name: Deploy Casual Store

on:
    push:
        tags: [deploy/v*]

jobs:
    deploy:
        name: Deploy
        environment: ask-ids
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3
            - name: Configure AWS credentials
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                  aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID --profile bootstrap
                  aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY --profile bootstrap
                  aws configure set region us-east-1 --profile bootstrap
            - name: Upload to S3 and Create Invalidation
              env:
                  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
                  CF_DISTRIBUTION_ID: ${{ secrets.CF_DISTRIBUTION_ID }}
              run: |
                  aws s3 sync casual-store s3://$S3_BUCKET_NAME --delete --cache-control no-cache --profile bootstrap
                  aws cloudfront create-invalidation --distribution-id $CF_DISTRIBUTION_ID --paths "/*" --profile bootstrap