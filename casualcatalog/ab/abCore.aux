{"version":2,"updates":[{"id":0,"timestamp":1759865572002,"update":"AWLpmK+ACAAnAQRib3RzJDY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNwEnAOmYr4AIABhhYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUCBADpmK+ACAHBLEBjb25zdCBkZXRhaWxlZCA9IHRoYXQ/LmRldGFpbGVkID8/IGZhbHNlOwpjb25zdCBoYXNoQWxnb3JpdGhtID0gdGhhdD8uaGFzaEFsZ29yaXRobSA/PyAnc2hhMSc7CmNvbnN0IGhhc2hGb3JtYXQgPSB0aGF0Py5oYXNoRm9ybWF0ID8/ICdoZXgnOwoKaW50ZXJmYWNlIEFCRmlsZVVwZGF0ZUNoZWNrIHsKICAgIGZpbGVOYW1lOiBzdHJpbmc7CiAgICB1cGRhdGVBdmFpbGFibGU6IGJvb2xlYW47CiAgICBjdXJyZW50SGFzaDogc3RyaW5nOwogICAgbGF0ZXN0SGFzaDogc3RyaW5nOwogICAgcmVtb3ZlZDogYm9vbGVhbjsKfQoKLy8gVGhpcyBsaXN0IG9mIGFiIGZpbGUgY2hlY2tzLCB0aGlzIHdpbGwgb25seSBiZSBwb3B1bGF0ZWQgaWYgJ2RldGFpbGVkJyBpcyB0cnVlLgpjb25zdCBhYkZpbGVDaGVja3M6IEFCRmlsZVVwZGF0ZUNoZWNrW10gPSBbXTsKCmFzeW5jIGZ1bmN0aW9uIGNoZWNrU2tpbGxPdXRkYXRlZChza2lsbE5hbWU6IHN0cmluZywgY3VycmVudEhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gewogICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOyAgICAgICAgCiAgICBsZXQgc2tpbGxSZW1vdmVkID0gZmFsc2U7CiAgICBsZXQgc2tpbGxSZXNwb25zZTsKCiAgICB0cnkgewogICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbFJlc3BvbnNlOmAsIHNraWxsUmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhc3NlcnQoc2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHtza2lsbE5hbWV9IG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7c2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7CgogICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBlcnJvciB3aGlsZSBkb3dubG9hZGluZyBza2lsbDpgLCBlKTsKICAgICAgICAKICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgLy8gRmlsZSBkb2VzbnQgZXhpc3QgYW55bW9yZSwgdGhlIHNraWxsIGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHNraWxsUmVtb3ZlZCkgewogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoOiBudWxsLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSwKICAgICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBDYWxjdWxhdGUgaGFzaCBvZiBhYiBmaWxlIHN0YXRlIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHNraWxsUmVzcG9uc2UuZGF0YS51cGRhdGVzKTsKICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgc3RhdGUpOwogICAgICAgIAogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgbGF0ZXN0VXBkYXRlczogc2tpbGxSZXNwb25zZS5kYXRhLnVwZGF0ZXMsCiAgICAgICAgICAgICAgICBsYXRlc3RTdGF0ZTogc3RhdGUsCiAgICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2g7CiAgICB9Cn0KCi8vIDEuIENoZWNrIGlmIGFiQ29uZmlnIGlzIG91dGRhdGVkLgpjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOwpjb25zdCBhYkNvbmZpZ1Jlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb25maWdVUkwgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZ1Jlc3BvbnNlOmAsIGFiQ29uZmlnUmVzcG9uc2UpOwp9Cgphc3NlcnQoYWJDb25maWdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke2FiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7Cgpjb25zdCBhYkNvbmZpZ0N1cnJlbnRIYXNoID0gYWIubGlua3MucmVtZW1iZXIudGFncy5hYkNvbmZpZ1NvdXJjZUhhc2g7CmNvbnN0IGFiQ29uZmlnTGF0ZXN0U3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcyk7CmZvciAobGV0IGlkIGluIGFiQ29uZmlnTGF0ZXN0U3RhdGUpIHsKICAgIGRlbGV0ZSBhYkNvbmZpZ0xhdGVzdFN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgp9CmNvbnN0IGFiQ29uZmlnTGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiQ29uZmlnTGF0ZXN0U3RhdGUpOwoKaWYgKGRldGFpbGVkKSB7CiAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgZmlsZU5hbWU6ICdhYkNvbmZpZycsCiAgICAgICAgY3VycmVudEhhc2g6IGFiQ29uZmlnQ3VycmVudEhhc2gsCiAgICAgICAgbGF0ZXN0SGFzaDogYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIHJlbW92ZWQ6IGZhbHNlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIGxhdGVzdFVwZGF0ZXM6IGFiQ29uZmlnUmVzcG9uc2UuZGF0YS51cGRhdGVzLAogICAgICAgIGxhdGVzdFN0YXRlOiBhYkNvbmZpZ0xhdGVzdFN0YXRlLAogICAgfSkKfQoKaWYgKCFkZXRhaWxlZCAmJiAoYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoKSkgewogICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgaW4gc2ltcGxlIG1vZGUsIHJldHVybiByaWdodCBhd2F5IG9uIHRoZSBmaXJzdCBvdXRkYXRlZCBmaWxlIGRpc2NvdmVyeS4KICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSB9Cn0KCi8vIDIuIENoZWNrIGlmIGFiIHNraWxscyBhcmUgb3V0ZGF0ZWQuCmNvbnN0IGFiU2tpbGxOYW1lcyA9IFsgJ2FiQ29yZScsIC4uLnRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKSBdOwpjb25zb2xlLmxvZyhgYWJTa2lsbE5hbWVzOmAsIGFiU2tpbGxOYW1lcyk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFiU2tpbGxOYW1lcy5sZW5ndGg7IGkrKykgewogICAgY29uc3Qgc2tpbGxOYW1lID0gYWJTa2lsbE5hbWVzW2ldOwoKICAgIGxldCBza2lsbEN1cnJlbnRIYXNoOwogICAgaWYgKHNraWxsTmFtZSA9PT0gJ2FiQ29yZScpIHsKICAgICAgICBza2lsbEN1cnJlbnRIYXNoID0gYWIudGFncy5hYkNvcmVTb3VyY2VIYXNoOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBsb2FkZWRTa2lsbEJvdCA9IGdldEJvdChiID0+IGIudGFncy5hYkxvYWRlZFNraWxsID09PSBza2lsbE5hbWUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOwogICAgICAgIGFzc2VydChsb2FkZWRTa2lsbEJvdCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb3VsZCBub3QgZmluZCBsb2FkZWQgc2tpbGwgYm90IGZvciAke3NraWxsTmFtZX0uYCk7CgogICAgICAgIHNraWxsQ3VycmVudEhhc2ggPSBsb2FkZWRTa2lsbEJvdC50YWdzLmFiTG9hZGVkU2tpbGxTb3VyY2VIYXNoOwogICAgfQogICAgCiAgICB0cnkgewogICAgICAgIGNvbnN0IHNraWxsT3V0ZGF0ZWQgPSBhd2FpdCBjaGVja1NraWxsT3V0ZGF0ZWQoc2tpbGxOYW1lLCBza2lsbEN1cnJlbnRIYXNoKTsKCiAgICAgICAgaWYgKCFkZXRhaWxlZCAmJiBza2lsbE91dGRhdGVkKSB7CiAgICAgICAgICAgIC8vIElmIHdlIGFyZSBydW5uaW5nIGluIHNpbXBsZSBtb2RlLCByZXR1cm4gcmlnaHQgYXdheSBvbiB0aGUgZmlyc3Qgb3V0ZGF0ZWQgZmlsZSBkaXNjb3ZlcnkuCiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSB9CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaCBhbiBlcnJvci5gLCBlKTsKICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICB9Cn0KCmlmIChkZXRhaWxlZCkgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogYWJGaWxlQ2hlY2tzLnNvbWUoZiA9PiBmLnVwZGF0ZUF2YWlsYWJsZSksCiAgICAgICAgYWJGaWxlQ2hlY2tzLAogICAgfQp9IGVsc2UgewogICAgLy8gSWYgd2UgbWFkZSBpdCBhbGwgdGhlIHdheSBoZXJlIGluIHNpbXBsZSBtb2RlLCB0aGVyZSBhcmUgbm8gb3V0ZGF0ZWQgZmlsZXMuCiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB1cGRhdGVBdmFpbGFibGU6IGZhbHNlIH0KfScA6ZivgAgAEmFiQ29yZU1ham9yVmVyc2lvbgIEAOmYr4AIwywCMTAnAOmYr4AIABJhYkNvcmVNaW5vclZlcnNpb24CBADpmK+ACMYsAjI0JwDpmK+ACAAGc3lzdGVtAgQA6ZivgAjJLA1hYi5jb3JlLmxlYXJuJwDpmK+ACAAEYWJJRAIEAOmYr4AI1ywFbGVhcm4nAOmYr4AIAARmb3JtAgQA6ZivgAjdLAdub3RoaW5nJwDpmK+ACAAGYWJCb290AgQA6ZivgAjlLKcqQC8qKgoqIE1JVCBMaWNlbnNlCioKKiBDb3B5cmlnaHQgKGMpIDIwMTkgQ2FzdWFsIFNpbXVsYXRpb24sIEluYy4KKgoqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAoqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCiogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzCiogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKKgoqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbAoqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCioKKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgoqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAoqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQoqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAoqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFCiogU09GVFdBUkUuCiogQGxpY2Vuc2UgTUlUCiovCgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib290aW5nIGFiYCk7Cn0KCi8vaW5zdCBtb2RlIChwbGF5ZXIgb3IgYnVpbGRlcikKbGV0IGluc3RNb2RlQ2hlY2sgPSBhd2FpdCBvcy52ZXJzaW9uKCkucGxheWVyTW9kZTsKLy9jaGVjayBzZWxmIGZvciBpbml0aWFsIGJvb3QgZGF0YQpsZXQgaW5pdGlhbEJvb3QgPSBsaW5rcy5yZW1lbWJlci50YWdzLmluaXRpYWxCb290ID8gdHJ1ZSA6IGZhbHNlOwovL2NoZWNrIHVybCBmb3IgcG9zc2libGUgYWIncyB0byBsb2FkCmxldCBib290RmxhZyA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gPyBjb25maWdCb3QudGFncy5wYXR0ZXJuIDogY29uZmlnQm90LnRhZ3MuYWI7Ci8vY2hlY2sgZm9yIGFzawpsZXQgYXNrID0gY29uZmlnQm90LnRhZ3MuYXNrOwovL2xvZ2luCmxldCBzdGF0dXMgPSBhd2FpdCB0aGlzQm90LmxvYWRpbmdTdGF0dXMoKTsKLy9zZWVkIChub3QgYWN0aXZlbHkgdXNlZCBoZXJlKQpsZXQgc2VlZCA9IGNvbmZpZ0JvdC50YWdzLnNlZWQ7Ci8vcHJvbXB0CmxldCBwcm9tcHQgPSBjb25maWdCb3QudGFncy5wcm9tcHQ7Ci8vY2hhbm5lbApsZXQgY2hhbm5lbCA9IGNvbmZpZ0JvdC50YWdzLmNoYW5uZWw7Ci8vdXVhYgpsZXQgdXVhYiA9IGNvbmZpZ0JvdC50YWdzLnV1YWI7Ci8vdmVyc2lvbgpsZXQgdmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbjsKLy9yZXF1ZXN0IGF1dGggYm90CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgovL3JlZGlyZWN0IGlmIGluIFVSTAppZiAoY29uZmlnQm90LnRhZ3Muam9pbkNvZGUpIHsKICAgIHRoaXNCb3QuYWJKb2luSG9zdCh7IHRleHQ6IGNvbmZpZ0JvdC50YWdzLmpvaW5Db2RlIH0pOwp9CgovL3N0YXR1cyBjbGVhbiB1cApkZXN0cm95KHN0YXR1cyk7CgovL2NoZWNrIHRpbWUgaWYgbmVlZGVkCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29uZGl0aW9uKSB7CiAgICBhd2FpdCBsaW5rcy5yZW1lbWJlci5hYkNvbmRpdGlvbigpOwp9CgovL2lmIG5vIHN0dWRpbywgc2V0IHN0dWRpbwppZiAoYXV0aEJvdCAmJiAhY29uZmlnQm90LnRhZ3Muc3R1ZGlvKSB7CiAgICBjb25maWdCb3QudGFncy5zdHVkaW8gPSBhdXRoQm90LmlkOwp9CgppZiAoYXV0aEJvdCkgewogICAgdGhpc0JvdC5hYkxvYWRTdHVkaW9zKCk7Cn0KCmlmICghbGlua3MucGVyc29uYWxpdHkpIHsgCiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiUGVyc29uYWxpdHkiKTsKfQoKLy9pbml0aWFsaXplIHJlbWVtYmVyIGdsb2JhbHMKZ2xvYmFsVGhpcy5hYkluc3RNZW1vcnkgPSBsaW5rcy5yZW1lbWJlcjsKZ2xvYmFsVGhpcy5hYlJlbWVtYmVyID0gbGlua3MucmVtZW1iZXI7Cmdsb2JhbFRoaXMuYWJQZXJzb25hbGl0eSA9IGxpbmtzLnBlcnNvbmFsaXR5OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yKSB7CiAgICBncmlkUG9ydGFsQm90LnRhZ3MucG9ydGFsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUdyaWRQb3J0YWxDb2xvcjsKfQoKLy9UaGlzIGNoZWNrcyBmb3IgdGhlIGFwcHJvcHJpYXRlIGFycmF5IG9mIHNraWxscyBhbmQgaW5pdGlhbGl6ZXMgdGhlbQphd2FpdCB0aGlzQm90LmFiU2tpbGxJbml0aWFsaXphdGlvbihpbnN0TW9kZUNoZWNrKTsKCi8vaW5pdGlhbGl6aW5nIG9mIGdsb2JhbCB2YXJpYWJsZXMKZ2xvYmFsVGhpcy5idWlsZGVyVmVyc2lvbiA9IGluc3RNb2RlQ2hlY2sgPT0gImJ1aWxkZXIiID8gdHJ1ZSA6IGZhbHNlOwpnbG9iYWxUaGlzLmFiTG9uZ1Rlcm1NZW1vcnlTZWFyY2ggPSBsaW5rcy5zZWFyY2g7Cmdsb2JhbFRoaXMuYWJTZWFyY2ggPSBsaW5rcy5zZWFyY2g7Cmdsb2JhbFRoaXMuYWJQdWJsaXNoID0gbGlua3Muc3RvcmU7Cmdsb2JhbFRoaXMuYWJTdG9yZSA9IGxpbmtzLnN0b3JlOwpnbG9iYWxUaGlzLmFiID0gdGhpc0JvdDsKCi8vY2hlY2sgZm9yIHV1YWJzCmlmICh1dWFiKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oe21lc3NhZ2U6IHV1YWIsIGlzVVVBQjogdHJ1ZX0pOwp9Ci8vY2hlY2sgZm9yIGNoYW5uZWwgaWYgY2hhbm5lbHMgYWxsb3dlZAplbHNlIGlmIChjaGFubmVsICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWxsb3dDaGFubmVscykgewogICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCJhYkFjdGlvbiIpOwoKICAgIGxpbmtzLmFzay5hYkNvcmVNZW51QWN0aW9uKHttZXNzYWdlOiBjaGFubmVsLCBpc0NoYW5uZWw6IHRydWV9KTsKfSBlbHNlIHsKICAgIC8vcG9wdWxhdGUgYm9vdGZsYWcgYWIKICAgIGlmIChpbml0aWFsQm9vdCAmJiBib290RmxhZykgewogICAgICAgIGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7IGFiSUQ6IGJvb3RGbGFnLCBpbml0aWFsQm9vdDogdHJ1ZSwgYXV0b0hhdGNoOiB0cnVlLCBzb3VyY2VFdmVudDogJ2Jvb3QnLCBhYlZlcnNpb246IHZlcnNpb259KTsKICAgIH0KCiAgICAvL2xvb2t1cCBhc2tJRCBpZiBhdmFpbGFibGUKICAgIGlmIChpbml0aWFsQm9vdCAmJiBhc2spIHsKICAgICAgICBpZiAoYXNrID09ICJlZ2dDYXJ0b24iIHx8IGFzayA9PSAiY2FzdWFsVHV0b3JpYWwiKSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdChhc2spOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCJhYkFjdGlvbiIpOwoKICAgICAgICAgICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrKTsKICAgICAgICB9CiAgICB9Cn0KCi8vY2hlY2sgZm9yIGFydGlmYWN0IEZJWAppZiAoY29uZmlnQm90LnRhZ3MuYXJ0aWZhY3QgJiYgaW5pdGlhbEJvb3QgJiYgIWFzayAmJiAhYm9vdEZsYWcpIHsKICAgIGNvbnN0IGFydGlmYWN0ID0gY29uZmlnQm90LnRhZ3MuYXJ0aWZhY3Q7CiAgICBjb25zdCBhcnRJbmRleCA9IGFydGlmYWN0LmluZGV4T2YoIl9hcnRfIik7CiAgICBjb25zdCBzdHVkaW8gPSBhcnRpZmFjdC5zdWJzdHJpbmcoMCwgYXJ0SW5kZXgpOwogICAgY29uc3QgcmVjb3JkQWRkcmVzcyA9IGFydGlmYWN0LnN1YnN0cmluZyhhcnRJbmRleCk7CiAgICBjb25zdCByZWNvcmREYXRhID0gYXdhaXQgb3MuZ2V0RGF0YShzdHVkaW8sIHJlY29yZEFkZHJlc3MpOwogICAgY29uc3QgYXNrSUQgPSByZWNvcmREYXRhLmRhdGEucGF0dGVybjsKCiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrSUQpOwp9CgovLyBDaGVjayBpZiB3ZSBjYW4gd2FrZSB1cCBhYiwgYW5kIHRoZW4gZG8gc28uCmlmICghY29uZmlnQm90LnRhZ3MuYWJTbGVlcCkgewogICAgaWYgKChpbml0aWFsQm9vdCAmJiAhYm9vdEZsYWcgJiYgIWFzaykgfHwgbGlua3MucmVtZW1iZXIudGFncy5hYkFsd2F5c1N0YXJ0QXdha2UgfHwgY29uZmlnQm90LnRhZ3MuYWJTdGF5QXdha2UpIHsKICAgICAgICBhd2FpdCBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogdHJ1ZSwgaW5pdGlhbDogaW5pdGlhbEJvb3QgfSk7CiAgICB9Cn0KCi8vc2V0IGluaXRpYWwgYm9vdCBkYXRhCmlmIChpbml0aWFsQm9vdCkgewogICAgc2V0VGFnTWFzayhsaW5rcy5yZW1lbWJlciwgJ2luaXRpYWxCb290JywgZmFsc2UsICdzaGFyZWQnKTsKCiAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxpemF0aW9uQ29uZmlndXJhdGlvbikgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLmFiSW5pdGlhbGl6YXRpb25Db25maWd1cmF0aW9uKCk7CiAgICB9Cn0KCi8vY2xlYW4gdXAgVVJMIHdpdGggdGFnUG9ydGFsCmlmIChjb25maWdCb3QudGFncy50YWdQb3J0YWwgJiYgIWNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbEFuY2hvclBvaW50ICYmIGJ1aWxkZXJWZXJzaW9uKSB7CiAgICBjb25maWdCb3QudGFncy50YWdQb3J0YWwgPSBudWxsOwogICAgY29uZmlnQm90LnRhZ3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwp9CgovL3BhdXNlIGZvciBhYiBsb2FkaW5nCmF3YWl0IG9zLnNsZWVwKDUwMCk7CgovL2luaXRpYWxpemUgdGltZSBib3QKdGhpc0JvdC5hYlRpbWVyKCk7CgpsaW5rcy5wZXJzb25hbGl0eS51cGRhdGVQZXJzb25hbGl0eSgpOwoKLy9pbml0aWFsaXphdGlvbiBzaG91dApzdXBlclNob3V0KCJvbkFCSW5pdGlhbGl6ZWQiLCB0YWdzLmFiSW5zdCk7KADpmK+ACAAGYWJDb3JlAXgnAOmYr4AIAAdhYkFkYXB0AgQA6ZivgAiOV74UQGxldCBza2lsbE5hbWU7CmxldCBza2lsbERhdGE7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgppZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICBza2lsbE5hbWUgPSB0aGF0OwogICAgc2tpbGxEYXRhID0gbnVsbDsKfSBlbHNlIGlmICh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcpIHsKICAgIHNraWxsTmFtZSA9IHRoYXQuc3lzdGVtSUQgPz8gdGhhdC5za2lsbE5hbWU7CiAgICBza2lsbERhdGEgPSB0aGF0LmRhdGEgPz8gbnVsbDsKfQoKaWYgKCFza2lsbE5hbWUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbE5hbWUgaXMgcmVxdWlyZWQuYCk7CiAgICByZXR1cm4gZmFsc2U7Cn0KCmlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfX1dIGFiQ29uZmlnIGNhbm5vdCBiZSBsb2FkZWQgdXNpbmcgYWJBZGFwdC5gKTsKICAgIHJldHVybjsKfQoKdHJ5IHsKICAgIGNvbnN0IGxvYWRlZFNraWxscyA9IHRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKTsKCiAgICBpZiAoIWxvYWRlZFNraWxscy5pbmNsdWRlcyhza2lsbE5hbWUpKSB7CiAgICAgICAgY29uc3QgdXJsID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FiLyR7c2tpbGxOYW1lfS5hdXhgKTsKICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsIH0pOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIHNraWxsIEdFVCByZXNwb25zZTpgLCByZXNwb25zZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgCiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICAvLyBBVVggRm9ybWF0IFZlcnNpb24gMi4KICAgICAgICAgICAgY29uc3QgdXBkYXRlcyA9IHJlc3BvbnNlLmRhdGEudXBkYXRlczsKICAgICAgICAgICAgYXdhaXQgb3MuYXBwbHlVcGRhdGVzVG9JbnN0KHVwZGF0ZXMpOwogICAgICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHVwZGF0ZXMpOwogICAgICAgICAgICBjb25zdCBzb3VyY2VIYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4Jywgc3RhdGUpOwoKICAgICAgICAgICAgLy8gTG9hZGVkIHNraWxscyBhcmUgc3RvcmVkIGFzIHNoYXJlZCBib3RzIHRoYXQgYW55b25lIGluIHRoZSBpbnN0IGNhbiByZWFkLgogICAgICAgICAgICBjcmVhdGUoewogICAgICAgICAgICAgICAgc3BhY2U6ICdzaGFyZWQnLAogICAgICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgICAgICBhYkxvYWRlZFNraWxsOiBza2lsbE5hbWUsCiAgICAgICAgICAgICAgICBhYkxvYWRlZFNraWxsU291cmNlSGFzaDogc291cmNlSGFzaCwKICAgICAgICAgICAgICAgIGZvcm06ICdub3RoaW5nJywKICAgICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQVVYIGZvcm1hdCB2ZXJzaW9uICR7cmVzcG9uc2UuZGF0YS52ZXJzaW9ufSBpcyBub3Qgc3VwcG9ydGVkLmApOwogICAgICAgIH0KCiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWIgc2tpbGwgJHtza2lsbE5hbWV9IGlzIGFscmVhZHkgbG9hZGVkLmApCiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHNraWxsQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3Nbc2tpbGxOYW1lXSA9PT0gdHJ1ZSk7CiAgICBpZiAoc2tpbGxCb3RzICYmIHNraWxsQm90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgd2hpc3Blcihza2lsbEJvdHMsIHRhZ05hbWUsIGNvbmZpZ0JvdC50YWdzLmluc3QpOwogICAgICAgIHdoaXNwZXIoc2tpbGxCb3RzLCAib25Ta2lsbFVwZGF0ZSIsIHsgZGF0YTogc2tpbGxEYXRhIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gTm8gYm90cyBhcHBlYXIgdG8gaGF2ZSBiZWVuIGxvYWRlZCB3aXRoICR7c2tpbGxOYW1lfS5gKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gRmFpbGVkIHRvIGRvd25sb2FkICR7c2tpbGxOYW1lfS4gU2VlIGFib3ZlIGVycm9yLmApOwogICAgcmV0dXJuIGZhbHNlOwp9JwDpmK+ACAALZGVzY3JpcHRpb24CBADpmK+ACM1rT1RoaXMgc2tpbGwgaXMgZGVzaWduZWQgdG8gaGFuZGxlIGJvdGggcmVjb25maWd1cmF0aW9uIG9mIGFiIGFuZCBpbml0aWFsaXphdGlvbi4nAOmYr4AIAApvbkJvdEFkZGVkAgQA6ZivgAidbPEBQGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJDb3JlIFNUQVJUIFVQYCk7Cgp0aGlzQm90LmFiSW5zdFVwZGF0ZSgpOwoKaWYgKCFsaW5rcy5yZW1lbWJlcikgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBmaW5kIGFiQ29uZmlnIHJlbWVtYmVyIGJvdC5gKTsKfQoKc2V0VGltZW91dCgoKSA9PiB0aGlzQm90LmFiQm9vdCgpLCA1MDApOycA6ZivgAgACHJlbWVtYmVyAgQA6ZivgAiPbijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDpmK+ACAADbG9nAgQA6ZivgAi2bmxALy9wYXNzIHRocm91Z2ggbG9nIGRhdGEKaWYgKGxpbmtzLmNvbnNvbGUpIHsKICAgIGxpbmtzLmNvbnNvbGUubG9nKHRoYXQpOwp9CmVsc2UgewogICAgY29uc29sZS5sb2codGhhdCk7Cn0nAOmYr4AIAA1tYW5pZmVzdGF0aW9uAgQA6ZivgAijbyjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDpmK+ACAAMYWJDcmVhdGVIb3N0AgQA6ZivgAjKb5YKQGNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwoKLy90aGlzIGZ1bmN0aW9uIGhhbmRsZXMgY3JlYXRpbmcgYSBmaWxlIGZvciBqb2luIGNvZGVzCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgewogICAgb3MudG9hc3QoInVybCBjb3BpZWQgdG8gY2xpcGJvYXJkIik7CgogICAgb3Muc2V0Q2xpcGJvYXJkKHNpdGVPcmlnaW4gKyAiLz9qb2luQ29kZT0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDAsIDMpICsgIi0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDMpKTsKCiAgICByZXR1cm47Cn0KCmlmICghYXV0aEJvdCkgewogICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKfQoKaWYgKCFhdXRoQm90KSB7CiAgICBvcy50b2FzdCgicGxlYXNlIGxvZyBpbiB0byBnZW5lcmF0ZSBhIGpvaW4gY29kZSIpOwogICAgcmV0dXJuOwp9Cgpjb25zdCBuZXdIb3N0SUQgPSB1dWlkKCkucmVwbGFjZUFsbCgiLSIsICIiKS5zdWJzdHJpbmcoMCwgNik7CmNvbnN0IGRhdGUgPSBEYXRlVGltZS5ub3coKS50b01pbGxpcygpOwpjb25zdCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5Owpjb25zdCByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YShyZWNvcmRLZXksIG5ld0hvc3RJRCwgeyB1cmw6IGNvbmZpZ0JvdC50YWdzLnVybCwgZGF0ZTogZGF0ZSwgbWFya2VyczogWyJwdWJsaWNSZWFkIl0gfSk7CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKSB7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnJlbWVtYmVyLCAnaG9zdElEJywgbmV3SG9zdElELnN1YnN0cmluZygwLCAzKSArICItIiArIG5ld0hvc3RJRC5zdWJzdHJpbmcoMyksICdzaGFyZWQnKTsKCiAgICBjb25zdCBqb2luVVJMID0gc2l0ZU9yaWdpbiArICIvP2pvaW5Db2RlPSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRDsKCiAgICBvcy5zZXRDbGlwYm9hcmQoam9pblVSTCk7CgogICAgdGhhdC50YWdzLmxhYmVsID0gImpvaW4gY29kZTogIiArIG5ld0hvc3RJRC5zdWJzdHJpbmcoMCwgMykgKyAiLSIgKyBuZXdIb3N0SUQuc3Vic3RyaW5nKDMpOwoKICAgIG9zLnNob3dRUkNvZGUoam9pblVSTCk7CgogICAgb3MudG9hc3QoImhvc3QgZ2VuZXJhdGVkLCB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogIiArIG5ld0hvc3RJRCk7Cn0KZWxzZSB7CiAgICBvcy50b2FzdCgic29tZXRoaW5nIHdlbnQgd3JvbmcsIHBsZWFzZSB0cnkgYWdhaW4iKTsKCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwp9JwDpmK+ACAAKYWJKb2luSG9zdAIEAOmYr4AI4XnuBkAvL2xvZ2ljIGZvciB1c2luZyBhIGpvaW4gY29kZSAoY2hlY2tzIGZvciBleGlzdGluZyBmaWxlcykKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmxldCBnZXRSZWNvcmQ7CgppZiAodGhhdC5kYXRhKSB7CiAgICBnZXRSZWNvcmQgPSB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHRoYXQuZGF0YSB9Owp9CmVsc2UgewogICAgY29uc3Qgam9pbkNvZGUgPSB0aGF0LnRleHQucmVwbGFjZUFsbCgiLSIsICIiKTsKICAgIGNvbnN0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CiAgICBjb25zb2xlLmxvZygiSk9JTkNPREUiLCBqb2luQ29kZSkKICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBqb2luQ29kZSk7Cn0KCmlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3QgZGF0ZSA9IERhdGVUaW1lLm5vdygpOwogICAgbGV0IGNyZWF0ZURhdGUgPSBEYXRlVGltZS5mcm9tTWlsbGlzKGdldFJlY29yZC5kYXRhLmRhdGUpOwogICAgbGV0IGRpZmZlcmVuY2UgPSBkYXRlLmRpZmYoY3JlYXRlRGF0ZSwgImRheXMiKS50b09iamVjdCgpOwoKICAgIGRpZmZlcmVuY2UgPSBNYXRoLmZsb29yKGRpZmZlcmVuY2UuZGF5cyk7CgogICAgaWYgKGRpZmZlcmVuY2UgPCA4KSB7CiAgICAgICAgb3MudG9hc3QoImpvaW5pbmcgaG9zdCBub3ciKTsKCiAgICAgICAgb3MuZ29Ub1VSTChnZXRSZWNvcmQuZGF0YS51cmwpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgb3MudG9hc3QoImpvaW4gY29kZSBvdXQgb2YgZGF0ZSwgcGxlYXNlIGdlbmVyYXRlIGEgbmV3IGpvaW4gY29kZSIpOwogICAgfQp9CmVsc2UgewogICAgb3MudG9hc3QoImNvZGUvYWIgaW52YWxpZCwgcGxlYXNlIHRyeSBhZ2FpbiIpOwp9JwDpmK+ACAAGc2VhcmNoAgQA6ZivgAjQgAEo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScA6ZivgAgACGFiSWdub3JlAgQA6ZivgAj3gAEEdHJ1ZScA6ZivgAgABG1lbnUCBADpmK+ACPyAASjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDpmK+ACAAVYWJTa2lsbEluaXRpYWxpemF0aW9uAgQA6ZivgAijgQGjAkAvL0ZpbmQgdGhlIGFwcHJvcHJpYXRlIGFycmF5IGFuZCBwb3B1bGF0ZSBza2lsbHMKbGV0IHNraWxsQXJyYXkgPSBsaW5rcy5yZW1lbWJlci50YWdzW3RoYXQgKyAiU2tpbGxBcnJheSJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoc2tpbGxBcnJheVtpXSk7Cn0KCmlmIChjb25maWdCb3QudGFncy5lbWJlZCA9PT0gJ2lvcycpIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgnYWJJT1NCcmlkZ2UnKTsKfQoKcmV0dXJuOycA6ZivgAgABmJhbm5lcgIEAOmYr4AIx4MBKPCflJdiNTUyZWFmOS1hOWQ2LTQxYzgtODUxNS1jYmQyYWJlYWFlNzMnAOmYr4AIAAVpbnB1dAIEAOmYr4AI7oMBKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAOmYr4AIAA1sb2FkaW5nU3RhdHVzAgQA6ZivgAiVhAHGB0Bjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkxvYWRTdGF0dXMiOwoKbGV0IHN0YXR1c0JvdCA9IHt9OwoKc3RhdHVzQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CnN0YXR1c0JvdC5sYWJlbCA9ICJ2ZXJpZnlpbmcgYXV0aEJvdCI7CnN0YXR1c0JvdC5sYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKc3RhdHVzQm90LmFiTG9hZFN0YXR1cyA9IHRydWU7CnN0YXR1c0JvdC5tZW51SXRlbVN0eWxlID0geyAiYmFja2dyb3VuZCI6ICJub25lIiB9OwpzdGF0dXNCb3QudHJhY2tOdW0gPSAwOwpzdGF0dXNCb3Qub25DcmVhdGUgPSBgQAogICAgaWYgKHRhZ3MudHJhY2tOdW0gPT0gMikgewogICAgICAgIHRhZ3MudHJhY2tOdW0gPSAwOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdGFncy50cmFja051bSsrOwogICAgfQoKICAgIHRhZ3MubGFiZWwgPSB0YWdzWyJsYWJlbCIrdGFncy50cmFja051bV07CiAgICB0YWdzLmZvcm1BZGRyZXNzID0gdGFnc1siZm9ybSIrdGFncy50cmFja051bV07CgogICAgc2V0VGltZW91dCgoKSA9PiB3aGlzcGVyKHRoaXNCb3QsICJvbkNyZWF0ZSIpLCA1MDApO2A7CnN0YXR1c0JvdC5sYWJlbDAgPSAidmVyaWZ5aW5nIGF1dGhCb3QuIjsKc3RhdHVzQm90LmxhYmVsMSA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4uIjsKc3RhdHVzQm90LmxhYmVsMiA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4uLiI7CnN0YXR1c0JvdC5mb3JtMCA9ICJob3VyZ2xhc3NfYm90dG9tIjsKc3RhdHVzQm90LmZvcm0xID0gImhvdXJnbGFzc190b3AiOwpzdGF0dXNCb3QuZm9ybTIgPSAiaG91cmdsYXNzX2JvdHRvbSI7CnN0YXR1c0JvdC5vbkRlc3Ryb3kgPSBgQAogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKbGV0IGNyZWF0ZWRTdGF0dXNCb3QgPSBjcmVhdGUoc3RhdHVzQm90KTsKCnJldHVybiBjcmVhdGVkU3RhdHVzQm90OycA6ZivgAgAA2FzawIEAOmYr4AI3IsBKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAOmYr4AIAA1hYkxvYWRTdHVkaW9zAgQA6ZivgAiDjAFbQGNvbnN0IHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7CmNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvcyA9IHVzZXJTdHVkaW9zOycA6ZivgAgAB2FiVGltZXICBADpmK+ACN+MAcEGQGlmIChnZXRCb3QoImFiVGltZXIiLCB0cnVlKSkgewogICAgcmV0dXJuOwp9CgppZiAoIXRhZ3MuYWJYUCkgewogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJYUCIsICIwIiwgImxvY2FsIik7Cn0KCmxldCB0aW1lckJvdCA9IHt9OwoKdGltZXJCb3Quc3BhY2UgPSAidGVtcExvY2FsIjsKdGltZXJCb3QubWFuYWdlciA9IGdldExpbmsodGhpc0JvdCk7CnRpbWVyQm90Lm9uQ3JlYXRlID0gYEAKICAgIG1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5vblRpbWVDaGVjaygpLCA2MDAwMCk7CmA7CnRpbWVyQm90LmFiVGltZXIgPSB0cnVlOwp0aW1lckJvdC5vblRpbWVDaGVjayA9IGBACiAgICBpZiAodGFncy5ub3RJZGxlKSB7CiAgICAgICAgdGFncy5ub3RJZGxlID0gZmFsc2U7CgogICAgICAgIC8vY29uc29sZS5sb2coIlhQIiwgbGlua3MubWFuYWdlci50YWdzLmFiWFApOwoKICAgICAgICBjb25zdCB0b3RhbFhQID0gbGlua3MubWFuYWdlci50YWdzLmFiWFAgKyAxOwoKICAgICAgICBzZXRUYWdNYXNrKGxpbmtzLm1hbmFnZXIsICJhYlhQIiwgdG90YWxYUCwgImxvY2FsIik7CiAgICB9CmA7CnRpbWVyQm90Lm5vdElkbGUgPSBmYWxzZTsKdGltZXJCb3Qub25BbnlBY3Rpb24gPSBgQAogICAgaWYgKCF0YWdzLm5vdElkbGUpIHsKICAgICAgICBpZiAodGhhdC5hY3Rpb24uaWQgPT0gZ3JpZFBvcnRhbEJvdC5pZCkKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3Mubm90SWRsZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpgOwoKbGV0IGFiVGltZXIgPSBjcmVhdGUodGltZXJCb3QpOwoKZ2xvYmFsVGhpcy5hYlRpbWVyID0gYWJUaW1lcjsnAOmYr4AIAAVzdG9yZQIEAOmYr4AIoZMBKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAOmYr4AIAAdjb25zb2xlAgQA6ZivgAjIkwEo8J+UlzI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYicA6ZivgAgACWFiVmVyc2lvbgIEAOmYr4AI75MBBTEwLjI0JwDpmK+ACAAMYWJMb2FkQ29uZmlnAgQA6ZivgAj1kwGaBkBjb25zdCB1cmwgPSBuZXcgVVJMKG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpKTsKdXJsLnBhdGhuYW1lID0gdXJsLnBhdGhuYW1lLnJlcGxhY2UoJ2FiMS5hdXgnLCAnYWJDb25maWcuYXV4Jyk7Cgp0cnkgewogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogdXJsLmhyZWYgfSk7CgogICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IHVwZGF0ZXMgPSByZXNwb25zZS5kYXRhLnVwZGF0ZXM7CiAgICBhd2FpdCBvcy5hcHBseVVwZGF0ZXNUb0luc3QodXBkYXRlcyk7CgogICAgaWYgKGxpbmtzLnJlbWVtYmVyKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBMb2FkZWQgYWJDb25maWcgYXV4IGJ1dCBjb3VsZCBub3QgZmluZCByZW1lbWJlciBib3QuYCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEZhaWxlZCB0byBkb3dubG9hZCBhYkNvbmZpZy4gU2VlIGFib3ZlIGVycm9yLmApOwogICAgcmV0dXJuIGZhbHNlOwp9JwDpmK+ACAAXYWJCdWlsZENhc3VhbENhdGFsb2dVUkwCBADpmK+ACJCaAf8BQGNvbnN0IHJlbGF0aXZlUGF0aCA9IHRoYXQ7Cgpjb25zdCB1cmwgPSBuZXcgVVJMKGxpbmtzLnJlbWVtYmVyLnRhZ3MuY2FzdWFsQ2F0YWxvZ1VSTCk7CmNvbnN0IGVudiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuY2FzdWFsQ2F0YWxvZ0VudjsKCnVybC5wYXRobmFtZSA9IHJlbGF0aXZlUGF0aDsKCmlmIChlbnYgJiYgZW52ICE9PSAncHJvZCcpIHsKICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdlbnYnLCBlbnYpOwp9CgpyZXR1cm4gdXJsLmhyZWY7JwDpmK+ACAAHY2hhbm5lbAIEAOmYr4AIkJwBKPCflJdhOWI2YWEwZC1iMzU3LTRkZTYtOWJlZi04NTM0OGFiMWQwZTAnAOmYr4AIAAtwZXJzb25hbGl0eQIEAOmYr4AIt5wBKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAOmYr4AIAAxhYkluc3RVcGRhdGUCBADpmK+ACN6cAaIBQC8vIFVwZGF0ZSB0aGUgYWJJbnN0IHRhZyB3aGljaCByZXByZXNlbnRzIHRoZSBpbnN0IHRoYXQgdGhpcyBhYiBleGlzdHMgaW4uCmNvbnN0IGN1ckluc3QgPSBvcy5nZXRDdXJyZW50SW5zdCgpOwpzZXRUYWdNYXNrKHRoaXNCb3QsICdhYkluc3QnLCBjdXJJbnN0LCAnc2hhcmVkJyk7JwDpmK+ACAAMb25JbnN0Sm9pbmVkAgQA6ZivgAiBngEYQHRoaXNCb3QuYWJJbnN0VXBkYXRlKCk7JwDpmK+ACAALb25JbnN0TGVhdmUCBADpmK+ACJqeARhAdGhpc0JvdC5hYkluc3RVcGRhdGUoKTsnAOmYr4AIAAxyZXNlcnZlZEFza3MCBADpmK+ACLOeAQzwn6esWyJob21lIl0nAOmYr4AIAAhhcnRpZmFjdAIEAOmYr4AIvp4BKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAOmYr4AIAAtib3RfZmFjdG9yeQIEAOmYr4AI5Z4BKPCflJdjNzhhYTY2My1kMDVjLTRlYzQtYmMyYy0yNmZkNTE1NjBiOTcnAOmYr4AIAAV1dGlscwIEAOmYr4AIjJ8BKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAOmYr4AIAAh1cGRhdGVBQgIEAOmYr4AIs58BlSlAY29uc3QgcmVsb2FkUGFnZSA9IHRoYXQ/LnJlbG9hZFBhZ2UgPz8gdHJ1ZTsNCmNvbnN0IHNob3dJbmRpY2F0b3IgPSB0aGF0Py5zaG93SW5kaWNhdG9yID8/IHRydWU7DQoNCmNvbnN0IERSWV9SVU4gPSBmYWxzZTsNCg0KbGV0IGJ1c3lJbmRpY2F0b3I7DQoNCmlmIChzaG93SW5kaWNhdG9yKSB7DQogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAndXBkYXRlQUJNZW51JzsNCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgdXBkYXRlQUJNZW51OiB0cnVlLCBsYWJlbDogYHVwZGF0aW5nICR7bGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX1gIH0pOw0KfQ0KDQpsZXQgb3ZlcndyaXRlUmVzdWx0Ow0KDQp0cnkgew0KICAgIC8vIFVwZGF0ZSBhYkNvbmZpZy4NCiAgICBjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOw0KICAgIGNvbnN0IGFiQ29uZmlnUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBhYkNvbmZpZ1VSTCB9KTsNCg0KICAgIGFzc2VydChhYkNvbmZpZ1Jlc3BvbnNlLnN0YXR1cyA9PT0gMjAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCBhYkNvbmZpZy4gUmVzcG9uc2U6ICR7YWJDb25maWdSZXNwb25zZS5zdGF0dXNUZXh0fWApOw0KICAgIGFzc2VydChhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZyBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke2FiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9ufWApOw0KDQogICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogYWJDb25maWdSZXNwb25zZS5kYXRhLCBncm91cFRhZzogJ2FiQ29uZmlnJywgZHJ5UnVuOiBEUllfUlVOIH0pOw0KICAgIHNldFRhZ01hc2soYWIubGlua3MucmVtZW1iZXIsICdhYkNvbmZpZ1NvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KDQogICAgLy8gVXBkYXRlIGFiIHNraWxscy4NCiAgICBjb25zdCBsb2FkZWRTa2lsbHMgPSB0aGlzQm90LmFiTG9hZGVkU2tpbGxzKCk7DQoNCiAgICBmb3IgKGxldCBza2lsbE5hbWUgb2YgbG9hZGVkU2tpbGxzKSB7DQogICAgICAgIGNvbnN0IHNraWxsVVJMID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FiLyR7c2tpbGxOYW1lfS5hdXhgKTsNCg0KICAgICAgICAvLyBTa2lsbHMgY2FuIGJlIHJlc3RydWN0dXJlZCwgbWVhbmluZyB0aGF0IHRoZXkgY291bGQgYmUgcmVtb3ZlZCBlbnRpcmVseSBpbiB0aGUgZnV0dXJlLg0KICAgICAgICAvLyBJZiBhIGZpbGUgZmFpbHMgdG8gYmUgcmV0cmlldmVkLCB0aGVuIHJlbW92ZSBhbGwgdGhlIGJvdHMgaW4gdGhlIGdyb3VwIGluIHRoZSBpbnN0Lg0KICAgICAgICBsZXQgcmVtb3ZlU2tpbGwgPSBmYWxzZTsNCiAgICAgICAgbGV0IHNraWxsUmVzcG9uc2U7DQoNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsNCg0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraWxsUmVzcG9uc2U6YCwgc2tpbGxSZXNwb25zZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGFzc2VydChza2lsbFJlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke3NraWxsTmFtZX0gbXVzdCBiZSBpbiBhdXggZmlsZSBmb3JtYXQgdjIuIEFjdHVhbCBhdXggZmlsZSBmb3JtYXQgdmVyc2lvbjogJHtza2lsbFJlc3BvbnNlLmRhdGEudmVyc2lvbn1gKTsNCg0KICAgICAgICAgICAgaWYgKHNraWxsUmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHsNCiAgICAgICAgICAgICAgICBpZiAoc2tpbGxSZXNwb25zZS5zdGF0dXMgPT09IDQwMyB8fCBza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7DQogICAgICAgICAgICAgICAgICAgIHJlbW92ZVNraWxsID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9IGNhdGNoIChlKSB7DQogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2F1Z2h0IGVycm9yIHdoaWxlIGRvd25sb2FkaW5nIHNraWxsOmAsIGUpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsNCiAgICAgICAgICAgICAgICAvLyBGaWxlIGRvZXNudCBleGlzdCBhbnltb3JlLCB0aGUgc2tpbGwgaGFzIGJlZW4gcmVtb3ZlZC4NCiAgICAgICAgICAgICAgICByZW1vdmVTa2lsbCA9IHRydWU7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHRocm93IGU7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmIChza2lsbFJlc3BvbnNlICYmICFyZW1vdmVTa2lsbCkgew0KICAgICAgICAgICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogc2tpbGxSZXNwb25zZS5kYXRhLCBncm91cFRhZzogc2tpbGxOYW1lLCBkcnlSdW46IERSWV9SVU4gfSk7DQoNCiAgICAgICAgICAgIGNvbnN0IGxvYWRlZFNraWxsQm90ID0gZ2V0Qm90KGIgPT4gYi50YWdzLmFiTG9hZGVkU2tpbGwgPT09IHNraWxsTmFtZSAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyk7DQogICAgICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzZXRUYWdNYXNrKGxvYWRlZFNraWxsQm90LCAnYWJMb2FkZWRTa2lsbFNvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KICAgICAgICB9IGVsc2UgaWYgKHJlbW92ZVNraWxsKSB7DQogICAgICAgICAgICBjb25zdCBza2lsbEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzW3NraWxsTmFtZV0gPT09IHRydWUpOw0KDQogICAgICAgICAgICBpZiAoRFJZX1JVTikgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZGVsZXRlICR7c2tpbGxCb3RzLmxlbmd0aH0gJHtza2lsbE5hbWV9IGJvdChzKSBiZWNhdXNlICR7c2tpbGxOYW1lfSBpcyBubyBsb25nZXIgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLmApDQogICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFNraWxsICR7c2tpbGxOYW1lfSBpcyBubyBsb25nZXIgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBSZW1vdmUgJHtza2lsbEJvdHMubGVuZ3RofSAke3NraWxsTmFtZX0gYm90KHMpIGZyb20gaW5zdC5gKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVzdHJveShza2lsbEJvdHMpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgLy8gVXBkYXRlIGFiQ29yZSAoZG8gdGhpcyBvbmUgbGFzdCEpDQogICAgY29uc3QgYWJDb3JlVVJMID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTCgnL2FiL2FiQ29yZS5hdXgnKTsNCiAgICBjb25zdCBhYkNvcmVSZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBhYkNvcmVVUkwgfSk7DQoNCiAgICBhc3NlcnQoYWJDb3JlUmVzcG9uc2Uuc3RhdHVzID09PSAyMDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkIGFiQ29yZS4gUmVzcG9uc2U6ICR7YWJDb3JlUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsNCiAgICBhc3NlcnQoYWJDb3JlUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29yZSBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke2FiQ29yZVJlc3BvbnNlLmRhdGEudmVyc2lvbn1gKTsNCg0KICAgIG92ZXJ3cml0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYXV4VjJPdmVyd3JpdGUoeyBhdXg6IGFiQ29yZVJlc3BvbnNlLmRhdGEsIGdyb3VwVGFnOiAnYWJDb3JlJywgZHJ5UnVuOiBEUllfUlVOIH0pOw0KICAgIHNldFRhZ01hc2soYWIsICdhYkNvcmVTb3VyY2VIYXNoJywgb3ZlcndyaXRlUmVzdWx0LnNvdXJjZUhhc2gsICdzaGFyZWQnKTsNCg0KICAgIGlmIChyZWxvYWRQYWdlKSB7DQogICAgICAgIGNvbnN0IHJlbW90ZURhdGFFdmVudCA9ICd1cGRhdGVfYWJfcmVsb2FkX3BhZ2UnOw0KICAgICAgICBjb25zdCByZW1vdGVEYXRhQXJnID0geyByZWxvYWRQYWdlLCBkcnlSdW46IERSWV9SVU4gfTsNCg0KICAgICAgICBpZiAob3MuaXNDb2xsYWJvcmF0aXZlKCkpIHsNCiAgICAgICAgICAgIGNvbnN0IHJlbW90ZXMgPSBhd2FpdCBvcy5yZW1vdGVzKCk7DQogICAgICAgICAgICBzZW5kUmVtb3RlRGF0YShyZW1vdGVzLCByZW1vdGVEYXRhRXZlbnQsIHJlbW90ZURhdGFBcmcpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgdGhpc0JvdC5vblJlbW90ZURhdGEoeyBuYW1lOiByZW1vdGVEYXRhRXZlbnQsIHRoYXQ6IHJlbW90ZURhdGFBcmcsIHJlbW90ZUlkOiBjb25maWdCb3QuaWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9IGZpbmFsbHkgew0KICAgIGlmIChidXN5SW5kaWNhdG9yKSB7DQogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7DQogICAgICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsNCiAgICB9DQp9JwDpmK+ACAAFZGVidWcCBADpmK+ACMnIAQR0cnVlJwDpmK+ACAAOYXV4VjJPdmVyd3JpdGUCBADpmK+ACM7IAZEqQGNvbnN0IGF1eCA9IHRoYXQ/LmF1eDsKY29uc3QgZ3JvdXBUYWcgPSB0aGF0Py5ncm91cFRhZzsKY29uc3QgZHJ5UnVuID0gdGhhdD8uZHJ5UnVuID8/IGZhbHNlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKYXNzZXJ0KGF1eD8udmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhdXggcGFyYW1ldGVyIGlzIHJlcXVpcmVkIHRvIGJlIGEgdjIgYXV4IGZpbGUuYCk7CmFzc2VydChncm91cFRhZyA9PSBudWxsIHx8IHR5cGVvZiBncm91cFRhZyA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ3JvdXBUYWcgcGFyYW1ldGVyIGlmIHByb3ZpZGVkLCBtdXN0IGJlIGEgc3RyaW5nLmApOwoKY29uc3Qgc3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhdXgudXBkYXRlcyk7CgovLyBTdXBlciBoYXJkY29kZWQgbWVzc3kgZml4IGZvciBjb21wdXRpbmcgYWJDb25maWcgc291cmNlIGhhc2guCmlmIChncm91cFRhZyA9PT0gJ2FiQ29uZmlnJykgeyAKICAgIGZvciAobGV0IGlkIGluIHN0YXRlKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgogICAgfQp9CgpsZXQgc291cmNlSGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIHN0YXRlKTsKbGV0IHByZXZHcm91cEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzW2dyb3VwVGFnXSA9PT0gdHJ1ZSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdGF0ZTpgLCBzdGF0ZSk7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHByZXZHcm91cEJvdHM6YCwgcHJldkdyb3VwQm90cyk7Cn0KCi8vIFN0ZXAgMTogQXBwbHkgdXBkYXRlcyBkaXJlY3RseSB0byB0aGUgaW5zdCBhcy1pcy4KaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU3RlcCAxOiBBcHBseSB1cGRhdGVzIGRpcmVjdGx5IHRvIHRoZSBpbnN0IGFzLWlzLmApOwp9CgppZiAoIWRyeVJ1bikgewogICAgYXdhaXQgb3MuYXBwbHlVcGRhdGVzVG9JbnN0KGF1eC51cGRhdGVzKTsKfSBlbHNlIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgYXBwbHkgdXBkYXRlcyB0byBpbnN0LmApCn0KCi8vIFN0ZXAgMjogRGVsZXRlIHByZXZpb3VzIGdyb3VwIGJvdHMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSB1cGRhdGUgc3RhdGUuCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFN0ZXAgMjogRGVsZXRlIHByZXZpb3VzIGdyb3VwIGJvdHMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSB1cGRhdGUgc3RhdGUuYCk7Cn0KCmZvciAoY29uc3QgcHJldkdyb3VwQm90IG9mIHByZXZHcm91cEJvdHMpIHsKICAgIGlmIChzdGF0ZVtwcmV2R3JvdXBCb3QuaWRdID09IG51bGwpIHsKICAgICAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZGVsZXRlIGJvdCAke3ByZXZHcm91cEJvdC5pZH0gcHJldmlvdXNseSBiZWxvbmdpbmcgdG8gZ3JvdXAgJHtncm91cFRhZ31gKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgcHJldmlvdXMgZ3JvdXAgYm90ICR7cHJldkdyb3VwQm90LmlkfSB0aGF0IGlzIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLmApOwogICAgICAgIH0KCiAgICAgICAgZGVzdHJveShwcmV2R3JvdXBCb3QpOwogICAgfQp9CgovLyBTdGVwIDM6IEZvciBlYWNoIGJvdCBpbiB0aGUgdXBkYXRlIHN0YXRlLCBjcmVhdGUsIHVwZGF0ZSwgYW5kIGRlbGV0ZSB0YWdzIG9uIHRoZSBleGlzdGluZyBib3RzIGluIHRoZSBpbnN0LgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBTdGVwIDM6IEZvciBlYWNoIGJvdCBpbiB0aGUgdXBkYXRlIHN0YXRlLCBjcmVhdGUsIHVwZGF0ZSwgYW5kIGRlbGV0ZSB0YWdzIG9uIHRoZSBleGlzdGluZyBib3RzIGluIHRoZSBpbnN0LmApOwp9Cgpmb3IgKGNvbnN0IGJvdElkIGluIHN0YXRlKSB7CiAgICBjb25zdCBib3QgPSBnZXRCb3QoJ2lkJywgYm90SWQpOwogICAgY29uc3QgYm90U3RhdGUgPSBzdGF0ZVtib3RJZF07CgogICAgaWYgKGJvdCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgZXhpc3RpbmcgYm90ICR7Ym90SWR9YCk7CiAgICAgICAgfQoKICAgICAgICAvLyBIYW5kbGVzIHRhZyBjcmVhdGUgLyB1cGRhdGUuCiAgICAgICAgZm9yIChjb25zdCBzdGF0ZVRhZ05hbWUgaW4gYm90U3RhdGUudGFncykgewogICAgICAgICAgICBpZiAoYm90LnJhd1tzdGF0ZVRhZ05hbWVdICE9IGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSkgewogICAgICAgICAgICAgICAgaWYgKGRyeVJ1bikgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgc2V0IHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0gdG8gdmFsdWU6YCwgYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2V0IHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0gdG86YCwgYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBib3QudGFnc1tzdGF0ZVRhZ05hbWVdID0gYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdOwoKICAgICAgICAgICAgICAgIGlmIChib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGFnICcke3N0YXRlVGFnTmFtZX0nIGZvciBib3QgJHtib3RJZH0gaXMgbnVsbCwgY2xlYXJpbmcgYW55IHRhZyBtYXNrcyBhcyB3ZWxsLmApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgYWxsIHBvc3NpYmxlIG1hc2tzIGZvciB0aGlzIHRhZyBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICdsb2NhbCcpOwogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICd0ZW1wTG9jYWwnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAnc2hhcmVkJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIHN0YXRlVGFnTmFtZSwgbnVsbCwgJ3RlbXBTaGFyZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0YWcgJyR7c3RhdGVUYWdOYW1lfScgZm9yIGJvdCAke2JvdElkfSBpcyBhbHJlYWR5IHVwLXRvLWRhdGUuYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIERlbGV0ZSB0YWdzIChhbmQgbWFza3MgZm9yIHRob3NlIHRhZ3MpIG9uIGV4aXN0aW5nIGJvdCB0aGF0IGFyZSBub3QgaW4gdXBkYXRlIHN0YXRlLgogICAgICAgIGNvbnN0IGJvdFRhZ3MgPSBPYmplY3Qua2V5cyhib3QudGFncyk7CgogICAgICAgIGZvciAoY29uc3QgYm90VGFnTmFtZSBvZiBib3RUYWdzKSB7CiAgICAgICAgICAgIGlmIChib3RTdGF0ZS50YWdzW2JvdFRhZ05hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChkcnlSdW4pIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGRlbGV0ZSB0YWcgJyR7Ym90VGFnTmFtZX0nIG9uIGJvdCAke2JvdElkfS5gKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVsZXRlIHRhZyAoYW5kIG1hc2tzKSAnJHtib3RUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9LmApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJvdC50YWdzW2JvdFRhZ05hbWVdID0gbnVsbDsKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFsbCBwb3NzaWJsZSBtYXNrcyBmb3IgdGhpcyB0YWcgYXMgd2VsbC4KICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAnbG9jYWwnKTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAndGVtcExvY2FsJyk7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ3NoYXJlZCcpOwogICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIGJvdFRhZ05hbWUsIG51bGwsICd0ZW1wU2hhcmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb3VsZCBub3QgZmluZCBib3QgJHtib3RJZH0gaW4gaW5zdC5gKTsKICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZG9uZS5gKTsKfQoKY29uc3QgYm90SWRzID0gT2JqZWN0LmtleXMoc3RhdGUpOwoKcmV0dXJuIHsKICAgIGdyb3VwVGFnLAogICAgYm90SWRzLAogICAgc291cmNlSGFzaCwKfTsnAOmYr4AIAA5hYkxvYWRlZFNraWxscwIEAOmYr4AI4PIBtgFAY29uc3QgbG9hZGVkU2tpbGxzID0gbmV3IFNldCgpOwoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkxvYWRlZFNraWxsICE9IG51bGwpIHsKICAgICAgICBsb2FkZWRTa2lsbHMuYWRkKGIudGFncy5hYkxvYWRlZFNraWxsKTsKICAgIH0KfSk7CgpyZXR1cm4gQXJyYXkuZnJvbShsb2FkZWRTa2lsbHMpOycA6ZivgAgADG9uUmVtb3RlRGF0YQIEAOmYr4AIl/QBpwVAaWYgKHRoYXQubmFtZSA9PT0gJ3VwZGF0ZV9hYl9yZWxvYWRfcGFnZScpIHsKICAgIGNvbnN0IHsgcmVsb2FkUGFnZSwgZHJ5UnVuIH0gPSB0aGF0LnRoYXQ7CgogICAgaWYgKHRoYXQucmVtb3RlSWQgPT09IGNvbmZpZ0JvdC5pZCkgewogICAgICAgIC8vIFdhaXQgYSBtb21lbnQgYmVmb3JlIHJlbG9hZGluZyB0aGUgcGFnZSBpZiB3ZSBhcmUgdGhlIG9uZXMgdGhhdCBzZW50IG91dCB0aGUgbWVzc2FnZS4KICAgICAgICBhd2FpdCBvcy5zbGVlcCgxMDAwKTsKICAgIH0KCiAgICBsZXQgaXNVUkwgPSBmYWxzZTsKCiAgICBpZiAodHlwZW9mIHJlbG9hZFBhZ2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbmV3IFVSTChyZWxvYWRQYWdlKTsKICAgICAgICAgICAgaXNVUkwgPSB0cnVlOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9CgogICAgbGV0IHVybCA9IGlzVVJMID8gcmVsb2FkUGFnZSA6IGNvbmZpZ0JvdC50YWdzLnVybDsKCiAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBnbyB0byB1cmxgLCB1cmwpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgb3MuZ29Ub1VSTChpc1VSTCA/IHJlbG9hZFBhZ2UgOiBjb25maWdCb3QudGFncy51cmwpOwp9JwDpmK+ACAAJb25FbnRlckFSAgQA6ZivgAi/+QETQG1hc2tzLmluQVIgPSB0cnVlOycA6ZivgAgACG9uRXhpdEFSAgQA6ZivgAjT+QETQG1hc2tzLmluQVIgPSBudWxsOycA6ZivgAgACW9uRW50ZXJWUgIEAOmYr4AI5/kBE0BtYXNrcy5pblZSID0gdHJ1ZTsnAOmYr4AIAAhvbkV4aXRWUgIEAOmYr4AI+/kBE0BtYXNrcy5pblZSID0gbnVsbDsA"}]}