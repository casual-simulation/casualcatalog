{"version":2,"updates":[{"id":0,"timestamp":1761841860203,"update":"AWr7sbr/CgAnAQRib3RzJDY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNwEnAPuxuv8KABhhYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUCBAD7sbr/CgGVLEBjb25zdCBkZXRhaWxlZCA9IHRoYXQ/LmRldGFpbGVkID8/IGZhbHNlOwpjb25zdCBoYXNoQWxnb3JpdGhtID0gdGhhdD8uaGFzaEFsZ29yaXRobSA/PyAnc2hhMSc7CmNvbnN0IGhhc2hGb3JtYXQgPSB0aGF0Py5oYXNoRm9ybWF0ID8/ICdoZXgnOwoKaW50ZXJmYWNlIEFCRmlsZVVwZGF0ZUNoZWNrIHsKICAgIGZpbGVOYW1lOiBzdHJpbmc7CiAgICB1cGRhdGVBdmFpbGFibGU6IGJvb2xlYW47CiAgICBjdXJyZW50SGFzaDogc3RyaW5nOwogICAgbGF0ZXN0SGFzaDogc3RyaW5nOwogICAgcmVtb3ZlZDogYm9vbGVhbjsKfQoKLy8gVGhpcyBsaXN0IG9mIGFiIGZpbGUgY2hlY2tzLCB0aGlzIHdpbGwgb25seSBiZSBwb3B1bGF0ZWQgaWYgJ2RldGFpbGVkJyBpcyB0cnVlLgpjb25zdCBhYkZpbGVDaGVja3M6IEFCRmlsZVVwZGF0ZUNoZWNrW10gPSBbXTsKCmFzeW5jIGZ1bmN0aW9uIGNoZWNrU2tpbGxPdXRkYXRlZChza2lsbE5hbWU6IHN0cmluZywgY3VycmVudEhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gewogICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOyAgICAgICAgCiAgICBsZXQgc2tpbGxSZW1vdmVkID0gZmFsc2U7CiAgICBsZXQgc2tpbGxSZXNwb25zZTsKCiAgICB0cnkgewogICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbFJlc3BvbnNlOmAsIHNraWxsUmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhc3NlcnQoc2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHtza2lsbE5hbWV9IG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7c2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7CgogICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBlcnJvciB3aGlsZSBkb3dubG9hZGluZyBza2lsbDpgLCBlKTsKICAgICAgICAKICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgLy8gRmlsZSBkb2VzbnQgZXhpc3QgYW55bW9yZSwgdGhlIHNraWxsIGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHNraWxsUmVtb3ZlZCkgewogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoOiBudWxsLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSwKICAgICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBDYWxjdWxhdGUgaGFzaCBvZiBhYiBmaWxlIHN0YXRlIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHNraWxsUmVzcG9uc2UuZGF0YS51cGRhdGVzKTsKICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgc3RhdGUpOwogICAgICAgIAogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgbGF0ZXN0VXBkYXRlczogc2tpbGxSZXNwb25zZS5kYXRhLnVwZGF0ZXMsCiAgICAgICAgICAgICAgICBsYXRlc3RTdGF0ZTogc3RhdGUsCiAgICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2g7CiAgICB9Cn0KCi8vIDEuIENoZWNrIGlmIGFiQ29uZmlnIGlzIG91dGRhdGVkLgpjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOwpjb25zdCBhYkNvbmZpZ1Jlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb25maWdVUkwgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZ1Jlc3BvbnNlOmAsIGFiQ29uZmlnUmVzcG9uc2UpOwp9Cgphc3NlcnQoYWJDb25maWdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke2FiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7Cgpjb25zdCBhYkNvbmZpZ0N1cnJlbnRIYXNoID0gYWIubGlua3MucmVtZW1iZXIudGFncy5hYkNvbmZpZ1NvdXJjZUhhc2g7CmNvbnN0IGFiQ29uZmlnTGF0ZXN0U3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcyk7CmZvciAobGV0IGlkIGluIGFiQ29uZmlnTGF0ZXN0U3RhdGUpIHsKICAgIGRlbGV0ZSBhYkNvbmZpZ0xhdGVzdFN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgp9CmNvbnN0IGFiQ29uZmlnTGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiQ29uZmlnTGF0ZXN0U3RhdGUpOwoKaWYgKGRldGFpbGVkKSB7CiAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgZmlsZU5hbWU6ICdhYkNvbmZpZycsCiAgICAgICAgY3VycmVudEhhc2g6IGFiQ29uZmlnQ3VycmVudEhhc2gsCiAgICAgICAgbGF0ZXN0SGFzaDogYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIHJlbW92ZWQ6IGZhbHNlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIGxhdGVzdFVwZGF0ZXM6IGFiQ29uZmlnUmVzcG9uc2UuZGF0YS51cGRhdGVzLAogICAgICAgIGxhdGVzdFN0YXRlOiBhYkNvbmZpZ0xhdGVzdFN0YXRlLAogICAgfSkKfQoKaWYgKCFkZXRhaWxlZCAmJiAoYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoKSkgewogICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgaW4gc2ltcGxlIG1vZGUsIHJldHVybiByaWdodCBhd2F5IG9uIHRoZSBmaXJzdCBvdXRkYXRlZCBmaWxlIGRpc2NvdmVyeS4KICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSB9Cn0KCi8vIDIuIENoZWNrIGlmIGFiIHNraWxscyBhcmUgb3V0ZGF0ZWQuCmNvbnN0IGFiU2tpbGxOYW1lcyA9IFsgJ2FiQ29yZScsIC4uLnRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKSBdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhYlNraWxsTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHNraWxsTmFtZSA9IGFiU2tpbGxOYW1lc1tpXTsKCiAgICBsZXQgc2tpbGxDdXJyZW50SGFzaDsKICAgIGlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICAgICAgc2tpbGxDdXJyZW50SGFzaCA9IGFiLnRhZ3MuYWJDb3JlU291cmNlSGFzaDsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbG9hZGVkU2tpbGxCb3QgPSBnZXRCb3QoYiA9PiBiLnRhZ3MuYWJMb2FkZWRTa2lsbCA9PT0gc2tpbGxOYW1lICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsKICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOwoKICAgICAgICBza2lsbEN1cnJlbnRIYXNoID0gbG9hZGVkU2tpbGxCb3QudGFncy5hYkxvYWRlZFNraWxsU291cmNlSGFzaDsKICAgIH0KICAgIAogICAgdHJ5IHsKICAgICAgICBjb25zdCBza2lsbE91dGRhdGVkID0gYXdhaXQgY2hlY2tTa2lsbE91dGRhdGVkKHNraWxsTmFtZSwgc2tpbGxDdXJyZW50SGFzaCk7CgogICAgICAgIGlmICghZGV0YWlsZWQgJiYgc2tpbGxPdXRkYXRlZCkgewogICAgICAgICAgICAvLyBJZiB3ZSBhcmUgcnVubmluZyBpbiBzaW1wbGUgbW9kZSwgcmV0dXJuIHJpZ2h0IGF3YXkgb24gdGhlIGZpcnN0IG91dGRhdGVkIGZpbGUgZGlzY292ZXJ5LgogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB1cGRhdGVBdmFpbGFibGU6IHRydWUgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2ggYW4gZXJyb3IuYCwgZSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9CgppZiAoZGV0YWlsZWQpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGFiRmlsZUNoZWNrcy5zb21lKGYgPT4gZi51cGRhdGVBdmFpbGFibGUpLAogICAgICAgIGFiRmlsZUNoZWNrcywKICAgIH0KfSBlbHNlIHsKICAgIC8vIElmIHdlIG1hZGUgaXQgYWxsIHRoZSB3YXkgaGVyZSBpbiBzaW1wbGUgbW9kZSwgdGhlcmUgYXJlIG5vIG91dGRhdGVkIGZpbGVzLgogICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdXBkYXRlQXZhaWxhYmxlOiBmYWxzZSB9Cn0nAPuxuv8KAARncmlkAgQA+7G6/wqXLCjwn5SXMDI4MzY1YTQtMDM2Zi00MWQwLTlhZjEtNzE1YWQ0ZjJhYTdhJwD7sbr/CgASYWJDb3JlTWFqb3JWZXJzaW9uAgQA+7G6/wq+LAIxMCcA+7G6/woAEmFiQ29yZU1pbm9yVmVyc2lvbgIEAPuxuv8KwSwCMzInAPuxuv8KAAZzeXN0ZW0CBAD7sbr/CsQsDWFiLmNvcmUubGVhcm4nAPuxuv8KAARhYklEAgQA+7G6/wrSLAVsZWFybicA+7G6/woABGZvcm0CBAD7sbr/CtgsB25vdGhpbmcnAPuxuv8KAAZhYkJvb3QCBAD7sbr/CuAs5SpALyoqCiogTUlUIExpY2Vuc2UKKgoqIENvcHlyaWdodCAoYykgMjAxOSBDYXN1YWwgU2ltdWxhdGlvbiwgSW5jLgoqCiogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQoqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwoqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoqCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKgoqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgoqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKKiBTT0ZUV0FSRS4KKiBAbGljZW5zZSBNSVQKKi8KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvb3RpbmcgYWJgKTsKfQoKLy9pbnN0IG1vZGUgKHBsYXllciBvciBidWlsZGVyKQpsZXQgaW5zdE1vZGVDaGVjayA9IGF3YWl0IG9zLnZlcnNpb24oKS5wbGF5ZXJNb2RlOwovL2NoZWNrIHNlbGYgZm9yIGluaXRpYWwgYm9vdCBkYXRhCmxldCBpbml0aWFsQm9vdCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuaW5pdGlhbEJvb3QgPyB0cnVlIDogZmFsc2U7Ci8vY2hlY2sgdXJsIGZvciBwb3NzaWJsZSBhYidzIHRvIGxvYWQKbGV0IGJvb3RGbGFnID0gY29uZmlnQm90LnRhZ3MucGF0dGVybiA/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gOiBjb25maWdCb3QudGFncy5hYjsKLy9jaGVjayBmb3IgYXNrCmxldCBhc2sgPSBjb25maWdCb3QudGFncy5hc2s7Ci8vbG9naW4KbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXNCb3QubG9hZGluZ1N0YXR1cygpOwovL3NlZWQgKG5vdCBhY3RpdmVseSB1c2VkIGhlcmUpCmxldCBzZWVkID0gY29uZmlnQm90LnRhZ3Muc2VlZDsKLy9wcm9tcHQKbGV0IHByb21wdCA9IGNvbmZpZ0JvdC50YWdzLnByb21wdDsKLy9jaGFubmVsCmxldCBjaGFubmVsID0gY29uZmlnQm90LnRhZ3MuY2hhbm5lbDsKLy91dWFiCmxldCB1dWFiID0gY29uZmlnQm90LnRhZ3MuYXV4bGluayA9PSAidXVhYiI7Ci8vdmVyc2lvbgpsZXQgdmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbjsKLy9yZXF1ZXN0IGF1dGggYm90CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgovL3JlZGlyZWN0IGlmIGluIFVSTAppZiAoY29uZmlnQm90LnRhZ3Muam9pbkNvZGUpIHsKICAgIHRoaXNCb3QuYWJKb2luSG9zdCh7IHRleHQ6IGNvbmZpZ0JvdC50YWdzLmpvaW5Db2RlIH0pOwp9CgovL3N0YXR1cyBjbGVhbiB1cApkZXN0cm95KHN0YXR1cyk7CgovL2NoZWNrIHRpbWUgaWYgbmVlZGVkCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29uZGl0aW9uKSB7CiAgICBhd2FpdCBsaW5rcy5yZW1lbWJlci5hYkNvbmRpdGlvbigpOwp9CgovL2lmIG5vIHN0dWRpbywgc2V0IHN0dWRpbwppZiAoYXV0aEJvdCAmJiAhY29uZmlnQm90LnRhZ3Muc3R1ZGlvKSB7CiAgICBjb25maWdCb3QudGFncy5zdHVkaW8gPSBhdXRoQm90LmlkOwp9CgppZiAoYXV0aEJvdCkgewogICAgdGhpc0JvdC5hYkxvYWRTdHVkaW9zKCk7Cn0KCmlmICghbGlua3MucGVyc29uYWxpdHkpIHsgCiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiUGVyc29uYWxpdHkiKTsKfQoKLy9pbml0aWFsaXplIHJlbWVtYmVyIGdsb2JhbHMKZ2xvYmFsVGhpcy5hYkluc3RNZW1vcnkgPSBsaW5rcy5yZW1lbWJlcjsKZ2xvYmFsVGhpcy5hYlJlbWVtYmVyID0gbGlua3MucmVtZW1iZXI7Cmdsb2JhbFRoaXMuYWJQZXJzb25hbGl0eSA9IGxpbmtzLnBlcnNvbmFsaXR5OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yKSB7CiAgICBncmlkUG9ydGFsQm90LnRhZ3MucG9ydGFsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUdyaWRQb3J0YWxDb2xvcjsKfQoKLy9UaGlzIGNoZWNrcyBmb3IgdGhlIGFwcHJvcHJpYXRlIGFycmF5IG9mIHNraWxscyBhbmQgaW5pdGlhbGl6ZXMgdGhlbQphd2FpdCB0aGlzQm90LmFiU2tpbGxJbml0aWFsaXphdGlvbihpbnN0TW9kZUNoZWNrKTsKCi8vaW5pdGlhbGl6aW5nIG9mIGdsb2JhbCB2YXJpYWJsZXMKZ2xvYmFsVGhpcy5idWlsZGVyVmVyc2lvbiA9IGluc3RNb2RlQ2hlY2sgPT0gImJ1aWxkZXIiID8gdHJ1ZSA6IGZhbHNlOwpnbG9iYWxUaGlzLmFiTG9uZ1Rlcm1NZW1vcnlTZWFyY2ggPSBsaW5rcy5zZWFyY2g7Cmdsb2JhbFRoaXMuYWJTZWFyY2ggPSBsaW5rcy5zZWFyY2g7Cmdsb2JhbFRoaXMuYWJQdWJsaXNoID0gbGlua3Muc3RvcmU7Cmdsb2JhbFRoaXMuYWJTdG9yZSA9IGxpbmtzLnN0b3JlOwpnbG9iYWxUaGlzLmFiID0gdGhpc0JvdDsKCi8vY2hlY2sgZm9yIHV1YWJzCmlmICh1dWFiKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oe21lc3NhZ2U6IGNvbmZpZ0JvdC50YWdzLnV1YWIsIGlzVVVBQjogdHJ1ZX0pOwp9Ci8vY2hlY2sgZm9yIGNoYW5uZWwgaWYgY2hhbm5lbHMgYWxsb3dlZAplbHNlIGlmIChjaGFubmVsICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWxsb3dDaGFubmVscykgewogICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCJhYkFjdGlvbiIpOwoKICAgIGxpbmtzLmFzay5hYkNvcmVNZW51QWN0aW9uKHttZXNzYWdlOiBjaGFubmVsLCBpc0NoYW5uZWw6IHRydWV9KTsKfSBlbHNlIHsKICAgIC8vcG9wdWxhdGUgYm9vdGZsYWcgYWIKICAgIGlmIChpbml0aWFsQm9vdCAmJiBib290RmxhZykgewogICAgICAgIGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7IGFiSUQ6IGJvb3RGbGFnLCBpbml0aWFsQm9vdDogdHJ1ZSwgYXV0b0hhdGNoOiB0cnVlLCBzb3VyY2VFdmVudDogJ2Jvb3QnLCBhYlZlcnNpb246IHZlcnNpb259KTsKICAgIH0KCiAgICAvL2xvb2t1cCBhc2tJRCBpZiBhdmFpbGFibGUKICAgIGlmIChpbml0aWFsQm9vdCAmJiBhc2spIHsKICAgICAgICBpZiAoYXNrID09ICJlZ2dDYXJ0b24iIHx8IGFzayA9PSAiY2FzdWFsVHV0b3JpYWwiKSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdChhc2spOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCJhYkFjdGlvbiIpOwoKICAgICAgICAgICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrKTsKICAgICAgICB9CiAgICB9Cn0KCi8vY2hlY2sgZm9yIGFydGlmYWN0IEZJWAppZiAoY29uZmlnQm90LnRhZ3MuYXJ0aWZhY3QgJiYgaW5pdGlhbEJvb3QgJiYgIWFzayAmJiAhYm9vdEZsYWcpIHsKICAgIGNvbnN0IGFydGlmYWN0ID0gY29uZmlnQm90LnRhZ3MuYXJ0aWZhY3Q7CiAgICBjb25zdCBhcnRJbmRleCA9IGFydGlmYWN0LmluZGV4T2YoIl9hcnRfIik7CiAgICBjb25zdCBzdHVkaW8gPSBhcnRpZmFjdC5zdWJzdHJpbmcoMCwgYXJ0SW5kZXgpOwogICAgY29uc3QgcmVjb3JkQWRkcmVzcyA9IGFydGlmYWN0LnN1YnN0cmluZyhhcnRJbmRleCk7CiAgICBjb25zdCByZWNvcmREYXRhID0gYXdhaXQgb3MuZ2V0RGF0YShzdHVkaW8sIHJlY29yZEFkZHJlc3MpOwogICAgY29uc3QgYXNrSUQgPSByZWNvcmREYXRhLmRhdGEucGF0dGVybjsKCiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrSUQpOwp9CgovLyBDaGVjayBpZiB3ZSBjYW4gd2FrZSB1cCBhYiwgYW5kIHRoZW4gZG8gc28uCmlmICghY29uZmlnQm90LnRhZ3MuYWJTbGVlcCkgewogICAgaWYgKChpbml0aWFsQm9vdCAmJiAhYm9vdEZsYWcgJiYgIWFzaykgfHwgbGlua3MucmVtZW1iZXIudGFncy5hYkFsd2F5c1N0YXJ0QXdha2UgfHwgY29uZmlnQm90LnRhZ3MuYWJTdGF5QXdha2UpIHsKICAgICAgICBhd2FpdCBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogdHJ1ZSwgaW5pdGlhbDogaW5pdGlhbEJvb3QgfSk7CiAgICB9Cn0KCi8vc2V0IGluaXRpYWwgYm9vdCBkYXRhCmlmIChpbml0aWFsQm9vdCkgewogICAgc2V0VGFnTWFzayhsaW5rcy5yZW1lbWJlciwgJ2luaXRpYWxCb290JywgZmFsc2UsICdzaGFyZWQnKTsKCiAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxpemF0aW9uQ29uZmlndXJhdGlvbikgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLmFiSW5pdGlhbGl6YXRpb25Db25maWd1cmF0aW9uKCk7CiAgICB9Cn0KCi8vY2xlYW4gdXAgVVJMIHdpdGggdGFnUG9ydGFsCmlmIChjb25maWdCb3QudGFncy50YWdQb3J0YWwgJiYgIWNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbEFuY2hvclBvaW50ICYmIGJ1aWxkZXJWZXJzaW9uKSB7CiAgICBjb25maWdCb3QudGFncy50YWdQb3J0YWwgPSBudWxsOwogICAgY29uZmlnQm90LnRhZ3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwp9CgovL3BhdXNlIGZvciBhYiBsb2FkaW5nCmF3YWl0IG9zLnNsZWVwKDUwMCk7CgovL2luaXRpYWxpemUgdGltZSBib3QKdGhpc0JvdC5hYlRpbWVyKCk7Cgp0aGlzQm90LmFiQ3JlYXRlVXBkYXRlQ2hlY2tlcigpOwoKbGlua3MucGVyc29uYWxpdHkudXBkYXRlUGVyc29uYWxpdHkoKTsKCi8vaW5pdGlhbGl6YXRpb24gc2hvdXQKc3VwZXJTaG91dCgib25BQkluaXRpYWxpemVkIiwgdGFncy5hYkluc3QpOygA+7G6/woABmFiQ29yZQF4JwD7sbr/CgAHYWJBZGFwdAIEAPuxuv8Kx1e+FEBsZXQgc2tpbGxOYW1lOwpsZXQgc2tpbGxEYXRhOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgc2tpbGxOYW1lID0gdGhhdDsKICAgIHNraWxsRGF0YSA9IG51bGw7Cn0gZWxzZSBpZiAodHlwZW9mIHRoYXQgPT09ICdvYmplY3QnKSB7CiAgICBza2lsbE5hbWUgPSB0aGF0LnN5c3RlbUlEID8/IHRoYXQuc2tpbGxOYW1lOwogICAgc2tpbGxEYXRhID0gdGhhdC5kYXRhID8/IG51bGw7Cn0KCmlmICghc2tpbGxOYW1lKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpbGxOYW1lIGlzIHJlcXVpcmVkLmApOwogICAgcmV0dXJuIGZhbHNlOwp9CgppZiAoc2tpbGxOYW1lID09PSAnYWJDb3JlJykgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX19XSBhYkNvbmZpZyBjYW5ub3QgYmUgbG9hZGVkIHVzaW5nIGFiQWRhcHQuYCk7CiAgICByZXR1cm47Cn0KCnRyeSB7CiAgICBjb25zdCBsb2FkZWRTa2lsbHMgPSB0aGlzQm90LmFiTG9hZGVkU2tpbGxzKCk7CgogICAgaWYgKCFsb2FkZWRTa2lsbHMuaW5jbHVkZXMoc2tpbGxOYW1lKSkgewogICAgICAgIGNvbnN0IHVybCA9IHRoaXNCb3QuYWJCdWlsZENhc3VhbENhdGFsb2dVUkwoYC9hYi8ke3NraWxsTmFtZX0uYXV4YCk7CiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYiBza2lsbCBHRVQgcmVzcG9uc2U6YCwgcmVzcG9uc2UpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkICR7c2tpbGxOYW1lfS4gUmVzcG9uc2U6ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIAogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIpIHsKICAgICAgICAgICAgLy8gQVVYIEZvcm1hdCBWZXJzaW9uIDIuCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZXMgPSByZXNwb25zZS5kYXRhLnVwZGF0ZXM7CiAgICAgICAgICAgIGF3YWl0IG9zLmFwcGx5VXBkYXRlc1RvSW5zdCh1cGRhdGVzKTsKICAgICAgICAgICAgY29uc3Qgc3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyh1cGRhdGVzKTsKICAgICAgICAgICAgY29uc3Qgc291cmNlSGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIHN0YXRlKTsKCiAgICAgICAgICAgIC8vIExvYWRlZCBza2lsbHMgYXJlIHN0b3JlZCBhcyBzaGFyZWQgYm90cyB0aGF0IGFueW9uZSBpbiB0aGUgaW5zdCBjYW4gcmVhZC4KICAgICAgICAgICAgY3JlYXRlKHsKICAgICAgICAgICAgICAgIHNwYWNlOiAnc2hhcmVkJywKICAgICAgICAgICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgICAgICAgICAgYWJMb2FkZWRTa2lsbDogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgYWJMb2FkZWRTa2lsbFNvdXJjZUhhc2g6IHNvdXJjZUhhc2gsCiAgICAgICAgICAgICAgICBmb3JtOiAnbm90aGluZycsCiAgICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEFVWCBmb3JtYXQgdmVyc2lvbiAke3Jlc3BvbnNlLmRhdGEudmVyc2lvbn0gaXMgbm90IHN1cHBvcnRlZC5gKTsKICAgICAgICB9CgogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIHNraWxsICR7c2tpbGxOYW1lfSBpcyBhbHJlYWR5IGxvYWRlZC5gKQogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBza2lsbEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzW3NraWxsTmFtZV0gPT09IHRydWUpOwogICAgaWYgKHNraWxsQm90cyAmJiBza2lsbEJvdHMubGVuZ3RoID4gMCkgewogICAgICAgIHdoaXNwZXIoc2tpbGxCb3RzLCB0YWdOYW1lLCBjb25maWdCb3QudGFncy5pbnN0KTsKICAgICAgICB3aGlzcGVyKHNraWxsQm90cywgIm9uU2tpbGxVcGRhdGUiLCB7IGRhdGE6IHNraWxsRGF0YSB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIE5vIGJvdHMgYXBwZWFyIHRvIGhhdmUgYmVlbiBsb2FkZWQgd2l0aCAke3NraWxsTmFtZX0uYCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwp9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEZhaWxlZCB0byBkb3dubG9hZCAke3NraWxsTmFtZX0uIFNlZSBhYm92ZSBlcnJvci5gKTsKICAgIHJldHVybiBmYWxzZTsKfScA+7G6/woAC2Rlc2NyaXB0aW9uAgQA+7G6/wqGbE9UaGlzIHNraWxsIGlzIGRlc2lnbmVkIHRvIGhhbmRsZSBib3RoIHJlY29uZmlndXJhdGlvbiBvZiBhYiBhbmQgaW5pdGlhbGl6YXRpb24uJwD7sbr/CgAKb25Cb3RBZGRlZAIEAPuxuv8K1mzxAUBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29yZSBTVEFSVCBVUGApOwoKdGhpc0JvdC5hYkluc3RVcGRhdGUoKTsKCmlmICghbGlua3MucmVtZW1iZXIpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZmluZCBhYkNvbmZpZyByZW1lbWJlciBib3QuYCk7Cn0KCnNldFRpbWVvdXQoKCkgPT4gdGhpc0JvdC5hYkJvb3QoKSwgNTAwKTsnAPuxuv8KAAhyZW1lbWJlcgIEAPuxuv8KyG4o8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA+7G6/woAA2xvZwIEAPuxuv8K725sQC8vcGFzcyB0aHJvdWdoIGxvZyBkYXRhCmlmIChsaW5rcy5jb25zb2xlKSB7CiAgICBsaW5rcy5jb25zb2xlLmxvZyh0aGF0KTsKfQplbHNlIHsKICAgIGNvbnNvbGUubG9nKHRoYXQpOwp9JwD7sbr/CgANbWFuaWZlc3RhdGlvbgIEAPuxuv8K3G8o8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA+7G6/woADGFiQ3JlYXRlSG9zdAIEAPuxuv8Kg3CbDUBjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKCi8vdGhpcyBmdW5jdGlvbiBoYW5kbGVzIGNyZWF0aW5nIGEgZmlsZSBmb3Igam9pbiBjb2RlcwppZiAobGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpIHsKICAgIG9zLnNldENsaXBib2FyZChzaXRlT3JpZ2luICsgIi8/am9pbkNvZGU9IiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKTsKICAgIGFiLmxpbmtzLnV0aWxzLmFiVG9hc3QoYHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkYCk7CiAgICByZXR1cm47Cn0KCmlmICghYXV0aEJvdCkgewogICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKfQoKaWYgKCFhdXRoQm90KSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBwbGVhc2UgbG9nIGluIHRvIGdlbmVyYXRlIGEgam9pbiBjb2RlYCk7CiAgICByZXR1cm47Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlSm9pbkNvZGUoKSB7CiAgICBjb25zdCBjaGFycyA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWjEyMzQ1Njc4OSc7CiAgICBsZXQgY29kZSA9ICcnOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHsKICAgICAgICBjb25zdCByYW5kb21JbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNoYXJzLmxlbmd0aCk7CiAgICAgICAgY29kZSArPSBjaGFyc1tyYW5kb21JbmRleF07CiAgICB9CiAgICByZXR1cm4gY29kZTsKfQoKY29uc3QgbmV3Sm9pbkNvZGUgPSBnZW5lcmF0ZUpvaW5Db2RlKCk7CmNvbnN0IGRhdGUgPSBvcy5pc0NvbGxhYm9yYXRpdmUoKSA/IG9zLmFncmVlZFVwb25UaW1lIDogb3MubG9jYWxUaW1lOwpjb25zdCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKLy8gW1J5YW4gQ29va106IFRoaXMgaXMgYSBuYWl2ZSByb29tIGNvZGUgZ2VuZXJhdG9yLiBJdCBkb2VzIG5vdCBjaGVjayBpZiB0aGUgcm9vbSBjb2RlIGlzIGFscmVhZHkgdGFrZW4gLyBhY3RpdmUuCmNvbnN0IHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHJlY29yZEtleSwgYGFiSm9pbkNvZGVfJHtuZXdKb2luQ29kZX1gLCB7IHVybDogY29uZmlnQm90LnRhZ3MudXJsLCBkYXRlIH0sIHsgbWFya2VyczogWyJwdWJsaWNSZWFkIl0gfSk7CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKSB7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnJlbWVtYmVyLCAnaG9zdElEJywgbmV3Sm9pbkNvZGUsICdzaGFyZWQnKTsKCiAgICBjb25zdCBqb2luVVJMID0gc2l0ZU9yaWdpbiArICIvP2pvaW5Db2RlPSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRDsKCiAgICBvcy5zZXRDbGlwYm9hcmQoam9pblVSTCk7CgogICAgaWYgKHRoYXQgJiYgdGhhdC50YWdzKSB7CiAgICAgICAgdGhhdC50YWdzLmxhYmVsID0gImpvaW4gY29kZTogIiArIG5ld0pvaW5Db2RlOwogICAgCiAgICB9CiAgICBvcy5zaG93UVJDb2RlKGpvaW5VUkwpOwoKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYGpvaW4gY29kZSBnZW5lcmF0ZWQ6ICR7bmV3Sm9pbkNvZGV9LiB1cmwgY29waWVkIHRvIGNsaXBib2FyZC5gKTsKfQplbHNlIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYGZhaWxlZCB0byBnZW5lcmF0ZSBqb2luIGNvZGUsIHBsZWFzZSB0cnkgYWdhaW4uYCk7CiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwp9JwD7sbr/CgAKYWJKb2luSG9zdAIEAPuxuv8Kn32sCkAvL2xvZ2ljIGZvciB1c2luZyBhIGpvaW4gY29kZSAoY2hlY2tzIGZvciBleGlzdGluZyBmaWxlcykKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmxldCBnZXRSZWNvcmQ7CgppZiAodGhhdC5kYXRhKSB7CiAgICBnZXRSZWNvcmQgPSB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHRoYXQuZGF0YSB9Owp9IGVsc2UgewogICAgY29uc3Qgam9pbkNvZGUgPSB0aGF0LnRleHQudG9VcHBlckNhc2UoKTsKICAgIGNvbnN0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGpvaW4gY29kZTpgLCBqb2luQ29kZSkKICAgIH0KCiAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYGFiSm9pbkNvZGVfJHtqb2luQ29kZX1gKTsKfQoKaWYgKGdldFJlY29yZCAmJiBnZXRSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3Qgbm93VGltZSA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWU7CiAgICBjb25zdCBub3dEYXRlID0gRGF0ZVRpbWUuZnJvbU1pbGxpcyhub3dUaW1lKTsKICAgIGNvbnN0IGNyZWF0ZURhdGUgPSBEYXRlVGltZS5mcm9tTWlsbGlzKGdldFJlY29yZC5kYXRhLmRhdGUpOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBub3dUaW1lOmAsIG5vd1RpbWUsIGBub3dEYXRlOmAsIG5vd0RhdGUsIGBjcmVhdGVEYXRlOmAsIGNyZWF0ZURhdGUpOwogICAgfQoKICAgIGxldCBkaWZmZXJlbmNlID0gbm93RGF0ZS5kaWZmKGNyZWF0ZURhdGUsICJkYXlzIikudG9PYmplY3QoKTsKICAgIGRpZmZlcmVuY2UgPSBNYXRoLmZsb29yKGRpZmZlcmVuY2UuZGF5cyk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRpZmZlcmVuY2UgKGRheXMpOmAsIGRpZmZlcmVuY2UpOwogICAgfQogICAgCiAgICBpZiAoZGlmZmVyZW5jZSA8IDgpIHsKICAgICAgICBvcy50b2FzdCgiam9pbmluZyBob3N0IG5vdyIpOwogICAgICAgIG9zLmdvVG9VUkwoZ2V0UmVjb3JkLmRhdGEudXJsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgb3MudG9hc3QoImpvaW4gY29kZSBvdXQgb2YgZGF0ZSwgcGxlYXNlIGdlbmVyYXRlIGEgbmV3IGpvaW4gY29kZSIpOwogICAgfQp9IGVsc2UgewogICAgb3MudG9hc3QoImpvaW4gY29kZSBpbnZhbGlkLCBwbGVhc2UgdHJ5IGFnYWluIik7Cn0nAPuxuv8KAAZzZWFyY2gCBAD7sbr/CsyHASjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwD7sbr/CgAIYWJJZ25vcmUCBAD7sbr/CvOHAQR0cnVlJwD7sbr/CgAEbWVudQIEAPuxuv8K+IcBKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAPuxuv8KABVhYlNraWxsSW5pdGlhbGl6YXRpb24CBAD7sbr/Cp+IAaMCQC8vRmluZCB0aGUgYXBwcm9wcmlhdGUgYXJyYXkgYW5kIHBvcHVsYXRlIHNraWxscwpsZXQgc2tpbGxBcnJheSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3NbdGhhdCArICJTa2lsbEFycmF5Il07Cgpmb3IgKGxldCBpID0gMDsgaSA8IHNraWxsQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdChza2lsbEFycmF5W2ldKTsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLmVtYmVkID09PSAnaW9zJykgewogICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCdhYklPU0JyaWRnZScpOwp9CgpyZXR1cm47JwD7sbr/CgAGYmFubmVyAgQA+7G6/wrDigEo8J+Ul2I1NTJlYWY5LWE5ZDYtNDFjOC04NTE1LWNiZDJhYmVhYWU3MycA+7G6/woABWlucHV0AgQA+7G6/wrqigEo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcA+7G6/woADWxvYWRpbmdTdGF0dXMCBAD7sbr/CpGLAcYHQGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTG9hZFN0YXR1cyI7CgpsZXQgc3RhdHVzQm90ID0ge307CgpzdGF0dXNCb3Quc3BhY2UgPSAidGVtcExvY2FsIjsKc3RhdHVzQm90LmxhYmVsID0gInZlcmlmeWluZyBhdXRoQm90IjsKc3RhdHVzQm90LmxhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwpzdGF0dXNCb3QuYWJMb2FkU3RhdHVzID0gdHJ1ZTsKc3RhdHVzQm90Lm1lbnVJdGVtU3R5bGUgPSB7ICJiYWNrZ3JvdW5kIjogIm5vbmUiIH07CnN0YXR1c0JvdC50cmFja051bSA9IDA7CnN0YXR1c0JvdC5vbkNyZWF0ZSA9IGBACiAgICBpZiAodGFncy50cmFja051bSA9PSAyKSB7CiAgICAgICAgdGFncy50cmFja051bSA9IDA7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICB0YWdzLnRyYWNrTnVtKys7CiAgICB9CgogICAgdGFncy5sYWJlbCA9IHRhZ3NbImxhYmVsIit0YWdzLnRyYWNrTnVtXTsKICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSB0YWdzWyJmb3JtIit0YWdzLnRyYWNrTnVtXTsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHdoaXNwZXIodGhpc0JvdCwgIm9uQ3JlYXRlIiksIDUwMCk7YDsKc3RhdHVzQm90LmxhYmVsMCA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4iOwpzdGF0dXNCb3QubGFiZWwxID0gInZlcmlmeWluZyBhdXRoQm90Li4iOwpzdGF0dXNCb3QubGFiZWwyID0gInZlcmlmeWluZyBhdXRoQm90Li4uIjsKc3RhdHVzQm90LmZvcm0wID0gImhvdXJnbGFzc19ib3R0b20iOwpzdGF0dXNCb3QuZm9ybTEgPSAiaG91cmdsYXNzX3RvcCI7CnN0YXR1c0JvdC5mb3JtMiA9ICJob3VyZ2xhc3NfYm90dG9tIjsKc3RhdHVzQm90Lm9uRGVzdHJveSA9IGBACiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7CgpsZXQgY3JlYXRlZFN0YXR1c0JvdCA9IGNyZWF0ZShzdGF0dXNCb3QpOwoKcmV0dXJuIGNyZWF0ZWRTdGF0dXNCb3Q7JwD7sbr/CgADYXNrAgQA+7G6/wrYkgEo8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycA+7G6/woADWFiTG9hZFN0dWRpb3MCBAD7sbr/Cv+SAVtAY29uc3QgdXNlclN0dWRpb3MgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsKY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zID0gdXNlclN0dWRpb3M7JwD7sbr/CgAHYWJUaW1lcgIEAPuxuv8K25MBwQZAaWYgKGdldEJvdCgiYWJUaW1lciIsIHRydWUpKSB7CiAgICByZXR1cm47Cn0KCmlmICghdGFncy5hYlhQKSB7CiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKfQoKbGV0IHRpbWVyQm90ID0ge307Cgp0aW1lckJvdC5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwp0aW1lckJvdC5tYW5hZ2VyID0gZ2V0TGluayh0aGlzQm90KTsKdGltZXJCb3Qub25DcmVhdGUgPSBgQAogICAgbWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzQm90Lm9uVGltZUNoZWNrKCksIDYwMDAwKTsKYDsKdGltZXJCb3QuYWJUaW1lciA9IHRydWU7CnRpbWVyQm90Lm9uVGltZUNoZWNrID0gYEAKICAgIGlmICh0YWdzLm5vdElkbGUpIHsKICAgICAgICB0YWdzLm5vdElkbGUgPSBmYWxzZTsKCiAgICAgICAgLy9jb25zb2xlLmxvZygiWFAiLCBsaW5rcy5tYW5hZ2VyLnRhZ3MuYWJYUCk7CgogICAgICAgIGNvbnN0IHRvdGFsWFAgPSBsaW5rcy5tYW5hZ2VyLnRhZ3MuYWJYUCArIDE7CgogICAgICAgIHNldFRhZ01hc2sobGlua3MubWFuYWdlciwgImFiWFAiLCB0b3RhbFhQLCAibG9jYWwiKTsKICAgIH0KYDsKdGltZXJCb3Qubm90SWRsZSA9IGZhbHNlOwp0aW1lckJvdC5vbkFueUFjdGlvbiA9IGBACiAgICBpZiAoIXRhZ3Mubm90SWRsZSkgewogICAgICAgIGlmICh0aGF0LmFjdGlvbi5pZCA9PSBncmlkUG9ydGFsQm90LmlkKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5ub3RJZGxlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CmA7CgpsZXQgYWJUaW1lciA9IGNyZWF0ZSh0aW1lckJvdCk7CgpnbG9iYWxUaGlzLmFiVGltZXIgPSBhYlRpbWVyOycA+7G6/woABXN0b3JlAgQA+7G6/wqdmgEo8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicA+7G6/woAB2NvbnNvbGUCBAD7sbr/CsSaASjwn5SXMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViJwD7sbr/CgAJYWJWZXJzaW9uAgQA+7G6/wrrmgEFMTAuMzInAPuxuv8KAAxhYkxvYWRDb25maWcCBAD7sbr/CvGaAZoGQGNvbnN0IHVybCA9IG5ldyBVUkwob3MuZ2V0QUIxQm9vdHN0cmFwVVJMKCkpOwp1cmwucGF0aG5hbWUgPSB1cmwucGF0aG5hbWUucmVwbGFjZSgnYWIxLmF1eCcsICdhYkNvbmZpZy5hdXgnKTsKCnRyeSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiB1cmwuaHJlZiB9KTsKCiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCBhYkNvbmZpZy4gUmVzcG9uc2U6ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3QgdXBkYXRlcyA9IHJlc3BvbnNlLmRhdGEudXBkYXRlczsKICAgIGF3YWl0IG9zLmFwcGx5VXBkYXRlc1RvSW5zdCh1cGRhdGVzKTsKCiAgICBpZiAobGlua3MucmVtZW1iZXIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIExvYWRlZCBhYkNvbmZpZyBhdXggYnV0IGNvdWxkIG5vdCBmaW5kIHJlbWVtYmVyIGJvdC5gKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gRmFpbGVkIHRvIGRvd25sb2FkIGFiQ29uZmlnLiBTZWUgYWJvdmUgZXJyb3IuYCk7CiAgICByZXR1cm4gZmFsc2U7Cn0nAPuxuv8KABdhYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTAIEAPuxuv8KjKEB/wFAY29uc3QgcmVsYXRpdmVQYXRoID0gdGhhdDsKCmNvbnN0IHVybCA9IG5ldyBVUkwobGlua3MucmVtZW1iZXIudGFncy5jYXN1YWxDYXRhbG9nVVJMKTsKY29uc3QgZW52ID0gbGlua3MucmVtZW1iZXIudGFncy5jYXN1YWxDYXRhbG9nRW52OwoKdXJsLnBhdGhuYW1lID0gcmVsYXRpdmVQYXRoOwoKaWYgKGVudiAmJiBlbnYgIT09ICdwcm9kJykgewogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2VudicsIGVudik7Cn0KCnJldHVybiB1cmwuaHJlZjsnAPuxuv8KAAdjaGFubmVsAgQA+7G6/wqMowEo8J+Ul2E5YjZhYTBkLWIzNTctNGRlNi05YmVmLTg1MzQ4YWIxZDBlMCcA+7G6/woAC3BlcnNvbmFsaXR5AgQA+7G6/wqzowEo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicA+7G6/woADGFiSW5zdFVwZGF0ZQIEAPuxuv8K2qMBogFALy8gVXBkYXRlIHRoZSBhYkluc3QgdGFnIHdoaWNoIHJlcHJlc2VudHMgdGhlIGluc3QgdGhhdCB0aGlzIGFiIGV4aXN0cyBpbi4KY29uc3QgY3VySW5zdCA9IG9zLmdldEN1cnJlbnRJbnN0KCk7CnNldFRhZ01hc2sodGhpc0JvdCwgJ2FiSW5zdCcsIGN1ckluc3QsICdzaGFyZWQnKTsnAPuxuv8KAAxvbkluc3RKb2luZWQCBAD7sbr/Cv2kARhAdGhpc0JvdC5hYkluc3RVcGRhdGUoKTsnAPuxuv8KAAtvbkluc3RMZWF2ZQIEAPuxuv8KlqUBGEB0aGlzQm90LmFiSW5zdFVwZGF0ZSgpOycA+7G6/woADHJlc2VydmVkQXNrcwIEAPuxuv8Kr6UBDPCfp6xbImhvbWUiXScA+7G6/woACGFydGlmYWN0AgQA+7G6/wq6pQEo8J+Ulzc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNycA+7G6/woAC2JvdF9mYWN0b3J5AgQA+7G6/wrhpQEo8J+Ul2M3OGFhNjYzLWQwNWMtNGVjNC1iYzJjLTI2ZmQ1MTU2MGI5NycA+7G6/woABXV0aWxzAgQA+7G6/wqIpgEo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycA+7G6/woACHVwZGF0ZUFCAgQA+7G6/wqvpgGVKUBjb25zdCByZWxvYWRQYWdlID0gdGhhdD8ucmVsb2FkUGFnZSA/PyB0cnVlOw0KY29uc3Qgc2hvd0luZGljYXRvciA9IHRoYXQ/LnNob3dJbmRpY2F0b3IgPz8gdHJ1ZTsNCg0KY29uc3QgRFJZX1JVTiA9IGZhbHNlOw0KDQpsZXQgYnVzeUluZGljYXRvcjsNCg0KaWYgKHNob3dJbmRpY2F0b3IpIHsNCiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICd1cGRhdGVBQk1lbnUnOw0KICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyB1cGRhdGVBQk1lbnU6IHRydWUsIGxhYmVsOiBgdXBkYXRpbmcgJHtsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5fWAgfSk7DQp9DQoNCmxldCBvdmVyd3JpdGVSZXN1bHQ7DQoNCnRyeSB7DQogICAgLy8gVXBkYXRlIGFiQ29uZmlnLg0KICAgIGNvbnN0IGFiQ29uZmlnVVJMID0gb3MuZ2V0QUIxQm9vdHN0cmFwVVJMKCk7DQogICAgY29uc3QgYWJDb25maWdSZXNwb25zZSA9IGF3YWl0IHdlYmhvb2soeyBtZXRob2Q6ICJHRVQiLCB1cmw6IGFiQ29uZmlnVVJMIH0pOw0KDQogICAgYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzID09PSAyMDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkIGFiQ29uZmlnLiBSZXNwb25zZTogJHthYkNvbmZpZ1Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7DQogICAgYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7DQoNCiAgICBvdmVyd3JpdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmF1eFYyT3ZlcndyaXRlKHsgYXV4OiBhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEsIGdyb3VwVGFnOiAnYWJDb25maWcnLCBkcnlSdW46IERSWV9SVU4gfSk7DQogICAgc2V0VGFnTWFzayhhYi5saW5rcy5yZW1lbWJlciwgJ2FiQ29uZmlnU291cmNlSGFzaCcsIG92ZXJ3cml0ZVJlc3VsdC5zb3VyY2VIYXNoLCAnc2hhcmVkJyk7DQoNCiAgICAvLyBVcGRhdGUgYWIgc2tpbGxzLg0KICAgIGNvbnN0IGxvYWRlZFNraWxscyA9IHRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKTsNCg0KICAgIGZvciAobGV0IHNraWxsTmFtZSBvZiBsb2FkZWRTa2lsbHMpIHsNCiAgICAgICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOw0KDQogICAgICAgIC8vIFNraWxscyBjYW4gYmUgcmVzdHJ1Y3R1cmVkLCBtZWFuaW5nIHRoYXQgdGhleSBjb3VsZCBiZSByZW1vdmVkIGVudGlyZWx5IGluIHRoZSBmdXR1cmUuDQogICAgICAgIC8vIElmIGEgZmlsZSBmYWlscyB0byBiZSByZXRyaWV2ZWQsIHRoZW4gcmVtb3ZlIGFsbCB0aGUgYm90cyBpbiB0aGUgZ3JvdXAgaW4gdGhlIGluc3QuDQogICAgICAgIGxldCByZW1vdmVTa2lsbCA9IGZhbHNlOw0KICAgICAgICBsZXQgc2tpbGxSZXNwb25zZTsNCg0KICAgICAgICB0cnkgew0KICAgICAgICAgICAgc2tpbGxSZXNwb25zZSA9IGF3YWl0IHdlYmhvb2soeyBtZXRob2Q6ICJHRVQiLCB1cmw6IHNraWxsVVJMIH0pOw0KDQogICAgICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpbGxSZXNwb25zZTpgLCBza2lsbFJlc3BvbnNlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgYXNzZXJ0KHNraWxsUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7c2tpbGxOYW1lfSBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke3NraWxsUmVzcG9uc2UuZGF0YS52ZXJzaW9ufWApOw0KDQogICAgICAgICAgICBpZiAoc2tpbGxSZXNwb25zZS5zdGF0dXMgIT09IDIwMCkgew0KICAgICAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsNCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlU2tpbGwgPSB0cnVlOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCAke3NraWxsTmFtZX0uIFJlc3BvbnNlOiAke3NraWxsUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYXVnaHQgZXJyb3Igd2hpbGUgZG93bmxvYWRpbmcgc2tpbGw6YCwgZSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmIChlLnJlc3BvbnNlPy5zdGF0dXMgPT09IDQwMyB8fCBlLnJlc3BvbnNlPy5zdGF0dXMgPT09IDQwNCkgew0KICAgICAgICAgICAgICAgIC8vIEZpbGUgZG9lc250IGV4aXN0IGFueW1vcmUsIHRoZSBza2lsbCBoYXMgYmVlbiByZW1vdmVkLg0KICAgICAgICAgICAgICAgIHJlbW92ZVNraWxsID0gdHJ1ZTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgdGhyb3cgZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYgKHNraWxsUmVzcG9uc2UgJiYgIXJlbW92ZVNraWxsKSB7DQogICAgICAgICAgICBvdmVyd3JpdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmF1eFYyT3ZlcndyaXRlKHsgYXV4OiBza2lsbFJlc3BvbnNlLmRhdGEsIGdyb3VwVGFnOiBza2lsbE5hbWUsIGRyeVJ1bjogRFJZX1JVTiB9KTsNCg0KICAgICAgICAgICAgY29uc3QgbG9hZGVkU2tpbGxCb3QgPSBnZXRCb3QoYiA9PiBiLnRhZ3MuYWJMb2FkZWRTa2lsbCA9PT0gc2tpbGxOYW1lICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsNCiAgICAgICAgICAgIGFzc2VydChsb2FkZWRTa2lsbEJvdCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb3VsZCBub3QgZmluZCBsb2FkZWQgc2tpbGwgYm90IGZvciAke3NraWxsTmFtZX0uYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHNldFRhZ01hc2sobG9hZGVkU2tpbGxCb3QsICdhYkxvYWRlZFNraWxsU291cmNlSGFzaCcsIG92ZXJ3cml0ZVJlc3VsdC5zb3VyY2VIYXNoLCAnc2hhcmVkJyk7DQogICAgICAgIH0gZWxzZSBpZiAocmVtb3ZlU2tpbGwpIHsNCiAgICAgICAgICAgIGNvbnN0IHNraWxsQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3Nbc2tpbGxOYW1lXSA9PT0gdHJ1ZSk7DQoNCiAgICAgICAgICAgIGlmIChEUllfUlVOKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBkZWxldGUgJHtza2lsbEJvdHMubGVuZ3RofSAke3NraWxsTmFtZX0gYm90KHMpIGJlY2F1c2UgJHtza2lsbE5hbWV9IGlzIG5vIGxvbmdlciBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuYCkNCiAgICAgICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU2tpbGwgJHtza2lsbE5hbWV9IGlzIG5vIGxvbmdlciBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuIFJlbW92ZSAke3NraWxsQm90cy5sZW5ndGh9ICR7c2tpbGxOYW1lfSBib3QocykgZnJvbSBpbnN0LmApOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkZXN0cm95KHNraWxsQm90cyk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBVcGRhdGUgYWJDb3JlIChkbyB0aGlzIG9uZSBsYXN0ISkNCiAgICBjb25zdCBhYkNvcmVVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKCcvYWIvYWJDb3JlLmF1eCcpOw0KICAgIGNvbnN0IGFiQ29yZVJlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICJHRVQiLCB1cmw6IGFiQ29yZVVSTCB9KTsNCg0KICAgIGFzc2VydChhYkNvcmVSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb3JlLiBSZXNwb25zZTogJHthYkNvcmVSZXNwb25zZS5zdGF0dXNUZXh0fWApOw0KICAgIGFzc2VydChhYkNvcmVSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJDb3JlIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb3JlUmVzcG9uc2UuZGF0YS52ZXJzaW9ufWApOw0KDQogICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogYWJDb3JlUmVzcG9uc2UuZGF0YSwgZ3JvdXBUYWc6ICdhYkNvcmUnLCBkcnlSdW46IERSWV9SVU4gfSk7DQogICAgc2V0VGFnTWFzayhhYiwgJ2FiQ29yZVNvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KDQogICAgaWYgKHJlbG9hZFBhZ2UpIHsNCiAgICAgICAgY29uc3QgcmVtb3RlRGF0YUV2ZW50ID0gJ3VwZGF0ZV9hYl9yZWxvYWRfcGFnZSc7DQogICAgICAgIGNvbnN0IHJlbW90ZURhdGFBcmcgPSB7IHJlbG9hZFBhZ2UsIGRyeVJ1bjogRFJZX1JVTiB9Ow0KDQogICAgICAgIGlmIChvcy5pc0NvbGxhYm9yYXRpdmUoKSkgew0KICAgICAgICAgICAgY29uc3QgcmVtb3RlcyA9IGF3YWl0IG9zLnJlbW90ZXMoKTsNCiAgICAgICAgICAgIHNlbmRSZW1vdGVEYXRhKHJlbW90ZXMsIHJlbW90ZURhdGFFdmVudCwgcmVtb3RlRGF0YUFyZyk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB0aGlzQm90Lm9uUmVtb3RlRGF0YSh7IG5hbWU6IHJlbW90ZURhdGFFdmVudCwgdGhhdDogcmVtb3RlRGF0YUFyZywgcmVtb3RlSWQ6IGNvbmZpZ0JvdC5pZCB9KTsNCiAgICAgICAgfQ0KICAgIH0NCn0gZmluYWxseSB7DQogICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsNCiAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsNCiAgICAgICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOw0KICAgIH0NCn0nAPuxuv8KAAVkZWJ1ZwIEAPuxuv8Kxc8BBWZhbHNlJwD7sbr/CgAVYWJDcmVhdGVVcGRhdGVDaGVja2VyAgQA+7G6/wrLzwG9E0BsZXQgYWJVcGRhdGVDaGVja2VyID0gZ2V0Qm90KCdhYlVwZGF0ZUNoZWNrZXInLCB0cnVlKTsKCmlmIChhYlVwZGF0ZUNoZWNrZXIpIHsKICAgIGdsb2JhbFRoaXMuYWJVcGRhdGVDaGVja2VyID0gYWJVcGRhdGVDaGVja2VyOwogICAgcmV0dXJuIGFiVXBkYXRlQ2hlY2tlcjsKfQoKbGV0IG1vZCA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIGFiVXBkYXRlQ2hlY2tlcjogdHJ1ZSwKICAgIGFiSWdub3JlOiB0cnVlLAogICAgY2hlY2tpbmc6IGZhbHNlLAogICAgdXBkYXRlQXZhaWxhYmxlOiBmYWxzZSwKICAgIGRlYnVnOiBmYWxzZSwKICAgIG9uQ3JlYXRlOiBgQAogICAgICAgIHRoaXNCb3Quc3RhcnRJbnRlcnZhbCgpOwogICAgICAgIHRoaXNCb3Qub25VcGRhdGVDaGVjaygpOwogICAgYCwKICAgIHN0YXJ0SW50ZXJ2YWw6IGBACiAgICAgICAgaWYgKCF0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGNvbnN0IFVQREFURV9DSEVDS19JTlRFUlZBTF9NSU5VVEVTID0gNTsKICAgICAgICAgICAgY29uc3QgaW50ZXJ2YWxNUyA9IFVQREFURV9DSEVDS19JTlRFUlZBTF9NSU5VVEVTICogNjAgKiAxMDAwOwogICAgICAgICAgICB0YWdzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5vblVwZGF0ZUNoZWNrKCksIGludGVydmFsTVMpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSBzdGFydCB1cGRhdGUgY2hlY2sgaW50ZXJ2YWwgbXM6JywgaW50ZXJ2YWxNUyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICBgLAogICAgc3RvcEludGVydmFsOiBgQAogICAgICAgIGlmICh0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGFncy5pbnRlcnZhbCk7CiAgICAgICAgICAgIHRhZ3MuaW50ZXJ2YWwgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSBzdG9wIHVwZGF0ZSBjaGVjayBpbnRlcnZhbC4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIGAsCiAgICBmb3JjZVVwZGF0ZUNoZWNrOiBgQAogICAgICAgIHRoaXNCb3Quc3RvcEludGVydmFsKCk7CiAgICAgICAgdGhpc0JvdC5zdGFydEludGVydmFsKCk7CiAgICAgICAgdGhpc0JvdC5vblVwZGF0ZUNoZWNrKHsgZm9yY2U6IHRydWUgfSk7CiAgICBgLAogICAgb25VcGRhdGVDaGVjazogYEAKICAgICAgICBjb25zdCBmb3JjZSA9IHRoYXQ/LmZvcmNlID8/IGZhbHNlOwoKICAgICAgICBpZiAoIXRhZ3MuY2hlY2tpbmcpIHsKICAgICAgICAgICAgaWYgKCF0YWdzLnVwZGF0ZUF2YWlsYWJsZSB8fCBmb3JjZSkgewogICAgICAgICAgICAgICAgdGFncy5jaGVja2luZyA9IHRydWU7CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhYi5hYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1thYlVwZGF0ZUNoZWNrZXJdIHVwZGF0ZSBjaGVjayByZXN1bHQ6JywgcmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdzLnVwZGF0ZUF2YWlsYWJsZSA9IHJlc3VsdC51cGRhdGVBdmFpbGFibGU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnVwZGF0ZUF2YWlsYWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdXQoJ29uQUJVcGRhdGVBdmFpbGFibGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgdGFncy5jaGVja2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gc2tpcCB1cGRhdGUgY2hlY2sg4oCUIHVwZGF0ZSBpcyBhbHJlYWR5IGtub3duIHRvIGJlIGF2YWlsYWJsZS4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gdXBkYXRlIGNoZWNrIGFscmVhZHkgaW4gcHJvZ3Jlc3MuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgYCwKfQoKYWJVcGRhdGVDaGVja2VyID0gY3JlYXRlKG1vZCk7Cmdsb2JhbFRoaXMuYWJVcGRhdGVDaGVja2VyID0gYWJVcGRhdGVDaGVja2VyCgpyZXR1cm4gYWJVcGRhdGVDaGVja2VyOycA+7G6/woADmF1eFYyT3ZlcndyaXRlAgQA+7G6/wqH4wGRKkBjb25zdCBhdXggPSB0aGF0Py5hdXg7CmNvbnN0IGdyb3VwVGFnID0gdGhhdD8uZ3JvdXBUYWc7CmNvbnN0IGRyeVJ1biA9IHRoYXQ/LmRyeVJ1biA/PyBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmFzc2VydChhdXg/LnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXV4IHBhcmFtZXRlciBpcyByZXF1aXJlZCB0byBiZSBhIHYyIGF1eCBmaWxlLmApOwphc3NlcnQoZ3JvdXBUYWcgPT0gbnVsbCB8fCB0eXBlb2YgZ3JvdXBUYWcgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdyb3VwVGFnIHBhcmFtZXRlciBpZiBwcm92aWRlZCwgbXVzdCBiZSBhIHN0cmluZy5gKTsKCmNvbnN0IHN0YXRlID0gYXdhaXQgb3MuZ2V0SW5zdFN0YXRlRnJvbVVwZGF0ZXMoYXV4LnVwZGF0ZXMpOwoKLy8gU3VwZXIgaGFyZGNvZGVkIG1lc3N5IGZpeCBmb3IgY29tcHV0aW5nIGFiQ29uZmlnIHNvdXJjZSBoYXNoLgppZiAoZ3JvdXBUYWcgPT09ICdhYkNvbmZpZycpIHsgCiAgICBmb3IgKGxldCBpZCBpbiBzdGF0ZSkgewogICAgICAgIGRlbGV0ZSBzdGF0ZVtpZF0udGFncy5iYXNlQUI7IC8vIGJhc2VBQiBpcyBhbiBhbm5veWluZyB0YWcgdGhhdCBzaG91bGQgbm90IGJlIGNvbXB1dGVkIGFzIHBhcnQgb2YgaGFzaCBzdGF0ZS4KICAgIH0KfQoKbGV0IHNvdXJjZUhhc2ggPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBzdGF0ZSk7CmxldCBwcmV2R3JvdXBCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFnc1tncm91cFRhZ10gPT09IHRydWUpOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhdGU6YCwgc3RhdGUpOwogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwcmV2R3JvdXBCb3RzOmAsIHByZXZHcm91cEJvdHMpOwp9CgovLyBTdGVwIDE6IEFwcGx5IHVwZGF0ZXMgZGlyZWN0bHkgdG8gdGhlIGluc3QgYXMtaXMuCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFN0ZXAgMTogQXBwbHkgdXBkYXRlcyBkaXJlY3RseSB0byB0aGUgaW5zdCBhcy1pcy5gKTsKfQoKaWYgKCFkcnlSdW4pIHsKICAgIGF3YWl0IG9zLmFwcGx5VXBkYXRlc1RvSW5zdChhdXgudXBkYXRlcyk7Cn0gZWxzZSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGFwcGx5IHVwZGF0ZXMgdG8gaW5zdC5gKQp9CgovLyBTdGVwIDI6IERlbGV0ZSBwcmV2aW91cyBncm91cCBib3RzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBTdGVwIDI6IERlbGV0ZSBwcmV2aW91cyBncm91cCBib3RzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLmApOwp9Cgpmb3IgKGNvbnN0IHByZXZHcm91cEJvdCBvZiBwcmV2R3JvdXBCb3RzKSB7CiAgICBpZiAoc3RhdGVbcHJldkdyb3VwQm90LmlkXSA9PSBudWxsKSB7CiAgICAgICAgaWYgKGRyeVJ1bikgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGRlbGV0ZSBib3QgJHtwcmV2R3JvdXBCb3QuaWR9IHByZXZpb3VzbHkgYmVsb25naW5nIHRvIGdyb3VwICR7Z3JvdXBUYWd9YCk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIHByZXZpb3VzIGdyb3VwIGJvdCAke3ByZXZHcm91cEJvdC5pZH0gdGhhdCBpcyBubyBsb25nZXIgaW4gdGhlIHVwZGF0ZSBzdGF0ZS5gKTsKICAgICAgICB9CgogICAgICAgIGRlc3Ryb3kocHJldkdyb3VwQm90KTsKICAgIH0KfQoKLy8gU3RlcCAzOiBGb3IgZWFjaCBib3QgaW4gdGhlIHVwZGF0ZSBzdGF0ZSwgY3JlYXRlLCB1cGRhdGUsIGFuZCBkZWxldGUgdGFncyBvbiB0aGUgZXhpc3RpbmcgYm90cyBpbiB0aGUgaW5zdC4KaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU3RlcCAzOiBGb3IgZWFjaCBib3QgaW4gdGhlIHVwZGF0ZSBzdGF0ZSwgY3JlYXRlLCB1cGRhdGUsIGFuZCBkZWxldGUgdGFncyBvbiB0aGUgZXhpc3RpbmcgYm90cyBpbiB0aGUgaW5zdC5gKTsKfQoKZm9yIChjb25zdCBib3RJZCBpbiBzdGF0ZSkgewogICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgIGNvbnN0IGJvdFN0YXRlID0gc3RhdGVbYm90SWRdOwoKICAgIGlmIChib3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIGV4aXN0aW5nIGJvdCAke2JvdElkfWApOwogICAgICAgIH0KCiAgICAgICAgLy8gSGFuZGxlcyB0YWcgY3JlYXRlIC8gdXBkYXRlLgogICAgICAgIGZvciAoY29uc3Qgc3RhdGVUYWdOYW1lIGluIGJvdFN0YXRlLnRhZ3MpIHsKICAgICAgICAgICAgaWYgKGJvdC5yYXdbc3RhdGVUYWdOYW1lXSAhPSBib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV0pIHsKICAgICAgICAgICAgICAgIGlmIChkcnlSdW4pIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIHNldCB0YWcgJyR7c3RhdGVUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9IHRvIHZhbHVlOmAsIGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldCB0YWcgJyR7c3RhdGVUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9IHRvOmAsIGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm90LnRhZ3Nbc3RhdGVUYWdOYW1lXSA9IGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAoYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBmb3IgYm90ICR7Ym90SWR9IGlzIG51bGwsIGNsZWFyaW5nIGFueSB0YWcgbWFza3MgYXMgd2VsbC5gKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGFsbCBwb3NzaWJsZSBtYXNrcyBmb3IgdGhpcyB0YWcgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAnbG9jYWwnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAndGVtcExvY2FsJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIHN0YXRlVGFnTmFtZSwgbnVsbCwgJ3NoYXJlZCcpOwogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICd0ZW1wU2hhcmVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGFnICcke3N0YXRlVGFnTmFtZX0nIGZvciBib3QgJHtib3RJZH0gaXMgYWxyZWFkeSB1cC10by1kYXRlLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBEZWxldGUgdGFncyAoYW5kIG1hc2tzIGZvciB0aG9zZSB0YWdzKSBvbiBleGlzdGluZyBib3QgdGhhdCBhcmUgbm90IGluIHVwZGF0ZSBzdGF0ZS4KICAgICAgICBjb25zdCBib3RUYWdzID0gT2JqZWN0LmtleXMoYm90LnRhZ3MpOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdFRhZ05hbWUgb2YgYm90VGFncykgewogICAgICAgICAgICBpZiAoYm90U3RhdGUudGFnc1tib3RUYWdOYW1lXSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBkZWxldGUgdGFnICcke2JvdFRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0uYCk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlbGV0ZSB0YWcgKGFuZCBtYXNrcykgJyR7Ym90VGFnTmFtZX0nIG9uIGJvdCAke2JvdElkfS5gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBib3QudGFnc1tib3RUYWdOYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbGwgcG9zc2libGUgbWFza3MgZm9yIHRoaXMgdGFnIGFzIHdlbGwuCiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ2xvY2FsJyk7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ3RlbXBMb2NhbCcpOwogICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIGJvdFRhZ05hbWUsIG51bGwsICdzaGFyZWQnKTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAndGVtcFNoYXJlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgYm90ICR7Ym90SWR9IGluIGluc3QuYCk7CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRvbmUuYCk7Cn0KCmNvbnN0IGJvdElkcyA9IE9iamVjdC5rZXlzKHN0YXRlKTsKCnJldHVybiB7CiAgICBncm91cFRhZywKICAgIGJvdElkcywKICAgIHNvdXJjZUhhc2gsCn07JwD7sbr/CgAOYWJMb2FkZWRTa2lsbHMCBAD7sbr/CpmNArYBQGNvbnN0IGxvYWRlZFNraWxscyA9IG5ldyBTZXQoKTsKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJMb2FkZWRTa2lsbCAhPSBudWxsKSB7CiAgICAgICAgbG9hZGVkU2tpbGxzLmFkZChiLnRhZ3MuYWJMb2FkZWRTa2lsbCk7CiAgICB9Cn0pOwoKcmV0dXJuIEFycmF5LmZyb20obG9hZGVkU2tpbGxzKTsnAPuxuv8KAAxvblJlbW90ZURhdGECBAD7sbr/CtCOAqcFQGlmICh0aGF0Lm5hbWUgPT09ICd1cGRhdGVfYWJfcmVsb2FkX3BhZ2UnKSB7CiAgICBjb25zdCB7IHJlbG9hZFBhZ2UsIGRyeVJ1biB9ID0gdGhhdC50aGF0OwoKICAgIGlmICh0aGF0LnJlbW90ZUlkID09PSBjb25maWdCb3QuaWQpIHsKICAgICAgICAvLyBXYWl0IGEgbW9tZW50IGJlZm9yZSByZWxvYWRpbmcgdGhlIHBhZ2UgaWYgd2UgYXJlIHRoZSBvbmVzIHRoYXQgc2VudCBvdXQgdGhlIG1lc3NhZ2UuCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMTAwMCk7CiAgICB9CgogICAgbGV0IGlzVVJMID0gZmFsc2U7CgogICAgaWYgKHR5cGVvZiByZWxvYWRQYWdlID09PSAnc3RyaW5nJykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIG5ldyBVUkwocmVsb2FkUGFnZSk7CiAgICAgICAgICAgIGlzVVJMID0gdHJ1ZTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgfQoKICAgIGxldCB1cmwgPSBpc1VSTCA/IHJlbG9hZFBhZ2UgOiBjb25maWdCb3QudGFncy51cmw7CgogICAgaWYgKGRyeVJ1bikgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZ28gdG8gdXJsYCwgdXJsKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIG9zLmdvVG9VUkwoaXNVUkwgPyByZWxvYWRQYWdlIDogY29uZmlnQm90LnRhZ3MudXJsKTsKfScA+7G6/woACW9uRW50ZXJBUgIEAPuxuv8K+JMCE0BtYXNrcy5pbkFSID0gdHJ1ZTsnAPuxuv8KAAhvbkV4aXRBUgIEAPuxuv8KjJQCE0BtYXNrcy5pbkFSID0gbnVsbDsnAPuxuv8KAAlvbkVudGVyVlICBAD7sbr/CqCUAhNAbWFza3MuaW5WUiA9IHRydWU7JwD7sbr/CgAIb25FeGl0VlICBAD7sbr/CrSUAhNAbWFza3MuaW5WUiA9IG51bGw7JwD7sbr/CgAGY3JlYXRlAgQA+7G6/wrIlAIo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycA+7G6/woABXBhc3RlAgQA+7G6/wrvlAIo8J+Ul2IzMzljMTE4LTQ4OWEtNDY2Yi1iYTlmLWIwN2E1ZjliNjY0ZgA="}]}