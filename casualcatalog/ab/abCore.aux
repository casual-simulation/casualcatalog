{"version":2,"updates":[{"id":0,"timestamp":1767654894601,"update":"AXKftKfcBAAnAQRib3RzJDY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNwEnAJ+0p9wEABhhYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUCBACftKfcBAGVLEBjb25zdCBkZXRhaWxlZCA9IHRoYXQ/LmRldGFpbGVkID8/IGZhbHNlOwpjb25zdCBoYXNoQWxnb3JpdGhtID0gdGhhdD8uaGFzaEFsZ29yaXRobSA/PyAnc2hhMSc7CmNvbnN0IGhhc2hGb3JtYXQgPSB0aGF0Py5oYXNoRm9ybWF0ID8/ICdoZXgnOwoKaW50ZXJmYWNlIEFCRmlsZVVwZGF0ZUNoZWNrIHsKICAgIGZpbGVOYW1lOiBzdHJpbmc7CiAgICB1cGRhdGVBdmFpbGFibGU6IGJvb2xlYW47CiAgICBjdXJyZW50SGFzaDogc3RyaW5nOwogICAgbGF0ZXN0SGFzaDogc3RyaW5nOwogICAgcmVtb3ZlZDogYm9vbGVhbjsKfQoKLy8gVGhpcyBsaXN0IG9mIGFiIGZpbGUgY2hlY2tzLCB0aGlzIHdpbGwgb25seSBiZSBwb3B1bGF0ZWQgaWYgJ2RldGFpbGVkJyBpcyB0cnVlLgpjb25zdCBhYkZpbGVDaGVja3M6IEFCRmlsZVVwZGF0ZUNoZWNrW10gPSBbXTsKCmFzeW5jIGZ1bmN0aW9uIGNoZWNrU2tpbGxPdXRkYXRlZChza2lsbE5hbWU6IHN0cmluZywgY3VycmVudEhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gewogICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOyAgICAgICAgCiAgICBsZXQgc2tpbGxSZW1vdmVkID0gZmFsc2U7CiAgICBsZXQgc2tpbGxSZXNwb25zZTsKCiAgICB0cnkgewogICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbFJlc3BvbnNlOmAsIHNraWxsUmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhc3NlcnQoc2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHtza2lsbE5hbWV9IG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7c2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7CgogICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBlcnJvciB3aGlsZSBkb3dubG9hZGluZyBza2lsbDpgLCBlKTsKICAgICAgICAKICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgLy8gRmlsZSBkb2VzbnQgZXhpc3QgYW55bW9yZSwgdGhlIHNraWxsIGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHNraWxsUmVtb3ZlZCkgewogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoOiBudWxsLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSwKICAgICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBDYWxjdWxhdGUgaGFzaCBvZiBhYiBmaWxlIHN0YXRlIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHNraWxsUmVzcG9uc2UuZGF0YS51cGRhdGVzKTsKICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgc3RhdGUpOwogICAgICAgIAogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgbGF0ZXN0VXBkYXRlczogc2tpbGxSZXNwb25zZS5kYXRhLnVwZGF0ZXMsCiAgICAgICAgICAgICAgICBsYXRlc3RTdGF0ZTogc3RhdGUsCiAgICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2g7CiAgICB9Cn0KCi8vIDEuIENoZWNrIGlmIGFiQ29uZmlnIGlzIG91dGRhdGVkLgpjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOwpjb25zdCBhYkNvbmZpZ1Jlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb25maWdVUkwgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZ1Jlc3BvbnNlOmAsIGFiQ29uZmlnUmVzcG9uc2UpOwp9Cgphc3NlcnQoYWJDb25maWdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke2FiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7Cgpjb25zdCBhYkNvbmZpZ0N1cnJlbnRIYXNoID0gYWIubGlua3MucmVtZW1iZXIudGFncy5hYkNvbmZpZ1NvdXJjZUhhc2g7CmNvbnN0IGFiQ29uZmlnTGF0ZXN0U3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcyk7CmZvciAobGV0IGlkIGluIGFiQ29uZmlnTGF0ZXN0U3RhdGUpIHsKICAgIGRlbGV0ZSBhYkNvbmZpZ0xhdGVzdFN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgp9CmNvbnN0IGFiQ29uZmlnTGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiQ29uZmlnTGF0ZXN0U3RhdGUpOwoKaWYgKGRldGFpbGVkKSB7CiAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgZmlsZU5hbWU6ICdhYkNvbmZpZycsCiAgICAgICAgY3VycmVudEhhc2g6IGFiQ29uZmlnQ3VycmVudEhhc2gsCiAgICAgICAgbGF0ZXN0SGFzaDogYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIHJlbW92ZWQ6IGZhbHNlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIGxhdGVzdFVwZGF0ZXM6IGFiQ29uZmlnUmVzcG9uc2UuZGF0YS51cGRhdGVzLAogICAgICAgIGxhdGVzdFN0YXRlOiBhYkNvbmZpZ0xhdGVzdFN0YXRlLAogICAgfSkKfQoKaWYgKCFkZXRhaWxlZCAmJiAoYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoKSkgewogICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgaW4gc2ltcGxlIG1vZGUsIHJldHVybiByaWdodCBhd2F5IG9uIHRoZSBmaXJzdCBvdXRkYXRlZCBmaWxlIGRpc2NvdmVyeS4KICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSB9Cn0KCi8vIDIuIENoZWNrIGlmIGFiIHNraWxscyBhcmUgb3V0ZGF0ZWQuCmNvbnN0IGFiU2tpbGxOYW1lcyA9IFsgJ2FiQ29yZScsIC4uLnRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKSBdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhYlNraWxsTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHNraWxsTmFtZSA9IGFiU2tpbGxOYW1lc1tpXTsKCiAgICBsZXQgc2tpbGxDdXJyZW50SGFzaDsKICAgIGlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICAgICAgc2tpbGxDdXJyZW50SGFzaCA9IGFiLnRhZ3MuYWJDb3JlU291cmNlSGFzaDsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbG9hZGVkU2tpbGxCb3QgPSBnZXRCb3QoYiA9PiBiLnRhZ3MuYWJMb2FkZWRTa2lsbCA9PT0gc2tpbGxOYW1lICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsKICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOwoKICAgICAgICBza2lsbEN1cnJlbnRIYXNoID0gbG9hZGVkU2tpbGxCb3QudGFncy5hYkxvYWRlZFNraWxsU291cmNlSGFzaDsKICAgIH0KICAgIAogICAgdHJ5IHsKICAgICAgICBjb25zdCBza2lsbE91dGRhdGVkID0gYXdhaXQgY2hlY2tTa2lsbE91dGRhdGVkKHNraWxsTmFtZSwgc2tpbGxDdXJyZW50SGFzaCk7CgogICAgICAgIGlmICghZGV0YWlsZWQgJiYgc2tpbGxPdXRkYXRlZCkgewogICAgICAgICAgICAvLyBJZiB3ZSBhcmUgcnVubmluZyBpbiBzaW1wbGUgbW9kZSwgcmV0dXJuIHJpZ2h0IGF3YXkgb24gdGhlIGZpcnN0IG91dGRhdGVkIGZpbGUgZGlzY292ZXJ5LgogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB1cGRhdGVBdmFpbGFibGU6IHRydWUgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2ggYW4gZXJyb3IuYCwgZSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9CgppZiAoZGV0YWlsZWQpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGFiRmlsZUNoZWNrcy5zb21lKGYgPT4gZi51cGRhdGVBdmFpbGFibGUpLAogICAgICAgIGFiRmlsZUNoZWNrcywKICAgIH0KfSBlbHNlIHsKICAgIC8vIElmIHdlIG1hZGUgaXQgYWxsIHRoZSB3YXkgaGVyZSBpbiBzaW1wbGUgbW9kZSwgdGhlcmUgYXJlIG5vIG91dGRhdGVkIGZpbGVzLgogICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdXBkYXRlQXZhaWxhYmxlOiBmYWxzZSB9Cn0nAJ+0p9wEAARncmlkAgQAn7Sn3ASXLCjwn5SXMDI4MzY1YTQtMDM2Zi00MWQwLTlhZjEtNzE1YWQ0ZjJhYTdhJwCftKfcBAASYWJDb3JlTWFqb3JWZXJzaW9uAgQAn7Sn3AS+LAIxMCcAn7Sn3AQAEmFiQ29yZU1pbm9yVmVyc2lvbgIEAJ+0p9wEwSwCMzUnAJ+0p9wEAAZzeXN0ZW0CBACftKfcBMQsDWFiLmNvcmUubGVhcm4nAJ+0p9wEAARhYklEAgQAn7Sn3ATSLAVsZWFybicAn7Sn3AQABGZvcm0CBACftKfcBNgsB25vdGhpbmcnAJ+0p9wEAAZhYkJvb3QCBACftKfcBOAs8CpALyoqCiogTUlUIExpY2Vuc2UKKgoqIENvcHlyaWdodCAoYykgMjAxOSBDYXN1YWwgU2ltdWxhdGlvbiwgSW5jLgoqCiogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQoqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwoqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoqCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKgoqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgoqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKKiBTT0ZUV0FSRS4KKiBAbGljZW5zZSBNSVQKKi8KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvb3RpbmcgYWJgKTsKfQoKLy9pbnN0IG1vZGUgKHBsYXllciBvciBidWlsZGVyKQpsZXQgaW5zdE1vZGVDaGVjayA9IGF3YWl0IG9zLnZlcnNpb24oKS5wbGF5ZXJNb2RlOwovL2NoZWNrIHNlbGYgZm9yIGluaXRpYWwgYm9vdCBkYXRhCmxldCBpbml0aWFsQm9vdCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuaW5pdGlhbEJvb3QgPyB0cnVlIDogZmFsc2U7Ci8vY2hlY2sgdXJsIGZvciBwb3NzaWJsZSBhYidzIHRvIGxvYWQKbGV0IGJvb3RGbGFnID0gY29uZmlnQm90LnRhZ3MucGF0dGVybiA/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gOiBjb25maWdCb3QudGFncy5hYjsKLy9jaGVjayBmb3IgYXNrCmxldCBhc2sgPSBjb25maWdCb3QudGFncy5hc2s7Ci8vbG9naW4KbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXNCb3QubG9hZGluZ1N0YXR1cygpOwovL3NlZWQgKG5vdCBhY3RpdmVseSB1c2VkIGhlcmUpCmxldCBzZWVkID0gY29uZmlnQm90LnRhZ3Muc2VlZDsKLy9wcm9tcHQKbGV0IHByb21wdCA9IGNvbmZpZ0JvdC50YWdzLnByb21wdDsKLy9jaGFubmVsCmxldCBjaGFubmVsID0gY29uZmlnQm90LnRhZ3MuY2hhbm5lbDsKLy91dWFiCmxldCB1dWFiID0gY29uZmlnQm90LnRhZ3MuYXV4bGluayA9PSAidXVhYiI7Ci8vdmVyc2lvbgpsZXQgdmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbjsKLy9yZXF1ZXN0IGF1dGggYm90CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgovL3JlZGlyZWN0IGlmIGluIFVSTAppZiAoY29uZmlnQm90LnRhZ3Muam9pbkNvZGUpIHsKICAgIHRoaXNCb3QuYWJKb2luSG9zdCh7IHRleHQ6IGNvbmZpZ0JvdC50YWdzLmpvaW5Db2RlIH0pOwp9CgovL3N0YXR1cyBjbGVhbiB1cApkZXN0cm95KHN0YXR1cyk7CgovL2NoZWNrIHRpbWUgaWYgbmVlZGVkCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29uZGl0aW9uKSB7CiAgICBhd2FpdCBsaW5rcy5yZW1lbWJlci5hYkNvbmRpdGlvbigpOwp9CgovL2lmIG5vIHN0dWRpbywgc2V0IHN0dWRpbwppZiAoYXV0aEJvdCAmJiAhY29uZmlnQm90LnRhZ3Muc3R1ZGlvKSB7CiAgICBjb25maWdCb3QudGFncy5zdHVkaW8gPSBhdXRoQm90LmlkOwp9Cgp0aGlzQm90LmFiUmVmcmVzaFN0dWRpb3MoKTsKdGhpc0JvdC5hYlJlZnJlc2hBSU1vZGVscygpOwoKaWYgKCFsaW5rcy5wZXJzb25hbGl0eSkgeyAKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJQZXJzb25hbGl0eSIpOwp9CgovL2luaXRpYWxpemUgcmVtZW1iZXIgZ2xvYmFscwpnbG9iYWxUaGlzLmFiSW5zdE1lbW9yeSA9IGxpbmtzLnJlbWVtYmVyOwpnbG9iYWxUaGlzLmFiUmVtZW1iZXIgPSBsaW5rcy5yZW1lbWJlcjsKZ2xvYmFsVGhpcy5hYlBlcnNvbmFsaXR5ID0gbGlua3MucGVyc29uYWxpdHk7CgppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VHcmlkUG9ydGFsQ29sb3IpIHsKICAgIGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yOwp9CgovL1RoaXMgY2hlY2tzIGZvciB0aGUgYXBwcm9wcmlhdGUgYXJyYXkgb2Ygc2tpbGxzIGFuZCBpbml0aWFsaXplcyB0aGVtCmF3YWl0IHRoaXNCb3QuYWJTa2lsbEluaXRpYWxpemF0aW9uKGluc3RNb2RlQ2hlY2spOwoKLy9pbml0aWFsaXppbmcgb2YgZ2xvYmFsIHZhcmlhYmxlcwpnbG9iYWxUaGlzLmJ1aWxkZXJWZXJzaW9uID0gaW5zdE1vZGVDaGVjayA9PSAiYnVpbGRlciIgPyB0cnVlIDogZmFsc2U7Cmdsb2JhbFRoaXMuYWJMb25nVGVybU1lbW9yeVNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlB1Ymxpc2ggPSBsaW5rcy5zdG9yZTsKZ2xvYmFsVGhpcy5hYlN0b3JlID0gbGlua3Muc3RvcmU7Cmdsb2JhbFRoaXMuYWIgPSB0aGlzQm90OwoKLy9jaGVjayBmb3IgdXVhYnMKaWYgKHV1YWIpIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbih7bWVzc2FnZTogY29uZmlnQm90LnRhZ3MudXVhYiwgaXNVVUFCOiB0cnVlfSk7Cn0KLy9jaGVjayBmb3IgY2hhbm5lbCBpZiBjaGFubmVscyBhbGxvd2VkCmVsc2UgaWYgKGNoYW5uZWwgJiYgbGlua3MucmVtZW1iZXIudGFncy5hbGxvd0NoYW5uZWxzKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oe21lc3NhZ2U6IGNoYW5uZWwsIGlzQ2hhbm5lbDogdHJ1ZX0pOwp9IGVsc2UgewogICAgLy9wb3B1bGF0ZSBib290ZmxhZyBhYgogICAgaWYgKGluaXRpYWxCb290ICYmIGJvb3RGbGFnKSB7CiAgICAgICAgYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogYm9vdEZsYWcsIGluaXRpYWxCb290OiB0cnVlLCBhdXRvSGF0Y2g6IHRydWUsIHNvdXJjZUV2ZW50OiAnYm9vdCcsIGFiVmVyc2lvbjogdmVyc2lvbn0pOwogICAgfQoKICAgIC8vbG9va3VwIGFza0lEIGlmIGF2YWlsYWJsZQogICAgaWYgKGluaXRpYWxCb290ICYmIGFzaykgewogICAgICAgIGlmIChhc2sgPT0gImVnZ0NhcnRvbiIgfHwgYXNrID09ICJjYXN1YWxUdXRvcmlhbCIpIHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KGFzayk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2spOwogICAgICAgIH0KICAgIH0KfQoKLy9jaGVjayBmb3IgYXJ0aWZhY3QgRklYCmlmIChjb25maWdCb3QudGFncy5hcnRpZmFjdCAmJiBpbml0aWFsQm9vdCAmJiAhYXNrICYmICFib290RmxhZykgewogICAgY29uc3QgYXJ0aWZhY3QgPSBjb25maWdCb3QudGFncy5hcnRpZmFjdDsKICAgIGNvbnN0IGFydEluZGV4ID0gYXJ0aWZhY3QuaW5kZXhPZigiX2FydF8iKTsKICAgIGNvbnN0IHN0dWRpbyA9IGFydGlmYWN0LnN1YnN0cmluZygwLCBhcnRJbmRleCk7CiAgICBjb25zdCByZWNvcmRBZGRyZXNzID0gYXJ0aWZhY3Quc3Vic3RyaW5nKGFydEluZGV4KTsKICAgIGNvbnN0IHJlY29yZERhdGEgPSBhd2FpdCBvcy5nZXREYXRhKHN0dWRpbywgcmVjb3JkQWRkcmVzcyk7CiAgICBjb25zdCBhc2tJRCA9IHJlY29yZERhdGEuZGF0YS5wYXR0ZXJuOwoKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJRCk7Cn0KCi8vIENoZWNrIGlmIHdlIGNhbiB3YWtlIHVwIGFiLCBhbmQgdGhlbiBkbyBzby4KaWYgKCFjb25maWdCb3QudGFncy5hYlNsZWVwKSB7CiAgICBpZiAoKGluaXRpYWxCb290ICYmICFib290RmxhZyAmJiAhYXNrKSB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWx3YXlzU3RhcnRBd2FrZSB8fCBjb25maWdCb3QudGFncy5hYlN0YXlBd2FrZSkgewogICAgICAgIGF3YWl0IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlLCBpbml0aWFsOiBpbml0aWFsQm9vdCB9KTsKICAgIH0KfQoKLy9zZXQgaW5pdGlhbCBib290IGRhdGEKaWYgKGluaXRpYWxCb290KSB7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnJlbWVtYmVyLCAnaW5pdGlhbEJvb3QnLCBmYWxzZSwgJ3NoYXJlZCcpOwoKICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbGl6YXRpb25Db25maWd1cmF0aW9uKSB7CiAgICAgICAgbGlua3MucmVtZW1iZXIuYWJJbml0aWFsaXphdGlvbkNvbmZpZ3VyYXRpb24oKTsKICAgIH0KfQoKLy9jbGVhbiB1cCBVUkwgd2l0aCB0YWdQb3J0YWwKaWYgKGNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbCAmJiAhY29uZmlnQm90LnRhZ3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgJiYgYnVpbGRlclZlcnNpb24pIHsKICAgIGNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbCA9IG51bGw7CiAgICBjb25maWdCb3QudGFncy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cn0KCi8vcGF1c2UgZm9yIGFiIGxvYWRpbmcKYXdhaXQgb3Muc2xlZXAoNTAwKTsKCi8vaW5pdGlhbGl6ZSB0aW1lIGJvdAp0aGlzQm90LmFiVGltZXIoKTsKCnRoaXNCb3QuYWJDcmVhdGVVcGRhdGVDaGVja2VyKCk7CgpsaW5rcy5wZXJzb25hbGl0eS51cGRhdGVQZXJzb25hbGl0eSgpOwoKLy9pbml0aWFsaXphdGlvbiBzaG91dApzdXBlclNob3V0KCJvbkFCSW5pdGlhbGl6ZWQiLCB0YWdzLmFiSW5zdCk7JwCftKfcBAAQb25BQkF1dGhCb3RBZGRlZAIEAJ+0p9wE0Vc5QHRoaXNCb3QuYWJSZWZyZXNoU3R1ZGlvcygpOwp0aGlzQm90LmFiUmVmcmVzaEFJTW9kZWxzKCk7JwCftKfcBAASb25BQkF1dGhCb3RSZW1vdmVkAgQAn7Sn3ASLWDlAdGhpc0JvdC5hYlJlZnJlc2hTdHVkaW9zKCk7CnRoaXNCb3QuYWJSZWZyZXNoQUlNb2RlbHMoKTsnAJ+0p9wEABBhYlJlZnJlc2hTdHVkaW9zAgQAn7Sn3ATFWKUBQGlmIChhdXRoQm90KSB7CiAgICBjb25zdCB1c2VyU3R1ZGlvcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOwogICAgY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zID0gdXNlclN0dWRpb3M7Cn0gZWxzZSB7CiAgICBjb25maWdCb3QudGFncy51c2VyX3N0dWRpb3MgPSBudWxsOwp9JwCftKfcBAARYWJSZWZyZXNoQUlNb2RlbHMCBACftKfcBOtZmgFAaWYgKGF1dGhCb3QpIHsKICAgIGNvbnN0IG1vZGVscyA9IGF3YWl0IGFpLmxpc3RDaGF0TW9kZWxzKCk7CiAgICBjb25maWdCb3QudGFncy5haUNoYXRNb2RlbHMgPSBtb2RlbHM7Cn0gZWxzZSB7CiAgICBjb25maWdCb3QudGFncy5haUNoYXRNb2RlbHMgPSBudWxsOwp9KACftKfcBAAGYWJDb3JlAXgnAJ+0p9wEAAdhYkFkYXB0AgQAn7Sn3ASHW74UQGxldCBza2lsbE5hbWU7CmxldCBza2lsbERhdGE7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgppZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICBza2lsbE5hbWUgPSB0aGF0OwogICAgc2tpbGxEYXRhID0gbnVsbDsKfSBlbHNlIGlmICh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcpIHsKICAgIHNraWxsTmFtZSA9IHRoYXQuc3lzdGVtSUQgPz8gdGhhdC5za2lsbE5hbWU7CiAgICBza2lsbERhdGEgPSB0aGF0LmRhdGEgPz8gbnVsbDsKfQoKaWYgKCFza2lsbE5hbWUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbE5hbWUgaXMgcmVxdWlyZWQuYCk7CiAgICByZXR1cm4gZmFsc2U7Cn0KCmlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfX1dIGFiQ29uZmlnIGNhbm5vdCBiZSBsb2FkZWQgdXNpbmcgYWJBZGFwdC5gKTsKICAgIHJldHVybjsKfQoKdHJ5IHsKICAgIGNvbnN0IGxvYWRlZFNraWxscyA9IHRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKTsKCiAgICBpZiAoIWxvYWRlZFNraWxscy5pbmNsdWRlcyhza2lsbE5hbWUpKSB7CiAgICAgICAgY29uc3QgdXJsID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FiLyR7c2tpbGxOYW1lfS5hdXhgKTsKICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsIH0pOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIHNraWxsIEdFVCByZXNwb25zZTpgLCByZXNwb25zZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgCiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICAvLyBBVVggRm9ybWF0IFZlcnNpb24gMi4KICAgICAgICAgICAgY29uc3QgdXBkYXRlcyA9IHJlc3BvbnNlLmRhdGEudXBkYXRlczsKICAgICAgICAgICAgYXdhaXQgb3MuYXBwbHlVcGRhdGVzVG9JbnN0KHVwZGF0ZXMpOwogICAgICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHVwZGF0ZXMpOwogICAgICAgICAgICBjb25zdCBzb3VyY2VIYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4Jywgc3RhdGUpOwoKICAgICAgICAgICAgLy8gTG9hZGVkIHNraWxscyBhcmUgc3RvcmVkIGFzIHNoYXJlZCBib3RzIHRoYXQgYW55b25lIGluIHRoZSBpbnN0IGNhbiByZWFkLgogICAgICAgICAgICBjcmVhdGUoewogICAgICAgICAgICAgICAgc3BhY2U6ICdzaGFyZWQnLAogICAgICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgICAgICBhYkxvYWRlZFNraWxsOiBza2lsbE5hbWUsCiAgICAgICAgICAgICAgICBhYkxvYWRlZFNraWxsU291cmNlSGFzaDogc291cmNlSGFzaCwKICAgICAgICAgICAgICAgIGZvcm06ICdub3RoaW5nJywKICAgICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQVVYIGZvcm1hdCB2ZXJzaW9uICR7cmVzcG9uc2UuZGF0YS52ZXJzaW9ufSBpcyBub3Qgc3VwcG9ydGVkLmApOwogICAgICAgIH0KCiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWIgc2tpbGwgJHtza2lsbE5hbWV9IGlzIGFscmVhZHkgbG9hZGVkLmApCiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHNraWxsQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3Nbc2tpbGxOYW1lXSA9PT0gdHJ1ZSk7CiAgICBpZiAoc2tpbGxCb3RzICYmIHNraWxsQm90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgd2hpc3Blcihza2lsbEJvdHMsIHRhZ05hbWUsIGNvbmZpZ0JvdC50YWdzLmluc3QpOwogICAgICAgIHdoaXNwZXIoc2tpbGxCb3RzLCAib25Ta2lsbFVwZGF0ZSIsIHsgZGF0YTogc2tpbGxEYXRhIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gTm8gYm90cyBhcHBlYXIgdG8gaGF2ZSBiZWVuIGxvYWRlZCB3aXRoICR7c2tpbGxOYW1lfS5gKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gRmFpbGVkIHRvIGRvd25sb2FkICR7c2tpbGxOYW1lfS4gU2VlIGFib3ZlIGVycm9yLmApOwogICAgcmV0dXJuIGZhbHNlOwp9JwCftKfcBAALZGVzY3JpcHRpb24CBACftKfcBMZvT1RoaXMgc2tpbGwgaXMgZGVzaWduZWQgdG8gaGFuZGxlIGJvdGggcmVjb25maWd1cmF0aW9uIG9mIGFiIGFuZCBpbml0aWFsaXphdGlvbi4nAJ+0p9wEAApvbkJvdEFkZGVkAgQAn7Sn3ASWcPEBQGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJDb3JlIFNUQVJUIFVQYCk7Cgp0aGlzQm90LmFiSW5zdFVwZGF0ZSgpOwoKaWYgKCFsaW5rcy5yZW1lbWJlcikgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBmaW5kIGFiQ29uZmlnIHJlbWVtYmVyIGJvdC5gKTsKfQoKc2V0VGltZW91dCgoKSA9PiB0aGlzQm90LmFiQm9vdCgpLCA1MDApOycAn7Sn3AQACHJlbWVtYmVyAgQAn7Sn3ASIcijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCftKfcBAADbG9nAgQAn7Sn3ASvcmxALy9wYXNzIHRocm91Z2ggbG9nIGRhdGEKaWYgKGxpbmtzLmNvbnNvbGUpIHsKICAgIGxpbmtzLmNvbnNvbGUubG9nKHRoYXQpOwp9CmVsc2UgewogICAgY29uc29sZS5sb2codGhhdCk7Cn0nAJ+0p9wEAA1tYW5pZmVzdGF0aW9uAgQAn7Sn3ASccyjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCftKfcBAAMYWJDcmVhdGVIb3N0AgQAn7Sn3ATDc9QNQGNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwoKLy90aGlzIGZ1bmN0aW9uIGhhbmRsZXMgY3JlYXRpbmcgYSBmaWxlIGZvciBqb2luIGNvZGVzCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgewogICAgY29uc3Qgam9pblVSTCA9IHNpdGVPcmlnaW4gKyAiLz9qb2luQ29kZT0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQ7CiAgICBvcy5zZXRDbGlwYm9hcmQoam9pblVSTCk7CiAgICBvcy5zaG93UVJDb2RlKGpvaW5VUkwpOwogICAgYWIubGlua3MudXRpbHMuYWJUb2FzdChgdXJsIGNvcGllZCB0byBjbGlwYm9hcmRgKTsKICAgIHJldHVybjsKfQoKaWYgKCFhdXRoQm90KSB7CiAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwp9CgppZiAoIWF1dGhCb3QpIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYHBsZWFzZSBsb2cgaW4gdG8gZ2VuZXJhdGUgYSBqb2luIGNvZGVgKTsKICAgIHJldHVybjsKfQoKZnVuY3Rpb24gZ2VuZXJhdGVKb2luQ29kZSgpIHsKICAgIGNvbnN0IGNoYXJzID0gJ0FCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaMTIzNDU2Nzg5JzsKICAgIGxldCBjb2RlID0gJyc7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDY7IGkrKykgewogICAgICAgIGNvbnN0IHJhbmRvbUluZGV4ID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogY2hhcnMubGVuZ3RoKTsKICAgICAgICBjb2RlICs9IGNoYXJzW3JhbmRvbUluZGV4XTsKICAgIH0KICAgIHJldHVybiBjb2RlOwp9Cgpjb25zdCBuZXdKb2luQ29kZSA9IGdlbmVyYXRlSm9pbkNvZGUoKTsKY29uc3QgZGF0ZSA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWU7CmNvbnN0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CgovLyBbUnlhbiBDb29rXTogVGhpcyBpcyBhIG5haXZlIHJvb20gY29kZSBnZW5lcmF0b3IuIEl0IGRvZXMgbm90IGNoZWNrIGlmIHRoZSByb29tIGNvZGUgaXMgYWxyZWFkeSB0YWtlbiAvIGFjdGl2ZS4KY29uc3QgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEocmVjb3JkS2V5LCBgYWJKb2luQ29kZV8ke25ld0pvaW5Db2RlfWAsIHsgdXJsOiBjb25maWdCb3QudGFncy51cmwsIGRhdGUgfSwgeyBtYXJrZXJzOiBbInB1YmxpY1JlYWQiXSB9KTsKCmlmIChyZWNvcmREYXRhLnN1Y2Nlc3MpIHsKICAgIHNldFRhZ01hc2sobGlua3MucmVtZW1iZXIsICdob3N0SUQnLCBuZXdKb2luQ29kZSwgJ3NoYXJlZCcpOwoKICAgIGNvbnN0IGpvaW5VUkwgPSBzaXRlT3JpZ2luICsgIi8/am9pbkNvZGU9IiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEOwoKICAgIG9zLnNldENsaXBib2FyZChqb2luVVJMKTsKCiAgICBpZiAodGhhdCAmJiB0aGF0LnRhZ3MpIHsKICAgICAgICB0aGF0LnRhZ3MubGFiZWwgPSAiam9pbiBjb2RlOiAiICsgbmV3Sm9pbkNvZGU7CiAgICAKICAgIH0KICAgIG9zLnNob3dRUkNvZGUoam9pblVSTCk7CgogICAgYWIubGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgam9pbiBjb2RlIGdlbmVyYXRlZDogJHtuZXdKb2luQ29kZX0uIHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkLmApOwp9CmVsc2UgewogICAgYWIubGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgZmFpbGVkIHRvIGdlbmVyYXRlIGpvaW4gY29kZSwgcGxlYXNlIHRyeSBhZ2Fpbi5gKTsKICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7Cn0nAJ+0p9wEAAphYkpvaW5Ib3N0AgQAn7Sn3ASYgQGsCkAvL2xvZ2ljIGZvciB1c2luZyBhIGpvaW4gY29kZSAoY2hlY2tzIGZvciBleGlzdGluZyBmaWxlcykKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmxldCBnZXRSZWNvcmQ7CgppZiAodGhhdC5kYXRhKSB7CiAgICBnZXRSZWNvcmQgPSB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHRoYXQuZGF0YSB9Owp9IGVsc2UgewogICAgY29uc3Qgam9pbkNvZGUgPSB0aGF0LnRleHQudG9VcHBlckNhc2UoKTsKICAgIGNvbnN0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGpvaW4gY29kZTpgLCBqb2luQ29kZSkKICAgIH0KCiAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYGFiSm9pbkNvZGVfJHtqb2luQ29kZX1gKTsKfQoKaWYgKGdldFJlY29yZCAmJiBnZXRSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3Qgbm93VGltZSA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWU7CiAgICBjb25zdCBub3dEYXRlID0gRGF0ZVRpbWUuZnJvbU1pbGxpcyhub3dUaW1lKTsKICAgIGNvbnN0IGNyZWF0ZURhdGUgPSBEYXRlVGltZS5mcm9tTWlsbGlzKGdldFJlY29yZC5kYXRhLmRhdGUpOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBub3dUaW1lOmAsIG5vd1RpbWUsIGBub3dEYXRlOmAsIG5vd0RhdGUsIGBjcmVhdGVEYXRlOmAsIGNyZWF0ZURhdGUpOwogICAgfQoKICAgIGxldCBkaWZmZXJlbmNlID0gbm93RGF0ZS5kaWZmKGNyZWF0ZURhdGUsICJkYXlzIikudG9PYmplY3QoKTsKICAgIGRpZmZlcmVuY2UgPSBNYXRoLmZsb29yKGRpZmZlcmVuY2UuZGF5cyk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRpZmZlcmVuY2UgKGRheXMpOmAsIGRpZmZlcmVuY2UpOwogICAgfQogICAgCiAgICBpZiAoZGlmZmVyZW5jZSA8IDgpIHsKICAgICAgICBvcy50b2FzdCgiam9pbmluZyBob3N0IG5vdyIpOwogICAgICAgIG9zLmdvVG9VUkwoZ2V0UmVjb3JkLmRhdGEudXJsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgb3MudG9hc3QoImpvaW4gY29kZSBvdXQgb2YgZGF0ZSwgcGxlYXNlIGdlbmVyYXRlIGEgbmV3IGpvaW4gY29kZSIpOwogICAgfQp9IGVsc2UgewogICAgb3MudG9hc3QoImpvaW4gY29kZSBpbnZhbGlkLCBwbGVhc2UgdHJ5IGFnYWluIik7Cn0nAJ+0p9wEAAZzZWFyY2gCBACftKfcBMWLASjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCftKfcBAAIYWJJZ25vcmUCBACftKfcBOyLAQR0cnVlJwCftKfcBAAEbWVudQIEAJ+0p9wE8YsBKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJ+0p9wEABVhYlNraWxsSW5pdGlhbGl6YXRpb24CBACftKfcBJiMAaMCQC8vRmluZCB0aGUgYXBwcm9wcmlhdGUgYXJyYXkgYW5kIHBvcHVsYXRlIHNraWxscwpsZXQgc2tpbGxBcnJheSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3NbdGhhdCArICJTa2lsbEFycmF5Il07Cgpmb3IgKGxldCBpID0gMDsgaSA8IHNraWxsQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdChza2lsbEFycmF5W2ldKTsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLmVtYmVkID09PSAnaW9zJykgewogICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCdhYklPU0JyaWRnZScpOwp9CgpyZXR1cm47JwCftKfcBAAGYmFubmVyAgQAn7Sn3AS8jgEo8J+Ul2I1NTJlYWY5LWE5ZDYtNDFjOC04NTE1LWNiZDJhYmVhYWU3MycAn7Sn3AQABWlucHV0AgQAn7Sn3ATjjgEo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAn7Sn3AQADWxvYWRpbmdTdGF0dXMCBACftKfcBIqPAcYHQGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTG9hZFN0YXR1cyI7CgpsZXQgc3RhdHVzQm90ID0ge307CgpzdGF0dXNCb3Quc3BhY2UgPSAidGVtcExvY2FsIjsKc3RhdHVzQm90LmxhYmVsID0gInZlcmlmeWluZyBhdXRoQm90IjsKc3RhdHVzQm90LmxhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwpzdGF0dXNCb3QuYWJMb2FkU3RhdHVzID0gdHJ1ZTsKc3RhdHVzQm90Lm1lbnVJdGVtU3R5bGUgPSB7ICJiYWNrZ3JvdW5kIjogIm5vbmUiIH07CnN0YXR1c0JvdC50cmFja051bSA9IDA7CnN0YXR1c0JvdC5vbkNyZWF0ZSA9IGBACiAgICBpZiAodGFncy50cmFja051bSA9PSAyKSB7CiAgICAgICAgdGFncy50cmFja051bSA9IDA7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICB0YWdzLnRyYWNrTnVtKys7CiAgICB9CgogICAgdGFncy5sYWJlbCA9IHRhZ3NbImxhYmVsIit0YWdzLnRyYWNrTnVtXTsKICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSB0YWdzWyJmb3JtIit0YWdzLnRyYWNrTnVtXTsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHdoaXNwZXIodGhpc0JvdCwgIm9uQ3JlYXRlIiksIDUwMCk7YDsKc3RhdHVzQm90LmxhYmVsMCA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4iOwpzdGF0dXNCb3QubGFiZWwxID0gInZlcmlmeWluZyBhdXRoQm90Li4iOwpzdGF0dXNCb3QubGFiZWwyID0gInZlcmlmeWluZyBhdXRoQm90Li4uIjsKc3RhdHVzQm90LmZvcm0wID0gImhvdXJnbGFzc19ib3R0b20iOwpzdGF0dXNCb3QuZm9ybTEgPSAiaG91cmdsYXNzX3RvcCI7CnN0YXR1c0JvdC5mb3JtMiA9ICJob3VyZ2xhc3NfYm90dG9tIjsKc3RhdHVzQm90Lm9uRGVzdHJveSA9IGBACiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7CgpsZXQgY3JlYXRlZFN0YXR1c0JvdCA9IGNyZWF0ZShzdGF0dXNCb3QpOwoKcmV0dXJuIGNyZWF0ZWRTdGF0dXNCb3Q7JwCftKfcBAADYXNrAgQAn7Sn3ATRlgEo8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycAn7Sn3AQAB2FiVGltZXICBACftKfcBPiWAcEGQGlmIChnZXRCb3QoImFiVGltZXIiLCB0cnVlKSkgewogICAgcmV0dXJuOwp9CgppZiAoIXRhZ3MuYWJYUCkgewogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJYUCIsICIwIiwgImxvY2FsIik7Cn0KCmxldCB0aW1lckJvdCA9IHt9OwoKdGltZXJCb3Quc3BhY2UgPSAidGVtcExvY2FsIjsKdGltZXJCb3QubWFuYWdlciA9IGdldExpbmsodGhpc0JvdCk7CnRpbWVyQm90Lm9uQ3JlYXRlID0gYEAKICAgIG1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5vblRpbWVDaGVjaygpLCA2MDAwMCk7CmA7CnRpbWVyQm90LmFiVGltZXIgPSB0cnVlOwp0aW1lckJvdC5vblRpbWVDaGVjayA9IGBACiAgICBpZiAodGFncy5ub3RJZGxlKSB7CiAgICAgICAgdGFncy5ub3RJZGxlID0gZmFsc2U7CgogICAgICAgIC8vY29uc29sZS5sb2coIlhQIiwgbGlua3MubWFuYWdlci50YWdzLmFiWFApOwoKICAgICAgICBjb25zdCB0b3RhbFhQID0gbGlua3MubWFuYWdlci50YWdzLmFiWFAgKyAxOwoKICAgICAgICBzZXRUYWdNYXNrKGxpbmtzLm1hbmFnZXIsICJhYlhQIiwgdG90YWxYUCwgImxvY2FsIik7CiAgICB9CmA7CnRpbWVyQm90Lm5vdElkbGUgPSBmYWxzZTsKdGltZXJCb3Qub25BbnlBY3Rpb24gPSBgQAogICAgaWYgKCF0YWdzLm5vdElkbGUpIHsKICAgICAgICBpZiAodGhhdC5hY3Rpb24uaWQgPT0gZ3JpZFBvcnRhbEJvdC5pZCkKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3Mubm90SWRsZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpgOwoKbGV0IGFiVGltZXIgPSBjcmVhdGUodGltZXJCb3QpOwoKZ2xvYmFsVGhpcy5hYlRpbWVyID0gYWJUaW1lcjsnAJ+0p9wEAAVzdG9yZQIEAJ+0p9wEup0BKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAJ+0p9wEAAdjb25zb2xlAgQAn7Sn3AThnQEo8J+UlzI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYicAn7Sn3AQACWFiVmVyc2lvbgIEAJ+0p9wEiJ4BBTEwLjM1JwCftKfcBAAXYWJCdWlsZENhc3VhbENhdGFsb2dVUkwCBACftKfcBI6eAf8BQGNvbnN0IHJlbGF0aXZlUGF0aCA9IHRoYXQ7Cgpjb25zdCB1cmwgPSBuZXcgVVJMKGxpbmtzLnJlbWVtYmVyLnRhZ3MuY2FzdWFsQ2F0YWxvZ1VSTCk7CmNvbnN0IGVudiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuY2FzdWFsQ2F0YWxvZ0VudjsKCnVybC5wYXRobmFtZSA9IHJlbGF0aXZlUGF0aDsKCmlmIChlbnYgJiYgZW52ICE9PSAncHJvZCcpIHsKICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdlbnYnLCBlbnYpOwp9CgpyZXR1cm4gdXJsLmhyZWY7JwCftKfcBAAHY2hhbm5lbAIEAJ+0p9wEjqABKPCflJdhOWI2YWEwZC1iMzU3LTRkZTYtOWJlZi04NTM0OGFiMWQwZTAnAJ+0p9wEAAtwZXJzb25hbGl0eQIEAJ+0p9wEtaABKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAJ+0p9wEAAxhYkluc3RVcGRhdGUCBACftKfcBNygAaIBQC8vIFVwZGF0ZSB0aGUgYWJJbnN0IHRhZyB3aGljaCByZXByZXNlbnRzIHRoZSBpbnN0IHRoYXQgdGhpcyBhYiBleGlzdHMgaW4uCmNvbnN0IGN1ckluc3QgPSBvcy5nZXRDdXJyZW50SW5zdCgpOwpzZXRUYWdNYXNrKHRoaXNCb3QsICdhYkluc3QnLCBjdXJJbnN0LCAnc2hhcmVkJyk7JwCftKfcBAAMb25JbnN0Sm9pbmVkAgQAn7Sn3AT/oQEYQHRoaXNCb3QuYWJJbnN0VXBkYXRlKCk7JwCftKfcBAALb25JbnN0TGVhdmUCBACftKfcBJiiARhAdGhpc0JvdC5hYkluc3RVcGRhdGUoKTsnAJ+0p9wEAAxyZXNlcnZlZEFza3MCBACftKfcBLGiAQzwn6esWyJob21lIl0nAJ+0p9wEAAhhcnRpZmFjdAIEAJ+0p9wEvKIBKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAJ+0p9wEAAtib3RfZmFjdG9yeQIEAJ+0p9wE46IBKPCflJdjNzhhYTY2My1kMDVjLTRlYzQtYmMyYy0yNmZkNTE1NjBiOTcnAJ+0p9wEAAV1dGlscwIEAJ+0p9wEiqMBKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAJ+0p9wEAAh1cGRhdGVBQgIEAJ+0p9wEsaMB4SpAY29uc3QgcmVsb2FkUGFnZSA9IHRoYXQ/LnJlbG9hZFBhZ2UgPz8gdHJ1ZTsNCmNvbnN0IHNob3dJbmRpY2F0b3IgPSB0aGF0Py5zaG93SW5kaWNhdG9yID8/IHRydWU7DQpjb25zdCBkcnlSdW4gPSB0aGF0Py5kcnlSdW4gPz8gZmFsc2U7DQoNCmxldCBidXN5SW5kaWNhdG9yOw0KDQppZiAoc2hvd0luZGljYXRvcikgew0KICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gJ3VwZGF0ZUFCTWVudSc7DQogICAgYnVzeUluZGljYXRvciA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IHVwZGF0ZUFCTWVudTogdHJ1ZSwgbGFiZWw6IGB1cGRhdGluZyAke2xpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHl9YCB9KTsNCn0NCg0KLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byB1cGRhdGUgaXRzZWxmLg0KYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCQmVmb3JlVXBkYXRlJykpOw0KDQpsZXQgb3ZlcndyaXRlUmVzdWx0Ow0KDQp0cnkgew0KICAgIC8vIFVwZGF0ZSBhYkNvbmZpZy4NCiAgICBjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOw0KICAgIGNvbnN0IGFiQ29uZmlnUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBhYkNvbmZpZ1VSTCB9KTsNCg0KICAgIGFzc2VydChhYkNvbmZpZ1Jlc3BvbnNlLnN0YXR1cyA9PT0gMjAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCBhYkNvbmZpZy4gUmVzcG9uc2U6ICR7YWJDb25maWdSZXNwb25zZS5zdGF0dXNUZXh0fWApOw0KICAgIGFzc2VydChhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZyBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke2FiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9ufWApOw0KDQogICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogYWJDb25maWdSZXNwb25zZS5kYXRhLCBncm91cFRhZzogJ2FiQ29uZmlnJywgZHJ5UnVuIH0pOw0KICAgIHNldFRhZ01hc2soYWIubGlua3MucmVtZW1iZXIsICdhYkNvbmZpZ1NvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KDQogICAgLy8gVXBkYXRlIGFiIHNraWxscy4NCiAgICBjb25zdCBsb2FkZWRTa2lsbHMgPSB0aGlzQm90LmFiTG9hZGVkU2tpbGxzKCk7DQoNCiAgICBmb3IgKGxldCBza2lsbE5hbWUgb2YgbG9hZGVkU2tpbGxzKSB7DQogICAgICAgIGNvbnN0IHNraWxsVVJMID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FiLyR7c2tpbGxOYW1lfS5hdXhgKTsNCg0KICAgICAgICAvLyBTa2lsbHMgY2FuIGJlIHJlc3RydWN0dXJlZCwgbWVhbmluZyB0aGF0IHRoZXkgY291bGQgYmUgcmVtb3ZlZCBlbnRpcmVseSBpbiB0aGUgZnV0dXJlLg0KICAgICAgICAvLyBJZiBhIGZpbGUgZmFpbHMgdG8gYmUgcmV0cmlldmVkLCB0aGVuIHJlbW92ZSBhbGwgdGhlIGJvdHMgaW4gdGhlIGdyb3VwIGluIHRoZSBpbnN0Lg0KICAgICAgICBsZXQgcmVtb3ZlU2tpbGwgPSBmYWxzZTsNCiAgICAgICAgbGV0IHNraWxsUmVzcG9uc2U7DQoNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsNCg0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraWxsUmVzcG9uc2U6YCwgc2tpbGxSZXNwb25zZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGFzc2VydChza2lsbFJlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke3NraWxsTmFtZX0gbXVzdCBiZSBpbiBhdXggZmlsZSBmb3JtYXQgdjIuIEFjdHVhbCBhdXggZmlsZSBmb3JtYXQgdmVyc2lvbjogJHtza2lsbFJlc3BvbnNlLmRhdGEudmVyc2lvbn1gKTsNCg0KICAgICAgICAgICAgaWYgKHNraWxsUmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHsNCiAgICAgICAgICAgICAgICBpZiAoc2tpbGxSZXNwb25zZS5zdGF0dXMgPT09IDQwMyB8fCBza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7DQogICAgICAgICAgICAgICAgICAgIHJlbW92ZVNraWxsID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9IGNhdGNoIChlKSB7DQogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2F1Z2h0IGVycm9yIHdoaWxlIGRvd25sb2FkaW5nIHNraWxsOmAsIGUpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsNCiAgICAgICAgICAgICAgICAvLyBGaWxlIGRvZXNudCBleGlzdCBhbnltb3JlLCB0aGUgc2tpbGwgaGFzIGJlZW4gcmVtb3ZlZC4NCiAgICAgICAgICAgICAgICByZW1vdmVTa2lsbCA9IHRydWU7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHRocm93IGU7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmIChza2lsbFJlc3BvbnNlICYmICFyZW1vdmVTa2lsbCkgew0KICAgICAgICAgICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogc2tpbGxSZXNwb25zZS5kYXRhLCBncm91cFRhZzogc2tpbGxOYW1lLCBkcnlSdW4gfSk7DQoNCiAgICAgICAgICAgIGNvbnN0IGxvYWRlZFNraWxsQm90ID0gZ2V0Qm90KGIgPT4gYi50YWdzLmFiTG9hZGVkU2tpbGwgPT09IHNraWxsTmFtZSAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyk7DQogICAgICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzZXRUYWdNYXNrKGxvYWRlZFNraWxsQm90LCAnYWJMb2FkZWRTa2lsbFNvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KICAgICAgICB9IGVsc2UgaWYgKHJlbW92ZVNraWxsKSB7DQogICAgICAgICAgICBjb25zdCBza2lsbEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzW3NraWxsTmFtZV0gPT09IHRydWUpOw0KDQogICAgICAgICAgICBpZiAoZHJ5UnVuKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBkZWxldGUgJHtza2lsbEJvdHMubGVuZ3RofSAke3NraWxsTmFtZX0gYm90KHMpIGJlY2F1c2UgJHtza2lsbE5hbWV9IGlzIG5vIGxvbmdlciBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuYCkNCiAgICAgICAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgICAgIH0NCg0KDQogICAgICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU2tpbGwgJHtza2lsbE5hbWV9IGlzIG5vIGxvbmdlciBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuIFJlbW92ZSAke3NraWxsQm90cy5sZW5ndGh9ICR7c2tpbGxOYW1lfSBib3QocykgZnJvbSBpbnN0LmApOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBkZXN0cm95KHNraWxsQm90cyk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICAvLyBVcGRhdGUgYWJDb3JlIChkbyB0aGlzIG9uZSBsYXN0ISkNCiAgICBjb25zdCBhYkNvcmVVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKCcvYWIvYWJDb3JlLmF1eCcpOw0KICAgIGNvbnN0IGFiQ29yZVJlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICJHRVQiLCB1cmw6IGFiQ29yZVVSTCB9KTsNCg0KICAgIGFzc2VydChhYkNvcmVSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb3JlLiBSZXNwb25zZTogJHthYkNvcmVSZXNwb25zZS5zdGF0dXNUZXh0fWApOw0KICAgIGFzc2VydChhYkNvcmVSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJDb3JlIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb3JlUmVzcG9uc2UuZGF0YS52ZXJzaW9ufWApOw0KDQogICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogYWJDb3JlUmVzcG9uc2UuZGF0YSwgZ3JvdXBUYWc6ICdhYkNvcmUnLCBkcnlSdW4gfSk7DQogICAgc2V0VGFnTWFzayhhYiwgJ2FiQ29yZVNvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KICAgIA0KICAgIC8vIExldCBhbGwgYm90cyBrbm93IHRoYXQgYWIgaXMgZmluaXNoZWQgdXBkYXRpbmcuDQogICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCVXBkYXRlZCcpKTsNCg0KICAgIGlmIChyZWxvYWRQYWdlKSB7DQogICAgICAgIGNvbnN0IHJlbW90ZURhdGFFdmVudCA9ICd1cGRhdGVfYWJfcmVsb2FkX3BhZ2UnOw0KICAgICAgICBjb25zdCByZW1vdGVEYXRhQXJnID0geyByZWxvYWRQYWdlLCBkcnlSdW4gfTsNCg0KICAgICAgICBpZiAob3MuaXNDb2xsYWJvcmF0aXZlKCkpIHsNCiAgICAgICAgICAgIGNvbnN0IHJlbW90ZXMgPSBhd2FpdCBvcy5yZW1vdGVzKCk7DQogICAgICAgICAgICBzZW5kUmVtb3RlRGF0YShyZW1vdGVzLCByZW1vdGVEYXRhRXZlbnQsIHJlbW90ZURhdGFBcmcpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgdGhpc0JvdC5vblJlbW90ZURhdGEoeyBuYW1lOiByZW1vdGVEYXRhRXZlbnQsIHRoYXQ6IHJlbW90ZURhdGFBcmcsIHJlbW90ZUlkOiBjb25maWdCb3QuaWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9IGZpbmFsbHkgew0KICAgIGlmIChidXN5SW5kaWNhdG9yKSB7DQogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7DQogICAgICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsNCiAgICB9DQp9JwCftKfcBAAFZGVidWcCBACftKfcBJPOAQVmYWxzZScAn7Sn3AQAFWFiQ3JlYXRlVXBkYXRlQ2hlY2tlcgIEAJ+0p9wEmc4BvRNAbGV0IGFiVXBkYXRlQ2hlY2tlciA9IGdldEJvdCgnYWJVcGRhdGVDaGVja2VyJywgdHJ1ZSk7CgppZiAoYWJVcGRhdGVDaGVja2VyKSB7CiAgICBnbG9iYWxUaGlzLmFiVXBkYXRlQ2hlY2tlciA9IGFiVXBkYXRlQ2hlY2tlcjsKICAgIHJldHVybiBhYlVwZGF0ZUNoZWNrZXI7Cn0KCmxldCBtb2QgPSB7CiAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICBhYlVwZGF0ZUNoZWNrZXI6IHRydWUsCiAgICBhYklnbm9yZTogdHJ1ZSwKICAgIGNoZWNraW5nOiBmYWxzZSwKICAgIHVwZGF0ZUF2YWlsYWJsZTogZmFsc2UsCiAgICBkZWJ1ZzogZmFsc2UsCiAgICBvbkNyZWF0ZTogYEAKICAgICAgICB0aGlzQm90LnN0YXJ0SW50ZXJ2YWwoKTsKICAgICAgICB0aGlzQm90Lm9uVXBkYXRlQ2hlY2soKTsKICAgIGAsCiAgICBzdGFydEludGVydmFsOiBgQAogICAgICAgIGlmICghdGFncy5pbnRlcnZhbCkgewogICAgICAgICAgICBjb25zdCBVUERBVEVfQ0hFQ0tfSU5URVJWQUxfTUlOVVRFUyA9IDU7CiAgICAgICAgICAgIGNvbnN0IGludGVydmFsTVMgPSBVUERBVEVfQ0hFQ0tfSU5URVJWQUxfTUlOVVRFUyAqIDYwICogMTAwMDsKICAgICAgICAgICAgdGFncy5pbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHRoaXNCb3Qub25VcGRhdGVDaGVjaygpLCBpbnRlcnZhbE1TKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gc3RhcnQgdXBkYXRlIGNoZWNrIGludGVydmFsIG1zOicsIGludGVydmFsTVMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgYCwKICAgIHN0b3BJbnRlcnZhbDogYEAKICAgICAgICBpZiAodGFncy5pbnRlcnZhbCkgewogICAgICAgICAgICBjbGVhckludGVydmFsKHRhZ3MuaW50ZXJ2YWwpOwogICAgICAgICAgICB0YWdzLmludGVydmFsID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gc3RvcCB1cGRhdGUgY2hlY2sgaW50ZXJ2YWwuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICBgLAogICAgZm9yY2VVcGRhdGVDaGVjazogYEAKICAgICAgICB0aGlzQm90LnN0b3BJbnRlcnZhbCgpOwogICAgICAgIHRoaXNCb3Quc3RhcnRJbnRlcnZhbCgpOwogICAgICAgIHRoaXNCb3Qub25VcGRhdGVDaGVjayh7IGZvcmNlOiB0cnVlIH0pOwogICAgYCwKICAgIG9uVXBkYXRlQ2hlY2s6IGBACiAgICAgICAgY29uc3QgZm9yY2UgPSB0aGF0Py5mb3JjZSA/PyBmYWxzZTsKCiAgICAgICAgaWYgKCF0YWdzLmNoZWNraW5nKSB7CiAgICAgICAgICAgIGlmICghdGFncy51cGRhdGVBdmFpbGFibGUgfHwgZm9yY2UpIHsKICAgICAgICAgICAgICAgIHRhZ3MuY2hlY2tpbmcgPSB0cnVlOwoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgYWIuYWJDaGVja0FCVXBkYXRlQXZhaWxhYmxlKCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSB1cGRhdGUgY2hlY2sgcmVzdWx0OicsIHJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFncy51cGRhdGVBdmFpbGFibGUgPSByZXN1bHQudXBkYXRlQXZhaWxhYmxlOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdC51cGRhdGVBdmFpbGFibGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3V0KCdvbkFCVXBkYXRlQXZhaWxhYmxlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgICAgICAgIHRhZ3MuY2hlY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1thYlVwZGF0ZUNoZWNrZXJdIHNraXAgdXBkYXRlIGNoZWNrIOKAlCB1cGRhdGUgaXMgYWxyZWFkeSBrbm93biB0byBiZSBhdmFpbGFibGUuJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1thYlVwZGF0ZUNoZWNrZXJdIHVwZGF0ZSBjaGVjayBhbHJlYWR5IGluIHByb2dyZXNzLicpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIGAsCn0KCmFiVXBkYXRlQ2hlY2tlciA9IGNyZWF0ZShtb2QpOwpnbG9iYWxUaGlzLmFiVXBkYXRlQ2hlY2tlciA9IGFiVXBkYXRlQ2hlY2tlcgoKcmV0dXJuIGFiVXBkYXRlQ2hlY2tlcjsnAJ+0p9wEAA5hdXhWMk92ZXJ3cml0ZQIEAJ+0p9wE1eEBkSpAY29uc3QgYXV4ID0gdGhhdD8uYXV4Owpjb25zdCBncm91cFRhZyA9IHRoYXQ/Lmdyb3VwVGFnOwpjb25zdCBkcnlSdW4gPSB0aGF0Py5kcnlSdW4gPz8gZmFsc2U7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9Cgphc3NlcnQoYXV4Py52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGF1eCBwYXJhbWV0ZXIgaXMgcmVxdWlyZWQgdG8gYmUgYSB2MiBhdXggZmlsZS5gKTsKYXNzZXJ0KGdyb3VwVGFnID09IG51bGwgfHwgdHlwZW9mIGdyb3VwVGFnID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBncm91cFRhZyBwYXJhbWV0ZXIgaWYgcHJvdmlkZWQsIG11c3QgYmUgYSBzdHJpbmcuYCk7Cgpjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKGF1eC51cGRhdGVzKTsKCi8vIFN1cGVyIGhhcmRjb2RlZCBtZXNzeSBmaXggZm9yIGNvbXB1dGluZyBhYkNvbmZpZyBzb3VyY2UgaGFzaC4KaWYgKGdyb3VwVGFnID09PSAnYWJDb25maWcnKSB7IAogICAgZm9yIChsZXQgaWQgaW4gc3RhdGUpIHsKICAgICAgICBkZWxldGUgc3RhdGVbaWRdLnRhZ3MuYmFzZUFCOyAvLyBiYXNlQUIgaXMgYW4gYW5ub3lpbmcgdGFnIHRoYXQgc2hvdWxkIG5vdCBiZSBjb21wdXRlZCBhcyBwYXJ0IG9mIGhhc2ggc3RhdGUuCiAgICB9Cn0KCmxldCBzb3VyY2VIYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4Jywgc3RhdGUpOwpsZXQgcHJldkdyb3VwQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3NbZ3JvdXBUYWddID09PSB0cnVlKTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXRlOmAsIHN0YXRlKTsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcHJldkdyb3VwQm90czpgLCBwcmV2R3JvdXBCb3RzKTsKfQoKLy8gU3RlcCAxOiBBcHBseSB1cGRhdGVzIGRpcmVjdGx5IHRvIHRoZSBpbnN0IGFzLWlzLgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBTdGVwIDE6IEFwcGx5IHVwZGF0ZXMgZGlyZWN0bHkgdG8gdGhlIGluc3QgYXMtaXMuYCk7Cn0KCmlmICghZHJ5UnVuKSB7CiAgICBhd2FpdCBvcy5hcHBseVVwZGF0ZXNUb0luc3QoYXV4LnVwZGF0ZXMpOwp9IGVsc2UgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBhcHBseSB1cGRhdGVzIHRvIGluc3QuYCkKfQoKLy8gU3RlcCAyOiBEZWxldGUgcHJldmlvdXMgZ3JvdXAgYm90cyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIHVwZGF0ZSBzdGF0ZS4KaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU3RlcCAyOiBEZWxldGUgcHJldmlvdXMgZ3JvdXAgYm90cyB0aGF0IGFyZSBubyBsb25nZXIgaW4gdGhlIHVwZGF0ZSBzdGF0ZS5gKTsKfQoKZm9yIChjb25zdCBwcmV2R3JvdXBCb3Qgb2YgcHJldkdyb3VwQm90cykgewogICAgaWYgKHN0YXRlW3ByZXZHcm91cEJvdC5pZF0gPT0gbnVsbCkgewogICAgICAgIGlmIChkcnlSdW4pIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBkZWxldGUgYm90ICR7cHJldkdyb3VwQm90LmlkfSBwcmV2aW91c2x5IGJlbG9uZ2luZyB0byBncm91cCAke2dyb3VwVGFnfWApOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVzdHJveWluZyBwcmV2aW91cyBncm91cCBib3QgJHtwcmV2R3JvdXBCb3QuaWR9IHRoYXQgaXMgbm8gbG9uZ2VyIGluIHRoZSB1cGRhdGUgc3RhdGUuYCk7CiAgICAgICAgfQoKICAgICAgICBkZXN0cm95KHByZXZHcm91cEJvdCk7CiAgICB9Cn0KCi8vIFN0ZXAgMzogRm9yIGVhY2ggYm90IGluIHRoZSB1cGRhdGUgc3RhdGUsIGNyZWF0ZSwgdXBkYXRlLCBhbmQgZGVsZXRlIHRhZ3Mgb24gdGhlIGV4aXN0aW5nIGJvdHMgaW4gdGhlIGluc3QuCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFN0ZXAgMzogRm9yIGVhY2ggYm90IGluIHRoZSB1cGRhdGUgc3RhdGUsIGNyZWF0ZSwgdXBkYXRlLCBhbmQgZGVsZXRlIHRhZ3Mgb24gdGhlIGV4aXN0aW5nIGJvdHMgaW4gdGhlIGluc3QuYCk7Cn0KCmZvciAoY29uc3QgYm90SWQgaW4gc3RhdGUpIHsKICAgIGNvbnN0IGJvdCA9IGdldEJvdCgnaWQnLCBib3RJZCk7CiAgICBjb25zdCBib3RTdGF0ZSA9IHN0YXRlW2JvdElkXTsKCiAgICBpZiAoYm90KSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBleGlzdGluZyBib3QgJHtib3RJZH1gKTsKICAgICAgICB9CgogICAgICAgIC8vIEhhbmRsZXMgdGFnIGNyZWF0ZSAvIHVwZGF0ZS4KICAgICAgICBmb3IgKGNvbnN0IHN0YXRlVGFnTmFtZSBpbiBib3RTdGF0ZS50YWdzKSB7CiAgICAgICAgICAgIGlmIChib3QucmF3W3N0YXRlVGFnTmFtZV0gIT0gYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdKSB7CiAgICAgICAgICAgICAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBzZXQgdGFnICcke3N0YXRlVGFnTmFtZX0nIG9uIGJvdCAke2JvdElkfSB0byB2YWx1ZTpgLCBib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV0pOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzZXQgdGFnICcke3N0YXRlVGFnTmFtZX0nIG9uIGJvdCAke2JvdElkfSB0bzpgLCBib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV0pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJvdC50YWdzW3N0YXRlVGFnTmFtZV0gPSBib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV07CgogICAgICAgICAgICAgICAgaWYgKGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0YWcgJyR7c3RhdGVUYWdOYW1lfScgZm9yIGJvdCAke2JvdElkfSBpcyBudWxsLCBjbGVhcmluZyBhbnkgdGFnIG1hc2tzIGFzIHdlbGwuYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciBhbGwgcG9zc2libGUgbWFza3MgZm9yIHRoaXMgdGFnIGFzIHdlbGwuCiAgICAgICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIHN0YXRlVGFnTmFtZSwgbnVsbCwgJ2xvY2FsJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIHN0YXRlVGFnTmFtZSwgbnVsbCwgJ3RlbXBMb2NhbCcpOwogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICdzaGFyZWQnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAndGVtcFNoYXJlZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBmb3IgYm90ICR7Ym90SWR9IGlzIGFscmVhZHkgdXAtdG8tZGF0ZS5gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRGVsZXRlIHRhZ3MgKGFuZCBtYXNrcyBmb3IgdGhvc2UgdGFncykgb24gZXhpc3RpbmcgYm90IHRoYXQgYXJlIG5vdCBpbiB1cGRhdGUgc3RhdGUuCiAgICAgICAgY29uc3QgYm90VGFncyA9IE9iamVjdC5rZXlzKGJvdC50YWdzKTsKCiAgICAgICAgZm9yIChjb25zdCBib3RUYWdOYW1lIG9mIGJvdFRhZ3MpIHsKICAgICAgICAgICAgaWYgKGJvdFN0YXRlLnRhZ3NbYm90VGFnTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGRyeVJ1bikgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZGVsZXRlIHRhZyAnJHtib3RUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9LmApOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZWxldGUgdGFnIChhbmQgbWFza3MpICcke2JvdFRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0uYCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm90LnRhZ3NbYm90VGFnTmFtZV0gPSBudWxsOwogICAgICAgICAgICAgICAgLy8gQ2xlYXIgYWxsIHBvc3NpYmxlIG1hc2tzIGZvciB0aGlzIHRhZyBhcyB3ZWxsLgogICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIGJvdFRhZ05hbWUsIG51bGwsICdsb2NhbCcpOwogICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIGJvdFRhZ05hbWUsIG51bGwsICd0ZW1wTG9jYWwnKTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAnc2hhcmVkJyk7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ3RlbXBTaGFyZWQnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNvdWxkIG5vdCBmaW5kIGJvdCAke2JvdElkfSBpbiBpbnN0LmApOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkb25lLmApOwp9Cgpjb25zdCBib3RJZHMgPSBPYmplY3Qua2V5cyhzdGF0ZSk7CgpyZXR1cm4gewogICAgZ3JvdXBUYWcsCiAgICBib3RJZHMsCiAgICBzb3VyY2VIYXNoLAp9OycAn7Sn3AQADmFiTG9hZGVkU2tpbGxzAgQAn7Sn3ATniwK2AUBjb25zdCBsb2FkZWRTa2lsbHMgPSBuZXcgU2V0KCk7CgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiTG9hZGVkU2tpbGwgIT0gbnVsbCkgewogICAgICAgIGxvYWRlZFNraWxscy5hZGQoYi50YWdzLmFiTG9hZGVkU2tpbGwpOwogICAgfQp9KTsKCnJldHVybiBBcnJheS5mcm9tKGxvYWRlZFNraWxscyk7JwCftKfcBAAMb25SZW1vdGVEYXRhAgQAn7Sn3ASejQKnBUBpZiAodGhhdC5uYW1lID09PSAndXBkYXRlX2FiX3JlbG9hZF9wYWdlJykgewogICAgY29uc3QgeyByZWxvYWRQYWdlLCBkcnlSdW4gfSA9IHRoYXQudGhhdDsKCiAgICBpZiAodGhhdC5yZW1vdGVJZCA9PT0gY29uZmlnQm90LmlkKSB7CiAgICAgICAgLy8gV2FpdCBhIG1vbWVudCBiZWZvcmUgcmVsb2FkaW5nIHRoZSBwYWdlIGlmIHdlIGFyZSB0aGUgb25lcyB0aGF0IHNlbnQgb3V0IHRoZSBtZXNzYWdlLgogICAgICAgIGF3YWl0IG9zLnNsZWVwKDEwMDApOwogICAgfQoKICAgIGxldCBpc1VSTCA9IGZhbHNlOwoKICAgIGlmICh0eXBlb2YgcmVsb2FkUGFnZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBuZXcgVVJMKHJlbG9hZFBhZ2UpOwogICAgICAgICAgICBpc1VSTCA9IHRydWU7CiAgICAgICAgfSBjYXRjaCAoZSkge30KICAgIH0KCiAgICBsZXQgdXJsID0gaXNVUkwgPyByZWxvYWRQYWdlIDogY29uZmlnQm90LnRhZ3MudXJsOwoKICAgIGlmIChkcnlSdW4pIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGdvIHRvIHVybGAsIHVybCk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgCiAgICBvcy5nb1RvVVJMKGlzVVJMID8gcmVsb2FkUGFnZSA6IGNvbmZpZ0JvdC50YWdzLnVybCk7Cn0nAJ+0p9wEAAlvbkVudGVyQVICBACftKfcBMaSAhNAbWFza3MuaW5BUiA9IHRydWU7JwCftKfcBAAIb25FeGl0QVICBACftKfcBNqSAhNAbWFza3MuaW5BUiA9IG51bGw7JwCftKfcBAAJb25FbnRlclZSAgQAn7Sn3ATukgITQG1hc2tzLmluVlIgPSB0cnVlOycAn7Sn3AQACG9uRXhpdFZSAgQAn7Sn3ASCkwITQG1hc2tzLmluVlIgPSBudWxsOycAn7Sn3AQABmNyZWF0ZQIEAJ+0p9wElpMCKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAJ+0p9wEAAVwYXN0ZQIEAJ+0p9wEvZMCKPCflJdiMzM5YzExOC00ODlhLTQ2NmItYmE5Zi1iMDdhNWY5YjY2NGYnAJ+0p9wEAAhhcm1fdG9vbAIEAJ+0p9wE5JMCKPCflJczYzc0YzlmMS04MmRjLTQ2NTUtOGIzOC1lN2YxMWRlODk3OGUnAJ+0p9wEAANjdWUCBACftKfcBIuUApALQC8vdGhhdA0KLy9ib3Q/DQovL3Bvc2l0aW9uPw0KLy90ZXh0DQovL2RpbWVuc2lvbj8NCi8vc2NhbGU/DQovL2NvbG9yPw0KLy9zcGFjZT8NCg0KY29uc3QgY3VycmVudERpbSA9IHRoYXQuZGltZW5zaW9uID8/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gPz8gJ2hvbWUnOw0KDQpsZXQgcG9zWDsNCmxldCBwb3NZOw0KbGV0IHBvc1o7DQoNCg0KDQppZiAodGhhdC5ib3QpIHsNCiAgICBwb3NYID0gdGhhdC5ib3QudGFnc1tjdXJyZW50RGltICsgJ1gnXTsNCiAgICBwb3NZID0gdGhhdC5ib3QudGFnc1tjdXJyZW50RGltICsgJ1knXTsNCiAgICBwb3NaID0gdGhhdC5ib3QudGFnc1tjdXJyZW50RGltICsgJ1onXSA/PyAwOw0KfSBlbHNlIGlmICh0aGF0LnBvc2l0aW9uKSB7DQogICAgcG9zWCA9IHRoYXQucG9zaXRpb24ueDsNCiAgICBwb3NZID0gdGhhdC5wb3NpdGlvbi55Ow0KICAgIHBvc1ogPSB0aGF0LnBvc2l0aW9uLnogPz8gMTsNCn0NCg0KaWYgKCghcG9zWCAmJiBwb3NYICE9IDApIHx8ICghcG9zWSAmJiBwb3NZICE9IDApKSB7DQogICAgcmV0dXJuOw0KfQ0KDQpjb25zdCBjdWVCb3QgPSBhd2FpdCBjcmVhdGUoew0KICAgIGxhYmVsOiB0aGF0LnRleHQgPz8gJycsDQogICAgbGFiZWxDb2xvcjogdGhhdC5jb2xvciA/PyAid2hpdGUiLA0KICAgIHNjYWxlOiB0aGF0LnNjYWxlID8/ICcuNScsDQogICAgW2N1cnJlbnREaW1dOiB0cnVlLA0KICAgIFtjdXJyZW50RGltICsgJ1gnXTogcG9zWCwNCiAgICBbY3VycmVudERpbSArICdZJ106IHBvc1ksDQogICAgW2N1cnJlbnREaW0gKyAnWiddOiBwb3NaLA0KICAgIGNvbG9yOiAnY2xlYXInLA0KICAgIGxhYmVsT3BhY2l0eTogMSwNCiAgICBzcGFjZTogdGhhdC5zcGFjZSA/PyAndGVtcExvY2FsJywNCiAgICBsYWJlbFBvc2l0aW9uOiAnZmxvYXRpbmdCaWxsYm9hcmQnLA0KICAgIGxhYmVsRmxvYXRpbmdCYWNrZ3JvdW5kQ29sb3I6ICdjbGVhcicsDQogICAgcG9pbnRhYmxlOiBmYWxzZSwNCiAgICBvbkJvdEFkZGVkOiBgQA0KICAgICAgICBhd2FpdCBhbmltYXRlVGFnKHRoaXNCb3QsIHsNCiAgICAgICAgICAgIGZyb21WYWx1ZTogew0KICAgICAgICAgICAgICAgIFsnJHtjdXJyZW50RGltfScgKyAnWiddOiAke3Bvc1p9LA0KICAgICAgICAgICAgICAgIGxhYmVsT3BhY2l0eTogMQ0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIHRvVmFsdWU6IHsNCiAgICAgICAgICAgICAgICBbJyR7Y3VycmVudERpbX0nICsgJ1onXTogJHtwb3NafSArIDMsDQogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAwDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgZHVyYXRpb246IDIsDQogICAgICAgICAgICB0YWdNYXNrU3BhY2U6IGZhbHNlDQogICAgICAgIH0pDQogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7DQogICAgYA0KfSkA"}]}