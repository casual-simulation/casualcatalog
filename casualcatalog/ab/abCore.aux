{"version":2,"updates":[{"id":0,"timestamp":1761059813371,"update":"AWbe4/SZCwAnAQRib3RzJDY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNwEnAN7j9JkLABhhYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUCBADe4/SZCwGVLEBjb25zdCBkZXRhaWxlZCA9IHRoYXQ/LmRldGFpbGVkID8/IGZhbHNlOwpjb25zdCBoYXNoQWxnb3JpdGhtID0gdGhhdD8uaGFzaEFsZ29yaXRobSA/PyAnc2hhMSc7CmNvbnN0IGhhc2hGb3JtYXQgPSB0aGF0Py5oYXNoRm9ybWF0ID8/ICdoZXgnOwoKaW50ZXJmYWNlIEFCRmlsZVVwZGF0ZUNoZWNrIHsKICAgIGZpbGVOYW1lOiBzdHJpbmc7CiAgICB1cGRhdGVBdmFpbGFibGU6IGJvb2xlYW47CiAgICBjdXJyZW50SGFzaDogc3RyaW5nOwogICAgbGF0ZXN0SGFzaDogc3RyaW5nOwogICAgcmVtb3ZlZDogYm9vbGVhbjsKfQoKLy8gVGhpcyBsaXN0IG9mIGFiIGZpbGUgY2hlY2tzLCB0aGlzIHdpbGwgb25seSBiZSBwb3B1bGF0ZWQgaWYgJ2RldGFpbGVkJyBpcyB0cnVlLgpjb25zdCBhYkZpbGVDaGVja3M6IEFCRmlsZVVwZGF0ZUNoZWNrW10gPSBbXTsKCmFzeW5jIGZ1bmN0aW9uIGNoZWNrU2tpbGxPdXRkYXRlZChza2lsbE5hbWU6IHN0cmluZywgY3VycmVudEhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gewogICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOyAgICAgICAgCiAgICBsZXQgc2tpbGxSZW1vdmVkID0gZmFsc2U7CiAgICBsZXQgc2tpbGxSZXNwb25zZTsKCiAgICB0cnkgewogICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbFJlc3BvbnNlOmAsIHNraWxsUmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhc3NlcnQoc2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHtza2lsbE5hbWV9IG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7c2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7CgogICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBlcnJvciB3aGlsZSBkb3dubG9hZGluZyBza2lsbDpgLCBlKTsKICAgICAgICAKICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgLy8gRmlsZSBkb2VzbnQgZXhpc3QgYW55bW9yZSwgdGhlIHNraWxsIGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHNraWxsUmVtb3ZlZCkgewogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoOiBudWxsLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSwKICAgICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBDYWxjdWxhdGUgaGFzaCBvZiBhYiBmaWxlIHN0YXRlIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHNraWxsUmVzcG9uc2UuZGF0YS51cGRhdGVzKTsKICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgc3RhdGUpOwogICAgICAgIAogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgbGF0ZXN0VXBkYXRlczogc2tpbGxSZXNwb25zZS5kYXRhLnVwZGF0ZXMsCiAgICAgICAgICAgICAgICBsYXRlc3RTdGF0ZTogc3RhdGUsCiAgICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2g7CiAgICB9Cn0KCi8vIDEuIENoZWNrIGlmIGFiQ29uZmlnIGlzIG91dGRhdGVkLgpjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOwpjb25zdCBhYkNvbmZpZ1Jlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb25maWdVUkwgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZ1Jlc3BvbnNlOmAsIGFiQ29uZmlnUmVzcG9uc2UpOwp9Cgphc3NlcnQoYWJDb25maWdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke2FiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7Cgpjb25zdCBhYkNvbmZpZ0N1cnJlbnRIYXNoID0gYWIubGlua3MucmVtZW1iZXIudGFncy5hYkNvbmZpZ1NvdXJjZUhhc2g7CmNvbnN0IGFiQ29uZmlnTGF0ZXN0U3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcyk7CmZvciAobGV0IGlkIGluIGFiQ29uZmlnTGF0ZXN0U3RhdGUpIHsKICAgIGRlbGV0ZSBhYkNvbmZpZ0xhdGVzdFN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgp9CmNvbnN0IGFiQ29uZmlnTGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiQ29uZmlnTGF0ZXN0U3RhdGUpOwoKaWYgKGRldGFpbGVkKSB7CiAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgZmlsZU5hbWU6ICdhYkNvbmZpZycsCiAgICAgICAgY3VycmVudEhhc2g6IGFiQ29uZmlnQ3VycmVudEhhc2gsCiAgICAgICAgbGF0ZXN0SGFzaDogYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIHJlbW92ZWQ6IGZhbHNlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIGxhdGVzdFVwZGF0ZXM6IGFiQ29uZmlnUmVzcG9uc2UuZGF0YS51cGRhdGVzLAogICAgICAgIGxhdGVzdFN0YXRlOiBhYkNvbmZpZ0xhdGVzdFN0YXRlLAogICAgfSkKfQoKaWYgKCFkZXRhaWxlZCAmJiAoYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoKSkgewogICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgaW4gc2ltcGxlIG1vZGUsIHJldHVybiByaWdodCBhd2F5IG9uIHRoZSBmaXJzdCBvdXRkYXRlZCBmaWxlIGRpc2NvdmVyeS4KICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSB9Cn0KCi8vIDIuIENoZWNrIGlmIGFiIHNraWxscyBhcmUgb3V0ZGF0ZWQuCmNvbnN0IGFiU2tpbGxOYW1lcyA9IFsgJ2FiQ29yZScsIC4uLnRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKSBdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhYlNraWxsTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHNraWxsTmFtZSA9IGFiU2tpbGxOYW1lc1tpXTsKCiAgICBsZXQgc2tpbGxDdXJyZW50SGFzaDsKICAgIGlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICAgICAgc2tpbGxDdXJyZW50SGFzaCA9IGFiLnRhZ3MuYWJDb3JlU291cmNlSGFzaDsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbG9hZGVkU2tpbGxCb3QgPSBnZXRCb3QoYiA9PiBiLnRhZ3MuYWJMb2FkZWRTa2lsbCA9PT0gc2tpbGxOYW1lICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsKICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOwoKICAgICAgICBza2lsbEN1cnJlbnRIYXNoID0gbG9hZGVkU2tpbGxCb3QudGFncy5hYkxvYWRlZFNraWxsU291cmNlSGFzaDsKICAgIH0KICAgIAogICAgdHJ5IHsKICAgICAgICBjb25zdCBza2lsbE91dGRhdGVkID0gYXdhaXQgY2hlY2tTa2lsbE91dGRhdGVkKHNraWxsTmFtZSwgc2tpbGxDdXJyZW50SGFzaCk7CgogICAgICAgIGlmICghZGV0YWlsZWQgJiYgc2tpbGxPdXRkYXRlZCkgewogICAgICAgICAgICAvLyBJZiB3ZSBhcmUgcnVubmluZyBpbiBzaW1wbGUgbW9kZSwgcmV0dXJuIHJpZ2h0IGF3YXkgb24gdGhlIGZpcnN0IG91dGRhdGVkIGZpbGUgZGlzY292ZXJ5LgogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB1cGRhdGVBdmFpbGFibGU6IHRydWUgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2ggYW4gZXJyb3IuYCwgZSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9CgppZiAoZGV0YWlsZWQpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGFiRmlsZUNoZWNrcy5zb21lKGYgPT4gZi51cGRhdGVBdmFpbGFibGUpLAogICAgICAgIGFiRmlsZUNoZWNrcywKICAgIH0KfSBlbHNlIHsKICAgIC8vIElmIHdlIG1hZGUgaXQgYWxsIHRoZSB3YXkgaGVyZSBpbiBzaW1wbGUgbW9kZSwgdGhlcmUgYXJlIG5vIG91dGRhdGVkIGZpbGVzLgogICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdXBkYXRlQXZhaWxhYmxlOiBmYWxzZSB9Cn0nAN7j9JkLABJhYkNvcmVNYWpvclZlcnNpb24CBADe4/SZC5csAjEwJwDe4/SZCwASYWJDb3JlTWlub3JWZXJzaW9uAgQA3uP0mQuaLAIyNycA3uP0mQsABnN5c3RlbQIEAN7j9JkLnSwNYWIuY29yZS5sZWFybicA3uP0mQsABGFiSUQCBADe4/SZC6ssBWxlYXJuJwDe4/SZCwAEZm9ybQIEAN7j9JkLsSwHbm90aGluZycA3uP0mQsABmFiQm9vdAIEAN7j9JkLuSzlKkAvKioKKiBNSVQgTGljZW5zZQoqCiogQ29weXJpZ2h0IChjKSAyMDE5IENhc3VhbCBTaW11bGF0aW9uLCBJbmMuCioKKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Ciogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAoqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwoqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGwKKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRQoqIFNPRlRXQVJFLgoqIEBsaWNlbnNlIE1JVAoqLwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm9vdGluZyBhYmApOwp9CgovL2luc3QgbW9kZSAocGxheWVyIG9yIGJ1aWxkZXIpCmxldCBpbnN0TW9kZUNoZWNrID0gYXdhaXQgb3MudmVyc2lvbigpLnBsYXllck1vZGU7Ci8vY2hlY2sgc2VsZiBmb3IgaW5pdGlhbCBib290IGRhdGEKbGV0IGluaXRpYWxCb290ID0gbGlua3MucmVtZW1iZXIudGFncy5pbml0aWFsQm9vdCA/IHRydWUgOiBmYWxzZTsKLy9jaGVjayB1cmwgZm9yIHBvc3NpYmxlIGFiJ3MgdG8gbG9hZApsZXQgYm9vdEZsYWcgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuID8gY29uZmlnQm90LnRhZ3MucGF0dGVybiA6IGNvbmZpZ0JvdC50YWdzLmFiOwovL2NoZWNrIGZvciBhc2sKbGV0IGFzayA9IGNvbmZpZ0JvdC50YWdzLmFzazsKLy9sb2dpbgpsZXQgc3RhdHVzID0gYXdhaXQgdGhpc0JvdC5sb2FkaW5nU3RhdHVzKCk7Ci8vc2VlZCAobm90IGFjdGl2ZWx5IHVzZWQgaGVyZSkKbGV0IHNlZWQgPSBjb25maWdCb3QudGFncy5zZWVkOwovL3Byb21wdApsZXQgcHJvbXB0ID0gY29uZmlnQm90LnRhZ3MucHJvbXB0OwovL2NoYW5uZWwKbGV0IGNoYW5uZWwgPSBjb25maWdCb3QudGFncy5jaGFubmVsOwovL3V1YWIKbGV0IHV1YWIgPSBjb25maWdCb3QudGFncy5hdXhsaW5rID09ICJ1dWFiIjsKLy92ZXJzaW9uCmxldCB2ZXJzaW9uID0gY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb24gPz8gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uOwovL3JlcXVlc3QgYXV0aCBib3QKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCi8vcmVkaXJlY3QgaWYgaW4gVVJMCmlmIChjb25maWdCb3QudGFncy5qb2luQ29kZSkgewogICAgdGhpc0JvdC5hYkpvaW5Ib3N0KHsgdGV4dDogY29uZmlnQm90LnRhZ3Muam9pbkNvZGUgfSk7Cn0KCi8vc3RhdHVzIGNsZWFuIHVwCmRlc3Ryb3koc3RhdHVzKTsKCi8vY2hlY2sgdGltZSBpZiBuZWVkZWQKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJDb25kaXRpb24pIHsKICAgIGF3YWl0IGxpbmtzLnJlbWVtYmVyLmFiQ29uZGl0aW9uKCk7Cn0KCi8vaWYgbm8gc3R1ZGlvLCBzZXQgc3R1ZGlvCmlmIChhdXRoQm90ICYmICFjb25maWdCb3QudGFncy5zdHVkaW8pIHsKICAgIGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA9IGF1dGhCb3QuaWQ7Cn0KCmlmIChhdXRoQm90KSB7CiAgICB0aGlzQm90LmFiTG9hZFN0dWRpb3MoKTsKfQoKaWYgKCFsaW5rcy5wZXJzb25hbGl0eSkgeyAKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJQZXJzb25hbGl0eSIpOwp9CgovL2luaXRpYWxpemUgcmVtZW1iZXIgZ2xvYmFscwpnbG9iYWxUaGlzLmFiSW5zdE1lbW9yeSA9IGxpbmtzLnJlbWVtYmVyOwpnbG9iYWxUaGlzLmFiUmVtZW1iZXIgPSBsaW5rcy5yZW1lbWJlcjsKZ2xvYmFsVGhpcy5hYlBlcnNvbmFsaXR5ID0gbGlua3MucGVyc29uYWxpdHk7CgppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VHcmlkUG9ydGFsQ29sb3IpIHsKICAgIGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yOwp9CgovL1RoaXMgY2hlY2tzIGZvciB0aGUgYXBwcm9wcmlhdGUgYXJyYXkgb2Ygc2tpbGxzIGFuZCBpbml0aWFsaXplcyB0aGVtCmF3YWl0IHRoaXNCb3QuYWJTa2lsbEluaXRpYWxpemF0aW9uKGluc3RNb2RlQ2hlY2spOwoKLy9pbml0aWFsaXppbmcgb2YgZ2xvYmFsIHZhcmlhYmxlcwpnbG9iYWxUaGlzLmJ1aWxkZXJWZXJzaW9uID0gaW5zdE1vZGVDaGVjayA9PSAiYnVpbGRlciIgPyB0cnVlIDogZmFsc2U7Cmdsb2JhbFRoaXMuYWJMb25nVGVybU1lbW9yeVNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlB1Ymxpc2ggPSBsaW5rcy5zdG9yZTsKZ2xvYmFsVGhpcy5hYlN0b3JlID0gbGlua3Muc3RvcmU7Cmdsb2JhbFRoaXMuYWIgPSB0aGlzQm90OwoKLy9jaGVjayBmb3IgdXVhYnMKaWYgKHV1YWIpIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbih7bWVzc2FnZTogY29uZmlnQm90LnRhZ3MudXVhYiwgaXNVVUFCOiB0cnVlfSk7Cn0KLy9jaGVjayBmb3IgY2hhbm5lbCBpZiBjaGFubmVscyBhbGxvd2VkCmVsc2UgaWYgKGNoYW5uZWwgJiYgbGlua3MucmVtZW1iZXIudGFncy5hbGxvd0NoYW5uZWxzKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oe21lc3NhZ2U6IGNoYW5uZWwsIGlzQ2hhbm5lbDogdHJ1ZX0pOwp9IGVsc2UgewogICAgLy9wb3B1bGF0ZSBib290ZmxhZyBhYgogICAgaWYgKGluaXRpYWxCb290ICYmIGJvb3RGbGFnKSB7CiAgICAgICAgYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogYm9vdEZsYWcsIGluaXRpYWxCb290OiB0cnVlLCBhdXRvSGF0Y2g6IHRydWUsIHNvdXJjZUV2ZW50OiAnYm9vdCcsIGFiVmVyc2lvbjogdmVyc2lvbn0pOwogICAgfQoKICAgIC8vbG9va3VwIGFza0lEIGlmIGF2YWlsYWJsZQogICAgaWYgKGluaXRpYWxCb290ICYmIGFzaykgewogICAgICAgIGlmIChhc2sgPT0gImVnZ0NhcnRvbiIgfHwgYXNrID09ICJjYXN1YWxUdXRvcmlhbCIpIHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KGFzayk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2spOwogICAgICAgIH0KICAgIH0KfQoKLy9jaGVjayBmb3IgYXJ0aWZhY3QgRklYCmlmIChjb25maWdCb3QudGFncy5hcnRpZmFjdCAmJiBpbml0aWFsQm9vdCAmJiAhYXNrICYmICFib290RmxhZykgewogICAgY29uc3QgYXJ0aWZhY3QgPSBjb25maWdCb3QudGFncy5hcnRpZmFjdDsKICAgIGNvbnN0IGFydEluZGV4ID0gYXJ0aWZhY3QuaW5kZXhPZigiX2FydF8iKTsKICAgIGNvbnN0IHN0dWRpbyA9IGFydGlmYWN0LnN1YnN0cmluZygwLCBhcnRJbmRleCk7CiAgICBjb25zdCByZWNvcmRBZGRyZXNzID0gYXJ0aWZhY3Quc3Vic3RyaW5nKGFydEluZGV4KTsKICAgIGNvbnN0IHJlY29yZERhdGEgPSBhd2FpdCBvcy5nZXREYXRhKHN0dWRpbywgcmVjb3JkQWRkcmVzcyk7CiAgICBjb25zdCBhc2tJRCA9IHJlY29yZERhdGEuZGF0YS5wYXR0ZXJuOwoKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJRCk7Cn0KCi8vIENoZWNrIGlmIHdlIGNhbiB3YWtlIHVwIGFiLCBhbmQgdGhlbiBkbyBzby4KaWYgKCFjb25maWdCb3QudGFncy5hYlNsZWVwKSB7CiAgICBpZiAoKGluaXRpYWxCb290ICYmICFib290RmxhZyAmJiAhYXNrKSB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWx3YXlzU3RhcnRBd2FrZSB8fCBjb25maWdCb3QudGFncy5hYlN0YXlBd2FrZSkgewogICAgICAgIGF3YWl0IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlLCBpbml0aWFsOiBpbml0aWFsQm9vdCB9KTsKICAgIH0KfQoKLy9zZXQgaW5pdGlhbCBib290IGRhdGEKaWYgKGluaXRpYWxCb290KSB7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnJlbWVtYmVyLCAnaW5pdGlhbEJvb3QnLCBmYWxzZSwgJ3NoYXJlZCcpOwoKICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbGl6YXRpb25Db25maWd1cmF0aW9uKSB7CiAgICAgICAgbGlua3MucmVtZW1iZXIuYWJJbml0aWFsaXphdGlvbkNvbmZpZ3VyYXRpb24oKTsKICAgIH0KfQoKLy9jbGVhbiB1cCBVUkwgd2l0aCB0YWdQb3J0YWwKaWYgKGNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbCAmJiAhY29uZmlnQm90LnRhZ3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgJiYgYnVpbGRlclZlcnNpb24pIHsKICAgIGNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbCA9IG51bGw7CiAgICBjb25maWdCb3QudGFncy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cn0KCi8vcGF1c2UgZm9yIGFiIGxvYWRpbmcKYXdhaXQgb3Muc2xlZXAoNTAwKTsKCi8vaW5pdGlhbGl6ZSB0aW1lIGJvdAp0aGlzQm90LmFiVGltZXIoKTsKCnRoaXNCb3QuYWJDcmVhdGVVcGRhdGVDaGVja2VyKCk7CgpsaW5rcy5wZXJzb25hbGl0eS51cGRhdGVQZXJzb25hbGl0eSgpOwoKLy9pbml0aWFsaXphdGlvbiBzaG91dApzdXBlclNob3V0KCJvbkFCSW5pdGlhbGl6ZWQiLCB0YWdzLmFiSW5zdCk7KADe4/SZCwAGYWJDb3JlAXgnAN7j9JkLAAdhYkFkYXB0AgQA3uP0mQugV74UQGxldCBza2lsbE5hbWU7CmxldCBza2lsbERhdGE7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgppZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICBza2lsbE5hbWUgPSB0aGF0OwogICAgc2tpbGxEYXRhID0gbnVsbDsKfSBlbHNlIGlmICh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcpIHsKICAgIHNraWxsTmFtZSA9IHRoYXQuc3lzdGVtSUQgPz8gdGhhdC5za2lsbE5hbWU7CiAgICBza2lsbERhdGEgPSB0aGF0LmRhdGEgPz8gbnVsbDsKfQoKaWYgKCFza2lsbE5hbWUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbE5hbWUgaXMgcmVxdWlyZWQuYCk7CiAgICByZXR1cm4gZmFsc2U7Cn0KCmlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfX1dIGFiQ29uZmlnIGNhbm5vdCBiZSBsb2FkZWQgdXNpbmcgYWJBZGFwdC5gKTsKICAgIHJldHVybjsKfQoKdHJ5IHsKICAgIGNvbnN0IGxvYWRlZFNraWxscyA9IHRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKTsKCiAgICBpZiAoIWxvYWRlZFNraWxscy5pbmNsdWRlcyhza2lsbE5hbWUpKSB7CiAgICAgICAgY29uc3QgdXJsID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FiLyR7c2tpbGxOYW1lfS5hdXhgKTsKICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsIH0pOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIHNraWxsIEdFVCByZXNwb25zZTpgLCByZXNwb25zZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgCiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMikgewogICAgICAgICAgICAvLyBBVVggRm9ybWF0IFZlcnNpb24gMi4KICAgICAgICAgICAgY29uc3QgdXBkYXRlcyA9IHJlc3BvbnNlLmRhdGEudXBkYXRlczsKICAgICAgICAgICAgYXdhaXQgb3MuYXBwbHlVcGRhdGVzVG9JbnN0KHVwZGF0ZXMpOwogICAgICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHVwZGF0ZXMpOwogICAgICAgICAgICBjb25zdCBzb3VyY2VIYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4Jywgc3RhdGUpOwoKICAgICAgICAgICAgLy8gTG9hZGVkIHNraWxscyBhcmUgc3RvcmVkIGFzIHNoYXJlZCBib3RzIHRoYXQgYW55b25lIGluIHRoZSBpbnN0IGNhbiByZWFkLgogICAgICAgICAgICBjcmVhdGUoewogICAgICAgICAgICAgICAgc3BhY2U6ICdzaGFyZWQnLAogICAgICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgICAgICBhYkxvYWRlZFNraWxsOiBza2lsbE5hbWUsCiAgICAgICAgICAgICAgICBhYkxvYWRlZFNraWxsU291cmNlSGFzaDogc291cmNlSGFzaCwKICAgICAgICAgICAgICAgIGZvcm06ICdub3RoaW5nJywKICAgICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQVVYIGZvcm1hdCB2ZXJzaW9uICR7cmVzcG9uc2UuZGF0YS52ZXJzaW9ufSBpcyBub3Qgc3VwcG9ydGVkLmApOwogICAgICAgIH0KCiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWIgc2tpbGwgJHtza2lsbE5hbWV9IGlzIGFscmVhZHkgbG9hZGVkLmApCiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHNraWxsQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3Nbc2tpbGxOYW1lXSA9PT0gdHJ1ZSk7CiAgICBpZiAoc2tpbGxCb3RzICYmIHNraWxsQm90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgd2hpc3Blcihza2lsbEJvdHMsIHRhZ05hbWUsIGNvbmZpZ0JvdC50YWdzLmluc3QpOwogICAgICAgIHdoaXNwZXIoc2tpbGxCb3RzLCAib25Ta2lsbFVwZGF0ZSIsIHsgZGF0YTogc2tpbGxEYXRhIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gTm8gYm90cyBhcHBlYXIgdG8gaGF2ZSBiZWVuIGxvYWRlZCB3aXRoICR7c2tpbGxOYW1lfS5gKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gRmFpbGVkIHRvIGRvd25sb2FkICR7c2tpbGxOYW1lfS4gU2VlIGFib3ZlIGVycm9yLmApOwogICAgcmV0dXJuIGZhbHNlOwp9JwDe4/SZCwALZGVzY3JpcHRpb24CBADe4/SZC99rT1RoaXMgc2tpbGwgaXMgZGVzaWduZWQgdG8gaGFuZGxlIGJvdGggcmVjb25maWd1cmF0aW9uIG9mIGFiIGFuZCBpbml0aWFsaXphdGlvbi4nAN7j9JkLAApvbkJvdEFkZGVkAgQA3uP0mQuvbPEBQGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJDb3JlIFNUQVJUIFVQYCk7Cgp0aGlzQm90LmFiSW5zdFVwZGF0ZSgpOwoKaWYgKCFsaW5rcy5yZW1lbWJlcikgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBmaW5kIGFiQ29uZmlnIHJlbWVtYmVyIGJvdC5gKTsKfQoKc2V0VGltZW91dCgoKSA9PiB0aGlzQm90LmFiQm9vdCgpLCA1MDApOycA3uP0mQsACHJlbWVtYmVyAgQA3uP0mQuhbijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDe4/SZCwADbG9nAgQA3uP0mQvIbmxALy9wYXNzIHRocm91Z2ggbG9nIGRhdGEKaWYgKGxpbmtzLmNvbnNvbGUpIHsKICAgIGxpbmtzLmNvbnNvbGUubG9nKHRoYXQpOwp9CmVsc2UgewogICAgY29uc29sZS5sb2codGhhdCk7Cn0nAN7j9JkLAA1tYW5pZmVzdGF0aW9uAgQA3uP0mQu1byjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDe4/SZCwAMYWJDcmVhdGVIb3N0AgQA3uP0mQvcb5YKQGNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwoKLy90aGlzIGZ1bmN0aW9uIGhhbmRsZXMgY3JlYXRpbmcgYSBmaWxlIGZvciBqb2luIGNvZGVzCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgewogICAgb3MudG9hc3QoInVybCBjb3BpZWQgdG8gY2xpcGJvYXJkIik7CgogICAgb3Muc2V0Q2xpcGJvYXJkKHNpdGVPcmlnaW4gKyAiLz9qb2luQ29kZT0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDAsIDMpICsgIi0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDMpKTsKCiAgICByZXR1cm47Cn0KCmlmICghYXV0aEJvdCkgewogICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKfQoKaWYgKCFhdXRoQm90KSB7CiAgICBvcy50b2FzdCgicGxlYXNlIGxvZyBpbiB0byBnZW5lcmF0ZSBhIGpvaW4gY29kZSIpOwogICAgcmV0dXJuOwp9Cgpjb25zdCBuZXdIb3N0SUQgPSB1dWlkKCkucmVwbGFjZUFsbCgiLSIsICIiKS5zdWJzdHJpbmcoMCwgNik7CmNvbnN0IGRhdGUgPSBEYXRlVGltZS5ub3coKS50b01pbGxpcygpOwpjb25zdCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5Owpjb25zdCByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YShyZWNvcmRLZXksIG5ld0hvc3RJRCwgeyB1cmw6IGNvbmZpZ0JvdC50YWdzLnVybCwgZGF0ZTogZGF0ZSwgbWFya2VyczogWyJwdWJsaWNSZWFkIl0gfSk7CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKSB7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnJlbWVtYmVyLCAnaG9zdElEJywgbmV3SG9zdElELnN1YnN0cmluZygwLCAzKSArICItIiArIG5ld0hvc3RJRC5zdWJzdHJpbmcoMyksICdzaGFyZWQnKTsKCiAgICBjb25zdCBqb2luVVJMID0gc2l0ZU9yaWdpbiArICIvP2pvaW5Db2RlPSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRDsKCiAgICBvcy5zZXRDbGlwYm9hcmQoam9pblVSTCk7CgogICAgdGhhdC50YWdzLmxhYmVsID0gImpvaW4gY29kZTogIiArIG5ld0hvc3RJRC5zdWJzdHJpbmcoMCwgMykgKyAiLSIgKyBuZXdIb3N0SUQuc3Vic3RyaW5nKDMpOwoKICAgIG9zLnNob3dRUkNvZGUoam9pblVSTCk7CgogICAgb3MudG9hc3QoImhvc3QgZ2VuZXJhdGVkLCB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogIiArIG5ld0hvc3RJRCk7Cn0KZWxzZSB7CiAgICBvcy50b2FzdCgic29tZXRoaW5nIHdlbnQgd3JvbmcsIHBsZWFzZSB0cnkgYWdhaW4iKTsKCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwp9JwDe4/SZCwAKYWJKb2luSG9zdAIEAN7j9JkL83nuBkAvL2xvZ2ljIGZvciB1c2luZyBhIGpvaW4gY29kZSAoY2hlY2tzIGZvciBleGlzdGluZyBmaWxlcykKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmxldCBnZXRSZWNvcmQ7CgppZiAodGhhdC5kYXRhKSB7CiAgICBnZXRSZWNvcmQgPSB7IHN1Y2Nlc3M6IHRydWUsIGRhdGE6IHRoYXQuZGF0YSB9Owp9CmVsc2UgewogICAgY29uc3Qgam9pbkNvZGUgPSB0aGF0LnRleHQucmVwbGFjZUFsbCgiLSIsICIiKTsKICAgIGNvbnN0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CiAgICBjb25zb2xlLmxvZygiSk9JTkNPREUiLCBqb2luQ29kZSkKICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBqb2luQ29kZSk7Cn0KCmlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3QgZGF0ZSA9IERhdGVUaW1lLm5vdygpOwogICAgbGV0IGNyZWF0ZURhdGUgPSBEYXRlVGltZS5mcm9tTWlsbGlzKGdldFJlY29yZC5kYXRhLmRhdGUpOwogICAgbGV0IGRpZmZlcmVuY2UgPSBkYXRlLmRpZmYoY3JlYXRlRGF0ZSwgImRheXMiKS50b09iamVjdCgpOwoKICAgIGRpZmZlcmVuY2UgPSBNYXRoLmZsb29yKGRpZmZlcmVuY2UuZGF5cyk7CgogICAgaWYgKGRpZmZlcmVuY2UgPCA4KSB7CiAgICAgICAgb3MudG9hc3QoImpvaW5pbmcgaG9zdCBub3ciKTsKCiAgICAgICAgb3MuZ29Ub1VSTChnZXRSZWNvcmQuZGF0YS51cmwpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgb3MudG9hc3QoImpvaW4gY29kZSBvdXQgb2YgZGF0ZSwgcGxlYXNlIGdlbmVyYXRlIGEgbmV3IGpvaW4gY29kZSIpOwogICAgfQp9CmVsc2UgewogICAgb3MudG9hc3QoImNvZGUvYWIgaW52YWxpZCwgcGxlYXNlIHRyeSBhZ2FpbiIpOwp9JwDe4/SZCwAGc2VhcmNoAgQA3uP0mQvigAEo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScA3uP0mQsACGFiSWdub3JlAgQA3uP0mQuJgQEEdHJ1ZScA3uP0mQsABG1lbnUCBADe4/SZC46BASjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDe4/SZCwAVYWJTa2lsbEluaXRpYWxpemF0aW9uAgQA3uP0mQu1gQGjAkAvL0ZpbmQgdGhlIGFwcHJvcHJpYXRlIGFycmF5IGFuZCBwb3B1bGF0ZSBza2lsbHMKbGV0IHNraWxsQXJyYXkgPSBsaW5rcy5yZW1lbWJlci50YWdzW3RoYXQgKyAiU2tpbGxBcnJheSJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoc2tpbGxBcnJheVtpXSk7Cn0KCmlmIChjb25maWdCb3QudGFncy5lbWJlZCA9PT0gJ2lvcycpIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgnYWJJT1NCcmlkZ2UnKTsKfQoKcmV0dXJuOycA3uP0mQsABmJhbm5lcgIEAN7j9JkL2YMBKPCflJdiNTUyZWFmOS1hOWQ2LTQxYzgtODUxNS1jYmQyYWJlYWFlNzMnAN7j9JkLAAVpbnB1dAIEAN7j9JkLgIQBKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAN7j9JkLAA1sb2FkaW5nU3RhdHVzAgQA3uP0mQunhAHGB0Bjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkxvYWRTdGF0dXMiOwoKbGV0IHN0YXR1c0JvdCA9IHt9OwoKc3RhdHVzQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CnN0YXR1c0JvdC5sYWJlbCA9ICJ2ZXJpZnlpbmcgYXV0aEJvdCI7CnN0YXR1c0JvdC5sYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKc3RhdHVzQm90LmFiTG9hZFN0YXR1cyA9IHRydWU7CnN0YXR1c0JvdC5tZW51SXRlbVN0eWxlID0geyAiYmFja2dyb3VuZCI6ICJub25lIiB9OwpzdGF0dXNCb3QudHJhY2tOdW0gPSAwOwpzdGF0dXNCb3Qub25DcmVhdGUgPSBgQAogICAgaWYgKHRhZ3MudHJhY2tOdW0gPT0gMikgewogICAgICAgIHRhZ3MudHJhY2tOdW0gPSAwOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdGFncy50cmFja051bSsrOwogICAgfQoKICAgIHRhZ3MubGFiZWwgPSB0YWdzWyJsYWJlbCIrdGFncy50cmFja051bV07CiAgICB0YWdzLmZvcm1BZGRyZXNzID0gdGFnc1siZm9ybSIrdGFncy50cmFja051bV07CgogICAgc2V0VGltZW91dCgoKSA9PiB3aGlzcGVyKHRoaXNCb3QsICJvbkNyZWF0ZSIpLCA1MDApO2A7CnN0YXR1c0JvdC5sYWJlbDAgPSAidmVyaWZ5aW5nIGF1dGhCb3QuIjsKc3RhdHVzQm90LmxhYmVsMSA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4uIjsKc3RhdHVzQm90LmxhYmVsMiA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4uLiI7CnN0YXR1c0JvdC5mb3JtMCA9ICJob3VyZ2xhc3NfYm90dG9tIjsKc3RhdHVzQm90LmZvcm0xID0gImhvdXJnbGFzc190b3AiOwpzdGF0dXNCb3QuZm9ybTIgPSAiaG91cmdsYXNzX2JvdHRvbSI7CnN0YXR1c0JvdC5vbkRlc3Ryb3kgPSBgQAogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKbGV0IGNyZWF0ZWRTdGF0dXNCb3QgPSBjcmVhdGUoc3RhdHVzQm90KTsKCnJldHVybiBjcmVhdGVkU3RhdHVzQm90OycA3uP0mQsAA2FzawIEAN7j9JkL7osBKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAN7j9JkLAA1hYkxvYWRTdHVkaW9zAgQA3uP0mQuVjAFbQGNvbnN0IHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7CmNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvcyA9IHVzZXJTdHVkaW9zOycA3uP0mQsAB2FiVGltZXICBADe4/SZC/GMAcEGQGlmIChnZXRCb3QoImFiVGltZXIiLCB0cnVlKSkgewogICAgcmV0dXJuOwp9CgppZiAoIXRhZ3MuYWJYUCkgewogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJYUCIsICIwIiwgImxvY2FsIik7Cn0KCmxldCB0aW1lckJvdCA9IHt9OwoKdGltZXJCb3Quc3BhY2UgPSAidGVtcExvY2FsIjsKdGltZXJCb3QubWFuYWdlciA9IGdldExpbmsodGhpc0JvdCk7CnRpbWVyQm90Lm9uQ3JlYXRlID0gYEAKICAgIG1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5vblRpbWVDaGVjaygpLCA2MDAwMCk7CmA7CnRpbWVyQm90LmFiVGltZXIgPSB0cnVlOwp0aW1lckJvdC5vblRpbWVDaGVjayA9IGBACiAgICBpZiAodGFncy5ub3RJZGxlKSB7CiAgICAgICAgdGFncy5ub3RJZGxlID0gZmFsc2U7CgogICAgICAgIC8vY29uc29sZS5sb2coIlhQIiwgbGlua3MubWFuYWdlci50YWdzLmFiWFApOwoKICAgICAgICBjb25zdCB0b3RhbFhQID0gbGlua3MubWFuYWdlci50YWdzLmFiWFAgKyAxOwoKICAgICAgICBzZXRUYWdNYXNrKGxpbmtzLm1hbmFnZXIsICJhYlhQIiwgdG90YWxYUCwgImxvY2FsIik7CiAgICB9CmA7CnRpbWVyQm90Lm5vdElkbGUgPSBmYWxzZTsKdGltZXJCb3Qub25BbnlBY3Rpb24gPSBgQAogICAgaWYgKCF0YWdzLm5vdElkbGUpIHsKICAgICAgICBpZiAodGhhdC5hY3Rpb24uaWQgPT0gZ3JpZFBvcnRhbEJvdC5pZCkKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3Mubm90SWRsZSA9IHRydWU7CiAgICAgICAgfQogICAgfQpgOwoKbGV0IGFiVGltZXIgPSBjcmVhdGUodGltZXJCb3QpOwoKZ2xvYmFsVGhpcy5hYlRpbWVyID0gYWJUaW1lcjsnAN7j9JkLAAVzdG9yZQIEAN7j9JkLs5MBKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAN7j9JkLAAdjb25zb2xlAgQA3uP0mQvakwEo8J+UlzI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYicA3uP0mQsACWFiVmVyc2lvbgIEAN7j9JkLgZQBBTEwLjI3JwDe4/SZCwAMYWJMb2FkQ29uZmlnAgQA3uP0mQuHlAGaBkBjb25zdCB1cmwgPSBuZXcgVVJMKG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpKTsKdXJsLnBhdGhuYW1lID0gdXJsLnBhdGhuYW1lLnJlcGxhY2UoJ2FiMS5hdXgnLCAnYWJDb25maWcuYXV4Jyk7Cgp0cnkgewogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogdXJsLmhyZWYgfSk7CgogICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IHVwZGF0ZXMgPSByZXNwb25zZS5kYXRhLnVwZGF0ZXM7CiAgICBhd2FpdCBvcy5hcHBseVVwZGF0ZXNUb0luc3QodXBkYXRlcyk7CgogICAgaWYgKGxpbmtzLnJlbWVtYmVyKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBMb2FkZWQgYWJDb25maWcgYXV4IGJ1dCBjb3VsZCBub3QgZmluZCByZW1lbWJlciBib3QuYCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEZhaWxlZCB0byBkb3dubG9hZCBhYkNvbmZpZy4gU2VlIGFib3ZlIGVycm9yLmApOwogICAgcmV0dXJuIGZhbHNlOwp9JwDe4/SZCwAXYWJCdWlsZENhc3VhbENhdGFsb2dVUkwCBADe4/SZC6KaAf8BQGNvbnN0IHJlbGF0aXZlUGF0aCA9IHRoYXQ7Cgpjb25zdCB1cmwgPSBuZXcgVVJMKGxpbmtzLnJlbWVtYmVyLnRhZ3MuY2FzdWFsQ2F0YWxvZ1VSTCk7CmNvbnN0IGVudiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuY2FzdWFsQ2F0YWxvZ0VudjsKCnVybC5wYXRobmFtZSA9IHJlbGF0aXZlUGF0aDsKCmlmIChlbnYgJiYgZW52ICE9PSAncHJvZCcpIHsKICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdlbnYnLCBlbnYpOwp9CgpyZXR1cm4gdXJsLmhyZWY7JwDe4/SZCwAHY2hhbm5lbAIEAN7j9JkLopwBKPCflJdhOWI2YWEwZC1iMzU3LTRkZTYtOWJlZi04NTM0OGFiMWQwZTAnAN7j9JkLAAtwZXJzb25hbGl0eQIEAN7j9JkLyZwBKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAN7j9JkLAAxhYkluc3RVcGRhdGUCBADe4/SZC/CcAaIBQC8vIFVwZGF0ZSB0aGUgYWJJbnN0IHRhZyB3aGljaCByZXByZXNlbnRzIHRoZSBpbnN0IHRoYXQgdGhpcyBhYiBleGlzdHMgaW4uCmNvbnN0IGN1ckluc3QgPSBvcy5nZXRDdXJyZW50SW5zdCgpOwpzZXRUYWdNYXNrKHRoaXNCb3QsICdhYkluc3QnLCBjdXJJbnN0LCAnc2hhcmVkJyk7JwDe4/SZCwAMb25JbnN0Sm9pbmVkAgQA3uP0mQuTngEYQHRoaXNCb3QuYWJJbnN0VXBkYXRlKCk7JwDe4/SZCwALb25JbnN0TGVhdmUCBADe4/SZC6yeARhAdGhpc0JvdC5hYkluc3RVcGRhdGUoKTsnAN7j9JkLAAxyZXNlcnZlZEFza3MCBADe4/SZC8WeAQzwn6esWyJob21lIl0nAN7j9JkLAAhhcnRpZmFjdAIEAN7j9JkL0J4BKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAN7j9JkLAAtib3RfZmFjdG9yeQIEAN7j9JkL954BKPCflJdjNzhhYTY2My1kMDVjLTRlYzQtYmMyYy0yNmZkNTE1NjBiOTcnAN7j9JkLAAV1dGlscwIEAN7j9JkLnp8BKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAN7j9JkLAAh1cGRhdGVBQgIEAN7j9JkLxZ8BlSlAY29uc3QgcmVsb2FkUGFnZSA9IHRoYXQ/LnJlbG9hZFBhZ2UgPz8gdHJ1ZTsNCmNvbnN0IHNob3dJbmRpY2F0b3IgPSB0aGF0Py5zaG93SW5kaWNhdG9yID8/IHRydWU7DQoNCmNvbnN0IERSWV9SVU4gPSBmYWxzZTsNCg0KbGV0IGJ1c3lJbmRpY2F0b3I7DQoNCmlmIChzaG93SW5kaWNhdG9yKSB7DQogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAndXBkYXRlQUJNZW51JzsNCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgdXBkYXRlQUJNZW51OiB0cnVlLCBsYWJlbDogYHVwZGF0aW5nICR7bGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX1gIH0pOw0KfQ0KDQpsZXQgb3ZlcndyaXRlUmVzdWx0Ow0KDQp0cnkgew0KICAgIC8vIFVwZGF0ZSBhYkNvbmZpZy4NCiAgICBjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOw0KICAgIGNvbnN0IGFiQ29uZmlnUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBhYkNvbmZpZ1VSTCB9KTsNCg0KICAgIGFzc2VydChhYkNvbmZpZ1Jlc3BvbnNlLnN0YXR1cyA9PT0gMjAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCBhYkNvbmZpZy4gUmVzcG9uc2U6ICR7YWJDb25maWdSZXNwb25zZS5zdGF0dXNUZXh0fWApOw0KICAgIGFzc2VydChhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZyBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke2FiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9ufWApOw0KDQogICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogYWJDb25maWdSZXNwb25zZS5kYXRhLCBncm91cFRhZzogJ2FiQ29uZmlnJywgZHJ5UnVuOiBEUllfUlVOIH0pOw0KICAgIHNldFRhZ01hc2soYWIubGlua3MucmVtZW1iZXIsICdhYkNvbmZpZ1NvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KDQogICAgLy8gVXBkYXRlIGFiIHNraWxscy4NCiAgICBjb25zdCBsb2FkZWRTa2lsbHMgPSB0aGlzQm90LmFiTG9hZGVkU2tpbGxzKCk7DQoNCiAgICBmb3IgKGxldCBza2lsbE5hbWUgb2YgbG9hZGVkU2tpbGxzKSB7DQogICAgICAgIGNvbnN0IHNraWxsVVJMID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FiLyR7c2tpbGxOYW1lfS5hdXhgKTsNCg0KICAgICAgICAvLyBTa2lsbHMgY2FuIGJlIHJlc3RydWN0dXJlZCwgbWVhbmluZyB0aGF0IHRoZXkgY291bGQgYmUgcmVtb3ZlZCBlbnRpcmVseSBpbiB0aGUgZnV0dXJlLg0KICAgICAgICAvLyBJZiBhIGZpbGUgZmFpbHMgdG8gYmUgcmV0cmlldmVkLCB0aGVuIHJlbW92ZSBhbGwgdGhlIGJvdHMgaW4gdGhlIGdyb3VwIGluIHRoZSBpbnN0Lg0KICAgICAgICBsZXQgcmVtb3ZlU2tpbGwgPSBmYWxzZTsNCiAgICAgICAgbGV0IHNraWxsUmVzcG9uc2U7DQoNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsNCg0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraWxsUmVzcG9uc2U6YCwgc2tpbGxSZXNwb25zZSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGFzc2VydChza2lsbFJlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke3NraWxsTmFtZX0gbXVzdCBiZSBpbiBhdXggZmlsZSBmb3JtYXQgdjIuIEFjdHVhbCBhdXggZmlsZSBmb3JtYXQgdmVyc2lvbjogJHtza2lsbFJlc3BvbnNlLmRhdGEudmVyc2lvbn1gKTsNCg0KICAgICAgICAgICAgaWYgKHNraWxsUmVzcG9uc2Uuc3RhdHVzICE9PSAyMDApIHsNCiAgICAgICAgICAgICAgICBpZiAoc2tpbGxSZXNwb25zZS5zdGF0dXMgPT09IDQwMyB8fCBza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7DQogICAgICAgICAgICAgICAgICAgIHJlbW92ZVNraWxsID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9IGNhdGNoIChlKSB7DQogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2F1Z2h0IGVycm9yIHdoaWxlIGRvd25sb2FkaW5nIHNraWxsOmAsIGUpOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsNCiAgICAgICAgICAgICAgICAvLyBGaWxlIGRvZXNudCBleGlzdCBhbnltb3JlLCB0aGUgc2tpbGwgaGFzIGJlZW4gcmVtb3ZlZC4NCiAgICAgICAgICAgICAgICByZW1vdmVTa2lsbCA9IHRydWU7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIHRocm93IGU7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGlmIChza2lsbFJlc3BvbnNlICYmICFyZW1vdmVTa2lsbCkgew0KICAgICAgICAgICAgb3ZlcndyaXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hdXhWMk92ZXJ3cml0ZSh7IGF1eDogc2tpbGxSZXNwb25zZS5kYXRhLCBncm91cFRhZzogc2tpbGxOYW1lLCBkcnlSdW46IERSWV9SVU4gfSk7DQoNCiAgICAgICAgICAgIGNvbnN0IGxvYWRlZFNraWxsQm90ID0gZ2V0Qm90KGIgPT4gYi50YWdzLmFiTG9hZGVkU2tpbGwgPT09IHNraWxsTmFtZSAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyk7DQogICAgICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOw0KICAgICAgICAgICAgDQogICAgICAgICAgICBzZXRUYWdNYXNrKGxvYWRlZFNraWxsQm90LCAnYWJMb2FkZWRTa2lsbFNvdXJjZUhhc2gnLCBvdmVyd3JpdGVSZXN1bHQuc291cmNlSGFzaCwgJ3NoYXJlZCcpOw0KICAgICAgICB9IGVsc2UgaWYgKHJlbW92ZVNraWxsKSB7DQogICAgICAgICAgICBjb25zdCBza2lsbEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzW3NraWxsTmFtZV0gPT09IHRydWUpOw0KDQogICAgICAgICAgICBpZiAoRFJZX1JVTikgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZGVsZXRlICR7c2tpbGxCb3RzLmxlbmd0aH0gJHtza2lsbE5hbWV9IGJvdChzKSBiZWNhdXNlICR7c2tpbGxOYW1lfSBpcyBubyBsb25nZXIgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLmApDQogICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFNraWxsICR7c2tpbGxOYW1lfSBpcyBubyBsb25nZXIgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBSZW1vdmUgJHtza2lsbEJvdHMubGVuZ3RofSAke3NraWxsTmFtZX0gYm90KHMpIGZyb20gaW5zdC5gKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVzdHJveShza2lsbEJvdHMpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgLy8gVXBkYXRlIGFiQ29yZSAoZG8gdGhpcyBvbmUgbGFzdCEpDQogICAgY29uc3QgYWJDb3JlVVJMID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTCgnL2FiL2FiQ29yZS5hdXgnKTsNCiAgICBjb25zdCBhYkNvcmVSZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBhYkNvcmVVUkwgfSk7DQoNCiAgICBhc3NlcnQoYWJDb3JlUmVzcG9uc2Uuc3RhdHVzID09PSAyMDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkIGFiQ29yZS4gUmVzcG9uc2U6ICR7YWJDb3JlUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsNCiAgICBhc3NlcnQoYWJDb3JlUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29yZSBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke2FiQ29yZVJlc3BvbnNlLmRhdGEudmVyc2lvbn1gKTsNCg0KICAgIG92ZXJ3cml0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYXV4VjJPdmVyd3JpdGUoeyBhdXg6IGFiQ29yZVJlc3BvbnNlLmRhdGEsIGdyb3VwVGFnOiAnYWJDb3JlJywgZHJ5UnVuOiBEUllfUlVOIH0pOw0KICAgIHNldFRhZ01hc2soYWIsICdhYkNvcmVTb3VyY2VIYXNoJywgb3ZlcndyaXRlUmVzdWx0LnNvdXJjZUhhc2gsICdzaGFyZWQnKTsNCg0KICAgIGlmIChyZWxvYWRQYWdlKSB7DQogICAgICAgIGNvbnN0IHJlbW90ZURhdGFFdmVudCA9ICd1cGRhdGVfYWJfcmVsb2FkX3BhZ2UnOw0KICAgICAgICBjb25zdCByZW1vdGVEYXRhQXJnID0geyByZWxvYWRQYWdlLCBkcnlSdW46IERSWV9SVU4gfTsNCg0KICAgICAgICBpZiAob3MuaXNDb2xsYWJvcmF0aXZlKCkpIHsNCiAgICAgICAgICAgIGNvbnN0IHJlbW90ZXMgPSBhd2FpdCBvcy5yZW1vdGVzKCk7DQogICAgICAgICAgICBzZW5kUmVtb3RlRGF0YShyZW1vdGVzLCByZW1vdGVEYXRhRXZlbnQsIHJlbW90ZURhdGFBcmcpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgdGhpc0JvdC5vblJlbW90ZURhdGEoeyBuYW1lOiByZW1vdGVEYXRhRXZlbnQsIHRoYXQ6IHJlbW90ZURhdGFBcmcsIHJlbW90ZUlkOiBjb25maWdCb3QuaWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9IGZpbmFsbHkgew0KICAgIGlmIChidXN5SW5kaWNhdG9yKSB7DQogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7DQogICAgICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsNCiAgICB9DQp9JwDe4/SZCwAFZGVidWcCBADe4/SZC9vIAQVmYWxzZScA3uP0mQsADmF1eFYyT3ZlcndyaXRlAgQA3uP0mQvhyAGRKkBjb25zdCBhdXggPSB0aGF0Py5hdXg7CmNvbnN0IGdyb3VwVGFnID0gdGhhdD8uZ3JvdXBUYWc7CmNvbnN0IGRyeVJ1biA9IHRoYXQ/LmRyeVJ1biA/PyBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmFzc2VydChhdXg/LnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXV4IHBhcmFtZXRlciBpcyByZXF1aXJlZCB0byBiZSBhIHYyIGF1eCBmaWxlLmApOwphc3NlcnQoZ3JvdXBUYWcgPT0gbnVsbCB8fCB0eXBlb2YgZ3JvdXBUYWcgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdyb3VwVGFnIHBhcmFtZXRlciBpZiBwcm92aWRlZCwgbXVzdCBiZSBhIHN0cmluZy5gKTsKCmNvbnN0IHN0YXRlID0gYXdhaXQgb3MuZ2V0SW5zdFN0YXRlRnJvbVVwZGF0ZXMoYXV4LnVwZGF0ZXMpOwoKLy8gU3VwZXIgaGFyZGNvZGVkIG1lc3N5IGZpeCBmb3IgY29tcHV0aW5nIGFiQ29uZmlnIHNvdXJjZSBoYXNoLgppZiAoZ3JvdXBUYWcgPT09ICdhYkNvbmZpZycpIHsgCiAgICBmb3IgKGxldCBpZCBpbiBzdGF0ZSkgewogICAgICAgIGRlbGV0ZSBzdGF0ZVtpZF0udGFncy5iYXNlQUI7IC8vIGJhc2VBQiBpcyBhbiBhbm5veWluZyB0YWcgdGhhdCBzaG91bGQgbm90IGJlIGNvbXB1dGVkIGFzIHBhcnQgb2YgaGFzaCBzdGF0ZS4KICAgIH0KfQoKbGV0IHNvdXJjZUhhc2ggPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBzdGF0ZSk7CmxldCBwcmV2R3JvdXBCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFnc1tncm91cFRhZ10gPT09IHRydWUpOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhdGU6YCwgc3RhdGUpOwogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwcmV2R3JvdXBCb3RzOmAsIHByZXZHcm91cEJvdHMpOwp9CgovLyBTdGVwIDE6IEFwcGx5IHVwZGF0ZXMgZGlyZWN0bHkgdG8gdGhlIGluc3QgYXMtaXMuCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFN0ZXAgMTogQXBwbHkgdXBkYXRlcyBkaXJlY3RseSB0byB0aGUgaW5zdCBhcy1pcy5gKTsKfQoKaWYgKCFkcnlSdW4pIHsKICAgIGF3YWl0IG9zLmFwcGx5VXBkYXRlc1RvSW5zdChhdXgudXBkYXRlcyk7Cn0gZWxzZSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGFwcGx5IHVwZGF0ZXMgdG8gaW5zdC5gKQp9CgovLyBTdGVwIDI6IERlbGV0ZSBwcmV2aW91cyBncm91cCBib3RzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBTdGVwIDI6IERlbGV0ZSBwcmV2aW91cyBncm91cCBib3RzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLmApOwp9Cgpmb3IgKGNvbnN0IHByZXZHcm91cEJvdCBvZiBwcmV2R3JvdXBCb3RzKSB7CiAgICBpZiAoc3RhdGVbcHJldkdyb3VwQm90LmlkXSA9PSBudWxsKSB7CiAgICAgICAgaWYgKGRyeVJ1bikgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGRlbGV0ZSBib3QgJHtwcmV2R3JvdXBCb3QuaWR9IHByZXZpb3VzbHkgYmVsb25naW5nIHRvIGdyb3VwICR7Z3JvdXBUYWd9YCk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIHByZXZpb3VzIGdyb3VwIGJvdCAke3ByZXZHcm91cEJvdC5pZH0gdGhhdCBpcyBubyBsb25nZXIgaW4gdGhlIHVwZGF0ZSBzdGF0ZS5gKTsKICAgICAgICB9CgogICAgICAgIGRlc3Ryb3kocHJldkdyb3VwQm90KTsKICAgIH0KfQoKLy8gU3RlcCAzOiBGb3IgZWFjaCBib3QgaW4gdGhlIHVwZGF0ZSBzdGF0ZSwgY3JlYXRlLCB1cGRhdGUsIGFuZCBkZWxldGUgdGFncyBvbiB0aGUgZXhpc3RpbmcgYm90cyBpbiB0aGUgaW5zdC4KaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU3RlcCAzOiBGb3IgZWFjaCBib3QgaW4gdGhlIHVwZGF0ZSBzdGF0ZSwgY3JlYXRlLCB1cGRhdGUsIGFuZCBkZWxldGUgdGFncyBvbiB0aGUgZXhpc3RpbmcgYm90cyBpbiB0aGUgaW5zdC5gKTsKfQoKZm9yIChjb25zdCBib3RJZCBpbiBzdGF0ZSkgewogICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgIGNvbnN0IGJvdFN0YXRlID0gc3RhdGVbYm90SWRdOwoKICAgIGlmIChib3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIGV4aXN0aW5nIGJvdCAke2JvdElkfWApOwogICAgICAgIH0KCiAgICAgICAgLy8gSGFuZGxlcyB0YWcgY3JlYXRlIC8gdXBkYXRlLgogICAgICAgIGZvciAoY29uc3Qgc3RhdGVUYWdOYW1lIGluIGJvdFN0YXRlLnRhZ3MpIHsKICAgICAgICAgICAgaWYgKGJvdC5yYXdbc3RhdGVUYWdOYW1lXSAhPSBib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV0pIHsKICAgICAgICAgICAgICAgIGlmIChkcnlSdW4pIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIHNldCB0YWcgJyR7c3RhdGVUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9IHRvIHZhbHVlOmAsIGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldCB0YWcgJyR7c3RhdGVUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9IHRvOmAsIGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm90LnRhZ3Nbc3RhdGVUYWdOYW1lXSA9IGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAoYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBmb3IgYm90ICR7Ym90SWR9IGlzIG51bGwsIGNsZWFyaW5nIGFueSB0YWcgbWFza3MgYXMgd2VsbC5gKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGFsbCBwb3NzaWJsZSBtYXNrcyBmb3IgdGhpcyB0YWcgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAnbG9jYWwnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAndGVtcExvY2FsJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIHN0YXRlVGFnTmFtZSwgbnVsbCwgJ3NoYXJlZCcpOwogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICd0ZW1wU2hhcmVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGFnICcke3N0YXRlVGFnTmFtZX0nIGZvciBib3QgJHtib3RJZH0gaXMgYWxyZWFkeSB1cC10by1kYXRlLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBEZWxldGUgdGFncyAoYW5kIG1hc2tzIGZvciB0aG9zZSB0YWdzKSBvbiBleGlzdGluZyBib3QgdGhhdCBhcmUgbm90IGluIHVwZGF0ZSBzdGF0ZS4KICAgICAgICBjb25zdCBib3RUYWdzID0gT2JqZWN0LmtleXMoYm90LnRhZ3MpOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdFRhZ05hbWUgb2YgYm90VGFncykgewogICAgICAgICAgICBpZiAoYm90U3RhdGUudGFnc1tib3RUYWdOYW1lXSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBkZWxldGUgdGFnICcke2JvdFRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0uYCk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlbGV0ZSB0YWcgKGFuZCBtYXNrcykgJyR7Ym90VGFnTmFtZX0nIG9uIGJvdCAke2JvdElkfS5gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBib3QudGFnc1tib3RUYWdOYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbGwgcG9zc2libGUgbWFza3MgZm9yIHRoaXMgdGFnIGFzIHdlbGwuCiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ2xvY2FsJyk7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ3RlbXBMb2NhbCcpOwogICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIGJvdFRhZ05hbWUsIG51bGwsICdzaGFyZWQnKTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAndGVtcFNoYXJlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgYm90ICR7Ym90SWR9IGluIGluc3QuYCk7CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRvbmUuYCk7Cn0KCmNvbnN0IGJvdElkcyA9IE9iamVjdC5rZXlzKHN0YXRlKTsKCnJldHVybiB7CiAgICBncm91cFRhZywKICAgIGJvdElkcywKICAgIHNvdXJjZUhhc2gsCn07JwDe4/SZCwAOYWJMb2FkZWRTa2lsbHMCBADe4/SZC/PyAbYBQGNvbnN0IGxvYWRlZFNraWxscyA9IG5ldyBTZXQoKTsKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJMb2FkZWRTa2lsbCAhPSBudWxsKSB7CiAgICAgICAgbG9hZGVkU2tpbGxzLmFkZChiLnRhZ3MuYWJMb2FkZWRTa2lsbCk7CiAgICB9Cn0pOwoKcmV0dXJuIEFycmF5LmZyb20obG9hZGVkU2tpbGxzKTsnAN7j9JkLAAxvblJlbW90ZURhdGECBADe4/SZC6r0AacFQGlmICh0aGF0Lm5hbWUgPT09ICd1cGRhdGVfYWJfcmVsb2FkX3BhZ2UnKSB7CiAgICBjb25zdCB7IHJlbG9hZFBhZ2UsIGRyeVJ1biB9ID0gdGhhdC50aGF0OwoKICAgIGlmICh0aGF0LnJlbW90ZUlkID09PSBjb25maWdCb3QuaWQpIHsKICAgICAgICAvLyBXYWl0IGEgbW9tZW50IGJlZm9yZSByZWxvYWRpbmcgdGhlIHBhZ2UgaWYgd2UgYXJlIHRoZSBvbmVzIHRoYXQgc2VudCBvdXQgdGhlIG1lc3NhZ2UuCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMTAwMCk7CiAgICB9CgogICAgbGV0IGlzVVJMID0gZmFsc2U7CgogICAgaWYgKHR5cGVvZiByZWxvYWRQYWdlID09PSAnc3RyaW5nJykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIG5ldyBVUkwocmVsb2FkUGFnZSk7CiAgICAgICAgICAgIGlzVVJMID0gdHJ1ZTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgfQoKICAgIGxldCB1cmwgPSBpc1VSTCA/IHJlbG9hZFBhZ2UgOiBjb25maWdCb3QudGFncy51cmw7CgogICAgaWYgKGRyeVJ1bikgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZ28gdG8gdXJsYCwgdXJsKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIG9zLmdvVG9VUkwoaXNVUkwgPyByZWxvYWRQYWdlIDogY29uZmlnQm90LnRhZ3MudXJsKTsKfScA3uP0mQsACW9uRW50ZXJBUgIEAN7j9JkL0vkBE0BtYXNrcy5pbkFSID0gdHJ1ZTsnAN7j9JkLAAhvbkV4aXRBUgIEAN7j9JkL5vkBE0BtYXNrcy5pbkFSID0gbnVsbDsnAN7j9JkLAAlvbkVudGVyVlICBADe4/SZC/r5ARNAbWFza3MuaW5WUiA9IHRydWU7JwDe4/SZCwAIb25FeGl0VlICBADe4/SZC476ARNAbWFza3MuaW5WUiA9IG51bGw7JwDe4/SZCwAEZ3JpZAIEAN7j9JkLovoBKPCflJcwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EnAN7j9JkLABVhYkNyZWF0ZVVwZGF0ZUNoZWNrZXICBADe4/SZC8n6Ab4TQGxldCBhYlVwZGF0ZUNoZWNrZXIgPSBnZXRCb3QoJ2FiVXBkYXRlQ2hlY2tlcicsIHRydWUpOwoKaWYgKGFiVXBkYXRlQ2hlY2tlcikgewogICAgZ2xvYmFsVGhpcy5hYlVwZGF0ZUNoZWNrZXIgPSBhYlVwZGF0ZUNoZWNrZXI7CiAgICByZXR1cm4gYWJVcGRhdGVDaGVja2VyOwp9CgpsZXQgbW9kID0gewogICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgYWJVcGRhdGVDaGVja2VyOiB0cnVlLAogICAgYWJJZ25vcmU6IHRydWUsCiAgICBjaGVja2luZzogZmFsc2UsCiAgICB1cGRhdGVBdmFpbGFibGU6IGZhbHNlLAogICAgZGVidWc6IHRydWUsCiAgICBvbkNyZWF0ZTogYEAKICAgICAgICB0aGlzQm90LnN0YXJ0SW50ZXJ2YWwoKTsKICAgICAgICB0aGlzQm90Lm9uVXBkYXRlQ2hlY2soKTsKICAgIGAsCiAgICBzdGFydEludGVydmFsOiBgQAogICAgICAgIGlmICghdGFncy5pbnRlcnZhbCkgewogICAgICAgICAgICBjb25zdCBVUERBVEVfQ0hFQ0tfSU5URVJWQUxfTUlOVVRFUyA9IDAuMTsKICAgICAgICAgICAgY29uc3QgaW50ZXJ2YWxNUyA9IFVQREFURV9DSEVDS19JTlRFUlZBTF9NSU5VVEVTICogNjAgKiAxMDAwOwogICAgICAgICAgICB0YWdzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5vblVwZGF0ZUNoZWNrKCksIGludGVydmFsTVMpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSBzdGFydCB1cGRhdGUgY2hlY2sgaW50ZXJ2YWwgbXM6JywgaW50ZXJ2YWxNUyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICBgLAogICAgc3RvcEludGVydmFsOiBgQAogICAgICAgIGlmICh0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGFncy5pbnRlcnZhbCk7CiAgICAgICAgICAgIHRhZ3MuaW50ZXJ2YWwgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSBzdG9wIHVwZGF0ZSBjaGVjayBpbnRlcnZhbC4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIGAsCiAgICBmb3JjZVVwZGF0ZUNoZWNrOiBgQAogICAgICAgIHRoaXNCb3Quc3RvcEludGVydmFsKCk7CiAgICAgICAgdGhpc0JvdC5zdGFydEludGVydmFsKCk7CiAgICAgICAgdGhpc0JvdC5vblVwZGF0ZUNoZWNrKHsgZm9yY2U6IHRydWUgfSk7CiAgICBgLAogICAgb25VcGRhdGVDaGVjazogYEAKICAgICAgICBjb25zdCBmb3JjZSA9IHRoYXQ/LmZvcmNlID8/IGZhbHNlOwoKICAgICAgICBpZiAoIXRhZ3MuY2hlY2tpbmcpIHsKICAgICAgICAgICAgaWYgKCF0YWdzLnVwZGF0ZUF2YWlsYWJsZSB8fCBmb3JjZSkgewogICAgICAgICAgICAgICAgdGFncy5jaGVja2luZyA9IHRydWU7CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhYi5hYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1thYlVwZGF0ZUNoZWNrZXJdIHVwZGF0ZSBjaGVjayByZXN1bHQ6JywgcmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdzLnVwZGF0ZUF2YWlsYWJsZSA9IHJlc3VsdC51cGRhdGVBdmFpbGFibGU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnVwZGF0ZUF2YWlsYWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdXQoJ29uQUJVcGRhdGVBdmFpbGFibGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgdGFncy5jaGVja2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gc2tpcCB1cGRhdGUgY2hlY2sg4oCUIHVwZGF0ZSBpcyBhbHJlYWR5IGtub3duIHRvIGJlIGF2YWlsYWJsZS4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gdXBkYXRlIGNoZWNrIGFscmVhZHkgaW4gcHJvZ3Jlc3MuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgYCwKfQoKYWJVcGRhdGVDaGVja2VyID0gY3JlYXRlKG1vZCk7Cmdsb2JhbFRoaXMuYWJVcGRhdGVDaGVja2VyID0gYWJVcGRhdGVDaGVja2VyCgpyZXR1cm4gYWJVcGRhdGVDaGVja2VyOwA="}]}