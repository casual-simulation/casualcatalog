{"version":2,"updates":[{"id":0,"timestamp":1771718067153,"update":"AXql0sy1DAAnAQRib3RzJDY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNwEnAKXSzLUMABhhYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUCBACl0sy1DAGVLEBjb25zdCBkZXRhaWxlZCA9IHRoYXQ/LmRldGFpbGVkID8/IGZhbHNlOwpjb25zdCBoYXNoQWxnb3JpdGhtID0gdGhhdD8uaGFzaEFsZ29yaXRobSA/PyAnc2hhMSc7CmNvbnN0IGhhc2hGb3JtYXQgPSB0aGF0Py5oYXNoRm9ybWF0ID8/ICdoZXgnOwoKaW50ZXJmYWNlIEFCRmlsZVVwZGF0ZUNoZWNrIHsKICAgIGZpbGVOYW1lOiBzdHJpbmc7CiAgICB1cGRhdGVBdmFpbGFibGU6IGJvb2xlYW47CiAgICBjdXJyZW50SGFzaDogc3RyaW5nOwogICAgbGF0ZXN0SGFzaDogc3RyaW5nOwogICAgcmVtb3ZlZDogYm9vbGVhbjsKfQoKLy8gVGhpcyBsaXN0IG9mIGFiIGZpbGUgY2hlY2tzLCB0aGlzIHdpbGwgb25seSBiZSBwb3B1bGF0ZWQgaWYgJ2RldGFpbGVkJyBpcyB0cnVlLgpjb25zdCBhYkZpbGVDaGVja3M6IEFCRmlsZVVwZGF0ZUNoZWNrW10gPSBbXTsKCmFzeW5jIGZ1bmN0aW9uIGNoZWNrU2tpbGxPdXRkYXRlZChza2lsbE5hbWU6IHN0cmluZywgY3VycmVudEhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gewogICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOyAgICAgICAgCiAgICBsZXQgc2tpbGxSZW1vdmVkID0gZmFsc2U7CiAgICBsZXQgc2tpbGxSZXNwb25zZTsKCiAgICB0cnkgewogICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbFJlc3BvbnNlOmAsIHNraWxsUmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhc3NlcnQoc2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHtza2lsbE5hbWV9IG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7c2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7CgogICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBlcnJvciB3aGlsZSBkb3dubG9hZGluZyBza2lsbDpgLCBlKTsKICAgICAgICAKICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgLy8gRmlsZSBkb2VzbnQgZXhpc3QgYW55bW9yZSwgdGhlIHNraWxsIGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHNraWxsUmVtb3ZlZCkgewogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoOiBudWxsLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSwKICAgICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBDYWxjdWxhdGUgaGFzaCBvZiBhYiBmaWxlIHN0YXRlIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHNraWxsUmVzcG9uc2UuZGF0YS51cGRhdGVzKTsKICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgc3RhdGUpOwogICAgICAgIAogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgbGF0ZXN0VXBkYXRlczogc2tpbGxSZXNwb25zZS5kYXRhLnVwZGF0ZXMsCiAgICAgICAgICAgICAgICBsYXRlc3RTdGF0ZTogc3RhdGUsCiAgICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2g7CiAgICB9Cn0KCi8vIDEuIENoZWNrIGlmIGFiQ29uZmlnIGlzIG91dGRhdGVkLgpjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOwpjb25zdCBhYkNvbmZpZ1Jlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb25maWdVUkwgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZ1Jlc3BvbnNlOmAsIGFiQ29uZmlnUmVzcG9uc2UpOwp9Cgphc3NlcnQoYWJDb25maWdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke2FiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7Cgpjb25zdCBhYkNvbmZpZ0N1cnJlbnRIYXNoID0gYWIubGlua3MucmVtZW1iZXIudGFncy5hYkNvbmZpZ1NvdXJjZUhhc2g7CmNvbnN0IGFiQ29uZmlnTGF0ZXN0U3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcyk7CmZvciAobGV0IGlkIGluIGFiQ29uZmlnTGF0ZXN0U3RhdGUpIHsKICAgIGRlbGV0ZSBhYkNvbmZpZ0xhdGVzdFN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgp9CmNvbnN0IGFiQ29uZmlnTGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiQ29uZmlnTGF0ZXN0U3RhdGUpOwoKaWYgKGRldGFpbGVkKSB7CiAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgZmlsZU5hbWU6ICdhYkNvbmZpZycsCiAgICAgICAgY3VycmVudEhhc2g6IGFiQ29uZmlnQ3VycmVudEhhc2gsCiAgICAgICAgbGF0ZXN0SGFzaDogYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIHJlbW92ZWQ6IGZhbHNlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIGxhdGVzdFVwZGF0ZXM6IGFiQ29uZmlnUmVzcG9uc2UuZGF0YS51cGRhdGVzLAogICAgICAgIGxhdGVzdFN0YXRlOiBhYkNvbmZpZ0xhdGVzdFN0YXRlLAogICAgfSkKfQoKaWYgKCFkZXRhaWxlZCAmJiAoYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoKSkgewogICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgaW4gc2ltcGxlIG1vZGUsIHJldHVybiByaWdodCBhd2F5IG9uIHRoZSBmaXJzdCBvdXRkYXRlZCBmaWxlIGRpc2NvdmVyeS4KICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSB9Cn0KCi8vIDIuIENoZWNrIGlmIGFiIHNraWxscyBhcmUgb3V0ZGF0ZWQuCmNvbnN0IGFiU2tpbGxOYW1lcyA9IFsgJ2FiQ29yZScsIC4uLnRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKSBdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhYlNraWxsTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHNraWxsTmFtZSA9IGFiU2tpbGxOYW1lc1tpXTsKCiAgICBsZXQgc2tpbGxDdXJyZW50SGFzaDsKICAgIGlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICAgICAgc2tpbGxDdXJyZW50SGFzaCA9IGFiLnRhZ3MuYWJDb3JlU291cmNlSGFzaDsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbG9hZGVkU2tpbGxCb3QgPSBnZXRCb3QoYiA9PiBiLnRhZ3MuYWJMb2FkZWRTa2lsbCA9PT0gc2tpbGxOYW1lICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsKICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOwoKICAgICAgICBza2lsbEN1cnJlbnRIYXNoID0gbG9hZGVkU2tpbGxCb3QudGFncy5hYkxvYWRlZFNraWxsU291cmNlSGFzaDsKICAgIH0KICAgIAogICAgdHJ5IHsKICAgICAgICBjb25zdCBza2lsbE91dGRhdGVkID0gYXdhaXQgY2hlY2tTa2lsbE91dGRhdGVkKHNraWxsTmFtZSwgc2tpbGxDdXJyZW50SGFzaCk7CgogICAgICAgIGlmICghZGV0YWlsZWQgJiYgc2tpbGxPdXRkYXRlZCkgewogICAgICAgICAgICAvLyBJZiB3ZSBhcmUgcnVubmluZyBpbiBzaW1wbGUgbW9kZSwgcmV0dXJuIHJpZ2h0IGF3YXkgb24gdGhlIGZpcnN0IG91dGRhdGVkIGZpbGUgZGlzY292ZXJ5LgogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB1cGRhdGVBdmFpbGFibGU6IHRydWUgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2ggYW4gZXJyb3IuYCwgZSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9CgppZiAoZGV0YWlsZWQpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGFiRmlsZUNoZWNrcy5zb21lKGYgPT4gZi51cGRhdGVBdmFpbGFibGUpLAogICAgICAgIGFiRmlsZUNoZWNrcywKICAgIH0KfSBlbHNlIHsKICAgIC8vIElmIHdlIG1hZGUgaXQgYWxsIHRoZSB3YXkgaGVyZSBpbiBzaW1wbGUgbW9kZSwgdGhlcmUgYXJlIG5vIG91dGRhdGVkIGZpbGVzLgogICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdXBkYXRlQXZhaWxhYmxlOiBmYWxzZSB9Cn0nAKXSzLUMAARncmlkAgQApdLMtQyXLCjwn5SXMDI4MzY1YTQtMDM2Zi00MWQwLTlhZjEtNzE1YWQ0ZjJhYTdhJwCl0sy1DAASYWJDb3JlTWFqb3JWZXJzaW9uAgQApdLMtQy+LAIxMCcApdLMtQwAEmFiQ29yZU1pbm9yVmVyc2lvbgIEAKXSzLUMwSwCNDInAKXSzLUMAAZzeXN0ZW0CBACl0sy1DMQsDWFiLmNvcmUubGVhcm4nAKXSzLUMAARhYklEAgQApdLMtQzSLAVsZWFybicApdLMtQwABGZvcm0CBACl0sy1DNgsB25vdGhpbmcnAKXSzLUMAAZhYkJvb3QCBACl0sy1DOAs0ypALyoqCiogTUlUIExpY2Vuc2UKKgoqIENvcHlyaWdodCAoYykgMjAxOSBDYXN1YWwgU2ltdWxhdGlvbiwgSW5jLgoqCiogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQoqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwoqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoqCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKgoqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgoqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKKiBTT0ZUV0FSRS4KKiBAbGljZW5zZSBNSVQKKi8KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvb3RpbmcgYWJgKTsKfQoKLy9pbnN0IG1vZGUgKHBsYXllciBvciBidWlsZGVyKQpsZXQgaW5zdE1vZGVDaGVjayA9IGF3YWl0IG9zLnZlcnNpb24oKS5wbGF5ZXJNb2RlOwovL2NoZWNrIHNlbGYgZm9yIGluaXRpYWwgYm9vdCBkYXRhCmxldCBpbml0aWFsQm9vdCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuaW5pdGlhbEJvb3QgPyB0cnVlIDogZmFsc2U7Ci8vY2hlY2sgdXJsIGZvciBwb3NzaWJsZSBhYidzIHRvIGxvYWQKbGV0IGJvb3RGbGFnID0gY29uZmlnQm90LnRhZ3MucGF0dGVybiA/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gOiBjb25maWdCb3QudGFncy5hYjsKLy9jaGVjayBmb3IgYXNrCmxldCBhc2sgPSBjb25maWdCb3QudGFncy5hc2s7Ci8vbG9naW4KbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXNCb3QubG9hZGluZ1N0YXR1cygpOwovL3NlZWQgKG5vdCBhY3RpdmVseSB1c2VkIGhlcmUpCmxldCBzZWVkID0gY29uZmlnQm90LnRhZ3Muc2VlZDsKLy9wcm9tcHQKbGV0IHByb21wdCA9IGNvbmZpZ0JvdC50YWdzLnByb21wdDsKLy9jaGFubmVsCmxldCBjaGFubmVsID0gY29uZmlnQm90LnRhZ3MuY2hhbm5lbDsKLy91dWFiCmxldCB1dWFiID0gY29uZmlnQm90LnRhZ3MuYXV4bGluayA9PSAidXVhYiI7Ci8vdmVyc2lvbgpsZXQgdmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbjsKLy9yZXF1ZXN0IGF1dGggYm90CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgovL3JlZGlyZWN0IGlmIGluIFVSTAppZiAoY29uZmlnQm90LnRhZ3Muam9pbkNvZGUpIHsKICAgIHRoaXNCb3QuYWJKb2luSG9zdCh7IHRleHQ6IGNvbmZpZ0JvdC50YWdzLmpvaW5Db2RlIH0pOwp9CgovL3N0YXR1cyBjbGVhbiB1cApkZXN0cm95KHN0YXR1cyk7CgovL2NoZWNrIHRpbWUgaWYgbmVlZGVkCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29uZGl0aW9uKSB7CiAgICBhd2FpdCBsaW5rcy5yZW1lbWJlci5hYkNvbmRpdGlvbigpOwp9CgovL2lmIG5vIHN0dWRpbywgc2V0IHN0dWRpbwppZiAoYXV0aEJvdCAmJiAhY29uZmlnQm90LnRhZ3Muc3R1ZGlvKSB7CiAgICBjb25maWdCb3QudGFncy5zdHVkaW8gPSBhdXRoQm90LmlkOwp9Cgp0aGlzQm90LmFiUmVmcmVzaFN0dWRpb3MoKTsKdGhpc0JvdC5hYlJlZnJlc2hBSU1vZGVscygpOwoKaWYgKCFsaW5rcy5wZXJzb25hbGl0eSkgeyAKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJQZXJzb25hbGl0eSIpOwp9CgovL2luaXRpYWxpemUgc29tZSBhYiBnbG9iYWxzLgpnbG9iYWxUaGlzLmFiID0gdGhpc0JvdDsKZ2xvYmFsVGhpcy5hYkluc3RNZW1vcnkgPSBsaW5rcy5yZW1lbWJlcjsKZ2xvYmFsVGhpcy5hYlJlbWVtYmVyID0gbGlua3MucmVtZW1iZXI7Cmdsb2JhbFRoaXMuYWJQZXJzb25hbGl0eSA9IGxpbmtzLnBlcnNvbmFsaXR5OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yKSB7CiAgICBncmlkUG9ydGFsQm90LnRhZ3MucG9ydGFsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUdyaWRQb3J0YWxDb2xvcjsKfQoKLy9UaGlzIGNoZWNrcyBmb3IgdGhlIGFwcHJvcHJpYXRlIGFycmF5IG9mIHNraWxscyBhbmQgaW5pdGlhbGl6ZXMgdGhlbQphd2FpdCB0aGlzQm90LmFiU2tpbGxJbml0aWFsaXphdGlvbihpbnN0TW9kZUNoZWNrKTsKCi8vIGluaXRpYWxpemluZyBvZiBzb21lIGNvbW1vbiBza2lsbCBnbG9iYWxzLgpnbG9iYWxUaGlzLmJ1aWxkZXJWZXJzaW9uID0gaW5zdE1vZGVDaGVjayA9PSAiYnVpbGRlciIgPyB0cnVlIDogZmFsc2U7Cmdsb2JhbFRoaXMuYWJMb25nVGVybU1lbW9yeVNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlB1Ymxpc2ggPSBsaW5rcy5zdG9yZTsKZ2xvYmFsVGhpcy5hYlN0b3JlID0gbGlua3Muc3RvcmU7CgovL2NoZWNrIGZvciB1dWFicwppZiAodXVhYikgewogICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCJhYkFjdGlvbiIpOwoKICAgIGxpbmtzLmFzay5hYkNvcmVNZW51QWN0aW9uKHttZXNzYWdlOiBjb25maWdCb3QudGFncy51dWFiLCBpc1VVQUI6IHRydWV9KTsKfQovL2NoZWNrIGZvciBjaGFubmVsIGlmIGNoYW5uZWxzIGFsbG93ZWQKZWxzZSBpZiAoY2hhbm5lbCAmJiBsaW5rcy5yZW1lbWJlci50YWdzLmFsbG93Q2hhbm5lbHMpIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbih7bWVzc2FnZTogY2hhbm5lbCwgaXNDaGFubmVsOiB0cnVlfSk7Cn0gZWxzZSB7CiAgICAvL3BvcHVsYXRlIGJvb3RmbGFnIGFiCiAgICBpZiAoaW5pdGlhbEJvb3QgJiYgYm9vdEZsYWcpIHsKICAgICAgICBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoeyBhYklEOiBib290RmxhZywgaW5pdGlhbEJvb3Q6IHRydWUsIGF1dG9IYXRjaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdib290JywgYWJWZXJzaW9uOiB2ZXJzaW9ufSk7CiAgICB9CgogICAgLy9sb29rdXAgYXNrSUQgaWYgYXZhaWxhYmxlCiAgICBpZiAoaW5pdGlhbEJvb3QgJiYgYXNrKSB7CiAgICAgICAgaWYgKGFzayA9PSAiZWdnQ2FydG9uIiB8fCBhc2sgPT0gImNhc3VhbFR1dG9yaWFsIikgewogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoYXNrKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICAgICAgICAgIGxpbmtzLmFzay5hYkNvcmVNZW51QWN0aW9uKGFzayk7CiAgICAgICAgfQogICAgfQp9CgovL2NoZWNrIGZvciBhcnRpZmFjdCBGSVgKaWYgKGNvbmZpZ0JvdC50YWdzLmFydGlmYWN0ICYmIGluaXRpYWxCb290ICYmICFhc2sgJiYgIWJvb3RGbGFnKSB7CiAgICBjb25zdCBhcnRpZmFjdCA9IGNvbmZpZ0JvdC50YWdzLmFydGlmYWN0OwogICAgY29uc3QgYXJ0SW5kZXggPSBhcnRpZmFjdC5pbmRleE9mKCJfYXJ0XyIpOwogICAgY29uc3Qgc3R1ZGlvID0gYXJ0aWZhY3Quc3Vic3RyaW5nKDAsIGFydEluZGV4KTsKICAgIGNvbnN0IHJlY29yZEFkZHJlc3MgPSBhcnRpZmFjdC5zdWJzdHJpbmcoYXJ0SW5kZXgpOwogICAgY29uc3QgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLmdldERhdGEoc3R1ZGlvLCByZWNvcmRBZGRyZXNzKTsKICAgIGNvbnN0IGFza0lEID0gcmVjb3JkRGF0YS5kYXRhLnBhdHRlcm47CgogICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KCJhYkFjdGlvbiIpOwoKICAgIGxpbmtzLmFzay5hYkNvcmVNZW51QWN0aW9uKGFza0lEKTsKfQoKLy8gQ2hlY2sgaWYgd2UgY2FuIHdha2UgdXAgYWIsIGFuZCB0aGVuIGRvIHNvLgppZiAoIWNvbmZpZ0JvdC50YWdzLmFiU2xlZXApIHsKICAgIGlmICgoaW5pdGlhbEJvb3QgJiYgIWJvb3RGbGFnICYmICFhc2spIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBbHdheXNTdGFydEF3YWtlIHx8IGNvbmZpZ0JvdC50YWdzLmFiU3RheUF3YWtlKSB7CiAgICAgICAgYXdhaXQgbGlua3MubWFuaWZlc3RhdGlvbi5hYlNldEF3YWtlKHsgYXdha2U6IHRydWUsIGluaXRpYWw6IGluaXRpYWxCb290IH0pOwogICAgfQp9CgovL3NldCBpbml0aWFsIGJvb3QgZGF0YQppZiAoaW5pdGlhbEJvb3QpIHsKICAgIHNldFRhZ01hc2sobGlua3MucmVtZW1iZXIsICdpbml0aWFsQm9vdCcsIGZhbHNlLCAnc2hhcmVkJyk7CgogICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsaXphdGlvbkNvbmZpZ3VyYXRpb24pIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5hYkluaXRpYWxpemF0aW9uQ29uZmlndXJhdGlvbigpOwogICAgfQp9CgovL2NsZWFuIHVwIFVSTCB3aXRoIHRhZ1BvcnRhbAppZiAoY29uZmlnQm90LnRhZ3MudGFnUG9ydGFsICYmICFjb25maWdCb3QudGFncy50YWdQb3J0YWxBbmNob3JQb2ludCAmJiBidWlsZGVyVmVyc2lvbikgewogICAgY29uZmlnQm90LnRhZ3MudGFnUG9ydGFsID0gbnVsbDsKICAgIGNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbFNwYWNlID0gbnVsbDsKfQoKLy9wYXVzZSBmb3IgYWIgbG9hZGluZwphd2FpdCBvcy5zbGVlcCg1MDApOwoKLy9pbml0aWFsaXplIHRpbWUgYm90CnRoaXNCb3QuYWJUaW1lcigpOwoKdGhpc0JvdC5hYkNyZWF0ZVVwZGF0ZUNoZWNrZXIoKTsKCi8vaW5pdGlhbGl6YXRpb24gc2hvdXQKc3VwZXJTaG91dCgib25BQkluaXRpYWxpemVkIiwgdGFncy5hYkluc3QpOycApdLMtQwAEG9uQUJBdXRoQm90QWRkZWQCBACl0sy1DLRXOUB0aGlzQm90LmFiUmVmcmVzaFN0dWRpb3MoKTsKdGhpc0JvdC5hYlJlZnJlc2hBSU1vZGVscygpOycApdLMtQwAEm9uQUJBdXRoQm90UmVtb3ZlZAIEAKXSzLUM7lc5QHRoaXNCb3QuYWJSZWZyZXNoU3R1ZGlvcygpOwp0aGlzQm90LmFiUmVmcmVzaEFJTW9kZWxzKCk7JwCl0sy1DAAQYWJSZWZyZXNoU3R1ZGlvcwIEAKXSzLUMqFilAUBpZiAoYXV0aEJvdCkgewogICAgY29uc3QgdXNlclN0dWRpb3MgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsKICAgIGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvcyA9IHVzZXJTdHVkaW9zOwp9IGVsc2UgewogICAgY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zID0gbnVsbDsKfScApdLMtQwAEWFiUmVmcmVzaEFJTW9kZWxzAgQApdLMtQzOWZoBQGlmIChhdXRoQm90KSB7CiAgICBjb25zdCBtb2RlbHMgPSBhd2FpdCBhaS5saXN0Q2hhdE1vZGVscygpOwogICAgY29uZmlnQm90LnRhZ3MuYWlDaGF0TW9kZWxzID0gbW9kZWxzOwp9IGVsc2UgewogICAgY29uZmlnQm90LnRhZ3MuYWlDaGF0TW9kZWxzID0gbnVsbDsKfSgApdLMtQwABmFiQ29yZQF4JwCl0sy1DAAHYWJBZGFwdAIEAKXSzLUM6lq+FEBsZXQgc2tpbGxOYW1lOwpsZXQgc2tpbGxEYXRhOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgc2tpbGxOYW1lID0gdGhhdDsKICAgIHNraWxsRGF0YSA9IG51bGw7Cn0gZWxzZSBpZiAodHlwZW9mIHRoYXQgPT09ICdvYmplY3QnKSB7CiAgICBza2lsbE5hbWUgPSB0aGF0LnN5c3RlbUlEID8/IHRoYXQuc2tpbGxOYW1lOwogICAgc2tpbGxEYXRhID0gdGhhdC5kYXRhID8/IG51bGw7Cn0KCmlmICghc2tpbGxOYW1lKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpbGxOYW1lIGlzIHJlcXVpcmVkLmApOwogICAgcmV0dXJuIGZhbHNlOwp9CgppZiAoc2tpbGxOYW1lID09PSAnYWJDb3JlJykgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX19XSBhYkNvbmZpZyBjYW5ub3QgYmUgbG9hZGVkIHVzaW5nIGFiQWRhcHQuYCk7CiAgICByZXR1cm47Cn0KCnRyeSB7CiAgICBjb25zdCBsb2FkZWRTa2lsbHMgPSB0aGlzQm90LmFiTG9hZGVkU2tpbGxzKCk7CgogICAgaWYgKCFsb2FkZWRTa2lsbHMuaW5jbHVkZXMoc2tpbGxOYW1lKSkgewogICAgICAgIGNvbnN0IHVybCA9IHRoaXNCb3QuYWJCdWlsZENhc3VhbENhdGFsb2dVUkwoYC9hYi8ke3NraWxsTmFtZX0uYXV4YCk7CiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYiBza2lsbCBHRVQgcmVzcG9uc2U6YCwgcmVzcG9uc2UpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkICR7c2tpbGxOYW1lfS4gUmVzcG9uc2U6ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIAogICAgICAgIGlmIChyZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIpIHsKICAgICAgICAgICAgLy8gQVVYIEZvcm1hdCBWZXJzaW9uIDIuCiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZXMgPSByZXNwb25zZS5kYXRhLnVwZGF0ZXM7CiAgICAgICAgICAgIGF3YWl0IG9zLmFwcGx5VXBkYXRlc1RvSW5zdCh1cGRhdGVzKTsKICAgICAgICAgICAgY29uc3Qgc3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyh1cGRhdGVzKTsKICAgICAgICAgICAgY29uc3Qgc291cmNlSGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIHN0YXRlKTsKCiAgICAgICAgICAgIC8vIExvYWRlZCBza2lsbHMgYXJlIHN0b3JlZCBhcyBzaGFyZWQgYm90cyB0aGF0IGFueW9uZSBpbiB0aGUgaW5zdCBjYW4gcmVhZC4KICAgICAgICAgICAgY3JlYXRlKHsKICAgICAgICAgICAgICAgIHNwYWNlOiAnc2hhcmVkJywKICAgICAgICAgICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgICAgICAgICAgYWJMb2FkZWRTa2lsbDogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgYWJMb2FkZWRTa2lsbFNvdXJjZUhhc2g6IHNvdXJjZUhhc2gsCiAgICAgICAgICAgICAgICBmb3JtOiAnbm90aGluZycsCiAgICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEFVWCBmb3JtYXQgdmVyc2lvbiAke3Jlc3BvbnNlLmRhdGEudmVyc2lvbn0gaXMgbm90IHN1cHBvcnRlZC5gKTsKICAgICAgICB9CgogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIHNraWxsICR7c2tpbGxOYW1lfSBpcyBhbHJlYWR5IGxvYWRlZC5gKQogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBza2lsbEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzW3NraWxsTmFtZV0gPT09IHRydWUpOwogICAgaWYgKHNraWxsQm90cyAmJiBza2lsbEJvdHMubGVuZ3RoID4gMCkgewogICAgICAgIHdoaXNwZXIoc2tpbGxCb3RzLCB0YWdOYW1lLCBjb25maWdCb3QudGFncy5pbnN0KTsKICAgICAgICB3aGlzcGVyKHNraWxsQm90cywgIm9uU2tpbGxVcGRhdGUiLCB7IGRhdGE6IHNraWxsRGF0YSB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIE5vIGJvdHMgYXBwZWFyIHRvIGhhdmUgYmVlbiBsb2FkZWQgd2l0aCAke3NraWxsTmFtZX0uYCk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwp9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEZhaWxlZCB0byBkb3dubG9hZCAke3NraWxsTmFtZX0uIFNlZSBhYm92ZSBlcnJvci5gKTsKICAgIHJldHVybiBmYWxzZTsKfScApdLMtQwAC2Rlc2NyaXB0aW9uAgQApdLMtQypb09UaGlzIHNraWxsIGlzIGRlc2lnbmVkIHRvIGhhbmRsZSBib3RoIHJlY29uZmlndXJhdGlvbiBvZiBhYiBhbmQgaW5pdGlhbGl6YXRpb24uJwCl0sy1DAAKb25Cb3RBZGRlZAIEAKXSzLUM+W/xAUBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29yZSBTVEFSVCBVUGApOwoKdGhpc0JvdC5hYkluc3RVcGRhdGUoKTsKCmlmICghbGlua3MucmVtZW1iZXIpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZmluZCBhYkNvbmZpZyByZW1lbWJlciBib3QuYCk7Cn0KCnNldFRpbWVvdXQoKCkgPT4gdGhpc0JvdC5hYkJvb3QoKSwgNTAwKTsnAKXSzLUMAAhyZW1lbWJlcgIEAKXSzLUM63Eo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycApdLMtQwAA2xvZwIEAKXSzLUMknJsQC8vcGFzcyB0aHJvdWdoIGxvZyBkYXRhCmlmIChsaW5rcy5jb25zb2xlKSB7CiAgICBsaW5rcy5jb25zb2xlLmxvZyh0aGF0KTsKfQplbHNlIHsKICAgIGNvbnNvbGUubG9nKHRoYXQpOwp9JwCl0sy1DAANbWFuaWZlc3RhdGlvbgIEAKXSzLUM/3Io8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcApdLMtQwADGFiQ3JlYXRlSG9zdAIEAKXSzLUMpnPUDUBjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKCi8vdGhpcyBmdW5jdGlvbiBoYW5kbGVzIGNyZWF0aW5nIGEgZmlsZSBmb3Igam9pbiBjb2RlcwppZiAobGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpIHsKICAgIGNvbnN0IGpvaW5VUkwgPSBzaXRlT3JpZ2luICsgIi8/am9pbkNvZGU9IiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEOwogICAgb3Muc2V0Q2xpcGJvYXJkKGpvaW5VUkwpOwogICAgb3Muc2hvd1FSQ29kZShqb2luVVJMKTsKICAgIGFiLmxpbmtzLnV0aWxzLmFiVG9hc3QoYHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkYCk7CiAgICByZXR1cm47Cn0KCmlmICghYXV0aEJvdCkgewogICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKfQoKaWYgKCFhdXRoQm90KSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBwbGVhc2UgbG9nIGluIHRvIGdlbmVyYXRlIGEgam9pbiBjb2RlYCk7CiAgICByZXR1cm47Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlSm9pbkNvZGUoKSB7CiAgICBjb25zdCBjaGFycyA9ICdBQkNERUZHSElKS0xNTk9QUVJTVFVWV1hZWjEyMzQ1Njc4OSc7CiAgICBsZXQgY29kZSA9ICcnOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHsKICAgICAgICBjb25zdCByYW5kb21JbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGNoYXJzLmxlbmd0aCk7CiAgICAgICAgY29kZSArPSBjaGFyc1tyYW5kb21JbmRleF07CiAgICB9CiAgICByZXR1cm4gY29kZTsKfQoKY29uc3QgbmV3Sm9pbkNvZGUgPSBnZW5lcmF0ZUpvaW5Db2RlKCk7CmNvbnN0IGRhdGUgPSBvcy5pc0NvbGxhYm9yYXRpdmUoKSA/IG9zLmFncmVlZFVwb25UaW1lIDogb3MubG9jYWxUaW1lOwpjb25zdCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKLy8gW1J5YW4gQ29va106IFRoaXMgaXMgYSBuYWl2ZSByb29tIGNvZGUgZ2VuZXJhdG9yLiBJdCBkb2VzIG5vdCBjaGVjayBpZiB0aGUgcm9vbSBjb2RlIGlzIGFscmVhZHkgdGFrZW4gLyBhY3RpdmUuCmNvbnN0IHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHJlY29yZEtleSwgYGFiSm9pbkNvZGVfJHtuZXdKb2luQ29kZX1gLCB7IHVybDogY29uZmlnQm90LnRhZ3MudXJsLCBkYXRlIH0sIHsgbWFya2VyczogWyJwdWJsaWNSZWFkIl0gfSk7CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKSB7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnJlbWVtYmVyLCAnaG9zdElEJywgbmV3Sm9pbkNvZGUsICdzaGFyZWQnKTsKCiAgICBjb25zdCBqb2luVVJMID0gc2l0ZU9yaWdpbiArICIvP2pvaW5Db2RlPSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRDsKCiAgICBvcy5zZXRDbGlwYm9hcmQoam9pblVSTCk7CgogICAgaWYgKHRoYXQgJiYgdGhhdC50YWdzKSB7CiAgICAgICAgdGhhdC50YWdzLmxhYmVsID0gImpvaW4gY29kZTogIiArIG5ld0pvaW5Db2RlOwogICAgCiAgICB9CiAgICBvcy5zaG93UVJDb2RlKGpvaW5VUkwpOwoKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYGpvaW4gY29kZSBnZW5lcmF0ZWQ6ICR7bmV3Sm9pbkNvZGV9LiB1cmwgY29waWVkIHRvIGNsaXBib2FyZC5gKTsKfQplbHNlIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYGZhaWxlZCB0byBnZW5lcmF0ZSBqb2luIGNvZGUsIHBsZWFzZSB0cnkgYWdhaW4uYCk7CiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwp9JwCl0sy1DAAKYWJKb2luSG9zdAIEAKXSzLUM+4ABrApALy9sb2dpYyBmb3IgdXNpbmcgYSBqb2luIGNvZGUgKGNoZWNrcyBmb3IgZXhpc3RpbmcgZmlsZXMpCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgpsZXQgZ2V0UmVjb3JkOwoKaWYgKHRoYXQuZGF0YSkgewogICAgZ2V0UmVjb3JkID0geyBzdWNjZXNzOiB0cnVlLCBkYXRhOiB0aGF0LmRhdGEgfTsKfSBlbHNlIHsKICAgIGNvbnN0IGpvaW5Db2RlID0gdGhhdC50ZXh0LnRvVXBwZXJDYXNlKCk7CiAgICBjb25zdCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBqb2luIGNvZGU6YCwgam9pbkNvZGUpCiAgICB9CgogICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGBhYkpvaW5Db2RlXyR7am9pbkNvZGV9YCk7Cn0KCmlmIChnZXRSZWNvcmQgJiYgZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGNvbnN0IG5vd1RpbWUgPSBvcy5pc0NvbGxhYm9yYXRpdmUoKSA/IG9zLmFncmVlZFVwb25UaW1lIDogb3MubG9jYWxUaW1lOwogICAgY29uc3Qgbm93RGF0ZSA9IERhdGVUaW1lLmZyb21NaWxsaXMobm93VGltZSk7CiAgICBjb25zdCBjcmVhdGVEYXRlID0gRGF0ZVRpbWUuZnJvbU1pbGxpcyhnZXRSZWNvcmQuZGF0YS5kYXRlKTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbm93VGltZTpgLCBub3dUaW1lLCBgbm93RGF0ZTpgLCBub3dEYXRlLCBgY3JlYXRlRGF0ZTpgLCBjcmVhdGVEYXRlKTsKICAgIH0KCiAgICBsZXQgZGlmZmVyZW5jZSA9IG5vd0RhdGUuZGlmZihjcmVhdGVEYXRlLCAiZGF5cyIpLnRvT2JqZWN0KCk7CiAgICBkaWZmZXJlbmNlID0gTWF0aC5mbG9vcihkaWZmZXJlbmNlLmRheXMpOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkaWZmZXJlbmNlIChkYXlzKTpgLCBkaWZmZXJlbmNlKTsKICAgIH0KICAgIAogICAgaWYgKGRpZmZlcmVuY2UgPCA4KSB7CiAgICAgICAgb3MudG9hc3QoImpvaW5pbmcgaG9zdCBub3ciKTsKICAgICAgICBvcy5nb1RvVVJMKGdldFJlY29yZC5kYXRhLnVybCk7CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCJqb2luIGNvZGUgb3V0IG9mIGRhdGUsIHBsZWFzZSBnZW5lcmF0ZSBhIG5ldyBqb2luIGNvZGUiKTsKICAgIH0KfSBlbHNlIHsKICAgIG9zLnRvYXN0KCJqb2luIGNvZGUgaW52YWxpZCwgcGxlYXNlIHRyeSBhZ2FpbiIpOwp9JwCl0sy1DAAGc2VhcmNoAgQApdLMtQyoiwEo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScApdLMtQwACGFiSWdub3JlAgQApdLMtQzPiwEEdHJ1ZScApdLMtQwABG1lbnUCBACl0sy1DNSLASjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCl0sy1DAAVYWJTa2lsbEluaXRpYWxpemF0aW9uAgQApdLMtQz7iwGjAkAvL0ZpbmQgdGhlIGFwcHJvcHJpYXRlIGFycmF5IGFuZCBwb3B1bGF0ZSBza2lsbHMKbGV0IHNraWxsQXJyYXkgPSBsaW5rcy5yZW1lbWJlci50YWdzW3RoYXQgKyAiU2tpbGxBcnJheSJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoc2tpbGxBcnJheVtpXSk7Cn0KCmlmIChjb25maWdCb3QudGFncy5lbWJlZCA9PT0gJ2lvcycpIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgnYWJJT1NCcmlkZ2UnKTsKfQoKcmV0dXJuOycApdLMtQwABmJhbm5lcgIEAKXSzLUMn44BKPCflJdiNTUyZWFmOS1hOWQ2LTQxYzgtODUxNS1jYmQyYWJlYWFlNzMnAKXSzLUMAAVpbnB1dAIEAKXSzLUMxo4BKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAKXSzLUMAA1sb2FkaW5nU3RhdHVzAgQApdLMtQztjgHGB0Bjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkxvYWRTdGF0dXMiOwoKbGV0IHN0YXR1c0JvdCA9IHt9OwoKc3RhdHVzQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CnN0YXR1c0JvdC5sYWJlbCA9ICJ2ZXJpZnlpbmcgYXV0aEJvdCI7CnN0YXR1c0JvdC5sYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKc3RhdHVzQm90LmFiTG9hZFN0YXR1cyA9IHRydWU7CnN0YXR1c0JvdC5tZW51SXRlbVN0eWxlID0geyAiYmFja2dyb3VuZCI6ICJub25lIiB9OwpzdGF0dXNCb3QudHJhY2tOdW0gPSAwOwpzdGF0dXNCb3Qub25DcmVhdGUgPSBgQAogICAgaWYgKHRhZ3MudHJhY2tOdW0gPT0gMikgewogICAgICAgIHRhZ3MudHJhY2tOdW0gPSAwOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdGFncy50cmFja051bSsrOwogICAgfQoKICAgIHRhZ3MubGFiZWwgPSB0YWdzWyJsYWJlbCIrdGFncy50cmFja051bV07CiAgICB0YWdzLmZvcm1BZGRyZXNzID0gdGFnc1siZm9ybSIrdGFncy50cmFja051bV07CgogICAgc2V0VGltZW91dCgoKSA9PiB3aGlzcGVyKHRoaXNCb3QsICJvbkNyZWF0ZSIpLCA1MDApO2A7CnN0YXR1c0JvdC5sYWJlbDAgPSAidmVyaWZ5aW5nIGF1dGhCb3QuIjsKc3RhdHVzQm90LmxhYmVsMSA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4uIjsKc3RhdHVzQm90LmxhYmVsMiA9ICJ2ZXJpZnlpbmcgYXV0aEJvdC4uLiI7CnN0YXR1c0JvdC5mb3JtMCA9ICJob3VyZ2xhc3NfYm90dG9tIjsKc3RhdHVzQm90LmZvcm0xID0gImhvdXJnbGFzc190b3AiOwpzdGF0dXNCb3QuZm9ybTIgPSAiaG91cmdsYXNzX2JvdHRvbSI7CnN0YXR1c0JvdC5vbkRlc3Ryb3kgPSBgQAogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKbGV0IGNyZWF0ZWRTdGF0dXNCb3QgPSBjcmVhdGUoc3RhdHVzQm90KTsKCnJldHVybiBjcmVhdGVkU3RhdHVzQm90OycApdLMtQwAA2FzawIEAKXSzLUMtJYBKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAKXSzLUMAAdhYlRpbWVyAgQApdLMtQzblgHBBkBpZiAoZ2V0Qm90KCJhYlRpbWVyIiwgdHJ1ZSkpIHsKICAgIHJldHVybjsKfQoKaWYgKCF0YWdzLmFiWFApIHsKICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiWFAiLCAiMCIsICJsb2NhbCIpOwp9CgpsZXQgdGltZXJCb3QgPSB7fTsKCnRpbWVyQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CnRpbWVyQm90Lm1hbmFnZXIgPSBnZXRMaW5rKHRoaXNCb3QpOwp0aW1lckJvdC5vbkNyZWF0ZSA9IGBACiAgICBtYXNrcy5pbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHRoaXNCb3Qub25UaW1lQ2hlY2soKSwgNjAwMDApOwpgOwp0aW1lckJvdC5hYlRpbWVyID0gdHJ1ZTsKdGltZXJCb3Qub25UaW1lQ2hlY2sgPSBgQAogICAgaWYgKHRhZ3Mubm90SWRsZSkgewogICAgICAgIHRhZ3Mubm90SWRsZSA9IGZhbHNlOwoKICAgICAgICAvL2NvbnNvbGUubG9nKCJYUCIsIGxpbmtzLm1hbmFnZXIudGFncy5hYlhQKTsKCiAgICAgICAgY29uc3QgdG90YWxYUCA9IGxpbmtzLm1hbmFnZXIudGFncy5hYlhQICsgMTsKCiAgICAgICAgc2V0VGFnTWFzayhsaW5rcy5tYW5hZ2VyLCAiYWJYUCIsIHRvdGFsWFAsICJsb2NhbCIpOwogICAgfQpgOwp0aW1lckJvdC5ub3RJZGxlID0gZmFsc2U7CnRpbWVyQm90Lm9uQW55QWN0aW9uID0gYEAKICAgIGlmICghdGFncy5ub3RJZGxlKSB7CiAgICAgICAgaWYgKHRoYXQuYWN0aW9uLmlkID09IGdyaWRQb3J0YWxCb3QuaWQpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLm5vdElkbGUgPSB0cnVlOwogICAgICAgIH0KICAgIH0KYDsKCmxldCBhYlRpbWVyID0gY3JlYXRlKHRpbWVyQm90KTsKCmdsb2JhbFRoaXMuYWJUaW1lciA9IGFiVGltZXI7JwCl0sy1DAAFc3RvcmUCBACl0sy1DJ2dASjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwCl0sy1DAAHY29uc29sZQIEAKXSzLUMxJ0BKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAKXSzLUMAAlhYlZlcnNpb24CBACl0sy1DOudAQUxMC40MicApdLMtQwAF2FiQnVpbGRDYXN1YWxDYXRhbG9nVVJMAgQApdLMtQzxnQH/AUBjb25zdCByZWxhdGl2ZVBhdGggPSB0aGF0OwoKY29uc3QgdXJsID0gbmV3IFVSTChsaW5rcy5yZW1lbWJlci50YWdzLmNhc3VhbENhdGFsb2dVUkwpOwpjb25zdCBlbnYgPSBsaW5rcy5yZW1lbWJlci50YWdzLmNhc3VhbENhdGFsb2dFbnY7Cgp1cmwucGF0aG5hbWUgPSByZWxhdGl2ZVBhdGg7CgppZiAoZW52ICYmIGVudiAhPT0gJ3Byb2QnKSB7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnZW52JywgZW52KTsKfQoKcmV0dXJuIHVybC5ocmVmOycApdLMtQwAB2NoYW5uZWwCBACl0sy1DPGfASjwn5SXYTliNmFhMGQtYjM1Ny00ZGU2LTliZWYtODUzNDhhYjFkMGUwJwCl0sy1DAALcGVyc29uYWxpdHkCBACl0sy1DJigASjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwCl0sy1DAAMYWJJbnN0VXBkYXRlAgQApdLMtQy/oAGiAUAvLyBVcGRhdGUgdGhlIGFiSW5zdCB0YWcgd2hpY2ggcmVwcmVzZW50cyB0aGUgaW5zdCB0aGF0IHRoaXMgYWIgZXhpc3RzIGluLgpjb25zdCBjdXJJbnN0ID0gb3MuZ2V0Q3VycmVudEluc3QoKTsKc2V0VGFnTWFzayh0aGlzQm90LCAnYWJJbnN0JywgY3VySW5zdCwgJ3NoYXJlZCcpOycApdLMtQwADG9uSW5zdEpvaW5lZAIEAKXSzLUM4qEBGEB0aGlzQm90LmFiSW5zdFVwZGF0ZSgpOycApdLMtQwAC29uSW5zdExlYXZlAgQApdLMtQz7oQEYQHRoaXNCb3QuYWJJbnN0VXBkYXRlKCk7JwCl0sy1DAAMcmVzZXJ2ZWRBc2tzAgQApdLMtQyUogEM8J+nrFsiaG9tZSJdJwCl0sy1DAAIYXJ0aWZhY3QCBACl0sy1DJ+iASjwn5SXNzhlNDE1MDMtYzkzMy00ZjhhLTgxN2EtYmE5N2JmOGQ1ZDI3JwCl0sy1DAALYm90X2ZhY3RvcnkCBACl0sy1DMaiASjwn5SXYzc4YWE2NjMtZDA1Yy00ZWM0LWJjMmMtMjZmZDUxNTYwYjk3JwCl0sy1DAAFdXRpbHMCBACl0sy1DO2iASjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCl0sy1DAAIdXBkYXRlQUICBACl0sy1DJSjAeEqQGNvbnN0IHJlbG9hZFBhZ2UgPSB0aGF0Py5yZWxvYWRQYWdlID8/IHRydWU7DQpjb25zdCBzaG93SW5kaWNhdG9yID0gdGhhdD8uc2hvd0luZGljYXRvciA/PyB0cnVlOw0KY29uc3QgZHJ5UnVuID0gdGhhdD8uZHJ5UnVuID8/IGZhbHNlOw0KDQpsZXQgYnVzeUluZGljYXRvcjsNCg0KaWYgKHNob3dJbmRpY2F0b3IpIHsNCiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICd1cGRhdGVBQk1lbnUnOw0KICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyB1cGRhdGVBQk1lbnU6IHRydWUsIGxhYmVsOiBgdXBkYXRpbmcgJHtsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5fWAgfSk7DQp9DQoNCi8vIExldCBhbGwgYm90cyBrbm93IHRoYXQgYWIgaXMgYWJvdXQgdG8gdXBkYXRlIGl0c2VsZi4NCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZVVwZGF0ZScpKTsNCg0KbGV0IG92ZXJ3cml0ZVJlc3VsdDsNCg0KdHJ5IHsNCiAgICAvLyBVcGRhdGUgYWJDb25maWcuDQogICAgY29uc3QgYWJDb25maWdVUkwgPSBvcy5nZXRBQjFCb290c3RyYXBVUkwoKTsNCiAgICBjb25zdCBhYkNvbmZpZ1Jlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb25maWdVUkwgfSk7DQoNCiAgICBhc3NlcnQoYWJDb25maWdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke2FiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsNCiAgICBhc3NlcnQoYWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJDb25maWcgbXVzdCBiZSBpbiBhdXggZmlsZSBmb3JtYXQgdjIuIEFjdHVhbCBhdXggZmlsZSBmb3JtYXQgdmVyc2lvbjogJHthYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbn1gKTsNCg0KICAgIG92ZXJ3cml0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYXV4VjJPdmVyd3JpdGUoeyBhdXg6IGFiQ29uZmlnUmVzcG9uc2UuZGF0YSwgZ3JvdXBUYWc6ICdhYkNvbmZpZycsIGRyeVJ1biB9KTsNCiAgICBzZXRUYWdNYXNrKGFiLmxpbmtzLnJlbWVtYmVyLCAnYWJDb25maWdTb3VyY2VIYXNoJywgb3ZlcndyaXRlUmVzdWx0LnNvdXJjZUhhc2gsICdzaGFyZWQnKTsNCg0KICAgIC8vIFVwZGF0ZSBhYiBza2lsbHMuDQogICAgY29uc3QgbG9hZGVkU2tpbGxzID0gdGhpc0JvdC5hYkxvYWRlZFNraWxscygpOw0KDQogICAgZm9yIChsZXQgc2tpbGxOYW1lIG9mIGxvYWRlZFNraWxscykgew0KICAgICAgICBjb25zdCBza2lsbFVSTCA9IHRoaXNCb3QuYWJCdWlsZENhc3VhbENhdGFsb2dVUkwoYC9hYi8ke3NraWxsTmFtZX0uYXV4YCk7DQoNCiAgICAgICAgLy8gU2tpbGxzIGNhbiBiZSByZXN0cnVjdHVyZWQsIG1lYW5pbmcgdGhhdCB0aGV5IGNvdWxkIGJlIHJlbW92ZWQgZW50aXJlbHkgaW4gdGhlIGZ1dHVyZS4NCiAgICAgICAgLy8gSWYgYSBmaWxlIGZhaWxzIHRvIGJlIHJldHJpZXZlZCwgdGhlbiByZW1vdmUgYWxsIHRoZSBib3RzIGluIHRoZSBncm91cCBpbiB0aGUgaW5zdC4NCiAgICAgICAgbGV0IHJlbW92ZVNraWxsID0gZmFsc2U7DQogICAgICAgIGxldCBza2lsbFJlc3BvbnNlOw0KDQogICAgICAgIHRyeSB7DQogICAgICAgICAgICBza2lsbFJlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogc2tpbGxVUkwgfSk7DQoNCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbFJlc3BvbnNlOmAsIHNraWxsUmVzcG9uc2UpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICBhc3NlcnQoc2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHtza2lsbE5hbWV9IG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7c2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7DQoNCiAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7DQogICAgICAgICAgICAgICAgaWYgKHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDMgfHwgc2tpbGxSZXNwb25zZS5zdGF0dXMgPT09IDQwNCkgew0KICAgICAgICAgICAgICAgICAgICByZW1vdmVTa2lsbCA9IHRydWU7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkICR7c2tpbGxOYW1lfS4gUmVzcG9uc2U6ICR7c2tpbGxSZXNwb25zZS5zdGF0dXNUZXh0fWApOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfSBjYXRjaCAoZSkgew0KICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBlcnJvciB3aGlsZSBkb3dubG9hZGluZyBza2lsbDpgLCBlKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYgKGUucmVzcG9uc2U/LnN0YXR1cyA9PT0gNDAzIHx8IGUucmVzcG9uc2U/LnN0YXR1cyA9PT0gNDA0KSB7DQogICAgICAgICAgICAgICAgLy8gRmlsZSBkb2VzbnQgZXhpc3QgYW55bW9yZSwgdGhlIHNraWxsIGhhcyBiZWVuIHJlbW92ZWQuDQogICAgICAgICAgICAgICAgcmVtb3ZlU2tpbGwgPSB0cnVlOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICB0aHJvdyBlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBpZiAoc2tpbGxSZXNwb25zZSAmJiAhcmVtb3ZlU2tpbGwpIHsNCiAgICAgICAgICAgIG92ZXJ3cml0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYXV4VjJPdmVyd3JpdGUoeyBhdXg6IHNraWxsUmVzcG9uc2UuZGF0YSwgZ3JvdXBUYWc6IHNraWxsTmFtZSwgZHJ5UnVuIH0pOw0KDQogICAgICAgICAgICBjb25zdCBsb2FkZWRTa2lsbEJvdCA9IGdldEJvdChiID0+IGIudGFncy5hYkxvYWRlZFNraWxsID09PSBza2lsbE5hbWUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOw0KICAgICAgICAgICAgYXNzZXJ0KGxvYWRlZFNraWxsQm90LCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNvdWxkIG5vdCBmaW5kIGxvYWRlZCBza2lsbCBib3QgZm9yICR7c2tpbGxOYW1lfS5gKTsNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgc2V0VGFnTWFzayhsb2FkZWRTa2lsbEJvdCwgJ2FiTG9hZGVkU2tpbGxTb3VyY2VIYXNoJywgb3ZlcndyaXRlUmVzdWx0LnNvdXJjZUhhc2gsICdzaGFyZWQnKTsNCiAgICAgICAgfSBlbHNlIGlmIChyZW1vdmVTa2lsbCkgew0KICAgICAgICAgICAgY29uc3Qgc2tpbGxCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFnc1tza2lsbE5hbWVdID09PSB0cnVlKTsNCg0KICAgICAgICAgICAgaWYgKGRyeVJ1bikgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZGVsZXRlICR7c2tpbGxCb3RzLmxlbmd0aH0gJHtza2lsbE5hbWV9IGJvdChzKSBiZWNhdXNlICR7c2tpbGxOYW1lfSBpcyBubyBsb25nZXIgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLmApDQogICAgICAgICAgICAgICAgY29udGludWU7DQogICAgICAgICAgICB9DQoNCg0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFNraWxsICR7c2tpbGxOYW1lfSBpcyBubyBsb25nZXIgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBSZW1vdmUgJHtza2lsbEJvdHMubGVuZ3RofSAke3NraWxsTmFtZX0gYm90KHMpIGZyb20gaW5zdC5gKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVzdHJveShza2lsbEJvdHMpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgLy8gVXBkYXRlIGFiQ29yZSAoZG8gdGhpcyBvbmUgbGFzdCEpDQogICAgY29uc3QgYWJDb3JlVVJMID0gdGhpc0JvdC5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTCgnL2FiL2FiQ29yZS5hdXgnKTsNCiAgICBjb25zdCBhYkNvcmVSZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBhYkNvcmVVUkwgfSk7DQoNCiAgICBhc3NlcnQoYWJDb3JlUmVzcG9uc2Uuc3RhdHVzID09PSAyMDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkIGFiQ29yZS4gUmVzcG9uc2U6ICR7YWJDb3JlUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsNCiAgICBhc3NlcnQoYWJDb3JlUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29yZSBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke2FiQ29yZVJlc3BvbnNlLmRhdGEudmVyc2lvbn1gKTsNCg0KICAgIG92ZXJ3cml0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYXV4VjJPdmVyd3JpdGUoeyBhdXg6IGFiQ29yZVJlc3BvbnNlLmRhdGEsIGdyb3VwVGFnOiAnYWJDb3JlJywgZHJ5UnVuIH0pOw0KICAgIHNldFRhZ01hc2soYWIsICdhYkNvcmVTb3VyY2VIYXNoJywgb3ZlcndyaXRlUmVzdWx0LnNvdXJjZUhhc2gsICdzaGFyZWQnKTsNCiAgICANCiAgICAvLyBMZXQgYWxsIGJvdHMga25vdyB0aGF0IGFiIGlzIGZpbmlzaGVkIHVwZGF0aW5nLg0KICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlVwZGF0ZWQnKSk7DQoNCiAgICBpZiAocmVsb2FkUGFnZSkgew0KICAgICAgICBjb25zdCByZW1vdGVEYXRhRXZlbnQgPSAndXBkYXRlX2FiX3JlbG9hZF9wYWdlJzsNCiAgICAgICAgY29uc3QgcmVtb3RlRGF0YUFyZyA9IHsgcmVsb2FkUGFnZSwgZHJ5UnVuIH07DQoNCiAgICAgICAgaWYgKG9zLmlzQ29sbGFib3JhdGl2ZSgpKSB7DQogICAgICAgICAgICBjb25zdCByZW1vdGVzID0gYXdhaXQgb3MucmVtb3RlcygpOw0KICAgICAgICAgICAgc2VuZFJlbW90ZURhdGEocmVtb3RlcywgcmVtb3RlRGF0YUV2ZW50LCByZW1vdGVEYXRhQXJnKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgIHRoaXNCb3Qub25SZW1vdGVEYXRhKHsgbmFtZTogcmVtb3RlRGF0YUV2ZW50LCB0aGF0OiByZW1vdGVEYXRhQXJnLCByZW1vdGVJZDogY29uZmlnQm90LmlkIH0pOw0KICAgICAgICB9DQogICAgfQ0KfSBmaW5hbGx5IHsNCiAgICBpZiAoYnVzeUluZGljYXRvcikgew0KICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOw0KICAgICAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7DQogICAgfQ0KfScApdLMtQwABWRlYnVnAgQApdLMtQz2zQEFZmFsc2UnAKXSzLUMABVhYkNyZWF0ZVVwZGF0ZUNoZWNrZXICBACl0sy1DPzNAb0TQGxldCBhYlVwZGF0ZUNoZWNrZXIgPSBnZXRCb3QoJ2FiVXBkYXRlQ2hlY2tlcicsIHRydWUpOwoKaWYgKGFiVXBkYXRlQ2hlY2tlcikgewogICAgZ2xvYmFsVGhpcy5hYlVwZGF0ZUNoZWNrZXIgPSBhYlVwZGF0ZUNoZWNrZXI7CiAgICByZXR1cm4gYWJVcGRhdGVDaGVja2VyOwp9CgpsZXQgbW9kID0gewogICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgYWJVcGRhdGVDaGVja2VyOiB0cnVlLAogICAgYWJJZ25vcmU6IHRydWUsCiAgICBjaGVja2luZzogZmFsc2UsCiAgICB1cGRhdGVBdmFpbGFibGU6IGZhbHNlLAogICAgZGVidWc6IGZhbHNlLAogICAgb25DcmVhdGU6IGBACiAgICAgICAgdGhpc0JvdC5zdGFydEludGVydmFsKCk7CiAgICAgICAgdGhpc0JvdC5vblVwZGF0ZUNoZWNrKCk7CiAgICBgLAogICAgc3RhcnRJbnRlcnZhbDogYEAKICAgICAgICBpZiAoIXRhZ3MuaW50ZXJ2YWwpIHsKICAgICAgICAgICAgY29uc3QgVVBEQVRFX0NIRUNLX0lOVEVSVkFMX01JTlVURVMgPSA1OwogICAgICAgICAgICBjb25zdCBpbnRlcnZhbE1TID0gVVBEQVRFX0NIRUNLX0lOVEVSVkFMX01JTlVURVMgKiA2MCAqIDEwMDA7CiAgICAgICAgICAgIHRhZ3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzQm90Lm9uVXBkYXRlQ2hlY2soKSwgaW50ZXJ2YWxNUyk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1thYlVwZGF0ZUNoZWNrZXJdIHN0YXJ0IHVwZGF0ZSBjaGVjayBpbnRlcnZhbCBtczonLCBpbnRlcnZhbE1TKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIGAsCiAgICBzdG9wSW50ZXJ2YWw6IGBACiAgICAgICAgaWYgKHRhZ3MuaW50ZXJ2YWwpIHsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0YWdzLmludGVydmFsKTsKICAgICAgICAgICAgdGFncy5pbnRlcnZhbCA9IG51bGw7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1thYlVwZGF0ZUNoZWNrZXJdIHN0b3AgdXBkYXRlIGNoZWNrIGludGVydmFsLicpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgYCwKICAgIGZvcmNlVXBkYXRlQ2hlY2s6IGBACiAgICAgICAgdGhpc0JvdC5zdG9wSW50ZXJ2YWwoKTsKICAgICAgICB0aGlzQm90LnN0YXJ0SW50ZXJ2YWwoKTsKICAgICAgICB0aGlzQm90Lm9uVXBkYXRlQ2hlY2soeyBmb3JjZTogdHJ1ZSB9KTsKICAgIGAsCiAgICBvblVwZGF0ZUNoZWNrOiBgQAogICAgICAgIGNvbnN0IGZvcmNlID0gdGhhdD8uZm9yY2UgPz8gZmFsc2U7CgogICAgICAgIGlmICghdGFncy5jaGVja2luZykgewogICAgICAgICAgICBpZiAoIXRhZ3MudXBkYXRlQXZhaWxhYmxlIHx8IGZvcmNlKSB7CiAgICAgICAgICAgICAgICB0YWdzLmNoZWNraW5nID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGFiLmFiQ2hlY2tBQlVwZGF0ZUF2YWlsYWJsZSgpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gdXBkYXRlIGNoZWNrIHJlc3VsdDonLCByZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3MudXBkYXRlQXZhaWxhYmxlID0gcmVzdWx0LnVwZGF0ZUF2YWlsYWJsZTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQudXBkYXRlQXZhaWxhYmxlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG91dCgnb25BQlVwZGF0ZUF2YWlsYWJsZScpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgICAgICAgICB0YWdzLmNoZWNraW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSBza2lwIHVwZGF0ZSBjaGVjayDigJQgdXBkYXRlIGlzIGFscmVhZHkga25vd24gdG8gYmUgYXZhaWxhYmxlLicpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSB1cGRhdGUgY2hlY2sgYWxyZWFkeSBpbiBwcm9ncmVzcy4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICBgLAp9CgphYlVwZGF0ZUNoZWNrZXIgPSBjcmVhdGUobW9kKTsKZ2xvYmFsVGhpcy5hYlVwZGF0ZUNoZWNrZXIgPSBhYlVwZGF0ZUNoZWNrZXIKCnJldHVybiBhYlVwZGF0ZUNoZWNrZXI7JwCl0sy1DAAOYXV4VjJPdmVyd3JpdGUCBACl0sy1DLjhAZEqQGNvbnN0IGF1eCA9IHRoYXQ/LmF1eDsKY29uc3QgZ3JvdXBUYWcgPSB0aGF0Py5ncm91cFRhZzsKY29uc3QgZHJ5UnVuID0gdGhhdD8uZHJ5UnVuID8/IGZhbHNlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKYXNzZXJ0KGF1eD8udmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhdXggcGFyYW1ldGVyIGlzIHJlcXVpcmVkIHRvIGJlIGEgdjIgYXV4IGZpbGUuYCk7CmFzc2VydChncm91cFRhZyA9PSBudWxsIHx8IHR5cGVvZiBncm91cFRhZyA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ3JvdXBUYWcgcGFyYW1ldGVyIGlmIHByb3ZpZGVkLCBtdXN0IGJlIGEgc3RyaW5nLmApOwoKY29uc3Qgc3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhdXgudXBkYXRlcyk7CgovLyBTdXBlciBoYXJkY29kZWQgbWVzc3kgZml4IGZvciBjb21wdXRpbmcgYWJDb25maWcgc291cmNlIGhhc2guCmlmIChncm91cFRhZyA9PT0gJ2FiQ29uZmlnJykgeyAKICAgIGZvciAobGV0IGlkIGluIHN0YXRlKSB7CiAgICAgICAgZGVsZXRlIHN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgogICAgfQp9CgpsZXQgc291cmNlSGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIHN0YXRlKTsKbGV0IHByZXZHcm91cEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzW2dyb3VwVGFnXSA9PT0gdHJ1ZSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdGF0ZTpgLCBzdGF0ZSk7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHByZXZHcm91cEJvdHM6YCwgcHJldkdyb3VwQm90cyk7Cn0KCi8vIFN0ZXAgMTogQXBwbHkgdXBkYXRlcyBkaXJlY3RseSB0byB0aGUgaW5zdCBhcy1pcy4KaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU3RlcCAxOiBBcHBseSB1cGRhdGVzIGRpcmVjdGx5IHRvIHRoZSBpbnN0IGFzLWlzLmApOwp9CgppZiAoIWRyeVJ1bikgewogICAgYXdhaXQgb3MuYXBwbHlVcGRhdGVzVG9JbnN0KGF1eC51cGRhdGVzKTsKfSBlbHNlIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgYXBwbHkgdXBkYXRlcyB0byBpbnN0LmApCn0KCi8vIFN0ZXAgMjogRGVsZXRlIHByZXZpb3VzIGdyb3VwIGJvdHMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSB1cGRhdGUgc3RhdGUuCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFN0ZXAgMjogRGVsZXRlIHByZXZpb3VzIGdyb3VwIGJvdHMgdGhhdCBhcmUgbm8gbG9uZ2VyIGluIHRoZSB1cGRhdGUgc3RhdGUuYCk7Cn0KCmZvciAoY29uc3QgcHJldkdyb3VwQm90IG9mIHByZXZHcm91cEJvdHMpIHsKICAgIGlmIChzdGF0ZVtwcmV2R3JvdXBCb3QuaWRdID09IG51bGwpIHsKICAgICAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZGVsZXRlIGJvdCAke3ByZXZHcm91cEJvdC5pZH0gcHJldmlvdXNseSBiZWxvbmdpbmcgdG8gZ3JvdXAgJHtncm91cFRhZ31gKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgcHJldmlvdXMgZ3JvdXAgYm90ICR7cHJldkdyb3VwQm90LmlkfSB0aGF0IGlzIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLmApOwogICAgICAgIH0KCiAgICAgICAgZGVzdHJveShwcmV2R3JvdXBCb3QpOwogICAgfQp9CgovLyBTdGVwIDM6IEZvciBlYWNoIGJvdCBpbiB0aGUgdXBkYXRlIHN0YXRlLCBjcmVhdGUsIHVwZGF0ZSwgYW5kIGRlbGV0ZSB0YWdzIG9uIHRoZSBleGlzdGluZyBib3RzIGluIHRoZSBpbnN0LgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBTdGVwIDM6IEZvciBlYWNoIGJvdCBpbiB0aGUgdXBkYXRlIHN0YXRlLCBjcmVhdGUsIHVwZGF0ZSwgYW5kIGRlbGV0ZSB0YWdzIG9uIHRoZSBleGlzdGluZyBib3RzIGluIHRoZSBpbnN0LmApOwp9Cgpmb3IgKGNvbnN0IGJvdElkIGluIHN0YXRlKSB7CiAgICBjb25zdCBib3QgPSBnZXRCb3QoJ2lkJywgYm90SWQpOwogICAgY29uc3QgYm90U3RhdGUgPSBzdGF0ZVtib3RJZF07CgogICAgaWYgKGJvdCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgZXhpc3RpbmcgYm90ICR7Ym90SWR9YCk7CiAgICAgICAgfQoKICAgICAgICAvLyBIYW5kbGVzIHRhZyBjcmVhdGUgLyB1cGRhdGUuCiAgICAgICAgZm9yIChjb25zdCBzdGF0ZVRhZ05hbWUgaW4gYm90U3RhdGUudGFncykgewogICAgICAgICAgICBpZiAoYm90LnJhd1tzdGF0ZVRhZ05hbWVdICE9IGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSkgewogICAgICAgICAgICAgICAgaWYgKGRyeVJ1bikgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgc2V0IHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0gdG8gdmFsdWU6YCwgYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2V0IHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0gdG86YCwgYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBib3QudGFnc1tzdGF0ZVRhZ05hbWVdID0gYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdOwoKICAgICAgICAgICAgICAgIGlmIChib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV0gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGFnICcke3N0YXRlVGFnTmFtZX0nIGZvciBib3QgJHtib3RJZH0gaXMgbnVsbCwgY2xlYXJpbmcgYW55IHRhZyBtYXNrcyBhcyB3ZWxsLmApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgYWxsIHBvc3NpYmxlIG1hc2tzIGZvciB0aGlzIHRhZyBhcyB3ZWxsLgogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICdsb2NhbCcpOwogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICd0ZW1wTG9jYWwnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAnc2hhcmVkJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIHN0YXRlVGFnTmFtZSwgbnVsbCwgJ3RlbXBTaGFyZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0YWcgJyR7c3RhdGVUYWdOYW1lfScgZm9yIGJvdCAke2JvdElkfSBpcyBhbHJlYWR5IHVwLXRvLWRhdGUuYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIERlbGV0ZSB0YWdzIChhbmQgbWFza3MgZm9yIHRob3NlIHRhZ3MpIG9uIGV4aXN0aW5nIGJvdCB0aGF0IGFyZSBub3QgaW4gdXBkYXRlIHN0YXRlLgogICAgICAgIGNvbnN0IGJvdFRhZ3MgPSBPYmplY3Qua2V5cyhib3QudGFncyk7CgogICAgICAgIGZvciAoY29uc3QgYm90VGFnTmFtZSBvZiBib3RUYWdzKSB7CiAgICAgICAgICAgIGlmIChib3RTdGF0ZS50YWdzW2JvdFRhZ05hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChkcnlSdW4pIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGRlbGV0ZSB0YWcgJyR7Ym90VGFnTmFtZX0nIG9uIGJvdCAke2JvdElkfS5gKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVsZXRlIHRhZyAoYW5kIG1hc2tzKSAnJHtib3RUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9LmApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJvdC50YWdzW2JvdFRhZ05hbWVdID0gbnVsbDsKICAgICAgICAgICAgICAgIC8vIENsZWFyIGFsbCBwb3NzaWJsZSBtYXNrcyBmb3IgdGhpcyB0YWcgYXMgd2VsbC4KICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAnbG9jYWwnKTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAndGVtcExvY2FsJyk7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ3NoYXJlZCcpOwogICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIGJvdFRhZ05hbWUsIG51bGwsICd0ZW1wU2hhcmVkJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb3VsZCBub3QgZmluZCBib3QgJHtib3RJZH0gaW4gaW5zdC5gKTsKICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZG9uZS5gKTsKfQoKY29uc3QgYm90SWRzID0gT2JqZWN0LmtleXMoc3RhdGUpOwoKcmV0dXJuIHsKICAgIGdyb3VwVGFnLAogICAgYm90SWRzLAogICAgc291cmNlSGFzaCwKfTsnAKXSzLUMAA5hYkxvYWRlZFNraWxscwIEAKXSzLUMyosCtgFAY29uc3QgbG9hZGVkU2tpbGxzID0gbmV3IFNldCgpOwoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkxvYWRlZFNraWxsICE9IG51bGwpIHsKICAgICAgICBsb2FkZWRTa2lsbHMuYWRkKGIudGFncy5hYkxvYWRlZFNraWxsKTsKICAgIH0KfSk7CgpyZXR1cm4gQXJyYXkuZnJvbShsb2FkZWRTa2lsbHMpOycApdLMtQwADG9uUmVtb3RlRGF0YQIEAKXSzLUMgY0CpwVAaWYgKHRoYXQubmFtZSA9PT0gJ3VwZGF0ZV9hYl9yZWxvYWRfcGFnZScpIHsKICAgIGNvbnN0IHsgcmVsb2FkUGFnZSwgZHJ5UnVuIH0gPSB0aGF0LnRoYXQ7CgogICAgaWYgKHRoYXQucmVtb3RlSWQgPT09IGNvbmZpZ0JvdC5pZCkgewogICAgICAgIC8vIFdhaXQgYSBtb21lbnQgYmVmb3JlIHJlbG9hZGluZyB0aGUgcGFnZSBpZiB3ZSBhcmUgdGhlIG9uZXMgdGhhdCBzZW50IG91dCB0aGUgbWVzc2FnZS4KICAgICAgICBhd2FpdCBvcy5zbGVlcCgxMDAwKTsKICAgIH0KCiAgICBsZXQgaXNVUkwgPSBmYWxzZTsKCiAgICBpZiAodHlwZW9mIHJlbG9hZFBhZ2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbmV3IFVSTChyZWxvYWRQYWdlKTsKICAgICAgICAgICAgaXNVUkwgPSB0cnVlOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICB9CgogICAgbGV0IHVybCA9IGlzVVJMID8gcmVsb2FkUGFnZSA6IGNvbmZpZ0JvdC50YWdzLnVybDsKCiAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBnbyB0byB1cmxgLCB1cmwpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIAogICAgb3MuZ29Ub1VSTChpc1VSTCA/IHJlbG9hZFBhZ2UgOiBjb25maWdCb3QudGFncy51cmwpOwp9JwCl0sy1DAAJb25FbnRlckFSAgQApdLMtQypkgITQG1hc2tzLmluQVIgPSB0cnVlOycApdLMtQwACG9uRXhpdEFSAgQApdLMtQy9kgITQG1hc2tzLmluQVIgPSBudWxsOycApdLMtQwACW9uRW50ZXJWUgIEAKXSzLUM0ZICE0BtYXNrcy5pblZSID0gdHJ1ZTsnAKXSzLUMAAhvbkV4aXRWUgIEAKXSzLUM5ZICE0BtYXNrcy5pblZSID0gbnVsbDsnAKXSzLUMAAZjcmVhdGUCBACl0sy1DPmSAijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwCl0sy1DAAFcGFzdGUCBACl0sy1DKCTAijwn5SXYjMzOWMxMTgtNDg5YS00NjZiLWJhOWYtYjA3YTVmOWI2NjRmJwCl0sy1DAAIYXJtX3Rvb2wCBACl0sy1DMeTAijwn5SXM2M3NGM5ZjEtODJkYy00NjU1LThiMzgtZTdmMTFkZTg5NzhlJwCl0sy1DAADY3VlAgQApdLMtQzukwKRDEAvL3RoYXQNCi8vYm90Pw0KLy9wb3NpdGlvbj8NCi8vdGV4dA0KLy9kaW1lbnNpb24/DQovL3NjYWxlPw0KLy9jb2xvcj8NCi8vc3BhY2U/DQovL2ZvbnRTaXplPw0KLy93cmFwTW9kZT8NCg0KY29uc3QgY3VycmVudERpbSA9IHRoYXQuZGltZW5zaW9uID8/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gPz8gJ2hvbWUnOw0KDQpsZXQgcG9zWDsNCmxldCBwb3NZOw0KbGV0IHBvc1o7DQoNCg0KDQppZiAodGhhdC5ib3QpIHsNCiAgICBwb3NYID0gdGhhdC5ib3QudGFnc1tjdXJyZW50RGltICsgJ1gnXTsNCiAgICBwb3NZID0gdGhhdC5ib3QudGFnc1tjdXJyZW50RGltICsgJ1knXTsNCiAgICBwb3NaID0gdGhhdC5ib3QudGFnc1tjdXJyZW50RGltICsgJ1onXSA/PyAwOw0KfSBlbHNlIGlmICh0aGF0LnBvc2l0aW9uKSB7DQogICAgcG9zWCA9IHRoYXQucG9zaXRpb24ueDsNCiAgICBwb3NZID0gdGhhdC5wb3NpdGlvbi55Ow0KICAgIHBvc1ogPSB0aGF0LnBvc2l0aW9uLnogPz8gMTsNCn0NCg0KaWYgKCghcG9zWCAmJiBwb3NYICE9IDApIHx8ICghcG9zWSAmJiBwb3NZICE9IDApKSB7DQogICAgcmV0dXJuOw0KfQ0KDQpjb25zdCBjdWVCb3QgPSBhd2FpdCBjcmVhdGUoew0KICAgIHNwYWNlOiB0aGF0LnNwYWNlID8/ICd0ZW1wTG9jYWwnLA0KICAgIGxhYmVsOiB0aGF0LnRleHQgPz8gJycsDQogICAgbGFiZWxDb2xvcjogdGhhdC5jb2xvciA/PyAid2hpdGUiLA0KICAgIHNjYWxlOiB0aGF0LnNjYWxlID8/ICcuNScsDQogICAgW2N1cnJlbnREaW1dOiB0cnVlLA0KICAgIFtjdXJyZW50RGltICsgJ1gnXTogcG9zWCwNCiAgICBbY3VycmVudERpbSArICdZJ106IHBvc1ksDQogICAgW2N1cnJlbnREaW0gKyAnWiddOiBwb3NaLA0KICAgIGNvbG9yOiAnY2xlYXInLA0KICAgIGxhYmVsT3BhY2l0eTogMSwNCiAgICBsYWJlbFdvcmRXcmFwTW9kZTogdGhhdC53cmFwTW9kZSA/PyAnYnJlYWtXb3JkcycsDQogICAgbGFiZWxGb250U2l6ZTogdGhhdC5mb250U2l6ZSA/PyB1bmRlZmluZWQsDQogICAgbGFiZWxQb3NpdGlvbjogJ2Zsb2F0aW5nQmlsbGJvYXJkJywNCiAgICBsYWJlbEZsb2F0aW5nQmFja2dyb3VuZENvbG9yOiAnY2xlYXInLA0KICAgIHBvaW50YWJsZTogZmFsc2UsDQogICAgb25Cb3RBZGRlZDogYEANCiAgICAgICAgYXdhaXQgYW5pbWF0ZVRhZyh0aGlzQm90LCB7DQogICAgICAgICAgICBmcm9tVmFsdWU6IHsNCiAgICAgICAgICAgICAgICBbJyR7Y3VycmVudERpbX0nICsgJ1onXTogJHtwb3NafSwNCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDENCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICB0b1ZhbHVlOiB7DQogICAgICAgICAgICAgICAgWycke2N1cnJlbnREaW19JyArICdaJ106ICR7cG9zWn0gKyAzLA0KICAgICAgICAgICAgICAgIGxhYmVsT3BhY2l0eTogMA0KICAgICAgICAgICAgfSwNCiAgICAgICAgICAgIGR1cmF0aW9uOiAyLA0KICAgICAgICAgICAgdGFnTWFza1NwYWNlOiBmYWxzZQ0KICAgICAgICB9KQ0KICAgICAgICBkZXN0cm95KHRoaXNCb3QpOw0KICAgIGANCn0pJwCl0sy1DAALb25BbnlDcmVhdGUCBACl0sy1DICgAvEEQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCkgewogICAgLy8gW1J5YW5dIEknbSBub3Qgc3VyZSB3aHkgd2UgbmVlZCB0byBkbyB0aGlzLCBidXQgd2l0aG91dCBhd2FpdGluZyBoZXJlIHdlIGFyZSBzZWVpbmcgc3RyYW5nZQogICAgLy8gYXJ0aWZhY3RzIHdpdGggbmV3IGJvdHMgY3JlYXRlZCB2aWEgYWIuIE11bHRpcGxlIGxpbmVzIGdldCBkcmF3biBpbnN0ZWFkIG9mIGp1c3Qgb25lIHRvIHRoZSBzZWxlY3RlZCBib3QgYW5kIHRoZSBhcm0KICAgIC8vIGRvZXNudCBnZXQgdXBkYXRlZCBwcm9wZXJseSB0byBoaWRlLiBJdHMgYXMgaWYgYm90IHVwZGF0ZXMgZ2V0IG1lc3NlZCB1cCBvciBwZXJoYXBzIGxvc3Qgd2l0aG91dCB0aGlzIGF3YWl0LgogICAgYXdhaXQgb3Muc2xlZXAoMCk7CiAgICAKICAgIC8vIEFzc2lnbiBhIGNyZWF0aW9uIHRpbWVzdGFtcCBmb3IgdGhlIGJvdC4KICAgIGxldCB0aW1lc3RhbXAgPSBvcy5hZ3JlZWRVcG9uVGltZTsKCiAgICBpZiAoTnVtYmVyLmlzTmFOKHRpbWVzdGFtcCkpIHsKICAgICAgICB0aW1lc3RhbXAgPSBvcy5sb2NhbFRpbWU7CiAgICB9CgogICAgc2V0VGFnTWFzayhib3QsICdhYkNyZWF0ZVRpbWUnLCB0aW1lc3RhbXAsICdzaGFyZWQnKTsKfScApdLMtQwABXNvdW5kAgQApdLMtQzypAIo8J+UlzEzNjcyMjUzLTI1MzYtNDA4Ni05NWNmLWViMTZmZmNjZTRkZCcApdLMtQwADWFiUHJpbWFyeUluc3QCBACl0sy1DJmlAsECQGlmIChjb25maWdCb3QpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpOwoKICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiB1cmwuc2VhcmNoUGFyYW1zKSB7CiAgICAgICAgICAgIGlmIChrZXkgPT09ICdpbnN0JyB8fCBrZXkgPT09ICdzdGF0aWNJbnN0JykgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBjYXRjaCB7CiAgICAgICAgLy8gQmFkIHVybC4KICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KfQoKcmV0dXJuIG51bGw7JwCl0sy1DAALYWJJc1ByaW1hcnkCBACl0sy1DNunAnNAY29uc3QgY3VySW5zdCA9IG9zLmdldEN1cnJlbnRJbnN0KCk7CmNvbnN0IHByaW1hcnlJbnN0ID0gdGhpc0JvdC5hYlByaW1hcnlJbnN0KCk7CgpyZXR1cm4gY3VySW5zdCA9PT0gcHJpbWFyeUluc3Q7AA=="}]}