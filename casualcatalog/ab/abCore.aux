{"version":2,"updates":[{"id":0,"timestamp":1771717205309,"update":"AXqnv7qtCAAnAQRib3RzJDY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNwEnAKe/uq0IABhhYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUCBACnv7qtCAGVLEBjb25zdCBkZXRhaWxlZCA9IHRoYXQ/LmRldGFpbGVkID8/IGZhbHNlOwpjb25zdCBoYXNoQWxnb3JpdGhtID0gdGhhdD8uaGFzaEFsZ29yaXRobSA/PyAnc2hhMSc7CmNvbnN0IGhhc2hGb3JtYXQgPSB0aGF0Py5oYXNoRm9ybWF0ID8/ICdoZXgnOwoKaW50ZXJmYWNlIEFCRmlsZVVwZGF0ZUNoZWNrIHsKICAgIGZpbGVOYW1lOiBzdHJpbmc7CiAgICB1cGRhdGVBdmFpbGFibGU6IGJvb2xlYW47CiAgICBjdXJyZW50SGFzaDogc3RyaW5nOwogICAgbGF0ZXN0SGFzaDogc3RyaW5nOwogICAgcmVtb3ZlZDogYm9vbGVhbjsKfQoKLy8gVGhpcyBsaXN0IG9mIGFiIGZpbGUgY2hlY2tzLCB0aGlzIHdpbGwgb25seSBiZSBwb3B1bGF0ZWQgaWYgJ2RldGFpbGVkJyBpcyB0cnVlLgpjb25zdCBhYkZpbGVDaGVja3M6IEFCRmlsZVVwZGF0ZUNoZWNrW10gPSBbXTsKCmFzeW5jIGZ1bmN0aW9uIGNoZWNrU2tpbGxPdXRkYXRlZChza2lsbE5hbWU6IHN0cmluZywgY3VycmVudEhhc2g6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gewogICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOyAgICAgICAgCiAgICBsZXQgc2tpbGxSZW1vdmVkID0gZmFsc2U7CiAgICBsZXQgc2tpbGxSZXNwb25zZTsKCiAgICB0cnkgewogICAgICAgIHNraWxsUmVzcG9uc2UgPSBhd2FpdCB3ZWJob29rKHsgbWV0aG9kOiAiR0VUIiwgdXJsOiBza2lsbFVSTCB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lsbFJlc3BvbnNlOmAsIHNraWxsUmVzcG9uc2UpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhc3NlcnQoc2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHtza2lsbE5hbWV9IG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7c2tpbGxSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7CgogICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyAhPT0gMjAwKSB7CiAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgJHtza2lsbE5hbWV9LiBSZXNwb25zZTogJHtza2lsbFJlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBlcnJvciB3aGlsZSBkb3dubG9hZGluZyBza2lsbDpgLCBlKTsKICAgICAgICAKICAgICAgICBpZiAoZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDMgfHwgZS5yZXNwb25zZT8uc3RhdHVzID09PSA0MDQpIHsKICAgICAgICAgICAgLy8gRmlsZSBkb2VzbnQgZXhpc3QgYW55bW9yZSwgdGhlIHNraWxsIGhhcyBiZWVuIHJlbW92ZWQuCiAgICAgICAgICAgIHNraWxsUmVtb3ZlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHNraWxsUmVtb3ZlZCkgewogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoOiBudWxsLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSwKICAgICAgICAgICAgfSkKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBDYWxjdWxhdGUgaGFzaCBvZiBhYiBmaWxlIHN0YXRlIHRvIGNvbXBhcmUgYWdhaW5zdC4KICAgICAgICBjb25zdCBzdGF0ZSA9IGF3YWl0IG9zLmdldEluc3RTdGF0ZUZyb21VcGRhdGVzKHNraWxsUmVzcG9uc2UuZGF0YS51cGRhdGVzKTsKICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgc3RhdGUpOwogICAgICAgIAogICAgICAgIGlmIChkZXRhaWxlZCkgewogICAgICAgICAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgICAgICAgICBmaWxlTmFtZTogc2tpbGxOYW1lLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgcmVtb3ZlZDogZmFsc2UsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgbGF0ZXN0VXBkYXRlczogc2tpbGxSZXNwb25zZS5kYXRhLnVwZGF0ZXMsCiAgICAgICAgICAgICAgICBsYXRlc3RTdGF0ZTogc3RhdGUsCiAgICAgICAgICAgIH0pCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2g7CiAgICB9Cn0KCi8vIDEuIENoZWNrIGlmIGFiQ29uZmlnIGlzIG91dGRhdGVkLgpjb25zdCBhYkNvbmZpZ1VSTCA9IG9zLmdldEFCMUJvb3RzdHJhcFVSTCgpOwpjb25zdCBhYkNvbmZpZ1Jlc3BvbnNlID0gYXdhaXQgd2ViaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb25maWdVUkwgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvbmZpZ1Jlc3BvbnNlOmAsIGFiQ29uZmlnUmVzcG9uc2UpOwp9Cgphc3NlcnQoYWJDb25maWdSZXNwb25zZS5zdGF0dXMgPT09IDIwMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb3VsZCBub3QgZG93bmxvYWQgYWJDb25maWcuIFJlc3BvbnNlOiAke2FiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsKYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7Cgpjb25zdCBhYkNvbmZpZ0N1cnJlbnRIYXNoID0gYWIubGlua3MucmVtZW1iZXIudGFncy5hYkNvbmZpZ1NvdXJjZUhhc2g7CmNvbnN0IGFiQ29uZmlnTGF0ZXN0U3RhdGUgPSBhd2FpdCBvcy5nZXRJbnN0U3RhdGVGcm9tVXBkYXRlcyhhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcyk7CmZvciAobGV0IGlkIGluIGFiQ29uZmlnTGF0ZXN0U3RhdGUpIHsKICAgIGRlbGV0ZSBhYkNvbmZpZ0xhdGVzdFN0YXRlW2lkXS50YWdzLmJhc2VBQjsgLy8gYmFzZUFCIGlzIGFuIGFubm95aW5nIHRhZyB0aGF0IHNob3VsZCBub3QgYmUgY29tcHV0ZWQgYXMgcGFydCBvZiBoYXNoIHN0YXRlLgp9CmNvbnN0IGFiQ29uZmlnTGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiQ29uZmlnTGF0ZXN0U3RhdGUpOwoKaWYgKGRldGFpbGVkKSB7CiAgICBhYkZpbGVDaGVja3MucHVzaCh7CiAgICAgICAgZmlsZU5hbWU6ICdhYkNvbmZpZycsCiAgICAgICAgY3VycmVudEhhc2g6IGFiQ29uZmlnQ3VycmVudEhhc2gsCiAgICAgICAgbGF0ZXN0SGFzaDogYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIHJlbW92ZWQ6IGZhbHNlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoLAogICAgICAgIGxhdGVzdFVwZGF0ZXM6IGFiQ29uZmlnUmVzcG9uc2UuZGF0YS51cGRhdGVzLAogICAgICAgIGxhdGVzdFN0YXRlOiBhYkNvbmZpZ0xhdGVzdFN0YXRlLAogICAgfSkKfQoKaWYgKCFkZXRhaWxlZCAmJiAoYWJDb25maWdDdXJyZW50SGFzaCAhPT0gYWJDb25maWdMYXRlc3RIYXNoKSkgewogICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgaW4gc2ltcGxlIG1vZGUsIHJldHVybiByaWdodCBhd2F5IG9uIHRoZSBmaXJzdCBvdXRkYXRlZCBmaWxlIGRpc2NvdmVyeS4KICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHVwZGF0ZUF2YWlsYWJsZTogdHJ1ZSB9Cn0KCi8vIDIuIENoZWNrIGlmIGFiIHNraWxscyBhcmUgb3V0ZGF0ZWQuCmNvbnN0IGFiU2tpbGxOYW1lcyA9IFsgJ2FiQ29yZScsIC4uLnRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKSBdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhYlNraWxsTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgIGNvbnN0IHNraWxsTmFtZSA9IGFiU2tpbGxOYW1lc1tpXTsKCiAgICBsZXQgc2tpbGxDdXJyZW50SGFzaDsKICAgIGlmIChza2lsbE5hbWUgPT09ICdhYkNvcmUnKSB7CiAgICAgICAgc2tpbGxDdXJyZW50SGFzaCA9IGFiLnRhZ3MuYWJDb3JlU291cmNlSGFzaDsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbG9hZGVkU2tpbGxCb3QgPSBnZXRCb3QoYiA9PiBiLnRhZ3MuYWJMb2FkZWRTa2lsbCA9PT0gc2tpbGxOYW1lICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsKICAgICAgICBhc3NlcnQobG9hZGVkU2tpbGxCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgbG9hZGVkIHNraWxsIGJvdCBmb3IgJHtza2lsbE5hbWV9LmApOwoKICAgICAgICBza2lsbEN1cnJlbnRIYXNoID0gbG9hZGVkU2tpbGxCb3QudGFncy5hYkxvYWRlZFNraWxsU291cmNlSGFzaDsKICAgIH0KICAgIAogICAgdHJ5IHsKICAgICAgICBjb25zdCBza2lsbE91dGRhdGVkID0gYXdhaXQgY2hlY2tTa2lsbE91dGRhdGVkKHNraWxsTmFtZSwgc2tpbGxDdXJyZW50SGFzaCk7CgogICAgICAgIGlmICghZGV0YWlsZWQgJiYgc2tpbGxPdXRkYXRlZCkgewogICAgICAgICAgICAvLyBJZiB3ZSBhcmUgcnVubmluZyBpbiBzaW1wbGUgbW9kZSwgcmV0dXJuIHJpZ2h0IGF3YXkgb24gdGhlIGZpcnN0IG91dGRhdGVkIGZpbGUgZGlzY292ZXJ5LgogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCB1cGRhdGVBdmFpbGFibGU6IHRydWUgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2ggYW4gZXJyb3IuYCwgZSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9CgppZiAoZGV0YWlsZWQpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGFiRmlsZUNoZWNrcy5zb21lKGYgPT4gZi51cGRhdGVBdmFpbGFibGUpLAogICAgICAgIGFiRmlsZUNoZWNrcywKICAgIH0KfSBlbHNlIHsKICAgIC8vIElmIHdlIG1hZGUgaXQgYWxsIHRoZSB3YXkgaGVyZSBpbiBzaW1wbGUgbW9kZSwgdGhlcmUgYXJlIG5vIG91dGRhdGVkIGZpbGVzLgogICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgdXBkYXRlQXZhaWxhYmxlOiBmYWxzZSB9Cn0nAKe/uq0IAARncmlkAgQAp7+6rQiXLCjwn5SXMDI4MzY1YTQtMDM2Zi00MWQwLTlhZjEtNzE1YWQ0ZjJhYTdhJwCnv7qtCAASYWJDb3JlTWFqb3JWZXJzaW9uAgQAp7+6rQi+LAIxMCcAp7+6rQgAEmFiQ29yZU1pbm9yVmVyc2lvbgIEAKe/uq0IwSwCNDEnAKe/uq0IAAZzeXN0ZW0CBACnv7qtCMQsDWFiLmNvcmUubGVhcm4nAKe/uq0IAARhYklEAgQAp7+6rQjSLAVsZWFybicAp7+6rQgABGZvcm0CBACnv7qtCNgsB25vdGhpbmcnAKe/uq0IAAZhYkJvb3QCBACnv7qtCOAsyCpALyoqCiogTUlUIExpY2Vuc2UKKgoqIENvcHlyaWdodCAoYykgMjAxOSBDYXN1YWwgU2ltdWxhdGlvbiwgSW5jLgoqCiogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQoqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwoqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoqCiogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KKgoqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCiogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksCiogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgoqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sCiogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKKiBTT0ZUV0FSRS4KKiBAbGljZW5zZSBNSVQKKi8KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvb3RpbmcgYWJgKTsKfQoKLy9pbnN0IG1vZGUgKHBsYXllciBvciBidWlsZGVyKQpsZXQgaW5zdE1vZGVDaGVjayA9IGF3YWl0IG9zLnZlcnNpb24oKS5wbGF5ZXJNb2RlOwovL2NoZWNrIHNlbGYgZm9yIGluaXRpYWwgYm9vdCBkYXRhCmxldCBpbml0aWFsQm9vdCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuaW5pdGlhbEJvb3QgPyB0cnVlIDogZmFsc2U7Ci8vY2hlY2sgdXJsIGZvciBwb3NzaWJsZSBhYidzIHRvIGxvYWQKbGV0IGJvb3RGbGFnID0gY29uZmlnQm90LnRhZ3MucGF0dGVybiA/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gOiBjb25maWdCb3QudGFncy5hYjsKLy9jaGVjayBmb3IgYXNrCmxldCBhc2sgPSBjb25maWdCb3QudGFncy5hc2s7Ci8vbG9naW4KbGV0IHN0YXR1cyA9IGF3YWl0IHRoaXNCb3QubG9hZGluZ1N0YXR1cygpOwovL3NlZWQgKG5vdCBhY3RpdmVseSB1c2VkIGhlcmUpCmxldCBzZWVkID0gY29uZmlnQm90LnRhZ3Muc2VlZDsKLy9wcm9tcHQKbGV0IHByb21wdCA9IGNvbmZpZ0JvdC50YWdzLnByb21wdDsKLy9jaGFubmVsCmxldCBjaGFubmVsID0gY29uZmlnQm90LnRhZ3MuY2hhbm5lbDsKLy91dWFiCmxldCB1dWFiID0gY29uZmlnQm90LnRhZ3MuYXV4bGluayA9PSAidXVhYiI7Ci8vdmVyc2lvbgpsZXQgdmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbjsKLy9yZXF1ZXN0IGF1dGggYm90CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgovL3JlZGlyZWN0IGlmIGluIFVSTAppZiAoY29uZmlnQm90LnRhZ3Muam9pbkNvZGUpIHsKICAgIHRoaXNCb3QuYWJKb2luSG9zdCh7IHRleHQ6IGNvbmZpZ0JvdC50YWdzLmpvaW5Db2RlIH0pOwp9CgovL3N0YXR1cyBjbGVhbiB1cApkZXN0cm95KHN0YXR1cyk7CgovL2NoZWNrIHRpbWUgaWYgbmVlZGVkCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29uZGl0aW9uKSB7CiAgICBhd2FpdCBsaW5rcy5yZW1lbWJlci5hYkNvbmRpdGlvbigpOwp9CgovL2lmIG5vIHN0dWRpbywgc2V0IHN0dWRpbwppZiAoYXV0aEJvdCAmJiAhY29uZmlnQm90LnRhZ3Muc3R1ZGlvKSB7CiAgICBjb25maWdCb3QudGFncy5zdHVkaW8gPSBhdXRoQm90LmlkOwp9Cgp0aGlzQm90LmFiUmVmcmVzaFN0dWRpb3MoKTsKdGhpc0JvdC5hYlJlZnJlc2hBSU1vZGVscygpOwoKaWYgKCFsaW5rcy5wZXJzb25hbGl0eSkgeyAKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJQZXJzb25hbGl0eSIpOwp9CgovL2luaXRpYWxpemUgcmVtZW1iZXIgZ2xvYmFscwpnbG9iYWxUaGlzLmFiSW5zdE1lbW9yeSA9IGxpbmtzLnJlbWVtYmVyOwpnbG9iYWxUaGlzLmFiUmVtZW1iZXIgPSBsaW5rcy5yZW1lbWJlcjsKZ2xvYmFsVGhpcy5hYlBlcnNvbmFsaXR5ID0gbGlua3MucGVyc29uYWxpdHk7CgppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VHcmlkUG9ydGFsQ29sb3IpIHsKICAgIGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yOwp9CgovL1RoaXMgY2hlY2tzIGZvciB0aGUgYXBwcm9wcmlhdGUgYXJyYXkgb2Ygc2tpbGxzIGFuZCBpbml0aWFsaXplcyB0aGVtCmF3YWl0IHRoaXNCb3QuYWJTa2lsbEluaXRpYWxpemF0aW9uKGluc3RNb2RlQ2hlY2spOwoKLy9pbml0aWFsaXppbmcgb2YgZ2xvYmFsIHZhcmlhYmxlcwpnbG9iYWxUaGlzLmJ1aWxkZXJWZXJzaW9uID0gaW5zdE1vZGVDaGVjayA9PSAiYnVpbGRlciIgPyB0cnVlIDogZmFsc2U7Cmdsb2JhbFRoaXMuYWJMb25nVGVybU1lbW9yeVNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlNlYXJjaCA9IGxpbmtzLnNlYXJjaDsKZ2xvYmFsVGhpcy5hYlB1Ymxpc2ggPSBsaW5rcy5zdG9yZTsKZ2xvYmFsVGhpcy5hYlN0b3JlID0gbGlua3Muc3RvcmU7Cmdsb2JhbFRoaXMuYWIgPSB0aGlzQm90OwoKLy9jaGVjayBmb3IgdXVhYnMKaWYgKHV1YWIpIHsKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbih7bWVzc2FnZTogY29uZmlnQm90LnRhZ3MudXVhYiwgaXNVVUFCOiB0cnVlfSk7Cn0KLy9jaGVjayBmb3IgY2hhbm5lbCBpZiBjaGFubmVscyBhbGxvd2VkCmVsc2UgaWYgKGNoYW5uZWwgJiYgbGlua3MucmVtZW1iZXIudGFncy5hbGxvd0NoYW5uZWxzKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oe21lc3NhZ2U6IGNoYW5uZWwsIGlzQ2hhbm5lbDogdHJ1ZX0pOwp9IGVsc2UgewogICAgLy9wb3B1bGF0ZSBib290ZmxhZyBhYgogICAgaWYgKGluaXRpYWxCb290ICYmIGJvb3RGbGFnKSB7CiAgICAgICAgYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogYm9vdEZsYWcsIGluaXRpYWxCb290OiB0cnVlLCBhdXRvSGF0Y2g6IHRydWUsIHNvdXJjZUV2ZW50OiAnYm9vdCcsIGFiVmVyc2lvbjogdmVyc2lvbn0pOwogICAgfQoKICAgIC8vbG9va3VwIGFza0lEIGlmIGF2YWlsYWJsZQogICAgaWYgKGluaXRpYWxCb290ICYmIGFzaykgewogICAgICAgIGlmIChhc2sgPT0gImVnZ0NhcnRvbiIgfHwgYXNrID09ICJjYXN1YWxUdXRvcmlhbCIpIHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KGFzayk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoImFiQWN0aW9uIik7CgogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2spOwogICAgICAgIH0KICAgIH0KfQoKLy9jaGVjayBmb3IgYXJ0aWZhY3QgRklYCmlmIChjb25maWdCb3QudGFncy5hcnRpZmFjdCAmJiBpbml0aWFsQm9vdCAmJiAhYXNrICYmICFib290RmxhZykgewogICAgY29uc3QgYXJ0aWZhY3QgPSBjb25maWdCb3QudGFncy5hcnRpZmFjdDsKICAgIGNvbnN0IGFydEluZGV4ID0gYXJ0aWZhY3QuaW5kZXhPZigiX2FydF8iKTsKICAgIGNvbnN0IHN0dWRpbyA9IGFydGlmYWN0LnN1YnN0cmluZygwLCBhcnRJbmRleCk7CiAgICBjb25zdCByZWNvcmRBZGRyZXNzID0gYXJ0aWZhY3Quc3Vic3RyaW5nKGFydEluZGV4KTsKICAgIGNvbnN0IHJlY29yZERhdGEgPSBhd2FpdCBvcy5nZXREYXRhKHN0dWRpbywgcmVjb3JkQWRkcmVzcyk7CiAgICBjb25zdCBhc2tJRCA9IHJlY29yZERhdGEuZGF0YS5wYXR0ZXJuOwoKICAgIGF3YWl0IHRoaXNCb3QuYWJBZGFwdCgiYWJBY3Rpb24iKTsKCiAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJRCk7Cn0KCi8vIENoZWNrIGlmIHdlIGNhbiB3YWtlIHVwIGFiLCBhbmQgdGhlbiBkbyBzby4KaWYgKCFjb25maWdCb3QudGFncy5hYlNsZWVwKSB7CiAgICBpZiAoKGluaXRpYWxCb290ICYmICFib290RmxhZyAmJiAhYXNrKSB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWx3YXlzU3RhcnRBd2FrZSB8fCBjb25maWdCb3QudGFncy5hYlN0YXlBd2FrZSkgewogICAgICAgIGF3YWl0IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlLCBpbml0aWFsOiBpbml0aWFsQm9vdCB9KTsKICAgIH0KfQoKLy9zZXQgaW5pdGlhbCBib290IGRhdGEKaWYgKGluaXRpYWxCb290KSB7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnJlbWVtYmVyLCAnaW5pdGlhbEJvb3QnLCBmYWxzZSwgJ3NoYXJlZCcpOwoKICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbGl6YXRpb25Db25maWd1cmF0aW9uKSB7CiAgICAgICAgbGlua3MucmVtZW1iZXIuYWJJbml0aWFsaXphdGlvbkNvbmZpZ3VyYXRpb24oKTsKICAgIH0KfQoKLy9jbGVhbiB1cCBVUkwgd2l0aCB0YWdQb3J0YWwKaWYgKGNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbCAmJiAhY29uZmlnQm90LnRhZ3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgJiYgYnVpbGRlclZlcnNpb24pIHsKICAgIGNvbmZpZ0JvdC50YWdzLnRhZ1BvcnRhbCA9IG51bGw7CiAgICBjb25maWdCb3QudGFncy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cn0KCi8vcGF1c2UgZm9yIGFiIGxvYWRpbmcKYXdhaXQgb3Muc2xlZXAoNTAwKTsKCi8vaW5pdGlhbGl6ZSB0aW1lIGJvdAp0aGlzQm90LmFiVGltZXIoKTsKCnRoaXNCb3QuYWJDcmVhdGVVcGRhdGVDaGVja2VyKCk7CgovL2luaXRpYWxpemF0aW9uIHNob3V0CnN1cGVyU2hvdXQoIm9uQUJJbml0aWFsaXplZCIsIHRhZ3MuYWJJbnN0KTsnAKe/uq0IABBvbkFCQXV0aEJvdEFkZGVkAgQAp7+6rQipVzlAdGhpc0JvdC5hYlJlZnJlc2hTdHVkaW9zKCk7CnRoaXNCb3QuYWJSZWZyZXNoQUlNb2RlbHMoKTsnAKe/uq0IABJvbkFCQXV0aEJvdFJlbW92ZWQCBACnv7qtCONXOUB0aGlzQm90LmFiUmVmcmVzaFN0dWRpb3MoKTsKdGhpc0JvdC5hYlJlZnJlc2hBSU1vZGVscygpOycAp7+6rQgAEGFiUmVmcmVzaFN0dWRpb3MCBACnv7qtCJ1YpQFAaWYgKGF1dGhCb3QpIHsKICAgIGNvbnN0IHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7CiAgICBjb25maWdCb3QudGFncy51c2VyX3N0dWRpb3MgPSB1c2VyU3R1ZGlvczsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvcyA9IG51bGw7Cn0nAKe/uq0IABFhYlJlZnJlc2hBSU1vZGVscwIEAKe/uq0Iw1maAUBpZiAoYXV0aEJvdCkgewogICAgY29uc3QgbW9kZWxzID0gYXdhaXQgYWkubGlzdENoYXRNb2RlbHMoKTsKICAgIGNvbmZpZ0JvdC50YWdzLmFpQ2hhdE1vZGVscyA9IG1vZGVsczsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLmFpQ2hhdE1vZGVscyA9IG51bGw7Cn0oAKe/uq0IAAZhYkNvcmUBeCcAp7+6rQgAB2FiQWRhcHQCBACnv7qtCN9avhRAbGV0IHNraWxsTmFtZTsKbGV0IHNraWxsRGF0YTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHNraWxsTmFtZSA9IHRoYXQ7CiAgICBza2lsbERhdGEgPSBudWxsOwp9IGVsc2UgaWYgKHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JykgewogICAgc2tpbGxOYW1lID0gdGhhdC5zeXN0ZW1JRCA/PyB0aGF0LnNraWxsTmFtZTsKICAgIHNraWxsRGF0YSA9IHRoYXQuZGF0YSA/PyBudWxsOwp9CgppZiAoIXNraWxsTmFtZSkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraWxsTmFtZSBpcyByZXF1aXJlZC5gKTsKICAgIHJldHVybiBmYWxzZTsKfQoKaWYgKHNraWxsTmFtZSA9PT0gJ2FiQ29yZScpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9fV0gYWJDb25maWcgY2Fubm90IGJlIGxvYWRlZCB1c2luZyBhYkFkYXB0LmApOwogICAgcmV0dXJuOwp9Cgp0cnkgewogICAgY29uc3QgbG9hZGVkU2tpbGxzID0gdGhpc0JvdC5hYkxvYWRlZFNraWxscygpOwoKICAgIGlmICghbG9hZGVkU2tpbGxzLmluY2x1ZGVzKHNraWxsTmFtZSkpIHsKICAgICAgICBjb25zdCB1cmwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOwogICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICJHRVQiLCB1cmwgfSk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWIgc2tpbGwgR0VUIHJlc3BvbnNlOmAsIHJlc3BvbnNlKTsKICAgICAgICB9CgogICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgIT09IDIwMCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCAke3NraWxsTmFtZX0uIFJlc3BvbnNlOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAKICAgICAgICBpZiAocmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyKSB7CiAgICAgICAgICAgIC8vIEFVWCBGb3JtYXQgVmVyc2lvbiAyLgogICAgICAgICAgICBjb25zdCB1cGRhdGVzID0gcmVzcG9uc2UuZGF0YS51cGRhdGVzOwogICAgICAgICAgICBhd2FpdCBvcy5hcHBseVVwZGF0ZXNUb0luc3QodXBkYXRlcyk7CiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gYXdhaXQgb3MuZ2V0SW5zdFN0YXRlRnJvbVVwZGF0ZXModXBkYXRlcyk7CiAgICAgICAgICAgIGNvbnN0IHNvdXJjZUhhc2ggPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBzdGF0ZSk7CgogICAgICAgICAgICAvLyBMb2FkZWQgc2tpbGxzIGFyZSBzdG9yZWQgYXMgc2hhcmVkIGJvdHMgdGhhdCBhbnlvbmUgaW4gdGhlIGluc3QgY2FuIHJlYWQuCiAgICAgICAgICAgIGNyZWF0ZSh7CiAgICAgICAgICAgICAgICBzcGFjZTogJ3NoYXJlZCcsCiAgICAgICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgICAgIGFiTG9hZGVkU2tpbGw6IHNraWxsTmFtZSwKICAgICAgICAgICAgICAgIGFiTG9hZGVkU2tpbGxTb3VyY2VIYXNoOiBzb3VyY2VIYXNoLAogICAgICAgICAgICAgICAgZm9ybTogJ25vdGhpbmcnLAogICAgICAgICAgICB9KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBBVVggZm9ybWF0IHZlcnNpb24gJHtyZXNwb25zZS5kYXRhLnZlcnNpb259IGlzIG5vdCBzdXBwb3J0ZWQuYCk7CiAgICAgICAgfQoKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYiBza2lsbCAke3NraWxsTmFtZX0gaXMgYWxyZWFkeSBsb2FkZWQuYCkKICAgICAgICB9CiAgICB9CgogICAgY29uc3Qgc2tpbGxCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFnc1tza2lsbE5hbWVdID09PSB0cnVlKTsKICAgIGlmIChza2lsbEJvdHMgJiYgc2tpbGxCb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICB3aGlzcGVyKHNraWxsQm90cywgdGFnTmFtZSwgY29uZmlnQm90LnRhZ3MuaW5zdCk7CiAgICAgICAgd2hpc3Blcihza2lsbEJvdHMsICJvblNraWxsVXBkYXRlIiwgeyBkYXRhOiBza2lsbERhdGEgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBObyBib3RzIGFwcGVhciB0byBoYXZlIGJlZW4gbG9hZGVkIHdpdGggJHtza2lsbE5hbWV9LmApOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKfSBjYXRjaCAoZSkgewogICAgY29uc29sZS5lcnJvcihlKTsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBGYWlsZWQgdG8gZG93bmxvYWQgJHtza2lsbE5hbWV9LiBTZWUgYWJvdmUgZXJyb3IuYCk7CiAgICByZXR1cm4gZmFsc2U7Cn0nAKe/uq0IAAtkZXNjcmlwdGlvbgIEAKe/uq0Inm9PVGhpcyBza2lsbCBpcyBkZXNpZ25lZCB0byBoYW5kbGUgYm90aCByZWNvbmZpZ3VyYXRpb24gb2YgYWIgYW5kIGluaXRpYWxpemF0aW9uLicAp7+6rQgACm9uQm90QWRkZWQCBACnv7qtCO5v8QFAY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvcmUgU1RBUlQgVVBgKTsKCnRoaXNCb3QuYWJJbnN0VXBkYXRlKCk7CgppZiAoIWxpbmtzLnJlbWVtYmVyKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGZpbmQgYWJDb25maWcgcmVtZW1iZXIgYm90LmApOwp9CgpzZXRUaW1lb3V0KCgpID0+IHRoaXNCb3QuYWJCb290KCksIDUwMCk7JwCnv7qtCAAIcmVtZW1iZXICBACnv7qtCOBxKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAKe/uq0IAANsb2cCBACnv7qtCIdybEAvL3Bhc3MgdGhyb3VnaCBsb2cgZGF0YQppZiAobGlua3MuY29uc29sZSkgewogICAgbGlua3MuY29uc29sZS5sb2codGhhdCk7Cn0KZWxzZSB7CiAgICBjb25zb2xlLmxvZyh0aGF0KTsKfScAp7+6rQgADW1hbmlmZXN0YXRpb24CBACnv7qtCPRyKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAKe/uq0IAAxhYkNyZWF0ZUhvc3QCBACnv7qtCJtz1A1AY29uc3Qgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CgovL3RoaXMgZnVuY3Rpb24gaGFuZGxlcyBjcmVhdGluZyBhIGZpbGUgZm9yIGpvaW4gY29kZXMKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSB7CiAgICBjb25zdCBqb2luVVJMID0gc2l0ZU9yaWdpbiArICIvP2pvaW5Db2RlPSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRDsKICAgIG9zLnNldENsaXBib2FyZChqb2luVVJMKTsKICAgIG9zLnNob3dRUkNvZGUoam9pblVSTCk7CiAgICBhYi5saW5rcy51dGlscy5hYlRvYXN0KGB1cmwgY29waWVkIHRvIGNsaXBib2FyZGApOwogICAgcmV0dXJuOwp9CgppZiAoIWF1dGhCb3QpIHsKICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7Cn0KCmlmICghYXV0aEJvdCkgewogICAgYWIubGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgcGxlYXNlIGxvZyBpbiB0byBnZW5lcmF0ZSBhIGpvaW4gY29kZWApOwogICAgcmV0dXJuOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZUpvaW5Db2RlKCkgewogICAgY29uc3QgY2hhcnMgPSAnQUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVoxMjM0NTY3ODknOwogICAgbGV0IGNvZGUgPSAnJzsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNjsgaSsrKSB7CiAgICAgICAgY29uc3QgcmFuZG9tSW5kZXggPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBjaGFycy5sZW5ndGgpOwogICAgICAgIGNvZGUgKz0gY2hhcnNbcmFuZG9tSW5kZXhdOwogICAgfQogICAgcmV0dXJuIGNvZGU7Cn0KCmNvbnN0IG5ld0pvaW5Db2RlID0gZ2VuZXJhdGVKb2luQ29kZSgpOwpjb25zdCBkYXRlID0gb3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZTsKY29uc3QgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCi8vIFtSeWFuIENvb2tdOiBUaGlzIGlzIGEgbmFpdmUgcm9vbSBjb2RlIGdlbmVyYXRvci4gSXQgZG9lcyBub3QgY2hlY2sgaWYgdGhlIHJvb20gY29kZSBpcyBhbHJlYWR5IHRha2VuIC8gYWN0aXZlLgpjb25zdCByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YShyZWNvcmRLZXksIGBhYkpvaW5Db2RlXyR7bmV3Sm9pbkNvZGV9YCwgeyB1cmw6IGNvbmZpZ0JvdC50YWdzLnVybCwgZGF0ZSB9LCB7IG1hcmtlcnM6IFsicHVibGljUmVhZCJdIH0pOwoKaWYgKHJlY29yZERhdGEuc3VjY2VzcykgewogICAgc2V0VGFnTWFzayhsaW5rcy5yZW1lbWJlciwgJ2hvc3RJRCcsIG5ld0pvaW5Db2RlLCAnc2hhcmVkJyk7CgogICAgY29uc3Qgam9pblVSTCA9IHNpdGVPcmlnaW4gKyAiLz9qb2luQ29kZT0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQ7CgogICAgb3Muc2V0Q2xpcGJvYXJkKGpvaW5VUkwpOwoKICAgIGlmICh0aGF0ICYmIHRoYXQudGFncykgewogICAgICAgIHRoYXQudGFncy5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBuZXdKb2luQ29kZTsKICAgIAogICAgfQogICAgb3Muc2hvd1FSQ29kZShqb2luVVJMKTsKCiAgICBhYi5saW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBqb2luIGNvZGUgZ2VuZXJhdGVkOiAke25ld0pvaW5Db2RlfS4gdXJsIGNvcGllZCB0byBjbGlwYm9hcmQuYCk7Cn0KZWxzZSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBmYWlsZWQgdG8gZ2VuZXJhdGUgam9pbiBjb2RlLCBwbGVhc2UgdHJ5IGFnYWluLmApOwogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKfScAp7+6rQgACmFiSm9pbkhvc3QCBACnv7qtCPCAAawKQC8vbG9naWMgZm9yIHVzaW5nIGEgam9pbiBjb2RlIChjaGVja3MgZm9yIGV4aXN0aW5nIGZpbGVzKQpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKbGV0IGdldFJlY29yZDsKCmlmICh0aGF0LmRhdGEpIHsKICAgIGdldFJlY29yZCA9IHsgc3VjY2VzczogdHJ1ZSwgZGF0YTogdGhhdC5kYXRhIH07Cn0gZWxzZSB7CiAgICBjb25zdCBqb2luQ29kZSA9IHRoYXQudGV4dC50b1VwcGVyQ2FzZSgpOwogICAgY29uc3QgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gam9pbiBjb2RlOmAsIGpvaW5Db2RlKQogICAgfQoKICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBgYWJKb2luQ29kZV8ke2pvaW5Db2RlfWApOwp9CgppZiAoZ2V0UmVjb3JkICYmIGdldFJlY29yZC5zdWNjZXNzKSB7CiAgICBjb25zdCBub3dUaW1lID0gb3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZTsKICAgIGNvbnN0IG5vd0RhdGUgPSBEYXRlVGltZS5mcm9tTWlsbGlzKG5vd1RpbWUpOwogICAgY29uc3QgY3JlYXRlRGF0ZSA9IERhdGVUaW1lLmZyb21NaWxsaXMoZ2V0UmVjb3JkLmRhdGEuZGF0ZSk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG5vd1RpbWU6YCwgbm93VGltZSwgYG5vd0RhdGU6YCwgbm93RGF0ZSwgYGNyZWF0ZURhdGU6YCwgY3JlYXRlRGF0ZSk7CiAgICB9CgogICAgbGV0IGRpZmZlcmVuY2UgPSBub3dEYXRlLmRpZmYoY3JlYXRlRGF0ZSwgImRheXMiKS50b09iamVjdCgpOwogICAgZGlmZmVyZW5jZSA9IE1hdGguZmxvb3IoZGlmZmVyZW5jZS5kYXlzKTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGlmZmVyZW5jZSAoZGF5cyk6YCwgZGlmZmVyZW5jZSk7CiAgICB9CiAgICAKICAgIGlmIChkaWZmZXJlbmNlIDwgOCkgewogICAgICAgIG9zLnRvYXN0KCJqb2luaW5nIGhvc3Qgbm93Iik7CiAgICAgICAgb3MuZ29Ub1VSTChnZXRSZWNvcmQuZGF0YS51cmwpOwogICAgfSBlbHNlIHsKICAgICAgICBvcy50b2FzdCgiam9pbiBjb2RlIG91dCBvZiBkYXRlLCBwbGVhc2UgZ2VuZXJhdGUgYSBuZXcgam9pbiBjb2RlIik7CiAgICB9Cn0gZWxzZSB7CiAgICBvcy50b2FzdCgiam9pbiBjb2RlIGludmFsaWQsIHBsZWFzZSB0cnkgYWdhaW4iKTsKfScAp7+6rQgABnNlYXJjaAIEAKe/uq0InYsBKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAKe/uq0IAAhhYklnbm9yZQIEAKe/uq0IxIsBBHRydWUnAKe/uq0IAARtZW51AgQAp7+6rQjJiwEo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAp7+6rQgAFWFiU2tpbGxJbml0aWFsaXphdGlvbgIEAKe/uq0I8IsBowJALy9GaW5kIHRoZSBhcHByb3ByaWF0ZSBhcnJheSBhbmQgcG9wdWxhdGUgc2tpbGxzCmxldCBza2lsbEFycmF5ID0gbGlua3MucmVtZW1iZXIudGFnc1t0aGF0ICsgIlNraWxsQXJyYXkiXTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc2tpbGxBcnJheS5sZW5ndGg7IGkrKykgewogICAgYXdhaXQgdGhpc0JvdC5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwp9CgppZiAoY29uZmlnQm90LnRhZ3MuZW1iZWQgPT09ICdpb3MnKSB7CiAgICBhd2FpdCB0aGlzQm90LmFiQWRhcHQoJ2FiSU9TQnJpZGdlJyk7Cn0KCnJldHVybjsnAKe/uq0IAAZiYW5uZXICBACnv7qtCJSOASjwn5SXYjU1MmVhZjktYTlkNi00MWM4LTg1MTUtY2JkMmFiZWFhZTczJwCnv7qtCAAFaW5wdXQCBACnv7qtCLuOASjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwCnv7qtCAANbG9hZGluZ1N0YXR1cwIEAKe/uq0I4o4BxgdAY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJMb2FkU3RhdHVzIjsKCmxldCBzdGF0dXNCb3QgPSB7fTsKCnN0YXR1c0JvdC5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwpzdGF0dXNCb3QubGFiZWwgPSAidmVyaWZ5aW5nIGF1dGhCb3QiOwpzdGF0dXNCb3QubGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CnN0YXR1c0JvdC5hYkxvYWRTdGF0dXMgPSB0cnVlOwpzdGF0dXNCb3QubWVudUl0ZW1TdHlsZSA9IHsgImJhY2tncm91bmQiOiAibm9uZSIgfTsKc3RhdHVzQm90LnRyYWNrTnVtID0gMDsKc3RhdHVzQm90Lm9uQ3JlYXRlID0gYEAKICAgIGlmICh0YWdzLnRyYWNrTnVtID09IDIpIHsKICAgICAgICB0YWdzLnRyYWNrTnVtID0gMDsKICAgIH0KICAgIGVsc2UgewogICAgICAgIHRhZ3MudHJhY2tOdW0rKzsKICAgIH0KCiAgICB0YWdzLmxhYmVsID0gdGFnc1sibGFiZWwiK3RhZ3MudHJhY2tOdW1dOwogICAgdGFncy5mb3JtQWRkcmVzcyA9IHRhZ3NbImZvcm0iK3RhZ3MudHJhY2tOdW1dOwoKICAgIHNldFRpbWVvdXQoKCkgPT4gd2hpc3Blcih0aGlzQm90LCAib25DcmVhdGUiKSwgNTAwKTtgOwpzdGF0dXNCb3QubGFiZWwwID0gInZlcmlmeWluZyBhdXRoQm90LiI7CnN0YXR1c0JvdC5sYWJlbDEgPSAidmVyaWZ5aW5nIGF1dGhCb3QuLiI7CnN0YXR1c0JvdC5sYWJlbDIgPSAidmVyaWZ5aW5nIGF1dGhCb3QuLi4iOwpzdGF0dXNCb3QuZm9ybTAgPSAiaG91cmdsYXNzX2JvdHRvbSI7CnN0YXR1c0JvdC5mb3JtMSA9ICJob3VyZ2xhc3NfdG9wIjsKc3RhdHVzQm90LmZvcm0yID0gImhvdXJnbGFzc19ib3R0b20iOwpzdGF0dXNCb3Qub25EZXN0cm95ID0gYEAKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKYDsKCmxldCBjcmVhdGVkU3RhdHVzQm90ID0gY3JlYXRlKHN0YXR1c0JvdCk7CgpyZXR1cm4gY3JlYXRlZFN0YXR1c0JvdDsnAKe/uq0IAANhc2sCBACnv7qtCKmWASjwn5SXZWM4NWMxZDYtOWYxYS00MGQ0LTgyZTEtNWJkNjgwMzQ5YzI3JwCnv7qtCAAHYWJUaW1lcgIEAKe/uq0I0JYBwQZAaWYgKGdldEJvdCgiYWJUaW1lciIsIHRydWUpKSB7CiAgICByZXR1cm47Cn0KCmlmICghdGFncy5hYlhQKSB7CiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKfQoKbGV0IHRpbWVyQm90ID0ge307Cgp0aW1lckJvdC5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwp0aW1lckJvdC5tYW5hZ2VyID0gZ2V0TGluayh0aGlzQm90KTsKdGltZXJCb3Qub25DcmVhdGUgPSBgQAogICAgbWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzQm90Lm9uVGltZUNoZWNrKCksIDYwMDAwKTsKYDsKdGltZXJCb3QuYWJUaW1lciA9IHRydWU7CnRpbWVyQm90Lm9uVGltZUNoZWNrID0gYEAKICAgIGlmICh0YWdzLm5vdElkbGUpIHsKICAgICAgICB0YWdzLm5vdElkbGUgPSBmYWxzZTsKCiAgICAgICAgLy9jb25zb2xlLmxvZygiWFAiLCBsaW5rcy5tYW5hZ2VyLnRhZ3MuYWJYUCk7CgogICAgICAgIGNvbnN0IHRvdGFsWFAgPSBsaW5rcy5tYW5hZ2VyLnRhZ3MuYWJYUCArIDE7CgogICAgICAgIHNldFRhZ01hc2sobGlua3MubWFuYWdlciwgImFiWFAiLCB0b3RhbFhQLCAibG9jYWwiKTsKICAgIH0KYDsKdGltZXJCb3Qubm90SWRsZSA9IGZhbHNlOwp0aW1lckJvdC5vbkFueUFjdGlvbiA9IGBACiAgICBpZiAoIXRhZ3Mubm90SWRsZSkgewogICAgICAgIGlmICh0aGF0LmFjdGlvbi5pZCA9PSBncmlkUG9ydGFsQm90LmlkKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5ub3RJZGxlID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CmA7CgpsZXQgYWJUaW1lciA9IGNyZWF0ZSh0aW1lckJvdCk7CgpnbG9iYWxUaGlzLmFiVGltZXIgPSBhYlRpbWVyOycAp7+6rQgABXN0b3JlAgQAp7+6rQiSnQEo8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicAp7+6rQgAB2NvbnNvbGUCBACnv7qtCLmdASjwn5SXMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViJwCnv7qtCAAJYWJWZXJzaW9uAgQAp7+6rQjgnQEFMTAuNDEnAKe/uq0IABdhYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTAIEAKe/uq0I5p0B/wFAY29uc3QgcmVsYXRpdmVQYXRoID0gdGhhdDsKCmNvbnN0IHVybCA9IG5ldyBVUkwobGlua3MucmVtZW1iZXIudGFncy5jYXN1YWxDYXRhbG9nVVJMKTsKY29uc3QgZW52ID0gbGlua3MucmVtZW1iZXIudGFncy5jYXN1YWxDYXRhbG9nRW52OwoKdXJsLnBhdGhuYW1lID0gcmVsYXRpdmVQYXRoOwoKaWYgKGVudiAmJiBlbnYgIT09ICdwcm9kJykgewogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ2VudicsIGVudik7Cn0KCnJldHVybiB1cmwuaHJlZjsnAKe/uq0IAAdjaGFubmVsAgQAp7+6rQjmnwEo8J+Ul2E5YjZhYTBkLWIzNTctNGRlNi05YmVmLTg1MzQ4YWIxZDBlMCcAp7+6rQgAC3BlcnNvbmFsaXR5AgQAp7+6rQiNoAEo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicAp7+6rQgADGFiSW5zdFVwZGF0ZQIEAKe/uq0ItKABogFALy8gVXBkYXRlIHRoZSBhYkluc3QgdGFnIHdoaWNoIHJlcHJlc2VudHMgdGhlIGluc3QgdGhhdCB0aGlzIGFiIGV4aXN0cyBpbi4KY29uc3QgY3VySW5zdCA9IG9zLmdldEN1cnJlbnRJbnN0KCk7CnNldFRhZ01hc2sodGhpc0JvdCwgJ2FiSW5zdCcsIGN1ckluc3QsICdzaGFyZWQnKTsnAKe/uq0IAAxvbkluc3RKb2luZWQCBACnv7qtCNehARhAdGhpc0JvdC5hYkluc3RVcGRhdGUoKTsnAKe/uq0IAAtvbkluc3RMZWF2ZQIEAKe/uq0I8KEBGEB0aGlzQm90LmFiSW5zdFVwZGF0ZSgpOycAp7+6rQgADHJlc2VydmVkQXNrcwIEAKe/uq0IiaIBDPCfp6xbImhvbWUiXScAp7+6rQgACGFydGlmYWN0AgQAp7+6rQiUogEo8J+Ulzc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNycAp7+6rQgAC2JvdF9mYWN0b3J5AgQAp7+6rQi7ogEo8J+Ul2M3OGFhNjYzLWQwNWMtNGVjNC1iYzJjLTI2ZmQ1MTU2MGI5NycAp7+6rQgABXV0aWxzAgQAp7+6rQjiogEo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAp7+6rQgACHVwZGF0ZUFCAgQAp7+6rQiJowHhKkBjb25zdCByZWxvYWRQYWdlID0gdGhhdD8ucmVsb2FkUGFnZSA/PyB0cnVlOw0KY29uc3Qgc2hvd0luZGljYXRvciA9IHRoYXQ/LnNob3dJbmRpY2F0b3IgPz8gdHJ1ZTsNCmNvbnN0IGRyeVJ1biA9IHRoYXQ/LmRyeVJ1biA/PyBmYWxzZTsNCg0KbGV0IGJ1c3lJbmRpY2F0b3I7DQoNCmlmIChzaG93SW5kaWNhdG9yKSB7DQogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAndXBkYXRlQUJNZW51JzsNCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgdXBkYXRlQUJNZW51OiB0cnVlLCBsYWJlbDogYHVwZGF0aW5nICR7bGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX1gIH0pOw0KfQ0KDQovLyBMZXQgYWxsIGJvdHMga25vdyB0aGF0IGFiIGlzIGFib3V0IHRvIHVwZGF0ZSBpdHNlbGYuDQphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJCZWZvcmVVcGRhdGUnKSk7DQoNCmxldCBvdmVyd3JpdGVSZXN1bHQ7DQoNCnRyeSB7DQogICAgLy8gVXBkYXRlIGFiQ29uZmlnLg0KICAgIGNvbnN0IGFiQ29uZmlnVVJMID0gb3MuZ2V0QUIxQm9vdHN0cmFwVVJMKCk7DQogICAgY29uc3QgYWJDb25maWdSZXNwb25zZSA9IGF3YWl0IHdlYmhvb2soeyBtZXRob2Q6ICJHRVQiLCB1cmw6IGFiQ29uZmlnVVJMIH0pOw0KDQogICAgYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2Uuc3RhdHVzID09PSAyMDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ291bGQgbm90IGRvd25sb2FkIGFiQ29uZmlnLiBSZXNwb25zZTogJHthYkNvbmZpZ1Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7DQogICAgYXNzZXJ0KGFiQ29uZmlnUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQ29uZmlnIG11c3QgYmUgaW4gYXV4IGZpbGUgZm9ybWF0IHYyLiBBY3R1YWwgYXV4IGZpbGUgZm9ybWF0IHZlcnNpb246ICR7YWJDb25maWdSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7DQoNCiAgICBvdmVyd3JpdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmF1eFYyT3ZlcndyaXRlKHsgYXV4OiBhYkNvbmZpZ1Jlc3BvbnNlLmRhdGEsIGdyb3VwVGFnOiAnYWJDb25maWcnLCBkcnlSdW4gfSk7DQogICAgc2V0VGFnTWFzayhhYi5saW5rcy5yZW1lbWJlciwgJ2FiQ29uZmlnU291cmNlSGFzaCcsIG92ZXJ3cml0ZVJlc3VsdC5zb3VyY2VIYXNoLCAnc2hhcmVkJyk7DQoNCiAgICAvLyBVcGRhdGUgYWIgc2tpbGxzLg0KICAgIGNvbnN0IGxvYWRlZFNraWxscyA9IHRoaXNCb3QuYWJMb2FkZWRTa2lsbHMoKTsNCg0KICAgIGZvciAobGV0IHNraWxsTmFtZSBvZiBsb2FkZWRTa2lsbHMpIHsNCiAgICAgICAgY29uc3Qgc2tpbGxVUkwgPSB0aGlzQm90LmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWIvJHtza2lsbE5hbWV9LmF1eGApOw0KDQogICAgICAgIC8vIFNraWxscyBjYW4gYmUgcmVzdHJ1Y3R1cmVkLCBtZWFuaW5nIHRoYXQgdGhleSBjb3VsZCBiZSByZW1vdmVkIGVudGlyZWx5IGluIHRoZSBmdXR1cmUuDQogICAgICAgIC8vIElmIGEgZmlsZSBmYWlscyB0byBiZSByZXRyaWV2ZWQsIHRoZW4gcmVtb3ZlIGFsbCB0aGUgYm90cyBpbiB0aGUgZ3JvdXAgaW4gdGhlIGluc3QuDQogICAgICAgIGxldCByZW1vdmVTa2lsbCA9IGZhbHNlOw0KICAgICAgICBsZXQgc2tpbGxSZXNwb25zZTsNCg0KICAgICAgICB0cnkgew0KICAgICAgICAgICAgc2tpbGxSZXNwb25zZSA9IGF3YWl0IHdlYmhvb2soeyBtZXRob2Q6ICJHRVQiLCB1cmw6IHNraWxsVVJMIH0pOw0KDQogICAgICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpbGxSZXNwb25zZTpgLCBza2lsbFJlc3BvbnNlKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgYXNzZXJ0KHNraWxsUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7c2tpbGxOYW1lfSBtdXN0IGJlIGluIGF1eCBmaWxlIGZvcm1hdCB2Mi4gQWN0dWFsIGF1eCBmaWxlIGZvcm1hdCB2ZXJzaW9uOiAke3NraWxsUmVzcG9uc2UuZGF0YS52ZXJzaW9ufWApOw0KDQogICAgICAgICAgICBpZiAoc2tpbGxSZXNwb25zZS5zdGF0dXMgIT09IDIwMCkgew0KICAgICAgICAgICAgICAgIGlmIChza2lsbFJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzIHx8IHNraWxsUmVzcG9uc2Uuc3RhdHVzID09PSA0MDQpIHsNCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlU2tpbGwgPSB0cnVlOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCAke3NraWxsTmFtZX0uIFJlc3BvbnNlOiAke3NraWxsUmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0gY2F0Y2ggKGUpIHsNCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYXVnaHQgZXJyb3Igd2hpbGUgZG93bmxvYWRpbmcgc2tpbGw6YCwgZSk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIGlmIChlLnJlc3BvbnNlPy5zdGF0dXMgPT09IDQwMyB8fCBlLnJlc3BvbnNlPy5zdGF0dXMgPT09IDQwNCkgew0KICAgICAgICAgICAgICAgIC8vIEZpbGUgZG9lc250IGV4aXN0IGFueW1vcmUsIHRoZSBza2lsbCBoYXMgYmVlbiByZW1vdmVkLg0KICAgICAgICAgICAgICAgIHJlbW92ZVNraWxsID0gdHJ1ZTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgdGhyb3cgZTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgaWYgKHNraWxsUmVzcG9uc2UgJiYgIXJlbW92ZVNraWxsKSB7DQogICAgICAgICAgICBvdmVyd3JpdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmF1eFYyT3ZlcndyaXRlKHsgYXV4OiBza2lsbFJlc3BvbnNlLmRhdGEsIGdyb3VwVGFnOiBza2lsbE5hbWUsIGRyeVJ1biB9KTsNCg0KICAgICAgICAgICAgY29uc3QgbG9hZGVkU2tpbGxCb3QgPSBnZXRCb3QoYiA9PiBiLnRhZ3MuYWJMb2FkZWRTa2lsbCA9PT0gc2tpbGxOYW1lICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsNCiAgICAgICAgICAgIGFzc2VydChsb2FkZWRTa2lsbEJvdCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb3VsZCBub3QgZmluZCBsb2FkZWQgc2tpbGwgYm90IGZvciAke3NraWxsTmFtZX0uYCk7DQogICAgICAgICAgICANCiAgICAgICAgICAgIHNldFRhZ01hc2sobG9hZGVkU2tpbGxCb3QsICdhYkxvYWRlZFNraWxsU291cmNlSGFzaCcsIG92ZXJ3cml0ZVJlc3VsdC5zb3VyY2VIYXNoLCAnc2hhcmVkJyk7DQogICAgICAgIH0gZWxzZSBpZiAocmVtb3ZlU2tpbGwpIHsNCiAgICAgICAgICAgIGNvbnN0IHNraWxsQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3Nbc2tpbGxOYW1lXSA9PT0gdHJ1ZSk7DQoNCiAgICAgICAgICAgIGlmIChkcnlSdW4pIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGRlbGV0ZSAke3NraWxsQm90cy5sZW5ndGh9ICR7c2tpbGxOYW1lfSBib3QocykgYmVjYXVzZSAke3NraWxsTmFtZX0gaXMgbm8gbG9uZ2VyIGluIHRoZSBjYXN1YWwgY2F0YWxvZy5gKQ0KICAgICAgICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICAgICAgfQ0KDQoNCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBTa2lsbCAke3NraWxsTmFtZX0gaXMgbm8gbG9uZ2VyIGluIHRoZSBjYXN1YWwgY2F0YWxvZy4gUmVtb3ZlICR7c2tpbGxCb3RzLmxlbmd0aH0gJHtza2lsbE5hbWV9IGJvdChzKSBmcm9tIGluc3QuYCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGRlc3Ryb3koc2tpbGxCb3RzKTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIC8vIFVwZGF0ZSBhYkNvcmUgKGRvIHRoaXMgb25lIGxhc3QhKQ0KICAgIGNvbnN0IGFiQ29yZVVSTCA9IHRoaXNCb3QuYWJCdWlsZENhc3VhbENhdGFsb2dVUkwoJy9hYi9hYkNvcmUuYXV4Jyk7DQogICAgY29uc3QgYWJDb3JlUmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogIkdFVCIsIHVybDogYWJDb3JlVVJMIH0pOw0KDQogICAgYXNzZXJ0KGFiQ29yZVJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvdWxkIG5vdCBkb3dubG9hZCBhYkNvcmUuIFJlc3BvbnNlOiAke2FiQ29yZVJlc3BvbnNlLnN0YXR1c1RleHR9YCk7DQogICAgYXNzZXJ0KGFiQ29yZVJlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkNvcmUgbXVzdCBiZSBpbiBhdXggZmlsZSBmb3JtYXQgdjIuIEFjdHVhbCBhdXggZmlsZSBmb3JtYXQgdmVyc2lvbjogJHthYkNvcmVSZXNwb25zZS5kYXRhLnZlcnNpb259YCk7DQoNCiAgICBvdmVyd3JpdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmF1eFYyT3ZlcndyaXRlKHsgYXV4OiBhYkNvcmVSZXNwb25zZS5kYXRhLCBncm91cFRhZzogJ2FiQ29yZScsIGRyeVJ1biB9KTsNCiAgICBzZXRUYWdNYXNrKGFiLCAnYWJDb3JlU291cmNlSGFzaCcsIG92ZXJ3cml0ZVJlc3VsdC5zb3VyY2VIYXNoLCAnc2hhcmVkJyk7DQogICAgDQogICAgLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBmaW5pc2hlZCB1cGRhdGluZy4NCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJVcGRhdGVkJykpOw0KDQogICAgaWYgKHJlbG9hZFBhZ2UpIHsNCiAgICAgICAgY29uc3QgcmVtb3RlRGF0YUV2ZW50ID0gJ3VwZGF0ZV9hYl9yZWxvYWRfcGFnZSc7DQogICAgICAgIGNvbnN0IHJlbW90ZURhdGFBcmcgPSB7IHJlbG9hZFBhZ2UsIGRyeVJ1biB9Ow0KDQogICAgICAgIGlmIChvcy5pc0NvbGxhYm9yYXRpdmUoKSkgew0KICAgICAgICAgICAgY29uc3QgcmVtb3RlcyA9IGF3YWl0IG9zLnJlbW90ZXMoKTsNCiAgICAgICAgICAgIHNlbmRSZW1vdGVEYXRhKHJlbW90ZXMsIHJlbW90ZURhdGFFdmVudCwgcmVtb3RlRGF0YUFyZyk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICB0aGlzQm90Lm9uUmVtb3RlRGF0YSh7IG5hbWU6IHJlbW90ZURhdGFFdmVudCwgdGhhdDogcmVtb3RlRGF0YUFyZywgcmVtb3RlSWQ6IGNvbmZpZ0JvdC5pZCB9KTsNCiAgICAgICAgfQ0KICAgIH0NCn0gZmluYWxseSB7DQogICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsNCiAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsNCiAgICAgICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOw0KICAgIH0NCn0nAKe/uq0IAAVkZWJ1ZwIEAKe/uq0I680BBWZhbHNlJwCnv7qtCAAVYWJDcmVhdGVVcGRhdGVDaGVja2VyAgQAp7+6rQjxzQG9E0BsZXQgYWJVcGRhdGVDaGVja2VyID0gZ2V0Qm90KCdhYlVwZGF0ZUNoZWNrZXInLCB0cnVlKTsKCmlmIChhYlVwZGF0ZUNoZWNrZXIpIHsKICAgIGdsb2JhbFRoaXMuYWJVcGRhdGVDaGVja2VyID0gYWJVcGRhdGVDaGVja2VyOwogICAgcmV0dXJuIGFiVXBkYXRlQ2hlY2tlcjsKfQoKbGV0IG1vZCA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIGFiVXBkYXRlQ2hlY2tlcjogdHJ1ZSwKICAgIGFiSWdub3JlOiB0cnVlLAogICAgY2hlY2tpbmc6IGZhbHNlLAogICAgdXBkYXRlQXZhaWxhYmxlOiBmYWxzZSwKICAgIGRlYnVnOiBmYWxzZSwKICAgIG9uQ3JlYXRlOiBgQAogICAgICAgIHRoaXNCb3Quc3RhcnRJbnRlcnZhbCgpOwogICAgICAgIHRoaXNCb3Qub25VcGRhdGVDaGVjaygpOwogICAgYCwKICAgIHN0YXJ0SW50ZXJ2YWw6IGBACiAgICAgICAgaWYgKCF0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGNvbnN0IFVQREFURV9DSEVDS19JTlRFUlZBTF9NSU5VVEVTID0gNTsKICAgICAgICAgICAgY29uc3QgaW50ZXJ2YWxNUyA9IFVQREFURV9DSEVDS19JTlRFUlZBTF9NSU5VVEVTICogNjAgKiAxMDAwOwogICAgICAgICAgICB0YWdzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5vblVwZGF0ZUNoZWNrKCksIGludGVydmFsTVMpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSBzdGFydCB1cGRhdGUgY2hlY2sgaW50ZXJ2YWwgbXM6JywgaW50ZXJ2YWxNUyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICBgLAogICAgc3RvcEludGVydmFsOiBgQAogICAgICAgIGlmICh0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGFncy5pbnRlcnZhbCk7CiAgICAgICAgICAgIHRhZ3MuaW50ZXJ2YWwgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbYWJVcGRhdGVDaGVja2VyXSBzdG9wIHVwZGF0ZSBjaGVjayBpbnRlcnZhbC4nKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIGAsCiAgICBmb3JjZVVwZGF0ZUNoZWNrOiBgQAogICAgICAgIHRoaXNCb3Quc3RvcEludGVydmFsKCk7CiAgICAgICAgdGhpc0JvdC5zdGFydEludGVydmFsKCk7CiAgICAgICAgdGhpc0JvdC5vblVwZGF0ZUNoZWNrKHsgZm9yY2U6IHRydWUgfSk7CiAgICBgLAogICAgb25VcGRhdGVDaGVjazogYEAKICAgICAgICBjb25zdCBmb3JjZSA9IHRoYXQ/LmZvcmNlID8/IGZhbHNlOwoKICAgICAgICBpZiAoIXRhZ3MuY2hlY2tpbmcpIHsKICAgICAgICAgICAgaWYgKCF0YWdzLnVwZGF0ZUF2YWlsYWJsZSB8fCBmb3JjZSkgewogICAgICAgICAgICAgICAgdGFncy5jaGVja2luZyA9IHRydWU7CgogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBhYi5hYkNoZWNrQUJVcGRhdGVBdmFpbGFibGUoKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1thYlVwZGF0ZUNoZWNrZXJdIHVwZGF0ZSBjaGVjayByZXN1bHQ6JywgcmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdzLnVwZGF0ZUF2YWlsYWJsZSA9IHJlc3VsdC51cGRhdGVBdmFpbGFibGU7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnVwZGF0ZUF2YWlsYWJsZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdXQoJ29uQUJVcGRhdGVBdmFpbGFibGUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CiAgICAgICAgICAgICAgICAgICAgdGFncy5jaGVja2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gc2tpcCB1cGRhdGUgY2hlY2sg4oCUIHVwZGF0ZSBpcyBhbHJlYWR5IGtub3duIHRvIGJlIGF2YWlsYWJsZS4nKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW2FiVXBkYXRlQ2hlY2tlcl0gdXBkYXRlIGNoZWNrIGFscmVhZHkgaW4gcHJvZ3Jlc3MuJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgYCwKfQoKYWJVcGRhdGVDaGVja2VyID0gY3JlYXRlKG1vZCk7Cmdsb2JhbFRoaXMuYWJVcGRhdGVDaGVja2VyID0gYWJVcGRhdGVDaGVja2VyCgpyZXR1cm4gYWJVcGRhdGVDaGVja2VyOycAp7+6rQgADmF1eFYyT3ZlcndyaXRlAgQAp7+6rQit4QGRKkBjb25zdCBhdXggPSB0aGF0Py5hdXg7CmNvbnN0IGdyb3VwVGFnID0gdGhhdD8uZ3JvdXBUYWc7CmNvbnN0IGRyeVJ1biA9IHRoYXQ/LmRyeVJ1biA/PyBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmFzc2VydChhdXg/LnZlcnNpb24gPT09IDIsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXV4IHBhcmFtZXRlciBpcyByZXF1aXJlZCB0byBiZSBhIHYyIGF1eCBmaWxlLmApOwphc3NlcnQoZ3JvdXBUYWcgPT0gbnVsbCB8fCB0eXBlb2YgZ3JvdXBUYWcgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdyb3VwVGFnIHBhcmFtZXRlciBpZiBwcm92aWRlZCwgbXVzdCBiZSBhIHN0cmluZy5gKTsKCmNvbnN0IHN0YXRlID0gYXdhaXQgb3MuZ2V0SW5zdFN0YXRlRnJvbVVwZGF0ZXMoYXV4LnVwZGF0ZXMpOwoKLy8gU3VwZXIgaGFyZGNvZGVkIG1lc3N5IGZpeCBmb3IgY29tcHV0aW5nIGFiQ29uZmlnIHNvdXJjZSBoYXNoLgppZiAoZ3JvdXBUYWcgPT09ICdhYkNvbmZpZycpIHsgCiAgICBmb3IgKGxldCBpZCBpbiBzdGF0ZSkgewogICAgICAgIGRlbGV0ZSBzdGF0ZVtpZF0udGFncy5iYXNlQUI7IC8vIGJhc2VBQiBpcyBhbiBhbm5veWluZyB0YWcgdGhhdCBzaG91bGQgbm90IGJlIGNvbXB1dGVkIGFzIHBhcnQgb2YgaGFzaCBzdGF0ZS4KICAgIH0KfQoKbGV0IHNvdXJjZUhhc2ggPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBzdGF0ZSk7CmxldCBwcmV2R3JvdXBCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFnc1tncm91cFRhZ10gPT09IHRydWUpOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhdGU6YCwgc3RhdGUpOwogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwcmV2R3JvdXBCb3RzOmAsIHByZXZHcm91cEJvdHMpOwp9CgovLyBTdGVwIDE6IEFwcGx5IHVwZGF0ZXMgZGlyZWN0bHkgdG8gdGhlIGluc3QgYXMtaXMuCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFN0ZXAgMTogQXBwbHkgdXBkYXRlcyBkaXJlY3RseSB0byB0aGUgaW5zdCBhcy1pcy5gKTsKfQoKaWYgKCFkcnlSdW4pIHsKICAgIGF3YWl0IG9zLmFwcGx5VXBkYXRlc1RvSW5zdChhdXgudXBkYXRlcyk7Cn0gZWxzZSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGFwcGx5IHVwZGF0ZXMgdG8gaW5zdC5gKQp9CgovLyBTdGVwIDI6IERlbGV0ZSBwcmV2aW91cyBncm91cCBib3RzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBTdGVwIDI6IERlbGV0ZSBwcmV2aW91cyBncm91cCBib3RzIHRoYXQgYXJlIG5vIGxvbmdlciBpbiB0aGUgdXBkYXRlIHN0YXRlLmApOwp9Cgpmb3IgKGNvbnN0IHByZXZHcm91cEJvdCBvZiBwcmV2R3JvdXBCb3RzKSB7CiAgICBpZiAoc3RhdGVbcHJldkdyb3VwQm90LmlkXSA9PSBudWxsKSB7CiAgICAgICAgaWYgKGRyeVJ1bikgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIGRlbGV0ZSBib3QgJHtwcmV2R3JvdXBCb3QuaWR9IHByZXZpb3VzbHkgYmVsb25naW5nIHRvIGdyb3VwICR7Z3JvdXBUYWd9YCk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIHByZXZpb3VzIGdyb3VwIGJvdCAke3ByZXZHcm91cEJvdC5pZH0gdGhhdCBpcyBubyBsb25nZXIgaW4gdGhlIHVwZGF0ZSBzdGF0ZS5gKTsKICAgICAgICB9CgogICAgICAgIGRlc3Ryb3kocHJldkdyb3VwQm90KTsKICAgIH0KfQoKLy8gU3RlcCAzOiBGb3IgZWFjaCBib3QgaW4gdGhlIHVwZGF0ZSBzdGF0ZSwgY3JlYXRlLCB1cGRhdGUsIGFuZCBkZWxldGUgdGFncyBvbiB0aGUgZXhpc3RpbmcgYm90cyBpbiB0aGUgaW5zdC4KaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gU3RlcCAzOiBGb3IgZWFjaCBib3QgaW4gdGhlIHVwZGF0ZSBzdGF0ZSwgY3JlYXRlLCB1cGRhdGUsIGFuZCBkZWxldGUgdGFncyBvbiB0aGUgZXhpc3RpbmcgYm90cyBpbiB0aGUgaW5zdC5gKTsKfQoKZm9yIChjb25zdCBib3RJZCBpbiBzdGF0ZSkgewogICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgIGNvbnN0IGJvdFN0YXRlID0gc3RhdGVbYm90SWRdOwoKICAgIGlmIChib3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIGV4aXN0aW5nIGJvdCAke2JvdElkfWApOwogICAgICAgIH0KCiAgICAgICAgLy8gSGFuZGxlcyB0YWcgY3JlYXRlIC8gdXBkYXRlLgogICAgICAgIGZvciAoY29uc3Qgc3RhdGVUYWdOYW1lIGluIGJvdFN0YXRlLnRhZ3MpIHsKICAgICAgICAgICAgaWYgKGJvdC5yYXdbc3RhdGVUYWdOYW1lXSAhPSBib3RTdGF0ZS50YWdzW3N0YXRlVGFnTmFtZV0pIHsKICAgICAgICAgICAgICAgIGlmIChkcnlSdW4pIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyeSBydW46IHdvdWxkIHNldCB0YWcgJyR7c3RhdGVUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9IHRvIHZhbHVlOmAsIGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldCB0YWcgJyR7c3RhdGVUYWdOYW1lfScgb24gYm90ICR7Ym90SWR9IHRvOmAsIGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm90LnRhZ3Nbc3RhdGVUYWdOYW1lXSA9IGJvdFN0YXRlLnRhZ3Nbc3RhdGVUYWdOYW1lXTsKCiAgICAgICAgICAgICAgICBpZiAoYm90U3RhdGUudGFnc1tzdGF0ZVRhZ05hbWVdID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRhZyAnJHtzdGF0ZVRhZ05hbWV9JyBmb3IgYm90ICR7Ym90SWR9IGlzIG51bGwsIGNsZWFyaW5nIGFueSB0YWcgbWFza3MgYXMgd2VsbC5gKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIENsZWFyIGFsbCBwb3NzaWJsZSBtYXNrcyBmb3IgdGhpcyB0YWcgYXMgd2VsbC4KICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAnbG9jYWwnKTsKICAgICAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgc3RhdGVUYWdOYW1lLCBudWxsLCAndGVtcExvY2FsJyk7CiAgICAgICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIHN0YXRlVGFnTmFtZSwgbnVsbCwgJ3NoYXJlZCcpOwogICAgICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBzdGF0ZVRhZ05hbWUsIG51bGwsICd0ZW1wU2hhcmVkJyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGFnICcke3N0YXRlVGFnTmFtZX0nIGZvciBib3QgJHtib3RJZH0gaXMgYWxyZWFkeSB1cC10by1kYXRlLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBEZWxldGUgdGFncyAoYW5kIG1hc2tzIGZvciB0aG9zZSB0YWdzKSBvbiBleGlzdGluZyBib3QgdGhhdCBhcmUgbm90IGluIHVwZGF0ZSBzdGF0ZS4KICAgICAgICBjb25zdCBib3RUYWdzID0gT2JqZWN0LmtleXMoYm90LnRhZ3MpOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdFRhZ05hbWUgb2YgYm90VGFncykgewogICAgICAgICAgICBpZiAoYm90U3RhdGUudGFnc1tib3RUYWdOYW1lXSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoZHJ5UnVuKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcnkgcnVuOiB3b3VsZCBkZWxldGUgdGFnICcke2JvdFRhZ05hbWV9JyBvbiBib3QgJHtib3RJZH0uYCk7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlbGV0ZSB0YWcgKGFuZCBtYXNrcykgJyR7Ym90VGFnTmFtZX0nIG9uIGJvdCAke2JvdElkfS5gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBib3QudGFnc1tib3RUYWdOYW1lXSA9IG51bGw7CiAgICAgICAgICAgICAgICAvLyBDbGVhciBhbGwgcG9zc2libGUgbWFza3MgZm9yIHRoaXMgdGFnIGFzIHdlbGwuCiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ2xvY2FsJyk7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKGJvdCwgYm90VGFnTmFtZSwgbnVsbCwgJ3RlbXBMb2NhbCcpOwogICAgICAgICAgICAgICAgc2V0VGFnTWFzayhib3QsIGJvdFRhZ05hbWUsIG51bGwsICdzaGFyZWQnKTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2soYm90LCBib3RUYWdOYW1lLCBudWxsLCAndGVtcFNoYXJlZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY291bGQgbm90IGZpbmQgYm90ICR7Ym90SWR9IGluIGluc3QuYCk7CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRvbmUuYCk7Cn0KCmNvbnN0IGJvdElkcyA9IE9iamVjdC5rZXlzKHN0YXRlKTsKCnJldHVybiB7CiAgICBncm91cFRhZywKICAgIGJvdElkcywKICAgIHNvdXJjZUhhc2gsCn07JwCnv7qtCAAOYWJMb2FkZWRTa2lsbHMCBACnv7qtCL+LArYBQGNvbnN0IGxvYWRlZFNraWxscyA9IG5ldyBTZXQoKTsKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJMb2FkZWRTa2lsbCAhPSBudWxsKSB7CiAgICAgICAgbG9hZGVkU2tpbGxzLmFkZChiLnRhZ3MuYWJMb2FkZWRTa2lsbCk7CiAgICB9Cn0pOwoKcmV0dXJuIEFycmF5LmZyb20obG9hZGVkU2tpbGxzKTsnAKe/uq0IAAxvblJlbW90ZURhdGECBACnv7qtCPaMAqcFQGlmICh0aGF0Lm5hbWUgPT09ICd1cGRhdGVfYWJfcmVsb2FkX3BhZ2UnKSB7CiAgICBjb25zdCB7IHJlbG9hZFBhZ2UsIGRyeVJ1biB9ID0gdGhhdC50aGF0OwoKICAgIGlmICh0aGF0LnJlbW90ZUlkID09PSBjb25maWdCb3QuaWQpIHsKICAgICAgICAvLyBXYWl0IGEgbW9tZW50IGJlZm9yZSByZWxvYWRpbmcgdGhlIHBhZ2UgaWYgd2UgYXJlIHRoZSBvbmVzIHRoYXQgc2VudCBvdXQgdGhlIG1lc3NhZ2UuCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMTAwMCk7CiAgICB9CgogICAgbGV0IGlzVVJMID0gZmFsc2U7CgogICAgaWYgKHR5cGVvZiByZWxvYWRQYWdlID09PSAnc3RyaW5nJykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIG5ldyBVUkwocmVsb2FkUGFnZSk7CiAgICAgICAgICAgIGlzVVJMID0gdHJ1ZTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgfQoKICAgIGxldCB1cmwgPSBpc1VSTCA/IHJlbG9hZFBhZ2UgOiBjb25maWdCb3QudGFncy51cmw7CgogICAgaWYgKGRyeVJ1bikgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJ5IHJ1bjogd291bGQgZ28gdG8gdXJsYCwgdXJsKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgICAKICAgIG9zLmdvVG9VUkwoaXNVUkwgPyByZWxvYWRQYWdlIDogY29uZmlnQm90LnRhZ3MudXJsKTsKfScAp7+6rQgACW9uRW50ZXJBUgIEAKe/uq0InpICE0BtYXNrcy5pbkFSID0gdHJ1ZTsnAKe/uq0IAAhvbkV4aXRBUgIEAKe/uq0IspICE0BtYXNrcy5pbkFSID0gbnVsbDsnAKe/uq0IAAlvbkVudGVyVlICBACnv7qtCMaSAhNAbWFza3MuaW5WUiA9IHRydWU7JwCnv7qtCAAIb25FeGl0VlICBACnv7qtCNqSAhNAbWFza3MuaW5WUiA9IG51bGw7JwCnv7qtCAAGY3JlYXRlAgQAp7+6rQjukgIo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAp7+6rQgABXBhc3RlAgQAp7+6rQiVkwIo8J+Ul2IzMzljMTE4LTQ4OWEtNDY2Yi1iYTlmLWIwN2E1ZjliNjY0ZicAp7+6rQgACGFybV90b29sAgQAp7+6rQi8kwIo8J+UlzNjNzRjOWYxLTgyZGMtNDY1NS04YjM4LWU3ZjExZGU4OTc4ZScAp7+6rQgAA2N1ZQIEAKe/uq0I45MCkQxALy90aGF0DQovL2JvdD8NCi8vcG9zaXRpb24/DQovL3RleHQNCi8vZGltZW5zaW9uPw0KLy9zY2FsZT8NCi8vY29sb3I/DQovL3NwYWNlPw0KLy9mb250U2l6ZT8NCi8vd3JhcE1vZGU/DQoNCmNvbnN0IGN1cnJlbnREaW0gPSB0aGF0LmRpbWVuc2lvbiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uID8/ICdob21lJzsNCg0KbGV0IHBvc1g7DQpsZXQgcG9zWTsNCmxldCBwb3NaOw0KDQoNCg0KaWYgKHRoYXQuYm90KSB7DQogICAgcG9zWCA9IHRoYXQuYm90LnRhZ3NbY3VycmVudERpbSArICdYJ107DQogICAgcG9zWSA9IHRoYXQuYm90LnRhZ3NbY3VycmVudERpbSArICdZJ107DQogICAgcG9zWiA9IHRoYXQuYm90LnRhZ3NbY3VycmVudERpbSArICdaJ10gPz8gMDsNCn0gZWxzZSBpZiAodGhhdC5wb3NpdGlvbikgew0KICAgIHBvc1ggPSB0aGF0LnBvc2l0aW9uLng7DQogICAgcG9zWSA9IHRoYXQucG9zaXRpb24ueTsNCiAgICBwb3NaID0gdGhhdC5wb3NpdGlvbi56ID8/IDE7DQp9DQoNCmlmICgoIXBvc1ggJiYgcG9zWCAhPSAwKSB8fCAoIXBvc1kgJiYgcG9zWSAhPSAwKSkgew0KICAgIHJldHVybjsNCn0NCg0KY29uc3QgY3VlQm90ID0gYXdhaXQgY3JlYXRlKHsNCiAgICBzcGFjZTogdGhhdC5zcGFjZSA/PyAndGVtcExvY2FsJywNCiAgICBsYWJlbDogdGhhdC50ZXh0ID8/ICcnLA0KICAgIGxhYmVsQ29sb3I6IHRoYXQuY29sb3IgPz8gIndoaXRlIiwNCiAgICBzY2FsZTogdGhhdC5zY2FsZSA/PyAnLjUnLA0KICAgIFtjdXJyZW50RGltXTogdHJ1ZSwNCiAgICBbY3VycmVudERpbSArICdYJ106IHBvc1gsDQogICAgW2N1cnJlbnREaW0gKyAnWSddOiBwb3NZLA0KICAgIFtjdXJyZW50RGltICsgJ1onXTogcG9zWiwNCiAgICBjb2xvcjogJ2NsZWFyJywNCiAgICBsYWJlbE9wYWNpdHk6IDEsDQogICAgbGFiZWxXb3JkV3JhcE1vZGU6IHRoYXQud3JhcE1vZGUgPz8gJ2JyZWFrV29yZHMnLA0KICAgIGxhYmVsRm9udFNpemU6IHRoYXQuZm9udFNpemUgPz8gdW5kZWZpbmVkLA0KICAgIGxhYmVsUG9zaXRpb246ICdmbG9hdGluZ0JpbGxib2FyZCcsDQogICAgbGFiZWxGbG9hdGluZ0JhY2tncm91bmRDb2xvcjogJ2NsZWFyJywNCiAgICBwb2ludGFibGU6IGZhbHNlLA0KICAgIG9uQm90QWRkZWQ6IGBADQogICAgICAgIGF3YWl0IGFuaW1hdGVUYWcodGhpc0JvdCwgew0KICAgICAgICAgICAgZnJvbVZhbHVlOiB7DQogICAgICAgICAgICAgICAgWycke2N1cnJlbnREaW19JyArICdaJ106ICR7cG9zWn0sDQogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAxDQogICAgICAgICAgICB9LA0KICAgICAgICAgICAgdG9WYWx1ZTogew0KICAgICAgICAgICAgICAgIFsnJHtjdXJyZW50RGltfScgKyAnWiddOiAke3Bvc1p9ICsgMywNCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDANCiAgICAgICAgICAgIH0sDQogICAgICAgICAgICBkdXJhdGlvbjogMiwNCiAgICAgICAgICAgIHRhZ01hc2tTcGFjZTogZmFsc2UNCiAgICAgICAgfSkNCiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsNCiAgICBgDQp9KScAp7+6rQgAC29uQW55Q3JlYXRlAgQAp7+6rQj1nwLxBEBjb25zdCB7IGJvdCB9ID0gdGhhdDsKCmlmIChib3QpIHsKICAgIC8vIFtSeWFuXSBJJ20gbm90IHN1cmUgd2h5IHdlIG5lZWQgdG8gZG8gdGhpcywgYnV0IHdpdGhvdXQgYXdhaXRpbmcgaGVyZSB3ZSBhcmUgc2VlaW5nIHN0cmFuZ2UKICAgIC8vIGFydGlmYWN0cyB3aXRoIG5ldyBib3RzIGNyZWF0ZWQgdmlhIGFiLiBNdWx0aXBsZSBsaW5lcyBnZXQgZHJhd24gaW5zdGVhZCBvZiBqdXN0IG9uZSB0byB0aGUgc2VsZWN0ZWQgYm90IGFuZCB0aGUgYXJtCiAgICAvLyBkb2VzbnQgZ2V0IHVwZGF0ZWQgcHJvcGVybHkgdG8gaGlkZS4gSXRzIGFzIGlmIGJvdCB1cGRhdGVzIGdldCBtZXNzZWQgdXAgb3IgcGVyaGFwcyBsb3N0IHdpdGhvdXQgdGhpcyBhd2FpdC4KICAgIGF3YWl0IG9zLnNsZWVwKDApOwogICAgCiAgICAvLyBBc3NpZ24gYSBjcmVhdGlvbiB0aW1lc3RhbXAgZm9yIHRoZSBib3QuCiAgICBsZXQgdGltZXN0YW1wID0gb3MuYWdyZWVkVXBvblRpbWU7CgogICAgaWYgKE51bWJlci5pc05hTih0aW1lc3RhbXApKSB7CiAgICAgICAgdGltZXN0YW1wID0gb3MubG9jYWxUaW1lOwogICAgfQoKICAgIHNldFRhZ01hc2soYm90LCAnYWJDcmVhdGVUaW1lJywgdGltZXN0YW1wLCAnc2hhcmVkJyk7Cn0nAKe/uq0IAAVzb3VuZAIEAKe/uq0I56QCKPCflJcxMzY3MjI1My0yNTM2LTQwODYtOTVjZi1lYjE2ZmZjY2U0ZGQnAKe/uq0IAA1hYlByaW1hcnlJbnN0AgQAp7+6rQiOpQLBAkBpZiAoY29uZmlnQm90KSB7CiAgICB0cnkgewogICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKTsKCiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdXJsLnNlYXJjaFBhcmFtcykgewogICAgICAgICAgICBpZiAoa2V5ID09PSAnaW5zdCcgfHwga2V5ID09PSAnc3RhdGljSW5zdCcpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gY2F0Y2ggewogICAgICAgIC8vIEJhZCB1cmwuCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9Cn0KCnJldHVybiBudWxsOycAp7+6rQgAC2FiSXNQcmltYXJ5AgQAp7+6rQjQpwJzQGNvbnN0IGN1ckluc3QgPSBvcy5nZXRDdXJyZW50SW5zdCgpOwpjb25zdCBwcmltYXJ5SW5zdCA9IHRoaXNCb3QuYWJQcmltYXJ5SW5zdCgpOwoKcmV0dXJuIGN1ckluc3QgPT09IHByaW1hcnlJbnN0OwA="}]}