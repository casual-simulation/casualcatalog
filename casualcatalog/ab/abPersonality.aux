{"version":2,"updates":[{"id":0,"timestamp":1764185534381,"update":"AboBmZzl3wwAJwEEYm90cyQxNjU1NGJjMS1lOTNlLTRhMGItOGNkMy1kZmQ3NzIzMTk2NzIBJwCZnOXfDAAJYWJWZXJzaW9uAgQAmZzl3wwBBTEwLjM0JwCZnOXfDAAGc3lzdGVtAgQAmZzl3wwHFmFiLnBlcnNvbmFsaXR5LnZlcnNpb24nAJmc5d8MABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQAmZzl3wweATEnAJmc5d8MAA1vblNraWxsVXBkYXRlAgQAmZzl3wwgrQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAmZzl3wwADWFiUGVyc29uYWxpdHkCBACZnOXfDM4BBHRydWUnAJmc5d8MAAhhYklnbm9yZQIEAJmc5d8M0wEEdHJ1ZScAmZzl3wwABGZvcm0CBACZnOXfDNgBB25vdGhpbmcnAJmc5d8MABlhYlBlcnNvbmFsaXR5TWlub3JWZXJzaW9uAgQAmZzl3wzgAQIyNScBBGJvdHMkM2M3NGM5ZjEtODJkYy00NjU1LThiMzgtZTdmMTFkZTg5NzhlAScAmZzl3wzjAQZzeXN0ZW0CBACZnOXfDOQBF2FiLnBlcnNvbmFsaXR5LmFybV90b29sJwCZnOXfDOMBDG9uQW55Qm90RHJhZwIEAJmc5d8M/AGNCEBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC50YWdzLmFybVNlbGVjdGlvbikgewogICAgaWYgKGRyYWdCb3QubGlua3MuYXJtQm90KSB7CiAgICAgICAgaWYgKGRyYWdCb3QubGlua3MuYXJtQm90LnRhZ3MubXVsdGlTZWxlY3QgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMgJiYgZHJhZ0JvdC50YWdzLmFybUdyb3VwRHJhZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlbmFibGUgY3VzdG9tIGRyYWdnaW5nYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9zLmVuYWJsZUN1c3RvbURyYWdnaW5nKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95IHByZXZpb3VzIGFybUJvdDogJHtkcmFnQm90Lm1hc2tzLmFybUJvdH1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveShkcmFnQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgY29uc3QgbXVsdGlTZWxlY3RLZXlIZWxkID0gb3MuZ2V0SW5wdXRTdGF0ZSgna2V5Ym9hcmQnLCAnU2hpZnQnKTsKICAgIGNvbnN0IG11bHRpU2VsZWN0QWxsb3dlZCA9IGRyYWdCb3QudGFncy5hcm1NdWx0aVNlbGVjdCA/PyB0cnVlOwoKICAgIGNvbnN0IGFybUJvdCA9IHRoaXNCb3QuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogZHJhZ0JvdCwKICAgICAgICBkaW1lbnNpb24sCiAgICAgICAgbXVsdGlTZWxlY3Q6IG11bHRpU2VsZWN0S2V5SGVsZCAmJiBtdWx0aVNlbGVjdEFsbG93ZWQsCiAgICB9KQoKICAgIG9zLnJlcGxhY2VEcmFnQm90KGFybUJvdCk7Cn0KJwCZnOXfDOMBBWRlYnVnAgQAmZzl3wyKCgVmYWxzZScAmZzl3wzjAQlsaXN0ZW5pbmcCBACZnOXfDJAKBHRydWUnAJmc5d8M4wELYWJDcmVhdGVBcm0CBACZnOXfDJUKjjhAY29uc3Qgb3JpZ2luQm90ID0gdGhhdC5vcmlnaW5Cb3Q7CmFzc2VydChhYi5saW5rcy51dGlscy5pc0JvdChvcmlnaW5Cb3QpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbkJvdCBpcyBhIHJlcXVpcmVkIEJvdCBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBkaW1lbnNpb24gPSB0aGF0LmRpbWVuc2lvbjsKYXNzZXJ0KHR5cGVvZiBkaW1lbnNpb24gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRpbWVuc2lvbiBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBwb3NpdGlvbiA9IHRoYXQucG9zaXRpb24gPz8gZ2V0Qm90UG9zaXRpb24ob3JpZ2luQm90LCBkaW1lbnNpb24pOwpjb25zdCBhcm1Db2xvciA9IHRoYXQuYXJtQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3MuYXJtQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3Muc3Ryb2tlQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3MuY29sb3I7CmNvbnN0IG11bHRpU2VsZWN0ID0gdGhhdC5tdWx0aVNlbGVjdCA/PyBmYWxzZTsKCmNvbnN0IGFybSA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIFtkaW1lbnNpb24gKyAnWiddOiBwb3NpdGlvbi56LAogICAgY3JlYXRvcjogb3JpZ2luQm90LmlkLAogICAgaXNBcm1Cb3Q6IHRydWUsCiAgICBwb2ludGFibGU6IHRydWUsCiAgICBtdWx0aVNlbGVjdCwKICAgIGRlYnVnOiB0YWdzLmRlYnVnLAogICAgb3JpZ2luQm90OiBnZXRMaW5rKG9yaWdpbkJvdCksCiAgICBkaW1lbnNpb24sCiAgICBzY2FsZTogMC45LAogICAgc2NhbGVaOiAwLjAxLAogICAgY29sb3I6ICdjbGVhcicsCiAgICBhcm1Db2xvciwKICAgIHN0cm9rZUNvbG9yOiBhcm1Db2xvciwKICAgIGxpbmVDb2xvcjogYXJtQ29sb3IsCiAgICBsaW5lVG86IG9yaWdpbkJvdC5pZCwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgLy8gRGVzdHJveSBwcmV2aW91cyBhcm0gaWYgaXQgaXMgc3RpbGwgYXJvdW5kLgogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3Mub3JpZ2luQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9IGBhcm0uJHt0aGlzQm90LmlkLnN1YnN0cmluZygwLCA1KX1gOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1Cb3QgPSBnZXRMaW5rKHRoaXNCb3QpOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5kcmFnZ2FibGUgPSB0YWdzLm11bHRpU2VsZWN0OwoKICAgICAgICBpZiAodGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICB0YWdzLmZvcm0gPSAnc3BoZXJlJzsKICAgICAgICAgICAgdGFncy5jb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgfQoKICAgICAgICAvLyBNYWtlIHRoZSBvcmlnaW4gYm90IHVuc2VsZWN0YWJsZSBmb3IgMS80IG9mIGEgc2Vjb25kLgogICAgICAgIC8vIFRoaXMgaGVscHMgcHJldmVudCB1bmludGVudGlvbmFsIHNlbGYtc2VsZWN0aW9uIG9mIHRoZSBvcmlnaW4gYm90LgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKICAgICAgICBvcy5zbGVlcCgyNTApLnRoZW4oKCkgPT4gewogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MucG9pbnRhYmxlID0gbnVsbDsKICAgICAgICB9KQoKICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1DcmVhdGUnKTsKICAgIH0pLAogICAgc2V0QXJtVmlzaWJsZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxldCB2aXNpYmxlID0gdGhhdDsKCiAgICAgICAgaWYgKHZpc2libGUpIHsKICAgICAgICAgICAgbWFza3Muc3Ryb2tlQ29sb3IgPSBudWxsOwogICAgICAgICAgICBtYXNrcy5saW5lQ29sb3IgPSBudWxsOwogICAgICAgICAgICBtYXNrcy5saW5lVG8gPSBsaW5rcy5vcmlnaW5Cb3QuaWQ7IAogICAgICAgICAgICBtYXNrcy5wb2ludGFibGUgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgICAgIG1hc2tzLmNvbG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG1hc2tzLnN0cm9rZUNvbG9yID0gJ2NsZWFyJzsKICAgICAgICAgICAgbWFza3MubGluZUNvbG9yID0gJ2NsZWFyJzsKICAgICAgICAgICAgbWFza3MubGluZVRvID0gZmFsc2U7CiAgICAgICAgICAgIG1hc2tzLnBvaW50YWJsZSA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgICAgIG1hc2tzLmNvbG9yID0gJ2NsZWFyJzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHsgZGltZW5zaW9uIH0gPSB0aGF0OwoKICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90Py50YWdzLmFybVRlbGVwb3J0ID8/IHRydWUpIHsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC50YWdzW2RpbWVuc2lvbiArICdYJ10gPSB0YWdzW2RpbWVuc2lvbiArICdYJ107CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC50YWdzW2RpbWVuc2lvbiArICdZJ10gPSB0YWdzW2RpbWVuc2lvbiArICdZJ107CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC50YWdzW2RpbWVuc2lvbiArICdaJ10gPSB0YWdzW2RpbWVuc2lvbiArICdaJ107CiAgICAgICAgfQoKICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtQ2xpY2snLCB7IGRpbWVuc2lvbiB9KTsKCiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIH0pLAogICAgb25Ecm9wRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5kcmFnQm90ICE9PSB0aGlzQm90KSByZXR1cm47CiAgICAgICAgaWYgKCFsaW5rcy5vcmlnaW5Cb3QpIHJldHVybjsKCiAgICAgICAgY29uc3QgZHJvcEJvdCA9IHRoYXQudG8uYm90OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgbGV0IGxpbmVUb0JvdHMgPSBsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvOwoKICAgICAgICAgICAgaWYgKGxpbmVUb0JvdHMgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGdldExpbmsoZHJvcEJvdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5lVG9Cb3RzID0gQXJyYXkuaXNBcnJheShsaW5lVG9Cb3RzKSA/IGxpbmVUb0JvdHMgOiBbbGluZVRvQm90c107CgogICAgICAgICAgICAgICAgaWYgKCFsaW5lVG9Cb3RzLmluY2x1ZGVzKGRyb3BCb3QpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGdldExpbmsoLi4ubGluZVRvQm90cywgZHJvcEJvdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaGlkZSBhcm1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGRyb3BCb3QuaWQ7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IHNlbGVjdGlvbiBvbiBvcmlnaW4gYm90LmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkRyb3BFeGl0OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuZHJhZ0JvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwogICAgICAgIGlmICghbGlua3Mub3JpZ2luQm90KSByZXR1cm47CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcm9wQm90OmAsIGRyb3BCb3QpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZSh0cnVlKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgYXJtYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBzZWxlY3Rpb24gb24gb3JpZ2luIGJvdC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25Ecm9wOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuYm90ICE9PSB0aGlzQm90KSByZXR1cm47CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3QgZHJvcEJvdCA9IHRoYXQudG8uYm90OwogICAgICAgIAogICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0ICYmIGxpbmtzLm9yaWdpbkJvdC5saW5rcy5saW5lVG8pIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5TZXRTZWxlY3Rpb24obGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbyk7CiAgICAgICAgfSBlbHNlIGlmIChkcm9wQm90KSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZShmYWxzZSk7CiAgICAgICAgICAgIHRoaXNCb3Qub3JpZ2luU2V0U2VsZWN0aW9uKGRyb3BCb3QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIERyb3BwZWQgb24gZ3JpZC4KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJvcHBlZCBvbiBncmlkLmApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtUGxhY2VkJywgeyBkaW1lbnNpb246IHRoYXQudG8uZGltZW5zaW9uLCB4OiB0aGF0LnRvLngsIHk6IHRoYXQudG8ueSwgejogdGhhdC50by56IH0pOwogICAgICAgIH0KICAgICAgICAKICAgIH0pLAogICAgb25HcmlkQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIH0pLAogICAgb3JpZ2luQ2xlYXJTZWxlY3Rpb246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lQ29sb3IgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwogICAgfSksCiAgICBvcmlnaW5TZXRTZWxlY3Rpb246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCBzZWxlY3RlZEJvdHMgPSB0aGF0OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtU2VsZWN0ZWRCb3RzID0gc2VsZWN0ZWRCb3RzID8gZ2V0TGluayhzZWxlY3RlZEJvdHMpIDogbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LnRhZ3MuYXJtU2VsZWN0ZWRCb3RzOwogICAgICAgIAogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1TZWxlY3RlZEJvdHMnLCBsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKQogICAgICAgIH0KICAgIH0pLAogICAgb25EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmRyYWdnYWJsZSA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1EZXN0cm95Jyk7CiAgICB9KSwKfTsKCmNvbnN0IGFybUJvdCA9IGNyZWF0ZShhcm0pOwoKcmV0dXJuIGFybUJvdDsnAJmc5d8M4wEQb25BbnlCb3REcmFnZ2luZwIEAJmc5d8MpELRFUBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC5saW5rcy5hcm1Cb3QpIHsKICAgIGlmIChkcmFnQm90LnRhZ3MuYXJtR3JvdXBEcmFnICYmIGRyYWdCb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgbGV0IGRyYWdDb29yZGluYXRvckJvdCA9IGxpbmtzLmRyYWdDb29yZGluYXRvckJvdDsKICAgICAgICAKICAgICAgICBpZiAoIWRyYWdDb29yZGluYXRvckJvdCkgewogICAgICAgICAgICBjb25zdCBkcmFnQ29vcmRpbmF0b3JNb2QgPSB7CiAgICAgICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgICAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgICAgICAgICAgICAgZGltZW5zaW9uOiBkaW1lbnNpb24sCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWCJdOiAwLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJZIl06IDAsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIloiXTogLTEsCiAgICAgICAgICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVidWc6IHRhZ3MuZGVidWcsCiAgICAgICAgICAgICAgICBjb2xvcjogImNsZWFyIiwKICAgICAgICAgICAgICAgIHN5c3RlbTogYGFybUdyb3VwRHJhZy4ke3RoaXNCb3QuaWQuc3Vic3RyaW5nKDAsIDUpfS5jb29yZGluYXRvcmAsCiAgICAgICAgICAgICAgICBvbkFueUJvdFBvaW50ZXJVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVzdHJveWluZyBkcmFnIGNvb3JkaW5hdG9yYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLm1hc2tzLmRyYWdDb29yZGluYXRvckJvdCA9IG51bGw7IAogICAgICAgICAgICAgICAgICAgIHNob3V0KCdvbkFybVN0b3BHcm91cERyYWcnLCB7IHg6IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAnWCddLCB5OiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgJ1knXSB9KTsKICAgICAgICAgICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QgPSBjcmVhdGUoZHJhZ0Nvb3JkaW5hdG9yTW9kKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNyZWF0ZWQgZHJhZyBjb29yZGluYXRvciBib3Q6YCwgZHJhZ0Nvb3JkaW5hdG9yQm90KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWFza3MuZHJhZ0Nvb3JkaW5hdG9yQm90ID0gZ2V0TGluayhkcmFnQ29vcmRpbmF0b3JCb3QpOwoKICAgICAgICAgICAgY29uc3QgYXJtU2VsZWN0ZWRCb3RzID0gZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgICAgIGNvbnN0IG9uQXJtU3RvcEdyb3VwRHJhZyA9IGBACiAgICAgICAgICAgICAgICBtYXNrcy50cmFuc2Zvcm1lciA9IG51bGw7CiAgICAgICAgICAgICAgICBtYXNrcy5vbkFybVN0b3BHcm91cERyYWcgPSBudWxsOwogICAgICAgICAgICAgICAgdGFncy4ke2RpbWVuc2lvbn1YID0gdGFncy4ke2RpbWVuc2lvbn1YICsgdGhhdC54OwogICAgICAgICAgICAgICAgdGFncy4ke2RpbWVuc2lvbn1ZID0gdGFncy4ke2RpbWVuc2lvbn1ZICsgdGhhdC55OwogICAgICAgICAgICBgCgogICAgICAgICAgICBkcmFnQm90Lm1hc2tzLnRyYW5zZm9ybWVyID0gZHJhZ0Nvb3JkaW5hdG9yQm90LmlkOwogICAgICAgICAgICBkcmFnQm90Lm1hc2tzLm9uQXJtU3RvcEdyb3VwRHJhZyA9IG9uQXJtU3RvcEdyb3VwRHJhZzsKCiAgICAgICAgICAgIHNldFRhZ01hc2soYXJtU2VsZWN0ZWRCb3RzLCAidHJhbnNmb3JtZXIiLCBkcmFnQ29vcmRpbmF0b3JCb3QuaWQsICJ0ZW1wTG9jYWwiKTsKICAgICAgICAgICAgc2V0VGFnTWFzayhhcm1TZWxlY3RlZEJvdHMsICJvbkFybVN0b3BHcm91cERyYWciLCBvbkFybVN0b3BHcm91cERyYWcsICJ0ZW1wTG9jYWwiKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHhDaGFuZ2UgPSB0aGF0LnRvLnggLSB0aGF0LmZyb20ueDsKICAgICAgICBjb25zdCB5Q2hhbmdlID0gdGhhdC50by55IC0gdGhhdC5mcm9tLnk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0geENoYW5nZTogJHt4Q2hhbmdlfSwgeUNoYW5nZTogJHt5Q2hhbmdlfWApOwogICAgICAgIH0KCiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIlgiXSA9IHhDaGFuZ2U7CiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIlkiXSA9IHlDaGFuZ2U7CiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIloiXSA9IC0xOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyYWcgYm90IHdpdGggYXJtIGRvZXMgbm90IHF1YWxpZnkgZm9yIGdyb3VwIGRyYWdnaW5nLmApOwogICAgICAgIH0KICAgIH0KfScAmZzl3wzjAQ1hYlBlcnNvbmFsaXR5AgQAmZzl3wz2VwR0cnVlJwCZnOXfDOMBCGFiSWdub3JlAgQAmZzl3wz7VwR0cnVlJwCZnOXfDOMBBGZvcm0CBACZnOXfDIBYB25vdGhpbmcnAJmc5d8M4wEJYWJWZXJzaW9uAgQAmZzl3wyIWAUxMC4zNCcBBGJvdHMkYjI2ZTEwODktMTcyZC00NWE5LThkMjItMDVjM2Y1OGMyYmY3AScAmZzl3wyOWAZzeXN0ZW0CBACZnOXfDI9YGGFiLnBlcnNvbmFsaXR5LmFuaW1hdGlvbicAmZzl3wyOWARmb3JtAgQAmZzl3wyoWAdub3RoaW5nJwCZnOXfDI5YCGFiSWdub3JlAgQAmZzl3wywWAR0cnVlJwCZnOXfDI5YDW1hbmlmZXN0YXRpb24CBACZnOXfDLVYKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJmc5d8MjlgIcmVtZW1iZXICBACZnOXfDNxYKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJmc5d8MjlgYYW5pbWF0aW9uX2FiR3JpZE1hbmlmZXN0AgQAmZzl3wyDWfoOQHNob3V0KCJyZXNldCIpOwoKY29uc3QgcG9zaXRpb25YID0gdGhhdD8ucG9zaXRpb24ueCA/PyAwOwpjb25zdCBwb3NpdGlvblkgPSB0aGF0Py5wb3NpdGlvbi55ID8/IDA7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQ/LmRpbWVuc2lvbiA/PyAiaG9tZSI7CmNvbnN0IGdyaWRTY2FsZSA9IHRoYXQ/LnNjYWxlID8/IDU7CmNvbnN0IG1vbWVudENvdW50ID0gMDsKY29uc3QgZ3JpZEJvdCA9IHt9OwoKZ3JpZEJvdC5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwpncmlkQm90LmNvbG9yID0gImNsZWFyIjsKZ3JpZEJvdC5zdHJva2VDb2xvciA9IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKZ3JpZEJvdC5zY2FsZSA9IDAuMDAxOwpncmlkQm90LnNjYWxlWiA9IDAuMTsKZ3JpZEJvdC5yZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKZ3JpZEJvdFtkaW1lbnNpb25dID0gdHJ1ZTsKZ3JpZEJvdC5wb2ludGFibGUgPSBmYWxzZTsKZ3JpZEJvdC5raWxsVGltZXIgPSAiQCBhd2FpdCBvcy5zbGVlcCg0MDApOyBkZXN0cm95KHRoaXNCb3QpOyI7CgpsZXQgcm91bmRCb3RzOwoKZm9yIChsZXQgaSA9IGdyaWRTY2FsZTsgaSA+IDA7IGktLSkKewogICAgY29uc3QgYm90Q291bnQgPSBpICogODsKCiAgICBsZXQgc2lkZUNvdW50ID0gMDsKICAgIGxldCBwaGFzZUZhY3RvciA9IDA7CgogICAgZm9yIChsZXQgaiA9IDA7IGogPCBib3RDb3VudDsgaisrKQogICAgewogICAgICAgIGlmIChwaGFzZUZhY3RvciA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKChpICsgcG9zaXRpb25YKSAqIC0xKSArIHNpZGVDb3VudDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gaSArIHBvc2l0aW9uWTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocGhhc2VGYWN0b3IgPT0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlgiXSA9IGkgKyBwb3NpdGlvblg7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9IChpICsgcG9zaXRpb25ZKSAtIHNpZGVDb3VudDsgIAogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwaGFzZUZhY3RvciA9PSAyKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKGkgKyBwb3NpdGlvblgpIC0gc2lkZUNvdW50OwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSAoKGkgKyBwb3NpdGlvblkpICogLTEpIDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKChpICsgcG9zaXRpb25YKSAqIC0xKSA7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9ICgoaSArIHBvc2l0aW9uWSkgKiAtMSkgKyBzaWRlQ291bnQ7ICAKICAgICAgICB9CgogICAgICAgIGNvbnN0IG5ld0dyaWRCb3QgPSBhd2FpdCBjcmVhdGUoZ3JpZEJvdCk7CgogICAgICAgIGFuaW1hdGVUYWcobmV3R3JpZEJvdCwgInNjYWxlIiwgewogICAgICAgICAgICB0b1ZhbHVlOiAxLAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICJlbGFzdGljIiwKICAgICAgICAgICAgICAgIG1vZGU6ICJvdXQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAwLjAxCiAgICAgICAgfSkuY2F0Y2goKCkgPT4ge30pOwoKICAgICAgICBuZXdHcmlkQm90LmtpbGxUaW1lcigpOwoKICAgICAgICBzaWRlQ291bnQrKzsKCiAgICAgICAgaWYgKHNpZGVDb3VudCA9PSBib3RDb3VudCAvIDQpCiAgICAgICAgewogICAgICAgICAgICBzaWRlQ291bnQgPSAwOwoKICAgICAgICAgICAgcGhhc2VGYWN0b3IrKzsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLnNsZWVwKDgpOwogICAgfQp9JwCZnOXfDI5YCWFiVmVyc2lvbgIEAJmc5d8M/mcFMTAuMzQnAJmc5d8MjlgGb25DaGF0AgQAmZzl3wyEaFVALy8gaWYgKHRoYXQubWVzc2FnZSA9PSAiQHRlc3QiKQovLyB7Ci8vICAgICB0aGlzQm90LmFuaW1hdGlvbl9hYkdyaWRNYW5pZmVzdCgpOwovLyB9JwCZnOXfDI5YC3BlcnNvbmFsaXR5AgQAmZzl3wzaaCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwCZnOXfDI5YDWFiUGVyc29uYWxpdHkCBACZnOXfDIFpBHRydWUnAQRib3RzJGI3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYgEnAJmc5d8MhmkGc3lzdGVtAgQAmZzl3wyHaRVhYi5wZXJzb25hbGl0eS5jb25maWcnAJmc5d8MhmkIYWJJZ25vcmUCBACZnOXfDJ1pBHRydWUnAJmc5d8MhmkEZm9ybQIEAJmc5d8MomkHbm90aGluZycAmZzl3wyGaQthYkJhc2VDb2xvcgIEAJmc5d8MqmkHIzAwRDlDRCcAmZzl3wyGaRFhYkJhc2VTdHJva2VDb2xvcgIEAJmc5d8MsmkHIzAwRDlDRCcAmZzl3wyGaRBhYkJsdWVwcmludENvbG9yAgQAmZzl3wy6aQcjMDA4MjdCJwCZnOXfDIZpCHJlbWVtYmVyAgQAmZzl3wzCaSjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCZnOXfDIZpEWFiQnVpbGRlcklkZW50aXR5AgQAmZzl3wzpaQpjYXN1YWwuYm90JwCZnOXfDIZpCWFiVmVyc2lvbgIEAJmc5d8M9GkFMTAuMzQnAJmc5d8MhmkXY2hhbmdlUGVyc29uYWxpdHlDb25maWcCBACZnOXfDPpp8hNAaWYgKCF0aGF0KSB7DQogICAgcmV0dXJuOw0KfQ0KDQppZiAoIWF1dGhCb3QpIHsNCiAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOw0KfQ0KDQppZiAoIWF1dGhCb3QpIHsNCiAgICByZXR1cm47DQp9DQoNCmF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90LmlkKTsNCg0KbGV0IGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWJQZXJzb25hbGl0eUNvbmZpZyIpOw0KDQppZiAoYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuc3VjY2VzcyA9PSBmYWxzZSkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0ge307DQp9IGVsc2Ugew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0gYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuZGF0YTsNCn0NCg0KaWYgKHRoYXQubmFtZSkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJ1aWxkZXJJZGVudGl0eSJdID0gdGhhdC5uYW1lOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQnVpbGRlcklkZW50aXR5IiwgdGhhdC5uYW1lLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQuY29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlQ29sb3IiXSA9IHRoYXQuY29sb3I7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQmFzZVN0cm9rZUNvbG9yIl0gPSB0aGF0LmNvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZUNvbG9yIiwgdGhhdC5jb2xvciwgImxvY2FsIik7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlU3Ryb2tlQ29sb3IiLCB0aGF0LmNvbG9yLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQucG9ydGFsQ29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlR3JpZFBvcnRhbENvbG9yIl0gPSB0aGF0LnBvcnRhbENvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZUdyaWRQb3J0YWxDb2xvciIsIHRoYXQucG9ydGFsQ29sb3IsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5tZW51Q29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlTWVudUNvbG9yIl0gPSB0aGF0Lm1lbnVDb2xvcjsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VNZW51Q29sb3IiLCB0aGF0Lm1lbnVDb2xvciwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0Lm1lbnVMYWJlbENvbG9yKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQmFzZUxhYmVsQ29sb3IiXSA9IHRoYXQubWVudUxhYmVsQ29sb3I7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlTGFiZWxDb2xvciIsIHRoYXQubWVudUxhYmVsQ29sb3IsICJsb2NhbCIpOw0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VTaGFkb3dDb2xvciJdID0gdGhhdC5tZW51TGFiZWxDb2xvcjsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VTaGFkb3dDb2xvciIsIHRoYXQubWVudUxhYmVsQ29sb3IsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5mb3JtKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiRm9ybSJdID0gdGhhdC5mb3JtOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiRm9ybSIsIHRoYXQuZm9ybSwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0LmFpTW9kZWwpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJQcmVmZXJyZWRBSU1vZGVsIl0gPSB0aGF0LmFpTW9kZWw7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJQcmVmZXJyZWRBSU1vZGVsIiwgdGhhdC5haU1vZGVsLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQuZGVmYXVsdFBlcnNvbmFsaXR5KSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSB7fTsNCiAgICB0aGlzQm90LnVwZGF0ZVBlcnNvbmFsaXR5KHt9KTsNCn0NCg0KaWYgKHRoYXQubWFwQmFzZW1hcCkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYk1hcFBvcnRhbEJhc2UiXSA9IHRoYXQubWFwQmFzZW1hcDsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYk1hcFBvcnRhbEJhc2UiLCB0aGF0Lm1hcEJhc2VtYXAsICJsb2NhbCIpOw0KfQ0KDQpjb25zdCByZXN1bHQgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICJhYlBlcnNvbmFsaXR5Q29uZmlnIiwgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEpOw0KDQppZiAocmVzdWx0LnN1Y2Nlc3MpIHsNCiAgICBhYi5saW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGB1cGRhdGVkIHBlcnNvbmFsaXR5IGNvbmZpZyBpbiB1c2VyIHJlY29yZGAsIGxvZ1R5cGU6ICdsb2cnfSk7DQp9IGVsc2Ugew0KICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGZhaWxlZCB0byB1cGRhdGUgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkLlxuJHtKU09OLnN0cmluZ2lmeShyZXN1bHQsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOw0KfQ0KDQpzaG91dCgnb25BQlBlcnNvbmFsaXR5Q2hhbmdlZCcsIHsgYm90OiB0aGlzQm90IH0pOycAmZzl3wyGaQ9hYkJhc2VNZW51Q29sb3ICBACZnOXfDO19ByMwMEQ5Q0QnAJmc5d8MhmkRdXBkYXRlUGVyc29uYWxpdHkCBACZnOXfDPV9lhdAaWYgKHRhZ3MuZGVidWcpIHsNCiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0ZSBzdGFydGApOw0KfQ0KDQppZiAodGhpc0JvdC52YXJzLnVwZGF0aW5nUGVyc29uYWxpdHkpIHsNCiAgICByZXR1cm47DQp9DQoNCnRoaXNCb3QudmFycy51cGRhdGluZ1BlcnNvbmFsaXR5ID0gdHJ1ZTsNCg0KbGV0IGFiUGVyc29uYWxpdHlDb25maWdEYXRhOw0KDQppZiAodGhhdCAmJiB0aGF0ID09IHt9KSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSB7fTsNCn0gZWxzZSB7DQogICAgaWYgKCFhdXRoQm90KSB7DQogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7DQogICAgfQ0KDQogICAgaWYgKGF1dGhCb3QpIHsNCiAgICAgICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhYlBlcnNvbmFsaXR5Q29uZmlnIik7DQogICAgICAgIGlmICghbGlua3MucmVtZW1iZXIgJiYgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuc3VjY2VzcyA9PSBmYWxzZSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLnVwZGF0aW5nUGVyc29uYWxpdHkgPSBmYWxzZTsNCiAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmIChhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5zdWNjZXNzKSB7DQogICAgICAgICAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSA9IGFiUGVyc29uYWxpdHlDb25maWdEYXRhLmRhdGE7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCmlmICh0YWdzLmRlYnVnKSB7DQogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YTpgLCB7Li4uYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGF9KTsNCn0NCg0KLy9hYkJsdWVQcmludENvbG9yDQovL2FiQmFzZUFjY2VudENvbG9yDQpjb25zdCBhYlRhZ3MgPSBbDQogICAgImFiQmFzZUNvbG9yIiwNCiAgICAiYWJCYXNlTWVudUNvbG9yIiwNCiAgICAiYWJCdWlsZGVySWRlbnRpdHkiLA0KICAgICJhYkJhc2VTdHJva2VDb2xvciIsDQogICAgImFiQmFzZUdyaWRQb3J0YWxDb2xvciIsDQogICAgImFiQmFzZUxhYmVsQ29sb3IiLA0KICAgICJhYkJhc2VTaGFkb3dDb2xvciIsDQogICAgImFiUHJlZmVycmVkQUlNb2RlbCIsDQogICAgImFiQ2F0YWxvZ05hbWUiLA0KICAgICJhYk1hcFBvcnRhbEJhc2UiDQpdOw0KDQpjbGVhclRhZ01hc2tzKHRoaXNCb3QpOw0KDQovLyBSeWFuIChBdWcgMjksIDIwMjUpOiBpbSBub3Qgc3VyZSBleGFjdGx5IHdoYXQgaXMgaGFwcGVuaW5nIGhlcmUgYnV0IHdpdGhvdXQgc2xlZXBpbmcgb24gdGhlc2UgYmlnIHRhZyBtYXNrIGNoYW5nZXMsIHRoZXkgZG9udCBhbGwgc2VlbSB0byBjb21lIGluIHByb3Blcmx5Lg0KYXdhaXQgb3Muc2xlZXAoMTAwKTsNCg0KZm9yIChsZXQgaSA9IDA7IGkgPCBhYlRhZ3MubGVuZ3RoOyArK2kpIHsNCiAgICBpZiAoYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgJiYgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbYWJUYWdzW2ldXSkgew0KICAgICAgICBpZiAodGFnc1thYlRhZ3NbaV1dICE9IGFiUGVyc29uYWxpdHlDb25maWdEYXRhW2FiVGFnc1tpXV0pIHsNCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzZXR0aW5nICR7YWJUYWdzW2ldfSBsb2NhbCBtYXNrIGZyb20gYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGE6ICR7YWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbYWJUYWdzW2ldXX1gKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgYWJUYWdzW2ldLCBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVthYlRhZ3NbaV1dLCAibG9jYWwiKTsNCiAgICAgICAgfQ0KICAgIH0gZWxzZSBpZiAobGlua3MucmVtZW1iZXIgJiYgbGlua3MucmVtZW1iZXIudGFnc1thYlRhZ3NbaV1dKSB7DQogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW2FiVGFnc1tpXV0gIT0gdGFnc1thYlRhZ3NbaV1dKSB7DQogICAgICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2V0dGluZyAke2FiVGFnc1tpXX0gbG9jYWwgbWFzayBmcm9tIGFiIHJlbWVtYmVyIGJvdDpgLCBsaW5rcy5yZW1lbWJlci50YWdzW2FiVGFnc1tpXV0pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCBhYlRhZ3NbaV0sIGxpbmtzLnJlbWVtYmVyLnRhZ3NbYWJUYWdzW2ldXSwgImxvY2FsIik7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBpZiAoYWJUYWdzW2ldID09ICJhYkJhc2VHcmlkUG9ydGFsQ29sb3IiKSB7DQogICAgICAgIGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxDb2xvciA9IHRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yOw0KICAgIH0NCg0KICAgIGlmIChhYlRhZ3NbaV0gPT0gImFiTWFwUG9ydGFsQmFzZSIpIHsNCiAgICAgICAgbWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCA9IHRhZ3MuYWJNYXBQb3J0YWxCYXNlOw0KICAgICAgICBtaW5pTWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCA9IHRhZ3MuYWJNYXBQb3J0YWxCYXNlOw0KICAgIH0NCn0NCg0KLy8gUnlhbiAoQXVnIDI5LCAyMDI1KTogaW0gbm90IHN1cmUgZXhhY3RseSB3aGF0IGlzIGhhcHBlbmluZyBoZXJlIGJ1dCB3aXRob3V0IHNsZWVwaW5nIG9uIHRoZXNlIGJpZyB0YWcgbWFzayBjaGFuZ2VzLCB0aGV5IGRvbnQgYWxsIHNlZW0gdG8gY29tZSBpbiBwcm9wZXJseS4NCmF3YWl0IG9zLnNsZWVwKDEwMCk7DQoNCnRoaXNCb3QudmFycy51cGRhdGluZ1BlcnNvbmFsaXR5ID0gZmFsc2U7DQpzaG91dCgnb25BQlBlcnNvbmFsaXR5VXBkYXRlZCcsIHsgYm90OiB0aGlzQm90IH0pOycAmZzl3wyGaQ1hYlBlcnNvbmFsaXR5AgQAmZzl3wyMlQEEdHJ1ZScAmZzl3wyGaQ1vblNraWxsVXBkYXRlAgQAmZzl3wyRlQEdQHRoaXNCb3QudXBkYXRlUGVyc29uYWxpdHkoKTsnAJmc5d8MhmkRYWJCYXNlU2hhZG93Q29sb3ICBACZnOXfDK+VAQVibGFjaycAmZzl3wyGaRBhYkJhc2VMYWJlbENvbG9yAgQAmZzl3wy1lQEFYmxhY2snAJmc5d8MhmkKbWFwT3B0aW9ucwIEAJmc5d8Mu5UBngfwn6esWw0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInNhdGVsbGl0ZSIsDQogICAgICAgICJpZCI6ICJzYXRlbGxpdGUiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJoeWJyaWQiLA0KICAgICAgICAiaWQiOiAiaHlicmlkIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAib2NlYW5zIiwNCiAgICAgICAgImlkIjogIm9jZWFucyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgIm9wZW4gc3RyZWV0IG1hcCIsDQogICAgICAgICJpZCI6ICJvc20iDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJ0ZXJyYWluIiwNCiAgICAgICAgImlkIjogInRlcnJhaW4iDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJkYXJrIGdyYXkgY2FudmFzIiwNCiAgICAgICAgImlkIjogImRhcmstZ3JheSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImdyYXkgY2FudmFzIiwNCiAgICAgICAgImlkIjogImdyYXkiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIiwNCiAgICAgICAgImlkIjogInN0cmVldHMiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChkYXJrKSIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzLW5pZ2h0LXZlY3RvciINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKG5hdmlnYXRpb24pIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtbmF2aWdhdGlvbi12ZWN0b3IiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJ0b3BvZ3JhcGhpYyIsDQogICAgICAgICJpZCI6ICJ0b3BvIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAocmVsaWVmKSIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzLXJlbGllZi12ZWN0b3IiDQogICAgfQ0KXScAmZzl3wyGaRRzaG93QUJCYXNlbWFwT3B0aW9ucwIEAJmc5d8M2JwBxAVAc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCg0Kc2hvdXQoImFiTWVudVJlZnJlc2giKTsNCmNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgPSAnYWJCYXNlbWFwT3B0aW9uc01lbnUnOw0KDQpmb3IgKGNvbnN0IG9wdGlvbiBvZiB0YWdzLm1hcE9wdGlvbnMpIHsNCiAgICBpZiAob3B0aW9uLmlkID09IG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXApIHsNCiAgICAgICAgY29udGludWU7DQogICAgfQ0KICAgIGNvbnN0IG9wdGlvbk9iaiA9IA0KICAgIHsNCiAgICAgICAgYWJCYXNlbWFwT3B0aW9uc01lbnU6IHRydWUsDQogICAgICAgIGNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnU6IGBAZGVzdHJveSh0aGlzQm90KTtgLA0KICAgICAgICBtYXBJRDogb3B0aW9uLmlkLA0KICAgICAgICBsYWJlbDogb3B0aW9uLm5hbWUsDQogICAgICAgIG9uQ2xpY2s6IGBADQogICAgICAgICAgICBtYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwID0gdGFncy5tYXBJRDsNCiAgICAgICAgICAgIHNob3V0KCdjaGFuZ2VQZXJzb25hbGl0eUNvbmZpZycsIHsnbWFwQmFzZW1hcCc6IHRhZ3MubWFwSUR9KTsgDQogICAgICAgICAgICBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KICAgICAgICBgDQogICAgfQ0KDQogICAgYWIubGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24ob3B0aW9uT2JqKTsNCn0nAJmc5d8MhmkLb25HcmlkQ2xpY2sCBACZnOXfDJ2iASZAc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCicAmZzl3wyGaQVkZWJ1ZwIEAJmc5d8MxKIBBWZhbHNlJwEEYm90cyRiOWI4MjgxOS0xZjE0LTQzOTItODhhOS01MmY2N2E5ZjhlNTUBJwCZnOXfDMqiAQZzeXN0ZW0CBACZnOXfDMuiARhhYi5wZXJzb25hbGl0eS5hcm1fbnVkZ2UnAJmc5d8MyqIBDW9uQUJBcm1QbGFjZWQCBACZnOXfDOSiAThAc2V0VGFnTWFzayh0aGlzQm90LCAnaGFzQXJtQmVlblBsYWNlZCcsIHRydWUsICdsb2NhbCcpOycAmZzl3wzKogEJb25BQkF3YWtlAgQAmZzl3wydowEwQGF3YWl0IG9zLnNsZWVwKDI1MCk7CnRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwCZnOXfDMqiAQhhYklnbm9yZQIEAJmc5d8MzqMBBHRydWUnAJmc5d8MyqIBDWFiUGVyc29uYWxpdHkCBACZnOXfDNOjAQR0cnVlJwCZnOXfDMqiAQRmb3JtAgQAmZzl3wzYowEHbm90aGluZycAmZzl3wzKogEFbGVhcm4CBACZnOXfDOCjASjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCZnOXfDMqiAQ1tYW5pZmVzdGF0aW9uAgQAmZzl3wyHpAEo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAmZzl3wzKogEIcmVtZW1iZXICBACZnOXfDK6kASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCZnOXfDMqiAQVkZWJ1ZwIEAJmc5d8M1aQBBWZhbHNlJwCZnOXfDMqiAQ5hcm1OdWRnZVdhaXRNUwIEAJmc5d8M26QBBDUwMDAnAJmc5d8MyqIBD29uQUJJbml0aWFsaXplZAIEAJmc5d8M4KQBG0B0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycAmZzl3wzKogEPYWJTdGFydEFybU51ZGdlAgQAmZzl3wz8pAHiG0BpZiAodGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhlcmUgaXMgYWxyZWFkeSBhIG51ZGdlIGluIHByb2dyZXNzLmApOwogICAgfQogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUgPSB0cnVlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhcnRpbmcgbnVkZ2UuLi5gKQp9CgpmdW5jdGlvbiBjYW5OdWRnZSgpOiBib29sZWFuIHsKICAgIC8vIENhbid0IGhhdmUgcGxhY2VkIHRoZSBhcm0gYWxyZWFkeS4KICAgIGlmICh0YWdzLmhhc0FybUJlZW5QbGFjZWQpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYXJtIHBsYWNlbWVudCBoYXMgYWxyZWFkeSBvY2N1cmVkLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gQUIgbWFuaWZlc3RhdGlvbiBib3QgbXVzdCBiZSBhY3RpdmUuCiAgICBpZiAoIWxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYWIgbWFuaWZlc3RhdGlvbiBib3QgaXMgaW5hY3RpdmUuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBUaGUgaW5zdCBtdXN0IGJlIGVtcHR5IG9mIGFsbCBib3RzLiBUaGUgZXhjZXB0aW9ucyBhcmUgYWIgYm90cyBhbmQgYnVpbHQtaW4gYm90cy4KICAgIGNvbnN0IHVzZXJNYWRlQm90ID0gZ2V0Qm90KChiKSA9PiB7CiAgICAgICAgcmV0dXJuICFiLnRhZ3Muc3lzdGVtPy5zdGFydHNXaXRoKCdhYi4nKSAmJgogICAgICAgICAgICAgICAgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYKICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJFZ2cgLy8gRG9uJ3QgaW5jbHVkZSBhYkVnZyBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgfSkKICAgIAogICAgaWYgKHVzZXJNYWRlQm90KSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdVc2VyTWFkZUJvdHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJNYWRlQm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWIudGFncy5zeXN0ZW0/LnN0YXJ0c1dpdGgoJ2FiLicpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiLnNwYWNlID09PSAnc2hhcmVkJyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIWIudGFncy5hYkVnZyAvLyBEb24ndCBpbmNsdWRlIGFiRWdnIGJvdHMgYXMgInVzZXIgbWFkZSIuCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGluc3QgY29udGFpbnMgdXNlciBtYWRlIGJvdHMuYCwgdXNlck1hZGVCb3RzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBpbnN0IGNvbnRhaW5zIHVzZXIgbWFkZSBib3RzLmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBNZW51IHBvcnRhbCBtdXN0IGVpdGhlciBiZSBpbmFjdGl2ZSBvciBub3QgaGF2ZSBhbnkgYm90cyBpbiB0aGUgY3VycmVudGx5IGFjdGl2ZSBtZW51IHBvcnRhbC4KICAgIGlmIChjb25maWdCb3QudGFncy5tZW51UG9ydGFsKSB7CiAgICAgICAgY29uc3QgYm90SW5NZW51UG9ydGFsID0gZ2V0Qm90KChiKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBiLnRhZ3NbY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbF0gPT09IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGJvdEluTWVudVBvcnRhbCkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IG9wZW4gYW5kIGhhcyBib3RzIGluIGl0LmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn0KCmlmIChjYW5OdWRnZSgpKSB7CiAgICAvLyBTdGFydCBudWRnZSBmb3IgYXJtIHBsYWNlbWVudC4KICAgIGF3YWl0IG9zLnNsZWVwKHRhZ3MuYXJtTnVkZ2VXYWl0TVMpOwoKICAgIGlmIChjYW5OdWRnZSgpKSB7CiAgICAgICAgY29uc3QgYWJQb3NpdGlvblggPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LnRhZ3NbbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiArICdYJ107CiAgICAgICAgY29uc3QgYWJQb3NpdGlvblkgPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LnRhZ3NbbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiArICdZJ107CgogICAgICAgIGNvbnN0IGdyaWRDbGlja1BhcmFtcyA9IHsKICAgICAgICAgICAgZGltZW5zaW9uOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uLAogICAgICAgICAgICBwb3NpdGlvbjogeyB4OiBhYlBvc2l0aW9uWCArIDUsIHk6IGFiUG9zaXRpb25ZIH0sCiAgICAgICAgICAgIGZvcmNlQXJtUGxhY2VtZW50OiB0cnVlLAogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA9PT0gbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbikgewogICAgICAgICAgICAvLyBNYXAgcG9ydGFsIGlzIGluIGRpZmZlcmVudCBjb29yZGluYXRlIHNwYWNlIGFuZCBzY2FsZS4KICAgICAgICAgICAgZ3JpZENsaWNrUGFyYW1zLnBvc2l0aW9uLnggPSBhYlBvc2l0aW9uWCArIDAuMDAwMzU3NDM0MDY4NDA1MzgyMzsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2hpc3BlcmluZyBvbkdyaWRDbGljayB0byB0aGUgYWIgbWFuaWZlc3RhdGlvbiBib3Qgd2l0aCB0aGUgcGFyYW1zOmAsIGdyaWRDbGlja1BhcmFtcykKICAgICAgICB9CgogICAgICAgIC8vIEZvcmNlIGFiIGFybSBwbGFjZW1lbnQgdXNpbmcgdGhlIG9uR3JpZENsaWNrIGxpc3RlbmVyIG9mIHRoZSBtYW5pZmVzdGF0aW9uIGJvdC4KICAgICAgICB3aGlzcGVyKGxpbmtzLm1hbmlmZXN0YXRpb24sICdvbkdyaWRDbGljaycsIGdyaWRDbGlja1BhcmFtcyk7CiAgICB9Cn0KCnRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSA9IGZhbHNlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZG9uZWApOwp9JwCZnOXfDMqiAQlhYlZlcnNpb24CBACZnOXfDN/AAQUxMC4zNCcAmZzl3wzKogEPb25Qb3J0YWxDaGFuZ2VkAgQAmZzl3wzlwAGFAUBjb25zdCB7IHBvcnRhbCwgZGltZW5zaW9uIH0gPSB0aGF0OwoKaWYgKHBvcnRhbCA9PT0gJ21lbnVQb3J0YWwnKSB7CiAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgIHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7CiAgICB9Cn0nAJmc5d8MyqIBDWFiTWVudVJlZnJlc2gCBACZnOXfDOvBARtAdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnAJmc5d8MyqIBEWRlYnVnVXNlck1hZGVCb3RzAgQAmZzl3wyHwgEFZmFsc2UnAQRib3RzJGRjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZAEnAJmc5d8MjcIBBnN5c3RlbQIEAJmc5d8MjsIBHGFiLnBlcnNvbmFsaXR5Lm1hbmlmZXN0YXRpb24nAJmc5d8MjcIBBGZvcm0CBACZnOXfDKvCAQdub3RoaW5nJwCZnOXfDI3CAQtkZXNjcmlwdGlvbgIEAJmc5d8Ms8IBOFRoaXMgc2tpbGwgY29udHJvbHMgdGhlIGFjdHVhbCBib3QgZm9yIHRoZSBhYiBpbnRlcmZhY2UuJwCZnOXfDI3CAQVsZWFybgIEAJmc5d8M7MIBKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJmc5d8MjcIBD29uUG9ydGFsQ2hhbmdlZAIEAJmc5d8Mk8MBs0BAY29uc3QgUE9SVEFMU19USEFUX0hJREUgPSBuZXcgU2V0KFsKICAgICJzeXN0ZW1Qb3J0YWwiLAogICAgInNoZWV0UG9ydGFsIgpdKQoKY29uc3QgUE9SVEFMU19USEFUX01BTklGRVNUID0gbmV3IFNldChbCiAgICAiZ3JpZFBvcnRhbCIsCiAgICAibWFwUG9ydGFsIgpdKTsKCmFzeW5jIGZ1bmN0aW9uIGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKHBvcnRhbDogJ21hcCcgfCAnZ3JpZCcpOiB7IHg6IG51bWJlciwgeTogbnVtYmVyIH0gewogICAgaWYgKHBvcnRhbCA9PT0gJ2dyaWQnKSB7CiAgICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9CiAgICB9IGVsc2UgaWYgKHBvcnRhbCA9PT0gJ21hcCcpIHsKICAgICAgICBpZiAodHlwZW9mIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwWm9vbVBvc2l0aW9uPy54ID09PSAnbnVtYmVyJyAmJiAgdHlwZW9mIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwWm9vbVBvc2l0aW9uPy55ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByZXR1cm4gbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IGN1cnJlbnRQb3NpdGlvbiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgbGV0IGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbiA9IGF3YWl0IGxpbmtzLnV0aWxzLmhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbigpOwoKICAgICAgICAgICAgLy8gQ3VycmVudCB3b3JrLWFyb3VuZCBmb3IgYWxsb3dpbmcgZ2VvbG9jYXRpb24gZm9yIGlPUyBhcHAKICAgICAgICAgICAgaWYgKGdldEJvdCgic3lzdGVtIiwgImFiLmlvc2JyaWRnZS5tZXNzZW5nZXIiKSkgewogICAgICAgICAgICAgICAgaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbikgewogICAgICAgICAgICAgICAgY29uc3QgZ2VvbG9jYXRpb24gPSBhd2FpdCBvcy5nZXRHZW9sb2NhdGlvbigpOwogICAgICAgICAgICAgICAgaWYgKGdlb2xvY2F0aW9uLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UG9zaXRpb24gPSB7IHg6IGdlb2xvY2F0aW9uLmxvbmdpdHVkZSwgeTogZ2VvbG9jYXRpb24ubGF0aXR1ZGUgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY3VycmVudFBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFBvc2l0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gR1JQTSBQb3NpdGlvbgogICAgICAgICAgICAgICAgcmV0dXJuIHsgeDogLTg1LjY3NjE4OTQ4MjI0MzQsIHk6IDQyLjk2NTY3NTY3NTY3NTYgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVucmVjb25naXplZCBwb3J0YWwgdHlwZSBwcm92aWRlZCB0byBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbjpgLCBwb3J0YWwpOwogICAgICAgIHJldHVybiB7IHg6IDAsIHk6IDAgfQogICAgfQp9Cgpjb25zdCBNQVBfTE9BRF9XQUlUX1RJTUUgPSAxMDAwOwoKZm9yIChjb25zdCBwb3J0YWwgb2YgUE9SVEFMU19USEFUX0hJREUpIHsKICAgIGlmIChjb25maWdCb3QudGFnc1twb3J0YWxdICE9IG51bGwpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGEgcG9ydGFsIHRoYXQgaGlkZXMgYWIgaXMgb3BlbiAtIGhpZGluZyBhYkJvdCBhbmQgaWdub3JpbmcuYCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsICE9IG51bGwgfHwgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsICE9IG51bGwpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGVldCBwb3J0YWwgb3Igc3lzdGVtIHBvcnRhbCBvcGVuZWQgLSBoaWRpbmcgYWJCb3QgYW5kIGlnbm9yaW5nLmApOwogICAgfQoKICAgIGlmICh0YWdzLmFiQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdCk7CiAgICB9CgogICAgcmV0dXJuOwp9CgppZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIGlzIG5vdCBhd2FrZSAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gInRhZ1BvcnRhbCIpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0YWdQb3J0YWwgY2hhbmdlZCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gIm1lbnVQb3J0YWwiKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWVudVBvcnRhbCBjaGFuZ2VkIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAiZ3JpZFBvcnRhbCIgJiYgY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ3JpZFBvcnRhbCBjaGFuZ2VkLCBidXQgYWxzbyBhbHJlYWR5IGluIHRoZSBtYXBQb3J0YWwgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKLy8gVGhlIG1hcCBwb3J0YWwgaXMgdG91Z2guIEl0IHNlZW1zIHRvIHZhcnkgaW4gbG9hZGluZyBzcGVlZCBvbgovLyB2YXJpb3VzIGhhcmR3YXJlIGFuZCBuZXR3b3JrcyBhbmQgaGFzIGJ5IHRoZSB0aW1lIG9uUG9ydGFsQ2hhbmdlZCBpcyBjYWxsZWQgaXQgZG9lc250Ci8vIHNlZW0gZ3VhcmVudGVlZCB0byBiZSBhY3R1YWxseSByZWFkeS4gQWRkaW5nIGEgaGFyZGNvZGVkIHdhaXQgdGltZSB0byBnaXZlIHRoZSBwb3J0YWwgc3BhY2UgdG8gZ2V0Ci8vIHRoZSBtYXAgcG9ydGFsIGZ1bGx5IGxvYWRlZCBiZWZvcmUgY29udGludWluZyB3aXRoIG1hbmlmZXN0aW5nIGFiLgovLwovLyBBdCBzb21lIHBvaW50IHRoaXMgY2FuIGdvIGF3YXkgaWYgd2UgZXZlciBnZXQgYSBzaG91dCBvciBzb21lIG90aGVyIGdhdXJlbnRlZSB0aGF0IHRoZSBtYXAgcG9ydGFsIGlzIGxvYWRlZC9yZWFkeS4KaWYgKHRoYXQucG9ydGFsID09PSAnbWFwUG9ydGFsJykgewogICAgaWYgKHRoYXQuZGltZW5zaW9uKSB7CiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkKSB7CiAgICAgICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gb3Muc2xlZXAoTUFQX0xPQURfV0FJVF9USU1FKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3YWl0aW5nIGZvciBtYXAgcG9ydGFsIHRvIGZpbmlzaCBsb2FkaW5nOiAke01BUF9MT0FEX1dBSVRfVElNRX1tc2ApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlcjsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwogICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXAgcG9ydGFsIGlzIGFscmVhZHkgbG9hZGVkLmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gZmFsc2U7CiAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcCBwb3J0YWwgaGFzIGJlZW4gdW5sb2FkZWQuYCk7CiAgICAgICAgfQogICAgfQp9CgovLyBTdGFydCBjaGVja3MgZm9yIGlmL3doZXJlIHdlIG5lZWQgdG8gbWFuaWZlc3QgYWIuCmxldCBuZXdBQiA9IGZhbHNlOwpsZXQgbmV3QUJQb3J0YWw7CmxldCBuZXdBQlBvc2l0aW9uOwpsZXQgZm9jdXNDYW1lcmEgPSB0cnVlOwoKaWYgKFBPUlRBTFNfVEhBVF9NQU5JRkVTVC5oYXModGhhdC5wb3J0YWwpICYmIHRoYXQuZGltZW5zaW9uKSB7CiAgICAvLyBBIHBvcnRhbCB0aGF0IG1hbmlmZXN0cyBhYiBoYXMganVzdCBjaGFuZ2VkIGRpbWVuc2lvbi4KICAgIC8vIE1hbmlmZXN0IGFiIGluIHRoZSBuZXcgZGltZW5zaW9uLgogICAgaWYgKHRoYXQucG9ydGFsID09ICJtYXBQb3J0YWwiIHx8IHRoYXQucG9ydGFsID09ICJtaW5pTWFwUG9ydGFsIikgezsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hbmlmZXN0aW5nIGFiIGJvdCBpbiBtYXAgcG9ydGFsIGRpbWVuc2lvbiAnJHt0aGF0LmRpbWVuc2lvbn0nLmApOwogICAgICAgIH0KCiAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICBuZXdBQlBvcnRhbCA9IHRoYXQucG9ydGFsOwogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgcG9zaXRpb246IG5ld0FCUG9zaXRpb24gfSk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hbmlmZXN0aW5nIGFiIGJvdCBkaW1lbnNpb24gJyR7dGhhdC5kaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignZ3JpZCcpOwogICAgICAgIG5ld0FCUG9ydGFsID0gdGhhdC5wb3J0YWw7CiAgICAgICAgbmV3QUIgPSBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKICAgIH0KfSBlbHNlIGlmICgoUE9SVEFMU19USEFUX01BTklGRVNULmhhcyh0aGF0LnBvcnRhbCkgfHwgUE9SVEFMU19USEFUX0hJREUuaGFzKHRoYXQucG9ydGFsKSkgJiYgCiAgICAgICAgICAgIXRoYXQuZGltZW5zaW9uICYmIAogICAgICAgICAgIChjb25maWdCb3QudGFncy5ncmlkUG9ydGFsIHx8IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkKKSB7CiAgICAvLyBBIHBvcnRhbCB0aGF0IHR5cGljYWxseSBoaWRlcyBvciByZS1tYW5pZmVzdHMgYWIganVzdCBjbG9zZWQsIGJ1dCBlaXRoZXIgdGhlIGdyaWQgb3IgbWFwIHBvcnRhbCBhcmUgc3RpbGwgb3Blbi4KICAgIC8vIFN1bW1vbiBhYiBpbiBlaXRoZXIgdGhlIG1hcFBvcnRhbCBvciBncmlkUG9ydGFsLgogICAgbGV0IHN1bW1vbkRpbWVuc2lvbjsKCiAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICAgICAgc3VtbW9uRGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ21hcFBvcnRhbCc7CiAgICAgICAgCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10pIHsKICAgICAgICAgICAgLy8gVXNlIGxhc3Qga25vd24gcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IG1hcCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwpIHsKICAgICAgICBzdW1tb25EaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ2dyaWRQb3J0YWwnOwoKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXSkgewogICAgICAgICAgICAvLyBVc2UgbGFzdCBrbm93biBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVXNlIGRlZmF1bHQgZ3JpZCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdncmlkJyk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChzdW1tb25EaW1lbnNpb24pIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN1bW1vbmluZyBhYiBib3QgaW4gJHtuZXdBQlBvcnRhbH0gZGltZW5zaW9uICcke3N1bW1vbkRpbWVuc2lvbn0nLmApOwogICAgICAgIH0KCiAgICAgICAgbmV3QUIgPSBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb246IHN1bW1vbkRpbWVuc2lvbiwgcG9zaXRpb246IG5ld0FCUG9zaXRpb24gfSk7CgogICAgICAgIGlmIChQT1JUQUxTX1RIQVRfSElERS5oYXModGhhdC5wb3J0YWwpKSB7CiAgICAgICAgICAgIC8vIElmIHRoZSBwb3J0YWwgdGhhdCBjbG9zZWQgd2FzIGEgcG9ydGFsIHRoYXQgaGlkZXMgYWIsIHRoZW4gZG9udCBydW4gdGhlIGNhbWVyYSBmb2N1cy4KICAgICAgICAgICAgLy8gVGhpcyB3aWxsIGp1c3QgdXNlIHRoZSBwcmV2aW91cyBjYW1lcmEgcG9zaXRpb24gYWxyZWFkeSBzdG9yZWQgaW4gbWVtb3J5LgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3aWxsIG5vdCBmb2N1cyBjYW1lcmEgb24gYWIgYmVjYXVzZSB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGUgcHJldmlvdXMgY2FtZXJhIHBvc2l0aW9uLmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvY3VzQ2FtZXJhID0gZmFsc2U7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdGggdGhlIG1hcCBhbmQgZ3JpZCBwb3J0YWwgYXJlIGJvdGggY2xvc2VkLCBjYW5ub3Qgc3VtbW9uIGFiIGluIGVpdGhlci5gKTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICByZXR1cm47Cn0KCmlmIChuZXdBQiAmJiBmb2N1c0NhbWVyYSkgewogICAgbGV0IHpvb20gPSAxMDsKCiAgICBpZiAobmV3QUJQb3J0YWwgPT09ICdtYXBQb3J0YWwnIHx8IG5ld0FCUG9ydGFsID09PSAnbWluaU1hcFBvcnRhbCcpIHsKICAgICAgICB6b29tID0gMjAwMDsKICAgIH0KICAgIHRyeSB7CiAgICAgICAgYXdhaXQgb3MuZm9jdXNPbihuZXdBQlBvc2l0aW9uLCB7IHpvb20sIHJvdGF0aW9uOiB7IHg6IDQ1LCB5OiA0NSB9LCBwb3J0YWw6IG5ld0FCUG9ydGFsIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm9jdXNPbiBlcnJvciBvY2N1cmVkOmAsIGUpOwogICAgICAgIH0KICAgIH0KfScAmZzl3wyNwgEIcmVtZW1iZXICBACZnOXfDMeDAijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCZnOXfDI3CAQ1hYk1hbmlmZXN0Qm90AgQAmZzl3wzugwKcL0Bjb25zdCBkaW1lbnNpb24gPSB0aGF0Py5kaW1lbnNpb247CmNvbnN0IHBvc2l0aW9uID0gdGhhdD8ucG9zaXRpb247CgppZiAodGhpc0JvdC52YXJzLmFiQm90TGFzdElkKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVzdHJveWluZyBhYkJvdGApOwogICAgfQogICAgZGVzdHJveSh0aGlzQm90LnZhcnMuYWJCb3RMYXN0SWQpOwp9Cgpjb25zdCBhYk1vZCA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgZm9ybU9wYWNpdHk6ICcwLjMzJywKICAgIGRpbWVuc2lvbiwKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIHN0cm9rZUNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbGFiZWw6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWwsCiAgICBsYWJlbFBvc2l0aW9uOiAnZnJvbnQnLAogICAgbGFiZWxDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC42MSwKICAgIGRyYWdnYWJsZTogZmFsc2UsCiAgICBzY2FsZTogMC45LAogICAgYXJtU2VsZWN0aW9uOiB0cnVlLAogICAgYXJtR3JvdXBEcmFnOiB0cnVlLAogICAgYXJtVGVsZXBvcnQ6IHRydWUsCiAgICBhcm1Db2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC5hbmltYXRlQm90KCk7CiAgICAgICAgbWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzQm90LmFuaW1hdGVCb3QoKSwgMjAwMCk7CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT0gJ3JpZ2h0JykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChsaW5rcy5hcm1Cb3QpIHsKICAgICAgICAgICAgZGVzdHJveShsaW5rcy5hcm1Cb3QpOwogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKCk7CiAgICB9KSwKICAgIG9uUG9pbnRlckVudGVyOkxpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJykgewogICAgICAgICAgICB0YWdzLm1vdXNlT3ZlciA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvblBvaW50ZXJFeGl0OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScpIHsKICAgICAgICAgICAgdGFncy5tb3VzZU92ZXIgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlckRvd246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnRCdXR0b25Eb3duID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlclVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScgJiYgdGhhdC5idXR0b25JZCA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0QnV0dG9uRG93biA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdERyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvbkRyYWc6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5tb3VzZUxlZnRCdXR0b25Eb3duKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICBvbktleURvd246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5rZXlzLmluY2x1ZGVzKCdTaGlmdCcpKSB7CiAgICAgICAgICAgIHRhZ3Muc2hpZnRIZWxkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgb25LZXlVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmtleXMuaW5jbHVkZXMoJ1NoaWZ0JykpIHsKICAgICAgICAgICAgdGFncy5zaGlmdEhlbGQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgdXBkYXRlUG9ydGFsQ3Vyc29yOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGV0IGN1cnNvciA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLm1vdXNlTGVmdERyYWdnaW5nKSB7CiAgICAgICAgICAgIGN1cnNvciA9ICdncmFiYmluZyc7ICAgIAogICAgICAgIH0gZWxzZSBpZiAodGFncy5tb3VzZU92ZXIpIHsKICAgICAgICAgICAgaWYgKHRhZ3Muc2hpZnRIZWxkKSB7CiAgICAgICAgICAgICAgICBjdXJzb3IgPSAnY29udGV4dC1tZW51JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxDdXJzb3IgPSBjdXJzb3I7CiAgICB9KSwKICAgIGFuaW1hdGVCb3Q6IExpc3RlbmVyU3RyaW5nKGFzeW5jICgpID0+IHsgCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLmFiT3B0aW1pemVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHJvdFogPSB0YWdzLmRpbWVuc2lvbiArICdSb3RhdGlvblonOwogICAgICAgIGxldCB0YXJnZXRTY2FsZSA9IDAuNjU7CgogICAgICAgIGF3YWl0IGFuaW1hdGVUYWcodGhpc0JvdCwKICAgICAgICB7CiAgICAgICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICAgICAgW3JvdFpdOiAwLAogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgICAgICBbcm90Wl06IDYuMywKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgICAgICB0eXBlOiAnc2ludXNvaWRhbCcsCiAgICAgICAgICAgICAgICBtb2RlOiAnaW5vdXQnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAyCiAgICAgICAgfSkuY2F0Y2goZSA9PiB7fSk7CiAgICB9KSwKICAgIG9uQXJtQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKCF0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IHJlc2V0OiB0cnVlIH0pOwogICAgICAgIH0KICAgIH0pLAogICAgb25Bcm1QbGFjZWQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkdyaWRGb2N1cyA9IHsKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgCiAgICAgICAgICAgIHBvc2l0aW9uOiB7CiAgICAgICAgICAgICAgICB4OiB0aGF0LngsCiAgICAgICAgICAgICAgICB5OiB0aGF0LnkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgbWVudTogJ2dyaWQnIH0pOwoKICAgICAgICBzaG91dCgnb25BQkFybVBsYWNlZCcsIHRoYXQpOwogICAgfSksCiAgICBvbkFybUNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgcmVzZXQ6IHRydWUgfSk7CiAgICAgICAgc2hvdXQoJ29uQUJGb290Q2xpY2tlZCcsIHRoYXQpOwogICAgfSksCiAgICBvbkFybVNlbGVjdGVkQm90czogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHNlbGVjdGVkQm90cyA9IHRoYXQ7CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNlbGVjdGVkQm90cykpIHsKICAgICAgICAgICAgLy8gTXVsdGlwbGUgYm90IHNlbGVjdGlvbi4KICAgICAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJNdWx0aXBsZUJvdEZvY3VzID0gZ2V0TGluayhzZWxlY3RlZEJvdHMpOwogICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnbXVsdGlwbGVCb3QnIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFNpbmdsZSBib3Qgc2VsZWN0aW9uLgogICAgICAgICAgICAvLyBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkJvdEZvY3VzID0gZ2V0TGluayhzZWxlY3RlZEJvdHMpOwogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkJvdEZvY3VzID0gIvCflJciICsgc2VsZWN0ZWRCb3RzLmlkOwogICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnYm90JyB9KTsKICAgICAgICB9CgogICAgICAgIHNob3V0KCdvbkFCU2VsZWN0ZWRCb3QnLCBzZWxlY3RlZEJvdHMpOwogICAgfSksCiAgICBvbkFybURlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBzaG91dCgnYWJNZW51UmVmcmVzaCcpOwogICAgfSksCiAgICBvbkRlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjbGVhckludGVydmFsKHRhZ3MuaW50ZXJ2YWwpOwogICAgICAgIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7CiAgICB9KSwKfTsKCmNvbnN0IGFiQm90ID0gY3JlYXRlKGFiTW9kKTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiU2Vjb25kYXJ5TGFiZWwpIHsKICAgIGNvbnN0IGFiTGFiZWxCb3QgPSB7CiAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgICAgIFtkaW1lbnNpb24gKyAnWiddOiAtMSwKICAgICAgICBjcmVhdG9yOiBhYkJvdC5pZCwKICAgICAgICB0cmFuc2Zvcm1lcjogYWJCb3QuaWQsCiAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICBjb2xvcjogJ2NsZWFyJywKICAgICAgICBsYWJlbDogbGlua3MucmVtZW1iZXIudGFncy5hYlNlY29uZGFyeUxhYmVsLAogICAgICAgIGxhYmVsUG9zaXRpb246ICdsZWZ0JywKICAgICAgICBsYWJlbFNpemU6IDAuNywKICAgICAgICBsYWJlbENvbG9yOiBhYkJvdC50YWdzLmxhYmVsQ29sb3IsCiAgICB9OwoKICAgIGNyZWF0ZShhYkxhYmVsQm90KTsKfQoKbWFza3MuYWJCb3QgPSBnZXRMaW5rKGFiQm90KTsKbGlua3MucmVtZW1iZXIubWFza3MuYWJBY3RpdmVEaW1lbnNpb24gPSBkaW1lbnNpb247CnRoaXNCb3QudmFycy5hYkJvdExhc3RJZCA9IGFiQm90LmlkOyAvLyBTdG9yaW5nIGlkIGFzIGEgdmFyIHByZXZlbnRzIGdob3N0IGFiQm90cyBkdXJpbmcgbXVsdGlwbGUgY2FsbHMgaW4gb25lIGZyYW1lLgoKLy8gU3RvcmUgdGhlIGxhc3QgcG9zaXRpb24gb2YgYWIgaW4gdGhpcyBkaW1lbnNpb24gb24gdGhlIHJlbWVtYmVyIGJvdC4KbGlua3MucmVtZW1iZXIubWFza3NbZGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10gPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeSh7IHg6IHBvc2l0aW9uPy54LCB5OiBwb3NpdGlvbj8ueSB9KTsKCmF3YWl0IG9zLnNsZWVwKDApOyAvLyBHaXZlIENhc3VhbE9TIGEgY2hhbmNlIHRvIHVwZGF0ZSB0YWcgbWFza3MuCgpzaG91dCgnb25BQk1vdmVkJywgeyBkaW1lbnNpb24sIHg6IHBvc2l0aW9uLngsIHk6IHBvc2l0aW9uLnkgfSk7CgpyZXR1cm4gYWJCb3Q7JwCZnOXfDI3CAQtvbkdyaWRDbGljawIEAJmc5d8Mh7MCgQ9AaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgIHJldHVybjsKfQoKY29uc3Qgc2hpZnRDaGVjayA9IG9zLmdldElucHV0U3RhdGUoImtleWJvYXJkIiwgIlNoaWZ0Iik7CgppZiAobGlua3MuYWJCb3QgJiYgKHNoaWZ0Q2hlY2sgfHwgKHRoYXQubW9kYWxpdHkgPT0gIm1vdXNlIiAmJiB0aGF0LmJ1dHRvbklkID09ICJyaWdodCIgJiYgIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSaWdodENsaWNrRGlzYWJsZWQpIHx8IHRoYXQuZm9yY2VBcm1QbGFjZW1lbnQpKSB7CiAgICBjb25zdCBhcm1Cb3QgPSBhYi5saW5rcy5hcm1fdG9vbC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBsaW5rcy5hYkJvdCwKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB0aGF0LnBvc2l0aW9uLAogICAgfSkKCiAgICAvLyBGYWtlIHVzZXIgZHJvcHBpbmcgdGhlIGFybSBvbiB0aGUgZ3JpZCBzcGFjZS4KICAgIGFybUJvdC5vbkRyb3AoewogICAgICAgIGJvdDogYXJtQm90LAogICAgICAgIHRvOiB7CiAgICAgICAgICAgIHg6IHRoYXQucG9zaXRpb24ueCwKICAgICAgICAgICAgeTogdGhhdC5wb3NpdGlvbi55LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfSwKICAgICAgICBmcm9tOiB7CiAgICAgICAgICAgIHg6IHRoYXQucG9zaXRpb24ueCwKICAgICAgICAgICAgeTogdGhhdC5wb3NpdGlvbi55LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuOwp9Cgpjb25zdCBmb290cHJpbnQgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgW3RoYXQuZGltZW5zaW9uXTogdHJ1ZSwKICAgIFt0aGF0LmRpbWVuc2lvbiArICJYIl06IHRoYXQucG9zaXRpb24ueCwKICAgIFt0aGF0LmRpbWVuc2lvbiArICJZIl06IHRoYXQucG9zaXRpb24ueSwKICAgIHNjYWxlWjogMC4wMSwKICAgIHBvc2l0aW9uSW5mbzogdGhhdCwKICAgIGNvbG9yOiAiY2xlYXIiLAogICAgcGVyc29uYWxpdHk6IHRhZ3MucGVyc29uYWxpdHksCiAgICBzdHJva2VDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIGRyYWdnYWJsZTogZmFsc2UsCiAgICBjdXJzb3I6ICdhbGlhcycsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb25DcmVhdGU6IExpc3RlbmVyU3RyaW5nKGFzeW5jICgpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGRlc3Ryb3kodGhpc0JvdCksIDgwMCk7CgogICAgICAgIGF3YWl0IGFuaW1hdGVUYWcodGhpc0JvdCwgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIHNjYWxlWDogMC4xLAogICAgICAgICAgICAgICAgc2NhbGVZOiAwLjEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgc2NhbGVYOiAxLjEsCiAgICAgICAgICAgICAgICBzY2FsZVk6IDEuMQogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogMC41LAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICJlbGFzdGljIiwKICAgICAgICAgICAgICAgIG1vZGU6ICJvdXQiCiAgICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChlID0+IHt9KTsKICAgIH0pLAogICAgb25DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgc2hvdXQoIm9uQUJGb290Q2xpY2tlZCIsIHsgZGltZW5zaW9uOiB0YWdzLmRpbWVuc2lvbiB9KTsKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiTWFuaWZlc3RCb3QodGFncy5wb3NpdGlvbkluZm8pOwogICAgfSksCn07CgoKY3JlYXRlKGZvb3RwcmludCk7JwCZnOXfDI3CAQRtZW51AgQAmZzl3wyJwgIo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAmZzl3wyNwgEHYWJDbGljawIEAJmc5d8MsMIC9wtAaWYgKCFsaW5rcy5hYkJvdCkgewogICAgcmV0dXJuOwp9CgppZiAobGlua3MuaW5wdXQpIHsKICAgIGxpbmtzLmlucHV0LmFiQ2hhdEJhckNsb3NlKCk7Cn0KCmNvbnN0IHJlc2V0ID0gdGhhdCA/IHRoYXQucmVzZXQgOiBmYWxzZTsKY29uc3QgbWVudSA9IHRoYXQgPyB0aGF0Lm1lbnUgOiAiY29yZSI7CmNvbnN0IHN0YXRlID0gb3MuZ2V0SW5wdXRTdGF0ZSgia2V5Ym9hcmQiLCAiU2hpZnQiKTsKCmlmICghcmVzZXQgJiYgKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwgfHwgc3RhdGUpKSB7CiAgICBjb25zdCBhYk1lbnVCb3RzID0gZ2V0Qm90cygiYWJNZW51IiwgdHJ1ZSk7CgogICAgd2hpc3BlcihhYk1lbnVCb3RzLCAiYWJNZW51UmVmcmVzaCIpOwoKICAgIGNsZWFySW50ZXJ2YWwobGlua3MuYWJCb3QudGFncy5pbnRlcnZhbCk7CgogICAgbGlua3MuYWJCb3QubWFza3MuaW50ZXJ2YWwgPSBudWxsOwoKICAgIGNsZWFyQW5pbWF0aW9ucyhsaW5rcy5hYkJvdCk7CgogICAgY29uc3Qgcm90WiA9IGxpbmtzLmFiQm90LnRhZ3MuZGltZW5zaW9uICsgIlJvdGF0aW9uWiI7CgogICAgaWYgKHN0YXRlICYmIG1lbnUgPT0gImNvcmUiKSB7CiAgICAgICAgbGlua3MubWVudS5hYkVudmlyb25tZW50TWVudSgpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgbGlua3MubWVudS5hYk9wZW5NZW51KG1lbnUpOwogICAgfQoKICAgIGFuaW1hdGVUYWcobGlua3MuYWJCb3QsIHsKICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgW3JvdFpdOiBsaW5rcy5hYkJvdC50YWdzW3JvdFpdLAogICAgICAgICAgICBzY2FsZTogbGlua3MuYWJCb3QudGFncy5zY2FsZQogICAgICAgIH0sCiAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICBbcm90Wl06IDAsCiAgICAgICAgICAgIHNjYWxlOiAwLjkKICAgICAgICB9LAogICAgICAgIGVhc2luZzogewogICAgICAgICAgICB0eXBlOiAic2ludXNvaWRhbCIsCiAgICAgICAgICAgIG1vZGU6ICJpbm91dCIKICAgICAgICB9LAogICAgICAgIGR1cmF0aW9uOiAwLjUKICAgIH0pLmNhdGNoKGUgPT4ge30pCn0KZWxzZSB7CiAgICBsaW5rcy5hYkJvdC5hbmltYXRlQm90KCk7CgogICAgbGlua3MuYWJCb3QubWFza3MubGluZVRvID0gbnVsbDsKCiAgICBpZiAobGlua3MuYWJCb3QubWFza3MuYXJtQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdC5saW5rcy5hcm1Cb3QpOwogICAgICAgIGxpbmtzLmFiQm90Lm1hc2tzLmFybUJvdCA9IG51bGw7CiAgICB9CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBjbGVhckludGVydmFsKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwpOwogICAgbGlua3MuYWJCb3QubWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiBsaW5rcy5hYkJvdC5hbmltYXRlQm90KCksIDIwMDApOwp9CgpzaG91dCgnb25BQkNsaWNrJywgeyBhYkJvdDogbGlua3MuYWJCb3QsIGRpbWVuc2lvbjogbGlua3MuYWJCb3QudGFncy5kaW1lbnNpb24sIG1lbnUsIHNoaWZ0S2V5OiAhIXN0YXRlLCByZXNldCB9KTsnAJmc5d8MjcIBCGFiSWdub3JlAgQAmZzl3wyozgIEdHJ1ZScAmZzl3wyNwgEDYXNrAgQAmZzl3wytzgIo8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycAmZzl3wyNwgEJYXNrQnV0dG9uAgQAmZzl3wzUzgLIBUBpZiAoIXRhZ3MuYWJBd2FrZSkKewogICAgcmV0dXJuOwp9CgpsZXQgYWJNZW51QnV0dG9uID0ge307CgphYk1lbnVCdXR0b24uYWJNZW51ID0gdHJ1ZTsKYWJNZW51QnV0dG9uLnJlbWVtYmVyID0gbGlua3MubWVudS50YWdzLnJlbWVtYmVyOwphYk1lbnVCdXR0b24ubWFuaWZlc3RhdGlvbiA9IGxpbmtzLm1lbnUudGFncy5tYW5pZmVzdGF0aW9uOwphYk1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKYWJNZW51QnV0dG9uLmJhc2VTa2lsbCA9ICLwn5SXIiArIGxpbmtzLmFzay5pZDsKYWJNZW51QnV0dG9uLmxhYmVsID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUxhYmVsOwphYk1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51SWNvbjsKYWJNZW51QnV0dG9uLm9uQ3JlYXRlID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudU9uR2VuZXJhdGU7CmFiTWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51U29ydE9yZGVyOwphYk1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51Q29sb3IgPyBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51Q29sb3IgOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oYWJNZW51QnV0dG9uKTsnAJmc5d8MjcIBCWFiQm90Q2hhdAIEAJmc5d8Mm9QC7ghAaWYgKCFsaW5rcy5hYkJvdCAmJiAhdGhhdC5ib3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYm90QmFzZSA9IHRoYXQuYm90ID8gdGhhdC5ib3Q6IGxpbmtzLmFiQm90Owpjb25zdCBkaW1lbnNpb24gPSAhdGhhdC5ib3QgPyBib3RCYXNlLnRhZ3MuZGltZW5zaW9uIDogdGhhdC5kaW1lbnNpb24gPyB0aGF0LmRpbWVuc2lvbiA6IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CmNvbnN0IG1lc3NhZ2UgPSB0aGF0Lm1lc3NhZ2U7CmNvbnN0IG1lc3NhZ2VUaW1lID0gdGhhdC50aW1lID8gdGhhdC50aW1lICogMTAwMCA6IDE2MDA7IAoKY29uc3QgbWVzc2FnZUJvdCA9IGF3YWl0IGxpbmtzLmJvdF9mYWN0b3J5LmFiQ3JlYXRlQmlsbGJvYXJkTGFiZWwoewogICAgYm90OiBib3RCYXNlLAogICAgbGFiZWw6IG1lc3NhZ2UsCiAgICBkaW1lbnNpb24sCiAgICBtZXNzYWdlVGltZSwKICAgIGNvbG9yOiAiIzAwMDAwMCIsCiAgICBsYWJlbENvbG9yOiAiI2ZmZmZmZiIsCiAgICBvbkJvdEFkZGVkOiBgQAogICAgICAgIGF3YWl0IG9zLnNsZWVwKHRhZ3MubWVzc2FnZVRpbWUpOwogICAgICAgIHRoaXNCb3Qub25GYWRlKCk7CiAgICBgLAogICAgb25GYWRlOiBgQAogICAgICAgIGFuaW1hdGVUYWcodGhpc0JvdCwgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgIloiXTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICJaIl0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgZm9ybU9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAiWiJdOiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgIloiXSArIDUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246ICR7dGhhdC5kdXJhdGlvbiA/PyAzfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7fSkKICAgICAgICAuZmluYWxseSgoKSA9PiB7CiAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgfSkKCiAgICBgLAp9KTsnAJmc5d8MjcIBCWFiVmVyc2lvbgIEAJmc5d8Mit0CBTEwLjM0JwCZnOXfDI3CAQlhbmltYXRpb24CBACZnOXfDJDdAijwn5SXYjI2ZTEwODktMTcyZC00NWE5LThkMjItMDVjM2Y1OGMyYmY3JwCZnOXfDI3CAQ9vbkFueUJvdENsaWNrZWQCBACZnOXfDLfdAukHQGlmICghbGlua3MucmVtZW1iZXIudGFncy5hYlJpZ2h0Q2xpY2tEaXNhYmxlZCAmJiAhdGhhdC5ib3QudGFncy5hYlJpZ2h0Q2xpY2tJZ25vcmUgJiYgdGhhdC5tb2RhbGl0eSA9PSAibW91c2UiICYmIHRoYXQuYnV0dG9uSWQgPT0gInJpZ2h0IikgewogICAgaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gYWIgc2VsZWN0ZWQKICAgIGlmICh0aGF0LmJvdCA9PSBsaW5rcy5hYkJvdCkgewogICAgICAgIGxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgICAgICByZXR1cm47CiAgICB9ICAgIAogICAgCiAgICBjb25zdCBhcm1Cb3QgPSBhYi5saW5rcy5hcm1fdG9vbC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBsaW5rcy5hYkJvdCwKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB0aGF0LnBvc2l0aW9uLAogICAgfSkKCiAgICBjb25zdCBib3RQb3NpdGlvbiA9IGdldEJvdFBvc2l0aW9uKHRoYXQuYm90LCB0aGF0LmRpbWVuc2lvbik7CgogICAgLy8gRmFrZSB1c2VyIGRyb3BwaW5nIHRoZSBzZWxlY3RpbmcgdGhlIGJvdCB3aXRoIHRoZSBhcm0uCiAgICBhcm1Cb3Qub25Ecm9wKHsKICAgICAgICBib3Q6IGFybUJvdCwKICAgICAgICB0bzogewogICAgICAgICAgICBib3Q6IHRoYXQuYm90LAogICAgICAgICAgICB4OiBib3RQb3NpdGlvbi54LAogICAgICAgICAgICB5OiBib3RQb3NpdGlvbi55LAogICAgICAgICAgICB6OiBib3RQb3NpdGlvbi56LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfSwKICAgICAgICBmcm9tOiB7CiAgICAgICAgICAgIHg6IGJvdFBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IGJvdFBvc2l0aW9uLnksCiAgICAgICAgICAgIHo6IGJvdFBvc2l0aW9uLnosCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm47Cn0nAJmc5d8MjcIBBWlucHV0AgQAmZzl3wyh5QIo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAmZzl3wyNwgELcGVyc29uYWxpdHkCBACZnOXfDMjlAijwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwCZnOXfDI3CAQ1hYlBlcnNvbmFsaXR5AgQAmZzl3wzv5QIEdHJ1ZScAmZzl3wyNwgEKYWJTZXRBd2FrZQIEAJmc5d8M9OUCpRJAbGV0IGF3YWtlID0gdGhhdD8uYXdha2U7CmxldCBpbml0aWFsID0gdGhhdD8uaW5pdGlhbCA/PyBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmFzc2VydCh0eXBlb2YgYXdha2UgPT09ICdib29sZWFuJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhd2FrZSBpcyBhIHJlcXVpcmVkIGJvb2xlYW4gcGFyYW1ldGVyLmApOwoKaWYgKGNvbmZpZ0JvdC50YWdzLmFiU3RheUF3YWtlKSB7CiAgICAvLyBJZiBhYlN0YXlBd2FrZSBpcyBlbmFibGVkLCBvdmVycmlkZSB0aGUgaW5jb21pbmcgYXdha2UgcGFyYW1ldGVyIGFuZCBuZXZlciBsZXQgYWIgYmUgcHV0IHRvIHNsZWVwLgogICAgYXdha2UgPSB0cnVlOwp9CgppZiAodGFncy5hYkF3YWtlICE9PSBhd2FrZSkgewogICAgaWYgKGluaXRpYWwpIHsKICAgICAgICAvLyBMb2FkIHVwIHNvbWUgY29yZSBhYiBza2lsbHMuCiAgICAgICAgY29uc3Qgc2tpbGxBcnJheSA9IFsiYWJQZXJzb25hbGl0eSIsICJhYkludGVyZmFjZSIsICJhYkFjdGlvbiIsICJhYlRlc3RzIl07CgogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2tpbGxBcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMzAwKTsKCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4pIHsKICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gdXVpZCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBQbGF5IGluaXRpYWwgYW5pbWF0aW9uIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbEFuaW1hdGlvbikgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5hbmltYXRpb25bbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxBbmltYXRpb25dKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFNob3cgaW5pdGlhbCBtZXNzYWdlIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpIHsKICAgICAgICAgICAgc2hvdXQoInNob3dDb25zb2xlIik7CgogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZVtpXSk7CgogICAgICAgICAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDIwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBVcGRhdGUgYWJBd2FrZSBzaGFyZWQgdGFnIG1hc2suCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdhYkF3YWtlJywgYXdha2UsICdzaGFyZWQnKTsKICAgIAogICAgaWYgKGF3YWtlKSB7CiAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA6IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CgogICAgICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbiwgcG9zaXRpb246IHsgeDogMCwgeTogMCB9IH0pOwoKICAgICAgICBzaG91dCgib25BQkF3YWtlIiwgeyBkaW1lbnNpb24sIHBvc2l0aW9uOiB7IHg6IDAsIHk6IDAgfSB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdCk7CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgc2hvdXQoIm9uQUJTbGVlcCIpOwogICAgfQp9JwCZnOXfDI3CAQV1dGlscwIEAJmc5d8MmvgCKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAJmc5d8MjcIBC2JvdF9mYWN0b3J5AgQAmZzl3wzB+AIo8J+Ul2M3OGFhNjYzLWQwNWMtNGVjNC1iYzJjLTI2ZmQ1MTU2MGI5NycAmZzl3wyNwgEPb25BQkluaXRpYWxpemVkAgQAmZzl3wzo+AJ9QGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsNCiAgICB0aGlzQm90Lm9uUG9ydGFsQ2hhbmdlZCh7cG9ydGFsOiAibWFwUG9ydGFsIiwgZGltZW5zaW9uOiBjb25maWdCb3QudGFncy5tYXBQb3J0YWx9KTsNCn0nAJmc5d8MjcIBBWRlYnVnAgQAmZzl3wzm+QIFZmFsc2UA"}]}