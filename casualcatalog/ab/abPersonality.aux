{"version":2,"updates":[{"id":0,"timestamp":1770834482057,"update":"AdgBs8vjsAMAJwEEYm90cyQxNjU1NGJjMS1lOTNlLTRhMGItOGNkMy1kZmQ3NzIzMTk2NzIBJwCzy+OwAwAJYWJWZXJzaW9uAgQAs8vjsAMBBTEwLjM4JwCzy+OwAwAGc3lzdGVtAgQAs8vjsAMHFmFiLnBlcnNvbmFsaXR5LnZlcnNpb24nALPL47ADABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQAs8vjsAMeATInALPL47ADAA1vblNraWxsVXBkYXRlAgQAs8vjsAMgrQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAs8vjsAMADWFiUGVyc29uYWxpdHkCBACzy+OwA84BBHRydWUnALPL47ADAAhhYklnbm9yZQIEALPL47AD0wEEdHJ1ZScAs8vjsAMABGZvcm0CBACzy+OwA9gBB25vdGhpbmcnALPL47ADABlhYlBlcnNvbmFsaXR5TWlub3JWZXJzaW9uAgQAs8vjsAPgAQIxNycBBGJvdHMkM2M3NGM5ZjEtODJkYy00NjU1LThiMzgtZTdmMTFkZTg5NzhlAScAs8vjsAPjAQZzeXN0ZW0CBACzy+OwA+QBF2FiLnBlcnNvbmFsaXR5LmFybV90b29sJwCzy+OwA+MBDG9uQW55Qm90RHJhZwIEALPL47AD/AGNCEBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC50YWdzLmFybVNlbGVjdGlvbikgewogICAgaWYgKGRyYWdCb3QubWFza3MuYXJtQm90KSB7CiAgICAgICAgaWYgKGRyYWdCb3QubGlua3MuYXJtQm90LnRhZ3MubXVsdGlTZWxlY3QgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMgJiYgZHJhZ0JvdC50YWdzLmFybUdyb3VwRHJhZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlbmFibGUgY3VzdG9tIGRyYWdnaW5nYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9zLmVuYWJsZUN1c3RvbURyYWdnaW5nKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95IHByZXZpb3VzIGFybUJvdDogJHtkcmFnQm90Lm1hc2tzLmFybUJvdH1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveShkcmFnQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgY29uc3QgbXVsdGlTZWxlY3RLZXlIZWxkID0gb3MuZ2V0SW5wdXRTdGF0ZSgna2V5Ym9hcmQnLCAnU2hpZnQnKTsKICAgIGNvbnN0IG11bHRpU2VsZWN0QWxsb3dlZCA9IGRyYWdCb3QudGFncy5hcm1NdWx0aVNlbGVjdCA/PyB0cnVlOwoKICAgIGNvbnN0IGFybUJvdCA9IHRoaXNCb3QuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogZHJhZ0JvdCwKICAgICAgICBkaW1lbnNpb24sCiAgICAgICAgbXVsdGlTZWxlY3Q6IG11bHRpU2VsZWN0S2V5SGVsZCAmJiBtdWx0aVNlbGVjdEFsbG93ZWQsCiAgICB9KQoKICAgIG9zLnJlcGxhY2VEcmFnQm90KGFybUJvdCk7Cn0KJwCzy+OwA+MBBWRlYnVnAgQAs8vjsAOKCgVmYWxzZScAs8vjsAPjAQlsaXN0ZW5pbmcCBACzy+OwA5AKBHRydWUnALPL47AD4wELYWJDcmVhdGVBcm0CBACzy+OwA5UK9U1AY29uc3Qgb3JpZ2luQm90ID0gdGhhdC5vcmlnaW5Cb3Q7CmFzc2VydChhYi5saW5rcy51dGlscy5pc0JvdChvcmlnaW5Cb3QpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbkJvdCBpcyBhIHJlcXVpcmVkIEJvdCBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBkaW1lbnNpb24gPSB0aGF0LmRpbWVuc2lvbjsKYXNzZXJ0KHR5cGVvZiBkaW1lbnNpb24gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRpbWVuc2lvbiBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBwb3NpdGlvbiA9IHRoYXQucG9zaXRpb24gPz8gZ2V0Qm90UG9zaXRpb24ob3JpZ2luQm90LCBkaW1lbnNpb24pOwpjb25zdCBtdWx0aVNlbGVjdCA9IHRoYXQubXVsdGlTZWxlY3QgPz8gZmFsc2U7CmNvbnN0IGFybUNvbG9yID0gdGhhdC5hcm1Db2xvciA/PyBvcmlnaW5Cb3QudGFncy5hcm1Db2xvciA/PyBvcmlnaW5Cb3QudGFncy5zdHJva2VDb2xvciA/PyBvcmlnaW5Cb3QudGFncy5jb2xvcjsKY29uc3QgYXJtTWVzaFBhdGggPSB0aGF0LmFybU1lc2hQYXRoID8/IG9yaWdpbkJvdC50YWdzLmFybU1lc2hQYXRoOwpjb25zdCBhcm1Ecm9wU291bmQgPSB0aGF0LmFybURyb3BTb3VuZCA/PyBvcmlnaW5Cb3QudGFncy5hcm1Ecm9wU291bmQ7CmNvbnN0IGFybVRlbGVwb3J0U291bmQgPSB0aGF0LmFybVRlbGVwb3J0U291bmQgPz8gb3JpZ2luQm90LnRhZ3MuYXJtVGVsZXBvcnRTb3VuZDsKCmNvbnN0IGFybSA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIFtkaW1lbnNpb24gKyAnWiddOiBwb3NpdGlvbi56LAogICAgY3JlYXRvcjogb3JpZ2luQm90LmlkLAogICAgaXNBcm1Cb3Q6IHRydWUsCiAgICBwb2ludGFibGU6IHRydWUsCiAgICBtdWx0aVNlbGVjdCwKICAgIGRlYnVnOiB0YWdzLmRlYnVnLAogICAgb3JpZ2luQm90OiBnZXRMaW5rKG9yaWdpbkJvdCksCiAgICBkaW1lbnNpb24sCiAgICBhcm1Db2xvciwKICAgIGFybU1lc2hQYXRoLAogICAgYXJtRHJvcFNvdW5kLAogICAgYXJtVGVsZXBvcnRTb3VuZCwKICAgIGRlZmF1bHRBcm1Ecm9wU291bmQ6IHRhZ3MuZGVmYXVsdEFybURyb3BTb3VuZCwKICAgIGRlZmF1bHRBcm1UZWxlcG9ydFNvdW5kOiB0YWdzLmRlZmF1bHRBcm1UZWxlcG9ydFNvdW5kLAogICAgbGluZUNvbG9yOiBhcm1Db2xvciwKICAgIGxpbmVUbzogb3JpZ2luQm90LmlkLAogICAgb25DcmVhdGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNyZWF0ZWQgYXJtQm90ICR7dGhpc0JvdC5pZH1gKTsKICAgICAgICB9CiAgICAgICAgLy8gRGVzdHJveSBwcmV2aW91cyBhcm0gaWYgaXQgaXMgc3RpbGwgYXJvdW5kLgogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3Mub3JpZ2luQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9IGBhcm0uJHt0aGlzQm90LmlkLnN1YnN0cmluZygwLCA1KX1gOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1Cb3QgPSBnZXRMaW5rKHRoaXNCb3QpOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5kcmFnZ2FibGUgPSB0YWdzLm11bHRpU2VsZWN0OwoKICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aCAmJiAhdGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aC5zdGFydHNXaXRoKCdodHRwczovLycpKSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gdGFncy5hcm1NZXNoUGF0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSBhYi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTCh0YWdzLmFybU1lc2hQYXRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGFncy5mb3JtID0gJ21lc2gnOwogICAgICAgICAgICB0YWdzLmZvcm1TdWJ0eXBlID0gJ2dsdGYnOwogICAgICAgICAgICB0YWdzLmFuY2hvclBvaW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgICAgICB0YWdzLnNjYWxlID0gMC45OTk5OyAvLyBUaGVyZSBpcyBhIHJlYWxseSBzdHJhbmdlIGJ1ZyB0aGF0IGlmIHRoaXMgaXMgbGVmdCB1bmRlZmluZWQgb3Igc2V0IHRvIDEgZXhhY3RseSwgdGhlIGFybSB3aWxsIHNvbWV0aW1lcyBkaXNhcHBlYXIuCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGFncy5zdHJva2VDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgICAgIHRhZ3MuZm9ybSA9ICdjdWJlJzsKICAgICAgICAgICAgdGFncy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAwLjk7CiAgICAgICAgICAgIHRhZ3Muc2NhbGVaID0gMC4wMTsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm0gPSAnc3BoZXJlJzsKICAgICAgICAgICAgICAgIHRhZ3MuY29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBNYWtlIHRoZSBvcmlnaW4gYm90IHVuc2VsZWN0YWJsZSBmb3IgMS80IG9mIGEgc2Vjb25kLgogICAgICAgIC8vIFRoaXMgaGVscHMgcHJldmVudCB1bmludGVudGlvbmFsIHNlbGYtc2VsZWN0aW9uIG9mIHRoZSBvcmlnaW4gYm90LgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKICAgICAgICBvcy5zbGVlcCgyNTApLnRoZW4oKCkgPT4gewogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MucG9pbnRhYmxlID0gbnVsbDsKICAgICAgICB9KQoKICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1DcmVhdGUnKTsKICAgIH0pLAogICAgc2V0QXJtVmlzaWJsZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxldCB2aXNpYmxlID0gdGhhdDsKCiAgICAgICAgaWYgKHZpc2libGUpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuYXJtTWVzaFBhdGgpIHsKICAgICAgICAgICAgICAgIG1hc2tzLmZvcm1PcGFjaXR5ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1hc2tzLnN0cm9rZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWFza3MubGluZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgbWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LmlkOyAKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aCkgewogICAgICAgICAgICAgICAgbWFza3MuZm9ybU9wYWNpdHkgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWFza3Muc3Ryb2tlQ29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5saW5lQ29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICBtYXNrcy5saW5lVG8gPSBmYWxzZTsKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gZmFsc2U7CgogICAgICAgICAgICBpZiAodGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICAgICAgbWFza3MuY29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3QgeyBkaW1lbnNpb24gfSA9IHRoYXQ7CgogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3Q/LnRhZ3MuYXJtVGVsZXBvcnQgPz8gdHJ1ZSkgewogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1gnXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1gnXTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1knXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1knXTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1onXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1onXTsKCiAgICAgICAgICAgIGFiLmxpbmtzLnNvdW5kLmFiUGxheVNvdW5kKHsgdmFsdWU6IHRhZ3MuYXJtVGVsZXBvcnRTb3VuZCwgZGVmYXVsdFZhbHVlOiB0YWdzLmRlZmF1bHRBcm1UZWxlcG9ydFNvdW5kIH0pOwogICAgICAgIH0KCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybUNsaWNrJywgeyBkaW1lbnNpb24gfSk7CgogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICB9KSwKICAgIG9uRHJvcEVudGVyOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuZHJhZ0JvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwogICAgICAgIGlmICghbGlua3Mub3JpZ2luQm90KSByZXR1cm47CgogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CgogICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIGxldCBsaW5lVG9Cb3RzID0gbGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbzsKCiAgICAgICAgICAgIGlmIChsaW5lVG9Cb3RzID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKGRyb3BCb3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGluZVRvQm90cyA9IEFycmF5LmlzQXJyYXkobGluZVRvQm90cykgPyBsaW5lVG9Cb3RzIDogW2xpbmVUb0JvdHNdOwoKICAgICAgICAgICAgICAgIGlmICghbGluZVRvQm90cy5pbmNsdWRlcyhkcm9wQm90KSkgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKC4uLmxpbmVUb0JvdHMsIGRyb3BCb3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGhpZGUgYXJtYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBkcm9wQm90LmlkOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBzZWxlY3Rpb24gb24gb3JpZ2luIGJvdC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25Ecm9wRXhpdDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmRyYWdCb3QgIT09IHRoaXNCb3QpIHJldHVybjsKICAgICAgICBpZiAoIWxpbmtzLm9yaWdpbkJvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkcm9wQm90ID0gdGhhdC50by5ib3Q7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJvcEJvdDpgLCBkcm9wQm90KTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUodHJ1ZSk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IGFybWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgc2VsZWN0aW9uIG9uIG9yaWdpbiBib3QuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJvcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmJvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgYWIubGlua3Muc291bmQuYWJQbGF5U291bmQoeyB2YWx1ZTogdGFncy5hcm1Ecm9wU291bmQsIGRlZmF1bHRWYWx1ZTogdGFncy5kZWZhdWx0QXJtRHJvcFNvdW5kIH0pOwogICAgICAgIAogICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0ICYmIGxpbmtzLm9yaWdpbkJvdC5saW5rcy5saW5lVG8pIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5TZXRTZWxlY3Rpb24obGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbyk7CiAgICAgICAgfSBlbHNlIGlmIChkcm9wQm90KSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZShmYWxzZSk7CiAgICAgICAgICAgIHRoaXNCb3Qub3JpZ2luU2V0U2VsZWN0aW9uKGRyb3BCb3QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIERyb3BwZWQgb24gZ3JpZC4KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJvcHBlZCBvbiBncmlkLmApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtUGxhY2VkJywgeyBkaW1lbnNpb246IHRoYXQudG8uZGltZW5zaW9uLCB4OiB0aGF0LnRvLngsIHk6IHRoYXQudG8ueSwgejogdGhhdC50by56IH0pOwogICAgICAgIH0KICAgICAgICAKICAgIH0pLAogICAgb25HcmlkQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIH0pLAogICAgb3JpZ2luQ2xlYXJTZWxlY3Rpb246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lQ29sb3IgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwogICAgfSksCiAgICBvcmlnaW5TZXRTZWxlY3Rpb246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCBzZWxlY3RlZEJvdHMgPSB0aGF0OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtU2VsZWN0ZWRCb3RzID0gc2VsZWN0ZWRCb3RzID8gZ2V0TGluayhzZWxlY3RlZEJvdHMpIDogbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LnRhZ3MuYXJtU2VsZWN0ZWRCb3RzOwogICAgICAgIAogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1TZWxlY3RlZEJvdHMnLCBsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKQogICAgICAgIH0KICAgIH0pLAogICAgb25BbnlCb3RzUmVtb3ZlZDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgIC8vIENoZWNrIHRoYXQgd2Ugc3RpbGwgaGF2ZSBzb21lIGFjdGl2ZSBzZWxlY3RlZCBib3RzLgogICAgICAgICAgICBsZXQgYWN0aXZlU2VsZWN0ZWRCb3RzID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBhcm1TZWxlY3RlZEJvdHMgPSBsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzOwoKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJtU2VsZWN0ZWRCb3RzKSkgewogICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0ZWRCb3RzID0gYXJtU2VsZWN0ZWRCb3RzLmV2ZXJ5KGIgPT4gISFiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVNlbGVjdGVkQm90cyA9ICEhYXJtU2VsZWN0ZWRCb3RzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVNlbGVjdGVkQm90cykgewogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJvdHMgd2UgaGFkIHNlbGVjdGVkIG5vIGxvbmdlciBleGlzdCwgZGVzdHJveSB0aGlzIGFybS4KICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIHRoYXQgYXJtIGhhcyBzZWxlY3RlZCBubyBsb25nZXIgZXhpc3QsIGRlc3Ryb3kgdGhpcyBhcm0uYCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5DbGVhclNlbGVjdGlvbigpOwogICAgICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIHRoYXQgYXJtIGhhcyBzZWxlY3RlZCBzdGlsbCBoYXMgYWN0aXZlIGJvdHMuYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uRGVzdHJveTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5kcmFnZ2FibGUgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtRGVzdHJveScpOwogICAgfSksCn07Cgpjb25zdCBhcm1Cb3QgPSBjcmVhdGUoYXJtKTsKCnJldHVybiBhcm1Cb3Q7JwCzy+OwA+MBEG9uQW55Qm90RHJhZ2dpbmcCBACzy+OwA4tY0RVAY29uc3QgZHJhZ0JvdCA9IHRoYXQuYm90Owpjb25zdCBkaW1lbnNpb24gPSB0aGF0LmZyb20uZGltZW5zaW9uOwoKaWYgKGRyYWdCb3QubGlua3MuYXJtQm90KSB7CiAgICBpZiAoZHJhZ0JvdC50YWdzLmFybUdyb3VwRHJhZyAmJiBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cykgewogICAgICAgIGxldCBkcmFnQ29vcmRpbmF0b3JCb3QgPSBsaW5rcy5kcmFnQ29vcmRpbmF0b3JCb3Q7CiAgICAgICAgCiAgICAgICAgaWYgKCFkcmFnQ29vcmRpbmF0b3JCb3QpIHsKICAgICAgICAgICAgY29uc3QgZHJhZ0Nvb3JkaW5hdG9yTW9kID0gewogICAgICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICAgICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgICAgICAgICAgICAgIGRpbWVuc2lvbjogZGltZW5zaW9uLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIlgiXTogMCwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWSJdOiAwLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJaIl06IC0xLAogICAgICAgICAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGRlYnVnOiB0YWdzLmRlYnVnLAogICAgICAgICAgICAgICAgY29sb3I6ICJjbGVhciIsCiAgICAgICAgICAgICAgICBzeXN0ZW06IGBhcm1Hcm91cERyYWcuJHt0aGlzQm90LmlkLnN1YnN0cmluZygwLCA1KX0uY29vcmRpbmF0b3JgLAogICAgICAgICAgICAgICAgb25BbnlCb3RQb2ludGVyVXA6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgZHJhZyBjb29yZGluYXRvcmApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGlua3MubWFuYWdlci5tYXNrcy5kcmFnQ29vcmRpbmF0b3JCb3QgPSBudWxsOyAKICAgICAgICAgICAgICAgICAgICBzaG91dCgnb25Bcm1TdG9wR3JvdXBEcmFnJywgeyB4OiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgJ1gnXSwgeTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICdZJ10gfSk7CiAgICAgICAgICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90ID0gY3JlYXRlKGRyYWdDb29yZGluYXRvck1vZCk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjcmVhdGVkIGRyYWcgY29vcmRpbmF0b3IgYm90OmAsIGRyYWdDb29yZGluYXRvckJvdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1hc2tzLmRyYWdDb29yZGluYXRvckJvdCA9IGdldExpbmsoZHJhZ0Nvb3JkaW5hdG9yQm90KTsKCiAgICAgICAgICAgIGNvbnN0IGFybVNlbGVjdGVkQm90cyA9IGRyYWdCb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzOwogICAgICAgICAgICBjb25zdCBvbkFybVN0b3BHcm91cERyYWcgPSBgQAogICAgICAgICAgICAgICAgbWFza3MudHJhbnNmb3JtZXIgPSBudWxsOwogICAgICAgICAgICAgICAgbWFza3Mub25Bcm1TdG9wR3JvdXBEcmFnID0gbnVsbDsKICAgICAgICAgICAgICAgIHRhZ3MuJHtkaW1lbnNpb259WCA9IHRhZ3MuJHtkaW1lbnNpb259WCArIHRoYXQueDsKICAgICAgICAgICAgICAgIHRhZ3MuJHtkaW1lbnNpb259WSA9IHRhZ3MuJHtkaW1lbnNpb259WSArIHRoYXQueTsKICAgICAgICAgICAgYAoKICAgICAgICAgICAgZHJhZ0JvdC5tYXNrcy50cmFuc2Zvcm1lciA9IGRyYWdDb29yZGluYXRvckJvdC5pZDsKICAgICAgICAgICAgZHJhZ0JvdC5tYXNrcy5vbkFybVN0b3BHcm91cERyYWcgPSBvbkFybVN0b3BHcm91cERyYWc7CgogICAgICAgICAgICBzZXRUYWdNYXNrKGFybVNlbGVjdGVkQm90cywgInRyYW5zZm9ybWVyIiwgZHJhZ0Nvb3JkaW5hdG9yQm90LmlkLCAidGVtcExvY2FsIik7CiAgICAgICAgICAgIHNldFRhZ01hc2soYXJtU2VsZWN0ZWRCb3RzLCAib25Bcm1TdG9wR3JvdXBEcmFnIiwgb25Bcm1TdG9wR3JvdXBEcmFnLCAidGVtcExvY2FsIik7CiAgICAgICAgfQoKICAgICAgICBjb25zdCB4Q2hhbmdlID0gdGhhdC50by54IC0gdGhhdC5mcm9tLng7CiAgICAgICAgY29uc3QgeUNoYW5nZSA9IHRoYXQudG8ueSAtIHRoYXQuZnJvbS55OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHhDaGFuZ2U6ICR7eENoYW5nZX0sIHlDaGFuZ2U6ICR7eUNoYW5nZX1gKTsKICAgICAgICB9CgogICAgICAgIGRyYWdDb29yZGluYXRvckJvdC50YWdzW2RpbWVuc2lvbiArICJYIl0gPSB4Q2hhbmdlOwogICAgICAgIGRyYWdDb29yZGluYXRvckJvdC50YWdzW2RpbWVuc2lvbiArICJZIl0gPSB5Q2hhbmdlOwogICAgICAgIGRyYWdDb29yZGluYXRvckJvdC50YWdzW2RpbWVuc2lvbiArICJaIl0gPSAtMTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcmFnIGJvdCB3aXRoIGFybSBkb2VzIG5vdCBxdWFsaWZ5IGZvciBncm91cCBkcmFnZ2luZy5gKTsKICAgICAgICB9CiAgICB9Cn0nALPL47AD4wENYWJQZXJzb25hbGl0eQIEALPL47AD3W0EdHJ1ZScAs8vjsAPjAQhhYklnbm9yZQIEALPL47AD4m0EdHJ1ZScAs8vjsAPjAQRmb3JtAgQAs8vjsAPnbQdub3RoaW5nJwCzy+OwA+MBCWFiVmVyc2lvbgIEALPL47AD720FMTAuMzgnALPL47AD4wETZGVmYXVsdEFybURyb3BTb3VuZAIEALPL47AD9W0ZYWIvYXVkaW8vc2VsZWN0IGxldmVsLm1wMycAs8vjsAPjARdkZWZhdWx0QXJtVGVsZXBvcnRTb3VuZAIEALPL47ADj24SYWIvYXVkaW8vd29vc2gubXAzJwEEYm90cyRiMjZlMTA4OS0xNzJkLTQ1YTktOGQyMi0wNWMzZjU4YzJiZjcBJwCzy+OwA6JuBnN5c3RlbQIEALPL47ADo24YYWIucGVyc29uYWxpdHkuYW5pbWF0aW9uJwCzy+OwA6JuBGZvcm0CBACzy+OwA7xuB25vdGhpbmcnALPL47ADom4IYWJJZ25vcmUCBACzy+OwA8RuBHRydWUnALPL47ADom4NbWFuaWZlc3RhdGlvbgIEALPL47ADyW4o8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAs8vjsAOibghyZW1lbWJlcgIEALPL47AD8G4o8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAs8vjsAOibhhhbmltYXRpb25fYWJHcmlkTWFuaWZlc3QCBACzy+OwA5dv+g5Ac2hvdXQoInJlc2V0Iik7Cgpjb25zdCBwb3NpdGlvblggPSB0aGF0Py5wb3NpdGlvbi54ID8/IDA7CmNvbnN0IHBvc2l0aW9uWSA9IHRoYXQ/LnBvc2l0aW9uLnkgPz8gMDsKY29uc3QgZGltZW5zaW9uID0gdGhhdD8uZGltZW5zaW9uID8/ICJob21lIjsKY29uc3QgZ3JpZFNjYWxlID0gdGhhdD8uc2NhbGUgPz8gNTsKY29uc3QgbW9tZW50Q291bnQgPSAwOwpjb25zdCBncmlkQm90ID0ge307CgpncmlkQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CmdyaWRCb3QuY29sb3IgPSAiY2xlYXIiOwpncmlkQm90LnN0cm9rZUNvbG9yID0gYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwpncmlkQm90LnNjYWxlID0gMC4wMDE7CmdyaWRCb3Quc2NhbGVaID0gMC4xOwpncmlkQm90LnJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwpncmlkQm90W2RpbWVuc2lvbl0gPSB0cnVlOwpncmlkQm90LnBvaW50YWJsZSA9IGZhbHNlOwpncmlkQm90LmtpbGxUaW1lciA9ICJAIGF3YWl0IG9zLnNsZWVwKDQwMCk7IGRlc3Ryb3kodGhpc0JvdCk7IjsKCmxldCByb3VuZEJvdHM7Cgpmb3IgKGxldCBpID0gZ3JpZFNjYWxlOyBpID4gMDsgaS0tKQp7CiAgICBjb25zdCBib3RDb3VudCA9IGkgKiA4OwoKICAgIGxldCBzaWRlQ291bnQgPSAwOwogICAgbGV0IHBoYXNlRmFjdG9yID0gMDsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJvdENvdW50OyBqKyspCiAgICB7CiAgICAgICAgaWYgKHBoYXNlRmFjdG9yID09IDApCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpICsgc2lkZUNvdW50OwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSBpICsgcG9zaXRpb25ZOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwaGFzZUZhY3RvciA9PSAxKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gaSArIHBvc2l0aW9uWDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKGkgKyBwb3NpdGlvblkpIC0gc2lkZUNvdW50OyAgCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHBoYXNlRmFjdG9yID09IDIpCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoaSArIHBvc2l0aW9uWCkgLSBzaWRlQ291bnQ7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9ICgoaSArIHBvc2l0aW9uWSkgKiAtMSkgOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpIDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKChpICsgcG9zaXRpb25ZKSAqIC0xKSArIHNpZGVDb3VudDsgIAogICAgICAgIH0KCiAgICAgICAgY29uc3QgbmV3R3JpZEJvdCA9IGF3YWl0IGNyZWF0ZShncmlkQm90KTsKCiAgICAgICAgYW5pbWF0ZVRhZyhuZXdHcmlkQm90LCAic2NhbGUiLCB7CiAgICAgICAgICAgIHRvVmFsdWU6IDEsCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogImVsYXN0aWMiLAogICAgICAgICAgICAgICAgbW9kZTogIm91dCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDAuMDEKICAgICAgICB9KS5jYXRjaCgoKSA9PiB7fSk7CgogICAgICAgIG5ld0dyaWRCb3Qua2lsbFRpbWVyKCk7CgogICAgICAgIHNpZGVDb3VudCsrOwoKICAgICAgICBpZiAoc2lkZUNvdW50ID09IGJvdENvdW50IC8gNCkKICAgICAgICB7CiAgICAgICAgICAgIHNpZGVDb3VudCA9IDA7CgogICAgICAgICAgICBwaGFzZUZhY3RvcisrOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoOCk7CiAgICB9Cn0nALPL47ADom4JYWJWZXJzaW9uAgQAs8vjsAOSfgUxMC4zOCcAs8vjsAOibgZvbkNoYXQCBACzy+OwA5h+VUAvLyBpZiAodGhhdC5tZXNzYWdlID09ICJAdGVzdCIpCi8vIHsKLy8gICAgIHRoaXNCb3QuYW5pbWF0aW9uX2FiR3JpZE1hbmlmZXN0KCk7Ci8vIH0nALPL47ADom4LcGVyc29uYWxpdHkCBACzy+OwA+5+KPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInALPL47ADom4NYWJQZXJzb25hbGl0eQIEALPL47ADlX8EdHJ1ZScBBGJvdHMkYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiAScAs8vjsAOafwZzeXN0ZW0CBACzy+OwA5t/FWFiLnBlcnNvbmFsaXR5LmNvbmZpZycAs8vjsAOafwhhYklnbm9yZQIEALPL47ADsX8EdHJ1ZScAs8vjsAOafwRmb3JtAgQAs8vjsAO2fwdub3RoaW5nJwCzy+OwA5p/C2FiQmFzZUNvbG9yAgQAs8vjsAO+fwcjMDBEOUNEJwCzy+OwA5p/EWFiQmFzZVN0cm9rZUNvbG9yAgQAs8vjsAPGfwcjMDBEOUNEJwCzy+OwA5p/EGFiQmx1ZXByaW50Q29sb3ICBACzy+OwA85/ByMwMDgyN0InALPL47ADmn8IcmVtZW1iZXICBACzy+OwA9Z/KPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnALPL47ADmn8RYWJCdWlsZGVySWRlbnRpdHkCBACzy+OwA/1/CmNhc3VhbC5ib3QnALPL47ADmn8JYWJWZXJzaW9uAgQAs8vjsAOIgAEFMTAuMzgnALPL47ADmn8PYWJCYXNlTWVudUNvbG9yAgQAs8vjsAOOgAEHIzAwRDlDRCcAs8vjsAOafw1hYlBlcnNvbmFsaXR5AgQAs8vjsAOWgAEEdHJ1ZScAs8vjsAOafw1vblNraWxsVXBkYXRlAgQAs8vjsAObgAEdQHRoaXNCb3QuYWJQZXJzb25hbGl0eUxvYWQoKTsnALPL47ADmn8RYWJCYXNlU2hhZG93Q29sb3ICBACzy+OwA7mAAQVibGFjaycAs8vjsAOafxBhYkJhc2VMYWJlbENvbG9yAgQAs8vjsAO/gAEFYmxhY2snALPL47ADmn8KbWFwT3B0aW9ucwIEALPL47ADxYABngfwn6esWw0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInNhdGVsbGl0ZSIsDQogICAgICAgICJpZCI6ICJzYXRlbGxpdGUiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJoeWJyaWQiLA0KICAgICAgICAiaWQiOiAiaHlicmlkIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAib2NlYW5zIiwNCiAgICAgICAgImlkIjogIm9jZWFucyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgIm9wZW4gc3RyZWV0IG1hcCIsDQogICAgICAgICJpZCI6ICJvc20iDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJ0ZXJyYWluIiwNCiAgICAgICAgImlkIjogInRlcnJhaW4iDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJkYXJrIGdyYXkgY2FudmFzIiwNCiAgICAgICAgImlkIjogImRhcmstZ3JheSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImdyYXkgY2FudmFzIiwNCiAgICAgICAgImlkIjogImdyYXkiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIiwNCiAgICAgICAgImlkIjogInN0cmVldHMiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChkYXJrKSIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzLW5pZ2h0LXZlY3RvciINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKG5hdmlnYXRpb24pIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtbmF2aWdhdGlvbi12ZWN0b3IiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJ0b3BvZ3JhcGhpYyIsDQogICAgICAgICJpZCI6ICJ0b3BvIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAocmVsaWVmKSIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzLXJlbGllZi12ZWN0b3IiDQogICAgfQ0KXScAs8vjsAOafxRzaG93QUJCYXNlbWFwT3B0aW9ucwIEALPL47AD4ocBxAVAc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCg0Kc2hvdXQoImFiTWVudVJlZnJlc2giKTsNCmNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgPSAnYWJCYXNlbWFwT3B0aW9uc01lbnUnOw0KDQpmb3IgKGNvbnN0IG9wdGlvbiBvZiB0YWdzLm1hcE9wdGlvbnMpIHsNCiAgICBpZiAob3B0aW9uLmlkID09IG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXApIHsNCiAgICAgICAgY29udGludWU7DQogICAgfQ0KICAgIGNvbnN0IG9wdGlvbk9iaiA9IA0KICAgIHsNCiAgICAgICAgYWJCYXNlbWFwT3B0aW9uc01lbnU6IHRydWUsDQogICAgICAgIGNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnU6IGBAZGVzdHJveSh0aGlzQm90KTtgLA0KICAgICAgICBtYXBJRDogb3B0aW9uLmlkLA0KICAgICAgICBsYWJlbDogb3B0aW9uLm5hbWUsDQogICAgICAgIG9uQ2xpY2s6IGBADQogICAgICAgICAgICBtYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwID0gdGFncy5tYXBJRDsNCiAgICAgICAgICAgIHNob3V0KCdhYlBlcnNvbmFsaXR5Q2hhbmdlJywgeyBhYk1hcFBvcnRhbEJhc2U6IHRhZ3MubWFwSUR9KTsgDQogICAgICAgICAgICBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KICAgICAgICBgDQogICAgfQ0KDQogICAgYWIubGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24ob3B0aW9uT2JqKTsNCn0nALPL47ADmn8Lb25HcmlkQ2xpY2sCBACzy+OwA6eNASZAc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCicAs8vjsAOafwVkZWJ1ZwIEALPL47ADzo0BBWZhbHNlJwCzy+OwA5p/E2FiUGVyc29uYWxpdHlDaGFuZ2UCBACzy+OwA9SNAcwGQGlmICghdGhhdCkgewogICAgcmV0dXJuOwp9Cgpjb25zdCBjaGFuZ2VkVGFncyA9IFtdOwoKZm9yIChjb25zdCBrZXkgaW4gdGhhdCkgewogICAgaWYgKHRhZ3MuYWJQZXJzb25hbGl0eVRhZ3MuaW5jbHVkZXMoa2V5KSkgewogICAgICAgIGlmIChtYXNrc1trZXldICE9PSB0aGF0W2tleV0pIHsKICAgICAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCBrZXksIHRoYXRba2V5XSwgJ2xvY2FsJyk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGFuZ2VkICcke2tleX0nIHRvOmAsIHNlbGYuc3RydWN0dXJlZENsb25lKHRoYXRba2V5XSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNoYW5nZWRUYWdzLmluY2x1ZGVzKGtleSkpIHsKICAgICAgICAgICAgICAgIGNoYW5nZWRUYWdzLnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFnLnN5c3RlbX0uJHt0YWdOYW1lfV0gJyR7a2V5fScgaXMgbm90IGEgdmFsaWQgYWIgcGVyc29uYWxpdHkgdGFnLmApOwogICAgfQp9CgppZiAoY2hhbmdlZFRhZ3MubGVuZ3RoID4gMCkgewogICAgdGhpc0JvdC52YXJzLmhhc1Vuc2F2ZWRDaGFuZ2VzID0gdHJ1ZTsKICAgIHNob3V0KCdvbkFCUGVyc29uYWxpdHlDaGFuZ2VkJywgeyBib3Q6IHRoaXNCb3QsIHRhZ3M6IGNoYW5nZWRUYWdzIH0pOwoKICAgIGlmICh0YWdzLmF1dG9zYXZlKSB7CiAgICAgICAgdGhpc0JvdC5hYlBlcnNvbmFsaXR5U2F2ZSgpOwogICAgfQp9CicAs8vjsAOafxJhYlBlcnNvbmFsaXR5UmVzZXQCBACzy+OwA6GUAYUGQGlmICh0aGlzQm90LnZhcnMucmVzZXR0aW5nKSB7CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5yZXNldHRpbmcgPSB0cnVlOwoKaWYgKCFhdXRoQm90KSB7CiAgICB0cnkgeyAKICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwogICAgfSBjYXRjaCB7CiAgICAgICAgdGhpc0JvdC52YXJzLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKaWYgKCFsaW5rcy5yZW1lbWJlcikgewogICAgdGhpc0JvdC52YXJzLnJlc2V0dGluZyA9IGZhbHNlOwogICAgcmV0dXJuOwp9CgppZiAoYXV0aEJvdCkgewogICAgLy8gRGVsZXRlIHVzZXIgcGVyc29uYWxpdHkgZnJvbSB1c2VyIHJlY29yZC4KICAgIGNvbnN0IGVyYXNlUmVzcG9uc2UgPSBhd2FpdCBvcy5lcmFzZURhdGEoYXV0aEJvdC5pZCwgJ2FiUGVyc29uYWxpdHlDb25maWcnKTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXJhc2VSZXNwb25zZTpgLCBzZWxmLnN0cnVjdHVyZWRDbG9uZShlcmFzZVJlc3BvbnNlKSk7CiAgICB9Cn0KCi8vIFJlbG9hZCB0aGUgcGVyc29uYWxpdHkuIFdpdGggdGhlIHVzZXIgcGVyc29uYWxpdHkgZXJhc2VkLCB0aGlzIHdpbGwgZWZmZWN0aXZlbHkgbG9hZCBhbGwgdGhlIGRlZmF1bHRzIGZyb20gYWJDb25maWcuCmF3YWl0IHRoaXNCb3QuYWJQZXJzb25hbGl0eUxvYWQoKTsKCnRoaXNCb3QudmFycy5yZXNldHRpbmcgPSBmYWxzZTsnALPL47ADmn8RYWJQZXJzb25hbGl0eVNhdmUCBACzy+OwA6eaAYULQGlmICh0aGlzQm90LnZhcnMuc2F2aW5nKSB7CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5zYXZpbmcgPSB0cnVlOwoKaWYgKCFhdXRoQm90KSB7CiAgICB0cnkgeyAKICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwogICAgfSBjYXRjaCB7CiAgICAgICAgdGhpc0JvdC52YXJzLnNhdmluZyA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy8gU2F2ZSBhbGwgdGhlIGN1cnJlbnQgYWIgcGVyc29uYWxpdHkgdGFncyB0byB0aGUgdXNlcidzIHJlY29yZC4KY29uc3QgdXNlclBlcnNvbmFsaXR5ID0ge307Cgpmb3IgKGNvbnN0IHRhZ05hbWUgb2YgdGFncy5hYlBlcnNvbmFsaXR5VGFncykgewogICAgaWYgKHRhZ3NbdGFnTmFtZV0gIT0gbnVsbCkgewogICAgICAgIHVzZXJQZXJzb25hbGl0eVt0YWdOYW1lXSA9IHRhZ3NbdGFnTmFtZV07CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNhdmluZyB1c2VyIHBlcnNvbmFsaXR5OmAsIHNlbGYuc3RydWN0dXJlZENsb25lKHVzZXJQZXJzb25hbGl0eSkpOwp9CgpsZXQgcmVjb3JkUmVzcG9uc2UgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICdhYlBlcnNvbmFsaXR5Q29uZmlnJywgdXNlclBlcnNvbmFsaXR5KTsKCmlmICghcmVjb3JkUmVzcG9uc2Uuc3VjY2VzcykgewogICAgaWYgKHJlY29yZFJlc3BvbnNlLmVycm9yQ29kZSA9PT0gJ25vdF9hdXRob3JpemVkJykgewogICAgICAgIC8vIEFzayB1c2VyIHRvIGdyYW50IHBlcm1pc3Npb247CiAgICAgICAgY29uc3QgcGVybWlzc2lvbiA9IGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90LmlkKTsKCiAgICAgICAgaWYgKHBlcm1pc3Npb24uc3VjY2VzcykgewogICAgICAgICAgICByZWNvcmRSZXNwb25zZSA9IGF3YWl0IG9zLnJlY29yZERhdGEoYXV0aEJvdC5pZCwgJ2FiUGVyc29uYWxpdHlDb25maWcnLCB1c2VyUGVyc29uYWxpdHkpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKHJlY29yZFJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYHVwZGF0ZWQgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkYCwgbG9nVHlwZTogJ2xvZyd9KTsKfSBlbHNlIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGZhaWxlZCB0byB1cGRhdGUgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkLlxuJHtKU09OLnN0cmluZ2lmeShyZWNvcmRSZXNwb25zZSwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnZXJyb3InfSk7Cn0KCnRoaXNCb3QudmFycy5zYXZpbmcgPSBmYWxzZTsKdGhpc0JvdC52YXJzLmhhc1Vuc2F2ZWRDaGFuZ2VzID0gZmFsc2U7JwCzy+OwA5p/EWFiUGVyc29uYWxpdHlMb2FkAgQAs8vjsAOtpQHSFEBpZiAodGhpc0JvdC52YXJzLmxvYWRpbmcpIHsKICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLmxvYWRpbmcgPSB0cnVlOwoKaWYgKCFhdXRoQm90KSB7CiAgICB0cnkgeyAKICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwogICAgfSBjYXRjaCB7CiAgICAgICAgdGhpc0JvdC52YXJzLmxvYWRpbmcgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICB9Cn0KCmlmICghbGlua3MucmVtZW1iZXIpIHsKICAgIHRoaXNCb3QudmFycy5sb2FkaW5nID0gZmFsc2U7CiAgICByZXR1cm47Cn0KCi8vIFJldHJpZXZlIHBlcnNvbmFsaXR5IGNvbmZpZyBmcm9tIHVzZXIncyByZWNvcmQuCmxldCB1c2VyUGVyc29uYWxpdHlEYXRhID0ge307CgppZiAoYXV0aEJvdCkgewogICAgY29uc3QgZ2V0RGF0YVJlc3BvbnNlID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAnYWJQZXJzb25hbGl0eUNvbmZpZycpOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBnZXREYXRhUmVzcG9uc2U6YCwgc2VsZi5zdHJ1Y3R1cmVkQ2xvbmUoZ2V0RGF0YVJlc3BvbnNlKSk7CiAgICB9CgogICAgaWYgKGdldERhdGFSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgdXNlclBlcnNvbmFsaXR5RGF0YSA9IGdldERhdGFSZXNwb25zZS5kYXRhOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAoZ2V0RGF0YVJlc3BvbnNlLmVycm9yQ29kZSAhPT0gJ2RhdGFfbm90X2ZvdW5kJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJQZXJzb25hbGl0eUNvbmZpZyBnZXQgZXJyb3I6YCwgeyBlcnJvckNvZGU6IGdldERhdGFSZXNwb25zZS5lcnJvckNvZGUsIGVycm9yTWVzc2FnZTogZ2V0RGF0YVJlc3BvbnNlLmVycm9yTWVzc2FnZSB9KTsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLmxvYWRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KfQoKLy8gQ2xlYXIgYW55IHByZXZpb3N1bHkgbG9hZGVkIHRhZ3MuCmNsZWFyVGFnTWFza3ModGhpc0JvdCk7CgovLyBSeWFuIChBdWcgMjksIDIwMjUpOiBpbSBub3Qgc3VyZSBleGFjdGx5IHdoYXQgaXMgaGFwcGVuaW5nIGhlcmUgYnV0IHdpdGhvdXQgc2xlZXBpbmcgb24gdGhlc2UgYmlnIHRhZyBtYXNrIGNoYW5nZXMsIHRoZXkgZG9udCBhbGwgc2VlbSB0byBjb21lIGluIHByb3Blcmx5Lgphd2FpdCBvcy5zbGVlcCgxMDApOwoKLy8gTG9hZCB0YWdzIGZyb20gZWl0aGVyIHRoZSB1c2VyJ3MgcGVyc29uYWxpdHkgY29uZmlnIChpZiBhdmFpbGFibGUpIG9yIGxvYWQgYSBkZWZhdWx0IGZyb20gdGhlIGFiQ29uZmlnLgpmb3IgKGNvbnN0IHRhZ05hbWUgb2YgdGFncy5hYlBlcnNvbmFsaXR5VGFncykgewogICAgaWYgKHVzZXJQZXJzb25hbGl0eURhdGFbdGFnTmFtZV0gIT0gbnVsbCkgewogICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgdGFnTmFtZSwgdXNlclBlcnNvbmFsaXR5RGF0YVt0YWdOYW1lXSwgJ2xvY2FsJyk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9hZGVkICcke3RhZ05hbWV9JyBmcm9tIHVzZXIgcGVyc29uYWxpdHkgZGF0YTpgLCBzZWxmLnN0cnVjdHVyZWRDbG9uZSh1c2VyUGVyc29uYWxpdHlEYXRhW3RhZ05hbWVdKSk7CiAgICAgICAgfQogICAgfSBlbHNlIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW3RhZ05hbWVdICE9IG51bGwpIHsKICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIHRhZ05hbWUsIGxpbmtzLnJlbWVtYmVyLnRhZ3NbdGFnTmFtZV0sICdsb2NhbCcpOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvYWRlZCAnJHt0YWdOYW1lfScgZnJvbSBhYiBjb25maWc6YCwgc2VsZi5zdHJ1Y3R1cmVkQ2xvbmUobGlua3MucmVtZW1iZXIudGFnc1t0YWdOYW1lXSkpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKHRhZ05hbWUgPT09ICJhYkJhc2VHcmlkUG9ydGFsQ29sb3IiKSB7CiAgICAgICAgZ3JpZFBvcnRhbEJvdC50YWdzLnBvcnRhbENvbG9yID0gdGFncy5hYkJhc2VHcmlkUG9ydGFsQ29sb3I7CiAgICB9CgogICAgaWYgKHRhZ05hbWUgPT09ICJhYk1hcFBvcnRhbEJhc2UiKSB7CiAgICAgICAgbWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCA9IHRhZ3MuYWJNYXBQb3J0YWxCYXNlOwogICAgICAgIG1pbmlNYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwID0gdGFncy5hYk1hcFBvcnRhbEJhc2U7CiAgICB9Cn0KCi8vIFJ5YW4gKEF1ZyAyOSwgMjAyNSk6IGltIG5vdCBzdXJlIGV4YWN0bHkgd2hhdCBpcyBoYXBwZW5pbmcgaGVyZSBidXQgd2l0aG91dCBzbGVlcGluZyBvbiB0aGVzZSBiaWcgdGFnIG1hc2sgY2hhbmdlcywgdGhleSBkb250IGFsbCBzZWVtIHRvIGNvbWUgaW4gcHJvcGVybHkuCmF3YWl0IG9zLnNsZWVwKDEwMCk7Cgp0aGlzQm90LnZhcnMubG9hZGluZyA9IGZhbHNlOwpzaG91dCgnb25BQlBlcnNvbmFsaXR5TG9hZGVkJywgeyBib3Q6IHRoaXNCb3QgfSk7JwCzy+OwA5p/EWFiUGVyc29uYWxpdHlUYWdzAgQAs8vjsAOAugGqAvCfp6xbCiAgICAiYWJCYXNlQ29sb3IiLAogICAgImFiQmFzZUxhYmVsQ29sb3IiLAogICAgImFiQmFzZU1lbnVDb2xvciIsCiAgICAiYWJCYXNlTWVudUxhYmVsQ29sb3IiLAogICAgImFiQmFzZVNoYWRvd0NvbG9yIiwKICAgICJhYkJhc2VTdHJva2VDb2xvciIsCiAgICAiYWJCbHVlcHJpbnRDb2xvciIsCiAgICAiYWJCdWlsZGVySWRlbnRpdHkiLAogICAgImFiQmFzZUdyaWRQb3J0YWxDb2xvciIsCiAgICAiYWJQcmVmZXJyZWRBSU1vZGVsIiwKICAgICJhYkNhdGFsb2dOYW1lIiwKICAgICJhYk1hcFBvcnRhbEJhc2UiCl0nALPL47ADmn8IYXV0b3NhdmUCBACzy+OwA6m8AQR0cnVlJwEEYm90cyRiOWI4MjgxOS0xZjE0LTQzOTItODhhOS01MmY2N2E5ZjhlNTUBJwCzy+OwA668AQZzeXN0ZW0CBACzy+OwA6+8ARhhYi5wZXJzb25hbGl0eS5hcm1fbnVkZ2UnALPL47ADrrwBDW9uQUJBcm1QbGFjZWQCBACzy+OwA8i8AThAc2V0VGFnTWFzayh0aGlzQm90LCAnaGFzQXJtQmVlblBsYWNlZCcsIHRydWUsICdsb2NhbCcpOycAs8vjsAOuvAEJb25BQkF3YWtlAgQAs8vjsAOBvQEwQGF3YWl0IG9zLnNsZWVwKDI1MCk7CnRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwCzy+OwA668AQhhYklnbm9yZQIEALPL47ADsr0BBHRydWUnALPL47ADrrwBDWFiUGVyc29uYWxpdHkCBACzy+OwA7e9AQR0cnVlJwCzy+OwA668AQRmb3JtAgQAs8vjsAO8vQEHbm90aGluZycAs8vjsAOuvAEFbGVhcm4CBACzy+OwA8S9ASjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCzy+OwA668AQ1tYW5pZmVzdGF0aW9uAgQAs8vjsAPrvQEo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAs8vjsAOuvAEIcmVtZW1iZXICBACzy+OwA5K+ASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCzy+OwA668AQVkZWJ1ZwIEALPL47ADub4BBWZhbHNlJwCzy+OwA668AQ5hcm1OdWRnZVdhaXRNUwIEALPL47ADv74BBDUwMDAnALPL47ADrrwBD29uQUJJbml0aWFsaXplZAIEALPL47ADxL4BG0B0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycAs8vjsAOuvAEPYWJTdGFydEFybU51ZGdlAgQAs8vjsAPgvgGCH0BpZiAodGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhlcmUgaXMgYWxyZWFkeSBhIG51ZGdlIGluIHByb2dyZXNzLmApOwogICAgfQogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUgPSB0cnVlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhcnRpbmcgbnVkZ2UuLi5gKQp9CgpmdW5jdGlvbiBjYW5OdWRnZSgpOiBib29sZWFuIHsKICAgIC8vIENhbid0IGhhdmUgcGxhY2VkIHRoZSBhcm0gYWxyZWFkeS4KICAgIGlmICh0YWdzLmhhc0FybUJlZW5QbGFjZWQpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYXJtIHBsYWNlbWVudCBoYXMgYWxyZWFkeSBvY2N1cmVkLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gQUIgbWFuaWZlc3RhdGlvbiBib3QgbXVzdCBiZSBhY3RpdmUuCiAgICBpZiAoIWxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYWIgbWFuaWZlc3RhdGlvbiBib3QgaXMgaW5hY3RpdmUuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBBQiBjaGF0IGJhciBtdXN0IGJlIGNsb3NlZC4KICAgIGlmIChsaW5rcy5pbnB1dC5tYXNrcy5jaGF0T3BlbikgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBhYiBjaGF0IGJhciBpcyBvcGVuLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gVGhlIGluc3QgbXVzdCBiZSBlbXB0eSBvZiBhbGwgYm90cy4gVGhlIGV4Y2VwdGlvbnMgYXJlIGFiIGJvdHMgYW5kIGJ1aWx0LWluIGJvdHMuCiAgICBjb25zdCB1c2VyTWFkZUJvdCA9IGdldEJvdCgoYikgPT4gewogICAgICAgIHJldHVybiAhYi50YWdzLnN5c3RlbT8uc3RhcnRzV2l0aCgnYWIuJykgJiYKICAgICAgICAgICAgICAgIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmCiAgICAgICAgICAgICAgICAhYi50YWdzLmFiRWdnICYmIC8vIERvbid0IGluY2x1ZGUgYWJFZ2cgYm90cyBhcyAidXNlciBtYWRlIi4KICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJMb2FkZWRTa2lsbCAmJiAvLyBEb24ndCBpbmNsdWRlIGxvYWRlZCBza2lsbCBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgICAgICAgICAgICAgIWIudGFncy5hYkJvdCAvLyBEb24ndCBpbmNsdWRlIGFueSBib3RzIHRoYXQgYXJlIGZsYWdnZWQgd2l0aCBhbiBhYkJvdCB0YWcuCiAgICB9KQogICAgCiAgICBpZiAodXNlck1hZGVCb3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1Z1VzZXJNYWRlQm90cykgewogICAgICAgICAgICAgICAgY29uc3QgdXNlck1hZGVCb3RzID0gZ2V0Qm90cygoYikgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhYi50YWdzLnN5c3RlbT8uc3RhcnRzV2l0aCgnYWIuJykgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAhYi50YWdzLmFiRWdnIC8vIERvbid0IGluY2x1ZGUgYWJFZ2cgYm90cyBhcyAidXNlciBtYWRlIi4KICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogaW5zdCBjb250YWlucyB1c2VyIG1hZGUgYm90cy5gLCB1c2VyTWFkZUJvdHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGluc3QgY29udGFpbnMgdXNlciBtYWRlIGJvdHMuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIE1lbnUgcG9ydGFsIG11c3QgZWl0aGVyIGJlIGluYWN0aXZlIG9yIG5vdCBoYXZlIGFueSBib3RzIGluIHRoZSBjdXJyZW50bHkgYWN0aXZlIG1lbnUgcG9ydGFsLgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwpIHsKICAgICAgICBjb25zdCBib3RJbk1lbnVQb3J0YWwgPSBnZXRCb3QoKGIpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGIudGFnc1tjb25maWdCb3QudGFncy5tZW51UG9ydGFsXSA9PT0gdHJ1ZQogICAgICAgIH0pOwoKICAgICAgICBpZiAoYm90SW5NZW51UG9ydGFsKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogbWVudVBvcnRhbCBpcyBjdXJyZW50bHkgb3BlbiBhbmQgaGFzIGJvdHMgaW4gaXQuYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKfQoKaWYgKGNhbk51ZGdlKCkpIHsKICAgIC8vIFN0YXJ0IG51ZGdlIGZvciBhcm0gcGxhY2VtZW50LgogICAgYXdhaXQgb3Muc2xlZXAodGFncy5hcm1OdWRnZVdhaXRNUyk7CgogICAgaWYgKGNhbk51ZGdlKCkpIHsKICAgICAgICBjb25zdCBhYlBvc2l0aW9uWCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QudGFnc1tsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uICsgJ1gnXTsKICAgICAgICBjb25zdCBhYlBvc2l0aW9uWSA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QudGFnc1tsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uICsgJ1knXTsKCiAgICAgICAgY29uc3QgZ3JpZENsaWNrUGFyYW1zID0gewogICAgICAgICAgICBkaW1lbnNpb246IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24sCiAgICAgICAgICAgIHBvc2l0aW9uOiB7IHg6IGFiUG9zaXRpb25YICsgNSwgeTogYWJQb3NpdGlvblkgfSwKICAgICAgICAgICAgZm9yY2VBcm1QbGFjZW1lbnQ6IHRydWUsCiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uKSB7CiAgICAgICAgICAgIC8vIE1hcCBwb3J0YWwgaXMgaW4gZGlmZmVyZW50IGNvb3JkaW5hdGUgc3BhY2UgYW5kIHNjYWxlLgogICAgICAgICAgICBncmlkQ2xpY2tQYXJhbXMucG9zaXRpb24ueCA9IGFiUG9zaXRpb25YICsgMC4wMDAzNTc0MzQwNjg0MDUzODIzOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3aGlzcGVyaW5nIG9uR3JpZENsaWNrIHRvIHRoZSBhYiBtYW5pZmVzdGF0aW9uIGJvdCB3aXRoIHRoZSBwYXJhbXM6YCwgZ3JpZENsaWNrUGFyYW1zKQogICAgICAgIH0KCiAgICAgICAgLy8gRm9yY2UgYWIgYXJtIHBsYWNlbWVudCB1c2luZyB0aGUgb25HcmlkQ2xpY2sgbGlzdGVuZXIgb2YgdGhlIG1hbmlmZXN0YXRpb24gYm90LgogICAgICAgIHdoaXNwZXIobGlua3MubWFuaWZlc3RhdGlvbiwgJ29uR3JpZENsaWNrJywgZ3JpZENsaWNrUGFyYW1zKTsKICAgIH0KfQoKdGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlID0gZmFsc2U7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkb25lYCk7Cn0nALPL47ADrrwBEG9uQUJDaGF0QmFyQ2xvc2UCBACzy+OwA+PdARtAdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnALPL47ADrrwBBWlucHV0AgQAs8vjsAP/3QEo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAs8vjsAOuvAEJYWJWZXJzaW9uAgQAs8vjsAOm3gEFMTAuMzgnALPL47ADrrwBD29uUG9ydGFsQ2hhbmdlZAIEALPL47ADrN4BhQFAY29uc3QgeyBwb3J0YWwsIGRpbWVuc2lvbiB9ID0gdGhhdDsKCmlmIChwb3J0YWwgPT09ICdtZW51UG9ydGFsJykgewogICAgaWYgKCFkaW1lbnNpb24pIHsKICAgICAgICB0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOwogICAgfQp9JwCzy+OwA668AQ1hYk1lbnVSZWZyZXNoAgQAs8vjsAOy3wEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwCzy+OwA668ARFkZWJ1Z1VzZXJNYWRlQm90cwIEALPL47ADzt8BBWZhbHNlJwEEYm90cyRkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQBJwCzy+OwA9TfAQZzeXN0ZW0CBACzy+OwA9XfARxhYi5wZXJzb25hbGl0eS5tYW5pZmVzdGF0aW9uJwCzy+OwA9TfAQRmb3JtAgQAs8vjsAPy3wEHbm90aGluZycAs8vjsAPU3wELZGVzY3JpcHRpb24CBACzy+OwA/rfAThUaGlzIHNraWxsIGNvbnRyb2xzIHRoZSBhY3R1YWwgYm90IGZvciB0aGUgYWIgaW50ZXJmYWNlLicAs8vjsAPU3wEFbGVhcm4CBACzy+OwA7PgASjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCzy+OwA9TfAQ9vblBvcnRhbENoYW5nZWQCBACzy+OwA9rgAaRJQGNvbnN0IFBPUlRBTFNfVEhBVF9ISURFID0gbmV3IFNldChbCiAgICAic3lzdGVtUG9ydGFsIiwKICAgICJzaGVldFBvcnRhbCIKXSkKCmNvbnN0IFBPUlRBTFNfVEhBVF9NQU5JRkVTVCA9IG5ldyBTZXQoWwogICAgImdyaWRQb3J0YWwiLAogICAgIm1hcFBvcnRhbCIKXSk7Cgpjb25zdCBNQVBfTE9BRF9XQUlUX1RJTUUgPSAxMDAwOwoKZm9yIChjb25zdCBwb3J0YWwgb2YgUE9SVEFMU19USEFUX0hJREUpIHsKICAgIGlmIChjb25maWdCb3QudGFnc1twb3J0YWxdICE9IG51bGwpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGEgcG9ydGFsIHRoYXQgaGlkZXMgYWIgaXMgb3BlbiAtIGhpZGluZyBhYkJvdCBhbmQgaWdub3JpbmcuYCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsICE9IG51bGwgfHwgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsICE9IG51bGwpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGVldCBwb3J0YWwgb3Igc3lzdGVtIHBvcnRhbCBvcGVuZWQgLSBoaWRpbmcgYWJCb3QgYW5kIGlnbm9yaW5nLmApOwogICAgfQoKICAgIGlmICh0YWdzLmFiQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdCk7CiAgICB9CgogICAgcmV0dXJuOwp9CgppZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIGlzIG5vdCBhd2FrZSAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gInRhZ1BvcnRhbCIpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0YWdQb3J0YWwgY2hhbmdlZCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gIm1lbnVQb3J0YWwiKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWVudVBvcnRhbCBjaGFuZ2VkIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAiZ3JpZFBvcnRhbCIgJiYgY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ3JpZFBvcnRhbCBjaGFuZ2VkLCBidXQgYWxzbyBhbHJlYWR5IGluIHRoZSBtYXBQb3J0YWwgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKLy8gVGhlIG1hcCBwb3J0YWwgaXMgdG91Z2guIEl0IHNlZW1zIHRvIHZhcnkgaW4gbG9hZGluZyBzcGVlZCBvbgovLyB2YXJpb3VzIGhhcmR3YXJlIGFuZCBuZXR3b3JrcyBhbmQgaGFzIGJ5IHRoZSB0aW1lIG9uUG9ydGFsQ2hhbmdlZCBpcyBjYWxsZWQgaXQgZG9lc250Ci8vIHNlZW0gZ3VhcmVudGVlZCB0byBiZSBhY3R1YWxseSByZWFkeS4gQWRkaW5nIGEgaGFyZGNvZGVkIHdhaXQgdGltZSB0byBnaXZlIHRoZSBwb3J0YWwgc3BhY2UgdG8gZ2V0Ci8vIHRoZSBtYXAgcG9ydGFsIGZ1bGx5IGxvYWRlZCBiZWZvcmUgY29udGludWluZyB3aXRoIG1hbmlmZXN0aW5nIGFiLgovLwovLyBBdCBzb21lIHBvaW50IHRoaXMgY2FuIGdvIGF3YXkgaWYgd2UgZXZlciBnZXQgYSBzaG91dCBvciBzb21lIG90aGVyIGdhdXJlbnRlZSB0aGF0IHRoZSBtYXAgcG9ydGFsIGlzIGxvYWRlZC9yZWFkeS4KaWYgKHRoYXQucG9ydGFsID09PSAnbWFwUG9ydGFsJykgewogICAgaWYgKHRoYXQuZGltZW5zaW9uKSB7CiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkICYmICF0aGlzQm90LnZhcnMubWFwUG9ydGFsSW5pdGlhbExvYWRlZCkgewogICAgICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG9zLnNsZWVwKE1BUF9MT0FEX1dBSVRfVElNRSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2FpdGluZyBmb3IgbWFwIHBvcnRhbCB0byBmaW5pc2ggbG9hZGluZzogJHtNQVBfTE9BRF9XQUlUX1RJTUV9bXNgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxJbml0aWFsTG9hZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFwIHBvcnRhbCBsb2FkZWQuYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCgogICAgICAgICAgICAvLyBhd2FpdCB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlcjsKICAgICAgICAgICAgLy8gdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwogICAgICAgICAgICAvLyB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXAgcG9ydGFsIGlzIGFscmVhZHkgbG9hZGVkLmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gZmFsc2U7CiAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcCBwb3J0YWwgaGFzIGJlZW4gdW5sb2FkZWQuYCk7CiAgICAgICAgfQogICAgfQp9CgovLyBTdGFydCBjaGVja3MgZm9yIGlmL3doZXJlIHdlIG5lZWQgdG8gbWFuaWZlc3QgYWIuCmxldCBuZXdBQiA9IGZhbHNlOwpsZXQgbmV3QUJQb3J0YWw7CmxldCBuZXdBQlBvc2l0aW9uOwpsZXQgZm9jdXNDYW1lcmEgPSB0cnVlOwpsZXQgZm9jdXNDYW1lcmFTdGFydFpvb207CgppZiAoUE9SVEFMU19USEFUX01BTklGRVNULmhhcyh0aGF0LnBvcnRhbCkgJiYgdGhhdC5kaW1lbnNpb24pIHsKICAgIC8vIEEgcG9ydGFsIHRoYXQgbWFuaWZlc3RzIGFiIGhhcyBqdXN0IGNoYW5nZWQgZGltZW5zaW9uLgogICAgLy8gTWFuaWZlc3QgYWIgaW4gdGhlIG5ldyBkaW1lbnNpb24uCiAgICBpZiAodGhhdC5wb3J0YWwgPT0gIm1hcFBvcnRhbCIgfHwgdGhhdC5wb3J0YWwgPT0gIm1pbmlNYXBQb3J0YWwiKSB7OwogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFuaWZlc3RpbmcgYWIgYm90IGluIG1hcCBwb3J0YWwgZGltZW5zaW9uICcke3RoYXQuZGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgdGhpc0JvdC5nZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignbWFwJyk7CiAgICAgICAgbmV3QUJQb3J0YWwgPSB0aGF0LnBvcnRhbDsKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwogICAgICAgIGZvY3VzQ2FtZXJhU3RhcnRab29tID0gYXdhaXQgdGhpc0JvdC5nZXRTdGFydENhbWVyYVpvb20oJ21hcCcpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYW5pZmVzdGluZyBhYiBib3QgZGltZW5zaW9uICcke3RoYXQuZGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgdGhpc0JvdC5nZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignZ3JpZCcpOwogICAgICAgIG5ld0FCUG9ydGFsID0gdGhhdC5wb3J0YWw7CiAgICAgICAgbmV3QUIgPSBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKICAgICAgICBmb2N1c0NhbWVyYVN0YXJ0Wm9vbSA9IGF3YWl0IHRoaXNCb3QuZ2V0U3RhcnRDYW1lcmFab29tKCdncmlkJyk7CiAgICB9Cn0gZWxzZSBpZiAoKFBPUlRBTFNfVEhBVF9NQU5JRkVTVC5oYXModGhhdC5wb3J0YWwpIHx8IFBPUlRBTFNfVEhBVF9ISURFLmhhcyh0aGF0LnBvcnRhbCkpICYmIAogICAgICAgICAgICF0aGF0LmRpbWVuc2lvbiAmJiAKICAgICAgICAgICAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCB8fCBjb25maWdCb3QudGFncy5tYXBQb3J0YWwpCikgewogICAgLy8gQSBwb3J0YWwgdGhhdCB0eXBpY2FsbHkgaGlkZXMgb3IgcmUtbWFuaWZlc3RzIGFiIGp1c3QgY2xvc2VkLCBidXQgZWl0aGVyIHRoZSBncmlkIG9yIG1hcCBwb3J0YWwgYXJlIHN0aWxsIG9wZW4uCiAgICAvLyBTdW1tb24gYWIgaW4gZWl0aGVyIHRoZSBtYXBQb3J0YWwgb3IgZ3JpZFBvcnRhbC4KICAgIGxldCBzdW1tb25EaW1lbnNpb247CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkgewogICAgICAgIHN1bW1vbkRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbDsKICAgICAgICBuZXdBQlBvcnRhbCA9ICdtYXBQb3J0YWwnOwogICAgICAgIAogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddKSB7CiAgICAgICAgICAgIC8vIFVzZSBsYXN0IGtub3duIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gbGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVc2UgZGVmYXVsdCBtYXAgcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCB0aGlzQm90LmdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwpIHsKICAgICAgICBzdW1tb25EaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ2dyaWRQb3J0YWwnOwoKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXSkgewogICAgICAgICAgICAvLyBVc2UgbGFzdCBrbm93biBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVXNlIGRlZmF1bHQgZ3JpZCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IHRoaXNCb3QuZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ2dyaWQnKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHN1bW1vbkRpbWVuc2lvbikgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3VtbW9uaW5nIGFiIGJvdCBpbiAke25ld0FCUG9ydGFsfSBkaW1lbnNpb24gJyR7c3VtbW9uRGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogc3VtbW9uRGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKCiAgICAgICAgaWYgKFBPUlRBTFNfVEhBVF9ISURFLmhhcyh0aGF0LnBvcnRhbCkpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIHBvcnRhbCB0aGF0IGNsb3NlZCB3YXMgYSBwb3J0YWwgdGhhdCBoaWRlcyBhYiwgdGhlbiBkb250IHJ1biB0aGUgY2FtZXJhIGZvY3VzLgogICAgICAgICAgICAvLyBUaGlzIHdpbGwganVzdCB1c2UgdGhlIHByZXZpb3VzIGNhbWVyYSBwb3NpdGlvbiBhbHJlYWR5IHN0b3JlZCBpbiBtZW1vcnkuCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdpbGwgbm90IGZvY3VzIGNhbWVyYSBvbiBhYiBiZWNhdXNlIHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoZSBwcmV2aW91cyBjYW1lcmEgcG9zaXRpb24uYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9jdXNDYW1lcmEgPSBmYWxzZTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90aCB0aGUgbWFwIGFuZCBncmlkIHBvcnRhbCBhcmUgYm90aCBjbG9zZWQsIGNhbm5vdCBzdW1tb24gYWIgaW4gZWl0aGVyLmApOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIHJldHVybjsKfQoKaWYgKGZvY3VzQ2FtZXJhICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwUHJldmVudEZvY3VzKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpcHBpbmcgY2FtZXJhIGZvY3VzIGFuaW1hdGlvbiBiZWNhdXNlIG1hcFByZXZlbnRGb2N1cyBpcyBzZXQgdG8gdHJ1ZSBvbiB0aGUgYWIgcmVtZW1iZXIgYm90LmApOwogICAgfQoKICAgIGZvY3VzQ2FtZXJhID0gZmFsc2U7Cn0KCmlmIChuZXdBQiAmJiBmb2N1c0NhbWVyYSkgewogICAgaWYgKHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8gJiYgCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5wb3J0YWwgPT09IHRoYXQucG9ydGFsICYmIAogICAgICAgIHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8uZGltZW5zaW9uID09PSB0aGF0LmRpbWVuc2lvbiAmJgogICAgICAgIHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8ucG9zaXRpb24/LnggPT09IG5ld0FCUG9zaXRpb24ueCAmJgogICAgICAgIHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8ucG9zaXRpb24/LnkgPT09IG5ld0FCUG9zaXRpb24ueQogICAgKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYW1lcmEgZm9jdXMgYW5pbWF0aW9uIGJlY2F1c2Ugb25lIGlzIGFscmVhZHkgYWN0aXZlIHdpdGggdGhlIHNhbWUgc2V0dGluZ3MuYCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mbyA9IHsgCiAgICAgICAgcG9ydGFsOiB0aGF0LnBvcnRhbCwgCiAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgICAgICBwb3NpdGlvbjogey4uLm5ld0FCUG9zaXRpb259LAogICAgfTsKCiAgICBsZXQgem9vbSA9IHRhZ3MuZGVmYXVsdEdyaWRQb3J0YWxab29tOwoKICAgIGlmIChuZXdBQlBvcnRhbCA9PT0gJ21hcFBvcnRhbCcgfHwgbmV3QUJQb3J0YWwgPT09ICdtaW5pTWFwUG9ydGFsJykgewogICAgICAgIHpvb20gPSB0YWdzLmRlZmF1bHRNYXBQb3J0YWxab29tOwogICAgfQogICAgCiAgICB0cnkgewogICAgICAgIGlmIChmb2N1c0NhbWVyYVN0YXJ0Wm9vbSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldCBzdGFydCB6b29tIG9mICR7bmV3QUJQb3J0YWx9IHRvICR7Zm9jdXNDYW1lcmFTdGFydFpvb219LmApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIpIHsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhd2FpdCBvcy5mb2N1c09uKG5ld0FCUG9zaXRpb24sIHsgem9vbTogZm9jdXNDYW1lcmFTdGFydFpvb20sIGR1cmF0aW9uOiAwLCBwb3J0YWw6IG5ld0FCUG9ydGFsIH0pOwogICAgICAgICAgICBhd2FpdCBvcy5zbGVlcCgxMDAwKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm9jdXMgb24gJHtKU09OLnN0cmluZ2lmeShuZXdBQlBvc2l0aW9uKX0gaW4gJHtuZXdBQlBvcnRhbH0gd2l0aCB6b29tICR7em9vbX0uYCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRhZ3MuYWJJbml0aWFsaXplZCkgeyAKICAgICAgICAgICAgLy8gW1J5YW5dIFJlYWxseSB3ZWlyZCBDYXN1YWxPUyBidWcgdGhhdCBjYXVzZXMgdGhlIHBvcnRhbCBjYW1lcmEgdG8gbm90IHJlc3BlY3Qgem9vbSBsZXZlbCBpZiB3ZSBkb250IGRvIHRoaXMuCiAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDI1MCk7IAogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3MuZm9jdXNPbihuZXdBQlBvc2l0aW9uLCB7IHpvb20sIHJvdGF0aW9uOiB7IHg6IDQ1LCB5OiA0NSB9LCBwb3J0YWw6IG5ld0FCUG9ydGFsIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm9jdXNPbiBlcnJvciBvY2N1cmVkOmAsIGUpOwogICAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mbyA9IG51bGw7CiAgICB9Cn0nALPL47AD1N8BCHJlbWVtYmVyAgQAs8vjsAP/qQIo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAs8vjsAPU3wENYWJNYW5pZmVzdEJvdAIEALPL47ADpqoC+z5AY29uc3QgZGltZW5zaW9uID0gdGhhdD8uZGltZW5zaW9uOwpjb25zdCBwb3NpdGlvbiA9IHRoYXQ/LnBvc2l0aW9uOwoKaWYgKHRoaXNCb3QudmFycy5hYkJvdExhc3RJZCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgYWJCb3RgKTsKICAgIH0KICAgIGRlc3Ryb3kodGhpc0JvdC52YXJzLmFiQm90TGFzdElkKTsKfQoKY29uc3QgYWJNb2QgPSB7CiAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICBkaW1lbnNpb24sCiAgICBhYkJvdDogdHJ1ZSwKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIGZvcm06ICdjdWJlJywKICAgIGxhYmVsOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsLAogICAgbGFiZWxQb3NpdGlvbjogJ2Zyb250JywKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNjEsCiAgICBkcmFnZ2FibGU6IGZhbHNlLAogICAgYXJtU2VsZWN0aW9uOiB0cnVlLAogICAgYXJtR3JvdXBEcmFnOiB0cnVlLAogICAgYXJtVGVsZXBvcnQ6IHRydWUsCiAgICBhcm1NZXNoUGF0aDogbGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoLAogICAgYXJtQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBwZXJzb25hbGl0eTogdGFncy5wZXJzb25hbGl0eSwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBzcGluRHVyYXRpb25NUzogMjAwMCwKICAgIHNwaW5JbnRlcnZhbE1TOiAyMDAwLAogICAgc291bmRDbGljazogbGlua3MucmVtZW1iZXIudGFncy5hYkNsaWNrU291bmQgPz8gdHJ1ZSwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7IAogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiTWVzaFBhdGgpIHsKICAgICAgICAgICAgbGV0IGZvcm1BZGRyZXNzOwoKICAgICAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJNZXNoUGF0aC5zdGFydHNXaXRoKCdodHRwczovLycpKSB7CiAgICAgICAgICAgICAgICBmb3JtQWRkcmVzcyA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJNZXNoUGF0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvcm1BZGRyZXNzID0gbGlua3MubGVhcm4uYWJCdWlsZENhc3VhbENhdGFsb2dVUkwobGlua3MucmVtZW1iZXIudGFncy5hYk1lc2hQYXRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBtZXNoIGZvciBhYi4KICAgICAgICAgICAgbWFza3MubWVzaEJvdCA9IGdldExpbmsoY3JlYXRlKHsKICAgICAgICAgICAgICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgICAgICAgICAgICAgIGFiQm90OiBnZXRMaW5rKHRoaXNCb3QpLAogICAgICAgICAgICAgICAgZm9ybTogJ21lc2gnLAogICAgICAgICAgICAgICAgZm9ybVN1YnR5cGU6ICdnbHRmJywKICAgICAgICAgICAgICAgIGZvcm1BZGRyZXNzLAogICAgICAgICAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVyOiB0aGlzQm90LmlkLAogICAgICAgICAgICAgICAgYW5jaG9yUG9pbnQ6ICdjZW50ZXInLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICdaJ106IC0wLjUKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGFncy5jb2xvciA9ICd0cmFuc3BhcmVudCc7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAxOwogICAgICAgICAgICB0YWdzLnNwaW5JbnRlcnZhbE1TID0gNDUwMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiBhIGN1c3RvbSBtZXNoIGlzIG5vdCBkZWZpbmVkIGZvciBhYiwgdGhlbiBnaXZlIGFiIGEgImNvcmUiLgogICAgICAgICAgICBtYXNrcy5jb3JlQm90ID0gZ2V0TGluayhjcmVhdGUoewogICAgICAgICAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgICAgICAgICAgYWJCb3Q6IGdldExpbmsodGhpc0JvdCksCiAgICAgICAgICAgICAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAwLjY2LAogICAgICAgICAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNjYWxlOiAwLjc1LAogICAgICAgICAgICAgICAgdHJhbnNmb3JtZXI6IHRoaXNCb3QuaWQsCiAgICAgICAgICAgICAgICBhbmNob3JQb2ludDogJ2NlbnRlcicsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb25dOiB0cnVlLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgJ1onXTogLTAuNQogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0YWdzLmNvbG9yID0gbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvcjsKICAgICAgICAgICAgdGFncy5zY2FsZSA9IDAuOTsKICAgICAgICAgICAgdGFncy5zdHJva2VXaWR0aCA9IDE7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlQ29sb3IgPSBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgICAgICAgICB0YWdzLmZvcm1PcGFjaXR5ID0gMC4zMzsKICAgICAgICAgICAgdGFncy5mb3JtRGVwdGhUZXN0ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzQm90LmFuaW1hdGVCb3QoKTsKICAgICAgICBtYXNrcy5pbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHRoaXNCb3QuYW5pbWF0ZUJvdCgpLCB0YWdzLnNwaW5JbnRlcnZhbE1TKTsKICAgIH0pLAogICAgb25DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09ICdtb3VzZScgJiYgdGhhdC5idXR0b25JZCA9PSAncmlnaHQnKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKG1hc2tzLmFybUJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLmFybUJvdCk7CiAgICAgICAgICAgIG1hc2tzLmFybUJvdCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soKTsKICAgIH0pLAogICAgb25Qb2ludGVyRW50ZXI6TGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlckV4aXQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJykgewogICAgICAgICAgICB0YWdzLm1vdXNlT3ZlciA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyRG93bjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT09ICdsZWZ0JykgewogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24gPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyVXA6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnRCdXR0b25Eb3duID0gZmFsc2U7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJhZzogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24pIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnREcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7ICAKICAgICAgICB9CiAgICB9KSwKICAgIG9uS2V5RG93bjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmtleXMuaW5jbHVkZXMoJ1NoaWZ0JykpIHsKICAgICAgICAgICAgdGFncy5zaGlmdEhlbGQgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICBvbktleVVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQua2V5cy5pbmNsdWRlcygnU2hpZnQnKSkgewogICAgICAgICAgICB0YWdzLnNoaWZ0SGVsZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICB1cGRhdGVQb3J0YWxDdXJzb3I6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsZXQgY3Vyc29yID0gbnVsbDsKCiAgICAgICAgaWYgKHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcpIHsKICAgICAgICAgICAgY3Vyc29yID0gJ2dyYWJiaW5nJzsgICAgCiAgICAgICAgfSBlbHNlIGlmICh0YWdzLm1vdXNlT3ZlcikgewogICAgICAgICAgICBpZiAodGFncy5zaGlmdEhlbGQpIHsKICAgICAgICAgICAgICAgIGN1cnNvciA9ICdjb250ZXh0LW1lbnUnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbEN1cnNvciA9IGN1cnNvcjsKICAgIH0pLAogICAgYW5pbWF0ZUJvdDogTGlzdGVuZXJTdHJpbmcoYXN5bmMgKCkgPT4geyAKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MuYWJPcHRpbWl6ZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm90WiA9IHRhZ3MuZGltZW5zaW9uICsgJ1JvdGF0aW9uWic7CgogICAgICAgIGF3YWl0IGFuaW1hdGVUYWcodGhpc0JvdCwKICAgICAgICB7CiAgICAgICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICAgICAgW3JvdFpdOiAwLAogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgICAgICBbcm90Wl06IDYuMywKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgICAgICB0eXBlOiAnc2ludXNvaWRhbCcsCiAgICAgICAgICAgICAgICBtb2RlOiAnaW5vdXQnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiB0YWdzLnNwaW5EdXJhdGlvbk1TIC8gMTAwMCwKICAgICAgICB9KS5jYXRjaChlID0+IHt9KTsKICAgIH0pLAogICAgb25Bcm1DcmVhdGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAoIXRhZ3MuaW50ZXJ2YWwpIHsKICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgcmVzZXQ6IHRydWUgfSk7CiAgICAgICAgfQogICAgfSksCiAgICBvbkFybVBsYWNlZDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiR3JpZEZvY3VzID0gewogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLCAKICAgICAgICAgICAgcG9zaXRpb246IHsKICAgICAgICAgICAgICAgIHg6IHRoYXQueCwKICAgICAgICAgICAgICAgIHk6IHRoYXQueQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnZ3JpZCcgfSk7CgogICAgICAgIHNob3V0KCdvbkFCQXJtUGxhY2VkJywgdGhhdCk7CiAgICB9KSwKICAgIG9uQXJtQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyByZXNldDogdHJ1ZSB9KTsKICAgICAgICBzaG91dCgnb25BQkZvb3RDbGlja2VkJywgdGhhdCk7CiAgICB9KSwKICAgIG9uQXJtU2VsZWN0ZWRCb3RzOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VsZWN0ZWRCb3RzID0gdGhhdDsKCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0ZWRCb3RzKSkgewogICAgICAgICAgICAvLyBNdWx0aXBsZSBib3Qgc2VsZWN0aW9uLgogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYk11bHRpcGxlQm90Rm9jdXMgPSBnZXRMaW5rKHNlbGVjdGVkQm90cyk7CiAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdtdWx0aXBsZUJvdCcgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gU2luZ2xlIGJvdCBzZWxlY3Rpb24uCiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiQm90Rm9jdXMgPSAi8J+UlyIgKyBzZWxlY3RlZEJvdHMuaWQ7CgogICAgICAgICAgICBpZiAoc2VsZWN0ZWRCb3RzID09PSB0aGlzQm90KSB7CiAgICAgICAgICAgICAgICBhYi5saW5rcy5tZW51LmFiRW52aXJvbm1lbnRNZW51KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnYm90JyB9KTsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIHNob3V0KCdvbkFCU2VsZWN0ZWRCb3QnLCBzZWxlY3RlZEJvdHMpOwogICAgfSksCiAgICBvbkFybURlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBzaG91dCgnYWJNZW51UmVmcmVzaCcpOwogICAgfSksCiAgICBvbkRlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjbGVhckludGVydmFsKHRhZ3MuaW50ZXJ2YWwpOwogICAgICAgIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7CiAgICB9KSwKfTsKCmNvbnN0IGFiQm90ID0gY3JlYXRlKGFiTW9kKTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiU2Vjb25kYXJ5TGFiZWwpIHsKICAgIGNvbnN0IGFiTGFiZWxCb3QgPSB7CiAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgICAgIFtkaW1lbnNpb24gKyAnWiddOiAtMSwKICAgICAgICBjcmVhdG9yOiBhYkJvdC5pZCwKICAgICAgICB0cmFuc2Zvcm1lcjogYWJCb3QuaWQsCiAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICBjb2xvcjogJ2NsZWFyJywKICAgICAgICBsYWJlbDogbGlua3MucmVtZW1iZXIudGFncy5hYlNlY29uZGFyeUxhYmVsLAogICAgICAgIGxhYmVsUG9zaXRpb246ICdsZWZ0JywKICAgICAgICBsYWJlbFNpemU6IDAuNywKICAgICAgICBsYWJlbENvbG9yOiBhYkJvdC50YWdzLmxhYmVsQ29sb3IsCiAgICB9OwoKICAgIGNyZWF0ZShhYkxhYmVsQm90KTsKfQoKbWFza3MuYWJCb3QgPSBnZXRMaW5rKGFiQm90KTsKbGlua3MucmVtZW1iZXIubWFza3MuYWJBY3RpdmVEaW1lbnNpb24gPSBkaW1lbnNpb247CnRoaXNCb3QudmFycy5hYkJvdExhc3RJZCA9IGFiQm90LmlkOyAvLyBTdG9yaW5nIGlkIGFzIGEgdmFyIHByZXZlbnRzIGdob3N0IGFiQm90cyBkdXJpbmcgbXVsdGlwbGUgY2FsbHMgaW4gb25lIGZyYW1lLgoKLy8gU3RvcmUgdGhlIGxhc3QgcG9zaXRpb24gb2YgYWIgaW4gdGhpcyBkaW1lbnNpb24gb24gdGhlIHJlbWVtYmVyIGJvdC4KbGlua3MucmVtZW1iZXIubWFza3NbZGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10gPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeSh7IHg6IHBvc2l0aW9uPy54LCB5OiBwb3NpdGlvbj8ueSB9KTsKCmF3YWl0IG9zLnNsZWVwKDApOyAvLyBHaXZlIENhc3VhbE9TIGEgY2hhbmNlIHRvIHVwZGF0ZSB0YWcgbWFza3MuCgpzaG91dCgnb25BQk1vdmVkJywgeyBkaW1lbnNpb24sIHg6IHBvc2l0aW9uLngsIHk6IHBvc2l0aW9uLnkgfSk7CgpyZXR1cm4gYWJCb3Q7JwCzy+OwA9TfAQtvbkdyaWRDbGljawIEALPL47ADnukC2RZAaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgIHJldHVybjsKfQoKY29uc3Qgc2hpZnRDaGVjayA9IG9zLmdldElucHV0U3RhdGUoImtleWJvYXJkIiwgIlNoaWZ0Iik7CgppZiAobGlua3MuYWJCb3QgJiYgKHNoaWZ0Q2hlY2sgfHwgKHRoYXQubW9kYWxpdHkgPT0gIm1vdXNlIiAmJiB0aGF0LmJ1dHRvbklkID09ICJyaWdodCIgJiYgIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSaWdodENsaWNrRGlzYWJsZWQpIHx8IHRoYXQuZm9yY2VBcm1QbGFjZW1lbnQpKSB7CiAgICBjb25zdCBhcm1Cb3QgPSBhYi5saW5rcy5hcm1fdG9vbC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBsaW5rcy5hYkJvdCwKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB0aGF0LnBvc2l0aW9uLAogICAgfSkKCiAgICAvLyBGYWtlIHVzZXIgZHJvcHBpbmcgdGhlIGFybSBvbiB0aGUgZ3JpZCBzcGFjZS4KICAgIGFybUJvdC5vbkRyb3AoewogICAgICAgIGJvdDogYXJtQm90LAogICAgICAgIHRvOiB7CiAgICAgICAgICAgIHg6IHRoYXQucG9zaXRpb24ueCwKICAgICAgICAgICAgeTogdGhhdC5wb3NpdGlvbi55LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfSwKICAgICAgICBmcm9tOiB7CiAgICAgICAgICAgIHg6IHRoYXQucG9zaXRpb24ueCwKICAgICAgICAgICAgeTogdGhhdC5wb3NpdGlvbi55LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuOwp9Cgpjb25zdCBmb290cHJpbnQgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgW3RoYXQuZGltZW5zaW9uXTogdHJ1ZSwKICAgIFt0aGF0LmRpbWVuc2lvbiArICJYIl06IHRoYXQucG9zaXRpb24ueCwKICAgIFt0aGF0LmRpbWVuc2lvbiArICJZIl06IHRoYXQucG9zaXRpb24ueSwKICAgIHBvc2l0aW9uSW5mbzogdGhhdCwKICAgIHBlcnNvbmFsaXR5OiB0YWdzLnBlcnNvbmFsaXR5LAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIGRyYWdnYWJsZTogZmFsc2UsCiAgICBjdXJzb3I6ICdhbGlhcycsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgc291bmRDcmVhdGU6ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KFsgJ2FiL2F1ZGlvL2dyaWQgdGFwXzAxLm1wMycsICdhYi9hdWRpby9ncmlkIHRhcF8wMi5tcDMnLCAnYWIvYXVkaW8vZ3JpZCB0YXBfMDMubXAzJywgJ2FiL2F1ZGlvL2dyaWQgdGFwXzA0Lm1wMycsICdhYi9hdWRpby9ncmlkIHRhcF8wNS5tcDMnIF0pLAogICAgb25DcmVhdGU6IExpc3RlbmVyU3RyaW5nKGFzeW5jICgpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGRlc3Ryb3kodGhpc0JvdCksIDgwMCk7CgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJtTWVzaFBhdGgpIHsKICAgICAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aC5zdGFydHNXaXRoKCdodHRwczovLycpKSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhZ3MuZm9ybSA9ICdtZXNoJzsKICAgICAgICAgICAgdGFncy5mb3JtU3VidHlwZSA9ICdnbHRmJzsKICAgICAgICAgICAgdGFncy5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgICAgICAgICB0YWdzLmFuY2hvclBvaW50ID0gJ2NlbnRlcic7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGFncy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgICAgICAgICB0YWdzLnNjYWxlWiA9IDAuMDE7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBhbmltYXRlVGFnKHRoaXNCb3QsIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBzY2FsZVg6IDAuMSwKICAgICAgICAgICAgICAgIHNjYWxlWTogMC4xCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIHNjYWxlWDogMS4xLAogICAgICAgICAgICAgICAgc2NhbGVZOiAxLjEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDAuNSwKICAgICAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgICAgICB0eXBlOiAiZWxhc3RpYyIsCiAgICAgICAgICAgICAgICBtb2RlOiAib3V0IgogICAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZSA9PiB7fSk7CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgIHNob3V0KCJvbkFCRm9vdENsaWNrZWQiLCB7IGRpbWVuc2lvbjogdGFncy5kaW1lbnNpb24gfSk7CiAgICAgICAgbGlua3MubWFuYWdlci5hYk1hbmlmZXN0Qm90KHRhZ3MucG9zaXRpb25JbmZvKTsKICAgICAgICBhYi5saW5rcy5zb3VuZC5hYlBsYXlTb3VuZCh7IHZhbHVlOiBhYi5saW5rcy5hcm1fdG9vbC50YWdzLmRlZmF1bHRBcm1UZWxlcG9ydFNvdW5kIH0pOwogICAgfSksCn07CgoKY3JlYXRlKGZvb3RwcmludCk7JwCzy+OwA9TfAQRtZW51AgQAs8vjsAP2/wIo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAs8vjsAPU3wEHYWJDbGljawIEALPL47ADnYAD0ApAaWYgKCFsaW5rcy5hYkJvdCkgewogICAgcmV0dXJuOwp9CgppZiAobGlua3MuaW5wdXQpIHsKICAgIGxpbmtzLmlucHV0LmFiQ2hhdEJhckNsb3NlKCk7Cn0KCmNvbnN0IHJlc2V0ID0gdGhhdCA/IHRoYXQucmVzZXQgOiBmYWxzZTsKY29uc3QgbWVudSA9IHRoYXQgPyB0aGF0Lm1lbnUgOiAiY29yZSI7CmNvbnN0IHN0YXRlID0gb3MuZ2V0SW5wdXRTdGF0ZSgia2V5Ym9hcmQiLCAiU2hpZnQiKTsKCmlmICghcmVzZXQgJiYgKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwgfHwgc3RhdGUpKSB7CiAgICBjb25zdCBhYk1lbnVCb3RzID0gZ2V0Qm90cygiYWJNZW51IiwgdHJ1ZSk7CgogICAgd2hpc3BlcihhYk1lbnVCb3RzLCAiYWJNZW51UmVmcmVzaCIpOwoKICAgIGNsZWFySW50ZXJ2YWwobGlua3MuYWJCb3QudGFncy5pbnRlcnZhbCk7CgogICAgbGlua3MuYWJCb3QubWFza3MuaW50ZXJ2YWwgPSBudWxsOwoKICAgIGNsZWFyQW5pbWF0aW9ucyhsaW5rcy5hYkJvdCk7CgogICAgY29uc3Qgcm90WiA9IGxpbmtzLmFiQm90LnRhZ3MuZGltZW5zaW9uICsgIlJvdGF0aW9uWiI7CgogICAgaWYgKHN0YXRlICYmIG1lbnUgPT0gImNvcmUiKSB7CiAgICAgICAgbGlua3MubWVudS5hYkVudmlyb25tZW50TWVudSgpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgbGlua3MubWVudS5hYk9wZW5NZW51KG1lbnUpOwogICAgfQoKICAgIGFuaW1hdGVUYWcobGlua3MuYWJCb3QsIHsKICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgW3JvdFpdOiBsaW5rcy5hYkJvdC50YWdzW3JvdFpdCiAgICAgICAgfSwKICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgIFtyb3RaXTogMAogICAgICAgIH0sCiAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgIHR5cGU6ICJzaW51c29pZGFsIiwKICAgICAgICAgICAgbW9kZTogImlub3V0IgogICAgICAgIH0sCiAgICAgICAgZHVyYXRpb246IDAuNQogICAgfSkuY2F0Y2goZSA9PiB7fSkKfQplbHNlIHsKICAgIGxpbmtzLmFiQm90LmFuaW1hdGVCb3QoKTsKCiAgICBsaW5rcy5hYkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwoKICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgY2xlYXJJbnRlcnZhbChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsKTsKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gbGlua3MuYWJCb3QuYW5pbWF0ZUJvdCgpLCBsaW5rcy5hYkJvdC50YWdzLnNwaW5JbnRlcnZhbE1TKTsKfQoKc2hvdXQoJ29uQUJDbGljaycsIHsgYWJCb3Q6IGxpbmtzLmFiQm90LCBkaW1lbnNpb246IGxpbmtzLmFiQm90LnRhZ3MuZGltZW5zaW9uLCBtZW51LCBzaGlmdEtleTogISFzdGF0ZSwgcmVzZXQgfSk7JwCzy+OwA9TfAQhhYklnbm9yZQIEALPL47AD7ooDBHRydWUnALPL47AD1N8BA2FzawIEALPL47AD84oDKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnALPL47AD1N8BCWFza0J1dHRvbgIEALPL47ADmosDyAVAaWYgKCF0YWdzLmFiQXdha2UpCnsKICAgIHJldHVybjsKfQoKbGV0IGFiTWVudUJ1dHRvbiA9IHt9OwoKYWJNZW51QnV0dG9uLmFiTWVudSA9IHRydWU7CmFiTWVudUJ1dHRvbi5yZW1lbWJlciA9IGxpbmtzLm1lbnUudGFncy5yZW1lbWJlcjsKYWJNZW51QnV0dG9uLm1hbmlmZXN0YXRpb24gPSBsaW5rcy5tZW51LnRhZ3MubWFuaWZlc3RhdGlvbjsKYWJNZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CmFiTWVudUJ1dHRvbi5iYXNlU2tpbGwgPSAi8J+UlyIgKyBsaW5rcy5hc2suaWQ7CmFiTWVudUJ1dHRvbi5sYWJlbCA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVMYWJlbDsKYWJNZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUljb247CmFiTWVudUJ1dHRvbi5vbkNyZWF0ZSA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVPbkdlbmVyYXRlOwphYk1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudVNvcnRPcmRlcjsKYWJNZW51QnV0dG9uLmNvbG9yID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUNvbG9yID8gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUNvbG9yIDogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGFiTWVudUJ1dHRvbik7JwCzy+OwA9TfAQlhYkJvdENoYXQCBACzy+OwA+GQA+4IQGlmICghbGlua3MuYWJCb3QgJiYgIXRoYXQuYm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGJvdEJhc2UgPSB0aGF0LmJvdCA/IHRoYXQuYm90OiBsaW5rcy5hYkJvdDsKY29uc3QgZGltZW5zaW9uID0gIXRoYXQuYm90ID8gYm90QmFzZS50YWdzLmRpbWVuc2lvbiA6IHRoYXQuZGltZW5zaW9uID8gdGhhdC5kaW1lbnNpb24gOiBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwpjb25zdCBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwpjb25zdCBtZXNzYWdlVGltZSA9IHRoYXQudGltZSA/IHRoYXQudGltZSAqIDEwMDAgOiAxNjAwOyAKCmNvbnN0IG1lc3NhZ2VCb3QgPSBhd2FpdCBsaW5rcy5ib3RfZmFjdG9yeS5hYkNyZWF0ZUJpbGxib2FyZExhYmVsKHsKICAgIGJvdDogYm90QmFzZSwKICAgIGxhYmVsOiBtZXNzYWdlLAogICAgZGltZW5zaW9uLAogICAgbWVzc2FnZVRpbWUsCiAgICBjb2xvcjogIiMwMDAwMDAiLAogICAgbGFiZWxDb2xvcjogIiNmZmZmZmYiLAogICAgb25Cb3RBZGRlZDogYEAKICAgICAgICBhd2FpdCBvcy5zbGVlcCh0YWdzLm1lc3NhZ2VUaW1lKTsKICAgICAgICB0aGlzQm90Lm9uRmFkZSgpOwogICAgYCwKICAgIG9uRmFkZTogYEAKICAgICAgICBhbmltYXRlVGFnKHRoaXNCb3QsIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBmb3JtT3BhY2l0eTogMSwKICAgICAgICAgICAgICAgIGxhYmVsT3BhY2l0eTogMSwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICJaIl06IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAiWiJdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAwLAogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAwLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgIloiXTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICJaIl0gKyA1CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAke3RoYXQuZHVyYXRpb24gPz8gM30KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZSkgPT4ge30pCiAgICAgICAgLmZpbmFsbHkoKCkgPT4gewogICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgIH0pCgogICAgYCwKfSk7JwCzy+OwA9TfAQlhYlZlcnNpb24CBACzy+OwA9CZAwUxMC4zOCcAs8vjsAPU3wEJYW5pbWF0aW9uAgQAs8vjsAPWmQMo8J+Ul2IyNmUxMDg5LTE3MmQtNDVhOS04ZDIyLTA1YzNmNThjMmJmNycAs8vjsAPU3wEPb25BbnlCb3RDbGlja2VkAgQAs8vjsAP9mQPpB0BpZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSaWdodENsaWNrRGlzYWJsZWQgJiYgIXRoYXQuYm90LnRhZ3MuYWJSaWdodENsaWNrSWdub3JlICYmIHRoYXQubW9kYWxpdHkgPT0gIm1vdXNlIiAmJiB0aGF0LmJ1dHRvbklkID09ICJyaWdodCIpIHsKICAgIGlmICghdGFncy5hYkF3YWtlKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGFiIHNlbGVjdGVkCiAgICBpZiAodGhhdC5ib3QgPT0gbGlua3MuYWJCb3QpIHsKICAgICAgICBsaW5rcy5tZW51LmFiRW52aXJvbm1lbnRNZW51KCk7CiAgICAgICAgcmV0dXJuOwogICAgfSAgICAKICAgIAogICAgY29uc3QgYXJtQm90ID0gYWIubGlua3MuYXJtX3Rvb2wuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogbGlua3MuYWJCb3QsCiAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgICAgICBwb3NpdGlvbjogdGhhdC5wb3NpdGlvbiwKICAgIH0pCgogICAgY29uc3QgYm90UG9zaXRpb24gPSBnZXRCb3RQb3NpdGlvbih0aGF0LmJvdCwgdGhhdC5kaW1lbnNpb24pOwoKICAgIC8vIEZha2UgdXNlciBkcm9wcGluZyB0aGUgc2VsZWN0aW5nIHRoZSBib3Qgd2l0aCB0aGUgYXJtLgogICAgYXJtQm90Lm9uRHJvcCh7CiAgICAgICAgYm90OiBhcm1Cb3QsCiAgICAgICAgdG86IHsKICAgICAgICAgICAgYm90OiB0aGF0LmJvdCwKICAgICAgICAgICAgeDogYm90UG9zaXRpb24ueCwKICAgICAgICAgICAgeTogYm90UG9zaXRpb24ueSwKICAgICAgICAgICAgejogYm90UG9zaXRpb24ueiwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0sCiAgICAgICAgZnJvbTogewogICAgICAgICAgICB4OiBib3RQb3NpdGlvbi54LAogICAgICAgICAgICB5OiBib3RQb3NpdGlvbi55LAogICAgICAgICAgICB6OiBib3RQb3NpdGlvbi56LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuOwp9JwCzy+OwA9TfAQVpbnB1dAIEALPL47AD56EDKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnALPL47AD1N8BC3BlcnNvbmFsaXR5AgQAs8vjsAOOogMo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicAs8vjsAPU3wENYWJQZXJzb25hbGl0eQIEALPL47ADtaIDBHRydWUnALPL47AD1N8BCmFiU2V0QXdha2UCBACzy+OwA7qiA4wQQGxldCBhd2FrZSA9IHRoYXQ/LmF3YWtlOwpsZXQgaW5pdGlhbCA9IHRoYXQ/LmluaXRpYWwgPz8gZmFsc2U7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9Cgphc3NlcnQodHlwZW9mIGF3YWtlID09PSAnYm9vbGVhbicsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXdha2UgaXMgYSByZXF1aXJlZCBib29sZWFuIHBhcmFtZXRlci5gKTsKCmlmIChjb25maWdCb3QudGFncy5hYlN0YXlBd2FrZSkgewogICAgLy8gSWYgYWJTdGF5QXdha2UgaXMgZW5hYmxlZCwgb3ZlcnJpZGUgdGhlIGluY29taW5nIGF3YWtlIHBhcmFtZXRlciBhbmQgbmV2ZXIgbGV0IGFiIGJlIHB1dCB0byBzbGVlcC4KICAgIGF3YWtlID0gdHJ1ZTsKfQoKaWYgKHRhZ3MuYWJBd2FrZSAhPT0gYXdha2UpIHsKICAgIGlmIChpbml0aWFsKSB7CiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4pIHsKICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gdXVpZCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBQbGF5IGluaXRpYWwgYW5pbWF0aW9uIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbEFuaW1hdGlvbikgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5hbmltYXRpb25bbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxBbmltYXRpb25dKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFNob3cgaW5pdGlhbCBtZXNzYWdlIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpIHsKICAgICAgICAgICAgc2hvdXQoInNob3dDb25zb2xlIik7CgogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZVtpXSk7CgogICAgICAgICAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDIwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBVcGRhdGUgYWJBd2FrZSBzaGFyZWQgdGFnIG1hc2suCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdhYkF3YWtlJywgYXdha2UsICdzaGFyZWQnKTsKICAgIAogICAgaWYgKGF3YWtlKSB7CiAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/PyBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwoKICAgICAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHsgeDogMCwgeTogMCB9OwoKICAgICAgICBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb24sIHBvc2l0aW9uIH0pOwoKICAgICAgICBzaG91dCgib25BQkF3YWtlIiwgeyBkaW1lbnNpb24sIHBvc2l0aW9uLCBpbml0aWFsIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKCiAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICBzaG91dCgib25BQlNsZWVwIik7CiAgICB9Cn0nALPL47AD1N8BBXV0aWxzAgQAs8vjsAPHsgMo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAs8vjsAPU3wELYm90X2ZhY3RvcnkCBACzy+OwA+6yAyjwn5SXYzc4YWE2NjMtZDA1Yy00ZWM0LWJjMmMtMjZmZDUxNTYwYjk3JwCzy+OwA9TfAQ9vbkFCSW5pdGlhbGl6ZWQCBACzy+OwA5WzA6wBQG1hc2tzLmFiSW5pdGlhbGl6ZWQgPSB0cnVlOw0KDQppZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7DQogICAgdGhpc0JvdC5vblBvcnRhbENoYW5nZWQoe3BvcnRhbDogIm1hcFBvcnRhbCIsIGRpbWVuc2lvbjogY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsLCBpbml0aWFsOiB0cnVlIH0pOw0KfScAs8vjsAPU3wEFZGVidWcCBACzy+OwA8K0AwR0cnVlJwCzy+OwA9TfARpnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbgIEALPL47ADx7QDqQtAYXN5bmMgZnVuY3Rpb24gZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24ocG9ydGFsOiAnbWFwJyB8ICdncmlkJyk6IHsgeDogbnVtYmVyLCB5OiBudW1iZXIgfSB7CiAgICBpZiAocG9ydGFsID09PSAnZ3JpZCcpIHsKICAgICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH0KICAgIH0gZWxzZSBpZiAocG9ydGFsID09PSAnbWFwJykgewogICAgICAgIGlmICh0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnggPT09ICdudW1iZXInICYmICB0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgY3VycmVudFBvc2l0aW9uID0gdW5kZWZpbmVkOwogICAgICAgICAgICBsZXQgaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uID0gYXdhaXQgbGlua3MudXRpbHMuaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKCk7CgogICAgICAgICAgICAvLyBDdXJyZW50IHdvcmstYXJvdW5kIGZvciBhbGxvd2luZyBnZW9sb2NhdGlvbiBmb3IgaU9TIGFwcAogICAgICAgICAgICBpZiAoZ2V0Qm90KCJzeXN0ZW0iLCAiYWIuaW9zYnJpZGdlLm1lc3NlbmdlciIpKSB7CiAgICAgICAgICAgICAgICBoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24gPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnZW9sb2NhdGlvbiA9IGF3YWl0IG9zLmdldEdlb2xvY2F0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAoZ2VvbG9jYXRpb24uc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbiA9IHsgeDogZ2VvbG9jYXRpb24ubG9uZ2l0dWRlLCB5OiBnZW9sb2NhdGlvbi5sYXRpdHVkZSB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXJyZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50UG9zaXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHUlBNIFBvc2l0aW9uCiAgICAgICAgICAgICAgICByZXR1cm4geyB4OiAtODUuNjc2MTg5NDgyMjQzNCwgeTogNDIuOTY1Njc1Njc1Njc1NiB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdW5yZWNvbmdpemVkIHBvcnRhbCB0eXBlIHByb3ZpZGVkIHRvIGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uOmAsIHBvcnRhbCk7CiAgICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9CiAgICB9Cn0KCnJldHVybiBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbih0aGF0KTsnALPL47AD1N8BEmdldFN0YXJ0Q2FtZXJhWm9vbQIEALPL47AD8b8DkARAYXN5bmMgZnVuY3Rpb24gZ2V0U3RhcnRDYW1lcmFab29tKHBvcnRhbDogJ21hcCcgfCAnZ3JpZCcpOiBudW1iZXIgfCBudWxsIHsKICAgIGlmIChwb3J0YWwgPT09ICdncmlkJykgewogICAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIGlmIChwb3J0YWwgPT09ICdtYXAnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFN0YXJ0Wm9vbSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgcmV0dXJuIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwU3RhcnRab29tOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVucmVjb25naXplZCBwb3J0YWwgdHlwZSBwcm92aWRlZCB0byBnZXRTdGFydENhbWVyYVpvb206YCwgcG9ydGFsKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KfQoKcmV0dXJuIGdldFN0YXJ0Q2FtZXJhWm9vbSh0aGF0KTsnALPL47AD1N8BFGRlZmF1bHRNYXBQb3J0YWxab29tAgQAs8vjsAOCxAMEMTAwMCcAs8vjsAPU3wEQb25BQkJlZm9yZVVwZGF0ZQIEALPL47ADh8QDNkBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gdGFncy5hYkF3YWtlOycAs8vjsAPU3wELb25BQlVwZGF0ZWQCBACzy+OwA77EA48BQGlmIChjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlKSB7CiAgICBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gbnVsbDsKICAgIGF3YWl0IHRoaXNCb3QuYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlIH0pCn0nALPL47AD1N8BFWRlZmF1bHRHcmlkUG9ydGFsWm9vbQIEALPL47ADzsUDAjIwJwCzy+OwA9TfAQlvbkFCQXdha2UCBACzy+OwA9HFA8IBQGNvbnN0IHsgZGltZW5zaW9uLCBwb3NpdGlvbiwgaW5pdGlhbCB9ID0gdGhhdDsKCmlmIChpbml0aWFsICYmIGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwgPT09IGRpbWVuc2lvbikgewogICAgb3MuZm9jdXNPbihwb3NpdGlvbiwgeyB6b29tOiB0YWdzLmRlZmF1bHRHcmlkUG9ydGFsWm9vbSwgcG9ydGFsOiAnZ3JpZFBvcnRhbCcgfSk7Cn0A"}]}