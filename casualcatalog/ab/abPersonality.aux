{"version":2,"updates":[{"id":0,"timestamp":1767627766430,"update":"AcIBmO3VtgEAJwEEYm90cyQxNjU1NGJjMS1lOTNlLTRhMGItOGNkMy1kZmQ3NzIzMTk2NzIBJwCY7dW2AQAJYWJWZXJzaW9uAgQAmO3VtgEBBTEwLjM1JwCY7dW2AQAGc3lzdGVtAgQAmO3VtgEHFmFiLnBlcnNvbmFsaXR5LnZlcnNpb24nAJjt1bYBABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQAmO3VtgEeATEnAJjt1bYBAA1vblNraWxsVXBkYXRlAgQAmO3VtgEgrQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAmO3VtgEADWFiUGVyc29uYWxpdHkCBACY7dW2Ac4BBHRydWUnAJjt1bYBAAhhYklnbm9yZQIEAJjt1bYB0wEEdHJ1ZScAmO3VtgEABGZvcm0CBACY7dW2AdgBB25vdGhpbmcnAJjt1bYBABlhYlBlcnNvbmFsaXR5TWlub3JWZXJzaW9uAgQAmO3VtgHgAQIzMicBBGJvdHMkM2M3NGM5ZjEtODJkYy00NjU1LThiMzgtZTdmMTFkZTg5NzhlAScAmO3VtgHjAQZzeXN0ZW0CBACY7dW2AeQBF2FiLnBlcnNvbmFsaXR5LmFybV90b29sJwCY7dW2AeMBDG9uQW55Qm90RHJhZwIEAJjt1bYB/AGNCEBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC50YWdzLmFybVNlbGVjdGlvbikgewogICAgaWYgKGRyYWdCb3QubWFza3MuYXJtQm90KSB7CiAgICAgICAgaWYgKGRyYWdCb3QubGlua3MuYXJtQm90LnRhZ3MubXVsdGlTZWxlY3QgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMgJiYgZHJhZ0JvdC50YWdzLmFybUdyb3VwRHJhZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlbmFibGUgY3VzdG9tIGRyYWdnaW5nYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9zLmVuYWJsZUN1c3RvbURyYWdnaW5nKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95IHByZXZpb3VzIGFybUJvdDogJHtkcmFnQm90Lm1hc2tzLmFybUJvdH1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveShkcmFnQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgY29uc3QgbXVsdGlTZWxlY3RLZXlIZWxkID0gb3MuZ2V0SW5wdXRTdGF0ZSgna2V5Ym9hcmQnLCAnU2hpZnQnKTsKICAgIGNvbnN0IG11bHRpU2VsZWN0QWxsb3dlZCA9IGRyYWdCb3QudGFncy5hcm1NdWx0aVNlbGVjdCA/PyB0cnVlOwoKICAgIGNvbnN0IGFybUJvdCA9IHRoaXNCb3QuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogZHJhZ0JvdCwKICAgICAgICBkaW1lbnNpb24sCiAgICAgICAgbXVsdGlTZWxlY3Q6IG11bHRpU2VsZWN0S2V5SGVsZCAmJiBtdWx0aVNlbGVjdEFsbG93ZWQsCiAgICB9KQoKICAgIG9zLnJlcGxhY2VEcmFnQm90KGFybUJvdCk7Cn0KJwCY7dW2AeMBBWRlYnVnAgQAmO3VtgGKCgVmYWxzZScAmO3VtgHjAQlsaXN0ZW5pbmcCBACY7dW2AZAKBHRydWUnAJjt1bYB4wELYWJDcmVhdGVBcm0CBACY7dW2AZUK0kFAY29uc3Qgb3JpZ2luQm90ID0gdGhhdC5vcmlnaW5Cb3Q7CmFzc2VydChhYi5saW5rcy51dGlscy5pc0JvdChvcmlnaW5Cb3QpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbkJvdCBpcyBhIHJlcXVpcmVkIEJvdCBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBkaW1lbnNpb24gPSB0aGF0LmRpbWVuc2lvbjsKYXNzZXJ0KHR5cGVvZiBkaW1lbnNpb24gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRpbWVuc2lvbiBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBwb3NpdGlvbiA9IHRoYXQucG9zaXRpb24gPz8gZ2V0Qm90UG9zaXRpb24ob3JpZ2luQm90LCBkaW1lbnNpb24pOwpjb25zdCBhcm1Db2xvciA9IHRoYXQuYXJtQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3MuYXJtQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3Muc3Ryb2tlQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3MuY29sb3I7CmNvbnN0IG11bHRpU2VsZWN0ID0gdGhhdC5tdWx0aVNlbGVjdCA/PyBmYWxzZTsKCmNvbnN0IGFybSA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIFtkaW1lbnNpb24gKyAnWiddOiBwb3NpdGlvbi56LAogICAgY3JlYXRvcjogb3JpZ2luQm90LmlkLAogICAgaXNBcm1Cb3Q6IHRydWUsCiAgICBwb2ludGFibGU6IHRydWUsCiAgICBtdWx0aVNlbGVjdCwKICAgIGRlYnVnOiB0YWdzLmRlYnVnLAogICAgb3JpZ2luQm90OiBnZXRMaW5rKG9yaWdpbkJvdCksCiAgICBkaW1lbnNpb24sCiAgICBzY2FsZTogMC45LAogICAgc2NhbGVaOiAwLjAxLAogICAgY29sb3I6ICdjbGVhcicsCiAgICBhcm1Db2xvciwKICAgIHN0cm9rZUNvbG9yOiBhcm1Db2xvciwKICAgIGxpbmVDb2xvcjogYXJtQ29sb3IsCiAgICBsaW5lVG86IG9yaWdpbkJvdC5pZCwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjcmVhdGVkIGFybUJvdCAke3RoaXNCb3QuaWR9YCk7CiAgICAgICAgfQogICAgICAgIC8vIERlc3Ryb3kgcHJldmlvdXMgYXJtIGlmIGl0IGlzIHN0aWxsIGFyb3VuZC4KICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1Cb3QpOwogICAgICAgIH0KCiAgICAgICAgdGFncy5zeXN0ZW0gPSBgYXJtLiR7dGhpc0JvdC5pZC5zdWJzdHJpbmcoMCwgNSl9YDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtQm90ID0gZ2V0TGluayh0aGlzQm90KTsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuZHJhZ2dhYmxlID0gdGFncy5tdWx0aVNlbGVjdDsKCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgdGFncy5mb3JtID0gJ3NwaGVyZSc7CiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgIH0KCiAgICAgICAgLy8gTWFrZSB0aGUgb3JpZ2luIGJvdCB1bnNlbGVjdGFibGUgZm9yIDEvNCBvZiBhIHNlY29uZC4KICAgICAgICAvLyBUaGlzIGhlbHBzIHByZXZlbnQgdW5pbnRlbnRpb25hbCBzZWxmLXNlbGVjdGlvbiBvZiB0aGUgb3JpZ2luIGJvdC4KICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MucG9pbnRhYmxlID0gZmFsc2U7CiAgICAgICAgb3Muc2xlZXAoMjUwKS50aGVuKCgpID0+IHsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLnBvaW50YWJsZSA9IG51bGw7CiAgICAgICAgfSkKCiAgICAgICAgdGhpc0JvdC5vcmlnaW5DbGVhclNlbGVjdGlvbigpOwoKICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtQ3JlYXRlJyk7CiAgICB9KSwKICAgIHNldEFybVZpc2libGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsZXQgdmlzaWJsZSA9IHRoYXQ7CgogICAgICAgIGlmICh2aXNpYmxlKSB7CiAgICAgICAgICAgIG1hc2tzLnN0cm9rZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgbWFza3MubGluZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgbWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LmlkOyAKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYXNrcy5zdHJva2VDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIG1hc2tzLmxpbmVDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIG1hc2tzLmxpbmVUbyA9IGZhbHNlOwogICAgICAgICAgICBtYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCB7IGRpbWVuc2lvbiB9ID0gdGhhdDsKCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdD8udGFncy5hcm1UZWxlcG9ydCA/PyB0cnVlKSB7CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC50YWdzW2RpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWCddID0gdGFnc1tkaW1lbnNpb24gKyAnWCddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWSddID0gdGFnc1tkaW1lbnNpb24gKyAnWSddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWiddID0gdGFnc1tkaW1lbnNpb24gKyAnWiddOwogICAgICAgIH0KCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybUNsaWNrJywgeyBkaW1lbnNpb24gfSk7CgogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICB9KSwKICAgIG9uRHJvcEVudGVyOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuZHJhZ0JvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwogICAgICAgIGlmICghbGlua3Mub3JpZ2luQm90KSByZXR1cm47CgogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CgogICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIGxldCBsaW5lVG9Cb3RzID0gbGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbzsKCiAgICAgICAgICAgIGlmIChsaW5lVG9Cb3RzID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKGRyb3BCb3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGluZVRvQm90cyA9IEFycmF5LmlzQXJyYXkobGluZVRvQm90cykgPyBsaW5lVG9Cb3RzIDogW2xpbmVUb0JvdHNdOwoKICAgICAgICAgICAgICAgIGlmICghbGluZVRvQm90cy5pbmNsdWRlcyhkcm9wQm90KSkgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKC4uLmxpbmVUb0JvdHMsIGRyb3BCb3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGhpZGUgYXJtYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBkcm9wQm90LmlkOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBzZWxlY3Rpb24gb24gb3JpZ2luIGJvdC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25Ecm9wRXhpdDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmRyYWdCb3QgIT09IHRoaXNCb3QpIHJldHVybjsKICAgICAgICBpZiAoIWxpbmtzLm9yaWdpbkJvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkcm9wQm90ID0gdGhhdC50by5ib3Q7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJvcEJvdDpgLCBkcm9wQm90KTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUodHJ1ZSk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IGFybWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgc2VsZWN0aW9uIG9uIG9yaWdpbiBib3QuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJvcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmJvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKICAgICAgICAKICAgICAgICBpZiAodGFncy5tdWx0aVNlbGVjdCAmJiBsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvKSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZShmYWxzZSk7CiAgICAgICAgICAgIHRoaXNCb3Qub3JpZ2luU2V0U2VsZWN0aW9uKGxpbmtzLm9yaWdpbkJvdC5saW5rcy5saW5lVG8pOwogICAgICAgIH0gZWxzZSBpZiAoZHJvcEJvdCkgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwogICAgICAgICAgICB0aGlzQm90Lm9yaWdpblNldFNlbGVjdGlvbihkcm9wQm90KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBEcm9wcGVkIG9uIGdyaWQuCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyb3BwZWQgb24gZ3JpZC5gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybVBsYWNlZCcsIHsgZGltZW5zaW9uOiB0aGF0LnRvLmRpbWVuc2lvbiwgeDogdGhhdC50by54LCB5OiB0aGF0LnRvLnksIHo6IHRoYXQudG8ueiB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICB9KSwKICAgIG9uR3JpZENsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC5vcmlnaW5DbGVhclNlbGVjdGlvbigpOwogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICB9KSwKICAgIG9yaWdpbkNsZWFyU2VsZWN0aW9uOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtU2VsZWN0ZWRCb3RzID0gbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbnVsbDsKICAgIH0pLAogICAgb3JpZ2luU2V0U2VsZWN0aW9uOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VsZWN0ZWRCb3RzID0gdGhhdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybVNlbGVjdGVkQm90cyA9IHNlbGVjdGVkQm90cyA/IGdldExpbmsoc2VsZWN0ZWRCb3RzKSA6IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGxpbmtzLm9yaWdpbkJvdC50YWdzLmFybVNlbGVjdGVkQm90czsKICAgICAgICAKICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cykgewogICAgICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtU2VsZWN0ZWRCb3RzJywgbGlua3Mub3JpZ2luQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cykKICAgICAgICB9CiAgICB9KSwKICAgIG9uQW55Qm90c1JlbW92ZWQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybVNlbGVjdGVkQm90cykgewogICAgICAgICAgICAvLyBDaGVjayB0aGF0IHdlIHN0aWxsIGhhdmUgc29tZSBhY3RpdmUgc2VsZWN0ZWQgYm90cy4KICAgICAgICAgICAgbGV0IGFjdGl2ZVNlbGVjdGVkQm90cyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgYXJtU2VsZWN0ZWRCb3RzID0gbGlua3Mub3JpZ2luQm90LmxpbmtzLmFybVNlbGVjdGVkQm90czsKCiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFybVNlbGVjdGVkQm90cykpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVNlbGVjdGVkQm90cyA9IGFybVNlbGVjdGVkQm90cy5ldmVyeShiID0+ICEhYik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhY3RpdmVTZWxlY3RlZEJvdHMgPSAhIWFybVNlbGVjdGVkQm90czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVTZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBib3RzIHdlIGhhZCBzZWxlY3RlZCBubyBsb25nZXIgZXhpc3QsIGRlc3Ryb3kgdGhpcyBhcm0uCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyB0aGF0IGFybSBoYXMgc2VsZWN0ZWQgbm8gbG9uZ2VyIGV4aXN0LCBkZXN0cm95IHRoaXMgYXJtLmApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXNCb3Qub3JpZ2luQ2xlYXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyB0aGF0IGFybSBoYXMgc2VsZWN0ZWQgc3RpbGwgaGFzIGFjdGl2ZSBib3RzLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkRlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuZHJhZ2dhYmxlID0gbnVsbDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybURlc3Ryb3knKTsKICAgIH0pLAp9OwoKY29uc3QgYXJtQm90ID0gY3JlYXRlKGFybSk7CgpyZXR1cm4gYXJtQm90OycAmO3VtgHjARBvbkFueUJvdERyYWdnaW5nAgQAmO3VtgHoS9EVQGNvbnN0IGRyYWdCb3QgPSB0aGF0LmJvdDsKY29uc3QgZGltZW5zaW9uID0gdGhhdC5mcm9tLmRpbWVuc2lvbjsKCmlmIChkcmFnQm90LmxpbmtzLmFybUJvdCkgewogICAgaWYgKGRyYWdCb3QudGFncy5hcm1Hcm91cERyYWcgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICBsZXQgZHJhZ0Nvb3JkaW5hdG9yQm90ID0gbGlua3MuZHJhZ0Nvb3JkaW5hdG9yQm90OwogICAgICAgIAogICAgICAgIGlmICghZHJhZ0Nvb3JkaW5hdG9yQm90KSB7CiAgICAgICAgICAgIGNvbnN0IGRyYWdDb29yZGluYXRvck1vZCA9IHsKICAgICAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICAgICAgICAgICAgICBkaW1lbnNpb246IGRpbWVuc2lvbiwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJYIl06IDAsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIlkiXTogMCwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWiJdOiAtMSwKICAgICAgICAgICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZWJ1ZzogdGFncy5kZWJ1ZywKICAgICAgICAgICAgICAgIGNvbG9yOiAiY2xlYXIiLAogICAgICAgICAgICAgICAgc3lzdGVtOiBgYXJtR3JvdXBEcmFnLiR7dGhpc0JvdC5pZC5zdWJzdHJpbmcoMCwgNSl9LmNvb3JkaW5hdG9yYCwKICAgICAgICAgICAgICAgIG9uQW55Qm90UG9pbnRlclVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIGRyYWcgY29vcmRpbmF0b3JgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3MuZHJhZ0Nvb3JkaW5hdG9yQm90ID0gbnVsbDsgCiAgICAgICAgICAgICAgICAgICAgc2hvdXQoJ29uQXJtU3RvcEdyb3VwRHJhZycsIHsgeDogdGFnc1t0YWdzLmRpbWVuc2lvbiArICdYJ10sIHk6IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAnWSddIH0pOwogICAgICAgICAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGRyYWdDb29yZGluYXRvckJvdCA9IGNyZWF0ZShkcmFnQ29vcmRpbmF0b3JNb2QpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3JlYXRlZCBkcmFnIGNvb3JkaW5hdG9yIGJvdDpgLCBkcmFnQ29vcmRpbmF0b3JCb3QpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5kcmFnQ29vcmRpbmF0b3JCb3QgPSBnZXRMaW5rKGRyYWdDb29yZGluYXRvckJvdCk7CgogICAgICAgICAgICBjb25zdCBhcm1TZWxlY3RlZEJvdHMgPSBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90czsKICAgICAgICAgICAgY29uc3Qgb25Bcm1TdG9wR3JvdXBEcmFnID0gYEAKICAgICAgICAgICAgICAgIG1hc2tzLnRyYW5zZm9ybWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIG1hc2tzLm9uQXJtU3RvcEdyb3VwRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgICB0YWdzLiR7ZGltZW5zaW9ufVggPSB0YWdzLiR7ZGltZW5zaW9ufVggKyB0aGF0Lng7CiAgICAgICAgICAgICAgICB0YWdzLiR7ZGltZW5zaW9ufVkgPSB0YWdzLiR7ZGltZW5zaW9ufVkgKyB0aGF0Lnk7CiAgICAgICAgICAgIGAKCiAgICAgICAgICAgIGRyYWdCb3QubWFza3MudHJhbnNmb3JtZXIgPSBkcmFnQ29vcmRpbmF0b3JCb3QuaWQ7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3Mub25Bcm1TdG9wR3JvdXBEcmFnID0gb25Bcm1TdG9wR3JvdXBEcmFnOwoKICAgICAgICAgICAgc2V0VGFnTWFzayhhcm1TZWxlY3RlZEJvdHMsICJ0cmFuc2Zvcm1lciIsIGRyYWdDb29yZGluYXRvckJvdC5pZCwgInRlbXBMb2NhbCIpOwogICAgICAgICAgICBzZXRUYWdNYXNrKGFybVNlbGVjdGVkQm90cywgIm9uQXJtU3RvcEdyb3VwRHJhZyIsIG9uQXJtU3RvcEdyb3VwRHJhZywgInRlbXBMb2NhbCIpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgeENoYW5nZSA9IHRoYXQudG8ueCAtIHRoYXQuZnJvbS54OwogICAgICAgIGNvbnN0IHlDaGFuZ2UgPSB0aGF0LnRvLnkgLSB0aGF0LmZyb20ueTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB4Q2hhbmdlOiAke3hDaGFuZ2V9LCB5Q2hhbmdlOiAke3lDaGFuZ2V9YCk7CiAgICAgICAgfQoKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWCJdID0geENoYW5nZTsKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWSJdID0geUNoYW5nZTsKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWiJdID0gLTE7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJhZyBib3Qgd2l0aCBhcm0gZG9lcyBub3QgcXVhbGlmeSBmb3IgZ3JvdXAgZHJhZ2dpbmcuYCk7CiAgICAgICAgfQogICAgfQp9JwCY7dW2AeMBDWFiUGVyc29uYWxpdHkCBACY7dW2AbphBHRydWUnAJjt1bYB4wEIYWJJZ25vcmUCBACY7dW2Ab9hBHRydWUnAJjt1bYB4wEEZm9ybQIEAJjt1bYBxGEHbm90aGluZycAmO3VtgHjAQlhYlZlcnNpb24CBACY7dW2AcxhBTEwLjM1JwEEYm90cyRiMjZlMTA4OS0xNzJkLTQ1YTktOGQyMi0wNWMzZjU4YzJiZjcBJwCY7dW2AdJhBnN5c3RlbQIEAJjt1bYB02EYYWIucGVyc29uYWxpdHkuYW5pbWF0aW9uJwCY7dW2AdJhBGZvcm0CBACY7dW2AexhB25vdGhpbmcnAJjt1bYB0mEIYWJJZ25vcmUCBACY7dW2AfRhBHRydWUnAJjt1bYB0mENbWFuaWZlc3RhdGlvbgIEAJjt1bYB+WEo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAmO3VtgHSYQhyZW1lbWJlcgIEAJjt1bYBoGIo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAmO3VtgHSYRhhbmltYXRpb25fYWJHcmlkTWFuaWZlc3QCBACY7dW2Acdi+g5Ac2hvdXQoInJlc2V0Iik7Cgpjb25zdCBwb3NpdGlvblggPSB0aGF0Py5wb3NpdGlvbi54ID8/IDA7CmNvbnN0IHBvc2l0aW9uWSA9IHRoYXQ/LnBvc2l0aW9uLnkgPz8gMDsKY29uc3QgZGltZW5zaW9uID0gdGhhdD8uZGltZW5zaW9uID8/ICJob21lIjsKY29uc3QgZ3JpZFNjYWxlID0gdGhhdD8uc2NhbGUgPz8gNTsKY29uc3QgbW9tZW50Q291bnQgPSAwOwpjb25zdCBncmlkQm90ID0ge307CgpncmlkQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CmdyaWRCb3QuY29sb3IgPSAiY2xlYXIiOwpncmlkQm90LnN0cm9rZUNvbG9yID0gYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwpncmlkQm90LnNjYWxlID0gMC4wMDE7CmdyaWRCb3Quc2NhbGVaID0gMC4xOwpncmlkQm90LnJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwpncmlkQm90W2RpbWVuc2lvbl0gPSB0cnVlOwpncmlkQm90LnBvaW50YWJsZSA9IGZhbHNlOwpncmlkQm90LmtpbGxUaW1lciA9ICJAIGF3YWl0IG9zLnNsZWVwKDQwMCk7IGRlc3Ryb3kodGhpc0JvdCk7IjsKCmxldCByb3VuZEJvdHM7Cgpmb3IgKGxldCBpID0gZ3JpZFNjYWxlOyBpID4gMDsgaS0tKQp7CiAgICBjb25zdCBib3RDb3VudCA9IGkgKiA4OwoKICAgIGxldCBzaWRlQ291bnQgPSAwOwogICAgbGV0IHBoYXNlRmFjdG9yID0gMDsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJvdENvdW50OyBqKyspCiAgICB7CiAgICAgICAgaWYgKHBoYXNlRmFjdG9yID09IDApCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpICsgc2lkZUNvdW50OwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSBpICsgcG9zaXRpb25ZOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwaGFzZUZhY3RvciA9PSAxKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gaSArIHBvc2l0aW9uWDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKGkgKyBwb3NpdGlvblkpIC0gc2lkZUNvdW50OyAgCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHBoYXNlRmFjdG9yID09IDIpCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoaSArIHBvc2l0aW9uWCkgLSBzaWRlQ291bnQ7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9ICgoaSArIHBvc2l0aW9uWSkgKiAtMSkgOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpIDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKChpICsgcG9zaXRpb25ZKSAqIC0xKSArIHNpZGVDb3VudDsgIAogICAgICAgIH0KCiAgICAgICAgY29uc3QgbmV3R3JpZEJvdCA9IGF3YWl0IGNyZWF0ZShncmlkQm90KTsKCiAgICAgICAgYW5pbWF0ZVRhZyhuZXdHcmlkQm90LCAic2NhbGUiLCB7CiAgICAgICAgICAgIHRvVmFsdWU6IDEsCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogImVsYXN0aWMiLAogICAgICAgICAgICAgICAgbW9kZTogIm91dCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDAuMDEKICAgICAgICB9KS5jYXRjaCgoKSA9PiB7fSk7CgogICAgICAgIG5ld0dyaWRCb3Qua2lsbFRpbWVyKCk7CgogICAgICAgIHNpZGVDb3VudCsrOwoKICAgICAgICBpZiAoc2lkZUNvdW50ID09IGJvdENvdW50IC8gNCkKICAgICAgICB7CiAgICAgICAgICAgIHNpZGVDb3VudCA9IDA7CgogICAgICAgICAgICBwaGFzZUZhY3RvcisrOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoOCk7CiAgICB9Cn0nAJjt1bYB0mEJYWJWZXJzaW9uAgQAmO3VtgHCcQUxMC4zNScAmO3VtgHSYQZvbkNoYXQCBACY7dW2AchxVUAvLyBpZiAodGhhdC5tZXNzYWdlID09ICJAdGVzdCIpCi8vIHsKLy8gICAgIHRoaXNCb3QuYW5pbWF0aW9uX2FiR3JpZE1hbmlmZXN0KCk7Ci8vIH0nAJjt1bYB0mELcGVyc29uYWxpdHkCBACY7dW2AZ5yKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAJjt1bYB0mENYWJQZXJzb25hbGl0eQIEAJjt1bYBxXIEdHJ1ZScBBGJvdHMkYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiAScAmO3VtgHKcgZzeXN0ZW0CBACY7dW2ActyFWFiLnBlcnNvbmFsaXR5LmNvbmZpZycAmO3VtgHKcghhYklnbm9yZQIEAJjt1bYB4XIEdHJ1ZScAmO3VtgHKcgRmb3JtAgQAmO3VtgHmcgdub3RoaW5nJwCY7dW2AcpyC2FiQmFzZUNvbG9yAgQAmO3VtgHucgcjMDBEOUNEJwCY7dW2AcpyEWFiQmFzZVN0cm9rZUNvbG9yAgQAmO3VtgH2cgcjMDBEOUNEJwCY7dW2AcpyEGFiQmx1ZXByaW50Q29sb3ICBACY7dW2Af5yByMwMDgyN0InAJjt1bYBynIIcmVtZW1iZXICBACY7dW2AYZzKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJjt1bYBynIRYWJCdWlsZGVySWRlbnRpdHkCBACY7dW2Aa1zCmNhc3VhbC5ib3QnAJjt1bYBynIJYWJWZXJzaW9uAgQAmO3VtgG4cwUxMC4zNScAmO3VtgHKchdjaGFuZ2VQZXJzb25hbGl0eUNvbmZpZwIEAJjt1bYBvnPyE0BpZiAoIXRoYXQpIHsNCiAgICByZXR1cm47DQp9DQoNCmlmICghYXV0aEJvdCkgew0KICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7DQp9DQoNCmlmICghYXV0aEJvdCkgew0KICAgIHJldHVybjsNCn0NCg0KYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGF1dGhCb3QuaWQpOw0KDQpsZXQgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhYlBlcnNvbmFsaXR5Q29uZmlnIik7DQoNCmlmIChhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5zdWNjZXNzID09IGZhbHNlKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSB7fTsNCn0gZWxzZSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5kYXRhOw0KfQ0KDQppZiAodGhhdC5uYW1lKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQnVpbGRlcklkZW50aXR5Il0gPSB0aGF0Lm5hbWU7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCdWlsZGVySWRlbnRpdHkiLCB0aGF0Lm5hbWUsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5jb2xvcikgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VDb2xvciJdID0gdGhhdC5jb2xvcjsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlU3Ryb2tlQ29sb3IiXSA9IHRoYXQuY29sb3I7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlQ29sb3IiLCB0aGF0LmNvbG9yLCAibG9jYWwiKTsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VTdHJva2VDb2xvciIsIHRoYXQuY29sb3IsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5wb3J0YWxDb2xvcikgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VHcmlkUG9ydGFsQ29sb3IiXSA9IHRoYXQucG9ydGFsQ29sb3I7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlR3JpZFBvcnRhbENvbG9yIiwgdGhhdC5wb3J0YWxDb2xvciwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0Lm1lbnVDb2xvcikgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VNZW51Q29sb3IiXSA9IHRoYXQubWVudUNvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZU1lbnVDb2xvciIsIHRoYXQubWVudUNvbG9yLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQubWVudUxhYmVsQ29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlTGFiZWxDb2xvciJdID0gdGhhdC5tZW51TGFiZWxDb2xvcjsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VMYWJlbENvbG9yIiwgdGhhdC5tZW51TGFiZWxDb2xvciwgImxvY2FsIik7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQmFzZVNoYWRvd0NvbG9yIl0gPSB0aGF0Lm1lbnVMYWJlbENvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZVNoYWRvd0NvbG9yIiwgdGhhdC5tZW51TGFiZWxDb2xvciwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0LmZvcm0pIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJGb3JtIl0gPSB0aGF0LmZvcm07DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJGb3JtIiwgdGhhdC5mb3JtLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQuYWlNb2RlbCkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYlByZWZlcnJlZEFJTW9kZWwiXSA9IHRoYXQuYWlNb2RlbDsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYlByZWZlcnJlZEFJTW9kZWwiLCB0aGF0LmFpTW9kZWwsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5kZWZhdWx0UGVyc29uYWxpdHkpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSA9IHt9Ow0KICAgIHRoaXNCb3QudXBkYXRlUGVyc29uYWxpdHkoe30pOw0KfQ0KDQppZiAodGhhdC5tYXBCYXNlbWFwKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiTWFwUG9ydGFsQmFzZSJdID0gdGhhdC5tYXBCYXNlbWFwOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiTWFwUG9ydGFsQmFzZSIsIHRoYXQubWFwQmFzZW1hcCwgImxvY2FsIik7DQp9DQoNCmNvbnN0IHJlc3VsdCA9IGF3YWl0IG9zLnJlY29yZERhdGEoYXV0aEJvdC5pZCwgImFiUGVyc29uYWxpdHlDb25maWciLCBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSk7DQoNCmlmIChyZXN1bHQuc3VjY2Vzcykgew0KICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYHVwZGF0ZWQgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkYCwgbG9nVHlwZTogJ2xvZyd9KTsNCn0gZWxzZSB7DQogICAgYWIubGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmFpbGVkIHRvIHVwZGF0ZSBwZXJzb25hbGl0eSBjb25maWcgaW4gdXNlciByZWNvcmQuXG4ke0pTT04uc3RyaW5naWZ5KHJlc3VsdCwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnZXJyb3InfSk7DQp9DQoNCnNob3V0KCdvbkFCUGVyc29uYWxpdHlDaGFuZ2VkJywgeyBib3Q6IHRoaXNCb3QgfSk7JwCY7dW2AcpyD2FiQmFzZU1lbnVDb2xvcgIEAJjt1bYBsYcBByMwMEQ5Q0QnAJjt1bYBynIRdXBkYXRlUGVyc29uYWxpdHkCBACY7dW2AbmHAZYXQGlmICh0YWdzLmRlYnVnKSB7DQogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGUgc3RhcnRgKTsNCn0NCg0KaWYgKHRoaXNCb3QudmFycy51cGRhdGluZ1BlcnNvbmFsaXR5KSB7DQogICAgcmV0dXJuOw0KfQ0KDQp0aGlzQm90LnZhcnMudXBkYXRpbmdQZXJzb25hbGl0eSA9IHRydWU7DQoNCmxldCBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YTsNCg0KaWYgKHRoYXQgJiYgdGhhdCA9PSB7fSkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0ge307DQp9IGVsc2Ugew0KICAgIGlmICghYXV0aEJvdCkgew0KICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOw0KICAgIH0NCg0KICAgIGlmIChhdXRoQm90KSB7DQogICAgICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWJQZXJzb25hbGl0eUNvbmZpZyIpOw0KICAgICAgICBpZiAoIWxpbmtzLnJlbWVtYmVyICYmIGFiUGVyc29uYWxpdHlDb25maWdEYXRhLnN1Y2Nlc3MgPT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy51cGRhdGluZ1BlcnNvbmFsaXR5ID0gZmFsc2U7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuc3VjY2Vzcykgew0KICAgICAgICAgICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5kYXRhOw0KICAgICAgICB9DQogICAgfQ0KfQ0KDQppZiAodGFncy5kZWJ1Zykgew0KICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGE6YCwgey4uLmFiUGVyc29uYWxpdHlDb25maWdEYXRhfSk7DQp9DQoNCi8vYWJCbHVlUHJpbnRDb2xvcg0KLy9hYkJhc2VBY2NlbnRDb2xvcg0KY29uc3QgYWJUYWdzID0gWw0KICAgICJhYkJhc2VDb2xvciIsDQogICAgImFiQmFzZU1lbnVDb2xvciIsDQogICAgImFiQnVpbGRlcklkZW50aXR5IiwNCiAgICAiYWJCYXNlU3Ryb2tlQ29sb3IiLA0KICAgICJhYkJhc2VHcmlkUG9ydGFsQ29sb3IiLA0KICAgICJhYkJhc2VMYWJlbENvbG9yIiwNCiAgICAiYWJCYXNlU2hhZG93Q29sb3IiLA0KICAgICJhYlByZWZlcnJlZEFJTW9kZWwiLA0KICAgICJhYkNhdGFsb2dOYW1lIiwNCiAgICAiYWJNYXBQb3J0YWxCYXNlIg0KXTsNCg0KY2xlYXJUYWdNYXNrcyh0aGlzQm90KTsNCg0KLy8gUnlhbiAoQXVnIDI5LCAyMDI1KTogaW0gbm90IHN1cmUgZXhhY3RseSB3aGF0IGlzIGhhcHBlbmluZyBoZXJlIGJ1dCB3aXRob3V0IHNsZWVwaW5nIG9uIHRoZXNlIGJpZyB0YWcgbWFzayBjaGFuZ2VzLCB0aGV5IGRvbnQgYWxsIHNlZW0gdG8gY29tZSBpbiBwcm9wZXJseS4NCmF3YWl0IG9zLnNsZWVwKDEwMCk7DQoNCmZvciAobGV0IGkgPSAwOyBpIDwgYWJUYWdzLmxlbmd0aDsgKytpKSB7DQogICAgaWYgKGFiUGVyc29uYWxpdHlDb25maWdEYXRhICYmIGFiUGVyc29uYWxpdHlDb25maWdEYXRhW2FiVGFnc1tpXV0pIHsNCiAgICAgICAgaWYgKHRhZ3NbYWJUYWdzW2ldXSAhPSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVthYlRhZ3NbaV1dKSB7DQogICAgICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2V0dGluZyAke2FiVGFnc1tpXX0gbG9jYWwgbWFzayBmcm9tIGFiUGVyc29uYWxpdHlDb25maWdEYXRhOiAke2FiUGVyc29uYWxpdHlDb25maWdEYXRhW2FiVGFnc1tpXV19YCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIGFiVGFnc1tpXSwgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbYWJUYWdzW2ldXSwgImxvY2FsIik7DQogICAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGxpbmtzLnJlbWVtYmVyICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3NbYWJUYWdzW2ldXSkgew0KICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFnc1thYlRhZ3NbaV1dICE9IHRhZ3NbYWJUYWdzW2ldXSkgew0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldHRpbmcgJHthYlRhZ3NbaV19IGxvY2FsIG1hc2sgZnJvbSBhYiByZW1lbWJlciBib3Q6YCwgbGlua3MucmVtZW1iZXIudGFnc1thYlRhZ3NbaV1dKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgYWJUYWdzW2ldLCBsaW5rcy5yZW1lbWJlci50YWdzW2FiVGFnc1tpXV0sICJsb2NhbCIpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKGFiVGFnc1tpXSA9PSAiYWJCYXNlR3JpZFBvcnRhbENvbG9yIikgew0KICAgICAgICBncmlkUG9ydGFsQm90LnRhZ3MucG9ydGFsQ29sb3IgPSB0YWdzLmFiQmFzZUdyaWRQb3J0YWxDb2xvcjsNCiAgICB9DQoNCiAgICBpZiAoYWJUYWdzW2ldID09ICJhYk1hcFBvcnRhbEJhc2UiKSB7DQogICAgICAgIG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLmFiTWFwUG9ydGFsQmFzZTsNCiAgICAgICAgbWluaU1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLmFiTWFwUG9ydGFsQmFzZTsNCiAgICB9DQp9DQoNCi8vIFJ5YW4gKEF1ZyAyOSwgMjAyNSk6IGltIG5vdCBzdXJlIGV4YWN0bHkgd2hhdCBpcyBoYXBwZW5pbmcgaGVyZSBidXQgd2l0aG91dCBzbGVlcGluZyBvbiB0aGVzZSBiaWcgdGFnIG1hc2sgY2hhbmdlcywgdGhleSBkb250IGFsbCBzZWVtIHRvIGNvbWUgaW4gcHJvcGVybHkuDQphd2FpdCBvcy5zbGVlcCgxMDApOw0KDQp0aGlzQm90LnZhcnMudXBkYXRpbmdQZXJzb25hbGl0eSA9IGZhbHNlOw0Kc2hvdXQoJ29uQUJQZXJzb25hbGl0eVVwZGF0ZWQnLCB7IGJvdDogdGhpc0JvdCB9KTsnAJjt1bYBynINYWJQZXJzb25hbGl0eQIEAJjt1bYB0J4BBHRydWUnAJjt1bYBynINb25Ta2lsbFVwZGF0ZQIEAJjt1bYB1Z4BHUB0aGlzQm90LnVwZGF0ZVBlcnNvbmFsaXR5KCk7JwCY7dW2AcpyEWFiQmFzZVNoYWRvd0NvbG9yAgQAmO3VtgHzngEFYmxhY2snAJjt1bYBynIQYWJCYXNlTGFiZWxDb2xvcgIEAJjt1bYB+Z4BBWJsYWNrJwCY7dW2AcpyCm1hcE9wdGlvbnMCBACY7dW2Af+eAZ4H8J+nrFsNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzYXRlbGxpdGUiLA0KICAgICAgICAiaWQiOiAic2F0ZWxsaXRlIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiaHlicmlkIiwNCiAgICAgICAgImlkIjogImh5YnJpZCINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgIm9jZWFucyIsDQogICAgICAgICJpZCI6ICJvY2VhbnMiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJvcGVuIHN0cmVldCBtYXAiLA0KICAgICAgICAiaWQiOiAib3NtIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAidGVycmFpbiIsDQogICAgICAgICJpZCI6ICJ0ZXJyYWluIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiZGFyayBncmF5IGNhbnZhcyIsDQogICAgICAgICJpZCI6ICJkYXJrLWdyYXkiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJncmF5IGNhbnZhcyIsDQogICAgICAgICJpZCI6ICJncmF5Ig0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAoZGFyaykiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1uaWdodC12ZWN0b3IiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChuYXZpZ2F0aW9uKSIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzLW5hdmlnYXRpb24tdmVjdG9yIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAidG9wb2dyYXBoaWMiLA0KICAgICAgICAiaWQiOiAidG9wbyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKHJlbGllZikiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1yZWxpZWYtdmVjdG9yIg0KICAgIH0NCl0nAJjt1bYBynIUc2hvd0FCQmFzZW1hcE9wdGlvbnMCBACY7dW2AZymAcQFQHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQoNCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7DQpjb25maWdCb3QudGFncy5tZW51UG9ydGFsID0gJ2FiQmFzZW1hcE9wdGlvbnNNZW51JzsNCg0KZm9yIChjb25zdCBvcHRpb24gb2YgdGFncy5tYXBPcHRpb25zKSB7DQogICAgaWYgKG9wdGlvbi5pZCA9PSBtYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwKSB7DQogICAgICAgIGNvbnRpbnVlOw0KICAgIH0NCiAgICBjb25zdCBvcHRpb25PYmogPSANCiAgICB7DQogICAgICAgIGFiQmFzZW1hcE9wdGlvbnNNZW51OiB0cnVlLA0KICAgICAgICBjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51OiBgQGRlc3Ryb3kodGhpc0JvdCk7YCwNCiAgICAgICAgbWFwSUQ6IG9wdGlvbi5pZCwNCiAgICAgICAgbGFiZWw6IG9wdGlvbi5uYW1lLA0KICAgICAgICBvbkNsaWNrOiBgQA0KICAgICAgICAgICAgbWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCA9IHRhZ3MubWFwSUQ7DQogICAgICAgICAgICBzaG91dCgnY2hhbmdlUGVyc29uYWxpdHlDb25maWcnLCB7J21hcEJhc2VtYXAnOiB0YWdzLm1hcElEfSk7IA0KICAgICAgICAgICAgc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCiAgICAgICAgYA0KICAgIH0NCg0KICAgIGFiLmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG9wdGlvbk9iaik7DQp9JwCY7dW2AcpyC29uR3JpZENsaWNrAgQAmO3VtgHhqwEmQHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQonAJjt1bYBynIFZGVidWcCBACY7dW2AYisAQVmYWxzZScBBGJvdHMkYjliODI4MTktMWYxNC00MzkyLTg4YTktNTJmNjdhOWY4ZTU1AScAmO3VtgGOrAEGc3lzdGVtAgQAmO3VtgGPrAEYYWIucGVyc29uYWxpdHkuYXJtX251ZGdlJwCY7dW2AY6sAQ1vbkFCQXJtUGxhY2VkAgQAmO3VtgGorAE4QHNldFRhZ01hc2sodGhpc0JvdCwgJ2hhc0FybUJlZW5QbGFjZWQnLCB0cnVlLCAnbG9jYWwnKTsnAJjt1bYBjqwBCW9uQUJBd2FrZQIEAJjt1bYB4awBMEBhd2FpdCBvcy5zbGVlcCgyNTApOwp0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycAmO3VtgGOrAEIYWJJZ25vcmUCBACY7dW2AZKtAQR0cnVlJwCY7dW2AY6sAQ1hYlBlcnNvbmFsaXR5AgQAmO3VtgGXrQEEdHJ1ZScAmO3VtgGOrAEEZm9ybQIEAJjt1bYBnK0BB25vdGhpbmcnAJjt1bYBjqwBBWxlYXJuAgQAmO3VtgGkrQEo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAmO3VtgGOrAENbWFuaWZlc3RhdGlvbgIEAJjt1bYBy60BKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJjt1bYBjqwBCHJlbWVtYmVyAgQAmO3VtgHyrQEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAmO3VtgGOrAEFZGVidWcCBACY7dW2AZmuAQVmYWxzZScAmO3VtgGOrAEOYXJtTnVkZ2VXYWl0TVMCBACY7dW2AZ+uAQQ1MDAwJwCY7dW2AY6sAQ9vbkFCSW5pdGlhbGl6ZWQCBACY7dW2AaSuARtAdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnAJjt1bYBjqwBD2FiU3RhcnRBcm1OdWRnZQIEAJjt1bYBwK4Bgh9AaWYgKHRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoZXJlIGlzIGFscmVhZHkgYSBudWRnZSBpbiBwcm9ncmVzcy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlID0gdHJ1ZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXJ0aW5nIG51ZGdlLi4uYCkKfQoKZnVuY3Rpb24gY2FuTnVkZ2UoKTogYm9vbGVhbiB7CiAgICAvLyBDYW4ndCBoYXZlIHBsYWNlZCB0aGUgYXJtIGFscmVhZHkuCiAgICBpZiAodGFncy5oYXNBcm1CZWVuUGxhY2VkKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFybSBwbGFjZW1lbnQgaGFzIGFscmVhZHkgb2NjdXJlZC5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEFCIG1hbmlmZXN0YXRpb24gYm90IG11c3QgYmUgYWN0aXZlLgogICAgaWYgKCFsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFiIG1hbmlmZXN0YXRpb24gYm90IGlzIGluYWN0aXZlLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gQUIgY2hhdCBiYXIgbXVzdCBiZSBjbG9zZWQuCiAgICBpZiAobGlua3MuaW5wdXQubWFza3MuY2hhdE9wZW4pIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYWIgY2hhdCBiYXIgaXMgb3Blbi5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIFRoZSBpbnN0IG11c3QgYmUgZW1wdHkgb2YgYWxsIGJvdHMuIFRoZSBleGNlcHRpb25zIGFyZSBhYiBib3RzIGFuZCBidWlsdC1pbiBib3RzLgogICAgY29uc3QgdXNlck1hZGVCb3QgPSBnZXRCb3QoKGIpID0+IHsKICAgICAgICByZXR1cm4gIWIudGFncy5zeXN0ZW0/LnN0YXJ0c1dpdGgoJ2FiLicpICYmCiAgICAgICAgICAgICAgICBiLnNwYWNlID09PSAnc2hhcmVkJyAmJgogICAgICAgICAgICAgICAgIWIudGFncy5hYkVnZyAmJiAvLyBEb24ndCBpbmNsdWRlIGFiRWdnIGJvdHMgYXMgInVzZXIgbWFkZSIuCiAgICAgICAgICAgICAgICAhYi50YWdzLmFiTG9hZGVkU2tpbGwgJiYgLy8gRG9uJ3QgaW5jbHVkZSBsb2FkZWQgc2tpbGwgYm90cyBhcyAidXNlciBtYWRlIi4KICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJCb3QgLy8gRG9uJ3QgaW5jbHVkZSBhbnkgYm90cyB0aGF0IGFyZSBmbGFnZ2VkIHdpdGggYW4gYWJCb3QgdGFnLgogICAgfSkKICAgIAogICAgaWYgKHVzZXJNYWRlQm90KSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdVc2VyTWFkZUJvdHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJNYWRlQm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWIudGFncy5zeXN0ZW0/LnN0YXJ0c1dpdGgoJ2FiLicpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiLnNwYWNlID09PSAnc2hhcmVkJyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIWIudGFncy5hYkVnZyAvLyBEb24ndCBpbmNsdWRlIGFiRWdnIGJvdHMgYXMgInVzZXIgbWFkZSIuCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGluc3QgY29udGFpbnMgdXNlciBtYWRlIGJvdHMuYCwgdXNlck1hZGVCb3RzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBpbnN0IGNvbnRhaW5zIHVzZXIgbWFkZSBib3RzLmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBNZW51IHBvcnRhbCBtdXN0IGVpdGhlciBiZSBpbmFjdGl2ZSBvciBub3QgaGF2ZSBhbnkgYm90cyBpbiB0aGUgY3VycmVudGx5IGFjdGl2ZSBtZW51IHBvcnRhbC4KICAgIGlmIChjb25maWdCb3QudGFncy5tZW51UG9ydGFsKSB7CiAgICAgICAgY29uc3QgYm90SW5NZW51UG9ydGFsID0gZ2V0Qm90KChiKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBiLnRhZ3NbY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbF0gPT09IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGJvdEluTWVudVBvcnRhbCkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IG9wZW4gYW5kIGhhcyBib3RzIGluIGl0LmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn0KCmlmIChjYW5OdWRnZSgpKSB7CiAgICAvLyBTdGFydCBudWRnZSBmb3IgYXJtIHBsYWNlbWVudC4KICAgIGF3YWl0IG9zLnNsZWVwKHRhZ3MuYXJtTnVkZ2VXYWl0TVMpOwoKICAgIGlmIChjYW5OdWRnZSgpKSB7CiAgICAgICAgY29uc3QgYWJQb3NpdGlvblggPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LnRhZ3NbbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiArICdYJ107CiAgICAgICAgY29uc3QgYWJQb3NpdGlvblkgPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LnRhZ3NbbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiArICdZJ107CgogICAgICAgIGNvbnN0IGdyaWRDbGlja1BhcmFtcyA9IHsKICAgICAgICAgICAgZGltZW5zaW9uOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uLAogICAgICAgICAgICBwb3NpdGlvbjogeyB4OiBhYlBvc2l0aW9uWCArIDUsIHk6IGFiUG9zaXRpb25ZIH0sCiAgICAgICAgICAgIGZvcmNlQXJtUGxhY2VtZW50OiB0cnVlLAogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA9PT0gbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbikgewogICAgICAgICAgICAvLyBNYXAgcG9ydGFsIGlzIGluIGRpZmZlcmVudCBjb29yZGluYXRlIHNwYWNlIGFuZCBzY2FsZS4KICAgICAgICAgICAgZ3JpZENsaWNrUGFyYW1zLnBvc2l0aW9uLnggPSBhYlBvc2l0aW9uWCArIDAuMDAwMzU3NDM0MDY4NDA1MzgyMzsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2hpc3BlcmluZyBvbkdyaWRDbGljayB0byB0aGUgYWIgbWFuaWZlc3RhdGlvbiBib3Qgd2l0aCB0aGUgcGFyYW1zOmAsIGdyaWRDbGlja1BhcmFtcykKICAgICAgICB9CgogICAgICAgIC8vIEZvcmNlIGFiIGFybSBwbGFjZW1lbnQgdXNpbmcgdGhlIG9uR3JpZENsaWNrIGxpc3RlbmVyIG9mIHRoZSBtYW5pZmVzdGF0aW9uIGJvdC4KICAgICAgICB3aGlzcGVyKGxpbmtzLm1hbmlmZXN0YXRpb24sICdvbkdyaWRDbGljaycsIGdyaWRDbGlja1BhcmFtcyk7CiAgICB9Cn0KCnRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSA9IGZhbHNlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZG9uZWApOwp9JwCY7dW2AY6sARBvbkFCQ2hhdEJhckNsb3NlAgQAmO3VtgHDzQEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwCY7dW2AY6sAQVpbnB1dAIEAJjt1bYB380BKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAJjt1bYBjqwBCWFiVmVyc2lvbgIEAJjt1bYBhs4BBTEwLjM1JwCY7dW2AY6sAQ9vblBvcnRhbENoYW5nZWQCBACY7dW2AYzOAYUBQGNvbnN0IHsgcG9ydGFsLCBkaW1lbnNpb24gfSA9IHRoYXQ7CgppZiAocG9ydGFsID09PSAnbWVudVBvcnRhbCcpIHsKICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsKICAgIH0KfScAmO3VtgGOrAENYWJNZW51UmVmcmVzaAIEAJjt1bYBks8BG0B0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycAmO3VtgGOrAERZGVidWdVc2VyTWFkZUJvdHMCBACY7dW2Aa7PAQVmYWxzZScBBGJvdHMkZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkAScAmO3VtgG0zwEGc3lzdGVtAgQAmO3VtgG1zwEcYWIucGVyc29uYWxpdHkubWFuaWZlc3RhdGlvbicAmO3VtgG0zwEEZm9ybQIEAJjt1bYB0s8BB25vdGhpbmcnAJjt1bYBtM8BC2Rlc2NyaXB0aW9uAgQAmO3VtgHazwE4VGhpcyBza2lsbCBjb250cm9scyB0aGUgYWN0dWFsIGJvdCBmb3IgdGhlIGFiIGludGVyZmFjZS4nAJjt1bYBtM8BBWxlYXJuAgQAmO3VtgGT0AEo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAmO3VtgG0zwEPb25Qb3J0YWxDaGFuZ2VkAgQAmO3VtgG60AGzQEBjb25zdCBQT1JUQUxTX1RIQVRfSElERSA9IG5ldyBTZXQoWwogICAgInN5c3RlbVBvcnRhbCIsCiAgICAic2hlZXRQb3J0YWwiCl0pCgpjb25zdCBQT1JUQUxTX1RIQVRfTUFOSUZFU1QgPSBuZXcgU2V0KFsKICAgICJncmlkUG9ydGFsIiwKICAgICJtYXBQb3J0YWwiCl0pOwoKYXN5bmMgZnVuY3Rpb24gZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24ocG9ydGFsOiAnbWFwJyB8ICdncmlkJyk6IHsgeDogbnVtYmVyLCB5OiBudW1iZXIgfSB7CiAgICBpZiAocG9ydGFsID09PSAnZ3JpZCcpIHsKICAgICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH0KICAgIH0gZWxzZSBpZiAocG9ydGFsID09PSAnbWFwJykgewogICAgICAgIGlmICh0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnggPT09ICdudW1iZXInICYmICB0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgY3VycmVudFBvc2l0aW9uID0gdW5kZWZpbmVkOwogICAgICAgICAgICBsZXQgaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uID0gYXdhaXQgbGlua3MudXRpbHMuaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKCk7CgogICAgICAgICAgICAvLyBDdXJyZW50IHdvcmstYXJvdW5kIGZvciBhbGxvd2luZyBnZW9sb2NhdGlvbiBmb3IgaU9TIGFwcAogICAgICAgICAgICBpZiAoZ2V0Qm90KCJzeXN0ZW0iLCAiYWIuaW9zYnJpZGdlLm1lc3NlbmdlciIpKSB7CiAgICAgICAgICAgICAgICBoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24gPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnZW9sb2NhdGlvbiA9IGF3YWl0IG9zLmdldEdlb2xvY2F0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAoZ2VvbG9jYXRpb24uc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbiA9IHsgeDogZ2VvbG9jYXRpb24ubG9uZ2l0dWRlLCB5OiBnZW9sb2NhdGlvbi5sYXRpdHVkZSB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXJyZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50UG9zaXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHUlBNIFBvc2l0aW9uCiAgICAgICAgICAgICAgICByZXR1cm4geyB4OiAtODUuNjc2MTg5NDgyMjQzNCwgeTogNDIuOTY1Njc1Njc1Njc1NiB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdW5yZWNvbmdpemVkIHBvcnRhbCB0eXBlIHByb3ZpZGVkIHRvIGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uOmAsIHBvcnRhbCk7CiAgICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9CiAgICB9Cn0KCmNvbnN0IE1BUF9MT0FEX1dBSVRfVElNRSA9IDEwMDA7Cgpmb3IgKGNvbnN0IHBvcnRhbCBvZiBQT1JUQUxTX1RIQVRfSElERSkgewogICAgaWYgKGNvbmZpZ0JvdC50YWdzW3BvcnRhbF0gIT0gbnVsbCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYSBwb3J0YWwgdGhhdCBoaWRlcyBhYiBpcyBvcGVuIC0gaGlkaW5nIGFiQm90IGFuZCBpZ25vcmluZy5gKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmFiQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3MuYWJCb3QpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgppZiAoY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgIT0gbnVsbCB8fCBjb25maWdCb3QudGFncy5zeXN0ZW1Qb3J0YWwgIT0gbnVsbCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoZWV0IHBvcnRhbCBvciBzeXN0ZW0gcG9ydGFsIG9wZW5lZCAtIGhpZGluZyBhYkJvdCBhbmQgaWdub3JpbmcuYCk7CiAgICB9CgogICAgaWYgKHRhZ3MuYWJCb3QpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKICAgIH0KCiAgICByZXR1cm47Cn0KCmlmICghdGFncy5hYkF3YWtlKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWIgaXMgbm90IGF3YWtlIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAidGFnUG9ydGFsIikgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRhZ1BvcnRhbCBjaGFuZ2VkIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAibWVudVBvcnRhbCIpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtZW51UG9ydGFsIGNoYW5nZWQgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRoYXQucG9ydGFsID09ICJncmlkUG9ydGFsIiAmJiBjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBncmlkUG9ydGFsIGNoYW5nZWQsIGJ1dCBhbHNvIGFscmVhZHkgaW4gdGhlIG1hcFBvcnRhbCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBUaGUgbWFwIHBvcnRhbCBpcyB0b3VnaC4gSXQgc2VlbXMgdG8gdmFyeSBpbiBsb2FkaW5nIHNwZWVkIG9uCi8vIHZhcmlvdXMgaGFyZHdhcmUgYW5kIG5ldHdvcmtzIGFuZCBoYXMgYnkgdGhlIHRpbWUgb25Qb3J0YWxDaGFuZ2VkIGlzIGNhbGxlZCBpdCBkb2VzbnQKLy8gc2VlbSBndWFyZW50ZWVkIHRvIGJlIGFjdHVhbGx5IHJlYWR5LiBBZGRpbmcgYSBoYXJkY29kZWQgd2FpdCB0aW1lIHRvIGdpdmUgdGhlIHBvcnRhbCBzcGFjZSB0byBnZXQKLy8gdGhlIG1hcCBwb3J0YWwgZnVsbHkgbG9hZGVkIGJlZm9yZSBjb250aW51aW5nIHdpdGggbWFuaWZlc3RpbmcgYWIuCi8vCi8vIEF0IHNvbWUgcG9pbnQgdGhpcyBjYW4gZ28gYXdheSBpZiB3ZSBldmVyIGdldCBhIHNob3V0IG9yIHNvbWUgb3RoZXIgZ2F1cmVudGVlIHRoYXQgdGhlIG1hcCBwb3J0YWwgaXMgbG9hZGVkL3JlYWR5LgppZiAodGhhdC5wb3J0YWwgPT09ICdtYXBQb3J0YWwnKSB7CiAgICBpZiAodGhhdC5kaW1lbnNpb24pIHsKICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQpIHsKICAgICAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlcikgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBvcy5zbGVlcChNQVBfTE9BRF9XQUlUX1RJTUUpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdhaXRpbmcgZm9yIG1hcCBwb3J0YWwgdG8gZmluaXNoIGxvYWRpbmc6ICR7TUFQX0xPQURfV0FJVF9USU1FfW1zYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyOwogICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcCBwb3J0YWwgaXMgYWxyZWFkeSBsb2FkZWQuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSBmYWxzZTsKICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFwIHBvcnRhbCBoYXMgYmVlbiB1bmxvYWRlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIFN0YXJ0IGNoZWNrcyBmb3IgaWYvd2hlcmUgd2UgbmVlZCB0byBtYW5pZmVzdCBhYi4KbGV0IG5ld0FCID0gZmFsc2U7CmxldCBuZXdBQlBvcnRhbDsKbGV0IG5ld0FCUG9zaXRpb247CmxldCBmb2N1c0NhbWVyYSA9IHRydWU7CgppZiAoUE9SVEFMU19USEFUX01BTklGRVNULmhhcyh0aGF0LnBvcnRhbCkgJiYgdGhhdC5kaW1lbnNpb24pIHsKICAgIC8vIEEgcG9ydGFsIHRoYXQgbWFuaWZlc3RzIGFiIGhhcyBqdXN0IGNoYW5nZWQgZGltZW5zaW9uLgogICAgLy8gTWFuaWZlc3QgYWIgaW4gdGhlIG5ldyBkaW1lbnNpb24uCiAgICBpZiAodGhhdC5wb3J0YWwgPT0gIm1hcFBvcnRhbCIgfHwgdGhhdC5wb3J0YWwgPT0gIm1pbmlNYXBQb3J0YWwiKSB7OwogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFuaWZlc3RpbmcgYWIgYm90IGluIG1hcCBwb3J0YWwgZGltZW5zaW9uICcke3RoYXQuZGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ21hcCcpOwogICAgICAgIG5ld0FCUG9ydGFsID0gdGhhdC5wb3J0YWw7CiAgICAgICAgbmV3QUIgPSBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFuaWZlc3RpbmcgYWIgYm90IGRpbWVuc2lvbiAnJHt0aGF0LmRpbWVuc2lvbn0nLmApOwogICAgICAgIH0KCiAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdncmlkJyk7CiAgICAgICAgbmV3QUJQb3J0YWwgPSB0aGF0LnBvcnRhbDsKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwogICAgfQp9IGVsc2UgaWYgKChQT1JUQUxTX1RIQVRfTUFOSUZFU1QuaGFzKHRoYXQucG9ydGFsKSB8fCBQT1JUQUxTX1RIQVRfSElERS5oYXModGhhdC5wb3J0YWwpKSAmJiAKICAgICAgICAgICAhdGhhdC5kaW1lbnNpb24gJiYgCiAgICAgICAgICAgKGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwgfHwgY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKQopIHsKICAgIC8vIEEgcG9ydGFsIHRoYXQgdHlwaWNhbGx5IGhpZGVzIG9yIHJlLW1hbmlmZXN0cyBhYiBqdXN0IGNsb3NlZCwgYnV0IGVpdGhlciB0aGUgZ3JpZCBvciBtYXAgcG9ydGFsIGFyZSBzdGlsbCBvcGVuLgogICAgLy8gU3VtbW9uIGFiIGluIGVpdGhlciB0aGUgbWFwUG9ydGFsIG9yIGdyaWRQb3J0YWwuCiAgICBsZXQgc3VtbW9uRGltZW5zaW9uOwoKICAgIGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsKICAgICAgICBzdW1tb25EaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5tYXBQb3J0YWw7CiAgICAgICAgbmV3QUJQb3J0YWwgPSAnbWFwUG9ydGFsJzsKICAgICAgICAKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXSkgewogICAgICAgICAgICAvLyBVc2UgbGFzdCBrbm93biBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVXNlIGRlZmF1bHQgbWFwIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ21hcCcpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCkgewogICAgICAgIHN1bW1vbkRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CiAgICAgICAgbmV3QUJQb3J0YWwgPSAnZ3JpZFBvcnRhbCc7CgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddKSB7CiAgICAgICAgICAgIC8vIFVzZSBsYXN0IGtub3duIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gbGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVc2UgZGVmYXVsdCBncmlkIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ2dyaWQnKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHN1bW1vbkRpbWVuc2lvbikgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3VtbW9uaW5nIGFiIGJvdCBpbiAke25ld0FCUG9ydGFsfSBkaW1lbnNpb24gJyR7c3VtbW9uRGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogc3VtbW9uRGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKCiAgICAgICAgaWYgKFBPUlRBTFNfVEhBVF9ISURFLmhhcyh0aGF0LnBvcnRhbCkpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIHBvcnRhbCB0aGF0IGNsb3NlZCB3YXMgYSBwb3J0YWwgdGhhdCBoaWRlcyBhYiwgdGhlbiBkb250IHJ1biB0aGUgY2FtZXJhIGZvY3VzLgogICAgICAgICAgICAvLyBUaGlzIHdpbGwganVzdCB1c2UgdGhlIHByZXZpb3VzIGNhbWVyYSBwb3NpdGlvbiBhbHJlYWR5IHN0b3JlZCBpbiBtZW1vcnkuCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdpbGwgbm90IGZvY3VzIGNhbWVyYSBvbiBhYiBiZWNhdXNlIHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoZSBwcmV2aW91cyBjYW1lcmEgcG9zaXRpb24uYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9jdXNDYW1lcmEgPSBmYWxzZTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90aCB0aGUgbWFwIGFuZCBncmlkIHBvcnRhbCBhcmUgYm90aCBjbG9zZWQsIGNhbm5vdCBzdW1tb24gYWIgaW4gZWl0aGVyLmApOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIHJldHVybjsKfQoKaWYgKG5ld0FCICYmIGZvY3VzQ2FtZXJhKSB7CiAgICBsZXQgem9vbSA9IDEwOwoKICAgIGlmIChuZXdBQlBvcnRhbCA9PT0gJ21hcFBvcnRhbCcgfHwgbmV3QUJQb3J0YWwgPT09ICdtaW5pTWFwUG9ydGFsJykgewogICAgICAgIHpvb20gPSAyMDAwOwogICAgfQogICAgdHJ5IHsKICAgICAgICBhd2FpdCBvcy5mb2N1c09uKG5ld0FCUG9zaXRpb24sIHsgem9vbSwgcm90YXRpb246IHsgeDogNDUsIHk6IDQ1IH0sIHBvcnRhbDogbmV3QUJQb3J0YWwgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb2N1c09uIGVycm9yIG9jY3VyZWQ6YCwgZSk7CiAgICAgICAgfQogICAgfQp9JwCY7dW2AbTPAQhyZW1lbWJlcgIEAJjt1bYB7pACKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJjt1bYBtM8BDWFiTWFuaWZlc3RCb3QCBACY7dW2AZWRAss0QGNvbnN0IGRpbWVuc2lvbiA9IHRoYXQ/LmRpbWVuc2lvbjsKY29uc3QgcG9zaXRpb24gPSB0aGF0Py5wb3NpdGlvbjsKCmlmICh0aGlzQm90LnZhcnMuYWJCb3RMYXN0SWQpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIGFiQm90YCk7CiAgICB9CiAgICBkZXN0cm95KHRoaXNCb3QudmFycy5hYkJvdExhc3RJZCk7Cn0KCmNvbnN0IGFiTW9kID0gewogICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBmb3JtT3BhY2l0eTogJzAuMzMnLAogICAgZGltZW5zaW9uLAogICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICBbZGltZW5zaW9uICsgJ1gnXTogcG9zaXRpb24ueCwKICAgIFtkaW1lbnNpb24gKyAnWSddOiBwb3NpdGlvbi55LAogICAgc3Ryb2tlQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBzdHJva2VXaWR0aDogMSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIGxhYmVsOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsLAogICAgbGFiZWxQb3NpdGlvbjogJ2Zyb250JywKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNjEsCiAgICBkcmFnZ2FibGU6IGZhbHNlLAogICAgc2NhbGU6IDAuOSwKICAgIGFybVNlbGVjdGlvbjogdHJ1ZSwKICAgIGFybUdyb3VwRHJhZzogdHJ1ZSwKICAgIGFybVRlbGVwb3J0OiB0cnVlLAogICAgYXJtQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBwZXJzb25hbGl0eTogdGFncy5wZXJzb25hbGl0eSwKICAgIGZvcm1EZXB0aFRlc3Q6IGZhbHNlLAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIC8vIENyZWF0ZSB0aGUgY29yZSBjdWJlLgogICAgICAgIGNvbnN0IGNvcmVNb2QgPSB7CiAgICAgICAgICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgICAgICAgICAgYWJCb3Q6IGdldExpbmsodGhpc0JvdCksCiAgICAgICAgICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICBmb3JtT3BhY2l0eTogMC42NiwKICAgICAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgc2NhbGU6IDAuNzUsCiAgICAgICAgICAgIHRyYW5zZm9ybWVyOiB0aGlzQm90LmlkLAogICAgICAgICAgICBhbmNob3JQb2ludDogJ2NlbnRlcicsCiAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbl06IHRydWUsCiAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICdaJ106IC0wLjUKICAgICAgICB9CgogICAgICAgIG1hc2tzLmNvcmVCb3QgPSBnZXRMaW5rKGNyZWF0ZShjb3JlTW9kKSk7CgogICAgICAgIHRoaXNCb3QuYW5pbWF0ZUJvdCgpOwogICAgICAgIG1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5hbmltYXRlQm90KCksIDIwMDApOwogICAgfSksCiAgICBvbkNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09ICdyaWdodCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAobWFza3MuYXJtQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3MuYXJtQm90KTsKICAgICAgICAgICAgbWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljaygpOwogICAgfSksCiAgICBvblBvaW50ZXJFbnRlcjpMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScpIHsKICAgICAgICAgICAgdGFncy5tb3VzZU92ZXIgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyRXhpdDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VPdmVyID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvblBvaW50ZXJEb3duOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScgJiYgdGhhdC5idXR0b25JZCA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0QnV0dG9uRG93biA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvblBvaW50ZXJVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT09ICdsZWZ0JykgewogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24gPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnREcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25EcmFnOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRhZ3MubW91c2VMZWZ0QnV0dG9uRG93bikgewogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdERyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgb25LZXlEb3duOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQua2V5cy5pbmNsdWRlcygnU2hpZnQnKSkgewogICAgICAgICAgICB0YWdzLnNoaWZ0SGVsZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7ICAKICAgICAgICB9CiAgICB9KSwKICAgIG9uS2V5VXA6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5rZXlzLmluY2x1ZGVzKCdTaGlmdCcpKSB7CiAgICAgICAgICAgIHRhZ3Muc2hpZnRIZWxkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7ICAKICAgICAgICB9CiAgICB9KSwKICAgIHVwZGF0ZVBvcnRhbEN1cnNvcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxldCBjdXJzb3IgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5tb3VzZUxlZnREcmFnZ2luZykgewogICAgICAgICAgICBjdXJzb3IgPSAnZ3JhYmJpbmcnOyAgICAKICAgICAgICB9IGVsc2UgaWYgKHRhZ3MubW91c2VPdmVyKSB7CiAgICAgICAgICAgIGlmICh0YWdzLnNoaWZ0SGVsZCkgewogICAgICAgICAgICAgICAgY3Vyc29yID0gJ2NvbnRleHQtbWVudSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJzb3IgPSAncG9pbnRlcic7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsQ3Vyc29yID0gY3Vyc29yOwogICAgfSksCiAgICBhbmltYXRlQm90OiBMaXN0ZW5lclN0cmluZyhhc3luYyAoKSA9PiB7IAogICAgICAgIGlmIChjb25maWdCb3QudGFncy5hYk9wdGltaXplZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCByb3RaID0gdGFncy5kaW1lbnNpb24gKyAnUm90YXRpb25aJzsKICAgICAgICBsZXQgdGFyZ2V0U2NhbGUgPSAwLjY1OwoKICAgICAgICBhd2FpdCBhbmltYXRlVGFnKHRoaXNCb3QsCiAgICAgICAgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIFtyb3RaXTogMCwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgW3JvdFpdOiA2LjMsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogJ3NpbnVzb2lkYWwnLAogICAgICAgICAgICAgICAgbW9kZTogJ2lub3V0JwogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogMgogICAgICAgIH0pLmNhdGNoKGUgPT4ge30pOwogICAgfSksCiAgICBvbkFybUNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICghdGFncy5pbnRlcnZhbCkgewogICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyByZXNldDogdHJ1ZSB9KTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uQXJtUGxhY2VkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJHcmlkRm9jdXMgPSB7CiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIAogICAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICAgICAgeDogdGhhdC54LAogICAgICAgICAgICAgICAgeTogdGhhdC55CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdncmlkJyB9KTsKCiAgICAgICAgc2hvdXQoJ29uQUJBcm1QbGFjZWQnLCB0aGF0KTsKICAgIH0pLAogICAgb25Bcm1DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IHJlc2V0OiB0cnVlIH0pOwogICAgICAgIHNob3V0KCdvbkFCRm9vdENsaWNrZWQnLCB0aGF0KTsKICAgIH0pLAogICAgb25Bcm1TZWxlY3RlZEJvdHM6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCBzZWxlY3RlZEJvdHMgPSB0aGF0OwoKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZWxlY3RlZEJvdHMpKSB7CiAgICAgICAgICAgIC8vIE11bHRpcGxlIGJvdCBzZWxlY3Rpb24uCiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiTXVsdGlwbGVCb3RGb2N1cyA9IGdldExpbmsoc2VsZWN0ZWRCb3RzKTsKICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgbWVudTogJ211bHRpcGxlQm90JyB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTaW5nbGUgYm90IHNlbGVjdGlvbi4KICAgICAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJCb3RGb2N1cyA9ICLwn5SXIiArIHNlbGVjdGVkQm90cy5pZDsKCiAgICAgICAgICAgIGlmIChzZWxlY3RlZEJvdHMgPT09IHRoaXNCb3QpIHsKICAgICAgICAgICAgICAgIGFiLmxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdib3QnIH0pOwogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgc2hvdXQoJ29uQUJTZWxlY3RlZEJvdCcsIHNlbGVjdGVkQm90cyk7CiAgICB9KSwKICAgIG9uQXJtRGVzdHJveTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7CiAgICB9KSwKICAgIG9uRGVzdHJveTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNsZWFySW50ZXJ2YWwodGFncy5pbnRlcnZhbCk7CiAgICAgICAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsKICAgIH0pLAp9OwoKY29uc3QgYWJCb3QgPSBjcmVhdGUoYWJNb2QpOwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJTZWNvbmRhcnlMYWJlbCkgewogICAgY29uc3QgYWJMYWJlbEJvdCA9IHsKICAgICAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICAgICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICAgICAgW2RpbWVuc2lvbiArICdaJ106IC0xLAogICAgICAgIGNyZWF0b3I6IGFiQm90LmlkLAogICAgICAgIHRyYW5zZm9ybWVyOiBhYkJvdC5pZCwKICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgIGNvbG9yOiAnY2xlYXInLAogICAgICAgIGxhYmVsOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiU2Vjb25kYXJ5TGFiZWwsCiAgICAgICAgbGFiZWxQb3NpdGlvbjogJ2xlZnQnLAogICAgICAgIGxhYmVsU2l6ZTogMC43LAogICAgICAgIGxhYmVsQ29sb3I6IGFiQm90LnRhZ3MubGFiZWxDb2xvciwKICAgIH07CgogICAgY3JlYXRlKGFiTGFiZWxCb3QpOwp9CgptYXNrcy5hYkJvdCA9IGdldExpbmsoYWJCb3QpOwpsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkFjdGl2ZURpbWVuc2lvbiA9IGRpbWVuc2lvbjsKdGhpc0JvdC52YXJzLmFiQm90TGFzdElkID0gYWJCb3QuaWQ7IC8vIFN0b3JpbmcgaWQgYXMgYSB2YXIgcHJldmVudHMgZ2hvc3QgYWJCb3RzIGR1cmluZyBtdWx0aXBsZSBjYWxscyBpbiBvbmUgZnJhbWUuCgovLyBTdG9yZSB0aGUgbGFzdCBwb3NpdGlvbiBvZiBhYiBpbiB0aGlzIGRpbWVuc2lvbiBvbiB0aGUgcmVtZW1iZXIgYm90LgpsaW5rcy5yZW1lbWJlci5tYXNrc1tkaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXSA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KHsgeDogcG9zaXRpb24/LngsIHk6IHBvc2l0aW9uPy55IH0pOwoKYXdhaXQgb3Muc2xlZXAoMCk7IC8vIEdpdmUgQ2FzdWFsT1MgYSBjaGFuY2UgdG8gdXBkYXRlIHRhZyBtYXNrcy4KCnNob3V0KCdvbkFCTW92ZWQnLCB7IGRpbWVuc2lvbiwgeDogcG9zaXRpb24ueCwgeTogcG9zaXRpb24ueSB9KTsKCnJldHVybiBhYkJvdDsnAJjt1bYBtM8BC29uR3JpZENsaWNrAgQAmO3VtgHdxQKBD0BpZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgcmV0dXJuOwp9Cgpjb25zdCBzaGlmdENoZWNrID0gb3MuZ2V0SW5wdXRTdGF0ZSgia2V5Ym9hcmQiLCAiU2hpZnQiKTsKCmlmIChsaW5rcy5hYkJvdCAmJiAoc2hpZnRDaGVjayB8fCAodGhhdC5tb2RhbGl0eSA9PSAibW91c2UiICYmIHRoYXQuYnV0dG9uSWQgPT0gInJpZ2h0IiAmJiAhbGlua3MucmVtZW1iZXIudGFncy5hYlJpZ2h0Q2xpY2tEaXNhYmxlZCkgfHwgdGhhdC5mb3JjZUFybVBsYWNlbWVudCkpIHsKICAgIGNvbnN0IGFybUJvdCA9IGFiLmxpbmtzLmFybV90b29sLmFiQ3JlYXRlQXJtKHsKICAgICAgICBvcmlnaW5Cb3Q6IGxpbmtzLmFiQm90LAogICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICAgICAgcG9zaXRpb246IHRoYXQucG9zaXRpb24sCiAgICB9KQoKICAgIC8vIEZha2UgdXNlciBkcm9wcGluZyB0aGUgYXJtIG9uIHRoZSBncmlkIHNwYWNlLgogICAgYXJtQm90Lm9uRHJvcCh7CiAgICAgICAgYm90OiBhcm1Cb3QsCiAgICAgICAgdG86IHsKICAgICAgICAgICAgeDogdGhhdC5wb3NpdGlvbi54LAogICAgICAgICAgICB5OiB0aGF0LnBvc2l0aW9uLnksCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9LAogICAgICAgIGZyb206IHsKICAgICAgICAgICAgeDogdGhhdC5wb3NpdGlvbi54LAogICAgICAgICAgICB5OiB0aGF0LnBvc2l0aW9uLnksCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm47Cn0KCmNvbnN0IGZvb3RwcmludCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICBbdGhhdC5kaW1lbnNpb25dOiB0cnVlLAogICAgW3RoYXQuZGltZW5zaW9uICsgIlgiXTogdGhhdC5wb3NpdGlvbi54LAogICAgW3RoYXQuZGltZW5zaW9uICsgIlkiXTogdGhhdC5wb3NpdGlvbi55LAogICAgc2NhbGVaOiAwLjAxLAogICAgcG9zaXRpb25JbmZvOiB0aGF0LAogICAgY29sb3I6ICJjbGVhciIsCiAgICBwZXJzb25hbGl0eTogdGFncy5wZXJzb25hbGl0eSwKICAgIHN0cm9rZUNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgZHJhZ2dhYmxlOiBmYWxzZSwKICAgIGN1cnNvcjogJ2FsaWFzJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoYXN5bmMgKCkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZGVzdHJveSh0aGlzQm90KSwgODAwKTsKCiAgICAgICAgYXdhaXQgYW5pbWF0ZVRhZyh0aGlzQm90LCB7CiAgICAgICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICAgICAgc2NhbGVYOiAwLjEsCiAgICAgICAgICAgICAgICBzY2FsZVk6IDAuMQogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgICAgICBzY2FsZVg6IDEuMSwKICAgICAgICAgICAgICAgIHNjYWxlWTogMS4xCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAwLjUsCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogImVsYXN0aWMiLAogICAgICAgICAgICAgICAgbW9kZTogIm91dCIKICAgICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGUgPT4ge30pOwogICAgfSksCiAgICBvbkNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICBzaG91dCgib25BQkZvb3RDbGlja2VkIiwgeyBkaW1lbnNpb246IHRhZ3MuZGltZW5zaW9uIH0pOwogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJNYW5pZmVzdEJvdCh0YWdzLnBvc2l0aW9uSW5mbyk7CiAgICB9KSwKfTsKCgpjcmVhdGUoZm9vdHByaW50KTsnAJjt1bYBtM8BBG1lbnUCBACY7dW2Ad/UAijwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCY7dW2AbTPAQdhYkNsaWNrAgQAmO3VtgGG1QL4CkBpZiAoIWxpbmtzLmFiQm90KSB7CiAgICByZXR1cm47Cn0KCmlmIChsaW5rcy5pbnB1dCkgewogICAgbGlua3MuaW5wdXQuYWJDaGF0QmFyQ2xvc2UoKTsKfQoKY29uc3QgcmVzZXQgPSB0aGF0ID8gdGhhdC5yZXNldCA6IGZhbHNlOwpjb25zdCBtZW51ID0gdGhhdCA/IHRoYXQubWVudSA6ICJjb3JlIjsKY29uc3Qgc3RhdGUgPSBvcy5nZXRJbnB1dFN0YXRlKCJrZXlib2FyZCIsICJTaGlmdCIpOwoKaWYgKCFyZXNldCAmJiAobGlua3MuYWJCb3QudGFncy5pbnRlcnZhbCB8fCBzdGF0ZSkpIHsKICAgIGNvbnN0IGFiTWVudUJvdHMgPSBnZXRCb3RzKCJhYk1lbnUiLCB0cnVlKTsKCiAgICB3aGlzcGVyKGFiTWVudUJvdHMsICJhYk1lbnVSZWZyZXNoIik7CgogICAgY2xlYXJJbnRlcnZhbChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsKTsKCiAgICBsaW5rcy5hYkJvdC5tYXNrcy5pbnRlcnZhbCA9IG51bGw7CgogICAgY2xlYXJBbmltYXRpb25zKGxpbmtzLmFiQm90KTsKCiAgICBjb25zdCByb3RaID0gbGlua3MuYWJCb3QudGFncy5kaW1lbnNpb24gKyAiUm90YXRpb25aIjsKCiAgICBpZiAoc3RhdGUgJiYgbWVudSA9PSAiY29yZSIpIHsKICAgICAgICBsaW5rcy5tZW51LmFiRW52aXJvbm1lbnRNZW51KCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBsaW5rcy5tZW51LmFiT3Blbk1lbnUobWVudSk7CiAgICB9CgogICAgYW5pbWF0ZVRhZyhsaW5rcy5hYkJvdCwgewogICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICBbcm90Wl06IGxpbmtzLmFiQm90LnRhZ3Nbcm90Wl0sCiAgICAgICAgICAgIHNjYWxlOiBsaW5rcy5hYkJvdC50YWdzLnNjYWxlCiAgICAgICAgfSwKICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgIFtyb3RaXTogMCwKICAgICAgICAgICAgc2NhbGU6IDAuOQogICAgICAgIH0sCiAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgIHR5cGU6ICJzaW51c29pZGFsIiwKICAgICAgICAgICAgbW9kZTogImlub3V0IgogICAgICAgIH0sCiAgICAgICAgZHVyYXRpb246IDAuNQogICAgfSkuY2F0Y2goZSA9PiB7fSkKfQplbHNlIHsKICAgIGxpbmtzLmFiQm90LmFuaW1hdGVCb3QoKTsKCiAgICBsaW5rcy5hYkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwoKICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgY2xlYXJJbnRlcnZhbChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsKTsKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gbGlua3MuYWJCb3QuYW5pbWF0ZUJvdCgpLCAyMDAwKTsKfQoKc2hvdXQoJ29uQUJDbGljaycsIHsgYWJCb3Q6IGxpbmtzLmFiQm90LCBkaW1lbnNpb246IGxpbmtzLmFiQm90LnRhZ3MuZGltZW5zaW9uLCBtZW51LCBzaGlmdEtleTogISFzdGF0ZSwgcmVzZXQgfSk7JwCY7dW2AbTPAQhhYklnbm9yZQIEAJjt1bYB/98CBHRydWUnAJjt1bYBtM8BA2FzawIEAJjt1bYBhOACKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAJjt1bYBtM8BCWFza0J1dHRvbgIEAJjt1bYBq+ACyAVAaWYgKCF0YWdzLmFiQXdha2UpCnsKICAgIHJldHVybjsKfQoKbGV0IGFiTWVudUJ1dHRvbiA9IHt9OwoKYWJNZW51QnV0dG9uLmFiTWVudSA9IHRydWU7CmFiTWVudUJ1dHRvbi5yZW1lbWJlciA9IGxpbmtzLm1lbnUudGFncy5yZW1lbWJlcjsKYWJNZW51QnV0dG9uLm1hbmlmZXN0YXRpb24gPSBsaW5rcy5tZW51LnRhZ3MubWFuaWZlc3RhdGlvbjsKYWJNZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CmFiTWVudUJ1dHRvbi5iYXNlU2tpbGwgPSAi8J+UlyIgKyBsaW5rcy5hc2suaWQ7CmFiTWVudUJ1dHRvbi5sYWJlbCA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVMYWJlbDsKYWJNZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUljb247CmFiTWVudUJ1dHRvbi5vbkNyZWF0ZSA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVPbkdlbmVyYXRlOwphYk1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudVNvcnRPcmRlcjsKYWJNZW51QnV0dG9uLmNvbG9yID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUNvbG9yID8gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUNvbG9yIDogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGFiTWVudUJ1dHRvbik7JwCY7dW2AbTPAQlhYkJvdENoYXQCBACY7dW2AfLlAu4IQGlmICghbGlua3MuYWJCb3QgJiYgIXRoYXQuYm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGJvdEJhc2UgPSB0aGF0LmJvdCA/IHRoYXQuYm90OiBsaW5rcy5hYkJvdDsKY29uc3QgZGltZW5zaW9uID0gIXRoYXQuYm90ID8gYm90QmFzZS50YWdzLmRpbWVuc2lvbiA6IHRoYXQuZGltZW5zaW9uID8gdGhhdC5kaW1lbnNpb24gOiBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwpjb25zdCBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwpjb25zdCBtZXNzYWdlVGltZSA9IHRoYXQudGltZSA/IHRoYXQudGltZSAqIDEwMDAgOiAxNjAwOyAKCmNvbnN0IG1lc3NhZ2VCb3QgPSBhd2FpdCBsaW5rcy5ib3RfZmFjdG9yeS5hYkNyZWF0ZUJpbGxib2FyZExhYmVsKHsKICAgIGJvdDogYm90QmFzZSwKICAgIGxhYmVsOiBtZXNzYWdlLAogICAgZGltZW5zaW9uLAogICAgbWVzc2FnZVRpbWUsCiAgICBjb2xvcjogIiMwMDAwMDAiLAogICAgbGFiZWxDb2xvcjogIiNmZmZmZmYiLAogICAgb25Cb3RBZGRlZDogYEAKICAgICAgICBhd2FpdCBvcy5zbGVlcCh0YWdzLm1lc3NhZ2VUaW1lKTsKICAgICAgICB0aGlzQm90Lm9uRmFkZSgpOwogICAgYCwKICAgIG9uRmFkZTogYEAKICAgICAgICBhbmltYXRlVGFnKHRoaXNCb3QsIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBmb3JtT3BhY2l0eTogMSwKICAgICAgICAgICAgICAgIGxhYmVsT3BhY2l0eTogMSwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICJaIl06IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAiWiJdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAwLAogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAwLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgIloiXTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICJaIl0gKyA1CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAke3RoYXQuZHVyYXRpb24gPz8gM30KICAgICAgICB9KQogICAgICAgIC5jYXRjaCgoZSkgPT4ge30pCiAgICAgICAgLmZpbmFsbHkoKCkgPT4gewogICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgIH0pCgogICAgYCwKfSk7JwCY7dW2AbTPAQlhYlZlcnNpb24CBACY7dW2AeHuAgUxMC4zNScAmO3VtgG0zwEJYW5pbWF0aW9uAgQAmO3VtgHn7gIo8J+Ul2IyNmUxMDg5LTE3MmQtNDVhOS04ZDIyLTA1YzNmNThjMmJmNycAmO3VtgG0zwEPb25BbnlCb3RDbGlja2VkAgQAmO3VtgGO7wLpB0BpZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSaWdodENsaWNrRGlzYWJsZWQgJiYgIXRoYXQuYm90LnRhZ3MuYWJSaWdodENsaWNrSWdub3JlICYmIHRoYXQubW9kYWxpdHkgPT0gIm1vdXNlIiAmJiB0aGF0LmJ1dHRvbklkID09ICJyaWdodCIpIHsKICAgIGlmICghdGFncy5hYkF3YWtlKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGFiIHNlbGVjdGVkCiAgICBpZiAodGhhdC5ib3QgPT0gbGlua3MuYWJCb3QpIHsKICAgICAgICBsaW5rcy5tZW51LmFiRW52aXJvbm1lbnRNZW51KCk7CiAgICAgICAgcmV0dXJuOwogICAgfSAgICAKICAgIAogICAgY29uc3QgYXJtQm90ID0gYWIubGlua3MuYXJtX3Rvb2wuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogbGlua3MuYWJCb3QsCiAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgICAgICBwb3NpdGlvbjogdGhhdC5wb3NpdGlvbiwKICAgIH0pCgogICAgY29uc3QgYm90UG9zaXRpb24gPSBnZXRCb3RQb3NpdGlvbih0aGF0LmJvdCwgdGhhdC5kaW1lbnNpb24pOwoKICAgIC8vIEZha2UgdXNlciBkcm9wcGluZyB0aGUgc2VsZWN0aW5nIHRoZSBib3Qgd2l0aCB0aGUgYXJtLgogICAgYXJtQm90Lm9uRHJvcCh7CiAgICAgICAgYm90OiBhcm1Cb3QsCiAgICAgICAgdG86IHsKICAgICAgICAgICAgYm90OiB0aGF0LmJvdCwKICAgICAgICAgICAgeDogYm90UG9zaXRpb24ueCwKICAgICAgICAgICAgeTogYm90UG9zaXRpb24ueSwKICAgICAgICAgICAgejogYm90UG9zaXRpb24ueiwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0sCiAgICAgICAgZnJvbTogewogICAgICAgICAgICB4OiBib3RQb3NpdGlvbi54LAogICAgICAgICAgICB5OiBib3RQb3NpdGlvbi55LAogICAgICAgICAgICB6OiBib3RQb3NpdGlvbi56LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuOwp9JwCY7dW2AbTPAQVpbnB1dAIEAJjt1bYB+PYCKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAJjt1bYBtM8BC3BlcnNvbmFsaXR5AgQAmO3VtgGf9wIo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicAmO3VtgG0zwENYWJQZXJzb25hbGl0eQIEAJjt1bYBxvcCBHRydWUnAJjt1bYBtM8BCmFiU2V0QXdha2UCBACY7dW2Acv3ApMQQGxldCBhd2FrZSA9IHRoYXQ/LmF3YWtlOwpsZXQgaW5pdGlhbCA9IHRoYXQ/LmluaXRpYWwgPz8gZmFsc2U7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9Cgphc3NlcnQodHlwZW9mIGF3YWtlID09PSAnYm9vbGVhbicsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXdha2UgaXMgYSByZXF1aXJlZCBib29sZWFuIHBhcmFtZXRlci5gKTsKCmlmIChjb25maWdCb3QudGFncy5hYlN0YXlBd2FrZSkgewogICAgLy8gSWYgYWJTdGF5QXdha2UgaXMgZW5hYmxlZCwgb3ZlcnJpZGUgdGhlIGluY29taW5nIGF3YWtlIHBhcmFtZXRlciBhbmQgbmV2ZXIgbGV0IGFiIGJlIHB1dCB0byBzbGVlcC4KICAgIGF3YWtlID0gdHJ1ZTsKfQoKaWYgKHRhZ3MuYWJBd2FrZSAhPT0gYXdha2UpIHsKICAgIGlmIChpbml0aWFsKSB7CiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4pIHsKICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gdXVpZCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBQbGF5IGluaXRpYWwgYW5pbWF0aW9uIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbEFuaW1hdGlvbikgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5hbmltYXRpb25bbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxBbmltYXRpb25dKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFNob3cgaW5pdGlhbCBtZXNzYWdlIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpIHsKICAgICAgICAgICAgc2hvdXQoInNob3dDb25zb2xlIik7CgogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZVtpXSk7CgogICAgICAgICAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDIwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBVcGRhdGUgYWJBd2FrZSBzaGFyZWQgdGFnIG1hc2suCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdhYkF3YWtlJywgYXdha2UsICdzaGFyZWQnKTsKICAgIAogICAgaWYgKGF3YWtlKSB7CiAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA6IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CgogICAgICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbiwgcG9zaXRpb246IHsgeDogMCwgeTogMCB9IH0pOwoKICAgICAgICBzaG91dCgib25BQkF3YWtlIiwgeyBkaW1lbnNpb24sIHBvc2l0aW9uOiB7IHg6IDAsIHk6IDAgfSB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdCk7CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgc2hvdXQoIm9uQUJTbGVlcCIpOwogICAgfQp9JwCY7dW2AbTPAQV1dGlscwIEAJjt1bYB34cDKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAJjt1bYBtM8BC2JvdF9mYWN0b3J5AgQAmO3VtgGGiAMo8J+Ul2M3OGFhNjYzLWQwNWMtNGVjNC1iYzJjLTI2ZmQ1MTU2MGI5NycAmO3VtgG0zwEPb25BQkluaXRpYWxpemVkAgQAmO3VtgGtiAN9QGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsNCiAgICB0aGlzQm90Lm9uUG9ydGFsQ2hhbmdlZCh7cG9ydGFsOiAibWFwUG9ydGFsIiwgZGltZW5zaW9uOiBjb25maWdCb3QudGFncy5tYXBQb3J0YWx9KTsNCn0nAJjt1bYBtM8BBWRlYnVnAgQAmO3VtgGriQMFZmFsc2UnAJjt1bYBtM8BEG9uQUJCZWZvcmVVcGRhdGUCBACY7dW2AbGJAzZAY29uZmlnQm90LnRhZ3MuYWJXYXNBd2FrZUJlZm9yZVVwZGF0ZSA9IHRhZ3MuYWJBd2FrZTsnAJjt1bYBtM8BC29uQUJVcGRhdGVkAgQAmO3VtgHoiQOPAUBpZiAoY29uZmlnQm90LnRhZ3MuYWJXYXNBd2FrZUJlZm9yZVVwZGF0ZSkgewogICAgY29uZmlnQm90LnRhZ3MuYWJXYXNBd2FrZUJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICBhd2FpdCB0aGlzQm90LmFiU2V0QXdha2UoeyBhd2FrZTogdHJ1ZSB9KQp9AA=="}]}