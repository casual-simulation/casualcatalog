{"version":2,"updates":[{"id":0,"timestamp":1767983904321,"update":"AcIBk6qAoQcAJwEEYm90cyQxNjU1NGJjMS1lOTNlLTRhMGItOGNkMy1kZmQ3NzIzMTk2NzIBJwCTqoChBwAJYWJWZXJzaW9uAgQAk6qAoQcBBTEwLjM1JwCTqoChBwAGc3lzdGVtAgQAk6qAoQcHFmFiLnBlcnNvbmFsaXR5LnZlcnNpb24nAJOqgKEHABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQAk6qAoQceATInAJOqgKEHAA1vblNraWxsVXBkYXRlAgQAk6qAoQcgrQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAk6qAoQcADWFiUGVyc29uYWxpdHkCBACTqoChB84BBHRydWUnAJOqgKEHAAhhYklnbm9yZQIEAJOqgKEH0wEEdHJ1ZScAk6qAoQcABGZvcm0CBACTqoChB9gBB25vdGhpbmcnAJOqgKEHABlhYlBlcnNvbmFsaXR5TWlub3JWZXJzaW9uAgQAk6qAoQfgAQEzJwEEYm90cyQzYzc0YzlmMS04MmRjLTQ2NTUtOGIzOC1lN2YxMWRlODk3OGUBJwCTqoChB+IBBnN5c3RlbQIEAJOqgKEH4wEXYWIucGVyc29uYWxpdHkuYXJtX3Rvb2wnAJOqgKEH4gEMb25BbnlCb3REcmFnAgQAk6qAoQf7AY0IQGNvbnN0IGRyYWdCb3QgPSB0aGF0LmJvdDsKY29uc3QgZGltZW5zaW9uID0gdGhhdC5mcm9tLmRpbWVuc2lvbjsKCmlmIChkcmFnQm90LnRhZ3MuYXJtU2VsZWN0aW9uKSB7CiAgICBpZiAoZHJhZ0JvdC5tYXNrcy5hcm1Cb3QpIHsKICAgICAgICBpZiAoZHJhZ0JvdC5saW5rcy5hcm1Cb3QudGFncy5tdWx0aVNlbGVjdCAmJiBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cyAmJiBkcmFnQm90LnRhZ3MuYXJtR3JvdXBEcmFnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVuYWJsZSBjdXN0b20gZHJhZ2dpbmdgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3MuZW5hYmxlQ3VzdG9tRHJhZ2dpbmcoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3kgcHJldmlvdXMgYXJtQm90OiAke2RyYWdCb3QubWFza3MuYXJtQm90fWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkZXN0cm95KGRyYWdCb3QubGlua3MuYXJtQm90KTsKICAgICAgICAgICAgZHJhZ0JvdC5tYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBtdWx0aVNlbGVjdEtleUhlbGQgPSBvcy5nZXRJbnB1dFN0YXRlKCdrZXlib2FyZCcsICdTaGlmdCcpOwogICAgY29uc3QgbXVsdGlTZWxlY3RBbGxvd2VkID0gZHJhZ0JvdC50YWdzLmFybU11bHRpU2VsZWN0ID8/IHRydWU7CgogICAgY29uc3QgYXJtQm90ID0gdGhpc0JvdC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBkcmFnQm90LAogICAgICAgIGRpbWVuc2lvbiwKICAgICAgICBtdWx0aVNlbGVjdDogbXVsdGlTZWxlY3RLZXlIZWxkICYmIG11bHRpU2VsZWN0QWxsb3dlZCwKICAgIH0pCgogICAgb3MucmVwbGFjZURyYWdCb3QoYXJtQm90KTsKfQonAJOqgKEH4gEFZGVidWcCBACTqoChB4kKBWZhbHNlJwCTqoChB+IBCWxpc3RlbmluZwIEAJOqgKEHjwoEdHJ1ZScAk6qAoQfiAQthYkNyZWF0ZUFybQIEAJOqgKEHlArSSEBjb25zdCBvcmlnaW5Cb3QgPSB0aGF0Lm9yaWdpbkJvdDsKYXNzZXJ0KGFiLmxpbmtzLnV0aWxzLmlzQm90KG9yaWdpbkJvdCksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luQm90IGlzIGEgcmVxdWlyZWQgQm90IHBhcmFtZXRlci5gKTsKCmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZGltZW5zaW9uOwphc3NlcnQodHlwZW9mIGRpbWVuc2lvbiA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGltZW5zaW9uIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHBvc2l0aW9uID0gdGhhdC5wb3NpdGlvbiA/PyBnZXRCb3RQb3NpdGlvbihvcmlnaW5Cb3QsIGRpbWVuc2lvbik7CmNvbnN0IG11bHRpU2VsZWN0ID0gdGhhdC5tdWx0aVNlbGVjdCA/PyBmYWxzZTsKY29uc3QgYXJtQ29sb3IgPSB0aGF0LmFybUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLmFybUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLnN0cm9rZUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLmNvbG9yOwpjb25zdCBhcm1NZXNoUGF0aCA9IHRoYXQuYXJtTWVzaFBhdGggPz8gb3JpZ2luQm90LnRhZ3MuYXJtTWVzaFBhdGg7Cgpjb25zdCBhcm0gPSB7CiAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtkaW1lbnNpb24gKyAnWCddOiBwb3NpdGlvbi54LAogICAgW2RpbWVuc2lvbiArICdZJ106IHBvc2l0aW9uLnksCiAgICBbZGltZW5zaW9uICsgJ1onXTogcG9zaXRpb24ueiwKICAgIGNyZWF0b3I6IG9yaWdpbkJvdC5pZCwKICAgIGlzQXJtQm90OiB0cnVlLAogICAgcG9pbnRhYmxlOiB0cnVlLAogICAgbXVsdGlTZWxlY3QsCiAgICBkZWJ1ZzogdGFncy5kZWJ1ZywKICAgIG9yaWdpbkJvdDogZ2V0TGluayhvcmlnaW5Cb3QpLAogICAgZGltZW5zaW9uLAogICAgYXJtQ29sb3IsCiAgICBhcm1NZXNoUGF0aCwKICAgIHN0cm9rZUNvbG9yOiBhcm1Db2xvciwKICAgIGxpbmVDb2xvcjogYXJtQ29sb3IsCiAgICBsaW5lVG86IG9yaWdpbkJvdC5pZCwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjcmVhdGVkIGFybUJvdCAke3RoaXNCb3QuaWR9YCk7CiAgICAgICAgfQogICAgICAgIC8vIERlc3Ryb3kgcHJldmlvdXMgYXJtIGlmIGl0IGlzIHN0aWxsIGFyb3VuZC4KICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1Cb3QpOwogICAgICAgIH0KCiAgICAgICAgdGFncy5zeXN0ZW0gPSBgYXJtLiR7dGhpc0JvdC5pZC5zdWJzdHJpbmcoMCwgNSl9YDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtQm90ID0gZ2V0TGluayh0aGlzQm90KTsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuZHJhZ2dhYmxlID0gdGFncy5tdWx0aVNlbGVjdDsKCiAgICAgICAgaWYgKHRhZ3MuYXJtTWVzaFBhdGggJiYgIXRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuYXJtTWVzaFBhdGguc3RhcnRzV2l0aCgnaHR0cHM6Ly8nKSkgewogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9IHRhZ3MuYXJtTWVzaFBhdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gYWIuYWJCdWlsZENhc3VhbENhdGFsb2dVUkwodGFncy5hcm1NZXNoUGF0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhZ3MuZm9ybSA9ICdtZXNoJzsKICAgICAgICAgICAgdGFncy5mb3JtU3VidHlwZSA9ICdnbHRmJzsKICAgICAgICAgICAgdGFncy5hbmNob3JQb2ludCA9ICdjZW50ZXInOwogICAgICAgICAgICB0YWdzLmNvbG9yID0gdGFncy5hcm1Db2xvcjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YWdzLnN0cm9rZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKICAgICAgICAgICAgdGFncy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAwLjk7CiAgICAgICAgICAgIHRhZ3Muc2NhbGVaID0gMC4wMTsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm0gPSAnc3BoZXJlJzsKICAgICAgICAgICAgICAgIHRhZ3MuY29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBNYWtlIHRoZSBvcmlnaW4gYm90IHVuc2VsZWN0YWJsZSBmb3IgMS80IG9mIGEgc2Vjb25kLgogICAgICAgIC8vIFRoaXMgaGVscHMgcHJldmVudCB1bmludGVudGlvbmFsIHNlbGYtc2VsZWN0aW9uIG9mIHRoZSBvcmlnaW4gYm90LgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKICAgICAgICBvcy5zbGVlcCgyNTApLnRoZW4oKCkgPT4gewogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MucG9pbnRhYmxlID0gbnVsbDsKICAgICAgICB9KQoKICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1DcmVhdGUnKTsKICAgIH0pLAogICAgc2V0QXJtVmlzaWJsZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxldCB2aXNpYmxlID0gdGhhdDsKCiAgICAgICAgaWYgKHZpc2libGUpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuYXJtTWVzaFBhdGgpIHsKICAgICAgICAgICAgICAgIG1hc2tzLmZvcm1PcGFjaXR5ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1hc2tzLnN0cm9rZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgbWFza3MubGluZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgbWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LmlkOyAKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aCkgewogICAgICAgICAgICAgICAgbWFza3MuZm9ybU9wYWNpdHkgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWFza3Muc3Ryb2tlQ29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5saW5lQ29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICBtYXNrcy5saW5lVG8gPSBmYWxzZTsKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gZmFsc2U7CgogICAgICAgICAgICBpZiAodGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICAgICAgbWFza3MuY29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3QgeyBkaW1lbnNpb24gfSA9IHRoYXQ7CgogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3Q/LnRhZ3MuYXJtVGVsZXBvcnQgPz8gdHJ1ZSkgewogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1gnXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1gnXTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1knXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1knXTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1onXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1onXTsKICAgICAgICB9CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1DbGljaycsIHsgZGltZW5zaW9uIH0pOwoKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgfSksCiAgICBvbkRyb3BFbnRlcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmRyYWdCb3QgIT09IHRoaXNCb3QpIHJldHVybjsKICAgICAgICBpZiAoIWxpbmtzLm9yaWdpbkJvdCkgcmV0dXJuOwoKICAgICAgICBjb25zdCBkcm9wQm90ID0gdGhhdC50by5ib3Q7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lQ29sb3IgPSB0YWdzLmFybUNvbG9yOwoKICAgICAgICBpZiAodGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICBsZXQgbGluZVRvQm90cyA9IGxpbmtzLm9yaWdpbkJvdC5saW5rcy5saW5lVG87CgogICAgICAgICAgICBpZiAobGluZVRvQm90cyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gZ2V0TGluayhkcm9wQm90KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxpbmVUb0JvdHMgPSBBcnJheS5pc0FycmF5KGxpbmVUb0JvdHMpID8gbGluZVRvQm90cyA6IFtsaW5lVG9Cb3RzXTsKCiAgICAgICAgICAgICAgICBpZiAoIWxpbmVUb0JvdHMuaW5jbHVkZXMoZHJvcEJvdCkpIHsKICAgICAgICAgICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gZ2V0TGluayguLi5saW5lVG9Cb3RzLCBkcm9wQm90KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZShmYWxzZSk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBoaWRlIGFybWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gZHJvcEJvdC5pZDsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgc2VsZWN0aW9uIG9uIG9yaWdpbiBib3QuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJvcEV4aXQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5kcmFnQm90ICE9PSB0aGlzQm90KSByZXR1cm47CiAgICAgICAgaWYgKCFsaW5rcy5vcmlnaW5Cb3QpIHJldHVybjsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgZHJvcEJvdCA9IHRoYXQudG8uYm90OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyb3BCb3Q6YCwgZHJvcEJvdCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKHRydWUpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBhcm1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IG51bGw7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IHNlbGVjdGlvbiBvbiBvcmlnaW4gYm90LmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkRyb3A6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5ib3QgIT09IHRoaXNCb3QpIHJldHVybjsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBjb25zdCBkcm9wQm90ID0gdGhhdC50by5ib3Q7CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QgJiYgbGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbykgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwogICAgICAgICAgICB0aGlzQm90Lm9yaWdpblNldFNlbGVjdGlvbihsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvKTsKICAgICAgICB9IGVsc2UgaWYgKGRyb3BCb3QpIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5TZXRTZWxlY3Rpb24oZHJvcEJvdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gRHJvcHBlZCBvbiBncmlkLgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcm9wcGVkIG9uIGdyaWQuYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1QbGFjZWQnLCB7IGRpbWVuc2lvbjogdGhhdC50by5kaW1lbnNpb24sIHg6IHRoYXQudG8ueCwgeTogdGhhdC50by55LCB6OiB0aGF0LnRvLnogfSk7CiAgICAgICAgfQogICAgICAgIAogICAgfSksCiAgICBvbkdyaWRDbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHRoaXNCb3Qub3JpZ2luQ2xlYXJTZWxlY3Rpb24oKTsKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgfSksCiAgICBvcmlnaW5DbGVhclNlbGVjdGlvbjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybVNlbGVjdGVkQm90cyA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IG51bGw7CiAgICB9KSwKICAgIG9yaWdpblNldFNlbGVjdGlvbjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHNlbGVjdGVkQm90cyA9IHRoYXQ7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMgPSBzZWxlY3RlZEJvdHMgPyBnZXRMaW5rKHNlbGVjdGVkQm90cykgOiBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lQ29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBsaW5rcy5vcmlnaW5Cb3QudGFncy5hcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybVNlbGVjdGVkQm90cycsIGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpCiAgICAgICAgfQogICAgfSksCiAgICBvbkFueUJvdHNSZW1vdmVkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgdGhhdCB3ZSBzdGlsbCBoYXZlIHNvbWUgYWN0aXZlIHNlbGVjdGVkIGJvdHMuCiAgICAgICAgICAgIGxldCBhY3RpdmVTZWxlY3RlZEJvdHMgPSBmYWxzZTsKCiAgICAgICAgICAgIGNvbnN0IGFybVNlbGVjdGVkQm90cyA9IGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHM7CgogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcm1TZWxlY3RlZEJvdHMpKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVTZWxlY3RlZEJvdHMgPSBhcm1TZWxlY3RlZEJvdHMuZXZlcnkoYiA9PiAhIWIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0ZWRCb3RzID0gISFhcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghYWN0aXZlU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYm90cyB3ZSBoYWQgc2VsZWN0ZWQgbm8gbG9uZ2VyIGV4aXN0LCBkZXN0cm95IHRoaXMgYXJtLgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgdGhhdCBhcm0gaGFzIHNlbGVjdGVkIG5vIGxvbmdlciBleGlzdCwgZGVzdHJveSB0aGlzIGFybS5gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgdGhhdCBhcm0gaGFzIHNlbGVjdGVkIHN0aWxsIGhhcyBhY3RpdmUgYm90cy5gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmRyYWdnYWJsZSA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1EZXN0cm95Jyk7CiAgICB9KSwKfTsKCmNvbnN0IGFybUJvdCA9IGNyZWF0ZShhcm0pOwoKcmV0dXJuIGFybUJvdDsnAJOqgKEH4gEQb25BbnlCb3REcmFnZ2luZwIEAJOqgKEH51LRFUBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC5saW5rcy5hcm1Cb3QpIHsKICAgIGlmIChkcmFnQm90LnRhZ3MuYXJtR3JvdXBEcmFnICYmIGRyYWdCb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgbGV0IGRyYWdDb29yZGluYXRvckJvdCA9IGxpbmtzLmRyYWdDb29yZGluYXRvckJvdDsKICAgICAgICAKICAgICAgICBpZiAoIWRyYWdDb29yZGluYXRvckJvdCkgewogICAgICAgICAgICBjb25zdCBkcmFnQ29vcmRpbmF0b3JNb2QgPSB7CiAgICAgICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgICAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgICAgICAgICAgICAgZGltZW5zaW9uOiBkaW1lbnNpb24sCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWCJdOiAwLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJZIl06IDAsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIloiXTogLTEsCiAgICAgICAgICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVidWc6IHRhZ3MuZGVidWcsCiAgICAgICAgICAgICAgICBjb2xvcjogImNsZWFyIiwKICAgICAgICAgICAgICAgIHN5c3RlbTogYGFybUdyb3VwRHJhZy4ke3RoaXNCb3QuaWQuc3Vic3RyaW5nKDAsIDUpfS5jb29yZGluYXRvcmAsCiAgICAgICAgICAgICAgICBvbkFueUJvdFBvaW50ZXJVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVzdHJveWluZyBkcmFnIGNvb3JkaW5hdG9yYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLm1hc2tzLmRyYWdDb29yZGluYXRvckJvdCA9IG51bGw7IAogICAgICAgICAgICAgICAgICAgIHNob3V0KCdvbkFybVN0b3BHcm91cERyYWcnLCB7IHg6IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAnWCddLCB5OiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgJ1knXSB9KTsKICAgICAgICAgICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QgPSBjcmVhdGUoZHJhZ0Nvb3JkaW5hdG9yTW9kKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNyZWF0ZWQgZHJhZyBjb29yZGluYXRvciBib3Q6YCwgZHJhZ0Nvb3JkaW5hdG9yQm90KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWFza3MuZHJhZ0Nvb3JkaW5hdG9yQm90ID0gZ2V0TGluayhkcmFnQ29vcmRpbmF0b3JCb3QpOwoKICAgICAgICAgICAgY29uc3QgYXJtU2VsZWN0ZWRCb3RzID0gZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgICAgIGNvbnN0IG9uQXJtU3RvcEdyb3VwRHJhZyA9IGBACiAgICAgICAgICAgICAgICBtYXNrcy50cmFuc2Zvcm1lciA9IG51bGw7CiAgICAgICAgICAgICAgICBtYXNrcy5vbkFybVN0b3BHcm91cERyYWcgPSBudWxsOwogICAgICAgICAgICAgICAgdGFncy4ke2RpbWVuc2lvbn1YID0gdGFncy4ke2RpbWVuc2lvbn1YICsgdGhhdC54OwogICAgICAgICAgICAgICAgdGFncy4ke2RpbWVuc2lvbn1ZID0gdGFncy4ke2RpbWVuc2lvbn1ZICsgdGhhdC55OwogICAgICAgICAgICBgCgogICAgICAgICAgICBkcmFnQm90Lm1hc2tzLnRyYW5zZm9ybWVyID0gZHJhZ0Nvb3JkaW5hdG9yQm90LmlkOwogICAgICAgICAgICBkcmFnQm90Lm1hc2tzLm9uQXJtU3RvcEdyb3VwRHJhZyA9IG9uQXJtU3RvcEdyb3VwRHJhZzsKCiAgICAgICAgICAgIHNldFRhZ01hc2soYXJtU2VsZWN0ZWRCb3RzLCAidHJhbnNmb3JtZXIiLCBkcmFnQ29vcmRpbmF0b3JCb3QuaWQsICJ0ZW1wTG9jYWwiKTsKICAgICAgICAgICAgc2V0VGFnTWFzayhhcm1TZWxlY3RlZEJvdHMsICJvbkFybVN0b3BHcm91cERyYWciLCBvbkFybVN0b3BHcm91cERyYWcsICJ0ZW1wTG9jYWwiKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHhDaGFuZ2UgPSB0aGF0LnRvLnggLSB0aGF0LmZyb20ueDsKICAgICAgICBjb25zdCB5Q2hhbmdlID0gdGhhdC50by55IC0gdGhhdC5mcm9tLnk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0geENoYW5nZTogJHt4Q2hhbmdlfSwgeUNoYW5nZTogJHt5Q2hhbmdlfWApOwogICAgICAgIH0KCiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIlgiXSA9IHhDaGFuZ2U7CiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIlkiXSA9IHlDaGFuZ2U7CiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIloiXSA9IC0xOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyYWcgYm90IHdpdGggYXJtIGRvZXMgbm90IHF1YWxpZnkgZm9yIGdyb3VwIGRyYWdnaW5nLmApOwogICAgICAgIH0KICAgIH0KfScAk6qAoQfiAQ1hYlBlcnNvbmFsaXR5AgQAk6qAoQe5aAR0cnVlJwCTqoChB+IBCGFiSWdub3JlAgQAk6qAoQe+aAR0cnVlJwCTqoChB+IBBGZvcm0CBACTqoChB8NoB25vdGhpbmcnAJOqgKEH4gEJYWJWZXJzaW9uAgQAk6qAoQfLaAUxMC4zNScBBGJvdHMkYjI2ZTEwODktMTcyZC00NWE5LThkMjItMDVjM2Y1OGMyYmY3AScAk6qAoQfRaAZzeXN0ZW0CBACTqoChB9JoGGFiLnBlcnNvbmFsaXR5LmFuaW1hdGlvbicAk6qAoQfRaARmb3JtAgQAk6qAoQfraAdub3RoaW5nJwCTqoChB9FoCGFiSWdub3JlAgQAk6qAoQfzaAR0cnVlJwCTqoChB9FoDW1hbmlmZXN0YXRpb24CBACTqoChB/hoKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJOqgKEH0WgIcmVtZW1iZXICBACTqoChB59pKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJOqgKEH0WgYYW5pbWF0aW9uX2FiR3JpZE1hbmlmZXN0AgQAk6qAoQfGafoOQHNob3V0KCJyZXNldCIpOwoKY29uc3QgcG9zaXRpb25YID0gdGhhdD8ucG9zaXRpb24ueCA/PyAwOwpjb25zdCBwb3NpdGlvblkgPSB0aGF0Py5wb3NpdGlvbi55ID8/IDA7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQ/LmRpbWVuc2lvbiA/PyAiaG9tZSI7CmNvbnN0IGdyaWRTY2FsZSA9IHRoYXQ/LnNjYWxlID8/IDU7CmNvbnN0IG1vbWVudENvdW50ID0gMDsKY29uc3QgZ3JpZEJvdCA9IHt9OwoKZ3JpZEJvdC5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwpncmlkQm90LmNvbG9yID0gImNsZWFyIjsKZ3JpZEJvdC5zdHJva2VDb2xvciA9IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKZ3JpZEJvdC5zY2FsZSA9IDAuMDAxOwpncmlkQm90LnNjYWxlWiA9IDAuMTsKZ3JpZEJvdC5yZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKZ3JpZEJvdFtkaW1lbnNpb25dID0gdHJ1ZTsKZ3JpZEJvdC5wb2ludGFibGUgPSBmYWxzZTsKZ3JpZEJvdC5raWxsVGltZXIgPSAiQCBhd2FpdCBvcy5zbGVlcCg0MDApOyBkZXN0cm95KHRoaXNCb3QpOyI7CgpsZXQgcm91bmRCb3RzOwoKZm9yIChsZXQgaSA9IGdyaWRTY2FsZTsgaSA+IDA7IGktLSkKewogICAgY29uc3QgYm90Q291bnQgPSBpICogODsKCiAgICBsZXQgc2lkZUNvdW50ID0gMDsKICAgIGxldCBwaGFzZUZhY3RvciA9IDA7CgogICAgZm9yIChsZXQgaiA9IDA7IGogPCBib3RDb3VudDsgaisrKQogICAgewogICAgICAgIGlmIChwaGFzZUZhY3RvciA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKChpICsgcG9zaXRpb25YKSAqIC0xKSArIHNpZGVDb3VudDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gaSArIHBvc2l0aW9uWTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocGhhc2VGYWN0b3IgPT0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlgiXSA9IGkgKyBwb3NpdGlvblg7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9IChpICsgcG9zaXRpb25ZKSAtIHNpZGVDb3VudDsgIAogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwaGFzZUZhY3RvciA9PSAyKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKGkgKyBwb3NpdGlvblgpIC0gc2lkZUNvdW50OwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSAoKGkgKyBwb3NpdGlvblkpICogLTEpIDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKChpICsgcG9zaXRpb25YKSAqIC0xKSA7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9ICgoaSArIHBvc2l0aW9uWSkgKiAtMSkgKyBzaWRlQ291bnQ7ICAKICAgICAgICB9CgogICAgICAgIGNvbnN0IG5ld0dyaWRCb3QgPSBhd2FpdCBjcmVhdGUoZ3JpZEJvdCk7CgogICAgICAgIGFuaW1hdGVUYWcobmV3R3JpZEJvdCwgInNjYWxlIiwgewogICAgICAgICAgICB0b1ZhbHVlOiAxLAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICJlbGFzdGljIiwKICAgICAgICAgICAgICAgIG1vZGU6ICJvdXQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAwLjAxCiAgICAgICAgfSkuY2F0Y2goKCkgPT4ge30pOwoKICAgICAgICBuZXdHcmlkQm90LmtpbGxUaW1lcigpOwoKICAgICAgICBzaWRlQ291bnQrKzsKCiAgICAgICAgaWYgKHNpZGVDb3VudCA9PSBib3RDb3VudCAvIDQpCiAgICAgICAgewogICAgICAgICAgICBzaWRlQ291bnQgPSAwOwoKICAgICAgICAgICAgcGhhc2VGYWN0b3IrKzsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLnNsZWVwKDgpOwogICAgfQp9JwCTqoChB9FoCWFiVmVyc2lvbgIEAJOqgKEHwXgFMTAuMzUnAJOqgKEH0WgGb25DaGF0AgQAk6qAoQfHeFVALy8gaWYgKHRoYXQubWVzc2FnZSA9PSAiQHRlc3QiKQovLyB7Ci8vICAgICB0aGlzQm90LmFuaW1hdGlvbl9hYkdyaWRNYW5pZmVzdCgpOwovLyB9JwCTqoChB9FoC3BlcnNvbmFsaXR5AgQAk6qAoQedeSjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwCTqoChB9FoDWFiUGVyc29uYWxpdHkCBACTqoChB8R5BHRydWUnAQRib3RzJGI3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYgEnAJOqgKEHyXkGc3lzdGVtAgQAk6qAoQfKeRVhYi5wZXJzb25hbGl0eS5jb25maWcnAJOqgKEHyXkIYWJJZ25vcmUCBACTqoChB+B5BHRydWUnAJOqgKEHyXkEZm9ybQIEAJOqgKEH5XkHbm90aGluZycAk6qAoQfJeQthYkJhc2VDb2xvcgIEAJOqgKEH7XkHIzAwRDlDRCcAk6qAoQfJeRFhYkJhc2VTdHJva2VDb2xvcgIEAJOqgKEH9XkHIzAwRDlDRCcAk6qAoQfJeRBhYkJsdWVwcmludENvbG9yAgQAk6qAoQf9eQcjMDA4MjdCJwCTqoChB8l5CHJlbWVtYmVyAgQAk6qAoQeFeijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCTqoChB8l5EWFiQnVpbGRlcklkZW50aXR5AgQAk6qAoQesegpjYXN1YWwuYm90JwCTqoChB8l5CWFiVmVyc2lvbgIEAJOqgKEHt3oFMTAuMzUnAJOqgKEHyXkXY2hhbmdlUGVyc29uYWxpdHlDb25maWcCBACTqoChB7168hNAaWYgKCF0aGF0KSB7DQogICAgcmV0dXJuOw0KfQ0KDQppZiAoIWF1dGhCb3QpIHsNCiAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOw0KfQ0KDQppZiAoIWF1dGhCb3QpIHsNCiAgICByZXR1cm47DQp9DQoNCmF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90LmlkKTsNCg0KbGV0IGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWJQZXJzb25hbGl0eUNvbmZpZyIpOw0KDQppZiAoYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuc3VjY2VzcyA9PSBmYWxzZSkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0ge307DQp9IGVsc2Ugew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0gYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuZGF0YTsNCn0NCg0KaWYgKHRoYXQubmFtZSkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJ1aWxkZXJJZGVudGl0eSJdID0gdGhhdC5uYW1lOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQnVpbGRlcklkZW50aXR5IiwgdGhhdC5uYW1lLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQuY29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlQ29sb3IiXSA9IHRoYXQuY29sb3I7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQmFzZVN0cm9rZUNvbG9yIl0gPSB0aGF0LmNvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZUNvbG9yIiwgdGhhdC5jb2xvciwgImxvY2FsIik7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlU3Ryb2tlQ29sb3IiLCB0aGF0LmNvbG9yLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQucG9ydGFsQ29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlR3JpZFBvcnRhbENvbG9yIl0gPSB0aGF0LnBvcnRhbENvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZUdyaWRQb3J0YWxDb2xvciIsIHRoYXQucG9ydGFsQ29sb3IsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5tZW51Q29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlTWVudUNvbG9yIl0gPSB0aGF0Lm1lbnVDb2xvcjsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VNZW51Q29sb3IiLCB0aGF0Lm1lbnVDb2xvciwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0Lm1lbnVMYWJlbENvbG9yKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQmFzZUxhYmVsQ29sb3IiXSA9IHRoYXQubWVudUxhYmVsQ29sb3I7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlTGFiZWxDb2xvciIsIHRoYXQubWVudUxhYmVsQ29sb3IsICJsb2NhbCIpOw0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VTaGFkb3dDb2xvciJdID0gdGhhdC5tZW51TGFiZWxDb2xvcjsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VTaGFkb3dDb2xvciIsIHRoYXQubWVudUxhYmVsQ29sb3IsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5mb3JtKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiRm9ybSJdID0gdGhhdC5mb3JtOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiRm9ybSIsIHRoYXQuZm9ybSwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0LmFpTW9kZWwpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJQcmVmZXJyZWRBSU1vZGVsIl0gPSB0aGF0LmFpTW9kZWw7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJQcmVmZXJyZWRBSU1vZGVsIiwgdGhhdC5haU1vZGVsLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQuZGVmYXVsdFBlcnNvbmFsaXR5KSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSB7fTsNCiAgICB0aGlzQm90LnVwZGF0ZVBlcnNvbmFsaXR5KHt9KTsNCn0NCg0KaWYgKHRoYXQubWFwQmFzZW1hcCkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYk1hcFBvcnRhbEJhc2UiXSA9IHRoYXQubWFwQmFzZW1hcDsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYk1hcFBvcnRhbEJhc2UiLCB0aGF0Lm1hcEJhc2VtYXAsICJsb2NhbCIpOw0KfQ0KDQpjb25zdCByZXN1bHQgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICJhYlBlcnNvbmFsaXR5Q29uZmlnIiwgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEpOw0KDQppZiAocmVzdWx0LnN1Y2Nlc3MpIHsNCiAgICBhYi5saW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGB1cGRhdGVkIHBlcnNvbmFsaXR5IGNvbmZpZyBpbiB1c2VyIHJlY29yZGAsIGxvZ1R5cGU6ICdsb2cnfSk7DQp9IGVsc2Ugew0KICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGZhaWxlZCB0byB1cGRhdGUgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkLlxuJHtKU09OLnN0cmluZ2lmeShyZXN1bHQsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOw0KfQ0KDQpzaG91dCgnb25BQlBlcnNvbmFsaXR5Q2hhbmdlZCcsIHsgYm90OiB0aGlzQm90IH0pOycAk6qAoQfJeQ9hYkJhc2VNZW51Q29sb3ICBACTqoChB7COAQcjMDBEOUNEJwCTqoChB8l5EXVwZGF0ZVBlcnNvbmFsaXR5AgQAk6qAoQe4jgGWF0BpZiAodGFncy5kZWJ1Zykgew0KICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRlIHN0YXJ0YCk7DQp9DQoNCmlmICh0aGlzQm90LnZhcnMudXBkYXRpbmdQZXJzb25hbGl0eSkgew0KICAgIHJldHVybjsNCn0NCg0KdGhpc0JvdC52YXJzLnVwZGF0aW5nUGVyc29uYWxpdHkgPSB0cnVlOw0KDQpsZXQgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGE7DQoNCmlmICh0aGF0ICYmIHRoYXQgPT0ge30pIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSA9IHt9Ow0KfSBlbHNlIHsNCiAgICBpZiAoIWF1dGhCb3QpIHsNCiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsNCiAgICB9DQoNCiAgICBpZiAoYXV0aEJvdCkgew0KICAgICAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdC5pZCwgImFiUGVyc29uYWxpdHlDb25maWciKTsNCiAgICAgICAgaWYgKCFsaW5rcy5yZW1lbWJlciAmJiBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5zdWNjZXNzID09IGZhbHNlKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRpbmdQZXJzb25hbGl0eSA9IGZhbHNlOw0KICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKGFiUGVyc29uYWxpdHlDb25maWdEYXRhLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0gYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuZGF0YTsNCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KaWYgKHRhZ3MuZGVidWcpIHsNCiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiUGVyc29uYWxpdHlDb25maWdEYXRhOmAsIHsuLi5hYlBlcnNvbmFsaXR5Q29uZmlnRGF0YX0pOw0KfQ0KDQovL2FiQmx1ZVByaW50Q29sb3INCi8vYWJCYXNlQWNjZW50Q29sb3INCmNvbnN0IGFiVGFncyA9IFsNCiAgICAiYWJCYXNlQ29sb3IiLA0KICAgICJhYkJhc2VNZW51Q29sb3IiLA0KICAgICJhYkJ1aWxkZXJJZGVudGl0eSIsDQogICAgImFiQmFzZVN0cm9rZUNvbG9yIiwNCiAgICAiYWJCYXNlR3JpZFBvcnRhbENvbG9yIiwNCiAgICAiYWJCYXNlTGFiZWxDb2xvciIsDQogICAgImFiQmFzZVNoYWRvd0NvbG9yIiwNCiAgICAiYWJQcmVmZXJyZWRBSU1vZGVsIiwNCiAgICAiYWJDYXRhbG9nTmFtZSIsDQogICAgImFiTWFwUG9ydGFsQmFzZSINCl07DQoNCmNsZWFyVGFnTWFza3ModGhpc0JvdCk7DQoNCi8vIFJ5YW4gKEF1ZyAyOSwgMjAyNSk6IGltIG5vdCBzdXJlIGV4YWN0bHkgd2hhdCBpcyBoYXBwZW5pbmcgaGVyZSBidXQgd2l0aG91dCBzbGVlcGluZyBvbiB0aGVzZSBiaWcgdGFnIG1hc2sgY2hhbmdlcywgdGhleSBkb250IGFsbCBzZWVtIHRvIGNvbWUgaW4gcHJvcGVybHkuDQphd2FpdCBvcy5zbGVlcCgxMDApOw0KDQpmb3IgKGxldCBpID0gMDsgaSA8IGFiVGFncy5sZW5ndGg7ICsraSkgew0KICAgIGlmIChhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSAmJiBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVthYlRhZ3NbaV1dKSB7DQogICAgICAgIGlmICh0YWdzW2FiVGFnc1tpXV0gIT0gYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbYWJUYWdzW2ldXSkgew0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldHRpbmcgJHthYlRhZ3NbaV19IGxvY2FsIG1hc2sgZnJvbSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YTogJHthYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVthYlRhZ3NbaV1dfWApOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCBhYlRhZ3NbaV0sIGFiUGVyc29uYWxpdHlDb25maWdEYXRhW2FiVGFnc1tpXV0sICJsb2NhbCIpOw0KICAgICAgICB9DQogICAgfSBlbHNlIGlmIChsaW5rcy5yZW1lbWJlciAmJiBsaW5rcy5yZW1lbWJlci50YWdzW2FiVGFnc1tpXV0pIHsNCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3NbYWJUYWdzW2ldXSAhPSB0YWdzW2FiVGFnc1tpXV0pIHsNCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzZXR0aW5nICR7YWJUYWdzW2ldfSBsb2NhbCBtYXNrIGZyb20gYWIgcmVtZW1iZXIgYm90OmAsIGxpbmtzLnJlbWVtYmVyLnRhZ3NbYWJUYWdzW2ldXSk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIGFiVGFnc1tpXSwgbGlua3MucmVtZW1iZXIudGFnc1thYlRhZ3NbaV1dLCAibG9jYWwiKTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGlmIChhYlRhZ3NbaV0gPT0gImFiQmFzZUdyaWRQb3J0YWxDb2xvciIpIHsNCiAgICAgICAgZ3JpZFBvcnRhbEJvdC50YWdzLnBvcnRhbENvbG9yID0gdGFncy5hYkJhc2VHcmlkUG9ydGFsQ29sb3I7DQogICAgfQ0KDQogICAgaWYgKGFiVGFnc1tpXSA9PSAiYWJNYXBQb3J0YWxCYXNlIikgew0KICAgICAgICBtYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwID0gdGFncy5hYk1hcFBvcnRhbEJhc2U7DQogICAgICAgIG1pbmlNYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwID0gdGFncy5hYk1hcFBvcnRhbEJhc2U7DQogICAgfQ0KfQ0KDQovLyBSeWFuIChBdWcgMjksIDIwMjUpOiBpbSBub3Qgc3VyZSBleGFjdGx5IHdoYXQgaXMgaGFwcGVuaW5nIGhlcmUgYnV0IHdpdGhvdXQgc2xlZXBpbmcgb24gdGhlc2UgYmlnIHRhZyBtYXNrIGNoYW5nZXMsIHRoZXkgZG9udCBhbGwgc2VlbSB0byBjb21lIGluIHByb3Blcmx5Lg0KYXdhaXQgb3Muc2xlZXAoMTAwKTsNCg0KdGhpc0JvdC52YXJzLnVwZGF0aW5nUGVyc29uYWxpdHkgPSBmYWxzZTsNCnNob3V0KCdvbkFCUGVyc29uYWxpdHlVcGRhdGVkJywgeyBib3Q6IHRoaXNCb3QgfSk7JwCTqoChB8l5DWFiUGVyc29uYWxpdHkCBACTqoChB8+lAQR0cnVlJwCTqoChB8l5DW9uU2tpbGxVcGRhdGUCBACTqoChB9SlAR1AdGhpc0JvdC51cGRhdGVQZXJzb25hbGl0eSgpOycAk6qAoQfJeRFhYkJhc2VTaGFkb3dDb2xvcgIEAJOqgKEH8qUBBWJsYWNrJwCTqoChB8l5EGFiQmFzZUxhYmVsQ29sb3ICBACTqoChB/ilAQVibGFjaycAk6qAoQfJeQptYXBPcHRpb25zAgQAk6qAoQf+pQGeB/Cfp6xbDQogICAgew0KICAgICAgICAibmFtZSI6ICAic2F0ZWxsaXRlIiwNCiAgICAgICAgImlkIjogInNhdGVsbGl0ZSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImh5YnJpZCIsDQogICAgICAgICJpZCI6ICJoeWJyaWQiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJvY2VhbnMiLA0KICAgICAgICAiaWQiOiAib2NlYW5zIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAib3BlbiBzdHJlZXQgbWFwIiwNCiAgICAgICAgImlkIjogIm9zbSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInRlcnJhaW4iLA0KICAgICAgICAiaWQiOiAidGVycmFpbiINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImRhcmsgZ3JheSBjYW52YXMiLA0KICAgICAgICAiaWQiOiAiZGFyay1ncmF5Ig0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiZ3JheSBjYW52YXMiLA0KICAgICAgICAiaWQiOiAiZ3JheSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKGRhcmspIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtbmlnaHQtdmVjdG9yIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAobmF2aWdhdGlvbikiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1uYXZpZ2F0aW9uLXZlY3RvciINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInRvcG9ncmFwaGljIiwNCiAgICAgICAgImlkIjogInRvcG8iDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChyZWxpZWYpIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtcmVsaWVmLXZlY3RvciINCiAgICB9DQpdJwCTqoChB8l5FHNob3dBQkJhc2VtYXBPcHRpb25zAgQAk6qAoQebrQHEBUBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KDQpzaG91dCgiYWJNZW51UmVmcmVzaCIpOw0KY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9ICdhYkJhc2VtYXBPcHRpb25zTWVudSc7DQoNCmZvciAoY29uc3Qgb3B0aW9uIG9mIHRhZ3MubWFwT3B0aW9ucykgew0KICAgIGlmIChvcHRpb24uaWQgPT0gbWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCkgew0KICAgICAgICBjb250aW51ZTsNCiAgICB9DQogICAgY29uc3Qgb3B0aW9uT2JqID0gDQogICAgew0KICAgICAgICBhYkJhc2VtYXBPcHRpb25zTWVudTogdHJ1ZSwNCiAgICAgICAgY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudTogYEBkZXN0cm95KHRoaXNCb3QpO2AsDQogICAgICAgIG1hcElEOiBvcHRpb24uaWQsDQogICAgICAgIGxhYmVsOiBvcHRpb24ubmFtZSwNCiAgICAgICAgb25DbGljazogYEANCiAgICAgICAgICAgIG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLm1hcElEOw0KICAgICAgICAgICAgc2hvdXQoJ2NoYW5nZVBlcnNvbmFsaXR5Q29uZmlnJywgeydtYXBCYXNlbWFwJzogdGFncy5tYXBJRH0pOyANCiAgICAgICAgICAgIHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQogICAgICAgIGANCiAgICB9DQoNCiAgICBhYi5saW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihvcHRpb25PYmopOw0KfScAk6qAoQfJeQtvbkdyaWRDbGljawIEAJOqgKEH4LIBJkBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KJwCTqoChB8l5BWRlYnVnAgQAk6qAoQeHswEFZmFsc2UnAQRib3RzJGI5YjgyODE5LTFmMTQtNDM5Mi04OGE5LTUyZjY3YTlmOGU1NQEnAJOqgKEHjbMBBnN5c3RlbQIEAJOqgKEHjrMBGGFiLnBlcnNvbmFsaXR5LmFybV9udWRnZScAk6qAoQeNswENb25BQkFybVBsYWNlZAIEAJOqgKEHp7MBOEBzZXRUYWdNYXNrKHRoaXNCb3QsICdoYXNBcm1CZWVuUGxhY2VkJywgdHJ1ZSwgJ2xvY2FsJyk7JwCTqoChB42zAQlvbkFCQXdha2UCBACTqoChB+CzATBAYXdhaXQgb3Muc2xlZXAoMjUwKTsKdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnAJOqgKEHjbMBCGFiSWdub3JlAgQAk6qAoQeRtAEEdHJ1ZScAk6qAoQeNswENYWJQZXJzb25hbGl0eQIEAJOqgKEHlrQBBHRydWUnAJOqgKEHjbMBBGZvcm0CBACTqoChB5u0AQdub3RoaW5nJwCTqoChB42zAQVsZWFybgIEAJOqgKEHo7QBKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJOqgKEHjbMBDW1hbmlmZXN0YXRpb24CBACTqoChB8q0ASjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCTqoChB42zAQhyZW1lbWJlcgIEAJOqgKEH8bQBKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJOqgKEHjbMBBWRlYnVnAgQAk6qAoQeYtQEFZmFsc2UnAJOqgKEHjbMBDmFybU51ZGdlV2FpdE1TAgQAk6qAoQeetQEENTAwMCcAk6qAoQeNswEPb25BQkluaXRpYWxpemVkAgQAk6qAoQejtQEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwCTqoChB42zAQ9hYlN0YXJ0QXJtTnVkZ2UCBACTqoChB7+1AYIfQGlmICh0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGVyZSBpcyBhbHJlYWR5IGEgbnVkZ2UgaW4gcHJvZ3Jlc3MuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSA9IHRydWU7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdGFydGluZyBudWRnZS4uLmApCn0KCmZ1bmN0aW9uIGNhbk51ZGdlKCk6IGJvb2xlYW4gewogICAgLy8gQ2FuJ3QgaGF2ZSBwbGFjZWQgdGhlIGFybSBhbHJlYWR5LgogICAgaWYgKHRhZ3MuaGFzQXJtQmVlblBsYWNlZCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBhcm0gcGxhY2VtZW50IGhhcyBhbHJlYWR5IG9jY3VyZWQuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBBQiBtYW5pZmVzdGF0aW9uIGJvdCBtdXN0IGJlIGFjdGl2ZS4KICAgIGlmICghbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBhYiBtYW5pZmVzdGF0aW9uIGJvdCBpcyBpbmFjdGl2ZS5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEFCIGNoYXQgYmFyIG11c3QgYmUgY2xvc2VkLgogICAgaWYgKGxpbmtzLmlucHV0Lm1hc2tzLmNoYXRPcGVuKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFiIGNoYXQgYmFyIGlzIG9wZW4uYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBUaGUgaW5zdCBtdXN0IGJlIGVtcHR5IG9mIGFsbCBib3RzLiBUaGUgZXhjZXB0aW9ucyBhcmUgYWIgYm90cyBhbmQgYnVpbHQtaW4gYm90cy4KICAgIGNvbnN0IHVzZXJNYWRlQm90ID0gZ2V0Qm90KChiKSA9PiB7CiAgICAgICAgcmV0dXJuICFiLnRhZ3Muc3lzdGVtPy5zdGFydHNXaXRoKCdhYi4nKSAmJgogICAgICAgICAgICAgICAgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYKICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJFZ2cgJiYgLy8gRG9uJ3QgaW5jbHVkZSBhYkVnZyBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgICAgICAgICAgICAgIWIudGFncy5hYkxvYWRlZFNraWxsICYmIC8vIERvbid0IGluY2x1ZGUgbG9hZGVkIHNraWxsIGJvdHMgYXMgInVzZXIgbWFkZSIuCiAgICAgICAgICAgICAgICAhYi50YWdzLmFiQm90IC8vIERvbid0IGluY2x1ZGUgYW55IGJvdHMgdGhhdCBhcmUgZmxhZ2dlZCB3aXRoIGFuIGFiQm90IHRhZy4KICAgIH0pCiAgICAKICAgIGlmICh1c2VyTWFkZUJvdCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnVXNlck1hZGVCb3RzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB1c2VyTWFkZUJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFiLnRhZ3Muc3lzdGVtPy5zdGFydHNXaXRoKCdhYi4nKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJFZ2cgLy8gRG9uJ3QgaW5jbHVkZSBhYkVnZyBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBpbnN0IGNvbnRhaW5zIHVzZXIgbWFkZSBib3RzLmAsIHVzZXJNYWRlQm90cyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogaW5zdCBjb250YWlucyB1c2VyIG1hZGUgYm90cy5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gTWVudSBwb3J0YWwgbXVzdCBlaXRoZXIgYmUgaW5hY3RpdmUgb3Igbm90IGhhdmUgYW55IGJvdHMgaW4gdGhlIGN1cnJlbnRseSBhY3RpdmUgbWVudSBwb3J0YWwuCiAgICBpZiAoY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGNvbnN0IGJvdEluTWVudVBvcnRhbCA9IGdldEJvdCgoYikgPT4gewogICAgICAgICAgICByZXR1cm4gYi50YWdzW2NvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWxdID09PSB0cnVlCiAgICAgICAgfSk7CgogICAgICAgIGlmIChib3RJbk1lbnVQb3J0YWwpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBvcGVuIGFuZCBoYXMgYm90cyBpbiBpdC5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwp9CgppZiAoY2FuTnVkZ2UoKSkgewogICAgLy8gU3RhcnQgbnVkZ2UgZm9yIGFybSBwbGFjZW1lbnQuCiAgICBhd2FpdCBvcy5zbGVlcCh0YWdzLmFybU51ZGdlV2FpdE1TKTsKCiAgICBpZiAoY2FuTnVkZ2UoKSkgewogICAgICAgIGNvbnN0IGFiUG9zaXRpb25YID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdC50YWdzW2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gKyAnWCddOwogICAgICAgIGNvbnN0IGFiUG9zaXRpb25ZID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdC50YWdzW2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gKyAnWSddOwoKICAgICAgICBjb25zdCBncmlkQ2xpY2tQYXJhbXMgPSB7CiAgICAgICAgICAgIGRpbWVuc2lvbjogbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiwKICAgICAgICAgICAgcG9zaXRpb246IHsgeDogYWJQb3NpdGlvblggKyA1LCB5OiBhYlBvc2l0aW9uWSB9LAogICAgICAgICAgICBmb3JjZUFybVBsYWNlbWVudDogdHJ1ZSwKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwgPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24pIHsKICAgICAgICAgICAgLy8gTWFwIHBvcnRhbCBpcyBpbiBkaWZmZXJlbnQgY29vcmRpbmF0ZSBzcGFjZSBhbmQgc2NhbGUuCiAgICAgICAgICAgIGdyaWRDbGlja1BhcmFtcy5wb3NpdGlvbi54ID0gYWJQb3NpdGlvblggKyAwLjAwMDM1NzQzNDA2ODQwNTM4MjM7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdoaXNwZXJpbmcgb25HcmlkQ2xpY2sgdG8gdGhlIGFiIG1hbmlmZXN0YXRpb24gYm90IHdpdGggdGhlIHBhcmFtczpgLCBncmlkQ2xpY2tQYXJhbXMpCiAgICAgICAgfQoKICAgICAgICAvLyBGb3JjZSBhYiBhcm0gcGxhY2VtZW50IHVzaW5nIHRoZSBvbkdyaWRDbGljayBsaXN0ZW5lciBvZiB0aGUgbWFuaWZlc3RhdGlvbiBib3QuCiAgICAgICAgd2hpc3BlcihsaW5rcy5tYW5pZmVzdGF0aW9uLCAnb25HcmlkQ2xpY2snLCBncmlkQ2xpY2tQYXJhbXMpOwogICAgfQp9Cgp0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUgPSBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRvbmVgKTsKfScAk6qAoQeNswEQb25BQkNoYXRCYXJDbG9zZQIEAJOqgKEHwtQBG0B0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycAk6qAoQeNswEFaW5wdXQCBACTqoChB97UASjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwCTqoChB42zAQlhYlZlcnNpb24CBACTqoChB4XVAQUxMC4zNScAk6qAoQeNswEPb25Qb3J0YWxDaGFuZ2VkAgQAk6qAoQeL1QGFAUBjb25zdCB7IHBvcnRhbCwgZGltZW5zaW9uIH0gPSB0aGF0OwoKaWYgKHBvcnRhbCA9PT0gJ21lbnVQb3J0YWwnKSB7CiAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgIHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7CiAgICB9Cn0nAJOqgKEHjbMBDWFiTWVudVJlZnJlc2gCBACTqoChB5HWARtAdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnAJOqgKEHjbMBEWRlYnVnVXNlck1hZGVCb3RzAgQAk6qAoQet1gEFZmFsc2UnAQRib3RzJGRjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZAEnAJOqgKEHs9YBBnN5c3RlbQIEAJOqgKEHtNYBHGFiLnBlcnNvbmFsaXR5Lm1hbmlmZXN0YXRpb24nAJOqgKEHs9YBBGZvcm0CBACTqoChB9HWAQdub3RoaW5nJwCTqoChB7PWAQtkZXNjcmlwdGlvbgIEAJOqgKEH2dYBOFRoaXMgc2tpbGwgY29udHJvbHMgdGhlIGFjdHVhbCBib3QgZm9yIHRoZSBhYiBpbnRlcmZhY2UuJwCTqoChB7PWAQVsZWFybgIEAJOqgKEHktcBKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJOqgKEHs9YBD29uUG9ydGFsQ2hhbmdlZAIEAJOqgKEHudcBs0BAY29uc3QgUE9SVEFMU19USEFUX0hJREUgPSBuZXcgU2V0KFsKICAgICJzeXN0ZW1Qb3J0YWwiLAogICAgInNoZWV0UG9ydGFsIgpdKQoKY29uc3QgUE9SVEFMU19USEFUX01BTklGRVNUID0gbmV3IFNldChbCiAgICAiZ3JpZFBvcnRhbCIsCiAgICAibWFwUG9ydGFsIgpdKTsKCmFzeW5jIGZ1bmN0aW9uIGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKHBvcnRhbDogJ21hcCcgfCAnZ3JpZCcpOiB7IHg6IG51bWJlciwgeTogbnVtYmVyIH0gewogICAgaWYgKHBvcnRhbCA9PT0gJ2dyaWQnKSB7CiAgICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9CiAgICB9IGVsc2UgaWYgKHBvcnRhbCA9PT0gJ21hcCcpIHsKICAgICAgICBpZiAodHlwZW9mIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwWm9vbVBvc2l0aW9uPy54ID09PSAnbnVtYmVyJyAmJiAgdHlwZW9mIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwWm9vbVBvc2l0aW9uPy55ID09PSAnbnVtYmVyJykgewogICAgICAgICAgICByZXR1cm4gbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb247CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGV0IGN1cnJlbnRQb3NpdGlvbiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgbGV0IGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbiA9IGF3YWl0IGxpbmtzLnV0aWxzLmhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbigpOwoKICAgICAgICAgICAgLy8gQ3VycmVudCB3b3JrLWFyb3VuZCBmb3IgYWxsb3dpbmcgZ2VvbG9jYXRpb24gZm9yIGlPUyBhcHAKICAgICAgICAgICAgaWYgKGdldEJvdCgic3lzdGVtIiwgImFiLmlvc2JyaWRnZS5tZXNzZW5nZXIiKSkgewogICAgICAgICAgICAgICAgaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbikgewogICAgICAgICAgICAgICAgY29uc3QgZ2VvbG9jYXRpb24gPSBhd2FpdCBvcy5nZXRHZW9sb2NhdGlvbigpOwogICAgICAgICAgICAgICAgaWYgKGdlb2xvY2F0aW9uLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50UG9zaXRpb24gPSB7IHg6IGdlb2xvY2F0aW9uLmxvbmdpdHVkZSwgeTogZ2VvbG9jYXRpb24ubGF0aXR1ZGUgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY3VycmVudFBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY3VycmVudFBvc2l0aW9uOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gR1JQTSBQb3NpdGlvbgogICAgICAgICAgICAgICAgcmV0dXJuIHsgeDogLTg1LjY3NjE4OTQ4MjI0MzQsIHk6IDQyLjk2NTY3NTY3NTY3NTYgfTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVucmVjb25naXplZCBwb3J0YWwgdHlwZSBwcm92aWRlZCB0byBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbjpgLCBwb3J0YWwpOwogICAgICAgIHJldHVybiB7IHg6IDAsIHk6IDAgfQogICAgfQp9Cgpjb25zdCBNQVBfTE9BRF9XQUlUX1RJTUUgPSAxMDAwOwoKZm9yIChjb25zdCBwb3J0YWwgb2YgUE9SVEFMU19USEFUX0hJREUpIHsKICAgIGlmIChjb25maWdCb3QudGFnc1twb3J0YWxdICE9IG51bGwpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGEgcG9ydGFsIHRoYXQgaGlkZXMgYWIgaXMgb3BlbiAtIGhpZGluZyBhYkJvdCBhbmQgaWdub3JpbmcuYCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsICE9IG51bGwgfHwgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsICE9IG51bGwpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGVldCBwb3J0YWwgb3Igc3lzdGVtIHBvcnRhbCBvcGVuZWQgLSBoaWRpbmcgYWJCb3QgYW5kIGlnbm9yaW5nLmApOwogICAgfQoKICAgIGlmICh0YWdzLmFiQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdCk7CiAgICB9CgogICAgcmV0dXJuOwp9CgppZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIGlzIG5vdCBhd2FrZSAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gInRhZ1BvcnRhbCIpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0YWdQb3J0YWwgY2hhbmdlZCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gIm1lbnVQb3J0YWwiKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWVudVBvcnRhbCBjaGFuZ2VkIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAiZ3JpZFBvcnRhbCIgJiYgY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ3JpZFBvcnRhbCBjaGFuZ2VkLCBidXQgYWxzbyBhbHJlYWR5IGluIHRoZSBtYXBQb3J0YWwgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKLy8gVGhlIG1hcCBwb3J0YWwgaXMgdG91Z2guIEl0IHNlZW1zIHRvIHZhcnkgaW4gbG9hZGluZyBzcGVlZCBvbgovLyB2YXJpb3VzIGhhcmR3YXJlIGFuZCBuZXR3b3JrcyBhbmQgaGFzIGJ5IHRoZSB0aW1lIG9uUG9ydGFsQ2hhbmdlZCBpcyBjYWxsZWQgaXQgZG9lc250Ci8vIHNlZW0gZ3VhcmVudGVlZCB0byBiZSBhY3R1YWxseSByZWFkeS4gQWRkaW5nIGEgaGFyZGNvZGVkIHdhaXQgdGltZSB0byBnaXZlIHRoZSBwb3J0YWwgc3BhY2UgdG8gZ2V0Ci8vIHRoZSBtYXAgcG9ydGFsIGZ1bGx5IGxvYWRlZCBiZWZvcmUgY29udGludWluZyB3aXRoIG1hbmlmZXN0aW5nIGFiLgovLwovLyBBdCBzb21lIHBvaW50IHRoaXMgY2FuIGdvIGF3YXkgaWYgd2UgZXZlciBnZXQgYSBzaG91dCBvciBzb21lIG90aGVyIGdhdXJlbnRlZSB0aGF0IHRoZSBtYXAgcG9ydGFsIGlzIGxvYWRlZC9yZWFkeS4KaWYgKHRoYXQucG9ydGFsID09PSAnbWFwUG9ydGFsJykgewogICAgaWYgKHRoYXQuZGltZW5zaW9uKSB7CiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkKSB7CiAgICAgICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gb3Muc2xlZXAoTUFQX0xPQURfV0FJVF9USU1FKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3YWl0aW5nIGZvciBtYXAgcG9ydGFsIHRvIGZpbmlzaCBsb2FkaW5nOiAke01BUF9MT0FEX1dBSVRfVElNRX1tc2ApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlcjsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwogICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXAgcG9ydGFsIGlzIGFscmVhZHkgbG9hZGVkLmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gZmFsc2U7CiAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcCBwb3J0YWwgaGFzIGJlZW4gdW5sb2FkZWQuYCk7CiAgICAgICAgfQogICAgfQp9CgovLyBTdGFydCBjaGVja3MgZm9yIGlmL3doZXJlIHdlIG5lZWQgdG8gbWFuaWZlc3QgYWIuCmxldCBuZXdBQiA9IGZhbHNlOwpsZXQgbmV3QUJQb3J0YWw7CmxldCBuZXdBQlBvc2l0aW9uOwpsZXQgZm9jdXNDYW1lcmEgPSB0cnVlOwoKaWYgKFBPUlRBTFNfVEhBVF9NQU5JRkVTVC5oYXModGhhdC5wb3J0YWwpICYmIHRoYXQuZGltZW5zaW9uKSB7CiAgICAvLyBBIHBvcnRhbCB0aGF0IG1hbmlmZXN0cyBhYiBoYXMganVzdCBjaGFuZ2VkIGRpbWVuc2lvbi4KICAgIC8vIE1hbmlmZXN0IGFiIGluIHRoZSBuZXcgZGltZW5zaW9uLgogICAgaWYgKHRoYXQucG9ydGFsID09ICJtYXBQb3J0YWwiIHx8IHRoYXQucG9ydGFsID09ICJtaW5pTWFwUG9ydGFsIikgezsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hbmlmZXN0aW5nIGFiIGJvdCBpbiBtYXAgcG9ydGFsIGRpbWVuc2lvbiAnJHt0aGF0LmRpbWVuc2lvbn0nLmApOwogICAgICAgIH0KCiAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICBuZXdBQlBvcnRhbCA9IHRoYXQucG9ydGFsOwogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgcG9zaXRpb246IG5ld0FCUG9zaXRpb24gfSk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hbmlmZXN0aW5nIGFiIGJvdCBkaW1lbnNpb24gJyR7dGhhdC5kaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignZ3JpZCcpOwogICAgICAgIG5ld0FCUG9ydGFsID0gdGhhdC5wb3J0YWw7CiAgICAgICAgbmV3QUIgPSBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKICAgIH0KfSBlbHNlIGlmICgoUE9SVEFMU19USEFUX01BTklGRVNULmhhcyh0aGF0LnBvcnRhbCkgfHwgUE9SVEFMU19USEFUX0hJREUuaGFzKHRoYXQucG9ydGFsKSkgJiYgCiAgICAgICAgICAgIXRoYXQuZGltZW5zaW9uICYmIAogICAgICAgICAgIChjb25maWdCb3QudGFncy5ncmlkUG9ydGFsIHx8IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkKKSB7CiAgICAvLyBBIHBvcnRhbCB0aGF0IHR5cGljYWxseSBoaWRlcyBvciByZS1tYW5pZmVzdHMgYWIganVzdCBjbG9zZWQsIGJ1dCBlaXRoZXIgdGhlIGdyaWQgb3IgbWFwIHBvcnRhbCBhcmUgc3RpbGwgb3Blbi4KICAgIC8vIFN1bW1vbiBhYiBpbiBlaXRoZXIgdGhlIG1hcFBvcnRhbCBvciBncmlkUG9ydGFsLgogICAgbGV0IHN1bW1vbkRpbWVuc2lvbjsKCiAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICAgICAgc3VtbW9uRGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ21hcFBvcnRhbCc7CiAgICAgICAgCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10pIHsKICAgICAgICAgICAgLy8gVXNlIGxhc3Qga25vd24gcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IG1hcCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwpIHsKICAgICAgICBzdW1tb25EaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ2dyaWRQb3J0YWwnOwoKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXSkgewogICAgICAgICAgICAvLyBVc2UgbGFzdCBrbm93biBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVXNlIGRlZmF1bHQgZ3JpZCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdncmlkJyk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChzdW1tb25EaW1lbnNpb24pIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN1bW1vbmluZyBhYiBib3QgaW4gJHtuZXdBQlBvcnRhbH0gZGltZW5zaW9uICcke3N1bW1vbkRpbWVuc2lvbn0nLmApOwogICAgICAgIH0KCiAgICAgICAgbmV3QUIgPSBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb246IHN1bW1vbkRpbWVuc2lvbiwgcG9zaXRpb246IG5ld0FCUG9zaXRpb24gfSk7CgogICAgICAgIGlmIChQT1JUQUxTX1RIQVRfSElERS5oYXModGhhdC5wb3J0YWwpKSB7CiAgICAgICAgICAgIC8vIElmIHRoZSBwb3J0YWwgdGhhdCBjbG9zZWQgd2FzIGEgcG9ydGFsIHRoYXQgaGlkZXMgYWIsIHRoZW4gZG9udCBydW4gdGhlIGNhbWVyYSBmb2N1cy4KICAgICAgICAgICAgLy8gVGhpcyB3aWxsIGp1c3QgdXNlIHRoZSBwcmV2aW91cyBjYW1lcmEgcG9zaXRpb24gYWxyZWFkeSBzdG9yZWQgaW4gbWVtb3J5LgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3aWxsIG5vdCBmb2N1cyBjYW1lcmEgb24gYWIgYmVjYXVzZSB3ZSBhcmUganVzdCBhc3N1bWluZyB0aGUgcHJldmlvdXMgY2FtZXJhIHBvc2l0aW9uLmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvY3VzQ2FtZXJhID0gZmFsc2U7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdGggdGhlIG1hcCBhbmQgZ3JpZCBwb3J0YWwgYXJlIGJvdGggY2xvc2VkLCBjYW5ub3Qgc3VtbW9uIGFiIGluIGVpdGhlci5gKTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICByZXR1cm47Cn0KCmlmIChuZXdBQiAmJiBmb2N1c0NhbWVyYSkgewogICAgbGV0IHpvb20gPSAxMDsKCiAgICBpZiAobmV3QUJQb3J0YWwgPT09ICdtYXBQb3J0YWwnIHx8IG5ld0FCUG9ydGFsID09PSAnbWluaU1hcFBvcnRhbCcpIHsKICAgICAgICB6b29tID0gMjAwMDsKICAgIH0KICAgIHRyeSB7CiAgICAgICAgYXdhaXQgb3MuZm9jdXNPbihuZXdBQlBvc2l0aW9uLCB7IHpvb20sIHJvdGF0aW9uOiB7IHg6IDQ1LCB5OiA0NSB9LCBwb3J0YWw6IG5ld0FCUG9ydGFsIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm9jdXNPbiBlcnJvciBvY2N1cmVkOmAsIGUpOwogICAgICAgIH0KICAgIH0KfScAk6qAoQez1gEIcmVtZW1iZXICBACTqoChB+2XAijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCTqoChB7PWAQ1hYk1hbmlmZXN0Qm90AgQAk6qAoQeUmALLPUBjb25zdCBkaW1lbnNpb24gPSB0aGF0Py5kaW1lbnNpb247CmNvbnN0IHBvc2l0aW9uID0gdGhhdD8ucG9zaXRpb247CgppZiAodGhpc0JvdC52YXJzLmFiQm90TGFzdElkKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVzdHJveWluZyBhYkJvdGApOwogICAgfQogICAgZGVzdHJveSh0aGlzQm90LnZhcnMuYWJCb3RMYXN0SWQpOwp9Cgpjb25zdCBhYk1vZCA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIGRpbWVuc2lvbiwKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIGZvcm06ICdjdWJlJywKICAgIGxhYmVsOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsLAogICAgbGFiZWxQb3NpdGlvbjogJ2Zyb250JywKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNjEsCiAgICBkcmFnZ2FibGU6IGZhbHNlLAogICAgYXJtU2VsZWN0aW9uOiB0cnVlLAogICAgYXJtR3JvdXBEcmFnOiB0cnVlLAogICAgYXJtVGVsZXBvcnQ6IHRydWUsCiAgICBhcm1NZXNoUGF0aDogbGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoLAogICAgYXJtQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBwZXJzb25hbGl0eTogdGFncy5wZXJzb25hbGl0eSwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4geyAKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYk1lc2hQYXRoKSB7CiAgICAgICAgICAgIGxldCBmb3JtQWRkcmVzczsKCiAgICAgICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiTWVzaFBhdGguc3RhcnRzV2l0aCgnaHR0cHM6Ly8nKSkgewogICAgICAgICAgICAgICAgZm9ybUFkZHJlc3MgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiTWVzaFBhdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3JtQWRkcmVzcyA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJNZXNoUGF0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgbWVzaCBmb3IgYWIuCiAgICAgICAgICAgIG1hc2tzLm1lc2hCb3QgPSBnZXRMaW5rKGNyZWF0ZSh7CiAgICAgICAgICAgICAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICAgICAgICAgICAgICBhYkJvdDogZ2V0TGluayh0aGlzQm90KSwKICAgICAgICAgICAgICAgIGZvcm06ICdtZXNoJywKICAgICAgICAgICAgICAgIGZvcm1TdWJ0eXBlOiAnZ2x0ZicsCiAgICAgICAgICAgICAgICBmb3JtQWRkcmVzcywKICAgICAgICAgICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lcjogdGhpc0JvdC5pZCwKICAgICAgICAgICAgICAgIGFuY2hvclBvaW50OiAnY2VudGVyJywKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbl06IHRydWUsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAnWiddOiAtMC41CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSAndHJhbnNwYXJlbnQnOwogICAgICAgICAgICB0YWdzLnNjYWxlID0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBJZiBhIGN1c3RvbSBtZXNoIGlzIG5vdCBkZWZpbmVkIGZvciBhYiwgdGhlbiBnaXZlIGFiIGEgImNvcmUiLgogICAgICAgICAgICBtYXNrcy5jb3JlQm90ID0gZ2V0TGluayhjcmVhdGUoewogICAgICAgICAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgICAgICAgICAgYWJCb3Q6IGdldExpbmsodGhpc0JvdCksCiAgICAgICAgICAgICAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAwLjY2LAogICAgICAgICAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHNjYWxlOiAwLjc1LAogICAgICAgICAgICAgICAgdHJhbnNmb3JtZXI6IHRoaXNCb3QuaWQsCiAgICAgICAgICAgICAgICBhbmNob3JQb2ludDogJ2NlbnRlcicsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb25dOiB0cnVlLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgJ1onXTogLTAuNQogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0YWdzLmNvbG9yID0gbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvcjsKICAgICAgICAgICAgdGFncy5zY2FsZSA9IDAuOTsKICAgICAgICAgICAgdGFncy5zdHJva2VXaWR0aCA9IDE7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlQ29sb3IgPSBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgICAgICAgICB0YWdzLmZvcm1PcGFjaXR5ID0gMC4zMzsKICAgICAgICAgICAgdGFncy5mb3JtRGVwdGhUZXN0ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzQm90LmFuaW1hdGVCb3QoKTsKICAgICAgICBtYXNrcy5pbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHRoaXNCb3QuYW5pbWF0ZUJvdCgpLCAyMDAwKTsKICAgIH0pLAogICAgb25DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09ICdtb3VzZScgJiYgdGhhdC5idXR0b25JZCA9PSAncmlnaHQnKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKG1hc2tzLmFybUJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLmFybUJvdCk7CiAgICAgICAgICAgIG1hc2tzLmFybUJvdCA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soKTsKICAgIH0pLAogICAgb25Qb2ludGVyRW50ZXI6TGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlckV4aXQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJykgewogICAgICAgICAgICB0YWdzLm1vdXNlT3ZlciA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyRG93bjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT09ICdsZWZ0JykgewogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24gPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyVXA6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnRCdXR0b25Eb3duID0gZmFsc2U7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJhZzogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24pIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnREcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7ICAKICAgICAgICB9CiAgICB9KSwKICAgIG9uS2V5RG93bjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmtleXMuaW5jbHVkZXMoJ1NoaWZ0JykpIHsKICAgICAgICAgICAgdGFncy5zaGlmdEhlbGQgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICBvbktleVVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQua2V5cy5pbmNsdWRlcygnU2hpZnQnKSkgewogICAgICAgICAgICB0YWdzLnNoaWZ0SGVsZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICB1cGRhdGVQb3J0YWxDdXJzb3I6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsZXQgY3Vyc29yID0gbnVsbDsKCiAgICAgICAgaWYgKHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcpIHsKICAgICAgICAgICAgY3Vyc29yID0gJ2dyYWJiaW5nJzsgICAgCiAgICAgICAgfSBlbHNlIGlmICh0YWdzLm1vdXNlT3ZlcikgewogICAgICAgICAgICBpZiAodGFncy5zaGlmdEhlbGQpIHsKICAgICAgICAgICAgICAgIGN1cnNvciA9ICdjb250ZXh0LW1lbnUnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbEN1cnNvciA9IGN1cnNvcjsKICAgIH0pLAogICAgYW5pbWF0ZUJvdDogTGlzdGVuZXJTdHJpbmcoYXN5bmMgKCkgPT4geyAKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MuYWJPcHRpbWl6ZWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3Qgcm90WiA9IHRhZ3MuZGltZW5zaW9uICsgJ1JvdGF0aW9uWic7CiAgICAgICAgbGV0IHRhcmdldFNjYWxlID0gMC42NTsKCiAgICAgICAgYXdhaXQgYW5pbWF0ZVRhZyh0aGlzQm90LAogICAgICAgIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBbcm90Wl06IDAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIFtyb3RaXTogNi4zLAogICAgICAgICAgICB9LAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICdzaW51c29pZGFsJywKICAgICAgICAgICAgICAgIG1vZGU6ICdpbm91dCcKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDIKICAgICAgICB9KS5jYXRjaChlID0+IHt9KTsKICAgIH0pLAogICAgb25Bcm1DcmVhdGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAoIXRhZ3MuaW50ZXJ2YWwpIHsKICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgcmVzZXQ6IHRydWUgfSk7CiAgICAgICAgfQogICAgfSksCiAgICBvbkFybVBsYWNlZDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiR3JpZEZvY3VzID0gewogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLCAKICAgICAgICAgICAgcG9zaXRpb246IHsKICAgICAgICAgICAgICAgIHg6IHRoYXQueCwKICAgICAgICAgICAgICAgIHk6IHRoYXQueQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnZ3JpZCcgfSk7CgogICAgICAgIHNob3V0KCdvbkFCQXJtUGxhY2VkJywgdGhhdCk7CiAgICB9KSwKICAgIG9uQXJtQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyByZXNldDogdHJ1ZSB9KTsKICAgICAgICBzaG91dCgnb25BQkZvb3RDbGlja2VkJywgdGhhdCk7CiAgICB9KSwKICAgIG9uQXJtU2VsZWN0ZWRCb3RzOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VsZWN0ZWRCb3RzID0gdGhhdDsKCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0ZWRCb3RzKSkgewogICAgICAgICAgICAvLyBNdWx0aXBsZSBib3Qgc2VsZWN0aW9uLgogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYk11bHRpcGxlQm90Rm9jdXMgPSBnZXRMaW5rKHNlbGVjdGVkQm90cyk7CiAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdtdWx0aXBsZUJvdCcgfSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gU2luZ2xlIGJvdCBzZWxlY3Rpb24uCiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiQm90Rm9jdXMgPSAi8J+UlyIgKyBzZWxlY3RlZEJvdHMuaWQ7CgogICAgICAgICAgICBpZiAoc2VsZWN0ZWRCb3RzID09PSB0aGlzQm90KSB7CiAgICAgICAgICAgICAgICBhYi5saW5rcy5tZW51LmFiRW52aXJvbm1lbnRNZW51KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnYm90JyB9KTsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIHNob3V0KCdvbkFCU2VsZWN0ZWRCb3QnLCBzZWxlY3RlZEJvdHMpOwogICAgfSksCiAgICBvbkFybURlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBzaG91dCgnYWJNZW51UmVmcmVzaCcpOwogICAgfSksCiAgICBvbkRlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjbGVhckludGVydmFsKHRhZ3MuaW50ZXJ2YWwpOwogICAgICAgIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7CiAgICB9KSwKfTsKCmNvbnN0IGFiQm90ID0gY3JlYXRlKGFiTW9kKTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiU2Vjb25kYXJ5TGFiZWwpIHsKICAgIGNvbnN0IGFiTGFiZWxCb3QgPSB7CiAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgICAgIFtkaW1lbnNpb24gKyAnWiddOiAtMSwKICAgICAgICBjcmVhdG9yOiBhYkJvdC5pZCwKICAgICAgICB0cmFuc2Zvcm1lcjogYWJCb3QuaWQsCiAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICBjb2xvcjogJ2NsZWFyJywKICAgICAgICBsYWJlbDogbGlua3MucmVtZW1iZXIudGFncy5hYlNlY29uZGFyeUxhYmVsLAogICAgICAgIGxhYmVsUG9zaXRpb246ICdsZWZ0JywKICAgICAgICBsYWJlbFNpemU6IDAuNywKICAgICAgICBsYWJlbENvbG9yOiBhYkJvdC50YWdzLmxhYmVsQ29sb3IsCiAgICB9OwoKICAgIGNyZWF0ZShhYkxhYmVsQm90KTsKfQoKbWFza3MuYWJCb3QgPSBnZXRMaW5rKGFiQm90KTsKbGlua3MucmVtZW1iZXIubWFza3MuYWJBY3RpdmVEaW1lbnNpb24gPSBkaW1lbnNpb247CnRoaXNCb3QudmFycy5hYkJvdExhc3RJZCA9IGFiQm90LmlkOyAvLyBTdG9yaW5nIGlkIGFzIGEgdmFyIHByZXZlbnRzIGdob3N0IGFiQm90cyBkdXJpbmcgbXVsdGlwbGUgY2FsbHMgaW4gb25lIGZyYW1lLgoKLy8gU3RvcmUgdGhlIGxhc3QgcG9zaXRpb24gb2YgYWIgaW4gdGhpcyBkaW1lbnNpb24gb24gdGhlIHJlbWVtYmVyIGJvdC4KbGlua3MucmVtZW1iZXIubWFza3NbZGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10gPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeSh7IHg6IHBvc2l0aW9uPy54LCB5OiBwb3NpdGlvbj8ueSB9KTsKCmF3YWl0IG9zLnNsZWVwKDApOyAvLyBHaXZlIENhc3VhbE9TIGEgY2hhbmNlIHRvIHVwZGF0ZSB0YWcgbWFza3MuCgpzaG91dCgnb25BQk1vdmVkJywgeyBkaW1lbnNpb24sIHg6IHBvc2l0aW9uLngsIHk6IHBvc2l0aW9uLnkgfSk7CgpyZXR1cm4gYWJCb3Q7JwCTqoChB7PWAQtvbkdyaWRDbGljawIEAJOqgKEH3NUCwBRAaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgIHJldHVybjsKfQoKY29uc3Qgc2hpZnRDaGVjayA9IG9zLmdldElucHV0U3RhdGUoImtleWJvYXJkIiwgIlNoaWZ0Iik7CgppZiAobGlua3MuYWJCb3QgJiYgKHNoaWZ0Q2hlY2sgfHwgKHRoYXQubW9kYWxpdHkgPT0gIm1vdXNlIiAmJiB0aGF0LmJ1dHRvbklkID09ICJyaWdodCIgJiYgIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSaWdodENsaWNrRGlzYWJsZWQpIHx8IHRoYXQuZm9yY2VBcm1QbGFjZW1lbnQpKSB7CiAgICBjb25zdCBhcm1Cb3QgPSBhYi5saW5rcy5hcm1fdG9vbC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBsaW5rcy5hYkJvdCwKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB0aGF0LnBvc2l0aW9uLAogICAgfSkKCiAgICAvLyBGYWtlIHVzZXIgZHJvcHBpbmcgdGhlIGFybSBvbiB0aGUgZ3JpZCBzcGFjZS4KICAgIGFybUJvdC5vbkRyb3AoewogICAgICAgIGJvdDogYXJtQm90LAogICAgICAgIHRvOiB7CiAgICAgICAgICAgIHg6IHRoYXQucG9zaXRpb24ueCwKICAgICAgICAgICAgeTogdGhhdC5wb3NpdGlvbi55LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfSwKICAgICAgICBmcm9tOiB7CiAgICAgICAgICAgIHg6IHRoYXQucG9zaXRpb24ueCwKICAgICAgICAgICAgeTogdGhhdC5wb3NpdGlvbi55LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuOwp9Cgpjb25zdCBmb290cHJpbnQgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgW3RoYXQuZGltZW5zaW9uXTogdHJ1ZSwKICAgIFt0aGF0LmRpbWVuc2lvbiArICJYIl06IHRoYXQucG9zaXRpb24ueCwKICAgIFt0aGF0LmRpbWVuc2lvbiArICJZIl06IHRoYXQucG9zaXRpb24ueSwKICAgIHBvc2l0aW9uSW5mbzogdGhhdCwKICAgIHBlcnNvbmFsaXR5OiB0YWdzLnBlcnNvbmFsaXR5LAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIGRyYWdnYWJsZTogZmFsc2UsCiAgICBjdXJzb3I6ICdhbGlhcycsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb25DcmVhdGU6IExpc3RlbmVyU3RyaW5nKGFzeW5jICgpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KCgpID0+IGRlc3Ryb3kodGhpc0JvdCksIDgwMCk7CgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJtTWVzaFBhdGgpIHsKICAgICAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aC5zdGFydHNXaXRoKCdodHRwczovLycpKSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRhZ3MuZm9ybSA9ICdtZXNoJzsKICAgICAgICAgICAgdGFncy5mb3JtU3VidHlwZSA9ICdnbHRmJzsKICAgICAgICAgICAgdGFncy5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgICAgICAgICB0YWdzLmFuY2hvclBvaW50ID0gJ2NlbnRlcic7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGFncy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgICAgICAgICB0YWdzLnNjYWxlWiA9IDAuMDE7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBhbmltYXRlVGFnKHRoaXNCb3QsIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBzY2FsZVg6IDAuMSwKICAgICAgICAgICAgICAgIHNjYWxlWTogMC4xCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIHNjYWxlWDogMS4xLAogICAgICAgICAgICAgICAgc2NhbGVZOiAxLjEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDAuNSwKICAgICAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgICAgICB0eXBlOiAiZWxhc3RpYyIsCiAgICAgICAgICAgICAgICBtb2RlOiAib3V0IgogICAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZSA9PiB7fSk7CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgIHNob3V0KCJvbkFCRm9vdENsaWNrZWQiLCB7IGRpbWVuc2lvbjogdGFncy5kaW1lbnNpb24gfSk7CiAgICAgICAgbGlua3MubWFuYWdlci5hYk1hbmlmZXN0Qm90KHRhZ3MucG9zaXRpb25JbmZvKTsKICAgIH0pLAp9OwoKCmNyZWF0ZShmb290cHJpbnQpOycAk6qAoQez1gEEbWVudQIEAJOqgKEHneoCKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJOqgKEHs9YBB2FiQ2xpY2sCBACTqoChB8TqArUKQGlmICghbGlua3MuYWJCb3QpIHsKICAgIHJldHVybjsKfQoKaWYgKGxpbmtzLmlucHV0KSB7CiAgICBsaW5rcy5pbnB1dC5hYkNoYXRCYXJDbG9zZSgpOwp9Cgpjb25zdCByZXNldCA9IHRoYXQgPyB0aGF0LnJlc2V0IDogZmFsc2U7CmNvbnN0IG1lbnUgPSB0aGF0ID8gdGhhdC5tZW51IDogImNvcmUiOwpjb25zdCBzdGF0ZSA9IG9zLmdldElucHV0U3RhdGUoImtleWJvYXJkIiwgIlNoaWZ0Iik7CgppZiAoIXJlc2V0ICYmIChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsIHx8IHN0YXRlKSkgewogICAgY29uc3QgYWJNZW51Qm90cyA9IGdldEJvdHMoImFiTWVudSIsIHRydWUpOwoKICAgIHdoaXNwZXIoYWJNZW51Qm90cywgImFiTWVudVJlZnJlc2giKTsKCiAgICBjbGVhckludGVydmFsKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwpOwoKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmludGVydmFsID0gbnVsbDsKCiAgICBjbGVhckFuaW1hdGlvbnMobGlua3MuYWJCb3QpOwoKICAgIGNvbnN0IHJvdFogPSBsaW5rcy5hYkJvdC50YWdzLmRpbWVuc2lvbiArICJSb3RhdGlvbloiOwoKICAgIGlmIChzdGF0ZSAmJiBtZW51ID09ICJjb3JlIikgewogICAgICAgIGxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGxpbmtzLm1lbnUuYWJPcGVuTWVudShtZW51KTsKICAgIH0KCiAgICBhbmltYXRlVGFnKGxpbmtzLmFiQm90LCB7CiAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgIFtyb3RaXTogbGlua3MuYWJCb3QudGFnc1tyb3RaXQogICAgICAgIH0sCiAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICBbcm90Wl06IDAKICAgICAgICB9LAogICAgICAgIGVhc2luZzogewogICAgICAgICAgICB0eXBlOiAic2ludXNvaWRhbCIsCiAgICAgICAgICAgIG1vZGU6ICJpbm91dCIKICAgICAgICB9LAogICAgICAgIGR1cmF0aW9uOiAwLjUKICAgIH0pLmNhdGNoKGUgPT4ge30pCn0KZWxzZSB7CiAgICBsaW5rcy5hYkJvdC5hbmltYXRlQm90KCk7CgogICAgbGlua3MuYWJCb3QubWFza3MubGluZVRvID0gbnVsbDsKCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGNsZWFySW50ZXJ2YWwobGlua3MuYWJCb3QudGFncy5pbnRlcnZhbCk7CiAgICBsaW5rcy5hYkJvdC5tYXNrcy5pbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IGxpbmtzLmFiQm90LmFuaW1hdGVCb3QoKSwgMjAwMCk7Cn0KCnNob3V0KCdvbkFCQ2xpY2snLCB7IGFiQm90OiBsaW5rcy5hYkJvdCwgZGltZW5zaW9uOiBsaW5rcy5hYkJvdC50YWdzLmRpbWVuc2lvbiwgbWVudSwgc2hpZnRLZXk6ICEhc3RhdGUsIHJlc2V0IH0pOycAk6qAoQez1gEIYWJJZ25vcmUCBACTqoChB/r0AgR0cnVlJwCTqoChB7PWAQNhc2sCBACTqoChB//0Aijwn5SXZWM4NWMxZDYtOWYxYS00MGQ0LTgyZTEtNWJkNjgwMzQ5YzI3JwCTqoChB7PWAQlhc2tCdXR0b24CBACTqoChB6b1AsgFQGlmICghdGFncy5hYkF3YWtlKQp7CiAgICByZXR1cm47Cn0KCmxldCBhYk1lbnVCdXR0b24gPSB7fTsKCmFiTWVudUJ1dHRvbi5hYk1lbnUgPSB0cnVlOwphYk1lbnVCdXR0b24ucmVtZW1iZXIgPSBsaW5rcy5tZW51LnRhZ3MucmVtZW1iZXI7CmFiTWVudUJ1dHRvbi5tYW5pZmVzdGF0aW9uID0gbGlua3MubWVudS50YWdzLm1hbmlmZXN0YXRpb247CmFiTWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwphYk1lbnVCdXR0b24uYmFzZVNraWxsID0gIvCflJciICsgbGlua3MuYXNrLmlkOwphYk1lbnVCdXR0b24ubGFiZWwgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51TGFiZWw7CmFiTWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVJY29uOwphYk1lbnVCdXR0b24ub25DcmVhdGUgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51T25HZW5lcmF0ZTsKYWJNZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVTb3J0T3JkZXI7CmFiTWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVDb2xvciA/IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVDb2xvciA6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihhYk1lbnVCdXR0b24pOycAk6qAoQez1gEJYWJCb3RDaGF0AgQAk6qAoQft+gLuCEBpZiAoIWxpbmtzLmFiQm90ICYmICF0aGF0LmJvdCkKewogICAgcmV0dXJuOwp9Cgpjb25zdCBib3RCYXNlID0gdGhhdC5ib3QgPyB0aGF0LmJvdDogbGlua3MuYWJCb3Q7CmNvbnN0IGRpbWVuc2lvbiA9ICF0aGF0LmJvdCA/IGJvdEJhc2UudGFncy5kaW1lbnNpb24gOiB0aGF0LmRpbWVuc2lvbiA/IHRoYXQuZGltZW5zaW9uIDogY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbDsKY29uc3QgbWVzc2FnZSA9IHRoYXQubWVzc2FnZTsKY29uc3QgbWVzc2FnZVRpbWUgPSB0aGF0LnRpbWUgPyB0aGF0LnRpbWUgKiAxMDAwIDogMTYwMDsgCgpjb25zdCBtZXNzYWdlQm90ID0gYXdhaXQgbGlua3MuYm90X2ZhY3RvcnkuYWJDcmVhdGVCaWxsYm9hcmRMYWJlbCh7CiAgICBib3Q6IGJvdEJhc2UsCiAgICBsYWJlbDogbWVzc2FnZSwKICAgIGRpbWVuc2lvbiwKICAgIG1lc3NhZ2VUaW1lLAogICAgY29sb3I6ICIjMDAwMDAwIiwKICAgIGxhYmVsQ29sb3I6ICIjZmZmZmZmIiwKICAgIG9uQm90QWRkZWQ6IGBACiAgICAgICAgYXdhaXQgb3Muc2xlZXAodGFncy5tZXNzYWdlVGltZSk7CiAgICAgICAgdGhpc0JvdC5vbkZhZGUoKTsKICAgIGAsCiAgICBvbkZhZGU6IGBACiAgICAgICAgYW5pbWF0ZVRhZyh0aGlzQm90LCB7CiAgICAgICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICAgICAgZm9ybU9wYWNpdHk6IDEsCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDEsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAiWiJdOiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgIloiXQogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgICAgICBmb3JtT3BhY2l0eTogMCwKICAgICAgICAgICAgICAgIGxhYmVsT3BhY2l0eTogMCwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICJaIl06IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAiWiJdICsgNQogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogJHt0aGF0LmR1cmF0aW9uID8/IDN9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHt9KQogICAgICAgIC5maW5hbGx5KCgpID0+IHsKICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICB9KQoKICAgIGAsCn0pOycAk6qAoQez1gEJYWJWZXJzaW9uAgQAk6qAoQfcgwMFMTAuMzUnAJOqgKEHs9YBCWFuaW1hdGlvbgIEAJOqgKEH4oMDKPCflJdiMjZlMTA4OS0xNzJkLTQ1YTktOGQyMi0wNWMzZjU4YzJiZjcnAJOqgKEHs9YBD29uQW55Qm90Q2xpY2tlZAIEAJOqgKEHiYQD6QdAaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmFiUmlnaHRDbGlja0Rpc2FibGVkICYmICF0aGF0LmJvdC50YWdzLmFiUmlnaHRDbGlja0lnbm9yZSAmJiB0aGF0Lm1vZGFsaXR5ID09ICJtb3VzZSIgJiYgdGhhdC5idXR0b25JZCA9PSAicmlnaHQiKSB7CiAgICBpZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBhYiBzZWxlY3RlZAogICAgaWYgKHRoYXQuYm90ID09IGxpbmtzLmFiQm90KSB7CiAgICAgICAgbGlua3MubWVudS5hYkVudmlyb25tZW50TWVudSgpOwogICAgICAgIHJldHVybjsKICAgIH0gICAgCiAgICAKICAgIGNvbnN0IGFybUJvdCA9IGFiLmxpbmtzLmFybV90b29sLmFiQ3JlYXRlQXJtKHsKICAgICAgICBvcmlnaW5Cb3Q6IGxpbmtzLmFiQm90LAogICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICAgICAgcG9zaXRpb246IHRoYXQucG9zaXRpb24sCiAgICB9KQoKICAgIGNvbnN0IGJvdFBvc2l0aW9uID0gZ2V0Qm90UG9zaXRpb24odGhhdC5ib3QsIHRoYXQuZGltZW5zaW9uKTsKCiAgICAvLyBGYWtlIHVzZXIgZHJvcHBpbmcgdGhlIHNlbGVjdGluZyB0aGUgYm90IHdpdGggdGhlIGFybS4KICAgIGFybUJvdC5vbkRyb3AoewogICAgICAgIGJvdDogYXJtQm90LAogICAgICAgIHRvOiB7CiAgICAgICAgICAgIGJvdDogdGhhdC5ib3QsCiAgICAgICAgICAgIHg6IGJvdFBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IGJvdFBvc2l0aW9uLnksCiAgICAgICAgICAgIHo6IGJvdFBvc2l0aW9uLnosCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9LAogICAgICAgIGZyb206IHsKICAgICAgICAgICAgeDogYm90UG9zaXRpb24ueCwKICAgICAgICAgICAgeTogYm90UG9zaXRpb24ueSwKICAgICAgICAgICAgejogYm90UG9zaXRpb24ueiwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybjsKfScAk6qAoQez1gEFaW5wdXQCBACTqoChB/OLAyjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwCTqoChB7PWAQtwZXJzb25hbGl0eQIEAJOqgKEHmowDKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAJOqgKEHs9YBDWFiUGVyc29uYWxpdHkCBACTqoChB8GMAwR0cnVlJwCTqoChB7PWAQphYlNldEF3YWtlAgQAk6qAoQfGjAOTEEBsZXQgYXdha2UgPSB0aGF0Py5hd2FrZTsKbGV0IGluaXRpYWwgPSB0aGF0Py5pbml0aWFsID8/IGZhbHNlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKYXNzZXJ0KHR5cGVvZiBhd2FrZSA9PT0gJ2Jvb2xlYW4nLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGF3YWtlIGlzIGEgcmVxdWlyZWQgYm9vbGVhbiBwYXJhbWV0ZXIuYCk7CgppZiAoY29uZmlnQm90LnRhZ3MuYWJTdGF5QXdha2UpIHsKICAgIC8vIElmIGFiU3RheUF3YWtlIGlzIGVuYWJsZWQsIG92ZXJyaWRlIHRoZSBpbmNvbWluZyBhd2FrZSBwYXJhbWV0ZXIgYW5kIG5ldmVyIGxldCBhYiBiZSBwdXQgdG8gc2xlZXAuCiAgICBhd2FrZSA9IHRydWU7Cn0KCmlmICh0YWdzLmFiQXdha2UgIT09IGF3YWtlKSB7CiAgICBpZiAoaW5pdGlhbCkgewogICAgICAgIGlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKSB7CiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gY29uZmlnQm90LnRhZ3MucGF0dGVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gUGxheSBpbml0aWFsIGFuaW1hdGlvbiBpZiBvbmUgaXMgZGVmaW5lZCBvbiBhYkNvbmZpZy4KICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxBbmltYXRpb24pIHsKICAgICAgICAgICAgYXdhaXQgbGlua3MuYW5pbWF0aW9uW2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsQW5pbWF0aW9uXSgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBTaG93IGluaXRpYWwgbWVzc2FnZSBpZiBvbmUgaXMgZGVmaW5lZCBvbiBhYkNvbmZpZy4KICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlKSB7CiAgICAgICAgICAgIHNob3V0KCJzaG93Q29uc29sZSIpOwoKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlKSkgewogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2VbaV0pOwoKICAgICAgICAgICAgICAgICAgICBhd2FpdCBvcy5zbGVlcCgyMDAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gVXBkYXRlIGFiQXdha2Ugc2hhcmVkIHRhZyBtYXNrLgogICAgc2V0VGFnTWFzayh0aGlzQm90LCAnYWJBd2FrZScsIGF3YWtlLCAnc2hhcmVkJyk7CiAgICAKICAgIGlmIChhd2FrZSkgewogICAgICAgIGxldCBkaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5tYXBQb3J0YWwgPyBjb25maWdCb3QudGFncy5tYXBQb3J0YWwgOiBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwoKICAgICAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb24sIHBvc2l0aW9uOiB7IHg6IDAsIHk6IDAgfSB9KTsKCiAgICAgICAgc2hvdXQoIm9uQUJBd2FrZSIsIHsgZGltZW5zaW9uLCBwb3NpdGlvbjogeyB4OiAwLCB5OiAwIH0gfSk7CiAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3kobGlua3MuYWJCb3QpOwoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwogICAgICAgIHNob3V0KCJvbkFCU2xlZXAiKTsKICAgIH0KfScAk6qAoQez1gEFdXRpbHMCBACTqoChB9qcAyjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCTqoChB7PWAQtib3RfZmFjdG9yeQIEAJOqgKEHgZ0DKPCflJdjNzhhYTY2My1kMDVjLTRlYzQtYmMyYy0yNmZkNTE1NjBiOTcnAJOqgKEHs9YBD29uQUJJbml0aWFsaXplZAIEAJOqgKEHqJ0DfUBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7DQogICAgdGhpc0JvdC5vblBvcnRhbENoYW5nZWQoe3BvcnRhbDogIm1hcFBvcnRhbCIsIGRpbWVuc2lvbjogY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsfSk7DQp9JwCTqoChB7PWAQVkZWJ1ZwIEAJOqgKEHpp4DBWZhbHNlJwCTqoChB7PWARBvbkFCQmVmb3JlVXBkYXRlAgQAk6qAoQesngM2QGNvbmZpZ0JvdC50YWdzLmFiV2FzQXdha2VCZWZvcmVVcGRhdGUgPSB0YWdzLmFiQXdha2U7JwCTqoChB7PWAQtvbkFCVXBkYXRlZAIEAJOqgKEH454DjwFAaWYgKGNvbmZpZ0JvdC50YWdzLmFiV2FzQXdha2VCZWZvcmVVcGRhdGUpIHsKICAgIGNvbmZpZ0JvdC50YWdzLmFiV2FzQXdha2VCZWZvcmVVcGRhdGUgPSBudWxsOwogICAgYXdhaXQgdGhpc0JvdC5hYlNldEF3YWtlKHsgYXdha2U6IHRydWUgfSkKfQA="}]}