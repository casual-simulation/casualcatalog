{"version":2,"updates":[{"id":0,"timestamp":1771645146536,"update":"AdoB0/Cr+g4AJwEEYm90cyQxNjU1NGJjMS1lOTNlLTRhMGItOGNkMy1kZmQ3NzIzMTk2NzIBJwDT8Kv6DgAJYWJWZXJzaW9uAgQA0/Cr+g4BBTEwLjQwJwDT8Kv6DgAGc3lzdGVtAgQA0/Cr+g4HFmFiLnBlcnNvbmFsaXR5LnZlcnNpb24nANPwq/oOABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQA0/Cr+g4eATMnANPwq/oOAA1vblNraWxsVXBkYXRlAgQA0/Cr+g4grQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycA0/Cr+g4ADWFiUGVyc29uYWxpdHkCBADT8Kv6Ds4BBHRydWUnANPwq/oOAAhhYklnbm9yZQIEANPwq/oO0wEEdHJ1ZScA0/Cr+g4ABGZvcm0CBADT8Kv6DtgBB25vdGhpbmcnANPwq/oOABlhYlBlcnNvbmFsaXR5TWlub3JWZXJzaW9uAgQA0/Cr+g7gAQE0JwEEYm90cyQzYzc0YzlmMS04MmRjLTQ2NTUtOGIzOC1lN2YxMWRlODk3OGUBJwDT8Kv6DuIBBnN5c3RlbQIEANPwq/oO4wEXYWIucGVyc29uYWxpdHkuYXJtX3Rvb2wnANPwq/oO4gEMb25BbnlCb3REcmFnAgQA0/Cr+g77AY0IQGNvbnN0IGRyYWdCb3QgPSB0aGF0LmJvdDsKY29uc3QgZGltZW5zaW9uID0gdGhhdC5mcm9tLmRpbWVuc2lvbjsKCmlmIChkcmFnQm90LnRhZ3MuYXJtU2VsZWN0aW9uKSB7CiAgICBpZiAoZHJhZ0JvdC5tYXNrcy5hcm1Cb3QpIHsKICAgICAgICBpZiAoZHJhZ0JvdC5saW5rcy5hcm1Cb3QudGFncy5tdWx0aVNlbGVjdCAmJiBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cyAmJiBkcmFnQm90LnRhZ3MuYXJtR3JvdXBEcmFnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVuYWJsZSBjdXN0b20gZHJhZ2dpbmdgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3MuZW5hYmxlQ3VzdG9tRHJhZ2dpbmcoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3kgcHJldmlvdXMgYXJtQm90OiAke2RyYWdCb3QubWFza3MuYXJtQm90fWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkZXN0cm95KGRyYWdCb3QubGlua3MuYXJtQm90KTsKICAgICAgICAgICAgZHJhZ0JvdC5tYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBtdWx0aVNlbGVjdEtleUhlbGQgPSBvcy5nZXRJbnB1dFN0YXRlKCdrZXlib2FyZCcsICdTaGlmdCcpOwogICAgY29uc3QgbXVsdGlTZWxlY3RBbGxvd2VkID0gZHJhZ0JvdC50YWdzLmFybU11bHRpU2VsZWN0ID8/IHRydWU7CgogICAgY29uc3QgYXJtQm90ID0gdGhpc0JvdC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBkcmFnQm90LAogICAgICAgIGRpbWVuc2lvbiwKICAgICAgICBtdWx0aVNlbGVjdDogbXVsdGlTZWxlY3RLZXlIZWxkICYmIG11bHRpU2VsZWN0QWxsb3dlZCwKICAgIH0pCgogICAgb3MucmVwbGFjZURyYWdCb3QoYXJtQm90KTsKfQonANPwq/oO4gEFZGVidWcCBADT8Kv6DokKBWZhbHNlJwDT8Kv6DuIBCWxpc3RlbmluZwIEANPwq/oOjwoEdHJ1ZScA0/Cr+g7iAQthYkNyZWF0ZUFybQIEANPwq/oOlAr1TUBjb25zdCBvcmlnaW5Cb3QgPSB0aGF0Lm9yaWdpbkJvdDsKYXNzZXJ0KGFiLmxpbmtzLnV0aWxzLmlzQm90KG9yaWdpbkJvdCksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luQm90IGlzIGEgcmVxdWlyZWQgQm90IHBhcmFtZXRlci5gKTsKCmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZGltZW5zaW9uOwphc3NlcnQodHlwZW9mIGRpbWVuc2lvbiA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGltZW5zaW9uIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHBvc2l0aW9uID0gdGhhdC5wb3NpdGlvbiA/PyBnZXRCb3RQb3NpdGlvbihvcmlnaW5Cb3QsIGRpbWVuc2lvbik7CmNvbnN0IG11bHRpU2VsZWN0ID0gdGhhdC5tdWx0aVNlbGVjdCA/PyBmYWxzZTsKY29uc3QgYXJtQ29sb3IgPSB0aGF0LmFybUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLmFybUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLnN0cm9rZUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLmNvbG9yOwpjb25zdCBhcm1NZXNoUGF0aCA9IHRoYXQuYXJtTWVzaFBhdGggPz8gb3JpZ2luQm90LnRhZ3MuYXJtTWVzaFBhdGg7CmNvbnN0IGFybURyb3BTb3VuZCA9IHRoYXQuYXJtRHJvcFNvdW5kID8/IG9yaWdpbkJvdC50YWdzLmFybURyb3BTb3VuZDsKY29uc3QgYXJtVGVsZXBvcnRTb3VuZCA9IHRoYXQuYXJtVGVsZXBvcnRTb3VuZCA/PyBvcmlnaW5Cb3QudGFncy5hcm1UZWxlcG9ydFNvdW5kOwoKY29uc3QgYXJtID0gewogICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICBbZGltZW5zaW9uICsgJ1gnXTogcG9zaXRpb24ueCwKICAgIFtkaW1lbnNpb24gKyAnWSddOiBwb3NpdGlvbi55LAogICAgW2RpbWVuc2lvbiArICdaJ106IHBvc2l0aW9uLnosCiAgICBjcmVhdG9yOiBvcmlnaW5Cb3QuaWQsCiAgICBpc0FybUJvdDogdHJ1ZSwKICAgIHBvaW50YWJsZTogdHJ1ZSwKICAgIG11bHRpU2VsZWN0LAogICAgZGVidWc6IHRhZ3MuZGVidWcsCiAgICBvcmlnaW5Cb3Q6IGdldExpbmsob3JpZ2luQm90KSwKICAgIGRpbWVuc2lvbiwKICAgIGFybUNvbG9yLAogICAgYXJtTWVzaFBhdGgsCiAgICBhcm1Ecm9wU291bmQsCiAgICBhcm1UZWxlcG9ydFNvdW5kLAogICAgZGVmYXVsdEFybURyb3BTb3VuZDogdGFncy5kZWZhdWx0QXJtRHJvcFNvdW5kLAogICAgZGVmYXVsdEFybVRlbGVwb3J0U291bmQ6IHRhZ3MuZGVmYXVsdEFybVRlbGVwb3J0U291bmQsCiAgICBsaW5lQ29sb3I6IGFybUNvbG9yLAogICAgbGluZVRvOiBvcmlnaW5Cb3QuaWQsCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3JlYXRlZCBhcm1Cb3QgJHt0aGlzQm90LmlkfWApOwogICAgICAgIH0KICAgICAgICAvLyBEZXN0cm95IHByZXZpb3VzIGFybSBpZiBpdCBpcyBzdGlsbCBhcm91bmQuCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1Cb3QpIHsKICAgICAgICAgICAgZGVzdHJveShsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtQm90KTsKICAgICAgICB9CgogICAgICAgIHRhZ3Muc3lzdGVtID0gYGFybS4ke3RoaXNCb3QuaWQuc3Vic3RyaW5nKDAsIDUpfWA7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCA9IGdldExpbmsodGhpc0JvdCk7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmRyYWdnYWJsZSA9IHRhZ3MubXVsdGlTZWxlY3Q7CgogICAgICAgIGlmICh0YWdzLmFybU1lc2hQYXRoICYmICF0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIGlmICh0YWdzLmFybU1lc2hQYXRoLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSB0YWdzLmFybU1lc2hQYXRoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9IGFiLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKHRhZ3MuYXJtTWVzaFBhdGgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0YWdzLmZvcm0gPSAnbWVzaCc7CiAgICAgICAgICAgIHRhZ3MuZm9ybVN1YnR5cGUgPSAnZ2x0Zic7CiAgICAgICAgICAgIHRhZ3MuYW5jaG9yUG9pbnQgPSAnY2VudGVyJzsKICAgICAgICAgICAgdGFncy5jb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAwLjk5OTk7IC8vIFRoZXJlIGlzIGEgcmVhbGx5IHN0cmFuZ2UgYnVnIHRoYXQgaWYgdGhpcyBpcyBsZWZ0IHVuZGVmaW5lZCBvciBzZXQgdG8gMSBleGFjdGx5LCB0aGUgYXJtIHdpbGwgc29tZXRpbWVzIGRpc2FwcGVhci4KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YWdzLnN0cm9rZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKICAgICAgICAgICAgdGFncy5mb3JtID0gJ2N1YmUnOwogICAgICAgICAgICB0YWdzLmNvbG9yID0gJ2NsZWFyJzsKICAgICAgICAgICAgdGFncy5zY2FsZSA9IDAuOTsKICAgICAgICAgICAgdGFncy5zY2FsZVogPSAwLjAxOwoKICAgICAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybSA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgdGFncy5jb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE1ha2UgdGhlIG9yaWdpbiBib3QgdW5zZWxlY3RhYmxlIGZvciAxLzQgb2YgYSBzZWNvbmQuCiAgICAgICAgLy8gVGhpcyBoZWxwcyBwcmV2ZW50IHVuaW50ZW50aW9uYWwgc2VsZi1zZWxlY3Rpb24gb2YgdGhlIG9yaWdpbiBib3QuCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLnBvaW50YWJsZSA9IGZhbHNlOwogICAgICAgIG9zLnNsZWVwKDI1MCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5wb2ludGFibGUgPSBudWxsOwogICAgICAgIH0pCgogICAgICAgIHRoaXNCb3Qub3JpZ2luQ2xlYXJTZWxlY3Rpb24oKTsKCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybUNyZWF0ZScpOwogICAgfSksCiAgICBzZXRBcm1WaXNpYmxlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGV0IHZpc2libGUgPSB0aGF0OwoKICAgICAgICBpZiAodmlzaWJsZSkgewogICAgICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aCkgewogICAgICAgICAgICAgICAgbWFza3MuZm9ybU9wYWNpdHkgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWFza3Muc3Ryb2tlQ29sb3IgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5saW5lQ29sb3IgPSBudWxsOwogICAgICAgICAgICBtYXNrcy5saW5lVG8gPSBsaW5rcy5vcmlnaW5Cb3QuaWQ7IAogICAgICAgICAgICBtYXNrcy5wb2ludGFibGUgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgICAgIG1hc2tzLmNvbG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmFybU1lc2hQYXRoKSB7CiAgICAgICAgICAgICAgICBtYXNrcy5mb3JtT3BhY2l0eSA9IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYXNrcy5zdHJva2VDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1hc2tzLmxpbmVDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIG1hc2tzLmxpbmVUbyA9IGZhbHNlOwogICAgICAgICAgICBtYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCB7IGRpbWVuc2lvbiB9ID0gdGhhdDsKCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdD8udGFncy5hcm1UZWxlcG9ydCA/PyB0cnVlKSB7CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC50YWdzW2RpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWCddID0gdGFnc1tkaW1lbnNpb24gKyAnWCddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWSddID0gdGFnc1tkaW1lbnNpb24gKyAnWSddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWiddID0gdGFnc1tkaW1lbnNpb24gKyAnWiddOwoKICAgICAgICAgICAgYWIubGlua3Muc291bmQuYWJQbGF5U291bmQoeyB2YWx1ZTogdGFncy5hcm1UZWxlcG9ydFNvdW5kLCBkZWZhdWx0VmFsdWU6IHRhZ3MuZGVmYXVsdEFybVRlbGVwb3J0U291bmQgfSk7CiAgICAgICAgfQoKICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtQ2xpY2snLCB7IGRpbWVuc2lvbiB9KTsKCiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIH0pLAogICAgb25Ecm9wRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5kcmFnQm90ICE9PSB0aGlzQm90KSByZXR1cm47CiAgICAgICAgaWYgKCFsaW5rcy5vcmlnaW5Cb3QpIHJldHVybjsKCiAgICAgICAgY29uc3QgZHJvcEJvdCA9IHRoYXQudG8uYm90OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgbGV0IGxpbmVUb0JvdHMgPSBsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvOwoKICAgICAgICAgICAgaWYgKGxpbmVUb0JvdHMgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGdldExpbmsoZHJvcEJvdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5lVG9Cb3RzID0gQXJyYXkuaXNBcnJheShsaW5lVG9Cb3RzKSA/IGxpbmVUb0JvdHMgOiBbbGluZVRvQm90c107CgogICAgICAgICAgICAgICAgaWYgKCFsaW5lVG9Cb3RzLmluY2x1ZGVzKGRyb3BCb3QpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGdldExpbmsoLi4ubGluZVRvQm90cywgZHJvcEJvdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaGlkZSBhcm1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGRyb3BCb3QuaWQ7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IHNlbGVjdGlvbiBvbiBvcmlnaW4gYm90LmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkRyb3BFeGl0OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuZHJhZ0JvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwogICAgICAgIGlmICghbGlua3Mub3JpZ2luQm90KSByZXR1cm47CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcm9wQm90OmAsIGRyb3BCb3QpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZSh0cnVlKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgYXJtYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBzZWxlY3Rpb24gb24gb3JpZ2luIGJvdC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25Ecm9wOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuYm90ICE9PSB0aGlzQm90KSByZXR1cm47CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3QgZHJvcEJvdCA9IHRoYXQudG8uYm90OwoKICAgICAgICBhYi5saW5rcy5zb3VuZC5hYlBsYXlTb3VuZCh7IHZhbHVlOiB0YWdzLmFybURyb3BTb3VuZCwgZGVmYXVsdFZhbHVlOiB0YWdzLmRlZmF1bHRBcm1Ecm9wU291bmQgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QgJiYgbGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbykgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwogICAgICAgICAgICB0aGlzQm90Lm9yaWdpblNldFNlbGVjdGlvbihsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvKTsKICAgICAgICB9IGVsc2UgaWYgKGRyb3BCb3QpIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5TZXRTZWxlY3Rpb24oZHJvcEJvdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gRHJvcHBlZCBvbiBncmlkLgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcm9wcGVkIG9uIGdyaWQuYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1QbGFjZWQnLCB7IGRpbWVuc2lvbjogdGhhdC50by5kaW1lbnNpb24sIHg6IHRoYXQudG8ueCwgeTogdGhhdC50by55LCB6OiB0aGF0LnRvLnogfSk7CiAgICAgICAgfQogICAgICAgIAogICAgfSksCiAgICBvbkdyaWRDbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHRoaXNCb3Qub3JpZ2luQ2xlYXJTZWxlY3Rpb24oKTsKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgfSksCiAgICBvcmlnaW5DbGVhclNlbGVjdGlvbjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybVNlbGVjdGVkQm90cyA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IG51bGw7CiAgICB9KSwKICAgIG9yaWdpblNldFNlbGVjdGlvbjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHNlbGVjdGVkQm90cyA9IHRoYXQ7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMgPSBzZWxlY3RlZEJvdHMgPyBnZXRMaW5rKHNlbGVjdGVkQm90cykgOiBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lQ29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBsaW5rcy5vcmlnaW5Cb3QudGFncy5hcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybVNlbGVjdGVkQm90cycsIGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpCiAgICAgICAgfQogICAgfSksCiAgICBvbkFueUJvdHNSZW1vdmVkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgdGhhdCB3ZSBzdGlsbCBoYXZlIHNvbWUgYWN0aXZlIHNlbGVjdGVkIGJvdHMuCiAgICAgICAgICAgIGxldCBhY3RpdmVTZWxlY3RlZEJvdHMgPSBmYWxzZTsKCiAgICAgICAgICAgIGNvbnN0IGFybVNlbGVjdGVkQm90cyA9IGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHM7CgogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcm1TZWxlY3RlZEJvdHMpKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVTZWxlY3RlZEJvdHMgPSBhcm1TZWxlY3RlZEJvdHMuZXZlcnkoYiA9PiAhIWIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0ZWRCb3RzID0gISFhcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghYWN0aXZlU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYm90cyB3ZSBoYWQgc2VsZWN0ZWQgbm8gbG9uZ2VyIGV4aXN0LCBkZXN0cm95IHRoaXMgYXJtLgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgdGhhdCBhcm0gaGFzIHNlbGVjdGVkIG5vIGxvbmdlciBleGlzdCwgZGVzdHJveSB0aGlzIGFybS5gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgdGhhdCBhcm0gaGFzIHNlbGVjdGVkIHN0aWxsIGhhcyBhY3RpdmUgYm90cy5gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmRyYWdnYWJsZSA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1EZXN0cm95Jyk7CiAgICB9KSwKfTsKCmNvbnN0IGFybUJvdCA9IGNyZWF0ZShhcm0pOwoKcmV0dXJuIGFybUJvdDsnANPwq/oO4gEQb25BbnlCb3REcmFnZ2luZwIEANPwq/oOiljRFUBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC5saW5rcy5hcm1Cb3QpIHsKICAgIGlmIChkcmFnQm90LnRhZ3MuYXJtR3JvdXBEcmFnICYmIGRyYWdCb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgbGV0IGRyYWdDb29yZGluYXRvckJvdCA9IGxpbmtzLmRyYWdDb29yZGluYXRvckJvdDsKICAgICAgICAKICAgICAgICBpZiAoIWRyYWdDb29yZGluYXRvckJvdCkgewogICAgICAgICAgICBjb25zdCBkcmFnQ29vcmRpbmF0b3JNb2QgPSB7CiAgICAgICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgICAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgICAgICAgICAgICAgZGltZW5zaW9uOiBkaW1lbnNpb24sCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWCJdOiAwLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJZIl06IDAsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIloiXTogLTEsCiAgICAgICAgICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgZGVidWc6IHRhZ3MuZGVidWcsCiAgICAgICAgICAgICAgICBjb2xvcjogImNsZWFyIiwKICAgICAgICAgICAgICAgIHN5c3RlbTogYGFybUdyb3VwRHJhZy4ke3RoaXNCb3QuaWQuc3Vic3RyaW5nKDAsIDUpfS5jb29yZGluYXRvcmAsCiAgICAgICAgICAgICAgICBvbkFueUJvdFBvaW50ZXJVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVzdHJveWluZyBkcmFnIGNvb3JkaW5hdG9yYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLm1hc2tzLmRyYWdDb29yZGluYXRvckJvdCA9IG51bGw7IAogICAgICAgICAgICAgICAgICAgIHNob3V0KCdvbkFybVN0b3BHcm91cERyYWcnLCB7IHg6IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAnWCddLCB5OiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgJ1knXSB9KTsKICAgICAgICAgICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QgPSBjcmVhdGUoZHJhZ0Nvb3JkaW5hdG9yTW9kKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNyZWF0ZWQgZHJhZyBjb29yZGluYXRvciBib3Q6YCwgZHJhZ0Nvb3JkaW5hdG9yQm90KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWFza3MuZHJhZ0Nvb3JkaW5hdG9yQm90ID0gZ2V0TGluayhkcmFnQ29vcmRpbmF0b3JCb3QpOwoKICAgICAgICAgICAgY29uc3QgYXJtU2VsZWN0ZWRCb3RzID0gZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgICAgIGNvbnN0IG9uQXJtU3RvcEdyb3VwRHJhZyA9IGBACiAgICAgICAgICAgICAgICBtYXNrcy50cmFuc2Zvcm1lciA9IG51bGw7CiAgICAgICAgICAgICAgICBtYXNrcy5vbkFybVN0b3BHcm91cERyYWcgPSBudWxsOwogICAgICAgICAgICAgICAgdGFncy4ke2RpbWVuc2lvbn1YID0gdGFncy4ke2RpbWVuc2lvbn1YICsgdGhhdC54OwogICAgICAgICAgICAgICAgdGFncy4ke2RpbWVuc2lvbn1ZID0gdGFncy4ke2RpbWVuc2lvbn1ZICsgdGhhdC55OwogICAgICAgICAgICBgCgogICAgICAgICAgICBkcmFnQm90Lm1hc2tzLnRyYW5zZm9ybWVyID0gZHJhZ0Nvb3JkaW5hdG9yQm90LmlkOwogICAgICAgICAgICBkcmFnQm90Lm1hc2tzLm9uQXJtU3RvcEdyb3VwRHJhZyA9IG9uQXJtU3RvcEdyb3VwRHJhZzsKCiAgICAgICAgICAgIHNldFRhZ01hc2soYXJtU2VsZWN0ZWRCb3RzLCAidHJhbnNmb3JtZXIiLCBkcmFnQ29vcmRpbmF0b3JCb3QuaWQsICJ0ZW1wTG9jYWwiKTsKICAgICAgICAgICAgc2V0VGFnTWFzayhhcm1TZWxlY3RlZEJvdHMsICJvbkFybVN0b3BHcm91cERyYWciLCBvbkFybVN0b3BHcm91cERyYWcsICJ0ZW1wTG9jYWwiKTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHhDaGFuZ2UgPSB0aGF0LnRvLnggLSB0aGF0LmZyb20ueDsKICAgICAgICBjb25zdCB5Q2hhbmdlID0gdGhhdC50by55IC0gdGhhdC5mcm9tLnk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0geENoYW5nZTogJHt4Q2hhbmdlfSwgeUNoYW5nZTogJHt5Q2hhbmdlfWApOwogICAgICAgIH0KCiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIlgiXSA9IHhDaGFuZ2U7CiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIlkiXSA9IHlDaGFuZ2U7CiAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90LnRhZ3NbZGltZW5zaW9uICsgIloiXSA9IC0xOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyYWcgYm90IHdpdGggYXJtIGRvZXMgbm90IHF1YWxpZnkgZm9yIGdyb3VwIGRyYWdnaW5nLmApOwogICAgICAgIH0KICAgIH0KfScA0/Cr+g7iAQ1hYlBlcnNvbmFsaXR5AgQA0/Cr+g7cbQR0cnVlJwDT8Kv6DuIBCGFiSWdub3JlAgQA0/Cr+g7hbQR0cnVlJwDT8Kv6DuIBBGZvcm0CBADT8Kv6DuZtB25vdGhpbmcnANPwq/oO4gEJYWJWZXJzaW9uAgQA0/Cr+g7ubQUxMC40MCcA0/Cr+g7iARNkZWZhdWx0QXJtRHJvcFNvdW5kAgQA0/Cr+g70bRlhYi9hdWRpby9zZWxlY3QgbGV2ZWwubXAzJwDT8Kv6DuIBF2RlZmF1bHRBcm1UZWxlcG9ydFNvdW5kAgQA0/Cr+g6ObhJhYi9hdWRpby93b29zaC5tcDMnAQRib3RzJGIyNmUxMDg5LTE3MmQtNDVhOS04ZDIyLTA1YzNmNThjMmJmNwEnANPwq/oOoW4Gc3lzdGVtAgQA0/Cr+g6ibhhhYi5wZXJzb25hbGl0eS5hbmltYXRpb24nANPwq/oOoW4EZm9ybQIEANPwq/oOu24Hbm90aGluZycA0/Cr+g6hbghhYklnbm9yZQIEANPwq/oOw24EdHJ1ZScA0/Cr+g6hbg1tYW5pZmVzdGF0aW9uAgQA0/Cr+g7Ibijwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDT8Kv6DqFuCHJlbWVtYmVyAgQA0/Cr+g7vbijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDT8Kv6DqFuGGFuaW1hdGlvbl9hYkdyaWRNYW5pZmVzdAIEANPwq/oOlm/6DkBzaG91dCgicmVzZXQiKTsKCmNvbnN0IHBvc2l0aW9uWCA9IHRoYXQ/LnBvc2l0aW9uLnggPz8gMDsKY29uc3QgcG9zaXRpb25ZID0gdGhhdD8ucG9zaXRpb24ueSA/PyAwOwpjb25zdCBkaW1lbnNpb24gPSB0aGF0Py5kaW1lbnNpb24gPz8gImhvbWUiOwpjb25zdCBncmlkU2NhbGUgPSB0aGF0Py5zY2FsZSA/PyA1Owpjb25zdCBtb21lbnRDb3VudCA9IDA7CmNvbnN0IGdyaWRCb3QgPSB7fTsKCmdyaWRCb3Quc3BhY2UgPSAidGVtcExvY2FsIjsKZ3JpZEJvdC5jb2xvciA9ICJjbGVhciI7CmdyaWRCb3Quc3Ryb2tlQ29sb3IgPSBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CmdyaWRCb3Quc2NhbGUgPSAwLjAwMTsKZ3JpZEJvdC5zY2FsZVogPSAwLjE7CmdyaWRCb3QucmVzZXQgPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CmdyaWRCb3RbZGltZW5zaW9uXSA9IHRydWU7CmdyaWRCb3QucG9pbnRhYmxlID0gZmFsc2U7CmdyaWRCb3Qua2lsbFRpbWVyID0gIkAgYXdhaXQgb3Muc2xlZXAoNDAwKTsgZGVzdHJveSh0aGlzQm90KTsiOwoKbGV0IHJvdW5kQm90czsKCmZvciAobGV0IGkgPSBncmlkU2NhbGU7IGkgPiAwOyBpLS0pCnsKICAgIGNvbnN0IGJvdENvdW50ID0gaSAqIDg7CgogICAgbGV0IHNpZGVDb3VudCA9IDA7CiAgICBsZXQgcGhhc2VGYWN0b3IgPSAwOwoKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYm90Q291bnQ7IGorKykKICAgIHsKICAgICAgICBpZiAocGhhc2VGYWN0b3IgPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlgiXSA9ICgoaSArIHBvc2l0aW9uWCkgKiAtMSkgKyBzaWRlQ291bnQ7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9IGkgKyBwb3NpdGlvblk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHBoYXNlRmFjdG9yID09IDEpCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSBpICsgcG9zaXRpb25YOwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSAoaSArIHBvc2l0aW9uWSkgLSBzaWRlQ291bnQ7ICAKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocGhhc2VGYWN0b3IgPT0gMikKICAgICAgICB7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlgiXSA9IChpICsgcG9zaXRpb25YKSAtIHNpZGVDb3VudDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKChpICsgcG9zaXRpb25ZKSAqIC0xKSA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlgiXSA9ICgoaSArIHBvc2l0aW9uWCkgKiAtMSkgOwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSAoKGkgKyBwb3NpdGlvblkpICogLTEpICsgc2lkZUNvdW50OyAgCiAgICAgICAgfQoKICAgICAgICBjb25zdCBuZXdHcmlkQm90ID0gYXdhaXQgY3JlYXRlKGdyaWRCb3QpOwoKICAgICAgICBhbmltYXRlVGFnKG5ld0dyaWRCb3QsICJzY2FsZSIsIHsKICAgICAgICAgICAgdG9WYWx1ZTogMSwKICAgICAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgICAgICB0eXBlOiAiZWxhc3RpYyIsCiAgICAgICAgICAgICAgICBtb2RlOiAib3V0IgogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogMC4wMQogICAgICAgIH0pLmNhdGNoKCgpID0+IHt9KTsKCiAgICAgICAgbmV3R3JpZEJvdC5raWxsVGltZXIoKTsKCiAgICAgICAgc2lkZUNvdW50Kys7CgogICAgICAgIGlmIChzaWRlQ291bnQgPT0gYm90Q291bnQgLyA0KQogICAgICAgIHsKICAgICAgICAgICAgc2lkZUNvdW50ID0gMDsKCiAgICAgICAgICAgIHBoYXNlRmFjdG9yKys7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5zbGVlcCg4KTsKICAgIH0KfScA0/Cr+g6hbglhYlZlcnNpb24CBADT8Kv6DpF+BTEwLjQwJwDT8Kv6DqFuBm9uQ2hhdAIEANPwq/oOl35VQC8vIGlmICh0aGF0Lm1lc3NhZ2UgPT0gIkB0ZXN0IikKLy8gewovLyAgICAgdGhpc0JvdC5hbmltYXRpb25fYWJHcmlkTWFuaWZlc3QoKTsKLy8gfScA0/Cr+g6hbgtwZXJzb25hbGl0eQIEANPwq/oO7X4o8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicA0/Cr+g6hbg1hYlBlcnNvbmFsaXR5AgQA0/Cr+g6UfwR0cnVlJwEEYm90cyRiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGIBJwDT8Kv6Dpl/BnN5c3RlbQIEANPwq/oOmn8VYWIucGVyc29uYWxpdHkuY29uZmlnJwDT8Kv6Dpl/CGFiSWdub3JlAgQA0/Cr+g6wfwR0cnVlJwDT8Kv6Dpl/BGZvcm0CBADT8Kv6DrV/B25vdGhpbmcnANPwq/oOmX8LYWJCYXNlQ29sb3ICBADT8Kv6Dr1/ByMwMEQ5Q0QnANPwq/oOmX8RYWJCYXNlU3Ryb2tlQ29sb3ICBADT8Kv6DsV/ByMwMEQ5Q0QnANPwq/oOmX8QYWJCbHVlcHJpbnRDb2xvcgIEANPwq/oOzX8HIzAwODI3QicA0/Cr+g6ZfwhyZW1lbWJlcgIEANPwq/oO1X8o8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA0/Cr+g6ZfxFhYkJ1aWxkZXJJZGVudGl0eQIEANPwq/oO/H8KY2FzdWFsLmJvdCcA0/Cr+g6ZfwlhYlZlcnNpb24CBADT8Kv6DoeAAQUxMC40MCcA0/Cr+g6Zfw9hYkJhc2VNZW51Q29sb3ICBADT8Kv6Do2AAQcjMDBEOUNEJwDT8Kv6Dpl/DWFiUGVyc29uYWxpdHkCBADT8Kv6DpWAAQR0cnVlJwDT8Kv6Dpl/DW9uU2tpbGxVcGRhdGUCBADT8Kv6DpqAAR1AdGhpc0JvdC5hYlBlcnNvbmFsaXR5TG9hZCgpOycA0/Cr+g6ZfxFhYkJhc2VTaGFkb3dDb2xvcgIEANPwq/oOuIABBWJsYWNrJwDT8Kv6Dpl/EGFiQmFzZUxhYmVsQ29sb3ICBADT8Kv6Dr6AAQVibGFjaycA0/Cr+g6ZfwptYXBPcHRpb25zAgQA0/Cr+g7EgAGeB/Cfp6xbDQogICAgew0KICAgICAgICAibmFtZSI6ICAic2F0ZWxsaXRlIiwNCiAgICAgICAgImlkIjogInNhdGVsbGl0ZSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImh5YnJpZCIsDQogICAgICAgICJpZCI6ICJoeWJyaWQiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJvY2VhbnMiLA0KICAgICAgICAiaWQiOiAib2NlYW5zIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAib3BlbiBzdHJlZXQgbWFwIiwNCiAgICAgICAgImlkIjogIm9zbSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInRlcnJhaW4iLA0KICAgICAgICAiaWQiOiAidGVycmFpbiINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImRhcmsgZ3JheSBjYW52YXMiLA0KICAgICAgICAiaWQiOiAiZGFyay1ncmF5Ig0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiZ3JheSBjYW52YXMiLA0KICAgICAgICAiaWQiOiAiZ3JheSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKGRhcmspIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtbmlnaHQtdmVjdG9yIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAobmF2aWdhdGlvbikiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1uYXZpZ2F0aW9uLXZlY3RvciINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInRvcG9ncmFwaGljIiwNCiAgICAgICAgImlkIjogInRvcG8iDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChyZWxpZWYpIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtcmVsaWVmLXZlY3RvciINCiAgICB9DQpdJwDT8Kv6Dpl/FHNob3dBQkJhc2VtYXBPcHRpb25zAgQA0/Cr+g7hhwHEBUBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KDQpzaG91dCgiYWJNZW51UmVmcmVzaCIpOw0KY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9ICdhYkJhc2VtYXBPcHRpb25zTWVudSc7DQoNCmZvciAoY29uc3Qgb3B0aW9uIG9mIHRhZ3MubWFwT3B0aW9ucykgew0KICAgIGlmIChvcHRpb24uaWQgPT0gbWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCkgew0KICAgICAgICBjb250aW51ZTsNCiAgICB9DQogICAgY29uc3Qgb3B0aW9uT2JqID0gDQogICAgew0KICAgICAgICBhYkJhc2VtYXBPcHRpb25zTWVudTogdHJ1ZSwNCiAgICAgICAgY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudTogYEBkZXN0cm95KHRoaXNCb3QpO2AsDQogICAgICAgIG1hcElEOiBvcHRpb24uaWQsDQogICAgICAgIGxhYmVsOiBvcHRpb24ubmFtZSwNCiAgICAgICAgb25DbGljazogYEANCiAgICAgICAgICAgIG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLm1hcElEOw0KICAgICAgICAgICAgc2hvdXQoJ2FiUGVyc29uYWxpdHlDaGFuZ2UnLCB7IGFiTWFwUG9ydGFsQmFzZTogdGFncy5tYXBJRH0pOyANCiAgICAgICAgICAgIHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQogICAgICAgIGANCiAgICB9DQoNCiAgICBhYi5saW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihvcHRpb25PYmopOw0KfScA0/Cr+g6ZfwtvbkdyaWRDbGljawIEANPwq/oOpo0BJkBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KJwDT8Kv6Dpl/BWRlYnVnAgQA0/Cr+g7NjQEFZmFsc2UnANPwq/oOmX8TYWJQZXJzb25hbGl0eUNoYW5nZQIEANPwq/oO040BzAZAaWYgKCF0aGF0KSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IGNoYW5nZWRUYWdzID0gW107Cgpmb3IgKGNvbnN0IGtleSBpbiB0aGF0KSB7CiAgICBpZiAodGFncy5hYlBlcnNvbmFsaXR5VGFncy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgaWYgKG1hc2tzW2tleV0gIT09IHRoYXRba2V5XSkgewogICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIGtleSwgdGhhdFtrZXldLCAnbG9jYWwnKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNoYW5nZWQgJyR7a2V5fScgdG86YCwgc2VsZi5zdHJ1Y3R1cmVkQ2xvbmUodGhhdFtrZXldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghY2hhbmdlZFRhZ3MuaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICAgICAgY2hhbmdlZFRhZ3MucHVzaChrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWcuc3lzdGVtfS4ke3RhZ05hbWV9XSAnJHtrZXl9JyBpcyBub3QgYSB2YWxpZCBhYiBwZXJzb25hbGl0eSB0YWcuYCk7CiAgICB9Cn0KCmlmIChjaGFuZ2VkVGFncy5sZW5ndGggPiAwKSB7CiAgICB0aGlzQm90LnZhcnMuaGFzVW5zYXZlZENoYW5nZXMgPSB0cnVlOwogICAgc2hvdXQoJ29uQUJQZXJzb25hbGl0eUNoYW5nZWQnLCB7IGJvdDogdGhpc0JvdCwgdGFnczogY2hhbmdlZFRhZ3MgfSk7CgogICAgaWYgKHRhZ3MuYXV0b3NhdmUpIHsKICAgICAgICB0aGlzQm90LmFiUGVyc29uYWxpdHlTYXZlKCk7CiAgICB9Cn0KJwDT8Kv6Dpl/EmFiUGVyc29uYWxpdHlSZXNldAIEANPwq/oOoJQBvwhAaWYgKHRoaXNCb3QudmFycy5yZXNldHRpbmcpIHsKICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLnJlc2V0dGluZyA9IHRydWU7CgppZiAoIWF1dGhCb3QpIHsKICAgIHRyeSB7IAogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CiAgICB9IGNhdGNoIHsKICAgICAgICB0aGlzQm90LnZhcnMucmVzZXR0aW5nID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgfQp9CgppZiAoIWxpbmtzLnJlbWVtYmVyKSB7CiAgICB0aGlzQm90LnZhcnMucmVzZXR0aW5nID0gZmFsc2U7CiAgICByZXR1cm47Cn0KCi8vIENsZWFyIGFueSBsb2FkZWQgdGFncy4KY2xlYXJUYWdNYXNrcyh0aGlzQm90LCAnbG9jYWwnKTsKCmlmIChhdXRoQm90KSB7CiAgICAvLyBTYXZlIGFuIGVtcHR5IG9iamVjdCB0byB0aGUgdXNlcidzIHJlY29yZC4KICAgIGxldCByZWNvcmRSZXNwb25zZSA9IGF3YWl0IG9zLnJlY29yZERhdGEoYXV0aEJvdC5pZCwgJ2FiUGVyc29uYWxpdHlDb25maWcnLCB7fSk7CgogICAgaWYgKCFyZWNvcmRSZXNwb25zZS5zdWNjZXNzKSB7CiAgICAgICAgaWYgKHJlY29yZFJlc3BvbnNlLmVycm9yQ29kZSA9PT0gJ25vdF9hdXRob3JpemVkJykgewogICAgICAgICAgICAvLyBBc2sgdXNlciB0byBncmFudCBwZXJtaXNzaW9uOwogICAgICAgICAgICBjb25zdCBwZXJtaXNzaW9uID0gYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGF1dGhCb3QuaWQpOwoKICAgICAgICAgICAgaWYgKHBlcm1pc3Npb24uc3VjY2VzcykgewogICAgICAgICAgICAgICAgcmVjb3JkUmVzcG9uc2UgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICdhYlBlcnNvbmFsaXR5Q29uZmlnJywge30pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBSZWxvYWQgdGhlIHBlcnNvbmFsaXR5LiBXaXRoIHRoZSB1c2VyIHBlcnNvbmFsaXR5IGVyYXNlZCwgdGhpcyB3aWxsIGVmZmVjdGl2ZWx5IGxvYWQgYWxsIHRoZSBkZWZhdWx0cyBmcm9tIGFiQ29uZmlnLgphd2FpdCB0aGlzQm90LmFiUGVyc29uYWxpdHlMb2FkKCk7Cgp0aGlzQm90LnZhcnMucmVzZXR0aW5nID0gZmFsc2U7JwDT8Kv6Dpl/EWFiUGVyc29uYWxpdHlTYXZlAgQA0/Cr+g7gnAGFC0BpZiAodGhpc0JvdC52YXJzLnNhdmluZykgewogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMuc2F2aW5nID0gdHJ1ZTsKCmlmICghYXV0aEJvdCkgewogICAgdHJ5IHsgCiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKICAgIH0gY2F0Y2ggewogICAgICAgIHRoaXNCb3QudmFycy5zYXZpbmcgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vIFNhdmUgYWxsIHRoZSBjdXJyZW50IGFiIHBlcnNvbmFsaXR5IHRhZ3MgdG8gdGhlIHVzZXIncyByZWNvcmQuCmNvbnN0IHVzZXJQZXJzb25hbGl0eSA9IHt9OwoKZm9yIChjb25zdCB0YWdOYW1lIG9mIHRhZ3MuYWJQZXJzb25hbGl0eVRhZ3MpIHsKICAgIGlmICh0YWdzW3RhZ05hbWVdICE9IG51bGwpIHsKICAgICAgICB1c2VyUGVyc29uYWxpdHlbdGFnTmFtZV0gPSB0YWdzW3RhZ05hbWVdOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzYXZpbmcgdXNlciBwZXJzb25hbGl0eTpgLCBzZWxmLnN0cnVjdHVyZWRDbG9uZSh1c2VyUGVyc29uYWxpdHkpKTsKfQoKbGV0IHJlY29yZFJlc3BvbnNlID0gYXdhaXQgb3MucmVjb3JkRGF0YShhdXRoQm90LmlkLCAnYWJQZXJzb25hbGl0eUNvbmZpZycsIHVzZXJQZXJzb25hbGl0eSk7CgppZiAoIXJlY29yZFJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgIGlmIChyZWNvcmRSZXNwb25zZS5lcnJvckNvZGUgPT09ICdub3RfYXV0aG9yaXplZCcpIHsKICAgICAgICAvLyBBc2sgdXNlciB0byBncmFudCBwZXJtaXNzaW9uOwogICAgICAgIGNvbnN0IHBlcm1pc3Npb24gPSBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oYXV0aEJvdC5pZCk7CgogICAgICAgIGlmIChwZXJtaXNzaW9uLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgcmVjb3JkUmVzcG9uc2UgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICdhYlBlcnNvbmFsaXR5Q29uZmlnJywgdXNlclBlcnNvbmFsaXR5KTsKICAgICAgICB9CiAgICB9Cn0KCmlmIChyZWNvcmRSZXNwb25zZS5zdWNjZXNzKSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGB1cGRhdGVkIHBlcnNvbmFsaXR5IGNvbmZpZyBpbiB1c2VyIHJlY29yZGAsIGxvZ1R5cGU6ICdsb2cnfSk7Cn0gZWxzZSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmYWlsZWQgdG8gdXBkYXRlIHBlcnNvbmFsaXR5IGNvbmZpZyBpbiB1c2VyIHJlY29yZC5cbiR7SlNPTi5zdHJpbmdpZnkocmVjb3JkUmVzcG9uc2UsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwp9Cgp0aGlzQm90LnZhcnMuc2F2aW5nID0gZmFsc2U7CnRoaXNCb3QudmFycy5oYXNVbnNhdmVkQ2hhbmdlcyA9IGZhbHNlOycA0/Cr+g6ZfxFhYlBlcnNvbmFsaXR5TG9hZAIEANPwq/oO5qcBziBAaWYgKHRoaXNCb3QudmFycy5sb2FkaW5nKSB7CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5sb2FkaW5nID0gdHJ1ZTsKCmlmICghYXV0aEJvdCkgewogICAgdHJ5IHsgCiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKICAgIH0gY2F0Y2ggewogICAgICAgIHRoaXNCb3QudmFycy5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgfQp9CgppZiAoIWxpbmtzLnJlbWVtYmVyKSB7CiAgICB0aGlzQm90LnZhcnMubG9hZGluZyA9IGZhbHNlOwogICAgcmV0dXJuOwp9CgovLyBSZXRyaWV2ZSBwZXJzb25hbGl0eSBjb25maWcgZnJvbSB1c2VyJ3MgcmVjb3JkLgpsZXQgdXNlclBlcnNvbmFsaXR5RGF0YSA9IHt9OwoKaWYgKGF1dGhCb3QpIHsKICAgIGNvbnN0IGdldERhdGFSZXNwb25zZSA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdC5pZCwgJ2FiUGVyc29uYWxpdHlDb25maWcnKTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2V0RGF0YVJlc3BvbnNlOmAsIHNlbGYuc3RydWN0dXJlZENsb25lKGdldERhdGFSZXNwb25zZSkpOwogICAgfQoKICAgIGlmIChnZXREYXRhUmVzcG9uc2Uuc3VjY2VzcykgewogICAgICAgIHVzZXJQZXJzb25hbGl0eURhdGEgPSBnZXREYXRhUmVzcG9uc2UuZGF0YTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGdldERhdGFSZXNwb25zZS5lcnJvckNvZGUgIT09ICdkYXRhX25vdF9mb3VuZCcpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiUGVyc29uYWxpdHlDb25maWcgZ2V0IGVycm9yOmAsIHsgZXJyb3JDb2RlOiBnZXREYXRhUmVzcG9uc2UuZXJyb3JDb2RlLCBlcnJvck1lc3NhZ2U6IGdldERhdGFSZXNwb25zZS5lcnJvck1lc3NhZ2UgfSk7CiAgICAgICAgICAgIHRoaXNCb3QudmFycy5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9Cn0KCi8vIENsZWFyIGFueSBwcmV2aW91c2x5IGxvYWRlZCB0YWdzLgpjbGVhclRhZ01hc2tzKHRoaXNCb3QpOwoKLy8gUnlhbiAoQXVnIDI5LCAyMDI1KTogaW0gbm90IHN1cmUgZXhhY3RseSB3aGF0IGlzIGhhcHBlbmluZyBoZXJlIGJ1dCB3aXRob3V0IHNsZWVwaW5nIG9uIHRoZXNlIGJpZyB0YWcgbWFzayBjaGFuZ2VzLCB0aGV5IGRvbnQgYWxsIHNlZW0gdG8gY29tZSBpbiBwcm9wZXJseS4KYXdhaXQgb3Muc2xlZXAoMTAwKTsKCi8vIExvYWQgdGFncyBmcm9tIGVpdGhlciB0aGUgdXNlcidzIHBlcnNvbmFsaXR5IGNvbmZpZyAoaWYgYXZhaWxhYmxlKSBvciBsb2FkIGEgZGVmYXVsdCBmcm9tIHRoZSBhYkNvbmZpZy4KZm9yIChjb25zdCB0YWdOYW1lIG9mIHRhZ3MuYWJQZXJzb25hbGl0eVRhZ3MpIHsKICAgIGlmICh1c2VyUGVyc29uYWxpdHlEYXRhW3RhZ05hbWVdICE9IG51bGwpIHsKICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIHRhZ05hbWUsIHVzZXJQZXJzb25hbGl0eURhdGFbdGFnTmFtZV0sICdsb2NhbCcpOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvYWRlZCAnJHt0YWdOYW1lfScgZnJvbSB1c2VyIHBlcnNvbmFsaXR5IGRhdGE6YCwgc2VsZi5zdHJ1Y3R1cmVkQ2xvbmUodXNlclBlcnNvbmFsaXR5RGF0YVt0YWdOYW1lXSkpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAobGlua3MucmVtZW1iZXIudGFnc1t0YWdOYW1lXSAhPSBudWxsKSB7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCB0YWdOYW1lLCBsaW5rcy5yZW1lbWJlci50YWdzW3RhZ05hbWVdLCAnbG9jYWwnKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb2FkZWQgJyR7dGFnTmFtZX0nIGZyb20gYWIgY29uZmlnOmAsIHNlbGYuc3RydWN0dXJlZENsb25lKGxpbmtzLnJlbWVtYmVyLnRhZ3NbdGFnTmFtZV0pKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmICh0YWdOYW1lID09PSAnYWJCYXNlR3JpZFBvcnRhbENvbG9yJykgewogICAgICAgIGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxDb2xvciA9IHRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yOwogICAgfSBlbHNlIGlmICh0YWdOYW1lID09PSAnYWJNYXBQb3J0YWxCYXNlJykgewogICAgICAgIG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLmFiTWFwUG9ydGFsQmFzZTsKICAgICAgICBtaW5pTWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCA9IHRhZ3MuYWJNYXBQb3J0YWxCYXNlOwogICAgfSBlbHNlIGlmICh0YWdOYW1lID09PSAnYWJQcmVmZXJyZWRBSU1vZGVsJykgewogICAgICAgIC8vIENoZWNrIHRoYXQgdGhpcyBhaSBtb2RlbCBpcyBzdGlsbCBhdmFpbGFibGUuCiAgICAgICAgY29uc3QgZGVzaXJlZE1vZGVsID0gdGFncy5hYlByZWZlcnJlZEFJTW9kZWw7CiAgICAgICAgY29uc3QgYWlDaGF0TW9kZWxzID0gY29uZmlnQm90LnRhZ3MuYWlDaGF0TW9kZWxzID8/IChhd2FpdCBhaS5saXN0Q2hhdE1vZGVscygpKTsKICAgICAgICBsZXQgZm91bmQgPSBkZXNpcmVkTW9kZWwgJiYgYWlDaGF0TW9kZWxzLnNvbWUoZSA9PiBlLm5hbWUgPT09IGRlc2lyZWRNb2RlbCk7CgogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgLy8gVGhlIGFiUHJlZmVycmVkQUlNb2RlbCBpcyBub3QgYXZhaWxhYmxlLiBUcnkgZmFsbGluZyBiYWNrIHRvIGFiQ29uZmlnIGRlZmF1bHQuCiAgICAgICAgICAgIGZvdW5kID0gbGlua3MucmVtZW1iZXIudGFncy5hYlByZWZlcnJlZEFJTW9kZWwgJiYgYWlDaGF0TW9kZWxzLnNvbWUoZSA9PiBlLm5hbWUgPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJQcmVmZXJyZWRBSU1vZGVsKTsKICAgICAgICAgICAgaWYgKGZvdW5kKSB7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdhYlByZWZlcnJlZEFJTW9kZWwnLCBsaW5rcy5yZW1lbWJlci50YWdzLmFiUHJlZmVycmVkQUlNb2RlbCwgJ2xvY2FsJyk7CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiUHJlZmVycmVkQUlNb2RlbCAnJHtkZXNpcmVkTW9kZWx9JyBpcyBub3QgYXZhaWxhYmxlLCBmYWxsaW5nIGJhY2sgdG8gYWJDb25maWcgZGVmYXVsdCAnJHtsaW5rcy5yZW1lbWJlci50YWdzLmFiUHJlZmVycmVkQUlNb2RlbH0nYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgYWJDb25maWcgZGVmYXVsdCBmb3IgYWJQcmVmZXJyZWRBSU1vZGVsIGlzIG5vdCBhdmFpbGFibGUuIEZhbGxiYWNrIHRvIHRoZSBDYXN1YWxPUyBkZWZhdWx0LgogICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdE1vZGVsID0gYWlDaGF0TW9kZWxzLmZpbmQoZSA9PiBlLmlzRGVmYXVsdCkubmFtZTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2FiUHJlZmVycmVkQUlNb2RlbCcsIGRlZmF1bHRNb2RlbCwgJ2xvY2FsJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYlByZWZlcnJlZEFJTW9kZWwgJyR7ZGVzaXJlZE1vZGVsfScgaXMgbm90IGF2YWlsYWJsZSwgZmFsbGluZyBiYWNrIHRvIENhc3VhbE9TIGRlZmF1bHQgJyR7ZGVmYXVsdE1vZGVsfSdgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICB9Cn0KCi8vIFJ5YW4gKEF1ZyAyOSwgMjAyNSk6IGltIG5vdCBzdXJlIGV4YWN0bHkgd2hhdCBpcyBoYXBwZW5pbmcgaGVyZSBidXQgd2l0aG91dCBzbGVlcGluZyBvbiB0aGVzZSBiaWcgdGFnIG1hc2sgY2hhbmdlcywgdGhleSBkb250IGFsbCBzZWVtIHRvIGNvbWUgaW4gcHJvcGVybHkuCmF3YWl0IG9zLnNsZWVwKDEwMCk7Cgp0aGlzQm90LnZhcnMubG9hZGluZyA9IGZhbHNlOwpzaG91dCgnb25BQlBlcnNvbmFsaXR5TG9hZGVkJywgeyBib3Q6IHRoaXNCb3QgfSk7JwDT8Kv6Dpl/EWFiUGVyc29uYWxpdHlUYWdzAgQA0/Cr+g61yAHKAvCfp6xbCiAgICAiYWJCYXNlQ29sb3IiLAogICAgImFiQmFzZUxhYmVsQ29sb3IiLAogICAgImFiQmFzZU1lbnVDb2xvciIsCiAgICAiYWJCYXNlTWVudUxhYmVsQ29sb3IiLAogICAgImFiQmFzZVNoYWRvd0NvbG9yIiwKICAgICJhYkJhc2VTdHJva2VDb2xvciIsCiAgICAiYWJCbHVlcHJpbnRDb2xvciIsCiAgICAiYWJCdWlsZGVySWRlbnRpdHkiLAogICAgImFiQmFzZUdyaWRQb3J0YWxDb2xvciIsCiAgICAiYWJQcmVmZXJyZWRBSU1vZGVsIiwKICAgICJhYkNhdGFsb2dOYW1lIiwKICAgICJhYk1hcFBvcnRhbEJhc2UiLAogICAgImFiQWx3YXlzQXBwcm92ZVBhdGNoQm90cyIKXScA0/Cr+g6ZfwhhdXRvc2F2ZQIEANPwq/oO/soBBHRydWUnANPwq/oOmX8YYWJBbHdheXNBcHByb3ZlUGF0Y2hCb3RzAgQA0/Cr+g6DywEFZmFsc2UnAQRib3RzJGI5YjgyODE5LTFmMTQtNDM5Mi04OGE5LTUyZjY3YTlmOGU1NQEnANPwq/oOicsBBnN5c3RlbQIEANPwq/oOissBGGFiLnBlcnNvbmFsaXR5LmFybV9udWRnZScA0/Cr+g6JywENb25BQkFybVBsYWNlZAIEANPwq/oOo8sBOEBzZXRUYWdNYXNrKHRoaXNCb3QsICdoYXNBcm1CZWVuUGxhY2VkJywgdHJ1ZSwgJ2xvY2FsJyk7JwDT8Kv6DonLAQlvbkFCQXdha2UCBADT8Kv6DtzLATBAYXdhaXQgb3Muc2xlZXAoMjUwKTsKdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnANPwq/oOicsBCGFiSWdub3JlAgQA0/Cr+g6NzAEEdHJ1ZScA0/Cr+g6JywENYWJQZXJzb25hbGl0eQIEANPwq/oOkswBBHRydWUnANPwq/oOicsBBGZvcm0CBADT8Kv6DpfMAQdub3RoaW5nJwDT8Kv6DonLAQVsZWFybgIEANPwq/oOn8wBKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnANPwq/oOicsBDW1hbmlmZXN0YXRpb24CBADT8Kv6DsbMASjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDT8Kv6DonLAQhyZW1lbWJlcgIEANPwq/oO7cwBKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnANPwq/oOicsBBWRlYnVnAgQA0/Cr+g6UzQEFZmFsc2UnANPwq/oOicsBDmFybU51ZGdlV2FpdE1TAgQA0/Cr+g6azQEENTAwMCcA0/Cr+g6JywEPb25BQkluaXRpYWxpemVkAgQA0/Cr+g6fzQEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwDT8Kv6DonLAQ9hYlN0YXJ0QXJtTnVkZ2UCBADT8Kv6DrvNAYIfQGlmICh0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGVyZSBpcyBhbHJlYWR5IGEgbnVkZ2UgaW4gcHJvZ3Jlc3MuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSA9IHRydWU7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdGFydGluZyBudWRnZS4uLmApCn0KCmZ1bmN0aW9uIGNhbk51ZGdlKCk6IGJvb2xlYW4gewogICAgLy8gQ2FuJ3QgaGF2ZSBwbGFjZWQgdGhlIGFybSBhbHJlYWR5LgogICAgaWYgKHRhZ3MuaGFzQXJtQmVlblBsYWNlZCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBhcm0gcGxhY2VtZW50IGhhcyBhbHJlYWR5IG9jY3VyZWQuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBBQiBtYW5pZmVzdGF0aW9uIGJvdCBtdXN0IGJlIGFjdGl2ZS4KICAgIGlmICghbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBhYiBtYW5pZmVzdGF0aW9uIGJvdCBpcyBpbmFjdGl2ZS5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEFCIGNoYXQgYmFyIG11c3QgYmUgY2xvc2VkLgogICAgaWYgKGxpbmtzLmlucHV0Lm1hc2tzLmNoYXRPcGVuKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFiIGNoYXQgYmFyIGlzIG9wZW4uYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBUaGUgaW5zdCBtdXN0IGJlIGVtcHR5IG9mIGFsbCBib3RzLiBUaGUgZXhjZXB0aW9ucyBhcmUgYWIgYm90cyBhbmQgYnVpbHQtaW4gYm90cy4KICAgIGNvbnN0IHVzZXJNYWRlQm90ID0gZ2V0Qm90KChiKSA9PiB7CiAgICAgICAgcmV0dXJuICFiLnRhZ3Muc3lzdGVtPy5zdGFydHNXaXRoKCdhYi4nKSAmJgogICAgICAgICAgICAgICAgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYKICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJFZ2cgJiYgLy8gRG9uJ3QgaW5jbHVkZSBhYkVnZyBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgICAgICAgICAgICAgIWIudGFncy5hYkxvYWRlZFNraWxsICYmIC8vIERvbid0IGluY2x1ZGUgbG9hZGVkIHNraWxsIGJvdHMgYXMgInVzZXIgbWFkZSIuCiAgICAgICAgICAgICAgICAhYi50YWdzLmFiQm90IC8vIERvbid0IGluY2x1ZGUgYW55IGJvdHMgdGhhdCBhcmUgZmxhZ2dlZCB3aXRoIGFuIGFiQm90IHRhZy4KICAgIH0pCiAgICAKICAgIGlmICh1c2VyTWFkZUJvdCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnVXNlck1hZGVCb3RzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB1c2VyTWFkZUJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFiLnRhZ3Muc3lzdGVtPy5zdGFydHNXaXRoKCdhYi4nKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJFZ2cgLy8gRG9uJ3QgaW5jbHVkZSBhYkVnZyBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBpbnN0IGNvbnRhaW5zIHVzZXIgbWFkZSBib3RzLmAsIHVzZXJNYWRlQm90cyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogaW5zdCBjb250YWlucyB1c2VyIG1hZGUgYm90cy5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gTWVudSBwb3J0YWwgbXVzdCBlaXRoZXIgYmUgaW5hY3RpdmUgb3Igbm90IGhhdmUgYW55IGJvdHMgaW4gdGhlIGN1cnJlbnRseSBhY3RpdmUgbWVudSBwb3J0YWwuCiAgICBpZiAoY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGNvbnN0IGJvdEluTWVudVBvcnRhbCA9IGdldEJvdCgoYikgPT4gewogICAgICAgICAgICByZXR1cm4gYi50YWdzW2NvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWxdID09PSB0cnVlCiAgICAgICAgfSk7CgogICAgICAgIGlmIChib3RJbk1lbnVQb3J0YWwpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBvcGVuIGFuZCBoYXMgYm90cyBpbiBpdC5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwp9CgppZiAoY2FuTnVkZ2UoKSkgewogICAgLy8gU3RhcnQgbnVkZ2UgZm9yIGFybSBwbGFjZW1lbnQuCiAgICBhd2FpdCBvcy5zbGVlcCh0YWdzLmFybU51ZGdlV2FpdE1TKTsKCiAgICBpZiAoY2FuTnVkZ2UoKSkgewogICAgICAgIGNvbnN0IGFiUG9zaXRpb25YID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdC50YWdzW2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gKyAnWCddOwogICAgICAgIGNvbnN0IGFiUG9zaXRpb25ZID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdC50YWdzW2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gKyAnWSddOwoKICAgICAgICBjb25zdCBncmlkQ2xpY2tQYXJhbXMgPSB7CiAgICAgICAgICAgIGRpbWVuc2lvbjogbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiwKICAgICAgICAgICAgcG9zaXRpb246IHsgeDogYWJQb3NpdGlvblggKyA1LCB5OiBhYlBvc2l0aW9uWSB9LAogICAgICAgICAgICBmb3JjZUFybVBsYWNlbWVudDogdHJ1ZSwKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwgPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24pIHsKICAgICAgICAgICAgLy8gTWFwIHBvcnRhbCBpcyBpbiBkaWZmZXJlbnQgY29vcmRpbmF0ZSBzcGFjZSBhbmQgc2NhbGUuCiAgICAgICAgICAgIGdyaWRDbGlja1BhcmFtcy5wb3NpdGlvbi54ID0gYWJQb3NpdGlvblggKyAwLjAwMDM1NzQzNDA2ODQwNTM4MjM7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdoaXNwZXJpbmcgb25HcmlkQ2xpY2sgdG8gdGhlIGFiIG1hbmlmZXN0YXRpb24gYm90IHdpdGggdGhlIHBhcmFtczpgLCBncmlkQ2xpY2tQYXJhbXMpCiAgICAgICAgfQoKICAgICAgICAvLyBGb3JjZSBhYiBhcm0gcGxhY2VtZW50IHVzaW5nIHRoZSBvbkdyaWRDbGljayBsaXN0ZW5lciBvZiB0aGUgbWFuaWZlc3RhdGlvbiBib3QuCiAgICAgICAgd2hpc3BlcihsaW5rcy5tYW5pZmVzdGF0aW9uLCAnb25HcmlkQ2xpY2snLCBncmlkQ2xpY2tQYXJhbXMpOwogICAgfQp9Cgp0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUgPSBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRvbmVgKTsKfScA0/Cr+g6JywEQb25BQkNoYXRCYXJDbG9zZQIEANPwq/oOvuwBG0B0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycA0/Cr+g6JywEFaW5wdXQCBADT8Kv6DtrsASjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDT8Kv6DonLAQlhYlZlcnNpb24CBADT8Kv6DoHtAQUxMC40MCcA0/Cr+g6JywEPb25Qb3J0YWxDaGFuZ2VkAgQA0/Cr+g6H7QGFAUBjb25zdCB7IHBvcnRhbCwgZGltZW5zaW9uIH0gPSB0aGF0OwoKaWYgKHBvcnRhbCA9PT0gJ21lbnVQb3J0YWwnKSB7CiAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgIHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7CiAgICB9Cn0nANPwq/oOicsBDWFiTWVudVJlZnJlc2gCBADT8Kv6Do3uARtAdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnANPwq/oOicsBEWRlYnVnVXNlck1hZGVCb3RzAgQA0/Cr+g6p7gEFZmFsc2UnAQRib3RzJGRjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZAEnANPwq/oOr+4BBnN5c3RlbQIEANPwq/oOsO4BHGFiLnBlcnNvbmFsaXR5Lm1hbmlmZXN0YXRpb24nANPwq/oOr+4BBGZvcm0CBADT8Kv6Ds3uAQdub3RoaW5nJwDT8Kv6Dq/uAQtkZXNjcmlwdGlvbgIEANPwq/oO1e4BOFRoaXMgc2tpbGwgY29udHJvbHMgdGhlIGFjdHVhbCBib3QgZm9yIHRoZSBhYiBpbnRlcmZhY2UuJwDT8Kv6Dq/uAQVsZWFybgIEANPwq/oOju8BKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnANPwq/oOr+4BD29uUG9ydGFsQ2hhbmdlZAIEANPwq/oOte8BpElAY29uc3QgUE9SVEFMU19USEFUX0hJREUgPSBuZXcgU2V0KFsKICAgICJzeXN0ZW1Qb3J0YWwiLAogICAgInNoZWV0UG9ydGFsIgpdKQoKY29uc3QgUE9SVEFMU19USEFUX01BTklGRVNUID0gbmV3IFNldChbCiAgICAiZ3JpZFBvcnRhbCIsCiAgICAibWFwUG9ydGFsIgpdKTsKCmNvbnN0IE1BUF9MT0FEX1dBSVRfVElNRSA9IDEwMDA7Cgpmb3IgKGNvbnN0IHBvcnRhbCBvZiBQT1JUQUxTX1RIQVRfSElERSkgewogICAgaWYgKGNvbmZpZ0JvdC50YWdzW3BvcnRhbF0gIT0gbnVsbCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYSBwb3J0YWwgdGhhdCBoaWRlcyBhYiBpcyBvcGVuIC0gaGlkaW5nIGFiQm90IGFuZCBpZ25vcmluZy5gKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmFiQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3MuYWJCb3QpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgppZiAoY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgIT0gbnVsbCB8fCBjb25maWdCb3QudGFncy5zeXN0ZW1Qb3J0YWwgIT0gbnVsbCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoZWV0IHBvcnRhbCBvciBzeXN0ZW0gcG9ydGFsIG9wZW5lZCAtIGhpZGluZyBhYkJvdCBhbmQgaWdub3JpbmcuYCk7CiAgICB9CgogICAgaWYgKHRhZ3MuYWJCb3QpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKICAgIH0KCiAgICByZXR1cm47Cn0KCmlmICghdGFncy5hYkF3YWtlKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWIgaXMgbm90IGF3YWtlIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAidGFnUG9ydGFsIikgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRhZ1BvcnRhbCBjaGFuZ2VkIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAibWVudVBvcnRhbCIpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtZW51UG9ydGFsIGNoYW5nZWQgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRoYXQucG9ydGFsID09ICJncmlkUG9ydGFsIiAmJiBjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBncmlkUG9ydGFsIGNoYW5nZWQsIGJ1dCBhbHNvIGFscmVhZHkgaW4gdGhlIG1hcFBvcnRhbCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBUaGUgbWFwIHBvcnRhbCBpcyB0b3VnaC4gSXQgc2VlbXMgdG8gdmFyeSBpbiBsb2FkaW5nIHNwZWVkIG9uCi8vIHZhcmlvdXMgaGFyZHdhcmUgYW5kIG5ldHdvcmtzIGFuZCBoYXMgYnkgdGhlIHRpbWUgb25Qb3J0YWxDaGFuZ2VkIGlzIGNhbGxlZCBpdCBkb2VzbnQKLy8gc2VlbSBndWFyZW50ZWVkIHRvIGJlIGFjdHVhbGx5IHJlYWR5LiBBZGRpbmcgYSBoYXJkY29kZWQgd2FpdCB0aW1lIHRvIGdpdmUgdGhlIHBvcnRhbCBzcGFjZSB0byBnZXQKLy8gdGhlIG1hcCBwb3J0YWwgZnVsbHkgbG9hZGVkIGJlZm9yZSBjb250aW51aW5nIHdpdGggbWFuaWZlc3RpbmcgYWIuCi8vCi8vIEF0IHNvbWUgcG9pbnQgdGhpcyBjYW4gZ28gYXdheSBpZiB3ZSBldmVyIGdldCBhIHNob3V0IG9yIHNvbWUgb3RoZXIgZ2F1cmVudGVlIHRoYXQgdGhlIG1hcCBwb3J0YWwgaXMgbG9hZGVkL3JlYWR5LgppZiAodGhhdC5wb3J0YWwgPT09ICdtYXBQb3J0YWwnKSB7CiAgICBpZiAodGhhdC5kaW1lbnNpb24pIHsKICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgJiYgIXRoaXNCb3QudmFycy5tYXBQb3J0YWxJbml0aWFsTG9hZGVkKSB7CiAgICAgICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gb3Muc2xlZXAoTUFQX0xPQURfV0FJVF9USU1FKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3YWl0aW5nIGZvciBtYXAgcG9ydGFsIHRvIGZpbmlzaCBsb2FkaW5nOiAke01BUF9MT0FEX1dBSVRfVElNRX1tc2ApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlci50aGVuKCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbEluaXRpYWxMb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXAgcG9ydGFsIGxvYWRlZC5gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIC8vIGF3YWl0IHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyOwogICAgICAgICAgICAvLyB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CiAgICAgICAgICAgIC8vIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcCBwb3J0YWwgaXMgYWxyZWFkeSBsb2FkZWQuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSBmYWxzZTsKICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFwIHBvcnRhbCBoYXMgYmVlbiB1bmxvYWRlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIFN0YXJ0IGNoZWNrcyBmb3IgaWYvd2hlcmUgd2UgbmVlZCB0byBtYW5pZmVzdCBhYi4KbGV0IG5ld0FCID0gZmFsc2U7CmxldCBuZXdBQlBvcnRhbDsKbGV0IG5ld0FCUG9zaXRpb247CmxldCBmb2N1c0NhbWVyYSA9IHRydWU7CmxldCBmb2N1c0NhbWVyYVN0YXJ0Wm9vbTsKCmlmIChQT1JUQUxTX1RIQVRfTUFOSUZFU1QuaGFzKHRoYXQucG9ydGFsKSAmJiB0aGF0LmRpbWVuc2lvbikgewogICAgLy8gQSBwb3J0YWwgdGhhdCBtYW5pZmVzdHMgYWIgaGFzIGp1c3QgY2hhbmdlZCBkaW1lbnNpb24uCiAgICAvLyBNYW5pZmVzdCBhYiBpbiB0aGUgbmV3IGRpbWVuc2lvbi4KICAgIGlmICh0aGF0LnBvcnRhbCA9PSAibWFwUG9ydGFsIiB8fCB0aGF0LnBvcnRhbCA9PSAibWluaU1hcFBvcnRhbCIpIHs7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYW5pZmVzdGluZyBhYiBib3QgaW4gbWFwIHBvcnRhbCBkaW1lbnNpb24gJyR7dGhhdC5kaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCB0aGlzQm90LmdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICBuZXdBQlBvcnRhbCA9IHRoYXQucG9ydGFsOwogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgcG9zaXRpb246IG5ld0FCUG9zaXRpb24gfSk7CiAgICAgICAgZm9jdXNDYW1lcmFTdGFydFpvb20gPSBhd2FpdCB0aGlzQm90LmdldFN0YXJ0Q2FtZXJhWm9vbSgnbWFwJyk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hbmlmZXN0aW5nIGFiIGJvdCBkaW1lbnNpb24gJyR7dGhhdC5kaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCB0aGlzQm90LmdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdncmlkJyk7CiAgICAgICAgbmV3QUJQb3J0YWwgPSB0aGF0LnBvcnRhbDsKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwogICAgICAgIGZvY3VzQ2FtZXJhU3RhcnRab29tID0gYXdhaXQgdGhpc0JvdC5nZXRTdGFydENhbWVyYVpvb20oJ2dyaWQnKTsKICAgIH0KfSBlbHNlIGlmICgoUE9SVEFMU19USEFUX01BTklGRVNULmhhcyh0aGF0LnBvcnRhbCkgfHwgUE9SVEFMU19USEFUX0hJREUuaGFzKHRoYXQucG9ydGFsKSkgJiYgCiAgICAgICAgICAgIXRoYXQuZGltZW5zaW9uICYmIAogICAgICAgICAgIChjb25maWdCb3QudGFncy5ncmlkUG9ydGFsIHx8IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkKKSB7CiAgICAvLyBBIHBvcnRhbCB0aGF0IHR5cGljYWxseSBoaWRlcyBvciByZS1tYW5pZmVzdHMgYWIganVzdCBjbG9zZWQsIGJ1dCBlaXRoZXIgdGhlIGdyaWQgb3IgbWFwIHBvcnRhbCBhcmUgc3RpbGwgb3Blbi4KICAgIC8vIFN1bW1vbiBhYiBpbiBlaXRoZXIgdGhlIG1hcFBvcnRhbCBvciBncmlkUG9ydGFsLgogICAgbGV0IHN1bW1vbkRpbWVuc2lvbjsKCiAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICAgICAgc3VtbW9uRGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ21hcFBvcnRhbCc7CiAgICAgICAgCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10pIHsKICAgICAgICAgICAgLy8gVXNlIGxhc3Qga25vd24gcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IG1hcCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IHRoaXNCb3QuZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ21hcCcpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCkgewogICAgICAgIHN1bW1vbkRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CiAgICAgICAgbmV3QUJQb3J0YWwgPSAnZ3JpZFBvcnRhbCc7CgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddKSB7CiAgICAgICAgICAgIC8vIFVzZSBsYXN0IGtub3duIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gbGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVc2UgZGVmYXVsdCBncmlkIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgdGhpc0JvdC5nZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignZ3JpZCcpOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoc3VtbW9uRGltZW5zaW9uKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdW1tb25pbmcgYWIgYm90IGluICR7bmV3QUJQb3J0YWx9IGRpbWVuc2lvbiAnJHtzdW1tb25EaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiBzdW1tb25EaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwoKICAgICAgICBpZiAoUE9SVEFMU19USEFUX0hJREUuaGFzKHRoYXQucG9ydGFsKSkgewogICAgICAgICAgICAvLyBJZiB0aGUgcG9ydGFsIHRoYXQgY2xvc2VkIHdhcyBhIHBvcnRhbCB0aGF0IGhpZGVzIGFiLCB0aGVuIGRvbnQgcnVuIHRoZSBjYW1lcmEgZm9jdXMuCiAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBqdXN0IHVzZSB0aGUgcHJldmlvdXMgY2FtZXJhIHBvc2l0aW9uIGFscmVhZHkgc3RvcmVkIGluIG1lbW9yeS4KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2lsbCBub3QgZm9jdXMgY2FtZXJhIG9uIGFiIGJlY2F1c2Ugd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhlIHByZXZpb3VzIGNhbWVyYSBwb3NpdGlvbi5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb2N1c0NhbWVyYSA9IGZhbHNlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RoIHRoZSBtYXAgYW5kIGdyaWQgcG9ydGFsIGFyZSBib3RoIGNsb3NlZCwgY2Fubm90IHN1bW1vbiBhYiBpbiBlaXRoZXIuYCk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgcmV0dXJuOwp9CgppZiAoZm9jdXNDYW1lcmEgJiYgbGlua3MucmVtZW1iZXIudGFncy5tYXBQcmV2ZW50Rm9jdXMpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYW1lcmEgZm9jdXMgYW5pbWF0aW9uIGJlY2F1c2UgbWFwUHJldmVudEZvY3VzIGlzIHNldCB0byB0cnVlIG9uIHRoZSBhYiByZW1lbWJlciBib3QuYCk7CiAgICB9CgogICAgZm9jdXNDYW1lcmEgPSBmYWxzZTsKfQoKaWYgKG5ld0FCICYmIGZvY3VzQ2FtZXJhKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mbyAmJiAKICAgICAgICB0aGlzQm90LnZhcnMuYWN0aXZlRm9jdXNJbmZvLnBvcnRhbCA9PT0gdGhhdC5wb3J0YWwgJiYgCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5kaW1lbnNpb24gPT09IHRoYXQuZGltZW5zaW9uICYmCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5wb3NpdGlvbj8ueCA9PT0gbmV3QUJQb3NpdGlvbi54ICYmCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5wb3NpdGlvbj8ueSA9PT0gbmV3QUJQb3NpdGlvbi55CiAgICApIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraXBwaW5nIGNhbWVyYSBmb2N1cyBhbmltYXRpb24gYmVjYXVzZSBvbmUgaXMgYWxyZWFkeSBhY3RpdmUgd2l0aCB0aGUgc2FtZSBzZXR0aW5ncy5gKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzQm90LnZhcnMuYWN0aXZlRm9jdXNJbmZvID0geyAKICAgICAgICBwb3J0YWw6IHRoYXQucG9ydGFsLCAKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB7Li4ubmV3QUJQb3NpdGlvbn0sCiAgICB9OwoKICAgIGxldCB6b29tID0gdGFncy5kZWZhdWx0R3JpZFBvcnRhbFpvb207CgogICAgaWYgKG5ld0FCUG9ydGFsID09PSAnbWFwUG9ydGFsJyB8fCBuZXdBQlBvcnRhbCA9PT0gJ21pbmlNYXBQb3J0YWwnKSB7CiAgICAgICAgem9vbSA9IHRhZ3MuZGVmYXVsdE1hcFBvcnRhbFpvb207CiAgICB9CiAgICAKICAgIHRyeSB7CiAgICAgICAgaWYgKGZvY3VzQ2FtZXJhU3RhcnRab29tICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2V0IHN0YXJ0IHpvb20gb2YgJHtuZXdBQlBvcnRhbH0gdG8gJHtmb2N1c0NhbWVyYVN0YXJ0Wm9vbX0uYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlcikgewogICAgICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGF3YWl0IG9zLmZvY3VzT24obmV3QUJQb3NpdGlvbiwgeyB6b29tOiBmb2N1c0NhbWVyYVN0YXJ0Wm9vbSwgZHVyYXRpb246IDAsIHBvcnRhbDogbmV3QUJQb3J0YWwgfSk7CiAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDEwMDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb2N1cyBvbiAke0pTT04uc3RyaW5naWZ5KG5ld0FCUG9zaXRpb24pfSBpbiAke25ld0FCUG9ydGFsfSB3aXRoIHpvb20gJHt6b29tfS5gKTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFncy5hYkluaXRpYWxpemVkKSB7IAogICAgICAgICAgICAvLyBbUnlhbl0gUmVhbGx5IHdlaXJkIENhc3VhbE9TIGJ1ZyB0aGF0IGNhdXNlcyB0aGUgcG9ydGFsIGNhbWVyYSB0byBub3QgcmVzcGVjdCB6b29tIGxldmVsIGlmIHdlIGRvbnQgZG8gdGhpcy4KICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjUwKTsgCiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5mb2N1c09uKG5ld0FCUG9zaXRpb24sIHsgem9vbSwgcm90YXRpb246IHsgeDogNDUsIHk6IDQ1IH0sIHBvcnRhbDogbmV3QUJQb3J0YWwgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb2N1c09uIGVycm9yIG9jY3VyZWQ6YCwgZSk7CiAgICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzQm90LnZhcnMuYWN0aXZlRm9jdXNJbmZvID0gbnVsbDsKICAgIH0KfScA0/Cr+g6v7gEIcmVtZW1iZXICBADT8Kv6Dtq4Aijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDT8Kv6Dq/uAQ1hYk1hbmlmZXN0Qm90AgQA0/Cr+g6BuQL9QEBjb25zdCBkaW1lbnNpb24gPSB0aGF0Py5kaW1lbnNpb247CmNvbnN0IHBvc2l0aW9uID0gdGhhdD8ucG9zaXRpb247CgppZiAodGhpc0JvdC52YXJzLmFiQm90TGFzdElkKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVzdHJveWluZyBhYkJvdGApOwogICAgfQogICAgZGVzdHJveSh0aGlzQm90LnZhcnMuYWJCb3RMYXN0SWQpOwp9Cgpjb25zdCBhYk1vZCA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIGRpbWVuc2lvbiwKICAgIGFiQm90OiB0cnVlLAogICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICBbZGltZW5zaW9uICsgJ1gnXTogcG9zaXRpb24ueCwKICAgIFtkaW1lbnNpb24gKyAnWSddOiBwb3NpdGlvbi55LAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgZm9ybTogJ2N1YmUnLAogICAgbGFiZWw6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWwsCiAgICBsYWJlbFBvc2l0aW9uOiAnZnJvbnQnLAogICAgbGFiZWxDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC42MSwKICAgIGRyYWdnYWJsZTogZmFsc2UsCiAgICBhcm1TZWxlY3Rpb246IHRydWUsCiAgICBhcm1Hcm91cERyYWc6IHRydWUsCiAgICBhcm1UZWxlcG9ydDogdHJ1ZSwKICAgIGFybU1lc2hQYXRoOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJtTWVzaFBhdGgsCiAgICBhcm1Db2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIHBlcnNvbmFsaXR5OiB0YWdzLnBlcnNvbmFsaXR5LAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIHNwaW5EdXJhdGlvbk1TOiAyMDAwLAogICAgc3BpbkludGVydmFsTVM6IDIwMDAsCiAgICBzb3VuZENsaWNrOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQ2xpY2tTb3VuZCA/PyB0cnVlLAogICAgb25DcmVhdGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsgCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJNZXNoUGF0aCkgewogICAgICAgICAgICBsZXQgZm9ybUFkZHJlc3M7CgogICAgICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYk1lc2hQYXRoLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHsKICAgICAgICAgICAgICAgIGZvcm1BZGRyZXNzID0gbGlua3MucmVtZW1iZXIudGFncy5hYk1lc2hQYXRoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZm9ybUFkZHJlc3MgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChsaW5rcy5yZW1lbWJlci50YWdzLmFiTWVzaFBhdGgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDcmVhdGUgdGhlIG1lc2ggZm9yIGFiLgogICAgICAgICAgICBtYXNrcy5tZXNoQm90ID0gZ2V0TGluayhjcmVhdGUoewogICAgICAgICAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgICAgICAgICAgYWJCb3Q6IGdldExpbmsodGhpc0JvdCksCiAgICAgICAgICAgICAgICBmb3JtOiAnbWVzaCcsCiAgICAgICAgICAgICAgICBmb3JtU3VidHlwZTogJ2dsdGYnLAogICAgICAgICAgICAgICAgZm9ybUFkZHJlc3MsCiAgICAgICAgICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgdHJhbnNmb3JtZXI6IHRoaXNCb3QuaWQsCiAgICAgICAgICAgICAgICBhbmNob3JQb2ludDogJ2NlbnRlcicsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb25dOiB0cnVlLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgJ1onXTogLTAuNQogICAgICAgICAgICB9KSk7CgogICAgICAgICAgICB0YWdzLmNvbG9yID0gJ3RyYW5zcGFyZW50JzsKICAgICAgICAgICAgdGFncy5zY2FsZSA9IDE7CiAgICAgICAgICAgIHRhZ3Muc3BpbkludGVydmFsTVMgPSA0NTAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIElmIGEgY3VzdG9tIG1lc2ggaXMgbm90IGRlZmluZWQgZm9yIGFiLCB0aGVuIGdpdmUgYWIgYSAiY29yZSIuCiAgICAgICAgICAgIG1hc2tzLmNvcmVCb3QgPSBnZXRMaW5rKGNyZWF0ZSh7CiAgICAgICAgICAgICAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICAgICAgICAgICAgICBhYkJvdDogZ2V0TGluayh0aGlzQm90KSwKICAgICAgICAgICAgICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgZm9ybU9wYWNpdHk6IDAuNjYsCiAgICAgICAgICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgICAgICAgICAgc2NhbGU6IDAuNzUsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lcjogdGhpc0JvdC5pZCwKICAgICAgICAgICAgICAgIGFuY2hvclBvaW50OiAnY2VudGVyJywKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbl06IHRydWUsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAnWiddOiAtMC41CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yOwogICAgICAgICAgICB0YWdzLnNjYWxlID0gMC45OwogICAgICAgICAgICB0YWdzLnN0cm9rZVdpZHRoID0gMTsKICAgICAgICAgICAgdGFncy5zdHJva2VDb2xvciA9IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgICAgIHRhZ3MuZm9ybU9wYWNpdHkgPSAwLjMzOwogICAgICAgICAgICB0YWdzLmZvcm1EZXB0aFRlc3QgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXNCb3QuYW5pbWF0ZUJvdCgpOwogICAgICAgIG1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpc0JvdC5hbmltYXRlQm90KCksIHRhZ3Muc3BpbkludGVydmFsTVMpOwogICAgfSksCiAgICBvbkNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09ICdyaWdodCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAobWFza3MuYXJtQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3MuYXJtQm90KTsKICAgICAgICAgICAgbWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljaygpOwogICAgfSksCiAgICBvblBvaW50ZXJFbnRlcjpMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScpIHsKICAgICAgICAgICAgdGFncy5tb3VzZU92ZXIgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyRXhpdDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VPdmVyID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvblBvaW50ZXJEb3duOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScgJiYgdGhhdC5idXR0b25JZCA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0QnV0dG9uRG93biA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvblBvaW50ZXJVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT09ICdsZWZ0JykgewogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24gPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnREcmFnZ2luZyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25EcmFnOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRhZ3MubW91c2VMZWZ0QnV0dG9uRG93bikgewogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdERyYWdnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgb25LZXlEb3duOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQua2V5cy5pbmNsdWRlcygnU2hpZnQnKSkgewogICAgICAgICAgICB0YWdzLnNoaWZ0SGVsZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7ICAKICAgICAgICB9CiAgICB9KSwKICAgIG9uS2V5VXA6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5rZXlzLmluY2x1ZGVzKCdTaGlmdCcpKSB7CiAgICAgICAgICAgIHRhZ3Muc2hpZnRIZWxkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7ICAKICAgICAgICB9CiAgICB9KSwKICAgIHVwZGF0ZVBvcnRhbEN1cnNvcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxldCBjdXJzb3IgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5tb3VzZUxlZnREcmFnZ2luZykgewogICAgICAgICAgICBjdXJzb3IgPSAnZ3JhYmJpbmcnOyAgICAKICAgICAgICB9IGVsc2UgaWYgKHRhZ3MubW91c2VPdmVyKSB7CiAgICAgICAgICAgIGlmICh0YWdzLnNoaWZ0SGVsZCkgewogICAgICAgICAgICAgICAgY3Vyc29yID0gJ2NvbnRleHQtbWVudSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJzb3IgPSAncG9pbnRlcic7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsQ3Vyc29yID0gY3Vyc29yOwogICAgfSksCiAgICBhbmltYXRlQm90OiBMaXN0ZW5lclN0cmluZyhhc3luYyAoKSA9PiB7IAogICAgICAgIGlmIChjb25maWdCb3QudGFncy5hYk9wdGltaXplZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCByb3RaID0gdGFncy5kaW1lbnNpb24gKyAnUm90YXRpb25aJzsKCiAgICAgICAgYXdhaXQgYW5pbWF0ZVRhZyh0aGlzQm90LAogICAgICAgIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBbcm90Wl06IDAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIFtyb3RaXTogNi4zLAogICAgICAgICAgICB9LAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICdzaW51c29pZGFsJywKICAgICAgICAgICAgICAgIG1vZGU6ICdpbm91dCcKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IHRhZ3Muc3BpbkR1cmF0aW9uTVMgLyAxMDAwLAogICAgICAgIH0pLmNhdGNoKGUgPT4ge30pOwogICAgfSksCiAgICBvbkFCWFBFUGFpZE91dDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHsgcGF5QW1vdW50LCBzb3VyY2VJZCB9ID0gdGhhdDsKCiAgICAgICAgaWYgKHNvdXJjZUlkID09PSAnYWJCb3QnKSB7CiAgICAgICAgICAgIGFiLmN1ZSh7IGJvdDogdGhpc0JvdCwgdGV4dDogYPCfqpktJHtwYXlBbW91bnR9YCwgd3JhcE1vZGU6ICdub25lJywgZm9udFNpemU6IDIsIGNvbG9yOiAnI2VmNDQ0NCcgfSk7CiAgICAgICAgfQogICAgfSksCiAgICBvbkFybUNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICghdGFncy5pbnRlcnZhbCkgewogICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyByZXNldDogdHJ1ZSB9KTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uQXJtUGxhY2VkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJHcmlkRm9jdXMgPSB7CiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIAogICAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICAgICAgeDogdGhhdC54LAogICAgICAgICAgICAgICAgeTogdGhhdC55CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdncmlkJyB9KTsKCiAgICAgICAgc2hvdXQoJ29uQUJBcm1QbGFjZWQnLCB0aGF0KTsKICAgIH0pLAogICAgb25Bcm1DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IHJlc2V0OiB0cnVlIH0pOwogICAgICAgIHNob3V0KCdvbkFCRm9vdENsaWNrZWQnLCB0aGF0KTsKICAgIH0pLAogICAgb25Bcm1TZWxlY3RlZEJvdHM6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCBzZWxlY3RlZEJvdHMgPSB0aGF0OwoKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzZWxlY3RlZEJvdHMpKSB7CiAgICAgICAgICAgIC8vIE11bHRpcGxlIGJvdCBzZWxlY3Rpb24uCiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiTXVsdGlwbGVCb3RGb2N1cyA9IGdldExpbmsoc2VsZWN0ZWRCb3RzKTsKICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgbWVudTogJ211bHRpcGxlQm90JyB9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBTaW5nbGUgYm90IHNlbGVjdGlvbi4KICAgICAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJCb3RGb2N1cyA9ICLwn5SXIiArIHNlbGVjdGVkQm90cy5pZDsKCiAgICAgICAgICAgIGlmIChzZWxlY3RlZEJvdHMgPT09IHRoaXNCb3QpIHsKICAgICAgICAgICAgICAgIGFiLmxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdib3QnIH0pOwogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgc2hvdXQoJ29uQUJTZWxlY3RlZEJvdCcsIHNlbGVjdGVkQm90cyk7CiAgICB9KSwKICAgIG9uQXJtRGVzdHJveTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7CiAgICB9KSwKICAgIG9uRGVzdHJveTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNsZWFySW50ZXJ2YWwodGFncy5pbnRlcnZhbCk7CiAgICAgICAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsKICAgIH0pLAp9OwoKY29uc3QgYWJCb3QgPSBjcmVhdGUoYWJNb2QpOwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJTZWNvbmRhcnlMYWJlbCkgewogICAgY29uc3QgYWJMYWJlbEJvdCA9IHsKICAgICAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICAgICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICAgICAgW2RpbWVuc2lvbiArICdaJ106IC0xLAogICAgICAgIGNyZWF0b3I6IGFiQm90LmlkLAogICAgICAgIHRyYW5zZm9ybWVyOiBhYkJvdC5pZCwKICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgIGNvbG9yOiAnY2xlYXInLAogICAgICAgIGxhYmVsOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiU2Vjb25kYXJ5TGFiZWwsCiAgICAgICAgbGFiZWxQb3NpdGlvbjogJ2xlZnQnLAogICAgICAgIGxhYmVsU2l6ZTogMC43LAogICAgICAgIGxhYmVsQ29sb3I6IGFiQm90LnRhZ3MubGFiZWxDb2xvciwKICAgIH07CgogICAgY3JlYXRlKGFiTGFiZWxCb3QpOwp9CgptYXNrcy5hYkJvdCA9IGdldExpbmsoYWJCb3QpOwpsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkFjdGl2ZURpbWVuc2lvbiA9IGRpbWVuc2lvbjsKdGhpc0JvdC52YXJzLmFiQm90TGFzdElkID0gYWJCb3QuaWQ7IC8vIFN0b3JpbmcgaWQgYXMgYSB2YXIgcHJldmVudHMgZ2hvc3QgYWJCb3RzIGR1cmluZyBtdWx0aXBsZSBjYWxscyBpbiBvbmUgZnJhbWUuCgovLyBTdG9yZSB0aGUgbGFzdCBwb3NpdGlvbiBvZiBhYiBpbiB0aGlzIGRpbWVuc2lvbiBvbiB0aGUgcmVtZW1iZXIgYm90LgpsaW5rcy5yZW1lbWJlci5tYXNrc1tkaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXSA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KHsgeDogcG9zaXRpb24/LngsIHk6IHBvc2l0aW9uPy55IH0pOwoKYXdhaXQgb3Muc2xlZXAoMCk7IC8vIEdpdmUgQ2FzdWFsT1MgYSBjaGFuY2UgdG8gdXBkYXRlIHRhZyBtYXNrcy4KCnNob3V0KCdvbkFCTW92ZWQnLCB7IGRpbWVuc2lvbiwgeDogcG9zaXRpb24ueCwgeTogcG9zaXRpb24ueSB9KTsKCnJldHVybiBhYkJvdDsnANPwq/oOr+4BC29uR3JpZENsaWNrAgQA0/Cr+g75+QLZFkBpZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgcmV0dXJuOwp9Cgpjb25zdCBzaGlmdENoZWNrID0gb3MuZ2V0SW5wdXRTdGF0ZSgia2V5Ym9hcmQiLCAiU2hpZnQiKTsKCmlmIChsaW5rcy5hYkJvdCAmJiAoc2hpZnRDaGVjayB8fCAodGhhdC5tb2RhbGl0eSA9PSAibW91c2UiICYmIHRoYXQuYnV0dG9uSWQgPT0gInJpZ2h0IiAmJiAhbGlua3MucmVtZW1iZXIudGFncy5hYlJpZ2h0Q2xpY2tEaXNhYmxlZCkgfHwgdGhhdC5mb3JjZUFybVBsYWNlbWVudCkpIHsKICAgIGNvbnN0IGFybUJvdCA9IGFiLmxpbmtzLmFybV90b29sLmFiQ3JlYXRlQXJtKHsKICAgICAgICBvcmlnaW5Cb3Q6IGxpbmtzLmFiQm90LAogICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICAgICAgcG9zaXRpb246IHRoYXQucG9zaXRpb24sCiAgICB9KQoKICAgIC8vIEZha2UgdXNlciBkcm9wcGluZyB0aGUgYXJtIG9uIHRoZSBncmlkIHNwYWNlLgogICAgYXJtQm90Lm9uRHJvcCh7CiAgICAgICAgYm90OiBhcm1Cb3QsCiAgICAgICAgdG86IHsKICAgICAgICAgICAgeDogdGhhdC5wb3NpdGlvbi54LAogICAgICAgICAgICB5OiB0aGF0LnBvc2l0aW9uLnksCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9LAogICAgICAgIGZyb206IHsKICAgICAgICAgICAgeDogdGhhdC5wb3NpdGlvbi54LAogICAgICAgICAgICB5OiB0aGF0LnBvc2l0aW9uLnksCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm47Cn0KCmNvbnN0IGZvb3RwcmludCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICBbdGhhdC5kaW1lbnNpb25dOiB0cnVlLAogICAgW3RoYXQuZGltZW5zaW9uICsgIlgiXTogdGhhdC5wb3NpdGlvbi54LAogICAgW3RoYXQuZGltZW5zaW9uICsgIlkiXTogdGhhdC5wb3NpdGlvbi55LAogICAgcG9zaXRpb25JbmZvOiB0aGF0LAogICAgcGVyc29uYWxpdHk6IHRhZ3MucGVyc29uYWxpdHksCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIGxlYXJuOiB0YWdzLmxlYXJuLAogICAgZHJhZ2dhYmxlOiBmYWxzZSwKICAgIGN1cnNvcjogJ2FsaWFzJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBzb3VuZENyZWF0ZTogJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoWyAnYWIvYXVkaW8vZ3JpZCB0YXBfMDEubXAzJywgJ2FiL2F1ZGlvL2dyaWQgdGFwXzAyLm1wMycsICdhYi9hdWRpby9ncmlkIHRhcF8wMy5tcDMnLCAnYWIvYXVkaW8vZ3JpZCB0YXBfMDQubXAzJywgJ2FiL2F1ZGlvL2dyaWQgdGFwXzA1Lm1wMycgXSksCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoYXN5bmMgKCkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZGVzdHJveSh0aGlzQm90KSwgODAwKTsKCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aCkgewogICAgICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJtTWVzaFBhdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gbGlua3MubGVhcm4uYWJCdWlsZENhc3VhbENhdGFsb2dVUkwobGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGFncy5mb3JtID0gJ21lc2gnOwogICAgICAgICAgICB0YWdzLmZvcm1TdWJ0eXBlID0gJ2dsdGYnOwogICAgICAgICAgICB0YWdzLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgICAgICAgICAgdGFncy5zdHJva2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgICAgIHRhZ3MuYW5jaG9yUG9pbnQgPSAnY2VudGVyJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YWdzLmNvbG9yID0gJ2NsZWFyJzsKICAgICAgICAgICAgdGFncy5zdHJva2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc2NhbGVaID0gMC4wMTsKICAgICAgICB9CgogICAgICAgIGF3YWl0IGFuaW1hdGVUYWcodGhpc0JvdCwgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIHNjYWxlWDogMC4xLAogICAgICAgICAgICAgICAgc2NhbGVZOiAwLjEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgc2NhbGVYOiAxLjEsCiAgICAgICAgICAgICAgICBzY2FsZVk6IDEuMQogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogMC41LAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICJlbGFzdGljIiwKICAgICAgICAgICAgICAgIG1vZGU6ICJvdXQiCiAgICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChlID0+IHt9KTsKICAgIH0pLAogICAgb25DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgc2hvdXQoIm9uQUJGb290Q2xpY2tlZCIsIHsgZGltZW5zaW9uOiB0YWdzLmRpbWVuc2lvbiB9KTsKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiTWFuaWZlc3RCb3QodGFncy5wb3NpdGlvbkluZm8pOwogICAgICAgIGFiLmxpbmtzLnNvdW5kLmFiUGxheVNvdW5kKHsgdmFsdWU6IGFiLmxpbmtzLmFybV90b29sLnRhZ3MuZGVmYXVsdEFybVRlbGVwb3J0U291bmQgfSk7CiAgICB9KSwKfTsKCgpjcmVhdGUoZm9vdHByaW50KTsnANPwq/oOr+4BBG1lbnUCBADT8Kv6DtGQAyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDT8Kv6Dq/uAQdhYkNsaWNrAgQA0/Cr+g74kAPQCkBpZiAoIWxpbmtzLmFiQm90KSB7CiAgICByZXR1cm47Cn0KCmlmIChsaW5rcy5pbnB1dCkgewogICAgbGlua3MuaW5wdXQuYWJDaGF0QmFyQ2xvc2UoKTsKfQoKY29uc3QgcmVzZXQgPSB0aGF0ID8gdGhhdC5yZXNldCA6IGZhbHNlOwpjb25zdCBtZW51ID0gdGhhdCA/IHRoYXQubWVudSA6ICJjb3JlIjsKY29uc3Qgc3RhdGUgPSBvcy5nZXRJbnB1dFN0YXRlKCJrZXlib2FyZCIsICJTaGlmdCIpOwoKaWYgKCFyZXNldCAmJiAobGlua3MuYWJCb3QudGFncy5pbnRlcnZhbCB8fCBzdGF0ZSkpIHsKICAgIGNvbnN0IGFiTWVudUJvdHMgPSBnZXRCb3RzKCJhYk1lbnUiLCB0cnVlKTsKCiAgICB3aGlzcGVyKGFiTWVudUJvdHMsICJhYk1lbnVSZWZyZXNoIik7CgogICAgY2xlYXJJbnRlcnZhbChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsKTsKCiAgICBsaW5rcy5hYkJvdC5tYXNrcy5pbnRlcnZhbCA9IG51bGw7CgogICAgY2xlYXJBbmltYXRpb25zKGxpbmtzLmFiQm90KTsKCiAgICBjb25zdCByb3RaID0gbGlua3MuYWJCb3QudGFncy5kaW1lbnNpb24gKyAiUm90YXRpb25aIjsKCiAgICBpZiAoc3RhdGUgJiYgbWVudSA9PSAiY29yZSIpIHsKICAgICAgICBsaW5rcy5tZW51LmFiRW52aXJvbm1lbnRNZW51KCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBsaW5rcy5tZW51LmFiT3Blbk1lbnUobWVudSk7CiAgICB9CgogICAgYW5pbWF0ZVRhZyhsaW5rcy5hYkJvdCwgewogICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICBbcm90Wl06IGxpbmtzLmFiQm90LnRhZ3Nbcm90Wl0KICAgICAgICB9LAogICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgW3JvdFpdOiAwCiAgICAgICAgfSwKICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgdHlwZTogInNpbnVzb2lkYWwiLAogICAgICAgICAgICBtb2RlOiAiaW5vdXQiCiAgICAgICAgfSwKICAgICAgICBkdXJhdGlvbjogMC41CiAgICB9KS5jYXRjaChlID0+IHt9KQp9CmVsc2UgewogICAgbGlua3MuYWJCb3QuYW5pbWF0ZUJvdCgpOwoKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmxpbmVUbyA9IG51bGw7CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBjbGVhckludGVydmFsKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwpOwogICAgbGlua3MuYWJCb3QubWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiBsaW5rcy5hYkJvdC5hbmltYXRlQm90KCksIGxpbmtzLmFiQm90LnRhZ3Muc3BpbkludGVydmFsTVMpOwp9CgpzaG91dCgnb25BQkNsaWNrJywgeyBhYkJvdDogbGlua3MuYWJCb3QsIGRpbWVuc2lvbjogbGlua3MuYWJCb3QudGFncy5kaW1lbnNpb24sIG1lbnUsIHNoaWZ0S2V5OiAhIXN0YXRlLCByZXNldCB9KTsnANPwq/oOr+4BCGFiSWdub3JlAgQA0/Cr+g7JmwMEdHJ1ZScA0/Cr+g6v7gEDYXNrAgQA0/Cr+g7OmwMo8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycA0/Cr+g6v7gEJYXNrQnV0dG9uAgQA0/Cr+g71mwPIBUBpZiAoIXRhZ3MuYWJBd2FrZSkKewogICAgcmV0dXJuOwp9CgpsZXQgYWJNZW51QnV0dG9uID0ge307CgphYk1lbnVCdXR0b24uYWJNZW51ID0gdHJ1ZTsKYWJNZW51QnV0dG9uLnJlbWVtYmVyID0gbGlua3MubWVudS50YWdzLnJlbWVtYmVyOwphYk1lbnVCdXR0b24ubWFuaWZlc3RhdGlvbiA9IGxpbmtzLm1lbnUudGFncy5tYW5pZmVzdGF0aW9uOwphYk1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKYWJNZW51QnV0dG9uLmJhc2VTa2lsbCA9ICLwn5SXIiArIGxpbmtzLmFzay5pZDsKYWJNZW51QnV0dG9uLmxhYmVsID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUxhYmVsOwphYk1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51SWNvbjsKYWJNZW51QnV0dG9uLm9uQ3JlYXRlID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudU9uR2VuZXJhdGU7CmFiTWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51U29ydE9yZGVyOwphYk1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51Q29sb3IgPyBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51Q29sb3IgOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oYWJNZW51QnV0dG9uKTsnANPwq/oOr+4BCWFiQm90Q2hhdAIEANPwq/oOvKED7ghAaWYgKCFsaW5rcy5hYkJvdCAmJiAhdGhhdC5ib3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYm90QmFzZSA9IHRoYXQuYm90ID8gdGhhdC5ib3Q6IGxpbmtzLmFiQm90Owpjb25zdCBkaW1lbnNpb24gPSAhdGhhdC5ib3QgPyBib3RCYXNlLnRhZ3MuZGltZW5zaW9uIDogdGhhdC5kaW1lbnNpb24gPyB0aGF0LmRpbWVuc2lvbiA6IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CmNvbnN0IG1lc3NhZ2UgPSB0aGF0Lm1lc3NhZ2U7CmNvbnN0IG1lc3NhZ2VUaW1lID0gdGhhdC50aW1lID8gdGhhdC50aW1lICogMTAwMCA6IDE2MDA7IAoKY29uc3QgbWVzc2FnZUJvdCA9IGF3YWl0IGxpbmtzLmJvdF9mYWN0b3J5LmFiQ3JlYXRlQmlsbGJvYXJkTGFiZWwoewogICAgYm90OiBib3RCYXNlLAogICAgbGFiZWw6IG1lc3NhZ2UsCiAgICBkaW1lbnNpb24sCiAgICBtZXNzYWdlVGltZSwKICAgIGNvbG9yOiAiIzAwMDAwMCIsCiAgICBsYWJlbENvbG9yOiAiI2ZmZmZmZiIsCiAgICBvbkJvdEFkZGVkOiBgQAogICAgICAgIGF3YWl0IG9zLnNsZWVwKHRhZ3MubWVzc2FnZVRpbWUpOwogICAgICAgIHRoaXNCb3Qub25GYWRlKCk7CiAgICBgLAogICAgb25GYWRlOiBgQAogICAgICAgIGFuaW1hdGVUYWcodGhpc0JvdCwgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgIloiXTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICJaIl0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgZm9ybU9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAiWiJdOiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgIloiXSArIDUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246ICR7dGhhdC5kdXJhdGlvbiA/PyAzfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7fSkKICAgICAgICAuZmluYWxseSgoKSA9PiB7CiAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgfSkKCiAgICBgLAp9KTsnANPwq/oOr+4BCWFiVmVyc2lvbgIEANPwq/oOq6oDBTEwLjQwJwDT8Kv6Dq/uAQlhbmltYXRpb24CBADT8Kv6DrGqAyjwn5SXYjI2ZTEwODktMTcyZC00NWE5LThkMjItMDVjM2Y1OGMyYmY3JwDT8Kv6Dq/uAQ9vbkFueUJvdENsaWNrZWQCBADT8Kv6DtiqA+kHQGlmICghbGlua3MucmVtZW1iZXIudGFncy5hYlJpZ2h0Q2xpY2tEaXNhYmxlZCAmJiAhdGhhdC5ib3QudGFncy5hYlJpZ2h0Q2xpY2tJZ25vcmUgJiYgdGhhdC5tb2RhbGl0eSA9PSAibW91c2UiICYmIHRoYXQuYnV0dG9uSWQgPT0gInJpZ2h0IikgewogICAgaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gYWIgc2VsZWN0ZWQKICAgIGlmICh0aGF0LmJvdCA9PSBsaW5rcy5hYkJvdCkgewogICAgICAgIGxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgICAgICByZXR1cm47CiAgICB9ICAgIAogICAgCiAgICBjb25zdCBhcm1Cb3QgPSBhYi5saW5rcy5hcm1fdG9vbC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBsaW5rcy5hYkJvdCwKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB0aGF0LnBvc2l0aW9uLAogICAgfSkKCiAgICBjb25zdCBib3RQb3NpdGlvbiA9IGdldEJvdFBvc2l0aW9uKHRoYXQuYm90LCB0aGF0LmRpbWVuc2lvbik7CgogICAgLy8gRmFrZSB1c2VyIGRyb3BwaW5nIHRoZSBzZWxlY3RpbmcgdGhlIGJvdCB3aXRoIHRoZSBhcm0uCiAgICBhcm1Cb3Qub25Ecm9wKHsKICAgICAgICBib3Q6IGFybUJvdCwKICAgICAgICB0bzogewogICAgICAgICAgICBib3Q6IHRoYXQuYm90LAogICAgICAgICAgICB4OiBib3RQb3NpdGlvbi54LAogICAgICAgICAgICB5OiBib3RQb3NpdGlvbi55LAogICAgICAgICAgICB6OiBib3RQb3NpdGlvbi56LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfSwKICAgICAgICBmcm9tOiB7CiAgICAgICAgICAgIHg6IGJvdFBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IGJvdFBvc2l0aW9uLnksCiAgICAgICAgICAgIHo6IGJvdFBvc2l0aW9uLnosCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm47Cn0nANPwq/oOr+4BBWlucHV0AgQA0/Cr+g7CsgMo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcA0/Cr+g6v7gELcGVyc29uYWxpdHkCBADT8Kv6DumyAyjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDT8Kv6Dq/uAQ1hYlBlcnNvbmFsaXR5AgQA0/Cr+g6QswMEdHJ1ZScA0/Cr+g6v7gEKYWJTZXRBd2FrZQIEANPwq/oOlbMDjBBAbGV0IGF3YWtlID0gdGhhdD8uYXdha2U7CmxldCBpbml0aWFsID0gdGhhdD8uaW5pdGlhbCA/PyBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmFzc2VydCh0eXBlb2YgYXdha2UgPT09ICdib29sZWFuJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhd2FrZSBpcyBhIHJlcXVpcmVkIGJvb2xlYW4gcGFyYW1ldGVyLmApOwoKaWYgKGNvbmZpZ0JvdC50YWdzLmFiU3RheUF3YWtlKSB7CiAgICAvLyBJZiBhYlN0YXlBd2FrZSBpcyBlbmFibGVkLCBvdmVycmlkZSB0aGUgaW5jb21pbmcgYXdha2UgcGFyYW1ldGVyIGFuZCBuZXZlciBsZXQgYWIgYmUgcHV0IHRvIHNsZWVwLgogICAgYXdha2UgPSB0cnVlOwp9CgppZiAodGFncy5hYkF3YWtlICE9PSBhd2FrZSkgewogICAgaWYgKGluaXRpYWwpIHsKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MucGF0dGVybikgewogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSB1dWlkKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFBsYXkgaW5pdGlhbCBhbmltYXRpb24gaWYgb25lIGlzIGRlZmluZWQgb24gYWJDb25maWcuCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsQW5pbWF0aW9uKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmFuaW1hdGlvbltsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbEFuaW1hdGlvbl0oKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU2hvdyBpbml0aWFsIG1lc3NhZ2UgaWYgb25lIGlzIGRlZmluZWQgb24gYWJDb25maWcuCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZSkgewogICAgICAgICAgICBzaG91dCgic2hvd0NvbnNvbGUiKTsKCiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlW2ldKTsKCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFVwZGF0ZSBhYkF3YWtlIHNoYXJlZCB0YWcgbWFzay4KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2FiQXdha2UnLCBhd2FrZSwgJ3NoYXJlZCcpOwogICAgCiAgICBpZiAoYXdha2UpIHsKICAgICAgICBsZXQgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8/IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CgogICAgICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHBvc2l0aW9uID0geyB4OiAwLCB5OiAwIH07CgogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbiwgcG9zaXRpb24gfSk7CgogICAgICAgIHNob3V0KCJvbkFCQXdha2UiLCB7IGRpbWVuc2lvbiwgcG9zaXRpb24sIGluaXRpYWwgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3kobGlua3MuYWJCb3QpOwoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwogICAgICAgIHNob3V0KCJvbkFCU2xlZXAiKTsKICAgIH0KfScA0/Cr+g6v7gEFdXRpbHMCBADT8Kv6DqLDAyjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDT8Kv6Dq/uAQtib3RfZmFjdG9yeQIEANPwq/oOycMDKPCflJdjNzhhYTY2My1kMDVjLTRlYzQtYmMyYy0yNmZkNTE1NjBiOTcnANPwq/oOr+4BD29uQUJJbml0aWFsaXplZAIEANPwq/oO8MMDrAFAbWFza3MuYWJJbml0aWFsaXplZCA9IHRydWU7DQoNCmlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsNCiAgICB0aGlzQm90Lm9uUG9ydGFsQ2hhbmdlZCh7cG9ydGFsOiAibWFwUG9ydGFsIiwgZGltZW5zaW9uOiBjb25maWdCb3QudGFncy5tYXBQb3J0YWwsIGluaXRpYWw6IHRydWUgfSk7DQp9JwDT8Kv6Dq/uAQVkZWJ1ZwIEANPwq/oOncUDBWZhbHNlJwDT8Kv6Dq/uARpnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbgIEANPwq/oOo8UDqQtAYXN5bmMgZnVuY3Rpb24gZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24ocG9ydGFsOiAnbWFwJyB8ICdncmlkJyk6IHsgeDogbnVtYmVyLCB5OiBudW1iZXIgfSB7CiAgICBpZiAocG9ydGFsID09PSAnZ3JpZCcpIHsKICAgICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH0KICAgIH0gZWxzZSBpZiAocG9ydGFsID09PSAnbWFwJykgewogICAgICAgIGlmICh0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnggPT09ICdudW1iZXInICYmICB0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgY3VycmVudFBvc2l0aW9uID0gdW5kZWZpbmVkOwogICAgICAgICAgICBsZXQgaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uID0gYXdhaXQgbGlua3MudXRpbHMuaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKCk7CgogICAgICAgICAgICAvLyBDdXJyZW50IHdvcmstYXJvdW5kIGZvciBhbGxvd2luZyBnZW9sb2NhdGlvbiBmb3IgaU9TIGFwcAogICAgICAgICAgICBpZiAoZ2V0Qm90KCJzeXN0ZW0iLCAiYWIuaW9zYnJpZGdlLm1lc3NlbmdlciIpKSB7CiAgICAgICAgICAgICAgICBoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24gPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnZW9sb2NhdGlvbiA9IGF3YWl0IG9zLmdldEdlb2xvY2F0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAoZ2VvbG9jYXRpb24uc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbiA9IHsgeDogZ2VvbG9jYXRpb24ubG9uZ2l0dWRlLCB5OiBnZW9sb2NhdGlvbi5sYXRpdHVkZSB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXJyZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50UG9zaXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHUlBNIFBvc2l0aW9uCiAgICAgICAgICAgICAgICByZXR1cm4geyB4OiAtODUuNjc2MTg5NDgyMjQzNCwgeTogNDIuOTY1Njc1Njc1Njc1NiB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdW5yZWNvbmdpemVkIHBvcnRhbCB0eXBlIHByb3ZpZGVkIHRvIGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uOmAsIHBvcnRhbCk7CiAgICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9CiAgICB9Cn0KCnJldHVybiBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbih0aGF0KTsnANPwq/oOr+4BEmdldFN0YXJ0Q2FtZXJhWm9vbQIEANPwq/oOzdADkARAYXN5bmMgZnVuY3Rpb24gZ2V0U3RhcnRDYW1lcmFab29tKHBvcnRhbDogJ21hcCcgfCAnZ3JpZCcpOiBudW1iZXIgfCBudWxsIHsKICAgIGlmIChwb3J0YWwgPT09ICdncmlkJykgewogICAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIGlmIChwb3J0YWwgPT09ICdtYXAnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFN0YXJ0Wm9vbSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgcmV0dXJuIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwU3RhcnRab29tOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVucmVjb25naXplZCBwb3J0YWwgdHlwZSBwcm92aWRlZCB0byBnZXRTdGFydENhbWVyYVpvb206YCwgcG9ydGFsKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KfQoKcmV0dXJuIGdldFN0YXJ0Q2FtZXJhWm9vbSh0aGF0KTsnANPwq/oOr+4BFGRlZmF1bHRNYXBQb3J0YWxab29tAgQA0/Cr+g7e1AMEMTAwMCcA0/Cr+g6v7gEQb25BQkJlZm9yZVVwZGF0ZQIEANPwq/oO49QDNkBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gdGFncy5hYkF3YWtlOycA0/Cr+g6v7gELb25BQlVwZGF0ZWQCBADT8Kv6DprVA48BQGlmIChjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlKSB7CiAgICBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gbnVsbDsKICAgIGF3YWl0IHRoaXNCb3QuYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlIH0pCn0nANPwq/oOr+4BFWRlZmF1bHRHcmlkUG9ydGFsWm9vbQIEANPwq/oOqtYDAjIwJwDT8Kv6Dq/uAQlvbkFCQXdha2UCBADT8Kv6Dq3WA8IBQGNvbnN0IHsgZGltZW5zaW9uLCBwb3NpdGlvbiwgaW5pdGlhbCB9ID0gdGhhdDsKCmlmIChpbml0aWFsICYmIGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwgPT09IGRpbWVuc2lvbikgewogICAgb3MuZm9jdXNPbihwb3NpdGlvbiwgeyB6b29tOiB0YWdzLmRlZmF1bHRHcmlkUG9ydGFsWm9vbSwgcG9ydGFsOiAnZ3JpZFBvcnRhbCcgfSk7Cn0A"}]}