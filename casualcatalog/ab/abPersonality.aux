{"version":2,"updates":[{"id":0,"timestamp":1770837089294,"update":"AdgB7rWleQAnAQRib3RzJDE2NTU0YmMxLWU5M2UtNGEwYi04Y2QzLWRmZDc3MjMxOTY3MgEnAO61pXkACWFiVmVyc2lvbgIEAO61pXkBBTEwLjM5JwDutaV5AAZzeXN0ZW0CBADutaV5BxZhYi5wZXJzb25hbGl0eS52ZXJzaW9uJwDutaV5ABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQA7rWleR4BMycA7rWleQANb25Ta2lsbFVwZGF0ZQIEAO61pXkgrQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycA7rWleQANYWJQZXJzb25hbGl0eQIEAO61pXnOAQR0cnVlJwDutaV5AAhhYklnbm9yZQIEAO61pXnTAQR0cnVlJwDutaV5AARmb3JtAgQA7rWledgBB25vdGhpbmcnAO61pXkAGWFiUGVyc29uYWxpdHlNaW5vclZlcnNpb24CBADutaV54AEBMCcBBGJvdHMkM2M3NGM5ZjEtODJkYy00NjU1LThiMzgtZTdmMTFkZTg5NzhlAScA7rWleeIBBnN5c3RlbQIEAO61pXnjARdhYi5wZXJzb25hbGl0eS5hcm1fdG9vbCcA7rWleeIBDG9uQW55Qm90RHJhZwIEAO61pXn7AY0IQGNvbnN0IGRyYWdCb3QgPSB0aGF0LmJvdDsKY29uc3QgZGltZW5zaW9uID0gdGhhdC5mcm9tLmRpbWVuc2lvbjsKCmlmIChkcmFnQm90LnRhZ3MuYXJtU2VsZWN0aW9uKSB7CiAgICBpZiAoZHJhZ0JvdC5tYXNrcy5hcm1Cb3QpIHsKICAgICAgICBpZiAoZHJhZ0JvdC5saW5rcy5hcm1Cb3QudGFncy5tdWx0aVNlbGVjdCAmJiBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cyAmJiBkcmFnQm90LnRhZ3MuYXJtR3JvdXBEcmFnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVuYWJsZSBjdXN0b20gZHJhZ2dpbmdgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgb3MuZW5hYmxlQ3VzdG9tRHJhZ2dpbmcoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3kgcHJldmlvdXMgYXJtQm90OiAke2RyYWdCb3QubWFza3MuYXJtQm90fWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkZXN0cm95KGRyYWdCb3QubGlua3MuYXJtQm90KTsKICAgICAgICAgICAgZHJhZ0JvdC5tYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBtdWx0aVNlbGVjdEtleUhlbGQgPSBvcy5nZXRJbnB1dFN0YXRlKCdrZXlib2FyZCcsICdTaGlmdCcpOwogICAgY29uc3QgbXVsdGlTZWxlY3RBbGxvd2VkID0gZHJhZ0JvdC50YWdzLmFybU11bHRpU2VsZWN0ID8/IHRydWU7CgogICAgY29uc3QgYXJtQm90ID0gdGhpc0JvdC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBkcmFnQm90LAogICAgICAgIGRpbWVuc2lvbiwKICAgICAgICBtdWx0aVNlbGVjdDogbXVsdGlTZWxlY3RLZXlIZWxkICYmIG11bHRpU2VsZWN0QWxsb3dlZCwKICAgIH0pCgogICAgb3MucmVwbGFjZURyYWdCb3QoYXJtQm90KTsKfQonAO61pXniAQVkZWJ1ZwIEAO61pXmJCgVmYWxzZScA7rWleeIBCWxpc3RlbmluZwIEAO61pXmPCgR0cnVlJwDutaV54gELYWJDcmVhdGVBcm0CBADutaV5lAr1TUBjb25zdCBvcmlnaW5Cb3QgPSB0aGF0Lm9yaWdpbkJvdDsKYXNzZXJ0KGFiLmxpbmtzLnV0aWxzLmlzQm90KG9yaWdpbkJvdCksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luQm90IGlzIGEgcmVxdWlyZWQgQm90IHBhcmFtZXRlci5gKTsKCmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZGltZW5zaW9uOwphc3NlcnQodHlwZW9mIGRpbWVuc2lvbiA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGltZW5zaW9uIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHBvc2l0aW9uID0gdGhhdC5wb3NpdGlvbiA/PyBnZXRCb3RQb3NpdGlvbihvcmlnaW5Cb3QsIGRpbWVuc2lvbik7CmNvbnN0IG11bHRpU2VsZWN0ID0gdGhhdC5tdWx0aVNlbGVjdCA/PyBmYWxzZTsKY29uc3QgYXJtQ29sb3IgPSB0aGF0LmFybUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLmFybUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLnN0cm9rZUNvbG9yID8/IG9yaWdpbkJvdC50YWdzLmNvbG9yOwpjb25zdCBhcm1NZXNoUGF0aCA9IHRoYXQuYXJtTWVzaFBhdGggPz8gb3JpZ2luQm90LnRhZ3MuYXJtTWVzaFBhdGg7CmNvbnN0IGFybURyb3BTb3VuZCA9IHRoYXQuYXJtRHJvcFNvdW5kID8/IG9yaWdpbkJvdC50YWdzLmFybURyb3BTb3VuZDsKY29uc3QgYXJtVGVsZXBvcnRTb3VuZCA9IHRoYXQuYXJtVGVsZXBvcnRTb3VuZCA/PyBvcmlnaW5Cb3QudGFncy5hcm1UZWxlcG9ydFNvdW5kOwoKY29uc3QgYXJtID0gewogICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICBbZGltZW5zaW9uICsgJ1gnXTogcG9zaXRpb24ueCwKICAgIFtkaW1lbnNpb24gKyAnWSddOiBwb3NpdGlvbi55LAogICAgW2RpbWVuc2lvbiArICdaJ106IHBvc2l0aW9uLnosCiAgICBjcmVhdG9yOiBvcmlnaW5Cb3QuaWQsCiAgICBpc0FybUJvdDogdHJ1ZSwKICAgIHBvaW50YWJsZTogdHJ1ZSwKICAgIG11bHRpU2VsZWN0LAogICAgZGVidWc6IHRhZ3MuZGVidWcsCiAgICBvcmlnaW5Cb3Q6IGdldExpbmsob3JpZ2luQm90KSwKICAgIGRpbWVuc2lvbiwKICAgIGFybUNvbG9yLAogICAgYXJtTWVzaFBhdGgsCiAgICBhcm1Ecm9wU291bmQsCiAgICBhcm1UZWxlcG9ydFNvdW5kLAogICAgZGVmYXVsdEFybURyb3BTb3VuZDogdGFncy5kZWZhdWx0QXJtRHJvcFNvdW5kLAogICAgZGVmYXVsdEFybVRlbGVwb3J0U291bmQ6IHRhZ3MuZGVmYXVsdEFybVRlbGVwb3J0U291bmQsCiAgICBsaW5lQ29sb3I6IGFybUNvbG9yLAogICAgbGluZVRvOiBvcmlnaW5Cb3QuaWQsCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3JlYXRlZCBhcm1Cb3QgJHt0aGlzQm90LmlkfWApOwogICAgICAgIH0KICAgICAgICAvLyBEZXN0cm95IHByZXZpb3VzIGFybSBpZiBpdCBpcyBzdGlsbCBhcm91bmQuCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1Cb3QpIHsKICAgICAgICAgICAgZGVzdHJveShsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtQm90KTsKICAgICAgICB9CgogICAgICAgIHRhZ3Muc3lzdGVtID0gYGFybS4ke3RoaXNCb3QuaWQuc3Vic3RyaW5nKDAsIDUpfWA7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCA9IGdldExpbmsodGhpc0JvdCk7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmRyYWdnYWJsZSA9IHRhZ3MubXVsdGlTZWxlY3Q7CgogICAgICAgIGlmICh0YWdzLmFybU1lc2hQYXRoICYmICF0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIGlmICh0YWdzLmFybU1lc2hQYXRoLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSB0YWdzLmFybU1lc2hQYXRoOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9IGFiLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKHRhZ3MuYXJtTWVzaFBhdGgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0YWdzLmZvcm0gPSAnbWVzaCc7CiAgICAgICAgICAgIHRhZ3MuZm9ybVN1YnR5cGUgPSAnZ2x0Zic7CiAgICAgICAgICAgIHRhZ3MuYW5jaG9yUG9pbnQgPSAnY2VudGVyJzsKICAgICAgICAgICAgdGFncy5jb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAwLjk5OTk7IC8vIFRoZXJlIGlzIGEgcmVhbGx5IHN0cmFuZ2UgYnVnIHRoYXQgaWYgdGhpcyBpcyBsZWZ0IHVuZGVmaW5lZCBvciBzZXQgdG8gMSBleGFjdGx5LCB0aGUgYXJtIHdpbGwgc29tZXRpbWVzIGRpc2FwcGVhci4KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YWdzLnN0cm9rZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKICAgICAgICAgICAgdGFncy5mb3JtID0gJ2N1YmUnOwogICAgICAgICAgICB0YWdzLmNvbG9yID0gJ2NsZWFyJzsKICAgICAgICAgICAgdGFncy5zY2FsZSA9IDAuOTsKICAgICAgICAgICAgdGFncy5zY2FsZVogPSAwLjAxOwoKICAgICAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybSA9ICdzcGhlcmUnOwogICAgICAgICAgICAgICAgdGFncy5jb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIE1ha2UgdGhlIG9yaWdpbiBib3QgdW5zZWxlY3RhYmxlIGZvciAxLzQgb2YgYSBzZWNvbmQuCiAgICAgICAgLy8gVGhpcyBoZWxwcyBwcmV2ZW50IHVuaW50ZW50aW9uYWwgc2VsZi1zZWxlY3Rpb24gb2YgdGhlIG9yaWdpbiBib3QuCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLnBvaW50YWJsZSA9IGZhbHNlOwogICAgICAgIG9zLnNsZWVwKDI1MCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5wb2ludGFibGUgPSBudWxsOwogICAgICAgIH0pCgogICAgICAgIHRoaXNCb3Qub3JpZ2luQ2xlYXJTZWxlY3Rpb24oKTsKCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybUNyZWF0ZScpOwogICAgfSksCiAgICBzZXRBcm1WaXNpYmxlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGV0IHZpc2libGUgPSB0aGF0OwoKICAgICAgICBpZiAodmlzaWJsZSkgewogICAgICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aCkgewogICAgICAgICAgICAgICAgbWFza3MuZm9ybU9wYWNpdHkgPSBudWxsOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWFza3Muc3Ryb2tlQ29sb3IgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5saW5lQ29sb3IgPSBudWxsOwogICAgICAgICAgICBtYXNrcy5saW5lVG8gPSBsaW5rcy5vcmlnaW5Cb3QuaWQ7IAogICAgICAgICAgICBtYXNrcy5wb2ludGFibGUgPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgICAgIG1hc2tzLmNvbG9yID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmFybU1lc2hQYXRoKSB7CiAgICAgICAgICAgICAgICBtYXNrcy5mb3JtT3BhY2l0eSA9IDA7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBtYXNrcy5zdHJva2VDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1hc2tzLmxpbmVDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIG1hc2tzLmxpbmVUbyA9IGZhbHNlOwogICAgICAgICAgICBtYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCB7IGRpbWVuc2lvbiB9ID0gdGhhdDsKCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdD8udGFncy5hcm1UZWxlcG9ydCA/PyB0cnVlKSB7CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC50YWdzW2RpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWCddID0gdGFnc1tkaW1lbnNpb24gKyAnWCddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWSddID0gdGFnc1tkaW1lbnNpb24gKyAnWSddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWiddID0gdGFnc1tkaW1lbnNpb24gKyAnWiddOwoKICAgICAgICAgICAgYWIubGlua3Muc291bmQuYWJQbGF5U291bmQoeyB2YWx1ZTogdGFncy5hcm1UZWxlcG9ydFNvdW5kLCBkZWZhdWx0VmFsdWU6IHRhZ3MuZGVmYXVsdEFybVRlbGVwb3J0U291bmQgfSk7CiAgICAgICAgfQoKICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtQ2xpY2snLCB7IGRpbWVuc2lvbiB9KTsKCiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIH0pLAogICAgb25Ecm9wRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5kcmFnQm90ICE9PSB0aGlzQm90KSByZXR1cm47CiAgICAgICAgaWYgKCFsaW5rcy5vcmlnaW5Cb3QpIHJldHVybjsKCiAgICAgICAgY29uc3QgZHJvcEJvdCA9IHRoYXQudG8uYm90OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgbGV0IGxpbmVUb0JvdHMgPSBsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvOwoKICAgICAgICAgICAgaWYgKGxpbmVUb0JvdHMgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGdldExpbmsoZHJvcEJvdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5lVG9Cb3RzID0gQXJyYXkuaXNBcnJheShsaW5lVG9Cb3RzKSA/IGxpbmVUb0JvdHMgOiBbbGluZVRvQm90c107CgogICAgICAgICAgICAgICAgaWYgKCFsaW5lVG9Cb3RzLmluY2x1ZGVzKGRyb3BCb3QpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGdldExpbmsoLi4ubGluZVRvQm90cywgZHJvcEJvdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaGlkZSBhcm1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGRyb3BCb3QuaWQ7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IHNlbGVjdGlvbiBvbiBvcmlnaW4gYm90LmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkRyb3BFeGl0OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuZHJhZ0JvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwogICAgICAgIGlmICghbGlua3Mub3JpZ2luQm90KSByZXR1cm47CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcm9wQm90OmAsIGRyb3BCb3QpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZSh0cnVlKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgYXJtYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBzZWxlY3Rpb24gb24gb3JpZ2luIGJvdC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25Ecm9wOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuYm90ICE9PSB0aGlzQm90KSByZXR1cm47CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgY29uc3QgZHJvcEJvdCA9IHRoYXQudG8uYm90OwoKICAgICAgICBhYi5saW5rcy5zb3VuZC5hYlBsYXlTb3VuZCh7IHZhbHVlOiB0YWdzLmFybURyb3BTb3VuZCwgZGVmYXVsdFZhbHVlOiB0YWdzLmRlZmF1bHRBcm1Ecm9wU291bmQgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QgJiYgbGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbykgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwogICAgICAgICAgICB0aGlzQm90Lm9yaWdpblNldFNlbGVjdGlvbihsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvKTsKICAgICAgICB9IGVsc2UgaWYgKGRyb3BCb3QpIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5TZXRTZWxlY3Rpb24oZHJvcEJvdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gRHJvcHBlZCBvbiBncmlkLgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcm9wcGVkIG9uIGdyaWQuYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1QbGFjZWQnLCB7IGRpbWVuc2lvbjogdGhhdC50by5kaW1lbnNpb24sIHg6IHRoYXQudG8ueCwgeTogdGhhdC50by55LCB6OiB0aGF0LnRvLnogfSk7CiAgICAgICAgfQogICAgICAgIAogICAgfSksCiAgICBvbkdyaWRDbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHRoaXNCb3Qub3JpZ2luQ2xlYXJTZWxlY3Rpb24oKTsKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgfSksCiAgICBvcmlnaW5DbGVhclNlbGVjdGlvbjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybVNlbGVjdGVkQm90cyA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IG51bGw7CiAgICB9KSwKICAgIG9yaWdpblNldFNlbGVjdGlvbjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHNlbGVjdGVkQm90cyA9IHRoYXQ7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMgPSBzZWxlY3RlZEJvdHMgPyBnZXRMaW5rKHNlbGVjdGVkQm90cykgOiBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lQ29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBsaW5rcy5vcmlnaW5Cb3QudGFncy5hcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybVNlbGVjdGVkQm90cycsIGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpCiAgICAgICAgfQogICAgfSksCiAgICBvbkFueUJvdHNSZW1vdmVkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgLy8gQ2hlY2sgdGhhdCB3ZSBzdGlsbCBoYXZlIHNvbWUgYWN0aXZlIHNlbGVjdGVkIGJvdHMuCiAgICAgICAgICAgIGxldCBhY3RpdmVTZWxlY3RlZEJvdHMgPSBmYWxzZTsKCiAgICAgICAgICAgIGNvbnN0IGFybVNlbGVjdGVkQm90cyA9IGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHM7CgogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcm1TZWxlY3RlZEJvdHMpKSB7CiAgICAgICAgICAgICAgICBhY3RpdmVTZWxlY3RlZEJvdHMgPSBhcm1TZWxlY3RlZEJvdHMuZXZlcnkoYiA9PiAhIWIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0ZWRCb3RzID0gISFhcm1TZWxlY3RlZEJvdHM7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghYWN0aXZlU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgYm90cyB3ZSBoYWQgc2VsZWN0ZWQgbm8gbG9uZ2VyIGV4aXN0LCBkZXN0cm95IHRoaXMgYXJtLgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgdGhhdCBhcm0gaGFzIHNlbGVjdGVkIG5vIGxvbmdlciBleGlzdCwgZGVzdHJveSB0aGlzIGFybS5gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CiAgICAgICAgICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgdGhhdCBhcm0gaGFzIHNlbGVjdGVkIHN0aWxsIGhhcyBhY3RpdmUgYm90cy5gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCA9IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmRyYWdnYWJsZSA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKICAgICAgICB9CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1EZXN0cm95Jyk7CiAgICB9KSwKfTsKCmNvbnN0IGFybUJvdCA9IGNyZWF0ZShhcm0pOwoKcmV0dXJuIGFybUJvdDsnAO61pXniARBvbkFueUJvdERyYWdnaW5nAgQA7rWleYpY0RVAY29uc3QgZHJhZ0JvdCA9IHRoYXQuYm90Owpjb25zdCBkaW1lbnNpb24gPSB0aGF0LmZyb20uZGltZW5zaW9uOwoKaWYgKGRyYWdCb3QubGlua3MuYXJtQm90KSB7CiAgICBpZiAoZHJhZ0JvdC50YWdzLmFybUdyb3VwRHJhZyAmJiBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cykgewogICAgICAgIGxldCBkcmFnQ29vcmRpbmF0b3JCb3QgPSBsaW5rcy5kcmFnQ29vcmRpbmF0b3JCb3Q7CiAgICAgICAgCiAgICAgICAgaWYgKCFkcmFnQ29vcmRpbmF0b3JCb3QpIHsKICAgICAgICAgICAgY29uc3QgZHJhZ0Nvb3JkaW5hdG9yTW9kID0gewogICAgICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICAgICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgICAgICAgICAgICAgIGRpbWVuc2lvbjogZGltZW5zaW9uLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIlgiXTogMCwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWSJdOiAwLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJaIl06IC0xLAogICAgICAgICAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIGRlYnVnOiB0YWdzLmRlYnVnLAogICAgICAgICAgICAgICAgY29sb3I6ICJjbGVhciIsCiAgICAgICAgICAgICAgICBzeXN0ZW06IGBhcm1Hcm91cERyYWcuJHt0aGlzQm90LmlkLnN1YnN0cmluZygwLCA1KX0uY29vcmRpbmF0b3JgLAogICAgICAgICAgICAgICAgb25BbnlCb3RQb2ludGVyVXA6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgZHJhZyBjb29yZGluYXRvcmApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGlua3MubWFuYWdlci5tYXNrcy5kcmFnQ29vcmRpbmF0b3JCb3QgPSBudWxsOyAKICAgICAgICAgICAgICAgICAgICBzaG91dCgnb25Bcm1TdG9wR3JvdXBEcmFnJywgeyB4OiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgJ1gnXSwgeTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICdZJ10gfSk7CiAgICAgICAgICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZHJhZ0Nvb3JkaW5hdG9yQm90ID0gY3JlYXRlKGRyYWdDb29yZGluYXRvck1vZCk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjcmVhdGVkIGRyYWcgY29vcmRpbmF0b3IgYm90OmAsIGRyYWdDb29yZGluYXRvckJvdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG1hc2tzLmRyYWdDb29yZGluYXRvckJvdCA9IGdldExpbmsoZHJhZ0Nvb3JkaW5hdG9yQm90KTsKCiAgICAgICAgICAgIGNvbnN0IGFybVNlbGVjdGVkQm90cyA9IGRyYWdCb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzOwogICAgICAgICAgICBjb25zdCBvbkFybVN0b3BHcm91cERyYWcgPSBgQAogICAgICAgICAgICAgICAgbWFza3MudHJhbnNmb3JtZXIgPSBudWxsOwogICAgICAgICAgICAgICAgbWFza3Mub25Bcm1TdG9wR3JvdXBEcmFnID0gbnVsbDsKICAgICAgICAgICAgICAgIHRhZ3MuJHtkaW1lbnNpb259WCA9IHRhZ3MuJHtkaW1lbnNpb259WCArIHRoYXQueDsKICAgICAgICAgICAgICAgIHRhZ3MuJHtkaW1lbnNpb259WSA9IHRhZ3MuJHtkaW1lbnNpb259WSArIHRoYXQueTsKICAgICAgICAgICAgYAoKICAgICAgICAgICAgZHJhZ0JvdC5tYXNrcy50cmFuc2Zvcm1lciA9IGRyYWdDb29yZGluYXRvckJvdC5pZDsKICAgICAgICAgICAgZHJhZ0JvdC5tYXNrcy5vbkFybVN0b3BHcm91cERyYWcgPSBvbkFybVN0b3BHcm91cERyYWc7CgogICAgICAgICAgICBzZXRUYWdNYXNrKGFybVNlbGVjdGVkQm90cywgInRyYW5zZm9ybWVyIiwgZHJhZ0Nvb3JkaW5hdG9yQm90LmlkLCAidGVtcExvY2FsIik7CiAgICAgICAgICAgIHNldFRhZ01hc2soYXJtU2VsZWN0ZWRCb3RzLCAib25Bcm1TdG9wR3JvdXBEcmFnIiwgb25Bcm1TdG9wR3JvdXBEcmFnLCAidGVtcExvY2FsIik7CiAgICAgICAgfQoKICAgICAgICBjb25zdCB4Q2hhbmdlID0gdGhhdC50by54IC0gdGhhdC5mcm9tLng7CiAgICAgICAgY29uc3QgeUNoYW5nZSA9IHRoYXQudG8ueSAtIHRoYXQuZnJvbS55OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHhDaGFuZ2U6ICR7eENoYW5nZX0sIHlDaGFuZ2U6ICR7eUNoYW5nZX1gKTsKICAgICAgICB9CgogICAgICAgIGRyYWdDb29yZGluYXRvckJvdC50YWdzW2RpbWVuc2lvbiArICJYIl0gPSB4Q2hhbmdlOwogICAgICAgIGRyYWdDb29yZGluYXRvckJvdC50YWdzW2RpbWVuc2lvbiArICJZIl0gPSB5Q2hhbmdlOwogICAgICAgIGRyYWdDb29yZGluYXRvckJvdC50YWdzW2RpbWVuc2lvbiArICJaIl0gPSAtMTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkcmFnIGJvdCB3aXRoIGFybSBkb2VzIG5vdCBxdWFsaWZ5IGZvciBncm91cCBkcmFnZ2luZy5gKTsKICAgICAgICB9CiAgICB9Cn0nAO61pXniAQ1hYlBlcnNvbmFsaXR5AgQA7rWledxtBHRydWUnAO61pXniAQhhYklnbm9yZQIEAO61pXnhbQR0cnVlJwDutaV54gEEZm9ybQIEAO61pXnmbQdub3RoaW5nJwDutaV54gEJYWJWZXJzaW9uAgQA7rWlee5tBTEwLjM5JwDutaV54gETZGVmYXVsdEFybURyb3BTb3VuZAIEAO61pXn0bRlhYi9hdWRpby9zZWxlY3QgbGV2ZWwubXAzJwDutaV54gEXZGVmYXVsdEFybVRlbGVwb3J0U291bmQCBADutaV5jm4SYWIvYXVkaW8vd29vc2gubXAzJwEEYm90cyRiMjZlMTA4OS0xNzJkLTQ1YTktOGQyMi0wNWMzZjU4YzJiZjcBJwDutaV5oW4Gc3lzdGVtAgQA7rWleaJuGGFiLnBlcnNvbmFsaXR5LmFuaW1hdGlvbicA7rWleaFuBGZvcm0CBADutaV5u24Hbm90aGluZycA7rWleaFuCGFiSWdub3JlAgQA7rWlecNuBHRydWUnAO61pXmhbg1tYW5pZmVzdGF0aW9uAgQA7rWlechuKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAO61pXmhbghyZW1lbWJlcgIEAO61pXnvbijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDutaV5oW4YYW5pbWF0aW9uX2FiR3JpZE1hbmlmZXN0AgQA7rWleZZv+g5Ac2hvdXQoInJlc2V0Iik7Cgpjb25zdCBwb3NpdGlvblggPSB0aGF0Py5wb3NpdGlvbi54ID8/IDA7CmNvbnN0IHBvc2l0aW9uWSA9IHRoYXQ/LnBvc2l0aW9uLnkgPz8gMDsKY29uc3QgZGltZW5zaW9uID0gdGhhdD8uZGltZW5zaW9uID8/ICJob21lIjsKY29uc3QgZ3JpZFNjYWxlID0gdGhhdD8uc2NhbGUgPz8gNTsKY29uc3QgbW9tZW50Q291bnQgPSAwOwpjb25zdCBncmlkQm90ID0ge307CgpncmlkQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CmdyaWRCb3QuY29sb3IgPSAiY2xlYXIiOwpncmlkQm90LnN0cm9rZUNvbG9yID0gYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwpncmlkQm90LnNjYWxlID0gMC4wMDE7CmdyaWRCb3Quc2NhbGVaID0gMC4xOwpncmlkQm90LnJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwpncmlkQm90W2RpbWVuc2lvbl0gPSB0cnVlOwpncmlkQm90LnBvaW50YWJsZSA9IGZhbHNlOwpncmlkQm90LmtpbGxUaW1lciA9ICJAIGF3YWl0IG9zLnNsZWVwKDQwMCk7IGRlc3Ryb3kodGhpc0JvdCk7IjsKCmxldCByb3VuZEJvdHM7Cgpmb3IgKGxldCBpID0gZ3JpZFNjYWxlOyBpID4gMDsgaS0tKQp7CiAgICBjb25zdCBib3RDb3VudCA9IGkgKiA4OwoKICAgIGxldCBzaWRlQ291bnQgPSAwOwogICAgbGV0IHBoYXNlRmFjdG9yID0gMDsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJvdENvdW50OyBqKyspCiAgICB7CiAgICAgICAgaWYgKHBoYXNlRmFjdG9yID09IDApCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpICsgc2lkZUNvdW50OwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSBpICsgcG9zaXRpb25ZOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwaGFzZUZhY3RvciA9PSAxKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gaSArIHBvc2l0aW9uWDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKGkgKyBwb3NpdGlvblkpIC0gc2lkZUNvdW50OyAgCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHBoYXNlRmFjdG9yID09IDIpCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoaSArIHBvc2l0aW9uWCkgLSBzaWRlQ291bnQ7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9ICgoaSArIHBvc2l0aW9uWSkgKiAtMSkgOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpIDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKChpICsgcG9zaXRpb25ZKSAqIC0xKSArIHNpZGVDb3VudDsgIAogICAgICAgIH0KCiAgICAgICAgY29uc3QgbmV3R3JpZEJvdCA9IGF3YWl0IGNyZWF0ZShncmlkQm90KTsKCiAgICAgICAgYW5pbWF0ZVRhZyhuZXdHcmlkQm90LCAic2NhbGUiLCB7CiAgICAgICAgICAgIHRvVmFsdWU6IDEsCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogImVsYXN0aWMiLAogICAgICAgICAgICAgICAgbW9kZTogIm91dCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDAuMDEKICAgICAgICB9KS5jYXRjaCgoKSA9PiB7fSk7CgogICAgICAgIG5ld0dyaWRCb3Qua2lsbFRpbWVyKCk7CgogICAgICAgIHNpZGVDb3VudCsrOwoKICAgICAgICBpZiAoc2lkZUNvdW50ID09IGJvdENvdW50IC8gNCkKICAgICAgICB7CiAgICAgICAgICAgIHNpZGVDb3VudCA9IDA7CgogICAgICAgICAgICBwaGFzZUZhY3RvcisrOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoOCk7CiAgICB9Cn0nAO61pXmhbglhYlZlcnNpb24CBADutaV5kX4FMTAuMzknAO61pXmhbgZvbkNoYXQCBADutaV5l35VQC8vIGlmICh0aGF0Lm1lc3NhZ2UgPT0gIkB0ZXN0IikKLy8gewovLyAgICAgdGhpc0JvdC5hbmltYXRpb25fYWJHcmlkTWFuaWZlc3QoKTsKLy8gfScA7rWleaFuC3BlcnNvbmFsaXR5AgQA7rWlee1+KPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAO61pXmhbg1hYlBlcnNvbmFsaXR5AgQA7rWleZR/BHRydWUnAQRib3RzJGI3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYgEnAO61pXmZfwZzeXN0ZW0CBADutaV5mn8VYWIucGVyc29uYWxpdHkuY29uZmlnJwDutaV5mX8IYWJJZ25vcmUCBADutaV5sH8EdHJ1ZScA7rWleZl/BGZvcm0CBADutaV5tX8Hbm90aGluZycA7rWleZl/C2FiQmFzZUNvbG9yAgQA7rWleb1/ByMwMEQ5Q0QnAO61pXmZfxFhYkJhc2VTdHJva2VDb2xvcgIEAO61pXnFfwcjMDBEOUNEJwDutaV5mX8QYWJCbHVlcHJpbnRDb2xvcgIEAO61pXnNfwcjMDA4MjdCJwDutaV5mX8IcmVtZW1iZXICBADutaV51X8o8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA7rWleZl/EWFiQnVpbGRlcklkZW50aXR5AgQA7rWlefx/CmNhc3VhbC5ib3QnAO61pXmZfwlhYlZlcnNpb24CBADutaV5h4ABBTEwLjM5JwDutaV5mX8PYWJCYXNlTWVudUNvbG9yAgQA7rWleY2AAQcjMDBEOUNEJwDutaV5mX8NYWJQZXJzb25hbGl0eQIEAO61pXmVgAEEdHJ1ZScA7rWleZl/DW9uU2tpbGxVcGRhdGUCBADutaV5moABHUB0aGlzQm90LmFiUGVyc29uYWxpdHlMb2FkKCk7JwDutaV5mX8RYWJCYXNlU2hhZG93Q29sb3ICBADutaV5uIABBWJsYWNrJwDutaV5mX8QYWJCYXNlTGFiZWxDb2xvcgIEAO61pXm+gAEFYmxhY2snAO61pXmZfwptYXBPcHRpb25zAgQA7rWlecSAAZ4H8J+nrFsNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzYXRlbGxpdGUiLA0KICAgICAgICAiaWQiOiAic2F0ZWxsaXRlIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiaHlicmlkIiwNCiAgICAgICAgImlkIjogImh5YnJpZCINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgIm9jZWFucyIsDQogICAgICAgICJpZCI6ICJvY2VhbnMiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJvcGVuIHN0cmVldCBtYXAiLA0KICAgICAgICAiaWQiOiAib3NtIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAidGVycmFpbiIsDQogICAgICAgICJpZCI6ICJ0ZXJyYWluIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiZGFyayBncmF5IGNhbnZhcyIsDQogICAgICAgICJpZCI6ICJkYXJrLWdyYXkiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJncmF5IGNhbnZhcyIsDQogICAgICAgICJpZCI6ICJncmF5Ig0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAoZGFyaykiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1uaWdodC12ZWN0b3IiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChuYXZpZ2F0aW9uKSIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzLW5hdmlnYXRpb24tdmVjdG9yIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAidG9wb2dyYXBoaWMiLA0KICAgICAgICAiaWQiOiAidG9wbyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKHJlbGllZikiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1yZWxpZWYtdmVjdG9yIg0KICAgIH0NCl0nAO61pXmZfxRzaG93QUJCYXNlbWFwT3B0aW9ucwIEAO61pXnhhwHEBUBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KDQpzaG91dCgiYWJNZW51UmVmcmVzaCIpOw0KY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9ICdhYkJhc2VtYXBPcHRpb25zTWVudSc7DQoNCmZvciAoY29uc3Qgb3B0aW9uIG9mIHRhZ3MubWFwT3B0aW9ucykgew0KICAgIGlmIChvcHRpb24uaWQgPT0gbWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCkgew0KICAgICAgICBjb250aW51ZTsNCiAgICB9DQogICAgY29uc3Qgb3B0aW9uT2JqID0gDQogICAgew0KICAgICAgICBhYkJhc2VtYXBPcHRpb25zTWVudTogdHJ1ZSwNCiAgICAgICAgY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudTogYEBkZXN0cm95KHRoaXNCb3QpO2AsDQogICAgICAgIG1hcElEOiBvcHRpb24uaWQsDQogICAgICAgIGxhYmVsOiBvcHRpb24ubmFtZSwNCiAgICAgICAgb25DbGljazogYEANCiAgICAgICAgICAgIG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLm1hcElEOw0KICAgICAgICAgICAgc2hvdXQoJ2FiUGVyc29uYWxpdHlDaGFuZ2UnLCB7IGFiTWFwUG9ydGFsQmFzZTogdGFncy5tYXBJRH0pOyANCiAgICAgICAgICAgIHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQogICAgICAgIGANCiAgICB9DQoNCiAgICBhYi5saW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihvcHRpb25PYmopOw0KfScA7rWleZl/C29uR3JpZENsaWNrAgQA7rWleaaNASZAc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCicA7rWleZl/BWRlYnVnAgQA7rWlec2NAQVmYWxzZScA7rWleZl/E2FiUGVyc29uYWxpdHlDaGFuZ2UCBADutaV5040BzAZAaWYgKCF0aGF0KSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IGNoYW5nZWRUYWdzID0gW107Cgpmb3IgKGNvbnN0IGtleSBpbiB0aGF0KSB7CiAgICBpZiAodGFncy5hYlBlcnNvbmFsaXR5VGFncy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgaWYgKG1hc2tzW2tleV0gIT09IHRoYXRba2V5XSkgewogICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIGtleSwgdGhhdFtrZXldLCAnbG9jYWwnKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNoYW5nZWQgJyR7a2V5fScgdG86YCwgc2VsZi5zdHJ1Y3R1cmVkQ2xvbmUodGhhdFtrZXldKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICghY2hhbmdlZFRhZ3MuaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICAgICAgY2hhbmdlZFRhZ3MucHVzaChrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWcuc3lzdGVtfS4ke3RhZ05hbWV9XSAnJHtrZXl9JyBpcyBub3QgYSB2YWxpZCBhYiBwZXJzb25hbGl0eSB0YWcuYCk7CiAgICB9Cn0KCmlmIChjaGFuZ2VkVGFncy5sZW5ndGggPiAwKSB7CiAgICB0aGlzQm90LnZhcnMuaGFzVW5zYXZlZENoYW5nZXMgPSB0cnVlOwogICAgc2hvdXQoJ29uQUJQZXJzb25hbGl0eUNoYW5nZWQnLCB7IGJvdDogdGhpc0JvdCwgdGFnczogY2hhbmdlZFRhZ3MgfSk7CgogICAgaWYgKHRhZ3MuYXV0b3NhdmUpIHsKICAgICAgICB0aGlzQm90LmFiUGVyc29uYWxpdHlTYXZlKCk7CiAgICB9Cn0KJwDutaV5mX8SYWJQZXJzb25hbGl0eVJlc2V0AgQA7rWleaCUAb8IQGlmICh0aGlzQm90LnZhcnMucmVzZXR0aW5nKSB7CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5yZXNldHRpbmcgPSB0cnVlOwoKaWYgKCFhdXRoQm90KSB7CiAgICB0cnkgeyAKICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwogICAgfSBjYXRjaCB7CiAgICAgICAgdGhpc0JvdC52YXJzLnJlc2V0dGluZyA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKaWYgKCFsaW5rcy5yZW1lbWJlcikgewogICAgdGhpc0JvdC52YXJzLnJlc2V0dGluZyA9IGZhbHNlOwogICAgcmV0dXJuOwp9CgovLyBDbGVhciBhbnkgbG9hZGVkIHRhZ3MuCmNsZWFyVGFnTWFza3ModGhpc0JvdCwgJ2xvY2FsJyk7CgppZiAoYXV0aEJvdCkgewogICAgLy8gU2F2ZSBhbiBlbXB0eSBvYmplY3QgdG8gdGhlIHVzZXIncyByZWNvcmQuCiAgICBsZXQgcmVjb3JkUmVzcG9uc2UgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICdhYlBlcnNvbmFsaXR5Q29uZmlnJywge30pOwoKICAgIGlmICghcmVjb3JkUmVzcG9uc2Uuc3VjY2VzcykgewogICAgICAgIGlmIChyZWNvcmRSZXNwb25zZS5lcnJvckNvZGUgPT09ICdub3RfYXV0aG9yaXplZCcpIHsKICAgICAgICAgICAgLy8gQXNrIHVzZXIgdG8gZ3JhbnQgcGVybWlzc2lvbjsKICAgICAgICAgICAgY29uc3QgcGVybWlzc2lvbiA9IGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90LmlkKTsKCiAgICAgICAgICAgIGlmIChwZXJtaXNzaW9uLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIHJlY29yZFJlc3BvbnNlID0gYXdhaXQgb3MucmVjb3JkRGF0YShhdXRoQm90LmlkLCAnYWJQZXJzb25hbGl0eUNvbmZpZycsIHt9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gUmVsb2FkIHRoZSBwZXJzb25hbGl0eS4gV2l0aCB0aGUgdXNlciBwZXJzb25hbGl0eSBlcmFzZWQsIHRoaXMgd2lsbCBlZmZlY3RpdmVseSBsb2FkIGFsbCB0aGUgZGVmYXVsdHMgZnJvbSBhYkNvbmZpZy4KYXdhaXQgdGhpc0JvdC5hYlBlcnNvbmFsaXR5TG9hZCgpOwoKdGhpc0JvdC52YXJzLnJlc2V0dGluZyA9IGZhbHNlOycA7rWleZl/EWFiUGVyc29uYWxpdHlTYXZlAgQA7rWleeCcAYULQGlmICh0aGlzQm90LnZhcnMuc2F2aW5nKSB7CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5zYXZpbmcgPSB0cnVlOwoKaWYgKCFhdXRoQm90KSB7CiAgICB0cnkgeyAKICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwogICAgfSBjYXRjaCB7CiAgICAgICAgdGhpc0JvdC52YXJzLnNhdmluZyA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy8gU2F2ZSBhbGwgdGhlIGN1cnJlbnQgYWIgcGVyc29uYWxpdHkgdGFncyB0byB0aGUgdXNlcidzIHJlY29yZC4KY29uc3QgdXNlclBlcnNvbmFsaXR5ID0ge307Cgpmb3IgKGNvbnN0IHRhZ05hbWUgb2YgdGFncy5hYlBlcnNvbmFsaXR5VGFncykgewogICAgaWYgKHRhZ3NbdGFnTmFtZV0gIT0gbnVsbCkgewogICAgICAgIHVzZXJQZXJzb25hbGl0eVt0YWdOYW1lXSA9IHRhZ3NbdGFnTmFtZV07CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNhdmluZyB1c2VyIHBlcnNvbmFsaXR5OmAsIHNlbGYuc3RydWN0dXJlZENsb25lKHVzZXJQZXJzb25hbGl0eSkpOwp9CgpsZXQgcmVjb3JkUmVzcG9uc2UgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICdhYlBlcnNvbmFsaXR5Q29uZmlnJywgdXNlclBlcnNvbmFsaXR5KTsKCmlmICghcmVjb3JkUmVzcG9uc2Uuc3VjY2VzcykgewogICAgaWYgKHJlY29yZFJlc3BvbnNlLmVycm9yQ29kZSA9PT0gJ25vdF9hdXRob3JpemVkJykgewogICAgICAgIC8vIEFzayB1c2VyIHRvIGdyYW50IHBlcm1pc3Npb247CiAgICAgICAgY29uc3QgcGVybWlzc2lvbiA9IGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90LmlkKTsKCiAgICAgICAgaWYgKHBlcm1pc3Npb24uc3VjY2VzcykgewogICAgICAgICAgICByZWNvcmRSZXNwb25zZSA9IGF3YWl0IG9zLnJlY29yZERhdGEoYXV0aEJvdC5pZCwgJ2FiUGVyc29uYWxpdHlDb25maWcnLCB1c2VyUGVyc29uYWxpdHkpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKHJlY29yZFJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYHVwZGF0ZWQgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkYCwgbG9nVHlwZTogJ2xvZyd9KTsKfSBlbHNlIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGZhaWxlZCB0byB1cGRhdGUgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkLlxuJHtKU09OLnN0cmluZ2lmeShyZWNvcmRSZXNwb25zZSwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnZXJyb3InfSk7Cn0KCnRoaXNCb3QudmFycy5zYXZpbmcgPSBmYWxzZTsKdGhpc0JvdC52YXJzLmhhc1Vuc2F2ZWRDaGFuZ2VzID0gZmFsc2U7JwDutaV5mX8RYWJQZXJzb25hbGl0eUxvYWQCBADutaV55qcBziBAaWYgKHRoaXNCb3QudmFycy5sb2FkaW5nKSB7CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5sb2FkaW5nID0gdHJ1ZTsKCmlmICghYXV0aEJvdCkgewogICAgdHJ5IHsgCiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKICAgIH0gY2F0Y2ggewogICAgICAgIHRoaXNCb3QudmFycy5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgcmV0dXJuOwogICAgfQp9CgppZiAoIWxpbmtzLnJlbWVtYmVyKSB7CiAgICB0aGlzQm90LnZhcnMubG9hZGluZyA9IGZhbHNlOwogICAgcmV0dXJuOwp9CgovLyBSZXRyaWV2ZSBwZXJzb25hbGl0eSBjb25maWcgZnJvbSB1c2VyJ3MgcmVjb3JkLgpsZXQgdXNlclBlcnNvbmFsaXR5RGF0YSA9IHt9OwoKaWYgKGF1dGhCb3QpIHsKICAgIGNvbnN0IGdldERhdGFSZXNwb25zZSA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdC5pZCwgJ2FiUGVyc29uYWxpdHlDb25maWcnKTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2V0RGF0YVJlc3BvbnNlOmAsIHNlbGYuc3RydWN0dXJlZENsb25lKGdldERhdGFSZXNwb25zZSkpOwogICAgfQoKICAgIGlmIChnZXREYXRhUmVzcG9uc2Uuc3VjY2VzcykgewogICAgICAgIHVzZXJQZXJzb25hbGl0eURhdGEgPSBnZXREYXRhUmVzcG9uc2UuZGF0YTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGdldERhdGFSZXNwb25zZS5lcnJvckNvZGUgIT09ICdkYXRhX25vdF9mb3VuZCcpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiUGVyc29uYWxpdHlDb25maWcgZ2V0IGVycm9yOmAsIHsgZXJyb3JDb2RlOiBnZXREYXRhUmVzcG9uc2UuZXJyb3JDb2RlLCBlcnJvck1lc3NhZ2U6IGdldERhdGFSZXNwb25zZS5lcnJvck1lc3NhZ2UgfSk7CiAgICAgICAgICAgIHRoaXNCb3QudmFycy5sb2FkaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9Cn0KCi8vIENsZWFyIGFueSBwcmV2aW91c2x5IGxvYWRlZCB0YWdzLgpjbGVhclRhZ01hc2tzKHRoaXNCb3QpOwoKLy8gUnlhbiAoQXVnIDI5LCAyMDI1KTogaW0gbm90IHN1cmUgZXhhY3RseSB3aGF0IGlzIGhhcHBlbmluZyBoZXJlIGJ1dCB3aXRob3V0IHNsZWVwaW5nIG9uIHRoZXNlIGJpZyB0YWcgbWFzayBjaGFuZ2VzLCB0aGV5IGRvbnQgYWxsIHNlZW0gdG8gY29tZSBpbiBwcm9wZXJseS4KYXdhaXQgb3Muc2xlZXAoMTAwKTsKCi8vIExvYWQgdGFncyBmcm9tIGVpdGhlciB0aGUgdXNlcidzIHBlcnNvbmFsaXR5IGNvbmZpZyAoaWYgYXZhaWxhYmxlKSBvciBsb2FkIGEgZGVmYXVsdCBmcm9tIHRoZSBhYkNvbmZpZy4KZm9yIChjb25zdCB0YWdOYW1lIG9mIHRhZ3MuYWJQZXJzb25hbGl0eVRhZ3MpIHsKICAgIGlmICh1c2VyUGVyc29uYWxpdHlEYXRhW3RhZ05hbWVdICE9IG51bGwpIHsKICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIHRhZ05hbWUsIHVzZXJQZXJzb25hbGl0eURhdGFbdGFnTmFtZV0sICdsb2NhbCcpOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvYWRlZCAnJHt0YWdOYW1lfScgZnJvbSB1c2VyIHBlcnNvbmFsaXR5IGRhdGE6YCwgc2VsZi5zdHJ1Y3R1cmVkQ2xvbmUodXNlclBlcnNvbmFsaXR5RGF0YVt0YWdOYW1lXSkpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAobGlua3MucmVtZW1iZXIudGFnc1t0YWdOYW1lXSAhPSBudWxsKSB7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCB0YWdOYW1lLCBsaW5rcy5yZW1lbWJlci50YWdzW3RhZ05hbWVdLCAnbG9jYWwnKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb2FkZWQgJyR7dGFnTmFtZX0nIGZyb20gYWIgY29uZmlnOmAsIHNlbGYuc3RydWN0dXJlZENsb25lKGxpbmtzLnJlbWVtYmVyLnRhZ3NbdGFnTmFtZV0pKTsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmICh0YWdOYW1lID09PSAnYWJCYXNlR3JpZFBvcnRhbENvbG9yJykgewogICAgICAgIGdyaWRQb3J0YWxCb3QudGFncy5wb3J0YWxDb2xvciA9IHRhZ3MuYWJCYXNlR3JpZFBvcnRhbENvbG9yOwogICAgfSBlbHNlIGlmICh0YWdOYW1lID09PSAnYWJNYXBQb3J0YWxCYXNlJykgewogICAgICAgIG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLmFiTWFwUG9ydGFsQmFzZTsKICAgICAgICBtaW5pTWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCA9IHRhZ3MuYWJNYXBQb3J0YWxCYXNlOwogICAgfSBlbHNlIGlmICh0YWdOYW1lID09PSAnYWJQcmVmZXJyZWRBSU1vZGVsJykgewogICAgICAgIC8vIENoZWNrIHRoYXQgdGhpcyBhaSBtb2RlbCBpcyBzdGlsbCBhdmFpbGFibGUuCiAgICAgICAgY29uc3QgZGVzaXJlZE1vZGVsID0gdGFncy5hYlByZWZlcnJlZEFJTW9kZWw7CiAgICAgICAgY29uc3QgYWlDaGF0TW9kZWxzID0gY29uZmlnQm90LnRhZ3MuYWlDaGF0TW9kZWxzID8/IChhd2FpdCBhaS5saXN0Q2hhdE1vZGVscygpKTsKICAgICAgICBsZXQgZm91bmQgPSBkZXNpcmVkTW9kZWwgJiYgYWlDaGF0TW9kZWxzLnNvbWUoZSA9PiBlLm5hbWUgPT09IGRlc2lyZWRNb2RlbCk7CgogICAgICAgIGlmICghZm91bmQpIHsKICAgICAgICAgICAgLy8gVGhlIGFiUHJlZmVycmVkQUlNb2RlbCBpcyBub3QgYXZhaWxhYmxlLiBUcnkgZmFsbGluZyBiYWNrIHRvIGFiQ29uZmlnIGRlZmF1bHQuCiAgICAgICAgICAgIGZvdW5kID0gbGlua3MucmVtZW1iZXIudGFncy5hYlByZWZlcnJlZEFJTW9kZWwgJiYgYWlDaGF0TW9kZWxzLnNvbWUoZSA9PiBlLm5hbWUgPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJQcmVmZXJyZWRBSU1vZGVsKTsKICAgICAgICAgICAgaWYgKGZvdW5kKSB7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdhYlByZWZlcnJlZEFJTW9kZWwnLCBsaW5rcy5yZW1lbWJlci50YWdzLmFiUHJlZmVycmVkQUlNb2RlbCwgJ2xvY2FsJyk7CgogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiUHJlZmVycmVkQUlNb2RlbCAnJHtkZXNpcmVkTW9kZWx9JyBpcyBub3QgYXZhaWxhYmxlLCBmYWxsaW5nIGJhY2sgdG8gYWJDb25maWcgZGVmYXVsdCAnJHtsaW5rcy5yZW1lbWJlci50YWdzLmFiUHJlZmVycmVkQUlNb2RlbH0nYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBUaGUgYWJDb25maWcgZGVmYXVsdCBmb3IgYWJQcmVmZXJyZWRBSU1vZGVsIGlzIG5vdCBhdmFpbGFibGUuIEZhbGxiYWNrIHRvIHRoZSBDYXN1YWxPUyBkZWZhdWx0LgogICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdE1vZGVsID0gYWlDaGF0TW9kZWxzLmZpbmQoZSA9PiBlLmlzRGVmYXVsdCkubmFtZTsKICAgICAgICAgICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2FiUHJlZmVycmVkQUlNb2RlbCcsIGRlZmF1bHRNb2RlbCwgJ2xvY2FsJyk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYlByZWZlcnJlZEFJTW9kZWwgJyR7ZGVzaXJlZE1vZGVsfScgaXMgbm90IGF2YWlsYWJsZSwgZmFsbGluZyBiYWNrIHRvIENhc3VhbE9TIGRlZmF1bHQgJyR7ZGVmYXVsdE1vZGVsfSdgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9CiAgICB9Cn0KCi8vIFJ5YW4gKEF1ZyAyOSwgMjAyNSk6IGltIG5vdCBzdXJlIGV4YWN0bHkgd2hhdCBpcyBoYXBwZW5pbmcgaGVyZSBidXQgd2l0aG91dCBzbGVlcGluZyBvbiB0aGVzZSBiaWcgdGFnIG1hc2sgY2hhbmdlcywgdGhleSBkb250IGFsbCBzZWVtIHRvIGNvbWUgaW4gcHJvcGVybHkuCmF3YWl0IG9zLnNsZWVwKDEwMCk7Cgp0aGlzQm90LnZhcnMubG9hZGluZyA9IGZhbHNlOwpzaG91dCgnb25BQlBlcnNvbmFsaXR5TG9hZGVkJywgeyBib3Q6IHRoaXNCb3QgfSk7JwDutaV5mX8RYWJQZXJzb25hbGl0eVRhZ3MCBADutaV5tcgBqgLwn6esWwogICAgImFiQmFzZUNvbG9yIiwKICAgICJhYkJhc2VMYWJlbENvbG9yIiwKICAgICJhYkJhc2VNZW51Q29sb3IiLAogICAgImFiQmFzZU1lbnVMYWJlbENvbG9yIiwKICAgICJhYkJhc2VTaGFkb3dDb2xvciIsCiAgICAiYWJCYXNlU3Ryb2tlQ29sb3IiLAogICAgImFiQmx1ZXByaW50Q29sb3IiLAogICAgImFiQnVpbGRlcklkZW50aXR5IiwKICAgICJhYkJhc2VHcmlkUG9ydGFsQ29sb3IiLAogICAgImFiUHJlZmVycmVkQUlNb2RlbCIsCiAgICAiYWJDYXRhbG9nTmFtZSIsCiAgICAiYWJNYXBQb3J0YWxCYXNlIgpdJwDutaV5mX8IYXV0b3NhdmUCBADutaV53soBBHRydWUnAQRib3RzJGI5YjgyODE5LTFmMTQtNDM5Mi04OGE5LTUyZjY3YTlmOGU1NQEnAO61pXnjygEGc3lzdGVtAgQA7rWleeTKARhhYi5wZXJzb25hbGl0eS5hcm1fbnVkZ2UnAO61pXnjygENb25BQkFybVBsYWNlZAIEAO61pXn9ygE4QHNldFRhZ01hc2sodGhpc0JvdCwgJ2hhc0FybUJlZW5QbGFjZWQnLCB0cnVlLCAnbG9jYWwnKTsnAO61pXnjygEJb25BQkF3YWtlAgQA7rWlebbLATBAYXdhaXQgb3Muc2xlZXAoMjUwKTsKdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnAO61pXnjygEIYWJJZ25vcmUCBADutaV558sBBHRydWUnAO61pXnjygENYWJQZXJzb25hbGl0eQIEAO61pXnsywEEdHJ1ZScA7rWleePKAQRmb3JtAgQA7rWlefHLAQdub3RoaW5nJwDutaV548oBBWxlYXJuAgQA7rWlefnLASjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDutaV548oBDW1hbmlmZXN0YXRpb24CBADutaV5oMwBKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAO61pXnjygEIcmVtZW1iZXICBADutaV5x8wBKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAO61pXnjygEFZGVidWcCBADutaV57swBBWZhbHNlJwDutaV548oBDmFybU51ZGdlV2FpdE1TAgQA7rWlefTMAQQ1MDAwJwDutaV548oBD29uQUJJbml0aWFsaXplZAIEAO61pXn5zAEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwDutaV548oBD2FiU3RhcnRBcm1OdWRnZQIEAO61pXmVzQGCH0BpZiAodGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhlcmUgaXMgYWxyZWFkeSBhIG51ZGdlIGluIHByb2dyZXNzLmApOwogICAgfQogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUgPSB0cnVlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhcnRpbmcgbnVkZ2UuLi5gKQp9CgpmdW5jdGlvbiBjYW5OdWRnZSgpOiBib29sZWFuIHsKICAgIC8vIENhbid0IGhhdmUgcGxhY2VkIHRoZSBhcm0gYWxyZWFkeS4KICAgIGlmICh0YWdzLmhhc0FybUJlZW5QbGFjZWQpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYXJtIHBsYWNlbWVudCBoYXMgYWxyZWFkeSBvY2N1cmVkLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gQUIgbWFuaWZlc3RhdGlvbiBib3QgbXVzdCBiZSBhY3RpdmUuCiAgICBpZiAoIWxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYWIgbWFuaWZlc3RhdGlvbiBib3QgaXMgaW5hY3RpdmUuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBBQiBjaGF0IGJhciBtdXN0IGJlIGNsb3NlZC4KICAgIGlmIChsaW5rcy5pbnB1dC5tYXNrcy5jaGF0T3BlbikgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBhYiBjaGF0IGJhciBpcyBvcGVuLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gVGhlIGluc3QgbXVzdCBiZSBlbXB0eSBvZiBhbGwgYm90cy4gVGhlIGV4Y2VwdGlvbnMgYXJlIGFiIGJvdHMgYW5kIGJ1aWx0LWluIGJvdHMuCiAgICBjb25zdCB1c2VyTWFkZUJvdCA9IGdldEJvdCgoYikgPT4gewogICAgICAgIHJldHVybiAhYi50YWdzLnN5c3RlbT8uc3RhcnRzV2l0aCgnYWIuJykgJiYKICAgICAgICAgICAgICAgIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmCiAgICAgICAgICAgICAgICAhYi50YWdzLmFiRWdnICYmIC8vIERvbid0IGluY2x1ZGUgYWJFZ2cgYm90cyBhcyAidXNlciBtYWRlIi4KICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJMb2FkZWRTa2lsbCAmJiAvLyBEb24ndCBpbmNsdWRlIGxvYWRlZCBza2lsbCBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgICAgICAgICAgICAgIWIudGFncy5hYkJvdCAvLyBEb24ndCBpbmNsdWRlIGFueSBib3RzIHRoYXQgYXJlIGZsYWdnZWQgd2l0aCBhbiBhYkJvdCB0YWcuCiAgICB9KQogICAgCiAgICBpZiAodXNlck1hZGVCb3QpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1Z1VzZXJNYWRlQm90cykgewogICAgICAgICAgICAgICAgY29uc3QgdXNlck1hZGVCb3RzID0gZ2V0Qm90cygoYikgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhYi50YWdzLnN5c3RlbT8uc3RhcnRzV2l0aCgnYWIuJykgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAhYi50YWdzLmFiRWdnIC8vIERvbid0IGluY2x1ZGUgYWJFZ2cgYm90cyBhcyAidXNlciBtYWRlIi4KICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogaW5zdCBjb250YWlucyB1c2VyIG1hZGUgYm90cy5gLCB1c2VyTWFkZUJvdHMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGluc3QgY29udGFpbnMgdXNlciBtYWRlIGJvdHMuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIE1lbnUgcG9ydGFsIG11c3QgZWl0aGVyIGJlIGluYWN0aXZlIG9yIG5vdCBoYXZlIGFueSBib3RzIGluIHRoZSBjdXJyZW50bHkgYWN0aXZlIG1lbnUgcG9ydGFsLgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwpIHsKICAgICAgICBjb25zdCBib3RJbk1lbnVQb3J0YWwgPSBnZXRCb3QoKGIpID0+IHsKICAgICAgICAgICAgcmV0dXJuIGIudGFnc1tjb25maWdCb3QudGFncy5tZW51UG9ydGFsXSA9PT0gdHJ1ZQogICAgICAgIH0pOwoKICAgICAgICBpZiAoYm90SW5NZW51UG9ydGFsKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogbWVudVBvcnRhbCBpcyBjdXJyZW50bHkgb3BlbiBhbmQgaGFzIGJvdHMgaW4gaXQuYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKfQoKaWYgKGNhbk51ZGdlKCkpIHsKICAgIC8vIFN0YXJ0IG51ZGdlIGZvciBhcm0gcGxhY2VtZW50LgogICAgYXdhaXQgb3Muc2xlZXAodGFncy5hcm1OdWRnZVdhaXRNUyk7CgogICAgaWYgKGNhbk51ZGdlKCkpIHsKICAgICAgICBjb25zdCBhYlBvc2l0aW9uWCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QudGFnc1tsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uICsgJ1gnXTsKICAgICAgICBjb25zdCBhYlBvc2l0aW9uWSA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QudGFnc1tsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uICsgJ1knXTsKCiAgICAgICAgY29uc3QgZ3JpZENsaWNrUGFyYW1zID0gewogICAgICAgICAgICBkaW1lbnNpb246IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24sCiAgICAgICAgICAgIHBvc2l0aW9uOiB7IHg6IGFiUG9zaXRpb25YICsgNSwgeTogYWJQb3NpdGlvblkgfSwKICAgICAgICAgICAgZm9yY2VBcm1QbGFjZW1lbnQ6IHRydWUsCiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uKSB7CiAgICAgICAgICAgIC8vIE1hcCBwb3J0YWwgaXMgaW4gZGlmZmVyZW50IGNvb3JkaW5hdGUgc3BhY2UgYW5kIHNjYWxlLgogICAgICAgICAgICBncmlkQ2xpY2tQYXJhbXMucG9zaXRpb24ueCA9IGFiUG9zaXRpb25YICsgMC4wMDAzNTc0MzQwNjg0MDUzODIzOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3aGlzcGVyaW5nIG9uR3JpZENsaWNrIHRvIHRoZSBhYiBtYW5pZmVzdGF0aW9uIGJvdCB3aXRoIHRoZSBwYXJhbXM6YCwgZ3JpZENsaWNrUGFyYW1zKQogICAgICAgIH0KCiAgICAgICAgLy8gRm9yY2UgYWIgYXJtIHBsYWNlbWVudCB1c2luZyB0aGUgb25HcmlkQ2xpY2sgbGlzdGVuZXIgb2YgdGhlIG1hbmlmZXN0YXRpb24gYm90LgogICAgICAgIHdoaXNwZXIobGlua3MubWFuaWZlc3RhdGlvbiwgJ29uR3JpZENsaWNrJywgZ3JpZENsaWNrUGFyYW1zKTsKICAgIH0KfQoKdGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlID0gZmFsc2U7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkb25lYCk7Cn0nAO61pXnjygEQb25BQkNoYXRCYXJDbG9zZQIEAO61pXmY7AEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwDutaV548oBBWlucHV0AgQA7rWlebTsASjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDutaV548oBCWFiVmVyc2lvbgIEAO61pXnb7AEFMTAuMzknAO61pXnjygEPb25Qb3J0YWxDaGFuZ2VkAgQA7rWleeHsAYUBQGNvbnN0IHsgcG9ydGFsLCBkaW1lbnNpb24gfSA9IHRoYXQ7CgppZiAocG9ydGFsID09PSAnbWVudVBvcnRhbCcpIHsKICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsKICAgIH0KfScA7rWleePKAQ1hYk1lbnVSZWZyZXNoAgQA7rWleeftARtAdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnAO61pXnjygERZGVidWdVc2VyTWFkZUJvdHMCBADutaV5g+4BBWZhbHNlJwEEYm90cyRkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQBJwDutaV5ie4BBnN5c3RlbQIEAO61pXmK7gEcYWIucGVyc29uYWxpdHkubWFuaWZlc3RhdGlvbicA7rWleYnuAQRmb3JtAgQA7rWleafuAQdub3RoaW5nJwDutaV5ie4BC2Rlc2NyaXB0aW9uAgQA7rWlea/uAThUaGlzIHNraWxsIGNvbnRyb2xzIHRoZSBhY3R1YWwgYm90IGZvciB0aGUgYWIgaW50ZXJmYWNlLicA7rWleYnuAQVsZWFybgIEAO61pXno7gEo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA7rWleYnuAQ9vblBvcnRhbENoYW5nZWQCBADutaV5j+8BpElAY29uc3QgUE9SVEFMU19USEFUX0hJREUgPSBuZXcgU2V0KFsKICAgICJzeXN0ZW1Qb3J0YWwiLAogICAgInNoZWV0UG9ydGFsIgpdKQoKY29uc3QgUE9SVEFMU19USEFUX01BTklGRVNUID0gbmV3IFNldChbCiAgICAiZ3JpZFBvcnRhbCIsCiAgICAibWFwUG9ydGFsIgpdKTsKCmNvbnN0IE1BUF9MT0FEX1dBSVRfVElNRSA9IDEwMDA7Cgpmb3IgKGNvbnN0IHBvcnRhbCBvZiBQT1JUQUxTX1RIQVRfSElERSkgewogICAgaWYgKGNvbmZpZ0JvdC50YWdzW3BvcnRhbF0gIT0gbnVsbCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYSBwb3J0YWwgdGhhdCBoaWRlcyBhYiBpcyBvcGVuIC0gaGlkaW5nIGFiQm90IGFuZCBpZ25vcmluZy5gKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmFiQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3MuYWJCb3QpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgppZiAoY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgIT0gbnVsbCB8fCBjb25maWdCb3QudGFncy5zeXN0ZW1Qb3J0YWwgIT0gbnVsbCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoZWV0IHBvcnRhbCBvciBzeXN0ZW0gcG9ydGFsIG9wZW5lZCAtIGhpZGluZyBhYkJvdCBhbmQgaWdub3JpbmcuYCk7CiAgICB9CgogICAgaWYgKHRhZ3MuYWJCb3QpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKICAgIH0KCiAgICByZXR1cm47Cn0KCmlmICghdGFncy5hYkF3YWtlKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWIgaXMgbm90IGF3YWtlIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAidGFnUG9ydGFsIikgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRhZ1BvcnRhbCBjaGFuZ2VkIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAibWVudVBvcnRhbCIpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtZW51UG9ydGFsIGNoYW5nZWQgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRoYXQucG9ydGFsID09ICJncmlkUG9ydGFsIiAmJiBjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBncmlkUG9ydGFsIGNoYW5nZWQsIGJ1dCBhbHNvIGFscmVhZHkgaW4gdGhlIG1hcFBvcnRhbCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBUaGUgbWFwIHBvcnRhbCBpcyB0b3VnaC4gSXQgc2VlbXMgdG8gdmFyeSBpbiBsb2FkaW5nIHNwZWVkIG9uCi8vIHZhcmlvdXMgaGFyZHdhcmUgYW5kIG5ldHdvcmtzIGFuZCBoYXMgYnkgdGhlIHRpbWUgb25Qb3J0YWxDaGFuZ2VkIGlzIGNhbGxlZCBpdCBkb2VzbnQKLy8gc2VlbSBndWFyZW50ZWVkIHRvIGJlIGFjdHVhbGx5IHJlYWR5LiBBZGRpbmcgYSBoYXJkY29kZWQgd2FpdCB0aW1lIHRvIGdpdmUgdGhlIHBvcnRhbCBzcGFjZSB0byBnZXQKLy8gdGhlIG1hcCBwb3J0YWwgZnVsbHkgbG9hZGVkIGJlZm9yZSBjb250aW51aW5nIHdpdGggbWFuaWZlc3RpbmcgYWIuCi8vCi8vIEF0IHNvbWUgcG9pbnQgdGhpcyBjYW4gZ28gYXdheSBpZiB3ZSBldmVyIGdldCBhIHNob3V0IG9yIHNvbWUgb3RoZXIgZ2F1cmVudGVlIHRoYXQgdGhlIG1hcCBwb3J0YWwgaXMgbG9hZGVkL3JlYWR5LgppZiAodGhhdC5wb3J0YWwgPT09ICdtYXBQb3J0YWwnKSB7CiAgICBpZiAodGhhdC5kaW1lbnNpb24pIHsKICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgJiYgIXRoaXNCb3QudmFycy5tYXBQb3J0YWxJbml0aWFsTG9hZGVkKSB7CiAgICAgICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gb3Muc2xlZXAoTUFQX0xPQURfV0FJVF9USU1FKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3YWl0aW5nIGZvciBtYXAgcG9ydGFsIHRvIGZpbmlzaCBsb2FkaW5nOiAke01BUF9MT0FEX1dBSVRfVElNRX1tc2ApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlci50aGVuKCgpID0+IHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gbnVsbDsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbEluaXRpYWxMb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXAgcG9ydGFsIGxvYWRlZC5gKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSkKCiAgICAgICAgICAgIC8vIGF3YWl0IHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyOwogICAgICAgICAgICAvLyB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CiAgICAgICAgICAgIC8vIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcCBwb3J0YWwgaXMgYWxyZWFkeSBsb2FkZWQuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkZWQgPSBmYWxzZTsKICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFwIHBvcnRhbCBoYXMgYmVlbiB1bmxvYWRlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIFN0YXJ0IGNoZWNrcyBmb3IgaWYvd2hlcmUgd2UgbmVlZCB0byBtYW5pZmVzdCBhYi4KbGV0IG5ld0FCID0gZmFsc2U7CmxldCBuZXdBQlBvcnRhbDsKbGV0IG5ld0FCUG9zaXRpb247CmxldCBmb2N1c0NhbWVyYSA9IHRydWU7CmxldCBmb2N1c0NhbWVyYVN0YXJ0Wm9vbTsKCmlmIChQT1JUQUxTX1RIQVRfTUFOSUZFU1QuaGFzKHRoYXQucG9ydGFsKSAmJiB0aGF0LmRpbWVuc2lvbikgewogICAgLy8gQSBwb3J0YWwgdGhhdCBtYW5pZmVzdHMgYWIgaGFzIGp1c3QgY2hhbmdlZCBkaW1lbnNpb24uCiAgICAvLyBNYW5pZmVzdCBhYiBpbiB0aGUgbmV3IGRpbWVuc2lvbi4KICAgIGlmICh0aGF0LnBvcnRhbCA9PSAibWFwUG9ydGFsIiB8fCB0aGF0LnBvcnRhbCA9PSAibWluaU1hcFBvcnRhbCIpIHs7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYW5pZmVzdGluZyBhYiBib3QgaW4gbWFwIHBvcnRhbCBkaW1lbnNpb24gJyR7dGhhdC5kaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCB0aGlzQm90LmdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICBuZXdBQlBvcnRhbCA9IHRoYXQucG9ydGFsOwogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgcG9zaXRpb246IG5ld0FCUG9zaXRpb24gfSk7CiAgICAgICAgZm9jdXNDYW1lcmFTdGFydFpvb20gPSBhd2FpdCB0aGlzQm90LmdldFN0YXJ0Q2FtZXJhWm9vbSgnbWFwJyk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hbmlmZXN0aW5nIGFiIGJvdCBkaW1lbnNpb24gJyR7dGhhdC5kaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCB0aGlzQm90LmdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdncmlkJyk7CiAgICAgICAgbmV3QUJQb3J0YWwgPSB0aGF0LnBvcnRhbDsKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwogICAgICAgIGZvY3VzQ2FtZXJhU3RhcnRab29tID0gYXdhaXQgdGhpc0JvdC5nZXRTdGFydENhbWVyYVpvb20oJ2dyaWQnKTsKICAgIH0KfSBlbHNlIGlmICgoUE9SVEFMU19USEFUX01BTklGRVNULmhhcyh0aGF0LnBvcnRhbCkgfHwgUE9SVEFMU19USEFUX0hJREUuaGFzKHRoYXQucG9ydGFsKSkgJiYgCiAgICAgICAgICAgIXRoYXQuZGltZW5zaW9uICYmIAogICAgICAgICAgIChjb25maWdCb3QudGFncy5ncmlkUG9ydGFsIHx8IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkKKSB7CiAgICAvLyBBIHBvcnRhbCB0aGF0IHR5cGljYWxseSBoaWRlcyBvciByZS1tYW5pZmVzdHMgYWIganVzdCBjbG9zZWQsIGJ1dCBlaXRoZXIgdGhlIGdyaWQgb3IgbWFwIHBvcnRhbCBhcmUgc3RpbGwgb3Blbi4KICAgIC8vIFN1bW1vbiBhYiBpbiBlaXRoZXIgdGhlIG1hcFBvcnRhbCBvciBncmlkUG9ydGFsLgogICAgbGV0IHN1bW1vbkRpbWVuc2lvbjsKCiAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICAgICAgc3VtbW9uRGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ21hcFBvcnRhbCc7CiAgICAgICAgCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10pIHsKICAgICAgICAgICAgLy8gVXNlIGxhc3Qga25vd24gcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IG1hcCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IHRoaXNCb3QuZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ21hcCcpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCkgewogICAgICAgIHN1bW1vbkRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CiAgICAgICAgbmV3QUJQb3J0YWwgPSAnZ3JpZFBvcnRhbCc7CgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddKSB7CiAgICAgICAgICAgIC8vIFVzZSBsYXN0IGtub3duIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gbGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVc2UgZGVmYXVsdCBncmlkIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgdGhpc0JvdC5nZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignZ3JpZCcpOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoc3VtbW9uRGltZW5zaW9uKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdW1tb25pbmcgYWIgYm90IGluICR7bmV3QUJQb3J0YWx9IGRpbWVuc2lvbiAnJHtzdW1tb25EaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiBzdW1tb25EaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwoKICAgICAgICBpZiAoUE9SVEFMU19USEFUX0hJREUuaGFzKHRoYXQucG9ydGFsKSkgewogICAgICAgICAgICAvLyBJZiB0aGUgcG9ydGFsIHRoYXQgY2xvc2VkIHdhcyBhIHBvcnRhbCB0aGF0IGhpZGVzIGFiLCB0aGVuIGRvbnQgcnVuIHRoZSBjYW1lcmEgZm9jdXMuCiAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBqdXN0IHVzZSB0aGUgcHJldmlvdXMgY2FtZXJhIHBvc2l0aW9uIGFscmVhZHkgc3RvcmVkIGluIG1lbW9yeS4KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2lsbCBub3QgZm9jdXMgY2FtZXJhIG9uIGFiIGJlY2F1c2Ugd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhlIHByZXZpb3VzIGNhbWVyYSBwb3NpdGlvbi5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb2N1c0NhbWVyYSA9IGZhbHNlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RoIHRoZSBtYXAgYW5kIGdyaWQgcG9ydGFsIGFyZSBib3RoIGNsb3NlZCwgY2Fubm90IHN1bW1vbiBhYiBpbiBlaXRoZXIuYCk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgcmV0dXJuOwp9CgppZiAoZm9jdXNDYW1lcmEgJiYgbGlua3MucmVtZW1iZXIudGFncy5tYXBQcmV2ZW50Rm9jdXMpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYW1lcmEgZm9jdXMgYW5pbWF0aW9uIGJlY2F1c2UgbWFwUHJldmVudEZvY3VzIGlzIHNldCB0byB0cnVlIG9uIHRoZSBhYiByZW1lbWJlciBib3QuYCk7CiAgICB9CgogICAgZm9jdXNDYW1lcmEgPSBmYWxzZTsKfQoKaWYgKG5ld0FCICYmIGZvY3VzQ2FtZXJhKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mbyAmJiAKICAgICAgICB0aGlzQm90LnZhcnMuYWN0aXZlRm9jdXNJbmZvLnBvcnRhbCA9PT0gdGhhdC5wb3J0YWwgJiYgCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5kaW1lbnNpb24gPT09IHRoYXQuZGltZW5zaW9uICYmCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5wb3NpdGlvbj8ueCA9PT0gbmV3QUJQb3NpdGlvbi54ICYmCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5wb3NpdGlvbj8ueSA9PT0gbmV3QUJQb3NpdGlvbi55CiAgICApIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraXBwaW5nIGNhbWVyYSBmb2N1cyBhbmltYXRpb24gYmVjYXVzZSBvbmUgaXMgYWxyZWFkeSBhY3RpdmUgd2l0aCB0aGUgc2FtZSBzZXR0aW5ncy5gKTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzQm90LnZhcnMuYWN0aXZlRm9jdXNJbmZvID0geyAKICAgICAgICBwb3J0YWw6IHRoYXQucG9ydGFsLCAKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB7Li4ubmV3QUJQb3NpdGlvbn0sCiAgICB9OwoKICAgIGxldCB6b29tID0gdGFncy5kZWZhdWx0R3JpZFBvcnRhbFpvb207CgogICAgaWYgKG5ld0FCUG9ydGFsID09PSAnbWFwUG9ydGFsJyB8fCBuZXdBQlBvcnRhbCA9PT0gJ21pbmlNYXBQb3J0YWwnKSB7CiAgICAgICAgem9vbSA9IHRhZ3MuZGVmYXVsdE1hcFBvcnRhbFpvb207CiAgICB9CiAgICAKICAgIHRyeSB7CiAgICAgICAgaWYgKGZvY3VzQ2FtZXJhU3RhcnRab29tICE9IG51bGwpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2V0IHN0YXJ0IHpvb20gb2YgJHtuZXdBQlBvcnRhbH0gdG8gJHtmb2N1c0NhbWVyYVN0YXJ0Wm9vbX0uYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlcikgewogICAgICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGF3YWl0IG9zLmZvY3VzT24obmV3QUJQb3NpdGlvbiwgeyB6b29tOiBmb2N1c0NhbWVyYVN0YXJ0Wm9vbSwgZHVyYXRpb246IDAsIHBvcnRhbDogbmV3QUJQb3J0YWwgfSk7CiAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDEwMDApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb2N1cyBvbiAke0pTT04uc3RyaW5naWZ5KG5ld0FCUG9zaXRpb24pfSBpbiAke25ld0FCUG9ydGFsfSB3aXRoIHpvb20gJHt6b29tfS5gKTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFncy5hYkluaXRpYWxpemVkKSB7IAogICAgICAgICAgICAvLyBbUnlhbl0gUmVhbGx5IHdlaXJkIENhc3VhbE9TIGJ1ZyB0aGF0IGNhdXNlcyB0aGUgcG9ydGFsIGNhbWVyYSB0byBub3QgcmVzcGVjdCB6b29tIGxldmVsIGlmIHdlIGRvbnQgZG8gdGhpcy4KICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjUwKTsgCiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5mb2N1c09uKG5ld0FCUG9zaXRpb24sIHsgem9vbSwgcm90YXRpb246IHsgeDogNDUsIHk6IDQ1IH0sIHBvcnRhbDogbmV3QUJQb3J0YWwgfSkKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb2N1c09uIGVycm9yIG9jY3VyZWQ6YCwgZSk7CiAgICAgICAgfQogICAgfSBmaW5hbGx5IHsKICAgICAgICB0aGlzQm90LnZhcnMuYWN0aXZlRm9jdXNJbmZvID0gbnVsbDsKICAgIH0KfScA7rWleYnuAQhyZW1lbWJlcgIEAO61pXm0uAIo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA7rWleYnuAQ1hYk1hbmlmZXN0Qm90AgQA7rWledu4Avs+QGNvbnN0IGRpbWVuc2lvbiA9IHRoYXQ/LmRpbWVuc2lvbjsKY29uc3QgcG9zaXRpb24gPSB0aGF0Py5wb3NpdGlvbjsKCmlmICh0aGlzQm90LnZhcnMuYWJCb3RMYXN0SWQpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIGFiQm90YCk7CiAgICB9CiAgICBkZXN0cm95KHRoaXNCb3QudmFycy5hYkJvdExhc3RJZCk7Cn0KCmNvbnN0IGFiTW9kID0gewogICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgZGltZW5zaW9uLAogICAgYWJCb3Q6IHRydWUsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtkaW1lbnNpb24gKyAnWCddOiBwb3NpdGlvbi54LAogICAgW2RpbWVuc2lvbiArICdZJ106IHBvc2l0aW9uLnksCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBmb3JtOiAnY3ViZScsCiAgICBsYWJlbDogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VMYWJlbCwKICAgIGxhYmVsUG9zaXRpb246ICdmcm9udCcsCiAgICBsYWJlbENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbGFiZWxTaXplOiAwLjYxLAogICAgZHJhZ2dhYmxlOiBmYWxzZSwKICAgIGFybVNlbGVjdGlvbjogdHJ1ZSwKICAgIGFybUdyb3VwRHJhZzogdHJ1ZSwKICAgIGFybVRlbGVwb3J0OiB0cnVlLAogICAgYXJtTWVzaFBhdGg6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aCwKICAgIGFybUNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgcGVyc29uYWxpdHk6IHRhZ3MucGVyc29uYWxpdHksCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIGxlYXJuOiB0YWdzLmxlYXJuLAogICAgc3BpbkR1cmF0aW9uTVM6IDIwMDAsCiAgICBzcGluSW50ZXJ2YWxNUzogMjAwMCwKICAgIHNvdW5kQ2xpY2s6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJDbGlja1NvdW5kID8/IHRydWUsCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4geyAKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYk1lc2hQYXRoKSB7CiAgICAgICAgICAgIGxldCBmb3JtQWRkcmVzczsKCiAgICAgICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiTWVzaFBhdGguc3RhcnRzV2l0aCgnaHR0cHM6Ly8nKSkgewogICAgICAgICAgICAgICAgZm9ybUFkZHJlc3MgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiTWVzaFBhdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmb3JtQWRkcmVzcyA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJNZXNoUGF0aCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENyZWF0ZSB0aGUgbWVzaCBmb3IgYWIuCiAgICAgICAgICAgIG1hc2tzLm1lc2hCb3QgPSBnZXRMaW5rKGNyZWF0ZSh7CiAgICAgICAgICAgICAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICAgICAgICAgICAgICBhYkJvdDogZ2V0TGluayh0aGlzQm90KSwKICAgICAgICAgICAgICAgIGZvcm06ICdtZXNoJywKICAgICAgICAgICAgICAgIGZvcm1TdWJ0eXBlOiAnZ2x0ZicsCiAgICAgICAgICAgICAgICBmb3JtQWRkcmVzcywKICAgICAgICAgICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1lcjogdGhpc0JvdC5pZCwKICAgICAgICAgICAgICAgIGFuY2hvclBvaW50OiAnY2VudGVyJywKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbl06IHRydWUsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAnWiddOiAtMC41CiAgICAgICAgICAgIH0pKTsKCiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSAndHJhbnNwYXJlbnQnOwogICAgICAgICAgICB0YWdzLnNjYWxlID0gMTsKICAgICAgICAgICAgdGFncy5zcGluSW50ZXJ2YWxNUyA9IDQ1MDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgYSBjdXN0b20gbWVzaCBpcyBub3QgZGVmaW5lZCBmb3IgYWIsIHRoZW4gZ2l2ZSBhYiBhICJjb3JlIi4KICAgICAgICAgICAgbWFza3MuY29yZUJvdCA9IGdldExpbmsoY3JlYXRlKHsKICAgICAgICAgICAgICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgICAgICAgICAgICAgIGFiQm90OiBnZXRMaW5rKHRoaXNCb3QpLAogICAgICAgICAgICAgICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICAgICAgICAgICAgICBmb3JtT3BhY2l0eTogMC42NiwKICAgICAgICAgICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBzY2FsZTogMC43NSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVyOiB0aGlzQm90LmlkLAogICAgICAgICAgICAgICAgYW5jaG9yUG9pbnQ6ICdjZW50ZXInLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICdaJ106IC0wLjUKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGFncy5jb2xvciA9IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAwLjk7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlV2lkdGggPSAxOwogICAgICAgICAgICB0YWdzLnN0cm9rZUNvbG9yID0gbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgICAgICAgICAgdGFncy5mb3JtT3BhY2l0eSA9IDAuMzM7CiAgICAgICAgICAgIHRhZ3MuZm9ybURlcHRoVGVzdCA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC5hbmltYXRlQm90KCk7CiAgICAgICAgbWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzQm90LmFuaW1hdGVCb3QoKSwgdGFncy5zcGluSW50ZXJ2YWxNUyk7CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT0gJ3JpZ2h0JykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChtYXNrcy5hcm1Cb3QpIHsKICAgICAgICAgICAgZGVzdHJveShsaW5rcy5hcm1Cb3QpOwogICAgICAgICAgICBtYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKCk7CiAgICB9KSwKICAgIG9uUG9pbnRlckVudGVyOkxpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJykgewogICAgICAgICAgICB0YWdzLm1vdXNlT3ZlciA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvblBvaW50ZXJFeGl0OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScpIHsKICAgICAgICAgICAgdGFncy5tb3VzZU92ZXIgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlckRvd246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnRCdXR0b25Eb3duID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlclVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScgJiYgdGhhdC5idXR0b25JZCA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0QnV0dG9uRG93biA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdERyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvbkRyYWc6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5tb3VzZUxlZnRCdXR0b25Eb3duKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICBvbktleURvd246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5rZXlzLmluY2x1ZGVzKCdTaGlmdCcpKSB7CiAgICAgICAgICAgIHRhZ3Muc2hpZnRIZWxkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgb25LZXlVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmtleXMuaW5jbHVkZXMoJ1NoaWZ0JykpIHsKICAgICAgICAgICAgdGFncy5zaGlmdEhlbGQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgdXBkYXRlUG9ydGFsQ3Vyc29yOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGV0IGN1cnNvciA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLm1vdXNlTGVmdERyYWdnaW5nKSB7CiAgICAgICAgICAgIGN1cnNvciA9ICdncmFiYmluZyc7ICAgIAogICAgICAgIH0gZWxzZSBpZiAodGFncy5tb3VzZU92ZXIpIHsKICAgICAgICAgICAgaWYgKHRhZ3Muc2hpZnRIZWxkKSB7CiAgICAgICAgICAgICAgICBjdXJzb3IgPSAnY29udGV4dC1tZW51JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxDdXJzb3IgPSBjdXJzb3I7CiAgICB9KSwKICAgIGFuaW1hdGVCb3Q6IExpc3RlbmVyU3RyaW5nKGFzeW5jICgpID0+IHsgCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLmFiT3B0aW1pemVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHJvdFogPSB0YWdzLmRpbWVuc2lvbiArICdSb3RhdGlvblonOwoKICAgICAgICBhd2FpdCBhbmltYXRlVGFnKHRoaXNCb3QsCiAgICAgICAgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIFtyb3RaXTogMCwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgW3JvdFpdOiA2LjMsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogJ3NpbnVzb2lkYWwnLAogICAgICAgICAgICAgICAgbW9kZTogJ2lub3V0JwogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogdGFncy5zcGluRHVyYXRpb25NUyAvIDEwMDAsCiAgICAgICAgfSkuY2F0Y2goZSA9PiB7fSk7CiAgICB9KSwKICAgIG9uQXJtQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKCF0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IHJlc2V0OiB0cnVlIH0pOwogICAgICAgIH0KICAgIH0pLAogICAgb25Bcm1QbGFjZWQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkdyaWRGb2N1cyA9IHsKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgCiAgICAgICAgICAgIHBvc2l0aW9uOiB7CiAgICAgICAgICAgICAgICB4OiB0aGF0LngsCiAgICAgICAgICAgICAgICB5OiB0aGF0LnkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgbWVudTogJ2dyaWQnIH0pOwoKICAgICAgICBzaG91dCgnb25BQkFybVBsYWNlZCcsIHRoYXQpOwogICAgfSksCiAgICBvbkFybUNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgcmVzZXQ6IHRydWUgfSk7CiAgICAgICAgc2hvdXQoJ29uQUJGb290Q2xpY2tlZCcsIHRoYXQpOwogICAgfSksCiAgICBvbkFybVNlbGVjdGVkQm90czogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHNlbGVjdGVkQm90cyA9IHRoYXQ7CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNlbGVjdGVkQm90cykpIHsKICAgICAgICAgICAgLy8gTXVsdGlwbGUgYm90IHNlbGVjdGlvbi4KICAgICAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJNdWx0aXBsZUJvdEZvY3VzID0gZ2V0TGluayhzZWxlY3RlZEJvdHMpOwogICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnbXVsdGlwbGVCb3QnIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFNpbmdsZSBib3Qgc2VsZWN0aW9uLgogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkJvdEZvY3VzID0gIvCflJciICsgc2VsZWN0ZWRCb3RzLmlkOwoKICAgICAgICAgICAgaWYgKHNlbGVjdGVkQm90cyA9PT0gdGhpc0JvdCkgewogICAgICAgICAgICAgICAgYWIubGlua3MubWVudS5hYkVudmlyb25tZW50TWVudSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgbWVudTogJ2JvdCcgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICBzaG91dCgnb25BQlNlbGVjdGVkQm90Jywgc2VsZWN0ZWRCb3RzKTsKICAgIH0pLAogICAgb25Bcm1EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsKICAgIH0pLAogICAgb25EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY2xlYXJJbnRlcnZhbCh0YWdzLmludGVydmFsKTsKICAgICAgICBzaG91dCgnYWJNZW51UmVmcmVzaCcpOwogICAgfSksCn07Cgpjb25zdCBhYkJvdCA9IGNyZWF0ZShhYk1vZCk7CgppZiAobGlua3MucmVtZW1iZXIudGFncy5hYlNlY29uZGFyeUxhYmVsKSB7CiAgICBjb25zdCBhYkxhYmVsQm90ID0gewogICAgICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgICAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICBbZGltZW5zaW9uICsgJ1onXTogLTEsCiAgICAgICAgY3JlYXRvcjogYWJCb3QuaWQsCiAgICAgICAgdHJhbnNmb3JtZXI6IGFiQm90LmlkLAogICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgY29sb3I6ICdjbGVhcicsCiAgICAgICAgbGFiZWw6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJTZWNvbmRhcnlMYWJlbCwKICAgICAgICBsYWJlbFBvc2l0aW9uOiAnbGVmdCcsCiAgICAgICAgbGFiZWxTaXplOiAwLjcsCiAgICAgICAgbGFiZWxDb2xvcjogYWJCb3QudGFncy5sYWJlbENvbG9yLAogICAgfTsKCiAgICBjcmVhdGUoYWJMYWJlbEJvdCk7Cn0KCm1hc2tzLmFiQm90ID0gZ2V0TGluayhhYkJvdCk7CmxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiQWN0aXZlRGltZW5zaW9uID0gZGltZW5zaW9uOwp0aGlzQm90LnZhcnMuYWJCb3RMYXN0SWQgPSBhYkJvdC5pZDsgLy8gU3RvcmluZyBpZCBhcyBhIHZhciBwcmV2ZW50cyBnaG9zdCBhYkJvdHMgZHVyaW5nIG11bHRpcGxlIGNhbGxzIGluIG9uZSBmcmFtZS4KCi8vIFN0b3JlIHRoZSBsYXN0IHBvc2l0aW9uIG9mIGFiIGluIHRoaXMgZGltZW5zaW9uIG9uIHRoZSByZW1lbWJlciBib3QuCmxpbmtzLnJlbWVtYmVyLm1hc2tzW2RpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddID0gJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoeyB4OiBwb3NpdGlvbj8ueCwgeTogcG9zaXRpb24/LnkgfSk7Cgphd2FpdCBvcy5zbGVlcCgwKTsgLy8gR2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byB1cGRhdGUgdGFnIG1hc2tzLgoKc2hvdXQoJ29uQUJNb3ZlZCcsIHsgZGltZW5zaW9uLCB4OiBwb3NpdGlvbi54LCB5OiBwb3NpdGlvbi55IH0pOwoKcmV0dXJuIGFiQm90OycA7rWleYnuAQtvbkdyaWRDbGljawIEAO61pXnT9wLZFkBpZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgcmV0dXJuOwp9Cgpjb25zdCBzaGlmdENoZWNrID0gb3MuZ2V0SW5wdXRTdGF0ZSgia2V5Ym9hcmQiLCAiU2hpZnQiKTsKCmlmIChsaW5rcy5hYkJvdCAmJiAoc2hpZnRDaGVjayB8fCAodGhhdC5tb2RhbGl0eSA9PSAibW91c2UiICYmIHRoYXQuYnV0dG9uSWQgPT0gInJpZ2h0IiAmJiAhbGlua3MucmVtZW1iZXIudGFncy5hYlJpZ2h0Q2xpY2tEaXNhYmxlZCkgfHwgdGhhdC5mb3JjZUFybVBsYWNlbWVudCkpIHsKICAgIGNvbnN0IGFybUJvdCA9IGFiLmxpbmtzLmFybV90b29sLmFiQ3JlYXRlQXJtKHsKICAgICAgICBvcmlnaW5Cb3Q6IGxpbmtzLmFiQm90LAogICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICAgICAgcG9zaXRpb246IHRoYXQucG9zaXRpb24sCiAgICB9KQoKICAgIC8vIEZha2UgdXNlciBkcm9wcGluZyB0aGUgYXJtIG9uIHRoZSBncmlkIHNwYWNlLgogICAgYXJtQm90Lm9uRHJvcCh7CiAgICAgICAgYm90OiBhcm1Cb3QsCiAgICAgICAgdG86IHsKICAgICAgICAgICAgeDogdGhhdC5wb3NpdGlvbi54LAogICAgICAgICAgICB5OiB0aGF0LnBvc2l0aW9uLnksCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9LAogICAgICAgIGZyb206IHsKICAgICAgICAgICAgeDogdGhhdC5wb3NpdGlvbi54LAogICAgICAgICAgICB5OiB0aGF0LnBvc2l0aW9uLnksCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm47Cn0KCmNvbnN0IGZvb3RwcmludCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICBbdGhhdC5kaW1lbnNpb25dOiB0cnVlLAogICAgW3RoYXQuZGltZW5zaW9uICsgIlgiXTogdGhhdC5wb3NpdGlvbi54LAogICAgW3RoYXQuZGltZW5zaW9uICsgIlkiXTogdGhhdC5wb3NpdGlvbi55LAogICAgcG9zaXRpb25JbmZvOiB0aGF0LAogICAgcGVyc29uYWxpdHk6IHRhZ3MucGVyc29uYWxpdHksCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIGxlYXJuOiB0YWdzLmxlYXJuLAogICAgZHJhZ2dhYmxlOiBmYWxzZSwKICAgIGN1cnNvcjogJ2FsaWFzJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBzb3VuZENyZWF0ZTogJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoWyAnYWIvYXVkaW8vZ3JpZCB0YXBfMDEubXAzJywgJ2FiL2F1ZGlvL2dyaWQgdGFwXzAyLm1wMycsICdhYi9hdWRpby9ncmlkIHRhcF8wMy5tcDMnLCAnYWIvYXVkaW8vZ3JpZCB0YXBfMDQubXAzJywgJ2FiL2F1ZGlvL2dyaWQgdGFwXzA1Lm1wMycgXSksCiAgICBvbkNyZWF0ZTogTGlzdGVuZXJTdHJpbmcoYXN5bmMgKCkgPT4gewogICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZGVzdHJveSh0aGlzQm90KSwgODAwKTsKCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aCkgewogICAgICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoLnN0YXJ0c1dpdGgoJ2h0dHBzOi8vJykpIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJtTWVzaFBhdGg7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gbGlua3MubGVhcm4uYWJCdWlsZENhc3VhbENhdGFsb2dVUkwobGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGFncy5mb3JtID0gJ21lc2gnOwogICAgICAgICAgICB0YWdzLmZvcm1TdWJ0eXBlID0gJ2dsdGYnOwogICAgICAgICAgICB0YWdzLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgICAgICAgICAgdGFncy5zdHJva2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgICAgIHRhZ3MuYW5jaG9yUG9pbnQgPSAnY2VudGVyJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0YWdzLmNvbG9yID0gJ2NsZWFyJzsKICAgICAgICAgICAgdGFncy5zdHJva2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc2NhbGVaID0gMC4wMTsKICAgICAgICB9CgogICAgICAgIGF3YWl0IGFuaW1hdGVUYWcodGhpc0JvdCwgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIHNjYWxlWDogMC4xLAogICAgICAgICAgICAgICAgc2NhbGVZOiAwLjEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgc2NhbGVYOiAxLjEsCiAgICAgICAgICAgICAgICBzY2FsZVk6IDEuMQogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogMC41LAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICJlbGFzdGljIiwKICAgICAgICAgICAgICAgIG1vZGU6ICJvdXQiCiAgICAgICAgICAgIH0KICAgICAgICB9KS5jYXRjaChlID0+IHt9KTsKICAgIH0pLAogICAgb25DbGljazogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgc2hvdXQoIm9uQUJGb290Q2xpY2tlZCIsIHsgZGltZW5zaW9uOiB0YWdzLmRpbWVuc2lvbiB9KTsKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiTWFuaWZlc3RCb3QodGFncy5wb3NpdGlvbkluZm8pOwogICAgICAgIGFiLmxpbmtzLnNvdW5kLmFiUGxheVNvdW5kKHsgdmFsdWU6IGFiLmxpbmtzLmFybV90b29sLnRhZ3MuZGVmYXVsdEFybVRlbGVwb3J0U291bmQgfSk7CiAgICB9KSwKfTsKCgpjcmVhdGUoZm9vdHByaW50KTsnAO61pXmJ7gEEbWVudQIEAO61pXmrjgMo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA7rWleYnuAQdhYkNsaWNrAgQA7rWledKOA9AKQGlmICghbGlua3MuYWJCb3QpIHsKICAgIHJldHVybjsKfQoKaWYgKGxpbmtzLmlucHV0KSB7CiAgICBsaW5rcy5pbnB1dC5hYkNoYXRCYXJDbG9zZSgpOwp9Cgpjb25zdCByZXNldCA9IHRoYXQgPyB0aGF0LnJlc2V0IDogZmFsc2U7CmNvbnN0IG1lbnUgPSB0aGF0ID8gdGhhdC5tZW51IDogImNvcmUiOwpjb25zdCBzdGF0ZSA9IG9zLmdldElucHV0U3RhdGUoImtleWJvYXJkIiwgIlNoaWZ0Iik7CgppZiAoIXJlc2V0ICYmIChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsIHx8IHN0YXRlKSkgewogICAgY29uc3QgYWJNZW51Qm90cyA9IGdldEJvdHMoImFiTWVudSIsIHRydWUpOwoKICAgIHdoaXNwZXIoYWJNZW51Qm90cywgImFiTWVudVJlZnJlc2giKTsKCiAgICBjbGVhckludGVydmFsKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwpOwoKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmludGVydmFsID0gbnVsbDsKCiAgICBjbGVhckFuaW1hdGlvbnMobGlua3MuYWJCb3QpOwoKICAgIGNvbnN0IHJvdFogPSBsaW5rcy5hYkJvdC50YWdzLmRpbWVuc2lvbiArICJSb3RhdGlvbloiOwoKICAgIGlmIChzdGF0ZSAmJiBtZW51ID09ICJjb3JlIikgewogICAgICAgIGxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGxpbmtzLm1lbnUuYWJPcGVuTWVudShtZW51KTsKICAgIH0KCiAgICBhbmltYXRlVGFnKGxpbmtzLmFiQm90LCB7CiAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgIFtyb3RaXTogbGlua3MuYWJCb3QudGFnc1tyb3RaXQogICAgICAgIH0sCiAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICBbcm90Wl06IDAKICAgICAgICB9LAogICAgICAgIGVhc2luZzogewogICAgICAgICAgICB0eXBlOiAic2ludXNvaWRhbCIsCiAgICAgICAgICAgIG1vZGU6ICJpbm91dCIKICAgICAgICB9LAogICAgICAgIGR1cmF0aW9uOiAwLjUKICAgIH0pLmNhdGNoKGUgPT4ge30pCn0KZWxzZSB7CiAgICBsaW5rcy5hYkJvdC5hbmltYXRlQm90KCk7CgogICAgbGlua3MuYWJCb3QubWFza3MubGluZVRvID0gbnVsbDsKCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGNsZWFySW50ZXJ2YWwobGlua3MuYWJCb3QudGFncy5pbnRlcnZhbCk7CiAgICBsaW5rcy5hYkJvdC5tYXNrcy5pbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IGxpbmtzLmFiQm90LmFuaW1hdGVCb3QoKSwgbGlua3MuYWJCb3QudGFncy5zcGluSW50ZXJ2YWxNUyk7Cn0KCnNob3V0KCdvbkFCQ2xpY2snLCB7IGFiQm90OiBsaW5rcy5hYkJvdCwgZGltZW5zaW9uOiBsaW5rcy5hYkJvdC50YWdzLmRpbWVuc2lvbiwgbWVudSwgc2hpZnRLZXk6ICEhc3RhdGUsIHJlc2V0IH0pOycA7rWleYnuAQhhYklnbm9yZQIEAO61pXmjmQMEdHJ1ZScA7rWleYnuAQNhc2sCBADutaV5qJkDKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAO61pXmJ7gEJYXNrQnV0dG9uAgQA7rWlec+ZA8gFQGlmICghdGFncy5hYkF3YWtlKQp7CiAgICByZXR1cm47Cn0KCmxldCBhYk1lbnVCdXR0b24gPSB7fTsKCmFiTWVudUJ1dHRvbi5hYk1lbnUgPSB0cnVlOwphYk1lbnVCdXR0b24ucmVtZW1iZXIgPSBsaW5rcy5tZW51LnRhZ3MucmVtZW1iZXI7CmFiTWVudUJ1dHRvbi5tYW5pZmVzdGF0aW9uID0gbGlua3MubWVudS50YWdzLm1hbmlmZXN0YXRpb247CmFiTWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwphYk1lbnVCdXR0b24uYmFzZVNraWxsID0gIvCflJciICsgbGlua3MuYXNrLmlkOwphYk1lbnVCdXR0b24ubGFiZWwgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51TGFiZWw7CmFiTWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVJY29uOwphYk1lbnVCdXR0b24ub25DcmVhdGUgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51T25HZW5lcmF0ZTsKYWJNZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVTb3J0T3JkZXI7CmFiTWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVDb2xvciA/IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVDb2xvciA6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihhYk1lbnVCdXR0b24pOycA7rWleYnuAQlhYkJvdENoYXQCBADutaV5lp8D7ghAaWYgKCFsaW5rcy5hYkJvdCAmJiAhdGhhdC5ib3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYm90QmFzZSA9IHRoYXQuYm90ID8gdGhhdC5ib3Q6IGxpbmtzLmFiQm90Owpjb25zdCBkaW1lbnNpb24gPSAhdGhhdC5ib3QgPyBib3RCYXNlLnRhZ3MuZGltZW5zaW9uIDogdGhhdC5kaW1lbnNpb24gPyB0aGF0LmRpbWVuc2lvbiA6IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CmNvbnN0IG1lc3NhZ2UgPSB0aGF0Lm1lc3NhZ2U7CmNvbnN0IG1lc3NhZ2VUaW1lID0gdGhhdC50aW1lID8gdGhhdC50aW1lICogMTAwMCA6IDE2MDA7IAoKY29uc3QgbWVzc2FnZUJvdCA9IGF3YWl0IGxpbmtzLmJvdF9mYWN0b3J5LmFiQ3JlYXRlQmlsbGJvYXJkTGFiZWwoewogICAgYm90OiBib3RCYXNlLAogICAgbGFiZWw6IG1lc3NhZ2UsCiAgICBkaW1lbnNpb24sCiAgICBtZXNzYWdlVGltZSwKICAgIGNvbG9yOiAiIzAwMDAwMCIsCiAgICBsYWJlbENvbG9yOiAiI2ZmZmZmZiIsCiAgICBvbkJvdEFkZGVkOiBgQAogICAgICAgIGF3YWl0IG9zLnNsZWVwKHRhZ3MubWVzc2FnZVRpbWUpOwogICAgICAgIHRoaXNCb3Qub25GYWRlKCk7CiAgICBgLAogICAgb25GYWRlOiBgQAogICAgICAgIGFuaW1hdGVUYWcodGhpc0JvdCwgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgIloiXTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICJaIl0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgZm9ybU9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAiWiJdOiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgIloiXSArIDUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246ICR7dGhhdC5kdXJhdGlvbiA/PyAzfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7fSkKICAgICAgICAuZmluYWxseSgoKSA9PiB7CiAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgfSkKCiAgICBgLAp9KTsnAO61pXmJ7gEJYWJWZXJzaW9uAgQA7rWleYWoAwUxMC4zOScA7rWleYnuAQlhbmltYXRpb24CBADutaV5i6gDKPCflJdiMjZlMTA4OS0xNzJkLTQ1YTktOGQyMi0wNWMzZjU4YzJiZjcnAO61pXmJ7gEPb25BbnlCb3RDbGlja2VkAgQA7rWlebKoA+kHQGlmICghbGlua3MucmVtZW1iZXIudGFncy5hYlJpZ2h0Q2xpY2tEaXNhYmxlZCAmJiAhdGhhdC5ib3QudGFncy5hYlJpZ2h0Q2xpY2tJZ25vcmUgJiYgdGhhdC5tb2RhbGl0eSA9PSAibW91c2UiICYmIHRoYXQuYnV0dG9uSWQgPT0gInJpZ2h0IikgewogICAgaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gYWIgc2VsZWN0ZWQKICAgIGlmICh0aGF0LmJvdCA9PSBsaW5rcy5hYkJvdCkgewogICAgICAgIGxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgICAgICByZXR1cm47CiAgICB9ICAgIAogICAgCiAgICBjb25zdCBhcm1Cb3QgPSBhYi5saW5rcy5hcm1fdG9vbC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBsaW5rcy5hYkJvdCwKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB0aGF0LnBvc2l0aW9uLAogICAgfSkKCiAgICBjb25zdCBib3RQb3NpdGlvbiA9IGdldEJvdFBvc2l0aW9uKHRoYXQuYm90LCB0aGF0LmRpbWVuc2lvbik7CgogICAgLy8gRmFrZSB1c2VyIGRyb3BwaW5nIHRoZSBzZWxlY3RpbmcgdGhlIGJvdCB3aXRoIHRoZSBhcm0uCiAgICBhcm1Cb3Qub25Ecm9wKHsKICAgICAgICBib3Q6IGFybUJvdCwKICAgICAgICB0bzogewogICAgICAgICAgICBib3Q6IHRoYXQuYm90LAogICAgICAgICAgICB4OiBib3RQb3NpdGlvbi54LAogICAgICAgICAgICB5OiBib3RQb3NpdGlvbi55LAogICAgICAgICAgICB6OiBib3RQb3NpdGlvbi56LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfSwKICAgICAgICBmcm9tOiB7CiAgICAgICAgICAgIHg6IGJvdFBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IGJvdFBvc2l0aW9uLnksCiAgICAgICAgICAgIHo6IGJvdFBvc2l0aW9uLnosCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm47Cn0nAO61pXmJ7gEFaW5wdXQCBADutaV5nLADKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAO61pXmJ7gELcGVyc29uYWxpdHkCBADutaV5w7ADKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAO61pXmJ7gENYWJQZXJzb25hbGl0eQIEAO61pXnqsAMEdHJ1ZScA7rWleYnuAQphYlNldEF3YWtlAgQA7rWlee+wA4wQQGxldCBhd2FrZSA9IHRoYXQ/LmF3YWtlOwpsZXQgaW5pdGlhbCA9IHRoYXQ/LmluaXRpYWwgPz8gZmFsc2U7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9Cgphc3NlcnQodHlwZW9mIGF3YWtlID09PSAnYm9vbGVhbicsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXdha2UgaXMgYSByZXF1aXJlZCBib29sZWFuIHBhcmFtZXRlci5gKTsKCmlmIChjb25maWdCb3QudGFncy5hYlN0YXlBd2FrZSkgewogICAgLy8gSWYgYWJTdGF5QXdha2UgaXMgZW5hYmxlZCwgb3ZlcnJpZGUgdGhlIGluY29taW5nIGF3YWtlIHBhcmFtZXRlciBhbmQgbmV2ZXIgbGV0IGFiIGJlIHB1dCB0byBzbGVlcC4KICAgIGF3YWtlID0gdHJ1ZTsKfQoKaWYgKHRhZ3MuYWJBd2FrZSAhPT0gYXdha2UpIHsKICAgIGlmIChpbml0aWFsKSB7CiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4pIHsKICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gdXVpZCgpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICAvLyBQbGF5IGluaXRpYWwgYW5pbWF0aW9uIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbEFuaW1hdGlvbikgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5hbmltYXRpb25bbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxBbmltYXRpb25dKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFNob3cgaW5pdGlhbCBtZXNzYWdlIGlmIG9uZSBpcyBkZWZpbmVkIG9uIGFiQ29uZmlnLgogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpIHsKICAgICAgICAgICAgc2hvdXQoInNob3dDb25zb2xlIik7CgogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZVtpXSk7CgogICAgICAgICAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDIwMDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBVcGRhdGUgYWJBd2FrZSBzaGFyZWQgdGFnIG1hc2suCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdhYkF3YWtlJywgYXdha2UsICdzaGFyZWQnKTsKICAgIAogICAgaWYgKGF3YWtlKSB7CiAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/PyBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwoKICAgICAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBwb3NpdGlvbiA9IHsgeDogMCwgeTogMCB9OwoKICAgICAgICBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb24sIHBvc2l0aW9uIH0pOwoKICAgICAgICBzaG91dCgib25BQkF3YWtlIiwgeyBkaW1lbnNpb24sIHBvc2l0aW9uLCBpbml0aWFsIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKCiAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICBzaG91dCgib25BQlNsZWVwIik7CiAgICB9Cn0nAO61pXmJ7gEFdXRpbHMCBADutaV5/MADKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAO61pXmJ7gELYm90X2ZhY3RvcnkCBADutaV5o8EDKPCflJdjNzhhYTY2My1kMDVjLTRlYzQtYmMyYy0yNmZkNTE1NjBiOTcnAO61pXmJ7gEPb25BQkluaXRpYWxpemVkAgQA7rWlecrBA6wBQG1hc2tzLmFiSW5pdGlhbGl6ZWQgPSB0cnVlOw0KDQppZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7DQogICAgdGhpc0JvdC5vblBvcnRhbENoYW5nZWQoe3BvcnRhbDogIm1hcFBvcnRhbCIsIGRpbWVuc2lvbjogY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsLCBpbml0aWFsOiB0cnVlIH0pOw0KfScA7rWleYnuAQVkZWJ1ZwIEAO61pXn3wgMFZmFsc2UnAO61pXmJ7gEaZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24CBADutaV5/cIDqQtAYXN5bmMgZnVuY3Rpb24gZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24ocG9ydGFsOiAnbWFwJyB8ICdncmlkJyk6IHsgeDogbnVtYmVyLCB5OiBudW1iZXIgfSB7CiAgICBpZiAocG9ydGFsID09PSAnZ3JpZCcpIHsKICAgICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH0KICAgIH0gZWxzZSBpZiAocG9ydGFsID09PSAnbWFwJykgewogICAgICAgIGlmICh0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnggPT09ICdudW1iZXInICYmICB0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBab29tUG9zaXRpb24/LnkgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsZXQgY3VycmVudFBvc2l0aW9uID0gdW5kZWZpbmVkOwogICAgICAgICAgICBsZXQgaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uID0gYXdhaXQgbGlua3MudXRpbHMuaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKCk7CgogICAgICAgICAgICAvLyBDdXJyZW50IHdvcmstYXJvdW5kIGZvciBhbGxvd2luZyBnZW9sb2NhdGlvbiBmb3IgaU9TIGFwcAogICAgICAgICAgICBpZiAoZ2V0Qm90KCJzeXN0ZW0iLCAiYWIuaW9zYnJpZGdlLm1lc3NlbmdlciIpKSB7CiAgICAgICAgICAgICAgICBoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24gPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCBnZW9sb2NhdGlvbiA9IGF3YWl0IG9zLmdldEdlb2xvY2F0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAoZ2VvbG9jYXRpb24uc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQb3NpdGlvbiA9IHsgeDogZ2VvbG9jYXRpb24ubG9uZ2l0dWRlLCB5OiBnZW9sb2NhdGlvbi5sYXRpdHVkZSB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjdXJyZW50UG9zaXRpb24pIHsKICAgICAgICAgICAgICAgIHJldHVybiBjdXJyZW50UG9zaXRpb247CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBHUlBNIFBvc2l0aW9uCiAgICAgICAgICAgICAgICByZXR1cm4geyB4OiAtODUuNjc2MTg5NDgyMjQzNCwgeTogNDIuOTY1Njc1Njc1Njc1NiB9OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdW5yZWNvbmdpemVkIHBvcnRhbCB0eXBlIHByb3ZpZGVkIHRvIGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uOmAsIHBvcnRhbCk7CiAgICAgICAgcmV0dXJuIHsgeDogMCwgeTogMCB9CiAgICB9Cn0KCnJldHVybiBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbih0aGF0KTsnAO61pXmJ7gESZ2V0U3RhcnRDYW1lcmFab29tAgQA7rWleafOA5AEQGFzeW5jIGZ1bmN0aW9uIGdldFN0YXJ0Q2FtZXJhWm9vbShwb3J0YWw6ICdtYXAnIHwgJ2dyaWQnKTogbnVtYmVyIHwgbnVsbCB7CiAgICBpZiAocG9ydGFsID09PSAnZ3JpZCcpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSBpZiAocG9ydGFsID09PSAnbWFwJykgewogICAgICAgIGlmICh0eXBlb2YgbGlua3MucmVtZW1iZXIudGFncy5tYXBTdGFydFpvb20gPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgIHJldHVybiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFN0YXJ0Wm9vbTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bnJlY29uZ2l6ZWQgcG9ydGFsIHR5cGUgcHJvdmlkZWQgdG8gZ2V0U3RhcnRDYW1lcmFab29tOmAsIHBvcnRhbCk7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9Cn0KCnJldHVybiBnZXRTdGFydENhbWVyYVpvb20odGhhdCk7JwDutaV5ie4BFGRlZmF1bHRNYXBQb3J0YWxab29tAgQA7rWlebjSAwQxMDAwJwDutaV5ie4BEG9uQUJCZWZvcmVVcGRhdGUCBADutaV5vdIDNkBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gdGFncy5hYkF3YWtlOycA7rWleYnuAQtvbkFCVXBkYXRlZAIEAO61pXn00gOPAUBpZiAoY29uZmlnQm90LnRhZ3MuYWJXYXNBd2FrZUJlZm9yZVVwZGF0ZSkgewogICAgY29uZmlnQm90LnRhZ3MuYWJXYXNBd2FrZUJlZm9yZVVwZGF0ZSA9IG51bGw7CiAgICBhd2FpdCB0aGlzQm90LmFiU2V0QXdha2UoeyBhd2FrZTogdHJ1ZSB9KQp9JwDutaV5ie4BFWRlZmF1bHRHcmlkUG9ydGFsWm9vbQIEAO61pXmE1AMCMjAnAO61pXmJ7gEJb25BQkF3YWtlAgQA7rWleYfUA8IBQGNvbnN0IHsgZGltZW5zaW9uLCBwb3NpdGlvbiwgaW5pdGlhbCB9ID0gdGhhdDsKCmlmIChpbml0aWFsICYmIGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwgPT09IGRpbWVuc2lvbikgewogICAgb3MuZm9jdXNPbihwb3NpdGlvbiwgeyB6b29tOiB0YWdzLmRlZmF1bHRHcmlkUG9ydGFsWm9vbSwgcG9ydGFsOiAnZ3JpZFBvcnRhbCcgfSk7Cn0A"}]}