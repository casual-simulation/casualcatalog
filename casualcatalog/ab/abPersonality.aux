{"version":2,"updates":[{"id":0,"timestamp":1765900985093,"update":"Ab4B6PWJ9AcAJwEEYm90cyQxNjU1NGJjMS1lOTNlLTRhMGItOGNkMy1kZmQ3NzIzMTk2NzIBJwDo9Yn0BwAJYWJWZXJzaW9uAgQA6PWJ9AcBBTEwLjM1JwDo9Yn0BwAGc3lzdGVtAgQA6PWJ9AcHFmFiLnBlcnNvbmFsaXR5LnZlcnNpb24nAOj1ifQHABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQA6PWJ9AceATEnAOj1ifQHAA1vblNraWxsVXBkYXRlAgQA6PWJ9AcgrQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycA6PWJ9AcADWFiUGVyc29uYWxpdHkCBADo9Yn0B84BBHRydWUnAOj1ifQHAAhhYklnbm9yZQIEAOj1ifQH0wEEdHJ1ZScA6PWJ9AcABGZvcm0CBADo9Yn0B9gBB25vdGhpbmcnAOj1ifQHABlhYlBlcnNvbmFsaXR5TWlub3JWZXJzaW9uAgQA6PWJ9AfgAQIzMCcBBGJvdHMkM2M3NGM5ZjEtODJkYy00NjU1LThiMzgtZTdmMTFkZTg5NzhlAScA6PWJ9AfjAQZzeXN0ZW0CBADo9Yn0B+QBF2FiLnBlcnNvbmFsaXR5LmFybV90b29sJwDo9Yn0B+MBDG9uQW55Qm90RHJhZwIEAOj1ifQH/AGNCEBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC50YWdzLmFybVNlbGVjdGlvbikgewogICAgaWYgKGRyYWdCb3QubWFza3MuYXJtQm90KSB7CiAgICAgICAgaWYgKGRyYWdCb3QubGlua3MuYXJtQm90LnRhZ3MubXVsdGlTZWxlY3QgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMgJiYgZHJhZ0JvdC50YWdzLmFybUdyb3VwRHJhZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlbmFibGUgY3VzdG9tIGRyYWdnaW5nYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9zLmVuYWJsZUN1c3RvbURyYWdnaW5nKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95IHByZXZpb3VzIGFybUJvdDogJHtkcmFnQm90Lm1hc2tzLmFybUJvdH1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveShkcmFnQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgY29uc3QgbXVsdGlTZWxlY3RLZXlIZWxkID0gb3MuZ2V0SW5wdXRTdGF0ZSgna2V5Ym9hcmQnLCAnU2hpZnQnKTsKICAgIGNvbnN0IG11bHRpU2VsZWN0QWxsb3dlZCA9IGRyYWdCb3QudGFncy5hcm1NdWx0aVNlbGVjdCA/PyB0cnVlOwoKICAgIGNvbnN0IGFybUJvdCA9IHRoaXNCb3QuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogZHJhZ0JvdCwKICAgICAgICBkaW1lbnNpb24sCiAgICAgICAgbXVsdGlTZWxlY3Q6IG11bHRpU2VsZWN0S2V5SGVsZCAmJiBtdWx0aVNlbGVjdEFsbG93ZWQsCiAgICB9KQoKICAgIG9zLnJlcGxhY2VEcmFnQm90KGFybUJvdCk7Cn0KJwDo9Yn0B+MBBWRlYnVnAgQA6PWJ9AeKCgVmYWxzZScA6PWJ9AfjAQlsaXN0ZW5pbmcCBADo9Yn0B5AKBHRydWUnAOj1ifQH4wELYWJDcmVhdGVBcm0CBADo9Yn0B5UK0kFAY29uc3Qgb3JpZ2luQm90ID0gdGhhdC5vcmlnaW5Cb3Q7CmFzc2VydChhYi5saW5rcy51dGlscy5pc0JvdChvcmlnaW5Cb3QpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbkJvdCBpcyBhIHJlcXVpcmVkIEJvdCBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBkaW1lbnNpb24gPSB0aGF0LmRpbWVuc2lvbjsKYXNzZXJ0KHR5cGVvZiBkaW1lbnNpb24gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRpbWVuc2lvbiBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBwb3NpdGlvbiA9IHRoYXQucG9zaXRpb24gPz8gZ2V0Qm90UG9zaXRpb24ob3JpZ2luQm90LCBkaW1lbnNpb24pOwpjb25zdCBhcm1Db2xvciA9IHRoYXQuYXJtQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3MuYXJtQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3Muc3Ryb2tlQ29sb3IgPz8gb3JpZ2luQm90LnRhZ3MuY29sb3I7CmNvbnN0IG11bHRpU2VsZWN0ID0gdGhhdC5tdWx0aVNlbGVjdCA/PyBmYWxzZTsKCmNvbnN0IGFybSA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIFtkaW1lbnNpb24gKyAnWiddOiBwb3NpdGlvbi56LAogICAgY3JlYXRvcjogb3JpZ2luQm90LmlkLAogICAgaXNBcm1Cb3Q6IHRydWUsCiAgICBwb2ludGFibGU6IHRydWUsCiAgICBtdWx0aVNlbGVjdCwKICAgIGRlYnVnOiB0YWdzLmRlYnVnLAogICAgb3JpZ2luQm90OiBnZXRMaW5rKG9yaWdpbkJvdCksCiAgICBkaW1lbnNpb24sCiAgICBzY2FsZTogMC45LAogICAgc2NhbGVaOiAwLjAxLAogICAgY29sb3I6ICdjbGVhcicsCiAgICBhcm1Db2xvciwKICAgIHN0cm9rZUNvbG9yOiBhcm1Db2xvciwKICAgIGxpbmVDb2xvcjogYXJtQ29sb3IsCiAgICBsaW5lVG86IG9yaWdpbkJvdC5pZCwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjcmVhdGVkIGFybUJvdCAke3RoaXNCb3QuaWR9YCk7CiAgICAgICAgfQogICAgICAgIC8vIERlc3Ryb3kgcHJldmlvdXMgYXJtIGlmIGl0IGlzIHN0aWxsIGFyb3VuZC4KICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybUJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLm9yaWdpbkJvdC5saW5rcy5hcm1Cb3QpOwogICAgICAgIH0KCiAgICAgICAgdGFncy5zeXN0ZW0gPSBgYXJtLiR7dGhpc0JvdC5pZC5zdWJzdHJpbmcoMCwgNSl9YDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtQm90ID0gZ2V0TGluayh0aGlzQm90KTsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuZHJhZ2dhYmxlID0gdGFncy5tdWx0aVNlbGVjdDsKCiAgICAgICAgaWYgKHRhZ3MubXVsdGlTZWxlY3QpIHsKICAgICAgICAgICAgdGFncy5mb3JtID0gJ3NwaGVyZSc7CiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgIH0KCiAgICAgICAgLy8gTWFrZSB0aGUgb3JpZ2luIGJvdCB1bnNlbGVjdGFibGUgZm9yIDEvNCBvZiBhIHNlY29uZC4KICAgICAgICAvLyBUaGlzIGhlbHBzIHByZXZlbnQgdW5pbnRlbnRpb25hbCBzZWxmLXNlbGVjdGlvbiBvZiB0aGUgb3JpZ2luIGJvdC4KICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MucG9pbnRhYmxlID0gZmFsc2U7CiAgICAgICAgb3Muc2xlZXAoMjUwKS50aGVuKCgpID0+IHsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLnBvaW50YWJsZSA9IG51bGw7CiAgICAgICAgfSkKCiAgICAgICAgdGhpc0JvdC5vcmlnaW5DbGVhclNlbGVjdGlvbigpOwoKICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtQ3JlYXRlJyk7CiAgICB9KSwKICAgIHNldEFybVZpc2libGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsZXQgdmlzaWJsZSA9IHRoYXQ7CgogICAgICAgIGlmICh2aXNpYmxlKSB7CiAgICAgICAgICAgIG1hc2tzLnN0cm9rZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgbWFza3MubGluZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgbWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LmlkOyAKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtYXNrcy5zdHJva2VDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIG1hc2tzLmxpbmVDb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIG1hc2tzLmxpbmVUbyA9IGZhbHNlOwogICAgICAgICAgICBtYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCB7IGRpbWVuc2lvbiB9ID0gdGhhdDsKCiAgICAgICAgaWYgKGxpbmtzLm9yaWdpbkJvdD8udGFncy5hcm1UZWxlcG9ydCA/PyB0cnVlKSB7CiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC50YWdzW2RpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWCddID0gdGFnc1tkaW1lbnNpb24gKyAnWCddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWSddID0gdGFnc1tkaW1lbnNpb24gKyAnWSddOwogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb24gKyAnWiddID0gdGFnc1tkaW1lbnNpb24gKyAnWiddOwogICAgICAgIH0KCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybUNsaWNrJywgeyBkaW1lbnNpb24gfSk7CgogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICB9KSwKICAgIG9uRHJvcEVudGVyOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuZHJhZ0JvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwogICAgICAgIGlmICghbGlua3Mub3JpZ2luQm90KSByZXR1cm47CgogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CgogICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIGxldCBsaW5lVG9Cb3RzID0gbGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbzsKCiAgICAgICAgICAgIGlmIChsaW5lVG9Cb3RzID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKGRyb3BCb3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGluZVRvQm90cyA9IEFycmF5LmlzQXJyYXkobGluZVRvQm90cykgPyBsaW5lVG9Cb3RzIDogW2xpbmVUb0JvdHNdOwoKICAgICAgICAgICAgICAgIGlmICghbGluZVRvQm90cy5pbmNsdWRlcyhkcm9wQm90KSkgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKC4uLmxpbmVUb0JvdHMsIGRyb3BCb3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGhpZGUgYXJtYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBkcm9wQm90LmlkOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBzZWxlY3Rpb24gb24gb3JpZ2luIGJvdC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25Ecm9wRXhpdDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmRyYWdCb3QgIT09IHRoaXNCb3QpIHJldHVybjsKICAgICAgICBpZiAoIWxpbmtzLm9yaWdpbkJvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkcm9wQm90ID0gdGhhdC50by5ib3Q7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJvcEJvdDpgLCBkcm9wQm90KTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUodHJ1ZSk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IGFybWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgc2VsZWN0aW9uIG9uIG9yaWdpbiBib3QuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJvcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmJvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKICAgICAgICAKICAgICAgICBpZiAodGFncy5tdWx0aVNlbGVjdCAmJiBsaW5rcy5vcmlnaW5Cb3QubGlua3MubGluZVRvKSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZShmYWxzZSk7CiAgICAgICAgICAgIHRoaXNCb3Qub3JpZ2luU2V0U2VsZWN0aW9uKGxpbmtzLm9yaWdpbkJvdC5saW5rcy5saW5lVG8pOwogICAgICAgIH0gZWxzZSBpZiAoZHJvcEJvdCkgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUoZmFsc2UpOwogICAgICAgICAgICB0aGlzQm90Lm9yaWdpblNldFNlbGVjdGlvbihkcm9wQm90KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBEcm9wcGVkIG9uIGdyaWQuCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRyb3BwZWQgb24gZ3JpZC5gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybVBsYWNlZCcsIHsgZGltZW5zaW9uOiB0aGF0LnRvLmRpbWVuc2lvbiwgeDogdGhhdC50by54LCB5OiB0aGF0LnRvLnksIHo6IHRoYXQudG8ueiB9KTsKICAgICAgICB9CiAgICAgICAgCiAgICB9KSwKICAgIG9uR3JpZENsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC5vcmlnaW5DbGVhclNlbGVjdGlvbigpOwogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICB9KSwKICAgIG9yaWdpbkNsZWFyU2VsZWN0aW9uOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtU2VsZWN0ZWRCb3RzID0gbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbnVsbDsKICAgIH0pLAogICAgb3JpZ2luU2V0U2VsZWN0aW9uOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VsZWN0ZWRCb3RzID0gdGhhdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybVNlbGVjdGVkQm90cyA9IHNlbGVjdGVkQm90cyA/IGdldExpbmsoc2VsZWN0ZWRCb3RzKSA6IG51bGw7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVUbyA9IGxpbmtzLm9yaWdpbkJvdC50YWdzLmFybVNlbGVjdGVkQm90czsKICAgICAgICAKICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cykgewogICAgICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtU2VsZWN0ZWRCb3RzJywgbGlua3Mub3JpZ2luQm90LmxpbmtzLmFybVNlbGVjdGVkQm90cykKICAgICAgICB9CiAgICB9KSwKICAgIG9uQW55Qm90c1JlbW92ZWQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAobGlua3Mub3JpZ2luQm90Lm1hc2tzLmFybVNlbGVjdGVkQm90cykgewogICAgICAgICAgICAvLyBDaGVjayB0aGF0IHdlIHN0aWxsIGhhdmUgc29tZSBhY3RpdmUgc2VsZWN0ZWQgYm90cy4KICAgICAgICAgICAgbGV0IGFjdGl2ZVNlbGVjdGVkQm90cyA9IGZhbHNlOwoKICAgICAgICAgICAgY29uc3QgYXJtU2VsZWN0ZWRCb3RzID0gbGlua3Mub3JpZ2luQm90LmxpbmtzLmFybVNlbGVjdGVkQm90czsKCiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFybVNlbGVjdGVkQm90cykpIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVNlbGVjdGVkQm90cyA9IGFybVNlbGVjdGVkQm90cy5ldmVyeShiID0+ICEhYik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhY3RpdmVTZWxlY3RlZEJvdHMgPSAhIWFybVNlbGVjdGVkQm90czsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFhY3RpdmVTZWxlY3RlZEJvdHMpIHsKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBib3RzIHdlIGhhZCBzZWxlY3RlZCBubyBsb25nZXIgZXhpc3QsIGRlc3Ryb3kgdGhpcyBhcm0uCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyB0aGF0IGFybSBoYXMgc2VsZWN0ZWQgbm8gbG9uZ2VyIGV4aXN0LCBkZXN0cm95IHRoaXMgYXJtLmApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXNCb3Qub3JpZ2luQ2xlYXJTZWxlY3Rpb24oKTsKICAgICAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyB0aGF0IGFybSBoYXMgc2VsZWN0ZWQgc3RpbGwgaGFzIGFjdGl2ZSBib3RzLmApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkRlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuZHJhZ2dhYmxlID0gbnVsbDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybURlc3Ryb3knKTsKICAgIH0pLAp9OwoKY29uc3QgYXJtQm90ID0gY3JlYXRlKGFybSk7CgpyZXR1cm4gYXJtQm90OycA6PWJ9AfjARBvbkFueUJvdERyYWdnaW5nAgQA6PWJ9AfoS9EVQGNvbnN0IGRyYWdCb3QgPSB0aGF0LmJvdDsKY29uc3QgZGltZW5zaW9uID0gdGhhdC5mcm9tLmRpbWVuc2lvbjsKCmlmIChkcmFnQm90LmxpbmtzLmFybUJvdCkgewogICAgaWYgKGRyYWdCb3QudGFncy5hcm1Hcm91cERyYWcgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICBsZXQgZHJhZ0Nvb3JkaW5hdG9yQm90ID0gbGlua3MuZHJhZ0Nvb3JkaW5hdG9yQm90OwogICAgICAgIAogICAgICAgIGlmICghZHJhZ0Nvb3JkaW5hdG9yQm90KSB7CiAgICAgICAgICAgIGNvbnN0IGRyYWdDb29yZGluYXRvck1vZCA9IHsKICAgICAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICAgICAgICAgICAgICBkaW1lbnNpb246IGRpbWVuc2lvbiwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJYIl06IDAsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIlkiXTogMCwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWiJdOiAtMSwKICAgICAgICAgICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZWJ1ZzogdGFncy5kZWJ1ZywKICAgICAgICAgICAgICAgIGNvbG9yOiAiY2xlYXIiLAogICAgICAgICAgICAgICAgc3lzdGVtOiBgYXJtR3JvdXBEcmFnLiR7dGhpc0JvdC5pZC5zdWJzdHJpbmcoMCwgNSl9LmNvb3JkaW5hdG9yYCwKICAgICAgICAgICAgICAgIG9uQW55Qm90UG9pbnRlclVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIGRyYWcgY29vcmRpbmF0b3JgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3MuZHJhZ0Nvb3JkaW5hdG9yQm90ID0gbnVsbDsgCiAgICAgICAgICAgICAgICAgICAgc2hvdXQoJ29uQXJtU3RvcEdyb3VwRHJhZycsIHsgeDogdGFnc1t0YWdzLmRpbWVuc2lvbiArICdYJ10sIHk6IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAnWSddIH0pOwogICAgICAgICAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGRyYWdDb29yZGluYXRvckJvdCA9IGNyZWF0ZShkcmFnQ29vcmRpbmF0b3JNb2QpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3JlYXRlZCBkcmFnIGNvb3JkaW5hdG9yIGJvdDpgLCBkcmFnQ29vcmRpbmF0b3JCb3QpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5kcmFnQ29vcmRpbmF0b3JCb3QgPSBnZXRMaW5rKGRyYWdDb29yZGluYXRvckJvdCk7CgogICAgICAgICAgICBjb25zdCBhcm1TZWxlY3RlZEJvdHMgPSBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90czsKICAgICAgICAgICAgY29uc3Qgb25Bcm1TdG9wR3JvdXBEcmFnID0gYEAKICAgICAgICAgICAgICAgIG1hc2tzLnRyYW5zZm9ybWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIG1hc2tzLm9uQXJtU3RvcEdyb3VwRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgICB0YWdzLiR7ZGltZW5zaW9ufVggPSB0YWdzLiR7ZGltZW5zaW9ufVggKyB0aGF0Lng7CiAgICAgICAgICAgICAgICB0YWdzLiR7ZGltZW5zaW9ufVkgPSB0YWdzLiR7ZGltZW5zaW9ufVkgKyB0aGF0Lnk7CiAgICAgICAgICAgIGAKCiAgICAgICAgICAgIGRyYWdCb3QubWFza3MudHJhbnNmb3JtZXIgPSBkcmFnQ29vcmRpbmF0b3JCb3QuaWQ7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3Mub25Bcm1TdG9wR3JvdXBEcmFnID0gb25Bcm1TdG9wR3JvdXBEcmFnOwoKICAgICAgICAgICAgc2V0VGFnTWFzayhhcm1TZWxlY3RlZEJvdHMsICJ0cmFuc2Zvcm1lciIsIGRyYWdDb29yZGluYXRvckJvdC5pZCwgInRlbXBMb2NhbCIpOwogICAgICAgICAgICBzZXRUYWdNYXNrKGFybVNlbGVjdGVkQm90cywgIm9uQXJtU3RvcEdyb3VwRHJhZyIsIG9uQXJtU3RvcEdyb3VwRHJhZywgInRlbXBMb2NhbCIpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgeENoYW5nZSA9IHRoYXQudG8ueCAtIHRoYXQuZnJvbS54OwogICAgICAgIGNvbnN0IHlDaGFuZ2UgPSB0aGF0LnRvLnkgLSB0aGF0LmZyb20ueTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB4Q2hhbmdlOiAke3hDaGFuZ2V9LCB5Q2hhbmdlOiAke3lDaGFuZ2V9YCk7CiAgICAgICAgfQoKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWCJdID0geENoYW5nZTsKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWSJdID0geUNoYW5nZTsKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWiJdID0gLTE7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJhZyBib3Qgd2l0aCBhcm0gZG9lcyBub3QgcXVhbGlmeSBmb3IgZ3JvdXAgZHJhZ2dpbmcuYCk7CiAgICAgICAgfQogICAgfQp9JwDo9Yn0B+MBDWFiUGVyc29uYWxpdHkCBADo9Yn0B7phBHRydWUnAOj1ifQH4wEIYWJJZ25vcmUCBADo9Yn0B79hBHRydWUnAOj1ifQH4wEEZm9ybQIEAOj1ifQHxGEHbm90aGluZycA6PWJ9AfjAQlhYlZlcnNpb24CBADo9Yn0B8xhBTEwLjM1JwEEYm90cyRiMjZlMTA4OS0xNzJkLTQ1YTktOGQyMi0wNWMzZjU4YzJiZjcBJwDo9Yn0B9JhBnN5c3RlbQIEAOj1ifQH02EYYWIucGVyc29uYWxpdHkuYW5pbWF0aW9uJwDo9Yn0B9JhBGZvcm0CBADo9Yn0B+xhB25vdGhpbmcnAOj1ifQH0mEIYWJJZ25vcmUCBADo9Yn0B/RhBHRydWUnAOj1ifQH0mENbWFuaWZlc3RhdGlvbgIEAOj1ifQH+WEo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA6PWJ9AfSYQhyZW1lbWJlcgIEAOj1ifQHoGIo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA6PWJ9AfSYRhhbmltYXRpb25fYWJHcmlkTWFuaWZlc3QCBADo9Yn0B8di+g5Ac2hvdXQoInJlc2V0Iik7Cgpjb25zdCBwb3NpdGlvblggPSB0aGF0Py5wb3NpdGlvbi54ID8/IDA7CmNvbnN0IHBvc2l0aW9uWSA9IHRoYXQ/LnBvc2l0aW9uLnkgPz8gMDsKY29uc3QgZGltZW5zaW9uID0gdGhhdD8uZGltZW5zaW9uID8/ICJob21lIjsKY29uc3QgZ3JpZFNjYWxlID0gdGhhdD8uc2NhbGUgPz8gNTsKY29uc3QgbW9tZW50Q291bnQgPSAwOwpjb25zdCBncmlkQm90ID0ge307CgpncmlkQm90LnNwYWNlID0gInRlbXBMb2NhbCI7CmdyaWRCb3QuY29sb3IgPSAiY2xlYXIiOwpncmlkQm90LnN0cm9rZUNvbG9yID0gYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwpncmlkQm90LnNjYWxlID0gMC4wMDE7CmdyaWRCb3Quc2NhbGVaID0gMC4xOwpncmlkQm90LnJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwpncmlkQm90W2RpbWVuc2lvbl0gPSB0cnVlOwpncmlkQm90LnBvaW50YWJsZSA9IGZhbHNlOwpncmlkQm90LmtpbGxUaW1lciA9ICJAIGF3YWl0IG9zLnNsZWVwKDQwMCk7IGRlc3Ryb3kodGhpc0JvdCk7IjsKCmxldCByb3VuZEJvdHM7Cgpmb3IgKGxldCBpID0gZ3JpZFNjYWxlOyBpID4gMDsgaS0tKQp7CiAgICBjb25zdCBib3RDb3VudCA9IGkgKiA4OwoKICAgIGxldCBzaWRlQ291bnQgPSAwOwogICAgbGV0IHBoYXNlRmFjdG9yID0gMDsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGJvdENvdW50OyBqKyspCiAgICB7CiAgICAgICAgaWYgKHBoYXNlRmFjdG9yID09IDApCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpICsgc2lkZUNvdW50OwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSBpICsgcG9zaXRpb25ZOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwaGFzZUZhY3RvciA9PSAxKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gaSArIHBvc2l0aW9uWDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKGkgKyBwb3NpdGlvblkpIC0gc2lkZUNvdW50OyAgCiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHBoYXNlRmFjdG9yID09IDIpCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoaSArIHBvc2l0aW9uWCkgLSBzaWRlQ291bnQ7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9ICgoaSArIHBvc2l0aW9uWSkgKiAtMSkgOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJYIl0gPSAoKGkgKyBwb3NpdGlvblgpICogLTEpIDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gKChpICsgcG9zaXRpb25ZKSAqIC0xKSArIHNpZGVDb3VudDsgIAogICAgICAgIH0KCiAgICAgICAgY29uc3QgbmV3R3JpZEJvdCA9IGF3YWl0IGNyZWF0ZShncmlkQm90KTsKCiAgICAgICAgYW5pbWF0ZVRhZyhuZXdHcmlkQm90LCAic2NhbGUiLCB7CiAgICAgICAgICAgIHRvVmFsdWU6IDEsCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogImVsYXN0aWMiLAogICAgICAgICAgICAgICAgbW9kZTogIm91dCIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDAuMDEKICAgICAgICB9KS5jYXRjaCgoKSA9PiB7fSk7CgogICAgICAgIG5ld0dyaWRCb3Qua2lsbFRpbWVyKCk7CgogICAgICAgIHNpZGVDb3VudCsrOwoKICAgICAgICBpZiAoc2lkZUNvdW50ID09IGJvdENvdW50IC8gNCkKICAgICAgICB7CiAgICAgICAgICAgIHNpZGVDb3VudCA9IDA7CgogICAgICAgICAgICBwaGFzZUZhY3RvcisrOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3Muc2xlZXAoOCk7CiAgICB9Cn0nAOj1ifQH0mEJYWJWZXJzaW9uAgQA6PWJ9AfCcQUxMC4zNScA6PWJ9AfSYQZvbkNoYXQCBADo9Yn0B8hxVUAvLyBpZiAodGhhdC5tZXNzYWdlID09ICJAdGVzdCIpCi8vIHsKLy8gICAgIHRoaXNCb3QuYW5pbWF0aW9uX2FiR3JpZE1hbmlmZXN0KCk7Ci8vIH0nAOj1ifQH0mELcGVyc29uYWxpdHkCBADo9Yn0B55yKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAOj1ifQH0mENYWJQZXJzb25hbGl0eQIEAOj1ifQHxXIEdHJ1ZScBBGJvdHMkYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiAScA6PWJ9AfKcgZzeXN0ZW0CBADo9Yn0B8tyFWFiLnBlcnNvbmFsaXR5LmNvbmZpZycA6PWJ9AfKcghhYklnbm9yZQIEAOj1ifQH4XIEdHJ1ZScA6PWJ9AfKcgRmb3JtAgQA6PWJ9Afmcgdub3RoaW5nJwDo9Yn0B8pyC2FiQmFzZUNvbG9yAgQA6PWJ9AfucgcjMDBEOUNEJwDo9Yn0B8pyEWFiQmFzZVN0cm9rZUNvbG9yAgQA6PWJ9Af2cgcjMDBEOUNEJwDo9Yn0B8pyEGFiQmx1ZXByaW50Q29sb3ICBADo9Yn0B/5yByMwMDgyN0InAOj1ifQHynIIcmVtZW1iZXICBADo9Yn0B4ZzKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAOj1ifQHynIRYWJCdWlsZGVySWRlbnRpdHkCBADo9Yn0B61zCmNhc3VhbC5ib3QnAOj1ifQHynIJYWJWZXJzaW9uAgQA6PWJ9Ae4cwUxMC4zNScA6PWJ9AfKchdjaGFuZ2VQZXJzb25hbGl0eUNvbmZpZwIEAOj1ifQHvnPyE0BpZiAoIXRoYXQpIHsNCiAgICByZXR1cm47DQp9DQoNCmlmICghYXV0aEJvdCkgew0KICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7DQp9DQoNCmlmICghYXV0aEJvdCkgew0KICAgIHJldHVybjsNCn0NCg0KYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGF1dGhCb3QuaWQpOw0KDQpsZXQgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhYlBlcnNvbmFsaXR5Q29uZmlnIik7DQoNCmlmIChhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5zdWNjZXNzID09IGZhbHNlKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSB7fTsNCn0gZWxzZSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5kYXRhOw0KfQ0KDQppZiAodGhhdC5uYW1lKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQnVpbGRlcklkZW50aXR5Il0gPSB0aGF0Lm5hbWU7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCdWlsZGVySWRlbnRpdHkiLCB0aGF0Lm5hbWUsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5jb2xvcikgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VDb2xvciJdID0gdGhhdC5jb2xvcjsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlU3Ryb2tlQ29sb3IiXSA9IHRoYXQuY29sb3I7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlQ29sb3IiLCB0aGF0LmNvbG9yLCAibG9jYWwiKTsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VTdHJva2VDb2xvciIsIHRoYXQuY29sb3IsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5wb3J0YWxDb2xvcikgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VHcmlkUG9ydGFsQ29sb3IiXSA9IHRoYXQucG9ydGFsQ29sb3I7DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJCYXNlR3JpZFBvcnRhbENvbG9yIiwgdGhhdC5wb3J0YWxDb2xvciwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0Lm1lbnVDb2xvcikgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYkJhc2VNZW51Q29sb3IiXSA9IHRoYXQubWVudUNvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZU1lbnVDb2xvciIsIHRoYXQubWVudUNvbG9yLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQubWVudUxhYmVsQ29sb3IpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJCYXNlTGFiZWxDb2xvciJdID0gdGhhdC5tZW51TGFiZWxDb2xvcjsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYkJhc2VMYWJlbENvbG9yIiwgdGhhdC5tZW51TGFiZWxDb2xvciwgImxvY2FsIik7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiQmFzZVNoYWRvd0NvbG9yIl0gPSB0aGF0Lm1lbnVMYWJlbENvbG9yOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiQmFzZVNoYWRvd0NvbG9yIiwgdGhhdC5tZW51TGFiZWxDb2xvciwgImxvY2FsIik7DQp9DQoNCmlmICh0aGF0LmZvcm0pIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVsiYWJGb3JtIl0gPSB0aGF0LmZvcm07DQogICAgc2V0VGFnTWFzayh0aGlzQm90LCAiYWJGb3JtIiwgdGhhdC5mb3JtLCAibG9jYWwiKTsNCn0NCg0KaWYgKHRoYXQuYWlNb2RlbCkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhWyJhYlByZWZlcnJlZEFJTW9kZWwiXSA9IHRoYXQuYWlNb2RlbDsNCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICJhYlByZWZlcnJlZEFJTW9kZWwiLCB0aGF0LmFpTW9kZWwsICJsb2NhbCIpOw0KfQ0KDQppZiAodGhhdC5kZWZhdWx0UGVyc29uYWxpdHkpIHsNCiAgICBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSA9IHt9Ow0KICAgIHRoaXNCb3QudXBkYXRlUGVyc29uYWxpdHkoe30pOw0KfQ0KDQppZiAodGhhdC5tYXBCYXNlbWFwKSB7DQogICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbImFiTWFwUG9ydGFsQmFzZSJdID0gdGhhdC5tYXBCYXNlbWFwOw0KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgImFiTWFwUG9ydGFsQmFzZSIsIHRoYXQubWFwQmFzZW1hcCwgImxvY2FsIik7DQp9DQoNCmNvbnN0IHJlc3VsdCA9IGF3YWl0IG9zLnJlY29yZERhdGEoYXV0aEJvdC5pZCwgImFiUGVyc29uYWxpdHlDb25maWciLCBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YSk7DQoNCmlmIChyZXN1bHQuc3VjY2Vzcykgew0KICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYHVwZGF0ZWQgcGVyc29uYWxpdHkgY29uZmlnIGluIHVzZXIgcmVjb3JkYCwgbG9nVHlwZTogJ2xvZyd9KTsNCn0gZWxzZSB7DQogICAgYWIubGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmFpbGVkIHRvIHVwZGF0ZSBwZXJzb25hbGl0eSBjb25maWcgaW4gdXNlciByZWNvcmQuXG4ke0pTT04uc3RyaW5naWZ5KHJlc3VsdCwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnZXJyb3InfSk7DQp9DQoNCnNob3V0KCdvbkFCUGVyc29uYWxpdHlDaGFuZ2VkJywgeyBib3Q6IHRoaXNCb3QgfSk7JwDo9Yn0B8pyD2FiQmFzZU1lbnVDb2xvcgIEAOj1ifQHsYcBByMwMEQ5Q0QnAOj1ifQHynIRdXBkYXRlUGVyc29uYWxpdHkCBADo9Yn0B7mHAZYXQGlmICh0YWdzLmRlYnVnKSB7DQogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGUgc3RhcnRgKTsNCn0NCg0KaWYgKHRoaXNCb3QudmFycy51cGRhdGluZ1BlcnNvbmFsaXR5KSB7DQogICAgcmV0dXJuOw0KfQ0KDQp0aGlzQm90LnZhcnMudXBkYXRpbmdQZXJzb25hbGl0eSA9IHRydWU7DQoNCmxldCBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YTsNCg0KaWYgKHRoYXQgJiYgdGhhdCA9PSB7fSkgew0KICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0ge307DQp9IGVsc2Ugew0KICAgIGlmICghYXV0aEJvdCkgew0KICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOw0KICAgIH0NCg0KICAgIGlmIChhdXRoQm90KSB7DQogICAgICAgIGFiUGVyc29uYWxpdHlDb25maWdEYXRhID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWJQZXJzb25hbGl0eUNvbmZpZyIpOw0KICAgICAgICBpZiAoIWxpbmtzLnJlbWVtYmVyICYmIGFiUGVyc29uYWxpdHlDb25maWdEYXRhLnN1Y2Nlc3MgPT0gZmFsc2UpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy51cGRhdGluZ1BlcnNvbmFsaXR5ID0gZmFsc2U7DQogICAgICAgICAgICByZXR1cm47DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEuc3VjY2Vzcykgew0KICAgICAgICAgICAgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGEgPSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YS5kYXRhOw0KICAgICAgICB9DQogICAgfQ0KfQ0KDQppZiAodGFncy5kZWJ1Zykgew0KICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGE6YCwgey4uLmFiUGVyc29uYWxpdHlDb25maWdEYXRhfSk7DQp9DQoNCi8vYWJCbHVlUHJpbnRDb2xvcg0KLy9hYkJhc2VBY2NlbnRDb2xvcg0KY29uc3QgYWJUYWdzID0gWw0KICAgICJhYkJhc2VDb2xvciIsDQogICAgImFiQmFzZU1lbnVDb2xvciIsDQogICAgImFiQnVpbGRlcklkZW50aXR5IiwNCiAgICAiYWJCYXNlU3Ryb2tlQ29sb3IiLA0KICAgICJhYkJhc2VHcmlkUG9ydGFsQ29sb3IiLA0KICAgICJhYkJhc2VMYWJlbENvbG9yIiwNCiAgICAiYWJCYXNlU2hhZG93Q29sb3IiLA0KICAgICJhYlByZWZlcnJlZEFJTW9kZWwiLA0KICAgICJhYkNhdGFsb2dOYW1lIiwNCiAgICAiYWJNYXBQb3J0YWxCYXNlIg0KXTsNCg0KY2xlYXJUYWdNYXNrcyh0aGlzQm90KTsNCg0KLy8gUnlhbiAoQXVnIDI5LCAyMDI1KTogaW0gbm90IHN1cmUgZXhhY3RseSB3aGF0IGlzIGhhcHBlbmluZyBoZXJlIGJ1dCB3aXRob3V0IHNsZWVwaW5nIG9uIHRoZXNlIGJpZyB0YWcgbWFzayBjaGFuZ2VzLCB0aGV5IGRvbnQgYWxsIHNlZW0gdG8gY29tZSBpbiBwcm9wZXJseS4NCmF3YWl0IG9zLnNsZWVwKDEwMCk7DQoNCmZvciAobGV0IGkgPSAwOyBpIDwgYWJUYWdzLmxlbmd0aDsgKytpKSB7DQogICAgaWYgKGFiUGVyc29uYWxpdHlDb25maWdEYXRhICYmIGFiUGVyc29uYWxpdHlDb25maWdEYXRhW2FiVGFnc1tpXV0pIHsNCiAgICAgICAgaWYgKHRhZ3NbYWJUYWdzW2ldXSAhPSBhYlBlcnNvbmFsaXR5Q29uZmlnRGF0YVthYlRhZ3NbaV1dKSB7DQogICAgICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2V0dGluZyAke2FiVGFnc1tpXX0gbG9jYWwgbWFzayBmcm9tIGFiUGVyc29uYWxpdHlDb25maWdEYXRhOiAke2FiUGVyc29uYWxpdHlDb25maWdEYXRhW2FiVGFnc1tpXV19YCk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsIGFiVGFnc1tpXSwgYWJQZXJzb25hbGl0eUNvbmZpZ0RhdGFbYWJUYWdzW2ldXSwgImxvY2FsIik7DQogICAgICAgIH0NCiAgICB9IGVsc2UgaWYgKGxpbmtzLnJlbWVtYmVyICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3NbYWJUYWdzW2ldXSkgew0KICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFnc1thYlRhZ3NbaV1dICE9IHRhZ3NbYWJUYWdzW2ldXSkgew0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldHRpbmcgJHthYlRhZ3NbaV19IGxvY2FsIG1hc2sgZnJvbSBhYiByZW1lbWJlciBib3Q6YCwgbGlua3MucmVtZW1iZXIudGFnc1thYlRhZ3NbaV1dKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgYWJUYWdzW2ldLCBsaW5rcy5yZW1lbWJlci50YWdzW2FiVGFnc1tpXV0sICJsb2NhbCIpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKGFiVGFnc1tpXSA9PSAiYWJCYXNlR3JpZFBvcnRhbENvbG9yIikgew0KICAgICAgICBncmlkUG9ydGFsQm90LnRhZ3MucG9ydGFsQ29sb3IgPSB0YWdzLmFiQmFzZUdyaWRQb3J0YWxDb2xvcjsNCiAgICB9DQoNCiAgICBpZiAoYWJUYWdzW2ldID09ICJhYk1hcFBvcnRhbEJhc2UiKSB7DQogICAgICAgIG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLmFiTWFwUG9ydGFsQmFzZTsNCiAgICAgICAgbWluaU1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLmFiTWFwUG9ydGFsQmFzZTsNCiAgICB9DQp9DQoNCi8vIFJ5YW4gKEF1ZyAyOSwgMjAyNSk6IGltIG5vdCBzdXJlIGV4YWN0bHkgd2hhdCBpcyBoYXBwZW5pbmcgaGVyZSBidXQgd2l0aG91dCBzbGVlcGluZyBvbiB0aGVzZSBiaWcgdGFnIG1hc2sgY2hhbmdlcywgdGhleSBkb250IGFsbCBzZWVtIHRvIGNvbWUgaW4gcHJvcGVybHkuDQphd2FpdCBvcy5zbGVlcCgxMDApOw0KDQp0aGlzQm90LnZhcnMudXBkYXRpbmdQZXJzb25hbGl0eSA9IGZhbHNlOw0Kc2hvdXQoJ29uQUJQZXJzb25hbGl0eVVwZGF0ZWQnLCB7IGJvdDogdGhpc0JvdCB9KTsnAOj1ifQHynINYWJQZXJzb25hbGl0eQIEAOj1ifQH0J4BBHRydWUnAOj1ifQHynINb25Ta2lsbFVwZGF0ZQIEAOj1ifQH1Z4BHUB0aGlzQm90LnVwZGF0ZVBlcnNvbmFsaXR5KCk7JwDo9Yn0B8pyEWFiQmFzZVNoYWRvd0NvbG9yAgQA6PWJ9AfzngEFYmxhY2snAOj1ifQHynIQYWJCYXNlTGFiZWxDb2xvcgIEAOj1ifQH+Z4BBWJsYWNrJwDo9Yn0B8pyCm1hcE9wdGlvbnMCBADo9Yn0B/+eAZ4H8J+nrFsNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzYXRlbGxpdGUiLA0KICAgICAgICAiaWQiOiAic2F0ZWxsaXRlIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiaHlicmlkIiwNCiAgICAgICAgImlkIjogImh5YnJpZCINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgIm9jZWFucyIsDQogICAgICAgICJpZCI6ICJvY2VhbnMiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJvcGVuIHN0cmVldCBtYXAiLA0KICAgICAgICAiaWQiOiAib3NtIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAidGVycmFpbiIsDQogICAgICAgICJpZCI6ICJ0ZXJyYWluIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiZGFyayBncmF5IGNhbnZhcyIsDQogICAgICAgICJpZCI6ICJkYXJrLWdyYXkiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJncmF5IGNhbnZhcyIsDQogICAgICAgICJpZCI6ICJncmF5Ig0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAoZGFyaykiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1uaWdodC12ZWN0b3IiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChuYXZpZ2F0aW9uKSIsDQogICAgICAgICJpZCI6ICJzdHJlZXRzLW5hdmlnYXRpb24tdmVjdG9yIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAidG9wb2dyYXBoaWMiLA0KICAgICAgICAiaWQiOiAidG9wbyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKHJlbGllZikiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1yZWxpZWYtdmVjdG9yIg0KICAgIH0NCl0nAOj1ifQHynIUc2hvd0FCQmFzZW1hcE9wdGlvbnMCBADo9Yn0B5ymAcQFQHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQoNCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7DQpjb25maWdCb3QudGFncy5tZW51UG9ydGFsID0gJ2FiQmFzZW1hcE9wdGlvbnNNZW51JzsNCg0KZm9yIChjb25zdCBvcHRpb24gb2YgdGFncy5tYXBPcHRpb25zKSB7DQogICAgaWYgKG9wdGlvbi5pZCA9PSBtYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwKSB7DQogICAgICAgIGNvbnRpbnVlOw0KICAgIH0NCiAgICBjb25zdCBvcHRpb25PYmogPSANCiAgICB7DQogICAgICAgIGFiQmFzZW1hcE9wdGlvbnNNZW51OiB0cnVlLA0KICAgICAgICBjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51OiBgQGRlc3Ryb3kodGhpc0JvdCk7YCwNCiAgICAgICAgbWFwSUQ6IG9wdGlvbi5pZCwNCiAgICAgICAgbGFiZWw6IG9wdGlvbi5uYW1lLA0KICAgICAgICBvbkNsaWNrOiBgQA0KICAgICAgICAgICAgbWFwUG9ydGFsQm90LnRhZ3MubWFwUG9ydGFsQmFzZW1hcCA9IHRhZ3MubWFwSUQ7DQogICAgICAgICAgICBzaG91dCgnY2hhbmdlUGVyc29uYWxpdHlDb25maWcnLCB7J21hcEJhc2VtYXAnOiB0YWdzLm1hcElEfSk7IA0KICAgICAgICAgICAgc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCiAgICAgICAgYA0KICAgIH0NCg0KICAgIGFiLmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG9wdGlvbk9iaik7DQp9JwDo9Yn0B8pyC29uR3JpZENsaWNrAgQA6PWJ9AfhqwEmQHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQonAOj1ifQHynIFZGVidWcCBADo9Yn0B4isAQVmYWxzZScBBGJvdHMkYjliODI4MTktMWYxNC00MzkyLTg4YTktNTJmNjdhOWY4ZTU1AScA6PWJ9AeOrAEGc3lzdGVtAgQA6PWJ9AePrAEYYWIucGVyc29uYWxpdHkuYXJtX251ZGdlJwDo9Yn0B46sAQ1vbkFCQXJtUGxhY2VkAgQA6PWJ9AeorAE4QHNldFRhZ01hc2sodGhpc0JvdCwgJ2hhc0FybUJlZW5QbGFjZWQnLCB0cnVlLCAnbG9jYWwnKTsnAOj1ifQHjqwBCW9uQUJBd2FrZQIEAOj1ifQH4awBMEBhd2FpdCBvcy5zbGVlcCgyNTApOwp0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycA6PWJ9AeOrAEIYWJJZ25vcmUCBADo9Yn0B5KtAQR0cnVlJwDo9Yn0B46sAQ1hYlBlcnNvbmFsaXR5AgQA6PWJ9AeXrQEEdHJ1ZScA6PWJ9AeOrAEEZm9ybQIEAOj1ifQHnK0BB25vdGhpbmcnAOj1ifQHjqwBBWxlYXJuAgQA6PWJ9AekrQEo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA6PWJ9AeOrAENbWFuaWZlc3RhdGlvbgIEAOj1ifQHy60BKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAOj1ifQHjqwBCHJlbWVtYmVyAgQA6PWJ9AfyrQEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA6PWJ9AeOrAEFZGVidWcCBADo9Yn0B5muAQVmYWxzZScA6PWJ9AeOrAEOYXJtTnVkZ2VXYWl0TVMCBADo9Yn0B5+uAQQ1MDAwJwDo9Yn0B46sAQ9vbkFCSW5pdGlhbGl6ZWQCBADo9Yn0B6SuARtAdGhpc0JvdC5hYlN0YXJ0QXJtTnVkZ2UoKTsnAOj1ifQHjqwBD2FiU3RhcnRBcm1OdWRnZQIEAOj1ifQHwK4B4htAaWYgKHRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoZXJlIGlzIGFscmVhZHkgYSBudWRnZSBpbiBwcm9ncmVzcy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlID0gdHJ1ZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXJ0aW5nIG51ZGdlLi4uYCkKfQoKZnVuY3Rpb24gY2FuTnVkZ2UoKTogYm9vbGVhbiB7CiAgICAvLyBDYW4ndCBoYXZlIHBsYWNlZCB0aGUgYXJtIGFscmVhZHkuCiAgICBpZiAodGFncy5oYXNBcm1CZWVuUGxhY2VkKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFybSBwbGFjZW1lbnQgaGFzIGFscmVhZHkgb2NjdXJlZC5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEFCIG1hbmlmZXN0YXRpb24gYm90IG11c3QgYmUgYWN0aXZlLgogICAgaWYgKCFsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFiIG1hbmlmZXN0YXRpb24gYm90IGlzIGluYWN0aXZlLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gVGhlIGluc3QgbXVzdCBiZSBlbXB0eSBvZiBhbGwgYm90cy4gVGhlIGV4Y2VwdGlvbnMgYXJlIGFiIGJvdHMgYW5kIGJ1aWx0LWluIGJvdHMuCiAgICBjb25zdCB1c2VyTWFkZUJvdCA9IGdldEJvdCgoYikgPT4gewogICAgICAgIHJldHVybiAhYi50YWdzLnN5c3RlbT8uc3RhcnRzV2l0aCgnYWIuJykgJiYKICAgICAgICAgICAgICAgIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmCiAgICAgICAgICAgICAgICAhYi50YWdzLmFiRWdnIC8vIERvbid0IGluY2x1ZGUgYWJFZ2cgYm90cyBhcyAidXNlciBtYWRlIi4KICAgIH0pCiAgICAKICAgIGlmICh1c2VyTWFkZUJvdCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnVXNlck1hZGVCb3RzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB1c2VyTWFkZUJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFiLnRhZ3Muc3lzdGVtPy5zdGFydHNXaXRoKCdhYi4nKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJFZ2cgLy8gRG9uJ3QgaW5jbHVkZSBhYkVnZyBib3RzIGFzICJ1c2VyIG1hZGUiLgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBpbnN0IGNvbnRhaW5zIHVzZXIgbWFkZSBib3RzLmAsIHVzZXJNYWRlQm90cyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogaW5zdCBjb250YWlucyB1c2VyIG1hZGUgYm90cy5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gTWVudSBwb3J0YWwgbXVzdCBlaXRoZXIgYmUgaW5hY3RpdmUgb3Igbm90IGhhdmUgYW55IGJvdHMgaW4gdGhlIGN1cnJlbnRseSBhY3RpdmUgbWVudSBwb3J0YWwuCiAgICBpZiAoY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGNvbnN0IGJvdEluTWVudVBvcnRhbCA9IGdldEJvdCgoYikgPT4gewogICAgICAgICAgICByZXR1cm4gYi50YWdzW2NvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWxdID09PSB0cnVlCiAgICAgICAgfSk7CgogICAgICAgIGlmIChib3RJbk1lbnVQb3J0YWwpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBvcGVuIGFuZCBoYXMgYm90cyBpbiBpdC5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwp9CgppZiAoY2FuTnVkZ2UoKSkgewogICAgLy8gU3RhcnQgbnVkZ2UgZm9yIGFybSBwbGFjZW1lbnQuCiAgICBhd2FpdCBvcy5zbGVlcCh0YWdzLmFybU51ZGdlV2FpdE1TKTsKCiAgICBpZiAoY2FuTnVkZ2UoKSkgewogICAgICAgIGNvbnN0IGFiUG9zaXRpb25YID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdC50YWdzW2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gKyAnWCddOwogICAgICAgIGNvbnN0IGFiUG9zaXRpb25ZID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdC50YWdzW2xpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24gKyAnWSddOwoKICAgICAgICBjb25zdCBncmlkQ2xpY2tQYXJhbXMgPSB7CiAgICAgICAgICAgIGRpbWVuc2lvbjogbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiwKICAgICAgICAgICAgcG9zaXRpb246IHsgeDogYWJQb3NpdGlvblggKyA1LCB5OiBhYlBvc2l0aW9uWSB9LAogICAgICAgICAgICBmb3JjZUFybVBsYWNlbWVudDogdHJ1ZSwKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwgPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb24pIHsKICAgICAgICAgICAgLy8gTWFwIHBvcnRhbCBpcyBpbiBkaWZmZXJlbnQgY29vcmRpbmF0ZSBzcGFjZSBhbmQgc2NhbGUuCiAgICAgICAgICAgIGdyaWRDbGlja1BhcmFtcy5wb3NpdGlvbi54ID0gYWJQb3NpdGlvblggKyAwLjAwMDM1NzQzNDA2ODQwNTM4MjM7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdoaXNwZXJpbmcgb25HcmlkQ2xpY2sgdG8gdGhlIGFiIG1hbmlmZXN0YXRpb24gYm90IHdpdGggdGhlIHBhcmFtczpgLCBncmlkQ2xpY2tQYXJhbXMpCiAgICAgICAgfQoKICAgICAgICAvLyBGb3JjZSBhYiBhcm0gcGxhY2VtZW50IHVzaW5nIHRoZSBvbkdyaWRDbGljayBsaXN0ZW5lciBvZiB0aGUgbWFuaWZlc3RhdGlvbiBib3QuCiAgICAgICAgd2hpc3BlcihsaW5rcy5tYW5pZmVzdGF0aW9uLCAnb25HcmlkQ2xpY2snLCBncmlkQ2xpY2tQYXJhbXMpOwogICAgfQp9Cgp0aGlzQm90LnZhcnMubnVkZ2VBY3RpdmUgPSBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRvbmVgKTsKfScA6PWJ9AeOrAEJYWJWZXJzaW9uAgQA6PWJ9AejygEFMTAuMzUnAOj1ifQHjqwBD29uUG9ydGFsQ2hhbmdlZAIEAOj1ifQHqcoBhQFAY29uc3QgeyBwb3J0YWwsIGRpbWVuc2lvbiB9ID0gdGhhdDsKCmlmIChwb3J0YWwgPT09ICdtZW51UG9ydGFsJykgewogICAgaWYgKCFkaW1lbnNpb24pIHsKICAgICAgICB0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOwogICAgfQp9JwDo9Yn0B46sAQ1hYk1lbnVSZWZyZXNoAgQA6PWJ9AevywEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwDo9Yn0B46sARFkZWJ1Z1VzZXJNYWRlQm90cwIEAOj1ifQHy8sBBWZhbHNlJwEEYm90cyRkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQBJwDo9Yn0B9HLAQZzeXN0ZW0CBADo9Yn0B9LLARxhYi5wZXJzb25hbGl0eS5tYW5pZmVzdGF0aW9uJwDo9Yn0B9HLAQRmb3JtAgQA6PWJ9AfvywEHbm90aGluZycA6PWJ9AfRywELZGVzY3JpcHRpb24CBADo9Yn0B/fLAThUaGlzIHNraWxsIGNvbnRyb2xzIHRoZSBhY3R1YWwgYm90IGZvciB0aGUgYWIgaW50ZXJmYWNlLicA6PWJ9AfRywEFbGVhcm4CBADo9Yn0B7DMASjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDo9Yn0B9HLAQ9vblBvcnRhbENoYW5nZWQCBADo9Yn0B9fMAbNAQGNvbnN0IFBPUlRBTFNfVEhBVF9ISURFID0gbmV3IFNldChbCiAgICAic3lzdGVtUG9ydGFsIiwKICAgICJzaGVldFBvcnRhbCIKXSkKCmNvbnN0IFBPUlRBTFNfVEhBVF9NQU5JRkVTVCA9IG5ldyBTZXQoWwogICAgImdyaWRQb3J0YWwiLAogICAgIm1hcFBvcnRhbCIKXSk7Cgphc3luYyBmdW5jdGlvbiBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbihwb3J0YWw6ICdtYXAnIHwgJ2dyaWQnKTogeyB4OiBudW1iZXIsIHk6IG51bWJlciB9IHsKICAgIGlmIChwb3J0YWwgPT09ICdncmlkJykgewogICAgICAgIHJldHVybiB7IHg6IDAsIHk6IDAgfQogICAgfSBlbHNlIGlmIChwb3J0YWwgPT09ICdtYXAnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbj8ueCA9PT0gJ251bWJlcicgJiYgIHR5cGVvZiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbj8ueSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgcmV0dXJuIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwWm9vbVBvc2l0aW9uOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBjdXJyZW50UG9zaXRpb24gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGxldCBoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24gPSBhd2FpdCBsaW5rcy51dGlscy5oYXNHZW9sb2NhdGlvblBlcm1pc3Npb24oKTsKCiAgICAgICAgICAgIC8vIEN1cnJlbnQgd29yay1hcm91bmQgZm9yIGFsbG93aW5nIGdlb2xvY2F0aW9uIGZvciBpT1MgYXBwCiAgICAgICAgICAgIGlmIChnZXRCb3QoInN5c3RlbSIsICJhYi5pb3NicmlkZ2UubWVzc2VuZ2VyIikpIHsKICAgICAgICAgICAgICAgIGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbiA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdlb2xvY2F0aW9uID0gYXdhaXQgb3MuZ2V0R2VvbG9jYXRpb24oKTsKICAgICAgICAgICAgICAgIGlmIChnZW9sb2NhdGlvbi5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBvc2l0aW9uID0geyB4OiBnZW9sb2NhdGlvbi5sb25naXR1ZGUsIHk6IGdlb2xvY2F0aW9uLmxhdGl0dWRlIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGN1cnJlbnRQb3NpdGlvbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRQb3NpdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEdSUE0gUG9zaXRpb24KICAgICAgICAgICAgICAgIHJldHVybiB7IHg6IC04NS42NzYxODk0ODIyNDM0LCB5OiA0Mi45NjU2NzU2NzU2NzU2IH07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bnJlY29uZ2l6ZWQgcG9ydGFsIHR5cGUgcHJvdmlkZWQgdG8gZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb246YCwgcG9ydGFsKTsKICAgICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH0KICAgIH0KfQoKY29uc3QgTUFQX0xPQURfV0FJVF9USU1FID0gMTAwMDsKCmZvciAoY29uc3QgcG9ydGFsIG9mIFBPUlRBTFNfVEhBVF9ISURFKSB7CiAgICBpZiAoY29uZmlnQm90LnRhZ3NbcG9ydGFsXSAhPSBudWxsKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhIHBvcnRhbCB0aGF0IGhpZGVzIGFiIGlzIG9wZW4gLSBoaWRpbmcgYWJCb3QgYW5kIGlnbm9yaW5nLmApOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuYWJCb3QpIHsKICAgICAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCmlmIChjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCAhPSBudWxsIHx8IGNvbmZpZ0JvdC50YWdzLnN5c3RlbVBvcnRhbCAhPSBudWxsKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hlZXQgcG9ydGFsIG9yIHN5c3RlbSBwb3J0YWwgb3BlbmVkIC0gaGlkaW5nIGFiQm90IGFuZCBpZ25vcmluZy5gKTsKICAgIH0KCiAgICBpZiAodGFncy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MuYWJCb3QpOwogICAgfQoKICAgIHJldHVybjsKfQoKaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYiBpcyBub3QgYXdha2UgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRoYXQucG9ydGFsID09ICJ0YWdQb3J0YWwiKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGFnUG9ydGFsIGNoYW5nZWQgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRoYXQucG9ydGFsID09ICJtZW51UG9ydGFsIikgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1lbnVQb3J0YWwgY2hhbmdlZCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gImdyaWRQb3J0YWwiICYmIGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdyaWRQb3J0YWwgY2hhbmdlZCwgYnV0IGFsc28gYWxyZWFkeSBpbiB0aGUgbWFwUG9ydGFsIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCi8vIFRoZSBtYXAgcG9ydGFsIGlzIHRvdWdoLiBJdCBzZWVtcyB0byB2YXJ5IGluIGxvYWRpbmcgc3BlZWQgb24KLy8gdmFyaW91cyBoYXJkd2FyZSBhbmQgbmV0d29ya3MgYW5kIGhhcyBieSB0aGUgdGltZSBvblBvcnRhbENoYW5nZWQgaXMgY2FsbGVkIGl0IGRvZXNudAovLyBzZWVtIGd1YXJlbnRlZWQgdG8gYmUgYWN0dWFsbHkgcmVhZHkuIEFkZGluZyBhIGhhcmRjb2RlZCB3YWl0IHRpbWUgdG8gZ2l2ZSB0aGUgcG9ydGFsIHNwYWNlIHRvIGdldAovLyB0aGUgbWFwIHBvcnRhbCBmdWxseSBsb2FkZWQgYmVmb3JlIGNvbnRpbnVpbmcgd2l0aCBtYW5pZmVzdGluZyBhYi4KLy8KLy8gQXQgc29tZSBwb2ludCB0aGlzIGNhbiBnbyBhd2F5IGlmIHdlIGV2ZXIgZ2V0IGEgc2hvdXQgb3Igc29tZSBvdGhlciBnYXVyZW50ZWUgdGhhdCB0aGUgbWFwIHBvcnRhbCBpcyBsb2FkZWQvcmVhZHkuCmlmICh0aGF0LnBvcnRhbCA9PT0gJ21hcFBvcnRhbCcpIHsKICAgIGlmICh0aGF0LmRpbWVuc2lvbikgewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRlZCkgewogICAgICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG9zLnNsZWVwKE1BUF9MT0FEX1dBSVRfVElNRSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2FpdGluZyBmb3IgbWFwIHBvcnRhbCB0byBmaW5pc2ggbG9hZGluZzogJHtNQVBfTE9BRF9XQUlUX1RJTUV9bXNgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXI7CiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRlZCA9IHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFwIHBvcnRhbCBpcyBhbHJlYWR5IGxvYWRlZC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRlZCA9IGZhbHNlOwogICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyID0gbnVsbDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXAgcG9ydGFsIGhhcyBiZWVuIHVubG9hZGVkLmApOwogICAgICAgIH0KICAgIH0KfQoKLy8gU3RhcnQgY2hlY2tzIGZvciBpZi93aGVyZSB3ZSBuZWVkIHRvIG1hbmlmZXN0IGFiLgpsZXQgbmV3QUIgPSBmYWxzZTsKbGV0IG5ld0FCUG9ydGFsOwpsZXQgbmV3QUJQb3NpdGlvbjsKbGV0IGZvY3VzQ2FtZXJhID0gdHJ1ZTsKCmlmIChQT1JUQUxTX1RIQVRfTUFOSUZFU1QuaGFzKHRoYXQucG9ydGFsKSAmJiB0aGF0LmRpbWVuc2lvbikgewogICAgLy8gQSBwb3J0YWwgdGhhdCBtYW5pZmVzdHMgYWIgaGFzIGp1c3QgY2hhbmdlZCBkaW1lbnNpb24uCiAgICAvLyBNYW5pZmVzdCBhYiBpbiB0aGUgbmV3IGRpbWVuc2lvbi4KICAgIGlmICh0aGF0LnBvcnRhbCA9PSAibWFwUG9ydGFsIiB8fCB0aGF0LnBvcnRhbCA9PSAibWluaU1hcFBvcnRhbCIpIHs7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYW5pZmVzdGluZyBhYiBib3QgaW4gbWFwIHBvcnRhbCBkaW1lbnNpb24gJyR7dGhhdC5kaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignbWFwJyk7CiAgICAgICAgbmV3QUJQb3J0YWwgPSB0aGF0LnBvcnRhbDsKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYW5pZmVzdGluZyBhYiBib3QgZGltZW5zaW9uICcke3RoYXQuZGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ2dyaWQnKTsKICAgICAgICBuZXdBQlBvcnRhbCA9IHRoYXQucG9ydGFsOwogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgcG9zaXRpb246IG5ld0FCUG9zaXRpb24gfSk7CiAgICB9Cn0gZWxzZSBpZiAoKFBPUlRBTFNfVEhBVF9NQU5JRkVTVC5oYXModGhhdC5wb3J0YWwpIHx8IFBPUlRBTFNfVEhBVF9ISURFLmhhcyh0aGF0LnBvcnRhbCkpICYmIAogICAgICAgICAgICF0aGF0LmRpbWVuc2lvbiAmJiAKICAgICAgICAgICAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCB8fCBjb25maWdCb3QudGFncy5tYXBQb3J0YWwpCikgewogICAgLy8gQSBwb3J0YWwgdGhhdCB0eXBpY2FsbHkgaGlkZXMgb3IgcmUtbWFuaWZlc3RzIGFiIGp1c3QgY2xvc2VkLCBidXQgZWl0aGVyIHRoZSBncmlkIG9yIG1hcCBwb3J0YWwgYXJlIHN0aWxsIG9wZW4uCiAgICAvLyBTdW1tb24gYWIgaW4gZWl0aGVyIHRoZSBtYXBQb3J0YWwgb3IgZ3JpZFBvcnRhbC4KICAgIGxldCBzdW1tb25EaW1lbnNpb247CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkgewogICAgICAgIHN1bW1vbkRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbDsKICAgICAgICBuZXdBQlBvcnRhbCA9ICdtYXBQb3J0YWwnOwogICAgICAgIAogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddKSB7CiAgICAgICAgICAgIC8vIFVzZSBsYXN0IGtub3duIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gbGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVc2UgZGVmYXVsdCBtYXAgcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignbWFwJyk7CiAgICAgICAgfQogICAgfSBlbHNlIGlmIChjb25maWdCb3QudGFncy5ncmlkUG9ydGFsKSB7CiAgICAgICAgc3VtbW9uRGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbDsKICAgICAgICBuZXdBQlBvcnRhbCA9ICdncmlkUG9ydGFsJzsKCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10pIHsKICAgICAgICAgICAgLy8gVXNlIGxhc3Qga25vd24gcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFVzZSBkZWZhdWx0IGdyaWQgcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignZ3JpZCcpOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAoc3VtbW9uRGltZW5zaW9uKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdW1tb25pbmcgYWIgYm90IGluICR7bmV3QUJQb3J0YWx9IGRpbWVuc2lvbiAnJHtzdW1tb25EaW1lbnNpb259Jy5gKTsKICAgICAgICB9CgogICAgICAgIG5ld0FCID0gYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uOiBzdW1tb25EaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwoKICAgICAgICBpZiAoUE9SVEFMU19USEFUX0hJREUuaGFzKHRoYXQucG9ydGFsKSkgewogICAgICAgICAgICAvLyBJZiB0aGUgcG9ydGFsIHRoYXQgY2xvc2VkIHdhcyBhIHBvcnRhbCB0aGF0IGhpZGVzIGFiLCB0aGVuIGRvbnQgcnVuIHRoZSBjYW1lcmEgZm9jdXMuCiAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBqdXN0IHVzZSB0aGUgcHJldmlvdXMgY2FtZXJhIHBvc2l0aW9uIGFscmVhZHkgc3RvcmVkIGluIG1lbW9yeS4KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2lsbCBub3QgZm9jdXMgY2FtZXJhIG9uIGFiIGJlY2F1c2Ugd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhlIHByZXZpb3VzIGNhbWVyYSBwb3NpdGlvbi5gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb2N1c0NhbWVyYSA9IGZhbHNlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RoIHRoZSBtYXAgYW5kIGdyaWQgcG9ydGFsIGFyZSBib3RoIGNsb3NlZCwgY2Fubm90IHN1bW1vbiBhYiBpbiBlaXRoZXIuYCk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgcmV0dXJuOwp9CgppZiAobmV3QUIgJiYgZm9jdXNDYW1lcmEpIHsKICAgIGxldCB6b29tID0gMTA7CgogICAgaWYgKG5ld0FCUG9ydGFsID09PSAnbWFwUG9ydGFsJyB8fCBuZXdBQlBvcnRhbCA9PT0gJ21pbmlNYXBQb3J0YWwnKSB7CiAgICAgICAgem9vbSA9IDIwMDA7CiAgICB9CiAgICB0cnkgewogICAgICAgIGF3YWl0IG9zLmZvY3VzT24obmV3QUJQb3NpdGlvbiwgeyB6b29tLCByb3RhdGlvbjogeyB4OiA0NSwgeTogNDUgfSwgcG9ydGFsOiBuZXdBQlBvcnRhbCB9KQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvY3VzT24gZXJyb3Igb2NjdXJlZDpgLCBlKTsKICAgICAgICB9CiAgICB9Cn0nAOj1ifQH0csBCHJlbWVtYmVyAgQA6PWJ9AeLjQIo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA6PWJ9AfRywENYWJNYW5pZmVzdEJvdAIEAOj1ifQHso0CyzRAY29uc3QgZGltZW5zaW9uID0gdGhhdD8uZGltZW5zaW9uOwpjb25zdCBwb3NpdGlvbiA9IHRoYXQ/LnBvc2l0aW9uOwoKaWYgKHRoaXNCb3QudmFycy5hYkJvdExhc3RJZCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgYWJCb3RgKTsKICAgIH0KICAgIGRlc3Ryb3kodGhpc0JvdC52YXJzLmFiQm90TGFzdElkKTsKfQoKY29uc3QgYWJNb2QgPSB7CiAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGZvcm1PcGFjaXR5OiAnMC4zMycsCiAgICBkaW1lbnNpb24sCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtkaW1lbnNpb24gKyAnWCddOiBwb3NpdGlvbi54LAogICAgW2RpbWVuc2lvbiArICdZJ106IHBvc2l0aW9uLnksCiAgICBzdHJva2VDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIHN0cm9rZVdpZHRoOiAxLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbGFiZWw6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWwsCiAgICBsYWJlbFBvc2l0aW9uOiAnZnJvbnQnLAogICAgbGFiZWxDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC42MSwKICAgIGRyYWdnYWJsZTogZmFsc2UsCiAgICBzY2FsZTogMC45LAogICAgYXJtU2VsZWN0aW9uOiB0cnVlLAogICAgYXJtR3JvdXBEcmFnOiB0cnVlLAogICAgYXJtVGVsZXBvcnQ6IHRydWUsCiAgICBhcm1Db2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIHBlcnNvbmFsaXR5OiB0YWdzLnBlcnNvbmFsaXR5LAogICAgZm9ybURlcHRoVGVzdDogZmFsc2UsCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgLy8gQ3JlYXRlIHRoZSBjb3JlIGN1YmUuCiAgICAgICAgY29uc3QgY29yZU1vZCA9IHsKICAgICAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgICAgICBhYkJvdDogZ2V0TGluayh0aGlzQm90KSwKICAgICAgICAgICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAwLjY2LAogICAgICAgICAgICBwb2ludGFibGU6IGZhbHNlLAogICAgICAgICAgICBzY2FsZTogMC43NSwKICAgICAgICAgICAgdHJhbnNmb3JtZXI6IHRoaXNCb3QuaWQsCiAgICAgICAgICAgIGFuY2hvclBvaW50OiAnY2VudGVyJywKICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgJ1onXTogLTAuNQogICAgICAgIH0KCiAgICAgICAgbWFza3MuY29yZUJvdCA9IGdldExpbmsoY3JlYXRlKGNvcmVNb2QpKTsKCiAgICAgICAgdGhpc0JvdC5hbmltYXRlQm90KCk7CiAgICAgICAgbWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzQm90LmFuaW1hdGVCb3QoKSwgMjAwMCk7CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT0gJ3JpZ2h0JykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChtYXNrcy5hcm1Cb3QpIHsKICAgICAgICAgICAgZGVzdHJveShsaW5rcy5hcm1Cb3QpOwogICAgICAgICAgICBtYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKCk7CiAgICB9KSwKICAgIG9uUG9pbnRlckVudGVyOkxpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJykgewogICAgICAgICAgICB0YWdzLm1vdXNlT3ZlciA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvblBvaW50ZXJFeGl0OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScpIHsKICAgICAgICAgICAgdGFncy5tb3VzZU92ZXIgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlckRvd246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnRCdXR0b25Eb3duID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlclVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQubW9kYWxpdHkgPT09ICdtb3VzZScgJiYgdGhhdC5idXR0b25JZCA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0QnV0dG9uRG93biA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdERyYWdnaW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7CiAgICAgICAgfQogICAgfSksCiAgICBvbkRyYWc6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5tb3VzZUxlZnRCdXR0b25Eb3duKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICBvbktleURvd246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5rZXlzLmluY2x1ZGVzKCdTaGlmdCcpKSB7CiAgICAgICAgICAgIHRhZ3Muc2hpZnRIZWxkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgb25LZXlVcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmtleXMuaW5jbHVkZXMoJ1NoaWZ0JykpIHsKICAgICAgICAgICAgdGFncy5zaGlmdEhlbGQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsgIAogICAgICAgIH0KICAgIH0pLAogICAgdXBkYXRlUG9ydGFsQ3Vyc29yOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGV0IGN1cnNvciA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLm1vdXNlTGVmdERyYWdnaW5nKSB7CiAgICAgICAgICAgIGN1cnNvciA9ICdncmFiYmluZyc7ICAgIAogICAgICAgIH0gZWxzZSBpZiAodGFncy5tb3VzZU92ZXIpIHsKICAgICAgICAgICAgaWYgKHRhZ3Muc2hpZnRIZWxkKSB7CiAgICAgICAgICAgICAgICBjdXJzb3IgPSAnY29udGV4dC1tZW51JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnNvciA9ICdwb2ludGVyJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxDdXJzb3IgPSBjdXJzb3I7CiAgICB9KSwKICAgIGFuaW1hdGVCb3Q6IExpc3RlbmVyU3RyaW5nKGFzeW5jICgpID0+IHsgCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLmFiT3B0aW1pemVkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHJvdFogPSB0YWdzLmRpbWVuc2lvbiArICdSb3RhdGlvblonOwogICAgICAgIGxldCB0YXJnZXRTY2FsZSA9IDAuNjU7CgogICAgICAgIGF3YWl0IGFuaW1hdGVUYWcodGhpc0JvdCwKICAgICAgICB7CiAgICAgICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICAgICAgW3JvdFpdOiAwLAogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgICAgICBbcm90Wl06IDYuMywKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgICAgICB0eXBlOiAnc2ludXNvaWRhbCcsCiAgICAgICAgICAgICAgICBtb2RlOiAnaW5vdXQnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAyCiAgICAgICAgfSkuY2F0Y2goZSA9PiB7fSk7CiAgICB9KSwKICAgIG9uQXJtQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKCF0YWdzLmludGVydmFsKSB7CiAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IHJlc2V0OiB0cnVlIH0pOwogICAgICAgIH0KICAgIH0pLAogICAgb25Bcm1QbGFjZWQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkdyaWRGb2N1cyA9IHsKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwgCiAgICAgICAgICAgIHBvc2l0aW9uOiB7CiAgICAgICAgICAgICAgICB4OiB0aGF0LngsCiAgICAgICAgICAgICAgICB5OiB0aGF0LnkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgbWVudTogJ2dyaWQnIH0pOwoKICAgICAgICBzaG91dCgnb25BQkFybVBsYWNlZCcsIHRoYXQpOwogICAgfSksCiAgICBvbkFybUNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgcmVzZXQ6IHRydWUgfSk7CiAgICAgICAgc2hvdXQoJ29uQUJGb290Q2xpY2tlZCcsIHRoYXQpOwogICAgfSksCiAgICBvbkFybVNlbGVjdGVkQm90czogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHNlbGVjdGVkQm90cyA9IHRoYXQ7CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHNlbGVjdGVkQm90cykpIHsKICAgICAgICAgICAgLy8gTXVsdGlwbGUgYm90IHNlbGVjdGlvbi4KICAgICAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJNdWx0aXBsZUJvdEZvY3VzID0gZ2V0TGluayhzZWxlY3RlZEJvdHMpOwogICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnbXVsdGlwbGVCb3QnIH0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFNpbmdsZSBib3Qgc2VsZWN0aW9uLgogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYkJvdEZvY3VzID0gIvCflJciICsgc2VsZWN0ZWRCb3RzLmlkOwoKICAgICAgICAgICAgaWYgKHNlbGVjdGVkQm90cyA9PT0gdGhpc0JvdCkgewogICAgICAgICAgICAgICAgYWIubGlua3MubWVudS5hYkVudmlyb25tZW50TWVudSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgbWVudTogJ2JvdCcgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICBzaG91dCgnb25BQlNlbGVjdGVkQm90Jywgc2VsZWN0ZWRCb3RzKTsKICAgIH0pLAogICAgb25Bcm1EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsKICAgIH0pLAogICAgb25EZXN0cm95OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY2xlYXJJbnRlcnZhbCh0YWdzLmludGVydmFsKTsKICAgICAgICBzaG91dCgnYWJNZW51UmVmcmVzaCcpOwogICAgfSksCn07Cgpjb25zdCBhYkJvdCA9IGNyZWF0ZShhYk1vZCk7CgppZiAobGlua3MucmVtZW1iZXIudGFncy5hYlNlY29uZGFyeUxhYmVsKSB7CiAgICBjb25zdCBhYkxhYmVsQm90ID0gewogICAgICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgICAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICBbZGltZW5zaW9uICsgJ1onXTogLTEsCiAgICAgICAgY3JlYXRvcjogYWJCb3QuaWQsCiAgICAgICAgdHJhbnNmb3JtZXI6IGFiQm90LmlkLAogICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgY29sb3I6ICdjbGVhcicsCiAgICAgICAgbGFiZWw6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJTZWNvbmRhcnlMYWJlbCwKICAgICAgICBsYWJlbFBvc2l0aW9uOiAnbGVmdCcsCiAgICAgICAgbGFiZWxTaXplOiAwLjcsCiAgICAgICAgbGFiZWxDb2xvcjogYWJCb3QudGFncy5sYWJlbENvbG9yLAogICAgfTsKCiAgICBjcmVhdGUoYWJMYWJlbEJvdCk7Cn0KCm1hc2tzLmFiQm90ID0gZ2V0TGluayhhYkJvdCk7CmxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiQWN0aXZlRGltZW5zaW9uID0gZGltZW5zaW9uOwp0aGlzQm90LnZhcnMuYWJCb3RMYXN0SWQgPSBhYkJvdC5pZDsgLy8gU3RvcmluZyBpZCBhcyBhIHZhciBwcmV2ZW50cyBnaG9zdCBhYkJvdHMgZHVyaW5nIG11bHRpcGxlIGNhbGxzIGluIG9uZSBmcmFtZS4KCi8vIFN0b3JlIHRoZSBsYXN0IHBvc2l0aW9uIG9mIGFiIGluIHRoaXMgZGltZW5zaW9uIG9uIHRoZSByZW1lbWJlciBib3QuCmxpbmtzLnJlbWVtYmVyLm1hc2tzW2RpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddID0gJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoeyB4OiBwb3NpdGlvbj8ueCwgeTogcG9zaXRpb24/LnkgfSk7Cgphd2FpdCBvcy5zbGVlcCgwKTsgLy8gR2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byB1cGRhdGUgdGFnIG1hc2tzLgoKc2hvdXQoJ29uQUJNb3ZlZCcsIHsgZGltZW5zaW9uLCB4OiBwb3NpdGlvbi54LCB5OiBwb3NpdGlvbi55IH0pOwoKcmV0dXJuIGFiQm90OycA6PWJ9AfRywELb25HcmlkQ2xpY2sCBADo9Yn0B/rBAoEPQGlmICghdGFncy5hYkF3YWtlKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IHNoaWZ0Q2hlY2sgPSBvcy5nZXRJbnB1dFN0YXRlKCJrZXlib2FyZCIsICJTaGlmdCIpOwoKaWYgKGxpbmtzLmFiQm90ICYmIChzaGlmdENoZWNrIHx8ICh0aGF0Lm1vZGFsaXR5ID09ICJtb3VzZSIgJiYgdGhhdC5idXR0b25JZCA9PSAicmlnaHQiICYmICFsaW5rcy5yZW1lbWJlci50YWdzLmFiUmlnaHRDbGlja0Rpc2FibGVkKSB8fCB0aGF0LmZvcmNlQXJtUGxhY2VtZW50KSkgewogICAgY29uc3QgYXJtQm90ID0gYWIubGlua3MuYXJtX3Rvb2wuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogbGlua3MuYWJCb3QsCiAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgICAgICBwb3NpdGlvbjogdGhhdC5wb3NpdGlvbiwKICAgIH0pCgogICAgLy8gRmFrZSB1c2VyIGRyb3BwaW5nIHRoZSBhcm0gb24gdGhlIGdyaWQgc3BhY2UuCiAgICBhcm1Cb3Qub25Ecm9wKHsKICAgICAgICBib3Q6IGFybUJvdCwKICAgICAgICB0bzogewogICAgICAgICAgICB4OiB0aGF0LnBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IHRoYXQucG9zaXRpb24ueSwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0sCiAgICAgICAgZnJvbTogewogICAgICAgICAgICB4OiB0aGF0LnBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IHRoYXQucG9zaXRpb24ueSwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybjsKfQoKY29uc3QgZm9vdHByaW50ID0gewogICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgIFt0aGF0LmRpbWVuc2lvbl06IHRydWUsCiAgICBbdGhhdC5kaW1lbnNpb24gKyAiWCJdOiB0aGF0LnBvc2l0aW9uLngsCiAgICBbdGhhdC5kaW1lbnNpb24gKyAiWSJdOiB0aGF0LnBvc2l0aW9uLnksCiAgICBzY2FsZVo6IDAuMDEsCiAgICBwb3NpdGlvbkluZm86IHRoYXQsCiAgICBjb2xvcjogImNsZWFyIiwKICAgIHBlcnNvbmFsaXR5OiB0YWdzLnBlcnNvbmFsaXR5LAogICAgc3Ryb2tlQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBkcmFnZ2FibGU6IGZhbHNlLAogICAgY3Vyc29yOiAnYWxpYXMnLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZyhhc3luYyAoKSA9PiB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBkZXN0cm95KHRoaXNCb3QpLCA4MDApOwoKICAgICAgICBhd2FpdCBhbmltYXRlVGFnKHRoaXNCb3QsIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBzY2FsZVg6IDAuMSwKICAgICAgICAgICAgICAgIHNjYWxlWTogMC4xCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIHNjYWxlWDogMS4xLAogICAgICAgICAgICAgICAgc2NhbGVZOiAxLjEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IDAuNSwKICAgICAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgICAgICB0eXBlOiAiZWxhc3RpYyIsCiAgICAgICAgICAgICAgICBtb2RlOiAib3V0IgogICAgICAgICAgICB9CiAgICAgICAgfSkuY2F0Y2goZSA9PiB7fSk7CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgIHNob3V0KCJvbkFCRm9vdENsaWNrZWQiLCB7IGRpbWVuc2lvbjogdGFncy5kaW1lbnNpb24gfSk7CiAgICAgICAgbGlua3MubWFuYWdlci5hYk1hbmlmZXN0Qm90KHRhZ3MucG9zaXRpb25JbmZvKTsKICAgIH0pLAp9OwoKCmNyZWF0ZShmb290cHJpbnQpOycA6PWJ9AfRywEEbWVudQIEAOj1ifQH/NACKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAOj1ifQH0csBB2FiQ2xpY2sCBADo9Yn0B6PRAvgKQGlmICghbGlua3MuYWJCb3QpIHsKICAgIHJldHVybjsKfQoKaWYgKGxpbmtzLmlucHV0KSB7CiAgICBsaW5rcy5pbnB1dC5hYkNoYXRCYXJDbG9zZSgpOwp9Cgpjb25zdCByZXNldCA9IHRoYXQgPyB0aGF0LnJlc2V0IDogZmFsc2U7CmNvbnN0IG1lbnUgPSB0aGF0ID8gdGhhdC5tZW51IDogImNvcmUiOwpjb25zdCBzdGF0ZSA9IG9zLmdldElucHV0U3RhdGUoImtleWJvYXJkIiwgIlNoaWZ0Iik7CgppZiAoIXJlc2V0ICYmIChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsIHx8IHN0YXRlKSkgewogICAgY29uc3QgYWJNZW51Qm90cyA9IGdldEJvdHMoImFiTWVudSIsIHRydWUpOwoKICAgIHdoaXNwZXIoYWJNZW51Qm90cywgImFiTWVudVJlZnJlc2giKTsKCiAgICBjbGVhckludGVydmFsKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwpOwoKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmludGVydmFsID0gbnVsbDsKCiAgICBjbGVhckFuaW1hdGlvbnMobGlua3MuYWJCb3QpOwoKICAgIGNvbnN0IHJvdFogPSBsaW5rcy5hYkJvdC50YWdzLmRpbWVuc2lvbiArICJSb3RhdGlvbloiOwoKICAgIGlmIChzdGF0ZSAmJiBtZW51ID09ICJjb3JlIikgewogICAgICAgIGxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIGxpbmtzLm1lbnUuYWJPcGVuTWVudShtZW51KTsKICAgIH0KCiAgICBhbmltYXRlVGFnKGxpbmtzLmFiQm90LCB7CiAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgIFtyb3RaXTogbGlua3MuYWJCb3QudGFnc1tyb3RaXSwKICAgICAgICAgICAgc2NhbGU6IGxpbmtzLmFiQm90LnRhZ3Muc2NhbGUKICAgICAgICB9LAogICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgW3JvdFpdOiAwLAogICAgICAgICAgICBzY2FsZTogMC45CiAgICAgICAgfSwKICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgdHlwZTogInNpbnVzb2lkYWwiLAogICAgICAgICAgICBtb2RlOiAiaW5vdXQiCiAgICAgICAgfSwKICAgICAgICBkdXJhdGlvbjogMC41CiAgICB9KS5jYXRjaChlID0+IHt9KQp9CmVsc2UgewogICAgbGlua3MuYWJCb3QuYW5pbWF0ZUJvdCgpOwoKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmxpbmVUbyA9IG51bGw7CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBjbGVhckludGVydmFsKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwpOwogICAgbGlua3MuYWJCb3QubWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiBsaW5rcy5hYkJvdC5hbmltYXRlQm90KCksIDIwMDApOwp9CgpzaG91dCgnb25BQkNsaWNrJywgeyBhYkJvdDogbGlua3MuYWJCb3QsIGRpbWVuc2lvbjogbGlua3MuYWJCb3QudGFncy5kaW1lbnNpb24sIG1lbnUsIHNoaWZ0S2V5OiAhIXN0YXRlLCByZXNldCB9KTsnAOj1ifQH0csBCGFiSWdub3JlAgQA6PWJ9Aec3AIEdHJ1ZScA6PWJ9AfRywEDYXNrAgQA6PWJ9Aeh3AIo8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycA6PWJ9AfRywEJYXNrQnV0dG9uAgQA6PWJ9AfI3ALIBUBpZiAoIXRhZ3MuYWJBd2FrZSkKewogICAgcmV0dXJuOwp9CgpsZXQgYWJNZW51QnV0dG9uID0ge307CgphYk1lbnVCdXR0b24uYWJNZW51ID0gdHJ1ZTsKYWJNZW51QnV0dG9uLnJlbWVtYmVyID0gbGlua3MubWVudS50YWdzLnJlbWVtYmVyOwphYk1lbnVCdXR0b24ubWFuaWZlc3RhdGlvbiA9IGxpbmtzLm1lbnUudGFncy5tYW5pZmVzdGF0aW9uOwphYk1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKYWJNZW51QnV0dG9uLmJhc2VTa2lsbCA9ICLwn5SXIiArIGxpbmtzLmFzay5pZDsKYWJNZW51QnV0dG9uLmxhYmVsID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUxhYmVsOwphYk1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51SWNvbjsKYWJNZW51QnV0dG9uLm9uQ3JlYXRlID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudU9uR2VuZXJhdGU7CmFiTWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51U29ydE9yZGVyOwphYk1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51Q29sb3IgPyBsaW5rcy5hc2sudGFncy5hYkNvcmVNZW51Q29sb3IgOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oYWJNZW51QnV0dG9uKTsnAOj1ifQH0csBCWFiQm90Q2hhdAIEAOj1ifQHj+IC7ghAaWYgKCFsaW5rcy5hYkJvdCAmJiAhdGhhdC5ib3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYm90QmFzZSA9IHRoYXQuYm90ID8gdGhhdC5ib3Q6IGxpbmtzLmFiQm90Owpjb25zdCBkaW1lbnNpb24gPSAhdGhhdC5ib3QgPyBib3RCYXNlLnRhZ3MuZGltZW5zaW9uIDogdGhhdC5kaW1lbnNpb24gPyB0aGF0LmRpbWVuc2lvbiA6IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CmNvbnN0IG1lc3NhZ2UgPSB0aGF0Lm1lc3NhZ2U7CmNvbnN0IG1lc3NhZ2VUaW1lID0gdGhhdC50aW1lID8gdGhhdC50aW1lICogMTAwMCA6IDE2MDA7IAoKY29uc3QgbWVzc2FnZUJvdCA9IGF3YWl0IGxpbmtzLmJvdF9mYWN0b3J5LmFiQ3JlYXRlQmlsbGJvYXJkTGFiZWwoewogICAgYm90OiBib3RCYXNlLAogICAgbGFiZWw6IG1lc3NhZ2UsCiAgICBkaW1lbnNpb24sCiAgICBtZXNzYWdlVGltZSwKICAgIGNvbG9yOiAiIzAwMDAwMCIsCiAgICBsYWJlbENvbG9yOiAiI2ZmZmZmZiIsCiAgICBvbkJvdEFkZGVkOiBgQAogICAgICAgIGF3YWl0IG9zLnNsZWVwKHRhZ3MubWVzc2FnZVRpbWUpOwogICAgICAgIHRoaXNCb3Qub25GYWRlKCk7CiAgICBgLAogICAgb25GYWRlOiBgQAogICAgICAgIGFuaW1hdGVUYWcodGhpc0JvdCwgewogICAgICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgICAgIGZvcm1PcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgbGFiZWxPcGFjaXR5OiAxLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uICsgIloiXTogdGFnc1t0YWdzLmRpbWVuc2lvbiArICJaIl0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9WYWx1ZTogewogICAgICAgICAgICAgICAgZm9ybU9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDAsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAiWiJdOiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgIloiXSArIDUKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246ICR7dGhhdC5kdXJhdGlvbiA/PyAzfQogICAgICAgIH0pCiAgICAgICAgLmNhdGNoKChlKSA9PiB7fSkKICAgICAgICAuZmluYWxseSgoKSA9PiB7CiAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgfSkKCiAgICBgLAp9KTsnAOj1ifQH0csBCWFiVmVyc2lvbgIEAOj1ifQH/uoCBTEwLjM1JwDo9Yn0B9HLAQlhbmltYXRpb24CBADo9Yn0B4TrAijwn5SXYjI2ZTEwODktMTcyZC00NWE5LThkMjItMDVjM2Y1OGMyYmY3JwDo9Yn0B9HLAQ9vbkFueUJvdENsaWNrZWQCBADo9Yn0B6vrAukHQGlmICghbGlua3MucmVtZW1iZXIudGFncy5hYlJpZ2h0Q2xpY2tEaXNhYmxlZCAmJiAhdGhhdC5ib3QudGFncy5hYlJpZ2h0Q2xpY2tJZ25vcmUgJiYgdGhhdC5tb2RhbGl0eSA9PSAibW91c2UiICYmIHRoYXQuYnV0dG9uSWQgPT0gInJpZ2h0IikgewogICAgaWYgKCF0YWdzLmFiQXdha2UpIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gYWIgc2VsZWN0ZWQKICAgIGlmICh0aGF0LmJvdCA9PSBsaW5rcy5hYkJvdCkgewogICAgICAgIGxpbmtzLm1lbnUuYWJFbnZpcm9ubWVudE1lbnUoKTsKICAgICAgICByZXR1cm47CiAgICB9ICAgIAogICAgCiAgICBjb25zdCBhcm1Cb3QgPSBhYi5saW5rcy5hcm1fdG9vbC5hYkNyZWF0ZUFybSh7CiAgICAgICAgb3JpZ2luQm90OiBsaW5rcy5hYkJvdCwKICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLAogICAgICAgIHBvc2l0aW9uOiB0aGF0LnBvc2l0aW9uLAogICAgfSkKCiAgICBjb25zdCBib3RQb3NpdGlvbiA9IGdldEJvdFBvc2l0aW9uKHRoYXQuYm90LCB0aGF0LmRpbWVuc2lvbik7CgogICAgLy8gRmFrZSB1c2VyIGRyb3BwaW5nIHRoZSBzZWxlY3RpbmcgdGhlIGJvdCB3aXRoIHRoZSBhcm0uCiAgICBhcm1Cb3Qub25Ecm9wKHsKICAgICAgICBib3Q6IGFybUJvdCwKICAgICAgICB0bzogewogICAgICAgICAgICBib3Q6IHRoYXQuYm90LAogICAgICAgICAgICB4OiBib3RQb3NpdGlvbi54LAogICAgICAgICAgICB5OiBib3RQb3NpdGlvbi55LAogICAgICAgICAgICB6OiBib3RQb3NpdGlvbi56LAogICAgICAgICAgICBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uCiAgICAgICAgfSwKICAgICAgICBmcm9tOiB7CiAgICAgICAgICAgIHg6IGJvdFBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IGJvdFBvc2l0aW9uLnksCiAgICAgICAgICAgIHo6IGJvdFBvc2l0aW9uLnosCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9CiAgICB9KTsKCiAgICByZXR1cm47Cn0nAOj1ifQH0csBBWlucHV0AgQA6PWJ9AeV8wIo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcA6PWJ9AfRywELcGVyc29uYWxpdHkCBADo9Yn0B7zzAijwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDo9Yn0B9HLAQ1hYlBlcnNvbmFsaXR5AgQA6PWJ9Afj8wIEdHJ1ZScA6PWJ9AfRywEKYWJTZXRBd2FrZQIEAOj1ifQH6PMCkxBAbGV0IGF3YWtlID0gdGhhdD8uYXdha2U7CmxldCBpbml0aWFsID0gdGhhdD8uaW5pdGlhbCA/PyBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmFzc2VydCh0eXBlb2YgYXdha2UgPT09ICdib29sZWFuJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhd2FrZSBpcyBhIHJlcXVpcmVkIGJvb2xlYW4gcGFyYW1ldGVyLmApOwoKaWYgKGNvbmZpZ0JvdC50YWdzLmFiU3RheUF3YWtlKSB7CiAgICAvLyBJZiBhYlN0YXlBd2FrZSBpcyBlbmFibGVkLCBvdmVycmlkZSB0aGUgaW5jb21pbmcgYXdha2UgcGFyYW1ldGVyIGFuZCBuZXZlciBsZXQgYWIgYmUgcHV0IHRvIHNsZWVwLgogICAgYXdha2UgPSB0cnVlOwp9CgppZiAodGFncy5hYkF3YWtlICE9PSBhd2FrZSkgewogICAgaWYgKGluaXRpYWwpIHsKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MucGF0dGVybikgewogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSB1dWlkKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFBsYXkgaW5pdGlhbCBhbmltYXRpb24gaWYgb25lIGlzIGRlZmluZWQgb24gYWJDb25maWcuCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsQW5pbWF0aW9uKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmFuaW1hdGlvbltsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbEFuaW1hdGlvbl0oKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU2hvdyBpbml0aWFsIG1lc3NhZ2UgaWYgb25lIGlzIGRlZmluZWQgb24gYWJDb25maWcuCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZSkgewogICAgICAgICAgICBzaG91dCgic2hvd0NvbnNvbGUiKTsKCiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlW2ldKTsKCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFVwZGF0ZSBhYkF3YWtlIHNoYXJlZCB0YWcgbWFzay4KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2FiQXdha2UnLCBhd2FrZSwgJ3NoYXJlZCcpOwogICAgCiAgICBpZiAoYXdha2UpIHsKICAgICAgICBsZXQgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsIDogY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbDsKCiAgICAgICAgaWYgKCFkaW1lbnNpb24pIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgdGhpc0JvdC5hYk1hbmlmZXN0Qm90KHsgZGltZW5zaW9uLCBwb3NpdGlvbjogeyB4OiAwLCB5OiAwIH0gfSk7CgogICAgICAgIHNob3V0KCJvbkFCQXdha2UiLCB7IGRpbWVuc2lvbiwgcG9zaXRpb246IHsgeDogMCwgeTogMCB9IH0pOwogICAgfSBlbHNlIHsKICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKCiAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICBzaG91dCgib25BQlNsZWVwIik7CiAgICB9Cn0nAOj1ifQH0csBBXV0aWxzAgQA6PWJ9Af8gwMo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycA6PWJ9AfRywELYm90X2ZhY3RvcnkCBADo9Yn0B6OEAyjwn5SXYzc4YWE2NjMtZDA1Yy00ZWM0LWJjMmMtMjZmZDUxNTYwYjk3JwDo9Yn0B9HLAQ9vbkFCSW5pdGlhbGl6ZWQCBADo9Yn0B8qEA31AaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkgew0KICAgIHRoaXNCb3Qub25Qb3J0YWxDaGFuZ2VkKHtwb3J0YWw6ICJtYXBQb3J0YWwiLCBkaW1lbnNpb246IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbH0pOw0KfScA6PWJ9AfRywEFZGVidWcCBADo9Yn0B8iFAwVmYWxzZScA6PWJ9AfRywEQb25BQkJlZm9yZVVwZGF0ZQIEAOj1ifQHzoUDNkBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gdGFncy5hYkF3YWtlOycA6PWJ9AfRywELb25BQlVwZGF0ZWQCBADo9Yn0B4WGA48BQGlmIChjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlKSB7CiAgICBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gbnVsbDsKICAgIGF3YWl0IHRoaXNCb3QuYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlIH0pCn0A"}]}