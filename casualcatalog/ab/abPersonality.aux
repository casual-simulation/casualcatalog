{"version":2,"updates":[{"id":0,"timestamp":1772044448843,"update":"AdoB0b3gBAAnAQRib3RzJDE2NTU0YmMxLWU5M2UtNGEwYi04Y2QzLWRmZDc3MjMxOTY3MgEnANG94AQACWFiVmVyc2lvbgIEANG94AQBBTEwLjQzJwDRveAEAAZzeXN0ZW0CBADRveAEBxZhYi5wZXJzb25hbGl0eS52ZXJzaW9uJwDRveAEABlhYlBlcnNvbmFsaXR5TWFqb3JWZXJzaW9uAgQA0b3gBB4BMycA0b3gBAANb25Ta2lsbFVwZGF0ZQIEANG94AQgrQFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJQZXJzb25hbGl0eU1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJQZXJzb25hbGl0eU1pbm9yVmVyc2lvbjsKCmNvbnNvbGUubG9nKCJbQUJQZXJzb25hbGl0eV0gTG9hZGVkIEFCIFBlcnNvbmFsaXR5IHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycA0b3gBAANYWJQZXJzb25hbGl0eQIEANG94ATOAQR0cnVlJwDRveAEAAhhYklnbm9yZQIEANG94ATTAQR0cnVlJwDRveAEAARmb3JtAgQA0b3gBNgBB25vdGhpbmcnANG94AQAGWFiUGVyc29uYWxpdHlNaW5vclZlcnNpb24CBADRveAE4AECMTQnAQRib3RzJDNjNzRjOWYxLTgyZGMtNDY1NS04YjM4LWU3ZjExZGU4OTc4ZQEnANG94ATjAQZzeXN0ZW0CBADRveAE5AEXYWIucGVyc29uYWxpdHkuYXJtX3Rvb2wnANG94ATjAQxvbkFueUJvdERyYWcCBADRveAE/AGNCEBjb25zdCBkcmFnQm90ID0gdGhhdC5ib3Q7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQuZnJvbS5kaW1lbnNpb247CgppZiAoZHJhZ0JvdC50YWdzLmFybVNlbGVjdGlvbikgewogICAgaWYgKGRyYWdCb3QubWFza3MuYXJtQm90KSB7CiAgICAgICAgaWYgKGRyYWdCb3QubGlua3MuYXJtQm90LnRhZ3MubXVsdGlTZWxlY3QgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMgJiYgZHJhZ0JvdC50YWdzLmFybUdyb3VwRHJhZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlbmFibGUgY3VzdG9tIGRyYWdnaW5nYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG9zLmVuYWJsZUN1c3RvbURyYWdnaW5nKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95IHByZXZpb3VzIGFybUJvdDogJHtkcmFnQm90Lm1hc2tzLmFybUJvdH1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveShkcmFnQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3MuYXJtQm90ID0gbnVsbDsKICAgICAgICB9CiAgICB9CgogICAgY29uc3QgbXVsdGlTZWxlY3RLZXlIZWxkID0gb3MuZ2V0SW5wdXRTdGF0ZSgna2V5Ym9hcmQnLCAnU2hpZnQnKTsKICAgIGNvbnN0IG11bHRpU2VsZWN0QWxsb3dlZCA9IGRyYWdCb3QudGFncy5hcm1NdWx0aVNlbGVjdCA/PyB0cnVlOwoKICAgIGNvbnN0IGFybUJvdCA9IHRoaXNCb3QuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogZHJhZ0JvdCwKICAgICAgICBkaW1lbnNpb24sCiAgICAgICAgbXVsdGlTZWxlY3Q6IG11bHRpU2VsZWN0S2V5SGVsZCAmJiBtdWx0aVNlbGVjdEFsbG93ZWQsCiAgICB9KQoKICAgIG9zLnJlcGxhY2VEcmFnQm90KGFybUJvdCk7Cn0KJwDRveAE4wEFZGVidWcCBADRveAEigoFZmFsc2UnANG94ATjAQlsaXN0ZW5pbmcCBADRveAEkAoEdHJ1ZScA0b3gBOMBC2FiQ3JlYXRlQXJtAgQA0b3gBJUK9U1AY29uc3Qgb3JpZ2luQm90ID0gdGhhdC5vcmlnaW5Cb3Q7CmFzc2VydChhYi5saW5rcy51dGlscy5pc0JvdChvcmlnaW5Cb3QpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbkJvdCBpcyBhIHJlcXVpcmVkIEJvdCBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBkaW1lbnNpb24gPSB0aGF0LmRpbWVuc2lvbjsKYXNzZXJ0KHR5cGVvZiBkaW1lbnNpb24gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRpbWVuc2lvbiBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBwb3NpdGlvbiA9IHRoYXQucG9zaXRpb24gPz8gZ2V0Qm90UG9zaXRpb24ob3JpZ2luQm90LCBkaW1lbnNpb24pOwpjb25zdCBtdWx0aVNlbGVjdCA9IHRoYXQubXVsdGlTZWxlY3QgPz8gZmFsc2U7CmNvbnN0IGFybUNvbG9yID0gdGhhdC5hcm1Db2xvciA/PyBvcmlnaW5Cb3QudGFncy5hcm1Db2xvciA/PyBvcmlnaW5Cb3QudGFncy5zdHJva2VDb2xvciA/PyBvcmlnaW5Cb3QudGFncy5jb2xvcjsKY29uc3QgYXJtTWVzaFBhdGggPSB0aGF0LmFybU1lc2hQYXRoID8/IG9yaWdpbkJvdC50YWdzLmFybU1lc2hQYXRoOwpjb25zdCBhcm1Ecm9wU291bmQgPSB0aGF0LmFybURyb3BTb3VuZCA/PyBvcmlnaW5Cb3QudGFncy5hcm1Ecm9wU291bmQ7CmNvbnN0IGFybVRlbGVwb3J0U291bmQgPSB0aGF0LmFybVRlbGVwb3J0U291bmQgPz8gb3JpZ2luQm90LnRhZ3MuYXJtVGVsZXBvcnRTb3VuZDsKCmNvbnN0IGFybSA9IHsKICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIFtkaW1lbnNpb24gKyAnWiddOiBwb3NpdGlvbi56LAogICAgY3JlYXRvcjogb3JpZ2luQm90LmlkLAogICAgaXNBcm1Cb3Q6IHRydWUsCiAgICBwb2ludGFibGU6IHRydWUsCiAgICBtdWx0aVNlbGVjdCwKICAgIGRlYnVnOiB0YWdzLmRlYnVnLAogICAgb3JpZ2luQm90OiBnZXRMaW5rKG9yaWdpbkJvdCksCiAgICBkaW1lbnNpb24sCiAgICBhcm1Db2xvciwKICAgIGFybU1lc2hQYXRoLAogICAgYXJtRHJvcFNvdW5kLAogICAgYXJtVGVsZXBvcnRTb3VuZCwKICAgIGRlZmF1bHRBcm1Ecm9wU291bmQ6IHRhZ3MuZGVmYXVsdEFybURyb3BTb3VuZCwKICAgIGRlZmF1bHRBcm1UZWxlcG9ydFNvdW5kOiB0YWdzLmRlZmF1bHRBcm1UZWxlcG9ydFNvdW5kLAogICAgbGluZUNvbG9yOiBhcm1Db2xvciwKICAgIGxpbmVUbzogb3JpZ2luQm90LmlkLAogICAgb25DcmVhdGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNyZWF0ZWQgYXJtQm90ICR7dGhpc0JvdC5pZH1gKTsKICAgICAgICB9CiAgICAgICAgLy8gRGVzdHJveSBwcmV2aW91cyBhcm0gaWYgaXQgaXMgc3RpbGwgYXJvdW5kLgogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtQm90KSB7CiAgICAgICAgICAgIGRlc3Ryb3kobGlua3Mub3JpZ2luQm90LmxpbmtzLmFybUJvdCk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9IGBhcm0uJHt0aGlzQm90LmlkLnN1YnN0cmluZygwLCA1KX1gOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1Cb3QgPSBnZXRMaW5rKHRoaXNCb3QpOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5kcmFnZ2FibGUgPSB0YWdzLm11bHRpU2VsZWN0OwoKICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aCAmJiAhdGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aC5zdGFydHNXaXRoKCdodHRwczovLycpKSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gdGFncy5hcm1NZXNoUGF0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSBhYi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTCh0YWdzLmFybU1lc2hQYXRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGFncy5mb3JtID0gJ21lc2gnOwogICAgICAgICAgICB0YWdzLmZvcm1TdWJ0eXBlID0gJ2dsdGYnOwogICAgICAgICAgICB0YWdzLmFuY2hvclBvaW50ID0gJ2NlbnRlcic7CiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgICAgICB0YWdzLnNjYWxlID0gMC45OTk5OyAvLyBUaGVyZSBpcyBhIHJlYWxseSBzdHJhbmdlIGJ1ZyB0aGF0IGlmIHRoaXMgaXMgbGVmdCB1bmRlZmluZWQgb3Igc2V0IHRvIDEgZXhhY3RseSwgdGhlIGFybSB3aWxsIHNvbWV0aW1lcyBkaXNhcHBlYXIuCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGFncy5zdHJva2VDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CiAgICAgICAgICAgIHRhZ3MuZm9ybSA9ICdjdWJlJzsKICAgICAgICAgICAgdGFncy5jb2xvciA9ICdjbGVhcic7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAwLjk7CiAgICAgICAgICAgIHRhZ3Muc2NhbGVaID0gMC4wMTsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm0gPSAnc3BoZXJlJzsKICAgICAgICAgICAgICAgIHRhZ3MuY29sb3IgPSB0YWdzLmFybUNvbG9yOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBNYWtlIHRoZSBvcmlnaW4gYm90IHVuc2VsZWN0YWJsZSBmb3IgMS80IG9mIGEgc2Vjb25kLgogICAgICAgIC8vIFRoaXMgaGVscHMgcHJldmVudCB1bmludGVudGlvbmFsIHNlbGYtc2VsZWN0aW9uIG9mIHRoZSBvcmlnaW4gYm90LgogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5wb2ludGFibGUgPSBmYWxzZTsKICAgICAgICBvcy5zbGVlcCgyNTApLnRoZW4oKCkgPT4gewogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MucG9pbnRhYmxlID0gbnVsbDsKICAgICAgICB9KQoKICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CgogICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1DcmVhdGUnKTsKICAgIH0pLAogICAgc2V0QXJtVmlzaWJsZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxldCB2aXNpYmxlID0gdGhhdDsKCiAgICAgICAgaWYgKHZpc2libGUpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuYXJtTWVzaFBhdGgpIHsKICAgICAgICAgICAgICAgIG1hc2tzLmZvcm1PcGFjaXR5ID0gbnVsbDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG1hc2tzLnN0cm9rZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWFza3MubGluZUNvbG9yID0gbnVsbDsKICAgICAgICAgICAgbWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LmlkOyAKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBtYXNrcy5jb2xvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5hcm1NZXNoUGF0aCkgewogICAgICAgICAgICAgICAgbWFza3MuZm9ybU9wYWNpdHkgPSAwOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbWFza3Muc3Ryb2tlQ29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5saW5lQ29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICBtYXNrcy5saW5lVG8gPSBmYWxzZTsKICAgICAgICAgICAgbWFza3MucG9pbnRhYmxlID0gZmFsc2U7CgogICAgICAgICAgICBpZiAodGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICAgICAgbWFza3MuY29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSksCiAgICBvbkNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3QgeyBkaW1lbnNpb24gfSA9IHRoYXQ7CgogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3Q/LnRhZ3MuYXJtVGVsZXBvcnQgPz8gdHJ1ZSkgewogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QudGFnc1tkaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1gnXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1gnXTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1knXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1knXTsKICAgICAgICAgICAgbGlua3Mub3JpZ2luQm90LnRhZ3NbZGltZW5zaW9uICsgJ1onXSA9IHRhZ3NbZGltZW5zaW9uICsgJ1onXTsKCiAgICAgICAgICAgIGFiLmxpbmtzLnNvdW5kLmFiUGxheVNvdW5kKHsgdmFsdWU6IHRhZ3MuYXJtVGVsZXBvcnRTb3VuZCwgZGVmYXVsdFZhbHVlOiB0YWdzLmRlZmF1bHRBcm1UZWxlcG9ydFNvdW5kIH0pOwogICAgICAgIH0KCiAgICAgICAgd2hpc3BlcihsaW5rcy5vcmlnaW5Cb3QsICdvbkFybUNsaWNrJywgeyBkaW1lbnNpb24gfSk7CgogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICB9KSwKICAgIG9uRHJvcEVudGVyOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQuZHJhZ0JvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwogICAgICAgIGlmICghbGlua3Mub3JpZ2luQm90KSByZXR1cm47CgogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwogICAgICAgIH0KCiAgICAgICAgbGlua3Mub3JpZ2luQm90Lm1hc2tzLmxpbmVDb2xvciA9IHRhZ3MuYXJtQ29sb3I7CgogICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgIGxldCBsaW5lVG9Cb3RzID0gbGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbzsKCiAgICAgICAgICAgIGlmIChsaW5lVG9Cb3RzID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKGRyb3BCb3QpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGluZVRvQm90cyA9IEFycmF5LmlzQXJyYXkobGluZVRvQm90cykgPyBsaW5lVG9Cb3RzIDogW2xpbmVUb0JvdHNdOwoKICAgICAgICAgICAgICAgIGlmICghbGluZVRvQm90cy5pbmNsdWRlcyhkcm9wQm90KSkgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBnZXRMaW5rKC4uLmxpbmVUb0JvdHMsIGRyb3BCb3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGhpZGUgYXJtYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBkcm9wQm90LmlkOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hvdyBzZWxlY3Rpb24gb24gb3JpZ2luIGJvdC5gKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pLAogICAgb25Ecm9wRXhpdDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmRyYWdCb3QgIT09IHRoaXNCb3QpIHJldHVybjsKICAgICAgICBpZiAoIWxpbmtzLm9yaWdpbkJvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBjb25zdCBkcm9wQm90ID0gdGhhdC50by5ib3Q7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJvcEJvdDpgLCBkcm9wQm90KTsKICAgICAgICB9CgogICAgICAgIGlmICghdGFncy5tdWx0aVNlbGVjdCkgewogICAgICAgICAgICB0aGlzQm90LnNldEFybVZpc2libGUodHJ1ZSk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaG93IGFybWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbnVsbDsKCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNob3cgc2VsZWN0aW9uIG9uIG9yaWdpbiBib3QuYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJvcDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmJvdCAhPT0gdGhpc0JvdCkgcmV0dXJuOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGNvbnN0IGRyb3BCb3QgPSB0aGF0LnRvLmJvdDsKCiAgICAgICAgYWIubGlua3Muc291bmQuYWJQbGF5U291bmQoeyB2YWx1ZTogdGFncy5hcm1Ecm9wU291bmQsIGRlZmF1bHRWYWx1ZTogdGFncy5kZWZhdWx0QXJtRHJvcFNvdW5kIH0pOwogICAgICAgIAogICAgICAgIGlmICh0YWdzLm11bHRpU2VsZWN0ICYmIGxpbmtzLm9yaWdpbkJvdC5saW5rcy5saW5lVG8pIHsKICAgICAgICAgICAgdGhpc0JvdC5zZXRBcm1WaXNpYmxlKGZhbHNlKTsKICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5TZXRTZWxlY3Rpb24obGlua3Mub3JpZ2luQm90LmxpbmtzLmxpbmVUbyk7CiAgICAgICAgfSBlbHNlIGlmIChkcm9wQm90KSB7CiAgICAgICAgICAgIHRoaXNCb3Quc2V0QXJtVmlzaWJsZShmYWxzZSk7CiAgICAgICAgICAgIHRoaXNCb3Qub3JpZ2luU2V0U2VsZWN0aW9uKGRyb3BCb3QpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIERyb3BwZWQgb24gZ3JpZC4KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJvcHBlZCBvbiBncmlkLmApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtUGxhY2VkJywgeyBkaW1lbnNpb246IHRoYXQudG8uZGltZW5zaW9uLCB4OiB0aGF0LnRvLngsIHk6IHRoYXQudG8ueSwgejogdGhhdC50by56IH0pOwogICAgICAgIH0KICAgICAgICAKICAgIH0pLAogICAgb25HcmlkQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICB0aGlzQm90Lm9yaWdpbkNsZWFyU2VsZWN0aW9uKCk7CiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIH0pLAogICAgb3JpZ2luQ2xlYXJTZWxlY3Rpb246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1TZWxlY3RlZEJvdHMgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lQ29sb3IgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwogICAgfSksCiAgICBvcmlnaW5TZXRTZWxlY3Rpb246IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCBzZWxlY3RlZEJvdHMgPSB0aGF0OwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtU2VsZWN0ZWRCb3RzID0gc2VsZWN0ZWRCb3RzID8gZ2V0TGluayhzZWxlY3RlZEJvdHMpIDogbnVsbDsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZUNvbG9yID0gdGFncy5hcm1Db2xvcjsKICAgICAgICBsaW5rcy5vcmlnaW5Cb3QubWFza3MubGluZVRvID0gbGlua3Mub3JpZ2luQm90LnRhZ3MuYXJtU2VsZWN0ZWRCb3RzOwogICAgICAgIAogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgIHdoaXNwZXIobGlua3Mub3JpZ2luQm90LCAnb25Bcm1TZWxlY3RlZEJvdHMnLCBsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzKQogICAgICAgIH0KICAgIH0pLAogICAgb25BbnlCb3RzUmVtb3ZlZDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmIChsaW5rcy5vcmlnaW5Cb3QubWFza3MuYXJtU2VsZWN0ZWRCb3RzKSB7CiAgICAgICAgICAgIC8vIENoZWNrIHRoYXQgd2Ugc3RpbGwgaGF2ZSBzb21lIGFjdGl2ZSBzZWxlY3RlZCBib3RzLgogICAgICAgICAgICBsZXQgYWN0aXZlU2VsZWN0ZWRCb3RzID0gZmFsc2U7CgogICAgICAgICAgICBjb25zdCBhcm1TZWxlY3RlZEJvdHMgPSBsaW5rcy5vcmlnaW5Cb3QubGlua3MuYXJtU2VsZWN0ZWRCb3RzOwoKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJtU2VsZWN0ZWRCb3RzKSkgewogICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0ZWRCb3RzID0gYXJtU2VsZWN0ZWRCb3RzLmV2ZXJ5KGIgPT4gISFiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFjdGl2ZVNlbGVjdGVkQm90cyA9ICEhYXJtU2VsZWN0ZWRCb3RzOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWFjdGl2ZVNlbGVjdGVkQm90cykgewogICAgICAgICAgICAgICAgLy8gSWYgdGhlIGJvdHMgd2UgaGFkIHNlbGVjdGVkIG5vIGxvbmdlciBleGlzdCwgZGVzdHJveSB0aGlzIGFybS4KICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIHRoYXQgYXJtIGhhcyBzZWxlY3RlZCBubyBsb25nZXIgZXhpc3QsIGRlc3Ryb3kgdGhpcyBhcm0uYCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpc0JvdC5vcmlnaW5DbGVhclNlbGVjdGlvbigpOwogICAgICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIHRoYXQgYXJtIGhhcyBzZWxlY3RlZCBzdGlsbCBoYXMgYWN0aXZlIGJvdHMuYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uRGVzdHJveTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIGxpbmtzLm9yaWdpbkJvdC5tYXNrcy5kcmFnZ2FibGUgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7CiAgICAgICAgfQoKICAgICAgICB3aGlzcGVyKGxpbmtzLm9yaWdpbkJvdCwgJ29uQXJtRGVzdHJveScpOwogICAgfSksCn07Cgpjb25zdCBhcm1Cb3QgPSBjcmVhdGUoYXJtKTsKCnJldHVybiBhcm1Cb3Q7JwDRveAE4wEQb25BbnlCb3REcmFnZ2luZwIEANG94ASLWNEVQGNvbnN0IGRyYWdCb3QgPSB0aGF0LmJvdDsKY29uc3QgZGltZW5zaW9uID0gdGhhdC5mcm9tLmRpbWVuc2lvbjsKCmlmIChkcmFnQm90LmxpbmtzLmFybUJvdCkgewogICAgaWYgKGRyYWdCb3QudGFncy5hcm1Hcm91cERyYWcgJiYgZHJhZ0JvdC5saW5rcy5hcm1TZWxlY3RlZEJvdHMpIHsKICAgICAgICBsZXQgZHJhZ0Nvb3JkaW5hdG9yQm90ID0gbGlua3MuZHJhZ0Nvb3JkaW5hdG9yQm90OwogICAgICAgIAogICAgICAgIGlmICghZHJhZ0Nvb3JkaW5hdG9yQm90KSB7CiAgICAgICAgICAgIGNvbnN0IGRyYWdDb29yZGluYXRvck1vZCA9IHsKICAgICAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICAgICAgICAgICAgICBkaW1lbnNpb246IGRpbWVuc2lvbiwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgICAgICAgICAgICAgW2RpbWVuc2lvbiArICJYIl06IDAsCiAgICAgICAgICAgICAgICBbZGltZW5zaW9uICsgIlkiXTogMCwKICAgICAgICAgICAgICAgIFtkaW1lbnNpb24gKyAiWiJdOiAtMSwKICAgICAgICAgICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBkZWJ1ZzogdGFncy5kZWJ1ZywKICAgICAgICAgICAgICAgIGNvbG9yOiAiY2xlYXIiLAogICAgICAgICAgICAgICAgc3lzdGVtOiBgYXJtR3JvdXBEcmFnLiR7dGhpc0JvdC5pZC5zdWJzdHJpbmcoMCwgNSl9LmNvb3JkaW5hdG9yYCwKICAgICAgICAgICAgICAgIG9uQW55Qm90UG9pbnRlclVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXN0cm95aW5nIGRyYWcgY29vcmRpbmF0b3JgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3MuZHJhZ0Nvb3JkaW5hdG9yQm90ID0gbnVsbDsgCiAgICAgICAgICAgICAgICAgICAgc2hvdXQoJ29uQXJtU3RvcEdyb3VwRHJhZycsIHsgeDogdGFnc1t0YWdzLmRpbWVuc2lvbiArICdYJ10sIHk6IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAnWSddIH0pOwogICAgICAgICAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGRyYWdDb29yZGluYXRvckJvdCA9IGNyZWF0ZShkcmFnQ29vcmRpbmF0b3JNb2QpOwoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3JlYXRlZCBkcmFnIGNvb3JkaW5hdG9yIGJvdDpgLCBkcmFnQ29vcmRpbmF0b3JCb3QpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBtYXNrcy5kcmFnQ29vcmRpbmF0b3JCb3QgPSBnZXRMaW5rKGRyYWdDb29yZGluYXRvckJvdCk7CgogICAgICAgICAgICBjb25zdCBhcm1TZWxlY3RlZEJvdHMgPSBkcmFnQm90LmxpbmtzLmFybVNlbGVjdGVkQm90czsKICAgICAgICAgICAgY29uc3Qgb25Bcm1TdG9wR3JvdXBEcmFnID0gYEAKICAgICAgICAgICAgICAgIG1hc2tzLnRyYW5zZm9ybWVyID0gbnVsbDsKICAgICAgICAgICAgICAgIG1hc2tzLm9uQXJtU3RvcEdyb3VwRHJhZyA9IG51bGw7CiAgICAgICAgICAgICAgICB0YWdzLiR7ZGltZW5zaW9ufVggPSB0YWdzLiR7ZGltZW5zaW9ufVggKyB0aGF0Lng7CiAgICAgICAgICAgICAgICB0YWdzLiR7ZGltZW5zaW9ufVkgPSB0YWdzLiR7ZGltZW5zaW9ufVkgKyB0aGF0Lnk7CiAgICAgICAgICAgIGAKCiAgICAgICAgICAgIGRyYWdCb3QubWFza3MudHJhbnNmb3JtZXIgPSBkcmFnQ29vcmRpbmF0b3JCb3QuaWQ7CiAgICAgICAgICAgIGRyYWdCb3QubWFza3Mub25Bcm1TdG9wR3JvdXBEcmFnID0gb25Bcm1TdG9wR3JvdXBEcmFnOwoKICAgICAgICAgICAgc2V0VGFnTWFzayhhcm1TZWxlY3RlZEJvdHMsICJ0cmFuc2Zvcm1lciIsIGRyYWdDb29yZGluYXRvckJvdC5pZCwgInRlbXBMb2NhbCIpOwogICAgICAgICAgICBzZXRUYWdNYXNrKGFybVNlbGVjdGVkQm90cywgIm9uQXJtU3RvcEdyb3VwRHJhZyIsIG9uQXJtU3RvcEdyb3VwRHJhZywgInRlbXBMb2NhbCIpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgeENoYW5nZSA9IHRoYXQudG8ueCAtIHRoYXQuZnJvbS54OwogICAgICAgIGNvbnN0IHlDaGFuZ2UgPSB0aGF0LnRvLnkgLSB0aGF0LmZyb20ueTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB4Q2hhbmdlOiAke3hDaGFuZ2V9LCB5Q2hhbmdlOiAke3lDaGFuZ2V9YCk7CiAgICAgICAgfQoKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWCJdID0geENoYW5nZTsKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWSJdID0geUNoYW5nZTsKICAgICAgICBkcmFnQ29vcmRpbmF0b3JCb3QudGFnc1tkaW1lbnNpb24gKyAiWiJdID0gLTE7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZHJhZyBib3Qgd2l0aCBhcm0gZG9lcyBub3QgcXVhbGlmeSBmb3IgZ3JvdXAgZHJhZ2dpbmcuYCk7CiAgICAgICAgfQogICAgfQp9JwDRveAE4wENYWJQZXJzb25hbGl0eQIEANG94ATdbQR0cnVlJwDRveAE4wEIYWJJZ25vcmUCBADRveAE4m0EdHJ1ZScA0b3gBOMBBGZvcm0CBADRveAE520Hbm90aGluZycA0b3gBOMBCWFiVmVyc2lvbgIEANG94ATvbQUxMC40MycA0b3gBOMBE2RlZmF1bHRBcm1Ecm9wU291bmQCBADRveAE9W0ZYWIvYXVkaW8vc2VsZWN0IGxldmVsLm1wMycA0b3gBOMBF2RlZmF1bHRBcm1UZWxlcG9ydFNvdW5kAgQA0b3gBI9uEmFiL2F1ZGlvL3dvb3NoLm1wMycBBGJvdHMkYjI2ZTEwODktMTcyZC00NWE5LThkMjItMDVjM2Y1OGMyYmY3AScA0b3gBKJuBnN5c3RlbQIEANG94ASjbhhhYi5wZXJzb25hbGl0eS5hbmltYXRpb24nANG94ASibgRmb3JtAgQA0b3gBLxuB25vdGhpbmcnANG94ASibghhYklnbm9yZQIEANG94ATEbgR0cnVlJwDRveAEom4NbWFuaWZlc3RhdGlvbgIEANG94ATJbijwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDRveAEom4IcmVtZW1iZXICBADRveAE8G4o8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA0b3gBKJuGGFuaW1hdGlvbl9hYkdyaWRNYW5pZmVzdAIEANG94ASXb/oOQHNob3V0KCJyZXNldCIpOwoKY29uc3QgcG9zaXRpb25YID0gdGhhdD8ucG9zaXRpb24ueCA/PyAwOwpjb25zdCBwb3NpdGlvblkgPSB0aGF0Py5wb3NpdGlvbi55ID8/IDA7CmNvbnN0IGRpbWVuc2lvbiA9IHRoYXQ/LmRpbWVuc2lvbiA/PyAiaG9tZSI7CmNvbnN0IGdyaWRTY2FsZSA9IHRoYXQ/LnNjYWxlID8/IDU7CmNvbnN0IG1vbWVudENvdW50ID0gMDsKY29uc3QgZ3JpZEJvdCA9IHt9OwoKZ3JpZEJvdC5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwpncmlkQm90LmNvbG9yID0gImNsZWFyIjsKZ3JpZEJvdC5zdHJva2VDb2xvciA9IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKZ3JpZEJvdC5zY2FsZSA9IDAuMDAxOwpncmlkQm90LnNjYWxlWiA9IDAuMTsKZ3JpZEJvdC5yZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKZ3JpZEJvdFtkaW1lbnNpb25dID0gdHJ1ZTsKZ3JpZEJvdC5wb2ludGFibGUgPSBmYWxzZTsKZ3JpZEJvdC5raWxsVGltZXIgPSAiQCBhd2FpdCBvcy5zbGVlcCg0MDApOyBkZXN0cm95KHRoaXNCb3QpOyI7CgpsZXQgcm91bmRCb3RzOwoKZm9yIChsZXQgaSA9IGdyaWRTY2FsZTsgaSA+IDA7IGktLSkKewogICAgY29uc3QgYm90Q291bnQgPSBpICogODsKCiAgICBsZXQgc2lkZUNvdW50ID0gMDsKICAgIGxldCBwaGFzZUZhY3RvciA9IDA7CgogICAgZm9yIChsZXQgaiA9IDA7IGogPCBib3RDb3VudDsgaisrKQogICAgewogICAgICAgIGlmIChwaGFzZUZhY3RvciA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKChpICsgcG9zaXRpb25YKSAqIC0xKSArIHNpZGVDb3VudDsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWSJdID0gaSArIHBvc2l0aW9uWTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAocGhhc2VGYWN0b3IgPT0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlgiXSA9IGkgKyBwb3NpdGlvblg7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9IChpICsgcG9zaXRpb25ZKSAtIHNpZGVDb3VudDsgIAogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChwaGFzZUZhY3RvciA9PSAyKQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKGkgKyBwb3NpdGlvblgpIC0gc2lkZUNvdW50OwogICAgICAgICAgICBncmlkQm90W2RpbWVuc2lvbiArICJZIl0gPSAoKGkgKyBwb3NpdGlvblkpICogLTEpIDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZ3JpZEJvdFtkaW1lbnNpb24gKyAiWCJdID0gKChpICsgcG9zaXRpb25YKSAqIC0xKSA7CiAgICAgICAgICAgIGdyaWRCb3RbZGltZW5zaW9uICsgIlkiXSA9ICgoaSArIHBvc2l0aW9uWSkgKiAtMSkgKyBzaWRlQ291bnQ7ICAKICAgICAgICB9CgogICAgICAgIGNvbnN0IG5ld0dyaWRCb3QgPSBhd2FpdCBjcmVhdGUoZ3JpZEJvdCk7CgogICAgICAgIGFuaW1hdGVUYWcobmV3R3JpZEJvdCwgInNjYWxlIiwgewogICAgICAgICAgICB0b1ZhbHVlOiAxLAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICJlbGFzdGljIiwKICAgICAgICAgICAgICAgIG1vZGU6ICJvdXQiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAwLjAxCiAgICAgICAgfSkuY2F0Y2goKCkgPT4ge30pOwoKICAgICAgICBuZXdHcmlkQm90LmtpbGxUaW1lcigpOwoKICAgICAgICBzaWRlQ291bnQrKzsKCiAgICAgICAgaWYgKHNpZGVDb3VudCA9PSBib3RDb3VudCAvIDQpCiAgICAgICAgewogICAgICAgICAgICBzaWRlQ291bnQgPSAwOwoKICAgICAgICAgICAgcGhhc2VGYWN0b3IrKzsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLnNsZWVwKDgpOwogICAgfQp9JwDRveAEom4JYWJWZXJzaW9uAgQA0b3gBJJ+BTEwLjQzJwDRveAEom4Gb25DaGF0AgQA0b3gBJh+VUAvLyBpZiAodGhhdC5tZXNzYWdlID09ICJAdGVzdCIpCi8vIHsKLy8gICAgIHRoaXNCb3QuYW5pbWF0aW9uX2FiR3JpZE1hbmlmZXN0KCk7Ci8vIH0nANG94ASibgtwZXJzb25hbGl0eQIEANG94ATufijwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDRveAEom4NYWJQZXJzb25hbGl0eQIEANG94ASVfwR0cnVlJwEEYm90cyRiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGIBJwDRveAEmn8Gc3lzdGVtAgQA0b3gBJt/FWFiLnBlcnNvbmFsaXR5LmNvbmZpZycA0b3gBJp/CGFiSWdub3JlAgQA0b3gBLF/BHRydWUnANG94ASafwRmb3JtAgQA0b3gBLZ/B25vdGhpbmcnANG94ASafwthYkJhc2VDb2xvcgIEANG94AS+fwcjMDBEOUNEJwDRveAEmn8RYWJCYXNlU3Ryb2tlQ29sb3ICBADRveAExn8HIzAwRDlDRCcA0b3gBJp/EGFiQmx1ZXByaW50Q29sb3ICBADRveAEzn8HIzAwODI3QicA0b3gBJp/CHJlbWVtYmVyAgQA0b3gBNZ/KPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnANG94ASafxFhYkJ1aWxkZXJJZGVudGl0eQIEANG94AT9fwpjYXN1YWwuYm90JwDRveAEmn8JYWJWZXJzaW9uAgQA0b3gBIiAAQUxMC40MycA0b3gBJp/D2FiQmFzZU1lbnVDb2xvcgIEANG94ASOgAEHIzAwRDlDRCcA0b3gBJp/DWFiUGVyc29uYWxpdHkCBADRveAEloABBHRydWUnANG94ASafw1vblNraWxsVXBkYXRlAgQA0b3gBJuAAR1AdGhpc0JvdC5hYlBlcnNvbmFsaXR5TG9hZCgpOycA0b3gBJp/EWFiQmFzZVNoYWRvd0NvbG9yAgQA0b3gBLmAAQVibGFjaycA0b3gBJp/EGFiQmFzZUxhYmVsQ29sb3ICBADRveAEv4ABBWJsYWNrJwDRveAEmn8KbWFwT3B0aW9ucwIEANG94ATFgAGeB/Cfp6xbDQogICAgew0KICAgICAgICAibmFtZSI6ICAic2F0ZWxsaXRlIiwNCiAgICAgICAgImlkIjogInNhdGVsbGl0ZSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImh5YnJpZCIsDQogICAgICAgICJpZCI6ICJoeWJyaWQiDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJvY2VhbnMiLA0KICAgICAgICAiaWQiOiAib2NlYW5zIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAib3BlbiBzdHJlZXQgbWFwIiwNCiAgICAgICAgImlkIjogIm9zbSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInRlcnJhaW4iLA0KICAgICAgICAiaWQiOiAidGVycmFpbiINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgImRhcmsgZ3JheSBjYW52YXMiLA0KICAgICAgICAiaWQiOiAiZGFyay1ncmF5Ig0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAiZ3JheSBjYW52YXMiLA0KICAgICAgICAiaWQiOiAiZ3JheSINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cyINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInN0cmVldHMgKGRhcmspIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtbmlnaHQtdmVjdG9yIg0KICAgIH0sDQogICAgew0KICAgICAgICAibmFtZSI6ICAic3RyZWV0cyAobmF2aWdhdGlvbikiLA0KICAgICAgICAiaWQiOiAic3RyZWV0cy1uYXZpZ2F0aW9uLXZlY3RvciINCiAgICB9LA0KICAgIHsNCiAgICAgICAgIm5hbWUiOiAgInRvcG9ncmFwaGljIiwNCiAgICAgICAgImlkIjogInRvcG8iDQogICAgfSwNCiAgICB7DQogICAgICAgICJuYW1lIjogICJzdHJlZXRzIChyZWxpZWYpIiwNCiAgICAgICAgImlkIjogInN0cmVldHMtcmVsaWVmLXZlY3RvciINCiAgICB9DQpdJwDRveAEmn8Uc2hvd0FCQmFzZW1hcE9wdGlvbnMCBADRveAE4ocBxAVAc2hvdXQoImNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnUiKTsNCg0Kc2hvdXQoImFiTWVudVJlZnJlc2giKTsNCmNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgPSAnYWJCYXNlbWFwT3B0aW9uc01lbnUnOw0KDQpmb3IgKGNvbnN0IG9wdGlvbiBvZiB0YWdzLm1hcE9wdGlvbnMpIHsNCiAgICBpZiAob3B0aW9uLmlkID09IG1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXApIHsNCiAgICAgICAgY29udGludWU7DQogICAgfQ0KICAgIGNvbnN0IG9wdGlvbk9iaiA9IA0KICAgIHsNCiAgICAgICAgYWJCYXNlbWFwT3B0aW9uc01lbnU6IHRydWUsDQogICAgICAgIGNsZWFyQUJCYXNlbWFwT3B0aW9uc01lbnU6IGBAZGVzdHJveSh0aGlzQm90KTtgLA0KICAgICAgICBtYXBJRDogb3B0aW9uLmlkLA0KICAgICAgICBsYWJlbDogb3B0aW9uLm5hbWUsDQogICAgICAgIG9uQ2xpY2s6IGBADQogICAgICAgICAgICBtYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwID0gdGFncy5tYXBJRDsNCiAgICAgICAgICAgIHNob3V0KCdhYlBlcnNvbmFsaXR5Q2hhbmdlJywgeyBhYk1hcFBvcnRhbEJhc2U6IHRhZ3MubWFwSUR9KTsgDQogICAgICAgICAgICBzaG91dCgiY2xlYXJBQkJhc2VtYXBPcHRpb25zTWVudSIpOw0KICAgICAgICBgDQogICAgfQ0KDQogICAgYWIubGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24ob3B0aW9uT2JqKTsNCn0nANG94ASafwtvbkdyaWRDbGljawIEANG94ASnjQEmQHNob3V0KCJjbGVhckFCQmFzZW1hcE9wdGlvbnNNZW51Iik7DQonANG94ASafwVkZWJ1ZwIEANG94ATOjQEFZmFsc2UnANG94ASafxNhYlBlcnNvbmFsaXR5Q2hhbmdlAgQA0b3gBNSNAcwGQGlmICghdGhhdCkgewogICAgcmV0dXJuOwp9Cgpjb25zdCBjaGFuZ2VkVGFncyA9IFtdOwoKZm9yIChjb25zdCBrZXkgaW4gdGhhdCkgewogICAgaWYgKHRhZ3MuYWJQZXJzb25hbGl0eVRhZ3MuaW5jbHVkZXMoa2V5KSkgewogICAgICAgIGlmIChtYXNrc1trZXldICE9PSB0aGF0W2tleV0pIHsKICAgICAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCBrZXksIHRoYXRba2V5XSwgJ2xvY2FsJyk7CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGFuZ2VkICcke2tleX0nIHRvOmAsIHNlbGYuc3RydWN0dXJlZENsb25lKHRoYXRba2V5XSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoIWNoYW5nZWRUYWdzLmluY2x1ZGVzKGtleSkpIHsKICAgICAgICAgICAgICAgIGNoYW5nZWRUYWdzLnB1c2goa2V5KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFnLnN5c3RlbX0uJHt0YWdOYW1lfV0gJyR7a2V5fScgaXMgbm90IGEgdmFsaWQgYWIgcGVyc29uYWxpdHkgdGFnLmApOwogICAgfQp9CgppZiAoY2hhbmdlZFRhZ3MubGVuZ3RoID4gMCkgewogICAgdGhpc0JvdC52YXJzLmhhc1Vuc2F2ZWRDaGFuZ2VzID0gdHJ1ZTsKICAgIHNob3V0KCdvbkFCUGVyc29uYWxpdHlDaGFuZ2VkJywgeyBib3Q6IHRoaXNCb3QsIHRhZ3M6IGNoYW5nZWRUYWdzIH0pOwoKICAgIGlmICh0YWdzLmF1dG9zYXZlKSB7CiAgICAgICAgdGhpc0JvdC5hYlBlcnNvbmFsaXR5U2F2ZSgpOwogICAgfQp9CicA0b3gBJp/EmFiUGVyc29uYWxpdHlSZXNldAIEANG94AShlAG/CEBpZiAodGhpc0JvdC52YXJzLnJlc2V0dGluZykgewogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMucmVzZXR0aW5nID0gdHJ1ZTsKCmlmICghYXV0aEJvdCkgewogICAgdHJ5IHsgCiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKICAgIH0gY2F0Y2ggewogICAgICAgIHRoaXNCb3QudmFycy5yZXNldHRpbmcgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICB9Cn0KCmlmICghbGlua3MucmVtZW1iZXIpIHsKICAgIHRoaXNCb3QudmFycy5yZXNldHRpbmcgPSBmYWxzZTsKICAgIHJldHVybjsKfQoKLy8gQ2xlYXIgYW55IGxvYWRlZCB0YWdzLgpjbGVhclRhZ01hc2tzKHRoaXNCb3QsICdsb2NhbCcpOwoKaWYgKGF1dGhCb3QpIHsKICAgIC8vIFNhdmUgYW4gZW1wdHkgb2JqZWN0IHRvIHRoZSB1c2VyJ3MgcmVjb3JkLgogICAgbGV0IHJlY29yZFJlc3BvbnNlID0gYXdhaXQgb3MucmVjb3JkRGF0YShhdXRoQm90LmlkLCAnYWJQZXJzb25hbGl0eUNvbmZpZycsIHt9KTsKCiAgICBpZiAoIXJlY29yZFJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAocmVjb3JkUmVzcG9uc2UuZXJyb3JDb2RlID09PSAnbm90X2F1dGhvcml6ZWQnKSB7CiAgICAgICAgICAgIC8vIEFzayB1c2VyIHRvIGdyYW50IHBlcm1pc3Npb247CiAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb24gPSBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oYXV0aEJvdC5pZCk7CgogICAgICAgICAgICBpZiAocGVybWlzc2lvbi5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICByZWNvcmRSZXNwb25zZSA9IGF3YWl0IG9zLnJlY29yZERhdGEoYXV0aEJvdC5pZCwgJ2FiUGVyc29uYWxpdHlDb25maWcnLCB7fSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vIFJlbG9hZCB0aGUgcGVyc29uYWxpdHkuIFdpdGggdGhlIHVzZXIgcGVyc29uYWxpdHkgZXJhc2VkLCB0aGlzIHdpbGwgZWZmZWN0aXZlbHkgbG9hZCBhbGwgdGhlIGRlZmF1bHRzIGZyb20gYWJDb25maWcuCmF3YWl0IHRoaXNCb3QuYWJQZXJzb25hbGl0eUxvYWQoKTsKCnRoaXNCb3QudmFycy5yZXNldHRpbmcgPSBmYWxzZTsnANG94ASafxFhYlBlcnNvbmFsaXR5U2F2ZQIEANG94AThnAGFC0BpZiAodGhpc0JvdC52YXJzLnNhdmluZykgewogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMuc2F2aW5nID0gdHJ1ZTsKCmlmICghYXV0aEJvdCkgewogICAgdHJ5IHsgCiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKICAgIH0gY2F0Y2ggewogICAgICAgIHRoaXNCb3QudmFycy5zYXZpbmcgPSBmYWxzZTsKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vIFNhdmUgYWxsIHRoZSBjdXJyZW50IGFiIHBlcnNvbmFsaXR5IHRhZ3MgdG8gdGhlIHVzZXIncyByZWNvcmQuCmNvbnN0IHVzZXJQZXJzb25hbGl0eSA9IHt9OwoKZm9yIChjb25zdCB0YWdOYW1lIG9mIHRhZ3MuYWJQZXJzb25hbGl0eVRhZ3MpIHsKICAgIGlmICh0YWdzW3RhZ05hbWVdICE9IG51bGwpIHsKICAgICAgICB1c2VyUGVyc29uYWxpdHlbdGFnTmFtZV0gPSB0YWdzW3RhZ05hbWVdOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzYXZpbmcgdXNlciBwZXJzb25hbGl0eTpgLCBzZWxmLnN0cnVjdHVyZWRDbG9uZSh1c2VyUGVyc29uYWxpdHkpKTsKfQoKbGV0IHJlY29yZFJlc3BvbnNlID0gYXdhaXQgb3MucmVjb3JkRGF0YShhdXRoQm90LmlkLCAnYWJQZXJzb25hbGl0eUNvbmZpZycsIHVzZXJQZXJzb25hbGl0eSk7CgppZiAoIXJlY29yZFJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgIGlmIChyZWNvcmRSZXNwb25zZS5lcnJvckNvZGUgPT09ICdub3RfYXV0aG9yaXplZCcpIHsKICAgICAgICAvLyBBc2sgdXNlciB0byBncmFudCBwZXJtaXNzaW9uOwogICAgICAgIGNvbnN0IHBlcm1pc3Npb24gPSBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oYXV0aEJvdC5pZCk7CgogICAgICAgIGlmIChwZXJtaXNzaW9uLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgcmVjb3JkUmVzcG9uc2UgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGF1dGhCb3QuaWQsICdhYlBlcnNvbmFsaXR5Q29uZmlnJywgdXNlclBlcnNvbmFsaXR5KTsKICAgICAgICB9CiAgICB9Cn0KCmlmIChyZWNvcmRSZXNwb25zZS5zdWNjZXNzKSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGB1cGRhdGVkIHBlcnNvbmFsaXR5IGNvbmZpZyBpbiB1c2VyIHJlY29yZGAsIGxvZ1R5cGU6ICdsb2cnfSk7Cn0gZWxzZSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmYWlsZWQgdG8gdXBkYXRlIHBlcnNvbmFsaXR5IGNvbmZpZyBpbiB1c2VyIHJlY29yZC5cbiR7SlNPTi5zdHJpbmdpZnkocmVjb3JkUmVzcG9uc2UsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwp9Cgp0aGlzQm90LnZhcnMuc2F2aW5nID0gZmFsc2U7CnRoaXNCb3QudmFycy5oYXNVbnNhdmVkQ2hhbmdlcyA9IGZhbHNlOycA0b3gBJp/EWFiUGVyc29uYWxpdHlMb2FkAgQA0b3gBOenAc4gQGlmICh0aGlzQm90LnZhcnMubG9hZGluZykgewogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMubG9hZGluZyA9IHRydWU7CgppZiAoIWF1dGhCb3QpIHsKICAgIHRyeSB7IAogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CiAgICB9IGNhdGNoIHsKICAgICAgICB0aGlzQm90LnZhcnMubG9hZGluZyA9IGZhbHNlOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKaWYgKCFsaW5rcy5yZW1lbWJlcikgewogICAgdGhpc0JvdC52YXJzLmxvYWRpbmcgPSBmYWxzZTsKICAgIHJldHVybjsKfQoKLy8gUmV0cmlldmUgcGVyc29uYWxpdHkgY29uZmlnIGZyb20gdXNlcidzIHJlY29yZC4KbGV0IHVzZXJQZXJzb25hbGl0eURhdGEgPSB7fTsKCmlmIChhdXRoQm90KSB7CiAgICBjb25zdCBnZXREYXRhUmVzcG9uc2UgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICdhYlBlcnNvbmFsaXR5Q29uZmlnJyk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdldERhdGFSZXNwb25zZTpgLCBzZWxmLnN0cnVjdHVyZWRDbG9uZShnZXREYXRhUmVzcG9uc2UpKTsKICAgIH0KCiAgICBpZiAoZ2V0RGF0YVJlc3BvbnNlLnN1Y2Nlc3MpIHsKICAgICAgICB1c2VyUGVyc29uYWxpdHlEYXRhID0gZ2V0RGF0YVJlc3BvbnNlLmRhdGE7CiAgICB9IGVsc2UgewogICAgICAgIGlmIChnZXREYXRhUmVzcG9uc2UuZXJyb3JDb2RlICE9PSAnZGF0YV9ub3RfZm91bmQnKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYlBlcnNvbmFsaXR5Q29uZmlnIGdldCBlcnJvcjpgLCB7IGVycm9yQ29kZTogZ2V0RGF0YVJlc3BvbnNlLmVycm9yQ29kZSwgZXJyb3JNZXNzYWdlOiBnZXREYXRhUmVzcG9uc2UuZXJyb3JNZXNzYWdlIH0pOwogICAgICAgICAgICB0aGlzQm90LnZhcnMubG9hZGluZyA9IGZhbHNlOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQp9CgovLyBDbGVhciBhbnkgcHJldmlvdXNseSBsb2FkZWQgdGFncy4KY2xlYXJUYWdNYXNrcyh0aGlzQm90KTsKCi8vIFJ5YW4gKEF1ZyAyOSwgMjAyNSk6IGltIG5vdCBzdXJlIGV4YWN0bHkgd2hhdCBpcyBoYXBwZW5pbmcgaGVyZSBidXQgd2l0aG91dCBzbGVlcGluZyBvbiB0aGVzZSBiaWcgdGFnIG1hc2sgY2hhbmdlcywgdGhleSBkb250IGFsbCBzZWVtIHRvIGNvbWUgaW4gcHJvcGVybHkuCmF3YWl0IG9zLnNsZWVwKDEwMCk7CgovLyBMb2FkIHRhZ3MgZnJvbSBlaXRoZXIgdGhlIHVzZXIncyBwZXJzb25hbGl0eSBjb25maWcgKGlmIGF2YWlsYWJsZSkgb3IgbG9hZCBhIGRlZmF1bHQgZnJvbSB0aGUgYWJDb25maWcuCmZvciAoY29uc3QgdGFnTmFtZSBvZiB0YWdzLmFiUGVyc29uYWxpdHlUYWdzKSB7CiAgICBpZiAodXNlclBlcnNvbmFsaXR5RGF0YVt0YWdOYW1lXSAhPSBudWxsKSB7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCB0YWdOYW1lLCB1c2VyUGVyc29uYWxpdHlEYXRhW3RhZ05hbWVdLCAnbG9jYWwnKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb2FkZWQgJyR7dGFnTmFtZX0nIGZyb20gdXNlciBwZXJzb25hbGl0eSBkYXRhOmAsIHNlbGYuc3RydWN0dXJlZENsb25lKHVzZXJQZXJzb25hbGl0eURhdGFbdGFnTmFtZV0pKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3NbdGFnTmFtZV0gIT0gbnVsbCkgewogICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgdGFnTmFtZSwgbGlua3MucmVtZW1iZXIudGFnc1t0YWdOYW1lXSwgJ2xvY2FsJyk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9hZGVkICcke3RhZ05hbWV9JyBmcm9tIGFiIGNvbmZpZzpgLCBzZWxmLnN0cnVjdHVyZWRDbG9uZShsaW5rcy5yZW1lbWJlci50YWdzW3RhZ05hbWVdKSk7CiAgICAgICAgfQogICAgfQogICAgCiAgICBpZiAodGFnTmFtZSA9PT0gJ2FiQmFzZUdyaWRQb3J0YWxDb2xvcicpIHsKICAgICAgICBncmlkUG9ydGFsQm90LnRhZ3MucG9ydGFsQ29sb3IgPSB0YWdzLmFiQmFzZUdyaWRQb3J0YWxDb2xvcjsKICAgIH0gZWxzZSBpZiAodGFnTmFtZSA9PT0gJ2FiTWFwUG9ydGFsQmFzZScpIHsKICAgICAgICBtYXBQb3J0YWxCb3QudGFncy5tYXBQb3J0YWxCYXNlbWFwID0gdGFncy5hYk1hcFBvcnRhbEJhc2U7CiAgICAgICAgbWluaU1hcFBvcnRhbEJvdC50YWdzLm1hcFBvcnRhbEJhc2VtYXAgPSB0YWdzLmFiTWFwUG9ydGFsQmFzZTsKICAgIH0gZWxzZSBpZiAodGFnTmFtZSA9PT0gJ2FiUHJlZmVycmVkQUlNb2RlbCcpIHsKICAgICAgICAvLyBDaGVjayB0aGF0IHRoaXMgYWkgbW9kZWwgaXMgc3RpbGwgYXZhaWxhYmxlLgogICAgICAgIGNvbnN0IGRlc2lyZWRNb2RlbCA9IHRhZ3MuYWJQcmVmZXJyZWRBSU1vZGVsOwogICAgICAgIGNvbnN0IGFpQ2hhdE1vZGVscyA9IGNvbmZpZ0JvdC50YWdzLmFpQ2hhdE1vZGVscyA/PyAoYXdhaXQgYWkubGlzdENoYXRNb2RlbHMoKSk7CiAgICAgICAgbGV0IGZvdW5kID0gZGVzaXJlZE1vZGVsICYmIGFpQ2hhdE1vZGVscy5zb21lKGUgPT4gZS5uYW1lID09PSBkZXNpcmVkTW9kZWwpOwoKICAgICAgICBpZiAoIWZvdW5kKSB7CiAgICAgICAgICAgIC8vIFRoZSBhYlByZWZlcnJlZEFJTW9kZWwgaXMgbm90IGF2YWlsYWJsZS4gVHJ5IGZhbGxpbmcgYmFjayB0byBhYkNvbmZpZyBkZWZhdWx0LgogICAgICAgICAgICBmb3VuZCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJQcmVmZXJyZWRBSU1vZGVsICYmIGFpQ2hhdE1vZGVscy5zb21lKGUgPT4gZS5uYW1lID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUHJlZmVycmVkQUlNb2RlbCk7CiAgICAgICAgICAgIGlmIChmb3VuZCkgewogICAgICAgICAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnYWJQcmVmZXJyZWRBSU1vZGVsJywgbGlua3MucmVtZW1iZXIudGFncy5hYlByZWZlcnJlZEFJTW9kZWwsICdsb2NhbCcpOwoKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYlByZWZlcnJlZEFJTW9kZWwgJyR7ZGVzaXJlZE1vZGVsfScgaXMgbm90IGF2YWlsYWJsZSwgZmFsbGluZyBiYWNrIHRvIGFiQ29uZmlnIGRlZmF1bHQgJyR7bGlua3MucmVtZW1iZXIudGFncy5hYlByZWZlcnJlZEFJTW9kZWx9J2ApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gVGhlIGFiQ29uZmlnIGRlZmF1bHQgZm9yIGFiUHJlZmVycmVkQUlNb2RlbCBpcyBub3QgYXZhaWxhYmxlLiBGYWxsYmFjayB0byB0aGUgQ2FzdWFsT1MgZGVmYXVsdC4KICAgICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRNb2RlbCA9IGFpQ2hhdE1vZGVscy5maW5kKGUgPT4gZS5pc0RlZmF1bHQpLm5hbWU7CiAgICAgICAgICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdhYlByZWZlcnJlZEFJTW9kZWwnLCBkZWZhdWx0TW9kZWwsICdsb2NhbCcpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJQcmVmZXJyZWRBSU1vZGVsICcke2Rlc2lyZWRNb2RlbH0nIGlzIG5vdCBhdmFpbGFibGUsIGZhbGxpbmcgYmFjayB0byBDYXN1YWxPUyBkZWZhdWx0ICcke2RlZmF1bHRNb2RlbH0nYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfQogICAgfQp9CgovLyBSeWFuIChBdWcgMjksIDIwMjUpOiBpbSBub3Qgc3VyZSBleGFjdGx5IHdoYXQgaXMgaGFwcGVuaW5nIGhlcmUgYnV0IHdpdGhvdXQgc2xlZXBpbmcgb24gdGhlc2UgYmlnIHRhZyBtYXNrIGNoYW5nZXMsIHRoZXkgZG9udCBhbGwgc2VlbSB0byBjb21lIGluIHByb3Blcmx5Lgphd2FpdCBvcy5zbGVlcCgxMDApOwoKdGhpc0JvdC52YXJzLmxvYWRpbmcgPSBmYWxzZTsKc2hvdXQoJ29uQUJQZXJzb25hbGl0eUxvYWRlZCcsIHsgYm90OiB0aGlzQm90IH0pOycA0b3gBJp/EWFiUGVyc29uYWxpdHlUYWdzAgQA0b3gBLbIAcoC8J+nrFsKICAgICJhYkJhc2VDb2xvciIsCiAgICAiYWJCYXNlTGFiZWxDb2xvciIsCiAgICAiYWJCYXNlTWVudUNvbG9yIiwKICAgICJhYkJhc2VNZW51TGFiZWxDb2xvciIsCiAgICAiYWJCYXNlU2hhZG93Q29sb3IiLAogICAgImFiQmFzZVN0cm9rZUNvbG9yIiwKICAgICJhYkJsdWVwcmludENvbG9yIiwKICAgICJhYkJ1aWxkZXJJZGVudGl0eSIsCiAgICAiYWJCYXNlR3JpZFBvcnRhbENvbG9yIiwKICAgICJhYlByZWZlcnJlZEFJTW9kZWwiLAogICAgImFiQ2F0YWxvZ05hbWUiLAogICAgImFiTWFwUG9ydGFsQmFzZSIsCiAgICAiYWJBbHdheXNBcHByb3ZlUGF0Y2hCb3RzIgpdJwDRveAEmn8IYXV0b3NhdmUCBADRveAE/8oBBHRydWUnANG94ASafxhhYkFsd2F5c0FwcHJvdmVQYXRjaEJvdHMCBADRveAEhMsBBWZhbHNlJwEEYm90cyRiOWI4MjgxOS0xZjE0LTQzOTItODhhOS01MmY2N2E5ZjhlNTUBJwDRveAEissBBnN5c3RlbQIEANG94ASLywEYYWIucGVyc29uYWxpdHkuYXJtX251ZGdlJwDRveAEissBDW9uQUJBcm1QbGFjZWQCBADRveAEpMsBOEBzZXRUYWdNYXNrKHRoaXNCb3QsICdoYXNBcm1CZWVuUGxhY2VkJywgdHJ1ZSwgJ2xvY2FsJyk7JwDRveAEissBCW9uQUJBd2FrZQIEANG94ATdywEwQGF3YWl0IG9zLnNsZWVwKDI1MCk7CnRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwDRveAEissBCGFiSWdub3JlAgQA0b3gBI7MAQR0cnVlJwDRveAEissBDWFiUGVyc29uYWxpdHkCBADRveAEk8wBBHRydWUnANG94ASKywEEZm9ybQIEANG94ASYzAEHbm90aGluZycA0b3gBIrLAQVsZWFybgIEANG94ASgzAEo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA0b3gBIrLAQ1tYW5pZmVzdGF0aW9uAgQA0b3gBMfMASjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDRveAEissBCHJlbWVtYmVyAgQA0b3gBO7MASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDRveAEissBBWRlYnVnAgQA0b3gBJXNAQVmYWxzZScA0b3gBIrLAQ5hcm1OdWRnZVdhaXRNUwIEANG94ASbzQEENTAwMCcA0b3gBIrLAQ9vbkFCSW5pdGlhbGl6ZWQCBADRveAEoM0BG0B0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycA0b3gBIrLAQ9hYlN0YXJ0QXJtTnVkZ2UCBADRveAEvM0Bgh9AaWYgKHRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoZXJlIGlzIGFscmVhZHkgYSBudWRnZSBpbiBwcm9ncmVzcy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLm51ZGdlQWN0aXZlID0gdHJ1ZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXJ0aW5nIG51ZGdlLi4uYCkKfQoKZnVuY3Rpb24gY2FuTnVkZ2UoKTogYm9vbGVhbiB7CiAgICAvLyBDYW4ndCBoYXZlIHBsYWNlZCB0aGUgYXJtIGFscmVhZHkuCiAgICBpZiAodGFncy5oYXNBcm1CZWVuUGxhY2VkKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFybSBwbGFjZW1lbnQgaGFzIGFscmVhZHkgb2NjdXJlZC5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIEFCIG1hbmlmZXN0YXRpb24gYm90IG11c3QgYmUgYWN0aXZlLgogICAgaWYgKCFsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGFiIG1hbmlmZXN0YXRpb24gYm90IGlzIGluYWN0aXZlLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gQUIgY2hhdCBiYXIgbXVzdCBiZSBjbG9zZWQuCiAgICBpZiAobGlua3MuaW5wdXQubWFza3MuY2hhdE9wZW4pIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCBudWRnZTogYWIgY2hhdCBiYXIgaXMgb3Blbi5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIC8vIFRoZSBpbnN0IG11c3QgYmUgZW1wdHkgb2YgYWxsIGJvdHMuIFRoZSBleGNlcHRpb25zIGFyZSBhYiBib3RzIGFuZCBidWlsdC1pbiBib3RzLgogICAgY29uc3QgdXNlck1hZGVCb3QgPSBnZXRCb3QoKGIpID0+IHsKICAgICAgICByZXR1cm4gIWIudGFncy5zeXN0ZW0/LnN0YXJ0c1dpdGgoJ2FiLicpICYmCiAgICAgICAgICAgICAgICBiLnNwYWNlID09PSAnc2hhcmVkJyAmJgogICAgICAgICAgICAgICAgIWIudGFncy5hYkVnZyAmJiAvLyBEb24ndCBpbmNsdWRlIGFiRWdnIGJvdHMgYXMgInVzZXIgbWFkZSIuCiAgICAgICAgICAgICAgICAhYi50YWdzLmFiTG9hZGVkU2tpbGwgJiYgLy8gRG9uJ3QgaW5jbHVkZSBsb2FkZWQgc2tpbGwgYm90cyBhcyAidXNlciBtYWRlIi4KICAgICAgICAgICAgICAgICFiLnRhZ3MuYWJCb3QgLy8gRG9uJ3QgaW5jbHVkZSBhbnkgYm90cyB0aGF0IGFyZSBmbGFnZ2VkIHdpdGggYW4gYWJCb3QgdGFnLgogICAgfSkKICAgIAogICAgaWYgKHVzZXJNYWRlQm90KSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdVc2VyTWFkZUJvdHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJNYWRlQm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWIudGFncy5zeXN0ZW0/LnN0YXJ0c1dpdGgoJ2FiLicpICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiLnNwYWNlID09PSAnc2hhcmVkJyAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIWIudGFncy5hYkVnZyAvLyBEb24ndCBpbmNsdWRlIGFiRWdnIGJvdHMgYXMgInVzZXIgbWFkZSIuCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IGluc3QgY29udGFpbnMgdXNlciBtYWRlIGJvdHMuYCwgdXNlck1hZGVCb3RzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IG51ZGdlOiBpbnN0IGNvbnRhaW5zIHVzZXIgbWFkZSBib3RzLmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICAvLyBNZW51IHBvcnRhbCBtdXN0IGVpdGhlciBiZSBpbmFjdGl2ZSBvciBub3QgaGF2ZSBhbnkgYm90cyBpbiB0aGUgY3VycmVudGx5IGFjdGl2ZSBtZW51IHBvcnRhbC4KICAgIGlmIChjb25maWdCb3QudGFncy5tZW51UG9ydGFsKSB7CiAgICAgICAgY29uc3QgYm90SW5NZW51UG9ydGFsID0gZ2V0Qm90KChiKSA9PiB7CiAgICAgICAgICAgIHJldHVybiBiLnRhZ3NbY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbF0gPT09IHRydWUKICAgICAgICB9KTsKCiAgICAgICAgaWYgKGJvdEluTWVudVBvcnRhbCkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgbnVkZ2U6IG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IG9wZW4gYW5kIGhhcyBib3RzIGluIGl0LmApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cn0KCmlmIChjYW5OdWRnZSgpKSB7CiAgICAvLyBTdGFydCBudWRnZSBmb3IgYXJtIHBsYWNlbWVudC4KICAgIGF3YWl0IG9zLnNsZWVwKHRhZ3MuYXJtTnVkZ2VXYWl0TVMpOwoKICAgIGlmIChjYW5OdWRnZSgpKSB7CiAgICAgICAgY29uc3QgYWJQb3NpdGlvblggPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LnRhZ3NbbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiArICdYJ107CiAgICAgICAgY29uc3QgYWJQb3NpdGlvblkgPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LnRhZ3NbbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbiArICdZJ107CgogICAgICAgIGNvbnN0IGdyaWRDbGlja1BhcmFtcyA9IHsKICAgICAgICAgICAgZGltZW5zaW9uOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uLAogICAgICAgICAgICBwb3NpdGlvbjogeyB4OiBhYlBvc2l0aW9uWCArIDUsIHk6IGFiUG9zaXRpb25ZIH0sCiAgICAgICAgICAgIGZvcmNlQXJtUGxhY2VtZW50OiB0cnVlLAogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA9PT0gbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbikgewogICAgICAgICAgICAvLyBNYXAgcG9ydGFsIGlzIGluIGRpZmZlcmVudCBjb29yZGluYXRlIHNwYWNlIGFuZCBzY2FsZS4KICAgICAgICAgICAgZ3JpZENsaWNrUGFyYW1zLnBvc2l0aW9uLnggPSBhYlBvc2l0aW9uWCArIDAuMDAwMzU3NDM0MDY4NDA1MzgyMzsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2hpc3BlcmluZyBvbkdyaWRDbGljayB0byB0aGUgYWIgbWFuaWZlc3RhdGlvbiBib3Qgd2l0aCB0aGUgcGFyYW1zOmAsIGdyaWRDbGlja1BhcmFtcykKICAgICAgICB9CgogICAgICAgIC8vIEZvcmNlIGFiIGFybSBwbGFjZW1lbnQgdXNpbmcgdGhlIG9uR3JpZENsaWNrIGxpc3RlbmVyIG9mIHRoZSBtYW5pZmVzdGF0aW9uIGJvdC4KICAgICAgICB3aGlzcGVyKGxpbmtzLm1hbmlmZXN0YXRpb24sICdvbkdyaWRDbGljaycsIGdyaWRDbGlja1BhcmFtcyk7CiAgICB9Cn0KCnRoaXNCb3QudmFycy5udWRnZUFjdGl2ZSA9IGZhbHNlOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZG9uZWApOwp9JwDRveAEissBEG9uQUJDaGF0QmFyQ2xvc2UCBADRveAEv+wBG0B0aGlzQm90LmFiU3RhcnRBcm1OdWRnZSgpOycA0b3gBIrLAQVpbnB1dAIEANG94ATb7AEo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcA0b3gBIrLAQlhYlZlcnNpb24CBADRveAEgu0BBTEwLjQzJwDRveAEissBD29uUG9ydGFsQ2hhbmdlZAIEANG94ASI7QGFAUBjb25zdCB7IHBvcnRhbCwgZGltZW5zaW9uIH0gPSB0aGF0OwoKaWYgKHBvcnRhbCA9PT0gJ21lbnVQb3J0YWwnKSB7CiAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgIHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7CiAgICB9Cn0nANG94ASKywENYWJNZW51UmVmcmVzaAIEANG94ASO7gEbQHRoaXNCb3QuYWJTdGFydEFybU51ZGdlKCk7JwDRveAEissBEWRlYnVnVXNlck1hZGVCb3RzAgQA0b3gBKruAQVmYWxzZScBBGJvdHMkZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkAScA0b3gBLDuAQZzeXN0ZW0CBADRveAEse4BHGFiLnBlcnNvbmFsaXR5Lm1hbmlmZXN0YXRpb24nANG94ASw7gEEZm9ybQIEANG94ATO7gEHbm90aGluZycA0b3gBLDuAQtkZXNjcmlwdGlvbgIEANG94ATW7gE4VGhpcyBza2lsbCBjb250cm9scyB0aGUgYWN0dWFsIGJvdCBmb3IgdGhlIGFiIGludGVyZmFjZS4nANG94ASw7gEFbGVhcm4CBADRveAEj+8BKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnANG94ASw7gEPb25Qb3J0YWxDaGFuZ2VkAgQA0b3gBLbvAaRJQGNvbnN0IFBPUlRBTFNfVEhBVF9ISURFID0gbmV3IFNldChbCiAgICAic3lzdGVtUG9ydGFsIiwKICAgICJzaGVldFBvcnRhbCIKXSkKCmNvbnN0IFBPUlRBTFNfVEhBVF9NQU5JRkVTVCA9IG5ldyBTZXQoWwogICAgImdyaWRQb3J0YWwiLAogICAgIm1hcFBvcnRhbCIKXSk7Cgpjb25zdCBNQVBfTE9BRF9XQUlUX1RJTUUgPSAxMDAwOwoKZm9yIChjb25zdCBwb3J0YWwgb2YgUE9SVEFMU19USEFUX0hJREUpIHsKICAgIGlmIChjb25maWdCb3QudGFnc1twb3J0YWxdICE9IG51bGwpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGEgcG9ydGFsIHRoYXQgaGlkZXMgYWIgaXMgb3BlbiAtIGhpZGluZyBhYkJvdCBhbmQgaWdub3JpbmcuYCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkJvdCkgewogICAgICAgICAgICBkZXN0cm95KGxpbmtzLmFiQm90KTsKICAgICAgICB9CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsICE9IG51bGwgfHwgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsICE9IG51bGwpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGVldCBwb3J0YWwgb3Igc3lzdGVtIHBvcnRhbCBvcGVuZWQgLSBoaWRpbmcgYWJCb3QgYW5kIGlnbm9yaW5nLmApOwogICAgfQoKICAgIGlmICh0YWdzLmFiQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5hYkJvdCk7CiAgICB9CgogICAgcmV0dXJuOwp9CgppZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiIGlzIG5vdCBhd2FrZSAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gInRhZ1BvcnRhbCIpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0YWdQb3J0YWwgY2hhbmdlZCAtIGlnbm9yaW5nLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAodGhhdC5wb3J0YWwgPT0gIm1lbnVQb3J0YWwiKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWVudVBvcnRhbCBjaGFuZ2VkIC0gaWdub3JpbmcuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LnBvcnRhbCA9PSAiZ3JpZFBvcnRhbCIgJiYgY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ3JpZFBvcnRhbCBjaGFuZ2VkLCBidXQgYWxzbyBhbHJlYWR5IGluIHRoZSBtYXBQb3J0YWwgLSBpZ25vcmluZy5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKLy8gVGhlIG1hcCBwb3J0YWwgaXMgdG91Z2guIEl0IHNlZW1zIHRvIHZhcnkgaW4gbG9hZGluZyBzcGVlZCBvbgovLyB2YXJpb3VzIGhhcmR3YXJlIGFuZCBuZXR3b3JrcyBhbmQgaGFzIGJ5IHRoZSB0aW1lIG9uUG9ydGFsQ2hhbmdlZCBpcyBjYWxsZWQgaXQgZG9lc250Ci8vIHNlZW0gZ3VhcmVudGVlZCB0byBiZSBhY3R1YWxseSByZWFkeS4gQWRkaW5nIGEgaGFyZGNvZGVkIHdhaXQgdGltZSB0byBnaXZlIHRoZSBwb3J0YWwgc3BhY2UgdG8gZ2V0Ci8vIHRoZSBtYXAgcG9ydGFsIGZ1bGx5IGxvYWRlZCBiZWZvcmUgY29udGludWluZyB3aXRoIG1hbmlmZXN0aW5nIGFiLgovLwovLyBBdCBzb21lIHBvaW50IHRoaXMgY2FuIGdvIGF3YXkgaWYgd2UgZXZlciBnZXQgYSBzaG91dCBvciBzb21lIG90aGVyIGdhdXJlbnRlZSB0aGF0IHRoZSBtYXAgcG9ydGFsIGlzIGxvYWRlZC9yZWFkeS4KaWYgKHRoYXQucG9ydGFsID09PSAnbWFwUG9ydGFsJykgewogICAgaWYgKHRoYXQuZGltZW5zaW9uKSB7CiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkICYmICF0aGlzQm90LnZhcnMubWFwUG9ydGFsSW5pdGlhbExvYWRlZCkgewogICAgICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG9zLnNsZWVwKE1BUF9MT0FEX1dBSVRfVElNRSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2FpdGluZyBmb3IgbWFwIHBvcnRhbCB0byBmaW5pc2ggbG9hZGluZzogJHtNQVBfTE9BRF9XQUlUX1RJTUV9bXNgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlciA9IG51bGw7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5tYXBQb3J0YWxJbml0aWFsTG9hZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFwIHBvcnRhbCBsb2FkZWQuYCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pCgogICAgICAgICAgICAvLyBhd2FpdCB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZFdhaXRlcjsKICAgICAgICAgICAgLy8gdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwogICAgICAgICAgICAvLyB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXAgcG9ydGFsIGlzIGFscmVhZHkgbG9hZGVkLmApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICB0aGlzQm90LnZhcnMubWFwUG9ydGFsTG9hZGVkID0gZmFsc2U7CiAgICAgICAgdGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIgPSBudWxsOwoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcCBwb3J0YWwgaGFzIGJlZW4gdW5sb2FkZWQuYCk7CiAgICAgICAgfQogICAgfQp9CgovLyBTdGFydCBjaGVja3MgZm9yIGlmL3doZXJlIHdlIG5lZWQgdG8gbWFuaWZlc3QgYWIuCmxldCBuZXdBQiA9IGZhbHNlOwpsZXQgbmV3QUJQb3J0YWw7CmxldCBuZXdBQlBvc2l0aW9uOwpsZXQgZm9jdXNDYW1lcmEgPSB0cnVlOwpsZXQgZm9jdXNDYW1lcmFTdGFydFpvb207CgppZiAoUE9SVEFMU19USEFUX01BTklGRVNULmhhcyh0aGF0LnBvcnRhbCkgJiYgdGhhdC5kaW1lbnNpb24pIHsKICAgIC8vIEEgcG9ydGFsIHRoYXQgbWFuaWZlc3RzIGFiIGhhcyBqdXN0IGNoYW5nZWQgZGltZW5zaW9uLgogICAgLy8gTWFuaWZlc3QgYWIgaW4gdGhlIG5ldyBkaW1lbnNpb24uCiAgICBpZiAodGhhdC5wb3J0YWwgPT0gIm1hcFBvcnRhbCIgfHwgdGhhdC5wb3J0YWwgPT0gIm1pbmlNYXBQb3J0YWwiKSB7OwogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFuaWZlc3RpbmcgYWIgYm90IGluIG1hcCBwb3J0YWwgZGltZW5zaW9uICcke3RoYXQuZGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgdGhpc0JvdC5nZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignbWFwJyk7CiAgICAgICAgbmV3QUJQb3J0YWwgPSB0aGF0LnBvcnRhbDsKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIHBvc2l0aW9uOiBuZXdBQlBvc2l0aW9uIH0pOwogICAgICAgIGZvY3VzQ2FtZXJhU3RhcnRab29tID0gYXdhaXQgdGhpc0JvdC5nZXRTdGFydENhbWVyYVpvb20oJ21hcCcpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYW5pZmVzdGluZyBhYiBib3QgZGltZW5zaW9uICcke3RoYXQuZGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQlBvc2l0aW9uID0gYXdhaXQgdGhpc0JvdC5nZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbignZ3JpZCcpOwogICAgICAgIG5ld0FCUG9ydGFsID0gdGhhdC5wb3J0YWw7CiAgICAgICAgbmV3QUIgPSBhd2FpdCB0aGlzQm90LmFiTWFuaWZlc3RCb3QoeyBkaW1lbnNpb246IHRoYXQuZGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKICAgICAgICBmb2N1c0NhbWVyYVN0YXJ0Wm9vbSA9IGF3YWl0IHRoaXNCb3QuZ2V0U3RhcnRDYW1lcmFab29tKCdncmlkJyk7CiAgICB9Cn0gZWxzZSBpZiAoKFBPUlRBTFNfVEhBVF9NQU5JRkVTVC5oYXModGhhdC5wb3J0YWwpIHx8IFBPUlRBTFNfVEhBVF9ISURFLmhhcyh0aGF0LnBvcnRhbCkpICYmIAogICAgICAgICAgICF0aGF0LmRpbWVuc2lvbiAmJiAKICAgICAgICAgICAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCB8fCBjb25maWdCb3QudGFncy5tYXBQb3J0YWwpCikgewogICAgLy8gQSBwb3J0YWwgdGhhdCB0eXBpY2FsbHkgaGlkZXMgb3IgcmUtbWFuaWZlc3RzIGFiIGp1c3QgY2xvc2VkLCBidXQgZWl0aGVyIHRoZSBncmlkIG9yIG1hcCBwb3J0YWwgYXJlIHN0aWxsIG9wZW4uCiAgICAvLyBTdW1tb24gYWIgaW4gZWl0aGVyIHRoZSBtYXBQb3J0YWwgb3IgZ3JpZFBvcnRhbC4KICAgIGxldCBzdW1tb25EaW1lbnNpb247CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkgewogICAgICAgIHN1bW1vbkRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbDsKICAgICAgICBuZXdBQlBvcnRhbCA9ICdtYXBQb3J0YWwnOwogICAgICAgIAogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzW3N1bW1vbkRpbWVuc2lvbiArICdBQkxhc3RQb3NpdGlvbiddKSB7CiAgICAgICAgICAgIC8vIFVzZSBsYXN0IGtub3duIHBvc2l0aW9uLgogICAgICAgICAgICBuZXdBQlBvc2l0aW9uID0gbGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVc2UgZGVmYXVsdCBtYXAgcG9zaXRpb24uCiAgICAgICAgICAgIG5ld0FCUG9zaXRpb24gPSBhd2FpdCB0aGlzQm90LmdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKCdtYXAnKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwpIHsKICAgICAgICBzdW1tb25EaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwogICAgICAgIG5ld0FCUG9ydGFsID0gJ2dyaWRQb3J0YWwnOwoKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFnc1tzdW1tb25EaW1lbnNpb24gKyAnQUJMYXN0UG9zaXRpb24nXSkgewogICAgICAgICAgICAvLyBVc2UgbGFzdCBrbm93biBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3Nbc3VtbW9uRGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVXNlIGRlZmF1bHQgZ3JpZCBwb3NpdGlvbi4KICAgICAgICAgICAgbmV3QUJQb3NpdGlvbiA9IGF3YWl0IHRoaXNCb3QuZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb24oJ2dyaWQnKTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHN1bW1vbkRpbWVuc2lvbikgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3VtbW9uaW5nIGFiIGJvdCBpbiAke25ld0FCUG9ydGFsfSBkaW1lbnNpb24gJyR7c3VtbW9uRGltZW5zaW9ufScuYCk7CiAgICAgICAgfQoKICAgICAgICBuZXdBQiA9IGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbjogc3VtbW9uRGltZW5zaW9uLCBwb3NpdGlvbjogbmV3QUJQb3NpdGlvbiB9KTsKCiAgICAgICAgaWYgKFBPUlRBTFNfVEhBVF9ISURFLmhhcyh0aGF0LnBvcnRhbCkpIHsKICAgICAgICAgICAgLy8gSWYgdGhlIHBvcnRhbCB0aGF0IGNsb3NlZCB3YXMgYSBwb3J0YWwgdGhhdCBoaWRlcyBhYiwgdGhlbiBkb250IHJ1biB0aGUgY2FtZXJhIGZvY3VzLgogICAgICAgICAgICAvLyBUaGlzIHdpbGwganVzdCB1c2UgdGhlIHByZXZpb3VzIGNhbWVyYSBwb3NpdGlvbiBhbHJlYWR5IHN0b3JlZCBpbiBtZW1vcnkuCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdpbGwgbm90IGZvY3VzIGNhbWVyYSBvbiBhYiBiZWNhdXNlIHdlIGFyZSBqdXN0IGFzc3VtaW5nIHRoZSBwcmV2aW91cyBjYW1lcmEgcG9zaXRpb24uYCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9jdXNDYW1lcmEgPSBmYWxzZTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90aCB0aGUgbWFwIGFuZCBncmlkIHBvcnRhbCBhcmUgYm90aCBjbG9zZWQsIGNhbm5vdCBzdW1tb24gYWIgaW4gZWl0aGVyLmApOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIHJldHVybjsKfQoKaWYgKGZvY3VzQ2FtZXJhICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwUHJldmVudEZvY3VzKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpcHBpbmcgY2FtZXJhIGZvY3VzIGFuaW1hdGlvbiBiZWNhdXNlIG1hcFByZXZlbnRGb2N1cyBpcyBzZXQgdG8gdHJ1ZSBvbiB0aGUgYWIgcmVtZW1iZXIgYm90LmApOwogICAgfQoKICAgIGZvY3VzQ2FtZXJhID0gZmFsc2U7Cn0KCmlmIChuZXdBQiAmJiBmb2N1c0NhbWVyYSkgewogICAgaWYgKHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8gJiYgCiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mby5wb3J0YWwgPT09IHRoYXQucG9ydGFsICYmIAogICAgICAgIHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8uZGltZW5zaW9uID09PSB0aGF0LmRpbWVuc2lvbiAmJgogICAgICAgIHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8ucG9zaXRpb24/LnggPT09IG5ld0FCUG9zaXRpb24ueCAmJgogICAgICAgIHRoaXNCb3QudmFycy5hY3RpdmVGb2N1c0luZm8ucG9zaXRpb24/LnkgPT09IG5ld0FCUG9zaXRpb24ueQogICAgKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYW1lcmEgZm9jdXMgYW5pbWF0aW9uIGJlY2F1c2Ugb25lIGlzIGFscmVhZHkgYWN0aXZlIHdpdGggdGhlIHNhbWUgc2V0dGluZ3MuYCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mbyA9IHsgCiAgICAgICAgcG9ydGFsOiB0aGF0LnBvcnRhbCwgCiAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgICAgICBwb3NpdGlvbjogey4uLm5ld0FCUG9zaXRpb259LAogICAgfTsKCiAgICBsZXQgem9vbSA9IHRhZ3MuZGVmYXVsdEdyaWRQb3J0YWxab29tOwoKICAgIGlmIChuZXdBQlBvcnRhbCA9PT0gJ21hcFBvcnRhbCcgfHwgbmV3QUJQb3J0YWwgPT09ICdtaW5pTWFwUG9ydGFsJykgewogICAgICAgIHpvb20gPSB0YWdzLmRlZmF1bHRNYXBQb3J0YWxab29tOwogICAgfQogICAgCiAgICB0cnkgewogICAgICAgIGlmIChmb2N1c0NhbWVyYVN0YXJ0Wm9vbSAhPSBudWxsKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNldCBzdGFydCB6b29tIG9mICR7bmV3QUJQb3J0YWx9IHRvICR7Zm9jdXNDYW1lcmFTdGFydFpvb219LmApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLm1hcFBvcnRhbExvYWRXYWl0ZXIpIHsKICAgICAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QudmFycy5tYXBQb3J0YWxMb2FkV2FpdGVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhd2FpdCBvcy5mb2N1c09uKG5ld0FCUG9zaXRpb24sIHsgem9vbTogZm9jdXNDYW1lcmFTdGFydFpvb20sIGR1cmF0aW9uOiAwLCBwb3J0YWw6IG5ld0FCUG9ydGFsIH0pOwogICAgICAgICAgICBhd2FpdCBvcy5zbGVlcCgxMDAwKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm9jdXMgb24gJHtKU09OLnN0cmluZ2lmeShuZXdBQlBvc2l0aW9uKX0gaW4gJHtuZXdBQlBvcnRhbH0gd2l0aCB6b29tICR7em9vbX0uYCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRhZ3MuYWJJbml0aWFsaXplZCkgeyAKICAgICAgICAgICAgLy8gW1J5YW5dIFJlYWxseSB3ZWlyZCBDYXN1YWxPUyBidWcgdGhhdCBjYXVzZXMgdGhlIHBvcnRhbCBjYW1lcmEgdG8gbm90IHJlc3BlY3Qgem9vbSBsZXZlbCBpZiB3ZSBkb250IGRvIHRoaXMuCiAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKDI1MCk7IAogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3MuZm9jdXNPbihuZXdBQlBvc2l0aW9uLCB7IHpvb20sIHJvdGF0aW9uOiB7IHg6IDQ1LCB5OiA0NSB9LCBwb3J0YWw6IG5ld0FCUG9ydGFsIH0pCiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm9jdXNPbiBlcnJvciBvY2N1cmVkOmAsIGUpOwogICAgICAgIH0KICAgIH0gZmluYWxseSB7CiAgICAgICAgdGhpc0JvdC52YXJzLmFjdGl2ZUZvY3VzSW5mbyA9IG51bGw7CiAgICB9Cn0nANG94ASw7gEIcmVtZW1iZXICBADRveAE27gCKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnANG94ASw7gENYWJNYW5pZmVzdEJvdAIEANG94ASCuQLohQFAY29uc3QgZGltZW5zaW9uID0gdGhhdD8uZGltZW5zaW9uOwpjb25zdCBwb3NpdGlvbiA9IHRoYXQ/LnBvc2l0aW9uOwoKaWYgKHRoaXNCb3QudmFycy5hYkJvdExhc3RJZCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgYWJCb3RgKTsKICAgIH0KICAgIGRlc3Ryb3kodGhpc0JvdC52YXJzLmFiQm90TGFzdElkKTsKfQoKY29uc3QgYWJNb2QgPSB7CiAgICBzcGFjZTogJ3RlbXBMb2NhbCcsCiAgICBkaW1lbnNpb24sCiAgICBhYkJvdDogdHJ1ZSwKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2RpbWVuc2lvbiArICdYJ106IHBvc2l0aW9uLngsCiAgICBbZGltZW5zaW9uICsgJ1knXTogcG9zaXRpb24ueSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIGZvcm06ICdjdWJlJywKICAgIGxhYmVsOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsLAogICAgbGFiZWxQb3NpdGlvbjogJ2Zyb250JywKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNjEsCiAgICBkcmFnZ2FibGU6IGZhbHNlLAogICAgYXJtU2VsZWN0aW9uOiB0cnVlLAogICAgYXJtR3JvdXBEcmFnOiB0cnVlLAogICAgYXJtVGVsZXBvcnQ6IHRydWUsCiAgICBhcm1NZXNoUGF0aDogbGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoLAogICAgYXJtQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBwZXJzb25hbGl0eTogdGFncy5wZXJzb25hbGl0eSwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBzcGluRHVyYXRpb25NUzogMjAwMCwKICAgIHNwaW5JbnRlcnZhbE1TOiAyMDAwLAogICAgc291bmRDbGljazogbGlua3MucmVtZW1iZXIudGFncy5hYkNsaWNrU291bmQgPz8gdHJ1ZSwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7IAogICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiTWVzaFBhdGgpIHsKICAgICAgICAgICAgbGV0IGZvcm1BZGRyZXNzOwoKICAgICAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJNZXNoUGF0aC5zdGFydHNXaXRoKCdodHRwczovLycpKSB7CiAgICAgICAgICAgICAgICBmb3JtQWRkcmVzcyA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJNZXNoUGF0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGZvcm1BZGRyZXNzID0gbGlua3MubGVhcm4uYWJCdWlsZENhc3VhbENhdGFsb2dVUkwobGlua3MucmVtZW1iZXIudGFncy5hYk1lc2hQYXRoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ3JlYXRlIHRoZSBtZXNoIGZvciBhYi4KICAgICAgICAgICAgbWFza3MubWVzaEJvdCA9IGdldExpbmsoY3JlYXRlKHsKICAgICAgICAgICAgICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgICAgICAgICAgICAgIGFiQm90OiBnZXRMaW5rKHRoaXNCb3QpLAogICAgICAgICAgICAgICAgbWFuYWdlcjogdGFncy5tYW5hZ2VyLAogICAgICAgICAgICAgICAgbmFtZTogJ2FiTWVzaEJvdCcsCiAgICAgICAgICAgICAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICAgICAgICAgIGZvcm06ICdtZXNoJywKICAgICAgICAgICAgICAgIGZvcm1TdWJ0eXBlOiAnZ2x0ZicsCiAgICAgICAgICAgICAgICBmb3JtQWRkcmVzcywKICAgICAgICAgICAgICAgIGZvcm1BbmltYXRpb246IGZhbHNlLAogICAgICAgICAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVyOiB0aGlzQm90LmlkLAogICAgICAgICAgICAgICAgYW5jaG9yUG9pbnQ6ICdjZW50ZXInLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICdaJ106IC0wLjUsCiAgICAgICAgICAgICAgICBhbmltVHJhbnNpdGlvbnM6IHsKICAgICAgICAgICAgICAgICAgICAvLyBLZXkgZm9ybWF0OiAnQ3VycmVudFN0YXRlOmFuaW1hdGlvbk5hbWUnIOKGkiBuZXh0IHN0YXRlIHRvIHRyYW5zaXRpb24gdG8uCiAgICAgICAgICAgICAgICAgICAgLy8gV2hlbiBhbiBhbmltYXRpb24gZmluaXNoZXMsIHdlIGxvb2sgdXAgdGhlIGN1cnJlbnQgc3RhdGUgKyBhbmltYXRpb24gY29tYm8KICAgICAgICAgICAgICAgICAgICAvLyB0byBkZXRlcm1pbmUgd2hhdCBzdGF0ZSB0byBtb3ZlIHRvLiBJZiBubyBlbnRyeSBleGlzdHMsIHdlIHN0YXkgaW4gdGhlIGN1cnJlbnQgc3RhdGUuCiAgICAgICAgICAgICAgICAgICAgJ0JsaW5rOmJsaW5rJzogJ0lkbGUnLAogICAgICAgICAgICAgICAgICAgICdDbGljazpob3Zlcl9hY3Rpb24nOiAnSWRsZScsCiAgICAgICAgICAgICAgICAgICAgJ1RoaW5raW5nQmVnaW46dGhpbmtpbmdfaW4nOiAnVGhpbmtpbmdMb29wJywKICAgICAgICAgICAgICAgICAgICAnVGhpbmtpbmdGYWlsdXJlOnRoaW5raW5nX291dF9mYWlsJzogJ0lkbGUnLAogICAgICAgICAgICAgICAgICAgICdUaGlua2luZ1N1Y2Nlc3M6dGhpbmtpbmdfb3V0JzogJ0lkbGUnLAogICAgICAgICAgICAgICAgICAgICdTZWxlY3RTaW5nbGVCZWdpbjpzZWxlY3Rfc2luZ2xlX2luJzogJ1NlbGVjdFNpbmdsZUxvb3AnLAogICAgICAgICAgICAgICAgICAgICdTZWxlY3RTaW5nbGVFbmQ6c2VsZWN0X3NpbmdsZV9vdXQnOiAnSWRsZScsCiAgICAgICAgICAgICAgICAgICAgJ1NlbGVjdE11bHRpQmVnaW46c2VsZWN0X211bHRpJzogJ1NlbGVjdE11bHRpTG9vcCcsCiAgICAgICAgICAgICAgICAgICAgJ1NlbGVjdE11bHRpRW5kOnNlbGVjdF9zaW5nbGVfb3V0JzogJ0lkbGUnLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG9uQm90QWRkZWQ6IExpc3RlbmVyU3RyaW5nKGFzeW5jICgpID0+IHsKICAgICAgICAgICAgICAgICAgICAvLyBNVVNUIHJ1biB0aGlzIGJlZm9yZSB0cmlnZ2VyaW5nIGFuaW1hdGlvbnMuIFdpdGhvdXQgaXQsIGFuaW1hdGlvbnMgbWF5IHRyeSB0byB0cmlnZ2VyIGJlZm9yZSB0aGUgYW5pbWF0aW9uIHN5c3RlbSBpcyByZWFkeS4KICAgICAgICAgICAgICAgICAgICBhd2FpdCBvcy5saXN0Rm9ybUFuaW1hdGlvbnModGhpc0JvdCk7CiAgICAgICAgICAgICAgICAgICAgdGFncy5hbmltYXRpb25zTG9hZGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWJBY3RpdmVSZXF1ZXN0R1BUcyA9IGdldEJvdHMoKGIpID0+IHsgcmV0dXJuIGIudGFncy5hYkFjdGl2ZVJlcXVlc3RHUFQgJiYgYi50YWdzLmlucHV0Py5zb3VyY2VJZCA9PT0gJ2FiQm90JyB9KTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGxpbmtzLm1hbmFnZXIudGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5uYW1lfS4ke3RhZ05hbWV9XSBhY3RpdmUgcmVxdWVzdCBncHRzIGZvciBhYkJvdDpgLCBhYkFjdGl2ZVJlcXVlc3RHUFRzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBpZiAoYWJBY3RpdmVSZXF1ZXN0R1BUcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNCb3QuY2hhbmdlQW5pbVN0YXRlKCdUaGlua2luZycpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNCb3QuY2hhbmdlQW5pbVN0YXRlKCdJZGxlJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBvbkZvcm1BbmltYXRpb25GaW5pc2hlZDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgYW5pbWF0aW9uIH0gPSB0aGF0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGFncy5hbmltU3RhdGU7CgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGAke3N0YXRlfToke2FuaW1hdGlvbn1gOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRTdGF0ZSA9IHRhZ3MuYW5pbVRyYW5zaXRpb25zPy5ba2V5XTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGxpbmtzLm1hbmFnZXIudGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5uYW1lfS4ke3RhZ05hbWV9XSB0cmFuc2l0aW9uIGxvb2t1cDogJyR7a2V5fScg4oaSICR7bmV4dFN0YXRlID8/ICcobm8gbWF0Y2gsIHN0YXlpbmcgaW4gJyArIHN0YXRlICsgJyknfWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRTdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzQm90LmNoYW5nZUFuaW1TdGF0ZShuZXh0U3RhdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgb25BQlJlcXVlc3RHUFRTdGFydGVkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBpbnB1dCB9ID0gdGhhdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LnNvdXJjZUlkID09PSAnYWJCb3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNCb3QuY2hhbmdlQW5pbVN0YXRlKCdUaGlua2luZ0JlZ2luJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBvbkFCUmVxdWVzdEdQVFN1Y2Nlc3M6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGlucHV0IH0gPSB0aGF0OwoKICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQuc291cmNlSWQgPT09ICdhYkJvdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpc0JvdC5jaGFuZ2VBbmltU3RhdGUoJ1RoaW5raW5nU3VjY2VzcycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgb25BQlJlcXVlc3RHUFRGYWlsdXJlOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBpbnB1dCB9ID0gdGhhdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LnNvdXJjZUlkID09PSAnYWJCb3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNCb3QuY2hhbmdlQW5pbVN0YXRlKCdUaGlua2luZ0ZhaWx1cmUnKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGNoYW5nZUFuaW1TdGF0ZTogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhhdDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXRlICE9PSB0YWdzLmFuaW1TdGF0ZSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAobGlua3MubWFuYWdlci50YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5uYW1lfS4ke3RhZ05hbWV9XWAsIHsgdG86IHN0YXRlLCBmcm9tOiB0YWdzLmFuaW1TdGF0ZX0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBjaGFuZ2VTdGF0ZSh0aGlzQm90LCBzdGF0ZSwgJ2FuaW1TdGF0ZScpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsaW5rcy5tYW5hZ2VyLnRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLm5hbWV9LiR7dGFnTmFtZX1dIGFscmVhZHkgaW4gc3RhdGU6ICcke3N0YXRlfSdgKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgYW5pbVN0YXRlSWRsZU9uRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBvcy5zdGFydEZvcm1BbmltYXRpb24odGhpc0JvdCwgJ2lkbGVfc21pbGUnLCB7IGNyb3NzRmFkZVdhcnA6IHRydWUsIGNyb3NzRmFkZUR1cmF0aW9uOiAzMDAsIGxvb3A6IHsgbW9kZTogJ3JlcGVhdCcgfSB9KTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRW50ZXIgYmxpbmsgc3RhdGUgcmFuZG9tbHkgd2hpbGUgaWRsaW5nLgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJsaW5rVGltZVJhbmdlID0gWzQ1MDAsIDgwMDBdOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJsaW5rVGltZSA9IG1hdGgucmFuZG9tKGJsaW5rVGltZVJhbmdlWzBdLCBibGlua1RpbWVSYW5nZVsxXSk7CiAgICAgICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmlkbGVCbGlua1RpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4geyB0aGlzQm90LmNoYW5nZUFuaW1TdGF0ZSgnQmxpbmsnKSB9LCBibGlua1RpbWUpOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVJZGxlT25FeGl0OiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2xlYXIgdGhlIGJsaW5rIHRpbWVvdXQuCiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXNCb3QudmFycy5pZGxlQmxpbmtUaW1lb3V0SWQpOwogICAgICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5pZGxlQmxpbmtUaW1lb3V0SWQgPSBudWxsOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVCbGlua09uRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBvcy5zdGFydEZvcm1BbmltYXRpb24odGhpc0JvdCwgJ2JsaW5rJywgeyBjcm9zc0ZhZGVXYXJwOiB0cnVlLCBjcm9zc0ZhZGVEdXJhdGlvbjogMzAwIH0pOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVDbGlja09uRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBvcy5zdGFydEZvcm1BbmltYXRpb24odGhpc0JvdCwgJ2hvdmVyX2FjdGlvbicsIHsgdGltZVNjYWxlOiAyLjI1IH0pOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVUaGlua2luZ0JlZ2luT25FbnRlcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIG9zLnN0YXJ0Rm9ybUFuaW1hdGlvbih0aGlzQm90LCAndGhpbmtpbmdfaW4nLCB7IGNyb3NzRmFkZVdhcnA6IHRydWUsIGNyb3NzRmFkZUR1cmF0aW9uOiAzMDAgfSk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGFuaW1TdGF0ZVRoaW5raW5nTG9vcE9uRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBvcy5zdGFydEZvcm1BbmltYXRpb24odGhpc0JvdCwgJ3RoaW5raW5nX2xvb3AnLCB7IGNyb3NzRmFkZVdhcnA6IHRydWUsIGNyb3NzRmFkZUR1cmF0aW9uOiAzMDAsIGxvb3A6IHsgbW9kZTogJ3JlcGVhdCcgfSB9KTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgYW5pbVN0YXRlVGhpbmtpbmdTdWNjZXNzT25FbnRlcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIG9zLnN0YXJ0Rm9ybUFuaW1hdGlvbih0aGlzQm90LCAndGhpbmtpbmdfb3V0JywgeyBjcm9zc0ZhZGVXYXJwOiB0cnVlLCBjcm9zc0ZhZGVEdXJhdGlvbjogNTAwIH0pOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVUaGlua2luZ0ZhaWx1cmVPbkVudGVyOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgb3Muc3RhcnRGb3JtQW5pbWF0aW9uKHRoaXNCb3QsICd0aGlua2luZ19vdXRfZmFpbCcsIHsgY3Jvc3NGYWRlV2FycDogdHJ1ZSwgY3Jvc3NGYWRlRHVyYXRpb246IDUwMCB9KTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgYW5pbVN0YXRlU2VsZWN0U2luZ2xlQmVnaW5PbkVudGVyOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgb3Muc3RhcnRGb3JtQW5pbWF0aW9uKHRoaXNCb3QsICdzZWxlY3Rfc2luZ2xlX2luJywgeyBjcm9zc0ZhZGVXYXJwOiB0cnVlLCBjcm9zc0ZhZGVEdXJhdGlvbjogMzAwIH0pOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVTZWxlY3RTaW5nbGVMb29wT25FbnRlcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIG9zLnN0YXJ0Rm9ybUFuaW1hdGlvbih0aGlzQm90LCAnc2VsZWN0X3NpbmdsZV9sb29wJywgeyBjcm9zc0ZhZGVXYXJwOiB0cnVlLCBjcm9zc0ZhZGVEdXJhdGlvbjogMzAwLCBsb29wOiB7IG1vZGU6ICdyZXBlYXQnIH0gfSk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGFuaW1TdGF0ZVNlbGVjdFNpbmdsZUVuZE9uRW50ZXI6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBvcy5zdGFydEZvcm1BbmltYXRpb24odGhpc0JvdCwgJ3NlbGVjdF9zaW5nbGVfb3V0JywgeyBjcm9zc0ZhZGVXYXJwOiB0cnVlLCBjcm9zc0ZhZGVEdXJhdGlvbjogMzAwIH0pOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVTZWxlY3RNdWx0aUJlZ2luT25FbnRlcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIG9zLnN0YXJ0Rm9ybUFuaW1hdGlvbih0aGlzQm90LCAnc2VsZWN0X211bHRpJywgeyBjcm9zc0ZhZGVXYXJwOiB0cnVlLCBjcm9zc0ZhZGVEdXJhdGlvbjogMzAwIH0pOwogICAgICAgICAgICAgICAgfSksCiAgICAgICAgICAgICAgICBhbmltU3RhdGVTZWxlY3RNdWx0aUxvb3BPbkVudGVyOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgb3Muc3RhcnRGb3JtQW5pbWF0aW9uKHRoaXNCb3QsICdzZWxlY3Rfc2luZ2xlX2xvb3AnLCB7IGNyb3NzRmFkZVdhcnA6IHRydWUsIGZhZGVEdXJhdGlvbjogMjAwLCBjcm9zc0ZhZGVEdXJhdGlvbjogMzAwLCBsb29wOiB7IG1vZGU6ICdyZXBlYXQnIH0gfSk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgIGFuaW1TdGF0ZVNlbGVjdE11bHRpRW5kT25FbnRlcjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgICAgICAgICAgICAgIG9zLnN0YXJ0Rm9ybUFuaW1hdGlvbih0aGlzQm90LCAnc2VsZWN0X3NpbmdsZV9vdXQnLCB7IGNyb3NzRmFkZVdhcnA6IHRydWUsIGNyb3NzRmFkZUR1cmF0aW9uOiAzMDAgfSk7CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgLy8gR2l2ZSBhYkJvdCBhIHJlZmVyZW5jZSB0byB0aGUgbWVzaEJvdCBjaGFuZ2VBbmltU3RhdGUgZnVuY3Rpb24uCiAgICAgICAgICAgIHRoaXNCb3QubGlzdGVuZXJzLmNoYW5nZUFuaW1TdGF0ZSA9IGxpbmtzLm1lc2hCb3QubGlzdGVuZXJzLmNoYW5nZUFuaW1TdGF0ZTsKCiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSAndHJhbnNwYXJlbnQnOwogICAgICAgICAgICB0YWdzLnNjYWxlID0gMTsKICAgICAgICAgICAgdGFncy5zcGluSW50ZXJ2YWxNUyA9IDQ1MDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gSWYgYSBjdXN0b20gbWVzaCBpcyBub3QgZGVmaW5lZCBmb3IgYWIsIHRoZW4gZ2l2ZSBhYiBhICJjb3JlIi4KICAgICAgICAgICAgbWFza3MuY29yZUJvdCA9IGdldExpbmsoY3JlYXRlKHsKICAgICAgICAgICAgICAgIHNwYWNlOiAndGVtcExvY2FsJywKICAgICAgICAgICAgICAgIGFiQm90OiBnZXRMaW5rKHRoaXNCb3QpLAogICAgICAgICAgICAgICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICAgICAgICAgICAgICBmb3JtT3BhY2l0eTogMC42NiwKICAgICAgICAgICAgICAgIHBvaW50YWJsZTogZmFsc2UsCiAgICAgICAgICAgICAgICBzY2FsZTogMC43NSwKICAgICAgICAgICAgICAgIHRyYW5zZm9ybWVyOiB0aGlzQm90LmlkLAogICAgICAgICAgICAgICAgYW5jaG9yUG9pbnQ6ICdjZW50ZXInLAogICAgICAgICAgICAgICAgW3RhZ3MuZGltZW5zaW9uXTogdHJ1ZSwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICdaJ106IC0wLjUKICAgICAgICAgICAgfSkpOwoKICAgICAgICAgICAgdGFncy5jb2xvciA9IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3I7CiAgICAgICAgICAgIHRhZ3Muc2NhbGUgPSAwLjk7CiAgICAgICAgICAgIHRhZ3Muc3Ryb2tlV2lkdGggPSAxOwogICAgICAgICAgICB0YWdzLnN0cm9rZUNvbG9yID0gbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgICAgICAgICAgdGFncy5mb3JtT3BhY2l0eSA9IDAuMzM7CiAgICAgICAgICAgIHRhZ3MuZm9ybURlcHRoVGVzdCA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC5hbmltYXRlQm90KCk7CiAgICAgICAgbWFza3MuaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzQm90LmFuaW1hdGVCb3QoKSwgdGFncy5zcGluSW50ZXJ2YWxNUyk7CiAgICB9KSwKICAgIG9uQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT0gJ3JpZ2h0JykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChtYXNrcy5hcm1Cb3QpIHsKICAgICAgICAgICAgZGVzdHJveShsaW5rcy5hcm1Cb3QpOwogICAgICAgICAgICBtYXNrcy5hcm1Cb3QgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxpbmtzLm1lc2hCb3QpIHsKICAgICAgICAgICAgbGlua3MubWVzaEJvdC5jaGFuZ2VBbmltU3RhdGUoJ0NsaWNrJyk7CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soKTsKICAgIH0pLAogICAgb25Qb2ludGVyRW50ZXI6TGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnKSB7CiAgICAgICAgICAgIHRhZ3MubW91c2VPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uUG9pbnRlckV4aXQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJykgewogICAgICAgICAgICB0YWdzLm1vdXNlT3ZlciA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyRG93bjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0Lm1vZGFsaXR5ID09PSAnbW91c2UnICYmIHRoYXQuYnV0dG9uSWQgPT09ICdsZWZ0JykgewogICAgICAgICAgICB0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24gPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOwogICAgICAgIH0KICAgIH0pLAogICAgb25Qb2ludGVyVXA6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAodGhhdC5tb2RhbGl0eSA9PT0gJ21vdXNlJyAmJiB0aGF0LmJ1dHRvbklkID09PSAnbGVmdCcpIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnRCdXR0b25Eb3duID0gZmFsc2U7CiAgICAgICAgICAgIHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVQb3J0YWxDdXJzb3IoKTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uRHJhZzogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0YWdzLm1vdXNlTGVmdEJ1dHRvbkRvd24pIHsKICAgICAgICAgICAgdGFncy5tb3VzZUxlZnREcmFnZ2luZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlUG9ydGFsQ3Vyc29yKCk7ICAKICAgICAgICB9CiAgICB9KSwKICAgIG9uS2V5RG93bjogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGlmICh0aGF0LmtleXMuaW5jbHVkZXMoJ1NoaWZ0JykpIHsKICAgICAgICAgICAgdGFncy5zaGlmdEhlbGQgPSB0cnVlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICBvbktleVVwOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgaWYgKHRoYXQua2V5cy5pbmNsdWRlcygnU2hpZnQnKSkgewogICAgICAgICAgICB0YWdzLnNoaWZ0SGVsZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZVBvcnRhbEN1cnNvcigpOyAgCiAgICAgICAgfQogICAgfSksCiAgICB1cGRhdGVQb3J0YWxDdXJzb3I6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsZXQgY3Vyc29yID0gbnVsbDsKCiAgICAgICAgaWYgKHRhZ3MubW91c2VMZWZ0RHJhZ2dpbmcpIHsKICAgICAgICAgICAgY3Vyc29yID0gJ2dyYWJiaW5nJzsgICAgCiAgICAgICAgfSBlbHNlIGlmICh0YWdzLm1vdXNlT3ZlcikgewogICAgICAgICAgICBpZiAodGFncy5zaGlmdEhlbGQpIHsKICAgICAgICAgICAgICAgIGN1cnNvciA9ICdjb250ZXh0LW1lbnUnOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3Vyc29yID0gJ3BvaW50ZXInOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbEN1cnNvciA9IGN1cnNvcjsKICAgIH0pLAogICAgYW5pbWF0ZUJvdDogTGlzdGVuZXJTdHJpbmcoYXN5bmMgKCkgPT4gewogICAgICAgIGlmIChsaW5rcy5tZXNoQm90KSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdCb3QudGFncy5hYk9wdGltaXplZCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCByb3RaID0gdGFncy5kaW1lbnNpb24gKyAnUm90YXRpb25aJzsKCiAgICAgICAgYXdhaXQgYW5pbWF0ZVRhZyh0aGlzQm90LAogICAgICAgIHsKICAgICAgICAgICAgZnJvbVZhbHVlOiB7CiAgICAgICAgICAgICAgICBbcm90Wl06IDAsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvVmFsdWU6IHsKICAgICAgICAgICAgICAgIFtyb3RaXTogNi4zLAogICAgICAgICAgICB9LAogICAgICAgICAgICBlYXNpbmc6IHsKICAgICAgICAgICAgICAgIHR5cGU6ICdzaW51c29pZGFsJywKICAgICAgICAgICAgICAgIG1vZGU6ICdpbm91dCcKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZHVyYXRpb246IHRhZ3Muc3BpbkR1cmF0aW9uTVMgLyAxMDAwLAogICAgICAgIH0pLmNhdGNoKGUgPT4ge30pOwogICAgfSksCiAgICBvbkFCWFBFUGFpZE91dDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHsgcGF5QW1vdW50LCBzb3VyY2VJZCB9ID0gdGhhdDsKCiAgICAgICAgaWYgKHNvdXJjZUlkID09PSAnYWJCb3QnKSB7CiAgICAgICAgICAgIGFiLmN1ZSh7IGJvdDogdGhpc0JvdCwgdGV4dDogYPCfqpktJHtwYXlBbW91bnR9YCwgd3JhcE1vZGU6ICdub25lJywgZm9udFNpemU6IDIsIGNvbG9yOiAnI2VmNDQ0NCcgfSk7CiAgICAgICAgICAgIHdoaXNwZXIoYWJYUEUubGlua3MuZ3VpLCAnc3Bhd25Db2lucycsIHsgdGFyZ2V0Qm90OiB0aGlzQm90LCBjb3VudDogcGF5QW1vdW50IH0pOwogICAgICAgIH0KICAgIH0pLAogICAgb25Bcm1DcmVhdGU6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBpZiAoIXRhZ3MuaW50ZXJ2YWwpIHsKICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYkNsaWNrKHsgcmVzZXQ6IHRydWUgfSk7CiAgICAgICAgfQoKICAgICAgICBpZiAobGlua3MuYXJtQm90ICYmIGxpbmtzLm1lc2hCb3QpIHsKICAgICAgICAgICAgY29uc3QgbXVsdGlTZWxlY3QgPSBsaW5rcy5hcm1Cb3QudGFncy5tdWx0aVNlbGVjdDsKICAgICAgICAgICAgaWYgKG11bHRpU2VsZWN0KSB7CiAgICAgICAgICAgICAgICBsaW5rcy5tZXNoQm90LmNoYW5nZUFuaW1TdGF0ZSgnU2VsZWN0TXVsdGlCZWdpbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGlua3MubWVzaEJvdC5jaGFuZ2VBbmltU3RhdGUoJ1NlbGVjdFNpbmdsZUJlZ2luJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KSwKICAgIG9uQXJtUGxhY2VkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYWJHcmlkRm9jdXMgPSB7CiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sIAogICAgICAgICAgICBwb3NpdGlvbjogewogICAgICAgICAgICAgICAgeDogdGhhdC54LAogICAgICAgICAgICAgICAgeTogdGhhdC55CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdncmlkJyB9KTsKCiAgICAgICAgaWYgKGxpbmtzLmFybUJvdCAmJiBsaW5rcy5tZXNoQm90KSB7CiAgICAgICAgICAgIGNvbnN0IG11bHRpU2VsZWN0ID0gbGlua3MuYXJtQm90LnRhZ3MubXVsdGlTZWxlY3Q7CiAgICAgICAgICAgIGlmIChtdWx0aVNlbGVjdCkgewogICAgICAgICAgICAgICAgbGlua3MubWVzaEJvdC5jaGFuZ2VBbmltU3RhdGUoJ1NlbGVjdE11bHRpRW5kJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5rcy5tZXNoQm90LmNoYW5nZUFuaW1TdGF0ZSgnU2VsZWN0U2luZ2xlRW5kJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNob3V0KCdvbkFCQXJtUGxhY2VkJywgdGhhdCk7CiAgICB9KSwKICAgIG9uQXJtQ2xpY2s6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyByZXNldDogdHJ1ZSB9KTsKICAgICAgICBzaG91dCgnb25BQkZvb3RDbGlja2VkJywgdGhhdCk7CiAgICB9KSwKICAgIG9uQXJtU2VsZWN0ZWRCb3RzOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3Qgc2VsZWN0ZWRCb3RzID0gdGhhdDsKCiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc2VsZWN0ZWRCb3RzKSkgewogICAgICAgICAgICAvLyBNdWx0aXBsZSBib3Qgc2VsZWN0aW9uLgogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYk11bHRpcGxlQm90Rm9jdXMgPSBnZXRMaW5rKHNlbGVjdGVkQm90cyk7CiAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJDbGljayh7IG1lbnU6ICdtdWx0aXBsZUJvdCcgfSk7CgogICAgICAgICAgICBpZiAobGlua3MuYXJtQm90ICYmIGxpbmtzLm1lc2hCb3QpIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1lc2hCb3QuY2hhbmdlQW5pbVN0YXRlKCdTZWxlY3RNdWx0aUVuZCcpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gU2luZ2xlIGJvdCBzZWxlY3Rpb24uCiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmFiQm90Rm9jdXMgPSAi8J+UlyIgKyBzZWxlY3RlZEJvdHMuaWQ7CgogICAgICAgICAgICBpZiAoc2VsZWN0ZWRCb3RzID09PSB0aGlzQm90KSB7CiAgICAgICAgICAgICAgICBhYi5saW5rcy5tZW51LmFiRW52aXJvbm1lbnRNZW51KCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiQ2xpY2soeyBtZW51OiAnYm90JyB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxpbmtzLmFybUJvdCAmJiBsaW5rcy5tZXNoQm90KSB7CiAgICAgICAgICAgICAgICBsaW5rcy5tZXNoQm90LmNoYW5nZUFuaW1TdGF0ZSgnU2VsZWN0U2luZ2xlRW5kJyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHNob3V0KCdvbkFCU2VsZWN0ZWRCb3QnLCBzZWxlY3RlZEJvdHMpOwogICAgfSksCiAgICBvbkFybURlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBzaG91dCgnYWJNZW51UmVmcmVzaCcpOwogICAgfSksCiAgICBvbkRlc3Ryb3k6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjbGVhckludGVydmFsKHRhZ3MuaW50ZXJ2YWwpOwogICAgICAgIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7CiAgICB9KSwKfTsKCmNvbnN0IGFiQm90ID0gY3JlYXRlKGFiTW9kKTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiU2Vjb25kYXJ5TGFiZWwpIHsKICAgIGNvbnN0IGFiTGFiZWxCb3QgPSB7CiAgICAgICAgc3BhY2U6ICd0ZW1wTG9jYWwnLAogICAgICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgICAgIFtkaW1lbnNpb24gKyAnWiddOiAtMSwKICAgICAgICBjcmVhdG9yOiBhYkJvdC5pZCwKICAgICAgICB0cmFuc2Zvcm1lcjogYWJCb3QuaWQsCiAgICAgICAgcG9pbnRhYmxlOiBmYWxzZSwKICAgICAgICBjb2xvcjogJ2NsZWFyJywKICAgICAgICBsYWJlbDogbGlua3MucmVtZW1iZXIudGFncy5hYlNlY29uZGFyeUxhYmVsLAogICAgICAgIGxhYmVsUG9zaXRpb246ICdsZWZ0JywKICAgICAgICBsYWJlbFNpemU6IDAuNywKICAgICAgICBsYWJlbENvbG9yOiBhYkJvdC50YWdzLmxhYmVsQ29sb3IsCiAgICB9OwoKICAgIGNyZWF0ZShhYkxhYmVsQm90KTsKfQoKbWFza3MuYWJCb3QgPSBnZXRMaW5rKGFiQm90KTsKbGlua3MucmVtZW1iZXIubWFza3MuYWJBY3RpdmVEaW1lbnNpb24gPSBkaW1lbnNpb247CnRoaXNCb3QudmFycy5hYkJvdExhc3RJZCA9IGFiQm90LmlkOyAvLyBTdG9yaW5nIGlkIGFzIGEgdmFyIHByZXZlbnRzIGdob3N0IGFiQm90cyBkdXJpbmcgbXVsdGlwbGUgY2FsbHMgaW4gb25lIGZyYW1lLgoKLy8gU3RvcmUgdGhlIGxhc3QgcG9zaXRpb24gb2YgYWIgaW4gdGhpcyBkaW1lbnNpb24gb24gdGhlIHJlbWVtYmVyIGJvdC4KbGlua3MucmVtZW1iZXIubWFza3NbZGltZW5zaW9uICsgJ0FCTGFzdFBvc2l0aW9uJ10gPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeSh7IHg6IHBvc2l0aW9uPy54LCB5OiBwb3NpdGlvbj8ueSB9KTsKCmF3YWl0IG9zLnNsZWVwKDApOyAvLyBHaXZlIENhc3VhbE9TIGEgY2hhbmNlIHRvIHVwZGF0ZSB0YWcgbWFza3MuCgpzaG91dCgnb25BQk1vdmVkJywgeyBkaW1lbnNpb24sIHg6IHBvc2l0aW9uLngsIHk6IHBvc2l0aW9uLnkgfSk7CgpyZXR1cm4gYWJCb3Q7JwDRveAEsO4BC29uR3JpZENsaWNrAgQA0b3gBOG+A+IWQGlmICghdGFncy5hYkF3YWtlKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IHNoaWZ0Q2hlY2sgPSBvcy5nZXRJbnB1dFN0YXRlKCJrZXlib2FyZCIsICJTaGlmdCIpOwoKaWYgKGxpbmtzLmFiQm90ICYmIChzaGlmdENoZWNrIHx8ICh0aGF0Lm1vZGFsaXR5ID09ICJtb3VzZSIgJiYgdGhhdC5idXR0b25JZCA9PSAicmlnaHQiICYmICFsaW5rcy5yZW1lbWJlci50YWdzLmFiUmlnaHRDbGlja0Rpc2FibGVkKSB8fCB0aGF0LmZvcmNlQXJtUGxhY2VtZW50KSkgewogICAgY29uc3QgYXJtQm90ID0gYWIubGlua3MuYXJtX3Rvb2wuYWJDcmVhdGVBcm0oewogICAgICAgIG9yaWdpbkJvdDogbGlua3MuYWJCb3QsCiAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgICAgICBwb3NpdGlvbjogdGhhdC5wb3NpdGlvbiwKICAgIH0pCgogICAgLy8gRmFrZSB1c2VyIGRyb3BwaW5nIHRoZSBhcm0gb24gdGhlIGdyaWQgc3BhY2UuCiAgICBhcm1Cb3Qub25Ecm9wKHsKICAgICAgICBib3Q6IGFybUJvdCwKICAgICAgICB0bzogewogICAgICAgICAgICB4OiB0aGF0LnBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IHRoYXQucG9zaXRpb24ueSwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0sCiAgICAgICAgZnJvbTogewogICAgICAgICAgICB4OiB0aGF0LnBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IHRoYXQucG9zaXRpb24ueSwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybjsKfQoKY29uc3QgZm9vdHByaW50ID0gewogICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbiwKICAgIFt0aGF0LmRpbWVuc2lvbl06IHRydWUsCiAgICBbdGhhdC5kaW1lbnNpb24gKyAiWCJdOiB0aGF0LnBvc2l0aW9uLngsCiAgICBbdGhhdC5kaW1lbnNpb24gKyAiWSJdOiB0aGF0LnBvc2l0aW9uLnksCiAgICBwb3NpdGlvbkluZm86IHRoYXQsCiAgICBwZXJzb25hbGl0eTogdGFncy5wZXJzb25hbGl0eSwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBkcmFnZ2FibGU6IGZhbHNlLAogICAgY3Vyc29yOiAnYWxpYXMnLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIHNvdW5kQ3JlYXRlOiAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShbICdhYi9hdWRpby9ncmlkIHRhcF8wMS5tcDMnLCAnYWIvYXVkaW8vZ3JpZCB0YXBfMDIubXAzJywgJ2FiL2F1ZGlvL2dyaWQgdGFwXzAzLm1wMycsICdhYi9hdWRpby9ncmlkIHRhcF8wNC5tcDMnLCAnYWIvYXVkaW8vZ3JpZCB0YXBfMDUubXAzJyBdKSwKICAgIG9uQ3JlYXRlOiBMaXN0ZW5lclN0cmluZyhhc3luYyAoKSA9PiB7CiAgICAgICAgc2V0VGltZW91dCgoKSA9PiBkZXN0cm95KHRoaXNCb3QpLCA4MDApOwoKICAgICAgICBpZiAobGlua3MucmVtZW1iZXIudGFncy5hYkFybU1lc2hQYXRoKSB7CiAgICAgICAgICAgIGlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJtTWVzaFBhdGguc3RhcnRzV2l0aCgnaHR0cHM6Ly8nKSkgewogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcm1NZXNoUGF0aDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJtTWVzaFBhdGgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0YWdzLmZvcm0gPSAnbWVzaCc7CiAgICAgICAgICAgIHRhZ3MuZm9ybVN1YnR5cGUgPSAnZ2x0Zic7CiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgICAgICAgICB0YWdzLnN0cm9rZUNvbG9yID0gbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgICAgICAgICAgdGFncy5hbmNob3JQb2ludCA9ICdjZW50ZXInOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRhZ3MuY29sb3IgPSAnY2xlYXInOwogICAgICAgICAgICB0YWdzLnN0cm9rZUNvbG9yID0gbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgICAgICAgICAgdGFncy5zY2FsZVogPSAwLjAxOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgYW5pbWF0ZVRhZyh0aGlzQm90LCB7CiAgICAgICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICAgICAgc2NhbGVYOiAwLjEsCiAgICAgICAgICAgICAgICBzY2FsZVk6IDAuMQogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgICAgICBzY2FsZVg6IDEuMSwKICAgICAgICAgICAgICAgIHNjYWxlWTogMS4xCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGR1cmF0aW9uOiAwLjUsCiAgICAgICAgICAgIGVhc2luZzogewogICAgICAgICAgICAgICAgdHlwZTogImVsYXN0aWMiLAogICAgICAgICAgICAgICAgbW9kZTogIm91dCIKICAgICAgICAgICAgfQogICAgICAgIH0pLmNhdGNoKGUgPT4ge30pOwogICAgfSksCiAgICBvbkNsaWNrOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICBzaG91dCgib25BQkZvb3RDbGlja2VkIiwgeyBkaW1lbnNpb246IHRhZ3MuZGltZW5zaW9uIH0pOwogICAgICAgIGxpbmtzLm1hbmFnZXIuYWJNYW5pZmVzdEJvdCh0YWdzLnBvc2l0aW9uSW5mbyk7CiAgICAgICAgYWIubGlua3Muc291bmQuYWJQbGF5U291bmQoeyB2YWx1ZTogYWIubGlua3MuYXJtX3Rvb2wudGFncy5kZWZhdWx0QXJtVGVsZXBvcnRTb3VuZCB9KTsKICAgIH0pLAp9OwoKCmNyZWF0ZShmb290cHJpbnQpOycA0b3gBLDuAQRtZW51AgQA0b3gBMLVAyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDRveAEsO4BB2FiQ2xpY2sCBADRveAE6dUD0ApAaWYgKCFsaW5rcy5hYkJvdCkgewogICAgcmV0dXJuOwp9CgppZiAobGlua3MuaW5wdXQpIHsKICAgIGxpbmtzLmlucHV0LmFiQ2hhdEJhckNsb3NlKCk7Cn0KCmNvbnN0IHJlc2V0ID0gdGhhdCA/IHRoYXQucmVzZXQgOiBmYWxzZTsKY29uc3QgbWVudSA9IHRoYXQgPyB0aGF0Lm1lbnUgOiAiY29yZSI7CmNvbnN0IHN0YXRlID0gb3MuZ2V0SW5wdXRTdGF0ZSgia2V5Ym9hcmQiLCAiU2hpZnQiKTsKCmlmICghcmVzZXQgJiYgKGxpbmtzLmFiQm90LnRhZ3MuaW50ZXJ2YWwgfHwgc3RhdGUpKSB7CiAgICBjb25zdCBhYk1lbnVCb3RzID0gZ2V0Qm90cygiYWJNZW51IiwgdHJ1ZSk7CgogICAgd2hpc3BlcihhYk1lbnVCb3RzLCAiYWJNZW51UmVmcmVzaCIpOwoKICAgIGNsZWFySW50ZXJ2YWwobGlua3MuYWJCb3QudGFncy5pbnRlcnZhbCk7CgogICAgbGlua3MuYWJCb3QubWFza3MuaW50ZXJ2YWwgPSBudWxsOwoKICAgIGNsZWFyQW5pbWF0aW9ucyhsaW5rcy5hYkJvdCk7CgogICAgY29uc3Qgcm90WiA9IGxpbmtzLmFiQm90LnRhZ3MuZGltZW5zaW9uICsgIlJvdGF0aW9uWiI7CgogICAgaWYgKHN0YXRlICYmIG1lbnUgPT0gImNvcmUiKSB7CiAgICAgICAgbGlua3MubWVudS5hYkVudmlyb25tZW50TWVudSgpOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgbGlua3MubWVudS5hYk9wZW5NZW51KG1lbnUpOwogICAgfQoKICAgIGFuaW1hdGVUYWcobGlua3MuYWJCb3QsIHsKICAgICAgICBmcm9tVmFsdWU6IHsKICAgICAgICAgICAgW3JvdFpdOiBsaW5rcy5hYkJvdC50YWdzW3JvdFpdCiAgICAgICAgfSwKICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgIFtyb3RaXTogMAogICAgICAgIH0sCiAgICAgICAgZWFzaW5nOiB7CiAgICAgICAgICAgIHR5cGU6ICJzaW51c29pZGFsIiwKICAgICAgICAgICAgbW9kZTogImlub3V0IgogICAgICAgIH0sCiAgICAgICAgZHVyYXRpb246IDAuNQogICAgfSkuY2F0Y2goZSA9PiB7fSkKfQplbHNlIHsKICAgIGxpbmtzLmFiQm90LmFuaW1hdGVCb3QoKTsKCiAgICBsaW5rcy5hYkJvdC5tYXNrcy5saW5lVG8gPSBudWxsOwoKICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgY2xlYXJJbnRlcnZhbChsaW5rcy5hYkJvdC50YWdzLmludGVydmFsKTsKICAgIGxpbmtzLmFiQm90Lm1hc2tzLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gbGlua3MuYWJCb3QuYW5pbWF0ZUJvdCgpLCBsaW5rcy5hYkJvdC50YWdzLnNwaW5JbnRlcnZhbE1TKTsKfQoKc2hvdXQoJ29uQUJDbGljaycsIHsgYWJCb3Q6IGxpbmtzLmFiQm90LCBkaW1lbnNpb246IGxpbmtzLmFiQm90LnRhZ3MuZGltZW5zaW9uLCBtZW51LCBzaGlmdEtleTogISFzdGF0ZSwgcmVzZXQgfSk7JwDRveAEsO4BCGFiSWdub3JlAgQA0b3gBLrgAwR0cnVlJwDRveAEsO4BA2FzawIEANG94AS/4AMo8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycA0b3gBLDuAQlhc2tCdXR0b24CBADRveAE5uADyAVAaWYgKCF0YWdzLmFiQXdha2UpCnsKICAgIHJldHVybjsKfQoKbGV0IGFiTWVudUJ1dHRvbiA9IHt9OwoKYWJNZW51QnV0dG9uLmFiTWVudSA9IHRydWU7CmFiTWVudUJ1dHRvbi5yZW1lbWJlciA9IGxpbmtzLm1lbnUudGFncy5yZW1lbWJlcjsKYWJNZW51QnV0dG9uLm1hbmlmZXN0YXRpb24gPSBsaW5rcy5tZW51LnRhZ3MubWFuaWZlc3RhdGlvbjsKYWJNZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CmFiTWVudUJ1dHRvbi5iYXNlU2tpbGwgPSAi8J+UlyIgKyBsaW5rcy5hc2suaWQ7CmFiTWVudUJ1dHRvbi5sYWJlbCA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVMYWJlbDsKYWJNZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUljb247CmFiTWVudUJ1dHRvbi5vbkNyZWF0ZSA9IGxpbmtzLmFzay50YWdzLmFiQ29yZU1lbnVPbkdlbmVyYXRlOwphYk1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudVNvcnRPcmRlcjsKYWJNZW51QnV0dG9uLmNvbG9yID0gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUNvbG9yID8gbGlua3MuYXNrLnRhZ3MuYWJDb3JlTWVudUNvbG9yIDogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGFiTWVudUJ1dHRvbik7JwDRveAEsO4BCWFiQm90Q2hhdAIEANG94ASt5gPuCEBpZiAoIWxpbmtzLmFiQm90ICYmICF0aGF0LmJvdCkKewogICAgcmV0dXJuOwp9Cgpjb25zdCBib3RCYXNlID0gdGhhdC5ib3QgPyB0aGF0LmJvdDogbGlua3MuYWJCb3Q7CmNvbnN0IGRpbWVuc2lvbiA9ICF0aGF0LmJvdCA/IGJvdEJhc2UudGFncy5kaW1lbnNpb24gOiB0aGF0LmRpbWVuc2lvbiA/IHRoYXQuZGltZW5zaW9uIDogY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbDsKY29uc3QgbWVzc2FnZSA9IHRoYXQubWVzc2FnZTsKY29uc3QgbWVzc2FnZVRpbWUgPSB0aGF0LnRpbWUgPyB0aGF0LnRpbWUgKiAxMDAwIDogMTYwMDsgCgpjb25zdCBtZXNzYWdlQm90ID0gYXdhaXQgbGlua3MuYm90X2ZhY3RvcnkuYWJDcmVhdGVCaWxsYm9hcmRMYWJlbCh7CiAgICBib3Q6IGJvdEJhc2UsCiAgICBsYWJlbDogbWVzc2FnZSwKICAgIGRpbWVuc2lvbiwKICAgIG1lc3NhZ2VUaW1lLAogICAgY29sb3I6ICIjMDAwMDAwIiwKICAgIGxhYmVsQ29sb3I6ICIjZmZmZmZmIiwKICAgIG9uQm90QWRkZWQ6IGBACiAgICAgICAgYXdhaXQgb3Muc2xlZXAodGFncy5tZXNzYWdlVGltZSk7CiAgICAgICAgdGhpc0JvdC5vbkZhZGUoKTsKICAgIGAsCiAgICBvbkZhZGU6IGBACiAgICAgICAgYW5pbWF0ZVRhZyh0aGlzQm90LCB7CiAgICAgICAgICAgIGZyb21WYWx1ZTogewogICAgICAgICAgICAgICAgZm9ybU9wYWNpdHk6IDEsCiAgICAgICAgICAgICAgICBsYWJlbE9wYWNpdHk6IDEsCiAgICAgICAgICAgICAgICBbdGFncy5kaW1lbnNpb24gKyAiWiJdOiB0YWdzW3RhZ3MuZGltZW5zaW9uICsgIloiXQogICAgICAgICAgICB9LAogICAgICAgICAgICB0b1ZhbHVlOiB7CiAgICAgICAgICAgICAgICBmb3JtT3BhY2l0eTogMCwKICAgICAgICAgICAgICAgIGxhYmVsT3BhY2l0eTogMCwKICAgICAgICAgICAgICAgIFt0YWdzLmRpbWVuc2lvbiArICJaIl06IHRhZ3NbdGFncy5kaW1lbnNpb24gKyAiWiJdICsgNQogICAgICAgICAgICB9LAogICAgICAgICAgICBkdXJhdGlvbjogJHt0aGF0LmR1cmF0aW9uID8/IDN9CiAgICAgICAgfSkKICAgICAgICAuY2F0Y2goKGUpID0+IHt9KQogICAgICAgIC5maW5hbGx5KCgpID0+IHsKICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICB9KQoKICAgIGAsCn0pOycA0b3gBLDuAQlhYlZlcnNpb24CBADRveAEnO8DBTEwLjQzJwDRveAEsO4BCWFuaW1hdGlvbgIEANG94ASi7wMo8J+Ul2IyNmUxMDg5LTE3MmQtNDVhOS04ZDIyLTA1YzNmNThjMmJmNycA0b3gBLDuAQ9vbkFueUJvdENsaWNrZWQCBADRveAEye8D6QdAaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmFiUmlnaHRDbGlja0Rpc2FibGVkICYmICF0aGF0LmJvdC50YWdzLmFiUmlnaHRDbGlja0lnbm9yZSAmJiB0aGF0Lm1vZGFsaXR5ID09ICJtb3VzZSIgJiYgdGhhdC5idXR0b25JZCA9PSAicmlnaHQiKSB7CiAgICBpZiAoIXRhZ3MuYWJBd2FrZSkgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBhYiBzZWxlY3RlZAogICAgaWYgKHRoYXQuYm90ID09IGxpbmtzLmFiQm90KSB7CiAgICAgICAgbGlua3MubWVudS5hYkVudmlyb25tZW50TWVudSgpOwogICAgICAgIHJldHVybjsKICAgIH0gICAgCiAgICAKICAgIGNvbnN0IGFybUJvdCA9IGFiLmxpbmtzLmFybV90b29sLmFiQ3JlYXRlQXJtKHsKICAgICAgICBvcmlnaW5Cb3Q6IGxpbmtzLmFiQm90LAogICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24sCiAgICAgICAgcG9zaXRpb246IHRoYXQucG9zaXRpb24sCiAgICB9KQoKICAgIGNvbnN0IGJvdFBvc2l0aW9uID0gZ2V0Qm90UG9zaXRpb24odGhhdC5ib3QsIHRoYXQuZGltZW5zaW9uKTsKCiAgICAvLyBGYWtlIHVzZXIgZHJvcHBpbmcgdGhlIHNlbGVjdGluZyB0aGUgYm90IHdpdGggdGhlIGFybS4KICAgIGFybUJvdC5vbkRyb3AoewogICAgICAgIGJvdDogYXJtQm90LAogICAgICAgIHRvOiB7CiAgICAgICAgICAgIGJvdDogdGhhdC5ib3QsCiAgICAgICAgICAgIHg6IGJvdFBvc2l0aW9uLngsCiAgICAgICAgICAgIHk6IGJvdFBvc2l0aW9uLnksCiAgICAgICAgICAgIHo6IGJvdFBvc2l0aW9uLnosCiAgICAgICAgICAgIGRpbWVuc2lvbjogdGhhdC5kaW1lbnNpb24KICAgICAgICB9LAogICAgICAgIGZyb206IHsKICAgICAgICAgICAgeDogYm90UG9zaXRpb24ueCwKICAgICAgICAgICAgeTogYm90UG9zaXRpb24ueSwKICAgICAgICAgICAgejogYm90UG9zaXRpb24ueiwKICAgICAgICAgICAgZGltZW5zaW9uOiB0aGF0LmRpbWVuc2lvbgogICAgICAgIH0KICAgIH0pOwoKICAgIHJldHVybjsKfScA0b3gBLDuAQVpbnB1dAIEANG94ASz9wMo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcA0b3gBLDuAQtwZXJzb25hbGl0eQIEANG94ATa9wMo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicA0b3gBLDuAQ1hYlBlcnNvbmFsaXR5AgQA0b3gBIH4AwR0cnVlJwDRveAEsO4BCmFiU2V0QXdha2UCBADRveAEhvgDjBBAbGV0IGF3YWtlID0gdGhhdD8uYXdha2U7CmxldCBpbml0aWFsID0gdGhhdD8uaW5pdGlhbCA/PyBmYWxzZTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCmFzc2VydCh0eXBlb2YgYXdha2UgPT09ICdib29sZWFuJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhd2FrZSBpcyBhIHJlcXVpcmVkIGJvb2xlYW4gcGFyYW1ldGVyLmApOwoKaWYgKGNvbmZpZ0JvdC50YWdzLmFiU3RheUF3YWtlKSB7CiAgICAvLyBJZiBhYlN0YXlBd2FrZSBpcyBlbmFibGVkLCBvdmVycmlkZSB0aGUgaW5jb21pbmcgYXdha2UgcGFyYW1ldGVyIGFuZCBuZXZlciBsZXQgYWIgYmUgcHV0IHRvIHNsZWVwLgogICAgYXdha2UgPSB0cnVlOwp9CgppZiAodGFncy5hYkF3YWtlICE9PSBhd2FrZSkgewogICAgaWYgKGluaXRpYWwpIHsKICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MucGF0dGVybikgewogICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSB1dWlkKCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIC8vIFBsYXkgaW5pdGlhbCBhbmltYXRpb24gaWYgb25lIGlzIGRlZmluZWQgb24gYWJDb25maWcuCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsQW5pbWF0aW9uKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmFuaW1hdGlvbltsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbEFuaW1hdGlvbl0oKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgLy8gU2hvdyBpbml0aWFsIG1lc3NhZ2UgaWYgb25lIGlzIGRlZmluZWQgb24gYWJDb25maWcuCiAgICAgICAgaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZSkgewogICAgICAgICAgICBzaG91dCgic2hvd0NvbnNvbGUiKTsKCiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJJbml0aWFsTWVzc2FnZSkpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkluaXRpYWxNZXNzYWdlW2ldKTsKCiAgICAgICAgICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjAwMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiSW5pdGlhbE1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFVwZGF0ZSBhYkF3YWtlIHNoYXJlZCB0YWcgbWFzay4KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2FiQXdha2UnLCBhd2FrZSwgJ3NoYXJlZCcpOwogICAgCiAgICBpZiAoYXdha2UpIHsKICAgICAgICBsZXQgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8/IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CgogICAgICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IHBvc2l0aW9uID0geyB4OiAwLCB5OiAwIH07CgogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJNYW5pZmVzdEJvdCh7IGRpbWVuc2lvbiwgcG9zaXRpb24gfSk7CgogICAgICAgIHNob3V0KCJvbkFCQXdha2UiLCB7IGRpbWVuc2lvbiwgcG9zaXRpb24sIGluaXRpYWwgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGRlc3Ryb3kobGlua3MuYWJCb3QpOwoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwogICAgICAgIHNob3V0KCJvbkFCU2xlZXAiKTsKICAgIH0KfScA0b3gBLDuAQV1dGlscwIEANG94ASTiAQo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycA0b3gBLDuAQtib3RfZmFjdG9yeQIEANG94AS6iAQo8J+Ul2M3OGFhNjYzLWQwNWMtNGVjNC1iYzJjLTI2ZmQ1MTU2MGI5NycA0b3gBLDuAQ9vbkFCSW5pdGlhbGl6ZWQCBADRveAE4YgErAFAbWFza3MuYWJJbml0aWFsaXplZCA9IHRydWU7DQoNCmlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsNCiAgICB0aGlzQm90Lm9uUG9ydGFsQ2hhbmdlZCh7cG9ydGFsOiAibWFwUG9ydGFsIiwgZGltZW5zaW9uOiBjb25maWdCb3QudGFncy5tYXBQb3J0YWwsIGluaXRpYWw6IHRydWUgfSk7DQp9JwDRveAEsO4BBWRlYnVnAgQA0b3gBI6KBAVmYWxzZScA0b3gBLDuARpnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbgIEANG94ASUigSpC0Bhc3luYyBmdW5jdGlvbiBnZXREZWZhdWx0TWFuaWZlc3RQb3NpdGlvbihwb3J0YWw6ICdtYXAnIHwgJ2dyaWQnKTogeyB4OiBudW1iZXIsIHk6IG51bWJlciB9IHsKICAgIGlmIChwb3J0YWwgPT09ICdncmlkJykgewogICAgICAgIHJldHVybiB7IHg6IDAsIHk6IDAgfQogICAgfSBlbHNlIGlmIChwb3J0YWwgPT09ICdtYXAnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbj8ueCA9PT0gJ251bWJlcicgJiYgIHR5cGVvZiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFpvb21Qb3NpdGlvbj8ueSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgcmV0dXJuIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwWm9vbVBvc2l0aW9uOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxldCBjdXJyZW50UG9zaXRpb24gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIGxldCBoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24gPSBhd2FpdCBsaW5rcy51dGlscy5oYXNHZW9sb2NhdGlvblBlcm1pc3Npb24oKTsKCiAgICAgICAgICAgIC8vIEN1cnJlbnQgd29yay1hcm91bmQgZm9yIGFsbG93aW5nIGdlb2xvY2F0aW9uIGZvciBpT1MgYXBwCiAgICAgICAgICAgIGlmIChnZXRCb3QoInN5c3RlbSIsICJhYi5pb3NicmlkZ2UubWVzc2VuZ2VyIikpIHsKICAgICAgICAgICAgICAgIGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbiA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24pIHsKICAgICAgICAgICAgICAgIGNvbnN0IGdlb2xvY2F0aW9uID0gYXdhaXQgb3MuZ2V0R2VvbG9jYXRpb24oKTsKICAgICAgICAgICAgICAgIGlmIChnZW9sb2NhdGlvbi5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBvc2l0aW9uID0geyB4OiBnZW9sb2NhdGlvbi5sb25naXR1ZGUsIHk6IGdlb2xvY2F0aW9uLmxhdGl0dWRlIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGN1cnJlbnRQb3NpdGlvbikgewogICAgICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRQb3NpdGlvbjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEdSUE0gUG9zaXRpb24KICAgICAgICAgICAgICAgIHJldHVybiB7IHg6IC04NS42NzYxODk0ODIyNDM0LCB5OiA0Mi45NjU2NzU2NzU2NzU2IH07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bnJlY29uZ2l6ZWQgcG9ydGFsIHR5cGUgcHJvdmlkZWQgdG8gZ2V0RGVmYXVsdE1hbmlmZXN0UG9zaXRpb246YCwgcG9ydGFsKTsKICAgICAgICByZXR1cm4geyB4OiAwLCB5OiAwIH0KICAgIH0KfQoKcmV0dXJuIGdldERlZmF1bHRNYW5pZmVzdFBvc2l0aW9uKHRoYXQpOycA0b3gBLDuARJnZXRTdGFydENhbWVyYVpvb20CBADRveAEvpUEkARAYXN5bmMgZnVuY3Rpb24gZ2V0U3RhcnRDYW1lcmFab29tKHBvcnRhbDogJ21hcCcgfCAnZ3JpZCcpOiBudW1iZXIgfCBudWxsIHsKICAgIGlmIChwb3J0YWwgPT09ICdncmlkJykgewogICAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIGlmIChwb3J0YWwgPT09ICdtYXAnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBsaW5rcy5yZW1lbWJlci50YWdzLm1hcFN0YXJ0Wm9vbSA9PT0gJ251bWJlcicpIHsKICAgICAgICAgICAgcmV0dXJuIGxpbmtzLnJlbWVtYmVyLnRhZ3MubWFwU3RhcnRab29tOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVucmVjb25naXplZCBwb3J0YWwgdHlwZSBwcm92aWRlZCB0byBnZXRTdGFydENhbWVyYVpvb206YCwgcG9ydGFsKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0KfQoKcmV0dXJuIGdldFN0YXJ0Q2FtZXJhWm9vbSh0aGF0KTsnANG94ASw7gEUZGVmYXVsdE1hcFBvcnRhbFpvb20CBADRveAEz5kEBDEwMDAnANG94ASw7gEQb25BQkJlZm9yZVVwZGF0ZQIEANG94ATUmQQ2QGNvbmZpZ0JvdC50YWdzLmFiV2FzQXdha2VCZWZvcmVVcGRhdGUgPSB0YWdzLmFiQXdha2U7JwDRveAEsO4BC29uQUJVcGRhdGVkAgQA0b3gBIuaBI8BQGlmIChjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlKSB7CiAgICBjb25maWdCb3QudGFncy5hYldhc0F3YWtlQmVmb3JlVXBkYXRlID0gbnVsbDsKICAgIGF3YWl0IHRoaXNCb3QuYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlIH0pCn0nANG94ASw7gEVZGVmYXVsdEdyaWRQb3J0YWxab29tAgQA0b3gBJubBAIyMCcA0b3gBLDuAQlvbkFCQXdha2UCBADRveAEnpsEwgFAY29uc3QgeyBkaW1lbnNpb24sIHBvc2l0aW9uLCBpbml0aWFsIH0gPSB0aGF0OwoKaWYgKGluaXRpYWwgJiYgY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCA9PT0gZGltZW5zaW9uKSB7CiAgICBvcy5mb2N1c09uKHBvc2l0aW9uLCB7IHpvb206IHRhZ3MuZGVmYXVsdEdyaWRQb3J0YWxab29tLCBwb3J0YWw6ICdncmlkUG9ydGFsJyB9KTsKfQA="}]}