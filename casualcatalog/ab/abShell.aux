{"version":2,"updates":[{"id":0,"timestamp":1772040365883,"update":"Ab0EgoacFQAnAQRib3RzJDAyODM2NWE0LTAzNmYtNDFkMC05YWYxLTcxNWFkNGYyYWE3YQEnAIKGnBUABnN5c3RlbQIEAIKGnBUBDWFiLnNoZWxsLmdyaWQnAIKGnBUABGZvcm0CBACChpwVDwdub3RoaW5nJwCChpwVAAxvbkFueUJvdERyYWcCBACChpwVF7sBQC8vY29udHJvbHMgZ3JpZCBzbmFwCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZFNuYXBTdGF0ZSkKewogICAgb3MuYWRkRHJvcFNuYXAoImdyaWQiKTsKfQoKLy9jb250cm9scyBib3Qgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkJvdFNuYXBTdGF0ZSkKewogICAgb3MuYWRkRHJvcFNuYXAoImZhY2UiKTsKfScAgoacFQAIcmVtZW1iZXICBACChpwV0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAgoacFQAIYWJJZ25vcmUCBACChpwV+gEEdHJ1ZScAgoacFQAHYWJTaGVsbAIEAIKGnBX/AQR0cnVlJwCChpwVAAlhYlZlcnNpb24CBACChpwVhAIFMTAuNDMnAIKGnBUABWZvY3VzAgQAgoacFYoCqwRALy9zaG91dCgiZm9jdXMiLCB7Ym90OiBib3QsIHBvc2l0aW9uOnt4OiB4LCB5OiB5fX0pOwoKY29uc3QgZm9jdXNUeXBlID0gdGhhdC5ib3QgPyAiYm90IiA6ICJwb3NpdGlvbiI7CmNvbnN0IGR1cmF0aW9uID0gdGhhdC5kdXJhdGlvbjsKY29uc3Qgem9vbSA9IHRoYXQuem9vbSA/PyBjb25maWdCb3QudGFncy5tYXBQb3J0YWwgPyAyMDAwIDogMTA7CmNvbnN0IHJvdGF0aW9uID0gdGhhdC5yb3RhdGlvbiA/PyB7eDogNDUsIHk6IDQ1fTsKY29uc3QgZWFzaW5nID0gdGhhdC5lYXNpbmcgPz8ge3R5cGU6ICJsaW5lYXIiLCBtb2RlOiAiaW5vdXQifTsKY29uc3QgZm9jdXNPcHRpb25zID0gewogICAgem9vbTogem9vbSwKICAgIHJvdGF0aW9uOiByb3RhdGlvbiwKICAgIGVhc2luZzogZWFzaW5nLAogICAgZHVyYXRpb246IGR1cmF0aW9uCn07CgppZiAoZm9jdXNUeXBlID09ICJib3QiKQp7CiAgICBhd2FpdCBvcy5mb2N1c09uKHRoYXQuYm90LCBmb2N1c09wdGlvbnMpCn0KZWxzZQp7CiAgICBhd2FpdCBvcy5mb2N1c09uKHRoYXQucG9zaXRpb24sIGZvY3VzT3B0aW9ucyk7Cn0nAQRib3RzJDExYzk1YzdkLWExOTMtNDAwZS1iNzEwLTNiYTA0ODZhNmExYQEnAIKGnBW2BgZzeXN0ZW0CBACChpwVtwYTYWIuc2hlbGwuY29tcG9uZW50cycAgoacFbYGDEFwcENvbnRhaW5lcgIEAIKGnBXLBsUEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfSAvPgogICAgICAgICAgICA8ZGl2PntjaGlsZHJlbn08L2Rpdj4KICAgICAgICA8Lz4KICAgICkKfQoKcmV0dXJuIEFwcENvbnRhaW5lcjsnAIKGnBW2BghUZXh0TGluawIEAIKGnBWRC6kDQGNvbnN0IFRleHRMaW5rID0gKHsKICAgIG9uQ2xpY2ssCiAgICBjaGlsZHJlbiwKfSkgPT4gewogICAgcmV0dXJuICgKICAgICAgICA8c3BhbiAKICAgICAgICAgICAgY2xhc3NOYW1lPSdhYi1hcHAtdGV4dC1saW5rIGJvbGQnIAogICAgICAgICAgICBvbkNsaWNrPXtvbkNsaWNrfQogICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgLy8gJy0tYWItYXBwLXRleHQtbGluay1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICAgICAgICAgICAgICAvLyAnLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yJzogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJsdWVwcmludENvbG9yCiAgICAgICAgICAgIH19CiAgICAgICAgPntjaGlsZHJlbn08L3NwYW4+CiAgICApCn0KCnJldHVybiBUZXh0TGluazsnAIKGnBW2BgZXaW5kb3cCBACChpwVuw62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAIKGnBW2BgxUZXh0TGluay5jc3MCBACChpwV8hDtAS5hYi1hcHAtdGV4dC1saW5rIHsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1jb2xvciwgcmdiKDcxIDI1NSAxMzcpKTsKfQoKLmFiLWFwcC10ZXh0LWxpbms6aG92ZXIgewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvciwgcmdiKDAgMTkyIDI1NSkpOwp9CgouYWItYXBwLXRleHQtbGluay5ib2xkIHsKICBmb250LXdlaWdodDogYm9sZDsKfScAgoacFbYGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAIKGnBXgEnEuYWItYXBwLWJnIHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMCwgMCwgMC4zMyk7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKfScAgoacFbYGCldpbmRvdy5jc3MCBACChpwV0hOoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAIKGnBW2BghyZW1lbWJlcgIEAIKGnBX7Fijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCChpwVtgYIYWJJZ25vcmUCBACChpwVohcEdHJ1ZScAgoacFbYGB2FiU2hlbGwCBACChpwVpxcEdHJ1ZScAgoacFbYGCWFiVmVyc2lvbgIEAIKGnBWsFwUxMC40MycAgoacFbYGC3BlcnNvbmFsaXR5AgQAgoacFbIXKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYgEnAIKGnBXZFwdBcHAuY3NzAgQAgoacFdoXyhY6cm9vdCB7CiAgLS1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIC0tb24tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAtLWFiLWNvbnNvbGUtaGVpZ2h0OiAzM3ZoOwp9Ci8qIERhcmsgbW9kZSBzdXBwb3J0ICovCkBtZWRpYSAocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIHsKICA6cm9vdCB7CiAgICAtLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgICAtLW9uLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgfQp9CgouYWItY29uc29sZS1idG4gewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogaW5oZXJpdDsKICBsZXR0ZXItc3BhY2luZzogaW5oZXJpdDsKICBsaW5lLWhlaWdodDogaW5oZXJpdDsKICB0ZXh0LXRyYW5zZm9ybTogaW5oZXJpdDsKICB0ZXh0LWluZGVudDogaW5oZXJpdDsKICB0ZXh0LXNoYWRvdzogaW5oZXJpdDsKICBiYWNrZ3JvdW5kLWNvbG9yOiBpbmhlcml0OwogIG1hcmdpbjogaW5oZXJpdDsKICBwYWRkaW5nLWJsb2NrOiBpbmhlcml0OwogIHBhZGRpbmctaW5saW5lOiBpbmhlcml0OwogIGJvcmRlcjogbm9uZTsKICB0cmFuc2Zvcm06IHNjYWxlKDEuMik7Cn0KCi5hYi1jb25zb2xlIHsKICB3aWR0aDogMTAwdnc7CiAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICBwYWRkaW5nOiAwOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCkgYnJpZ2h0bmVzcygyMDAlKTsKICBhbmltYXRpb24tbmFtZTogc2xpZGUtYXBwLWluOwogIGFuaW1hdGlvbi1kdXJhdGlvbjogMC41czsKICBvdmVyZmxvdy15OiBoaWRkZW47CiAgei1pbmRleDogMTsKfQoKLmFiLWNvbnNvbGU6OmFmdGVyIHsKICBjb250ZW50OiAiIjsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgdG9wOiAwOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgYm90dG9tOiAwOwogIG9wYWNpdHk6IDAuOTsKICB6LWluZGV4OiAwOwp9CgpAa2V5ZnJhbWVzIHNsaWRlLWFwcC1pbiB7CiAgZnJvbSB7CiAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBjdWJpYy1iZXppZXIoLjYsMCwuNzksMS4wMyk7CiAgICAvKiB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMTEwJSk7ICovCiAgICAvKiBoZWlnaHQ6IDBweDsgKi8KICAgIC8qIG1pbi1oZWlnaHQ6IDBweDsgKi8KICAgIG1heC1oZWlnaHQ6IDBweDsKICB9CgogIHRvIHsKICAgIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICAgIC8qIG1pbi1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsgKi8KICB9Cn0KCi5hYi1jb25zb2xlID4gZGl2IHsKICB6LWluZGV4OiAxOwogIHBvc2l0aW9uOiByZWxhdGl2ZQp9CgouYWItY29uc29sZS10b3AtYmFyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICB3aWR0aDogMTAwJTsKICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgZGlzcGxheTogZmxleDsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGp1c3RpZnktY29udGVudDogZW5kOwogIHBhZGRpbmc6IDAuNXJlbTsKfQoKLmFiLWNvbnNvbGUtbG9nIHsKICBvdmVyZmxvdy15OiBhdXRvOwogIGZsZXgtZ3JvdzogMTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW4tcmV2ZXJzZTsKICBtaW4taGVpZ2h0OiAyNHB4OwogIHBhZGRpbmc6IDAgMXJlbTsKICBjdXJzb3I6IHBvaW50ZXI7CiAgb3ZlcnNjcm9sbC1iZWhhdmlvcjogY29udGFpbjsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgY3Vyc29yOiBpbml0aWFsOwp9CgouYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciB7CiAgbWFyZ2luOiAwLjVyZW0gMDsKfQouYWItY29uc29sZS1tZXNzYWdlIHsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiByb3c7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKfQoKLmFiLWNvbnNvbGUtc3BhY2VyIHsKICBmbGV4LXNocmluazogMDsKICBmbGV4LWdyb3c6IDE7Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIG1heC13aWR0aDogODB2dzsKICBib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5hYi1jb25zb2xlLXRpbWVzdGFtcCB7CiAgb3BhY2l0eTogMC42Owp9CgouY29uc29sZS1zZW5kLWJ0biB7CiAgbWFyZ2luOiAwICFpbXBvcnRhbnQ7CiAgcGFkZGluZzogMCAxcmVtICFpbXBvcnRhbnQ7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9CgouY29uc29sZS1zZW5kLWJ0biA+IHNwYW4gewogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgzcHgpCn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGdhcDogMC43NXJlbTsKICBtYXJnaW46IDAuNXJlbSAxcmVtOwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciA+IGlucHV0IHsKICBiYWNrZ3JvdW5kOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgZmxleC1ncm93OiAxOwogIG91dGxpbmU6IG5vbmU7CiAgYm9yZGVyOiBub25lOwogIHBhZGRpbmc6IDFyZW07CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9JwCChpwV2RcGZ2V0QXBwAgQAgoacFaUu3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwCChpwV2RcLaGlkZUNvbnNvbGUCBACChpwVg1KfAUB2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwptYXNrcy5vcGVuID0gZmFsc2U7CmdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSBudWxsOycAgoacFdkXA2xvZwIEAIKGnBWjU4UJQGxldCBib3RUYWdzID0ge307Cgpjb25zdCBfdGltZXN0YW1wID0gb3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZQoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgY29uc3QgX21lc3NhZ2VUZXh0ID0gU3RyaW5nKHRoYXQpLnNwbGl0KCc6ICcpOwogICAgY29uc3QgX25hbWUgPSBfbWVzc2FnZVRleHQuc2hpZnQoKTsKCiAgICBpZiAoIXRoYXQuaW5jbHVkZXMoJzogJykpIHsKICAgICAgICBib3RUYWdzID0gewogICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgIG5hbWU6ICIiLAogICAgICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiBfbmFtZSwKICAgICAgICAgICAgbWVzc2FnZTogX21lc3NhZ2VUZXh0LmpvaW4oJzogJyksCiAgICAgICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICAgICAgdGltZXN0YW1wOiBfdGltZXN0YW1wLAogICAgICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiCiAgICAgICAgfQogICAgfQoKfSBlbHNlIHsKICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiLAogICAgICAgIC4uLnRoYXQKICAgIH0KfQoKY29uc3QgbG9nQm90ID0gYXdhaXQgY3JlYXRlKGJvdFRhZ3MpOwoKc2hvdXQoIm9uQUJMb2ciLCBsb2dCb3QpOwoKaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAIKGnBXZFwtzaG93Q29uc29sZQIEAIKGnBWpXO0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAgoacFdkXBnN5c3RlbQIEAIKGnBWXYBBhYi5zaGVsbC5jb25zb2xlJwCChpwV2RcNdG9nZ2xlQ29uc29sZQIEAIKGnBWoYJYBQGlmIChtYXNrcy5vcGVuKSB7CiAgICB3aGlzcGVyKHRoaXNCb3QsICJoaWRlQ29uc29sZSIpOwogICAgbWFza3Mub3BlbiA9IGZhbHNlOwp9IGVsc2UgewogICAgd2hpc3Blcih0aGlzQm90LCAic2hvd0NvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSB0cnVlOwp9JwCChpwV2RcEZm9ybQIEAIKGnBW/YQdub3RoaW5nJwCChpwV2RcHYWJTaGVsbAIEAIKGnBXHYQR0cnVlJwCChpwV2RcKYWJJRE9yaWdpbgIEAIKGnBXMYRVhYkNvbnNvbGUgdXBkYXRlIDctMTYnAIKGnBXZFwZUb3BCYXICBACChpwV4mHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAgoacFdkXDXNob3dDaGF0SW5wdXQCBACChpwV1mYFZmFsc2UnAIKGnBXZFwpzaG93VG9wQmFyAgQAgoacFdxmBWZhbHNlJwCChpwV2RcJYWJWZXJzaW9uAgQAgoacFeJmBTEwLjQzJwCChpwV2RcSc2V0QWJFeHBhbmRDb25zb2xlAgQAgoacFehmlwJAY29uc29sZS5sb2codGhpc0JvdC52YXJzLnNldFNob3dBbGwpCmlmICh0eXBlb2YgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgIT09ICdmdW5jdGlvbicpIHsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQgPT09IHVuZGVmaW5lZCkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwocyA9PiAhcyk7Cn0gZWxzZSBpZiAodGhhdCA9PSB0cnVlKSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCh0cnVlKTsKfSBlbHNlIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKGZhbHNlKTsKfQonAIKGnBXZFwhhYklnbm9yZQIEAIKGnBWAaQR0cnVlJwCChpwV2RcHTWVzc2FnZQIEAIKGnBWFacEQQGNvbnN0IHsgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZUVmZmVjdCB9ID0gb3MuYXBwSG9va3MKY29uc3QgVG9wQmFyID0gdGhpc0JvdC5Ub3BCYXIoKQoKY29uc3QgTWVzc2FnZSA9ICh7IHRpbWVzdGFtcCwgbWVzc2FnZSwgbmFtZSB9KSA9PiB7CiAgICBjb25zdCBbc2hvd1RpbWUsIHNldFNob3dUaW1lXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IFt1c2VyTWVzc2FnZSwgc2V0VXNlck1lc3NhZ2VdID0gdXNlU3RhdGUoZmFsc2UpOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGF1dGhCb3QgJiYgYXV0aEJvdC50YWdzLm5hbWUpIHsKICAgICAgICAgICAgaWYgKGF1dGhCb3QudGFncy5uYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChtYXNrcy5wcmVmZXJyZWROYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobmFtZSA9PSAidXNlciIgfHwgbmFtZSA9PSAiVXNlciIpIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UoZmFsc2UpOwogICAgICAgIH0KCiAgICB9LCBbbmFtZV0pCgogICAgY29uc3QgdGltZVRleHQgPSB1c2VNZW1vKAogICAgICAgICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aW1lc3RhbXApIHsgcmV0dXJuIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoCiAgICAgICAgICAgICAgICAgICAnZW4tdXMnLCB7dGltZVN0eWxlOiAnbWVkaXVtJ30pfSwKICAgICAgICBbdGltZXN0YW1wXQogICAgKTsKCiAgICBpZiAoIXRpbWVzdGFtcCB8fCAhbWVzc2FnZSkgeyByZXR1cm4gPD48Lz4gfQoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoKSA9PiBzZXRTaG93VGltZSh0cnVlKX0KICAgICAgICAgICAgb25Qb2ludGVyTGVhdmU9eygpID0+IHNldFNob3dUaW1lKGZhbHNlKX0KICAgICAgICA+CiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIHN0eWxlPXt1c2VyTWVzc2FnZSAmJiB7dGV4dEFsaWduOiAncmlnaHQnfX0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAge25hbWV9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlIiBzdHlsZT17ewogICAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3JvdycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ3Jvdy1yZXZlcnNlJwogICAgICAgICAgICB9fT4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXNwYWNlciIKICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0QWxpZ246IHVzZXJNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncmlnaHQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnbGVmdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHNob3dUaW1lID8gMC42IDogMAogICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAge3RpbWVUZXh0fQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1jb250ZW50Ij57bWVzc2FnZX08L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBNZXNzYWdlOycAgoacFdkXEG9uQW55Qm90c1JlbW92ZWQCBACChpwVx3mtAkBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3RJZCBvZiBib3RJRHMpIHsNCiAgICBpZiAodGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgY29uc3QgZGVsZXRlZCA9IHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmRlbGV0ZShib3RJZCk7DQoNCiAgICAgICAgaWYgKGRlbGV0ZWQpIHsNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdElkOiBib3RJZCB9KTsNCiAgICAgICAgfQ0KICAgIH0NCn0nAIKGnBXZFw5vbkFueUJvdHNBZGRlZAIEAIKGnBX1e/gDQGNvbnN0IHsgYm90cyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBuZXdCb3Qgb2YgYm90cykgew0KICAgIGlmIChuZXdCb3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMobmV3Qm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKG5ld0JvdC5pZCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IG5ld0JvdCB9KTsNCiAgICB9DQp9JwCChpwV2RcQb25BbnlCb3RzQ2hhbmdlZAIEAIKGnBXuf4YGQGNvbnN0IGNoYW5nZXMgPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IGNoYW5nZSBvZiBjaGFuZ2VzKSB7DQogICAgaWYgKGNoYW5nZT8uYm90Py50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhjaGFuZ2UuYm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKGNoYW5nZS5ib3QuaWQpOw0KDQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBjaGFuZ2UuYm90IH0pOw0KICAgICAgICB9IA0KDQogICAgICAgIGlmIChjaGFuZ2UudGFncy5pbmNsdWRlcygibWVzc2FnZSIpIHx8IGNoYW5nZS50YWdzLmluY2x1ZGVzKCJuYW1lIikgfHwgY2hhbmdlLnRhZ3MuaW5jbHVkZXMoInRpbWVzdGFtcCIpIHx8IGNoYW5nZS50YWdzLmluY2x1ZGVzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIpKSB7DQogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOyAgICAgICAgDQogICAgICAgIH0NCiAgICB9DQp9JwCChpwV2Rcfb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZAIEAIKGnBX1hQE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwCChpwV2Rcdb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQCBACChpwVrIYBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycBBGJvdHMkMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjAScAgoacFeOGAQZzeXN0ZW0CBACChpwV5IYBDWFiLnNoZWxsLmhlbHAnAIKGnBXjhgEJb25LZXlEb3duAgQAgoacFfKGAYgCQGlmICh0YWdzLmFjdGl2ZSAmJiB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICBmb3IgKGxldCBjYWxsYmFjayBvZiB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9JwCChpwV44YBB3VubW91bnQCBACChpwV+4gBjgFAYXdhaXQgb3MuY29tcGlsZUFwcCh0YWdzLmFwcElkLCA8PjwvPik7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAodGFncy5hcHBJZCk7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IHVuZGVmaW5lZDsKbWFza3MuYWN0aXZlID0gZmFsc2U7JwCChpwV44YBCXN0eWxlLmNzcwIEAIKGnBWKigHxBy5oZWxwLXRhYmxlIHsKICB3aWR0aDogMTAwJTsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLmhlbHAtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5oZWxwLXRhYmxlIHRkIGgzIHsKICBtYXJnaW46IDA7Cn0KCi5oZWxwLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9Cgouc2VjdGlvbiB7CiAgbWFyZ2luLXRvcDogMTZweDsKfQoKLnNlY3Rpb24gcDpmaXJzdC1vZi10eXBlIHsKICBtYXJnaW4tdG9wOiA0cHg7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5kZXNjcmlwdGlvbiB7IAogIHdoaXRlLXNwYWNlOiBwcmUtbGluZTsKfQoKLnVzYWdlLXRhYmxlIHsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLnVzYWdlLXRhYmxlIHRkLGgzIHsgCiAgdmVydGljYWwtYWxpZ246IHRvcDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgbWFyZ2luOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogNjBweDsKfQoKLmFyZ3MtdGFibGUgewogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouYXJncy10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmFyZ3MtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCksIChtYXgtaGVpZ2h0OiA2MDBweCkgewogIC5oZWxwLXdpbmRvdyB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGxlZnQ6IHVuc2V0OwogICAgdG9wOiB1bnNldDsKICAgIHRyYW5zZm9ybTogdW5zZXQ7CiAgICBtYXgtd2lkdGg6IHVuc2V0OwogICAgbWF4LWhlaWdodDogdW5zZXQ7CiAgICBib3gtc2hhZG93OiB1bnNldDsKICB9Cn0nAIKGnBXjhgEJb25EZXN0cm95AgQAgoacFfyRARNAdGhpc0JvdC51bm1vdW50KCk7JwCChpwV44YBBW1vdW50AgQAgoacFZCSAfECQGNvbnN0IHsKICAgIGFiQ29tbWFuZHNNYW5hZ2VyLAogICAgc2VsZWN0ZWRDb21tYW5kCn0gPSB0aGF0ID8/IHt9OwoKaWYgKG1hc2tzLmFjdGl2ZSkgewogICAgYXdhaXQgdGhpc0JvdC51bm1vdW50KCk7Cn0KCmNvbnN0IEFwcCA9IHRoaXNCb3QuQXBwKCk7Cgphd2FpdCBvcy5yZWdpc3RlckFwcCh0YWdzLmFwcElkLCB0aGlzQm90KTsKYXdhaXQgb3MuY29tcGlsZUFwcCh0YWdzLmFwcElkLCA8QXBwIGNvbW1hbmRzPXthYkNvbW1hbmRzTWFuYWdlci5jb21tYW5kc30gaW5pdGlhbFNlbGVjdGVkQ29tbWFuZD17c2VsZWN0ZWRDb21tYW5kfS8+KTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gW107Cm1hc2tzLmFjdGl2ZSA9IHRydWU7JwCChpwV44YBCmNvbXBvbmVudHMCBACChpwVgpUBKPCflJcxMWM5NWM3ZC1hMTkzLTQwMGUtYjcxMC0zYmEwNDg2YTZhMWEnAIKGnBXjhgEFdXRpbHMCBACChpwVqZUBKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAIKGnBXjhgEIYWJJZ25vcmUCBACChpwV0JUBBHRydWUnAIKGnBXjhgEHYWJTaGVsbAIEAIKGnBXVlQEEdHJ1ZScAgoacFeOGAQlhYlZlcnNpb24CBACChpwV2pUBBTEwLjQzJwCChpwV44YBA0FwcAIEAIKGnBXglQGyL0Bjb25zdCBBcHBDb250YWluZXIgPSBsaW5rcy5jb21wb25lbnRzLkFwcENvbnRhaW5lcigpOwpjb25zdCBXaW5kb3cgPSBsaW5rcy5jb21wb25lbnRzLldpbmRvdygpOwpjb25zdCBUZXh0TGluayA9IGxpbmtzLmNvbXBvbmVudHMuVGV4dExpbmsoKTsKY29uc3QgY3NzID0gbGlua3MudXRpbHMuYWJDb21waWxlQ1NTKFsgdGhpc0JvdCwgbGlua3MuY29tcG9uZW50cyBdKTsKCmNvbnN0IHsgdXNlU3RhdGUsIHVzZUVmZmVjdCwgdXNlQ2FsbGJhY2ssIHVzZVJlZiwgdXNlTWVtbyB9ID0gb3MuYXBwSG9va3M7CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKi8KY29uc3QgQXZhaWxhYmxlQ29tbWFuZHMgPSAoeyBjb21tYW5kcywgb25Db21tYW5kQ2xpY2sgfSkgPT4gewogICAgY29uc3QgY29tbWFuZE5hbWVzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpLnNvcnQoKTsKCiAgICBjb25zdCBvbkNsb3NlID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkNsb3NlfT57J3ggQ2xvc2UnfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+QXZhaWxhYmxlIENvbW1hbmRzPC9oMj4KICAgICAgICAgICAgPHA+VXNhZ2U6IC5jb21tYW5kIFtvcHRpb25zXTwvcD4KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgICAgICB7Y29tbWFuZE5hbWVzLm1hcCgobmFtZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSBjb21tYW5kc1tuYW1lXTsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxUZXh0TGluayBvbkNsaWNrPXsoKSA9PiBvbkNvbW1hbmRDbGljayhjb21tYW5kLm5hbWUpfT57Y29tbWFuZC5uYW1lfTwvVGV4dExpbms+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57ZGVzY3JpcHRpb259PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICA8Lz4KICAgICkKfQoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge0NvbW1hbmR9IHByb3BzLmNvbW1hbmQKICovCmNvbnN0IFNwZWNpZmljQ29tbWFuZCA9ICh7IGNvbW1hbmQsIG9uQmFjayB9KSA9PiB7CiAgICBsZXQgdXNhZ2UgPSAnJzsKICAgIGxldCBkZXNjcmlwdGlvbiA9IG51bGw7CiAgICBsZXQgYXJncyA9IG51bGw7CgogICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgIGlmIChjb21tYW5kLmhlbHAudXNhZ2UpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29tbWFuZC5oZWxwLnVzYWdlKSkgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2Uuam9pbignXG4nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVzYWdlID0gY29tbWFuZC5oZWxwLnVzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5sb25nRGVzY3JpcHRpb247CiAgICAgICAgfSBlbHNlIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzICYmIGNvbW1hbmQuaGVscC5hcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgYXJncyA9IGNvbW1hbmQuaGVscC5hcmdzOwogICAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuICgKICAgICAgICA8PiAgCiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkJhY2t9PnsnPCBCYWNrJ308L1RleHRMaW5rPjwvcD4KICAgICAgICAgICAgPGgyPntjb21tYW5kLm5hbWV9PC9oMj4KICAgICAgICAgICAgeyB1c2FnZSAmJgogICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0ndXNhZ2UtdGFibGUnPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxoMz5Vc2FnZTo8L2gzPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57dXNhZ2V9PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGRlc2NyaXB0aW9uICYmIAogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5EZXNjcmlwdGlvbjo8L2gzPgogICAgICAgICAgICAgICAgICAgIDxwIGNsYXNzTmFtZT0nZGVzY3JpcHRpb24nPntkZXNjcmlwdGlvbn08L3A+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGFyZ3MgJiYKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uJz4KICAgICAgICAgICAgICAgICAgICA8aDM+QXJndW1lbnRzOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0nYXJncy10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgICAgIHsgYXJncy5tYXAoKGFyZykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcmcuaWRlbnRpZmllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ0Rlc2NyaXB0aW9uRGlzcGxheSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllci5qb2luKCcsXG4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLmRlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gYXJnLmRlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2FyZ0lkZW50aWZpZXJEaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnRGVzY3JpcHRpb25EaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgfSl9CiAgICAgICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIDxici8+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2hlbHAtdGFibGUnPgogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKiBAcGFyYW0ge2FueVtdfSBbcHJvcHMuYXJnc10KICovCmNvbnN0IEFwcCA9ICh7IGNvbW1hbmRzLCBpbml0aWFsU2VsZWN0ZWRDb21tYW5kIH0pID0+IHsKICAgIGNvbnN0IFsgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmQgXSA9IHVzZVN0YXRlKGluaXRpYWxTZWxlY3RlZENvbW1hbmQpOwoKICAgIC8vIEVzY2FwZSBrZXkgcHJlc3MgZXZlbnQgaGFuZGxlcgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBjb25zdCBvbkVzY2FwZUtleVByZXNzID0gKCkgPT4gewogICAgICAgICAgICBpZiAoc2VsZWN0ZWRDb21tYW5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5wdXNoKG9uRXNjYXBlS2V5UHJlc3MpOwoKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBjb25zdCBjYWxsYmFja0luZGV4ID0gdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MuZmluZEluZGV4KChjYWxsYmFjaykgPT4gY2FsbGJhY2sgPT09IG9uRXNjYXBlS2V5UHJlc3MpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5zcGxpY2UoY2FsbGJhY2tJbmRleCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBbc2VsZWN0ZWRDb21tYW5kXSk7CiAgICAKICAgIGNvbnN0IG9uQmFja2dyb3VuZENsaWNrID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwoKICAgIGNvbnN0IG9uQ29tbWFuZENsaWNrID0gdXNlQ2FsbGJhY2soKG5hbWUpID0+IHsKICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobmFtZSk7CiAgICB9LCBbc2V0U2VsZWN0ZWRDb21tYW5kXSkKCiAgICBjb25zdCBjb250ZW50ID0gdXNlTWVtbygoKSA9PiB7CiAgICAgICAgaWYgKCFzZWxlY3RlZENvbW1hbmQpIHsKICAgICAgICAgICAgcmV0dXJuIDxBdmFpbGFibGVDb21tYW5kcyBjb21tYW5kcz17Y29tbWFuZHN9IG9uQ29tbWFuZENsaWNrPXtvbkNvbW1hbmRDbGlja30vPgogICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICByZXR1cm4gPFNwZWNpZmljQ29tbWFuZCBjb21tYW5kPXtjb21tYW5kc1tzZWxlY3RlZENvbW1hbmRdfSBvbkJhY2s9eygpID0+IHNldFNlbGVjdGVkQ29tbWFuZChudWxsKX0vPgogICAgICAgIH0KICAgIH0sIFtjb21tYW5kcywgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmRdKTsKCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxzdHlsZT57Y3NzfTwvc3R5bGU+CgogICAgICAgICAgICA8QXBwQ29udGFpbmVyIG9uQmFja2dyb3VuZENsaWNrPXtvbkJhY2tncm91bmRDbGlja30+CiAgICAgICAgICAgICAgICA8V2luZG93PgogICAgICAgICAgICAgICAgICAgIHtjb250ZW50fQogICAgICAgICAgICAgICAgPC9XaW5kb3c+CiAgICAgICAgICAgIDwvQXBwQ29udGFpbmVyPgogICAgICAgIDwvPgogICAgKQp9CgpyZXR1cm4gQXBwOycAgoacFeOGAQVhcHBJZAIEAIKGnBWTxQEPYWItY29tbWFuZC1oZWxwJwEEYm90cyQzMTViZTRkZS1mOTYwLTQ0MDgtODEzMi04MWQ5MjU2Y2RmOWMBJwCChpwVo8UBCm9uQm90QWRkZWQCBACChpwVpMUB0QxALyoqCiAqIExpc3RlbmVyU3RyaW5nIGlzIGEgZnVuY3Rpb24gdGhhdCBjYW4gdHVybiBhbnkgZnVuY3Rpb24gaW50byBhIENhc3VhbE9TIGxpc3RlbmVyIHRhZyBzdHJpbmcuCiAqLwpmdW5jdGlvbiBMaXN0ZW5lclN0cmluZyhmdW5jKSB7CiAgICBpZiAodHlwZW9mIGZ1bmMgPT09ICdzdHJpbmcnICYmIGZ1bmNbMF0gPT09ICdAJykgewogICAgICAgIC8vIElzIGFscmVhZHkgYSBsaXN0ZW5lciBzdHJpbmcuCiAgICAgICAgcmV0dXJuIGRlZGVudChmdW5jKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGZ1bmMgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYExpc3RlbmVyU3RyaW5nIGNhbiBvbmx5IGNvbnZlcnQgZnVuY3Rpb24gb2JqZWN0cyB0byBzdHJpbmdzLmApOwogICAgfQoKICAgIGNvbnN0IGZ1bmNTdHJpbmcgPSBmdW5jLnRvU3RyaW5nKCk7CiAgICAKICAgIGlmIChmdW5jU3RyaW5nLmluY2x1ZGVzKCc9PicpKSB7CiAgICAgICAgLy8gSGFuZGxlIGFycm93IGZ1bmN0aW9ucwogICAgICAgIGNvbnN0IGFycm93SW5kZXggPSBmdW5jU3RyaW5nLmluZGV4T2YoJz0+Jyk7CiAgICAgICAgY29uc3QgYWZ0ZXJBcnJvdyA9IGZ1bmNTdHJpbmcuc3Vic3RyaW5nKGFycm93SW5kZXggKyAyKS50cmltKCk7CiAgICAgICAgCiAgICAgICAgaWYgKGFmdGVyQXJyb3cuc3RhcnRzV2l0aCgneycpKSB7CiAgICAgICAgICAgIC8vIEFycm93IGZ1bmN0aW9uIHdpdGggYmxvY2sgYm9keQogICAgICAgICAgICBjb25zdCBtYXRjaCA9IGFmdGVyQXJyb3cubWF0Y2goL1x7KFtcc1xTXSopXH0vKTsKICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVkZW50KCdAJyArIG1hdGNoWzFdLnRyaW0oKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBBcnJvdyBmdW5jdGlvbiB3aXRoIGNvbmNpc2UgYm9keQogICAgICAgICAgICByZXR1cm4gZGVkZW50KCdAJyArIGFmdGVyQXJyb3cpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSGFuZGxlIHJlZ3VsYXIgZnVuY3Rpb25zCiAgICAgICAgY29uc3QgbWF0Y2ggPSBmdW5jU3RyaW5nLm1hdGNoKC9ceyhbXHNcU10qKVx9Lyk7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiBkZWRlbnQoJ0AnICsgbWF0Y2hbMV0udHJpbSgpKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIEV4dGVuZCBGdW5jdGlvbiBwcm90b3R5cGUgdG8gaW5jbHVkZSBhIC50b0xpc3RlbmVyU3RyaW5nKCkgZnVuY3Rpb24uCi8vIE5vdyB5b3UgY2FuIGNhbGwgLnRvTGlzdGVuZXJTdHJpbmcoKSBvbiBhbnkgZnVuY3Rpb24gYW5kIGhhdmUgaXQgY29udmVydGVkIHRvIGEgbGlzdGVuZXIgc3RyaW5nLgpPYmplY3QuZGVmaW5lUHJvcGVydHkoRnVuY3Rpb24ucHJvdG90eXBlLCAndG9MaXN0ZW5lclN0cmluZycsIHsKICAgIHZhbHVlOiBmdW5jdGlvbigpIHsgcmV0dXJuIExpc3RlbmVyU3RyaW5nKHRoaXMpIH0sCiAgICB3cml0YWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGVudW1lcmFibGU6IGZhbHNlLAp9KTsKCmdsb2JhbFRoaXMuTGlzdGVuZXJTdHJpbmcgPSBMaXN0ZW5lclN0cmluZzsnAIKGnBWjxQEJb25EZXN0cm95AgQAgoacFfbRAU5AZGVsZXRlIGdsb2JhbFRoaXMuTGlzdGVuZXJTdHJpbmc7CmRlbGV0ZSBGdW5jdGlvbi5wcm90b3R5cGUudG9MaXN0ZW5lclN0cmluZzsnAIKGnBWjxQEGc3lzdGVtAgQAgoacFcXSARhhYi5zaGVsbC5saXN0ZW5lcl9zdHJpbmcnAIKGnBWjxQEIYWJJZ25vcmUCBACChpwV3tIBBHRydWUnAIKGnBWjxQEHYWJTaGVsbAIEAIKGnBXj0gEEdHJ1ZScAgoacFaPFAQlhYlZlcnNpb24CBACChpwV6NIBBTEwLjQzJwEEYm90cyQzNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMBJwCChpwV7tIBBnN5c3RlbQIEAIKGnBXv0gEPYWIuc2hlbGwuY3JlYXRlJwCChpwV7tIBBGZvcm0CBACChpwV/9IBB25vdGhpbmcnAIKGnBXu0gELZGVzY3JpcHRpb24CBACChpwVh9MBPUJvdCB1c2VkIHRvIGNyZWF0ZS9tYW5pZmVzdCBib3RzIGludG8gYW4gYWN0dWFsIHNjZW5lL3BvcnRhbC4nAIKGnBXu0gEMYWJDcmVhdGVCb3RzAgQAgoacFcXTAfcwQGxldCB7IAogICAgaW5pdGlhbEJvb3QsIC8vIGNoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4gKG9wdGlvbmFsKQogICAgYm90RGF0YSwgLy8gYm90cyB0byBiZSBnZW5lcmF0ZWQKICAgIG9yaWdpbiwgLy8gd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCiAgICBzdHVkaW8sIC8vIHdoYXQgc3R1ZGlvIGlzIHRoaXMgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgIHJlY29yZCwgLy8gUnlhbiBDb29rOiBkbyB3ZSBuZWVkIHRoaXMgaWYgd2UgYWxyZWFkeSBoYXZlIHN0dWRpbz8gKG9wdGlvbmFsKQogICAgdmVyc2lvbiwgLy8gdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCiAgICBlZ2dQYXJhbWV0ZXJzLCAvLyBkYXRhIHRvIHBhc3MgdG8gYWxsIGNyZWF0ZWQgYm90cyB2aWEgQG9uRWdnSGF0Y2guIChvcHRpb25hbCkKICAgIGlnbm9yZUdyaWRGb2N1cywgLy8gUnlhbiBDb29rOiBhZGRpbmcgdGhpcyBhcyBhbiBvcHRpb25hbCBmbGFnLiAob3B0aW9uYWwpCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIC8vIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIHRoZSBib3RzIGFyZSBjcmVhdGVkLiAob3B0aW9uYWwpCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsIHRvIGFiQ3JlYXRlQm90cy4gKG9wdGlvbmFsKS4KfSA9IHRoYXQ7CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBmb3Igd2hlbiBhYkNyZWF0ZUJvdHMgZXhwZWN0ZWQgImJvdHMiIHBhcmFtZXRlci4KaWYgKCFib3REYXRhICYmIHRoYXQuYm90cykgewogICAgYm90RGF0YSA9IHRoYXQuYm90czsKfQoKbGV0IGJvdENvdW50ID0gT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoOwpjb25zdCBib3REYXRhSGFzaE9yaWdpbmFsID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90RGF0YSk7CmNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCi8vIFJ1biBzb21lIGFiLXNwZWNpZmljIHByZXByb2Nlc3Npbmcgb2YgYm90IGRhdGEuCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIGRhdGEudGFncy5hYklET3JpZ2luID0gb3JpZ2luOwogICAgICAgIGRhdGEudGFncy5hYklEU3R1ZGlvID0gc3R1ZGlvOwoKICAgICAgICBpZiAoZGF0YS50YWdzLmNyZWF0b3IpIHsKICAgICAgICAgICAgZGF0YS50YWdzLm9sZENyZWF0b3IgPSBkYXRhLnRhZ3MuY3JlYXRvcjsKICAgICAgICB9CgogICAgICAgIC8vIFJ5YW4gQ29vazogVGhpcyB0YXJnZXRQb3NpdGlvbiBzdHVmZiBpcyBhcHBhcmVudGx5IHVzZWQgZm9yIGJvdCBwYXN0aW5nPyAKICAgICAgICAvLyBUaGlzIGlzIHNvbWUgcmVhbGx5IGNvbmZ1c2luZyBsb2dpYyBhbmQgc2hvdWxkIGJlIHJlZmFjdG9yZWQgZXZlbnR1YWxseS4KICAgICAgICBpZiAoKGJvdENvdW50IDwgMiB8fCBib3RDb3VudCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uICsgJ1gnXSA9IGFiR3JpZEZvY3VzLnBvc2l0aW9uLng7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWSddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueTsKICAgICAgICB9CiAgICB9Cn0KCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlYSBjcmVhdGVkLgpsZXQgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZScsIHByZXByb2Nlc3NBcmcpKTsKCmlmICh0eXBlb2YgYm90RGF0YSAhPT0gJ29iamVjdCcgfHwgT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICAvLyBUaGVyZSBpc24ndCBhbnkgYm90RGF0YSB0byBjcmVhdGUgZnJvbSEKICAgIHJldHVybjsKfQoKLy8gQ3JlYXRlIGJvdHMgZnJvbSB0aGUgYm90IGRhdGEuCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKbGV0IG5ld0JvdElkcyA9IFtdOwoKZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgIGNvbnN0IG5ld0JvdCA9IGNyZWF0ZShkYXRhLnRhZ3MpOwoKICAgICAgICAgICAgaWRNYXAuc2V0KGRhdGEuaWQsIG5ld0JvdC5pZCk7CiAgICAgICAgICAgIG5ld0JvdHMucHVzaChuZXdCb3QpOwogICAgICAgICAgICBuZXdCb3RJZHMucHVzaChuZXdCb3QuaWQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbnZhbGlkIGJvdGAsIGUpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGVkIGJvdDogYCwgZGF0YSk7CiAgICB9Cn0KCmlmIChuZXdCb3RzLmxlbmd0aCA+IDAgJiYgc291cmNlRXZlbnQgPT09ICdwYXN0ZScpIHsKICAgIGFiLmxpbmtzLnNvdW5kLmFiUGxheVNvdW5kKHsgdmFsdWU6IGFiLmxpbmtzLnNvdW5kLnRhZ3MuZGVmYXVsdENyZWF0ZVNvdW5kIH0pCn0KCi8vIEFycmF5IG9mIHRhZyByZWxhdGlvbnNoaXBzIHRvIGJlIHByZXNlcnZlZApjb25zdCBsaW5rVGFncyA9IFsibGluayIsICJjcmVhdG9yIiwgImNvbmZpZ0JvdCIsICJsaW5lVG8iLCAidHJhbnNmb3JtZXIiLCAiZm9ybUxpZ2h0VGFyZ2V0Il07CgovLyBUaGlzIGxvb3AgY29udGFpbnMgdGhlIGxvZ2ljIGZvciBwcmVzZXJ2aW5nIHRoZSBsaW5rVGFncwpmb3IgKGxldCBuZXdCb3Qgb2YgbmV3Qm90cykgewogICAgZm9yIChsZXQgdGFnIG9mIGxpbmtUYWdzKSB7CiAgICAgICAgbGV0IHZhbHVlID0gbmV3Qm90LnRhZ3NbdGFnXTsKCiAgICAgICAgaWYgKHRhZyA9PSAiY3JlYXRvciIpIHsKICAgICAgICAgICAgdmFsdWUgPSBuZXdCb3QudGFncy5vbGRDcmVhdG9yOwogICAgICAgICAgICBuZXdCb3QudGFncy5vbGRDcmVhdG9yID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUJvdExpbmtzKG5ld0JvdCwgaWRNYXApOwoKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBsZXQgbmV3VmFsdWUgPSB2YWx1ZS5tYXAoaWQgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpZE1hcC5nZXQoaWQpIHx8IGlkOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lEID0gaWRNYXAuZ2V0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3SUQpIHsKICAgICAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdJRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gVG9hc3RzIGZvciBoYXRjaGVzLCBidXQgb25seSBvbiBidWlsZGVyCmlmIChvcmlnaW4gJiYgdmVyc2lvbiAmJiBjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUgPT0gbnVsbCAmJiAhY29uZmlnQm90LnRhZ3MucGggJiYgYnVpbGRlclZlcnNpb24gPT0gImJ1aWxkZXIiKSB7CiAgICBvcy50b2FzdCgiaGF0Y2hlZCAiICsgb3JpZ2luICsgIiB2IiArIHZlcnNpb24pOwp9CgovLyBDcmVhdGUgYWJFZ2cgYm90IHRoYXQgdHJhY2tzIGNhbiBiZSB1c2VkIHRvIHRyYWNrIHdoYXQgZWdncyBoYXZlIGJlZW4gaGF0Y2hlZC4KbGV0IGFiRWdnTGFiZWw7CgppZiAob3JpZ2luKSB7CiAgICBpZiAodmVyc2lvbikgewogICAgICAgIGFiRWdnTGFiZWwgPSBgJHtvcmlnaW59IHYke3ZlcnNpb259YDsKICAgIH0gZWxzZSB7CiAgICAgICAgYWJFZ2dMYWJlbCA9IG9yaWdpbjsKICAgIH0KfSBlbHNlIHsKICAgIGFiRWdnTGFiZWwgPSAndW5rbm93bic7Cn0KCmNvbnN0IGFiRWdnID0gY3JlYXRlKHsKICAgIHNwYWNlOiAic2hhcmVkIiwKICAgIGFiOiB0cnVlLAogICAgYWJFZ2c6IHRydWUsCiAgICBhYklnbm9yZTogdHJ1ZSwKICAgIG9yaWdpbl9hYjogb3JpZ2luLAogICAgb3JpZ2luX3ZlcnNpb246IHZlcnNpb24sCiAgICBvcmlnaW5fcmVjb3JkOiByZWNvcmQsCiAgICBvcmlnaW5fc3R1ZGlvOiBzdHVkaW8sCiAgICBjcmVhdGVkVGltZXN0YW1wOiBEYXRlVGltZS5mcm9tTWlsbGlzKG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUpLAogICAgYm90SWRzOiBg8J+nrCR7SlNPTi5zdHJpbmdpZnkobmV3Qm90SWRzKX1gLAogICAgYm90RGF0YUhhc2hPcmlnaW5hbCwKICAgIHNvdXJjZUV2ZW50LAogICAgaW5zdDogYWIudGFncy5hYkluc3QsCiAgICBmb3JtOiAiZWdnIiwKICAgIGVnZ1BhcmFtZXRlcnM6IGVnZ1BhcmFtZXRlcnMgPyBg8J+nrCR7SlNPTi5zdHJpbmdpZnkoZWdnUGFyYW1ldGVycyl9YCA6IG51bGwsCiAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgIGxhYmVsOiBhYkVnZ0xhYmVsLAogICAgaGF0Y2hlclJlbW90ZUlkOiBjb25maWdCb3QuaWQsCn0pOwoKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47Cgp3aGlzcGVyKG5ld0JvdHMsICdvblByZUhhdGNoJywgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOwoKaWYgKGluaXRpYWxCb290KSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy8gb25FZ2dIYXRjaCBmb3IgYWxsIGp1c3QgaGF0Y2hlZCBib3RzCndoaXNwZXIobmV3Qm90cywgIm9uRWdnSGF0Y2giLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgZWdnUGFyYW1ldGVycywgc291cmNlRXZlbnQgfSk7CgovLyBvbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQUJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKc3VwZXJTaG91dCgib25BYkFkZGVkIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCmlmIChvcy5pc0NvbGxhYm9yYXRpdmUoKSkgewogICAgLy8gUmVtb3RlIHNob3V0IHRvIGFsbCBvdGhlciBjb25uZWN0ZWQgcmVtb3RlcyB0aGF0IGEgcmVtb3RlIGhhcyBhZGRlZCBhbiBhYi4KICAgIGNvbnN0IHJlbW90ZUlkcyA9IGF3YWl0IG9zLnJlbW90ZXMoKTsKICAgIGNvbnN0IHNlbGZJbmRleCA9IHJlbW90ZUlkcy5pbmRleE9mKGNvbmZpZ0JvdC5pZCk7CiAgICBpZiAoc2VsZkluZGV4ID4gMCkgewogICAgICAgIHJlbW90ZUlkcy5zcGxpY2Uoc2VsZkluZGV4LCAxKTsKICAgIH0KCiAgICBzZW5kUmVtb3RlRGF0YShyZW1vdGVJZHMsICdyZW1vdGVfYWJfYWRkZWQnLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQsIGFiRWdnSWQ6IGFiRWdnLmlkIH0pOwp9CgpyZXR1cm4gbmV3Qm90czsnAIKGnBXu0gEIcmVtZW1iZXICBACChpwVuYQCKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAIKGnBXu0gEIYWJJZ25vcmUCBACChpwV4IQCBHRydWUnAIKGnBXu0gEHYWJTaGVsbAIEAIKGnBXlhAIEdHJ1ZScAgoacFe7SAQlhYlZlcnNpb24CBACChpwV6oQCBTEwLjQzJwCChpwV7tIBC3BlcnNvbmFsaXR5AgQAgoacFfCEAijwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwCChpwV7tIBDG9uUmVtb3RlRGF0YQIEAIKGnBWXhQLuCkBpZiAodGhhdC5uYW1lID09PSAncmVtb3RlX2FiX2FkZGVkJykgewogICAgY29uc3QgYWJFZ2dJZCA9IHRoYXQudGhhdC5hYkVnZ0lkOwoKICAgIGlmIChhYkVnZ0lkKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdGFydGluZyBzZWFyY2ggZm9yIGFiRWdnIGJvdCB3aXRoIGlkICR7YWJFZ2dJZH0sIEV2ZW50IGRhdGE6YCwgdGhhdC50aGF0KTsKICAgICAgICB9CgogICAgICAgIC8vIFdhaXQgZm9yIHRoZSBhYkVnZyBib3QgdG8gYXJyaXZlLiBPbmNlIGl0IGhhcywgd2Ugc2hvdWxkIGJlIGFibGUgdG8gc2FmZWx5IHNob3V0IG9uUmVtb3RlQUJBZGRlZCBhbmQgaGF2ZSBhbGwgdGhlIGJvdHMgaW4gdGhlIGluc3QuCiAgICAgICAgbGV0IGFiRWdnID0gZ2V0Qm90KCdpZCcsIGFiRWdnSWQpOwogICAgICAgIGxldCBhY2N1bVNlYXJjaFRpbWUgPSAwOwogICAgICAgIGNvbnN0IE1BWF9TRUFSQ0hfVElNRV9NUyA9IDIwMDAwOwogICAgICAgIGNvbnN0IFNFQVJDSF9JTlRFUlZBTF9NUyA9IDI1MDsKICAgICAgICAKICAgICAgICB3aGlsZSghYWJFZ2cpIHsKICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoU0VBUkNIX0lOVEVSVkFMX01TKTsKCiAgICAgICAgICAgIGlmIChhY2N1bVNlYXJjaFRpbWUgPD0gTUFYX1NFQVJDSF9USU1FX01TKSB7CiAgICAgICAgICAgICAgICBhY2N1bVNlYXJjaFRpbWUgKz0gU0VBUkNIX0lOVEVSVkFMX01TOwogICAgICAgICAgICAgICAgYWJFZ2cgPSBnZXRCb3QoJ2lkJywgYWJFZ2dJZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVtb3RlX2FiX2FkZGVkIGV2ZW50IHJlY2VpdmVkIGJ1dCBhYkVnZ0lkICR7YWJFZ2dJZH0gbmV2ZXIgYXJyaXZlZC5gKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYWJFZ2cpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgYWJFZ2cgYm90IHdpdGggaWQgJHthYkVnZ0lkfWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlclNob3V0KCdvblJlbW90ZUFCQWRkZWQnLCB0aGF0LnRoYXQpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlbW90ZV9hYl9hZGRlZCBldmVudCByZWNlaXZlZCBidXQgbm90IGFiRWdnSWQgd2FzIHByb3ZpZGVkLiBFdmVudCBkYXRhOmAsIHRoYXQudGhhdCk7CiAgICB9Cn0nAIKGnBXu0gEFZGVidWcCBACChpwVhpACBWZhbHNlJwEEYm90cyQ1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYBJwCChpwVjJACBnN5c3RlbQIEAIKGnBWNkAIQYWIuc2hlbGwudmVyc2lvbicAgoacFYyQAgRmb3JtAgQAgoacFZ6QAgdub3RoaW5nJwCChpwVjJACCGFiSWdub3JlAgQAgoacFaaQAgR0cnVlJwCChpwVjJACB2FiU2hlbGwCBACChpwVq5ACBHRydWUnAIKGnBWMkAITYWJTaGVsbE1ham9yVmVyc2lvbgIEAIKGnBWwkAIBNCcAgoacFYyQAg1vblNraWxsVXBkYXRlAgQAgoacFbKQApcBQGNvbnN0IHZlcnNpb25TdHJpbmcgPSB0YWdzLmFiU2hlbGxNYWpvclZlcnNpb24gKyAiLiIgKyB0YWdzLmFiU2hlbGxNaW5vclZlcnNpb247DQoNCmNvbnNvbGUubG9nKCJbQUJTaGVsbF0gTG9hZGVkIEFCIHNoZWxsIHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAgoacFYyQAglhYlZlcnNpb24CBACChpwVypECBTEwLjQzJwCChpwVjJACE2FiU2hlbGxNaW5vclZlcnNpb24CBACChpwV0JECATQnAQRib3RzJDc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZgEnAIKGnBXSkQIGc3lzdGVtAgQAgoacFdORAg5hYi5zaGVsbC5zdG9yZScAgoacFdKRAgRmb3JtAgQAgoacFeKRAgdub3RoaW5nJwCChpwV0pECC2Rlc2NyaXB0aW9uAgQAgoacFeqRAj9UaGlzIHNraWxsIGlzIG1lYW50IHRvIGJlIGEgY29uZmlndXJhYmxlIG1lYW5zIHRvIHB1Ymxpc2ggZGF0YS4nAIKGnBXSkQIPYWJQdWJsaXNoUmVjb3JkAgQAgoacFaqSAuULQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmc7CmxldCByZWNvcmREYXRhID0gdGhhdC5kYXRhOwpsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKbGV0IGVuZHBvaW50ID0gdGhhdC5lbmRwb2ludCA/IHRoYXQuZW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCBtYXJrZXJTZXQgPSB0aGF0Lm1hcmtlclNldCA/PyBuZXcgU2V0KCk7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKbGV0IHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0cnVlOwoKaWYgKCFyZWNvcmREYXRhKSB7CiAgICByZXR1cm4gIm5vIGRhdGEgc3VwcGxpZWQiOwp9Cgphc3NlcnQobWFya2VyU2V0IGluc3RhbmNlb2YgU2V0LCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcmtlclNldCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFNldGApOwoKLy8gW1J5YW4gQ29va10gSEFDSzogVGhlcmUgYXJlIGlzc3VlcyB3aXRoIGN1c3RvbSBtYXJrZXJzLiBDbGVhciBhbGwgb2YgdGhlIGV4Y2VwdCBmb3IgcHVibGljUmVhZC4KbWFya2VyU2V0LmNsZWFyKCk7CgppZiAocHVibGljRmFjaW5nKSB7CiAgICBtYXJrZXJTZXQuYWRkKCdwdWJsaWNSZWFkJyk7Cn0KCnJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHsgZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBtYXJrZXJTZXQuc2l6ZSA+IDAgPyBBcnJheS5mcm9tKG1hcmtlclNldCkgOiB1bmRlZmluZWQgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmREYXRhIHJlc3VsdDpgLCByZWNvcmREYXRhKTsKfQoKaWYgKHJlY29yZERhdGEuc3VjY2VzcykgewogICAgYWIubGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBkYXRhIHB1Ymxpc2hlZCB0byByZWNvcmQgJHt1c2VyUmVjb3JkfSBhdCBhZGRyZXNzICR7cmVjb3JkTmFtZX1gLCBsb2dUeXBlOiAnbG9nJywgdG9hc3Q6IHRvYXN0IH0pOwp9IGVsc2UgewogICAgYWIubGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZGF0YSBmYWlsZWQgdG8gcHVibGlzaCB0byByZWNvcmQgJHt1c2VyUmVjb3JkfSBhdCBhZGRyZXNzICR7cmVjb3JkTmFtZX1cbiR7SlNPTi5zdHJpbmdpZnkocmVjb3JkRGF0YSwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwoKICAgIGlmICh0b2FzdCkgewogICAgICAgIGFiLmxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgZGF0YSBmYWlsZWQgdG8gcHVibGlzaCB0byByZWNvcmQgJHt1c2VyUmVjb3JkfSBhdCBhZGRyZXNzICR7cmVjb3JkTmFtZX0uICR7cmVjb3JkRGF0YS5lcnJvck1lc3NhZ2V9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIH0KfQoKcmV0dXJuIHJlY29yZERhdGE7JwCChpwV0pECDWFiUHVibGlzaEZpbGUCBACChpwVkJ4CsQ1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghdGhpc0JvdC5jYW5QdWJsaXNoRmlsZSgpKSB7CiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIGVycm9yQ29kZTogJ25vdF9hdXRob3JpemVkJywKICAgICAgICBlcnJvck1lc3NhZ2U6ICdVc2VyIGlzIG5vdCBhdXRob3JpemVkIHRvIHB1Ymxpc2ggZmlsZXMuJwogICAgfQp9CgpsZXQgZmlsZSA9IHRoYXQuZmlsZTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlTmFtZTsKbGV0IG1pbWVUeXBlID0gdGhhdC5taW1lVHlwZTsKbGV0IG1hcmtlclNldCA9IHRoYXQubWFya2VyU2V0ID8/IG5ldyBTZXQoKTsKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nID8/IHRydWU7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghZmlsZSkgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICBlcnJvckNvZGU6ICdpbnZhbGlkX2ZpbGVfZGF0YScsCiAgICAgICAgZXJyb3JNZXNzYWdlOiAnQSBmaWxlIG11c3QgYmUgcHJvdmlkZWQgdG8gcHVibGlzaC4nCiAgICB9Cn0KCmFzc2VydChtYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CgovLyBbUnlhbiBDb29rXSBIQUNLOiBUaGVyZSBhcmUgaXNzdWVzIHdpdGggY3VzdG9tIG1hcmtlcnMuIENsZWFyIGFsbCBvZiB0aGUgZXhjZXB0IGZvciBwdWJsaWNSZWFkLgptYXJrZXJTZXQuY2xlYXIoKTsKCmlmIChwdWJsaWNGYWNpbmcpIHsKICAgIG1hcmtlclNldC5hZGQoJ3B1YmxpY1JlYWQnKTsKfQoKbGV0IGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHsgZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUsIG1hcmtlcnM6IG1hcmtlclNldC5zaXplID4gMCA/IEFycmF5LmZyb20obWFya2VyU2V0KSA6IHVuZGVmaW5lZCB9KTsKCmlmICghZmlsZVVwbG9hZC5zdWNjZXNzKSB7CiAgICBpZiAoZmlsZVVwbG9hZC5lcnJvckNvZGUgPT0gImZpbGVfYWxyZWFkeV9leGlzdHMiKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmlsZSBhbHJlYWR5IGV4aXN0cyBpbiAke3VzZXJSZWNvcmR9YCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgcmV0dXJuIGZpbGVVcGxvYWQ7CiAgICB9CgogICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHVzZXJSZWNvcmQpOwoKICAgIGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHsgZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUsIG1hcmtlcnM6IG1hcmtlclNldC5zaXplID4gMCA/IEFycmF5LmZyb20obWFya2VyU2V0KSA6IHVuZGVmaW5lZCB9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykgewogICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmlsZSByZWNvcmRlZCB0byAke3VzZXJSZWNvcmR9YCwgbG9nVHlwZTogJ2xvZycgfSk7Cn0KZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmaWxlIGZhaWxlZCB0byByZWNvcmRgLCBsb2dUeXBlOiAnZXJyb3InIH0pOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAIKGnBXSkQIQYWJDb3JlTWVudUFjdGlvbgIEAIKGnBXCqwJNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAIKGnBXSkQILb25TdG9yZU1lbnUCBACChpwVkKwCjZgBQGxldCBwb3NzaWJsZVB1Ymxpc2hCb3QgPSBuZXcgU2V0KCk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpKSB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzLmZvckVhY2goYiA9PiBwb3NzaWJsZVB1Ymxpc2hCb3QuYWRkKGIpKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcG9zc2libGVQdWJsaXNoQm90LmFkZChsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpOwogICAgfQp9CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgewogICAgcG9zc2libGVQdWJsaXNoQm90LmFkZChsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKTsKfQoKcG9zc2libGVQdWJsaXNoQm90ID0gQXJyYXkuZnJvbShwb3NzaWJsZVB1Ymxpc2hCb3QpOwoKY29uc3QgYmFzZUFCID0gIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMgPyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjogbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cy5pZDsKY29uc3QgYmFzZUJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBkZWZhdWx0cyA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIG1hbmFnZXI6ICLwn5SXIiArIHRoaXNCb3QuaWQsCiAgICBtYW5pZmVzdGF0aW9uOiB0YWdzLm1hbmlmZXN0YXRpb24sCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YAp9CgovLyBDcmVhdGUgZG93bmxvYWQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgbGFiZWw6ICJkb3dubG9hZCIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItY29sb3IiOiAiJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybUFkZHJlc3M6ICJnZXRfYXBwIiwKICAgIHBvc3NpYmxlQm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiRG93bmxvYWQoeyBwb3NzaWJsZUJvdHM6IGxpbmtzLnBvc3NpYmxlQm90LCBzb3VyY2VFdmVudDogJ2FiX3N0b3JlX21lbnVfZG93bmxvYWQnIH0pO2AKfSk7CgppZiAoIWF1dGhCb3QpIAp7CiAgICAvLyBDcmVhdGUgbG9naW4gbWVzc2FnZQogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgICAgICBsYWJlbDogInBsZWFzZSBzaWduIGluIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIiwKICAgICAgICBvbkNsaWNrOiBgQCBvcy5yZXF1ZXN0QXV0aEJvdCgpYAogICAgfSk7CgogICAgcmV0dXJuOwp9CmVsc2UgaWYgKGF1dGhCb3QudGFncy5zdWJzY3JpcHRpb25UaWVyID09ICJGcmVlUGxheSIpIAp7CiAgICAvLyBDcmVhdGUgdXBncmFkZSBzdWJzY3JpcHRpb24gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJwbGVhc2UgdXBncmFkZSB5b3VyIHN1YnNjcmlwdGlvbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIKICAgIH0pOwoKICAgIHJldHVybjsKfQoKCmxldCB1c2VyU3R1ZGlvcyA9IGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvczsKCmlmICghdXNlclN0dWRpb3MpIAp7CiAgICB1c2VyU3R1ZGlvcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOwp9CgppZiAodXNlclN0dWRpb3Muc3VjY2VzcykgCnsKICAgIGNvbnN0IGFjdGl2ZVN0dWRpbyA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpOwoKICAgIGxldCBiYXNlU3R1ZGlvID0gYXV0aEJvdC5pZDsKCiAgICBpZiAoYmFzZVN0dWRpbyA9PSBhdXRoQm90LmlkKSAKICAgIHsKICAgICAgICBiYXNlU3R1ZGlvID0gInBsYXllciI7CiAgICB9CgogICAgaWYgKGFjdGl2ZVN0dWRpbyA9PSAtMSAmJiBiYXNlU3R1ZGlvICE9ICJwbGF5ZXIiKSAKICAgIHsKICAgICAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGJhc2VTdHVkaW87CiAgICB9CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyAmJiAhYWN0aXZlU3R1ZGlvKSAKICAgIHsKICAgICAgICBjb25zdCBzdHVkaW9NYXRjaCA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQoKICAgICAgICBpZiAoc3R1ZGlvTWF0Y2ggIT0gLTEpIHsKICAgICAgICAgICAgYmFzZVN0dWRpbyA9IGJhc2VTdHVkaW87CiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHN0dWRpb0xhYmVsID0gYWN0aXZlU3R1ZGlvID09IC0xID8gYmFzZVN0dWRpbyA6IHVzZXJTdHVkaW9zLnN0dWRpb3NbYWN0aXZlU3R1ZGlvXS5kaXNwbGF5TmFtZTsKCiAgICAvLyBDcmVhdGUgc3R1ZGlvIHNlbGVjdCBidXR0b24KICAgIGNvbnN0IHN0dWRpb0Rpc3BsYXlCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJzdHVkaW89IiArIHN0dWRpb0xhYmVsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41LAogICAgICAgIHN0dWRpb0luZm9ybWF0aW9uOiB1c2VyU3R1ZGlvcywKICAgICAgICBmb3JtQWRkcmVzczogImludmVudG9yeV8yIiwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLnN0dWRpb1NlbGVjdCh0YWdzLnN0dWRpb0luZm9ybWF0aW9uKTtgCiAgICB9KTsKCiAgICBtYXNrcy5zdHVkaW9TZWxlY3RCdXR0b24gPSBnZXRMaW5rKHN0dWRpb0Rpc3BsYXlCdXR0b24pOwp9Cgpjb25zdCB0b3RhbEJvdENvdW50ID0gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA+IDAgPyBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoIDogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aDsKCi8vIENyZWF0ZSBwdWJsaXNoIGxhYmVsIGJ1dHRvbgpjb25zdCBsYWJlbEJvdCA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgbGFiZWw6IGBwdWJsaXNoIHBhdHRlcm4gJHtiYXNlQm90cy5sZW5ndGggPiAwID8gIiIgOiAiYXMgIn0ke2Jhc2VBQn0gKCR7dG90YWxCb3RDb3VudH0gYm90JHtiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgIHRvdGFsQm90czogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCwKICAgIGFiTWVudVNvcnRPcmRlcjogMSwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIGZvcm1BZGRyZXNzOiBudWxsLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCA4cHggMHB4IDBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLXRvcC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIHNoaWZ0U3RhdGU6IGZhbHNlLAogICAgb25DbGljazogYEAgY29uc3QgbWVudUJvdHMgPSBnZXRCb3RzKCdhYk1lbnVTb3J0T3JkZXInKTsKCiAgICAgICAgaWYgKHRhZ3Muc2hpZnRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleVVwIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlEb3duIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0YWdzLnNoaWZ0U3RhdGUgPSAhdGFncy5zaGlmdFN0YXRlO2AsCiAgICBzY2FsZVk6ICJhdXRvIiwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGxldCB0b3RhbEJvdHMgPSBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPyB0aGF0LmFiQm90cyA6IHRoYXQuYWJCb3RzICsgdGhhdC5ub25BQkJvdHM7CgogICAgY29uc3QgdG90YWxCb3RWYXIgPSB0b3RhbEJvdHMgPT0gMSA/ICIgYm90IiA6ICIgYm90cyI7CiAgICBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cz8ubGVuZ3RoICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgaWYgKGdldEJvdCgiYWJJRE9yaWdpbiIsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCKSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSkubGVuZ3RoOwoKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiArICIgKCIgKyBhYkJvdHMgKyAiIGJvdHMpIjsKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSBhYkJvdHM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCBwYXR0ZXJuIGFzICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjsKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICAgICAgfSAgIAogICAgfQogICAgZWxzZQogICAgeyAgIAogICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgdGhhdC5hYiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjsKICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgIH1gCn0pOwoKLy8gQ3JlYXRlIGVuY3J5cHQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgIGxhYmVsOiAiZW5jcnlwdCIsCiAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgIGVuY3J5cHRTdGF0ZTogZmFsc2UsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBpZih0YWdzLmVuY3J5cHRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSB0cnVlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSB0cnVlOwogICAgICAgIH1gLAp9KTsKCmxldCBhYkJ1dHRvbjsKCmlmIChwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vIENyZWF0ZSBpbmNsdWRlQm90cyBidXR0b24KICAgIGFiQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MiwKICAgICAgICBhYlNlbGVjdGlvbkJ1dHRvbjogdHJ1ZSwKICAgICAgICBsYWJlbDogYmFzZUJvdHMubGVuZ3RoID4gMCAmJiBiYXNlQUIgIT0gdW5kZWZpbmVkID8gYHNlbGVjdGVkIHBhdHRlcm46ICR7YmFzZUFCfSAoJHtiYXNlQm90cy5sZW5ndGh9IGJvdCR7YmFzZUJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCA6IGBuZXcgcGF0dGVybiAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAnZWdnJywKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoU2VsZWN0KCk7YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXJOb24gPSB0aGF0Lm5vbkFCQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICBjb25zdCBib3RWYXJBQiA9IHRoYXQuYWJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgICAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9IHRoYXQuYWIgKyAiICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXJOb247CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAic2VsZWN0ZWQgcGF0dGVybjogIiArIHRoYXQuYWIgKyAiICgiICsgdGhhdC5hYkJvdHMgKyBib3RWYXJBQjsKICAgICAgICB9YAogICAgfSk7Cn0KCmlmIChub25BQkJvdHMubGVuZ3RoID4gMCAmJiBwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vaWNsdWRlIG5ldyBib3RzCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MywKICAgICAgICBhYkJ1dHRvbjogZ2V0TGluayhhYkJ1dHRvbiksCiAgICAgICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICAgICAgbGFiZWw6IGBpbmNsdWRlIG5ldyAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94IiwKICAgICAgICB1bmNsYWltZWRTdGF0ZTogZmFsc2UsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gbGlua3MuYWJCdXR0b24udGFncy5sYWJlbDsKCiAgICAgICAgICAgICAgICBpZiAobGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih0YWdzLnVuY2xhaW1lZFN0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zdCBub25BQkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vbkFCQm90cy5sZW5ndGh9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CgogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiAwfSk7CiAgICAgICAgICAgIH1gLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAiaW5jbHVkZSBuZXcgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhcjsKCiAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSB0aGF0LmFiOwoKICAgICAgICAgICAgaWYoIWxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgcHVibGljIGJ1dHRvbgppZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIAp7CiAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBmYWxzZTsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgICAgIGxhYmVsOiAiaXNQdWJsaWMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgICAgIHB1YmxpY1N0YXRlOiBmYWxzZSwKICAgICAgICBvbkNsaWNrOiBgQCBpZih0YWdzLnB1YmxpY1N0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IHRydWU7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHZlcnNpb24gc2VsZWN0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBsYWJlbDogJ3ZlcnNpb25GbGFnPWN1cnJlbnQnLAogICAgZm9ybUFkZHJlc3M6ICdhbHRfcm91dGUnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIHNob3V0KCdzaG93VmVyc2lvblNlbGVjdG9yJyk7YCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICd2ZXJzaW9uRmxhZz0nICsgdGhhdDsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgIGAsCn0pOwoKLy8gQ3VycmVudCBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdjdXJyZW50JywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl9jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBGZWVkYmFjayBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdmZWVkYmFjaycsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdmZWVkYmFjayc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gU3RhYmxlIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ3N0YWJsZScsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMiwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdzdGFibGUnOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIENyZWF0ZSBwdWJsaXNoIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogNCwKICAgIGZvcm1BZGRyZXNzOiAiZWdnIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHggMHB4IDhweCA4cHgiLAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1ib3R0b20tc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItY29sb3IiOiAiJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybTogImlucHV0IiwKICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgIG9uSW5wdXRUeXBpbmc6IGBAIGxpbmtzLmxhYmVsQm90LnRhZ3MubGFiZWwgPSAncHVibGlzaCBwYXR0ZXJuIGFzICcgKyB0aGF0LnRleHQgKyAnICgnICsgbGlua3MubGFiZWxCb3QudGFncy50b3RhbEJvdHMgKyAnIGJvdCcgKyAobGlua3MubGFiZWxCb3QudGFncy50b3RhbEJvdHMgPT0gMSA/ICcpJyA6ICdzKScpO2AsCiAgICBtZW51SXRlbVNob3dTdWJtaXRXaGVuRW1wdHk6IHRydWUsCiAgICB0YXJnZXRCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgIG1lbnVJdGVtVGV4dDogYmFzZUFCLAogICAgb25TdWJtaXQ6IGBACiAgICAgICAgICAgIGlmICh0aGF0LnRleHQgPT0gbnVsbCAmJiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhhdC50ZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGxldCBjb25maXJtUHVzaCA9IGZhbHNlOwogICAgICAgICAgICBsZXQgaW5YUiA9IGNvbmZpZ0JvdC50YWdzLmFyRW5hYmxlZCB8fCBjb25maWdCb3QudGFncy52ckVuYWJsZWQ7CgogICAgICAgICAgICBpZiAoaW5YUikgewogICAgICAgICAgICAgICAgY29uZmlybVB1c2ggPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKICAgICAgICAgICAgICAgIGNvbmZpcm1QdXNoID0gYXdhaXQgb3Muc2hvd0NvbmZpcm0oewogICAgICAgICAgICAgICAgICAgIHRpdGxlOiAiY29uZmlybSBwdWJsaXNoIiwKICAgICAgICAgICAgICAgICAgICBjb250ZW50OiAicHVibGlzaCAiICsgdGhhdC50ZXh0ICsgIiB0byAiICsgdGFyZ2V0U3R1ZGlvICsgIj8iLAogICAgICAgICAgICAgICAgICAgIGNvbmZpcm1UZXh0OiAicHVibGlzaCIsCiAgICAgICAgICAgICAgICAgICAgY2FuY2VsVGV4dDogImNhbmNlbCIKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWNvbmZpcm1QdXNoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoQUIoeyBhYjogdGhhdC50ZXh0LCBib3Q6IGxpbmtzLnRhcmdldEJvdCwgYmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgbWFudWFsUHVibGlzaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdzdG9yZV9tZW51JyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJhYiBub3Qgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSB0aGF0LmFiOwogICAgfWAKfSk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgCnsKICAgIC8vIENyZWF0ZSBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDgsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAiY29weSB0byBjbGlwYm9hcmQiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiZmlsZV9jb3B5IiwKICAgICAgICB0YXJnZXRCb3Q6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RGb2N1cywKICAgICAgICBvbkNsaWNrOiBgQCAKICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRCb3QgPSBsaW5rcy50YXJnZXRCb3Q7CgogICAgICAgICAgICBhYi5saW5rcy5wYXN0ZS5hYkNvcHlCb3RzVG9DbGlwYm9hcmQoeyBib3RzOiBbbGlua3MudGFyZ2V0Qm90XSwgc291cmNlRXZlbnQ6ICdhYl9zdG9yZV9tZW51X2NvcHlfY2xpcGJvYXJkJyB9KQoKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CiAgICAgICAgYCwKICAgIH0pOwp9CmVsc2UgCnsKICAgIC8vIENyZWF0ZSBzY2FuIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMTAsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyAgICAgICAgICAgIAogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAic2NhbiB0byBwdWJsaXNoIiwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgb25DbGljazogYEAgY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSB0cnVlOyBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpO2AsCiAgICB9KTsKfQoKbGV0IGhvc3RCdXR0b24gPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDUwLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgZm9ybUFkZHJlc3M6ICJncm91cF9hZGQiLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBvbkNsaWNrOiBgQCAKICAgICAgICBsaW5rcy5sZWFybi5hYkNyZWF0ZUhvc3QodGhpc0JvdCk7CiAgICAgICAgaWYgKCFhYi5saW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gJ2dlbmVyYXRpbmcgY29kZSBub3cnOwogICAgICAgIH0KICAgIGAsCn07CgppZiAobGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpIHsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiam9pbiBjb2RlOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQ7Cn0gZWxzZSB7CiAgICBob3N0QnV0dG9uLmxhYmVsID0gImdlbmVyYXRlIGpvaW4gY29kZSI7Cn0KCmlmIChjb25maWdCb3QudGFncy5zdGF0aWNJbnN0ID09IHVuZGVmaW5lZCkKewogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oaG9zdEJ1dHRvbik7Ly9nZW5lcmF0ZSBhIGhvc3QgYnV0dG9uCn0nAIKGnBXSkQIOYWJDb3JlTWVudUljb24CBACChpwVkMQDCWlvc19zaGFyZScAgoacFdKRAg9hYkNvcmVNZW51TGFiZWwCBACChpwVmsQDBXNoYXJlJwCChpwV0pECE2FiQ29yZU1lbnVTb3J0T3JkZXICBACChpwVoMQDATMnAIKGnBXSkQIIcmVtZW1iZXICBACChpwVosQDKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAIKGnBXSkQILYWJQdWJsaXNoQUICBACChpwVycQDuT9AaWYgKCFhdXRoQm90KSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogIm11c3QgYmUgbG9nZ2VkIGluIHRvIHB1Ymxpc2ggcGF0dGVybnMuIiwgbG9nVHlwZTogImVycm9yIiB9KTsKICAgIHJldHVybjsKfQoKaWYgKCF0aGlzQm90LmNhblB1Ymxpc2hGaWxlKCkpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAibXVzdCBoYXZlIHN1YnNjcmlwdGlvbiB0aGF0IHN1cHBvcnRzIGZpbGUgcHVibGlzaGluZy4iLCBsb2dUeXBlOiAiZXJyb3IiIH0pOwogICAgcmV0dXJuIAp9CgppZiAodGhhdC5hYi5pbmRleE9mKCIgIikgIT0gLTEgfHwgdGhhdC5hYi5pbmRleE9mKCciJykgIT0gLTEpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAicGF0dGVybiBuYW1lcyBtYXkgbm90IGNvbnRhaW4gc3BhY2VzIG9yIHF1b3RhaW9uIG1hcmtzLCBwbGVhc2UgdHJ5IGFnYWluLiIsIGxvZ1R5cGU6ICJlcnJvciIgfSk7CiAgICByZXR1cm47Cn0KCgpsaW5rcy51dGlscy5hYkxvZyhgcHVibGlzaGluZyAke3RoYXQuYWJ9YCk7CgppZiAoIXRoYXQua2VlcE1lbnUpIHsKICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsgCn0KCi8vYWIgdmFyaWFibGVzCmNvbnN0IGFiSUQgPSB0aGF0LmFiOwpsZXQga2V5ID0gdGhhdC5rZXk7CmxldCB0YXJnZXQgPSB0aGF0LnRhcmdldCA/IHRoYXQudGFyZ2V0IDogdGhhdC5ib3Q7CmNvbnN0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nID8/IGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZzsKY29uc3QgYmFzZUFCID0gdGhhdC5iYXNlQUIgPz8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8/IChjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkKTsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaCA9IHRoYXQub25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaDsgLy8gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBwcmVwcm9jZXNzIHRoZSBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuIChvcHRpb25hbCkKY29uc3QgbWFudWFsUHVibGlzaCA9IHRoYXQubWFudWFsUHVibGlzaDsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0LnNvdXJjZUV2ZW50OyAvLyBzb3VyY2VFdmVudCBpcyBhbiBldmVudCBuYW1lIHRoYXQgc3ltYm9saXplcyB3aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwuIChvcHRpb25hbCkKY29uc3QgZWdnTWFya2VyU2V0ID0gdGhhdC5lZ2dNYXJrZXJTZXQgPz8gbmV3IFNldCgpOwpjb25zdCBhdXhNYXJrZXJTZXQgPSB0aGF0LmF1eE1hcmtlclNldCA/PyBuZXcgU2V0KCk7CmNvbnN0IHN0YXRlID0ge307CmxldCBmb3JtYXR0ZWRGaWxlID0ge307Cgphc3NlcnQoZWdnTWFya2VyU2V0IGluc3RhbmNlb2YgU2V0LCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVnZ01hcmtlclNldCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFNldGApOwphc3NlcnQoYXV4TWFya2VyU2V0IGluc3RhbmNlb2YgU2V0LCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGF1eE1hcmtlclNldCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFNldGApOwoKY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKCmVnZ01hcmtlclNldC5hZGQoJ2FiRWdnJyk7CmVnZ01hcmtlclNldC5hZGQoYWJJRCk7CgphdXhNYXJrZXJTZXQuYWRkKCdhYkF1eCcpOwphdXhNYXJrZXJTZXQuYWRkKGFiSUQpOwoKbGV0IGJ1c3lJbmRpY2F0b3I7CmlmIChtYW51YWxQdWJsaXNoICYmICFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUpIHsKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KICAgIAogICAgYnVzeUluZGljYXRvciA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGB1cGxvYWRpbmcgJHt0aGF0LmFifWAsIG9uRGVzdHJveTogYEBjb25zb2xlLmxvZygnYnVzeSBpbmRpY2F0b3IgZ28gYm9vbScpYH0pOwp9CgovLyBMZXQgYWxsIGJvdHMga25vdyB0aGF0IGFiIGlzIGFib3V0IHRvIHN0YXJ0IHB1Ymxpc2hpbmcuCmNvbnN0IGJlZm9yZVB1Ymxpc2hBcmcgPSB7IGFiOiBhYklELCBzdHVkaW8sIHB1YmxpY0ZhY2luZywgc291cmNlRXZlbnQgfTsKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCQmVmb3JlUHVibGlzaCcsIGJlZm9yZVB1Ymxpc2hBcmcpKTsKCmlmICghdGFyZ2V0IHx8IHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkICYmIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIpIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSAmJiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gYWJJRCk7CgogICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CiAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgJiYgZ2V0Qm90KCJhYklET3JpZ2luIiwgYmFzZUFCKSkgewogICAgICAgIGNvbnN0IGVnZ0JvdHMgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSAmJiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQik7CiAgICAgICAgY29uc3QgbmV3Qm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09IG51bGwpOwoKICAgICAgICB0YXJnZXQgPSBbLi4uZWdnQm90cywgLi4ubmV3Qm90c107CiAgICB9IGVsc2UgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKICAgIH0KCiAgICBzZXRUYWcodGFyZ2V0LCAiYWJJRE9yaWdpbiIsIGFiSUQpOwoKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgPSBudWxsOwoKICAgIGlmICh0YXJnZXQubGVuZ3RoIDwgMSkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoIm5vIGJvdHMgZm91bmQgdG8gcHVibGlzaCIpOwoKICAgICAgICBpZiAoIXRoYXQua2VlcE1lbnUpIHsKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsgCiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL3RoaXMgbG9naWMgaGFuZGxlcyBnZW5lcmF0aW5nIGEga2V5IGZvciBlbmNyeXB0aW9uIChvcHRpb25hbCkKaWYgKGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24pIHsKICAgIGxldCBrZXlDaGVjazsKCiAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKCiAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoIiIsIHsKICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICB0aXRsZTogJ2VudGVyIGEgc2VjcmV0IGtleScKICAgIH0pOwoKICAgIGlmIChrZXkpIHsKICAgICAgICBrZXlDaGVjayA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdjb25maXJtIHNlY3JldCBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKGtleSAhPSBrZXlDaGVjaykgewogICAgICAgIGlmICgha2V5Q2hlY2spIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgibm8ga2V5IGVudGVyZWQiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJrZXlzIGRvIG5vdCBtYXRjaCIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCF0aGF0LmtlZXBNZW51KSB7CiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7IAogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy9mb3JtYXR0aW5nIGJvdHMgZm9yIGZpbGUgc3RvcmFnZQppZiAoQXJyYXkuaXNBcnJheSh0YXJnZXQpKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgewogICAgICAgIGxldCBjdXJyZW50Qm90SUQgPSB0YXJnZXRbaV0uaWQ7CiAgICAgICAgbGV0IGN1cnJlbnRCb3REYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0YXJnZXRbaV0pKTsKCiAgICAgICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwogICAgfQp9CmVsc2UgewogICAgc3RhdGVbdGFyZ2V0LmlkXSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGFyZ2V0KSk7Cn0KCi8vY2hlY2tzIGZvciBwcmV2aW91cyBlZ2dzIGFuZCByZXR1cm5zIGRhdGEgZm9yIHByZXZpb3VzbHkgcHVibGlzaGVkIGFiJ3MKbGV0IGVnZ0NoZWNrID0gYXdhaXQgdGhpc0JvdC5hYlByZXZpb3VzRWdnQ2hlY2soeyBhYklEOiBhYklEIH0pOwoKLy9hZGQgeHAgYm90IGhlcmUKc3RhdGUuYWJYUEJvdCA9IHsKICAgIHNwYWNlOiAic2hhcmVkIiwKICAgIGlkOiAiYWJYUEJvdCIsCiAgICB0YWdzOiB7CiAgICAgICAgZm9ybTogIm5vdGhpbmciLAogICAgICAgIHN5c3RlbTogImFiLnBhdHRlcm4uYWJYUEJvdCIsCiAgICAgICAgYXV0aG9ySUQ6IGF1dGhCb3QuaWQsCiAgICAgICAgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uLAogICAgICAgIHhwOiBsaW5rcy5sZWFybi50YWdzLmFiWFAsCiAgICAgICAgc2lnbmF0dXJlOiBlZ2dDaGVjay5zaWduYXR1cmUsCiAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICB9Cn07CgovLyBEbyBhbm90aGVyIHByZXByb2Nlc3NpbmcgcGFzcyB0aGF0IGFsbG93cyBsaXN0ZW5lcnMgdG8gcHJlcHJvY2VzcyB0aGUgYWIgZGF0YSBiZWZvcmUgaXQgaXMgcHVibGlzaGVkLgpsZXQgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YTogc3RhdGUsIGFiOiBhYklELCBzdHVkaW8sIHB1YmxpY0ZhY2luZywgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoKHByZXByb2Nlc3NBcmcpCn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVQdWJsaXNoJywgcHJlcHJvY2Vzc0FyZykpOwoKLy9hZGRpdGlvbmFsIGZpbGUgZGF0YQpmb3JtYXR0ZWRGaWxlLnZlcnNpb24gPSAxOwpmb3JtYXR0ZWRGaWxlLnNpZ25hdHVyZSA9IGVnZ0NoZWNrLnNpZ25hdHVyZTsKZm9ybWF0dGVkRmlsZS5zdGF0ZSA9IHN0YXRlOwoKLy9hY3R1YWwgZW5jcnlwdGlvbiBpZiBjaG9zZW4KaWYgKGtleSkgewogICAgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KGZvcm1hdHRlZEZpbGUpOwogICAgZm9ybWF0dGVkRmlsZSA9IGNyeXB0by5lbmNyeXB0KGtleSwgZm9ybWF0dGVkRmlsZSk7Cn0KCi8vcHVibGlzaCB0aGUgZmlsZSBhbmQgdGhlIGVnZyByZWNvcmQuCmxldCBwdWJsaXNoRmlsZTsKbGV0IHB1Ymxpc2hSZWNvcmQ7CgpwdWJsaXNoRmlsZSA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoRmlsZSh7IGZpbGU6IGZvcm1hdHRlZEZpbGUsIGZpbGVOYW1lOiBhYklELCBwdWJsaWNGYWNpbmc6IHRydWUsIG1hcmtlclNldDogYXV4TWFya2VyU2V0IH0pOwoKaWYgKHB1Ymxpc2hGaWxlLnN1Y2Nlc3MpIHsKICAgIC8vZ2F0aGVyIGFkZGlvbmFsIGVnZyBkYXRhCiAgICBjb25zdCBhaVBlcm1pdENoZWNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWlfcGVybWl0Iik7CiAgICBjb25zdCBhaVBlcm1pdElEID0gYWlQZXJtaXRDaGVjay5zdWNjZXNzID8gYWlQZXJtaXRDaGVjay5kYXRhLnBlcm1pdElEIDogZmFsc2U7CgogICAgZWdnQ2hlY2suZWdnRGF0YS5haVBlcm1pdCA9IGFpUGVybWl0SUQ7CiAgICBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5LnB1c2gocHVibGlzaEZpbGUudXJsKTsKICAgIGVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgZWdnQ2hlY2suZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICAKICAgIC8vcHVibGlzaCBlZ2cvYWIgcmVjb3JkCiAgICBwdWJsaXNoUmVjb3JkID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hSZWNvcmQoeyBkYXRhOiBlZ2dDaGVjay5lZ2dEYXRhLCByZWNvcmROYW1lOiBhYklELCBwdWJsaWNGYWNpbmcsIG1hcmtlclNldDogZWdnTWFya2VyU2V0LCB0b2FzdDogZmFsc2UgfSk7Cn0KCmlmIChwdWJsaXNoRmlsZS5zdWNjZXNzICYmIHB1Ymxpc2hSZWNvcmQuc3VjY2VzcykgewogICAgLy9wdWJsaXNoaW5nIHNob3V0CiAgICBzdXBlclNob3V0KCJvbkFCUHVibGlzaGVkIiwgeyBzdWNjZXNzOiBwdWJsaXNoRmlsZS5zdWNjZXNzLCBhYjogYWJJRCwgZmlsZUFkZHJlc3M6IHB1Ymxpc2hGaWxlLnVybCB9KTsKICAgIHN1cGVyU2hvdXQoIm9uQWJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCiAgICBjb25zdCBiaW9zID0gcHVibGljRmFjaW5nID8gImZyZWUiIDogImxvY2FsIjsKICAgIGNvbnN0IGluc3RUeXBlID0gcHVibGljRmFjaW5nID8gImZyZWUiIDogImxvY2FsIjsKCiAgICBzZXRUYWdNYXNrKGxpbmtzLmxlYXJuLCAiYWJYUCIsICIwIiwgImxvY2FsIik7CgogICAgaWYgKG1hbnVhbFB1Ymxpc2gpIHsKICAgICAgICBsZXQgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CiAgICAgICAgY29uc3QgdXJsID0gc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJnN0dWRpbz0iICsgc3R1ZGlvICsgIiZiaW9zPSIgKyBiaW9zOwogICAgICAgIG9zLnNldENsaXBib2FyZCh1cmwpOwoKICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIHdpdGggZW5jcnlwdGVkIGRhdGEgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgYW5hbHl0aWNzLnJlY29yZEV2ZW50KCdhYl9lZ2dfcHVibGlzaCcsIHsgYWI6IGFiSUQsIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgfQp9CmVsc2UgewogICAgbGV0IGVycm9yTWVzc2FnZTsKCiAgICBpZiAoIXB1Ymxpc2hGaWxlLnN1Y2Nlc3MpIHsKICAgICAgICBlcnJvck1lc3NhZ2UgPSBwdWJsaXNoRmlsZS5lcnJvck1lc3NhZ2UgPz8gcHVibGlzaEZpbGUuZXJyb3JDb2RlOwogICAgfSBlbHNlIGlmICghcHVibGlzaFJlY29yZC5zdWNjZXNzKSB7CiAgICAgICAgZXJyb3JNZXNzYWdlID0gcHVibGljaFJlY29yZC5lcnJvck1lc3NhZ2UgPz8gcHVibGlzaFJlY29yZC5lcnJvckNvZGU7CiAgICB9IGVsc2UgewogICAgICAgIGVycm9yTWVzc2FnZSA9ICdVbmtub3duIHJlYXNvbic7CiAgICB9CgogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogYFB1Ymxpc2hpbmcgZmFpbGVkOiAke2Vycm9yTWVzc2FnZX1gLAogICAgICAgIGxvZ1R5cGU6ICdlcnJvcicsCiAgICAgICAgdG9hc3Q6ICFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUKICAgIH0pCn0KCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gcHVibGlzaFJlY29yZDsnAIKGnBXSkQIIYWJJZ25vcmUCBACChpwVg4QEBHRydWUnAIKGnBXSkQIKYWJEb3dubG9hZAIEAIKGnBWIhAS5FUBjb25zdCBwb3NzaWJsZUJvdHMgPSB0aGF0Py5wb3NzaWJsZUJvdHM7CmxldCBmaWxlbmFtZSA9IHRoYXQ/LmZpbGVuYW1lOwpsZXQgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKbGV0IG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ7CmxldCBsb2cgPSB0aGF0Py5sb2cgPz8gdHJ1ZTsKbGV0IHJlb3BlbkFiTWVudSA9IHRoYXQ/LnJlb3BlbkFiTWVudSA/PyB0cnVlOwoKLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byBkb3dubG9hZCBib3RzLgpjb25zdCBiZWZvcmVEb3dubG9hZEFyZyA9IHsgZmlsZW5hbWUsIHNvdXJjZUV2ZW50IH07CmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZURvd25sb2FkJywgYmVmb3JlRG93bmxvYWRBcmcpKTsKCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zdCBzaG91bGREb3dubG9hZEluc3QgPSAhcG9zc2libGVCb3RzIHx8IChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykgJiYgcG9zc2libGVCb3RzLmxlbmd0aCA9PT0gMCk7CgppZiAoc2hvdWxkRG93bmxvYWRJbnN0KSB7CiAgICAvLyBEb3dubG9hZCBpbnN0LgogICAgZG93bmxvYWRCb3RzID0gZ2V0Qm90cyhiID0+ICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOwoKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgIH0KCiAgICBpZiAobG9nKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGluc3QnKTsKICAgIH0KfSBlbHNlIHsKICAgIGlmIChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykpIHsKICAgICAgICAvLyBEb3dubG9hZCBib3RzLgogICAgICAgIGRvd25sb2FkQm90cyA9IHBvc3NpYmxlQm90czsKICAgICAgICBjb25zdCBib3RJZHMgPSBwb3NzaWJsZUJvdHMubWFwKGIgPT4gYi5pZCkuc29ydCgpOwogICAgICAgIGxldCBib3RJZHNTSEExID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90SWRzKTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtib3RJZHNTSEExLnN1YnN0cmluZygwLCA3KX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9nKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGBkb3dubG9hZCAke2Rvd25sb2FkQm90cy5sZW5ndGh9IGJvdHNgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGJvdC4KICAgICAgICBkb3dubG9hZEJvdHMgPSBbcG9zc2libGVCb3RzXTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtwb3NzaWJsZUJvdHMuaWQuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGJvdCcpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpIHsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9Cgpjb25zdCBzdGF0ZSA9IHt9OwoKLy8gRm9ybWF0IGJvdHMgZm9yIGZpbGUgc3RvcmFnZQpmb3IgKGxldCBpID0gMDsgaSA8IGRvd25sb2FkQm90cy5sZW5ndGg7IGkrKykgewogICAgbGV0IGN1cnJlbnRCb3RJRCA9IGRvd25sb2FkQm90c1tpXS5pZDsKICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZG93bmxvYWRCb3RzW2ldKSk7CgogICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwp9CgppZiAoIWZpbGVuYW1lLmVuZHNXaXRoKCcuYXV4JykpIHsKICAgIGZpbGVuYW1lICs9ICcuYXV4JzsKfQoKLy8gRG8gYSBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmNvbnN0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBmaWxlbmFtZSwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQocHJlcHJvY2Vzc0FyZyk7Cn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vIERvd25sb2FkIGFzIHYxIGF1eCBmaWxlLgpjb25zdCBhdXhGaWxlID0geyB2ZXJzaW9uOiAxLCBzdGF0ZSB9Owpvcy5kb3dubG9hZChhdXhGaWxlLCBmaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgppZiAocmVvcGVuQWJNZW51KSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfScAgoacFdKRAg1tYW5pZmVzdGF0aW9uAgQAgoacFcKZBCjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCChpwV0pECBG1lbnUCBACChpwV6ZkEKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAIKGnBXSkQISYWJQcmV2aW91c0VnZ0NoZWNrAgQAgoacFZCaBIARQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0Py5hYklEOwpjb25zdCByZWNvcmRLZXlPck5hbWUgPSB0aGF0Py5yZWNvcmRLZXlPck5hbWUgPz8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQ7Cgphc3NlcnQodHlwZW9mIGFiSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyYCk7CmFzc2VydCh0eXBlb2YgcmVjb3JkS2V5T3JOYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXlPck5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBlZ2dIaXN0b3J5OwpsZXQgZWdnSUQ7CmxldCB0YXJnZXRWZXJzaW9uTnVtOwpsZXQgbGFzdEhhc2g7CmxldCBtYXhWZXJzaW9uTnVtOwpsZXQgc3RhYmxlVmVyc2lvbjsKbGV0IGZlZWRiYWNrVmVyc2lvbjsKbGV0IHByZXZpb3VzWFA7CmxldCByZWNvcmRMb29rdXAgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleU9yTmFtZSwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycAgoacFdKRAg9hYkJvdE1lbnVBY3Rpb24CBACChpwVkasETUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCChpwV0pECDmFiQm90TWVudUxhYmVsAgQAgoacFd+rBAVzaGFyZScAgoacFdKRAg1hYkJvdE1lbnVJY29uAgQAgoacFeWrBAlpb3Nfc2hhcmUnAIKGnBXSkQISYWJCb3RNZW51U29ydE9yZGVyAgQAgoacFe+rBAMzLjUnAIKGnBXSkQIFbGVhcm4CBACChpwV86sEKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAIKGnBXSkQILYWJRUlB1Ymxpc2gCBACChpwVmqwE4QFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0LCBzb3VyY2VFdmVudDogJ3FyX3B1Ymxpc2gnfSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAIKGnBXSkQIGc2VhcmNoAgQAgoacFfytBCjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCChpwV0pECB2FiU2hlbGwCBACChpwVo64EBHRydWUnAIKGnBXSkQIMc3R1ZGlvU2VsZWN0AgQAgoacFaiuBIULQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwCChpwV0pECDmFiUHVibGlzaEFza0lEAgQAgoacFay5BN8VQGlmICghbGlua3MubWVudSkgewogICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKfQoKbGV0IG1lbnVEaW1lbnNpb24gPSB0aGF0Lm1lbnVEaW1lbnNpb24gPz8gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKbGV0IHByb2dyZXNzQnV0dG9uOwoKaWYgKG1lbnVEaW1lbnNpb24pIHsKICAgIHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgW21lbnVEaW1lbnNpb25dOiB0cnVlLCBsYWJlbDogYHB1Ymxpc2hpbmcgJHt0aGF0LmFza0lEfWAgfSk7Cn0KCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7Cgpjb25zdCBwYXR0ZXJuSUQgPSB0aGF0LnBhdHRlcm5JRDsKY29uc3Qgc3R1ZGlvSUQgPSB0aGF0LnN0dWRpb0lEID8gdGhhdC5zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBhdXRoQm90LmlkOwpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQucmVwbGFjZUFsbCgiLSIsICIiKTsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmNvbnN0IG1hcmtlclNldCA9IHRoYXQubWFya2VyU2V0ID8/IG5ldyBTZXQoKTsKY29uc3QgdG9hc3QgPSB0aGF0LnRvYXN0ID8/IHRydWU7Cgphc3NlcnQobWFya2VyU2V0IGluc3RhbmNlb2YgU2V0LCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcmtlclNldCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFNldGApOwoKbWFya2VyU2V0LmFkZCgncHVibGljUmVhZCcpOwptYXJrZXJTZXQuYWRkKCdhYkFzaycpOwoKLy8gW1J5YW4gQ29va10gSEFDSzogVGhlcmUgYXJlIGlzc3VlcyB3aXRoIGN1c3RvbSBtYXJrZXJzLiBDbGVhciBhbGwgb2YgdGhlIGV4Y2VwdCBmb3IgcHVibGljUmVhZC4KbWFya2VyU2V0LmNsZWFyKCk7Cm1hcmtlclNldC5hZGQoJ3B1YmxpY1JlYWQnKTsKCi8vIENoZWNrIHRvIHNlZSBpZiB0aGlzIGFza0lEIGFscmVhZHkgZXhpc3RzIGluIHRoZSBjYXN1YWwgY2F0YWxvZy4gQ2FzdWFsIGNhdGFsb2cgYXNrcyBhbHdheXMgb3ZlcnJpZGUgYWIgYXNrcyBhbmQgc28gdXNlcidzIHNob3VsZCBiZSBhd2FyZS4KY29uc3QgZXhpc3RzSW5DYXN1YWxDYXRhbG9nID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLmFiQ2FzdWFsQ2F0YWxvZ0Fza0lERXhpc3RzKHsgYXNrSUQ6IHRoYXQuYXNrSUQgfSk7CgppZiAoIWV4aXN0c0luQ2FzdWFsQ2F0YWxvZykgewogICAgY29uc3QgcHVibGlzaEFzayA9IGF3YWl0IG9zLnJlY29yZERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIHsgcGF0dGVybklEOiBwYXR0ZXJuSUQsIHN0dWRpb0lEOiBzdHVkaW9JRCB9LCB7IGVuZHBvaW50OiBlbmRwb2ludCwgdXBkYXRlUG9saWN5OiBbYXV0aEJvdC5pZF0sIG1hcmtlcnM6IG1hcmtlclNldC5zaXplID4gMCA/IEFycmF5LmZyb20obWFya2VyU2V0KSA6IHVuZGVmaW5lZCB9KTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcHVibGlzaEFzayByZXN1bHQ6YCwgcHVibGlzaEFzayk7CiAgICB9CgogICAgaWYgKHB1Ymxpc2hBc2suc3VjY2VzcykgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGFzayAke3RoYXQuYXNrSUR9IHB1Ymxpc2hlZCB0byBhYiByZWNvcmQuYCwgbG9nVHlwZTogJ2xvZycgfSk7CgogICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYGFzayAke3RoYXQuYXNrSUR9IHB1Ymxpc2hlZC5gLCBsb2dUeXBlOiAnbG9nJyB9KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGFzayAke3RoYXQuYXNrSUR9IGZhaWxlZCB0byBwdWJsaXNoIHRvIGFiIHJlY29yZC5cbiR7SlNPTi5zdHJpbmdpZnkocHVibGlzaEFzaywgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwoKICAgICAgICBpZiAodG9hc3QpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJUb2FzdCh7IG1lc3NhZ2U6IGBmYWlsZWQgdG8gcHVibGlzaCBhc2sgJHt0aGF0LmFza0lEfS4gJHtwdWJsaXNoQXNrLmVycm9yTWVzc2FnZX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KCiAgICByZXR1cm4gcHVibGlzaEFzazsKfSBlbHNlIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgYXNrSUQgJyR7dGhhdC5hc2tJRH0nIGFscmVhZHkgZXhpc3RzIGluIHRoZSBjYXN1YWwgY2F0YWxvZy4gUGxlYXNlIGNob29zZSBhIGRpZmZlcmVudCBuYW1lLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CgogICAgaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICB9CiAgICAKICAgIC8vIFJldHVybiBhbiBvYmplY3QgaW4gdGhlIHNoYXBlIG9mIFJlY29yZERhdGFGYWlsdXJlLgogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICBlcnJvckNvZGU6ICdhc2tpZF9leGlzdHNfY2FzdWFsX2NhdGFsb2cnLAogICAgICAgIGVycm9yTWVzc2FnZTogYENhc3VhbCBjYXRhbG9nIGFscmVhZHkgY29udGFpbnMgdGhlIGFza0lEICcke2Fza0lEfSdgCiAgICB9Cn0nAIKGnBXSkQIFaW5wdXQCBACChpwVjM8EKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAIKGnBXSkQILYWJFbWJlZExpbmsCBACChpwVs88EpANAY29uc3QgYWIgPSB0aGF0ID8gdHJ1ZSA6IGZhbHNlOwpjb25zdCBlbWJlZExpbmsgPSBhYiA/ICJhYj0iICsgdGhhdCA6ICJpbnN0PSIgKyBjb25maWdCb3QudGFncy5pbnN0Owpjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKY29uc3QgZW1iZWRUZXh0ID0gYDwhRE9DVFlQRSBodG1sPgrCoMKgwqDCoDxodG1sPgrCoMKgwqDCoMKgwqDCoMKgPGhlYWQ+PC9oZWFkPgrCoMKgwqDCoMKgwqDCoMKgPGJvZHk+CsKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoDxpZnJhbWUgc3JjPSIke3NpdGVPcmlnaW4gKyAiLz8iICsgZW1iZWRMaW5rfSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iNDAwIiAvPgrCoMKgwqDCoMKgwqDCoMKgPC9ib2R5PgrCoMKgwqDCoDwvaHRtbD5gOwoKcmV0dXJuIGVtYmVkVGV4dDsnAIKGnBXSkQIPYWJQYXR0ZXJuVXBkYXRlAgQAgoacFazSBKUFQC8vc2hvdXQoImFiUGF0dGVyblVwZGF0ZSIsIHthYklEOiBhYklELCBzdHVkaW86c3R1ZGlvPywgYm90czogYm90cz99KTsKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghYXV0aEJvdCkKewogICAgcmV0dXJuOwp9Cgpjb25zdCBhYklEID0gdGhhdC5hYklEOwpjb25zdCBzdHVkaW8gPSB0aGF0LnN0dWRpbyA/IHRoYXQuc3R1ZGlvIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKY29uc3QgYWJNYW5pZmVzdCA9IGdldEJvdChieU1vZCh7YWJFZ2c6IHRydWUsIG9yaWdpbl9hYjogYWJJRH0pKTsKCmlmICghYWJNYW5pZmVzdCkKewogICAgc2hvdXQoIm9uTG9va3VwQUJFZ2dzIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBhdXRvSGF0Y2g6IHRydWUsIHNvdXJjZUV2ZW50OiAncGF0dGVybl91cGRhdGUnfSk7CgogICAgcmV0dXJuOwp9Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHN0dWRpbzsKCmNvbnN0IGFiQm90cyA9IHRoYXQuYm90cyA/PyBnZXRCb3RzKCJhYklET3JpZ2luIiwgYWJJRCk7Cgphd2FpdCB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogYWJJRCwgdGFyZ2V0OiBhYkJvdHMsIHB1YmxpY0ZhY2luZzogdHJ1ZSwgc291cmNlRXZlbnQ6ICdwYXR0ZXJuX3VwZGF0ZSd9KTsnAIKGnBXSkQIXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBACChpwV0tcETUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCChpwV0pECGmFiTXVsdGlwbGVCb3RNZW51U29ydE9yZGVyAgQAgoacFaDYBAEyJwCChpwV0pECFWFiTXVsdGlwbGVCb3RNZW51SWNvbgIEAIKGnBWi2AQJaW9zX3NoYXJlJwCChpwV0pECFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBACChpwVrNgEBXNoYXJlJwCChpwV0pECD2FiUHVibGlzaFNlbGVjdAIEAIKGnBWy2ASkE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IHRhZ3MubGFiZWwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vblBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwCChpwV0pECCWFiVmVyc2lvbgIEAIKGnBXV6wQFMTAuNDMnAIKGnBXSkQILcGVyc29uYWxpdHkCBACChpwV2+sEKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAIKGnBXSkQIFdXRpbHMCBACChpwVguwEKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAIKGnBXSkQIOY2FuUHVibGlzaEZpbGUCBACChpwVqewE/gNAaWYgKGdsb2JhbFRoaXMuYWIpIHsKICAgIGlmIChhdXRoQm90KSB7CiAgICAgICAgaWYgKGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3Muc3Vic2NyaXB0aW9uc0VuYWJsZWQpIHsKICAgICAgICAgICAgaWYgKGF1dGhCb3QudGFncy5zdWJzY3JpcHRpb25UaWVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIgIT09ICdGcmVlUGxheSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfSBlbHNlIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB3YWl0IGZvciBhYiB0byBmaW5pc2ggYm9vdGluZyBiZWZvcmUgcXVlcnlpbmcgJHt0YWdOYW1lfS5gKQogICAgcmV0dXJuIG51bGw7Cn0nAIKGnBXSkQIFZGVidWcCBACChpwVqPAEBWZhbHNlJwEEYm90cyQ3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcBJwCChpwVrvAEFWFiRmluZEFydGlmYWN0QnVuZGxlcwIEAIKGnBWv8ASTBkBjb25zdCB7IAogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge307Cgpjb25zdCBhcnRpZmFjdEJ1bmRsZXM6IFJlY29yZDxzdHJpbmcsIEFCQXJ0aWZhY3RCdW5kbGU+ID0ge307IC8vIEtleSBpcyBhcnRpZmFjdCBpZAoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSAmJiBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCAmJiBhYkFydGlmYWN0SW5zdGFuY2VJRCAhPT0gYi50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFydGlmYWN0SWQgPSBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZS5pZDsKCiAgICAgICAgaWYgKGFydGlmYWN0SWQgJiYgIWFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSkgewogICAgICAgICAgICBhcnRpZmFjdEJ1bmRsZXNbYXJ0aWZhY3RJZF0gPSBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICB9CiAgICB9Cn0pOwoKcmV0dXJuIGFydGlmYWN0QnVuZGxlczsnAIKGnBWu8AQFc3RvcmUCBACChpwVw/YEKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAIKGnBWu8AQGc3lzdGVtAgQAgoacFer2BBFhYi5zaGVsbC5hcnRpZmFjdCcAgoacFa7wBAhhYklnbm9yZQIEAIKGnBX89gQEdHJ1ZScAgoacFa7wBAlhYlZlcnNpb24CBACChpwVgfcEBTEwLjQzJwCChpwVrvAEBWRlYnVnAgQAgoacFYf3BAVmYWxzZScAgoacFa7wBCNhYkNoZWNrQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkF0UmVzdAIEAIKGnBWN9wSzBkBpZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGVja2luZy4uLmApOwp9CgovLyBDbGVhciBhbnkgY3VycmVudGx5IHJ1bm5pbmcgImF0IHJlc3QiIGNoZWNrLgppZiAobWFza3MuYXRSZXN0VGltZW91dElkKSB7CiAgICBjbGVhclRpbWVvdXQobWFza3MuYXRSZXN0VGltZW91dElkKTsKICAgIG1hc2tzLmF0UmVzdFRpbWVvdXRJZCA9IG51bGw7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNsZWFyZWQgcHJldmlvdXMgImF0IHJlc3QiIGNoZWNrLmApOwogICAgfQp9Cgphc3luYyBmdW5jdGlvbiBjaGVjaygpIHsKICAgIGNvbnN0IHJlY29uc3RpdHV0aW5nU2lnbmFsQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0U2lnbmFsQm90KTsKCiAgICBpZiAocmVjb25zdGl0dXRpbmdTaWduYWxCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3QgcmVjb25zaXRpdHV0aW9uIGlzIGF0IHJlc3RgKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2hvdXQoJ29uQUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uQXRSZXN0Jyk7CiAgICB9CgogICAgbWFza3MuYXRSZXN0VGltZW91dElkID0gbnVsbDsKfQoKbWFza3MuYXRSZXN0VGltZW91dElkID0gc2V0VGltZW91dChjaGVjaywgdGFncy5jaGVja0F0UmVzdFdhaXRNUyk7CicAgoacFa7wBAhyZW1lbWJlcgIEAIKGnBXB/QQo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAgoacFa7wBBNhYkNyZWF0ZUFydGlmYWN0Qm90AgQAgoacFej9BN4TQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLAogICAgZGltZW5zaW9uID0gbGlua3MubGVhcm4udGFncy5hYkluc3QgPz8gJ2hvbWUnLAogICAgcG9zaXRpb24gPSBuZXcgVmVjdG9yMygwLCAwLCAwKSwKICAgIG90aGVyVGFncyA9IHt9LAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0Qm90ID0gY3JlYXRlKHsKICAgIHNwYWNlOiAnc2hhcmVkJywKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgIGFiQXJ0aWZhY3RCb3Q6IHRydWUsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtgJHtkaW1lbnNpb259WGBdOiBwb3NpdGlvbi54LAogICAgW2Ake2RpbWVuc2lvbn1ZYF06IHBvc2l0aW9uLnksCiAgICBbYCR7ZGltZW5zaW9ufVpgXTogcG9zaXRpb24ueiwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBsYWJlbENvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIHN0cm9rZUNvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIG9uQm90QWRkZWQ6IGBACiAgICAgICAgdGhpc0JvdC51cGRhdGVDb21wdXRlZFRhZ3MoKTsKICAgIGAsCiAgICBvbkJvdENoYW5nZWQ6IGBACiAgICAgICAgY29uc3QgY2hhbmdlZFRhZ3MgPSB0aGF0LnRhZ3M7CgogICAgICAgIGlmIChjaGFuZ2VkVGFncy5zb21lKHQgPT4gdCA9PT0gJ2FiQXJ0aWZhY3RJbnN0YW5jZUlEJyB8fCB0ID09PSAnYWJBcnRpZmFjdE5hbWUnKSkgewogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZUNvbXB1dGVkVGFncygpOwogICAgICAgIH0KICAgIGAsCiAgICB1cGRhdGVDb21wdXRlZFRhZ3M6IGBACiAgICAgICAgbGV0IHN5c3RlbSA9ICdhYkFydGlmYWN0Qm90JzsKCiAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgc3lzdGVtICs9ICcuJyArIHRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRC5zdWJzdHJpbmcoMCwgNyk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9ICEhc3lzdGVtID8gc3lzdGVtIDogbnVsbDsKICAgICAgICB0YWdzLmxhYmVsID0gdGFncy5zeXN0ZW07CiAgICBgLAogICAgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlOiBgQAogICAgICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnbGFiZWwnLCAnICcsICdzaGFyZWQnKTsKICAgIGAsCiAgICAuLi5vdGhlclRhZ3MsCn0pOwoKdHJ5IHsKICAgIC8vIFVwZGF0ZSBhbGwgdGhlIHNoYXJkcyBmb3IgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZSAtLSB3aGljaCBub3cgaW5jbHVkZXMgdGhpcyBib3QhCiAgICBjb25zdCB1cGRhdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwoKICAgIGlmICghdXBkYXRlUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byB1cGRhdGUgJyR7YWJBcnRpZmFjdE5hbWV9JyBhcnRpZmFjdCBzaGFyZHMuYCk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaHQgZXJyb3Igd2hpbGUgdXBkYXRlIGFydGlmYWN0IHNoYXJkczpgLCBlKTsKICAgIGRlc3Ryb3koYWJBcnRpZmFjdEJvdCk7CiAgICByZXR1cm4gbnVsbDsKfQoKcmV0dXJuIGFiQXJ0aWZhY3RCb3Q7JwCChpwVrvAEFmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGUCBACChpwVx5EFpD9AaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmFzc2VydCh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJnIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLmApOwoKY29uc3QgewogICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cywKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gYXV0aEJvdD8uaWQgPz8gYWIubGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWUsCiAgICBlZ2dQYXJhbWV0ZXJzLCAvLyBFZ2cgcGFyYW10ZXJzIHRoYXQgeW91IHdvdWxkIGxpa2UgdG8gaGF2ZSBwYXNzZWQgdG8gdGhlIHJlY29uc2l0dXRlZCBib3RzIChvcHRpb25hbCkuCiAgICB0b2FzdCA9IHRydWUsCn0gPSB0aGF0IGFzIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmc7Cgphc3NlcnQoYWJBcnRpZmFjdEJ1bmRsZSAmJiBhYkFydGlmYWN0QnVuZGxlLmRhdGEgJiYgYWJBcnRpZmFjdEJ1bmRsZS5kZXBlbmRlbmNpZXMsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJ1bmRsZSBpcyByZXF1aXJlZCB0byBiZSBvZiB0eXBlIEFCQXJ0aWZhY3RCdW5kbGUuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgdG8gYmUgb2YgdHlwZSBzdHJpbmcuYCk7CgovLyBDcmVhdGUgYSB0ZW1wU2hhcmVkIGJvdCB0aGF0IGFjdHMgYXMgYSBzaWduYWwgdG8gZXZlcnlvbmUgdGhhdCB0aGlzIGFydGlmYWN0IGluc3RhbmNlIGlzIGluIHRoZSBwcm9jZXNzIG9mIGJlaW5nIHJlY29uc3RpdHV0ZWQuCmNvbnN0IHJlY29uc3RpdHV0aW5nU2lnbmFsQm90ID0gY3JlYXRlKHsKICAgIHNwYWNlOiAndGVtcFNoYXJlZCcsCiAgICBhYkJvdDogdHJ1ZSwKICAgIGFiUmVjb25zdGl0dXRpbmdBcnRpZmFjdFNpZ25hbEJvdDogdHJ1ZSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBjcmVhdGVkVGltZTogb3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZSwgLy8gVGhlIHRpbWUgdGhpcyBzaWduYWwgYm90IHdhcyBjcmVhdGVkLgogICAgYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0SW5zdGFuY2VJRDogYWJBcnRpZmFjdEluc3RhbmNlSUQsIC8vIFRoZSBpbnN0YW5jZSBpZCBvZiB0aGUgYXJ0aWZhY3QgYmVpbmcgcmVjb25zdGl0dXRlZC4KICAgIGFiUmVjb25zdGl0dXRpb25CeVJlbW90ZUlkOiBjb25maWdCb3QuaWQsIC8vIFRoZSByZW1vdGUgaWQgb2YgdGhlIHVzZXIgcGVyZm9ybWluZyB0aGUgcmVjb25zaXR1dGlvbi4KICAgIGFiQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmc6ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KHRoYXQpLCAvLyBBIGNvcHkgb2YgdGhlIHJlY29uc3RpdHV0ZSBhcmcgb2JqZWN0IGZvciB0aGlzIGZ1bmN0aW9uIGluIGNhc2UgaXQncyBuZWVkZWQuCiAgICBvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3QgeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9ID0gdGhhdDsKCiAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSB0YWdzLmFiUmVjb25zdGl0dXRpbmdBcnRpZmFjdEluc3RhbmNlSUQgJiYgdGhpc0JvdC5zcGFjZSAhPT0gJ3JlbW90ZVRlbXBTaGFyZWQnKSB7CiAgICAgICAgICAgIGlmIChsaW5rcy5tYW5hZ2VyLnRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0U2lnbmFsQm90XSBkZXN0cm95aW5nIHNlbGYgYmVjYXVzZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCAke3RhZ3MuYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0SW5zdGFuY2VJRH0gaGFzIHJlY29uc3RpdHV0ZWQuYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgfQogICAgfSksCiAgICBvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZDogTGlzdGVuZXJTdHJpbmcoKCkgPT4gewogICAgICAgIGNvbnN0IHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSA9IHRoYXQ7CgogICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gdGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RJbnN0YW5jZUlEICYmIHRoaXNCb3Quc3BhY2UgIT09ICdyZW1vdGVUZW1wU2hhcmVkJykgewogICAgICAgICAgICBpZiAobGlua3MubWFuYWdlci50YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgW2FiUmVjb25zdGl0dXRpbmdBcnRpZmFjdFNpZ25hbEJvdF0gZGVzdHJveWluZyBzZWxmIGJlY2F1c2UgYXJ0aWZhY3QgaW5zdGFuY2UgaWQgJHt0YWdzLmFiUmVjb25zdGl0dXRpbmdBcnRpZmFjdEluc3RhbmNlSUR9IGZhaWxlZCB0byByZWNvbnN0aXR1dGUuYCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICAgICAgfQogICAgfSkKfSk7Cgp0cnkgewoKICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmcgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKTsKICAgIGNvbnN0IHNoYXJkQm90cyA9IFtdOwoKICAgIGZ1bmN0aW9uIGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUoeyBib3REYXRhIH0pIHsKICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7IC8vIElmIHRoZSBzaGFyZCBib3QgaGFzIGl0c2VsZiBtYXJrZWQgYXMgcmVjb25zdGl0dXRlZCBhbHJlYWR5IChwb3NzaWJseSBkdWUgdG8gYW4gb3ZlcnNpZ2h0KSwgdGhlbiByZW1vdmUgaXQhCgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmc7IC8vIEFzc2lnbiB0aGUgYXJ0aWZhY3QgYnVuZGxlIGJhY2sgdG8gdGhlIGhhdGNoZWQgc2hhcmQgYm90LgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBhYkFydGlmYWN0SW5zdGFuY2VJRDsgLy8gVVVJRCBvZiB0aGUgYXJ0aWZhY3QgaW5zdGFuY2UgdGhhdCB0aGlzIGJvdCBiZWxvbmdzIHRvLgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjsgLy8gVGhlIHVzZXIgaWQgdGhlIG93bmVyIG9mIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UuCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRJbnN0YW5jZUlEID0gdXVpZCgpOyAvLyBVVUlEIGFzc2lnbmVkIHRvIHRoZSBib3QgYnkgdGhlIGFydGlmYWN0IHdoZW4gbG9hZGVkLgogICAgICAgIH0KICAgIH0KCiAgICBmb3IgKGNvbnN0IGRlcGVuZGVuY3kgb2YgYWJBcnRpZmFjdEJ1bmRsZS5kZXBlbmRlbmNpZXMpIHsKICAgICAgICBjb25zdCBkZXBlbmRlbmN5Qm90cyA9IFtdOwoKICAgICAgICBpZiAodGhpc0JvdC5pc0VnZ0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgY29uc3QgZWdnRGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kgYXMgQUJBcnRpZmFjdEVnZ0RlcGVuZGVuY3k7CgogICAgICAgICAgICAvLyBGaXJzdCB0cnkgdG8gbG9hZCBmcm9tIGVnZy4KICAgICAgICAgICAgY29uc3QgbG9va3VwRWdnUmVzdWx0ID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgICAgICAgICAgICAgIGFiSUQ6IGVnZ0RlcGVuZGVuY3kuYWJJRCwKICAgICAgICAgICAgICAgIHJlY29yZEtleTogZWdnRGVwZW5kZW5jeS5yZWNvcmRLZXksCiAgICAgICAgICAgICAgICBhYlZlcnNpb246IGVnZ0RlcGVuZGVuY3kuYWJWZXJzaW9uLAogICAgICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQogICAgICAgICAgICB9KQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9ICR7ZWdnRGVwZW5kZW5jeS5hYklEfSBsb29rdXBFZ2dSZXN1bHQ6YCwgbG9va3VwRWdnUmVzdWx0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxvb2t1cEVnZ1Jlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgbG9hZGVkIGRlcGVuZGVuY3kgYWJJRDogJHtlZ2dEZXBlbmRlbmN5LmFiSUR9LCBhYlZlcnNpb246ICR7ZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24gPz8gJ2xhdGVzdCd9YCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yIChjb25zdCBoYXRjaGVkQm90IG9mIGxvb2t1cEVnZ1Jlc3VsdC5oYXRjaGVkQm90cykgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChkZXBlbmRlbmN5Qm90cy5sZW5ndGggPT09IDAgJiYgdGhpc0JvdC5pc0Fza0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgY29uc3QgYXNrRGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kgYXMgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgogICAgICAgICAgICAvLyBUcnkgdG8gbG9hZCBmcm9tIGFzay4KICAgICAgICAgICAgY29uc3QgbG9va3VwQXNrUmVzdWx0OiBBQkxvb2t1cEFza0lEUmVzdWx0ID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQXNrSUQoewogICAgICAgICAgICAgICAgYXNrSUQ6IGFza0RlcGVuZGVuY3kuYXNrSUQsCiAgICAgICAgICAgICAgICBzaG93SW5kaWNhdG9yOiBmYWxzZSwKICAgICAgICAgICAgICAgIGF1dG9IYXRjaDogdHJ1ZSwKICAgICAgICAgICAgICAgIGlnbm9yZVJlc2VydmVkOiB0cnVlLAogICAgICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQogICAgICAgICAgICB9KQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrUmVzdWx0OmAsIGxvb2t1cEFza1Jlc3VsdCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChsb29rdXBBc2tSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBoYXRjaGVkQm90IG9mIGxvb2t1cEFza1Jlc3VsdC5oYXRjaGVkQm90cykgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChkZXBlbmRlbmN5Qm90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGZvciAoY29uc3Qgc2hhcmRCb3Qgb2YgZGVwZW5kZW5jeUJvdHMpIHsKICAgICAgICAgICAgICAgIHNoYXJkQm90cy5wdXNoKHNoYXJkQm90KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSBmYWlsZWQgdG8gbG9hZCBkZXBlbmRlbmN5OiAke0pTT04uc3RyaW5naWZ5KGRlcGVuZGVuY3kpfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgfQogICAgfQoKCiAgICBpZiAoc2hhcmRCb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAvLyBUZWxsIGFsbCBoYXRjaGVkIHNoYXJkIGJvdHMgdG8gcmVjb25zdGl0dXRlLiBUaGV5IGFsbCBoYXZlIGNvcGllcyBvZiB0aGUgYWJBcnRpZmFjdEJ1bmRsZSBhbmQgY2FuIHJlY29uc3RpdHV0ZSB0aGVtc2VsdmVzIGZyb20gdGhhdC4KICAgICAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUnLCB7IGRhdGE6IGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSB9KSk7CgogICAgICAgIGZvciAobGV0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgICAgICAgICBzZXRUYWdNYXNrKHNoYXJkQm90LCAnYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCcsIHRydWUsICdzaGFyZWQnKTsgLy8gVGhpcyBib3QgaGFzIGJlZW4gcmVjb25zdGl0dXRlZCBpbiB0aGlzIGluc3QuCiAgICAgICAgfQoKICAgICAgICBhd2FpdCB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBhYkFydGlmYWN0SW5zdGFuY2VPd25lciB9KTsKCiAgICAgICAgY29uc3QgcmVjb25zdGl0dXRpb25SZXN1bHQgPSB7CiAgICAgICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBhYkFydGlmYWN0QnVuZGxlLm5hbWUsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgc2hhcmRCb3RzLAogICAgICAgIH07CgogICAgICAgIHdoaXNwZXIoc2hhcmRCb3RzLCAnb25SZWNvbnN0aXR1dGVkJywgcmVjb25zdGl0dXRpb25SZXN1bHQpOwogICAgICAgIHNob3V0KCdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkJywgcmVjb25zdGl0dXRpb25SZXN1bHQpOwoKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZpbmlzaGVkIHJlY29uc3RpdHV0aW9uLmAsIHRvYXN0OiB0b2FzdCB9KTsKCiAgICAgICAgcmV0dXJuIHJlY29uc3RpdHV0aW9uUmVzdWx0OwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBmYWlsdXJlUmVzdWx0ID0gewogICAgICAgICAgICBlcnJvckNvZGU6ICdub19zaGFyZF9ib3RzJywKICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiAnUmVjb25zdGl0dXRpb24gcmVzdWx0cyBpbiBubyBzaGFyZCBib3RzLicsCiAgICAgICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBhYkFydGlmYWN0QnVuZGxlLm5hbWUsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICB9OwoKICAgICAgICBzaG91dCgnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBmYWlsdXJlUmVzdWx0KTsKCiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9JyAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBmYWlsZWQgcmVjb25zdGl0dXRpb24uYCwgdG9hc3Q6IHRvYXN0IH0pOwoKICAgICAgICByZXR1cm4gZmFpbHVyZVJlc3VsdDsKICAgIH0KCn0gZmluYWxseSB7CiAgICBkZXN0cm95KHJlY29uc3RpdHV0aW5nU2lnbmFsQm90KTsKfQonAIKGnBWu8AQXYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24CBACChpwV6NAFATEnAIKGnBWu8AQGc2VhcmNoAgQAgoacFerQBSjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCChpwVrvAEB2FiU2hlbGwCBACChpwVkdEFBHRydWUnAIKGnBWu8AQFdXRpbHMCBACChpwVltEFKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAIKGnBWu8AQPb25BbnlCb3RDbGlja2VkAgQAgoacFb3RBYEBQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGJvdCB9KQp9JwCChpwVrvAEFmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMCBACChpwVv9IFshxAY29uc3QgYWJBcnRpZmFjdE5hbWUgPSB0aGF0LmFiQXJ0aWZhY3ROYW1lOwpsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSB0aGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwpsZXQgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSB0aGF0LmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID8/IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lOwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKaWYgKHNoYXJkQm90cy5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVGhlcmUgYXJlIG5vIHNoYXJkcyBmb3IgYXJ0aWZhY3QgbmFtZSAnJHthYkFydGlmYWN0TmFtZX0nLmAsIGxvZ1R5cGU6ICd3YXJuJyB9KTsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KCmNvbnN0IHByZXZBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHNoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CmNvbnN0IHByZXZBcnRpZmFjdElEID0gcHJldkFydGlmYWN0QnVuZGxlID8gcHJldkFydGlmYWN0QnVuZGxlLmlkIDogbnVsbDsKY29uc3QgcHJldkFydGlmYWN0SW5zdGFuY2VPd25lciA9IHNoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwoKbGV0IGNvbGxlY3RTaGFyZFJlc3VsdDogQUJBcnRpZmFjdENvbGxlY3RTaGFyZHNSZXN1bHQ7Cgp0cnkgewogICAgY29sbGVjdFNoYXJkUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hYkNvbGxlY3RBcnRpZmFjdFNoYXJkcyh7IHNoYXJkQm90cyB9KTsKCiAgICBpZiAoIWNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGNvbGxlY3RTaGFyZFJlc3VsdC5yZWFzb24sIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9IGNhdGNoKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFNvbWV0aGluZyB3ZW50IHdyb25nIGNvbGxlY3Rpbmcgc2hhcmRzLiBTZWUgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Cn0KCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSB0aGlzQm90LmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdFNoYXJkOiBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQgfSk7CgppZiAocHJldkFydGlmYWN0SUQgJiYgcHJldkFydGlmYWN0SUQgIT09IGFiQXJ0aWZhY3RCdW5kbGUuaWQpIHsKICAgIC8vIFRoZSBhcnRpZmFjdCBoYXMgYSBuZXcgaWQuIEFsbCBvZiB0aGUgc2hhcmQgYm90cyBuZWVkIGEgbmV3IGluc3RhbmNlIGlkIGFzIHdlbGwuCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKCiAgICBmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBhYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5hbCBtZXJnZWQgYXJ0aWZhY3QgJHthYkFydGlmYWN0TmFtZX06YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIEV2ZXJ5IHNoYXJkIGJvdCBnZXRzIGEgY29weSBvZiB0aGUgYXJ0aWZhY3QgYnVuZGxlLgovLyBUaGlzIG1ha2VzIHRoZSBhcnRpZmFjdCBob2xvZ3JhcGhpYyBieSBuYXR1cmUuIFRoaXMgbWVhbnMgdGhhdCBhbnkgc2hhcmQgY2FuIGJlIHVzZWQgdG8gcmVjb25zdGl0dXRlIHRoZSB3aG9sZS4KZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIC8vIE1hcmsgZWFjaCBzaGFyZCBib3QgYXMgYmVpbmcgJ3JlY29uc3RpdHV0ZWQnIHdoZW4gd2UgdXBkYXRlIHRoZSBhcnRpZmFjdC4KICAgIC8vIEJlY2F1c2UgdGhpcyBpcyBhIHNoYXJlZCB0YWcgbWFzaywgaXQgd2lsbCBvbmx5IGJlIHRydWUgaW4gdGhlIGN1cnJlbnQgaW5zdC4KICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOwogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlID0gICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwoKICAgIC8vIElmIHRoZSBzaGFyZEJvdCBoYXNudCBiZWVuIG1hcmtlZCBhcyBoYXZpbmcgYW4gaW5zdGFuY2Ugb3duZXIgT1IgaXRzIG93bmVyIGRvZXNudCBtYXRjaCB0aGUgb25lIGJlaW5nIHByb3ZpZGVkIHRvCiAgICAvLyB0aGlzIHVwZGF0ZSBmdW5jdGlvbiB0aGVuIHdlIGNoYW5nZSBpdC4KICAgIGlmICghc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciB8fCBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyICE9PSBhYkFydGlmYWN0SW5zdGFuY2VPd25lcikgewogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKICAgIH0KfQoKLy8gUnlhbiBDb29rOiBOZWVkIHRvIGdpdmUgQ2FzdWFsT1MgYSBjaGFuY2UgdG8gY2F0Y2h1cC4KLy8gRm91bmQgdGhhdCBpZiB3ZSBkaWRudCBkbyB0aGlzLCBtb2QgdGFncyB3b3VsZCBub3QgYmUgcmV0dXJuZWQgYXMgSlNPTiBvYmplY3RzIGJ1dCBpbnN0ZWFkIHRoZSByYXcgc3RyaW5nLgphd2FpdCBvcy5zbGVlcCgwKTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0ZWQgYXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9Jy4gQ29waWVkIGFydGlmYWN0IGJ1bmRsZSB0byAke3NoYXJkQm90cy5sZW5ndGh9IGJvdHMuIGFiQXJ0aWZhY3RCdW5kbGU6YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCnNob3V0KCdvbkFueUFCQXJ0aWZhY3RTaGFyZHNVcGRhdGVkJywgeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLCBhYkFydGlmYWN0QnVuZGxlLCBzaGFyZEJvdHMgfSkKCi8vIFNoYXJkIHVwZGF0ZSBzdWNjZXNzZnVsLgpyZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07JwCChpwVrvAEBG1lbnUCBACChpwV8O4FKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAIKGnBWu8AQFbGVhcm4CBACChpwVl+8FKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAIKGnBWu8AQLb25HcmlkQ2xpY2sCBACChpwVvu8FRkBpZiAobGlua3MuYXJ0aWZhY3RNZW51Qm90cykgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7Cn0nAIKGnBWu8AQaYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQCBACChpwVhfAFByNBRUExRkYnAIKGnBWu8AQbYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0AgQAgoacFY3wBQcjMWUxYjJkJwCChpwVrvAEEG9uQW55Qm90c1JlbW92ZWQCBACChpwVlfAFjARAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7CgppZiAobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkICYmIGJvdElEcy5pbmNsdWRlcyhtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQpKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfQoKZm9yIChsZXQgYm90SUQgb2YgYm90SURzKSB7CiAgICBjb25zdCBkZWxldGVkID0gdGhpc0JvdC52YXJzLnJlY29uc3RpdHV0aW5nU2lnbmFsQm90SWRzLmRlbGV0ZShib3RJRCk7CgogICAgaWYgKGRlbGV0ZWQpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRldGVjdGVkIHJlbW92ZWQgcmVjb25zdGl0dXRpb24gc2lnbmFsIGJvdCwgd2lsbCBub3cgYmVnaW4gY2hlY2sgaWYgcmVjb25zaXRpdHVpb24gaXMgYXQgcmVzdC5gKTsKICAgICAgICB9CgogICAgICAgIHRoaXNCb3QuYWJDaGVja0FydGlmYWN0UmVjb25zdGl0dXRpb25BdFJlc3QoKTsKICAgIH0KfScAgoacFa7wBAd2ZXJzaW9uAgQAgoacFaL0BSjwn5SXNTI4ZGMwZjktNDNlYy00M2YzLWE0NzAtZTJkZDZhMGRhOTVmJwCChpwVrvAEGGFiR2V0QXJ0aWZhY3ROYW1lc0luSW5zdAIEAIKGnBXJ9AWsAUBjb25zdCBhYkFydGlmYWN0TmFtZXMgPSBuZXcgU2V0KCk7CgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWVzLmFkZChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpOwogICAgfQp9KQoKcmV0dXJuIGFiQXJ0aWZhY3ROYW1lczsnAIKGnBWu8AQVYWJBcnRpZmFjdEJvdE1lbnVPcGVuAgQAgoacFfb1BdUXQGNvbnN0IHsgYWJBcnRpZmFjdEJvdCB9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0Qm90ICYmIGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCnNob3V0KCJhYkFydGlmYWN0Qm90TWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkFydGlmYWN0TWVudSI7CgppZiAoIXRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwp9Cgpjb25zdCBhYkFydGlmYWN0QmFzZUNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0QmFzZUNvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQ7CmNvbnN0IGFiQXJ0aWZhY3RMYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0TGFiZWxDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdDsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKCmxldCBpbmZvTGFiZWwgPSBgW2FydGlmYWN0IG5hbWVdOiAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGlkXTogJHthYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLCA3KX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGluc3RhbmNlIGlkXTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPz8gJ3Vuc2V0J30gXG5gOwppbmZvTGFiZWwgKz0gYFthcnRpZmFjdCBpbnN0YW5jZSBvd25lcl06ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID8/ICd1bnNldCd9IFxuYDsKaW5mb0xhYmVsICs9IGBbcmVjb25zdGl0dXRlZCBpbiBpbnN0XTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZH1cbmA7CmluZm9MYWJlbCArPSBgW2Zvcm1hdF06IHYke2FiQXJ0aWZhY3RCdW5kbGUuZm9ybWF0VmVyc2lvbn1cbmA7CmluZm9MYWJlbCArPSBgW2NyZWF0ZWQgdGltZV06ICR7RGF0ZVRpbWUuZnJvbUlTTyhhYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXApLnRvTG9jYWxlU3RyaW5nKERhdGVUaW1lLkRBVEVUSU1FX1NIT1JUX1dJVEhfU0VDT05EUyl9XG5gOwoKLy8gSGVhZGVyCmNvbnN0IGluZm9Cb3QgPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudVRleHQoewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBsYWJlbDogaW5mb0xhYmVsLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGluZm9Cb3QpOwoKLy8gRG93bmxvYWQgc2hhcmQgYnV0dG9uLgpjb25zdCBkb3dubG9hZEJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdkb3dubG9hZCcsCiAgICBsYWJlbDogYGRvd25sb2FkIHNoYXJkYCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSAnYWJBcnRpZmFjdC0nICsgYWJBcnRpZmFjdEJ1bmRsZS5uYW1lICsgJy0nICsgYWJBcnRpZmFjdEJ1bmRsZS5pZC5zdWJzdHJpbmcoMCw3KSArICcuYXV4JzsgCiAgICAgICAgb3MuZG93bmxvYWRCb3RzKFsgbGlua3MuYWJBcnRpZmFjdEJvdCBdLCBmaWxlbmFtZSk7CiAgICAgICAgCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwogICAgYCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaChkb3dubG9hZEJ1dHRvbik7CgovLyBVcGRhdGUgYXJ0aWZhY3QgYnV0dG9uLgpjb25zdCB1cGRhdGVCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGFiQXJ0aWZhY3RCb3Q6IGdldExpbmsoYWJBcnRpZmFjdEJvdCksCiAgICBhYkFydGlmYWN0VG9vbDogZ2V0TGluayh0aGlzQm90KSwKICAgIGZvcm1BZGRyZXNzOiAnc3luYycsCiAgICBsYWJlbDogYHVwZGF0ZSBhcnRpZmFjdGAsCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IGxpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gYWJBcnRpZmFjdEJ1bmRsZS5uYW1lOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgICAgIAogICAgICAgIGF3YWl0IGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwoKICAgICAgICBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYkFydGlmYWN0Qm90TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBsaW5rcy5hYkFydGlmYWN0Qm90IH0pOwogICAgYCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaCh1cGRhdGVCdXR0b24pOwoKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gYWJBcnRpZmFjdEJvdC5pZDsnAIKGnBWu8AQZYWJEb3dubG9hZEFydGlmYWN0UGF0dGVybgIEAIKGnBXMjQaIBUBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIHNoYXJkQm90cywKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3ROYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiRG93bmxvYWQoeyAKICAgIHBvc3NpYmxlQm90czogc2hhcmRCb3RzLAogICAgZmlsZW5hbWU6IGAke2FiQXJ0aWZhY3ROYW1lfWAsCiAgICBzb3VyY2VFdmVudDogJ2Rvd25sb2FkX2FydGlmYWN0X3BhdHRlcm4nLAogICAgcmVvcGVuQWJNZW51OiBmYWxzZSwKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkOiBhc3luYyAoYXJnKSA9PiB7CiAgICAgICAgYXdhaXQgdGhpc0JvdC5hYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YShhcmcuYm90RGF0YSk7CiAgICB9Cn0pOycAgoacFa7wBBZhYkFydGlmYWN0Qm90TWVudVJlc2V0AgQAgoacFdWSBu8BQGlmICh0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyAmJiB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5sZW5ndGggPiAwKSB7CiAgICBkZXN0cm95KHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKTsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gbnVsbDsnAIKGnBWu8AQFdHlwZXMCBACChpwVxZQG+wnwn5OEaW50ZXJmYWNlIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgewogICAgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZTsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEPzogc3RyaW5nOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cz86IHN0cmluZzsKICAgIGVnZ1BhcmFtZXRlcnM/OiBhbnk7CiAgICB0b2FzdD86IGJvb2xlYW47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeSB7CiAgICBhYklEOiBzdHJpbmc7CiAgICByZWNvcmRLZXk6IHN0cmluZzsKICAgIGFiVmVyc2lvbj86IG51bWJlcjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5IHsKICAgIGFza0lEOiBzdHJpbmc7Cn0KCnR5cGUgQUJBcnRpZmFjdERlcGVuZGVuY3kgPSBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeSB8IEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5OwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RCdW5kbGUgewogICAgaWQ6IHN0cmluZzsKICAgIG5hbWU6IHN0cmluZzsKICAgIGZvcm1hdFZlcnNpb246IG51bWJlcjsKICAgIGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT47CiAgICBkZXBlbmRlbmNpZXM6IEFycmF5PEFCQXJ0aWZhY3REZXBlbmRlbmN5PjsKICAgIGNhc3VhbE9TVmVyc2lvbjogQXV4VmVyc2lvbjsKICAgIGNyZWF0ZWRUaW1lc3RhbXA6IHN0cmluZzsKICAgIGFiU2hlbGxWZXJzaW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0U2hhcmQgewogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2UgewogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFeHBlcmllbmNlQXV0aCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogc3RyaW5nOwogICAgYXV0aG9yaXplZDogYm9vbGVhbjsKICAgIGZhaWx1cmVSZWFzb246IEFCQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmVSZWFzb247Cn0KCnR5cGUgQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX3NpZ25faW4nIHwgJ3VzZXJfZGVjbGluZWRfaW5zdF9wZXJtaXNzaW9uJyB8ICd1bmtub3duJzsKCmludGVyZmFjZSBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuOwogICAgcmVhc29uPzogYW55OwogICAgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKfQonAIKGnBWu8AQab25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUCBACChpwVv54G4T9AaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmNvbnN0IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoYXQpKSk7Cn0KCmlmIChzb3VyY2VFdmVudCA9PT0gJ2FzaycgfHwgCiAgICBzb3VyY2VFdmVudCA9PT0gJ3Bhc3RlJyB8fCAKICAgIHNvdXJjZUV2ZW50ID09PSAnYm9vdCcgfHwgCiAgICBzb3VyY2VFdmVudCA9PT0gJ2ZpbGVfdXBsb2FkJyB8fAogICAgc291cmNlRXZlbnQgPT09ICd0b29sJyB8fAogICAgc291cmNlRXZlbnQgPT09ICdjcmVhdGVfYXJ0aWZhY3RfcHJvbWlzZScKKSB7CiAgICAvLyBDaGVjayB0byBzZWUgaWYgdGhlIGJvdHMgYmVpbmcgYWRkZWQgYXJlIGFydGlmYWN0IHNoYXJkcyB0aGF0IG5lZWRzIHRvIGJlIHJlY29uc3RpdHV0ZWQuCiAgICBjb25zdCBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZTogUmVjb3JkPHN0cmluZywgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZz4gPSB7fTsgLy8gS2V5IGlzIGFydGlmYWN0IGluc3RhbmNlIGlkLgogICAgY29uc3QgZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlczogUmVjb3JkPHN0cmluZywgQm90W10+ID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VzKCk7CiAgICBjb25zdCBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZTogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7IC8vIFRoaXMgc2V0IHRyYWNrcyBhcnRpZmFjdCBpZHMgdGhhdCBhcmUgYWxyZWFkeSBxdWV1ZWQgdG8gYmUgcmVjb25zdGl0dXRlZCB3aXRoIGEgbmV3IGluc3RhbmNlIGlkLgogICAgY29uc3Qgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQ6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpOyAvLyBUcmFjayBvcmlnaW5hbCBpbnN0YW5jZSBJRHMgdGhhdCB3ZSd2ZSBhbHJlYWR5IGRlY2lkZWQgdG8gZ2l2ZSBuZXcgaW5zdGFuY2VzCgogICAgZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgICAgIGlmIChkYXRhICYmCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSAmJgogICAgICAgICAgICAhZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQgJiYKICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU/LnN0YXJ0c1dpdGgoJ/Cfp6wnKQogICAgICAgICkgewogICAgICAgICAgICBjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRDogc3RyaW5nID0gZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgICAgICBjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjogc3RyaW5nID0gZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gSlNPTi5wYXJzZShkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZS5zdWJzdHJpbmcoMikpOwoKICAgICAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgICAgICAgICAvLyBTaGFyZCBoYXMgYW4gYXJ0aWZhY3QgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSAmJiAhb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMTogSW5zdGFuY2UgYWxyZWFkeSBleGlzdHMgLSBjcmVhdGUgbmV3IGluc3RhbmNlIChmaXJzdCB0aW1lIHdlIHNlZSB0aGlzIGNvbGxpc2lvbikKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdBcnRpZmFjdEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbbmV3QXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IG5ld0FydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91czogYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuYWRkKGFiQXJ0aWZhY3RCdW5kbGUuaWQpOyAvLyBUcmFjayB0aGF0IHdlJ3JlIGNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIGZvciB0aGlzIGFydGlmYWN0IElECiAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuYWRkKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsgLy8gVHJhY2sgdGhhdCB3ZSd2ZSBkZWNpZGVkIHRvIHJlcGxhY2UgdGhpcyBvcmlnaW5hbCBpbnN0YW5jZSBJRAoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMTogU2hhcmQgZnJvbSBleGlzdGluZyBpbnN0YW5jZS4gQ3JlYXRpbmcgbmV3IGluc3RhbmNlLiAob2xkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSwgbmV3OiAke25ld0FydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxYjogV2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBvcmlnaW5hbCBJRCAtIGRpc3Bvc2UuCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDFiOiBBZGRpdGlvbmFsIHNoYXJkIGZvciByZXBsYWNlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAob3JpZ2luYWw6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDI6IEluc3RhbmNlIGFscmVhZHkgcXVldWVkIGZvciByZWNvbnN0aXR1dGlvbiAtIGRpc3Bvc2UgZHVwbGljYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDI6IER1cGxpY2F0ZSBzaGFyZCBmb3IgcXVldWVkIGluc3RhbmNlLiBEaXNwb3NpbmcuIChhYkFydGlmYWN0SW5zdGFuY2VJRDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDM6IEluc3RhbmNlIHRvIHJlY29uc3RpdHV0ZSB3aXRoIGV4aXN0aW5nIElECiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGVnZ1BhcmFtZXRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMzogSW5zdGFuY2UgdG8gcmVjb25zdGl0dXRlLiAoYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFNoYXJkIGhhcyBubyBhcnRpZmFjdCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgaWYgKGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmhhcyhhYkFydGlmYWN0QnVuZGxlLmlkKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgNDogQXJ0aWZhY3QgYWxyZWFkeSBoYXMgbmV3IGluc3RhbmNlIHF1ZXVlZCAtIGRpc3Bvc2UgZHVwbGljYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDQ6IER1cGxpY2F0ZSBzaGFyZCBmb3IgYXJ0aWZhY3Qgd2l0aCBuZXcgaW5zdGFuY2UgcXVldWVkLiBEaXNwb3NpbmcuIChhcnRpZmFjdElkOiAke2FiQXJ0aWZhY3RCdW5kbGUuaWR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSA1OiBDcmVhdGUgbmV3IGluc3RhbmNlIGZvciBhcnRpZmFjdCB3aXRob3V0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW25ld0FydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBuZXdBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuYWRkKGFiQXJ0aWZhY3RCdW5kbGUuaWQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgNTogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIGZvciBhcnRpZmFjdCB3aXRob3V0IGluc3RhbmNlIElELiAobmV3OiAke25ld0FydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgYSBzaGFyZCBib3QuIElnbm9yZSBpdC4KICAgICAgICB9CiAgICB9CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlOmAsIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXM6YCwgZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlcyk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZTpgLCBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZSk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZDpgLCBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZCk7CiAgICB9CgogICAgZm9yIChjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZSkgewogICAgICAgIGNvbnN0IHJlY29uc3RpdHV0ZUFyZzogQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZyA9IGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKICAgICAgICAKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFJlY29uc3RpdHV0aW5nIGFydGlmYWN0IGluc3RhbmNlOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGUocmVjb25zdGl0dXRlQXJnKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGlmIChzb3VyY2VFdmVudCA9PT0gJ2NyZWF0ZV9hcnRpZmFjdF9wcm9taXNlJykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICAgICAgICAgICAgICAvLyBEbyBhIHNwZWNpYWwgc2hvdXQgc28gdGhhdCB0aGUgY3JlYXRlIGFydGlmYWN0IHByb21pc2UgZnVuY3Rpb24gY2FuIGNhdGNoIHRoaXMgZXJyb3IuCiAgICAgICAgICAgICAgICBjb25zdCBmYWlsdXJlUmVzdWx0ID0gewogICAgICAgICAgICAgICAgICAgIGVycm9yQ29kZTogJ2FydGlmYWN0X3Byb21pc2VfcmVjb25zdGl0dXRpb25fZmFpbGVkJywKICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2U6IGBSZWNvbnN0aXR1dGlvbiBmcm9tIGFydGlmYWN0IHByb21pc2UgaGFzIGZhaWxlZC4gQ2F1Z2h0IGVycm9yOiAke2xpbmtzLnV0aWxzLmdldEVycm9yTWVzc2FnZShlKX1gLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3ROYW1lOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEJ1bmRsZS5uYW1lLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91czogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXI6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzOiByZWNvbnN0aXR1dGVBcmcuZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkJywgZmFpbHVyZVJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgfQp9JwCChpwVrvAEG29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaAIEAIKGnBWf3galAkBpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9Cgp0aGlzQm90LmFiUHJlcHJvY2Vzc0JvdERhdGFUb0FydGlmYWN0UHJvbWlzZXMoeyBib3REYXRhOiB0aGF0LmJvdERhdGEgfSk7JwCChpwVrvAEFmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMCBACChpwVxeAGygdAY29uc3QgeyAKICAgIGJvdHMsCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge30KCmlmIChib3RzKSB7CiAgICBhc3NlcnQoQXJyYXkuaXNBcnJheShib3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIG11c3QgYmUgYW4gYXJyYXkuYCk7Cn0KCmNvbnN0IGluc3RhbmNlczogUmVjb3JkPHN0cmluZywgQm90W10+ID0ge30gLy8gS2V5IGlzIGFydGlmYWN0IGluc3RhbmNlIGlkLgoKZnVuY3Rpb24gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYm90KSB7CiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbGV0IGJvdEFycmF5ID0gaW5zdGFuY2VzW2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICAgICAgaWYgKCFib3RBcnJheSkgewogICAgICAgICAgICBib3RBcnJheSA9IFtdOwogICAgICAgICAgICBpbnN0YW5jZXNbYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSURdID0gYm90QXJyYXk7CiAgICAgICAgfQoKICAgICAgICBib3RBcnJheS5wdXNoKGJvdCk7CiAgICB9Cn0KCmlmIChib3RzKSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgaW5zdGFuY2VzIGluIHByb3ZpZGVkIGxpc3Qgb2YgYm90cy4KICAgIGJvdHMuZm9yRWFjaChiID0+IHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGIpKTsKfSBlbHNlIHsKICAgIC8vIEdldCBhcnRpZmFjdCBpbnN0YW5jZXMgaW4gaW5zdC4KICAgIGdldEJvdHMoYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShiKSk7Cn0KCnJldHVybiBpbnN0YW5jZXM7JwCChpwVrvAEFWFiR2V0QXJ0aWZhY3RQYXR0ZXJucwIEAIKGnBWQ6AbzB0Bjb25zdCB7IAogICAgYm90cywKICAgIGFiQXJ0aWZhY3ROYW1lLAp9ID0gdGhhdCA/PyB7fQoKaWYgKGJvdHMpIHsKICAgIGFzc2VydChBcnJheS5pc0FycmF5KGJvdHMpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgbXVzdCBiZSBhbiBhcnJheS5gKTsKfQoKY29uc3QgcGF0dGVybnM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHt9IC8vIEtleSBpcyBhcnRpZmFjdCBuYW1lLgoKZnVuY3Rpb24gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihib3QpIHsKICAgIC8vIFBhdHRlcm4gYm90cyBoYXZlIGFiQXJ0aWZhY3ROYW1lIGJ1dCBubyBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmICFib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBib3QudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBsZXQgYm90QXJyYXkgPSBwYXR0ZXJuc1tib3QudGFncy5hYkFydGlmYWN0TmFtZV07CgogICAgICAgIGlmICghYm90QXJyYXkpIHsKICAgICAgICAgICAgYm90QXJyYXkgPSBbXTsKICAgICAgICAgICAgcGF0dGVybnNbYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWVdID0gYm90QXJyYXk7CiAgICAgICAgfQoKICAgICAgICBib3RBcnJheS5wdXNoKGJvdCk7CiAgICB9Cn0KCmlmIChib3RzKSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgcGF0dGVybnMgaW4gcHJvdmlkZWQgbGlzdCBvZiBib3RzLgogICAgYm90cy5mb3JFYWNoKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihiKSk7Cn0gZWxzZSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgcGF0dGVybnMgaW4gaW5zdC4KICAgIGdldEJvdHMoYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGIpKTsKfQoKcmV0dXJuIHBhdHRlcm5zOycAgoacFa7wBBhhYlB1Ymxpc2hBcnRpZmFjdFBhdHRlcm4CBACChpwVhPAGhgZAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzdHVkaW8sCiAgICBzaGFyZEJvdHMsCiAgICBtYW51YWxQdWJsaXNoLAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdE5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBzdHVkaW8gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0dWRpbyBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiUHVibGlzaEFCKHsKICAgIGFiOiBhYkFydGlmYWN0TmFtZSwgCiAgICB0YXJnZXQ6IHNoYXJkQm90cywgCiAgICBzdHVkaW8sCiAgICBtYW51YWxQdWJsaXNoLAogICAgc291cmNlRXZlbnQ6ICdwdWJsaXNoX2FydGlmYWN0X3BhdHRlcm4nLAogICAgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaDogYXN5bmMgKGFyZykgPT4gewogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAIKGnBWu8AQmYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGECBACChpwVi/YGkwdAY29uc3QgYm90RGF0YSA9IHRoYXQ7Cgphc3NlcnQobGlua3MudXRpbHMuaXNPYmplY3QoYm90RGF0YSksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJndW1lbnQgbXVzdCBiZSBhbiBvYmplY3QuYCk7Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwogICAgCiAgICBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3RCb3QgPT09IHRydWUpIHsKICAgICAgICAvLyBSZW1vdmUgYXJ0aWZhY3QgYm90cy4KICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgIAogICAgfSBlbHNlIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAvLyBTdHJpcCBhcnRpZmFjdCBpbnN0YW5jZSBkYXRhIGZyb20gYm90LgogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKCiAgICAgICAgLy8gUmVtb3ZlIHNvbWUgb3RoZXJzLgogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuY3JlYXRvcjsKCiAgICAgICAgLy8gR2l2ZSBlYWNoIGJvdCBhIGNoYW5jZSB0byBzdHJpcCBpbnN0YW5jZSBkYXRhIGZyb20gdGhlIGNvcHkgb2YgaXRzIG93biBib3QgZGF0YS4KICAgICAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihkYXRhLmlkLCAnb25BQlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YScsIHsgZGF0YSB9KSk7CiAgICB9Cn0nAIKGnBWu8AQPaXNFZ2dEZXBlbmRlbmN5AgQAgoacFZ/9BlJAcmV0dXJuIGxpbmtzLnV0aWxzLmlzU3RyaW5nKHRoYXQ/LmFiSUQpICYmIGxpbmtzLnV0aWxzLmlzU3RyaW5nKHRoYXQ/LnJlY29yZEtleSk7JwCChpwVrvAED2lzQXNrRGVwZW5kZW5jeQIEAIKGnBXy/QYqQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hc2tJRCk7JwCChpwVrvAEEG9uQW55Qm90c0NoYW5nZWQCBACChpwVnf4GyQhALy8gY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwoKZm9yIChjb25zdCBjaGFuZ2VkIG9mIHRoYXQpIHsKICAgIGlmIChjaGFuZ2VkID09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgIH0KCiAgICAvLyAxKSBvbmx5IGNhcmUgYWJvdXQgYm90cyB3aXRoIGFydGlmYWN0IHRhZ3MKICAgIGlmICghY2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0TmFtZSB8fCAhY2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgY29udGludWU7CgogICAgLy8gMikgYXJ0aWZhY3QgbXVzdCBiZSByZWNvbnN0aXR1dGVkLgogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIGNvbnRpbnVlOwoKICAgIGlmICh0aGlzQm90LmlzRXhwZXJpZW5jZUVuYWJsZWQoKSkgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2hhbmdlcyBvbiBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2NoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGRldGVjdGVkLCBjYWxsaW5nIHRvIHVwZGF0ZSBleHBlcmllbmNlLmAsIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgIGNoYW5nZWRCb3RJZDogY2hhbmdlZC5ib3QuaWQsCiAgICAgICAgICAgICAgICBjaGFuZ2VkVGFnczogY2hhbmdlZC50YWdzLAogICAgICAgICAgICB9KSk7CiAgICAgICAgfQogICAgICAgIHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdCBpbnN0YW5jZSAke2NoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGNoYW5nZWQgYnV0IGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICAgICAgfQogICAgfQp9CicAgoacFa7wBBlleHBlcmllbmNlVGlja1JhdGVMaW1pdE1TAgQAgoacFeeGBwQ1MDAwJwCChpwVrvAEFmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWcCBACChpwV7IYHGW9uQUJBcnRpZmFjdENvbGxlY3RTaGFyZHMnAIKGnBWu8AQIZGVidWdFeHACBACChpwVhocHBWZhbHNlJwCChpwVrvAEF2lzUmVjb25zdGl0dXRpb25FbmFibGVkAgQAgoacFYyHB3xAaWYgKGNvbmZpZ0JvdC50YWdzLmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbiA9PT0gZmFsc2UpIHsKICAgIHJldHVybiBmYWxzZTsKfQoKLy8gUmVjb25zdGl0dXRpb24gb24gYnkgZGVmYXVsdC4KcmV0dXJuIHRydWU7JwCChpwVrvAEF2FiQ29sbGVjdEFydGlmYWN0U2hhcmRzAgQAgoacFYmIB9AYQGNvbnN0IHsgc2hhcmRCb3RzIH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgcmVxdWlyZWQgdG8gYmUgYW4gYm90IGFycmF5LmApOwoKLyoqIEtlZXAgdHJhY2sgb2YgZGVwZW5kZW5jeSBoYXNoZXMuIFRoaXMgcHJldmVudHMgZHVwbGljYXRlcyBpbiB0aGUgYXJ0aWZhY3QgZGVwZW5kZW5jaWVzLiAqLwpjb25zdCBkZXBlbmRlbmN5SGFzaGVzID0gbmV3IFNldCgpOwoKbGV0IG1lcmdlZFNoYXJkOiBBQkFydGlmYWN0U2hhcmQgPSB7CiAgICBkYXRhOiB7fSwKICAgIGRlcGVuZGVuY2llczogW10sCn07Cgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgY29uc3QgYm90U2hvcnRJZCA9IHNoYXJkQm90LmlkLnN1YnN0cmluZygwLCA1KTsKCiAgICBsZXQgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKICAgIGlmIChzaGFyZEJvdC50YWdzW3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10pIHsKICAgICAgICBpZiAoc2hhcmRCb3RbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSkgewogICAgICAgICAgICBzaGFyZCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShzaGFyZEJvdFt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHRhZyBpcyBkZWZpbmVkIGJ1dCBpcyBub3QgYSB2YWxpZCBmdW5jdGlvbi5gIH07CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgc2hhcmQ6YCwgc2hhcmQpOwogICAgfQoKICAgIGlmIChzaGFyZCkgewogICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQpKSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCBtdXN0IGJlIGFuIG9iamVjdC5gIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGF0YSkgewogICAgICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzT2JqZWN0KHNoYXJkLmRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgJ2RhdGEnIHByb3BlcnR5IG11c3QgYmUgYW4gb2JqZWN0LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2hhbGxvdyBtZXJnZSBzaGFyZCdzIGRhdGEgcHJvcGVydGllcyBpbnRvIGNvbWJpbmVkIGFydGlmYWN0IGRhdGEuCiAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRhdGEgPSB7IC4uLm1lcmdlZFNoYXJkLmRhdGEsIC4uLnNoYXJkLmRhdGEgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc0FycmF5KHNoYXJkLmRlcGVuZGVuY2llcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCAnZGVwZW5kZW5jaWVzJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIGFycmF5LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgdGhhdCBkZXBlbmRlbmN5IGlzIG9uZSBvZiB0aGUgc3VwcG9ydGVkIHR5cGVzLgogICAgICAgICAgICAgICAgaWYgKCF0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSAmJiAhdGhpc0JvdC5pc0Fza0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIGhhcyBhIGRlcGVuZGVuY3kgZW50cnkgdGhhdCBpcyBuZWl0aGVyIGFuIGVnZyBvciBhc2sgZGVwZW5kZW5jeSB0eXBlLmAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBkZXBlbmRlbmN5IGlzbnQgYWxyZWFkeSBjb2xsZWN0ZWQuCiAgICAgICAgICAgICAgICBjb25zdCBoYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgZGVwZW5kZW5jeSk7CgogICAgICAgICAgICAgICAgaWYgKCFkZXBlbmRlbmN5SGFzaGVzLmhhcyhoYXNoKSkgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lIYXNoZXMuYWRkKGhhc2gpOwogICAgICAgICAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBNYWtlIHN1cmUgd2UgaGF2ZSBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeS4KaWYgKG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIG11c3QgbGlzdCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeSBpbiBvcmRlciB0byByZWNvbnN0aXR1dGUgcHJvcGVybHkuYCB9Owp9Cgpjb25zdCByZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0ID0gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIHNoYXJkOiBtZXJnZWRTaGFyZCwKfQoKcmV0dXJuIHJlc3VsdDsnAIKGnBWu8AQXY2FuVXNlclVwZGF0ZUV4cGVyaWVuY2UCBACChpwV2qAHzglAY29uc3QgewogICAgcmVtb3RlSWQgPSBjb25maWdCb3QuaWQsCiAgICBzaGFyZEJvdAp9ID0gdGhhdCA/PyB7fQoKaWYgKHNoYXJkQm90ICYmIAogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0TmFtZSAmJgogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRAopIHsKICAgIC8vIE5lZWQgdG8gZmlndXJlIG91dCBpZiB0aGlzIHVzZXIgaXMgYWxsb3dlZCB0byB1cGRhdGUgdGhlIGV4cGVyaWVuY2Ugb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgIGxldCBjYW5Vc2VyVXBkYXRlID0gZmFsc2U7CgogICAgc3dpdGNoIChzaGFyZEJvdC5zcGFjZSkgewogICAgICAgIGNhc2UgJ3NoYXJlZCc6CiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgIGNhc2UgJ3RlbXBTaGFyZWQnOgogICAgICAgICAgICAvLyB0ZW1wU2hhcmVkIHNwYWNlIG1lYW5zIHRoYXQgdGhpcyBib3QgaXMgYmFzaWNhbGx5IG93bmVkIGJ5IHRoaXMgdXNlci4KICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3JlbW90ZVRlbXBTaGFyZWQnOgogICAgICAgICAgICAvLyByZW1vdGVUZW1wU2hhcmVkIHNwYWNlIG1lYW5zIHRoYXQgdGhpcyBib3QgaXMgb3duZWQgYnkgc29tZW9uZSBlbHNlLgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2xvY2FsJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3RlbXBMb2NhbCc6CiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVW5yZWNvZ25pemVkIGJvdCBzcGFjZTpgLCBzaGFyZEJvdC5zcGFjZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBjYW5Vc2VyVXBkYXRlOwp9IGVsc2UgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwcm92aWRlZCBzaGFyZEJvdCBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgZnJvbSBhbiBhcnRpZmFjdCBpbnN0YW5jZS5gLCBzaGFyZEJvdCk7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7Cn0nAIKGnBWu8AQaYWJDcmVhdGVBcnRpZmFjdFByb21pc2VCb3QCBACChpwVqaoH4hVAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RTaGFyZCwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gYXV0aEJvdD8uaWQgPz8gYWIubGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWUsCiAgICBzcGFjZSA9ICdzaGFyZWQnLAp9ID0gdGhhdCA/PyB7fTsKCgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoYWJBcnRpZmFjdFNoYXJkICYmIGFiQXJ0aWZhY3RTaGFyZC5kYXRhICYmIGFiQXJ0aWZhY3RTaGFyZC5kZXBlbmRlbmNpZXMsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdFNoYXJkIGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBBQkFydGlmYWN0U2hhcmQuYCk7Cgpjb25zdCBib3REYXRhID0gW107CmNvbnN0IHByb21pc2VJZCA9IHV1aWQoKTsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGUgPSB0aGlzQm90LmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdFNoYXJkIH0pOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2VuZXJhdGVkIGFiQXJ0aWZhY3RCdW5kbGU6YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCmJvdERhdGFbcHJvbWlzZUlkXSA9IHsKICAgIGlkOiBwcm9taXNlSWQsCiAgICBzcGFjZSwKICAgIHRhZ3M6IHsKICAgICAgICBhYkFydGlmYWN0TmFtZSwKICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKSwKICAgICAgICBhYkFydGlmYWN0UHJvbWlzZTogdHJ1ZSwKICAgIH0KfQoKLy8gQ3JlYXRlIGFydGlmYWN0IHByb21pc2UgdGhyb3VnaCBhYkNyZWF0ZUJvdHMuIAovLyBUaGlzIHdpbGwgdHJpZ2dlciBhcnRpZmFjdCdzIG9uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlIGFuZCBpdCB3aWxsIGZpbmQKLy8gdGhpcyBhcnRpZmFjdCBwcm9taXNlIGFuZCB1c2UgdGhlIGRhdGEgdG8gcmVjb25zdGl0dXRlIGl0LgpsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90RGF0YSwgc291cmNlRXZlbnQ6ICdjcmVhdGVfYXJ0aWZhY3RfcHJvbWlzZScgfSk7Cgpjb25zdCB3YWl0Rm9yUmVjb25zdGl0dXRpb24gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICAgIG9zLnJlbW92ZUJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkJywgaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQpOwogICAgICAgIG9zLnJlbW92ZUJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCk7CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQobGlzdGVuZXJUaGF0KSB7CiAgICAgICAgaWYgKGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQgfHwKICAgICAgICAgICAgbGlzdGVuZXJUaGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgKSB7CiAgICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICAgICAgcmVzb2x2ZShsaXN0ZW5lclRoYXQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQobGlzdGVuZXJUaGF0KSB7CiAgICAgICAgaWYgKGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQgfHwKICAgICAgICAgICAgbGlzdGVuZXJUaGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgKSB7CiAgICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihsaXN0ZW5lclRoYXQuZXJyb3JNZXNzYWdlKSk7CiAgICAgICAgfQogICAgfQoKICAgIG9zLmFkZEJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkJywgaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQpOwogICAgb3MuYWRkQm90TGlzdGVuZXIodGhpc0JvdCwgJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkJywgaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkKTsKfSkKCmNvbnN0IHJlY29uc3RpdHV0ZVJlc3VsdCA9IGF3YWl0IHdhaXRGb3JSZWNvbnN0aXR1dGlvbjsKCnJldHVybiByZWNvbnN0aXR1dGVSZXN1bHQuc2hhcmRCb3RzOycAgoacFa7wBBZhYkNyZWF0ZUFydGlmYWN0QnVuZGxlAgQAgoacFYrAB5kIQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdFNoYXJkLAp9ID0gdGhhdDsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHsKICAgIG5hbWU6IGFiQXJ0aWZhY3ROYW1lLAogICAgZm9ybWF0VmVyc2lvbjogMSwKICAgIGRhdGE6IGFiQXJ0aWZhY3RTaGFyZC5kYXRhLAogICAgZGVwZW5kZW5jaWVzOiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLAp9CgovLyBHZW5lcmF0ZSB0aGUgYXJ0aWZhY3QgaWQsIHdoaWNoIGlzIHNoYTI1NiBoYXNoIG9mIHRoZSBjb3JlIGNvbnRlbnRzIG9mIHRoZSBhcnRpZmFjdC4KYWJBcnRpZmFjdEJ1bmRsZS5pZCA9IGNyeXB0by5zaGEyNTYoYWJBcnRpZmFjdEJ1bmRsZSk7CgovLyBTdG9yZSBzb21lIGV4dHJhIG1ldGFkYXRhIHByb3BlcnRpZXMgd2l0aCB0aGUgYXJ0aWZhY3QuCi8vIFRoZXNlIGFyZSBub3QgY29yZSB0byB0aGUgYXJ0aWZhY3QncyBmdW5jdGlvbmFsaXR5IGJ1dCBtYXkgYmUgdXNlZnVsIGFzIGFydGlmYWN0cyBldm9sdmUuCmFiQXJ0aWZhY3RCdW5kbGUuY2FzdWFsT1NWZXJzaW9uID0gb3MudmVyc2lvbigpOwphYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXAgPSBEYXRlVGltZS5ub3coKS50b0lTTygpOwphYkFydGlmYWN0QnVuZGxlLmFiU2hlbGxWZXJzaW9uID0gYCR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1ham9yVmVyc2lvbn0uJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWlub3JWZXJzaW9ufWA7CgpyZXR1cm4gYWJBcnRpZmFjdEJ1bmRsZTsnAIKGnBWu8AQGY3JlYXRlAgQAgoacFaTIByjwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwCChpwVrvAEE2lzRXhwZXJpZW5jZUVuYWJsZWQCBACChpwVy8gHdEBpZiAoY29uZmlnQm90LnRhZ3MuYWJBcnRpZmFjdEV4cGVyaWVuY2UgPT09IHRydWUpIHsKICAgIHJldHVybiB0cnVlOwp9CgovLyBFeHBlcmllbmNlIG9mZiBieSBkZWZhdWx0LgpyZXR1cm4gZmFsc2U7JwCChpwVrvAEHmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudAIEAIKGnBXAyQfJHEBjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLCAvLyBbUnlhbiBDb29rXTogSSB3aWxsIG5lZWQgdGhpcyB3aGVuIEkgZ2V0IGJhY2sgdG8gYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZS4KfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MgPSB7fTsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYWxyZWFkeSBoYXMgYSBkb2N1bWVudCBsb2FkZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmxldCBleHBlcmllbmNlQXV0aDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCmlmICghZXhwZXJpZW5jZUF1dGguYXV0aG9yaXplZCkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEFydGlmYWN0IGV4cGVyaWVuY2Ugd2FzIG5vdCBhdXRob3JpemVkLiBSZWFzb246ICR7ZXhwZXJpZW5jZUF1dGguZmFpbHVyZVJlYXNvbn1gKTsKICAgIHJldHVybjsKfQoKLy8gR2V0IHRoZSBhcnRpZmFjdCBpbnN0YW5jZSdzIHNoYXJlZCBkb2N1bWVudCBhcyB3ZWxsIGFzIHRoZSBleHBlcmllbmNlIG1hcC4KY29uc3QgZG9jdW1lbnQgPSBhd2FpdCBvcy5nZXRTaGFyZWREb2N1bWVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwgYGFydGlmYWN0SW5zdGFuY2VfJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gLCAnbWFpbicpOwpjb25zdCBleHBlcmllbmNlTWFwID0gZG9jdW1lbnQuZ2V0TWFwKCdleHBlcmllbmNlJyk7Cgpjb25zdCBza2lwS2V5cyA9IG5ldyBTZXQoWwogICAgJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnLAogICAgLy8gQWRkIG1vcmUga2V5cyBoZXJlIGlmIG5lZWRlZAogICAgLy8gJ3NvbWVPdGhlcktleScsCiAgICAvLyAneWV0QW5vdGhlcktleScKXSk7Cgpjb25zdCBleHBlcmllbmNlU3ViID0gZXhwZXJpZW5jZU1hcC5kZWVwQ2hhbmdlcy5zdWJzY3JpYmUoKGV2ZW50cykgPT4gewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9uIGRlZXAgY2hhbmdlczpgLCBldmVudHMpOwogICAgfQoKICAgIC8vIENvbGxlY3QgYWxsIGNoYW5nZWQga2V5cwogICAgY29uc3QgYWxsS2V5cyA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZXZ0IG9mIGV2ZW50cyA/PyBbXSkgewogICAgICAgIGNvbnN0IG0gPSBldnQ/LmNoYW5nZXM7CiAgICAgICAgaWYgKG0gJiYgdHlwZW9mIG0ua2V5cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBmb3IgKGNvbnN0IGsgb2YgbS5rZXlzKCkpIHsKICAgICAgICAgICAgICAgIGFsbEtleXMuYWRkKGspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFNraXAgaWYgKmFsbCogY2hhbmdlcyBhcmUgaW5zaWRlIHRoZSBza2lwIGxpc3QKICAgIGNvbnN0IHNob3VsZFNraXAgPSBhbGxLZXlzLnNpemUgPiAwICYmIFsuLi5hbGxLZXlzXS5ldmVyeSgoaykgPT4gc2tpcEtleXMuaGFzKGspKTsKICAgIGlmIChzaG91bGRTa2lwKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYWxsIHRvIGFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlLCB0aGUgb25seSBjaGFuZ2UgdG8gdGhlIGV4cGVyaWVuY2Ugd2VyZSBzcGVjaWFsIHJlc2VydmVkIHByb3BlcnRpZXMuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0pOwoKdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gPSB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3VifTsKCmlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGluc3RhbmNlIGRvY3VtZW50IGxvYWRlZDpgLCB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSk7CgogICAgY29uc3QgZXhwZXJpZW5jZUpTT04gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VNYXAudG9KU09OKCkpKTsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gbG9hZGVkIGV4cGVyaWVuY2UgbWFwIHN0YXRlOmAsIGV4cGVyaWVuY2VKU09OKTsKfQoKY29uc3QgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9IGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJyk7CgppZiAoYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9PT0gdHJ1ZSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0aW5nIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGZyb20gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEltbWVkaWF0ZWx5IGdpdmUgdGhlIHNoYXJkIGJvdHMgdGhlIGN1cnJlbnQgZXhwZXJpZW5jZSBzdGF0ZS4KICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbml0aWFsaXppbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEluaXRpYWxpemUgdGhlIGV4cGVyaWVuY2Ugc3RhdGUgd2l0aCB0aGUgY3VycmVudCBzaGFyZCBkYXRhLgogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7ICAgIAp9CicAgoacFa7wBCBhYlVubG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudAIEAIKGnBWK5geJBkBjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3ViIH0gPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsgCgogICAgaWYgKGV4cGVyaWVuY2VTdWIpIHsKICAgICAgICBleHBlcmllbmNlU3ViLnVuc3Vic2NyaWJlKCk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdW5zdWJzY3JpYmVkIGZyb20gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZXhwZXJpZW5jZSBtYXAuYCk7CiAgICAgICAgfQogICAgfQoKICAgIGRlbGV0ZSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVtb3ZlZCBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBkb2N1bWVudC5gKTsKICAgIH0KfScAgoacFa7wBB5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMCBACChpwVlOwHtAJAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3Qgc2hhcmRCb3RzID0gZ2V0Qm90cygoYikgPT4gewogICAgcmV0dXJuIGIudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQKfSk7CgpyZXR1cm4gc2hhcmRCb3RzOycAgoacFa7wBCZhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZQIEAIKGnBXJ7gfpB0Bjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICByZXR1cm47Cn0KCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCBpbnN0YW5jZURvYyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmIChpbnN0YW5jZURvYykgewogICAgICAgIGNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUR9KTsKCiAgICAgICAgY29uc3QgeyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1YiB9ID0gaW5zdGFuY2VEb2M7CgogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VEYXRhID0gZXhwZXJpZW5jZU1hcC50b0pTT04oKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSB3aXRoIGV4cGVyaWVuY2Ugc3RhdGU6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlRGF0YSkpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHdoaXNwZXIoc2hhcmRCb3RzLCAnb25BQkFydGlmYWN0RXhwZXJpZW5jZScsIHsgZGF0YTogZXhwZXJpZW5jZURhdGEgfSkpOwogICAgfQp9JwCChpwVrvAEImFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUV4cGVyaWVuY2UCBACChpwVs/YH0ChAaW1wb3J0IHsgU2hhcmVkTWFwIH0gZnJvbSAnY2FzdWFsb3MnOwoKY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICghdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzKSB7CiAgICB0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMgPSBuZXcgU2V0KCk7Cn0KCmlmICh0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgdXBkYXRlIGlzIGFscmVhZHkgaW4gcHJvZ3Jlc3MgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICB9CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5hZGQoYWJBcnRpZmFjdEluc3RhbmNlSUQpOwoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IGluc3RhbmNlRG9jID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgaWYgKGluc3RhbmNlRG9jKSB7CiAgICAgICAgY29uc3Qgc2hhcmRCb3RzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCiAgICAgICAgLy8gTmVlZCB0byBhc2sgaWYgdGhpcyB1c2VyIGlzIGFsbG93ZWQgdG8gdXBkYXRlIHRoZSBleHBlcmllbmNlIG9mIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UuCiAgICAgICAgY29uc3QgY2FuVXNlclVwZGF0ZSA9IGF3YWl0IHRoaXNCb3QuY2FuVXNlclVwZGF0ZUV4cGVyaWVuY2UoeyByZW1vdGVJZDogY29uZmlnQm90LmlkLCBzaGFyZEJvdDogc2hhcmRCb3RzWzBdIH0pOwoKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbiB1c2VyIHVwZGF0ZSBleHBlcmllbmNlIGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke3NoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELnN1YnN0cmluZygwLCA3KX0/YCwgY2FuVXNlclVwZGF0ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2FuVXNlclVwZGF0ZSkgewogICAgICAgICAgICBsZXQgY29sbGVjdFNoYXJkUmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdDsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb2xsZWN0U2hhcmRSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiQ29sbGVjdEFydGlmYWN0U2hhcmRzKHsgc2hhcmRCb3RzIH0pOwoKICAgICAgICAgICAgICAgIGlmICghY29sbGVjdFNoYXJkUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGNvbGxlY3RTaGFyZFJlc3VsdC5yZWFzb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRDpgLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYGNvbGxlY3RTaGFyZFJlc3VsdDpgLCBKU09OLnN0cmluZ2lmeShjb2xsZWN0U2hhcmRSZXN1bHQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbGxlY3RTaGFyZFJlc3VsdCAmJiBjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgLy8gT25seSB1cGRhdGUgZW50cnkgaW4gZXhwZXJpZW5jZU1hcCBpZiB0aGUgZGF0YSBpcyBhY3R1YWxseSBkaWZmZXJlbnQuCiAgICAgICAgICAgICAgICBjb25zdCBleHBlcmllbmNlTWFwOiBTaGFyZWRNYXAgPSBpbnN0YW5jZURvYy5leHBlcmllbmNlTWFwOwoKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogc2hhcmQgZGF0YSBtaWdodCBiZSB1bmRlZmluZWQvbnVsbAogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmREYXRhID0gKGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZCAmJiBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQuZGF0YSkgPyBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQuZGF0YSA6IHt9OwogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmREYXRhS2V5cyA9IE9iamVjdC5rZXlzKHNoYXJkRGF0YSk7CiAgICAgICAgICAgICAgICBjb25zdCBrZXlzVG9EZWxldGUgPSBbXTsKCiAgICAgICAgICAgICAgICAvLyBTaW1wbGUgZGVlcC1lcXVhbGl0eSBjaGVjayBmb3IgSlNPTi1zZXJpYWxpemFibGUgdmFsdWVzCiAgICAgICAgICAgICAgICBjb25zdCBpc0VxdWFsID0gKGEsIGIpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYSA9PT0gYikgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGEpID09PSBKU09OLnN0cmluZ2lmeShiKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gMSkgVXBzZXJ0IG9ubHkgd2hlbiBkaWZmZXJlbnQKICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHNoYXJkRGF0YUtleXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWwgPSBzaGFyZERhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWwgPSBleHBlcmllbmNlTWFwLmdldChrZXkpOwogICAgICAgICAgICAgICAgICAgIGlmICghaXNFcXVhbChvbGRWYWwsIG5ld1ZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRpbmcgZXhwZXJpZW5jZU1hcCBrZXkgIiR7a2V5fSJgLCBKU09OLnN0cmluZ2lmeSh7IG9sZFZhbCwgbmV3VmFsIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLnNldChrZXksIG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIpIENvbGxlY3Qga2V5cyB0aGF0IGV4aXN0IGluIHRoZSBtYXAgYnV0IG5vdCBpbiB0aGUgc2hhcmQgZGF0YQogICAgICAgICAgICAgICAgLy8gICAgKHdlIGF2b2lkIG11dGF0aW5nIHRoZSBtYXAgd2hpbGUgaXRlcmF0aW5nIGl0KQogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgZXhwZXJpZW5jZU1hcC5rZXlzKCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgZGVsZXRlIGFiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQuIEl0cyBhIHNwZWNpYWwgcHJvcGVydHkuCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoIXNoYXJkRGF0YUtleXMuaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXlzVG9EZWxldGUucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAzKSBSZW1vdmUgc3RhbGUga2V5cwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2Yga2V5c1RvRGVsZXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZWxldGluZyBzdGFsZSBleHBlcmllbmNlTWFwIGtleSAiJHtrZXl9ImApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLmRlbGV0ZShrZXkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChleHBlcmllbmNlTWFwLmdldCgnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcpICE9IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLnNldCgnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgdXBkYXRlIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGJlY2F1c2UgaW5zdGFuY2UgZG9jdW1lbnQgbm90IGxvYWRlZC5gKTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSBpbnN0YW5jZSBkb2N1bWVudHMgaGF2ZSBub3QgYmVlbiBpbml0aWFsaXplZC5gKTsKICAgIH0KfQoKdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmRlbGV0ZShhYkFydGlmYWN0SW5zdGFuY2VJRCk7JwCChpwVrvAEDG9uSW5zdEpvaW5lZAIEAIKGnBWEnwiQBkBtYXNrcy5pbnN0Sm9pbmVkID0gdHJ1ZTsKCmNvbnN0IGFydGlmYWN0SW5zdGFuY2VzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VzKCk7Cgpmb3IgKGxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBhcnRpZmFjdEluc3RhbmNlcykgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvYWRpbmcgYXJ0aWZhY3QgaW5zdGFuY2UgZG9jdW1lbnQgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICB9CiAgICAKICAgIHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0KCi8vIENvbGxlY3QgYWxsIHJlY29uc3RpdHV0aW9uIHNpZ25hbCBib3RzIGludG8gYSBsb2NhbCBzZXQgc28gd2Uga25vdyB3aGVuIHRoZXkgYXJlIHJlbW92ZWQuCmNvbnN0IHJlY29uc3RpdHV0aW5nU2lnbmFsQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0U2lnbmFsQm90KTsKZm9yIChjb25zdCBzaWduYWxCb3Qgb2YgcmVjb25zdGl0dXRpbmdTaWduYWxCb3RzKSB7CiAgICB0aGlzQm90LnZhcnMucmVjb25zdGl0dXRpbmdTaWduYWxCb3RJZHMuYWRkKHNpZ25hbEJvdC5pZCk7Cn0KCmlmIChyZWNvbnN0aXR1dGluZ1NpZ25hbEJvdHMubGVuZ3RoID09PSAwKSB7CiAgICB0aGlzQm90LmFiQ2hlY2tBcnRpZmFjdFJlY29uc3RpdHV0aW9uQXRSZXN0KCk7Cn0nAIKGnBWu8AQOb25BbnlCb3RzQWRkZWQCBACChpwVlaUIwQVAaWYgKCFtYXNrcy5pbnN0Sm9pbmVkKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFkZGVkQm90cyA9IHRoYXQuYm90czsKCmZvciAoY29uc3QgYm90IG9mIGFkZGVkQm90cykgewogICAgaWYgKGJvdCA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjUwKTsKCiAgICAgICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGV0ZWN0ZWQgYWRkZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7Ym90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9LmApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgICAgIH0KICAgIH0gCiAgICBlbHNlIGlmIChib3QudGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RTaWduYWxCb3QpIHsKICAgICAgICB0aGlzQm90LnZhcnMucmVjb25zdGl0dXRpbmdTaWduYWxCb3RJZHMuYWRkKGJvdC5pZCk7CiAgICB9Cn0nAIKGnBWu8AQab25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQCBACChpwV16oI3gVAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgncHJpbnRhcnRpZmFjdGV4cGVyaWVuY2UnLCAoYXJncykgPT4gewogICAgY29uc3QgaW5zdGFuY2VEb2NzID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jczsKCiAgICBsZXQgYWxsRXhwZXJpZW5jZSA9IHt9OwoKICAgIGZvciAobGV0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGluc3RhbmNlRG9jcykgewogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VNYXAgPSBpbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdLmV4cGVyaWVuY2VNYXA7CiAgICAgICAgY29uc3QgZXhwZXJpZW5jZUpTT04gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VNYXAudG9KU09OKCkpKTsKICAgICAgICBhbGxFeHBlcmllbmNlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IGV4cGVyaWVuY2VKU09OOwogICAgfQoKICAgIGNvbnNvbGUubG9nKGBbcHJpbnRhcnRpZmFjdGV4cGVyaWVuY2VdIEFsbCBjdXJyZW50IGFydGlmYWN0IGluc3RhbmNlIGV4cGVyaWVuY2Ugc3RhdGVzOmAsIGFsbEV4cGVyaWVuY2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnUHJpbnQgYWxsIGN1cnJlbnRseSBsb2FkZWQgYXJ0aWZhY3QgaW5zdGFuY2UgZXhwZXJpZW5jZSBzdGF0ZXMgdG8gdGhlIGNvbnNvbGUuJywKICAgIHVzYWdlOiBbJy5wcmludGFydGlmYWN0ZXhwZXJpZW5jZSddCn0pOycAgoacFa7wBBhhYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgCBACChpwVtrAI3BJAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBleHBBdXRoUmVzdWx0OiBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGggPSB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGF1dGhvcml6ZWQ6IHVuZGVmaW5lZCwKICAgIGZhaWx1cmVSZWFzb246IHVuZGVmaW5lZCwKfQoKaWYgKGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSkgewogICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSBhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkOwoKICAgIHJldHVybiBleHBBdXRoUmVzdWx0Owp9CgpsZXQgbXlBdXRoQm90ID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCmlmICghbXlBdXRoQm90KSB7CiAgICAvLyBOb3Qgc2lnbmVkIGluLCBuZWVkIHRvIHNpZ24gaW4gdG8gdXNlIGFydGlmYWN0IGV4cGVyaWVuY2UuCiAgICBsZXQgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IGdsb2JhbFRoaXMuYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKCiAgICBpZiAoIWFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UpIHsKICAgICAgICBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlID0gb3Muc2hvd0NvbmZpcm0oewogICAgICAgICAgICB0aXRsZTogJ1NpZ24gSW4gUmVxdWlyZWQnLAogICAgICAgICAgICBjb250ZW50OiAnVGhpcyBzZXJ2ZXIgaGFzIGFydGlmYWN0cyB0aGF0IHdvcmsgYmVzdCB3aGVuIHlvdeKAmXJlIHNpZ25lZCBpbi4gSWYgeW91IGNvbnRpbnVlIHdpdGhvdXQgc2lnbmluZyBpbiwgdGhlIGFydGlmYWN0cyBtYXkgbm90IHN0YXkgaW4gc3luYy4nLAogICAgICAgICAgICBjb25maXJtVGV4dDogJ1NpZ24gSW4nLAogICAgICAgICAgICBjYW5jZWxUZXh0OiAnQ29udGludWUgV2l0aG91dCcKICAgICAgICB9KTsKCiAgICAgICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0VXNlckF1dGhQcm9taXNlID0gYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKICAgIH0KCiAgICBjb25zdCBjb25maXJtZWQgPSBhd2FpdCBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlOwogICAgZGVsZXRlIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZTsKCiAgICBpZiAoY29uZmlybWVkKSB7CiAgICAgICAgbXlBdXRoQm90ID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICAgICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbic7CiAgICAgICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlID0gZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uOwogICAgICAgIAogICAgICAgIHJldHVybiBleHBBdXRoUmVzdWx0OwogICAgfQp9CgppZiAoIW15QXV0aEJvdCkgewogICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSAndW5rbm93bic7CiAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUgPSBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb247CgogICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Cn0KCi8vIGNvbnN0IGFkbWluUGVybWlzc2lvblJlc3VsdCA9IGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSk7Ci8vIGNvbnNvbGUubG9nKGBhZG1pblBlcm1pc3Npb25SZXN1bHQ6YCwgYWRtaW5QZXJtaXNzaW9uUmVzdWx0KTsKCi8vIGlmIChhZG1pblBlcm1pc3Npb25SZXN1bHQuc3VjY2VzcykgewovLyAgICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gdHJ1ZTsKCi8vICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKLy8gfSBlbHNlIHsKLy8gICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwovLyAgICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfaW5zdF9wZXJtaXNzaW9uJzsKLy8gICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSA9IGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbjsKCi8vICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKLy8gfQoKZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gdHJ1ZTsKCnJldHVybiBleHBBdXRoUmVzdWx0OycAgoacFa7wBBFvbkFCQmVmb3JlUHVibGlzaAIEAIKGnBWRwwiGBEBpZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwCChpwVrvAEEm9uQUJCZWZvcmVEb3dubG9hZAIEAIKGnBWYxwiGBEBpZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwCChpwVrvAEGWFiVXBkYXRlQWxsQXJ0aWZhY3RTaGFyZHMCBACChpwVn8sIoQVAY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwoKZm9yIChjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBhcnRpZmFjdEluc3RhbmNlcykgewogICAgY29uc3Qgc2hhcmRCb3QgPSBhcnRpZmFjdEluc3RhbmNlc1thYkFydGlmYWN0SW5zdGFuY2VJRF0uZmluZChiID0+IGIgIT0gbnVsbCk7CgogICAgaWYgKCFzaGFyZEJvdCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVuYWJsZSB0byB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSB0aGVyZSB3ZXJlIG5vIHNoYXJkIGJvdHMgZm91bmQuYCk7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgCiAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwp9JwCChpwVrvAEHG9uQUJQcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQCBACChpwVwdAI4wJAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKaWYgKHRoYXQuc291cmNlRXZlbnQgIT09ICdkb3dubG9hZF9hcnRpZmFjdF9wYXR0ZXJuJykgewogICAgdGhpc0JvdC5hYlByZXByb2Nlc3NCb3REYXRhVG9BcnRpZmFjdFByb21pc2VzKHsgYm90RGF0YTogdGhhdC5ib3REYXRhIH0pOwp9JwCChpwVrvAEJWFiUHJlcHJvY2Vzc0JvdERhdGFUb0FydGlmYWN0UHJvbWlzZXMCBACChpwVpdMI+g9ALyoqCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYm90RGF0YSAoZnJvbSBvbkFCUHJlcHJvY2Vzc0JlZm9yZSogY2FsbHMpIGFuZCByZXBsYWNlcyBhbnkgc2hhcmQgYm90cyB3aXRoIGFydGlmYWN0IHByb21pc2UgYm90cy4KICovCgpjb25zdCBib3REYXRhID0gdGhhdD8uYm90RGF0YTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXJ0aW5nIGJvdERhdGE6YCwgey4uLmJvdERhdGF9KTsKfQoKYXNzZXJ0KHR5cGVvZiBib3REYXRhID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3REYXRhIGlzIGEgcmVxdWlyZWQgb2JqZWN0LmApOwoKLy8gRGV0ZWN0IGFydGlmYWN0IGluc3RhbmNlcyB0aGF0IG5lZWQgdG8gYmUgY29udmVydGVkIGludG8gYXJ0aWZhY3QgcHJvbWlzZXMuCgovKioga2V5OiBhcnRpZmFjdCBpbnN0YW5jZSBpZCwgdmFsdWU6IGFydGlmYWN0IHByb21pc2UgZGF0YS4gKi8KY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZSA9IG5ldyBTZXQoKTsgLy8gS2VlcCB0cmFjayBvZiB3aGF0IGFydGlmYWN0IGluc3RhbmNlIElEcyBoYXZlIGhhZCBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUuCgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QuCiAgICAgICAgaWYgKCFhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmhhcyhkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgIC8vIFRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgbmVlZHMgYW4gYXJ0aWZhY3QgcHJvbWlzZSBtYWRlIGZvciBpdC4KICAgICAgICAgICAgY29uc3QgcHJvbWlzZUlkID0gdXVpZCgpOwoKICAgICAgICAgICAgYm90RGF0YVtwcm9taXNlSWRdID0gewogICAgICAgICAgICAgICAgaWQ6IHByb21pc2VJZCwKICAgICAgICAgICAgICAgIHNwYWNlOiAnc2hhcmVkJywKICAgICAgICAgICAgICAgIHRhZ3M6IHsKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXI6IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0UHJvbWlzZTogdHJ1ZSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ29udmVydGVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7ZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEfSBpbnRvIGFuIGFydGlmYWN0IHByb21pc2U6YCwgYm90RGF0YVtwcm9taXNlSWRdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZS5hZGQoZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsKICAgICAgICB9CgogICAgICAgIC8vIFJlbW92ZSBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QgZnJvbSBib3REYXRhIHRoYXQgaXMgYWJvdXQgdG8gYmUgcHVibGlzaGVkLgogICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZpbmlzaGVkIGJvdERhdGE6YCwgey4uLmJvdERhdGF9KTsKfScAgoacFa7wBB1vbkFCQmVmb3JlQ29weUJvdHNUb0NsaXBib2FyZAIEAIKGnBWg4wjIB0Bjb25zdCB7IGJvdHMgfSA9IHRoYXQ7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKLy8gW0lNUE9SVEFOVCBOT1RFXSAoU2VwdGVtYmVyIDQsIDIwMjUpOiBUaGlzIGlzIGEgd29ya2Fyb3VuZCB1bnRpbCB3ZSBoYXZlIGFiIGFydGlmYWN0IGV4cGVyaWVuY2Ugc3RhdGUgd29ya2luZy4gQXMgc29vbiBhcyBleHBlcmllbmNlIHN0YXRlIGhvb2tlZAovLyB1cCwgdGhpcyBwcm9jZXNzIHNob3VsZCBiZSBlbGltaW5hdGVkIGJlY2F1c2UgaXQgY2hhbmdlcyB0aGUgYXJ0aWZhY3QgaW5zdGFuY2UgaWQgd2hpY2ggaXMgbm90IGlkZWFsIC0gYnV0IGlzIHNlcnZpY2FibGUgdW50aWwKLy8gdGhlbiBmb3IgdGhlIG5lZWRzIHdlIGhhdmUgbm93Lgpjb25zdCB1cGRhdGVkSW5zdGFuY2VzID0gbmV3IFNldCgpOwoKZm9yIChsZXQgYm90IG9mIGJvdHMpIHsKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCAmJiBib3QudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIGlmICghdXBkYXRlZEluc3RhbmNlcy5oYXMoYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgIHVwZGF0ZWRJbnN0YW5jZXMuYWRkKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsKCiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7CiAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjogYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfQp9JwCChpwVrvAEEWNoZWNrQXRSZXN0V2FpdE1TAgQAgoacFenqCAM1MDAnAIKGnBWu8AQKb25Cb3RBZGRlZAIEAIKGnBXt6gg1QHRoaXNCb3QudmFycy5yZWNvbnN0aXR1dGluZ1NpZ25hbEJvdElkcyA9IG5ldyBTZXQoKTsnAQRib3RzJDkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YwEnAIKGnBWj6wgPY2FsY01hcFJvdGF0aW9uAgQAgoacFaTrCIEOQGNvbnN0IHsgbWFwUG9zaXRpb24sIGF1eFJvdGF0aW9uIH0gPSB0aGF0OwoKbGV0IFRIUkVFID0gdGhpc0JvdC52YXJzLlRIUkVFOwppZiAoIVRIUkVFKSB7CiAgICBUSFJFRSA9IGF3YWl0IGltcG9ydCgndGhyZWUnKTsKICAgIHRoaXNCb3QudmFycy5USFJFRSA9IFRIUkVFOwp9Cgpjb25zdCBkZWdUb1JhZCA9IChkKSA9PiAoZCAqIE1hdGguUEkpIC8gMTgwOwoKZnVuY3Rpb24gdGFuZ2VudEJhc2lzRnJvbUxvbkxhdChsb25EZWcsIGxhdERlZykgewogICAgY29uc3QgbG9uID0gZGVnVG9SYWQobG9uRGVnKTsKICAgIGNvbnN0IGxhdCA9IGRlZ1RvUmFkKGxhdERlZyk7CgogICAgLy8gTm9ybWFsIHBvaW50aW5nIG91dCBvZiB0aGUgZ2xvYmUuCiAgICBjb25zdCBuID0gbmV3IFRIUkVFLlZlY3RvcjMoCiAgICAgICAgTWF0aC5jb3MobGF0KSAqIE1hdGguY29zKGxvbiksCiAgICAgICAgTWF0aC5jb3MobGF0KSAqIE1hdGguc2luKGxvbiksCiAgICAgICAgTWF0aC5zaW4obGF0KSwKICAgICkubm9ybWFsaXplKCk7CgogICAgLy8gQnVpbGQgZWFzdC9ub3J0aCBmcm9tIHRoZSBub3JtYWwKICAgIGNvbnN0IHdvcmxkVXAgPSBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAxKTsKICAgIGxldCBlYXN0ID0gd29ybGRVcC5jbG9uZSgpLmNyb3NzKG4pLm5vcm1hbGl6ZSgpOwogICAgaWYgKGVhc3QubGVuZ3RoU3EoKSA9PT0gMCkgZWFzdCA9IG5ldyBUSFJFRS5WZWN0b3IzKDEsIDAsIDApOyAvLyBwb2xlIGd1YXJkCiAgICBjb25zdCBub3J0aCA9IG4uY2xvbmUoKS5jcm9zcyhlYXN0KS5ub3JtYWxpemUoKTsKCiAgICAvLyBCYXNpczogY29sdW1ucyA9IGVhc3QsIG5vcnRoLCBub3JtYWwKICAgIGNvbnN0IGJhc2lzID0gbmV3IFRIUkVFLk1hdHJpeDQoKS5tYWtlQmFzaXMoZWFzdCwgbm9ydGgsIG4pOwogICAgcmV0dXJuIGJhc2lzOwp9CgovLyBHaXZlbiBwb3J0YWwgYm90IHRhZ3MgYW5kIGEgZ2l6bW8gb2JqZWN0M0QsIGFsaWduIGdpem1vIHJvdGF0aW9uCmZ1bmN0aW9uIGNhbGNNYXBSb3RhdGlvbihtYXBQb3NpdGlvbiwgYXV4Um90YXRpb24pIHsKICAgIGNvbnN0IGxvbiA9IG1hcFBvc2l0aW9uLng7IC8vIFggPSBsb25naXR1ZGUgKGRlZ3JlZXMpCiAgICBjb25zdCBsYXQgPSBtYXBQb3NpdGlvbi55OyAvLyBZID0gbGF0aXR1ZGUgKGRlZ3JlZXMpCiAgICBjb25zdCBhdXhRdWF0ID0gYXV4Um90YXRpb24ucXVhdGVybmlvbjsKCiAgICBpZiAobG9uID09IG51bGwgfHwgbGF0ID09IG51bGwgfHwgYXV4UXVhdCA9PSBudWxsKSByZXR1cm47CgogICAgY29uc3QgcXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKGF1eFF1YXQueCwgYXV4UXVhdC55LCBhdXhRdWF0LnosIGF1eFF1YXQudyk7CgogICAgY29uc3QgYmFzaXMgPSB0YW5nZW50QmFzaXNGcm9tTG9uTGF0KGxvbiwgbGF0KTsKICAgIGNvbnN0IGJhc2lzSW52ID0gYmFzaXMuY2xvbmUoKS5pbnZlcnQoKTsKICAgIGNvbnN0IGJhc2lzSW52UXVhdCA9IG5ldyBUSFJFRS5RdWF0ZXJuaW9uKCkuc2V0RnJvbVJvdGF0aW9uTWF0cml4KGJhc2lzSW52KTsKCiAgICAvLyBBcHBseSB0aGUgdGFuZ2VudCBjb3JyZWN0aW9uCiAgICBjb25zdCB3b3JsZFF1YXQgPSBxdWF0LmNsb25lKCkucHJlbXVsdGlwbHkoYmFzaXNJbnZRdWF0KTsKCiAgICByZXR1cm4gbmV3IFJvdGF0aW9uKHsgcXVhdGVybmlvbjogeyB4OiB3b3JsZFF1YXQueCwgeTogd29ybGRRdWF0LnksIHo6IHdvcmxkUXVhdC56LCB3OiB3b3JsZFF1YXQudyB9fSk7Cn0KCnJldHVybiBjYWxjTWFwUm90YXRpb24obWFwUG9zaXRpb24sIGF1eFJvdGF0aW9uKTsnAIKGnBWj6wgOYWJGaWxlVGltZWNvZGUCBACChpwVpvkIZkBjb25zdCBkYXRlOiBEYXRlVGltZSA9IHRoYXQ/LmRhdGUgPz8gRGF0ZVRpbWUubm93KCk7CnJldHVybiBkYXRlLnRvVVRDKCkudG9Gb3JtYXQoJ3l5eXlNTWRkLUhIbW1zcycpOycAgoacFaPrCAZzeXN0ZW0CBACChpwVjfoIDmFiLnNoZWxsLnV0aWxzJwCChpwVo+sIDGFiQ29tcGlsZUNTUwIEAIKGnBWc+giCBEBsZXQgYm90cyA9IHRoYXQ7Cgpib3RzID0gQXJyYXkuaXNBcnJheShib3RzKSA/IGJvdHMgOiBbYm90c107CgpsZXQgY3NzID0gW107Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgZm9yIChsZXQga2V5IGluIGJvdC50YWdzKSB7CiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCdjc3MnKSkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBDU1Mga2V5OiAke2tleX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3MucHVzaChib3QudGFnc1trZXldKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IGNvbXBpbGVkID0gY3NzLmpvaW4oJ1xuXG4nKTsKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY29tcGlsZWQgQ1NTOlxuXG5gLCBjb21waWxlZCk7Cn0KCnJldHVybiBjb21waWxlZDsnAIKGnBWj6wgIYWJJZ25vcmUCBACChpwVn/4IBHRydWUnAIKGnBWj6wgHYWJTaGVsbAIEAIKGnBWk/ggEdHJ1ZScAgoacFaPrCAlhYlZlcnNpb24CBACChpwVqf4IBTEwLjQzJwCChpwVo+sIDWFiTG9nQW5kVG9hc3QCBACChpwVr/4IuApAbGV0IG1lc3NhZ2U7CmxldCBkdXJhdGlvbjsKbGV0IGxvZ1R5cGUgPSAnbG9nJzsKbGV0IG5hbWUgPSBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHk7CmxldCB0b2FzdCA9IHRydWU7CmxldCBhYkxvZyA9IHRydWU7CmxldCBjb25zb2xlTG9nID0gdHJ1ZTsKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIG1lc3NhZ2UgPSB0aGF0OwogICAgZHVyYXRpb24gPSB0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0LCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwOwp9IGVsc2UgewogICAgbWVzc2FnZSA9IHRoYXQubWVzc2FnZTsKICAgIGR1cmF0aW9uID0gdGhhdC5kdXJhdGlvbiA/PyAodGhpc0JvdC5lc3RpbWF0ZVJlYWRpbmdUaW1lKHsgdGV4dDogdGhhdC5tZXNzYWdlLCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwKTsKICAgIG5hbWUgPSB0aGF0Lm5hbWUgPz8gbmFtZTsKICAgIGxvZ1R5cGUgPSB0aGF0LmxvZ1R5cGUgPz8gbG9nVHlwZTsKICAgIHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0b2FzdDsKICAgIGFiTG9nID0gdGhhdC5hYkxvZyA/PyBhYkxvZzsKfQoKaWYgKGxvZ1R5cGUgPT09ICdsb2cnKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnd2FybmluZycgfHwgbG9nVHlwZSA9PT0gJ3dhcm4nKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogV2FybmluZzogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUud2FybihuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChgV2FybmluZzogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnZXJyb3InKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogRXJyb3I6ICcgKyBtZXNzYWdlKTsKICAgIGlmIChjb25zb2xlTG9nKSBjb25zb2xlLmVycm9yKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBFcnJvcjogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9JwCChpwVo+sICHJlbWVtYmVyAgQAgoacFeiICSjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCChpwVo+sIBWFiTG9nAgQAgoacFY+JCaUCQGlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgYWJMb2c6IHRydWUsCiAgICAgICAgY29uc29sZUxvZzogdHJ1ZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICBhYkxvZzogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nOiB0cnVlLAogICAgfSk7Cn0nAIKGnBWj6wgTZXN0aW1hdGVSZWFkaW5nVGltZQIEAIKGnBW1iwncA0Bjb25zdCB7CiAgICB0ZXh0ID0gJycsCiAgICB3b3Jkc1Blck1pbnV0ZSA9IDI1MCwKICAgIGRlbGF5VGltZSA9IDUwMCwKfSA9IHRoYXQ7CgovLyBDb3VudCB3b3JkcyAocm91Z2ggYXBwcm94aW1hdGlvbiBieSBzcGxpdHRpbmcgb24gd2hpdGVzcGFjZSkKY29uc3Qgd29yZENvdW50ID0gdGV4dC50cmltKCkuc3BsaXQoL1xzKy8pLmxlbmd0aDsKbGV0IHRvdGFsVGltZU1zID0gMDsKCmlmICh3b3JkQ291bnQgPiAwKSB7CiAgICAvLyBDYWxjdWxhdGUgcmVhZGluZyB0aW1lIGluIG1pbGxpc2Vjb25kcwogICAgY29uc3Qgd29yZHNQZXJTZWNvbmQgPSB3b3Jkc1Blck1pbnV0ZSAvIDYwOwogICAgY29uc3QgcmVhZGluZ1RpbWVNcyA9IE1hdGguY2VpbCgod29yZENvdW50IC8gd29yZHNQZXJTZWNvbmQpICogMTAwMCk7CgogICAgdG90YWxUaW1lTXMgPSByZWFkaW5nVGltZU1zICsgZGVsYXlUaW1lOwp9CgpyZXR1cm4gdG90YWxUaW1lTXM7JwCChpwVo+sICGlzT2JqZWN0AgQAgoacFZKPCTlAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheSh0aGF0KTsnAIKGnBWj6wgHaXNBcnJheQIEAIKGnBXMjwkcQHJldHVybiBBcnJheS5pc0FycmF5KHRoYXQpOycAgoacFaPrCAhpc1N0cmluZwIEAIKGnBXpjwkhQHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZyc7JwCChpwVo+sID2dldEVycm9yTWVzc2FnZQIEAIKGnBWLkAnAAkBmdW5jdGlvbiBnZXRFcnJvck1lc3NhZ2UoZXJyb3IpIHsKICAgIGlmIChlcnJvcikgewogICAgICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiBlcnJvcjsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yLm1lc3NhZ2UpIHsKICAgICAgICAgICAgcmV0dXJuIGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfSBlbHNlIGlmIChlcnJvci5lcnJvcikgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JNZXNzYWdlKGVycm9yLmVycm9yKTsKICAgICAgICB9CiAgICB9Cn0KCnJldHVybiBnZXRFcnJvck1lc3NhZ2UodGhhdCk7JwCChpwVo+sIB2FiVG9hc3QCBACChpwVzJIJpwJAaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIGFiTG9nOiBmYWxzZSwKICAgICAgICBjb25zb2xlTG9nOiBmYWxzZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIGFiTG9nOiBmYWxzZSwKICAgICAgICBjb25zb2xlTG9nOiBmYWxzZSwKICAgIH0pOwp9JwCChpwVo+sIGGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbgIEAIKGnBX0lAn8AkBsZXQgaGFzUGVybWlzc2lvbiA9IGZhbHNlOwoKdHJ5IHsKICAgIGlmIChnbG9iYWxUaGlzLm5hdmlnYXRvciAmJiBuYXZpZ2F0b3IucGVybWlzc2lvbnMpIHsKICAgICAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCBuYXZpZ2F0b3IucGVybWlzc2lvbnMucXVlcnkoeyBuYW1lOiAnZ2VvbG9jYXRpb24nIH0pOwogICAgICAgIGhhc1Blcm1pc3Npb24gPSBzdGF0dXM/LnN0YXRlID09PSAnZ3JhbnRlZCc7CiAgICB9Cn0gY2F0Y2ggKGUpIHsgCiAgICBjb25zb2xlLmVycm9yKGBDYXVnaHQgYW4gZXJyb3Igd2lsbCBxdWVyeWluZyBwZXJtaXNzaW9ucy4gRXJyb3I6YCwgYWIubGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpKTsKfQoKcmV0dXJuIGhhc1Blcm1pc3Npb247JwCChpwVo+sIBWlzQm90AgQAgoacFfGXCVRAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JyAmJiB0aGF0LnRhZ3MgJiYgdGhhdC5pZCAmJiB0aGF0LnNwYWNlICYmIHRoYXQudmFyczsnAIKGnBWj6wgOYXBwbHlLZXlUb1RleHQCBACChpwVxpgJ5QhAbGV0IHsgdGV4dCwga2V5IH0gPSB0aGF0OwoKdGV4dCA9ICh0ZXh0ID8/ICcnKS50b1N0cmluZygpOwoKY29uc3QgREVCVUcgPSBmYWxzZTsKCnN3aXRjaCAoa2V5KSB7CiAgICBjYXNlICdCYWNrc3BhY2UnOgogICAgICAgIHRleHQgPSB0ZXh0LnN1YnN0cmluZygwLCB0ZXh0Lmxlbmd0aCAtIDEpOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnRGVsZXRlJzoKICAgIGNhc2UgJ0NsZWFyJzoKICAgICAgICB0ZXh0ID0gJyc7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdFbnRlcic6CiAgICAgICAgdGV4dCArPSAnXG4nOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnVGFiJzoKICAgICAgICAvLyBDb252ZXJ0IHRhYnMgdG8gc3BhY2VzLgogICAgICAgIHRleHQgKz0gJyAnLnJlcGVhdCg0KTsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ0VzY2FwZSc6CiAgICBjYXNlICdTaGlmdCc6CiAgICBjYXNlICdDYXBzTG9jayc6CiAgICBjYXNlICdDb250cm9sJzoKICAgIGNhc2UgJ0FsdCc6CiAgICBjYXNlICdNZXRhJzoKICAgIGNhc2UgJ0NvbnRleHRNZW51JzoKICAgIGNhc2UgJ1BhZ2VVcCc6CiAgICBjYXNlICdQYWdlRG93bic6CiAgICBjYXNlICdIb21lJzoKICAgIGNhc2UgJ0VuZCc6CiAgICBjYXNlICdIZWxwJzoKICAgIGNhc2UgJ0YxJzoKICAgIGNhc2UgJ0YyJzoKICAgIGNhc2UgJ0YzJzoKICAgIGNhc2UgJ0Y0JzoKICAgIGNhc2UgJ0Y1JzoKICAgIGNhc2UgJ0Y2JzoKICAgIGNhc2UgJ0Y3JzoKICAgIGNhc2UgJ0Y4JzoKICAgIGNhc2UgJ0Y5JzoKICAgIGNhc2UgJ0YxMCc6CiAgICBjYXNlICdGMTEnOgogICAgY2FzZSAnRjEyJzoKICAgIGNhc2UgJ0YxMyc6CiAgICBjYXNlICdBcnJvd1VwJzoKICAgIGNhc2UgJ0Fycm93UmlnaHQnOgogICAgY2FzZSAnQXJyb3dEb3duJzoKICAgIGNhc2UgJ0Fycm93TGVmdCc6CiAgICAgICAgLy8gSWdub3JlIGtleXN0cm9rZS4KICAgICAgICBpZiAoREVCVUcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpZ25vcmluZyBrZXlzdHJva2U6YCwga2V5KTsKICAgICAgICB9CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIHRleHQgKz0ga2V5Owp9CgpyZXR1cm4gdGV4dDsnAIKGnBWj6wgQYWRqdXN0QnJpZ2h0bmVzcwIEAIKGnBWsoQnUBkBsZXQgVEhSRUUgPSB0aGlzQm90LnZhcnMuVEhSRUU7CmlmICghVEhSRUUpIHsKICAgIFRIUkVFID0gYXdhaXQgaW1wb3J0KCd0aHJlZScpOwogICAgdGhpc0JvdC52YXJzLlRIUkVFID0gVEhSRUU7Cn0KCmZ1bmN0aW9uIHJlc29sdmVDb2xvcihjb2xvcjogc3RyaW5nKTogeyByOiBudW1iZXI7IGc6IG51bWJlcjsgYjogbnVtYmVyIH0gewogICAgY29uc3QgYyA9IG5ldyBUSFJFRS5Db2xvcihjb2xvcik7CiAgICByZXR1cm4gewogICAgICAgIHI6IE1hdGgucm91bmQoYy5yICogMjU1KSwKICAgICAgICBnOiBNYXRoLnJvdW5kKGMuZyAqIDI1NSksCiAgICAgICAgYjogTWF0aC5yb3VuZChjLmIgKiAyNTUpLAogICAgfTsKfQoKZnVuY3Rpb24gYWRqdXN0QnJpZ2h0bmVzcyh7IGNvbG9yLCBmYWN0b3IgfTogeyBjb2xvcjogc3RyaW5nOyBmYWN0b3I6IG51bWJlciB9KTogc3RyaW5nIHsKICAgIGNvbnN0IHsgciwgZywgYiB9ID0gcmVzb2x2ZUNvbG9yKGNvbG9yLnRyaW0oKSk7CgogICAgY29uc3QgYXIgPSBNYXRoLm1pbigyNTUsIE1hdGgubWF4KDAsIE1hdGgucm91bmQociAqIGZhY3RvcikpKTsKICAgIGNvbnN0IGFnID0gTWF0aC5taW4oMjU1LCBNYXRoLm1heCgwLCBNYXRoLnJvdW5kKGcgKiBmYWN0b3IpKSk7CiAgICBjb25zdCBhYiA9IE1hdGgubWluKDI1NSwgTWF0aC5tYXgoMCwgTWF0aC5yb3VuZChiICogZmFjdG9yKSkpOwoKICAgIGNvbnN0IHRvSGV4ID0gKGM6IG51bWJlcikgPT4gYy50b1N0cmluZygxNikucGFkU3RhcnQoMiwgJzAnKTsKICAgIHJldHVybiAnIycgKyB0b0hleChhcikgKyB0b0hleChhZykgKyB0b0hleChhYik7Cn0KCnJldHVybiBhZGp1c3RCcmlnaHRuZXNzKHRoYXQpOycBBGJvdHMkZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1AScAgoacFYGoCQZzeXN0ZW0CBACChpwVgqgJD2FiLnNoZWxsLnNlYXJjaCcAgoacFYGoCQRmb3JtAgQAgoacFZKoCQdub3RoaW5nJwCChpwVgagJDmFiUmV0cmlldmVGaWxlAgQAgoacFZqoCYIBQC8vcHVsbCBkb3duIGZpbGUgZGF0YQppZiAoIXRoYXQudXJsKQp7CiAgICByZXR1cm4gIm5vIGZpbGUgdXJsIHN1cHBsaWVkIjsKfQoKbGV0IGRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKHRoYXQudXJsKTsKCnJldHVybiBkYXRhOycAgoacFYGoCRBhYlJldHJpZXZlUmVjb3JkAgQAgoacFZ2pCewEQC8vcmV0cmlldmUgc3BlY2lmaWVkIHJlY29yZApsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKCmxldCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKaWYgKHRoYXQucmVjb3JkS2V5KQp7CiAgICByZWNvcmRLZXkgPSB0aGF0LnJlY29yZEtleTsKfQplbHNlIGlmIChhdXRoQm90KQp7CiAgICBpZiAoYXV0aEJvdC5pZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCiAgICB7CiAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKCiAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICB9Cn0KCmxldCByZWNvcmRFbmRwb2ludCA9IHRoYXQucmVjb3JkRW5kcG9pbnQgPyB0aGF0LnJlY29yZEVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwoKaWYgKCFyZWNvcmROYW1lKQp7CiAgICByZXR1cm4gIm5vIHJlY29yZCBuYW1lIHN1cHBsaWVkIjsKfQoKbGV0IGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCByZWNvcmROYW1lLCByZWNvcmRFbmRwb2ludCk7CgovL0FERCBhZGRpdGlvbmFsIGVycm9yIGhhbmRsaW5nPwoKcmV0dXJuIGdldFJlY29yZDsnAIKGnBWBqAkIcmVtZW1iZXICBACChpwViq4JKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAIKGnBWBqAkNbWFuaWZlc3RhdGlvbgIEAIKGnBWxrgko8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAgoacFYGoCQ5vbkxvb2t1cEFCRWdncwIEAIKGnBXYrgnPMkBjb25zdCB7IAogICAgYWJJRCwKICAgIGFiVmVyc2lvbiwKICAgIGluaXRpYWxCb290LAogICAgYXV0b0hhdGNoLAogICAgcmV0dXJuVHlwZSwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBrZXkgPSBjb25maWdCb3QudGFncy5rZXksCiAgICB0b2FzdCA9IHRydWUsCiAgICBzaG93SW5kaWNhdG9yID0gdHJ1ZSwKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50LCAvLyBzb3VyY2VFdmVudCBpcyBhbiBldmVudCBuYW1lIHRoYXQgc3ltYm9saXplcyB3aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwuIChvcHRpb25hbCkKfSA9IHRoYXQ7CgpsZXQgewogICAgcmVjb3JkS2V5ID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvLAp9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKbGlua3MudXRpbHMuYWJMb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGxvYWRpbmcgIiArIGFiSUQpOwoKLy9jbGVhciBhYi0xCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uICYmIGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgPT0gImFiTWVudSIpIHsKICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwp9CgpsZXQgYnVzeUluZGljYXRvcjsKCmlmIChzaG93SW5kaWNhdG9yKSB7CiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQoKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgbG9hZGluZyAke2FiSUR9YH0pOwp9Cgpjb25zdCBwb3NzaWJsZUF1dGggPSBhdXRoQm90ID8gYXV0aEJvdCA6IHRydWU7CmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBnZXRSZWNvcmQ6YCwgey4uLmdldFJlY29yZH0pOwp9CgpsZXQgZWdnRGF0YTsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYKICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5ICYmCiAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gInJlY29yZF9ub3RfZm91bmQiCiAgICApIHsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiKSB7CiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9sb2dnZWRfaW4iKSB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCiAgICAgICAgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiAKICAgICAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIgogICAgICAgICkgewogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHRvYXN0KSB7IAogICAgICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKICAgIH0KCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgIH0KCiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CmVsc2UgewogICAgY29uc3QgcHVibGljUmVhZFRlc3QgPSBnZXRSZWNvcmQubWFya2Vycy5pbmRleE9mKCJwdWJsaWNSZWFkIik7CiAgICBjb25zdCBhdXRob3IgPSBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwoKICAgIGlmIChwdWJsaWNSZWFkVGVzdCAhPSAtMSAmJiBhdXRob3IpIHsKICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIHsKICAgICAgICAgICAgY29uc3QgZWdnSGF0Y2hFdmVudCA9IGFiSUQ7CgogICAgICAgICAgICBvcy5yZWNvcmRFdmVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBlZ2dIYXRjaEV2ZW50KTsKICAgICAgICB9CiAgICB9CgogICAgLy9wYWNrYWdlIHRoZSByZWNvcmQgZGF0YQogICAgZWdnRGF0YSA9IGdldFJlY29yZC5kYXRhOwoKICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAvLyBDaGFuZ2UgaW5pdGlhbCB0YXJnZXQgdmVyc2lvbiBvZiB0aGUgZWdnIGlmIGFiVmVyc2lvbiBpcyBwcm92aWRlZC4KICAgICAgICBlZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9Cn0KCmlmIChyZXR1cm5UeXBlICE9IG51bGwpIHsKICAgIGlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICAgICAgICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYWJWZXJzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSBhYlZlcnNpb24gLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlZ2dEYXRhVVJMID0gZ2V0UmVjb3JkLmRhdGEuZWdnVmVyc2lvbkhpc3RvcnlbdmVyc2lvbl07CiAgICAgICAgICAgIGNvbnN0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXR1cm5EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocmV0dXJuVHlwZSA9PT0gImVnZyIpIHsKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNpbXBseSByZXR1cm4gdGhlIGVnZyBkYXRhIGlmIHJlcXVlc3RlZC4KICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZC5kYXRhOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVGhpcyBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgYXV4IGZpbGVzIHN0b3JlZCBiZWZvcmUgdGhlIHJlY29yZCBzeXN0ZW0gZXhpc3RlZC4KICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGNvbnN0IHZlcnNpb25BcnJheSA9IEpTT04ucGFyc2UoZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeSk7CiAgICAgICAgICAgIGNvbnN0IGZpbGVVVUlEID0gdmVyc2lvbkFycmF5W2VnZ0RhdGEubWF4VmVyc2lvbiAtIDFdOwogICAgICAgICAgICBjb25zdCBmaWxlbmFtZWhhc2hMVE0gPSBjcnlwdG8uc2hhMjU2KGZpbGVVVUlEKTsKICAgICAgICAgICAgY29uc3QgZmlsZXVybGhhc2hMVE0gPSAiYXV4XyIgKyBmaWxlbmFtZWhhc2hMVE0gKyAnLmF1eCc7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldExUTVVSTCA9ICJodHRwczovL2J1aWxkZXItbHRtLWZpbGVzLnMzLmFtYXpvbmF3cy5jb20vIiArIGZpbGV1cmxoYXNoTFRNOwogICAgICAgICAgICBjb25zdCBvID0gewogICAgICAgICAgICAgICAgbWV0aG9kOiAiR0VUIiwKICAgICAgICAgICAgICAgIHVybDogdGFyZ2V0TFRNVVJMCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsZXQgZmlsZUdldCA9IGF3YWl0IHdlYmhvb2sobyk7CgogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZpbGVHZXQuc3RhdHVzICE9IDIwMCkgewogICAgICAgICAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgb3MudG9hc3QoIm5vIGZpbGUgZm91bmQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CgogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZpbGVHZXQgPSBmaWxlR2V0LmRhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmaWxlR2V0OwogICAgICAgIH0KICAgIH0KfQoKLy9hYiBzcGVjaWZpYyB2YXJpYWJsZXMgZm9yIHVuZGVyc3RhbmRpbmcgaWYgYSBwb3NpdGlvbiBpcyBzcGVjaWZpZWQKbGV0IGN1cnJlbnREaW07CmxldCBzcGFjZU1vZDsKbGV0IGRpbWVuc2lvblg7CmxldCBkaW1lbnNpb25ZOwpsZXQgZGltTW9kOwoKLy9oYW5kbGUgZGltZW5zaW9uIGlkZW50aWZpY2F0aW9uCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGNvbnN0IGFiQm90ID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdDsKCiAgICAgICAgY3VycmVudERpbSA9IGFiQm90LnRhZ3MuZGltZW5zaW9uOwogICAgfQp9CmVsc2UgewogICAgY3VycmVudERpbSA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKLy9jaGVja3MgZm9yIGdyaWQgZm9jdXMKaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzKSB7CiAgICBkaW1lbnNpb25YID0gbnVsbDsKICAgIGRpbWVuc2lvblkgPSBudWxsOwp9CmVsc2UgewogICAgbGV0IGhhdGNoUG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKICAgIGN1cnJlbnREaW0gPSBoYXRjaFBvaW50LmRpbWVuc2lvbjsKICAgIGRpbWVuc2lvblggPSBoYXRjaFBvaW50LnBvc2l0aW9uLng7CiAgICBkaW1lbnNpb25ZID0gaGF0Y2hQb2ludC5wb3NpdGlvbi55OwogICAgc3BhY2VNb2QgPSB7IHNwYWNlOiAic2hhcmVkIiB9Owp9CgovL3RoaXMgbG9naWMgaGFuZGxlcyBsb2dpYyBhcm91bmQgYXV0b0hhdGNoIHZzIG1hbnVhbCBoYXRjaGluZwppZiAoIWF1dG9IYXRjaCAmJiBjb25maWdCb3QudGFncy5wYXR0ZXJuID09IG51bGwpIHsKICAgIGRpbU1vZCA9IHsKICAgICAgICBbY3VycmVudERpbV06IHRydWUsCiAgICAgICAgW2N1cnJlbnREaW0gKyAiWCJdOiBkaW1lbnNpb25YLAogICAgICAgIFtjdXJyZW50RGltICsgIlkiXTogZGltZW5zaW9uWSwKICAgICAgICBkaW1lbnNpb246IGN1cnJlbnREaW0KICAgIH07Cn0KZWxzZSB7CiAgICBkaW1Nb2QgPSB7IGF1dG9IYXRjaDogdHJ1ZSwga2V5IH07Cn0KCi8vY2FsbCBmb3Igb3ZvIHdpdGggaW5mb3JtYXRpb24gcHJvdmlkZWQKY29uc3QgbWFuaWZlc3RSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm1hbmlmZXN0T3ZvKHsKICAgIGFiSUQsCiAgICBzdHVkaW86IHJlY29yZEtleSwKICAgIGRpbU1vZCwKICAgIHNwYWNlTW9kLAogICAgZWdnRGF0YSwKICAgIGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50LAp9KTsKCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpsaW5rcy51dGlscy5hYkxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgYWJJRCArICIgbG9hZGVkLCB2ZXJzaW9uICIgKyBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgZ2V0UmVjb3JkLmRhdGEubWF4VmVyc2lvbik7CgpyZXR1cm4gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIGhhdGNoZWRCb3RzOiBtYW5pZmVzdFJlc3VsdD8uaGF0Y2hlZEJvdHMsCn07JwCChpwVgagJC21hbmlmZXN0T3ZvAgQAgoacFajhCdQPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCAmJiAhY29uZmlnQm90LnRhZ3MuYWJTdGF5QXdha2UpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgppZiAobGlua3Mub3ZvQm90KSB7CiAgICBkZXN0cm95KGxpbmtzLm92b0JvdCk7Cn0KCmxldCBlZ2dNb2QgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBpbml0aWFsVGltZXI6IHRydWUsCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgc291cmNlRXZlbnQsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaW50ZXJhY3RPdm8oKTsKICAgIGAsCiAgICBmb3JtOiAiZWdnIiwKICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VMYWJlbENvbG9yLAogICAgcHJvZ3Jlc3NCYXJDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvciwKICAgIHByb2dyZXNzQmFyQmFja2dyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxTaXplOiAwLjUsCiAgICBvblBvaW50ZXJFbnRlcjogYEAKICAgICAgICBtYXNrcy50aXBJZCA9IGF3YWl0IG9zLnRpcCh0YWdzLmFiSUQgKyAnIHYnICsgdGFncy50YXJnZXRWZXJzaW9uKTsKICAgIGAsCiAgICBvblBvaW50ZXJFeGl0OiBgQAogICAgICAgIGlmIChtYXNrcy50aXBJZCkgewogICAgICAgICAgICBvcy5oaWRlVGlwcyhtYXNrcy50aXBJZCk7CiAgICAgICAgfQogICAgYCwKICAgIGxhYmVsUG9zaXRpb246ICJmcm9udCIsCiAgICBvcmllbnRhdGlvbk1vZGU6ICJiaWxsYm9hcmRGcm9udCIsCiAgICBvbkRlc3Ryb3k6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5tYXNrcy5vdm9Cb3QgPSBudWxsOwogICAgYCwKICAgIGVnZ1RpbWVyOiBgQAogICAgICAgIGlmICh0YWdzLnByb2dyZXNzQmFyIDwgMSkgewogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyICs9IDAuMTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge3doaXNwZXIodGhpc0JvdCwgImVnZ1RpbWVyIik7fSwgNzUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNCb3Qub25DbGljaygpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciA9IG51bGw7CiAgICAgICAgfQogICAgYAp9OwoKCmNvbnN0IG92byA9IGF3YWl0IGNyZWF0ZShlZ2dEYXRhLCBlZ2dNb2QsIGRpbU1vZCwgc3BhY2VNb2QpOwptYXNrcy5vdm9Cb3QgPSBnZXRMaW5rKG92byk7CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBvdm8udmFycy5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGUgPSBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU7Cn0KCmlmIChvdm8udGFncy5hdXRvSGF0Y2gpIHsKICAgIGNvbnN0IGhhdGNoZWRCb3RzID0gYXdhaXQgdGhpc0JvdC5oYXRjaE92byhvdm8pOwogICAgcmV0dXJuIHsgaGF0Y2hlZEJvdHMgfTsKfQplbHNlIHsKICAgIG92by50YWdzLnByb2dyZXNzQmFyID0gMDsKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBvdm8udGFncy5tYXhWZXJzaW9uOwogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9JwCChpwVgagJCW9uS2V5RG93bgIEAIKGnBX98AmCBkAvL2hpZGRlbiB2ZXJzaW9uIGJ1dHRvbiBmb3IgaGF0Y2ggbWVudQppZiAoIWxpbmtzLm92b0JvdCB8fCBjb25maWdCb3QudGFncy5tZW51UG9ydGFsICE9ICJhYk92b01lbnUiKQp7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LmtleXMgPT0gIlNoaWZ0IikKewogICAgbGV0IHZlcnNpb25CdXR0b24gPSB7fTsKCiAgICB2ZXJzaW9uQnV0dG9uLmFiT3ZvTWVudSA9IHRydWU7CiAgICB2ZXJzaW9uQnV0dG9uLm92b1NvcnRPcmRlciA9IC0xOwogICAgdmVyc2lvbkJ1dHRvbi5tYXhWZXJzaW9uID0gbGlua3Mub3ZvQm90LnRhZ3MubWF4VmVyc2lvbjsKICAgIHZlcnNpb25CdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7CiAgICB2ZXJzaW9uQnV0dG9uLmxhYmVsID0gImNoYW5nZSBlZ2cgdmVyc2lvbiI7CiAgICB2ZXJzaW9uQnV0dG9uLmxhYmVsQWxpZ25tZW50ID0gImNlbnRlciI7CiAgICB2ZXJzaW9uQnV0dG9uLm92b01lbnVSZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKICAgIHZlcnNpb25CdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yOwogICAgdmVyc2lvbkJ1dHRvbi5vbktleVVwID0gIkAgaWYodGhhdC5rZXlzID09ICdTaGlmdCcpe2Rlc3Ryb3kodGhpc0JvdCl9OyI7CiAgICB2ZXJzaW9uQnV0dG9uLm9uQ2xpY2sgPSAiQCBsaW5rcy5tYW5hZ2VyLmNoYW5nZU92b1ZlcnNpb24oKTsiOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHZlcnNpb25CdXR0b24pOwp9JwCChpwVgagJCGhhdGNoT3ZvAgQAgoacFf72CZ0VQC8vbG9naWMgZm9yIGhhdGNoaW5nIG9mIGFuIGFiCnNob3V0KCdvdm9NZW51UmVzZXQnKTsKCi8vZGF0YSBpbiByZWdhcmRzIHRvIHdoYXQgYWIgaXMgZ29pbmcgdG8gYmUgaGF0Y2hlZApjb25zdCBvdm8gPSB0aGF0OwoKLy9oYXRjaCBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGluaXRpYWxCb290ID0gb3ZvLnRhZ3MuaW5pdGlhbEJvb3Q7CmxldCB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiA/PyBvdm8udGFncy50YXJnZXRWZXJzaW9uOwoKaWYgKChjb25maWdCb3QudGFncy5hYlZlcnNpb24gfHwgY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb24pICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy5hYlZlcnNpb24gPz8gY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb247Cn0KCi8vdGFyZ2V0ZWQgdmVyc2lvbnMKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiIHx8ICFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkpCnsKICAgIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJmZWVkYmFjayIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmZlZWRiYWNrVmVyc2lvbjsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImN1cnJlbnQiKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICB9CiAgICBlbHNlIGlmICghaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnZlcnNpb24KICAgIH0KCiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gbnVsbDsKfQoKaWYgKGlzTmFOKHRhcmdldFZlcnNpb24pKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwp9CgpsZXQgdmVyc2lvbkFycmF5ID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3Rvcnk7CmxldCBmaWxlVVJMID0gdmVyc2lvbkFycmF5W3RhcmdldFZlcnNpb24gLSAxXTsKbGV0IGtleSA9IG92by50YWdzLmtleSA/IG92by50YWdzLmtleSA6IGNvbmZpZ0JvdC50YWdzLmtleTsKbGV0IGZpbGVHZXQ7CgovL2FjdHVhbCBmaWxlIHJldHJpZXZhbAp0cnkKewogICAgZmlsZUdldCA9IGF3YWl0IG9zLmdldEZpbGUoZmlsZVVSTCk7Cn0KY2F0Y2ggKGUpCnsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdubyBmaWxlIGZvdW5kJyk7CgogICAgcmV0dXJuOwp9CgovL2hhbmRsaW5nIGZvciBlbmNyeXB0ZWQgYWIgZmlsZQppZiAoY3J5cHRvLmlzRW5jcnlwdGVkKGZpbGVHZXQpKQp7CiAgICBpZiAoIWtleSkKICAgIHsKICAgICAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoJycsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnRW50ZXIga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGZpbGVHZXQgPSBjcnlwdG8uZGVjcnlwdChrZXksIGZpbGVHZXQpOwoKICAgIGlmIChmaWxlR2V0ID09IG51bGwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdpbmNvcnJlY3Qga2V5Jyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAKICAgIGZpbGVHZXQgPSBKU09OLnBhcnNlKGZpbGVHZXQpOwogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KZWxzZQp7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQoKLy9jbGVhbiB1cApkZXN0cm95KG92byk7CgovL3RvYXN0IGlmIG5vdCBvbiBzdGFibGUKaWYob3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiAhPSB0YXJnZXRWZXJzaW9uICYmICFjb25maWdCb3QudGFncy5hYlNpbGVudCkKewogICAgaWYgKG92by50YWdzLmZlZWRiYWNrVmVyc2lvbiA9PSB0YXJnZXRWZXJzaW9uKQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIGZlZWRiYWNrIHZlcnNpb24gb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIHZlcnNpb24gIiArIHRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggKyAiIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KfQoKLy9nZW5lcmF0ZSBib3RzIGJhc2VkIG9uIHRoZSBmaWxlIHJldHJpZXZlZCAqSEVSRSoKY29uc3QgbmV3Qm90cyA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoewogICAgYm90czogZmlsZUdldCwKICAgIG9yaWdpbjogb3ZvLnRhZ3MuYWJJRCwKICAgIHN0dWRpbzogb3ZvLnRhZ3Muc3R1ZGlvLAogICAgdmVyc2lvbjogdGFyZ2V0VmVyc2lvbiwKICAgIGluaXRpYWxCb290OiBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnM6IG92by50YWdzLmVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50OiBvdm8udGFncy5zb3VyY2VFdmVudCwKfSk7CgpyZXR1cm4gbmV3Qm90czsnAIKGnBWBqAkLaW50ZXJhY3RPdm8CBACChpwVnIwK6QZALy9tYW51YWwgaGF0Y2ggbWVudQpjb25zdCBvdm9Cb3QgPSB0aGF0ID8gdGhhdCA6IGxpbmtzLm92b0JvdDsKCmlmICghb3ZvQm90KSB7CiAgICByZXR1cm47Cn0KCnNob3V0KCJvdm9NZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiT3ZvTWVudSI7CgptYXNrcy5vbkdyaWRDbGljayA9IGBACiAgICBzaG91dCgib3ZvTWVudVJlc2V0Iik7CmA7Cm1hc2tzLm92b01lbnVSZXNldCA9IGBACiAgICBtYXNrcy5vbkdyaWRDbGljayA9IG51bGw7CiAgICBtYXNrcy5vdm9NZW51UmVzZXQgPSBudWxsOwoKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKYDsKCm9zLnR3ZWVuVG8ob3ZvQm90LCAxNSw0NSw0NSwgNSk7Cgpjb25zdCBlZ2dNZW51QnV0dG9uID0gewogICAgYWJPdm9NZW51OiB0cnVlLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG92b0JvdDogZ2V0TGluayhvdm9Cb3QpLAogICAgY29sb3I6IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHRhcmdldFZlcnNpb246IG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sCiAgICBsYWJlbDogYGhhdGNoICR7b3ZvQm90LnRhZ3MuYWJJRH0gdiR7b3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbn0gb2YgJHtvdm9Cb3QudGFncy5tYXhWZXJzaW9ufWAsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBvdm9NZW51UmVzZXQ6IGBACiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIGAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaGF0Y2hPdm8obGlua3Mub3ZvQm90KTsKICAgIGAsCn07CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihlZ2dNZW51QnV0dG9uKTsnAIKGnBWBqAkGY3JlYXRlAgQAgoacFYaTCijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwCChpwVgagJEGNoYW5nZU92b1ZlcnNpb24CBACChpwVrZMK8AJALy9sb2dpYyBmb3IgdmVyc2lvbiBjaGFuZ2luZyB3aGVuIG1hbnVhbGx5IGhhdGNoaW5nIGFuIGFiCmNvbnN0IG92b0JvdCA9IGxpbmtzLm92b0JvdDsKCmxldCBuZXdWZXJzaW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sIHsKICAgIHBsYWNlaG9sZGVyOiAiZW50ZXIgYSB2ZXJzaW9uIGZyb20gMSB0byAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbgp9KTsKCm92b0JvdC50YWdzLnRhcmdldFZlcnNpb24gPSBuZXdWZXJzaW9uOwpvdm9Cb3QudGFncy5sYWJlbCA9ICd2JysgbmV3VmVyc2lvbjsKCmNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBuZXdWZXJzaW9uOwoKc2hvdXQoIm92b01lbnVSZXNldCIpOycAgoacFYGoCQRtZW51AgQAgoacFZ6WCijwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCChpwVgagJCGFiSWdub3JlAgQAgoacFcWWCgR0cnVlJwCChpwVgagJB2FiU2hlbGwCBACChpwVypYKBHRydWUnAIKGnBWBqAkMYWIxTFRNU2VhcmNoAgQAgoacFc+WCjNALy9zdXBwb3J0IG9sZCBzeW50YXgKdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsnAIKGnBWBqAkNb25Mb29rdXBBc2tJRAIEAIKGnBWDlwqyIEBjb25zdCBhc2tJRCA9IHRoYXQ/LmFza0lEOwpjb25zdCBzaG93SW5kaWNhdG9yID0gdGhhdD8uc2hvd0luZGljYXRvciA/PyB0cnVlOwpjb25zdCBhdXRvSGF0Y2ggPSB0aGF0Py5hdXRvSGF0Y2ggPz8gdHJ1ZTsKY29uc3QgZWdnUGFyYW1ldGVycyA9IHRoYXQ/LmVnZ1BhcmFtZXRlcnM7CmNvbnN0IHNvdXJjZUV2ZW50ID0gdGhhdD8uc291cmNlRXZlbnQ7CmNvbnN0IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IHRoYXQ/Lm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsKY29uc3QgaWdub3JlUmVzZXJ2ZWQgPSB0aGF0Py5pZ25vcmVSZXNlcnZlZDsKY29uc3QgZGF0YU9ubHkgPSB0aGF0Py5kYXRhT25seSA/PyBmYWxzZTsKCmFzc2VydCh0eXBlb2YgYXNrSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmxldCBsb29rdXBBc2s6IEFCTG9va3VwQXNrSURSZXN1bHQ7CmxldCBidXN5SW5kaWNhdG9yOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvb2tpbmcgdXAgJHthc2tJRH1gIH0pOwp9CgovL0NoZWNrIGZvciByZXNlcnZlZCBrZXl3b3JkcwppZiAobGlua3M/LmxlYXJuPy50YWdzPy5yZXNlcnZlZEFza3M/LmluY2x1ZGVzKGFza0lEKSAmJiAhaWdub3JlUmVzZXJ2ZWQgJiYgYXV0aEJvdCkgewogICAgaWYgKCFnZXRCb3QoImFiSURPcmlnaW4iLCBhc2tJRCkpIHsKICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCB0aGlzQm90Lmxvb2t1cEZyb21TdHVkaW8oey4uLnRoYXQsIHJlc2VydmVkOiB0cnVlLCBkYXRhT25seSB9KTsKICAgICAgICBpZiAobG9va3VwQXNrICYmIGxvb2t1cEFzay5zdWNjZXNzID09IHRydWUpIHsKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmV0dXJuaW5nIHJlc2VydmVkIGFzayAnJHthc2tJRH0nIGZvdW5kIGluIHN0dWRpbzpgLCBsb29rdXBBc2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsb29rdXBBc2s7CiAgICAgICAgfQogICAgfQp9CgovLyBGaXJzdCBjaGVjayB0aGUgY2FzdWFsIGNhdGFsb2cgZm9yIHRoZSBhc2suCmNvbnN0IGNhc3VhbENhdGFsb2dVUkwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2Fza3MvJHthc2tJRH0uYXV4YCk7Cgp0cnkgewogICAgY29uc3QgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICdHRVQnLCB1cmw6IGNhc3VhbENhdGFsb2dVUkwgfSk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhc3VhbCBjYXRhbG9nIHJlc3BvbnNlOmAsIGNhc3VhbENhdGFsb2dSZXNwb25zZSk7CiAgICB9CgogICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgIGlmIChjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAxICYmIGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnN0YXRlKSB7CiAgICAgICAgICAgIGlmIChkYXRhT25seSkgewogICAgICAgICAgICAgICAgbG9va3VwQXNrID0gewogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQ2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UgaXMgYSB2MSBhdXggZmlsZS4KICAgICAgICAgICAgICAgIGNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgCiAgICAgICAgICAgICAgICAgICAgYm90czogY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgaWdub3JlR3JpZEZvY3VzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9yaWdpbjogYXNrSUQsCiAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICAgICAgICAgICAgICAgICAgc291cmNlRXZlbnQsCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycsCiAgICAgICAgICAgICAgICAgICAgaGF0Y2hlZEJvdHM6IG5ld0JvdHMsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIgJiYgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcykgewogICAgICAgICAgICAvLyBDYXN1YWwgY2F0YWxvZyByZXNwb25zZSBpcyBhIHYyIGF1eCBmaWxlLgogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFza3Mgb25seSBzdXBwb3J0IHYxIGF1eCBmaWxlIGZvcm1hdC5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CgogICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIHJlc3BvbnNlLgogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS5gLCBjYXN1YWxDYXRhbG9nUmVzcG9uc2UpOwogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFVucmVjb2duaXplZCBjYXN1YWwgY2F0YWxvZyBhc2sgcmVzcG9uc2UuIENoZWNrIGNvbnNvbGUgZm9yIG1vcmUgZGV0YWlscy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CgogICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJldHVybmluZyBhc2sgJyR7YXNrSUR9JyBmb3VuZCBpbiBjYXN1YWwgY2F0YWxvZzpgLCBsb29rdXBBc2spCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbG9va3VwQXNrOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICAvLyBEaWQgbm90IGZpbmQgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLgp9Cgpsb29rdXBBc2sgPSBhd2FpdCB0aGlzQm90Lmxvb2t1cEZyb21TdHVkaW8odGhhdCk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBGcm9tU3R1ZGlvIHJlc3VsdDpgLCB7Li4ubG9va3VwQXNrfSk7Cn0KCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gbG9va3VwQXNrOycAgoacFYGoCQV0eXBlcwIEAIKGnBW2twr2AfCfk4R0eXBlIEFCQXNrSURPcmlnaW4gPSAnY2FzdWFsX2NhdGFsb2cnIHwgJ2FiX3JlY29yZCc7CgppbnRlcmZhY2UgQUJMb29rdXBBc2tJRFJlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuOwogICAgb3JpZ2luOiBBQkFza0lET3JpZ2luOwogICAgaGF0Y2hlZEJvdHM/OiBCb3RbXTsKfQoKaW50ZXJmYWNlIEFCTG9va3VwRWdnUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW4sCiAgICBoYXRjaGVkQm90cz86IEJvdFtdLAp9CicAgoacFYGoCQVpbnB1dAIEAIKGnBWruQoo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAgoacFYGoCQVoYXRjaAIEAIKGnBXSuQrAAUAvL3Nob3V0KCJoYXRjaCIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywga2V5OiBrZXksIGF1dG9IYXRjaDogYm9vbGVhbiwgcmV0dXJuVHlwZTogZGF0YS9udWxsLCBlZ2dQYXJhbWV0ZXJzOiBhcmd9KTsKCmNvbnN0IGxvb2tVcCA9IGF3YWl0IHRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7CgpyZXR1cm4gbG9va1VwOycAgoacFYGoCQlhYlZlcnNpb24CBACChpwVk7sKBTEwLjQzJwCChpwVgagJBWxlYXJuAgQAgoacFZm7Cijwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCChpwVgagJBXV0aWxzAgQAgoacFcC7Cijwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCChpwVgagJC3BlcnNvbmFsaXR5AgQAgoacFee7Cijwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwCChpwVgagJEGxvb2t1cEZyb21TdHVkaW8CBACChpwVjrwK+CpAY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsNCmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOw0KY29uc3QgZWdnUGFyYW1ldGVycyA9IHRoYXQ/LmVnZ1BhcmFtZXRlcnM7DQpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQ/LnNvdXJjZUV2ZW50Ow0KY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOw0KY29uc3QgcmVzZXJ2ZWQgPSB0aGF0Py5yZXNlcnZlZDsNCmNvbnN0IGlzQ2hhbm5lbCA9IHRoYXQ/LmlzQ2hhbm5lbDsNCmNvbnN0IGlzVVVBQiA9IHRoYXQ/LmlzVVVBQjsNCmNvbnN0IGRhdGFPbmx5ID0gdGhhdD8uZGF0YU9ubHkgPz8gZmFsc2U7DQoNCmxldCBsb29rdXBBc2s6IEFCTG9va3VwQXNrSURSZXN1bHQ7DQpsZXQgdXNlZFN0dWRpbzsNCg0KaWYgKHRhZ3MuZGVidWcpIHsNCiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsNCn0NCg0KLy8gQ2hlY2sgdGhlIGFiIHJlY29yZCBmb3IgdGhlIGFzay4NCmNvbnN0IGFiRm9ybWF0dGVkQXNrSUQgPSBhc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOw0KDQppZiAodGFncy5kZWJ1Zykgew0KICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJGb3JtYXR0ZWRBc2tJRDpgLCBhYkZvcm1hdHRlZEFza0lEKTsNCn0NCg0KaWYgKHJlc2VydmVkKSB7DQogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbykgew0KICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICE9IGF1dGhCb3QuaWQpIHsNCiAgICAgICAgICAgIGNvbnN0IHBlcm1zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7DQogICAgICAgICAgICBpZiAocGVybXMuc3VjY2Vzcykgew0KICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gcGVybXMuc3R1ZGlvcy5maW5kKChzdHVkKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAoc3R1ZC5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBVc2VyIHBlcm1pc3Npb25zIGZvciBzdHVkaW8iLCBmb3VuZCwgcGVybXMpOw0KICAgICAgICAgICAgICAgIGlmICghZm91bmQpIHsNCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IFVzZXIgZG9lcyBub3QgaGF2ZSBwZXJtaXNzaW9ucyBmb3IgdGhpcyBzdHVkaW8uIikNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdXNlZFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8sIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzICYmIGxvb2t1cEFzay5lcnJvckNvZGUgJiYgbG9va3VwQXNrLmVycm9yQ29kZSA9PSAnbm90X2F1dGhvcml6ZWQnKSB7DQogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oY29uZmlnQm90LnRhZ3Muc3R1ZGlvKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogZmFpbHVyZSBsb29raW5nIHVwIGFzayBpbiBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBMb29rZWQgdXAgYXNrIGluIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICAgIHVzZWRTdHVkaW8gPSBhdXRoQm90Py5pZDsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90Py5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90Py5pZCk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3Q/LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogZmFpbHVyZSBsb29raW5nIHVwIGFzayBpbiB1c2VyIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IExvb2tlZCB1cCBhc2sgaW4gdXNlciBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQp9IGVsc2Ugew0KICAgIHVzZWRTdHVkaW8gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5Ow0KICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYGFza18ke2FiRm9ybWF0dGVkQXNrSUR9YCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsNCiAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFzayBhdHRlbXB0IDE6YCwgey4uLmxvb2t1cEFza30pOw0KICAgIH0NCiAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzKSB7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYWJGb3JtYXR0ZWRBc2tJRCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsNCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMjpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzICYmIGlzVVVBQikgew0KICAgICAgICB1c2VkU3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQ7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2sgYXR0ZW1wdCAzIChpc1VVQUIpOmAsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgfQ0KICAgICAgICBpZihsb29rdXBBc2suZXJyb3JDb2RlICYmIGxvb2t1cEFzay5lcnJvckNvZGUgPT0gJ25vdF9hdXRob3JpemVkJykgew0KICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKCFsb29rdXBBc2suc3VjY2VzcyAmJiBpc0NoYW5uZWwpIHsNCiAgICAgICAgdXNlZFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkOw0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMyAoaXNDaGFubmVsKTpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgIH0NCiAgICAgICAgaWYobG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KbG9va3VwQXNrLm9yaWdpbiA9ICdhYl9yZWNvcmQnOw0KDQppZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgKGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCB8fCByZXNlcnZlZCB8fCBpc0NoYW5uZWwgfHwgaXNVVUFCKSkgew0KICAgIGlmIChkYXRhT25seSkgew0KICAgICAgICByZXR1cm4gbG9va3VwQXNrOw0KICAgIH0gZWxzZSB7DQogICAgICAgIC8vIExvb2t1cCB0aGUgZWdnIHVzaW5nIHRoZSBzdHVkaW9JRCBhbmQgcGF0dGVybklEIGZyb20gdGhlIGFiX3JlY29yZCBhc2suDQogICAgICAgIGNvbnN0IGxvb2t1cEVnZzogQUJMb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogKHJlc2VydmVkIHx8IGlzQ2hhbm5lbCB8fCBpc1VVQUIpID8gYWJGb3JtYXR0ZWRBc2tJRCA6IGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA/PyB1c2VkU3R1ZGlvLCBhdXRvSGF0Y2gsIGVnZ1BhcmFtZXRlcnMsIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgc291cmNlRXZlbnQgfSk7DQogICAgICAgIA0KICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBFZ2c6YCwgey4uLmxvb2t1cEVnZ30pOw0KICAgICAgICB9DQoNCiAgICAgICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBsb29rdXBFZ2cuc3VjY2VzczsNCiAgICAgICAgbG9va3VwQXNrLmhhdGNoZWRCb3RzID0gbG9va3VwRWdnLmhhdGNoZWRCb3RzOw0KICAgIH0NCn0gZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgIWxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCAmJiAhbG9va3VwQXNrLmRhdGEudXJsKSB7DQogICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBmYWxzZTsNCn0NCg0KcmV0dXJuIGxvb2t1cEFzazsnAIKGnBWBqAkFZGVidWcCBACChpwVh+cKBWZhbHNlJwCChpwVgagJGmFiQ2FzdWFsQ2F0YWxvZ0Fza0lERXhpc3RzAgQAgoacFY3nCoIHQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IHVybCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYXNrcy8ke2Fza0lEfS5hdXhgKTsKCmxldCBleGlzdHM7CmxldCByZXNwb25zZTsKCnRyeSB7CiAgICByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsKICAgICAgICBtZXRob2Q6ICdIRUFEJywKICAgICAgICB1cmwsCiAgICB9KQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZXNwb25zZTpgLCByZXNwb25zZSk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIENhbGwgdG8gY2FzdWFsIGNhdGFsb2cgaGFzIGZhaWxlZCwgdGhlIGFzayBpZCBkb2VzIG5vdCBleGlzdCB0aGVyZS4KICAgIC8vIE5PVEU6IEl0IHdvdWxkIGJlIG5pY2UgaWYgdGhlIENhc3VhbCBDYXRhbG9nIGVuZHBvaW50IHJldHVybmVkIGEgNDA0IE5vdCBGb3VuZCBzdGF0dXMgY29kZSBqdXN0IHNvIHdlIGNhbiBydWxlIG91dCBhY3R1YWwgc2VydmVyIGVycm9ycy4KICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBhbiBlcnJvcjpgLCBlKTsKICAgIH0KCiAgICBleGlzdHMgPSBmYWxzZTsKfQoKaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICBleGlzdHMgPSB0cnVlOwp9IGVsc2UgewogICAgZXhpc3RzID0gZmFsc2U7Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEICcke2Fza0lEfScgZXhpc3RzIGluIGNhc3VhbCBjYXRhbG9nP2AsIGV4aXN0cyk7Cn0KCnJldHVybiBleGlzdHM7CicAgoacFYGoCRlhYkNoZWNrQXNrVXBkYXRlQXZhaWxhYmxlAgQAgoacFZDuCssOQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IGN1cnJlbnRIYXNoID0gdGhhdD8uY3VycmVudEhhc2g7CmNvbnN0IGhhc2hBbGdvcml0aG0gPSB0aGF0Py5oYXNoQWxnb3JpdGhtID8/ICdzaGExJzsKY29uc3QgaGFzaEZvcm1hdCA9IHRoYXQ/Lmhhc2hGb3JtYXQgPz8gJ2hleCc7Cgphc3NlcnQodHlwZW9mIGFza0lEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhc2tJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgY3VycmVudEhhc2ggPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGN1cnJlbnRIYXNoIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKQoKY29uc3QgYXNrRGF0YSA9IGF3YWl0IGFiLmxpbmtzLnNlYXJjaC5vbkxvb2t1cEFza0lEKHsgYXNrSUQsIHNob3dJbmRpY2F0b3I6IGZhbHNlLCBkYXRhT25seTogdHJ1ZSwgc291cmNlRXZlbnQ6ICdhc2tfdXBkYXRlX2NoZWNrJyB9KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0RhdGE6YCwgYXNrRGF0YSk7Cn0KCmlmIChhc2tEYXRhLnN1Y2Nlc3MpIHsKICAgIGlmIChhc2tEYXRhLmRhdGEucGF0dGVybklEICYmIGFza0RhdGEuZGF0YS5zdHVkaW9JRCkgewogICAgICAgIC8vIEFzayBpcyBhIHBvaW50ZXIgdG8gYW4gZWdnIGluIGEgc3R1ZGlvLgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGFiRGF0YSA9IGF3YWl0IGFiLmxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7IGFiSUQ6IGFza0RhdGEuZGF0YS5wYXR0ZXJuSUQsIHJlY29yZEtleTogYXNrRGF0YS5kYXRhLnN0dWRpb0lELCByZXR1cm5UeXBlOiAnZGF0YSd9KTsKICAgICAgICAgICAgY29uc3QgbGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiRGF0YS5zdGF0ZSk7CgogICAgICAgICAgICByZXR1cm4geyAKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2h0IGFuIGVycm9yLmAsIGUpOwogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICAgICAgfQogICAgfSAgZWxzZSBpZiAoYXNrRGF0YS5kYXRhLnZlcnNpb24gPT09IDEgJiYgYXNrRGF0YS5kYXRhLnN0YXRlKSB7CiAgICAgICAgLy8gQXNrIGlzIGEgdjEgYXV4IGZpbGUuCiAgICAgICAgY29uc3QgbGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFza0RhdGEuZGF0YS5zdGF0ZSk7CgogICAgICAgIHJldHVybiB7IAogICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICBjdXJyZW50SGFzaCwKICAgICAgICAgICAgbGF0ZXN0SGFzaCwKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgYXNrRGF0YSBzdHJ1Y3R1cmUuYCwgYXNrRGF0YSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9IGVsc2UgewogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQp9CicAgoacFYGoCRlhYkNoZWNrRWdnVXBkYXRlQXZhaWxhYmxlAgQAgoacFdz8CpkHQGNvbnN0IGFiSUQgPSB0aGF0Py5hYklEOwpjb25zdCBjdXJyZW50QUJWZXJzaW9uID0gdGhhdD8uY3VycmVudEFCVmVyc2lvbjsgLy8gMS1iYXNlZCB2ZXJzaW9uIG51bWJlci4KY29uc3QgcmVjb3JkS2V5T3JOYW1lID0gdGhhdD8ucmVjb3JkS2V5T3JOYW1lOwoKYXNzZXJ0KHR5cGVvZiBhYklEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYklEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlcmApOwphc3NlcnQoTnVtYmVyLmlzSW50ZWdlcihjdXJyZW50QUJWZXJzaW9uKSAmJiBjdXJyZW50QUJWZXJzaW9uID4gMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjdXJyZW50QUJWZXJzaW9uIG11c3QgYmUgYW4gaW50ZWdlciBncmVhdGVyIHRoYW4gMC5gKTsKYXNzZXJ0KHR5cGVvZiByZWNvcmRLZXlPck5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleU9yTmFtZSBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBlZ2cgPSBhd2FpdCBhYi5saW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoeyBhYklELCByZWNvcmRLZXk6IHJlY29yZEtleU9yTmFtZSwgcmV0dXJuVHlwZTogJ2VnZyd9KTsKCmlmICghZWdnIHx8IGVnZy5zdWNjZXNzID09PSBmYWxzZSkgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiBmYWxzZQogICAgfQp9IGVsc2UgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogZWdnLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCA+IGN1cnJlbnRBQlZlcnNpb24sCiAgICAgICAgY3VycmVudEFCVmVyc2lvbiwKICAgICAgICBsYXRlc3RBQlZlcnNpb246IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGgsCiAgICB9Cn0KJwEEYm90cyRmMWU2NmNjOS0wYjY2LTQ5YzMtODNjOS1jNzAyZjU0YjM1OWYBJwCChpwV9oMLBnN5c3RlbQIEAIKGnBX3gwsPYWIuc2hlbGwuZGVkZW50JwCChpwV9oMLCm9uQm90QWRkZWQCBACChpwVh4QL0QlALy8gZGVkZW50LWpzIGh0dHBzOi8vZ2l0aHViLmNvbS9NYXJ0aW5Lb2xhcmlrL2RlZGVudC1qcwoKLyoqCiAqIFJlbW92ZXMgaW5kZW50YXRpb24gZnJvbSBtdWx0aWxpbmUgc3RyaW5ncy4gV29ya3Mgd2l0aCBib3RoIHRhYnMgYW5kIHNwYWNlcy4KICovCmZ1bmN0aW9uIGRlZGVudCAodGVtcGxhdGVTdHJpbmdzLCAuLi52YWx1ZXMpIHsKCWxldCBtYXRjaGVzID0gW107CglsZXQgc3RyaW5ncyA9IHR5cGVvZiB0ZW1wbGF0ZVN0cmluZ3MgPT09ICdzdHJpbmcnID8gWyB0ZW1wbGF0ZVN0cmluZ3MgXSA6IHRlbXBsYXRlU3RyaW5ncy5zbGljZSgpOwoKCS8vIDEuIFJlbW92ZSB0cmFpbGluZyB3aGl0ZXNwYWNlLgoJc3RyaW5nc1tzdHJpbmdzLmxlbmd0aCAtIDFdID0gc3RyaW5nc1tzdHJpbmdzLmxlbmd0aCAtIDFdLnJlcGxhY2UoL1xyP1xuKFtcdCBdKikkLywgJycpOwoKCS8vIDIuIEZpbmQgYWxsIGxpbmUgYnJlYWtzIHRvIGRldGVybWluZSB0aGUgaGlnaGVzdCBjb21tb24gaW5kZW50YXRpb24gbGV2ZWwuCglmb3IgKGxldCBpID0gMDsgaSA8IHN0cmluZ3MubGVuZ3RoOyBpKyspIHsKCQlsZXQgbWF0Y2g7CgoJCWlmIChtYXRjaCA9IHN0cmluZ3NbaV0ubWF0Y2goL1xuW1x0IF0rL2cpKSB7CgkJCW1hdGNoZXMucHVzaCguLi5tYXRjaCk7CgkJfQoJfQoKCS8vIDMuIFJlbW92ZSB0aGUgY29tbW9uIGluZGVudGF0aW9uIGZyb20gYWxsIHN0cmluZ3MuCglpZiAobWF0Y2hlcy5sZW5ndGgpIHsKCQlsZXQgc2l6ZSA9IE1hdGgubWluKC4uLm1hdGNoZXMubWFwKHZhbHVlID0+IHZhbHVlLmxlbmd0aCAtIDEpKTsKCQlsZXQgcGF0dGVybiA9IG5ldyBSZWdFeHAoYFxuW1x0IF17JHtzaXplfX1gLCAnZycpOwoKCQlmb3IgKGxldCBpID0gMDsgaSA8IHN0cmluZ3MubGVuZ3RoOyBpKyspIHsKCQkJc3RyaW5nc1tpXSA9IHN0cmluZ3NbaV0ucmVwbGFjZShwYXR0ZXJuLCAnXG4nKTsKCQl9Cgl9CgoJLy8gNC4gUmVtb3ZlIGxlYWRpbmcgd2hpdGVzcGFjZS4KCXN0cmluZ3NbMF0gPSBzdHJpbmdzWzBdLnJlcGxhY2UoL15ccj9cbi8sICcnKTsKCgkvLyA1LiBQZXJmb3JtIGludGVycG9sYXRpb24uCglsZXQgc3RyaW5nID0gc3RyaW5nc1swXTsKCglmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewoJCXN0cmluZyArPSB2YWx1ZXNbaV0gKyBzdHJpbmdzW2kgKyAxXTsKCX0KCglyZXR1cm4gc3RyaW5nOwp9CgpnbG9iYWxUaGlzLmRlZGVudCA9IGRlZGVudDsnAIKGnBX2gwsJb25EZXN0cm95AgQAgoacFdmNCxlkZWxldGUgZ2xvYmFsVGhpcy5kZWRlbnQ7JwCChpwV9oMLCGFiSWdub3JlAgQAgoacFfONCwR0cnVlJwCChpwV9oMLB2FiU2hlbGwCBACChpwV+I0LBHRydWUnAIKGnBX2gwsJYWJWZXJzaW9uAgQAgoacFf2NCwUxMC40MycBBGJvdHMkZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwAScAgoacFYOOCwZzeXN0ZW0CBACChpwVhI4LDmFiLnNoZWxsLmlucHV0JwCChpwVg44LBGZvcm0CBACChpwVk44LB25vdGhpbmcnAIKGnBWDjgsJb25LZXlEb3duAgQAgoacFZuOC9ULQGlmIChhYi5saW5rcy5yZW1lbWJlci50YWdzLmFiQWxsb3dDaGF0QmFyID09PSBmYWxzZSB8fCAhYWIuYWJJc1ByaW1hcnkoKSkgewogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGtleXMgfSA9IHRoYXQ7CgppZiAobWFza3MuY2hhdE9wZW4pIHsKICAgIGNvbnN0IGVzYyA9IHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJyk7CgogICAgaWYgKGVzYykgewogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYXJyb3dVcCA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dVcCcpOwogICAgICAgIGNvbnN0IGFycm93RG93biA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dEb3duJyk7CiAgICAgICAgCiAgICAgICAgaWYgKGFycm93VXAgfHwgYXJyb3dEb3duKSB7CiAgICAgICAgICAgIC8vIElmIEFycm93VXAgb3IgQXJyb3dEb3duIGFyZSBwcmVzc2VkIHdoaWxlIHRoZSBhYiBjaGF0IGJhciBpcyBvcGVuIHRoZW4KICAgICAgICAgICAgLy8gc3RhcnQgY29tYmluZyB0aHJvdWdoIGNoYXQgaGlzdG9yeS4KICAgICAgICAgICAgY29uc3QgZGlyID0gYXJyb3dVcCA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ICsgZGlyOwogICAgICAgICAgICBsZXQgaGlzdG9yaWNhbFRleHQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBoaXN0b3JpY2FsVGV4dCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeVtpbmRleF07CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPj0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgY2hhdCBiYXIuCiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKHsgcHJlZmlsbDogaGlzdG9yaWNhbFRleHQgfSk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgY29uc3QgYmFja3RpY2sgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ2AnKSB8fCB0aGF0LmtleXMuaW5jbHVkZXMoIkRlYWQiKTsKCiAgICBpZiAoYmFja3RpY2spIHsKICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgIH0KfQonAIKGnBWDjgsGb25DaGF0AgQAgoacFfGZC+gYQC8vIE5vdCBzdXBwb3J0ZWQgb3V0c2lkZSBvZiBidWlsZGVyIHZlcnNpb24KaWYgKCFidWlsZGVyVmVyc2lvbikgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgppZiAoIXRoYXQubWVzc2FnZSkgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgovLyBBcHBlbmQgbWVzc2FnZSB0byBjaGF0IGhpc3RvcnkgYW5kIHVwZGF0ZSB0aGUgY3VycmVudCBoaXN0b3J5IGluZGV4Lgp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkucHVzaCh0aGF0Lm1lc3NhZ2UpOwp0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKCi8vIEZ1bmN0aW9uIHRvIHBhcnNlIGFyZ3VtZW50cyB3aXRoIHF1b3RlIHN1cHBvcnQgYW5kIGVycm9yIGhhbmRsaW5nCi8vIEV4YW1wbGVzOiAKLy8gICAnYXJnMSBhcmcyJyAtPiBbJ2FyZzEnLCAnYXJnMiddCi8vICAgJyJhcmcgd2l0aCBzcGFjZXMiIGFyZzInIC0+IFsnYXJnIHdpdGggc3BhY2VzJywgJ2FyZzInXQovLyAgICcidW5jbG9zZWQgcXVvdGUnIC0+IHRocm93cyBFcnJvcgpmdW5jdGlvbiBwYXJzZUFyZ3VtZW50cyhpbnB1dCkgewogICAgY29uc3QgYXJncyA9IFtdOwogICAgbGV0IGN1cnJlbnRBcmcgPSAnJzsKICAgIGxldCBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgbGV0IHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGNoYXIgPSBpbnB1dFtpXTsKICAgICAgICAKICAgICAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSBpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJ1xcJyAmJiBpICsgMSA8IGlucHV0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaSsrOyAvLyBTa2lwIHRoZSBiYWNrc2xhc2gKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gaW5wdXRbaV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gJyInIHx8IGNoYXIgPT09ICInIikgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gY2hhcjsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSBpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICcgJykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50QXJnID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuY2xvc2VkIHF1b3RlOiBmb3VuZCBvcGVuaW5nICR7aW5zaWRlUXVvdGVzfSBhdCBwb3NpdGlvbiAke3F1b3RlU3RhcnRQb3N9IGJ1dCBubyBjbG9zaW5nIHF1b3RlYCk7CiAgICB9CiAgICAKICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICB9CiAgICAKICAgIHJldHVybiBhcmdzOwp9CgppZiAodGhhdC5tZXNzYWdlWzBdID09ICIuIikgewogICAgY29uc3QgY29tbWFuZFBhcnQgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOyAvLyBSZW1vdmUgdGhlIGRvdAogICAgY29uc3Qgc3BhY2VJbmRleCA9IGNvbW1hbmRQYXJ0LmluZGV4T2YoJyAnKTsKCiAgICAvLyBDcmVhdGUgYSBmcmVzaCBDb21tYW5kc01hbmFnZXIgd2l0aCBlYWNoIGNhbGwgc28gdGhhdCB3ZSBhbHdheXMgaGF2ZSB0aGUgbGF0ZXN0IGNvbW1hbmRzIGFuZCBmdW5jdGlvbmFsaXR5LgogICAgY29uc3QgYWJDb21tYW5kcyA9IG5ldyBBQkNvbW1hbmRzTWFuYWdlcigpOwogICAgCiAgICAvLyBHZXQgY29tbWFuZCBuYW1lLgogICAgbGV0IGNtZDsKICAgIGlmIChzcGFjZUluZGV4ID09PSAtMSkgewogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0OwogICAgfSBlbHNlIHsKICAgICAgICBjbWQgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoMCwgc3BhY2VJbmRleCk7CiAgICB9CgogICAgLy8gR2V0IGNvbW1hbmQgYXJncy4KICAgIGlmIChhYkNvbW1hbmRzICYmIGFiQ29tbWFuZHMuaGFzQ29tbWFuZChjbWQpKSB7CiAgICAgICAgbGV0IGFyZ3M7CgogICAgICAgIGlmIChzcGFjZUluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAvLyBIYXMgYXJndW1lbnRzCiAgICAgICAgICAgIGNvbnN0IGFyZ3NTdHJpbmcgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoc3BhY2VJbmRleCArIDEpOwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSBwYXJzZUFyZ3VtZW50cyhhcmdzU3RyaW5nKTsKICAgICAgICAgICAgICAgIGFyZ3MgPSBwYXJzZWRBcmdzLmxlbmd0aCA/IHBhcnNlZEFyZ3MgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEVycm9yIHBhcnNpbmcgY29tbWFuZCBhcmd1bWVudHM6ICR7ZXJyb3IubWVzc2FnZX1gLCBsb2dUeXBlOiAnRXJyb3InIH0pOwogICAgICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxsIGNvbW1hbmQuCiAgICAgICAgYWJDb21tYW5kcy5jYWxsQ29tbWFuZChjbWQsIGFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBOb3QgYSBjb21tYW5kLCBldmFsdWF0ZSBtZXNzYWdlIGFzIGphdmFzY3JpcHQuCiAgICAgICAgY29uc3QganMgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOwogICAgICAgIG9zLnJ1bihqcyk7CiAgICB9Cn0KCnRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsnAIKGnBWDjgsLZGVzY3JpcHRpb24CBACChpwV2rILQlRoaXMgaXMgbWVhbnQgdG8gaGFuZGxlIGFueSBub25lIG1lbnUgcmVsYXRlZCBpbnB1dHMvaW50ZXJhY3Rpb25zLicAgoacFYOOCwxvbkZpbGVVcGxvYWQCBACChpwVnbMLqDVAaW1wb3J0IHsgUmVjb3JkRmlsZVJlc3VsdCB9IGZyb20gJ2Nhc3VhbG9zJzsKCi8vZmlsdGVyIG91dCB0aW1lcyB3aGVuIGZpbGUgbG9hZGluZyBpcyBub3QgYWxsb3dlZAppZiAoIWJ1aWxkZXJWZXJzaW9uIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJMaXN0ZW5pbmdGb3JGaWxlVXBsb2FkcyAhPT0gdHJ1ZSkgewogICAgcmV0dXJuOwp9CgovL3ZhcmlvdXMgZmlsZSBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykuc2hpZnQoKTsKbGV0IHNpemUgPSB0aGF0LmZpbGUuc2l6ZTsKbGV0IGNvcHlVcmwgPSB0aGF0LmNvcHlVcmwgPz8gdHJ1ZTsKbGV0IGZvY3VzQ2FtZXJhID0gdGhhdC5mb2N1c0NhbWVyYSA/PyB0cnVlOwpsZXQgbWltZVR5cGU7CmNvbnN0IGJvdEluZm8gPSB7fTsKCi8vaGFyZCBsaW1pdCBiYXNlZCBvbiBmaWxlIHNpemUKaWYgKHNpemUgPiAyMDAwMDAwMDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAibWF4aW11bSBmaWxlIHNpemUgZXhjZWVkZWQgKDIwMCBtYikiLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgcmV0dXJuOwp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIGltYWdlIGRpbWVuc2lvbnMgJiBhc3BlY3QgZnJvbSBBcnJheUJ1ZmZlciBkYXRhLgogKiBSZXF1aXJlcyBDYXN1YWxPUyBiZSBjb25maWd1cmVkIHRvIGhhdmUgYWNjZXNzIHRvIHRoZSBET00uCiAqLwpmdW5jdGlvbiBnZXRJbWFnZURpbWVuc2lvbnMoYXJyYXlCdWZmZXIsIG1pbWVUeXBlKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbYXJyYXlCdWZmZXJdLCB7IHR5cGU6IG1pbWVUeXBlIH0pOwogICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgY29uc3QgaW1nID0gbmV3IHNlbGYuSW1hZ2UoKTsKICAgICAgICBpbWcub25sb2FkID0gKCkgPT4gewogICAgICAgICAgICByZXNvbHZlKHsgd2lkdGg6IGltZy5uYXR1cmFsV2lkdGgsIGhlaWdodDogaW1nLm5hdHVyYWxIZWlnaHQsIGFzcGVjdDogaW1nLm5hdHVyYWxXaWR0aCAvIGltZy5uYXR1cmFsSGVpZ2h0IH0pOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfTsKICAgICAgICBpbWcub25lcnJvciA9IHJlamVjdDsKICAgICAgICBpbWcuc3JjID0gdXJsOwogICAgfSk7Cn0KCi8vdGhpcyBzd2l0Y2ggaGFuZGxlcyBwb3NzaWJsZSBmaWxlcyBleHRlbnNpb25zLCB3aGlsZSByZWplY3RpbmcgYW55IGl0IGRvZXMgbm90IHJlY29nbml6ZQpzd2l0Y2ggKGZpbGVFeHRlbnNpb24pIHsKICAgIGNhc2UgJ2pwZyc6CiAgICBjYXNlICdqcGVnJzoKICAgIGNhc2UgJ3dlYnAnOgogICAgY2FzZSAnZ2lmJzoKICAgIGNhc2UgJ3BuZyc6CiAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2UvIiArIGZpbGVFeHRlbnNpb247CiAgICAgICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICAgICAgYm90SW5mby5hbmNob3JQb2ludCA9ICfwn6esWzAsMCwtMC4wMV0nOwoKICAgICAgICBpZiAob3MuZGV2aWNlKCkuc3VwcG9ydHNET00pIHsKICAgICAgICAgICAgY29uc3QgaW1hZ2VEaW1lbnNpb25zID0gYXdhaXQgZ2V0SW1hZ2VEaW1lbnNpb25zKHRoYXQuZmlsZS5kYXRhLCBtaW1lVHlwZSk7CgogICAgICAgICAgICAvLyBBZGp1c3Qgc2NhbGUgdG8gcmVzcGVjdCBhc3BlY3QgcmF0aW8uIFRoaXMgaXMgImNvdmVyIiBzY2FsaW5nIHN0eWxlLgogICAgICAgICAgICBpZiAoaW1hZ2VEaW1lbnNpb25zLmFzcGVjdCA+PSAxKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWCA9IGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWSA9IDEgLyBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBicmVhazsKICAgIGNhc2UgJ3N2Zyc6CiAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICAgICAgYm90SW5mby5hbmNob3JQb2ludCA9ICfwn6esWzAsMCwtMC4wMV0nOwoKICAgICAgICBpZiAob3MuZGV2aWNlKCkuc3VwcG9ydHNET00pIHsKICAgICAgICAgICAgY29uc3QgaW1hZ2VEaW1lbnNpb25zID0gYXdhaXQgZ2V0SW1hZ2VEaW1lbnNpb25zKHRoYXQuZmlsZS5kYXRhLCBtaW1lVHlwZSk7CgogICAgICAgICAgICAvLyBBZGp1c3Qgc2NhbGUgdG8gcmVzcGVjdCBhc3BlY3QgcmF0aW8uIFRoaXMgaXMgImNvdmVyIiBzY2FsaW5nIHN0eWxlLgogICAgICAgICAgICBpZiAoaW1hZ2VEaW1lbnNpb25zLmFzcGVjdCA+PSAxKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWCA9IGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWSA9IDEgLyBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGJyZWFrOwogICAgY2FzZSAnZ2xiJzoKICAgIGNhc2UgJ2V4cic6CiAgICBjYXNlICdnbHRmJzoKICAgICAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICAgICAgYm90SW5mby5mb3JtID0gIm1lc2giOwogICAgICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAiZ2x0ZiI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdhdXgnOgogICAgY2FzZSAncGRmJzoKICAgICAgICBsZXQgYm90RGF0YSA9IGZpbGVFeHRlbnNpb24gPT0gIi5hdXgiID8gSlNPTi5wYXJzZSh0aGF0LmZpbGUuZGF0YSkuc3RhdGUgOiBvcy5wYXJzZUJvdHNGcm9tRGF0YSh0aGF0LmZpbGUuZGF0YSk7CiAgICAgICAgYXdhaXQgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdHM6IGJvdERhdGEsIG9yaWdpbjogZmlsZU5hbWUsIHNvdXJjZUV2ZW50OiAnZmlsZV91cGxvYWQnIH0pOwogICAgICAgIHJldHVybjsKICAgIGNhc2UgJ21wMyc6CiAgICAgICAgbWltZVR5cGUgPSAnYXVkaW8vbXBlZyc7CiAgICAgICAgYm90SW5mby5vbkNsaWNrID0gIkAgb3MucGxheVNvdW5kKHRhZ3MuZm9ybUFkZHJlc3MpOyI7CiAgICAgICAgYm90SW5mby5sYWJlbCA9ICJDbGljayB0byBQbGF5IjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ21wNCc6CiAgICAgICAgbWltZVR5cGUgPSAndmlkZW8vbXA0JzsKICAgICAgICBib3RJbmZvLmZvcm0gPSAiaWZyYW1lIjsKICAgICAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gInNyYyI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdvdGYnOgogICAgICAgIG1pbWVUeXBlID0gJ2ZvbnQvb3RmJzsKICAgICAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnd29mZic6CiAgICAgICAgbWltZVR5cGUgPSAnZm9udC93b2ZmJzsKICAgICAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYGZpbGUgdHlwZSBub3Qgc3VwcG9ydGVkYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICByZXR1cm4gbmV3IEVycm9yKCJ1bmhhbmRsZWQgZmlsZSB0eXBlOiAiICsgZmlsZUV4dGVuc2lvbik7Cn0KCi8vdGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYW5kIG9iamVjdHMgc2V0IHVwIGEgbG9hZGluZyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgppZiAoIWxpbmtzLm1lbnUpIHsKICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGB1cGxvYWRpbmdgIH0pOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBjb25maWdCb3QudGFncy5zdHVkaW9JRCA/PyBjb25maWdCb3QudGFncy5zdHVkaW87CgppZiAoIWNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKSB7CiAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYXV0aEJvdC5pZDsKfQoKLy90aGlzIGlzIHRoZSBhY3R1YWwgdXBsb2FkIGZ1bmN0aW9uYWxpdHkKbGV0IHVwbG9hZFJlc3VsdDogUmVjb3JkRmlsZVJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEZpbGUoeyBmaWxlOiB0aGF0LmZpbGUuZGF0YSwgZmlsZU5hbWU6IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUgfSk7CgppZiAodXBsb2FkUmVzdWx0KSB7CiAgICBpZiAodXBsb2FkUmVzdWx0LnN1Y2Nlc3MgfHwgdXBsb2FkUmVzdWx0LmVycm9yQ29kZSA9PT0gJ2ZpbGVfYWxyZWFkeV9leGlzdHMnKSB7CiAgICAgICAgY29uc3QgZmlsZVVSTCA9IHVwbG9hZFJlc3VsdC51cmwgPz8gdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICAgICAgLy9pZiB0aGUgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgYXMgYSBib3Qgd2l0aCBhIGxpbmssIHRoaXMgbG9naWMgaGFuZGxlcyB0aGF0CiAgICAgICAgaWYgKE9iamVjdC5rZXlzKGJvdEluZm8pLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb247CgogICAgICAgICAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGZhbGxiYWNrIHRvIHdoYXRldmVyIGlzIHRoZSB2aXNpYmxlIHBvcnRhbC4KICAgICAgICAgICAgICAgIGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICBkaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5tYXBQb3J0YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICBkaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGltZW5zaW9uKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbl0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHBvc2l0aW9uID0gZ2V0Qm90UG9zaXRpb24obGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCwgZGltZW5zaW9uKTsKICAgICAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbiArICdYJ10gPSBwb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uICsgJ1knXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb24gKyAnWiddID0gcG9zaXRpb24uejsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG1pbWVUeXBlLmluY2x1ZGVzKCJmb250IikpIHsKICAgICAgICAgICAgICAgIGJvdEluZm8ubGFiZWxGb250QWRkcmVzcyA9IGZpbGVVUkw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLmZvcm1BZGRyZXNzID0gZmlsZVVSTDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYm90SW5mby5hYkZpbGVVcGxvYWQgPSB0cnVlOwoKICAgICAgICAgICAgY29uc3QgYm90ID0gY3JlYXRlKGJvdEluZm8pOwoKICAgICAgICAgICAgaWYgKGZvY3VzQ2FtZXJhKSB7CiAgICAgICAgICAgICAgICBvcy5mb2N1c09uKGJvdCwgeyBkdXJhdGlvbjogMSB9KS5jYXRjaChlID0+IHt9KQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY29weVVybCkgewogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZmlsZVVSTCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYEZpbGUgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQuYCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYEZpbGUgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7ZmlsZVVSTH1gLCBsb2dUeXBlOiAnbG9nJyB9KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIHVwbG9hZCBmaWxlLiBSZWFzb246ICR7dXBsb2FkUmVzdWx0LmVycm9yTWVzc2FnZX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYEZhaWxlZCB0byB1cGxvYWQgZmlsZS4gUmVzdWx0OiAke0pTT04uc3RyaW5naWZ5KHVwbG9hZFJlc3VsdCl9YCwgbG9nVHlwZTogYGVycm9yYH0pOwogICAgfQp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aXRoIGZpbGUgdXBsb2FkLmAsIGxvZ1R5cGU6IGBlcnJvcmB9KTsKfQoKLy9jbGVhciB0aGUgcHJvZ3Jlc3MgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CgppZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gdXBsb2FkUmVzdWx0OycAgoacFYOOCwVsZWFybgIEAIKGnBXC6Aso8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAgoacFYOOCwhyZW1lbWJlcgIEAIKGnBXp6Aso8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAgoacFYOOCw1tYW5pZmVzdGF0aW9uAgQAgoacFZDpCyjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCChpwVg44LCGFiSWdub3JlAgQAgoacFbfpCwR0cnVlJwCChpwVg44LBmNyZWF0ZQIEAIKGnBW86Qso8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAgoacFYOOCwVzdG9yZQIEAIKGnBXj6Qso8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicAgoacFYOOCwRtZW51AgQAgoacFYrqCyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCChpwVg44LB2FiU2hlbGwCBACChpwVseoLBHRydWUnAIKGnBWDjgsJb25UYXBDb2RlAgQAgoacFbbqC6kCQGNvbnN0IHRhcENvZGUgPSB0aGF0OwoKc3dpdGNoICh0YXBDb2RlKQp7CiAgICBjYXNlICIzMzQyIjoKICAgICAgICBvcy50b2FzdCgid2FraW5nICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5KTsKCiAgICAgICAgdGhpc0JvdC5vbkNoYXQoe21lc3NhZ2U6ICIuLiJ9KTsKICAgICAgICBicmVhazsKICAgIGNhc2UgIjQyNDIiOgogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICAvL2NvbnNvbGUubG9nKHRhcENvZGUpOwp9JwCChpwVg44LA2FzawIEAIKGnBXg7Aso8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycAgoacFYOOCwlhYlZlcnNpb24CBACChpwVh+0LBTEwLjQzJwCChpwVg44LCm9uQm90QWRkZWQCBACChpwVje0LQEB0aGlzQm90LmxvYWRBQkNvbW1hbmRzTWFuYWdlcigpOwp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkgPSBbXTsnAIKGnBWDjgsab25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQCBACChpwVzu0LmWtAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCi8vIFRoZXNlIGFyZSBhbGwgdGhlIGJ1aWx0LWluIGNvbW1hbmRzLgoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdoZWxwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGNvbW1hbmRzID0gYWJDb21tYW5kcy5jb21tYW5kczsKICAgIGNvbnN0IGNvbW1hbmRLZXlzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpOwoKICAgIGxldCBzZWxlY3RlZENvbW1hbmQ7CiAgICBpZiAoY29tbWFuZEtleXMgJiYgY29tbWFuZEtleXMubGVuZ3RoICYmIGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb21tYW5kS2V5TWF0Y2ggPSBjb21tYW5kS2V5cy5maW5kKGtleSA9PiBrZXkgPT09IGFyZ3NbMF0pOwogICAgICAgIHNlbGVjdGVkQ29tbWFuZCA9IGNvbW1hbmRLZXlNYXRjaDsKICAgIH0KICAgIAogICAgbGlua3MuaGVscC5tb3VudCh7IGFiQ29tbWFuZHNNYW5hZ2VyOiBhYkNvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IHRoaXMgaGVscCB3aW5kb3cuIENhbiBzcGVjaWZ5IGEgY29tbWFuZCB0byBvcGVuIHRoZSBoZWxwIHBhZ2UgZm9yIHRoYXQgY29tbWFuZCBkaXJlY3RseS4nLAogICAgdXNhZ2U6IFsnLmhlbHAnLCAnLmhlbHAgW2NvbW1hbmRdJ10KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJy4nLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcuLicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3dha2UnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcud2FrZScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NsZWVwJywgYXJncyA9PiB0aGlzQm90LmNtZEFCU2xlZXAoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdXQgYWIgdG8gc2xlZXAuJywKICAgIHVzYWdlOiAnLnNsZWVwJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYWNjb3VudCcsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBlbmRwb2ludCA9IGF3YWl0IG9zLmdldFJlY29yZHNFbmRwb2ludCgpOwogICAgb3Mub3BlblVSTChlbmRwb2ludCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBhY2NvdW50L3JlY29yZHMgcGFnZSBpbiBhIG5ldyB0YWIuJywKICAgIHVzYWdlOiAnLmFjY291bnQnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhc2snLCAoYXJncykgPT4gewogICAgaWYgKGxpbmtzLmFzaykgewogICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBhc2tJbnB1dCA9IGFyZ3Muam9pbignICcpOwogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLmFzayBjb21tYW5kIHJlcXVpcmVzIGlucHV0YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhc2sgYm90IGlzIG5vdCBsb2FkZWQsIGNhbm5vdCBsb2FkIGFza2ApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQXNrIGFiJywKICAgIHVzYWdlOiAnLmFzayA8YXNrX25hbWU+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbmFtZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSwgeyB0aXRsZTogJ3doYXQgd291bGQgeW91IGxpa2UgdG8gY2FsbCBtZT8nIH0pOwogICAgc2hvdXQoJ2FiUGVyc29uYWxpdHlDaGFuZ2UnLCB7IGFiQnVpbGRlcklkZW50aXR5OiBuYW1lIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2l2ZSBhYiBhIG5ldyBuYW1lLicsCiAgICB1c2FnZTogJy5uYW1lYWInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGRhdGVhYicsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBsaW5rcy5sZWFybi51cGRhdGVBQigpOzsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwZGF0ZSBBQiBjb3JlIGFuZCBza2lsbHMgdG8gY3VycmVudCBjb2RlLicsCiAgICB1c2FnZTogJy51cGRhdGVhYicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3N5c3RlbScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTeXN0ZW0oYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaW5zdC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGkgICAgCgogICAgWW91IG1heSBwcm92aWRlIGEgY3VzdG9tIHN5c3RlbVRhZ05hbWUgd2l0aCB0aGUgY29tbWFuZCwgaW4gb3JkZXIgdG8gb3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBvbmx5IGZvciBib3RzIHdpdGggdGhlIGdpdmVuIHN5c3RlbVRhZ05hbWUuIEJ5IGRlZmF1bHQsICJzeXN0ZW0iIHdpbGwgYmUgdXNlZCBhcyB0aGUgc3lzdGVtVGFnTmFtZS4KCiAgICBGb3IgZXhhbXBsZToKCiAgICA+IC5zeXN0ZW0KICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgInN5c3RlbSIgdGFnLgoKICAgID4gLnN5c3RlbSBteUdyb3VwCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJteUdyb3VwIiB0YWcuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnN5c3RlbScsCiAgICAgICAgJy5zeXN0ZW0gc3lzdGVtVGFnTmFtZScKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXcnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LiBCeSBkZWZhdWx0IHRoZSBzeXN0ZW0gcG9ydGFsIHdpbGwgb3BlbiBpbiBhIG5ldyB0YWIuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZycsIChhcmdzKSA9PiB7CiAgICBsaW5rcy5jb25zb2xlLnRvZ2dsZUNvbnNvbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1RvZ2dsZSB2aXNpYmxpdHkgb2YgdGhlIGFiIGxvZy4nLAogICAgdXNhZ2U6ICcubG9nJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2djbGVhcicsIChhcmdzKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlTG9nQm90cyA9IGdldEJvdHMoImNvbnNvbGVMb2dNZXNzYWdlQm90IiwgdHJ1ZSk7CiAgICBkZXN0cm95KG1lc3NhZ2VMb2dCb3RzKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0NsZWFyIGFsbCBhYiBsb2cgbWVzc2FnZXMuJywKICAgIHVzYWdlOiAnLmxvZ2NsZWFyJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzaGVldCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTaGVldChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3Igc3BlY2lmaWVkIGJvdCBvciBhbiBlbnRpcmUgZGltZW5zaW9uLicsCiAgICB1c2FnZTogWwogICAgICAgICcuc2hlZXQgW29wdGlvbnNdIFtwb3J0YWwgfCBoZWxwZXJCb3ROYW1lIHwgYm90SWQgfCBnbG9iYWxUaGlzUGF0aF0nLAogICAgICAgICdleC4gLnNoZWV0IGhvbWUnLAogICAgICAgICdleC4gLnNoZWV0IGNvbmZpZ0JvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgLXQgYTJjZjQ3MzktMzlhMi00ZmQ2LWIzZWYtY2M0NzgyZjk3MDg5JywKICAgICAgICAnZXguIC5zaGVldCBnbG9iYWxUaGlzLm15T2JqZWN0Lm15Qm90JywKICAgICAgICAnZXguIC5zaGVldCBteU9iamVjdC5teUJvdCcKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBpbiBhIG5ldyBicm93c2VyIHRhYi4gXG5cbk5PVEU6IC5zaGVldCB3aWxsIGF1dG9tYXRpY2FsbHkgaW5zcGVjdCB0aGUgc3BhY2Ugb2YgYSBib3QgYW5kIGZvcmNlIG9wZW5pbmcgaW4gdGhlIHNhbWUgdGFiIGlmIGEgYm90IGlzIGluIHRlbXBMb2NhbCBvciB0ZW1wU2hhcmVkIHNwYWNlLicsCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbWVudXNoZWV0JywgKGFyZ3MpID0+IHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKICAgIGlmICghY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2Fubm90IG9wZW4gc2hlZXRQb3J0YWwgZm9yIG1lbnVQb3J0YWwgYm90cy4gVGhlIG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IGRpc2FibGVkLmB9KQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciB0aGUgY3VycmVudCBtZW51IHBvcnRhbC4nLAogICAgdXNhZ2U6ICcubWVudVNoZWV0JywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkaW5zdCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEluc3QoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCB0aGUgaW5zdCB0byBkaXNrLicsCiAgICB1c2FnZTogJy5kb3dubG9hZGluc3QnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZHN5c3RlbScsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZFN5c3RlbShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIHRoZSBzcGVjaWZpZWQgYm90IHN5c3RlbShzKSB0byBkaXNrLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCB0aGUgc3BlY2lmaWVkIGJvdCBzeXN0ZW0ocykgdG8gZGlzay4KICAgIAogICAgVGhlIHByb3ZpZGVkIHN5c3RlbU5hbWUocykgaWxsIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBib3RzIHdob3NlIHN5c3RlbSB0YWcgc3RhcnRzIHdpdGggc3lzdGVtTmFtZShzKS4gSXQgd2lsbCByZXNwZWN0IHRoZSBkb3Qgbm90YXRpb24gb2YgdGhlIHN5c3RlbSB0YWcsIHNvIHBhcnRpYWwgbWF0Y2hlcyB3aWxsIG5vdCB3b3JrLiBTZWUgdGhlIGV4YW1wbGVzIGJlbG93IGZvciBhIGJldHRlciB1bmRlcnN0YW5kaW5nLgoKICAgIEZvciBleGFtcGxlIGlmIHN5c3RlbU5hbWUgaXMgImhlbGxvIjoKCiAgICBTeXN0ZW0gVGFnIC0+IERvd25sb2FkPwogICAgLSBoZWxsbyAtPiB5ZXMKICAgIC0gaGVsbG8ud29ybGQubWFpbiAtPiB5ZXMKICAgIC0gaGVsbG8ud29ybGQuZmlyZXdvcmtzIC0+IHllcwogICAgLSByYy5yZWRCb3QgLT4gbm8KICAgIC0gaGVsbG9Xb3JsZC5ib3QgLT4gbm8KICAgIC0gaGVsaXVtLmF0b20gLT4gbm8KICAgIC0gaGV4LmdyaWQuaGVsbG8gLT4gbm8KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRzeXN0ZW0gWy4uLnN5c3RlbU5hbWVdJwogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRhYicsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEFCKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIHNwZWNpZmllZCBhYiBncm91cChzKSB0byBkaXNrLgoKICAgIFlvdSBjYW4gcHJvdmlkZSBhIGxpc3Qgb2YgZ3JvdXBzIHRvIGRvd25sb2FkIGFsb25nIHdpdGggdGhlIGNvbW1hbmQ6CiAgICA+IC5kb3dubG9hZGFiIGFiQ29yZSBhYlNoZWxsIGFiSW50ZXJmYWNlCgogICAgSWYgZ3JvdXAocykgYXJlIG5vdCBwcm92aWRlZCB3aXRoIHRoZSBjb21hbWFuZCB0aGVuIHlvdSB3aWxsIGJlIHByb21wdGVkIHRvIHByb3ZpZGUgb25lIHdpdGggYSBkaWFsb2cuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRvd25sb2FkYWIgW29wdGlvbnNdIFtncm91cC4uLl0nLAogICAgICAgICdleC4gLmRvd25sb2FkYWIgYWJTaGVsbCBhYkludGVyZmFjZScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiAtdiAxIG15R3JvdXBOYW1lJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnU3BlY2lmeSB0aGUgYXV4IGZvcm1hdCB2ZXJzaW9uIG51bWJlci4gZXguIC12IDEgd2lsbCBiZSBhdXggZm9ybWF0IHZlcnNpb24gMSAocHVyZSBib3QganNvbikuIEJ5IGRlZmF1bHQsIGFiIGZpbGVzIGFyZSB1c3VhbGx5IGRvd25sb2FkZWQgYXMgdmVyc2lvbiAyIGF1eCBmaWxlcyAoY29uZmxpY3QtZnJlZSB1cGRhdGUpLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGVnZycsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEVnZyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4gWW91IHdpbGwgbmVlZCB0byBwcm92aWRlIHRoZSByZWNvcmRLZXkgYXMgd2VsbCBhbmQgdGhlIG5hbWUgb2YgdGhlIGVnZy4gQSBkcm9wZG93biBzZWxlY3Rpb24gd2lsbCBiZSBwcm92aWRlZCBmb3IgdGhlIGVnZyBpZiBmb3VuZCB0byBzZWxlY3Qgd2hpY2ggdmVyc2lvbiB0byBkb3dubG9hZC5gLAogICAgdXNhZ2U6ICcuZG93bmxvYWRlZ2cnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9hZHNraWxsJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm9yIChsZXQgc2tpbGwgb2YgYXJncykgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJy5sb2Fkc2tpbGwgcmVxdWlyZXMgc29tZSBza2lsbCBuYW1lcycpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTG9hZCB0aGUgc3BlY2lmaWVkIGFiIHNraWxscy4nLAogICAgdXNhZ2U6ICcubG9hZFNraWxsIFtza2lsbCAuLi5dJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXJscXInLCAoKSA9PiBvcy5zaG93UVJDb2RlKGNvbmZpZ0JvdC50YWdzLnVybCksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IGEgUVIgY29kZSBmb3IgdGhlIGJyb3dlciB0YWJcJ3MgY3VycmVudCBVUkwuJywKICAgIHVzYWdlOiAnLnVybHFyJwp9KTsKCmNvbnN0IERJTV9TVVBQT1JURURfUE9SVEFMUyA9IFsnZ3JpZCcsICdtYXAnLCAnbWluaUdyaWQnLCAnbWluaU1hcCcsICdzaGVldCcsICdzeXN0ZW0nLCAnbWVudScsICd0YWcnXTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZGltJywgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgbGV0IHBvcnRhbCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1wJyk7CiAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGFyZ3Muam9pbignICcpOwoKICAgICAgICBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSAnZ3JpZCc7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGltZW5zaW9uID09PSAibnVsbCIgfHwgZGltZW5zaW9uID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBkaW1lbnNpb24gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKERJTV9TVVBQT1JURURfUE9SVEFMUy5pbmRleE9mKHBvcnRhbCkgPj0gMCkgewogICAgICAgICAgICBjb25maWdCb3QudGFnc1tgJHtwb3J0YWx9UG9ydGFsYF0gPSBkaW1lbnNpb247CgogICAgICAgICAgICBpZiAoZGltZW5zaW9uID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2xvc2VkICR7cG9ydGFsfVBvcnRhbC5gIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBTZXQgJHtwb3J0YWx9UG9ydGFsIHRvICcke2RpbWVuc2lvbn0nIGRpbWVuc2lvbi5gIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGAke3BvcnRhbH0gaXMgbm90IGEgc3VwcG9ydGVkIHBvcnRhbCBmb3IgdGhlIGRpbSBjb21tYW5kLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSkKICAgICAgICB9CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHbyB0byBzcGVjaWZpZWQgcG9ydGFsIGRpbWVuc2lvbi4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgR28gdG8gc3BlY2lmaWVkIHByb3RhbCBkaW1lbnNpb24uCiAgICAKICAgIElmIGEgcG9ydGFsIGFyZ3VtZW50IGlzIG5vdCBwcm92aWRlZCB0aGVuIGl0IHdpbGwgZGVmYXVsdCB0byB0aGUgZ3JpZFBvcnRhbC4KICAgIAogICAgSWYgYSBkaW1lbnNpb24gaXMgbm90IHByb3ZpZGVkIG9yIGlzICJudWxsIiB0aGVuIHRoZSBwb3J0YWwgd2lsbCBiZSBzZXQgdG8gbnVsbCBhbmQgYmUgY2xvc2VkLmAsCiAgICB1c2FnZTogWwogICAgICAgICcuZGltIDxkaW1lbnNpb24+JywKICAgICAgICAnLmRpbSAtcCA8cG9ydGFsPiA8ZGltZW5zaW9uPicKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXAnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogYFNwZWNpZnkgdGhlIHBvcnRhbCBuYW1lLiBDYW4gYmUgYW55b25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7RElNX1NVUFBPUlRFRF9QT1JUQUxTLmpvaW4oJywgJyl9YAogICAgICAgIH0KICAgIF0KCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1dWlkJywgKCkgPT4gewogICAgb3Muc2V0Q2xpcGJvYXJkKHV1aWQoKSk7CgogICAgbGV0IG1lc3NhZ2UgPSBgQ29waWVkIG5ldyB1dWlkIHRvIGNsaXBib2FyZGA7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYSB1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllciAodXVpZCkgYW5kIGNvcHkgaXQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcudXVpZCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2R1cCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBib3RJZCA9IGFyZ3MgPyBhcmdzWzBdIDogdW5kZWZpbmVkOwogICAgaWYgKGJvdElkKSB7CiAgICAgICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgICAgICBpZiAoYm90KSB7CiAgICAgICAgICAgIGNvbnN0IGR1cEJvdCA9IGNyZWF0ZShib3QpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZHVwQm90LmlkKTsKICAgICAgICAgICAgb3MudG9hc3QoJ0R1cGxpY2F0ZSBib3QgaWQgY29waWVkIHRvIGNsaXBib2FyZC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcy50b2FzdChgTm8gYm90IGZvdW5kIHdpdGggaWQgJHtib3RJZH1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCdQcm92aWRlIHRoZSBpZCBvZiB0aGUgYm90IHlvdSB3YW50IHRvIGR1cGxpY2F0ZScpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGEgc3BlY2lmaWVkIGJvdCBhbmQgY29weSB0aGUgbmV3IGJvdFwncyBpZCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy5kdXAgPGJvdElkPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGF1eCcsIChhcmdzKSA9PiB7CiAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIEFVWCBmaWxlKHMpIHRvIHRoZSBjdXJyZW50IGluc3QuJywKICAgIHVzYWdlOiAnLnVwbG9hZGF1eCcKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkZmlsZXMnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBsb2FkRmlsZXMoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgZmlsZShzKSBkaXJlY3RseSB0byByZWNvcmQuJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGxvYWRmaWxlcycsCiAgICAgICAgJy51cGxvYWRmaWxlcyAtcmVjb3JkIDxyZWNvcmRfaWQ+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcmVjb3JkJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcHRpb25hbGx5IHB1Ymxpc2ggZmlsZShzKSB0byBhIHNwZWNpZmljIHJlY29yZC4gSWYgb21pdHRlZCwgZmlsZShzKSB3aWxsIGJlIHB1Ymxpc2hlZCB0byB0aGUgdXNlclwncyBwZXJzb25hbCByZWNvcmQuJwogICAgICAgIH0KICAgIF0KfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgncHVibGlzaGFzaycsIGFyZ3MgPT4gdGhpc0JvdC5jbWRQdWJsaXNoQXNrKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnUHVibGlzaCBhbiBhc2sgdG8gdGhlIHB1YmxpYyBhYiByZWNvcmQuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYFB1Ymxpc2ggYW4gYXNrIHRvIHRoZSBwdWJsaWMgYWIgcmVjb3JkLgoKICAgIEFuIGFiIGFzayBpcyBhIGxpdHRsZSBwb2ludGVyIHRvIGEgcGF0dGVybiBpbnNpZGUgb2YgYSBzcGVjaWZpYyBzdHVkaW8uIFRoZSBhc2sgY2FuIGJlIHVzZWQgdG8gbG9hZCB0aGUgZ2l2ZW4gcGF0dGVybiB1c2luZyBhIHNpbXBsZSBuYW1lLCBsaWtlIGEgc2hvcnRjdXQgb3IgYW4gYWxpYXMuCgogICAgVGhlIGFzayBpdHNlbGYgaXMgc3RvcmVkIGluIHRoZSBwdWJsaWMgYWIgcmVjb3JkIHNvIHRoYXQgYW55b25lIGNhbiByZWFkIHRoZSBwb2ludGVyIGZpbGUsIGJ1dCB0aGUgcGVybWlzc2lvbnMgZm9yIHRoZSBwYXR0ZXJuIGluc2lkZSB0aGUgc3R1ZGlvIGFyZSBzdGlsbCBtYW5hZ2VkIGJ5IHRoZSBvcmlnaW5hbCBhdXRob3IuCgogICAgQW55IHVwZGF0ZXMgdG8gYW4gZXhpc3RpbmcgYXNrIHdpbGwgYmUgb3ZlcndyaXR0ZW4uCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnB1Ymxpc2hhc2sgLWFzayA8YXNrSUQ+IC1wYXR0ZXJuIDxwYXR0ZXJuSUQ+IC1zdHVkaW8gPHN0dWRpb0lEPicsCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1hc2snLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBhc2sgdG8gYmUgc2V0LicsCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcGF0dGVybicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHBhdHRlcm4gc2V0IHRoZSBhc2sgdG8gcG9pbnQgYXQuJywKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1zdHVkaW8nLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBzdHVkaW8gdG8gc2V0IHRoZSBhc2sgdG8gcG9pbnQgYXQuIFRoaXMgaXMgdGVjaG5pY2FsbHkgb3B0aW9uYWwsIGlmIG5vdCBwcm92aWRlZCB0aGVuIHRoZSBzdHVkaW8gSUQgb2YgdGhlIGN1cnJlbnRseSBsb2dnZWQgaW4gdXNlciB3aWxsIGJlIHVzZWQuJywKICAgICAgICB9CiAgICBdCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3ZpZXdyZWNvcmRkYXRhJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmICghbGlua3Mudmlld1JlY29yZERhdGFBcHApIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYlZpZXdSZWNvcmQnKTsKICAgIH0KCiAgICBjb25zdCBpc0FsaWFzID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctYScpCgogICAgbGV0IHJlY29yZE5hbWU7CgogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgcmVjb3JkTmFtZSA9IGFyZ3Muam9pbignICcpOwogICAgfQoKICAgIGlmIChpc0FsaWFzKSB7CiAgICAgICAgc3dpdGNoKHJlY29yZE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAncGxheWVyJzoKICAgICAgICAgICAgICAgIGlmIChhdXRoQm90KSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTmFtZSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC52aWV3cmVjb3JkZGF0YSBtdXN0IGJlIGxvZ2dlZCBpbiB0byB2aWV3IHBsYXllciByZWNvcmQuYCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2FiJzoKICAgICAgICAgICAgICAgIHJlY29yZE5hbWUgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLnZpZXdyZWNvcmRkYXRhIGNvbW1hbmQgZG9lcyBub3QgcmVjb2duaXplIGFsaWFzICR7cmVjb3JkTmFtZX1gKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICghcmVjb3JkTmFtZSAmJiBhdXRoQm90KSB7CiAgICAgICAgICAgIHJlY29yZE5hbWUgPSBhdXRoQm90LmlkOwogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKHJlY29yZE5hbWUpIHsKICAgICAgICBsaW5rcy52aWV3UmVjb3JkRGF0YUFwcC5tb3VudCh7IHJlY29yZE5hbWUgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC52aWV3cmVjb3JkZGF0YSBjb21tYW5kIHJlcXVpcmVzIGEgcmVjb3JkTmFtZWApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVmlldyBkYXRhIHN0b3JlZCBpbiBwcm92aWRlZCByZWNvcmQgbmFtZS4gSWYgcmVjb3JkIG5hbWUgaXMgbm90IHByb3ZpZGVkIHRoZW4gaXQgd2lsbCBkZWZhdWx0IHRvIHlvdXIgcGVyc29uYWwgcmVjb3JkLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBWaWV3IGRhdGEgc3RvcmVkIGluIHByb3ZpZGVkIHJlY29yZCBuYW1lLiBJZiByZWNvcmQgbmFtZSBpcyBub3QgcHJvdmlkZWQgdGhlbiBpdCB3aWxsIGRlZmF1bHQgdG8geW91ciBwZXJzb25hbCByZWNvcmQuCgogICAgVGhlcmUgYXJlIHNvbWUgYWxpYXNlcyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggdGhlIGFsaWFzIGFyZ3VtZW50IHRvIGxvYWQgYSByZWNvcmQgdmlhIGFsaWFzOgogICAgLSBwbGF5ZXI6IHlvdXIgcGVyc29uYWwgcmVjb3JkCiAgICAtIGFiOiBhYidzIHB1YmxpYyByZWNvcmQKICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcudmlld3JlY29yZGRhdGEnLAogICAgICAgICcudmlld3JlY29yZGRhdGEgW3JlY29yZE5hbWVdJywKICAgICAgICAnLXZpZXdyZWNvcmRkYXRhIC1hIGFiJyAgCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1hJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgcHJvdmlkZWQgcmVjb3JkTmFtZSBpcyBhY3R1YWxseSBhbiBhbGlhcy4nCiAgICAgICAgfQogICAgXQp9KScAgoacFYOOCwhhcnRpZmFjdAIEAIKGnBXo2Awo8J+Ulzc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNycAgoacFYOOCxVsb2FkQUJDb21tYW5kc01hbmFnZXICBACChpwVj9kM+i1ALyoqCiAqIEFCQ29tbWFuZHNNYW5hZ2VyIGlzIHBhcnQgb2YgYWJTaGVsbC4KICogWW91IGNhbiByZWdpc3RlciBjb21tYW5kcyB0byBpdCB0aGF0IGNhbiBiZSBpbnZva2VkIHVzaW5nICckPGNvbW1hbmQ+JyB3aXRoIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICogSXRzIGdlbmVyYWxseSBub3QgcmVjb21tZW5kZWQgdG8gY3JlYXRlIHRoaXMgeW91cnNlbGYgYnV0IGluc3RlYWQgdG8gbGlzdGVuIGZvciB0aGUgQG9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkIHNob3V0CiAqIGFuZCB0byByZWdpc3RlciB5b3VyIGNvbW1hbmRzIHRoZXJlLgogKiBAcHJvcCB7c3RyaW5nW119IGNvbW1hbmRzCiAqLwpjbGFzcyBBQkNvbW1hbmRzTWFuYWdlciB7CiAgICBjb21tYW5kczogUmVjb3JkPHN0cmluZywgQUJDb21tYW5kPjsKCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLmNvbW1hbmRzID0ge307CgogICAgICAgIC8vIFNob3V0IHRoYXQgYW4gaW5zdGFuY2Ugb2YgQUJDb21tYW5kc01hbmFnZXIgaGFzIGJlZW4gY3JlYXRlZCBhbmQgYWxsb3cgYW55IGxpc3RlbmVycwogICAgICAgIC8vIHRvIGFkZCB0aGVpciBvd24gY29tbWFuZHMgdG8gdGhlIGluc3RhbmNlLgogICAgICAgIHNob3V0KCdvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCcsIHRoaXMpOwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgY29tbWFuZCB0byBBQkNvbW1hbmRzTWFuYWdlci4KICAgICAqIFRoaXMgY29tbWFuZCB3aWxsIGJlIGF2YWlsYWJsZSB0byBpbnZva2UgdXNpbmcgJyQ8bmFtZT4nIG9uIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBzdWNjZXNzZnVsbHkgYWRkZWQuCiAgICAgKi8KICAgIGFkZENvbW1hbmQobmFtZTogc3RyaW5nLCBjYWxsYmFjazogQUJDb21tYW5kQ2FsbGJhY2ssIGhlbHA6IEFCQ29tbWFuZEhlbHApOiBib29sZWFuIHsKICAgICAgICBpZiAoIW5hbWUgfHwgdHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gc3RyaW5nIG5hbWUgaXMgcmVxdWlyZWQgZm9yIGNvbW1hbmRzLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgYWxyZWFkeSBleGlzdHMgYXMgYSBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWNhbGxiYWNrIHx8IHR5cGVvZiBjYWxsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBhIGNhbGxiYWNrIGZ1bmN0aW9uLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHApIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIGlzIG1pc3Npbmcgc2hvcnREZXNjcmlwdGlvbiBmcm9tIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbW1hbmRzW25hbWVdID0geyBuYW1lLCBjYWxsYmFjaywgaGVscCB9OwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGhhc0NvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29tbWFuZHNbbmFtZV0gIT0gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSBhIGNvbW1hbmQgZnJvbSBBQkNvbW1hbmRzTWFuYWdlcgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdhcyByZW1vdmVkLiBJZiB0aGUgY29tbWFuZCBkb2Vzbid0IGV4aXN0IGZhbHNlIHdpbGwgYWxzbyBiZSByZXR1cm5lZC4KICAgICAqLwogICAgcmVtb3ZlQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENhbGwgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdpdGggdGhlIHByb3ZpZGVkIGFyZ3MgKGlmIGFueSkuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgZXhlY3V0ZWQuCiAgICAgKi8KICAgIGNhbGxDb21tYW5kKG5hbWU6IHN0cmluZywgYXJncz86IGFueVtdKTogYm9vbGVhbiB7CiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgaWYgKGNvbW1hbmQpIHsKICAgICAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaGVscEFyZyBvZiBjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShoZWxwQXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaCguLi5oZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBc3NlcnQgdGhhdCB0aGUgaW5wdXQgYXJncyBhcmUgdmFsaWQgYWdhaW5zdCB0aGUgY29tbWFuZCBoZWxwIGRvY3VtZW50YXRpb24uCiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGVhc3kgd2F5IHRvIHZhbGlkYXRlIGFyZ3MgYmVmb3JlIGV4ZWN1dGluZyBhIGNvbW1hbmQuCiAgICAgICAgICAgICAgICBBQkNvbW1hbmRzTWFuYWdlci5hc3NlcnRWYWxpZEFyZ3MoYXJncywgdmFsaWRBcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21tYW5kLmNhbGxiYWNrKGFyZ3MpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgbm90IGEgdmFsaWQgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBwcm92aWRlZCBhcmcuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgYW5kIHZhbHVlIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ1ZhbHVlKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGFueSB7CiAgICAgICAgbGV0IHZhbHVlID0gbnVsbDsKCiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgbGV0IGRlbGV0ZUNvdW50ID0gMTsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlSW5kZXggPSBhcmdJbmRleCArIDE7CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlSW5kZXggPCBhcmdzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhcmdzW3ZhbHVlSW5kZXhdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSByZWxhdGVkIGFyZ3MgJiB2YWx1ZXMKICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCBkZWxldGVDb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB3ZXRoZXIgdGhlIGFyZyBmbGFnIGlzIHByb3ZpZGVkIGluIHRoZSBhcmdzLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ0ZsYWcoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFyZyBmbGFnLgogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIDEpOwoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICBzdGF0aWMgYXNzZXJ0VmFsaWRBcmdzKGFyZ3M6IGFueVtdLCB2YWxpZEFyZ3M6IGFueVtdKTogdm9pZCB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgaW52YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGFyZyBvZiBhcmdzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJnICYmIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcmcgd2Ugd2FudCB0byBldmFsdWF0ZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZEFyZ3MgfHwgIXZhbGlkQXJncy5pbmNsdWRlcyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGFyZyBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHZhbGlkQXJncywgdGh1cyB0aGUgYXJnIGlzIGludmFsaWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQXJncy5wdXNoKGFyZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgdGhpcyBhcmcgaXQgaXMgbW9zdGx5IGxpa2VseSBhIHZhbHVlIGFyZy4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpbnZhbGlkQXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgSW52YWxpZCBhcmd1bWVudHM6ICR7aW52YWxpZEFyZ3Muam9pbignLCAnKX1gOwoKICAgICAgICAgICAgICAgIG9zLnRvYXN0KGVycm9yTWVzc2FnZSwgNCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKZ2xvYmFsVGhpcy5BQkNvbW1hbmRzTWFuYWdlciA9IEFCQ29tbWFuZHNNYW5hZ2VyOycAgoacFYOOCwRoZWxwAgQAgoacFYqHDSjwn5SXMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjJwCChpwVg44LCGNtZFNoZWV0AgQAgoacFbGHDc0UQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IHBvcnRhbDsKbGV0IG5ld1RhYiA9IGZhbHNlOwoKaWYgKGFyZ3MpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV07CiAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJy10JykgewogICAgICAgICAgICAgICAgbmV3VGFiID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSBhcmc7CiAgICAgICAgfQogICAgfQp9CgppZiAoIXBvcnRhbCkgewogICAgcG9ydGFsID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9Cgpjb25zdCBoZWxwZXJCb3RzID0gewogICAgJ2NvbmZpZ0JvdCc6IGNvbmZpZ0JvdCwKICAgICdncmlkUG9ydGFsQm90JzogZ3JpZFBvcnRhbEJvdCwKICAgICdzaGVldFBvcnRhbEJvdCc6IHNoZWV0UG9ydGFsQm90LAogICAgJ3N5c3RlbVBvcnRhbEJvdCc6IHN5c3RlbVBvcnRhbEJvdCwKICAgICdtaW5pR3JpZFBvcnRhbEJvdCc6IG1pbmlHcmlkUG9ydGFsQm90LAogICAgJ21hcFBvcnRhbEJvdCc6IG1hcFBvcnRhbEJvdCwKICAgICdtaW5pTWFwUG9ydGFsQm90JzogbWluaU1hcFBvcnRhbEJvdCwKICAgICdtZW51UG9ydGFsQm90JzogbWVudVBvcnRhbEJvdCwKICAgICdsZWZ0V3Jpc3RQb3J0YWxCb3QnOiBsZWZ0V3Jpc3RQb3J0YWxCb3QsCiAgICAncmlnaHRXcmlzdFBvcnRhbEJvdCc6IHJpZ2h0V3Jpc3RQb3J0YWxCb3QsCiAgICAnbWVldFBvcnRhbEJvdCc6IG1lZXRQb3J0YWxCb3QsCiAgICAndGFnUG9ydGFsQm90JzogdGFnUG9ydGFsQm90LAogICAgJ2ltdVBvcnRhbEJvdCc6IGltdVBvcnRhbEJvdCwKfTsKCi8vIEZ1bmN0aW9uIHRvIHJlc29sdmUgYSBwb3J0YWwgcmVmZXJlbmNlIHRvIGEgc3BlY2lmaWMgYm90CmZ1bmN0aW9uIHJlc29sdmVQb3J0YWxUb0JvdChwYXRoKSB7CiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJycpIHJldHVybiBudWxsOwogICAgCiAgICAvLyBGaXJzdCBjaGVjayBpZiBpdCdzIGRpcmVjdGx5IGluIGhlbHBlckJvdHMKICAgIGlmIChoZWxwZXJCb3RzW3BhdGhdKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlckJvdHNbcGF0aF07CiAgICB9CgogICAgLy8gUGVyaGFwcyB0aGUgcGF0aCBpcyBhIGJvdCBpZC4KICAgIGxldCBib3RGcm9tSWRTZWFyY2ggPSBnZXRCb3QoJ2lkJywgcGF0aCk7CiAgICBpZiAoYm90RnJvbUlkU2VhcmNoKSB7CiAgICAgICAgcmV0dXJuIGJvdEZyb21JZFNlYXJjaDsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgZm9yIGJvdGggZGlyZWN0IGFuZCBuZXN0ZWQgcGF0aHMgaW4gZ2xvYmFsVGhpcwogICAgbGV0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIGxldCBjdXJyZW50T2JqID0gZ2xvYmFsVGhpczsKICAgIGxldCBzdGFydEluZGV4ID0gMDsKICAgIAogICAgLy8gSGFuZGxlIGlmIHRoZSBwYXRoIGV4cGxpY2l0bHkgc3RhcnRzIHdpdGggJ2dsb2JhbFRoaXMnCiAgICBpZiAocGF0aFBhcnRzWzBdID09PSAnZ2xvYmFsVGhpcycpIHsKICAgICAgICBzdGFydEluZGV4ID0gMTsgLy8gU2tpcCB0aGUgJ2dsb2JhbFRoaXMnIHBhcnQgc2luY2Ugd2UncmUgYWxyZWFkeSBzdGFydGluZyB0aGVyZQogICAgfQogICAgCiAgICAvLyBUcmF2ZXJzZSB0aGUgcGF0aAogICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBwYXRoUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwYXJ0ID0gcGF0aFBhcnRzW2ldOwogICAgICAgIGlmICghY3VycmVudE9ialtwYXJ0XSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gUGF0aCBzZWdtZW50IGRvZXNuJ3QgZXhpc3QKICAgICAgICB9CiAgICAgICAgY3VycmVudE9iaiA9IGN1cnJlbnRPYmpbcGFydF07CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGlmIHRoZSBmaW5hbCBvYmplY3QgaXMgYSBib3QgKGhhcyBpZCBhbmQgdGFncykKICAgIGlmIChjdXJyZW50T2JqICYmIGN1cnJlbnRPYmouaWQgJiYgY3VycmVudE9iai50YWdzKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRPYmo7CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOyAvLyBOb3QgYSB2YWxpZCBib3QKfQoKLy8gU2VhcmNoIHRvIHNlZSBpZiBwb3J0YWwgYXJndW1lbnQgaXMgc3BlY2lmaWMgdG8gYSBib3QKbGV0IHVuaXF1ZUJvdCA9IHJlc29sdmVQb3J0YWxUb0JvdChwb3J0YWwpOwoKaWYgKHVuaXF1ZUJvdCkgewogICAgaWYgKHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcExvY2FsJyB8fAogICAgICAgIHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcFNoYXJlZCcKICAgICkgewogICAgICAgIC8vIEZvcmNlIHNoZWV0IHRvIG9wZW4gaW4gc2FtZSB0YWIgaWYgdGhlIGJvdCBvbmx5IGxpdmVzIGluIHRoaXMgdGFiLgogICAgICAgIG5ld1RhYiA9IGZhbHNlOwogICAgfQogICAgcG9ydGFsID0gdW5pcXVlQm90LmlkOwp9CgppZiAobmV3VGFiKSB7CiAgICBvcy5vcGVuVVJMKGAvP2luc3Q9JHtvcy5nZXRDdXJyZW50SW5zdCgpfSZzaGVldFBvcnRhbD0ke3BvcnRhbH1gKTsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gcG9ydGFsOwp9JwCChpwVg44LDWNtZERvd25sb2FkQUICBACChpwV/5sNowtAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgYXV4VmVyc2lvbjogc3RyaW5nID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXYnKTsKCmlmICghYXV4VmVyc2lvbikgewogICAgLy8gRGVmYXVsdCB0byBhdXggdmVyc2lvbiAyIGlmIGFyZ3VtZW50IGlzIG5vdCBwcm92aWRlZC4KICAgIGF1eFZlcnNpb24gPSAnMic7Cn0KCmlmIChhdXhWZXJzaW9uICE9PSAnMScgJiYgYXV4VmVyc2lvbiAhPT0gJzInKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBPbmx5IGF1eCBmb3JtYXQgdmVyc2lvbiAxIGFuZCAyIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGRvd25sb2FkIGFiIGNvbW1hbmQuYCk7CiAgICByZXR1cm47Cn0KCi8vIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiBmYWxzZSB9KTsKCmxldCBncm91cHMgPSBbXTsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgLy8gUmVtYWluaW5nIGFyZ3MgYXJlIGdyb3VwIG5hbWVzIHByb3ZpZGVkIHdpdGggdGhlIGNvbW1hbmQuCiAgICBncm91cHMgPSBhcmdzOwp9IGVsc2UgewogICAgbGV0IGdyb3VwID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCwgeyB0aXRsZTogJ0FCIEdyb3VwIFRhZycsIGF1dG9TZWxlY3Q6IHRydWUgfSk7CiAgICBpZiAoZ3JvdXApIHsKICAgICAgICBtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAgPSBncm91cDsKICAgICAgICBncm91cHMucHVzaChncm91cCk7CiAgICB9Cn0KCmNvbnN0IG1ham9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWFqb3JWZXJzaW9uOwpjb25zdCBtaW5vclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1pbm9yVmVyc2lvbjsKY29uc3QgYWJWZXJzaW9uID0gYCR7bWFqb3JWZXJzaW9ufS4ke21pbm9yVmVyc2lvbn1gOwoKZm9yIChsZXQgZ3JvdXAgb2YgZ3JvdXBzKSB7CiAgICBjb25zdCBncm91cEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgW2dyb3VwXTogdHJ1ZSwgc3BhY2U6ICdzaGFyZWQnIH0pKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwQm90cy5sZW5ndGg7IGkrKykgewogICAgICAgIGdyb3VwQm90c1tpXS50YWdzLmFiVmVyc2lvbiA9IGFiVmVyc2lvbjsKICAgIH0KCiAgICBpZiAoZ3JvdXAgPT0gImFiQ29uZmlnIikgewogICAgICAgIGdyb3VwID0gImFiMSI7CiAgICB9CgogICAgaWYgKGF1eFZlcnNpb24gPT09ICcxJykgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMQogICAgICAgIG9zLmRvd25sb2FkQm90cyhncm91cEJvdHMsIGdyb3VwKQogICAgfSBlbHNlIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDIKICAgICAgICBvcy5kb3dubG9hZEJvdHNBc0luaXRpYWx6YXRpb25VcGRhdGUoZ3JvdXBCb3RzLCBncm91cCk7CiAgICB9Cgp9CgonAIKGnBWDjgsJY21kQUJXYWtlAgQAgoacFaOnDTFAbGlua3MubWFuaWZlc3RhdGlvbi5hYlNldEF3YWtlKHsgYXdha2U6IHRydWUgfSk7JwCChpwVg44LCmNtZEFCU2xlZXACBACChpwV1acN0AFAbGlua3MubWFuaWZlc3RhdGlvbi5hYlNldEF3YWtlKHsgYXdha2U6IGZhbHNlIH0pOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbFNwYWNlID0gbnVsbDsKCnRhZ1BvcnRhbEJvdC5tYXNrcy50YWdQb3J0YWxBbmNob3JQb2ludCA9IG51bGw7JwCChpwVg44LB2NvbnNvbGUCBACChpwVpqkNKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAIKGnBWDjgsOY21kVXBsb2FkRmlsZXMCBACChpwVzakNkxBAY29uc3QgYXJncyA9IHRoYXQ7Cgphc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlKHsgZmlsZSwgcmVjb3JkS2V5IH0pIHsKICAgIGxldCBmaWxlRXh0ZW5zaW9uID0gZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCk7CiAgICBsZXQgZmlsZU5hbWUgPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwogICAgbGV0IG1pbWVUeXBlOwoKICAgIHN3aXRjaCAoZmlsZUV4dGVuc2lvbikgewogICAgICAgIGNhc2UgJ3N2Zyc6CiAgICAgICAgICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdnbGInOgogICAgICAgIGNhc2UgJ2dsdGYnOgogICAgICAgICAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIG1pbWVUeXBlID0gZmlsZS5taW1lVHlwZTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgbGV0IHVybDsKICAgICAgICAKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gcmVjb3JkS2V5OwogICAgY29uc3QgW3Jlc3VsdF0gPSBhd2FpdCBQcm9taXNlLmFsbChzaG91dCgnYWJQdWJsaXNoRmlsZScsIHsgZmlsZSwgZmlsZU5hbWUsIG1pbWVUeXBlIH0pKTsKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gbnVsbDsKICAgIAogICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQudXJsOwogICAgfSBlbHNlIGlmIChyZXN1bHQuZXhpc3RpbmdGaWxlVXJsKSB7CiAgICAgICAgdXJsID0gcmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKICAgIH0KCiAgICByZXR1cm4geyB1cmwgfTsKfQoKY29uc3QgcmVjb3JkS2V5ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXJlY29yZCcpOwpjb25zdCBzZWxlY3RlZEZpbGVzID0gYXdhaXQgb3Muc2hvd1VwbG9hZEZpbGVzKCk7CmNvbnN0IHB1Ymxpc2hSZWNvcmQgPSBnZXRCb3QoJ3N5c3RlbScsICdyYy1wYWNrYWdlLWRldi5wdWJsaXNoUmVjb3JkJyk7CgppZiAoc2VsZWN0ZWRGaWxlcyAmJiBzZWxlY3RlZEZpbGVzLmxlbmd0aCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVwbG9hZCAke3NlbGVjdGVkRmlsZXMubGVuZ3RofSBmaWxlcy4uLmApOwogICAgfQoKICAgIGxldCBkb25lSHRtbCA9ICcnOwoKICAgIGlmIChyZWNvcmRLZXkpIHsKICAgICAgICBkb25lSHRtbCArPSBgPGgyPlJlY29yZCBJZDwvaDI+YDsKICAgICAgICBkb25lSHRtbCArPSBgPHA+JHtyZWNvcmRLZXl9PC9wPmA7CiAgICB9CgogICAgZG9uZUh0bWwgKz0gJzxoMj5VcGxvYWRlZCBGaWxlczwvaDI+JzsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEZpbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb3Muc2hvd0h0bWwoYFVwbG9hZGluZyAke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX0uLi5gKTsKICAgICAgICAKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1cGxvYWRGaWxlKHsKICAgICAgICAgICAgZmlsZTogc2VsZWN0ZWRGaWxlc1tpXSwKICAgICAgICAgICAgcmVjb3JkS2V5LAogICAgICAgICAgICBvblByb2dyZXNzOiAoZmlsZVByb2dyZXNzKSA9PiB7CiAgICAgICAgICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSAke01hdGguY2VpbChmaWxlUHJvZ3Jlc3MgKiAxMDApfSVgKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGlmIChyZXN1bHQudXJsKSB7CiAgICAgICAgICAgIGRvbmVIdG1sICs9IGA8YSBocmVmPSIke3Jlc3VsdC51cmx9IiB0YXJnZXQ9Il9ibGFuayI+JHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9PC9hPjwvYnI+YDsKICAgICAgICB9CgogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSByZXN1bHQ6YCwgcmVzdWx0KTsKICAgIH0KCiAgICBvcy5zaG93SHRtbChkb25lSHRtbCk7Cn0nAIKGnBWDjgsOY21kRG93bmxvYWRFZ2cCBACChpwV4bkN+QtAY29uc3QgcmVjb3JkS2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZEb3dubG9hZEVnZ1JlY29yZEtleSwgewogICAgdGl0bGU6ICdyZWNvcmQgdG8gbG9va3VwIGVnZyBpbicsCiAgICB0eXBlOiAndGV4dCcsCn0pCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb3JkS2V5OmAsIHJlY29yZEtleSk7CgppZiAoIXJlY29yZEtleSkgewogICAgcmV0dXJuOwp9CgptYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXkgPSByZWNvcmRLZXk7Cgpjb25zdCBlZ2dOYW1lID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUsIHsKICAgIHRpdGxlOiAnbmFtZSBvZiBlZ2cnLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVnZ05hbWU6YCwgZWdnTmFtZSk7CgppZiAoIWVnZ05hbWUpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnTmFtZSA9IGVnZ05hbWU7Cgpjb25zdCBlZ2cgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgYWJJRDogZWdnTmFtZSwKICAgIHJlY29yZEtleSwKICAgIHJldHVyblR5cGU6ICdlZ2cnCn0pCgpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVnZzpgLCBlZ2cpOwoKaWYgKCFBcnJheS5pc0FycmF5KGVnZy5lZ2dWZXJzaW9uSGlzdG9yeSkgfHwgZWdnLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgRGF0YSBmb3VuZCBhdCBhZGRyZXNzICcke2VnZ05hbWV9JyBpbiByZWNvcmQgJyR7cmVjb3JkS2V5fScgZG9lcyBub3QgYXBwZWFyIHRvIGJlIGFuIGVnZy5gKQogICAgcmV0dXJuIG51bGw7Cn0KCmNvbnN0IGVnZ1ZlcnNpb25PcHRpb25zID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5Lm1hcCgoaXRlbSwgaW5kZXgpID0+IHsKICAgIHJldHVybiB7IGxhYmVsOiBgdmVyc2lvbiAke2luZGV4ICsgMX1gLCB2YWx1ZTogaW5kZXggfQp9KQoKY29uc3Qgc2VsZWN0ZWRWZXJzaW9uT3B0aW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KGVnZ1ZlcnNpb25PcHRpb25zLmxlbmd0aCAtIDEsIHsKICAgIHRpdGxlOiAnZG93bmxvYWQgZWdnIHZlcnNpb24nLAogICAgdHlwZTogJ2xpc3QnLAogICAgc3VidHlwZTogJ3NlbGVjdCcsCiAgICBpdGVtczogZWdnVmVyc2lvbk9wdGlvbnMsCn0pCgppZiAoIXNlbGVjdGVkVmVyc2lvbk9wdGlvbikgewogICAgcmV0dXJuIG51bGw7Cn0KCmNvbnN0IGF1eERhdGFVcmwgPSBlZ2cuZWdnVmVyc2lvbkhpc3Rvcnlbc2VsZWN0ZWRWZXJzaW9uT3B0aW9uLnZhbHVlXTsKY29uc3QgYXV4RGF0YSA9IGF3YWl0IG9zLmdldEZpbGUoYXV4RGF0YVVybCk7CmNvbnN0IGF1eEZpbGVuYW1lID0gYCR7ZWdnTmFtZX1fdiR7c2VsZWN0ZWRWZXJzaW9uT3B0aW9uLnZhbHVlICsgMX0uYXV4YDsKCm9zLmRvd25sb2FkKGF1eERhdGEsIGF1eEZpbGVuYW1lLCAnYXBwbGljYXRpb24vanNvbicpOycAgoacFYOOCw9jbWREb3dubG9hZEluc3QCBACChpwV28UNWUBhYi5saW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgcmVvcGVuQWJNZW51OiBmYWxzZSwgc291cmNlRXZlbnQ6ICdhYl9jbWRfZG93bmxvYWRfaW5zdCcgfSk7JwCChpwVg44LBnNlYXJjaAIEAIKGnBW1xg0o8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAgoacFYOOCwV1dGlscwIEAIKGnBXcxg0o8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAgoacFYOOCwljbWRTeXN0ZW0CBACChpwVg8cNkQdAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBzYW1lV2luZG93ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctdycpOwoKbGV0IHN5c3RlbVRhZ05hbWUgPSBudWxsOwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICBzeXN0ZW1UYWdOYW1lID0gYXJncy5qb2luKCcgJyk7Cn0KCmlmIChzYW1lV2luZG93KSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LgogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsID0gdHJ1ZTsKICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVRhZ05hbWUgPSBzeXN0ZW1UYWdOYW1lOwp9IGVsc2UgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIGEgbmV3IHRhYi4KICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKTsKCiAgICAvLyBSZW1vdmUgYW55IHBvcnRhbHMgdGhhdCBhcmUgc2V0IGluIHRoZSBVUkwuCiAgICBsZXQgcGFyYW1zID0gdXJsLnNlYXJjaFBhcmFtcy5rZXlzKCk7CiAgICBmb3IgKGxldCBwYXJhbSBvZiBwYXJhbXMpIHsKICAgICAgICBpZiAocGFyYW0uZW5kc1dpdGgoJ1BvcnRhbCcpKSB7CiAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKHBhcmFtKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gVHVybiBvbiB0aGUgc3lzdGVtIHBvcnRhbC4KICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1Qb3J0YWwnLCAndHJ1ZScpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3N5c3RlbVRhZ05hbWUnKTsKCiAgICBpZiAoc3lzdGVtVGFnTmFtZSkgewogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1UYWdOYW1lJywgc3lzdGVtVGFnTmFtZSk7CiAgICB9CgogICAgb3Mub3BlblVSTCh1cmwuaHJlZik7Cn0KJwCChpwVg44LDWFiQ2hhdEJhck9wZW4CBACChpwVlc4NwANAaWYgKGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBbGxvd0NoYXRCYXIgPT09IGZhbHNlKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IHsKICAgIHByZWZpbGwsCn0gPSB0aGF0ID8/IHt9CgptYXNrcy5jaGF0T3BlbiA9IHRydWU7Cgpvcy5zaG93Q2hhdCh7CiAgICBwbGFjZWhvbGRlcjogJz4gLmhlbHAgdG8gc2VlIGF2YWlsYWJsZSBjb21tYW5kcycsCiAgICBiYWNrZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlTWVudUNvbG9yLAogICAgZm9yZWdyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZU1lbnVMYWJlbENvbG9yLAogICAgcGxhY2Vob2xkZXJDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VNZW51TGFiZWxDb2xvciwKICAgIHByZWZpbGwKfSkKCnNob3V0KCdvbkFCQ2hhdEJhck9wZW4nLCB7IHByZWZpbGwgfSk7JwCChpwVg44LDmFiQ2hhdEJhckNsb3NlAgQAgoacFdbRDZIBQG1hc2tzLmNoYXRPcGVuID0gZmFsc2U7Cm9zLmhpZGVDaGF0KCk7CgpzaG91dCgnb25BQkNoYXRCYXJDbG9zZScpOwoKLy8gR2l2ZSBDYXN1YWxPUyBhIGNoYW5nZSB0byBhY3R1YWxseSByZW1vdmUgdGhlIGNoYXQgYmFyLgphd2FpdCBvcy5zbGVlcCgwKTsnAIKGnBWDjgsLcGVyc29uYWxpdHkCBACChpwV6dINKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAIKGnBWDjgsFdHlwZXMCBACChpwVkNMN8gLwn5OEdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9JwCChpwVg44LEXZpZXdSZWNvcmREYXRhQXBwAgQAgoacFYHWDSjwn5SXOTJmZjZkMjgtMzM1MS00Y2ZiLTg0NjQtOWQ3YzYxNDI3YTI2JwCChpwVg44LEWNtZERvd25sb2FkU3lzdGVtAgQAgoacFajWDd4GQGNvbnN0IGFyZ3MgPSB0aGF0OwoKaWYgKCFhcmdzIHx8IGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogJ011c3QgcHJvdmlkZSBzeXN0ZW0gbmFtZShzKSB0byBkb3dubG9hZC4nLCBsb2dUeXBlOiAnZXJyb3InIH0pCiAgICByZXR1cm47Cn0KCmNvbnN0IHN5c3RlbU5hbWVzID0gYXJnczsKCmZvciAoY29uc3Qgc3lzdGVtTmFtZSBvZiBzeXN0ZW1OYW1lcykgewogICAgY29uc3Qgc3lzdGVtTmFtZVBhcnRzID0gc3lzdGVtTmFtZS5zcGxpdCgnLicpOwoKICAgIGNvbnN0IHN5c3RlbUJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICAgICAgaWYgKGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLnN5c3RlbSkgewogICAgICAgICAgICBjb25zdCBzeXN0ZW1UYWdQYXJ0cyA9IGIudGFncy5zeXN0ZW0uc3BsaXQoJy4nKTsKICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBzeXN0ZW1OYW1lUGFydHMuZXZlcnkoKHN5c3RlbU5hbWVQYXJ0LCBpbmRleCkgPT4gc3lzdGVtVGFnUGFydHNbaW5kZXhdID09PSBzeXN0ZW1OYW1lUGFydCk7CiAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICB9CiAgICB9KTsKCiAgICBpZiAoc3lzdGVtQm90cyAmJiBzeXN0ZW1Cb3RzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gYCR7c3lzdGVtTmFtZX0uYXV4YDsKICAgICAgICBhYi5saW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgcG9zc2libGVCb3RzOiBzeXN0ZW1Cb3RzLCBmaWxlbmFtZSwgcmVvcGVuQWJNZW51OiBmYWxzZSwgc291cmNlRXZlbnQ6ICdhYl9jbWRfZG93bmxvYWRfc3lzdGVtJyB9KTsKICAgIH0KfScAgoacFYOOCw1jbWRQdWJsaXNoQXNrAgQAgoacFYfdDaEPQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3QgYXNrSUQgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctYXNrJyk7CmNvbnN0IHBhdHRlcm5JRCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1wYXR0ZXJuJyk7CmxldCBzdHVkaW9JRCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1zdHVkaW8nKTsKCmlmICghYXNrSUQpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgLWFzayBpcyBhIHJlcXVpcmVkIGFyZ3VtZW50YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgppZiAoIXBhdHRlcm5JRCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGAtcGF0dGVybiBpcyBhIHJlcXVpcmVkIGFyZ3VtZW50YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgppZiAoIXN0dWRpb0lEKSB7CiAgICBpZiAoYXV0aEJvdCkgewogICAgICAgIHN0dWRpb0lEID0gYXV0aEJvdC5pZDsKICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBFaXRoZXIgcHJvdmlkZSBhIHN0dWRpbyBvciBsb2dpbiB0byB1c2UgeW91ciBwZXJzb25hbCBzdHVkaW8gZm9yIHRoZSBhc2suYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKbGV0IHB1Ymxpc2hSZXN1bHQ7Cgp0cnkgewogICAgcHVibGlzaFJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEFza0lEKHsgYXNrSUQsIHBhdHRlcm5JRCwgc3R1ZGlvSUQgfSk7Cn0gY2F0Y2ggKGUpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIHB1Ymxpc2ggYXNrICcke2Fza0lEfScuICR7bGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIHJldHVybjsKfQoKaWYgKHB1Ymxpc2hSZXN1bHQuc3VjY2VzcykgewogICAgLy8gTmVlZCB0byB1c2UgY29uZmlnQm90IHN0dWRpbyB0YWcgZm9yIGxvb2t1cC4KICAgIGNvbmZpZ0JvdC5tYXNrcy5zdHVkaW8gPSBzdHVkaW9JRDsKICAgIGF3YWl0IG9zLnNsZWVwKDApOwogICAgCiAgICB0cnkgewogICAgICAgIGNvbnN0IGxvb2t1cEFza1Jlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5sb29rdXBGcm9tU3R1ZGlvKHsgYXNrSUQsIGRhdGFPbmx5OiB0cnVlIH0pOwoKICAgICAgICBpZiAobG9va3VwQXNrUmVzdWx0LnN1Y2Nlc3MgJiYgbG9va3VwQXNrUmVzdWx0LmRhdGEpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBQdWJsaXNoZWQgYXNrICcke2Fza0lEfScuICR7SlNPTi5zdHJpbmdpZnkobG9va3VwQXNrUmVzdWx0LmRhdGEsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2xvZyd9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEZhaWxlZCB0byBsb29rdXAgYXNrICcke2Fza0lEfScgaW4gc3R1ZGlvICcke3N0dWRpb0lEfScuYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEZhaWxlZCB0byBsb29rdXAgYXNrICcke2Fza0lEfScgaW4gc3R1ZGlvICcke3N0dWRpb0lEfScuICR7bGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIH0KCiAgICBjb25maWdCb3QubWFza3Muc3R1ZGlvID0gbnVsbDsKfSBlbHNlIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIHB1Ymxpc2ggYXNrICcke2Fza0lEfScuYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgoKAA=="}]}