{"version":2,"updates":[{"id":0,"timestamp":1770676117174,"update":"Ab0E/+GZtQIAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwD/4Zm1AgAGc3lzdGVtAgQA/+GZtQIBDWFiLnNoZWxsLmdyaWQnAP/hmbUCAARmb3JtAgQA/+GZtQIPB25vdGhpbmcnAP/hmbUCAAxvbkFueUJvdERyYWcCBAD/4Zm1Ahe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAP/hmbUCAAhyZW1lbWJlcgIEAP/hmbUC0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA/+GZtQIACGFiSWdub3JlAgQA/+GZtQL6AQR0cnVlJwD/4Zm1AgAHYWJTaGVsbAIEAP/hmbUC/wEEdHJ1ZScA/+GZtQIACWFiVmVyc2lvbgIEAP/hmbUChAIFMTAuMzcnAP/hmbUCAAVmb2N1cwIEAP/hmbUCigKrBEAvL3Nob3V0KCJmb2N1cyIsIHtib3Q6IGJvdCwgcG9zaXRpb246e3g6IHgsIHk6IHl9fSk7Cgpjb25zdCBmb2N1c1R5cGUgPSB0aGF0LmJvdCA/ICJib3QiIDogInBvc2l0aW9uIjsKY29uc3QgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uOwpjb25zdCB6b29tID0gdGhhdC56b29tID8/IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IDIwMDAgOiAxMDsKY29uc3Qgcm90YXRpb24gPSB0aGF0LnJvdGF0aW9uID8/IHt4OiA0NSwgeTogNDV9Owpjb25zdCBlYXNpbmcgPSB0aGF0LmVhc2luZyA/PyB7dHlwZTogImxpbmVhciIsIG1vZGU6ICJpbm91dCJ9Owpjb25zdCBmb2N1c09wdGlvbnMgPSB7CiAgICB6b29tOiB6b29tLAogICAgcm90YXRpb246IHJvdGF0aW9uLAogICAgZWFzaW5nOiBlYXNpbmcsCiAgICBkdXJhdGlvbjogZHVyYXRpb24KfTsKCmlmIChmb2N1c1R5cGUgPT0gImJvdCIpCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5ib3QsIGZvY3VzT3B0aW9ucykKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScA/+GZtQK2BgZzeXN0ZW0CBAD/4Zm1ArcGE2FiLnNoZWxsLmNvbXBvbmVudHMnAP/hmbUCtgYMQXBwQ29udGFpbmVyAgQA/+GZtQLLBsUEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfSAvPgogICAgICAgICAgICA8ZGl2PntjaGlsZHJlbn08L2Rpdj4KICAgICAgICA8Lz4KICAgICkKfQoKcmV0dXJuIEFwcENvbnRhaW5lcjsnAP/hmbUCtgYIVGV4dExpbmsCBAD/4Zm1ApELowNAY29uc3QgVGV4dExpbmsgPSAoewogICAgb25DbGljaywKICAgIGNoaWxkcmVuLAp9KSA9PiB7CiAgICByZXR1cm4gKAogICAgICAgIDxzcGFuIAogICAgICAgICAgICBjbGFzc05hbWU9J2FiLWFwcC10ZXh0LWxpbmsgYm9sZCcgCiAgICAgICAgICAgIG9uQ2xpY2s9e29uQ2xpY2t9CiAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAnLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yJzogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstaG92ZXItY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmx1ZXByaW50Q29sb3IKICAgICAgICAgICAgfX0KICAgICAgICA+e2NoaWxkcmVufTwvc3Bhbj4KICAgICkKfQoKcmV0dXJuIFRleHRMaW5rOycA/+GZtQK2BgZXaW5kb3cCBAD/4Zm1ArUOtgJAY29uc3QgV2luZG93ID0gKHsKICAgIGlkLAogICAgZGlzYWJsZVNoYWRvdywKICAgIGNoaWxkcmVuLAp9KSA9PiB7CgogICAgbGV0IHdpbmRvd0NsYXNzTmFtZSA9ICdhYi1hcHAtd2luZG93JzsKCiAgICBpZiAoZGlzYWJsZVNoYWRvdykgewogICAgICAgIHdpbmRvd0NsYXNzTmFtZSArPSAnIG5vLXNoYWRvdyc7CiAgICB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2IGlkPXtpZH0gY2xhc3NOYW1lPXt3aW5kb3dDbGFzc05hbWV9PgogICAgICAgICAgICB7Y2hpbGRyZW59CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBXaW5kb3c7JwD/4Zm1ArYGDFRleHRMaW5rLmNzcwIEAP/hmbUC7BDtAS5hYi1hcHAtdGV4dC1saW5rIHsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1jb2xvciwgcmdiKDcxIDI1NSAxMzcpKTsKfQoKLmFiLWFwcC10ZXh0LWxpbms6aG92ZXIgewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvciwgcmdiKDAgMTkyIDI1NSkpOwp9CgouYWItYXBwLXRleHQtbGluay5ib2xkIHsKICBmb250LXdlaWdodDogYm9sZDsKfScA/+GZtQK2BhVCYWNrZ3JvdW5kT3ZlcmxheS5jc3MCBAD/4Zm1AtoScS5hYi1hcHAtYmcgewogICAgcG9zaXRpb246IGZpeGVkOwogICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjMzKTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwp9JwD/4Zm1ArYGCldpbmRvdy5jc3MCBAD/4Zm1AswTqAMuYWItYXBwLXdpbmRvdyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgY29sb3I6IHdoaXRlOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzJmMmYyZjsKICAgIHdpZHRoOiA4MHZ3OwogICAgaGVpZ2h0OiA3MHZoOwogICAgbWF4LXdpZHRoOiAxNTAwcHg7CiAgICBtYXgtaGVpZ2h0OiAxMDAwcHg7CiAgICBsZWZ0OiA1MCU7CiAgICB0b3A6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMHB4IDBweCAxMnB4IDBweCBibGFjazsKICAgIG92ZXJmbG93OiBhdXRvOwogICAgcGFkZGluZy1sZWZ0OiA4cHg7CiAgICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCi5hYi1hcHAtd2luZG93Lm5vLXNoYWRvdyB7CiAgICBib3gtc2hhZG93OiBub25lOwp9JwD/4Zm1ArYGCHJlbWVtYmVyAgQA/+GZtQL1Fijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwD/4Zm1ArYGCGFiSWdub3JlAgQA/+GZtQKcFwR0cnVlJwD/4Zm1ArYGB2FiU2hlbGwCBAD/4Zm1AqEXBHRydWUnAP/hmbUCtgYJYWJWZXJzaW9uAgQA/+GZtQKmFwUxMC4zNycA/+GZtQK2BgtwZXJzb25hbGl0eQIEAP/hmbUCrBco8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicBBGJvdHMkMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViAScA/+GZtQLTFwdBcHAuY3NzAgQA/+GZtQLUF8oWOnJvb3QgewogIC0tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICAtLW9uLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgLS1hYi1jb25zb2xlLWhlaWdodDogMzN2aDsKfQovKiBEYXJrIG1vZGUgc3VwcG9ydCAqLwpAbWVkaWEgKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKSB7CiAgOnJvb3QgewogICAgLS1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogICAgLS1vbi1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIH0KfQoKLmFiLWNvbnNvbGUtYnRuIHsKICBjdXJzb3I6IHBvaW50ZXI7CiAgY29sb3I6IGluaGVyaXQ7CiAgbGV0dGVyLXNwYWNpbmc6IGluaGVyaXQ7CiAgbGluZS1oZWlnaHQ6IGluaGVyaXQ7CiAgdGV4dC10cmFuc2Zvcm06IGluaGVyaXQ7CiAgdGV4dC1pbmRlbnQ6IGluaGVyaXQ7CiAgdGV4dC1zaGFkb3c6IGluaGVyaXQ7CiAgYmFja2dyb3VuZC1jb2xvcjogaW5oZXJpdDsKICBtYXJnaW46IGluaGVyaXQ7CiAgcGFkZGluZy1ibG9jazogaW5oZXJpdDsKICBwYWRkaW5nLWlubGluZTogaW5oZXJpdDsKICBib3JkZXI6IG5vbmU7CiAgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOwp9CgouYWItY29uc29sZSB7CiAgd2lkdGg6IDEwMHZ3OwogIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgcGFkZGluZzogMDsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpIGJyaWdodG5lc3MoMjAwJSk7CiAgYW5pbWF0aW9uLW5hbWU6IHNsaWRlLWFwcC1pbjsKICBhbmltYXRpb24tZHVyYXRpb246IDAuNXM7CiAgb3ZlcmZsb3cteTogaGlkZGVuOwogIHotaW5kZXg6IDE7Cn0KCi5hYi1jb25zb2xlOjphZnRlciB7CiAgY29udGVudDogIiI7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgcG9zaXRpb246IGFic29sdXRlOwogIHRvcDogMDsKICBsZWZ0OiAwOwogIHJpZ2h0OiAwOwogIGJvdHRvbTogMDsKICBvcGFjaXR5OiAwLjk7CiAgei1pbmRleDogMDsKfQoKQGtleWZyYW1lcyBzbGlkZS1hcHAtaW4gewogIGZyb20gewogICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogY3ViaWMtYmV6aWVyKC42LDAsLjc5LDEuMDMpOwogICAgLyogdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDExMCUpOyAqLwogICAgLyogaGVpZ2h0OiAwcHg7ICovCiAgICAvKiBtaW4taGVpZ2h0OiAwcHg7ICovCiAgICBtYXgtaGVpZ2h0OiAwcHg7CiAgfQoKICB0byB7CiAgICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgICAvKiBtaW4taGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7ICovCiAgfQp9CgouYWItY29uc29sZSA+IGRpdiB7CiAgei1pbmRleDogMTsKICBwb3NpdGlvbjogcmVsYXRpdmUKfQoKLmFiLWNvbnNvbGUtdG9wLWJhciB7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgd2lkdGg6IDEwMCU7CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIHVzZXItc2VsZWN0OiBub25lOwogIGRpc3BsYXk6IGZsZXg7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBqdXN0aWZ5LWNvbnRlbnQ6IGVuZDsKICBwYWRkaW5nOiAwLjVyZW07Cn0KCi5hYi1jb25zb2xlLWxvZyB7CiAgb3ZlcmZsb3cteTogYXV0bzsKICBmbGV4LWdyb3c6IDE7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uLXJldmVyc2U7CiAgbWluLWhlaWdodDogMjRweDsKICBwYWRkaW5nOiAwIDFyZW07CiAgY3Vyc29yOiBwb2ludGVyOwogIG92ZXJzY3JvbGwtYmVoYXZpb3I6IGNvbnRhaW47Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIGN1cnNvcjogaW5pdGlhbDsKfQoKLmFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIgewogIG1hcmdpbjogMC41cmVtIDA7Cn0KLmFiLWNvbnNvbGUtbWVzc2FnZSB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgZ2FwOiA4cHg7Cn0KCi5hYi1jb25zb2xlLXNwYWNlciB7CiAgZmxleC1zaHJpbms6IDA7CiAgZmxleC1ncm93OiAxOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBtYXgtd2lkdGg6IDgwdnc7CiAgYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScA/+GZtQLTFwZnZXRBcHACBAD/4Zm1Ap8u3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwD/4Zm1AtMXC2hpZGVDb25zb2xlAgQA/+GZtQL9UZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwD/4Zm1AtMXA2xvZwIEAP/hmbUCnVOFCUBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGF3YWl0IGNyZWF0ZShib3RUYWdzKTsKCnNob3V0KCJvbkFCTG9nIiwgbG9nQm90KTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwD/4Zm1AtMXC3Nob3dDb25zb2xlAgQA/+GZtQKjXO0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicA/+GZtQLTFwZzeXN0ZW0CBAD/4Zm1ApFgEGFiLnNoZWxsLmNvbnNvbGUnAP/hmbUC0xcNdG9nZ2xlQ29uc29sZQIEAP/hmbUComCWAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScA/+GZtQLTFwRmb3JtAgQA/+GZtQK5YQdub3RoaW5nJwD/4Zm1AtMXB2FiU2hlbGwCBAD/4Zm1AsFhBHRydWUnAP/hmbUC0xcKYWJJRE9yaWdpbgIEAP/hmbUCxmEVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwD/4Zm1AtMXBlRvcEJhcgIEAP/hmbUC3GHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicA/+GZtQLTFw1zaG93Q2hhdElucHV0AgQA/+GZtQLQZgVmYWxzZScA/+GZtQLTFwpzaG93VG9wQmFyAgQA/+GZtQLWZgVmYWxzZScA/+GZtQLTFwlhYlZlcnNpb24CBAD/4Zm1AtxmBTEwLjM3JwD/4Zm1AtMXEnNldEFiRXhwYW5kQ29uc29sZQIEAP/hmbUC4maXAkBjb25zb2xlLmxvZyh0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCkKaWYgKHR5cGVvZiB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuOwp9CgppZiAodGhhdCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChzID0+ICFzKTsKfSBlbHNlIGlmICh0aGF0ID09IHRydWUpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHRydWUpOwp9IGVsc2UgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwoZmFsc2UpOwp9CicA/+GZtQLTFwhhYklnbm9yZQIEAP/hmbUC+mgEdHJ1ZScA/+GZtQLTFwdNZXNzYWdlAgQA/+GZtQL/aMEQQGNvbnN0IHsgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZUVmZmVjdCB9ID0gb3MuYXBwSG9va3MKY29uc3QgVG9wQmFyID0gdGhpc0JvdC5Ub3BCYXIoKQoKY29uc3QgTWVzc2FnZSA9ICh7IHRpbWVzdGFtcCwgbWVzc2FnZSwgbmFtZSB9KSA9PiB7CiAgICBjb25zdCBbc2hvd1RpbWUsIHNldFNob3dUaW1lXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IFt1c2VyTWVzc2FnZSwgc2V0VXNlck1lc3NhZ2VdID0gdXNlU3RhdGUoZmFsc2UpOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGF1dGhCb3QgJiYgYXV0aEJvdC50YWdzLm5hbWUpIHsKICAgICAgICAgICAgaWYgKGF1dGhCb3QudGFncy5uYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChtYXNrcy5wcmVmZXJyZWROYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobmFtZSA9PSAidXNlciIgfHwgbmFtZSA9PSAiVXNlciIpIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UoZmFsc2UpOwogICAgICAgIH0KCiAgICB9LCBbbmFtZV0pCgogICAgY29uc3QgdGltZVRleHQgPSB1c2VNZW1vKAogICAgICAgICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aW1lc3RhbXApIHsgcmV0dXJuIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoCiAgICAgICAgICAgICAgICAgICAnZW4tdXMnLCB7dGltZVN0eWxlOiAnbWVkaXVtJ30pfSwKICAgICAgICBbdGltZXN0YW1wXQogICAgKTsKCiAgICBpZiAoIXRpbWVzdGFtcCB8fCAhbWVzc2FnZSkgeyByZXR1cm4gPD48Lz4gfQoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoKSA9PiBzZXRTaG93VGltZSh0cnVlKX0KICAgICAgICAgICAgb25Qb2ludGVyTGVhdmU9eygpID0+IHNldFNob3dUaW1lKGZhbHNlKX0KICAgICAgICA+CiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIHN0eWxlPXt1c2VyTWVzc2FnZSAmJiB7dGV4dEFsaWduOiAncmlnaHQnfX0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAge25hbWV9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlIiBzdHlsZT17ewogICAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3JvdycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ3Jvdy1yZXZlcnNlJwogICAgICAgICAgICB9fT4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXNwYWNlciIKICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0QWxpZ246IHVzZXJNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncmlnaHQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnbGVmdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHNob3dUaW1lID8gMC42IDogMAogICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAge3RpbWVUZXh0fQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1jb250ZW50Ij57bWVzc2FnZX08L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBNZXNzYWdlOycA/+GZtQLTFxBvbkFueUJvdHNSZW1vdmVkAgQA/+GZtQLBea0CQGNvbnN0IHsgYm90SURzIH0gPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IGJvdElkIG9mIGJvdElEcykgew0KICAgIGlmICh0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICBjb25zdCBkZWxldGVkID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuZGVsZXRlKGJvdElkKTsNCg0KICAgICAgICBpZiAoZGVsZXRlZCkgew0KICAgICAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90SWQ6IGJvdElkIH0pOw0KICAgICAgICB9DQogICAgfQ0KfScA/+GZtQLTFw5vbkFueUJvdHNBZGRlZAIEAP/hmbUC73v4A0Bjb25zdCB7IGJvdHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgbmV3Qm90IG9mIGJvdHMpIHsNCiAgICBpZiAobmV3Qm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKG5ld0JvdC5pZCkpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmFkZChuZXdCb3QuaWQpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBuZXdCb3QgfSk7DQogICAgfQ0KfScA/+GZtQLTFxBvbkFueUJvdHNDaGFuZ2VkAgQA/+GZtQLof+MFQGNvbnN0IGJvdHMgPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IGJvdCBvZiBib3RzKSB7DQogICAgaWYgKGJvdC5ib3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMoYm90LmJvdC5pZCkpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmFkZChib3QuYm90LmlkKTsNCg0KICAgICAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdDogYm90LmJvdCB9KTsNCiAgICAgICAgfSANCg0KICAgICAgICBpZiAoYm90LnRhZ3MuaW5jbHVkZXMoIm1lc3NhZ2UiKSB8fCBib3QudGFncy5pbmNsdWRlcygibmFtZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJ0aW1lc3RhbXAiKSB8fCBib3QudGFncy5pbmNsdWRlcygiY29uc29sZUxvZ01lc3NhZ2VCb3QiKSkgew0KICAgICAgICAgICAgaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsgICAgICAgIA0KICAgICAgICB9DQogICAgfQ0KfScA/+GZtQLTFx9vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkAgQA/+GZtQLMhQE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwD/4Zm1AtMXHW9uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkAgQA/+GZtQKDhgE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwEEYm90cyQyNGRjMDQzMS1mZmJiLTQ0OGQtYWE3NS05NzFiYWEwNzE4ZGMBJwD/4Zm1ArqGAQZzeXN0ZW0CBAD/4Zm1AruGAQ1hYi5zaGVsbC5oZWxwJwD/4Zm1ArqGAQlvbktleURvd24CBAD/4Zm1AsmGAYgCQGlmICh0YWdzLmFjdGl2ZSAmJiB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICBmb3IgKGxldCBjYWxsYmFjayBvZiB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9JwD/4Zm1ArqGAQd1bm1vdW50AgQA/+GZtQLSiAGOAUBhd2FpdCBvcy5jb21waWxlQXBwKHRhZ3MuYXBwSWQsIDw+PC8+KTsKYXdhaXQgb3MudW5yZWdpc3RlckFwcCh0YWdzLmFwcElkKTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gdW5kZWZpbmVkOwptYXNrcy5hY3RpdmUgPSBmYWxzZTsnAP/hmbUCuoYBCXN0eWxlLmNzcwIEAP/hmbUC4YkB8QcuaGVscC10YWJsZSB7CiAgd2lkdGg6IDEwMCU7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi5oZWxwLXRhYmxlIHRkIHsKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHBhZGRpbmctYm90dG9tOiA4cHg7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouaGVscC10YWJsZSB0ZCBoMyB7CiAgbWFyZ2luOiAwOwp9CgouaGVscC10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA5MHB4OwogIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLnNlY3Rpb24gewogIG1hcmdpbi10b3A6IDE2cHg7Cn0KCi5zZWN0aW9uIHA6Zmlyc3Qtb2YtdHlwZSB7CiAgbWFyZ2luLXRvcDogNHB4OwogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouZGVzY3JpcHRpb24geyAKICB3aGl0ZS1zcGFjZTogcHJlLWxpbmU7Cn0KCi51c2FnZS10YWJsZSB7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi51c2FnZS10YWJsZSB0ZCxoMyB7IAogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogIG1hcmdpbjogMDsKfQoKLnVzYWdlLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDYwcHg7Cn0KCi5hcmdzLXRhYmxlIHsKICBtYXJnaW4tbGVmdDogMTZweDsKfQoKLmFyZ3MtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5hcmdzLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9CgpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpLCAobWF4LWhlaWdodDogNjAwcHgpIHsKICAuaGVscC13aW5kb3cgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBsZWZ0OiB1bnNldDsKICAgIHRvcDogdW5zZXQ7CiAgICB0cmFuc2Zvcm06IHVuc2V0OwogICAgbWF4LXdpZHRoOiB1bnNldDsKICAgIG1heC1oZWlnaHQ6IHVuc2V0OwogICAgYm94LXNoYWRvdzogdW5zZXQ7CiAgfQp9JwD/4Zm1ArqGAQlvbkRlc3Ryb3kCBAD/4Zm1AtORARNAdGhpc0JvdC51bm1vdW50KCk7JwD/4Zm1ArqGAQVtb3VudAIEAP/hmbUC55EB8QJAY29uc3QgewogICAgYWJDb21tYW5kc01hbmFnZXIsCiAgICBzZWxlY3RlZENvbW1hbmQKfSA9IHRoYXQgPz8ge307CgppZiAobWFza3MuYWN0aXZlKSB7CiAgICBhd2FpdCB0aGlzQm90LnVubW91bnQoKTsKfQoKY29uc3QgQXBwID0gdGhpc0JvdC5BcHAoKTsKCmF3YWl0IG9zLnJlZ2lzdGVyQXBwKHRhZ3MuYXBwSWQsIHRoaXNCb3QpOwphd2FpdCBvcy5jb21waWxlQXBwKHRhZ3MuYXBwSWQsIDxBcHAgY29tbWFuZHM9e2FiQ29tbWFuZHNNYW5hZ2VyLmNvbW1hbmRzfSBpbml0aWFsU2VsZWN0ZWRDb21tYW5kPXtzZWxlY3RlZENvbW1hbmR9Lz4pOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSBbXTsKbWFza3MuYWN0aXZlID0gdHJ1ZTsnAP/hmbUCuoYBCmNvbXBvbmVudHMCBAD/4Zm1AtmUASjwn5SXMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhJwD/4Zm1ArqGAQV1dGlscwIEAP/hmbUCgJUBKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAP/hmbUCuoYBCGFiSWdub3JlAgQA/+GZtQKnlQEEdHJ1ZScA/+GZtQK6hgEHYWJTaGVsbAIEAP/hmbUCrJUBBHRydWUnAP/hmbUCuoYBCWFiVmVyc2lvbgIEAP/hmbUCsZUBBTEwLjM3JwD/4Zm1ArqGAQNBcHACBAD/4Zm1AreVAbIvQGNvbnN0IEFwcENvbnRhaW5lciA9IGxpbmtzLmNvbXBvbmVudHMuQXBwQ29udGFpbmVyKCk7CmNvbnN0IFdpbmRvdyA9IGxpbmtzLmNvbXBvbmVudHMuV2luZG93KCk7CmNvbnN0IFRleHRMaW5rID0gbGlua3MuY29tcG9uZW50cy5UZXh0TGluaygpOwpjb25zdCBjc3MgPSBsaW5rcy51dGlscy5hYkNvbXBpbGVDU1MoWyB0aGlzQm90LCBsaW5rcy5jb21wb25lbnRzIF0pOwoKY29uc3QgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlUmVmLCB1c2VNZW1vIH0gPSBvcy5hcHBIb29rczsKCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqLwpjb25zdCBBdmFpbGFibGVDb21tYW5kcyA9ICh7IGNvbW1hbmRzLCBvbkNvbW1hbmRDbGljayB9KSA9PiB7CiAgICBjb25zdCBjb21tYW5kTmFtZXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcykuc29ydCgpOwoKICAgIGNvbnN0IG9uQ2xvc2UgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQ2xvc2V9PnsneCBDbG9zZSd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj5BdmFpbGFibGUgQ29tbWFuZHM8L2gyPgogICAgICAgICAgICA8cD5Vc2FnZTogLmNvbW1hbmQgW29wdGlvbnNdPC9wPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgICAgIHtjb21tYW5kTmFtZXMubWFwKChuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRzW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PFRleHRMaW5rIG9uQ2xpY2s9eygpID0+IG9uQ29tbWFuZENsaWNrKGNvbW1hbmQubmFtZSl9Pntjb21tYW5kLm5hbWV9PC9UZXh0TGluaz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntkZXNjcmlwdGlvbn08L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7Q29tbWFuZH0gcHJvcHMuY29tbWFuZAogKi8KY29uc3QgU3BlY2lmaWNDb21tYW5kID0gKHsgY29tbWFuZCwgb25CYWNrIH0pID0+IHsKICAgIGxldCB1c2FnZSA9ICcnOwogICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKICAgIGxldCBhcmdzID0gbnVsbDsKCiAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC51c2FnZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb21tYW5kLmhlbHAudXNhZ2UpKSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZS5qb2luKCdcbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbjsKICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MgJiYgY29tbWFuZC5oZWxwLmFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhcmdzID0gY29tbWFuZC5oZWxwLmFyZ3M7CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+ICAKICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQmFja30+eyc8IEJhY2snfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+e2NvbW1hbmQubmFtZX08L2gyPgogICAgICAgICAgICB7IHVzYWdlICYmCiAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSd1c2FnZS10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGgzPlVzYWdlOjwvaDM+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2FnZX08L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgZGVzY3JpcHRpb24gJiYgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkRlc2NyaXB0aW9uOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdkZXNjcmlwdGlvbic+e2Rlc2NyaXB0aW9ufTwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgYXJncyAmJgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5Bcmd1bWVudHM6PC9oMz4KICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdhcmdzLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICAgICAgeyBhcmdzLm1hcCgoYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZy5pZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdJZGVudGlmaWVyRGlzcGxheSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyLmpvaW4oJyxcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmcuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBhcmcuZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnSWRlbnRpZmllckRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdEZXNjcmlwdGlvbkRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqIEBwYXJhbSB7YW55W119IFtwcm9wcy5hcmdzXQogKi8KY29uc3QgQXBwID0gKHsgY29tbWFuZHMsIGluaXRpYWxTZWxlY3RlZENvbW1hbmQgfSkgPT4gewogICAgY29uc3QgWyBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZCBdID0gdXNlU3RhdGUoaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCk7CgogICAgLy8gRXNjYXBlIGtleSBwcmVzcyBldmVudCBoYW5kbGVyCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IG9uRXNjYXBlS2V5UHJlc3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZENvbW1hbmQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnB1c2gob25Fc2NhcGVLZXlQcmVzcyk7CgogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrSW5kZXggPSB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5maW5kSW5kZXgoKGNhbGxiYWNrKSA9PiBjYWxsYmFjayA9PT0gb25Fc2NhcGVLZXlQcmVzcyk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnNwbGljZShjYWxsYmFja0luZGV4LCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFtzZWxlY3RlZENvbW1hbmRdKTsKICAgIAogICAgY29uc3Qgb25CYWNrZ3JvdW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CgogICAgY29uc3Qgb25Db21tYW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygobmFtZSkgPT4gewogICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChuYW1lKTsKICAgIH0sIFtzZXRTZWxlY3RlZENvbW1hbmRdKQoKICAgIGNvbnN0IGNvbnRlbnQgPSB1c2VNZW1vKCgpID0+IHsKICAgICAgICBpZiAoIXNlbGVjdGVkQ29tbWFuZCkgewogICAgICAgICAgICByZXR1cm4gPEF2YWlsYWJsZUNvbW1hbmRzIGNvbW1hbmRzPXtjb21tYW5kc30gb25Db21tYW5kQ2xpY2s9e29uQ29tbWFuZENsaWNrfS8+CiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgIHJldHVybiA8U3BlY2lmaWNDb21tYW5kIGNvbW1hbmQ9e2NvbW1hbmRzW3NlbGVjdGVkQ29tbWFuZF19IG9uQmFjaz17KCkgPT4gc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpfS8+CiAgICAgICAgfQogICAgfSwgW2NvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHN0eWxlPntjc3N9PC9zdHlsZT4KCiAgICAgICAgICAgIDxBcHBDb250YWluZXIgb25CYWNrZ3JvdW5kQ2xpY2s9e29uQmFja2dyb3VuZENsaWNrfT4KICAgICAgICAgICAgICAgIDxXaW5kb3c+CiAgICAgICAgICAgICAgICAgICAge2NvbnRlbnR9CiAgICAgICAgICAgICAgICA8L1dpbmRvdz4KICAgICAgICAgICAgPC9BcHBDb250YWluZXI+CiAgICAgICAgPC8+CiAgICApCn0KCnJldHVybiBBcHA7JwD/4Zm1ArqGAQVhcHBJZAIEAP/hmbUC6sQBD2FiLWNvbW1hbmQtaGVscCcBBGJvdHMkMzE1YmU0ZGUtZjk2MC00NDA4LTgxMzItODFkOTI1NmNkZjljAScA/+GZtQL6xAEKb25Cb3RBZGRlZAIEAP/hmbUC+8QB0QxALyoqCiAqIExpc3RlbmVyU3RyaW5nIGlzIGEgZnVuY3Rpb24gdGhhdCBjYW4gdHVybiBhbnkgZnVuY3Rpb24gaW50byBhIENhc3VhbE9TIGxpc3RlbmVyIHRhZyBzdHJpbmcuCiAqLwpmdW5jdGlvbiBMaXN0ZW5lclN0cmluZyhmdW5jKSB7CiAgICBpZiAodHlwZW9mIGZ1bmMgPT09ICdzdHJpbmcnICYmIGZ1bmNbMF0gPT09ICdAJykgewogICAgICAgIC8vIElzIGFscmVhZHkgYSBsaXN0ZW5lciBzdHJpbmcuCiAgICAgICAgcmV0dXJuIGRlZGVudChmdW5jKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGZ1bmMgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYExpc3RlbmVyU3RyaW5nIGNhbiBvbmx5IGNvbnZlcnQgZnVuY3Rpb24gb2JqZWN0cyB0byBzdHJpbmdzLmApOwogICAgfQoKICAgIGNvbnN0IGZ1bmNTdHJpbmcgPSBmdW5jLnRvU3RyaW5nKCk7CiAgICAKICAgIGlmIChmdW5jU3RyaW5nLmluY2x1ZGVzKCc9PicpKSB7CiAgICAgICAgLy8gSGFuZGxlIGFycm93IGZ1bmN0aW9ucwogICAgICAgIGNvbnN0IGFycm93SW5kZXggPSBmdW5jU3RyaW5nLmluZGV4T2YoJz0+Jyk7CiAgICAgICAgY29uc3QgYWZ0ZXJBcnJvdyA9IGZ1bmNTdHJpbmcuc3Vic3RyaW5nKGFycm93SW5kZXggKyAyKS50cmltKCk7CiAgICAgICAgCiAgICAgICAgaWYgKGFmdGVyQXJyb3cuc3RhcnRzV2l0aCgneycpKSB7CiAgICAgICAgICAgIC8vIEFycm93IGZ1bmN0aW9uIHdpdGggYmxvY2sgYm9keQogICAgICAgICAgICBjb25zdCBtYXRjaCA9IGFmdGVyQXJyb3cubWF0Y2goL1x7KFtcc1xTXSopXH0vKTsKICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVkZW50KCdAJyArIG1hdGNoWzFdLnRyaW0oKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBBcnJvdyBmdW5jdGlvbiB3aXRoIGNvbmNpc2UgYm9keQogICAgICAgICAgICByZXR1cm4gZGVkZW50KCdAJyArIGFmdGVyQXJyb3cpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSGFuZGxlIHJlZ3VsYXIgZnVuY3Rpb25zCiAgICAgICAgY29uc3QgbWF0Y2ggPSBmdW5jU3RyaW5nLm1hdGNoKC9ceyhbXHNcU10qKVx9Lyk7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiBkZWRlbnQoJ0AnICsgbWF0Y2hbMV0udHJpbSgpKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIEV4dGVuZCBGdW5jdGlvbiBwcm90b3R5cGUgdG8gaW5jbHVkZSBhIC50b0xpc3RlbmVyU3RyaW5nKCkgZnVuY3Rpb24uCi8vIE5vdyB5b3UgY2FuIGNhbGwgLnRvTGlzdGVuZXJTdHJpbmcoKSBvbiBhbnkgZnVuY3Rpb24gYW5kIGhhdmUgaXQgY29udmVydGVkIHRvIGEgbGlzdGVuZXIgc3RyaW5nLgpPYmplY3QuZGVmaW5lUHJvcGVydHkoRnVuY3Rpb24ucHJvdG90eXBlLCAndG9MaXN0ZW5lclN0cmluZycsIHsKICAgIHZhbHVlOiBmdW5jdGlvbigpIHsgcmV0dXJuIExpc3RlbmVyU3RyaW5nKHRoaXMpIH0sCiAgICB3cml0YWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGVudW1lcmFibGU6IGZhbHNlLAp9KTsKCmdsb2JhbFRoaXMuTGlzdGVuZXJTdHJpbmcgPSBMaXN0ZW5lclN0cmluZzsnAP/hmbUC+sQBCW9uRGVzdHJveQIEAP/hmbUCzdEBTkBkZWxldGUgZ2xvYmFsVGhpcy5MaXN0ZW5lclN0cmluZzsKZGVsZXRlIEZ1bmN0aW9uLnByb3RvdHlwZS50b0xpc3RlbmVyU3RyaW5nOycA/+GZtQL6xAEGc3lzdGVtAgQA/+GZtQKc0gEYYWIuc2hlbGwubGlzdGVuZXJfc3RyaW5nJwD/4Zm1AvrEAQhhYklnbm9yZQIEAP/hmbUCtdIBBHRydWUnAP/hmbUC+sQBB2FiU2hlbGwCBAD/4Zm1ArrSAQR0cnVlJwD/4Zm1AvrEAQlhYlZlcnNpb24CBAD/4Zm1Ar/SAQUxMC4zNycBBGJvdHMkMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczAScA/+GZtQLF0gEGc3lzdGVtAgQA/+GZtQLG0gEPYWIuc2hlbGwuY3JlYXRlJwD/4Zm1AsXSAQRmb3JtAgQA/+GZtQLW0gEHbm90aGluZycA/+GZtQLF0gELZGVzY3JpcHRpb24CBAD/4Zm1At7SAT1Cb3QgdXNlZCB0byBjcmVhdGUvbWFuaWZlc3QgYm90cyBpbnRvIGFuIGFjdHVhbCBzY2VuZS9wb3J0YWwuJwD/4Zm1AsXSAQxhYkNyZWF0ZUJvdHMCBAD/4Zm1ApzTAe4vQGxldCB7IAogICAgaW5pdGlhbEJvb3QsIC8vIGNoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4gKG9wdGlvbmFsKQogICAgYm90RGF0YSwgLy8gYm90cyB0byBiZSBnZW5lcmF0ZWQKICAgIG9yaWdpbiwgLy8gd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCiAgICBzdHVkaW8sIC8vIHdoYXQgc3R1ZGlvIGlzIHRoaXMgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgIHJlY29yZCwgLy8gUnlhbiBDb29rOiBkbyB3ZSBuZWVkIHRoaXMgaWYgd2UgYWxyZWFkeSBoYXZlIHN0dWRpbz8gKG9wdGlvbmFsKQogICAgdmVyc2lvbiwgLy8gdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCiAgICBlZ2dQYXJhbWV0ZXJzLCAvLyBkYXRhIHRvIHBhc3MgdG8gYWxsIGNyZWF0ZWQgYm90cyB2aWEgQG9uRWdnSGF0Y2guIChvcHRpb25hbCkKICAgIGlnbm9yZUdyaWRGb2N1cywgLy8gUnlhbiBDb29rOiBhZGRpbmcgdGhpcyBhcyBhbiBvcHRpb25hbCBmbGFnLiAob3B0aW9uYWwpCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIC8vIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIHRoZSBib3RzIGFyZSBjcmVhdGVkLiAob3B0aW9uYWwpCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsIHRvIGFiQ3JlYXRlQm90cy4gKG9wdGlvbmFsKS4KfSA9IHRoYXQ7CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBmb3Igd2hlbiBhYkNyZWF0ZUJvdHMgZXhwZWN0ZWQgImJvdHMiIHBhcmFtZXRlci4KaWYgKCFib3REYXRhICYmIHRoYXQuYm90cykgewogICAgYm90RGF0YSA9IHRoYXQuYm90czsKfQoKbGV0IGJvdENvdW50ID0gT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoOwpjb25zdCBib3REYXRhSGFzaE9yaWdpbmFsID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90RGF0YSk7CmNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCi8vIFJ1biBzb21lIGFiLXNwZWNpZmljIHByZXByb2Nlc3Npbmcgb2YgYm90IGRhdGEuCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIGRhdGEudGFncy5hYklET3JpZ2luID0gb3JpZ2luOwogICAgICAgIGRhdGEudGFncy5hYklEU3R1ZGlvID0gc3R1ZGlvOwoKICAgICAgICBpZiAoZGF0YS50YWdzLmNyZWF0b3IpIHsKICAgICAgICAgICAgZGF0YS50YWdzLm9sZENyZWF0b3IgPSBkYXRhLnRhZ3MuY3JlYXRvcjsKICAgICAgICB9CgogICAgICAgIC8vIFJ5YW4gQ29vazogVGhpcyB0YXJnZXRQb3NpdGlvbiBzdHVmZiBpcyBhcHBhcmVudGx5IHVzZWQgZm9yIGJvdCBwYXN0aW5nPyAKICAgICAgICAvLyBUaGlzIGlzIHNvbWUgcmVhbGx5IGNvbmZ1c2luZyBsb2dpYyBhbmQgc2hvdWxkIGJlIHJlZmFjdG9yZWQgZXZlbnR1YWxseS4KICAgICAgICBpZiAoKGJvdENvdW50IDwgMiB8fCBib3RDb3VudCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uICsgJ1gnXSA9IGFiR3JpZEZvY3VzLnBvc2l0aW9uLng7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWSddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueTsKICAgICAgICB9CiAgICB9Cn0KCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlYSBjcmVhdGVkLgpsZXQgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZScsIHByZXByb2Nlc3NBcmcpKTsKCmlmICh0eXBlb2YgYm90RGF0YSAhPT0gJ29iamVjdCcgfHwgT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICAvLyBUaGVyZSBpc24ndCBhbnkgYm90RGF0YSB0byBjcmVhdGUgZnJvbSEKICAgIHJldHVybjsKfQoKLy8gQ3JlYXRlIGJvdHMgZnJvbSB0aGUgYm90IGRhdGEuCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKbGV0IG5ld0JvdElkcyA9IFtdOwoKZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgIGNvbnN0IG5ld0JvdCA9IGNyZWF0ZShkYXRhLnRhZ3MpOwoKICAgICAgICAgICAgaWRNYXAuc2V0KGRhdGEuaWQsIG5ld0JvdC5pZCk7CiAgICAgICAgICAgIG5ld0JvdHMucHVzaChuZXdCb3QpOwogICAgICAgICAgICBuZXdCb3RJZHMucHVzaChuZXdCb3QuaWQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbnZhbGlkIGJvdGAsIGUpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGVkIGJvdDogYCwgZGF0YSk7CiAgICB9Cn0KCi8vIEFycmF5IG9mIHRhZyByZWxhdGlvbnNoaXBzIHRvIGJlIHByZXNlcnZlZApjb25zdCBsaW5rVGFncyA9IFsibGluayIsICJjcmVhdG9yIiwgImNvbmZpZ0JvdCIsICJsaW5lVG8iLCAidHJhbnNmb3JtZXIiLCAiZm9ybUxpZ2h0VGFyZ2V0Il07CgovLyBUaGlzIGxvb3AgY29udGFpbnMgdGhlIGxvZ2ljIGZvciBwcmVzZXJ2aW5nIHRoZSBsaW5rVGFncwpmb3IgKGxldCBuZXdCb3Qgb2YgbmV3Qm90cykgewogICAgZm9yIChsZXQgdGFnIG9mIGxpbmtUYWdzKSB7CiAgICAgICAgbGV0IHZhbHVlID0gbmV3Qm90LnRhZ3NbdGFnXTsKCiAgICAgICAgaWYgKHRhZyA9PSAiY3JlYXRvciIpIHsKICAgICAgICAgICAgdmFsdWUgPSBuZXdCb3QudGFncy5vbGRDcmVhdG9yOwogICAgICAgICAgICBuZXdCb3QudGFncy5vbGRDcmVhdG9yID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUJvdExpbmtzKG5ld0JvdCwgaWRNYXApOwoKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBsZXQgbmV3VmFsdWUgPSB2YWx1ZS5tYXAoaWQgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpZE1hcC5nZXQoaWQpIHx8IGlkOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lEID0gaWRNYXAuZ2V0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3SUQpIHsKICAgICAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdJRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gVG9hc3RzIGZvciBoYXRjaGVzLCBidXQgb25seSBvbiBidWlsZGVyCmlmIChvcmlnaW4gJiYgdmVyc2lvbiAmJiBjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUgPT0gbnVsbCAmJiAhY29uZmlnQm90LnRhZ3MucGggJiYgYnVpbGRlclZlcnNpb24gPT0gImJ1aWxkZXIiKSB7CiAgICBvcy50b2FzdCgiaGF0Y2hlZCAiICsgb3JpZ2luICsgIiB2IiArIHZlcnNpb24pOwp9CgovLyBDcmVhdGUgYWJFZ2cgYm90IHRoYXQgdHJhY2tzIGNhbiBiZSB1c2VkIHRvIHRyYWNrIHdoYXQgZWdncyBoYXZlIGJlZW4gaGF0Y2hlZC4KbGV0IGFiRWdnTGFiZWw7CgppZiAob3JpZ2luKSB7CiAgICBpZiAodmVyc2lvbikgewogICAgICAgIGFiRWdnTGFiZWwgPSBgJHtvcmlnaW59IHYke3ZlcnNpb259YDsKICAgIH0gZWxzZSB7CiAgICAgICAgYWJFZ2dMYWJlbCA9IG9yaWdpbjsKICAgIH0KfSBlbHNlIHsKICAgIGFiRWdnTGFiZWwgPSAndW5rbm93bic7Cn0KCmNvbnN0IGFiRWdnID0gY3JlYXRlKHsKICAgIHNwYWNlOiAic2hhcmVkIiwKICAgIGFiOiB0cnVlLAogICAgYWJFZ2c6IHRydWUsCiAgICBhYklnbm9yZTogdHJ1ZSwKICAgIG9yaWdpbl9hYjogb3JpZ2luLAogICAgb3JpZ2luX3ZlcnNpb246IHZlcnNpb24sCiAgICBvcmlnaW5fcmVjb3JkOiByZWNvcmQsCiAgICBvcmlnaW5fc3R1ZGlvOiBzdHVkaW8sCiAgICBjcmVhdGVkVGltZXN0YW1wOiBEYXRlVGltZS5mcm9tTWlsbGlzKG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUpLAogICAgYm90SWRzOiBg8J+nrCR7SlNPTi5zdHJpbmdpZnkobmV3Qm90SWRzKX1gLAogICAgYm90RGF0YUhhc2hPcmlnaW5hbCwKICAgIHNvdXJjZUV2ZW50LAogICAgaW5zdDogYWIudGFncy5hYkluc3QsCiAgICBmb3JtOiAiZWdnIiwKICAgIGVnZ1BhcmFtZXRlcnM6IGVnZ1BhcmFtZXRlcnMgPyBg8J+nrCR7SlNPTi5zdHJpbmdpZnkoZWdnUGFyYW1ldGVycyl9YCA6IG51bGwsCiAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgIGxhYmVsOiBhYkVnZ0xhYmVsLAogICAgaGF0Y2hlclJlbW90ZUlkOiBjb25maWdCb3QuaWQsCn0pOwoKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47Cgp3aGlzcGVyKG5ld0JvdHMsICdvblByZUhhdGNoJywgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOwoKaWYgKGluaXRpYWxCb290KSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy8gb25FZ2dIYXRjaCBmb3IgYWxsIGp1c3QgaGF0Y2hlZCBib3RzCndoaXNwZXIobmV3Qm90cywgIm9uRWdnSGF0Y2giLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgZWdnUGFyYW1ldGVycywgc291cmNlRXZlbnQgfSk7CgovLyBvbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQUJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKc3VwZXJTaG91dCgib25BYkFkZGVkIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCmlmIChvcy5pc0NvbGxhYm9yYXRpdmUoKSkgewogICAgLy8gUmVtb3RlIHNob3V0IHRvIGFsbCBvdGhlciBjb25uZWN0ZWQgcmVtb3RlcyB0aGF0IGEgcmVtb3RlIGhhcyBhZGRlZCBhbiBhYi4KICAgIGNvbnN0IHJlbW90ZUlkcyA9IGF3YWl0IG9zLnJlbW90ZXMoKTsKICAgIGNvbnN0IHNlbGZJbmRleCA9IHJlbW90ZUlkcy5pbmRleE9mKGNvbmZpZ0JvdC5pZCk7CiAgICBpZiAoc2VsZkluZGV4ID4gMCkgewogICAgICAgIHJlbW90ZUlkcy5zcGxpY2Uoc2VsZkluZGV4LCAxKTsKICAgIH0KCiAgICBzZW5kUmVtb3RlRGF0YShyZW1vdGVJZHMsICdyZW1vdGVfYWJfYWRkZWQnLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQsIGFiRWdnSWQ6IGFiRWdnLmlkIH0pOwoKfQoKcmV0dXJuIG5ld0JvdHM7JwD/4Zm1AsXSAQhyZW1lbWJlcgIEAP/hmbUCh4MCKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAP/hmbUCxdIBCGFiSWdub3JlAgQA/+GZtQKugwIEdHJ1ZScA/+GZtQLF0gEHYWJTaGVsbAIEAP/hmbUCs4MCBHRydWUnAP/hmbUCxdIBCWFiVmVyc2lvbgIEAP/hmbUCuIMCBTEwLjM3JwD/4Zm1AsXSAQtwZXJzb25hbGl0eQIEAP/hmbUCvoMCKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAP/hmbUCxdIBDG9uUmVtb3RlRGF0YQIEAP/hmbUC5YMC7gpAaWYgKHRoYXQubmFtZSA9PT0gJ3JlbW90ZV9hYl9hZGRlZCcpIHsKICAgIGNvbnN0IGFiRWdnSWQgPSB0aGF0LnRoYXQuYWJFZ2dJZDsKCiAgICBpZiAoYWJFZ2dJZCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhcnRpbmcgc2VhcmNoIGZvciBhYkVnZyBib3Qgd2l0aCBpZCAke2FiRWdnSWR9LCBFdmVudCBkYXRhOmAsIHRoYXQudGhhdCk7CiAgICAgICAgfQoKICAgICAgICAvLyBXYWl0IGZvciB0aGUgYWJFZ2cgYm90IHRvIGFycml2ZS4gT25jZSBpdCBoYXMsIHdlIHNob3VsZCBiZSBhYmxlIHRvIHNhZmVseSBzaG91dCBvblJlbW90ZUFCQWRkZWQgYW5kIGhhdmUgYWxsIHRoZSBib3RzIGluIHRoZSBpbnN0LgogICAgICAgIGxldCBhYkVnZyA9IGdldEJvdCgnaWQnLCBhYkVnZ0lkKTsKICAgICAgICBsZXQgYWNjdW1TZWFyY2hUaW1lID0gMDsKICAgICAgICBjb25zdCBNQVhfU0VBUkNIX1RJTUVfTVMgPSAyMDAwMDsKICAgICAgICBjb25zdCBTRUFSQ0hfSU5URVJWQUxfTVMgPSAyNTA7CiAgICAgICAgCiAgICAgICAgd2hpbGUoIWFiRWdnKSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKFNFQVJDSF9JTlRFUlZBTF9NUyk7CgogICAgICAgICAgICBpZiAoYWNjdW1TZWFyY2hUaW1lIDw9IE1BWF9TRUFSQ0hfVElNRV9NUykgewogICAgICAgICAgICAgICAgYWNjdW1TZWFyY2hUaW1lICs9IFNFQVJDSF9JTlRFUlZBTF9NUzsKICAgICAgICAgICAgICAgIGFiRWdnID0gZ2V0Qm90KCdpZCcsIGFiRWdnSWQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlbW90ZV9hYl9hZGRlZCBldmVudCByZWNlaXZlZCBidXQgYWJFZ2dJZCAke2FiRWdnSWR9IG5ldmVyIGFycml2ZWQuYCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGFiRWdnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIGFiRWdnIGJvdCB3aXRoIGlkICR7YWJFZ2dJZH1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3VwZXJTaG91dCgnb25SZW1vdGVBQkFkZGVkJywgdGhhdC50aGF0KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZW1vdGVfYWJfYWRkZWQgZXZlbnQgcmVjZWl2ZWQgYnV0IG5vdCBhYkVnZ0lkIHdhcyBwcm92aWRlZC4gRXZlbnQgZGF0YTpgLCB0aGF0LnRoYXQpOwogICAgfQp9JwD/4Zm1AsXSAQVkZWJ1ZwIEAP/hmbUC1I4CBWZhbHNlJwEEYm90cyQ1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYBJwD/4Zm1AtqOAgZzeXN0ZW0CBAD/4Zm1AtuOAhBhYi5zaGVsbC52ZXJzaW9uJwD/4Zm1AtqOAgRmb3JtAgQA/+GZtQLsjgIHbm90aGluZycA/+GZtQLajgIIYWJJZ25vcmUCBAD/4Zm1AvSOAgR0cnVlJwD/4Zm1AtqOAgdhYlNoZWxsAgQA/+GZtQL5jgIEdHJ1ZScA/+GZtQLajgITYWJTaGVsbE1ham9yVmVyc2lvbgIEAP/hmbUC/o4CATMnAP/hmbUC2o4CDW9uU2tpbGxVcGRhdGUCBAD/4Zm1AoCPApcBQGNvbnN0IHZlcnNpb25TdHJpbmcgPSB0YWdzLmFiU2hlbGxNYWpvclZlcnNpb24gKyAiLiIgKyB0YWdzLmFiU2hlbGxNaW5vclZlcnNpb247DQoNCmNvbnNvbGUubG9nKCJbQUJTaGVsbF0gTG9hZGVkIEFCIHNoZWxsIHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycA/+GZtQLajgIJYWJWZXJzaW9uAgQA/+GZtQKYkAIFMTAuMzcnAP/hmbUC2o4CE2FiU2hlbGxNaW5vclZlcnNpb24CBAD/4Zm1Ap6QAgIzNCcBBGJvdHMkNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmAScA/+GZtQKhkAIGc3lzdGVtAgQA/+GZtQKikAIOYWIuc2hlbGwuc3RvcmUnAP/hmbUCoZACBGZvcm0CBAD/4Zm1ArGQAgdub3RoaW5nJwD/4Zm1AqGQAgtkZXNjcmlwdGlvbgIEAP/hmbUCuZACP1RoaXMgc2tpbGwgaXMgbWVhbnQgdG8gYmUgYSBjb25maWd1cmFibGUgbWVhbnMgdG8gcHVibGlzaCBkYXRhLicA/+GZtQKhkAIPYWJQdWJsaXNoUmVjb3JkAgQA/+GZtQL5kALlC0Bhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nOwpsZXQgcmVjb3JkRGF0YSA9IHRoYXQuZGF0YTsKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CmxldCBlbmRwb2ludCA9IHRoYXQuZW5kcG9pbnQgPyB0aGF0LmVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgbWFya2VyU2V0ID0gdGhhdC5tYXJrZXJTZXQgPz8gbmV3IFNldCgpOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CmxldCB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdHJ1ZTsKCmlmICghcmVjb3JkRGF0YSkgewogICAgcmV0dXJuICJubyBkYXRhIHN1cHBsaWVkIjsKfQoKYXNzZXJ0KG1hcmtlclNldCBpbnN0YW5jZW9mIFNldCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXJrZXJTZXQgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBTZXRgKTsKCi8vIFtSeWFuIENvb2tdIEhBQ0s6IFRoZXJlIGFyZSBpc3N1ZXMgd2l0aCBjdXN0b20gbWFya2Vycy4gQ2xlYXIgYWxsIG9mIHRoZSBleGNlcHQgZm9yIHB1YmxpY1JlYWQuCm1hcmtlclNldC5jbGVhcigpOwoKaWYgKHB1YmxpY0ZhY2luZykgewogICAgbWFya2VyU2V0LmFkZCgncHVibGljUmVhZCcpOwp9CgpyZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7IGVuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogbWFya2VyU2V0LnNpemUgPiAwID8gQXJyYXkuZnJvbShtYXJrZXJTZXQpIDogdW5kZWZpbmVkIH0pOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb3JkRGF0YSByZXN1bHQ6YCwgcmVjb3JkRGF0YSk7Cn0KCmlmIChyZWNvcmREYXRhLnN1Y2Nlc3MpIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgZGF0YSBwdWJsaXNoZWQgdG8gcmVjb3JkICR7dXNlclJlY29yZH0gYXQgYWRkcmVzcyAke3JlY29yZE5hbWV9YCwgbG9nVHlwZTogJ2xvZycsIHRvYXN0OiB0b2FzdCB9KTsKfSBlbHNlIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGRhdGEgZmFpbGVkIHRvIHB1Ymxpc2ggdG8gcmVjb3JkICR7dXNlclJlY29yZH0gYXQgYWRkcmVzcyAke3JlY29yZE5hbWV9XG4ke0pTT04uc3RyaW5naWZ5KHJlY29yZERhdGEsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKCiAgICBpZiAodG9hc3QpIHsKICAgICAgICBhYi5saW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYGRhdGEgZmFpbGVkIHRvIHB1Ymxpc2ggdG8gcmVjb3JkICR7dXNlclJlY29yZH0gYXQgYWRkcmVzcyAke3JlY29yZE5hbWV9LiAke3JlY29yZERhdGEuZXJyb3JNZXNzYWdlfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICB9Cn0KCnJldHVybiByZWNvcmREYXRhOycA/+GZtQKhkAINYWJQdWJsaXNoRmlsZQIEAP/hmbUC35wCsQ1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghdGhpc0JvdC5jYW5QdWJsaXNoRmlsZSgpKSB7CiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIGVycm9yQ29kZTogJ25vdF9hdXRob3JpemVkJywKICAgICAgICBlcnJvck1lc3NhZ2U6ICdVc2VyIGlzIG5vdCBhdXRob3JpemVkIHRvIHB1Ymxpc2ggZmlsZXMuJwogICAgfQp9CgpsZXQgZmlsZSA9IHRoYXQuZmlsZTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlTmFtZTsKbGV0IG1pbWVUeXBlID0gdGhhdC5taW1lVHlwZTsKbGV0IG1hcmtlclNldCA9IHRoYXQubWFya2VyU2V0ID8/IG5ldyBTZXQoKTsKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nID8/IHRydWU7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghZmlsZSkgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICBlcnJvckNvZGU6ICdpbnZhbGlkX2ZpbGVfZGF0YScsCiAgICAgICAgZXJyb3JNZXNzYWdlOiAnQSBmaWxlIG11c3QgYmUgcHJvdmlkZWQgdG8gcHVibGlzaC4nCiAgICB9Cn0KCmFzc2VydChtYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CgovLyBbUnlhbiBDb29rXSBIQUNLOiBUaGVyZSBhcmUgaXNzdWVzIHdpdGggY3VzdG9tIG1hcmtlcnMuIENsZWFyIGFsbCBvZiB0aGUgZXhjZXB0IGZvciBwdWJsaWNSZWFkLgptYXJrZXJTZXQuY2xlYXIoKTsKCmlmIChwdWJsaWNGYWNpbmcpIHsKICAgIG1hcmtlclNldC5hZGQoJ3B1YmxpY1JlYWQnKTsKfQoKbGV0IGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHsgZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUsIG1hcmtlcnM6IG1hcmtlclNldC5zaXplID4gMCA/IEFycmF5LmZyb20obWFya2VyU2V0KSA6IHVuZGVmaW5lZCB9KTsKCmlmICghZmlsZVVwbG9hZC5zdWNjZXNzKSB7CiAgICBpZiAoZmlsZVVwbG9hZC5lcnJvckNvZGUgPT0gImZpbGVfYWxyZWFkeV9leGlzdHMiKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmlsZSBhbHJlYWR5IGV4aXN0cyBpbiAke3VzZXJSZWNvcmR9YCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgcmV0dXJuIGZpbGVVcGxvYWQ7CiAgICB9CgogICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHVzZXJSZWNvcmQpOwoKICAgIGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHsgZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUsIG1hcmtlcnM6IG1hcmtlclNldC5zaXplID4gMCA/IEFycmF5LmZyb20obWFya2VyU2V0KSA6IHVuZGVmaW5lZCB9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykgewogICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmlsZSByZWNvcmRlZCB0byAke3VzZXJSZWNvcmR9YCwgbG9nVHlwZTogJ2xvZycgfSk7Cn0KZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmaWxlIGZhaWxlZCB0byByZWNvcmRgLCBsb2dUeXBlOiAnZXJyb3InIH0pOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAP/hmbUCoZACEGFiQ29yZU1lbnVBY3Rpb24CBAD/4Zm1ApGqAk1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycA/+GZtQKhkAILb25TdG9yZU1lbnUCBAD/4Zm1At+qAo2YAUBsZXQgcG9zc2libGVQdWJsaXNoQm90ID0gbmV3IFNldCgpOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cykgewogICAgaWYgKEFycmF5LmlzQXJyYXkobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSkgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cy5mb3JFYWNoKGIgPT4gcG9zc2libGVQdWJsaXNoQm90LmFkZChiKSk7CiAgICB9IGVsc2UgewogICAgICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKTsKICAgIH0KfQoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIHsKICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyk7Cn0KCnBvc3NpYmxlUHVibGlzaEJvdCA9IEFycmF5LmZyb20ocG9zc2libGVQdWJsaXNoQm90KTsKCmNvbnN0IGJhc2VBQiA9ICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzID8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMuaWQ7CmNvbnN0IGJhc2VCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBiYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgZGVmYXVsdHMgPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBtYW5hZ2VyOiAi8J+UlyIgKyB0aGlzQm90LmlkLAogICAgbWFuaWZlc3RhdGlvbjogdGFncy5tYW5pZmVzdGF0aW9uLAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAKfQoKLy8gQ3JlYXRlIGRvd25sb2FkIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgIGxhYmVsOiAiZG93bmxvYWQiLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm1BZGRyZXNzOiAiZ2V0X2FwcCIsCiAgICBwb3NzaWJsZUJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYkRvd25sb2FkKHsgcG9zc2libGVCb3RzOiBsaW5rcy5wb3NzaWJsZUJvdCwgc291cmNlRXZlbnQ6ICdhYl9zdG9yZV9tZW51X2Rvd25sb2FkJyB9KTtgCn0pOwoKaWYgKCFhdXRoQm90KSAKewogICAgLy8gQ3JlYXRlIGxvZ2luIG1lc3NhZ2UKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICAgICAgbGFiZWw6ICJwbGVhc2Ugc2lnbiBpbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIsCiAgICAgICAgb25DbGljazogYEAgb3MucmVxdWVzdEF1dGhCb3QoKWAKICAgIH0pOwoKICAgIHJldHVybjsKfQplbHNlIGlmIChhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciA9PSAiRnJlZVBsYXkiKSAKewogICAgLy8gQ3JlYXRlIHVwZ3JhZGUgc3Vic2NyaXB0aW9uIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAicGxlYXNlIHVwZ3JhZGUgeW91ciBzdWJzY3JpcHRpb24gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siCiAgICB9KTsKCiAgICByZXR1cm47Cn0KCgpsZXQgdXNlclN0dWRpb3MgPSBjb25maWdCb3QudGFncy51c2VyX3N0dWRpb3M7CgppZiAoIXVzZXJTdHVkaW9zKSAKewogICAgdXNlclN0dWRpb3MgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsKfQoKaWYgKHVzZXJTdHVkaW9zLnN1Y2Nlc3MpIAp7CiAgICBjb25zdCBhY3RpdmVTdHVkaW8gPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKTsKCiAgICBsZXQgYmFzZVN0dWRpbyA9IGF1dGhCb3QuaWQ7CgogICAgaWYgKGJhc2VTdHVkaW8gPT0gYXV0aEJvdC5pZCkgCiAgICB7CiAgICAgICAgYmFzZVN0dWRpbyA9ICJwbGF5ZXIiOwogICAgfQoKICAgIGlmIChhY3RpdmVTdHVkaW8gPT0gLTEgJiYgYmFzZVN0dWRpbyAhPSAicGxheWVyIikgCiAgICB7CiAgICAgICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBiYXNlU3R1ZGlvOwogICAgfQoKICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8gJiYgIWFjdGl2ZVN0dWRpbykgCiAgICB7CiAgICAgICAgY29uc3Qgc3R1ZGlvTWF0Y2ggPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbykKCiAgICAgICAgaWYgKHN0dWRpb01hdGNoICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2VTdHVkaW8gPSBiYXNlU3R1ZGlvOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBzdHVkaW9MYWJlbCA9IGFjdGl2ZVN0dWRpbyA9PSAtMSA/IGJhc2VTdHVkaW8gOiB1c2VyU3R1ZGlvcy5zdHVkaW9zW2FjdGl2ZVN0dWRpb10uZGlzcGxheU5hbWU7CgogICAgLy8gQ3JlYXRlIHN0dWRpbyBzZWxlY3QgYnV0dG9uCiAgICBjb25zdCBzdHVkaW9EaXNwbGF5QnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAic3R1ZGlvPSIgKyBzdHVkaW9MYWJlbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNSwKICAgICAgICBzdHVkaW9JbmZvcm1hdGlvbjogdXNlclN0dWRpb3MsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJpbnZlbnRvcnlfMiIsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5zdHVkaW9TZWxlY3QodGFncy5zdHVkaW9JbmZvcm1hdGlvbik7YAogICAgfSk7CgogICAgbWFza3Muc3R1ZGlvU2VsZWN0QnV0dG9uID0gZ2V0TGluayhzdHVkaW9EaXNwbGF5QnV0dG9uKTsKfQoKY29uc3QgdG90YWxCb3RDb3VudCA9IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggPiAwID8gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGg7CgovLyBDcmVhdGUgcHVibGlzaCBsYWJlbCBidXR0b24KY29uc3QgbGFiZWxCb3QgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGxhYmVsOiBgcHVibGlzaCBwYXR0ZXJuICR7YmFzZUJvdHMubGVuZ3RoID4gMCA/ICIiIDogImFzICJ9JHtiYXNlQUJ9ICgke3RvdGFsQm90Q291bnR9IGJvdCR7YmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICB0b3RhbEJvdHM6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGgsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBmb3JtQWRkcmVzczogbnVsbCwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHggOHB4IDBweCAwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci10b3Atc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBzaGlmdFN0YXRlOiBmYWxzZSwKICAgIG9uQ2xpY2s6IGBAIGNvbnN0IG1lbnVCb3RzID0gZ2V0Qm90cygnYWJNZW51U29ydE9yZGVyJyk7CgogICAgICAgIGlmICh0YWdzLnNoaWZ0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlVcCIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5RG93biIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGFncy5zaGlmdFN0YXRlID0gIXRhZ3Muc2hpZnRTdGF0ZTtgLAogICAgc2NhbGVZOiAiYXV0byIsCiAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBsZXQgdG90YWxCb3RzID0gY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID8gdGhhdC5hYkJvdHMgOiB0aGF0LmFiQm90cyArIHRoYXQubm9uQUJCb3RzOwoKICAgIGNvbnN0IHRvdGFsQm90VmFyID0gdG90YWxCb3RzID09IDEgPyAiIGJvdCIgOiAiIGJvdHMiOwogICAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHM/Lmxlbmd0aCAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIGlmIChnZXRCb3QoImFiSURPcmlnaW4iLCBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQikpCiAgICAgICAgewogICAgICAgICAgICBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpLmxlbmd0aDsKCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgYWJCb3RzICsgIiBib3RzKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gYWJCb3RzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggcGF0dGVybiBhcyAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgICAgIH0gICAKICAgIH0KICAgIGVsc2UKICAgIHsgICAKICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIHRoYXQuYWIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICB9YAp9KTsKCi8vIENyZWF0ZSBlbmNyeXB0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICBsYWJlbDogImVuY3J5cHQiLAogICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICBlbmNyeXB0U3RhdGU6IGZhbHNlLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgaWYodGFncy5lbmNyeXB0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gdHJ1ZTsKICAgICAgICB9YCwKfSk7CgpsZXQgYWJCdXR0b247CgppZiAocG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvLyBDcmVhdGUgaW5jbHVkZUJvdHMgYnV0dG9uCiAgICBhYkJ1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTIsCiAgICAgICAgYWJTZWxlY3Rpb25CdXR0b246IHRydWUsCiAgICAgICAgbGFiZWw6IGJhc2VCb3RzLmxlbmd0aCA+IDAgJiYgYmFzZUFCICE9IHVuZGVmaW5lZCA/IGBzZWxlY3RlZCBwYXR0ZXJuOiAke2Jhc2VBQn0gKCR7YmFzZUJvdHMubGVuZ3RofSBib3Qke2Jhc2VCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAgOiBgbmV3IHBhdHRlcm4gKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogJ2VnZycsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaFNlbGVjdCgpO2AsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyTm9uID0gdGhhdC5ub25BQkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgY29uc3QgYm90VmFyQUIgPSB0aGF0LmFiQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICAgICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSB0aGF0LmFiICsgIiAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyTm9uOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInNlbGVjdGVkIHBhdHRlcm46ICIgKyB0aGF0LmFiICsgIiAoIiArIHRoYXQuYWJCb3RzICsgYm90VmFyQUI7CiAgICAgICAgfWAKICAgIH0pOwp9CgppZiAobm9uQUJCb3RzLmxlbmd0aCA+IDAgJiYgcG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvL2ljbHVkZSBuZXcgYm90cwogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTMsCiAgICAgICAgYWJCdXR0b246IGdldExpbmsoYWJCdXR0b24pLAogICAgICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgICAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgICAgIGxhYmVsOiBgaW5jbHVkZSBuZXcgKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveCIsCiAgICAgICAgdW5jbGFpbWVkU3RhdGU6IGZhbHNlLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CgogICAgICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IGxpbmtzLmFiQnV0dG9uLnRhZ3MubGFiZWw7CgogICAgICAgICAgICAgICAgaWYgKGxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGFncy51bmNsYWltZWRTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25BQkJvdHMubGVuZ3RofSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwoKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IHRydWU7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogMH0pOwogICAgICAgICAgICB9YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cyA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIAogICAgICAgICAgICB0YWdzLmxhYmVsID0gImluY2x1ZGUgbmV3ICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXI7CgogICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gdGhhdC5hYjsKCiAgICAgICAgICAgIGlmKCFsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHB1YmxpYyBidXR0b24KaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSAKewogICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gZmFsc2U7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgICAgICBsYWJlbDogImlzUHVibGljIiwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgICAgICBwdWJsaWNTdGF0ZTogZmFsc2UsCiAgICAgICAgb25DbGljazogYEAgaWYodGFncy5wdWJsaWNTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSB0cnVlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSB2ZXJzaW9uIHNlbGVjdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgbGFiZWw6ICd2ZXJzaW9uRmxhZz1jdXJyZW50JywKICAgIGZvcm1BZGRyZXNzOiAnYWx0X3JvdXRlJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBzaG91dCgnc2hvd1ZlcnNpb25TZWxlY3RvcicpO2AsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAndmVyc2lvbkZsYWc9JyArIHRoYXQ7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICBgLAp9KTsKCi8vIEN1cnJlbnQgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnY3VycmVudCcsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gRmVlZGJhY2sgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnZmVlZGJhY2snLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnZmVlZGJhY2snOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIFN0YWJsZSBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdzdGFibGUnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTIsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnc3RhYmxlJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBDcmVhdGUgcHVibGlzaCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDQsCiAgICBmb3JtQWRkcmVzczogImVnZyIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCA4cHggOHB4IiwKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItYm90dG9tLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm06ICJpbnB1dCIsCiAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICBvbklucHV0VHlwaW5nOiBgQCBsaW5rcy5sYWJlbEJvdC50YWdzLmxhYmVsID0gJ3B1Ymxpc2ggcGF0dGVybiBhcyAnICsgdGhhdC50ZXh0ICsgJyAoJyArIGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzICsgJyBib3QnICsgKGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzID09IDEgPyAnKScgOiAncyknKTtgLAogICAgbWVudUl0ZW1TaG93U3VibWl0V2hlbkVtcHR5OiB0cnVlLAogICAgdGFyZ2V0Qm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBtZW51SXRlbVRleHQ6IGJhc2VBQiwKICAgIG9uU3VibWl0OiBgQAogICAgICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQudGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgY29uZmlybVB1c2ggPSBmYWxzZTsKICAgICAgICAgICAgbGV0IGluWFIgPSBjb25maWdCb3QudGFncy5hckVuYWJsZWQgfHwgY29uZmlnQm90LnRhZ3MudnJFbmFibGVkOwoKICAgICAgICAgICAgaWYgKGluWFIpIHsKICAgICAgICAgICAgICAgIGNvbmZpcm1QdXNoID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgICAgICBjb25maXJtUHVzaCA9IGF3YWl0IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgICAgICAgICB0aXRsZTogImNvbmZpcm0gcHVibGlzaCIsCiAgICAgICAgICAgICAgICAgICAgY29udGVudDogInB1Ymxpc2ggIiArIHRoYXQudGV4dCArICIgdG8gIiArIHRhcmdldFN0dWRpbyArICI/IiwKICAgICAgICAgICAgICAgICAgICBjb25maXJtVGV4dDogInB1Ymxpc2giLAogICAgICAgICAgICAgICAgICAgIGNhbmNlbFRleHQ6ICJjYW5jZWwiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFjb25maXJtUHVzaCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhhdC50ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaEFCKHsgYWI6IHRoYXQudGV4dCwgYm90OiBsaW5rcy50YXJnZXRCb3QsIGJhc2VBQjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIG1hbnVhbFB1Ymxpc2g6IHRydWUsIHNvdXJjZUV2ZW50OiAnc3RvcmVfbWVudScgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvcy50b2FzdCgiYWIgbm90IHNwZWNpZmllZCIpOwogICAgICAgICAgICB9CiAgICAgICAgYCwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIAogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gdGhhdC5hYjsKICAgIH1gCn0pOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIAp7CiAgICAvLyBDcmVhdGUgY29weSB0byBjbGlwYm9hcmQgYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA4LAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogImNvcHkgdG8gY2xpcGJvYXJkIiwKICAgICAgICBmb3JtQWRkcmVzczogImZpbGVfY29weSIsCiAgICAgICAgdGFyZ2V0Qm90OiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90Rm9jdXMsCiAgICAgICAgb25DbGljazogYEAgCiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwoKICAgICAgICAgICAgYWIubGlua3MucGFzdGUuYWJDb3B5Qm90c1RvQ2xpcGJvYXJkKHsgYm90czogW2xpbmtzLnRhcmdldEJvdF0sIHNvdXJjZUV2ZW50OiAnYWJfc3RvcmVfbWVudV9jb3B5X2NsaXBib2FyZCcgfSkKCiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIGAsCiAgICB9KTsKfQplbHNlIAp7CiAgICAvLyBDcmVhdGUgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEwLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsgICAgICAgICAgICAKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogInNjYW4gdG8gcHVibGlzaCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJxcl9jb2RlX3NjYW5uZXIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gdHJ1ZTsgb3Mub3BlblFSQ29kZVNjYW5uZXIoKTtgLAogICAgfSk7Cn0KCmxldCBob3N0QnV0dG9uID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51U29ydE9yZGVyOiA1MCwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGZvcm1BZGRyZXNzOiAiZ3JvdXBfYWRkIiwKICAgIGxlYXJuOiB0YWdzLmxlYXJuLAogICAgb25DbGljazogYEAgCiAgICAgICAgbGlua3MubGVhcm4uYWJDcmVhdGVIb3N0KHRoaXNCb3QpOwogICAgICAgIGlmICghYWIubGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKICAgICAgICB9CiAgICBgLAp9OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSB7CiAgICBob3N0QnV0dG9uLmxhYmVsID0gImpvaW4gY29kZTogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEOwp9IGVsc2UgewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJnZW5lcmF0ZSBqb2luIGNvZGUiOwp9CgppZiAoY29uZmlnQm90LnRhZ3Muc3RhdGljSW5zdCA9PSB1bmRlZmluZWQpCnsKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGhvc3RCdXR0b24pOy8vZ2VuZXJhdGUgYSBob3N0IGJ1dHRvbgp9JwD/4Zm1AqGQAg5hYkNvcmVNZW51SWNvbgIEAP/hmbUC38IDCWlvc19zaGFyZScA/+GZtQKhkAIPYWJDb3JlTWVudUxhYmVsAgQA/+GZtQLpwgMFc2hhcmUnAP/hmbUCoZACE2FiQ29yZU1lbnVTb3J0T3JkZXICBAD/4Zm1Au/CAwEzJwD/4Zm1AqGQAghyZW1lbWJlcgIEAP/hmbUC8cIDKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAP/hmbUCoZACC2FiUHVibGlzaEFCAgQA/+GZtQKYwwO5P0BpZiAoIWF1dGhCb3QpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAibXVzdCBiZSBsb2dnZWQgaW4gdG8gcHVibGlzaCBwYXR0ZXJucy4iLCBsb2dUeXBlOiAiZXJyb3IiIH0pOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QuY2FuUHVibGlzaEZpbGUoKSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJtdXN0IGhhdmUgc3Vic2NyaXB0aW9uIHRoYXQgc3VwcG9ydHMgZmlsZSBwdWJsaXNoaW5nLiIsIGxvZ1R5cGU6ICJlcnJvciIgfSk7CiAgICByZXR1cm4gCn0KCmlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJwYXR0ZXJuIG5hbWVzIG1heSBub3QgY29udGFpbiBzcGFjZXMgb3IgcXVvdGFpb24gbWFya3MsIHBsZWFzZSB0cnkgYWdhaW4uIiwgbG9nVHlwZTogImVycm9yIiB9KTsKICAgIHJldHVybjsKfQoKCmxpbmtzLnV0aWxzLmFiTG9nKGBwdWJsaXNoaW5nICR7dGhhdC5hYn1gKTsKCmlmICghdGhhdC5rZWVwTWVudSkgewogICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKfQoKLy9hYiB2YXJpYWJsZXMKY29uc3QgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKY29uc3QgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpjb25zdCBiYXNlQUIgPSB0aGF0LmJhc2VBQiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPz8gKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQpOwpjb25zdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoID0gdGhhdC5vblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOyAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4gKG9wdGlvbmFsKQpjb25zdCBtYW51YWxQdWJsaXNoID0gdGhhdC5tYW51YWxQdWJsaXNoOwpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQuc291cmNlRXZlbnQ7IC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQpjb25zdCBlZ2dNYXJrZXJTZXQgPSB0aGF0LmVnZ01hcmtlclNldCA/PyBuZXcgU2V0KCk7CmNvbnN0IGF1eE1hcmtlclNldCA9IHRoYXQuYXV4TWFya2VyU2V0ID8/IG5ldyBTZXQoKTsKY29uc3Qgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmFzc2VydChlZ2dNYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CmFzc2VydChhdXhNYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXV4TWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7Cgpjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwoKZWdnTWFya2VyU2V0LmFkZCgnYWJFZ2cnKTsKZWdnTWFya2VyU2V0LmFkZChhYklEKTsKCmF1eE1hcmtlclNldC5hZGQoJ2FiQXV4Jyk7CmF1eE1hcmtlclNldC5hZGQoYWJJRCk7CgpsZXQgYnVzeUluZGljYXRvcjsKaWYgKG1hbnVhbFB1Ymxpc2ggJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkgewogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQogICAgCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHVwbG9hZGluZyAke3RoYXQuYWJ9YCwgb25EZXN0cm95OiBgQGNvbnNvbGUubG9nKCdidXN5IGluZGljYXRvciBnbyBib29tJylgfSk7Cn0KCi8vIExldCBhbGwgYm90cyBrbm93IHRoYXQgYWIgaXMgYWJvdXQgdG8gc3RhcnQgcHVibGlzaGluZy4KY29uc3QgYmVmb3JlUHVibGlzaEFyZyA9IHsgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nLCBzb3VyY2VFdmVudCB9Owphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJCZWZvcmVQdWJsaXNoJywgYmVmb3JlUHVibGlzaEFyZykpOwoKaWYgKCF0YXJnZXQgfHwgdGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgIGlmIChjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgJiYgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQikgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBhYklEKTsKCiAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiAmJiBnZXRCb3QoImFiSURPcmlnaW4iLCBiYXNlQUIpKSB7CiAgICAgICAgY29uc3QgZWdnQm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKTsKICAgICAgICBjb25zdCBuZXdCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCk7CgogICAgICAgIHRhcmdldCA9IFsuLi5lZ2dCb3RzLCAuLi5uZXdCb3RzXTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgfQoKICAgIHNldFRhZyh0YXJnZXQsICJhYklET3JpZ2luIiwgYWJJRCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IG51bGw7CgogICAgaWYgKHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgibm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIGlmICghdGhhdC5rZWVwTWVudSkgewogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikgewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkgewogICAgICAgIGtleUNoZWNrID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ2NvbmZpcm0gc2VjcmV0IGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBpZiAoa2V5ICE9IGtleUNoZWNrKSB7CiAgICAgICAgaWYgKCFrZXlDaGVjaykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBrZXkgZW50ZXJlZCIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoYXQua2VlcE1lbnUpIHsKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsgCiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGN1cnJlbnRCb3RJRCA9IHRhcmdldFtpXS5pZDsKICAgICAgICBsZXQgY3VycmVudEJvdERhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldFtpXSkpOwoKICAgICAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdERhdGE7CiAgICB9Cn0KZWxzZSB7CiAgICBzdGF0ZVt0YXJnZXQuaWRdID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0YXJnZXQpKTsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7IGFiSUQ6IGFiSUQgfSk7CgovL2FkZCB4cCBib3QgaGVyZQpzdGF0ZS5hYlhQQm90ID0gewogICAgc3BhY2U6ICJzaGFyZWQiLAogICAgaWQ6ICJhYlhQQm90IiwKICAgIHRhZ3M6IHsKICAgICAgICBmb3JtOiAibm90aGluZyIsCiAgICAgICAgc3lzdGVtOiAiYWIucGF0dGVybi5hYlhQQm90IiwKICAgICAgICBhdXRob3JJRDogYXV0aEJvdC5pZCwKICAgICAgICB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24sCiAgICAgICAgeHA6IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUCwKICAgICAgICBzaWduYXR1cmU6IGVnZ0NoZWNrLnNpZ25hdHVyZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgIH0KfTsKCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBhYiBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhOiBzdGF0ZSwgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nLCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gnLCBwcmVwcm9jZXNzQXJnKSk7CgovL2FkZGl0aW9uYWwgZmlsZSBkYXRhCmZvcm1hdHRlZEZpbGUudmVyc2lvbiA9IDE7CmZvcm1hdHRlZEZpbGUuc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwpmb3JtYXR0ZWRGaWxlLnN0YXRlID0gc3RhdGU7CgovL2FjdHVhbCBlbmNyeXB0aW9uIGlmIGNob3NlbgppZiAoa2V5KSB7CiAgICBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkoZm9ybWF0dGVkRmlsZSk7CiAgICBmb3JtYXR0ZWRGaWxlID0gY3J5cHRvLmVuY3J5cHQoa2V5LCBmb3JtYXR0ZWRGaWxlKTsKfQoKLy9wdWJsaXNoIHRoZSBmaWxlIGFuZCB0aGUgZWdnIHJlY29yZC4KbGV0IHB1Ymxpc2hGaWxlOwpsZXQgcHVibGlzaFJlY29yZDsKCnB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogdHJ1ZSwgbWFya2VyU2V0OiBhdXhNYXJrZXJTZXQgfSk7CgppZiAocHVibGlzaEZpbGUuc3VjY2VzcykgewogICAgLy9nYXRoZXIgYWRkaW9uYWwgZWdnIGRhdGEKICAgIGNvbnN0IGFpUGVybWl0Q2hlY2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhaV9wZXJtaXQiKTsKICAgIGNvbnN0IGFpUGVybWl0SUQgPSBhaVBlcm1pdENoZWNrLnN1Y2Nlc3MgPyBhaVBlcm1pdENoZWNrLmRhdGEucGVybWl0SUQgOiBmYWxzZTsKCiAgICBlZ2dDaGVjay5lZ2dEYXRhLmFpUGVybWl0ID0gYWlQZXJtaXRJRDsKICAgIGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkucHVzaChwdWJsaXNoRmlsZS51cmwpOwogICAgZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICBlZ2dDaGVjay5lZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKICAgIAogICAgLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKICAgIHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7IGRhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZywgbWFya2VyU2V0OiBlZ2dNYXJrZXJTZXQsIHRvYXN0OiBmYWxzZSB9KTsKfQoKaWYgKHB1Ymxpc2hGaWxlLnN1Y2Nlc3MgJiYgcHVibGlzaFJlY29yZC5zdWNjZXNzKSB7CiAgICAvL3B1Ymxpc2hpbmcgc2hvdXQKICAgIHN1cGVyU2hvdXQoIm9uQUJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOwogICAgc3VwZXJTaG91dCgib25BYlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7IC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoKICAgIGNvbnN0IGJpb3MgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwogICAgY29uc3QgaW5zdFR5cGUgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwoKICAgIHNldFRhZ01hc2sobGlua3MubGVhcm4sICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKCiAgICBpZiAobWFudWFsUHVibGlzaCkgewogICAgICAgIGxldCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKICAgICAgICBjb25zdCB1cmwgPSBzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICImc3R1ZGlvPSIgKyBzdHVkaW8gKyAiJmJpb3M9IiArIGJpb3M7CiAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKHVybCk7CgogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgd2l0aCBlbmNyeXB0ZWQgZGF0YSBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9CiAgICB9CgogICAgdHJ5IHsKICAgICAgICBhd2FpdCBhbmFseXRpY3MucmVjb3JkRXZlbnQoJ2FiX2VnZ19wdWJsaXNoJywgeyBhYjogYWJJRCwgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICB9Cn0KZWxzZSB7CiAgICBsZXQgZXJyb3JNZXNzYWdlOwoKICAgIGlmICghcHVibGlzaEZpbGUuc3VjY2VzcykgewogICAgICAgIGVycm9yTWVzc2FnZSA9IHB1Ymxpc2hGaWxlLmVycm9yTWVzc2FnZSA/PyBwdWJsaXNoRmlsZS5lcnJvckNvZGU7CiAgICB9IGVsc2UgaWYgKCFwdWJsaXNoUmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBlcnJvck1lc3NhZ2UgPSBwdWJsaWNoUmVjb3JkLmVycm9yTWVzc2FnZSA/PyBwdWJsaXNoUmVjb3JkLmVycm9yQ29kZTsKICAgIH0gZWxzZSB7CiAgICAgICAgZXJyb3JNZXNzYWdlID0gJ1Vua25vd24gcmVhc29uJzsKICAgIH0KCiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiBgUHVibGlzaGluZyBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWAsCiAgICAgICAgbG9nVHlwZTogJ2Vycm9yJywKICAgICAgICB0b2FzdDogIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZQogICAgfSkKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBwdWJsaXNoUmVjb3JkOycA/+GZtQKhkAIIYWJJZ25vcmUCBAD/4Zm1AtKCBAR0cnVlJwD/4Zm1AqGQAgphYkRvd25sb2FkAgQA/+GZtQLXggS5FUBjb25zdCBwb3NzaWJsZUJvdHMgPSB0aGF0Py5wb3NzaWJsZUJvdHM7CmxldCBmaWxlbmFtZSA9IHRoYXQ/LmZpbGVuYW1lOwpsZXQgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKbGV0IG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ7CmxldCBsb2cgPSB0aGF0Py5sb2cgPz8gdHJ1ZTsKbGV0IHJlb3BlbkFiTWVudSA9IHRoYXQ/LnJlb3BlbkFiTWVudSA/PyB0cnVlOwoKLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byBkb3dubG9hZCBib3RzLgpjb25zdCBiZWZvcmVEb3dubG9hZEFyZyA9IHsgZmlsZW5hbWUsIHNvdXJjZUV2ZW50IH07CmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZURvd25sb2FkJywgYmVmb3JlRG93bmxvYWRBcmcpKTsKCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zdCBzaG91bGREb3dubG9hZEluc3QgPSAhcG9zc2libGVCb3RzIHx8IChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykgJiYgcG9zc2libGVCb3RzLmxlbmd0aCA9PT0gMCk7CgppZiAoc2hvdWxkRG93bmxvYWRJbnN0KSB7CiAgICAvLyBEb3dubG9hZCBpbnN0LgogICAgZG93bmxvYWRCb3RzID0gZ2V0Qm90cyhiID0+ICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOwoKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgIH0KCiAgICBpZiAobG9nKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGluc3QnKTsKICAgIH0KfSBlbHNlIHsKICAgIGlmIChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykpIHsKICAgICAgICAvLyBEb3dubG9hZCBib3RzLgogICAgICAgIGRvd25sb2FkQm90cyA9IHBvc3NpYmxlQm90czsKICAgICAgICBjb25zdCBib3RJZHMgPSBwb3NzaWJsZUJvdHMubWFwKGIgPT4gYi5pZCkuc29ydCgpOwogICAgICAgIGxldCBib3RJZHNTSEExID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90SWRzKTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtib3RJZHNTSEExLnN1YnN0cmluZygwLCA3KX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9nKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGBkb3dubG9hZCAke2Rvd25sb2FkQm90cy5sZW5ndGh9IGJvdHNgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGJvdC4KICAgICAgICBkb3dubG9hZEJvdHMgPSBbcG9zc2libGVCb3RzXTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtwb3NzaWJsZUJvdHMuaWQuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGJvdCcpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpIHsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9Cgpjb25zdCBzdGF0ZSA9IHt9OwoKLy8gRm9ybWF0IGJvdHMgZm9yIGZpbGUgc3RvcmFnZQpmb3IgKGxldCBpID0gMDsgaSA8IGRvd25sb2FkQm90cy5sZW5ndGg7IGkrKykgewogICAgbGV0IGN1cnJlbnRCb3RJRCA9IGRvd25sb2FkQm90c1tpXS5pZDsKICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZG93bmxvYWRCb3RzW2ldKSk7CgogICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwp9CgppZiAoIWZpbGVuYW1lLmVuZHNXaXRoKCcuYXV4JykpIHsKICAgIGZpbGVuYW1lICs9ICcuYXV4JzsKfQoKLy8gRG8gYSBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmNvbnN0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBmaWxlbmFtZSwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQocHJlcHJvY2Vzc0FyZyk7Cn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vIERvd25sb2FkIGFzIHYxIGF1eCBmaWxlLgpjb25zdCBhdXhGaWxlID0geyB2ZXJzaW9uOiAxLCBzdGF0ZSB9Owpvcy5kb3dubG9hZChhdXhGaWxlLCBmaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgppZiAocmVvcGVuQWJNZW51KSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfScA/+GZtQKhkAINbWFuaWZlc3RhdGlvbgIEAP/hmbUCkZgEKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAP/hmbUCoZACBG1lbnUCBAD/4Zm1AriYBCjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwD/4Zm1AqGQAhJhYlByZXZpb3VzRWdnQ2hlY2sCBAD/4Zm1At+YBIARQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0Py5hYklEOwpjb25zdCByZWNvcmRLZXlPck5hbWUgPSB0aGF0Py5yZWNvcmRLZXlPck5hbWUgPz8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQ7Cgphc3NlcnQodHlwZW9mIGFiSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyYCk7CmFzc2VydCh0eXBlb2YgcmVjb3JkS2V5T3JOYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXlPck5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBlZ2dIaXN0b3J5OwpsZXQgZWdnSUQ7CmxldCB0YXJnZXRWZXJzaW9uTnVtOwpsZXQgbGFzdEhhc2g7CmxldCBtYXhWZXJzaW9uTnVtOwpsZXQgc3RhYmxlVmVyc2lvbjsKbGV0IGZlZWRiYWNrVmVyc2lvbjsKbGV0IHByZXZpb3VzWFA7CmxldCByZWNvcmRMb29rdXAgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleU9yTmFtZSwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycA/+GZtQKhkAIPYWJCb3RNZW51QWN0aW9uAgQA/+GZtQLgqQRNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAP/hmbUCoZACDmFiQm90TWVudUxhYmVsAgQA/+GZtQKuqgQFc2hhcmUnAP/hmbUCoZACDWFiQm90TWVudUljb24CBAD/4Zm1ArSqBAlpb3Nfc2hhcmUnAP/hmbUCoZACEmFiQm90TWVudVNvcnRPcmRlcgIEAP/hmbUCvqoEAzMuNScA/+GZtQKhkAIFbGVhcm4CBAD/4Zm1AsKqBCjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwD/4Zm1AqGQAgthYlFSUHVibGlzaAIEAP/hmbUC6aoE4QFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0LCBzb3VyY2VFdmVudDogJ3FyX3B1Ymxpc2gnfSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAP/hmbUCoZACBnNlYXJjaAIEAP/hmbUCy6wEKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAP/hmbUCoZACB2FiU2hlbGwCBAD/4Zm1AvKsBAR0cnVlJwD/4Zm1AqGQAgxzdHVkaW9TZWxlY3QCBAD/4Zm1AvesBIULQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwD/4Zm1AqGQAg5hYlB1Ymxpc2hBc2tJRAIEAP/hmbUC+7cE3xVAaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgbWVudURpbWVuc2lvbiA9IHRoYXQubWVudURpbWVuc2lvbiA/PyBjb25maWdCb3QudGFncy5tZW51UG9ydGFsOwpsZXQgcHJvZ3Jlc3NCdXR0b247CgppZiAobWVudURpbWVuc2lvbikgewogICAgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBbbWVudURpbWVuc2lvbl06IHRydWUsIGxhYmVsOiBgcHVibGlzaGluZyAke3RoYXQuYXNrSUR9YCB9KTsKfQoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmNvbnN0IHBhdHRlcm5JRCA9IHRoYXQucGF0dGVybklEOwpjb25zdCBzdHVkaW9JRCA9IHRoYXQuc3R1ZGlvSUQgPyB0aGF0LnN0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKY29uc3QgbWFya2VyU2V0ID0gdGhhdC5tYXJrZXJTZXQgPz8gbmV3IFNldCgpOwpjb25zdCB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdHJ1ZTsKCmFzc2VydChtYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CgptYXJrZXJTZXQuYWRkKCdwdWJsaWNSZWFkJyk7Cm1hcmtlclNldC5hZGQoJ2FiQXNrJyk7CgovLyBbUnlhbiBDb29rXSBIQUNLOiBUaGVyZSBhcmUgaXNzdWVzIHdpdGggY3VzdG9tIG1hcmtlcnMuIENsZWFyIGFsbCBvZiB0aGUgZXhjZXB0IGZvciBwdWJsaWNSZWFkLgptYXJrZXJTZXQuY2xlYXIoKTsKbWFya2VyU2V0LmFkZCgncHVibGljUmVhZCcpOwoKLy8gQ2hlY2sgdG8gc2VlIGlmIHRoaXMgYXNrSUQgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBDYXN1YWwgY2F0YWxvZyBhc2tzIGFsd2F5cyBvdmVycmlkZSBhYiBhc2tzIGFuZCBzbyB1c2VyJ3Mgc2hvdWxkIGJlIGF3YXJlLgpjb25zdCBleGlzdHNJbkNhc3VhbENhdGFsb2cgPSBhd2FpdCBhYi5saW5rcy5zZWFyY2guYWJDYXN1YWxDYXRhbG9nQXNrSURFeGlzdHMoeyBhc2tJRDogdGhhdC5hc2tJRCB9KTsKCmlmICghZXhpc3RzSW5DYXN1YWxDYXRhbG9nKSB7CiAgICBjb25zdCBwdWJsaXNoQXNrID0gYXdhaXQgb3MucmVjb3JkRGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwgeyBwYXR0ZXJuSUQ6IHBhdHRlcm5JRCwgc3R1ZGlvSUQ6IHN0dWRpb0lEIH0sIHsgZW5kcG9pbnQ6IGVuZHBvaW50LCB1cGRhdGVQb2xpY3k6IFthdXRoQm90LmlkXSwgbWFya2VyczogbWFya2VyU2V0LnNpemUgPiAwID8gQXJyYXkuZnJvbShtYXJrZXJTZXQpIDogdW5kZWZpbmVkIH0pOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwdWJsaXNoQXNrIHJlc3VsdDpgLCBwdWJsaXNoQXNrKTsKICAgIH0KCiAgICBpZiAocHVibGlzaEFzay5zdWNjZXNzKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gcHVibGlzaGVkIHRvIGFiIHJlY29yZC5gLCBsb2dUeXBlOiAnbG9nJyB9KTsKCiAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gcHVibGlzaGVkLmAsIGxvZ1R5cGU6ICdsb2cnIH0pOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gZmFpbGVkIHRvIHB1Ymxpc2ggdG8gYWIgcmVjb3JkLlxuJHtKU09OLnN0cmluZ2lmeShwdWJsaXNoQXNrLCB1bmRlZmluZWQsIDIpfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CgogICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYGZhaWxlZCB0byBwdWJsaXNoIGFzayAke3RoYXQuYXNrSUR9LiAke3B1Ymxpc2hBc2suZXJyb3JNZXNzYWdlfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQoKICAgIHJldHVybiBwdWJsaXNoQXNrOwp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBhc2tJRCAnJHt0aGF0LmFza0lEfScgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBQbGVhc2UgY2hvb3NlIGEgZGlmZmVyZW50IG5hbWUuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKCiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KICAgIAogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBpbiB0aGUgc2hhcGUgb2YgUmVjb3JkRGF0YUZhaWx1cmUuCiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIGVycm9yQ29kZTogJ2Fza2lkX2V4aXN0c19jYXN1YWxfY2F0YWxvZycsCiAgICAgICAgZXJyb3JNZXNzYWdlOiBgQ2FzdWFsIGNhdGFsb2cgYWxyZWFkeSBjb250YWlucyB0aGUgYXNrSUQgJyR7YXNrSUR9J2AKICAgIH0KfScA/+GZtQKhkAIFaW5wdXQCBAD/4Zm1AtvNBCjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwD/4Zm1AqGQAgthYkVtYmVkTGluawIEAP/hmbUCgs4EpANAY29uc3QgYWIgPSB0aGF0ID8gdHJ1ZSA6IGZhbHNlOwpjb25zdCBlbWJlZExpbmsgPSBhYiA/ICJhYj0iICsgdGhhdCA6ICJpbnN0PSIgKyBjb25maWdCb3QudGFncy5pbnN0Owpjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKY29uc3QgZW1iZWRUZXh0ID0gYDwhRE9DVFlQRSBodG1sPgrCoMKgwqDCoDxodG1sPgrCoMKgwqDCoMKgwqDCoMKgPGhlYWQ+PC9oZWFkPgrCoMKgwqDCoMKgwqDCoMKgPGJvZHk+CsKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoDxpZnJhbWUgc3JjPSIke3NpdGVPcmlnaW4gKyAiLz8iICsgZW1iZWRMaW5rfSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iNDAwIiAvPgrCoMKgwqDCoMKgwqDCoMKgPC9ib2R5PgrCoMKgwqDCoDwvaHRtbD5gOwoKcmV0dXJuIGVtYmVkVGV4dDsnAP/hmbUCoZACD2FiUGF0dGVyblVwZGF0ZQIEAP/hmbUC+9AEpQVALy9zaG91dCgiYWJQYXR0ZXJuVXBkYXRlIiwge2FiSUQ6IGFiSUQsIHN0dWRpbzpzdHVkaW8/LCBib3RzOiBib3RzP30pOwphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKaWYgKCFhdXRoQm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8gdGhhdC5zdHVkaW8gOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBhYk1hbmlmZXN0ID0gZ2V0Qm90KGJ5TW9kKHthYkVnZzogdHJ1ZSwgb3JpZ2luX2FiOiBhYklEfSkpOwoKaWYgKCFhYk1hbmlmZXN0KQp7CiAgICBzaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGF1dG9IYXRjaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdwYXR0ZXJuX3VwZGF0ZSd9KTsKCiAgICByZXR1cm47Cn0KCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gc3R1ZGlvOwoKY29uc3QgYWJCb3RzID0gdGhhdC5ib3RzID8/IGdldEJvdHMoImFiSURPcmlnaW4iLCBhYklEKTsKCmF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBhYklELCB0YXJnZXQ6IGFiQm90cywgcHVibGljRmFjaW5nOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm5fdXBkYXRlJ30pOycA/+GZtQKhkAIXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBAD/4Zm1AqHWBE1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycA/+GZtQKhkAIaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBAD/4Zm1Au/WBAEyJwD/4Zm1AqGQAhVhYk11bHRpcGxlQm90TWVudUljb24CBAD/4Zm1AvHWBAlpb3Nfc2hhcmUnAP/hmbUCoZACFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBAD/4Zm1AvvWBAVzaGFyZScA/+GZtQKhkAIPYWJQdWJsaXNoU2VsZWN0AgQA/+GZtQKB1wSkE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IHRhZ3MubGFiZWwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vblBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwD/4Zm1AqGQAglhYlZlcnNpb24CBAD/4Zm1AqTqBAUxMC4zNycA/+GZtQKhkAILcGVyc29uYWxpdHkCBAD/4Zm1AqrqBCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwD/4Zm1AqGQAgV1dGlscwIEAP/hmbUC0eoEKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAP/hmbUCoZACDmNhblB1Ymxpc2hGaWxlAgQA/+GZtQL46gT+A0BpZiAoZ2xvYmFsVGhpcy5hYikgewogICAgaWYgKGF1dGhCb3QpIHsKICAgICAgICBpZiAoYWIubGlua3MucmVtZW1iZXIudGFncy5zdWJzY3JpcHRpb25zRW5hYmxlZCkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciAhPT0gJ0ZyZWVQbGF5JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9IGVsc2UgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdhaXQgZm9yIGFiIHRvIGZpbmlzaCBib290aW5nIGJlZm9yZSBxdWVyeWluZyAke3RhZ05hbWV9LmApCiAgICByZXR1cm4gbnVsbDsKfScA/+GZtQKhkAIFZGVidWcCBAD/4Zm1AvfuBAR0cnVlJwEEYm90cyQ3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcBJwD/4Zm1AvzuBBVhYkZpbmRBcnRpZmFjdEJ1bmRsZXMCBAD/4Zm1Av3uBJMGQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmNvbnN0IGFydGlmYWN0QnVuZGxlczogUmVjb3JkPHN0cmluZywgQUJBcnRpZmFjdEJ1bmRsZT4gPSB7fTsgLy8gS2V5IGlzIGFydGlmYWN0IGlkCgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGIudGFncy5hYkFydGlmYWN0QnVuZGxlKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGIudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEICYmIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICE9PSBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYXJ0aWZhY3RJZCA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlLmlkOwoKICAgICAgICBpZiAoYXJ0aWZhY3RJZCAmJiAhYXJ0aWZhY3RCdW5kbGVzW2FydGlmYWN0SWRdKSB7CiAgICAgICAgICAgIGFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIH0KICAgIH0KfSk7CgpyZXR1cm4gYXJ0aWZhY3RCdW5kbGVzOycA/+GZtQL87gQFc3RvcmUCBAD/4Zm1ApH1BCjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwD/4Zm1AvzuBAZzeXN0ZW0CBAD/4Zm1Arj1BBFhYi5zaGVsbC5hcnRpZmFjdCcA/+GZtQL87gQIYWJJZ25vcmUCBAD/4Zm1Asr1BAR0cnVlJwD/4Zm1AvzuBAlhYlZlcnNpb24CBAD/4Zm1As/1BAUxMC4zNycA/+GZtQL87gQFZGVidWcCBAD/4Zm1AtX1BAVmYWxzZScA/+GZtQL87gQjYWJDaGVja0FydGlmYWN0UmVjb25zdGl0dXRpb25BdFJlc3QCBAD/4Zm1Atv1BLMGQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNoZWNraW5nLi4uYCk7Cn0KCi8vIENsZWFyIGFueSBjdXJyZW50bHkgcnVubmluZyAiYXQgcmVzdCIgY2hlY2suCmlmIChtYXNrcy5hdFJlc3RUaW1lb3V0SWQpIHsKICAgIGNsZWFyVGltZW91dChtYXNrcy5hdFJlc3RUaW1lb3V0SWQpOwogICAgbWFza3MuYXRSZXN0VGltZW91dElkID0gbnVsbDsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2xlYXJlZCBwcmV2aW91cyAiYXQgcmVzdCIgY2hlY2suYCk7CiAgICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNoZWNrKCkgewogICAgY29uc3QgcmVjb25zdGl0dXRpbmdTaWduYWxCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RTaWduYWxCb3QpOwoKICAgIGlmIChyZWNvbnN0aXR1dGluZ1NpZ25hbEJvdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdCByZWNvbnNpdGl0dXRpb24gaXMgYXQgcmVzdGApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBzaG91dCgnb25BQkFydGlmYWN0UmVjb25zdGl0dXRpb25BdFJlc3QnKTsKICAgIH0KCiAgICBtYXNrcy5hdFJlc3RUaW1lb3V0SWQgPSBudWxsOwp9CgptYXNrcy5hdFJlc3RUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGNoZWNrLCB0YWdzLmNoZWNrQXRSZXN0V2FpdE1TKTsKJwD/4Zm1AvzuBAhyZW1lbWJlcgIEAP/hmbUCj/wEKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAP/hmbUC/O4EE2FiQ3JlYXRlQXJ0aWZhY3RCb3QCBAD/4Zm1Arb8BN4TQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLAogICAgZGltZW5zaW9uID0gbGlua3MubGVhcm4udGFncy5hYkluc3QgPz8gJ2hvbWUnLAogICAgcG9zaXRpb24gPSBuZXcgVmVjdG9yMygwLCAwLCAwKSwKICAgIG90aGVyVGFncyA9IHt9LAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0Qm90ID0gY3JlYXRlKHsKICAgIHNwYWNlOiAnc2hhcmVkJywKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgIGFiQXJ0aWZhY3RCb3Q6IHRydWUsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtgJHtkaW1lbnNpb259WGBdOiBwb3NpdGlvbi54LAogICAgW2Ake2RpbWVuc2lvbn1ZYF06IHBvc2l0aW9uLnksCiAgICBbYCR7ZGltZW5zaW9ufVpgXTogcG9zaXRpb24ueiwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBsYWJlbENvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIHN0cm9rZUNvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIG9uQm90QWRkZWQ6IGBACiAgICAgICAgdGhpc0JvdC51cGRhdGVDb21wdXRlZFRhZ3MoKTsKICAgIGAsCiAgICBvbkJvdENoYW5nZWQ6IGBACiAgICAgICAgY29uc3QgY2hhbmdlZFRhZ3MgPSB0aGF0LnRhZ3M7CgogICAgICAgIGlmIChjaGFuZ2VkVGFncy5zb21lKHQgPT4gdCA9PT0gJ2FiQXJ0aWZhY3RJbnN0YW5jZUlEJyB8fCB0ID09PSAnYWJBcnRpZmFjdE5hbWUnKSkgewogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZUNvbXB1dGVkVGFncygpOwogICAgICAgIH0KICAgIGAsCiAgICB1cGRhdGVDb21wdXRlZFRhZ3M6IGBACiAgICAgICAgbGV0IHN5c3RlbSA9ICdhYkFydGlmYWN0Qm90JzsKCiAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgc3lzdGVtICs9ICcuJyArIHRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRC5zdWJzdHJpbmcoMCwgNyk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9ICEhc3lzdGVtID8gc3lzdGVtIDogbnVsbDsKICAgICAgICB0YWdzLmxhYmVsID0gdGFncy5zeXN0ZW07CiAgICBgLAogICAgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlOiBgQAogICAgICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnbGFiZWwnLCAnICcsICdzaGFyZWQnKTsKICAgIGAsCiAgICAuLi5vdGhlclRhZ3MsCn0pOwoKdHJ5IHsKICAgIC8vIFVwZGF0ZSBhbGwgdGhlIHNoYXJkcyBmb3IgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZSAtLSB3aGljaCBub3cgaW5jbHVkZXMgdGhpcyBib3QhCiAgICBjb25zdCB1cGRhdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwoKICAgIGlmICghdXBkYXRlUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byB1cGRhdGUgJyR7YWJBcnRpZmFjdE5hbWV9JyBhcnRpZmFjdCBzaGFyZHMuYCk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaHQgZXJyb3Igd2hpbGUgdXBkYXRlIGFydGlmYWN0IHNoYXJkczpgLCBlKTsKICAgIGRlc3Ryb3koYWJBcnRpZmFjdEJvdCk7CiAgICByZXR1cm4gbnVsbDsKfQoKcmV0dXJuIGFiQXJ0aWZhY3RCb3Q7JwD/4Zm1AvzuBBZhYkFydGlmYWN0UmVjb25zdGl0dXRlAgQA/+GZtQKVkAWkP0BpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKYXNzZXJ0KHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmcgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuYCk7Cgpjb25zdCB7CiAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBhdXRoQm90Py5pZCA/PyBhYi5saW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwKICAgIGVnZ1BhcmFtZXRlcnMsIC8vIEVnZyBwYXJhbXRlcnMgdGhhdCB5b3Ugd291bGQgbGlrZSB0byBoYXZlIHBhc3NlZCB0byB0aGUgcmVjb25zaXR1dGVkIGJvdHMgKG9wdGlvbmFsKS4KICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgYXMgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgQUJBcnRpZmFjdEJ1bmRsZS5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCB0byBiZSBvZiB0eXBlIHN0cmluZy5gKTsKCi8vIENyZWF0ZSBhIHRlbXBTaGFyZWQgYm90IHRoYXQgYWN0cyBhcyBhIHNpZ25hbCB0byBldmVyeW9uZSB0aGF0IHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaXMgaW4gdGhlIHByb2Nlc3Mgb2YgYmVpbmcgcmVjb25zdGl0dXRlZC4KY29uc3QgcmVjb25zdGl0dXRpbmdTaWduYWxCb3QgPSBjcmVhdGUoewogICAgc3BhY2U6ICd0ZW1wU2hhcmVkJywKICAgIGFiQm90OiB0cnVlLAogICAgYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0U2lnbmFsQm90OiB0cnVlLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIGNyZWF0ZWRUaW1lOiBvcy5pc0NvbGxhYm9yYXRpdmUoKSA/IG9zLmFncmVlZFVwb25UaW1lIDogb3MubG9jYWxUaW1lLCAvLyBUaGUgdGltZSB0aGlzIHNpZ25hbCBib3Qgd2FzIGNyZWF0ZWQuCiAgICBhYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RJbnN0YW5jZUlEOiBhYkFydGlmYWN0SW5zdGFuY2VJRCwgLy8gVGhlIGluc3RhbmNlIGlkIG9mIHRoZSBhcnRpZmFjdCBiZWluZyByZWNvbnN0aXR1dGVkLgogICAgYWJSZWNvbnN0aXR1dGlvbkJ5UmVtb3RlSWQ6IGNvbmZpZ0JvdC5pZCwgLy8gVGhlIHJlbW90ZSBpZCBvZiB0aGUgdXNlciBwZXJmb3JtaW5nIHRoZSByZWNvbnNpdHV0aW9uLgogICAgYWJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzogJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkodGhhdCksIC8vIEEgY29weSBvZiB0aGUgcmVjb25zdGl0dXRlIGFyZyBvYmplY3QgZm9yIHRoaXMgZnVuY3Rpb24gaW4gY2FzZSBpdCdzIG5lZWRlZC4KICAgIG9uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCB7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0gPSB0aGF0OwoKICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IHRhZ3MuYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0SW5zdGFuY2VJRCAmJiB0aGlzQm90LnNwYWNlICE9PSAncmVtb3RlVGVtcFNoYXJlZCcpIHsKICAgICAgICAgICAgaWYgKGxpbmtzLm1hbmFnZXIudGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFthYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RTaWduYWxCb3RdIGRlc3Ryb3lpbmcgc2VsZiBiZWNhdXNlIGFydGlmYWN0IGluc3RhbmNlIGlkICR7dGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RJbnN0YW5jZUlEfSBoYXMgcmVjb25zdGl0dXRlZC5gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3QgeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9ID0gdGhhdDsKCiAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSB0YWdzLmFiUmVjb25zdGl0dXRpbmdBcnRpZmFjdEluc3RhbmNlSUQgJiYgdGhpc0JvdC5zcGFjZSAhPT0gJ3JlbW90ZVRlbXBTaGFyZWQnKSB7CiAgICAgICAgICAgIGlmIChsaW5rcy5tYW5hZ2VyLnRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0U2lnbmFsQm90XSBkZXN0cm95aW5nIHNlbGYgYmVjYXVzZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCAke3RhZ3MuYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0SW5zdGFuY2VJRH0gZmFpbGVkIHRvIHJlY29uc3RpdHV0ZS5gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICB9CiAgICB9KQp9KTsKCnRyeSB7CgogICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZVN0cmluZyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwogICAgY29uc3Qgc2hhcmRCb3RzID0gW107CgogICAgZnVuY3Rpb24gaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSh7IGJvdERhdGEgfSkgewogICAgICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZDsgLy8gSWYgdGhlIHNoYXJkIGJvdCBoYXMgaXRzZWxmIG1hcmtlZCBhcyByZWNvbnN0aXR1dGVkIGFscmVhZHkgKHBvc3NpYmx5IGR1ZSB0byBhbiBvdmVyc2lnaHQpLCB0aGVuIHJlbW92ZSBpdCEKCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJ1bmRsZVN0cmluZzsgLy8gQXNzaWduIHRoZSBhcnRpZmFjdCBidW5kbGUgYmFjayB0byB0aGUgaGF0Y2hlZCBzaGFyZCBib3QuCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOyAvLyBVVUlEIG9mIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSB0aGF0IHRoaXMgYm90IGJlbG9uZ3MgdG8uCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOyAvLyBUaGUgdXNlciBpZCB0aGUgb3duZXIgb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7IC8vIFVVSUQgYXNzaWduZWQgdG8gdGhlIGJvdCBieSB0aGUgYXJ0aWZhY3Qgd2hlbiBsb2FkZWQuCiAgICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcykgewogICAgICAgIGNvbnN0IGRlcGVuZGVuY3lCb3RzID0gW107CgogICAgICAgIGlmICh0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgICAgICBjb25zdCBlZ2dEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeTsKCiAgICAgICAgICAgIC8vIEZpcnN0IHRyeSB0byBsb2FkIGZyb20gZWdnLgogICAgICAgICAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgICAgICAgICAgYWJJRDogZWdnRGVwZW5kZW5jeS5hYklELAogICAgICAgICAgICAgICAgcmVjb3JkS2V5OiBlZ2dEZXBlbmRlbmN5LnJlY29yZEtleSwKICAgICAgICAgICAgICAgIGFiVmVyc2lvbjogZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24sCiAgICAgICAgICAgICAgICBhdXRvSGF0Y2g6IHRydWUsCiAgICAgICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlCiAgICAgICAgICAgIH0pCgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gJHtlZ2dEZXBlbmRlbmN5LmFiSUR9IGxvb2t1cEVnZ1Jlc3VsdDpgLCBsb29rdXBFZ2dSZXN1bHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobG9va3VwRWdnUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBsb2FkZWQgZGVwZW5kZW5jeSBhYklEOiAke2VnZ0RlcGVuZGVuY3kuYWJJRH0sIGFiVmVyc2lvbjogJHtlZ2dEZXBlbmRlbmN5LmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhhdGNoZWRCb3Qgb2YgbG9va3VwRWdnUmVzdWx0LmhhdGNoZWRCb3RzKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeUJvdHMucHVzaChoYXRjaGVkQm90KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA9PT0gMCAmJiB0aGlzQm90LmlzQXNrRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgICAgICBjb25zdCBhc2tEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0QXNrRGVwZW5kZW5jeTsKCiAgICAgICAgICAgIC8vIFRyeSB0byBsb2FkIGZyb20gYXNrLgogICAgICAgICAgICBjb25zdCBsb29rdXBBc2tSZXN1bHQ6IEFCTG9va3VwQXNrSURSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBc2tJRCh7CiAgICAgICAgICAgICAgICBhc2tJRDogYXNrRGVwZW5kZW5jeS5hc2tJRCwKICAgICAgICAgICAgICAgIHNob3dJbmRpY2F0b3I6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICAgICAgaWdub3JlUmVzZXJ2ZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlCiAgICAgICAgICAgIH0pCgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2tSZXN1bHQ6YCwgbG9va3VwQXNrUmVzdWx0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxvb2t1cEFza1Jlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhhdGNoZWRCb3Qgb2YgbG9va3VwQXNrUmVzdWx0LmhhdGNoZWRCb3RzKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeUJvdHMucHVzaChoYXRjaGVkQm90KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZm9yIChjb25zdCBzaGFyZEJvdCBvZiBkZXBlbmRlbmN5Qm90cykgewogICAgICAgICAgICAgICAgc2hhcmRCb3RzLnB1c2goc2hhcmRCb3QpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9IGZhaWxlZCB0byBsb2FkIGRlcGVuZGVuY3k6ICR7SlNPTi5zdHJpbmdpZnkoZGVwZW5kZW5jeSl9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICB9CiAgICB9CgoKICAgIGlmIChzaGFyZEJvdHMubGVuZ3RoID4gMCkgewogICAgICAgIC8vIFRlbGwgYWxsIGhhdGNoZWQgc2hhcmQgYm90cyB0byByZWNvbnN0aXR1dGUuIFRoZXkgYWxsIGhhdmUgY29waWVzIG9mIHRoZSBhYkFydGlmYWN0QnVuZGxlIGFuZCBjYW4gcmVjb25zdGl0dXRlIHRoZW1zZWx2ZXMgZnJvbSB0aGF0LgogICAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKHNoYXJkQm90cywgJ29uQUJBcnRpZmFjdFJlY29uc3RpdHV0ZScsIHsgZGF0YTogYWJBcnRpZmFjdEJ1bmRsZS5kYXRhIH0pKTsKCiAgICAgICAgZm9yIChsZXQgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOyAvLyBUaGlzIGJvdCBoYXMgYmVlbiByZWNvbnN0aXR1dGVkIGluIHRoaXMgaW5zdC4KICAgICAgICB9CgogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwoKICAgICAgICBjb25zdCByZWNvbnN0aXR1dGlvblJlc3VsdCA9IHsKICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICBzaGFyZEJvdHMsCiAgICAgICAgfTsKCiAgICAgICAgd2hpc3BlcihzaGFyZEJvdHMsICdvblJlY29uc3RpdHV0ZWQnLCByZWNvbnN0aXR1dGlvblJlc3VsdCk7CiAgICAgICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCByZWNvbnN0aXR1dGlvblJlc3VsdCk7CgogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfScgKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgZmluaXNoZWQgcmVjb25zdGl0dXRpb24uYCwgdG9hc3Q6IHRvYXN0IH0pOwoKICAgICAgICByZXR1cm4gcmVjb25zdGl0dXRpb25SZXN1bHQ7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGZhaWx1cmVSZXN1bHQgPSB7CiAgICAgICAgICAgIGVycm9yQ29kZTogJ25vX3NoYXJkX2JvdHMnLAogICAgICAgICAgICBlcnJvck1lc3NhZ2U6ICdSZWNvbnN0aXR1dGlvbiByZXN1bHRzIGluIG5vIHNoYXJkIGJvdHMuJywKICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgIH07CgogICAgICAgIHNob3V0KCdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGZhaWx1cmVSZXN1bHQpOwoKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZhaWxlZCByZWNvbnN0aXR1dGlvbi5gLCB0b2FzdDogdG9hc3QgfSk7CgogICAgICAgIHJldHVybiBmYWlsdXJlUmVzdWx0OwogICAgfQoKfSBmaW5hbGx5IHsKICAgIGRlc3Ryb3kocmVjb25zdGl0dXRpbmdTaWduYWxCb3QpOwp9CicA/+GZtQL87gQXYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24CBAD/4Zm1ArbPBQExJwD/4Zm1AvzuBAZzZWFyY2gCBAD/4Zm1ArjPBSjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwD/4Zm1AvzuBAdhYlNoZWxsAgQA/+GZtQLfzwUEdHJ1ZScA/+GZtQL87gQFdXRpbHMCBAD/4Zm1AuTPBSjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwD/4Zm1AvzuBA9vbkFueUJvdENsaWNrZWQCBAD/4Zm1AovQBYEBQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGJvdCB9KQp9JwD/4Zm1AvzuBBZhYlVwZGF0ZUFydGlmYWN0U2hhcmRzAgQA/+GZtQKN0QWyHEBjb25zdCBhYkFydGlmYWN0TmFtZSA9IHRoYXQuYWJBcnRpZmFjdE5hbWU7CmxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CmxldCBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IHRoYXQuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPz8gYXV0aEJvdD8uaWQgPz8gYWIubGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWU7Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgppZiAoc2hhcmRCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBUaGVyZSBhcmUgbm8gc2hhcmRzIGZvciBhcnRpZmFjdCBuYW1lICcke2FiQXJ0aWZhY3ROYW1lfScuYCwgbG9nVHlwZTogJ3dhcm4nIH0pOwogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQoKY29uc3QgcHJldkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gc2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKY29uc3QgcHJldkFydGlmYWN0SUQgPSBwcmV2QXJ0aWZhY3RCdW5kbGUgPyBwcmV2QXJ0aWZhY3RCdW5kbGUuaWQgOiBudWxsOwpjb25zdCBwcmV2QXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gc2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CgpsZXQgY29sbGVjdFNoYXJkUmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdDsKCnRyeSB7CiAgICBjb2xsZWN0U2hhcmRSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiQ29sbGVjdEFydGlmYWN0U2hhcmRzKHsgc2hhcmRCb3RzIH0pOwoKICAgIGlmICghY29sbGVjdFNoYXJkUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogY29sbGVjdFNoYXJkUmVzdWx0LnJlYXNvbiwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICB9Cn0gY2F0Y2goZSkgewogICAgY29uc29sZS5lcnJvcihlKTsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgU29tZXRoaW5nIHdlbnQgd3JvbmcgY29sbGVjdGluZyBzaGFyZHMuIFNlZSBjb25zb2xlIGZvciBtb3JlIGRldGFpbHMuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH0KfQoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHRoaXNCb3QuYWJDcmVhdGVBcnRpZmFjdEJ1bmRsZSh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0U2hhcmQ6IGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZCB9KTsKCmlmIChwcmV2QXJ0aWZhY3RJRCAmJiBwcmV2QXJ0aWZhY3RJRCAhPT0gYWJBcnRpZmFjdEJ1bmRsZS5pZCkgewogICAgLy8gVGhlIGFydGlmYWN0IGhhcyBhIG5ldyBpZC4gQWxsIG9mIHRoZSBzaGFyZCBib3RzIG5lZWQgYSBuZXcgaW5zdGFuY2UgaWQgYXMgd2VsbC4KICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwoKICAgIGZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZpbmFsIG1lcmdlZCBhcnRpZmFjdCAke2FiQXJ0aWZhY3ROYW1lfTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKLy8gRXZlcnkgc2hhcmQgYm90IGdldHMgYSBjb3B5IG9mIHRoZSBhcnRpZmFjdCBidW5kbGUuCi8vIFRoaXMgbWFrZXMgdGhlIGFydGlmYWN0IGhvbG9ncmFwaGljIGJ5IG5hdHVyZS4gVGhpcyBtZWFucyB0aGF0IGFueSBzaGFyZCBjYW4gYmUgdXNlZCB0byByZWNvbnN0aXR1dGUgdGhlIHdob2xlLgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgLy8gTWFyayBlYWNoIHNoYXJkIGJvdCBhcyBiZWluZyAncmVjb25zdGl0dXRlZCcgd2hlbiB3ZSB1cGRhdGUgdGhlIGFydGlmYWN0LgogICAgLy8gQmVjYXVzZSB0aGlzIGlzIGEgc2hhcmVkIHRhZyBtYXNrLCBpdCB3aWxsIG9ubHkgYmUgdHJ1ZSBpbiB0aGUgY3VycmVudCBpbnN0LgogICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7CiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGUgPSAgJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoYWJBcnRpZmFjdEJ1bmRsZSk7CgogICAgLy8gSWYgdGhlIHNoYXJkQm90IGhhc250IGJlZW4gbWFya2VkIGFzIGhhdmluZyBhbiBpbnN0YW5jZSBvd25lciBPUiBpdHMgb3duZXIgZG9lc250IG1hdGNoIHRoZSBvbmUgYmVpbmcgcHJvdmlkZWQgdG8KICAgIC8vIHRoaXMgdXBkYXRlIGZ1bmN0aW9uIHRoZW4gd2UgY2hhbmdlIGl0LgogICAgaWYgKCFzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIHx8IHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgIT09IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyKSB7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgfQp9CgovLyBSeWFuIENvb2s6IE5lZWQgdG8gZ2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byBjYXRjaHVwLgovLyBGb3VuZCB0aGF0IGlmIHdlIGRpZG50IGRvIHRoaXMsIG1vZCB0YWdzIHdvdWxkIG5vdCBiZSByZXR1cm5lZCBhcyBKU09OIG9iamVjdHMgYnV0IGluc3RlYWQgdGhlIHJhdyBzdHJpbmcuCmF3YWl0IG9zLnNsZWVwKDApOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRlZCBhcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nLiBDb3BpZWQgYXJ0aWZhY3QgYnVuZGxlIHRvICR7c2hhcmRCb3RzLmxlbmd0aH0gYm90cy4gYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKc2hvdXQoJ29uQW55QUJBcnRpZmFjdFNoYXJkc1VwZGF0ZWQnLCB7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsIGFiQXJ0aWZhY3RCdW5kbGUsIHNoYXJkQm90cyB9KQoKLy8gU2hhcmQgdXBkYXRlIHN1Y2Nlc3NmdWwuCnJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTsnAP/hmbUC/O4EBG1lbnUCBAD/4Zm1Ar7tBSjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwD/4Zm1AvzuBAVsZWFybgIEAP/hmbUC5e0FKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAP/hmbUC/O4EC29uR3JpZENsaWNrAgQA/+GZtQKM7gVGQGlmIChsaW5rcy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfScA/+GZtQL87gQaYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQCBAD/4Zm1AtPuBQcjQUVBMUZGJwD/4Zm1AvzuBBthYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQCBAD/4Zm1AtvuBQcjMWUxYjJkJwD/4Zm1AvzuBBBvbkFueUJvdHNSZW1vdmVkAgQA/+GZtQLj7gWMBEBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsKCmlmIChtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgJiYgYm90SURzLmluY2x1ZGVzKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCkpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwp9Cgpmb3IgKGxldCBib3RJRCBvZiBib3RJRHMpIHsKICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMucmVjb25zdGl0dXRpbmdTaWduYWxCb3RJZHMuZGVsZXRlKGJvdElEKTsKCiAgICBpZiAoZGVsZXRlZCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGV0ZWN0ZWQgcmVtb3ZlZCByZWNvbnN0aXR1dGlvbiBzaWduYWwgYm90LCB3aWxsIG5vdyBiZWdpbiBjaGVjayBpZiByZWNvbnNpdGl0dWlvbiBpcyBhdCByZXN0LmApOwogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC5hYkNoZWNrQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkF0UmVzdCgpOwogICAgfQp9JwD/4Zm1AvzuBAd2ZXJzaW9uAgQA/+GZtQLw8gUo8J+UlzUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZicA/+GZtQL87gQYYWJHZXRBcnRpZmFjdE5hbWVzSW5JbnN0AgQA/+GZtQKX8wWsAUBjb25zdCBhYkFydGlmYWN0TmFtZXMgPSBuZXcgU2V0KCk7CgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWVzLmFkZChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpOwogICAgfQp9KQoKcmV0dXJuIGFiQXJ0aWZhY3ROYW1lczsnAP/hmbUC/O4EFWFiQXJ0aWZhY3RCb3RNZW51T3BlbgIEAP/hmbUCxPQF1RdAY29uc3QgeyBhYkFydGlmYWN0Qm90IH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3RCb3QgJiYgYWJBcnRpZmFjdEJvdC5zcGFjZSAmJiBhYkFydGlmYWN0Qm90LnRhZ3MsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJvdCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQm90LmApOwoKc2hvdXQoImFiQXJ0aWZhY3RCb3RNZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiQXJ0aWZhY3RNZW51IjsKCmlmICghdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwoKbGV0IGluZm9MYWJlbCA9IGBbYXJ0aWZhY3QgbmFtZV06ICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaWRdOiAke2FiQXJ0aWZhY3RCdW5kbGUuaWQuc3Vic3RyaW5nKDAsIDcpfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaW5zdGFuY2UgaWRdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA/PyAndW5zZXQnfSBcbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGluc3RhbmNlIG93bmVyXTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPz8gJ3Vuc2V0J30gXG5gOwppbmZvTGFiZWwgKz0gYFtyZWNvbnN0aXR1dGVkIGluIGluc3RdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkfVxuYDsKaW5mb0xhYmVsICs9IGBbZm9ybWF0XTogdiR7YWJBcnRpZmFjdEJ1bmRsZS5mb3JtYXRWZXJzaW9ufVxuYDsKaW5mb0xhYmVsICs9IGBbY3JlYXRlZCB0aW1lXTogJHtEYXRlVGltZS5mcm9tSVNPKGFiQXJ0aWZhY3RCdW5kbGUuY3JlYXRlZFRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoRGF0ZVRpbWUuREFURVRJTUVfU0hPUlRfV0lUSF9TRUNPTkRTKX1cbmA7CgovLyBIZWFkZXIKY29uc3QgaW5mb0JvdCA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51VGV4dCh7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGxhYmVsOiBpbmZvTGFiZWwsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2goaW5mb0JvdCk7CgovLyBEb3dubG9hZCBzaGFyZCBidXR0b24uCmNvbnN0IGRvd25sb2FkQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgYWJBcnRpZmFjdFRvb2w6IGdldExpbmsodGhpc0JvdCksCiAgICBmb3JtQWRkcmVzczogJ2Rvd25sb2FkJywKICAgIGxhYmVsOiBgZG93bmxvYWQgc2hhcmRgLAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGUgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9ICdhYkFydGlmYWN0LScgKyBhYkFydGlmYWN0QnVuZGxlLm5hbWUgKyAnLScgKyBhYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLDcpICsgJy5hdXgnOyAKICAgICAgICBvcy5kb3dubG9hZEJvdHMoWyBsaW5rcy5hYkFydGlmYWN0Qm90IF0sIGZpbGVuYW1lKTsKICAgICAgICAKICAgICAgICBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGRvd25sb2FkQnV0dG9uKTsKCi8vIFVwZGF0ZSBhcnRpZmFjdCBidXR0b24uCmNvbnN0IHVwZGF0ZUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdzeW5jJywKICAgIGxhYmVsOiBgdXBkYXRlIGFydGlmYWN0YCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBhYkFydGlmYWN0QnVuZGxlLm5hbWU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CiAgICAgICAgCiAgICAgICAgYXdhaXQgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgfSk7CgogICAgICAgIGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGxpbmtzLmFiQXJ0aWZhY3RCb3QgfSk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKHVwZGF0ZUJ1dHRvbik7CgptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBhYkFydGlmYWN0Qm90LmlkOycA/+GZtQL87gQZYWJEb3dubG9hZEFydGlmYWN0UGF0dGVybgIEAP/hmbUCmowGiAVAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzaGFyZEJvdHMsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0TmFtZSA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpICYmIHNoYXJkQm90cy5sZW5ndGggPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyBhIHJlcXVpcmVkIEJvdCBhcnJheSBwYXJhbWV0ZXIuIEl0IG11c3QgaGF2ZSBhdCBsZWFzdCAxIGJvdC5gKTsKCnJldHVybiBsaW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgCiAgICBwb3NzaWJsZUJvdHM6IHNoYXJkQm90cywKICAgIGZpbGVuYW1lOiBgJHthYkFydGlmYWN0TmFtZX1gLAogICAgc291cmNlRXZlbnQ6ICdkb3dubG9hZF9hcnRpZmFjdF9wYXR0ZXJuJywKICAgIHJlb3BlbkFiTWVudTogZmFsc2UsCiAgICBvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZDogYXN5bmMgKGFyZykgPT4gewogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAP/hmbUC/O4EFmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQCBAD/4Zm1AqORBu8BQGlmICh0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyAmJiB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5sZW5ndGggPiAwKSB7CiAgICBkZXN0cm95KHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKTsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gbnVsbDsnAP/hmbUC/O4EBXR5cGVzAgQA/+GZtQKTkwb7CfCfk4RpbnRlcmZhY2UgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZyB7CiAgICBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ/OiBzdHJpbmc7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzPzogc3RyaW5nOwogICAgZWdnUGFyYW1ldGVycz86IGFueTsKICAgIHRvYXN0PzogYm9vbGVhbjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHsKICAgIGFiSUQ6IHN0cmluZzsKICAgIHJlY29yZEtleTogc3RyaW5nOwogICAgYWJWZXJzaW9uPzogbnVtYmVyOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3kgewogICAgYXNrSUQ6IHN0cmluZzsKfQoKdHlwZSBBQkFydGlmYWN0RGVwZW5kZW5jeSA9IEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHwgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgppbnRlcmZhY2UgQUJBcnRpZmFjdEJ1bmRsZSB7CiAgICBpZDogc3RyaW5nOwogICAgbmFtZTogc3RyaW5nOwogICAgZm9ybWF0VmVyc2lvbjogbnVtYmVyOwogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+OwogICAgY2FzdWFsT1NWZXJzaW9uOiBBdXhWZXJzaW9uOwogICAgY3JlYXRlZFRpbWVzdGFtcDogc3RyaW5nOwogICAgYWJTaGVsbFZlcnNpb246IHN0cmluZzsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RTaGFyZCB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+OwogICAgZGVwZW5kZW5jaWVzOiBBcnJheTxBQkFydGlmYWN0RGVwZW5kZW5jeT47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RXhwZXJpZW5jZSB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoIHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmc7CiAgICBhdXRob3JpemVkOiBib29sZWFuOwogICAgZmFpbHVyZVJlYXNvbjogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZVJlYXNvbjsKfQoKdHlwZSBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbicgfCAndXNlcl9kZWNsaW5lZF9pbnN0X3Blcm1pc3Npb24nIHwgJ3Vua25vd24nOwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICByZWFzb24/OiBhbnk7CiAgICBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwp9CicA/+GZtQL87gQab25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUCBAD/4Zm1Ao2dBuE/QGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGF0KSkpOwp9CgppZiAoc291cmNlRXZlbnQgPT09ICdhc2snIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdwYXN0ZScgfHwgCiAgICBzb3VyY2VFdmVudCA9PT0gJ2Jvb3QnIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdmaWxlX3VwbG9hZCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAndG9vbCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnCikgewogICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBib3RzIGJlaW5nIGFkZGVkIGFyZSBhcnRpZmFjdCBzaGFyZHMgdGhhdCBuZWVkcyB0byBiZSByZWNvbnN0aXR1dGVkLgogICAgY29uc3QgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGU6IFJlY29yZDxzdHJpbmcsIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmc+ID0ge307IC8vIEtleSBpcyBhcnRpZmFjdCBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwogICAgY29uc3QgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpOyAvLyBUaGlzIHNldCB0cmFja3MgYXJ0aWZhY3QgaWRzIHRoYXQgYXJlIGFscmVhZHkgcXVldWVkIHRvIGJlIHJlY29uc3RpdHV0ZWQgd2l0aCBhIG5ldyBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVHJhY2sgb3JpZ2luYWwgaW5zdGFuY2UgSURzIHRoYXQgd2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGdpdmUgbmV3IGluc3RhbmNlcwoKICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICBpZiAoZGF0YSAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYKICAgICAgICAgICAgIWRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkICYmCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlPy5zdGFydHNXaXRoKCfwn6esJykKICAgICAgICApIHsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IHN0cmluZyA9IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlT3duZXI6IHN0cmluZyA9IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IEpTT04ucGFyc2UoZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGUuc3Vic3RyaW5nKDIpKTsKCiAgICAgICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICAgICAgLy8gU2hhcmQgaGFzIGFuIGFydGlmYWN0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gJiYgIW9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmhhcyhhYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDE6IEluc3RhbmNlIGFscmVhZHkgZXhpc3RzIC0gY3JlYXRlIG5ldyBpbnN0YW5jZSAoZmlyc3QgdGltZSB3ZSBzZWUgdGhpcyBjb2xsaXNpb24pCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW25ld0FydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBuZXdBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXM6IGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsgLy8gVHJhY2sgdGhhdCB3ZSdyZSBjcmVhdGluZyBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBhcnRpZmFjdCBJRAogICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7IC8vIFRyYWNrIHRoYXQgd2UndmUgZGVjaWRlZCB0byByZXBsYWNlIHRoaXMgb3JpZ2luYWwgaW5zdGFuY2UgSUQKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDE6IFNoYXJkIGZyb20gZXhpc3RpbmcgaW5zdGFuY2UuIENyZWF0aW5nIG5ldyBpbnN0YW5jZS4gKG9sZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0sIG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMWI6IFdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2UgZm9yIHRoaXMgb3JpZ2luYWwgSUQgLSBkaXNwb3NlLgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAxYjogQWRkaXRpb25hbCBzaGFyZCBmb3IgcmVwbGFjZWQgaW5zdGFuY2UuIERpc3Bvc2luZy4gKG9yaWdpbmFsOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAyOiBJbnN0YW5jZSBhbHJlYWR5IHF1ZXVlZCBmb3IgcmVjb25zdGl0dXRpb24gLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAyOiBEdXBsaWNhdGUgc2hhcmQgZm9yIHF1ZXVlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAoYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAzOiBJbnN0YW5jZSB0byByZWNvbnN0aXR1dGUgd2l0aCBleGlzdGluZyBJRAogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDM6IEluc3RhbmNlIHRvIHJlY29uc3RpdHV0ZS4gKGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTaGFyZCBoYXMgbm8gYXJ0aWZhY3QgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgIGlmIChhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5oYXMoYWJBcnRpZmFjdEJ1bmRsZS5pZCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDQ6IEFydGlmYWN0IGFscmVhZHkgaGFzIG5ldyBpbnN0YW5jZSBxdWV1ZWQgLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSA0OiBEdXBsaWNhdGUgc2hhcmQgZm9yIGFydGlmYWN0IHdpdGggbmV3IGluc3RhbmNlIHF1ZXVlZC4gRGlzcG9zaW5nLiAoYXJ0aWZhY3RJZDogJHthYkFydGlmYWN0QnVuZGxlLmlkfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgNTogQ3JlYXRlIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDU6IENyZWF0aW5nIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRC4gKG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgbm90IGEgc2hhcmQgYm90LiBJZ25vcmUgaXQuCiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZTpgLCBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZSk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzOmAsIGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXMpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6YCwgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQ6YCwgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQpOwogICAgfQoKICAgIGZvciAoY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpIHsKICAgICAgICBjb25zdCByZWNvbnN0aXR1dGVBcmc6IEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgPSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF07CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBSZWNvbnN0aXR1dGluZyBhcnRpZmFjdCBpbnN0YW5jZTogJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0UmVjb25zdGl0dXRlKHJlY29uc3RpdHV0ZUFyZyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoc291cmNlRXZlbnQgPT09ICdjcmVhdGVfYXJ0aWZhY3RfcHJvbWlzZScpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICAgICAgLy8gRG8gYSBzcGVjaWFsIHNob3V0IHNvIHRoYXQgdGhlIGNyZWF0ZSBhcnRpZmFjdCBwcm9taXNlIGZ1bmN0aW9uIGNhbiBjYXRjaCB0aGlzIGVycm9yLgogICAgICAgICAgICAgICAgY29uc3QgZmFpbHVyZVJlc3VsdCA9IHsKICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGU6ICdhcnRpZmFjdF9wcm9taXNlX3JlY29uc3RpdHV0aW9uX2ZhaWxlZCcsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBgUmVjb25zdGl0dXRpb24gZnJvbSBhcnRpZmFjdCBwcm9taXNlIGhhcyBmYWlsZWQuIENhdWdodCBlcnJvcjogJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXM6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVyczogcmVjb25zdGl0dXRlQXJnLmVnZ1BhcmFtZXRlcnMsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHNob3V0KCdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGZhaWx1cmVSZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgIH0KfScA/+GZtQL87gQbb25BQlByZXByb2Nlc3NCZWZvcmVQdWJsaXNoAgQA/+GZtQLt3AalAkBpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9Cgp0aGlzQm90LmFiUHJlcHJvY2Vzc0JvdERhdGFUb0FydGlmYWN0UHJvbWlzZXMoeyBib3REYXRhOiB0aGF0LmJvdERhdGEgfSk7JwD/4Zm1AvzuBBZhYkdldEFydGlmYWN0SW5zdGFuY2VzAgQA/+GZtQKT3wbKB0Bjb25zdCB7IAogICAgYm90cywKICAgIGFiQXJ0aWZhY3ROYW1lLAp9ID0gdGhhdCA/PyB7fQoKaWYgKGJvdHMpIHsKICAgIGFzc2VydChBcnJheS5pc0FycmF5KGJvdHMpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgbXVzdCBiZSBhbiBhcnJheS5gKTsKfQoKY29uc3QgaW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB7fSAvLyBLZXkgaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaWQuCgpmdW5jdGlvbiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShib3QpIHsKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiBib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBib3QudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBsZXQgYm90QXJyYXkgPSBpbnN0YW5jZXNbYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgICAgICBpZiAoIWJvdEFycmF5KSB7CiAgICAgICAgICAgIGJvdEFycmF5ID0gW107CiAgICAgICAgICAgIGluc3RhbmNlc1tib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRF0gPSBib3RBcnJheTsKICAgICAgICB9CgogICAgICAgIGJvdEFycmF5LnB1c2goYm90KTsKICAgIH0KfQoKaWYgKGJvdHMpIHsKICAgIC8vIEdldCBhcnRpZmFjdCBpbnN0YW5jZXMgaW4gcHJvdmlkZWQgbGlzdCBvZiBib3RzLgogICAgYm90cy5mb3JFYWNoKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYikpOwp9IGVsc2UgewogICAgLy8gR2V0IGFydGlmYWN0IGluc3RhbmNlcyBpbiBpbnN0LgogICAgZ2V0Qm90cyhiID0+IHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGIpKTsKfQoKcmV0dXJuIGluc3RhbmNlczsnAP/hmbUC/O4EFWFiR2V0QXJ0aWZhY3RQYXR0ZXJucwIEAP/hmbUC3uYG8wdAY29uc3QgeyAKICAgIGJvdHMsCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge30KCmlmIChib3RzKSB7CiAgICBhc3NlcnQoQXJyYXkuaXNBcnJheShib3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIG11c3QgYmUgYW4gYXJyYXkuYCk7Cn0KCmNvbnN0IHBhdHRlcm5zOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB7fSAvLyBLZXkgaXMgYXJ0aWZhY3QgbmFtZS4KCmZ1bmN0aW9uIHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYm90KSB7CiAgICAvLyBQYXR0ZXJuIGJvdHMgaGF2ZSBhYkFydGlmYWN0TmFtZSBidXQgbm8gYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiAhYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbGV0IGJvdEFycmF5ID0gcGF0dGVybnNbYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWVdOwoKICAgICAgICBpZiAoIWJvdEFycmF5KSB7CiAgICAgICAgICAgIGJvdEFycmF5ID0gW107CiAgICAgICAgICAgIHBhdHRlcm5zW2JvdC50YWdzLmFiQXJ0aWZhY3ROYW1lXSA9IGJvdEFycmF5OwogICAgICAgIH0KCiAgICAgICAgYm90QXJyYXkucHVzaChib3QpOwogICAgfQp9CgppZiAoYm90cykgewogICAgLy8gR2V0IGFydGlmYWN0IHBhdHRlcm5zIGluIHByb3ZpZGVkIGxpc3Qgb2YgYm90cy4KICAgIGJvdHMuZm9yRWFjaChiID0+IHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYikpOwp9IGVsc2UgewogICAgLy8gR2V0IGFydGlmYWN0IHBhdHRlcm5zIGluIGluc3QuCiAgICBnZXRCb3RzKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihiKSk7Cn0KCnJldHVybiBwYXR0ZXJuczsnAP/hmbUC/O4EGGFiUHVibGlzaEFydGlmYWN0UGF0dGVybgIEAP/hmbUC0u4GhgZAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzdHVkaW8sCiAgICBzaGFyZEJvdHMsCiAgICBtYW51YWxQdWJsaXNoLAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdE5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBzdHVkaW8gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0dWRpbyBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiUHVibGlzaEFCKHsKICAgIGFiOiBhYkFydGlmYWN0TmFtZSwgCiAgICB0YXJnZXQ6IHNoYXJkQm90cywgCiAgICBzdHVkaW8sCiAgICBtYW51YWxQdWJsaXNoLAogICAgc291cmNlRXZlbnQ6ICdwdWJsaXNoX2FydGlmYWN0X3BhdHRlcm4nLAogICAgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaDogYXN5bmMgKGFyZykgPT4gewogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAP/hmbUC/O4EJmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhAgQA/+GZtQLZ9AaTB0Bjb25zdCBib3REYXRhID0gdGhhdDsKCmFzc2VydChsaW5rcy51dGlscy5pc09iamVjdChib3REYXRhKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmd1bWVudCBtdXN0IGJlIGFuIG9iamVjdC5gKTsKCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CiAgICAKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdEJvdCA9PT0gdHJ1ZSkgewogICAgICAgIC8vIFJlbW92ZSBhcnRpZmFjdCBib3RzLgogICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgCiAgICB9IGVsc2UgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIC8vIFN0cmlwIGFydGlmYWN0IGluc3RhbmNlIGRhdGEgZnJvbSBib3QuCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRJbnN0YW5jZUlEOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwoKICAgICAgICAvLyBSZW1vdmUgc29tZSBvdGhlcnMuCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5jcmVhdG9yOwoKICAgICAgICAvLyBHaXZlIGVhY2ggYm90IGEgY2hhbmNlIHRvIHN0cmlwIGluc3RhbmNlIGRhdGEgZnJvbSB0aGUgY29weSBvZiBpdHMgb3duIGJvdCBkYXRhLgogICAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKGRhdGEuaWQsICdvbkFCU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhJywgeyBkYXRhIH0pKTsKICAgIH0KfScA/+GZtQL87gQPaXNFZ2dEZXBlbmRlbmN5AgQA/+GZtQLt+wZSQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hYklEKSAmJiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5yZWNvcmRLZXkpOycA/+GZtQL87gQPaXNBc2tEZXBlbmRlbmN5AgQA/+GZtQLA/AYqQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hc2tJRCk7JwD/4Zm1AvzuBBBvbkFueUJvdHNDaGFuZ2VkAgQA/+GZtQLr/AbJCEAvLyBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cgpmb3IgKGNvbnN0IGNoYW5nZWQgb2YgdGhhdCkgewogICAgaWYgKGNoYW5nZWQgPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIC8vIDEpIG9ubHkgY2FyZSBhYm91dCBib3RzIHdpdGggYXJ0aWZhY3QgdGFncwogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lIHx8ICFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSBjb250aW51ZTsKCiAgICAvLyAyKSBhcnRpZmFjdCBtdXN0IGJlIHJlY29uc3RpdHV0ZWQuCiAgICBpZiAoIWNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCkgY29udGludWU7CgogICAgaWYgKHRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGFuZ2VzIG9uIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gZGV0ZWN0ZWQsIGNhbGxpbmcgdG8gdXBkYXRlIGV4cGVyaWVuY2UuYCwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgY2hhbmdlZEJvdElkOiBjaGFuZ2VkLmJvdC5pZCwKICAgICAgICAgICAgICAgIGNoYW5nZWRUYWdzOiBjaGFuZ2VkLnRhZ3MsCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0IGluc3RhbmNlICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gY2hhbmdlZCBidXQgZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KJwD/4Zm1AvzuBBlleHBlcmllbmNlVGlja1JhdGVMaW1pdE1TAgQA/+GZtQK1hQcENTAwMCcA/+GZtQL87gQWY29sbGVjdFNoYXJkc0xpc3RlblRhZwIEAP/hmbUCuoUHGW9uQUJBcnRpZmFjdENvbGxlY3RTaGFyZHMnAP/hmbUC/O4ECGRlYnVnRXhwAgQA/+GZtQLUhQcFZmFsc2UnAP/hmbUC/O4EF2lzUmVjb25zdGl0dXRpb25FbmFibGVkAgQA/+GZtQLahQd8QGlmIChjb25maWdCb3QudGFncy5hYkFydGlmYWN0UmVjb25zdGl0dXRpb24gPT09IGZhbHNlKSB7CiAgICByZXR1cm4gZmFsc2U7Cn0KCi8vIFJlY29uc3RpdHV0aW9uIG9uIGJ5IGRlZmF1bHQuCnJldHVybiB0cnVlOycA/+GZtQL87gQXYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMCBAD/4Zm1AteGB9AYQGNvbnN0IHsgc2hhcmRCb3RzIH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgcmVxdWlyZWQgdG8gYmUgYW4gYm90IGFycmF5LmApOwoKLyoqIEtlZXAgdHJhY2sgb2YgZGVwZW5kZW5jeSBoYXNoZXMuIFRoaXMgcHJldmVudHMgZHVwbGljYXRlcyBpbiB0aGUgYXJ0aWZhY3QgZGVwZW5kZW5jaWVzLiAqLwpjb25zdCBkZXBlbmRlbmN5SGFzaGVzID0gbmV3IFNldCgpOwoKbGV0IG1lcmdlZFNoYXJkOiBBQkFydGlmYWN0U2hhcmQgPSB7CiAgICBkYXRhOiB7fSwKICAgIGRlcGVuZGVuY2llczogW10sCn07Cgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgY29uc3QgYm90U2hvcnRJZCA9IHNoYXJkQm90LmlkLnN1YnN0cmluZygwLCA1KTsKCiAgICBsZXQgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKICAgIGlmIChzaGFyZEJvdC50YWdzW3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10pIHsKICAgICAgICBpZiAoc2hhcmRCb3RbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSkgewogICAgICAgICAgICBzaGFyZCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShzaGFyZEJvdFt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHRhZyBpcyBkZWZpbmVkIGJ1dCBpcyBub3QgYSB2YWxpZCBmdW5jdGlvbi5gIH07CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgc2hhcmQ6YCwgc2hhcmQpOwogICAgfQoKICAgIGlmIChzaGFyZCkgewogICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQpKSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCBtdXN0IGJlIGFuIG9iamVjdC5gIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGF0YSkgewogICAgICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzT2JqZWN0KHNoYXJkLmRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgJ2RhdGEnIHByb3BlcnR5IG11c3QgYmUgYW4gb2JqZWN0LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2hhbGxvdyBtZXJnZSBzaGFyZCdzIGRhdGEgcHJvcGVydGllcyBpbnRvIGNvbWJpbmVkIGFydGlmYWN0IGRhdGEuCiAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRhdGEgPSB7IC4uLm1lcmdlZFNoYXJkLmRhdGEsIC4uLnNoYXJkLmRhdGEgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc0FycmF5KHNoYXJkLmRlcGVuZGVuY2llcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCAnZGVwZW5kZW5jaWVzJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIGFycmF5LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgdGhhdCBkZXBlbmRlbmN5IGlzIG9uZSBvZiB0aGUgc3VwcG9ydGVkIHR5cGVzLgogICAgICAgICAgICAgICAgaWYgKCF0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSAmJiAhdGhpc0JvdC5pc0Fza0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIGhhcyBhIGRlcGVuZGVuY3kgZW50cnkgdGhhdCBpcyBuZWl0aGVyIGFuIGVnZyBvciBhc2sgZGVwZW5kZW5jeSB0eXBlLmAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBkZXBlbmRlbmN5IGlzbnQgYWxyZWFkeSBjb2xsZWN0ZWQuCiAgICAgICAgICAgICAgICBjb25zdCBoYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgZGVwZW5kZW5jeSk7CgogICAgICAgICAgICAgICAgaWYgKCFkZXBlbmRlbmN5SGFzaGVzLmhhcyhoYXNoKSkgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lIYXNoZXMuYWRkKGhhc2gpOwogICAgICAgICAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBNYWtlIHN1cmUgd2UgaGF2ZSBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeS4KaWYgKG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIG11c3QgbGlzdCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeSBpbiBvcmRlciB0byByZWNvbnN0aXR1dGUgcHJvcGVybHkuYCB9Owp9Cgpjb25zdCByZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0ID0gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIHNoYXJkOiBtZXJnZWRTaGFyZCwKfQoKcmV0dXJuIHJlc3VsdDsnAP/hmbUC/O4EF2NhblVzZXJVcGRhdGVFeHBlcmllbmNlAgQA/+GZtQKonwfOCUBjb25zdCB7CiAgICByZW1vdGVJZCA9IGNvbmZpZ0JvdC5pZCwKICAgIHNoYXJkQm90Cn0gPSB0aGF0ID8/IHt9CgppZiAoc2hhcmRCb3QgJiYgCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlECikgewogICAgLy8gTmVlZCB0byBmaWd1cmUgb3V0IGlmIHRoaXMgdXNlciBpcyBhbGxvd2VkIHRvIHVwZGF0ZSB0aGUgZXhwZXJpZW5jZSBvZiB0aGlzIGFydGlmYWN0IGluc3RhbmNlLgogICAgbGV0IGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKCiAgICBzd2l0Y2ggKHNoYXJkQm90LnNwYWNlKSB7CiAgICAgICAgY2FzZSAnc2hhcmVkJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgY2FzZSAndGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBiYXNpY2FsbHkgb3duZWQgYnkgdGhpcyB1c2VyLgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncmVtb3RlVGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHJlbW90ZVRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBvd25lZCBieSBzb21lb25lIGVsc2UuCiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnbG9jYWwnOgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAndGVtcExvY2FsJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgYm90IHNwYWNlOmAsIHNoYXJkQm90LnNwYWNlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIGNhblVzZXJVcGRhdGU7Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHByb3ZpZGVkIHNoYXJkQm90IGRvZXMgbm90IGFwcGVhciB0byBiZSBmcm9tIGFuIGFydGlmYWN0IGluc3RhbmNlLmAsIHNoYXJkQm90KTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKfScA/+GZtQL87gQaYWJDcmVhdGVBcnRpZmFjdFByb21pc2VCb3QCBAD/4Zm1AveoB+IVQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0U2hhcmQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLAogICAgc3BhY2UgPSAnc2hhcmVkJywKfSA9IHRoYXQgPz8ge307CgoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYm90RGF0YSA9IFtdOwpjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0QnVuZGxlKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RTaGFyZCB9KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdlbmVyYXRlZCBhYkFydGlmYWN0QnVuZGxlOmAsIGFiQXJ0aWZhY3RCdW5kbGUpOwp9Cgpib3REYXRhW3Byb21pc2VJZF0gPSB7CiAgICBpZDogcHJvbWlzZUlkLAogICAgc3BhY2UsCiAgICB0YWdzOiB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoYWJBcnRpZmFjdEJ1bmRsZSksCiAgICAgICAgYWJBcnRpZmFjdFByb21pc2U6IHRydWUsCiAgICB9Cn0KCi8vIENyZWF0ZSBhcnRpZmFjdCBwcm9taXNlIHRocm91Z2ggYWJDcmVhdGVCb3RzLiAKLy8gVGhpcyB3aWxsIHRyaWdnZXIgYXJ0aWZhY3QncyBvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSBhbmQgaXQgd2lsbCBmaW5kCi8vIHRoaXMgYXJ0aWZhY3QgcHJvbWlzZSBhbmQgdXNlIHRoZSBkYXRhIHRvIHJlY29uc3RpdHV0ZSBpdC4KbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdERhdGEsIHNvdXJjZUV2ZW50OiAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnIH0pOwoKY29uc3Qgd2FpdEZvclJlY29uc3RpdHV0aW9uID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnVuY3Rpb24gY2xlYW51cCgpIHsKICAgICAgICBvcy5yZW1vdmVCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKTsKICAgICAgICBvcy5yZW1vdmVCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKGxpc3RlbmVyVGhhdCkgewogICAgICAgIGlmIChsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIHx8CiAgICAgICAgICAgIGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgICkgewogICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgIHJlc29sdmUobGlzdGVuZXJUaGF0KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkKGxpc3RlbmVyVGhhdCkgewogICAgICAgIGlmIChsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIHx8CiAgICAgICAgICAgIGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgICkgewogICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IobGlzdGVuZXJUaGF0LmVycm9yTWVzc2FnZSkpOwogICAgICAgIH0KICAgIH0KCiAgICBvcy5hZGRCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKTsKICAgIG9zLmFkZEJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCk7Cn0pCgpjb25zdCByZWNvbnN0aXR1dGVSZXN1bHQgPSBhd2FpdCB3YWl0Rm9yUmVjb25zdGl0dXRpb247CgpyZXR1cm4gcmVjb25zdGl0dXRlUmVzdWx0LnNoYXJkQm90czsnAP/hmbUC/O4EFmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUCBAD/4Zm1Ati+B5kIQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdFNoYXJkLAp9ID0gdGhhdDsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHsKICAgIG5hbWU6IGFiQXJ0aWZhY3ROYW1lLAogICAgZm9ybWF0VmVyc2lvbjogMSwKICAgIGRhdGE6IGFiQXJ0aWZhY3RTaGFyZC5kYXRhLAogICAgZGVwZW5kZW5jaWVzOiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLAp9CgovLyBHZW5lcmF0ZSB0aGUgYXJ0aWZhY3QgaWQsIHdoaWNoIGlzIHNoYTI1NiBoYXNoIG9mIHRoZSBjb3JlIGNvbnRlbnRzIG9mIHRoZSBhcnRpZmFjdC4KYWJBcnRpZmFjdEJ1bmRsZS5pZCA9IGNyeXB0by5zaGEyNTYoYWJBcnRpZmFjdEJ1bmRsZSk7CgovLyBTdG9yZSBzb21lIGV4dHJhIG1ldGFkYXRhIHByb3BlcnRpZXMgd2l0aCB0aGUgYXJ0aWZhY3QuCi8vIFRoZXNlIGFyZSBub3QgY29yZSB0byB0aGUgYXJ0aWZhY3QncyBmdW5jdGlvbmFsaXR5IGJ1dCBtYXkgYmUgdXNlZnVsIGFzIGFydGlmYWN0cyBldm9sdmUuCmFiQXJ0aWZhY3RCdW5kbGUuY2FzdWFsT1NWZXJzaW9uID0gb3MudmVyc2lvbigpOwphYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXAgPSBEYXRlVGltZS5ub3coKS50b0lTTygpOwphYkFydGlmYWN0QnVuZGxlLmFiU2hlbGxWZXJzaW9uID0gYCR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1ham9yVmVyc2lvbn0uJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWlub3JWZXJzaW9ufWA7CgpyZXR1cm4gYWJBcnRpZmFjdEJ1bmRsZTsnAP/hmbUC/O4EBmNyZWF0ZQIEAP/hmbUC8sYHKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAP/hmbUC/O4EE2lzRXhwZXJpZW5jZUVuYWJsZWQCBAD/4Zm1ApnHB3RAaWYgKGNvbmZpZ0JvdC50YWdzLmFiQXJ0aWZhY3RFeHBlcmllbmNlID09PSB0cnVlKSB7CiAgICByZXR1cm4gdHJ1ZTsKfQoKLy8gRXhwZXJpZW5jZSBvZmYgYnkgZGVmYXVsdC4KcmV0dXJuIGZhbHNlOycA/+GZtQL87gQeYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50AgQA/+GZtQKOyAfJHEBjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLCAvLyBbUnlhbiBDb29rXTogSSB3aWxsIG5lZWQgdGhpcyB3aGVuIEkgZ2V0IGJhY2sgdG8gYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZS4KfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MgPSB7fTsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYWxyZWFkeSBoYXMgYSBkb2N1bWVudCBsb2FkZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmxldCBleHBlcmllbmNlQXV0aDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCmlmICghZXhwZXJpZW5jZUF1dGguYXV0aG9yaXplZCkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEFydGlmYWN0IGV4cGVyaWVuY2Ugd2FzIG5vdCBhdXRob3JpemVkLiBSZWFzb246ICR7ZXhwZXJpZW5jZUF1dGguZmFpbHVyZVJlYXNvbn1gKTsKICAgIHJldHVybjsKfQoKLy8gR2V0IHRoZSBhcnRpZmFjdCBpbnN0YW5jZSdzIHNoYXJlZCBkb2N1bWVudCBhcyB3ZWxsIGFzIHRoZSBleHBlcmllbmNlIG1hcC4KY29uc3QgZG9jdW1lbnQgPSBhd2FpdCBvcy5nZXRTaGFyZWREb2N1bWVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwgYGFydGlmYWN0SW5zdGFuY2VfJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gLCAnbWFpbicpOwpjb25zdCBleHBlcmllbmNlTWFwID0gZG9jdW1lbnQuZ2V0TWFwKCdleHBlcmllbmNlJyk7Cgpjb25zdCBza2lwS2V5cyA9IG5ldyBTZXQoWwogICAgJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnLAogICAgLy8gQWRkIG1vcmUga2V5cyBoZXJlIGlmIG5lZWRlZAogICAgLy8gJ3NvbWVPdGhlcktleScsCiAgICAvLyAneWV0QW5vdGhlcktleScKXSk7Cgpjb25zdCBleHBlcmllbmNlU3ViID0gZXhwZXJpZW5jZU1hcC5kZWVwQ2hhbmdlcy5zdWJzY3JpYmUoKGV2ZW50cykgPT4gewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9uIGRlZXAgY2hhbmdlczpgLCBldmVudHMpOwogICAgfQoKICAgIC8vIENvbGxlY3QgYWxsIGNoYW5nZWQga2V5cwogICAgY29uc3QgYWxsS2V5cyA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZXZ0IG9mIGV2ZW50cyA/PyBbXSkgewogICAgICAgIGNvbnN0IG0gPSBldnQ/LmNoYW5nZXM7CiAgICAgICAgaWYgKG0gJiYgdHlwZW9mIG0ua2V5cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBmb3IgKGNvbnN0IGsgb2YgbS5rZXlzKCkpIHsKICAgICAgICAgICAgICAgIGFsbEtleXMuYWRkKGspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFNraXAgaWYgKmFsbCogY2hhbmdlcyBhcmUgaW5zaWRlIHRoZSBza2lwIGxpc3QKICAgIGNvbnN0IHNob3VsZFNraXAgPSBhbGxLZXlzLnNpemUgPiAwICYmIFsuLi5hbGxLZXlzXS5ldmVyeSgoaykgPT4gc2tpcEtleXMuaGFzKGspKTsKICAgIGlmIChzaG91bGRTa2lwKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYWxsIHRvIGFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlLCB0aGUgb25seSBjaGFuZ2UgdG8gdGhlIGV4cGVyaWVuY2Ugd2VyZSBzcGVjaWFsIHJlc2VydmVkIHByb3BlcnRpZXMuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0pOwoKdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gPSB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3VifTsKCmlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGluc3RhbmNlIGRvY3VtZW50IGxvYWRlZDpgLCB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSk7CgogICAgY29uc3QgZXhwZXJpZW5jZUpTT04gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VNYXAudG9KU09OKCkpKTsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gbG9hZGVkIGV4cGVyaWVuY2UgbWFwIHN0YXRlOmAsIGV4cGVyaWVuY2VKU09OKTsKfQoKY29uc3QgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9IGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJyk7CgppZiAoYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9PT0gdHJ1ZSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0aW5nIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGZyb20gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEltbWVkaWF0ZWx5IGdpdmUgdGhlIHNoYXJkIGJvdHMgdGhlIGN1cnJlbnQgZXhwZXJpZW5jZSBzdGF0ZS4KICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbml0aWFsaXppbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEluaXRpYWxpemUgdGhlIGV4cGVyaWVuY2Ugc3RhdGUgd2l0aCB0aGUgY3VycmVudCBzaGFyZCBkYXRhLgogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7ICAgIAp9CicA/+GZtQL87gQgYWJVbmxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQCBAD/4Zm1AtjkB4kGQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IHsgZG9jdW1lbnQsIGV4cGVyaWVuY2VNYXAsIGV4cGVyaWVuY2VTdWIgfSA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOyAKCiAgICBpZiAoZXhwZXJpZW5jZVN1YikgewogICAgICAgIGV4cGVyaWVuY2VTdWIudW5zdWJzY3JpYmUoKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bnN1YnNjcmliZWQgZnJvbSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBleHBlcmllbmNlIG1hcC5gKTsKICAgICAgICB9CiAgICB9CgogICAgZGVsZXRlIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZW1vdmVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGRvY3VtZW50LmApOwogICAgfQp9JwD/4Zm1AvzuBB5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMCBAD/4Zm1AuLqB7QCQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgIHJldHVybiBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0pOwoKcmV0dXJuIHNoYXJkQm90czsnAP/hmbUC/O4EJmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlAgQA/+GZtQKX7QfpB0Bjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICByZXR1cm47Cn0KCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCBpbnN0YW5jZURvYyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmIChpbnN0YW5jZURvYykgewogICAgICAgIGNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUR9KTsKCiAgICAgICAgY29uc3QgeyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1YiB9ID0gaW5zdGFuY2VEb2M7CgogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VEYXRhID0gZXhwZXJpZW5jZU1hcC50b0pTT04oKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSB3aXRoIGV4cGVyaWVuY2Ugc3RhdGU6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlRGF0YSkpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHdoaXNwZXIoc2hhcmRCb3RzLCAnb25BQkFydGlmYWN0RXhwZXJpZW5jZScsIHsgZGF0YTogZXhwZXJpZW5jZURhdGEgfSkpOwogICAgfQp9JwD/4Zm1AvzuBCJhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlAgQA/+GZtQKB9QfQKEBpbXBvcnQgeyBTaGFyZWRNYXAgfSBmcm9tICdjYXN1YWxvcyc7Cgpjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKCF0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMpIHsKICAgIHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcyA9IG5ldyBTZXQoKTsKfQoKaWYgKHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSB1cGRhdGUgaXMgYWxyZWFkeSBpbiBwcm9ncmVzcyBmb3IgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgIH0KICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgY29uc3QgaW5zdGFuY2VEb2MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICBpZiAoaW5zdGFuY2VEb2MpIHsKICAgICAgICBjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKICAgICAgICAvLyBOZWVkIHRvIGFzayBpZiB0aGlzIHVzZXIgaXMgYWxsb3dlZCB0byB1cGRhdGUgdGhlIGV4cGVyaWVuY2Ugb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgICAgICBjb25zdCBjYW5Vc2VyVXBkYXRlID0gYXdhaXQgdGhpc0JvdC5jYW5Vc2VyVXBkYXRlRXhwZXJpZW5jZSh7IHJlbW90ZUlkOiBjb25maWdCb3QuaWQsIHNoYXJkQm90OiBzaGFyZEJvdHNbMF0gfSk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2FuIHVzZXIgdXBkYXRlIGV4cGVyaWVuY2UgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7c2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQuc3Vic3RyaW5nKDAsIDcpfT9gLCBjYW5Vc2VyVXBkYXRlKTsKICAgICAgICB9CgogICAgICAgIGlmIChjYW5Vc2VyVXBkYXRlKSB7CiAgICAgICAgICAgIGxldCBjb2xsZWN0U2hhcmRSZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0OwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbGxlY3RTaGFyZFJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMoeyBzaGFyZEJvdHMgfSk7CgogICAgICAgICAgICAgICAgaWYgKCFjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY29sbGVjdFNoYXJkUmVzdWx0LnJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOmAsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBgY29sbGVjdFNoYXJkUmVzdWx0OmAsIEpTT04uc3RyaW5naWZ5KGNvbGxlY3RTaGFyZFJlc3VsdCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29sbGVjdFNoYXJkUmVzdWx0ICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBlbnRyeSBpbiBleHBlcmllbmNlTWFwIGlmIHRoZSBkYXRhIGlzIGFjdHVhbGx5IGRpZmZlcmVudC4KICAgICAgICAgICAgICAgIGNvbnN0IGV4cGVyaWVuY2VNYXA6IFNoYXJlZE1hcCA9IGluc3RhbmNlRG9jLmV4cGVyaWVuY2VNYXA7CgogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBzaGFyZCBkYXRhIG1pZ2h0IGJlIHVuZGVmaW5lZC9udWxsCiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGEgPSAoY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhKSA/IGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhIDoge307CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGFLZXlzID0gT2JqZWN0LmtleXMoc2hhcmREYXRhKTsKICAgICAgICAgICAgICAgIGNvbnN0IGtleXNUb0RlbGV0ZSA9IFtdOwoKICAgICAgICAgICAgICAgIC8vIFNpbXBsZSBkZWVwLWVxdWFsaXR5IGNoZWNrIGZvciBKU09OLXNlcmlhbGl6YWJsZSB2YWx1ZXMKICAgICAgICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSAoYSwgYikgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChhID09PSBiKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYSkgPT09IEpTT04uc3RyaW5naWZ5KGIpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyAxKSBVcHNlcnQgb25seSB3aGVuIGRpZmZlcmVudAogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2Ygc2hhcmREYXRhS2V5cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1ZhbCA9IHNoYXJkRGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbCA9IGV4cGVyaWVuY2VNYXAuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0VxdWFsKG9sZFZhbCwgbmV3VmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBleHBlcmllbmNlTWFwIGtleSAiJHtrZXl9ImAsIEpTT04uc3RyaW5naWZ5KHsgb2xkVmFsLCBuZXdWYWwgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KGtleSwgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMikgQ29sbGVjdCBrZXlzIHRoYXQgZXhpc3QgaW4gdGhlIG1hcCBidXQgbm90IGluIHRoZSBzaGFyZCBkYXRhCiAgICAgICAgICAgICAgICAvLyAgICAod2UgYXZvaWQgbXV0YXRpbmcgdGhlIG1hcCB3aGlsZSBpdGVyYXRpbmcgaXQpCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBleHBlcmllbmNlTWFwLmtleXMoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09ICdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBkZWxldGUgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZC4gSXRzIGEgc3BlY2lhbCBwcm9wZXJ0eS4KICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICghc2hhcmREYXRhS2V5cy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleXNUb0RlbGV0ZS5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMpIFJlbW92ZSBzdGFsZSBrZXlzCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzVG9EZWxldGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlbGV0aW5nIHN0YWxlIGV4cGVyaWVuY2VNYXAga2V5ICIke2tleX0iYCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgIT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSBpbnN0YW5jZSBkb2N1bWVudCBub3QgbG9hZGVkLmApOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IHVwZGF0ZSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBiZWNhdXNlIGluc3RhbmNlIGRvY3VtZW50cyBoYXZlIG5vdCBiZWVuIGluaXRpYWxpemVkLmApOwogICAgfQp9Cgp0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuZGVsZXRlKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsnAP/hmbUC/O4EDG9uSW5zdEpvaW5lZAIEAP/hmbUC0p0IkAZAbWFza3MuaW5zdEpvaW5lZCA9IHRydWU7Cgpjb25zdCBhcnRpZmFjdEluc3RhbmNlcyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwoKZm9yIChsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RJbnN0YW5jZXMpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb2FkaW5nIGFydGlmYWN0IGluc3RhbmNlIGRvY3VtZW50IGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWApOwogICAgfQogICAgCiAgICB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9CgovLyBDb2xsZWN0IGFsbCByZWNvbnN0aXR1dGlvbiBzaWduYWwgYm90cyBpbnRvIGEgbG9jYWwgc2V0IHNvIHdlIGtub3cgd2hlbiB0aGV5IGFyZSByZW1vdmVkLgpjb25zdCByZWNvbnN0aXR1dGluZ1NpZ25hbEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiUmVjb25zdGl0dXRpbmdBcnRpZmFjdFNpZ25hbEJvdCk7CmZvciAoY29uc3Qgc2lnbmFsQm90IG9mIHJlY29uc3RpdHV0aW5nU2lnbmFsQm90cykgewogICAgdGhpc0JvdC52YXJzLnJlY29uc3RpdHV0aW5nU2lnbmFsQm90SWRzLmFkZChzaWduYWxCb3QuaWQpOwp9CgppZiAocmVjb25zdGl0dXRpbmdTaWduYWxCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgdGhpc0JvdC5hYkNoZWNrQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkF0UmVzdCgpOwp9JwD/4Zm1AvzuBA5vbkFueUJvdHNBZGRlZAIEAP/hmbUC46MIwQVAaWYgKCFtYXNrcy5pbnN0Sm9pbmVkKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFkZGVkQm90cyA9IHRoYXQuYm90czsKCmZvciAoY29uc3QgYm90IG9mIGFkZGVkQm90cykgewogICAgaWYgKGJvdCA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjUwKTsKCiAgICAgICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGV0ZWN0ZWQgYWRkZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7Ym90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9LmApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgICAgIH0KICAgIH0gCiAgICBlbHNlIGlmIChib3QudGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RTaWduYWxCb3QpIHsKICAgICAgICB0aGlzQm90LnZhcnMucmVjb25zdGl0dXRpbmdTaWduYWxCb3RJZHMuYWRkKGJvdC5pZCk7CiAgICB9Cn0nAP/hmbUC/O4EGm9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkAgQA/+GZtQKlqQjeBUBsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdwcmludGFydGlmYWN0ZXhwZXJpZW5jZScsIChhcmdzKSA9PiB7CiAgICBjb25zdCBpbnN0YW5jZURvY3MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzOwoKICAgIGxldCBhbGxFeHBlcmllbmNlID0ge307CgogICAgZm9yIChsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gaW5zdGFuY2VEb2NzKSB7CiAgICAgICAgY29uc3QgZXhwZXJpZW5jZU1hcCA9IGluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0uZXhwZXJpZW5jZU1hcDsKICAgICAgICBjb25zdCBleHBlcmllbmNlSlNPTiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXhwZXJpZW5jZU1hcC50b0pTT04oKSkpOwogICAgICAgIGFsbEV4cGVyaWVuY2VbYWJBcnRpZmFjdEluc3RhbmNlSURdID0gZXhwZXJpZW5jZUpTT047CiAgICB9CgogICAgY29uc29sZS5sb2coYFtwcmludGFydGlmYWN0ZXhwZXJpZW5jZV0gQWxsIGN1cnJlbnQgYXJ0aWZhY3QgaW5zdGFuY2UgZXhwZXJpZW5jZSBzdGF0ZXM6YCwgYWxsRXhwZXJpZW5jZSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQcmludCBhbGwgY3VycmVudGx5IGxvYWRlZCBhcnRpZmFjdCBpbnN0YW5jZSBleHBlcmllbmNlIHN0YXRlcyB0byB0aGUgY29uc29sZS4nLAogICAgdXNhZ2U6IFsnLnByaW50YXJ0aWZhY3RleHBlcmllbmNlJ10KfSk7JwD/4Zm1AvzuBBhhYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgCBAD/4Zm1AoSvCNwSQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgZXhwQXV0aFJlc3VsdDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhdXRob3JpemVkOiB1bmRlZmluZWQsCiAgICBmYWlsdXJlUmVhc29uOiB1bmRlZmluZWQsCn0KCmlmIChnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUpIHsKICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZDsKCiAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKfQoKbGV0IG15QXV0aEJvdCA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgppZiAoIW15QXV0aEJvdCkgewogICAgLy8gTm90IHNpZ25lZCBpbiwgbmVlZCB0byBzaWduIGluIHRvIHVzZSBhcnRpZmFjdCBleHBlcmllbmNlLgogICAgbGV0IGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UgPSBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2U7CgogICAgaWYgKCFhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlKSB7CiAgICAgICAgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgdGl0bGU6ICdTaWduIEluIFJlcXVpcmVkJywKICAgICAgICAgICAgY29udGVudDogJ1RoaXMgc2VydmVyIGhhcyBhcnRpZmFjdHMgdGhhdCB3b3JrIGJlc3Qgd2hlbiB5b3XigJlyZSBzaWduZWQgaW4uIElmIHlvdSBjb250aW51ZSB3aXRob3V0IHNpZ25pbmcgaW4sIHRoZSBhcnRpZmFjdHMgbWF5IG5vdCBzdGF5IGluIHN5bmMuJywKICAgICAgICAgICAgY29uZmlybVRleHQ6ICdTaWduIEluJywKICAgICAgICAgICAgY2FuY2VsVGV4dDogJ0NvbnRpbnVlIFdpdGhvdXQnCiAgICAgICAgfSk7CgogICAgICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2U7CiAgICB9CgogICAgY29uc3QgY29uZmlybWVkID0gYXdhaXQgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKICAgIGRlbGV0ZSBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmU7CgogICAgaWYgKGNvbmZpcm1lZCkgewogICAgICAgIG15QXV0aEJvdCA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICB9IGVsc2UgewogICAgICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX3NpZ25faW4nOwogICAgICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSA9IGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbjsKICAgICAgICAKICAgICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKICAgIH0KfQoKaWYgKCFteUF1dGhCb3QpIHsKICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3Vua25vd24nOwogICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlID0gZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uOwoKICAgIHJldHVybiBleHBBdXRoUmVzdWx0Owp9CgovLyBjb25zdCBhZG1pblBlcm1pc3Npb25SZXN1bHQgPSBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24obGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWUpOwovLyBjb25zb2xlLmxvZyhgYWRtaW5QZXJtaXNzaW9uUmVzdWx0OmAsIGFkbWluUGVybWlzc2lvblJlc3VsdCk7CgovLyBpZiAoYWRtaW5QZXJtaXNzaW9uUmVzdWx0LnN1Y2Nlc3MpIHsKLy8gICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IHRydWU7CgovLyAgICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Ci8vIH0gZWxzZSB7Ci8vICAgICBleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSBmYWxzZTsKLy8gICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX2luc3RfcGVybWlzc2lvbic7Ci8vICAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUgPSBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb247CgovLyAgICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Ci8vIH0KCmV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IHRydWU7CgpyZXR1cm4gZXhwQXV0aFJlc3VsdDsnAP/hmbUC/O4EEW9uQUJCZWZvcmVQdWJsaXNoAgQA/+GZtQLfwQiGBEBpZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwD/4Zm1AvzuBBJvbkFCQmVmb3JlRG93bmxvYWQCBAD/4Zm1AubFCIYEQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCi8vIFtJTVBPUlRBTlQgTk9URV0gKFNlcHRlbWJlciA0LCAyMDI1KTogVGhpcyBpcyBhIHdvcmthcm91bmQgdW50aWwgd2UgaGF2ZSBhYiBhcnRpZmFjdCBleHBlcmllbmNlIHN0YXRlIHdvcmtpbmcuIEFzIHNvb24gYXMgZXhwZXJpZW5jZSBzdGF0ZSBob29rZWQKLy8gdXAsIHRoaXMgcHJvY2VzcyBzaG91bGQgYmUgZWxpbWluYXRlZCBiZWNhdXNlIGl0IGNoYW5nZXMgdGhlIGFydGlmYWN0IGluc3RhbmNlIGlkIHdoaWNoIGlzIG5vdCBpZGVhbCAtIGJ1dCBpcyBzZXJ2aWNhYmxlIHVudGlsCi8vIHRoZW4gZm9yIHRoZSBuZWVkcyB3ZSBoYXZlIG5vdy4KCi8vIE5haXZlbHkgdXBkYXRlIGFsbCBhcnRpZmFjdCBzaGFyZHMgaW4gdGhpcyBpbnN0IGJlZm9yZSBhYiBwdWJsaXNoZXMgYW4gZWdnLgphd2FpdCB0aGlzQm90LmFiVXBkYXRlQWxsQXJ0aWZhY3RTaGFyZHMoKTsnAP/hmbUC/O4EGWFiVXBkYXRlQWxsQXJ0aWZhY3RTaGFyZHMCBAD/4Zm1Au3JCKEFQGNvbnN0IGFydGlmYWN0SW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMoKTsKCmZvciAoY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RJbnN0YW5jZXMpIHsKICAgIGNvbnN0IHNoYXJkQm90ID0gYXJ0aWZhY3RJbnN0YW5jZXNbYWJBcnRpZmFjdEluc3RhbmNlSURdLmZpbmQoYiA9PiBiICE9IG51bGwpOwoKICAgIGlmICghc2hhcmRCb3QpIHsKICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bmFibGUgdG8gdXBkYXRlIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGJlY2F1c2UgdGhlcmUgd2VyZSBubyBzaGFyZCBib3RzIGZvdW5kLmApOwogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gc2hhcmRCb3QudGFncy5hYkFydGlmYWN0TmFtZTsKICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKICAgIAogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBhYkFydGlmYWN0SW5zdGFuY2VPd25lciB9KTsKfScA/+GZtQL87gQcb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZAIEAP/hmbUCj88I4wJAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKaWYgKHRoYXQuc291cmNlRXZlbnQgIT09ICdkb3dubG9hZF9hcnRpZmFjdF9wYXR0ZXJuJykgewogICAgdGhpc0JvdC5hYlByZXByb2Nlc3NCb3REYXRhVG9BcnRpZmFjdFByb21pc2VzKHsgYm90RGF0YTogdGhhdC5ib3REYXRhIH0pOwp9JwD/4Zm1AvzuBCVhYlByZXByb2Nlc3NCb3REYXRhVG9BcnRpZmFjdFByb21pc2VzAgQA/+GZtQLz0Qj6D0AvKioKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBib3REYXRhIChmcm9tIG9uQUJQcmVwcm9jZXNzQmVmb3JlKiBjYWxscykgYW5kIHJlcGxhY2VzIGFueSBzaGFyZCBib3RzIHdpdGggYXJ0aWZhY3QgcHJvbWlzZSBib3RzLgogKi8KCmNvbnN0IGJvdERhdGEgPSB0aGF0Py5ib3REYXRhOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhcnRpbmcgYm90RGF0YTpgLCB7Li4uYm90RGF0YX0pOwp9Cgphc3NlcnQodHlwZW9mIGJvdERhdGEgPT09ICdvYmplY3QnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdERhdGEgaXMgYSByZXF1aXJlZCBvYmplY3QuYCk7CgovLyBEZXRlY3QgYXJ0aWZhY3QgaW5zdGFuY2VzIHRoYXQgbmVlZCB0byBiZSBjb252ZXJ0ZWQgaW50byBhcnRpZmFjdCBwcm9taXNlcy4KCi8qKiBrZXk6IGFydGlmYWN0IGluc3RhbmNlIGlkLCB2YWx1ZTogYXJ0aWZhY3QgcHJvbWlzZSBkYXRhLiAqLwpjb25zdCBhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlID0gbmV3IFNldCgpOyAvLyBLZWVwIHRyYWNrIG9mIHdoYXQgYXJ0aWZhY3QgaW5zdGFuY2UgSURzIGhhdmUgaGFkIGFuIGFydGlmYWN0IHByb21pc2UgbWFkZS4KCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSAmJiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBUaGlzIGlzIGFuIGFydGlmYWN0IGluc3RhbmNlIHNoYXJkIGJvdC4KICAgICAgICBpZiAoIWFydGlmYWN0SW5zdGFuY2VzV2l0aFByb21pc2UuaGFzKGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgLy8gVGhpcyBhcnRpZmFjdCBpbnN0YW5jZSBuZWVkcyBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUgZm9yIGl0LgogICAgICAgICAgICBjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7CgogICAgICAgICAgICBib3REYXRhW3Byb21pc2VJZF0gPSB7CiAgICAgICAgICAgICAgICBpZDogcHJvbWlzZUlkLAogICAgICAgICAgICAgICAgc3BhY2U6ICdzaGFyZWQnLAogICAgICAgICAgICAgICAgdGFnczogewogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjogZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGU6IGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RQcm9taXNlOiB0cnVlLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb252ZXJ0ZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHtkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGludG8gYW4gYXJ0aWZhY3QgcHJvbWlzZTpgLCBib3REYXRhW3Byb21pc2VJZF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmFkZChkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpOwogICAgICAgIH0KCiAgICAgICAgLy8gUmVtb3ZlIGFydGlmYWN0IGluc3RhbmNlIHNoYXJkIGJvdCBmcm9tIGJvdERhdGEgdGhhdCBpcyBhYm91dCB0byBiZSBwdWJsaXNoZWQuCiAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZmluaXNoZWQgYm90RGF0YTpgLCB7Li4uYm90RGF0YX0pOwp9JwD/4Zm1AvzuBB1vbkFCQmVmb3JlQ29weUJvdHNUb0NsaXBib2FyZAIEAP/hmbUC7uEIyAdAY29uc3QgeyBib3RzIH0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCi8vIFtJTVBPUlRBTlQgTk9URV0gKFNlcHRlbWJlciA0LCAyMDI1KTogVGhpcyBpcyBhIHdvcmthcm91bmQgdW50aWwgd2UgaGF2ZSBhYiBhcnRpZmFjdCBleHBlcmllbmNlIHN0YXRlIHdvcmtpbmcuIEFzIHNvb24gYXMgZXhwZXJpZW5jZSBzdGF0ZSBob29rZWQKLy8gdXAsIHRoaXMgcHJvY2VzcyBzaG91bGQgYmUgZWxpbWluYXRlZCBiZWNhdXNlIGl0IGNoYW5nZXMgdGhlIGFydGlmYWN0IGluc3RhbmNlIGlkIHdoaWNoIGlzIG5vdCBpZGVhbCAtIGJ1dCBpcyBzZXJ2aWNhYmxlIHVudGlsCi8vIHRoZW4gZm9yIHRoZSBuZWVkcyB3ZSBoYXZlIG5vdy4KY29uc3QgdXBkYXRlZEluc3RhbmNlcyA9IG5ldyBTZXQoKTsKCmZvciAobGV0IGJvdCBvZiBib3RzKSB7CiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICBpZiAoIXVwZGF0ZWRJbnN0YW5jZXMuaGFzKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICB1cGRhdGVkSW5zdGFuY2VzLmFkZChib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCk7CgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoewogICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lLAogICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXI6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0KfScA/+GZtQL87gQRY2hlY2tBdFJlc3RXYWl0TVMCBAD/4Zm1ArfpCAM1MDAnAP/hmbUC/O4ECm9uQm90QWRkZWQCBAD/4Zm1ArvpCDVAdGhpc0JvdC52YXJzLnJlY29uc3RpdHV0aW5nU2lnbmFsQm90SWRzID0gbmV3IFNldCgpOycBBGJvdHMkOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjAScA/+GZtQLx6QgPY2FsY01hcFJvdGF0aW9uAgQA/+GZtQLy6QiBDkBjb25zdCB7IG1hcFBvc2l0aW9uLCBhdXhSb3RhdGlvbiB9ID0gdGhhdDsKCmxldCBUSFJFRSA9IHRoaXNCb3QudmFycy5USFJFRTsKaWYgKCFUSFJFRSkgewogICAgVEhSRUUgPSBhd2FpdCBpbXBvcnQoJ3RocmVlJyk7CiAgICB0aGlzQm90LnZhcnMuVEhSRUUgPSBUSFJFRTsKfQoKY29uc3QgZGVnVG9SYWQgPSAoZCkgPT4gKGQgKiBNYXRoLlBJKSAvIDE4MDsKCmZ1bmN0aW9uIHRhbmdlbnRCYXNpc0Zyb21Mb25MYXQobG9uRGVnLCBsYXREZWcpIHsKICAgIGNvbnN0IGxvbiA9IGRlZ1RvUmFkKGxvbkRlZyk7CiAgICBjb25zdCBsYXQgPSBkZWdUb1JhZChsYXREZWcpOwoKICAgIC8vIE5vcm1hbCBwb2ludGluZyBvdXQgb2YgdGhlIGdsb2JlLgogICAgY29uc3QgbiA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgIE1hdGguY29zKGxhdCkgKiBNYXRoLmNvcyhsb24pLAogICAgICAgIE1hdGguY29zKGxhdCkgKiBNYXRoLnNpbihsb24pLAogICAgICAgIE1hdGguc2luKGxhdCksCiAgICApLm5vcm1hbGl6ZSgpOwoKICAgIC8vIEJ1aWxkIGVhc3Qvbm9ydGggZnJvbSB0aGUgbm9ybWFsCiAgICBjb25zdCB3b3JsZFVwID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSk7CiAgICBsZXQgZWFzdCA9IHdvcmxkVXAuY2xvbmUoKS5jcm9zcyhuKS5ub3JtYWxpemUoKTsKICAgIGlmIChlYXN0Lmxlbmd0aFNxKCkgPT09IDApIGVhc3QgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKTsgLy8gcG9sZSBndWFyZAogICAgY29uc3Qgbm9ydGggPSBuLmNsb25lKCkuY3Jvc3MoZWFzdCkubm9ybWFsaXplKCk7CgogICAgLy8gQmFzaXM6IGNvbHVtbnMgPSBlYXN0LCBub3J0aCwgbm9ybWFsCiAgICBjb25zdCBiYXNpcyA9IG5ldyBUSFJFRS5NYXRyaXg0KCkubWFrZUJhc2lzKGVhc3QsIG5vcnRoLCBuKTsKICAgIHJldHVybiBiYXNpczsKfQoKLy8gR2l2ZW4gcG9ydGFsIGJvdCB0YWdzIGFuZCBhIGdpem1vIG9iamVjdDNELCBhbGlnbiBnaXptbyByb3RhdGlvbgpmdW5jdGlvbiBjYWxjTWFwUm90YXRpb24obWFwUG9zaXRpb24sIGF1eFJvdGF0aW9uKSB7CiAgICBjb25zdCBsb24gPSBtYXBQb3NpdGlvbi54OyAvLyBYID0gbG9uZ2l0dWRlIChkZWdyZWVzKQogICAgY29uc3QgbGF0ID0gbWFwUG9zaXRpb24ueTsgLy8gWSA9IGxhdGl0dWRlIChkZWdyZWVzKQogICAgY29uc3QgYXV4UXVhdCA9IGF1eFJvdGF0aW9uLnF1YXRlcm5pb247CgogICAgaWYgKGxvbiA9PSBudWxsIHx8IGxhdCA9PSBudWxsIHx8IGF1eFF1YXQgPT0gbnVsbCkgcmV0dXJuOwoKICAgIGNvbnN0IHF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbihhdXhRdWF0LngsIGF1eFF1YXQueSwgYXV4UXVhdC56LCBhdXhRdWF0LncpOwoKICAgIGNvbnN0IGJhc2lzID0gdGFuZ2VudEJhc2lzRnJvbUxvbkxhdChsb24sIGxhdCk7CiAgICBjb25zdCBiYXNpc0ludiA9IGJhc2lzLmNsb25lKCkuaW52ZXJ0KCk7CiAgICBjb25zdCBiYXNpc0ludlF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21Sb3RhdGlvbk1hdHJpeChiYXNpc0ludik7CgogICAgLy8gQXBwbHkgdGhlIHRhbmdlbnQgY29ycmVjdGlvbgogICAgY29uc3Qgd29ybGRRdWF0ID0gcXVhdC5jbG9uZSgpLnByZW11bHRpcGx5KGJhc2lzSW52UXVhdCk7CgogICAgcmV0dXJuIG5ldyBSb3RhdGlvbih7IHF1YXRlcm5pb246IHsgeDogd29ybGRRdWF0LngsIHk6IHdvcmxkUXVhdC55LCB6OiB3b3JsZFF1YXQueiwgdzogd29ybGRRdWF0LncgfX0pOwp9CgpyZXR1cm4gY2FsY01hcFJvdGF0aW9uKG1hcFBvc2l0aW9uLCBhdXhSb3RhdGlvbik7JwD/4Zm1AvHpCA5hYkZpbGVUaW1lY29kZQIEAP/hmbUC9PcIZkBjb25zdCBkYXRlOiBEYXRlVGltZSA9IHRoYXQ/LmRhdGUgPz8gRGF0ZVRpbWUubm93KCk7CnJldHVybiBkYXRlLnRvVVRDKCkudG9Gb3JtYXQoJ3l5eXlNTWRkLUhIbW1zcycpOycA/+GZtQLx6QgGc3lzdGVtAgQA/+GZtQLb+AgOYWIuc2hlbGwudXRpbHMnAP/hmbUC8ekIDGFiQ29tcGlsZUNTUwIEAP/hmbUC6vgIggRAbGV0IGJvdHMgPSB0aGF0OwoKYm90cyA9IEFycmF5LmlzQXJyYXkoYm90cykgPyBib3RzIDogW2JvdHNdOwoKbGV0IGNzcyA9IFtdOwoKZm9yIChsZXQgYm90IG9mIGJvdHMpIHsKICAgIGZvciAobGV0IGtleSBpbiBib3QudGFncykgewogICAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnY3NzJykpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgQ1NTIGtleTogJHtrZXl9YCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3NzLnB1c2goYm90LnRhZ3Nba2V5XSk7CiAgICAgICAgfQogICAgfQp9Cgpjb25zdCBjb21waWxlZCA9IGNzcy5qb2luKCdcblxuJyk7CmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNvbXBpbGVkIENTUzpcblxuYCwgY29tcGlsZWQpOwp9CgpyZXR1cm4gY29tcGlsZWQ7JwD/4Zm1AvHpCAhhYklnbm9yZQIEAP/hmbUC7fwIBHRydWUnAP/hmbUC8ekIB2FiU2hlbGwCBAD/4Zm1AvL8CAR0cnVlJwD/4Zm1AvHpCAlhYlZlcnNpb24CBAD/4Zm1Avf8CAUxMC4zNycA/+GZtQLx6QgNYWJMb2dBbmRUb2FzdAIEAP/hmbUC/fwIuApAbGV0IG1lc3NhZ2U7CmxldCBkdXJhdGlvbjsKbGV0IGxvZ1R5cGUgPSAnbG9nJzsKbGV0IG5hbWUgPSBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHk7CmxldCB0b2FzdCA9IHRydWU7CmxldCBhYkxvZyA9IHRydWU7CmxldCBjb25zb2xlTG9nID0gdHJ1ZTsKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIG1lc3NhZ2UgPSB0aGF0OwogICAgZHVyYXRpb24gPSB0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0LCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwOwp9IGVsc2UgewogICAgbWVzc2FnZSA9IHRoYXQubWVzc2FnZTsKICAgIGR1cmF0aW9uID0gdGhhdC5kdXJhdGlvbiA/PyAodGhpc0JvdC5lc3RpbWF0ZVJlYWRpbmdUaW1lKHsgdGV4dDogdGhhdC5tZXNzYWdlLCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwKTsKICAgIG5hbWUgPSB0aGF0Lm5hbWUgPz8gbmFtZTsKICAgIGxvZ1R5cGUgPSB0aGF0LmxvZ1R5cGUgPz8gbG9nVHlwZTsKICAgIHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0b2FzdDsKICAgIGFiTG9nID0gdGhhdC5hYkxvZyA/PyBhYkxvZzsKfQoKaWYgKGxvZ1R5cGUgPT09ICdsb2cnKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnd2FybmluZycgfHwgbG9nVHlwZSA9PT0gJ3dhcm4nKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogV2FybmluZzogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUud2FybihuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChgV2FybmluZzogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnZXJyb3InKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogRXJyb3I6ICcgKyBtZXNzYWdlKTsKICAgIGlmIChjb25zb2xlTG9nKSBjb25zb2xlLmVycm9yKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBFcnJvcjogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9JwD/4Zm1AvHpCAhyZW1lbWJlcgIEAP/hmbUCtocJKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAP/hmbUC8ekIBWFiTG9nAgQA/+GZtQLdhwmlAkBpZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICB0aGlzQm90LmFiTG9nQW5kVG9hc3QoewogICAgICAgIG1lc3NhZ2U6IHRoYXQsCiAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgIGFiTG9nOiB0cnVlLAogICAgICAgIGNvbnNvbGVMb2c6IHRydWUsCiAgICB9KTsKfSBlbHNlIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgLi4udGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgYWJMb2c6IHRydWUsCiAgICAgICAgY29uc29sZUxvZzogdHJ1ZSwKICAgIH0pOwp9JwD/4Zm1AvHpCBNlc3RpbWF0ZVJlYWRpbmdUaW1lAgQA/+GZtQKDigncA0Bjb25zdCB7CiAgICB0ZXh0ID0gJycsCiAgICB3b3Jkc1Blck1pbnV0ZSA9IDI1MCwKICAgIGRlbGF5VGltZSA9IDUwMCwKfSA9IHRoYXQ7CgovLyBDb3VudCB3b3JkcyAocm91Z2ggYXBwcm94aW1hdGlvbiBieSBzcGxpdHRpbmcgb24gd2hpdGVzcGFjZSkKY29uc3Qgd29yZENvdW50ID0gdGV4dC50cmltKCkuc3BsaXQoL1xzKy8pLmxlbmd0aDsKbGV0IHRvdGFsVGltZU1zID0gMDsKCmlmICh3b3JkQ291bnQgPiAwKSB7CiAgICAvLyBDYWxjdWxhdGUgcmVhZGluZyB0aW1lIGluIG1pbGxpc2Vjb25kcwogICAgY29uc3Qgd29yZHNQZXJTZWNvbmQgPSB3b3Jkc1Blck1pbnV0ZSAvIDYwOwogICAgY29uc3QgcmVhZGluZ1RpbWVNcyA9IE1hdGguY2VpbCgod29yZENvdW50IC8gd29yZHNQZXJTZWNvbmQpICogMTAwMCk7CgogICAgdG90YWxUaW1lTXMgPSByZWFkaW5nVGltZU1zICsgZGVsYXlUaW1lOwp9CgpyZXR1cm4gdG90YWxUaW1lTXM7JwD/4Zm1AvHpCAhpc09iamVjdAIEAP/hmbUC4I0JOUByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdvYmplY3QnICYmICFBcnJheS5pc0FycmF5KHRoYXQpOycA/+GZtQLx6QgHaXNBcnJheQIEAP/hmbUCmo4JHEByZXR1cm4gQXJyYXkuaXNBcnJheSh0aGF0KTsnAP/hmbUC8ekICGlzU3RyaW5nAgQA/+GZtQK3jgkhQHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZyc7JwD/4Zm1AvHpCA9nZXRFcnJvck1lc3NhZ2UCBAD/4Zm1AtmOCcACQGZ1bmN0aW9uIGdldEVycm9yTWVzc2FnZShlcnJvcikgewogICAgaWYgKGVycm9yKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcnJvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmV0dXJuIGVycm9yOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZSkgewogICAgICAgICAgICByZXR1cm4gZXJyb3IubWVzc2FnZTsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yLmVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck1lc3NhZ2UoZXJyb3IuZXJyb3IpOwogICAgICAgIH0KICAgIH0KfQoKcmV0dXJuIGdldEVycm9yTWVzc2FnZSh0aGF0KTsnAP/hmbUC8ekIB2FiVG9hc3QCBAD/4Zm1ApqRCacCQGlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICBhYkxvZzogZmFsc2UsCiAgICAgICAgY29uc29sZUxvZzogZmFsc2UsCiAgICB9KTsKfSBlbHNlIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgLi4udGhhdCwKICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICBhYkxvZzogZmFsc2UsCiAgICAgICAgY29uc29sZUxvZzogZmFsc2UsCiAgICB9KTsKfScA/+GZtQLx6QgYaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uAgQA/+GZtQLCkwn8AkBsZXQgaGFzUGVybWlzc2lvbiA9IGZhbHNlOwoKdHJ5IHsKICAgIGlmIChnbG9iYWxUaGlzLm5hdmlnYXRvciAmJiBuYXZpZ2F0b3IucGVybWlzc2lvbnMpIHsKICAgICAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCBuYXZpZ2F0b3IucGVybWlzc2lvbnMucXVlcnkoeyBuYW1lOiAnZ2VvbG9jYXRpb24nIH0pOwogICAgICAgIGhhc1Blcm1pc3Npb24gPSBzdGF0dXM/LnN0YXRlID09PSAnZ3JhbnRlZCc7CiAgICB9Cn0gY2F0Y2ggKGUpIHsgCiAgICBjb25zb2xlLmVycm9yKGBDYXVnaHQgYW4gZXJyb3Igd2lsbCBxdWVyeWluZyBwZXJtaXNzaW9ucy4gRXJyb3I6YCwgYWIubGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpKTsKfQoKcmV0dXJuIGhhc1Blcm1pc3Npb247JwD/4Zm1AvHpCAVpc0JvdAIEAP/hmbUCv5YJVEByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdvYmplY3QnICYmIHRoYXQudGFncyAmJiB0aGF0LmlkICYmIHRoYXQuc3BhY2UgJiYgdGhhdC52YXJzOycA/+GZtQLx6QgOYXBwbHlLZXlUb1RleHQCBAD/4Zm1ApSXCeUIQGxldCB7IHRleHQsIGtleSB9ID0gdGhhdDsKCnRleHQgPSAodGV4dCA/PyAnJykudG9TdHJpbmcoKTsKCmNvbnN0IERFQlVHID0gZmFsc2U7Cgpzd2l0Y2ggKGtleSkgewogICAgY2FzZSAnQmFja3NwYWNlJzoKICAgICAgICB0ZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sZW5ndGggLSAxKTsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ0RlbGV0ZSc6CiAgICBjYXNlICdDbGVhcic6CiAgICAgICAgdGV4dCA9ICcnOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnRW50ZXInOgogICAgICAgIHRleHQgKz0gJ1xuJzsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ1RhYic6CiAgICAgICAgLy8gQ29udmVydCB0YWJzIHRvIHNwYWNlcy4KICAgICAgICB0ZXh0ICs9ICcgJy5yZXBlYXQoNCk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdFc2NhcGUnOgogICAgY2FzZSAnU2hpZnQnOgogICAgY2FzZSAnQ2Fwc0xvY2snOgogICAgY2FzZSAnQ29udHJvbCc6CiAgICBjYXNlICdBbHQnOgogICAgY2FzZSAnTWV0YSc6CiAgICBjYXNlICdDb250ZXh0TWVudSc6CiAgICBjYXNlICdQYWdlVXAnOgogICAgY2FzZSAnUGFnZURvd24nOgogICAgY2FzZSAnSG9tZSc6CiAgICBjYXNlICdFbmQnOgogICAgY2FzZSAnSGVscCc6CiAgICBjYXNlICdGMSc6CiAgICBjYXNlICdGMic6CiAgICBjYXNlICdGMyc6CiAgICBjYXNlICdGNCc6CiAgICBjYXNlICdGNSc6CiAgICBjYXNlICdGNic6CiAgICBjYXNlICdGNyc6CiAgICBjYXNlICdGOCc6CiAgICBjYXNlICdGOSc6CiAgICBjYXNlICdGMTAnOgogICAgY2FzZSAnRjExJzoKICAgIGNhc2UgJ0YxMic6CiAgICBjYXNlICdGMTMnOgogICAgY2FzZSAnQXJyb3dVcCc6CiAgICBjYXNlICdBcnJvd1JpZ2h0JzoKICAgIGNhc2UgJ0Fycm93RG93bic6CiAgICBjYXNlICdBcnJvd0xlZnQnOgogICAgICAgIC8vIElnbm9yZSBrZXlzdHJva2UuCiAgICAgICAgaWYgKERFQlVHKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaWdub3Jpbmcga2V5c3Ryb2tlOmAsIGtleSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICB0ZXh0ICs9IGtleTsKfQoKcmV0dXJuIHRleHQ7JwD/4Zm1AvHpCBBhZGp1c3RCcmlnaHRuZXNzAgQA/+GZtQL6nwnqDUBmdW5jdGlvbiBhZGp1c3RCcmlnaHRuZXNzKHsgY29sb3IsIGZhY3RvciB9KSB7CiAgICBsZXQgciwgZywgYiwgYSA9IG51bGw7CiAgICBsZXQgZm9ybWF0ID0gJ2hleCc7CgogICAgaWYgKGNvbG9yLnN0YXJ0c1dpdGgoJyMnKSkgewogICAgICAgIC8vIEhleCBmb3JtYXQKICAgICAgICBjb25zdCBoZXggPSBjb2xvci5zbGljZSgxKTsKCiAgICAgICAgaWYgKGhleC5sZW5ndGggPT09IDMpIHsKICAgICAgICAgICAgciA9IHBhcnNlSW50KGhleFswXSArIGhleFswXSwgMTYpOwogICAgICAgICAgICBnID0gcGFyc2VJbnQoaGV4WzFdICsgaGV4WzFdLCAxNik7CiAgICAgICAgICAgIGIgPSBwYXJzZUludChoZXhbMl0gKyBoZXhbMl0sIDE2KTsKICAgICAgICB9IGVsc2UgaWYgKGhleC5sZW5ndGggPT09IDYpIHsKICAgICAgICAgICAgciA9IHBhcnNlSW50KGhleC5zbGljZSgwLCAyKSwgMTYpOwogICAgICAgICAgICBnID0gcGFyc2VJbnQoaGV4LnNsaWNlKDIsIDQpLCAxNik7CiAgICAgICAgICAgIGIgPSBwYXJzZUludChoZXguc2xpY2UoNCwgNiksIDE2KTsKICAgICAgICB9IGVsc2UgaWYgKGhleC5sZW5ndGggPT09IDgpIHsKICAgICAgICAgICAgciA9IHBhcnNlSW50KGhleC5zbGljZSgwLCAyKSwgMTYpOwogICAgICAgICAgICBnID0gcGFyc2VJbnQoaGV4LnNsaWNlKDIsIDQpLCAxNik7CiAgICAgICAgICAgIGIgPSBwYXJzZUludChoZXguc2xpY2UoNCwgNiksIDE2KTsKICAgICAgICAgICAgYSA9IHBhcnNlSW50KGhleC5zbGljZSg2LCA4KSwgMTYpIC8gMjU1OwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoY29sb3Iuc3RhcnRzV2l0aCgncmdiJykpIHsKICAgICAgICAvLyByZ2IoKSBvciByZ2JhKCkgZm9ybWF0CiAgICAgICAgZm9ybWF0ID0gY29sb3Iuc3RhcnRzV2l0aCgncmdiYScpID8gJ3JnYmEnIDogJ3JnYic7CiAgICAgICAgY29uc3QgdmFsdWVzID0gY29sb3IubWF0Y2goL1tcZC5dKy9nKS5tYXAoTnVtYmVyKTsKICAgICAgICByID0gdmFsdWVzWzBdOwogICAgICAgIGcgPSB2YWx1ZXNbMV07CiAgICAgICAgYiA9IHZhbHVlc1syXTsKICAgICAgICBpZiAodmFsdWVzLmxlbmd0aCA9PT0gNCkgewogICAgICAgICAgICBhID0gdmFsdWVzWzNdOwogICAgICAgICAgICBmb3JtYXQgPSAncmdiYSc7CiAgICAgICAgfQogICAgfQoKICAgIC8vIEFwcGx5IGJyaWdodG5lc3MgZmFjdG9yCiAgICByID0gTWF0aC5taW4oMjU1LCBNYXRoLm1heCgwLCBNYXRoLnJvdW5kKHIgKiBmYWN0b3IpKSk7CiAgICBnID0gTWF0aC5taW4oMjU1LCBNYXRoLm1heCgwLCBNYXRoLnJvdW5kKGcgKiBmYWN0b3IpKSk7CiAgICBiID0gTWF0aC5taW4oMjU1LCBNYXRoLm1heCgwLCBNYXRoLnJvdW5kKGIgKiBmYWN0b3IpKSk7CgogICAgLy8gUmV0dXJuIGluIG9yaWdpbmFsIGZvcm1hdAogICAgaWYgKGZvcm1hdCA9PT0gJ2hleCcpIHsKICAgICAgICBjb25zdCB0b0hleCA9IGMgPT4gYy50b1N0cmluZygxNikucGFkU3RhcnQoMiwgJzAnKTsKICAgICAgICByZXR1cm4gJyMnICsgdG9IZXgocikgKyB0b0hleChnKSArIHRvSGV4KGIpICsgKGEgIT09IG51bGwgPyB0b0hleChNYXRoLnJvdW5kKGEgKiAyNTUpKSA6ICcnKTsKICAgIH0gZWxzZSBpZiAoZm9ybWF0ID09PSAncmdiYScpIHsKICAgICAgICByZXR1cm4gYHJnYmEoJHtyfSwgJHtnfSwgJHtifSwgJHthfSlgOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gYHJnYigke3J9LCAke2d9LCAke2J9KWA7CiAgICB9Cn0KCnJldHVybiBhZGp1c3RCcmlnaHRuZXNzKHRoYXQpOycBBGJvdHMkZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1AScA/+GZtQLlrQkGc3lzdGVtAgQA/+GZtQLmrQkPYWIuc2hlbGwuc2VhcmNoJwD/4Zm1AuWtCQRmb3JtAgQA/+GZtQL2rQkHbm90aGluZycA/+GZtQLlrQkOYWJSZXRyaWV2ZUZpbGUCBAD/4Zm1Av6tCYIBQC8vcHVsbCBkb3duIGZpbGUgZGF0YQppZiAoIXRoYXQudXJsKQp7CiAgICByZXR1cm4gIm5vIGZpbGUgdXJsIHN1cHBsaWVkIjsKfQoKbGV0IGRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKHRoYXQudXJsKTsKCnJldHVybiBkYXRhOycA/+GZtQLlrQkQYWJSZXRyaWV2ZVJlY29yZAIEAP/hmbUCga8J7ARALy9yZXRyaWV2ZSBzcGVjaWZpZWQgcmVjb3JkCmxldCByZWNvcmROYW1lID0gdGhhdC5yZWNvcmROYW1lOwoKbGV0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CgppZiAodGhhdC5yZWNvcmRLZXkpCnsKICAgIHJlY29yZEtleSA9IHRoYXQucmVjb3JkS2V5Owp9CmVsc2UgaWYgKGF1dGhCb3QpCnsKICAgIGlmIChhdXRoQm90LmlkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbykKICAgIHsKICAgICAgICByZWNvcmRLZXkgPSBhdXRoQm90LmlkOwoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgIH0KfQoKbGV0IHJlY29yZEVuZHBvaW50ID0gdGhhdC5yZWNvcmRFbmRwb2ludCA/IHRoYXQucmVjb3JkRW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CgppZiAoIXJlY29yZE5hbWUpCnsKICAgIHJldHVybiAibm8gcmVjb3JkIG5hbWUgc3VwcGxpZWQiOwp9CgpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIHJlY29yZE5hbWUsIHJlY29yZEVuZHBvaW50KTsKCi8vQUREIGFkZGl0aW9uYWwgZXJyb3IgaGFuZGxpbmc/CgpyZXR1cm4gZ2V0UmVjb3JkOycA/+GZtQLlrQkIcmVtZW1iZXICBAD/4Zm1Au6zCSjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwD/4Zm1AuWtCQ1tYW5pZmVzdGF0aW9uAgQA/+GZtQKVtAko8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA/+GZtQLlrQkOb25Mb29rdXBBQkVnZ3MCBAD/4Zm1Ary0Cc8yQGNvbnN0IHsgCiAgICBhYklELAogICAgYWJWZXJzaW9uLAogICAgaW5pdGlhbEJvb3QsCiAgICBhdXRvSGF0Y2gsCiAgICByZXR1cm5UeXBlLAogICAgZWdnUGFyYW1ldGVycywKICAgIGtleSA9IGNvbmZpZ0JvdC50YWdzLmtleSwKICAgIHRvYXN0ID0gdHJ1ZSwKICAgIHNob3dJbmRpY2F0b3IgPSB0cnVlLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsIC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQp9ID0gdGhhdDsKCmxldCB7CiAgICByZWNvcmRLZXkgPSBjb25maWdCb3QudGFncy5zdHVkaW8sCn0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9CgpsaW5rcy51dGlscy5hYkxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogbG9hZGluZyAiICsgYWJJRCk7CgovL2NsZWFyIGFiLTEKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24gJiYgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9PSAiYWJNZW51IikgewogICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7Cn0KCmxldCBidXN5SW5kaWNhdG9yOwoKaWYgKHNob3dJbmRpY2F0b3IpIHsKICAgIGlmICghbGlua3MubWVudSkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7CiAgICB9CgogICAgYnVzeUluZGljYXRvciA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGBsb2FkaW5nICR7YWJJRH1gfSk7Cn0KCmNvbnN0IHBvc3NpYmxlQXV0aCA9IGF1dGhCb3QgPyBhdXRoQm90IDogdHJ1ZTsKbGV0IGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdldFJlY29yZDpgLCB7Li4uZ2V0UmVjb3JkfSk7Cn0KCmxldCBlZ2dEYXRhOwoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgdGhlIHJldHJpZXZlZCBkYXRhLCBzZWFyY2hlcyBhZ2FpbiBpZiBub25lIGNhbWUgdGhyb3VnaAppZiAoIWdldFJlY29yZC5zdWNjZXNzKSB7CiAgICBpZiAocG9zc2libGVBdXRoLmlkID09IHJlY29yZEtleSAmJgogICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXkgJiYKICAgICAgICBnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAicmVjb3JkX25vdF9mb3VuZCIKICAgICkgewogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYWJJRCk7CiAgICB9IGVsc2UgaWYgKGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfYXV0aG9yaXplZCIpIHsKICAgICAgICBpZiAoIXJlY29yZEtleSkgewogICAgICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwogICAgICAgICAgICByZWNvcmRLZXkgPSBhdXRoQm90LmlkOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2xvZ2dlZF9pbiIpIHsKICAgICAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICAgICAgICBpZiAoIXJlY29yZEtleSkgewogICAgICAgICAgICByZWNvcmRLZXkgPSBhdXRoQm90LmlkOwogICAgICAgIH0KCiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKICAgICAgICBpZiAoIWdldFJlY29yZC5zdWNjZXNzICYmIAogICAgICAgICAgICBnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiCiAgICAgICAgKSB7CiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CiAgICAgICAgfQogICAgfQp9CgppZiAoIWdldFJlY29yZC5zdWNjZXNzKSB7CiAgICBpZiAodG9hc3QpIHsgCiAgICAgICAgb3MudG9hc3QoYG5vIGRhdGEgZm91bmQgaW4gJHthYklEfWApOwogICAgfQoKICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgfQoKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KZWxzZSB7CiAgICBjb25zdCBwdWJsaWNSZWFkVGVzdCA9IGdldFJlY29yZC5tYXJrZXJzLmluZGV4T2YoInB1YmxpY1JlYWQiKTsKICAgIGNvbnN0IGF1dGhvciA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgogICAgaWYgKHB1YmxpY1JlYWRUZXN0ICE9IC0xICYmIGF1dGhvcikgewogICAgICAgIGlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgewogICAgICAgICAgICBjb25zdCBlZ2dIYXRjaEV2ZW50ID0gYWJJRDsKCiAgICAgICAgICAgIG9zLnJlY29yZEV2ZW50KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGVnZ0hhdGNoRXZlbnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvL3BhY2thZ2UgdGhlIHJlY29yZCBkYXRhCiAgICBlZ2dEYXRhID0gZ2V0UmVjb3JkLmRhdGE7CgogICAgaWYgKGFiVmVyc2lvbikgewogICAgICAgIC8vIENoYW5nZSBpbml0aWFsIHRhcmdldCB2ZXJzaW9uIG9mIHRoZSBlZ2cgaWYgYWJWZXJzaW9uIGlzIHByb3ZpZGVkLgogICAgICAgIGVnZ0RhdGEudGFyZ2V0VmVyc2lvbiA9IGFiVmVyc2lvbjsKICAgIH0KfQoKaWYgKHJldHVyblR5cGUgIT0gbnVsbCkgewogICAgaWYgKGdldFJlY29yZC5zdWNjZXNzKSB7CiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBsZXQgdmVyc2lvbiA9IGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gLSAxOwoKICAgICAgICAgICAgaWYgKGFiVmVyc2lvbikgewogICAgICAgICAgICAgICAgaWYgKCFpc05hTihhYlZlcnNpb24pKSB7CiAgICAgICAgICAgICAgICAgICAgdmVyc2lvbiA9IGFiVmVyc2lvbiAtIDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IGVnZ0RhdGFVUkwgPSBnZXRSZWNvcmQuZGF0YS5lZ2dWZXJzaW9uSGlzdG9yeVt2ZXJzaW9uXTsKICAgICAgICAgICAgY29uc3QgcmV0dXJuRGF0YSA9IGF3YWl0IG9zLmdldEZpbGUoZWdnRGF0YVVSTCk7CgogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldHVybkRhdGE7CiAgICAgICAgfSBlbHNlIGlmIChyZXR1cm5UeXBlID09PSAiZWdnIikgewogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2ltcGx5IHJldHVybiB0aGUgZWdnIGRhdGEgaWYgcmVxdWVzdGVkLgogICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkLmRhdGE7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICAvLyBUaGlzIGlzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIG9sZCBhdXggZmlsZXMgc3RvcmVkIGJlZm9yZSB0aGUgcmVjb3JkIHN5c3RlbSBleGlzdGVkLgogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgY29uc3QgdmVyc2lvbkFycmF5ID0gSlNPTi5wYXJzZShlZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5KTsKICAgICAgICAgICAgY29uc3QgZmlsZVVVSUQgPSB2ZXJzaW9uQXJyYXlbZWdnRGF0YS5tYXhWZXJzaW9uIC0gMV07CiAgICAgICAgICAgIGNvbnN0IGZpbGVuYW1laGFzaExUTSA9IGNyeXB0by5zaGEyNTYoZmlsZVVVSUQpOwogICAgICAgICAgICBjb25zdCBmaWxldXJsaGFzaExUTSA9ICJhdXhfIiArIGZpbGVuYW1laGFzaExUTSArICcuYXV4JzsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TFRNVVJMID0gImh0dHBzOi8vYnVpbGRlci1sdG0tZmlsZXMuczMuYW1hem9uYXdzLmNvbS8iICsgZmlsZXVybGhhc2hMVE07CiAgICAgICAgICAgIGNvbnN0IG8gPSB7CiAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgICAgICAgdXJsOiB0YXJnZXRMVE1VUkwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGxldCBmaWxlR2V0ID0gYXdhaXQgd2ViaG9vayhvKTsKCiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZmlsZUdldC5zdGF0dXMgIT0gMjAwKSB7CiAgICAgICAgICAgICAgICBpZiAodG9hc3QpIHsKICAgICAgICAgICAgICAgICAgICBvcy50b2FzdCgibm8gZmlsZSBmb3VuZCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHNob3V0KCJhYlJlZnJlc2giKTsKCiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgZmlsZUdldCA9IGZpbGVHZXQuZGF0YTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGZpbGVHZXQ7CiAgICAgICAgfQogICAgfQp9CgovL2FiIHNwZWNpZmljIHZhcmlhYmxlcyBmb3IgdW5kZXJzdGFuZGluZyBpZiBhIHBvc2l0aW9uIGlzIHNwZWNpZmllZApsZXQgY3VycmVudERpbTsKbGV0IHNwYWNlTW9kOwpsZXQgZGltZW5zaW9uWDsKbGV0IGRpbWVuc2lvblk7CmxldCBkaW1Nb2Q7CgovL2hhbmRsZSBkaW1lbnNpb24gaWRlbnRpZmljYXRpb24KaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24pIHsKICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgY29uc3QgYWJCb3QgPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90OwoKICAgICAgICBjdXJyZW50RGltID0gYWJCb3QudGFncy5kaW1lbnNpb247CiAgICB9Cn0KZWxzZSB7CiAgICBjdXJyZW50RGltID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9CgovL2NoZWNrcyBmb3IgZ3JpZCBmb2N1cwppZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkRm9jdXMpIHsKICAgIGRpbWVuc2lvblggPSBudWxsOwogICAgZGltZW5zaW9uWSA9IG51bGw7Cn0KZWxzZSB7CiAgICBsZXQgaGF0Y2hQb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkRm9jdXM7CgogICAgY3VycmVudERpbSA9IGhhdGNoUG9pbnQuZGltZW5zaW9uOwogICAgZGltZW5zaW9uWCA9IGhhdGNoUG9pbnQucG9zaXRpb24ueDsKICAgIGRpbWVuc2lvblkgPSBoYXRjaFBvaW50LnBvc2l0aW9uLnk7CiAgICBzcGFjZU1vZCA9IHsgc3BhY2U6ICJzaGFyZWQiIH07Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGxvZ2ljIGFyb3VuZCBhdXRvSGF0Y2ggdnMgbWFudWFsIGhhdGNoaW5nCmlmICghYXV0b0hhdGNoICYmIGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gPT0gbnVsbCkgewogICAgZGltTW9kID0gewogICAgICAgIFtjdXJyZW50RGltXTogdHJ1ZSwKICAgICAgICBbY3VycmVudERpbSArICJYIl06IGRpbWVuc2lvblgsCiAgICAgICAgW2N1cnJlbnREaW0gKyAiWSJdOiBkaW1lbnNpb25ZLAogICAgICAgIGRpbWVuc2lvbjogY3VycmVudERpbQogICAgfTsKfQplbHNlIHsKICAgIGRpbU1vZCA9IHsgYXV0b0hhdGNoOiB0cnVlLCBrZXkgfTsKfQoKLy9jYWxsIGZvciBvdm8gd2l0aCBpbmZvcm1hdGlvbiBwcm92aWRlZApjb25zdCBtYW5pZmVzdFJlc3VsdCA9IGF3YWl0IHRoaXNCb3QubWFuaWZlc3RPdm8oewogICAgYWJJRCwKICAgIHN0dWRpbzogcmVjb3JkS2V5LAogICAgZGltTW9kLAogICAgc3BhY2VNb2QsCiAgICBlZ2dEYXRhLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0pOwoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBhYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCnJldHVybiB7CiAgICBzdWNjZXNzOiB0cnVlLAogICAgaGF0Y2hlZEJvdHM6IG1hbmlmZXN0UmVzdWx0Py5oYXRjaGVkQm90cywKfTsnAP/hmbUC5a0JC21hbmlmZXN0T3ZvAgQA/+GZtQKM5wnUD0Bjb25zdCB7IAogICAgYWJJRCwKICAgIHN0dWRpbywKICAgIGluaXRpYWxCb290LAogICAgc3BhY2VNb2QsCiAgICBkaW1Nb2QsCiAgICBlZ2dEYXRhLAogICAgZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50LAp9ID0gdGhhdDsKCi8vZWdnIHZpc3VhbGl6YXRpb24Kc2hvdXQoImFiTWVudVJlc2V0Iik7CgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QgJiYgIWNvbmZpZ0JvdC50YWdzLmFiU3RheUF3YWtlKSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KTsKICAgIH0KfQoKaWYgKGxpbmtzLm92b0JvdCkgewogICAgZGVzdHJveShsaW5rcy5vdm9Cb3QpOwp9CgpsZXQgZWdnTW9kID0gewogICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgaW5pdGlhbFRpbWVyOiB0cnVlLAogICAgYWJJRCwKICAgIHN0dWRpbywKICAgIGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVycywKICAgIHNvdXJjZUV2ZW50LAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb25DbGljazogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLmludGVyYWN0T3ZvKCk7CiAgICBgLAogICAgZm9ybTogImVnZyIsCiAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgIHByb2dyZXNzQmFyQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3IsCiAgICBwcm9ncmVzc0JhckJhY2tncm91bmRDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC41LAogICAgb25Qb2ludGVyRW50ZXI6IGBACiAgICAgICAgbWFza3MudGlwSWQgPSBhd2FpdCBvcy50aXAodGFncy5hYklEICsgJyB2JyArIHRhZ3MudGFyZ2V0VmVyc2lvbik7CiAgICBgLAogICAgb25Qb2ludGVyRXhpdDogYEAKICAgICAgICBpZiAobWFza3MudGlwSWQpIHsKICAgICAgICAgICAgb3MuaGlkZVRpcHMobWFza3MudGlwSWQpOwogICAgICAgIH0KICAgIGAsCiAgICBsYWJlbFBvc2l0aW9uOiAiZnJvbnQiLAogICAgb3JpZW50YXRpb25Nb2RlOiAiYmlsbGJvYXJkRnJvbnQiLAogICAgb25EZXN0cm95OiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3Mub3ZvQm90ID0gbnVsbDsKICAgIGAsCiAgICBlZ2dUaW1lcjogYEAKICAgICAgICBpZiAodGFncy5wcm9ncmVzc0JhciA8IDEpIHsKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciArPSAwLjE7CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90Lm9uQ2xpY2soKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgPSBudWxsOwogICAgICAgIH0KICAgIGAKfTsKCgpjb25zdCBvdm8gPSBhd2FpdCBjcmVhdGUoZWdnRGF0YSwgZWdnTW9kLCBkaW1Nb2QsIHNwYWNlTW9kKTsKbWFza3Mub3ZvQm90ID0gZ2V0TGluayhvdm8pOwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSkgewogICAgb3ZvLnZhcnMub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwp9CgppZiAob3ZvLnRhZ3MuYXV0b0hhdGNoKSB7CiAgICBjb25zdCBoYXRjaGVkQm90cyA9IGF3YWl0IHRoaXNCb3QuaGF0Y2hPdm8ob3ZvKTsKICAgIHJldHVybiB7IGhhdGNoZWRCb3RzIH07Cn0KZWxzZSB7CiAgICBvdm8udGFncy5wcm9ncmVzc0JhciA9IDA7CiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gb3ZvLnRhZ3MubWF4VmVyc2lvbjsKICAgIHNldFRpbWVvdXQoKCkgPT4geyB3aGlzcGVyKG92bywgImVnZ1RpbWVyIik7IH0sIDc1KTsKfScA/+GZtQLlrQkJb25LZXlEb3duAgQA/+GZtQLh9gmCBkAvL2hpZGRlbiB2ZXJzaW9uIGJ1dHRvbiBmb3IgaGF0Y2ggbWVudQppZiAoIWxpbmtzLm92b0JvdCB8fCBjb25maWdCb3QudGFncy5tZW51UG9ydGFsICE9ICJhYk92b01lbnUiKQp7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LmtleXMgPT0gIlNoaWZ0IikKewogICAgbGV0IHZlcnNpb25CdXR0b24gPSB7fTsKCiAgICB2ZXJzaW9uQnV0dG9uLmFiT3ZvTWVudSA9IHRydWU7CiAgICB2ZXJzaW9uQnV0dG9uLm92b1NvcnRPcmRlciA9IC0xOwogICAgdmVyc2lvbkJ1dHRvbi5tYXhWZXJzaW9uID0gbGlua3Mub3ZvQm90LnRhZ3MubWF4VmVyc2lvbjsKICAgIHZlcnNpb25CdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7CiAgICB2ZXJzaW9uQnV0dG9uLmxhYmVsID0gImNoYW5nZSBlZ2cgdmVyc2lvbiI7CiAgICB2ZXJzaW9uQnV0dG9uLmxhYmVsQWxpZ25tZW50ID0gImNlbnRlciI7CiAgICB2ZXJzaW9uQnV0dG9uLm92b01lbnVSZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKICAgIHZlcnNpb25CdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yOwogICAgdmVyc2lvbkJ1dHRvbi5vbktleVVwID0gIkAgaWYodGhhdC5rZXlzID09ICdTaGlmdCcpe2Rlc3Ryb3kodGhpc0JvdCl9OyI7CiAgICB2ZXJzaW9uQnV0dG9uLm9uQ2xpY2sgPSAiQCBsaW5rcy5tYW5hZ2VyLmNoYW5nZU92b1ZlcnNpb24oKTsiOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHZlcnNpb25CdXR0b24pOwp9JwD/4Zm1AuWtCQhoYXRjaE92bwIEAP/hmbUC4vwJnRVALy9sb2dpYyBmb3IgaGF0Y2hpbmcgb2YgYW4gYWIKc2hvdXQoJ292b01lbnVSZXNldCcpOwoKLy9kYXRhIGluIHJlZ2FyZHMgdG8gd2hhdCBhYiBpcyBnb2luZyB0byBiZSBoYXRjaGVkCmNvbnN0IG92byA9IHRoYXQ7CgovL2hhdGNoIHNwZWNpZmljIHZhcmlhYmxlcwpsZXQgaW5pdGlhbEJvb3QgPSBvdm8udGFncy5pbml0aWFsQm9vdDsKbGV0IHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5zdGFibGVWZXJzaW9uID8/IG92by50YWdzLnRhcmdldFZlcnNpb247CgppZiAoKGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbiB8fCBjb25maWdCb3QudGFncy5wYXR0ZXJuVmVyc2lvbikgJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbiA/PyBjb25maWdCb3QudGFncy5wYXR0ZXJuVmVyc2lvbjsKfQoKLy90YXJnZXRlZCB2ZXJzaW9ucwppZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIgfHwgIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKSkKewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImZlZWRiYWNrIikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uOwogICAgfQogICAgZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiY3VycmVudCIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKICAgIH0KICAgIGVsc2UgaWYgKCFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MudmVyc2lvbgogICAgfQoKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBudWxsOwp9CgppZiAoaXNOYU4odGFyZ2V0VmVyc2lvbikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7Cn0KCmxldCB2ZXJzaW9uQXJyYXkgPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeTsKbGV0IGZpbGVVUkwgPSB2ZXJzaW9uQXJyYXlbdGFyZ2V0VmVyc2lvbiAtIDFdOwpsZXQga2V5ID0gb3ZvLnRhZ3Mua2V5ID8gb3ZvLnRhZ3Mua2V5IDogY29uZmlnQm90LnRhZ3Mua2V5OwpsZXQgZmlsZUdldDsKCi8vYWN0dWFsIGZpbGUgcmV0cmlldmFsCnRyeQp7CiAgICBmaWxlR2V0ID0gYXdhaXQgb3MuZ2V0RmlsZShmaWxlVVJMKTsKfQpjYXRjaCAoZSkKewogICAgY29uc29sZS5lcnJvcihlKTsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJ25vIGZpbGUgZm91bmQnKTsKCiAgICByZXR1cm47Cn0KCi8vaGFuZGxpbmcgZm9yIGVuY3J5cHRlZCBhYiBmaWxlCmlmIChjcnlwdG8uaXNFbmNyeXB0ZWQoZmlsZUdldCkpCnsKICAgIGlmICgha2V5KQogICAgewogICAgICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgnJywgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdFbnRlciBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgZmlsZUdldCA9IGNyeXB0by5kZWNyeXB0KGtleSwgZmlsZUdldCk7CgogICAgaWYgKGZpbGVHZXQgPT0gbnVsbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJ2luY29ycmVjdCBrZXknKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgIAogICAgZmlsZUdldCA9IEpTT04ucGFyc2UoZmlsZUdldCk7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQplbHNlCnsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CgovL2NsZWFuIHVwCmRlc3Ryb3kob3ZvKTsKCi8vdG9hc3QgaWYgbm90IG9uIHN0YWJsZQppZihvdm8udGFncy5zdGFibGVWZXJzaW9uICE9IHRhcmdldFZlcnNpb24gJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50KQp7CiAgICBpZiAob3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uID09IHRhcmdldFZlcnNpb24pCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWQgZmVlZGJhY2sgdmVyc2lvbiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWQgdmVyc2lvbiAiICsgdGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCArICIgb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQp9CgovL2dlbmVyYXRlIGJvdHMgYmFzZWQgb24gdGhlIGZpbGUgcmV0cmlldmVkICpIRVJFKgpjb25zdCBuZXdCb3RzID0gYXdhaXQgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7CiAgICBib3RzOiBmaWxlR2V0LAogICAgb3JpZ2luOiBvdm8udGFncy5hYklELAogICAgc3R1ZGlvOiBvdm8udGFncy5zdHVkaW8sCiAgICB2ZXJzaW9uOiB0YXJnZXRWZXJzaW9uLAogICAgaW5pdGlhbEJvb3Q6IGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVyczogb3ZvLnRhZ3MuZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogb3ZvLnZhcnMub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQ6IG92by50YWdzLnNvdXJjZUV2ZW50LAp9KTsKCnJldHVybiBuZXdCb3RzOycA/+GZtQLlrQkLaW50ZXJhY3RPdm8CBAD/4Zm1AoCSCukGQC8vbWFudWFsIGhhdGNoIG1lbnUKY29uc3Qgb3ZvQm90ID0gdGhhdCA/IHRoYXQgOiBsaW5rcy5vdm9Cb3Q7CgppZiAoIW92b0JvdCkgewogICAgcmV0dXJuOwp9CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk92b01lbnUiOwoKbWFza3Mub25HcmlkQ2xpY2sgPSBgQAogICAgc2hvdXQoIm92b01lbnVSZXNldCIpOwpgOwptYXNrcy5vdm9NZW51UmVzZXQgPSBgQAogICAgbWFza3Mub25HcmlkQ2xpY2sgPSBudWxsOwogICAgbWFza3Mub3ZvTWVudVJlc2V0ID0gbnVsbDsKCiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7Cgpvcy50d2VlblRvKG92b0JvdCwgMTUsNDUsNDUsIDUpOwoKY29uc3QgZWdnTWVudUJ1dHRvbiA9IHsKICAgIGFiT3ZvTWVudTogdHJ1ZSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvdm9Cb3Q6IGdldExpbmsob3ZvQm90KSwKICAgIGNvbG9yOiBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICB0YXJnZXRWZXJzaW9uOiBvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uLAogICAgbGFiZWw6IGBoYXRjaCAke292b0JvdC50YWdzLmFiSUR9IHYke292b0JvdC50YWdzLnRhcmdldFZlcnNpb259IG9mICR7b3ZvQm90LnRhZ3MubWF4VmVyc2lvbn1gLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgb3ZvTWVudVJlc2V0OiBgQAogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICBgLAogICAgb25DbGljazogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLmhhdGNoT3ZvKGxpbmtzLm92b0JvdCk7CiAgICBgLAp9OwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oZWdnTWVudUJ1dHRvbik7JwD/4Zm1AuWtCQZjcmVhdGUCBAD/4Zm1AuqYCijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwD/4Zm1AuWtCRBjaGFuZ2VPdm9WZXJzaW9uAgQA/+GZtQKRmQrwAkAvL2xvZ2ljIGZvciB2ZXJzaW9uIGNoYW5naW5nIHdoZW4gbWFudWFsbHkgaGF0Y2hpbmcgYW4gYWIKY29uc3Qgb3ZvQm90ID0gbGlua3Mub3ZvQm90OwoKbGV0IG5ld1ZlcnNpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQob3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwgewogICAgcGxhY2Vob2xkZXI6ICJlbnRlciBhIHZlcnNpb24gZnJvbSAxIHRvICIgKyBvdm9Cb3QudGFncy5tYXhWZXJzaW9uCn0pOwoKb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiA9IG5ld1ZlcnNpb247Cm92b0JvdC50YWdzLmxhYmVsID0gJ3YnKyBuZXdWZXJzaW9uOwoKY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG5ld1ZlcnNpb247CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7JwD/4Zm1AuWtCQRtZW51AgQA/+GZtQKCnAoo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA/+GZtQLlrQkIYWJJZ25vcmUCBAD/4Zm1AqmcCgR0cnVlJwD/4Zm1AuWtCQdhYlNoZWxsAgQA/+GZtQKunAoEdHJ1ZScA/+GZtQLlrQkMYWIxTFRNU2VhcmNoAgQA/+GZtQKznAozQC8vc3VwcG9ydCBvbGQgc3ludGF4CnRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7JwD/4Zm1AuWtCQ1vbkxvb2t1cEFza0lEAgQA/+GZtQLnnAqyIEBjb25zdCBhc2tJRCA9IHRoYXQ/LmFza0lEOwpjb25zdCBzaG93SW5kaWNhdG9yID0gdGhhdD8uc2hvd0luZGljYXRvciA/PyB0cnVlOwpjb25zdCBhdXRvSGF0Y2ggPSB0aGF0Py5hdXRvSGF0Y2ggPz8gdHJ1ZTsKY29uc3QgZWdnUGFyYW1ldGVycyA9IHRoYXQ/LmVnZ1BhcmFtZXRlcnM7CmNvbnN0IHNvdXJjZUV2ZW50ID0gdGhhdD8uc291cmNlRXZlbnQ7CmNvbnN0IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IHRoYXQ/Lm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsKY29uc3QgaWdub3JlUmVzZXJ2ZWQgPSB0aGF0Py5pZ25vcmVSZXNlcnZlZDsKY29uc3QgZGF0YU9ubHkgPSB0aGF0Py5kYXRhT25seSA/PyBmYWxzZTsKCmFzc2VydCh0eXBlb2YgYXNrSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmxldCBsb29rdXBBc2s6IEFCTG9va3VwQXNrSURSZXN1bHQ7CmxldCBidXN5SW5kaWNhdG9yOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvb2tpbmcgdXAgJHthc2tJRH1gIH0pOwp9CgovL0NoZWNrIGZvciByZXNlcnZlZCBrZXl3b3JkcwppZiAobGlua3M/LmxlYXJuPy50YWdzPy5yZXNlcnZlZEFza3M/LmluY2x1ZGVzKGFza0lEKSAmJiAhaWdub3JlUmVzZXJ2ZWQgJiYgYXV0aEJvdCkgewogICAgaWYgKCFnZXRCb3QoImFiSURPcmlnaW4iLCBhc2tJRCkpIHsKICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCB0aGlzQm90Lmxvb2t1cEZyb21TdHVkaW8oey4uLnRoYXQsIHJlc2VydmVkOiB0cnVlLCBkYXRhT25seSB9KTsKICAgICAgICBpZiAobG9va3VwQXNrICYmIGxvb2t1cEFzay5zdWNjZXNzID09IHRydWUpIHsKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmV0dXJuaW5nIHJlc2VydmVkIGFzayAnJHthc2tJRH0nIGZvdW5kIGluIHN0dWRpbzpgLCBsb29rdXBBc2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBsb29rdXBBc2s7CiAgICAgICAgfQogICAgfQp9CgovLyBGaXJzdCBjaGVjayB0aGUgY2FzdWFsIGNhdGFsb2cgZm9yIHRoZSBhc2suCmNvbnN0IGNhc3VhbENhdGFsb2dVUkwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2Fza3MvJHthc2tJRH0uYXV4YCk7Cgp0cnkgewogICAgY29uc3QgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICdHRVQnLCB1cmw6IGNhc3VhbENhdGFsb2dVUkwgfSk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhc3VhbCBjYXRhbG9nIHJlc3BvbnNlOmAsIGNhc3VhbENhdGFsb2dSZXNwb25zZSk7CiAgICB9CgogICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgIGlmIChjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAxICYmIGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnN0YXRlKSB7CiAgICAgICAgICAgIGlmIChkYXRhT25seSkgewogICAgICAgICAgICAgICAgbG9va3VwQXNrID0gewogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gQ2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UgaXMgYSB2MSBhdXggZmlsZS4KICAgICAgICAgICAgICAgIGNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgCiAgICAgICAgICAgICAgICAgICAgYm90czogY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgaWdub3JlR3JpZEZvY3VzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9yaWdpbjogYXNrSUQsCiAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICAgICAgICAgICAgICAgICAgc291cmNlRXZlbnQsCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycsCiAgICAgICAgICAgICAgICAgICAgaGF0Y2hlZEJvdHM6IG5ld0JvdHMsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIgJiYgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcykgewogICAgICAgICAgICAvLyBDYXN1YWwgY2F0YWxvZyByZXNwb25zZSBpcyBhIHYyIGF1eCBmaWxlLgogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFza3Mgb25seSBzdXBwb3J0IHYxIGF1eCBmaWxlIGZvcm1hdC5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CgogICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIHJlc3BvbnNlLgogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS5gLCBjYXN1YWxDYXRhbG9nUmVzcG9uc2UpOwogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFVucmVjb2duaXplZCBjYXN1YWwgY2F0YWxvZyBhc2sgcmVzcG9uc2UuIENoZWNrIGNvbnNvbGUgZm9yIG1vcmUgZGV0YWlscy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CgogICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJldHVybmluZyBhc2sgJyR7YXNrSUR9JyBmb3VuZCBpbiBjYXN1YWwgY2F0YWxvZzpgLCBsb29rdXBBc2spCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbG9va3VwQXNrOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICAvLyBEaWQgbm90IGZpbmQgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLgp9Cgpsb29rdXBBc2sgPSBhd2FpdCB0aGlzQm90Lmxvb2t1cEZyb21TdHVkaW8odGhhdCk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBGcm9tU3R1ZGlvIHJlc3VsdDpgLCB7Li4ubG9va3VwQXNrfSk7Cn0KCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gbG9va3VwQXNrOycA/+GZtQLlrQkFdHlwZXMCBAD/4Zm1Apq9CvYB8J+ThHR5cGUgQUJBc2tJRE9yaWdpbiA9ICdjYXN1YWxfY2F0YWxvZycgfCAnYWJfcmVjb3JkJzsKCmludGVyZmFjZSBBQkxvb2t1cEFza0lEUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICBvcmlnaW46IEFCQXNrSURPcmlnaW47CiAgICBoYXRjaGVkQm90cz86IEJvdFtdOwp9CgppbnRlcmZhY2UgQUJMb29rdXBFZ2dSZXN1bHQgewogICAgc3VjY2VzczogYm9vbGVhbiwKICAgIGhhdGNoZWRCb3RzPzogQm90W10sCn0KJwD/4Zm1AuWtCQVpbnB1dAIEAP/hmbUCj78KKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAP/hmbUC5a0JBWhhdGNoAgQA/+GZtQK2vwrAAUAvL3Nob3V0KCJoYXRjaCIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywga2V5OiBrZXksIGF1dG9IYXRjaDogYm9vbGVhbiwgcmV0dXJuVHlwZTogZGF0YS9udWxsLCBlZ2dQYXJhbWV0ZXJzOiBhcmd9KTsKCmNvbnN0IGxvb2tVcCA9IGF3YWl0IHRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7CgpyZXR1cm4gbG9va1VwOycA/+GZtQLlrQkJYWJWZXJzaW9uAgQA/+GZtQL3wAoFMTAuMzcnAP/hmbUC5a0JBWxlYXJuAgQA/+GZtQL9wAoo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA/+GZtQLlrQkFdXRpbHMCBAD/4Zm1AqTBCijwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwD/4Zm1AuWtCQtwZXJzb25hbGl0eQIEAP/hmbUCy8EKKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAP/hmbUC5a0JEGxvb2t1cEZyb21TdHVkaW8CBAD/4Zm1AvLBCvgqQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7DQpjb25zdCBhdXRvSGF0Y2ggPSB0aGF0Py5hdXRvSGF0Y2ggPz8gdHJ1ZTsNCmNvbnN0IGVnZ1BhcmFtZXRlcnMgPSB0aGF0Py5lZ2dQYXJhbWV0ZXJzOw0KY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsNCmNvbnN0IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IHRoYXQ/Lm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsNCmNvbnN0IHJlc2VydmVkID0gdGhhdD8ucmVzZXJ2ZWQ7DQpjb25zdCBpc0NoYW5uZWwgPSB0aGF0Py5pc0NoYW5uZWw7DQpjb25zdCBpc1VVQUIgPSB0aGF0Py5pc1VVQUI7DQpjb25zdCBkYXRhT25seSA9IHRoYXQ/LmRhdGFPbmx5ID8/IGZhbHNlOw0KDQpsZXQgbG9va3VwQXNrOiBBQkxvb2t1cEFza0lEUmVzdWx0Ow0KbGV0IHVzZWRTdHVkaW87DQoNCmlmICh0YWdzLmRlYnVnKSB7DQogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7DQp9DQoNCi8vIENoZWNrIHRoZSBhYiByZWNvcmQgZm9yIHRoZSBhc2suDQpjb25zdCBhYkZvcm1hdHRlZEFza0lEID0gYXNrSUQucmVwbGFjZUFsbCgiLSIsICIiKTsNCg0KaWYgKHRhZ3MuZGVidWcpIHsNCiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiRm9ybWF0dGVkQXNrSUQ6YCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQp9DQoNCmlmIChyZXNlcnZlZCkgew0KICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8pIHsNCiAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyAhPSBhdXRoQm90LmlkKSB7DQogICAgICAgICAgICBjb25zdCBwZXJtcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOw0KICAgICAgICAgICAgaWYgKHBlcm1zLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgICAgICBjb25zdCBmb3VuZCA9IHBlcm1zLnN0dWRpb3MuZmluZCgoc3R1ZCkgPT4gew0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHN0dWQuc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogVXNlciBwZXJtaXNzaW9ucyBmb3Igc3R1ZGlvIiwgZm91bmQsIHBlcm1zKTsNCiAgICAgICAgICAgICAgICBpZiAoIWZvdW5kKSB7DQogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBVc2VyIGRvZXMgbm90IGhhdmUgcGVybWlzc2lvbnMgZm9yIHRoaXMgc3R1ZGlvLiIpDQogICAgICAgICAgICAgICAgICAgIHJldHVybiBsb29rdXBBc2s7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHVzZWRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zdHVkaW87DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgaWYgKCFsb29rdXBBc2suc3VjY2VzcyAmJiBsb29rdXBBc2suZXJyb3JDb2RlICYmIGxvb2t1cEFzay5lcnJvckNvZGUgPT0gJ25vdF9hdXRob3JpemVkJykgew0KICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbywgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IGZhaWx1cmUgbG9va2luZyB1cCBhc2sgaW4gc3R1ZGlvIiwgey4uLmxvb2t1cEFza30pOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogTG9va2VkIHVwIGFzayBpbiBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgICB1c2VkU3R1ZGlvID0gYXV0aEJvdD8uaWQ7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdD8uaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzICYmIGxvb2t1cEFzay5lcnJvckNvZGUgJiYgbG9va3VwQXNrLmVycm9yQ29kZSA9PSAnbm90X2F1dGhvcml6ZWQnKSB7DQogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oYXV0aEJvdD8uaWQpOw0KICAgICAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90Py5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzKSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IGZhaWx1cmUgbG9va2luZyB1cCBhc2sgaW4gdXNlciBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBMb29rZWQgdXAgYXNrIGluIHVzZXIgc3R1ZGlvIiwgey4uLmxvb2t1cEFza30pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KfSBlbHNlIHsNCiAgICB1c2VkU3R1ZGlvID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsNCiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGBhc2tfJHthYkZvcm1hdHRlZEFza0lEfWAsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludCk7DQogICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2sgYXR0ZW1wdCAxOmAsIHsuLi5sb29rdXBBc2t9KTsNCiAgICB9DQogICAgaWYgKCFsb29rdXBBc2suc3VjY2Vzcykgew0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiRm9ybWF0dGVkQXNrSUQsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludCk7DQogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFzayBhdHRlbXB0IDI6YCwgey4uLmxvb2t1cEFza30pOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKCFsb29rdXBBc2suc3VjY2VzcyAmJiBpc1VVQUIpIHsNCiAgICAgICAgdXNlZFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkOw0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMyAoaXNVVUFCKTpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgIH0NCiAgICAgICAgaWYobG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MgJiYgaXNDaGFubmVsKSB7DQogICAgICAgIHVzZWRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZDsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFzayBhdHRlbXB0IDMgKGlzQ2hhbm5lbCk6YCwgey4uLmxvb2t1cEFza30pOw0KICAgICAgICB9DQogICAgICAgIGlmKGxvb2t1cEFzay5lcnJvckNvZGUgJiYgbG9va3VwQXNrLmVycm9yQ29kZSA9PSAnbm90X2F1dGhvcml6ZWQnKSB7DQogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQpOw0KICAgICAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCmxvb2t1cEFzay5vcmlnaW4gPSAnYWJfcmVjb3JkJzsNCg0KaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmIChsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQgfHwgcmVzZXJ2ZWQgfHwgaXNDaGFubmVsIHx8IGlzVVVBQikpIHsNCiAgICBpZiAoZGF0YU9ubHkpIHsNCiAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsNCiAgICB9IGVsc2Ugew0KICAgICAgICAvLyBMb29rdXAgdGhlIGVnZyB1c2luZyB0aGUgc3R1ZGlvSUQgYW5kIHBhdHRlcm5JRCBmcm9tIHRoZSBhYl9yZWNvcmQgYXNrLg0KICAgICAgICBjb25zdCBsb29rdXBFZ2c6IEFCTG9va3VwRWdnUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh7IGFiSUQ6IChyZXNlcnZlZCB8fCBpc0NoYW5uZWwgfHwgaXNVVUFCKSA/IGFiRm9ybWF0dGVkQXNrSUQgOiBsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQsIHJlY29yZEtleTogbG9va3VwQXNrLmRhdGEuc3R1ZGlvSUQgPz8gdXNlZFN0dWRpbywgYXV0b0hhdGNoLCBlZ2dQYXJhbWV0ZXJzLCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIHNvdXJjZUV2ZW50IH0pOw0KICAgICAgICANCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwRWdnOmAsIHsuLi5sb29rdXBFZ2d9KTsNCiAgICAgICAgfQ0KDQogICAgICAgIGxvb2t1cEFzay5zdWNjZXNzID0gbG9va3VwRWdnLnN1Y2Nlc3M7DQogICAgICAgIGxvb2t1cEFzay5oYXRjaGVkQm90cyA9IGxvb2t1cEVnZy5oYXRjaGVkQm90czsNCiAgICB9DQp9IGVsc2UgaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmICFsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQgJiYgIWxvb2t1cEFzay5kYXRhLnVybCkgew0KICAgIGxvb2t1cEFzay5zdWNjZXNzID0gZmFsc2U7DQp9DQoNCnJldHVybiBsb29rdXBBc2s7JwD/4Zm1AuWtCQVkZWJ1ZwIEAP/hmbUC6+wKBHRydWUnAP/hmbUC5a0JGmFiQ2FzdWFsQ2F0YWxvZ0Fza0lERXhpc3RzAgQA/+GZtQLw7AqCB0Bjb25zdCBhc2tJRCA9IHRoYXQ/LmFza0lEOwpjb25zdCB1cmwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2Fza3MvJHthc2tJRH0uYXV4YCk7CgpsZXQgZXhpc3RzOwpsZXQgcmVzcG9uc2U7Cgp0cnkgewogICAgcmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7CiAgICAgICAgbWV0aG9kOiAnSEVBRCcsCiAgICAgICAgdXJsLAogICAgfSkKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVzcG9uc2U6YCwgcmVzcG9uc2UpOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICAvLyBDYWxsIHRvIGNhc3VhbCBjYXRhbG9nIGhhcyBmYWlsZWQsIHRoZSBhc2sgaWQgZG9lcyBub3QgZXhpc3QgdGhlcmUuCiAgICAvLyBOT1RFOiBJdCB3b3VsZCBiZSBuaWNlIGlmIHRoZSBDYXN1YWwgQ2F0YWxvZyBlbmRwb2ludCByZXR1cm5lZCBhIDQwNCBOb3QgRm91bmQgc3RhdHVzIGNvZGUganVzdCBzbyB3ZSBjYW4gcnVsZSBvdXQgYWN0dWFsIHNlcnZlciBlcnJvcnMuCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYXVnaHQgYW4gZXJyb3I6YCwgZSk7CiAgICB9CgogICAgZXhpc3RzID0gZmFsc2U7Cn0KCmlmIChyZXNwb25zZSAmJiByZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgZXhpc3RzID0gdHJ1ZTsKfSBlbHNlIHsKICAgIGV4aXN0cyA9IGZhbHNlOwp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhc2tJRCAnJHthc2tJRH0nIGV4aXN0cyBpbiBjYXN1YWwgY2F0YWxvZz9gLCBleGlzdHMpOwp9CgpyZXR1cm4gZXhpc3RzOwonAP/hmbUC5a0JGWFiQ2hlY2tBc2tVcGRhdGVBdmFpbGFibGUCBAD/4Zm1AvPzCssOQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IGN1cnJlbnRIYXNoID0gdGhhdD8uY3VycmVudEhhc2g7CmNvbnN0IGhhc2hBbGdvcml0aG0gPSB0aGF0Py5oYXNoQWxnb3JpdGhtID8/ICdzaGExJzsKY29uc3QgaGFzaEZvcm1hdCA9IHRoYXQ/Lmhhc2hGb3JtYXQgPz8gJ2hleCc7Cgphc3NlcnQodHlwZW9mIGFza0lEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhc2tJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgY3VycmVudEhhc2ggPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGN1cnJlbnRIYXNoIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKQoKY29uc3QgYXNrRGF0YSA9IGF3YWl0IGFiLmxpbmtzLnNlYXJjaC5vbkxvb2t1cEFza0lEKHsgYXNrSUQsIHNob3dJbmRpY2F0b3I6IGZhbHNlLCBkYXRhT25seTogdHJ1ZSwgc291cmNlRXZlbnQ6ICdhc2tfdXBkYXRlX2NoZWNrJyB9KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0RhdGE6YCwgYXNrRGF0YSk7Cn0KCmlmIChhc2tEYXRhLnN1Y2Nlc3MpIHsKICAgIGlmIChhc2tEYXRhLmRhdGEucGF0dGVybklEICYmIGFza0RhdGEuZGF0YS5zdHVkaW9JRCkgewogICAgICAgIC8vIEFzayBpcyBhIHBvaW50ZXIgdG8gYW4gZWdnIGluIGEgc3R1ZGlvLgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGFiRGF0YSA9IGF3YWl0IGFiLmxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7IGFiSUQ6IGFza0RhdGEuZGF0YS5wYXR0ZXJuSUQsIHJlY29yZEtleTogYXNrRGF0YS5kYXRhLnN0dWRpb0lELCByZXR1cm5UeXBlOiAnZGF0YSd9KTsKICAgICAgICAgICAgY29uc3QgbGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFiRGF0YS5zdGF0ZSk7CgogICAgICAgICAgICByZXR1cm4geyAKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICAgICAgY3VycmVudEhhc2gsCiAgICAgICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2h0IGFuIGVycm9yLmAsIGUpOwogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICAgICAgfQogICAgfSAgZWxzZSBpZiAoYXNrRGF0YS5kYXRhLnZlcnNpb24gPT09IDEgJiYgYXNrRGF0YS5kYXRhLnN0YXRlKSB7CiAgICAgICAgLy8gQXNrIGlzIGEgdjEgYXV4IGZpbGUuCiAgICAgICAgY29uc3QgbGF0ZXN0SGFzaCA9IGNyeXB0by5oYXNoKGhhc2hBbGdvcml0aG0sIGhhc2hGb3JtYXQsIGFza0RhdGEuZGF0YS5zdGF0ZSk7CgogICAgICAgIHJldHVybiB7IAogICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGN1cnJlbnRIYXNoICE9PSBsYXRlc3RIYXNoLAogICAgICAgICAgICBjdXJyZW50SGFzaCwKICAgICAgICAgICAgbGF0ZXN0SGFzaCwKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgYXNrRGF0YSBzdHJ1Y3R1cmUuYCwgYXNrRGF0YSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9IGVsc2UgewogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQp9CicA/+GZtQLlrQkZYWJDaGVja0VnZ1VwZGF0ZUF2YWlsYWJsZQIEAP/hmbUCv4ILmQdAY29uc3QgYWJJRCA9IHRoYXQ/LmFiSUQ7CmNvbnN0IGN1cnJlbnRBQlZlcnNpb24gPSB0aGF0Py5jdXJyZW50QUJWZXJzaW9uOyAvLyAxLWJhc2VkIHZlcnNpb24gbnVtYmVyLgpjb25zdCByZWNvcmRLZXlPck5hbWUgPSB0aGF0Py5yZWNvcmRLZXlPck5hbWU7Cgphc3NlcnQodHlwZW9mIGFiSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyYCk7CmFzc2VydChOdW1iZXIuaXNJbnRlZ2VyKGN1cnJlbnRBQlZlcnNpb24pICYmIGN1cnJlbnRBQlZlcnNpb24gPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGN1cnJlbnRBQlZlcnNpb24gbXVzdCBiZSBhbiBpbnRlZ2VyIGdyZWF0ZXIgdGhhbiAwLmApOwphc3NlcnQodHlwZW9mIHJlY29yZEtleU9yTmFtZSA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb3JkS2V5T3JOYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IGVnZyA9IGF3YWl0IGFiLmxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7IGFiSUQsIHJlY29yZEtleTogcmVjb3JkS2V5T3JOYW1lLCByZXR1cm5UeXBlOiAnZWdnJ30pOwoKaWYgKCFlZ2cgfHwgZWdnLnN1Y2Nlc3MgPT09IGZhbHNlKSB7CiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlCiAgICB9Cn0gZWxzZSB7CiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgdXBkYXRlQXZhaWxhYmxlOiBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoID4gY3VycmVudEFCVmVyc2lvbiwKICAgICAgICBjdXJyZW50QUJWZXJzaW9uLAogICAgICAgIGxhdGVzdEFCVmVyc2lvbjogZWdnLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCwKICAgIH0KfQonAQRib3RzJGYxZTY2Y2M5LTBiNjYtNDljMy04M2M5LWM3MDJmNTRiMzU5ZgEnAP/hmbUC2YkLBnN5c3RlbQIEAP/hmbUC2okLD2FiLnNoZWxsLmRlZGVudCcA/+GZtQLZiQsKb25Cb3RBZGRlZAIEAP/hmbUC6okL0QlALy8gZGVkZW50LWpzIGh0dHBzOi8vZ2l0aHViLmNvbS9NYXJ0aW5Lb2xhcmlrL2RlZGVudC1qcwoKLyoqCiAqIFJlbW92ZXMgaW5kZW50YXRpb24gZnJvbSBtdWx0aWxpbmUgc3RyaW5ncy4gV29ya3Mgd2l0aCBib3RoIHRhYnMgYW5kIHNwYWNlcy4KICovCmZ1bmN0aW9uIGRlZGVudCAodGVtcGxhdGVTdHJpbmdzLCAuLi52YWx1ZXMpIHsKCWxldCBtYXRjaGVzID0gW107CglsZXQgc3RyaW5ncyA9IHR5cGVvZiB0ZW1wbGF0ZVN0cmluZ3MgPT09ICdzdHJpbmcnID8gWyB0ZW1wbGF0ZVN0cmluZ3MgXSA6IHRlbXBsYXRlU3RyaW5ncy5zbGljZSgpOwoKCS8vIDEuIFJlbW92ZSB0cmFpbGluZyB3aGl0ZXNwYWNlLgoJc3RyaW5nc1tzdHJpbmdzLmxlbmd0aCAtIDFdID0gc3RyaW5nc1tzdHJpbmdzLmxlbmd0aCAtIDFdLnJlcGxhY2UoL1xyP1xuKFtcdCBdKikkLywgJycpOwoKCS8vIDIuIEZpbmQgYWxsIGxpbmUgYnJlYWtzIHRvIGRldGVybWluZSB0aGUgaGlnaGVzdCBjb21tb24gaW5kZW50YXRpb24gbGV2ZWwuCglmb3IgKGxldCBpID0gMDsgaSA8IHN0cmluZ3MubGVuZ3RoOyBpKyspIHsKCQlsZXQgbWF0Y2g7CgoJCWlmIChtYXRjaCA9IHN0cmluZ3NbaV0ubWF0Y2goL1xuW1x0IF0rL2cpKSB7CgkJCW1hdGNoZXMucHVzaCguLi5tYXRjaCk7CgkJfQoJfQoKCS8vIDMuIFJlbW92ZSB0aGUgY29tbW9uIGluZGVudGF0aW9uIGZyb20gYWxsIHN0cmluZ3MuCglpZiAobWF0Y2hlcy5sZW5ndGgpIHsKCQlsZXQgc2l6ZSA9IE1hdGgubWluKC4uLm1hdGNoZXMubWFwKHZhbHVlID0+IHZhbHVlLmxlbmd0aCAtIDEpKTsKCQlsZXQgcGF0dGVybiA9IG5ldyBSZWdFeHAoYFxuW1x0IF17JHtzaXplfX1gLCAnZycpOwoKCQlmb3IgKGxldCBpID0gMDsgaSA8IHN0cmluZ3MubGVuZ3RoOyBpKyspIHsKCQkJc3RyaW5nc1tpXSA9IHN0cmluZ3NbaV0ucmVwbGFjZShwYXR0ZXJuLCAnXG4nKTsKCQl9Cgl9CgoJLy8gNC4gUmVtb3ZlIGxlYWRpbmcgd2hpdGVzcGFjZS4KCXN0cmluZ3NbMF0gPSBzdHJpbmdzWzBdLnJlcGxhY2UoL15ccj9cbi8sICcnKTsKCgkvLyA1LiBQZXJmb3JtIGludGVycG9sYXRpb24uCglsZXQgc3RyaW5nID0gc3RyaW5nc1swXTsKCglmb3IgKGxldCBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykgewoJCXN0cmluZyArPSB2YWx1ZXNbaV0gKyBzdHJpbmdzW2kgKyAxXTsKCX0KCglyZXR1cm4gc3RyaW5nOwp9CgpnbG9iYWxUaGlzLmRlZGVudCA9IGRlZGVudDsnAP/hmbUC2YkLCW9uRGVzdHJveQIEAP/hmbUCvJMLGWRlbGV0ZSBnbG9iYWxUaGlzLmRlZGVudDsnAP/hmbUC2YkLCGFiSWdub3JlAgQA/+GZtQLWkwsEdHJ1ZScA/+GZtQLZiQsHYWJTaGVsbAIEAP/hmbUC25MLBHRydWUnAP/hmbUC2YkLCWFiVmVyc2lvbgIEAP/hmbUC4JMLBTEwLjM3JwEEYm90cyRmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjABJwD/4Zm1AuaTCwZzeXN0ZW0CBAD/4Zm1AueTCw5hYi5zaGVsbC5pbnB1dCcA/+GZtQLmkwsEZm9ybQIEAP/hmbUC9pMLB25vdGhpbmcnAP/hmbUC5pMLCW9uS2V5RG93bgIEAP/hmbUC/pMLwAtAaWYgKGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBbGxvd0NoYXRCYXIgPT09IGZhbHNlKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IHsga2V5cyB9ID0gdGhhdDsKCmlmIChtYXNrcy5jaGF0T3BlbikgewogICAgY29uc3QgZXNjID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdFc2NhcGUnKTsKCiAgICBpZiAoZXNjKSB7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhcnJvd1VwID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd1VwJyk7CiAgICAgICAgY29uc3QgYXJyb3dEb3duID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd0Rvd24nKTsKICAgICAgICAKICAgICAgICBpZiAoYXJyb3dVcCB8fCBhcnJvd0Rvd24pIHsKICAgICAgICAgICAgLy8gSWYgQXJyb3dVcCBvciBBcnJvd0Rvd24gYXJlIHByZXNzZWQgd2hpbGUgdGhlIGFiIGNoYXQgYmFyIGlzIG9wZW4gdGhlbgogICAgICAgICAgICAvLyBzdGFydCBjb21iaW5nIHRocm91Z2ggY2hhdCBoaXN0b3J5LgogICAgICAgICAgICBjb25zdCBkaXIgPSBhcnJvd1VwID8gLTEgOiAxOwogICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggKyBkaXI7CiAgICAgICAgICAgIGxldCBoaXN0b3JpY2FsVGV4dCA9IG51bGw7CgogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiBpbmRleCA8IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGhpc3RvcmljYWxUZXh0ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5W2luZGV4XTsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSAtMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA+PSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBjaGF0IGJhci4KICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oeyBwcmVmaWxsOiBoaXN0b3JpY2FsVGV4dCB9KTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBjb25zdCBiYWNrdGljayA9IHRoYXQua2V5cy5pbmNsdWRlcygnYCcpIHx8IHRoYXQua2V5cy5pbmNsdWRlcygiRGVhZCIpOwoKICAgIGlmIChiYWNrdGljaykgewogICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgfQp9CicA/+GZtQLmkwsGb25DaGF0AgQA/+GZtQK/nwuKGEAvLyBOb3Qgc3VwcG9ydGVkIG91dHNpZGUgb2YgYnVpbGRlciB2ZXJzaW9uCmlmICghYnVpbGRlclZlcnNpb24pIHsKICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIHJldHVybjsKfQoKaWYgKCF0aGF0Lm1lc3NhZ2UpIHsKICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIHJldHVybjsKfQoKLy8gQXBwZW5kIG1lc3NhZ2UgdG8gY2hhdCBoaXN0b3J5IGFuZCB1cGRhdGUgdGhlIGN1cnJlbnQgaGlzdG9yeSBpbmRleC4KdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5LnB1c2godGhhdC5tZXNzYWdlKTsKdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CgovLyBGdW5jdGlvbiB0byBwYXJzZSBhcmd1bWVudHMgd2l0aCBxdW90ZSBzdXBwb3J0IGFuZCBlcnJvciBoYW5kbGluZwovLyBFeGFtcGxlczogCi8vICAgJ2FyZzEgYXJnMicgLT4gWydhcmcxJywgJ2FyZzInXQovLyAgICciYXJnIHdpdGggc3BhY2VzIiBhcmcyJyAtPiBbJ2FyZyB3aXRoIHNwYWNlcycsICdhcmcyJ10KLy8gICAnInVuY2xvc2VkIHF1b3RlJyAtPiB0aHJvd3MgRXJyb3IKZnVuY3Rpb24gcGFyc2VBcmd1bWVudHMoaW5wdXQpIHsKICAgIGNvbnN0IGFyZ3MgPSBbXTsKICAgIGxldCBjdXJyZW50QXJnID0gJyc7CiAgICBsZXQgaW5zaWRlUXVvdGVzID0gbnVsbDsKICAgIGxldCBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaGFyID0gaW5wdXRbaV07CiAgICAgICAgCiAgICAgICAgaWYgKGluc2lkZVF1b3RlcykgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgICAgICBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgICAgICAgICAgICAgcXVvdGVTdGFydFBvcyA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICdcXCcgJiYgaSArIDEgPCBpbnB1dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGkrKzsgLy8gU2tpcCB0aGUgYmFja3NsYXNoCiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGlucHV0W2ldOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBjaGFyOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGNoYXIgPT09ICciJyB8fCBjaGFyID09PSAiJyIpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IGNoYXI7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gaTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAnICcpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudEFyZyA9ICcnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBjaGFyOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmNsb3NlZCBxdW90ZTogZm91bmQgb3BlbmluZyAke2luc2lkZVF1b3Rlc30gYXQgcG9zaXRpb24gJHtxdW90ZVN0YXJ0UG9zfSBidXQgbm8gY2xvc2luZyBxdW90ZWApOwogICAgfQogICAgCiAgICBpZiAoY3VycmVudEFyZy5sZW5ndGggPiAwKSB7CiAgICAgICAgYXJncy5wdXNoKGN1cnJlbnRBcmcpOwogICAgfQogICAgCiAgICByZXR1cm4gYXJnczsKfQoKaWYgKHRoYXQubWVzc2FnZVswXSA9PSAiLiIpIHsKICAgIGNvbnN0IGNvbW1hbmRQYXJ0ID0gdGhhdC5tZXNzYWdlLnN1YnN0cmluZygxKTsgLy8gUmVtb3ZlIHRoZSBkb3QKICAgIGNvbnN0IHNwYWNlSW5kZXggPSBjb21tYW5kUGFydC5pbmRleE9mKCcgJyk7CiAgICAKICAgIGxldCBjbWQsIGFyZ3M7CiAgICBpZiAoc3BhY2VJbmRleCA9PT0gLTEpIHsKICAgICAgICAvLyBObyBhcmd1bWVudHMKICAgICAgICBjbWQgPSBjb21tYW5kUGFydDsKICAgICAgICBhcmdzID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBIYXMgYXJndW1lbnRzCiAgICAgICAgY21kID0gY29tbWFuZFBhcnQuc3Vic3RyaW5nKDAsIHNwYWNlSW5kZXgpOwogICAgICAgIGNvbnN0IGFyZ3NTdHJpbmcgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoc3BhY2VJbmRleCArIDEpOwogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSBwYXJzZUFyZ3VtZW50cyhhcmdzU3RyaW5nKTsKICAgICAgICAgICAgYXJncyA9IHBhcnNlZEFyZ3MubGVuZ3RoID8gcGFyc2VkQXJncyA6IHVuZGVmaW5lZDsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEVycm9yIHBhcnNpbmcgY29tbWFuZCBhcmd1bWVudHM6ICR7ZXJyb3IubWVzc2FnZX1gLCBsb2dUeXBlOiAnRXJyb3InIH0pOwogICAgICAgICAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgLy8gQ3JlYXRlIGEgZnJlc2ggQ29tbWFuZHNNYW5hZ2VyIHdpdGggZWFjaCBjYWxsIHNvIHRoYXQgd2UgYWx3YXlzIGhhdmUgdGhlIGxhdGVzdCBjb21tYW5kcyBhbmQgZnVuY3Rpb25hbGl0eS4KICAgIGNvbnN0IGFiQ29tbWFuZHMgPSBuZXcgQUJDb21tYW5kc01hbmFnZXIoKTsKCiAgICBpZiAoYWJDb21tYW5kcyAmJiBhYkNvbW1hbmRzLmhhc0NvbW1hbmQoY21kKSkgewogICAgICAgIC8vIENhbGwgY29tbWFuZCB3aXRoIGFyZ3MuCiAgICAgICAgYWJDb21tYW5kcy5jYWxsQ29tbWFuZChjbWQsIGFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBFdmFsdWF0ZSBjb21tYW5kIGFzIGphdmFzY3JpcHQuCiAgICAgICAgY29uc3QganMgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOwogICAgICAgIG9zLnJ1bihqcyk7CiAgICB9Cn0KCnRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsnAP/hmbUC5pMLC2Rlc2NyaXB0aW9uAgQA/+GZtQLKtwtCVGhpcyBpcyBtZWFudCB0byBoYW5kbGUgYW55IG5vbmUgbWVudSByZWxhdGVkIGlucHV0cy9pbnRlcmFjdGlvbnMuJwD/4Zm1AuaTCwxvbkZpbGVVcGxvYWQCBAD/4Zm1Ao24C6I1QGltcG9ydCB7IFJlY29yZEZpbGVSZXN1bHQgfSBmcm9tICdjYXN1YWxvcyc7CgovL2ZpbHRlciBvdXQgdGltZXMgd2hlbiBmaWxlIGxvYWRpbmcgaXMgbm90IGFsbG93ZWQKaWYgKCFidWlsZGVyVmVyc2lvbiB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiTGlzdGVuaW5nRm9yRmlsZVVwbG9hZHMgIT09IHRydWUpIHsKICAgIHJldHVybjsKfQoKLy92YXJpb3VzIGZpbGUgc3BlY2lmaWMgdmFyaWFibGVzCmxldCBmaWxlRXh0ZW5zaW9uID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CmxldCBzaXplID0gdGhhdC5maWxlLnNpemU7CmxldCBjb3B5VXJsID0gdGhhdC5jb3B5VXJsID8/IHRydWU7CmxldCBmb2N1c0NhbWVyYSA9IHRoYXQuZm9jdXNDYW1lcmEgPz8gdHJ1ZTsKbGV0IG1pbWVUeXBlOwpjb25zdCBib3RJbmZvID0ge307CgovL2hhcmQgbGltaXQgYmFzZWQgb24gZmlsZSBzaXplCmlmIChzaXplID4gMjAwMDAwMDAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogIm1heGltdW0gZmlsZSBzaXplIGV4Y2VlZGVkICgyMDAgbWIpIiwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIHJldHVybjsKfQoKLyoqCiAqIEhlbHBlciBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyBpbWFnZSBkaW1lbnNpb25zICYgYXNwZWN0IGZyb20gQXJyYXlCdWZmZXIgZGF0YS4KICogUmVxdWlyZXMgQ2FzdWFsT1MgYmUgY29uZmlndXJlZCB0byBoYXZlIGFjY2VzcyB0byB0aGUgRE9NLgogKi8KZnVuY3Rpb24gZ2V0SW1hZ2VEaW1lbnNpb25zKGFycmF5QnVmZmVyLCBtaW1lVHlwZSkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2FycmF5QnVmZmVyXSwgeyB0eXBlOiBtaW1lVHlwZSB9KTsKICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgIGNvbnN0IGltZyA9IG5ldyBzZWxmLkltYWdlKCk7CiAgICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHsKICAgICAgICAgICAgcmVzb2x2ZSh7IHdpZHRoOiBpbWcubmF0dXJhbFdpZHRoLCBoZWlnaHQ6IGltZy5uYXR1cmFsSGVpZ2h0LCBhc3BlY3Q6IGltZy5uYXR1cmFsV2lkdGggLyBpbWcubmF0dXJhbEhlaWdodCB9KTsKICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogICAgICAgIH07CiAgICAgICAgaW1nLm9uZXJyb3IgPSByZWplY3Q7CiAgICAgICAgaW1nLnNyYyA9IHVybDsKICAgIH0pOwp9CgovL3RoaXMgc3dpdGNoIGhhbmRsZXMgcG9zc2libGUgZmlsZXMgZXh0ZW5zaW9ucywgd2hpbGUgcmVqZWN0aW5nIGFueSBpdCBkb2VzIG5vdCByZWNvZ25pemUKc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICBjYXNlICdqcGcnOgogICAgY2FzZSAnanBlZyc6CiAgICBjYXNlICd3ZWJwJzoKICAgIGNhc2UgJ2dpZic6CiAgICBjYXNlICdwbmcnOgogICAgICAgIG1pbWVUeXBlID0gImltYWdlLyIgKyBmaWxlRXh0ZW5zaW9uOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgICAgIGJvdEluZm8uYW5jaG9yUG9pbnQgPSAn8J+nrFswLDAsLTAuMDFdJzsKCiAgICAgICAgaWYgKG9zLmRldmljZSgpLnN1cHBvcnRzRE9NKSB7CiAgICAgICAgICAgIGNvbnN0IGltYWdlRGltZW5zaW9ucyA9IGF3YWl0IGdldEltYWdlRGltZW5zaW9ucyh0aGF0LmZpbGUuZGF0YSwgbWltZVR5cGUpOwoKICAgICAgICAgICAgLy8gQWRqdXN0IHNjYWxlIHRvIHJlc3BlY3QgYXNwZWN0IHJhdGlvLiBUaGlzIGlzICJjb3ZlciIgc2NhbGluZyBzdHlsZS4KICAgICAgICAgICAgaWYgKGltYWdlRGltZW5zaW9ucy5hc3BlY3QgPj0gMSkgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVggPSBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVkgPSAxIC8gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdzdmcnOgogICAgICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgICAgIGJvdEluZm8uYW5jaG9yUG9pbnQgPSAn8J+nrFswLDAsLTAuMDFdJzsKCiAgICAgICAgaWYgKG9zLmRldmljZSgpLnN1cHBvcnRzRE9NKSB7CiAgICAgICAgICAgIGNvbnN0IGltYWdlRGltZW5zaW9ucyA9IGF3YWl0IGdldEltYWdlRGltZW5zaW9ucyh0aGF0LmZpbGUuZGF0YSwgbWltZVR5cGUpOwoKICAgICAgICAgICAgLy8gQWRqdXN0IHNjYWxlIHRvIHJlc3BlY3QgYXNwZWN0IHJhdGlvLiBUaGlzIGlzICJjb3ZlciIgc2NhbGluZyBzdHlsZS4KICAgICAgICAgICAgaWYgKGltYWdlRGltZW5zaW9ucy5hc3BlY3QgPj0gMSkgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVggPSBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVkgPSAxIC8gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBicmVhazsKICAgIGNhc2UgJ2dsYic6CiAgICBjYXNlICdleHInOgogICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgbWltZVR5cGUgPSAidGV4dC94bWwiOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJtZXNoIjsKICAgICAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gImdsdGYiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnYXV4JzoKICAgIGNhc2UgJ3BkZic6CiAgICAgICAgbGV0IGJvdERhdGEgPSBmaWxlRXh0ZW5zaW9uID09ICIuYXV4IiA/IEpTT04ucGFyc2UodGhhdC5maWxlLmRhdGEpLnN0YXRlIDogb3MucGFyc2VCb3RzRnJvbURhdGEodGhhdC5maWxlLmRhdGEpOwogICAgICAgIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3RzOiBib3REYXRhLCBvcmlnaW46IGZpbGVOYW1lLCBzb3VyY2VFdmVudDogJ2ZpbGVfdXBsb2FkJyB9KTsKICAgICAgICByZXR1cm47CiAgICBjYXNlICdtcDMnOgogICAgICAgIG1pbWVUeXBlID0gJ2F1ZGlvL21wZWcnOwogICAgICAgIGJvdEluZm8ub25DbGljayA9ICJAIG9zLnBsYXlTb3VuZCh0YWdzLmZvcm1BZGRyZXNzKTsiOwogICAgICAgIGJvdEluZm8ubGFiZWwgPSAiQ2xpY2sgdG8gUGxheSI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdtcDQnOgogICAgICAgIG1pbWVUeXBlID0gJ3ZpZGVvL21wNCc7CiAgICAgICAgYm90SW5mby5mb3JtID0gImlmcmFtZSI7CiAgICAgICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJzcmMiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnb3RmJzoKICAgICAgICBtaW1lVHlwZSA9ICdmb250L290Zic7CiAgICAgICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ3dvZmYnOgogICAgICAgIG1pbWVUeXBlID0gJ2ZvbnQvd29mZic7CiAgICAgICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBmaWxlIHR5cGUgbm90IHN1cHBvcnRlZGAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcigidW5oYW5kbGVkIGZpbGUgdHlwZTogIiArIGZpbGVFeHRlbnNpb24pOwp9CgovL3RoZSBmb2xsb3dpbmcgdmFyaWFibGVzIGFuZCBvYmplY3RzIHNldCB1cCBhIGxvYWRpbmcgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgdXBsb2FkaW5nYCB9KTsKCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvOwoKaWYgKCFjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCkgewogICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cn0KCi8vdGhpcyBpcyB0aGUgYWN0dWFsIHVwbG9hZCBmdW5jdGlvbmFsaXR5CmxldCB1cGxvYWRSZXN1bHQ6IFJlY29yZEZpbGVSZXN1bHQgPSBhd2FpdCBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogdGhhdC5maWxlLmRhdGEsIGZpbGVOYW1lOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlIH0pOwoKaWYgKHVwbG9hZFJlc3VsdCkgewogICAgaWYgKHVwbG9hZFJlc3VsdC5zdWNjZXNzIHx8IHVwbG9hZFJlc3VsdC5lcnJvckNvZGUgPT09ICdmaWxlX2FscmVhZHlfZXhpc3RzJykgewogICAgICAgIGNvbnN0IGZpbGVVUkwgPSB1cGxvYWRSZXN1bHQudXJsID8/IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgICAgIC8vaWYgdGhlIGZpbGUgc2hvdWxkIGJlIGluY2x1ZGVkIGFzIGEgYm90IHdpdGggYSBsaW5rLCB0aGlzIGxvZ2ljIGhhbmRsZXMgdGhhdAogICAgICAgIGlmIChPYmplY3Qua2V5cyhib3RJbmZvKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGxldCBkaW1lbnNpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uOwoKICAgICAgICAgICAgaWYgKCFkaW1lbnNpb24pIHsKICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmYWxsYmFjayB0byB3aGF0ZXZlciBpcyB0aGUgdmlzaWJsZSBwb3J0YWwuCiAgICAgICAgICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb25maWdCb3QudGFncy5ncmlkUG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpbWVuc2lvbikgewogICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb25dID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgICAgICAgICAgICAgIGxldCBwb3NpdGlvbiA9IGdldEJvdFBvc2l0aW9uKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QsIGRpbWVuc2lvbik7CiAgICAgICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb24gKyAnWCddID0gcG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbiArICdZJ10gPSBwb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uICsgJ1onXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtaW1lVHlwZS5pbmNsdWRlcygiZm9udCIpKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLmxhYmVsRm9udEFkZHJlc3MgPSBmaWxlVVJMOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm90SW5mby5mb3JtQWRkcmVzcyA9IGZpbGVVUkw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGJvdEluZm8uYWJGaWxlVXBsb2FkID0gdHJ1ZTsKCiAgICAgICAgICAgIGNvbnN0IGJvdCA9IGNyZWF0ZShib3RJbmZvKTsKCiAgICAgICAgICAgIGlmIChmb2N1c0NhbWVyYSkgewogICAgICAgICAgICAgICAgb3MuZm9jdXNPbihib3QsIHsgZHVyYXRpb246IDEgfSkuY2F0Y2goZSA9PiB7fSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNvcHlVcmwpIHsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGZpbGVVUkwpOwogICAgICAgICAgICAKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJUb2FzdCh7IG1lc3NhZ2U6IGBGaWxlIHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkLmAsIGxvZ1R5cGU6ICdsb2cnIH0pOwogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBGaWxlIHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke2ZpbGVVUkx9YCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYEZhaWxlZCB0byB1cGxvYWQgZmlsZS4gUmVhc29uOiAke3VwbG9hZFJlc3VsdC5lcnJvck1lc3NhZ2V9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gdXBsb2FkIGZpbGUuIFJlc3VsdDogJHtKU09OLnN0cmluZ2lmeSh1cGxvYWRSZXN1bHQpfWAsIGxvZ1R5cGU6IGBlcnJvcmB9KTsKICAgIH0KfSBlbHNlIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2l0aCBmaWxlIHVwbG9hZC5gLCBsb2dUeXBlOiBgZXJyb3JgfSk7Cn0KCi8vY2xlYXIgdGhlIHByb2dyZXNzIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwoKaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHVwbG9hZFJlc3VsdDsnAP/hmbUC5pMLBWxlYXJuAgQA/+GZtQKs7Qso8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA/+GZtQLmkwsIcmVtZW1iZXICBAD/4Zm1AtPtCyjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwD/4Zm1AuaTCw1tYW5pZmVzdGF0aW9uAgQA/+GZtQL67Qso8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA/+GZtQLmkwsIYWJJZ25vcmUCBAD/4Zm1AqHuCwR0cnVlJwD/4Zm1AuaTCwZjcmVhdGUCBAD/4Zm1AqbuCyjwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwD/4Zm1AuaTCwVzdG9yZQIEAP/hmbUCze4LKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAP/hmbUC5pMLBG1lbnUCBAD/4Zm1AvTuCyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwD/4Zm1AuaTCwdhYlNoZWxsAgQA/+GZtQKb7wsEdHJ1ZScA/+GZtQLmkwsJb25UYXBDb2RlAgQA/+GZtQKg7wupAkBjb25zdCB0YXBDb2RlID0gdGhhdDsKCnN3aXRjaCAodGFwQ29kZSkKewogICAgY2FzZSAiMzM0MiI6CiAgICAgICAgb3MudG9hc3QoIndha2luZyAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSk7CgogICAgICAgIHRoaXNCb3Qub25DaGF0KHttZXNzYWdlOiAiLi4ifSk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICI0MjQyIjoKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgLy9jb25zb2xlLmxvZyh0YXBDb2RlKTsKfScA/+GZtQLmkwsDYXNrAgQA/+GZtQLK8Qso8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycA/+GZtQLmkwsJYWJWZXJzaW9uAgQA/+GZtQLx8QsFMTAuMzcnAP/hmbUC5pMLCm9uQm90QWRkZWQCBAD/4Zm1AvfxC0BAdGhpc0JvdC5sb2FkQUJDb21tYW5kc01hbmFnZXIoKTsKdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5ID0gW107JwD/4Zm1AuaTCxpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAP/hmbUCuPIL12tAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCi8vIFRoZXNlIGFyZSBhbGwgdGhlIGJ1aWx0LWluIGNvbW1hbmRzLgoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdoZWxwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGNvbW1hbmRzID0gYWJDb21tYW5kcy5jb21tYW5kczsKICAgIGNvbnN0IGNvbW1hbmRLZXlzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpOwoKICAgIGxldCBzZWxlY3RlZENvbW1hbmQ7CiAgICBpZiAoY29tbWFuZEtleXMgJiYgY29tbWFuZEtleXMubGVuZ3RoICYmIGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb21tYW5kS2V5TWF0Y2ggPSBjb21tYW5kS2V5cy5maW5kKGtleSA9PiBrZXkgPT09IGFyZ3NbMF0pOwogICAgICAgIHNlbGVjdGVkQ29tbWFuZCA9IGNvbW1hbmRLZXlNYXRjaDsKICAgIH0KICAgIAogICAgbGlua3MuaGVscC5tb3VudCh7IGFiQ29tbWFuZHNNYW5hZ2VyOiBhYkNvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IHRoaXMgaGVscCB3aW5kb3cuIENhbiBzcGVjaWZ5IGEgY29tbWFuZCB0byBvcGVuIHRoZSBoZWxwIHBhZ2UgZm9yIHRoYXQgY29tbWFuZCBkaXJlY3RseS4nLAogICAgdXNhZ2U6IFsnLmhlbHAnLCAnLmhlbHAgW2NvbW1hbmRdJ10KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJy4nLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcuLicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3dha2UnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcud2FrZScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NsZWVwJywgYXJncyA9PiB0aGlzQm90LmNtZEFCU2xlZXAoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdXQgYWIgdG8gc2xlZXAuJywKICAgIHVzYWdlOiAnLnNsZWVwJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYWNjb3VudCcsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBlbmRwb2ludCA9IGF3YWl0IG9zLmdldFJlY29yZHNFbmRwb2ludCgpOwogICAgb3Mub3BlblVSTChlbmRwb2ludCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBhY2NvdW50L3JlY29yZHMgcGFnZSBpbiBhIG5ldyB0YWIuJywKICAgIHVzYWdlOiAnLmFjY291bnQnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhc2snLCAoYXJncykgPT4gewogICAgaWYgKGxpbmtzLmFzaykgewogICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBhc2tJbnB1dCA9IGFyZ3Muam9pbignICcpOwogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLmFzayBjb21tYW5kIHJlcXVpcmVzIGlucHV0YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhc2sgYm90IGlzIG5vdCBsb2FkZWQsIGNhbm5vdCBsb2FkIGFza2ApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQXNrIGFiJywKICAgIHVzYWdlOiAnLmFzayA8YXNrX25hbWU+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbmFtZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSwgeyB0aXRsZTogJ3doYXQgd291bGQgeW91IGxpa2UgdG8gY2FsbCBtZT8nIH0pOwogICAgc2V0VGFnTWFzayhsaW5rcy5wZXJzb25hbGl0eSwgJ2FiQnVpbGRlcklkZW50aXR5JywgbmFtZSwgJ2xvY2FsJyk7CiAgICBzaG91dCgnY2hhbmdlUGVyc29uYWxpdHlDb25maWcnLCB7IG5hbWU6IG5hbWUgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHaXZlIGFiIGEgbmV3IG5hbWUuJywKICAgIHVzYWdlOiAnLm5hbWVhYicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwZGF0ZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGxpbmtzLmxlYXJuLnVwZGF0ZUFCKCk7Owp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBkYXRlIEFCIGNvcmUgYW5kIHNraWxscyB0byBjdXJyZW50IGNvZGUuJywKICAgIHVzYWdlOiAnLnVwZGF0ZWFiJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc3lzdGVtJywgYXJncyA9PiB0aGlzQm90LmNtZFN5c3RlbShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpbnN0LicsCiAgICBsb25nRGVzY3JpcHRpb246IGBPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaSAgICAKCiAgICBZb3UgbWF5IHByb3ZpZGUgYSBjdXN0b20gc3lzdGVtVGFnTmFtZSB3aXRoIHRoZSBjb21tYW5kLCBpbiBvcmRlciB0byBvcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIG9ubHkgZm9yIGJvdHMgd2l0aCB0aGUgZ2l2ZW4gc3lzdGVtVGFnTmFtZS4gQnkgZGVmYXVsdCwgInN5c3RlbSIgd2lsbCBiZSB1c2VkIGFzIHRoZSBzeXN0ZW1UYWdOYW1lLgoKICAgIEZvciBleGFtcGxlOgoKICAgID4gLnN5c3RlbQogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAic3lzdGVtIiB0YWcuCgogICAgPiAuc3lzdGVtIG15R3JvdXAKICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgIm15R3JvdXAiIHRhZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuc3lzdGVtJywKICAgICAgICAnLnN5c3RlbSBzeXN0ZW1UYWdOYW1lJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBpbiB0aGUgY3VycmVudCB3aW5kb3cuIEJ5IGRlZmF1bHQgdGhlIHN5c3RlbSBwb3J0YWwgd2lsbCBvcGVuIGluIGEgbmV3IHRhYi4nCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nJywgKGFyZ3MpID0+IHsKICAgIGxpbmtzLmNvbnNvbGUudG9nZ2xlQ29uc29sZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVG9nZ2xlIHZpc2libGl0eSBvZiB0aGUgYWIgbG9nLicsCiAgICB1c2FnZTogJy5sb2cnCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZ2NsZWFyJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG1lc3NhZ2VMb2dCb3RzID0gZ2V0Qm90cygiY29uc29sZUxvZ01lc3NhZ2VCb3QiLCB0cnVlKTsKICAgIGRlc3Ryb3kobWVzc2FnZUxvZ0JvdHMpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQ2xlYXIgYWxsIGFiIGxvZyBtZXNzYWdlcy4nLAogICAgdXNhZ2U6ICcubG9nY2xlYXInCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NoZWV0JywgYXJncyA9PiB0aGlzQm90LmNtZFNoZWV0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciBzcGVjaWZpZWQgYm90IG9yIGFuIGVudGlyZSBkaW1lbnNpb24uJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zaGVldCBbb3B0aW9uc10gW3BvcnRhbCB8IGhlbHBlckJvdE5hbWUgfCBib3RJZCB8IGdsb2JhbFRoaXNQYXRoXScsCiAgICAgICAgJ2V4LiAuc2hlZXQgaG9tZScsCiAgICAgICAgJ2V4LiAuc2hlZXQgY29uZmlnQm90JywKICAgICAgICAnZXguIC5zaGVldCAtdCBhMmNmNDczOS0zOWEyLTRmZDYtYjNlZi1jYzQ3ODJmOTcwODknLAogICAgICAgICdleC4gLnNoZWV0IGdsb2JhbFRoaXMubXlPYmplY3QubXlCb3QnLAogICAgICAgICdleC4gLnNoZWV0IG15T2JqZWN0Lm15Qm90JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGluIGEgbmV3IGJyb3dzZXIgdGFiLiBcblxuTk9URTogLnNoZWV0IHdpbGwgYXV0b21hdGljYWxseSBpbnNwZWN0IHRoZSBzcGFjZSBvZiBhIGJvdCBhbmQgZm9yY2Ugb3BlbmluZyBpbiB0aGUgc2FtZSB0YWIgaWYgYSBib3QgaXMgaW4gdGVtcExvY2FsIG9yIHRlbXBTaGFyZWQgc3BhY2UuJywKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdtZW51c2hlZXQnLCAoYXJncykgPT4gewogICAgY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgPSBjb25maWdCb3QudGFncy5tZW51UG9ydGFsOwogICAgaWYgKCFjb25maWdCb3QudGFncy5tZW51UG9ydGFsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBDYW5ub3Qgb3BlbiBzaGVldFBvcnRhbCBmb3IgbWVudVBvcnRhbCBib3RzLiBUaGUgbWVudVBvcnRhbCBpcyBjdXJyZW50bHkgZGlzYWJsZWQuYH0pCiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHRoZSBjdXJyZW50IG1lbnUgcG9ydGFsLicsCiAgICB1c2FnZTogJy5tZW51U2hlZXQnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRpbnN0JywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkSW5zdChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIHRoZSBpbnN0IHRvIGRpc2suJywKICAgIHVzYWdlOiAnLmRvd25sb2FkaW5zdCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2Fkc3lzdGVtJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkU3lzdGVtKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgdGhlIHNwZWNpZmllZCBib3Qgc3lzdGVtKHMpIHRvIGRpc2suJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIHRoZSBzcGVjaWZpZWQgYm90IHN5c3RlbShzKSB0byBkaXNrLgogICAgCiAgICBUaGUgcHJvdmlkZWQgc3lzdGVtTmFtZShzKSBpbGwgYmUgdXNlZCB0byBtYXRjaCBhZ2FpbnN0IGJvdHMgd2hvc2Ugc3lzdGVtIHRhZyBzdGFydHMgd2l0aCBzeXN0ZW1OYW1lKHMpLiBJdCB3aWxsIHJlc3BlY3QgdGhlIGRvdCBub3RhdGlvbiBvZiB0aGUgc3lzdGVtIHRhZywgc28gcGFydGlhbCBtYXRjaGVzIHdpbGwgbm90IHdvcmsuIFNlZSB0aGUgZXhhbXBsZXMgYmVsb3cgZm9yIGEgYmV0dGVyIHVuZGVyc3RhbmRpbmcuCgogICAgRm9yIGV4YW1wbGUgaWYgc3lzdGVtTmFtZSBpcyAiaGVsbG8iOgoKICAgIFN5c3RlbSBUYWcgLT4gRG93bmxvYWQ/CiAgICAtIGhlbGxvIC0+IHllcwogICAgLSBoZWxsby53b3JsZC5tYWluIC0+IHllcwogICAgLSBoZWxsby53b3JsZC5maXJld29ya3MgLT4geWVzCiAgICAtIHJjLnJlZEJvdCAtPiBubwogICAgLSBoZWxsb1dvcmxkLmJvdCAtPiBubwogICAgLSBoZWxpdW0uYXRvbSAtPiBubwogICAgLSBoZXguZ3JpZC5oZWxsbyAtPiBubwogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5kb3dubG9hZHN5c3RlbSBbLi4uc3lzdGVtTmFtZV0nCiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGFiJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkQUIoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBzcGVjaWZpZWQgYWIgZ3JvdXAocykgdG8gZGlzay4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suCgogICAgWW91IGNhbiBwcm92aWRlIGEgbGlzdCBvZiBncm91cHMgdG8gZG93bmxvYWQgYWxvbmcgd2l0aCB0aGUgY29tbWFuZDoKICAgID4gLmRvd25sb2FkYWIgYWJDb3JlIGFiU2hlbGwgYWJJbnRlcmZhY2UKCiAgICBJZiBncm91cChzKSBhcmUgbm90IHByb3ZpZGVkIHdpdGggdGhlIGNvbWFtYW5kIHRoZW4geW91IHdpbGwgYmUgcHJvbXB0ZWQgdG8gcHJvdmlkZSBvbmUgd2l0aCBhIGRpYWxvZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRhYiBbb3B0aW9uc10gW2dyb3VwLi4uXScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiBhYlNoZWxsIGFiSW50ZXJmYWNlJywKICAgICAgICAnZXguIC5kb3dubG9hZGFiIC12IDEgbXlHcm91cE5hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy12JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdTcGVjaWZ5IHRoZSBhdXggZm9ybWF0IHZlcnNpb24gbnVtYmVyLiBleC4gLXYgMSB3aWxsIGJlIGF1eCBmb3JtYXQgdmVyc2lvbiAxIChwdXJlIGJvdCBqc29uKS4gQnkgZGVmYXVsdCwgYWIgZmlsZXMgYXJlIHVzdWFsbHkgZG93bmxvYWRlZCBhcyB2ZXJzaW9uIDIgYXV4IGZpbGVzIChjb25mbGljdC1mcmVlIHVwZGF0ZSkuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkZWdnJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkRWdnKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLiBZb3Ugd2lsbCBuZWVkIHRvIHByb3ZpZGUgdGhlIHJlY29yZEtleSBhcyB3ZWxsIGFuZCB0aGUgbmFtZSBvZiB0aGUgZWdnLiBBIGRyb3Bkb3duIHNlbGVjdGlvbiB3aWxsIGJlIHByb3ZpZGVkIGZvciB0aGUgZWdnIGlmIGZvdW5kIHRvIHNlbGVjdCB3aGljaCB2ZXJzaW9uIHRvIGRvd25sb2FkLmAsCiAgICB1c2FnZTogJy5kb3dubG9hZGVnZycsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2Fkc2tpbGwnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKGFyZ3MpIHsKICAgICAgICBmb3IgKGxldCBza2lsbCBvZiBhcmdzKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoc2tpbGwpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnLmxvYWRza2lsbCByZXF1aXJlcyBzb21lIHNraWxsIG5hbWVzJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdMb2FkIHRoZSBzcGVjaWZpZWQgYWIgc2tpbGxzLicsCiAgICB1c2FnZTogJy5sb2FkU2tpbGwgW3NraWxsIC4uLl0nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cmxxcicsICgpID0+IG9zLnNob3dRUkNvZGUoY29uZmlnQm90LnRhZ3MudXJsKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgYSBRUiBjb2RlIGZvciB0aGUgYnJvd2VyIHRhYlwncyBjdXJyZW50IFVSTC4nLAogICAgdXNhZ2U6ICcudXJscXInCn0pOwoKY29uc3QgRElNX1NVUFBPUlRFRF9QT1JUQUxTID0gWydncmlkJywgJ21hcCcsICdtaW5pR3JpZCcsICdtaW5pTWFwJywgJ3NoZWV0JywgJ3N5c3RlbScsICdtZW51JywgJ3RhZyddOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkaW0nLCAoYXJncykgPT4gewogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBsZXQgcG9ydGFsID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXAnKTsKICAgICAgICBsZXQgZGltZW5zaW9uID0gYXJncy5qb2luKCcgJyk7CgogICAgICAgIGlmICghcG9ydGFsKSB7CiAgICAgICAgICAgIHBvcnRhbCA9ICdncmlkJzsKICAgICAgICB9CgogICAgICAgIGlmIChkaW1lbnNpb24gPT09ICJudWxsIiB8fCBkaW1lbnNpb24gPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGRpbWVuc2lvbiA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoRElNX1NVUFBPUlRFRF9QT1JUQUxTLmluZGV4T2YocG9ydGFsKSA+PSAwKSB7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzW2Ake3BvcnRhbH1Qb3J0YWxgXSA9IGRpbWVuc2lvbjsKCiAgICAgICAgICAgIGlmIChkaW1lbnNpb24gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBDbG9zZWQgJHtwb3J0YWx9UG9ydGFsLmAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFNldCAke3BvcnRhbH1Qb3J0YWwgdG8gJyR7ZGltZW5zaW9ufScgZGltZW5zaW9uLmAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYCR7cG9ydGFsfSBpcyBub3QgYSBzdXBwb3J0ZWQgcG9ydGFsIGZvciB0aGUgZGltIGNvbW1hbmQuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KQogICAgICAgIH0KICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dvIHRvIHNwZWNpZmllZCBwb3J0YWwgZGltZW5zaW9uLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBHbyB0byBzcGVjaWZpZWQgcHJvdGFsIGRpbWVuc2lvbi4KICAgIAogICAgSWYgYSBwb3J0YWwgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkIHRoZW4gaXQgd2lsbCBkZWZhdWx0IHRvIHRoZSBncmlkUG9ydGFsLgogICAgCiAgICBJZiBhIGRpbWVuc2lvbiBpcyBub3QgcHJvdmlkZWQgb3IgaXMgIm51bGwiIHRoZW4gdGhlIHBvcnRhbCB3aWxsIGJlIHNldCB0byBudWxsIGFuZCBiZSBjbG9zZWQuYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5kaW0gPGRpbWVuc2lvbj4nLAogICAgICAgICcuZGltIC1wIDxwb3J0YWw+IDxkaW1lbnNpb24+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgU3BlY2lmeSB0aGUgcG9ydGFsIG5hbWUuIENhbiBiZSBhbnlvbmUgb2YgdGhlIGZvbGxvd2luZzogJHtESU1fU1VQUE9SVEVEX1BPUlRBTFMuam9pbignLCAnKX1gCiAgICAgICAgfQogICAgXQoKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3V1aWQnLCAoKSA9PiB7CiAgICBvcy5zZXRDbGlwYm9hcmQodXVpZCgpKTsKCiAgICBsZXQgbWVzc2FnZSA9IGBDb3BpZWQgbmV3IHV1aWQgdG8gY2xpcGJvYXJkYDsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgb3MudG9hc3QobWVzc2FnZSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHZW5lcmF0ZSBhIHVuaXZlcnNhbGx5IHVuaXF1ZSBpZGVudGlmaWVyICh1dWlkKSBhbmQgY29weSBpdCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy51dWlkJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZHVwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGJvdElkID0gYXJncyA/IGFyZ3NbMF0gOiB1bmRlZmluZWQ7CiAgICBpZiAoYm90SWQpIHsKICAgICAgICBjb25zdCBib3QgPSBnZXRCb3QoJ2lkJywgYm90SWQpOwogICAgICAgIGlmIChib3QpIHsKICAgICAgICAgICAgY29uc3QgZHVwQm90ID0gY3JlYXRlKGJvdCk7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChkdXBCb3QuaWQpOwogICAgICAgICAgICBvcy50b2FzdCgnRHVwbGljYXRlIGJvdCBpZCBjb3BpZWQgdG8gY2xpcGJvYXJkLicpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9zLnRvYXN0KGBObyBib3QgZm91bmQgd2l0aCBpZCAke2JvdElkfWApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgb3MudG9hc3QoJ1Byb3ZpZGUgdGhlIGlkIG9mIHRoZSBib3QgeW91IHdhbnQgdG8gZHVwbGljYXRlJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEdXBsaWNhdGUgYSBzcGVjaWZpZWQgYm90IGFuZCBjb3B5IHRoZSBuZXcgYm90XCdzIGlkIHRvIHRoZSBjbGlwYm9hcmQuJywKICAgIHVzYWdlOiAnLmR1cCA8Ym90SWQ+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkYXV4JywgKGFyZ3MpID0+IHsKICAgIG9zLnNob3dVcGxvYWRBdXhGaWxlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgQVVYIGZpbGUocykgdG8gdGhlIGN1cnJlbnQgaW5zdC4nLAogICAgdXNhZ2U6ICcudXBsb2FkYXV4Jwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGxvYWRmaWxlcycsIGFyZ3MgPT4gdGhpc0JvdC5jbWRVcGxvYWRGaWxlcyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwbG9hZCBmaWxlKHMpIGRpcmVjdGx5IHRvIHJlY29yZC4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnVwbG9hZGZpbGVzJywKICAgICAgICAnLnVwbG9hZGZpbGVzIC1yZWNvcmQgPHJlY29yZF9pZD4nCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1yZWNvcmQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wdGlvbmFsbHkgcHVibGlzaCBmaWxlKHMpIHRvIGEgc3BlY2lmaWMgcmVjb3JkLiBJZiBvbWl0dGVkLCBmaWxlKHMpIHdpbGwgYmUgcHVibGlzaGVkIHRvIHRoZSB1c2VyXCdzIHBlcnNvbmFsIHJlY29yZC4nCiAgICAgICAgfQogICAgXQp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdwdWJsaXNoYXNrJywgYXJncyA9PiB0aGlzQm90LmNtZFB1Ymxpc2hBc2soYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdWJsaXNoIGFuIGFzayB0byB0aGUgcHVibGljIGFiIHJlY29yZC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgUHVibGlzaCBhbiBhc2sgdG8gdGhlIHB1YmxpYyBhYiByZWNvcmQuCgogICAgQW4gYWIgYXNrIGlzIGEgbGl0dGxlIHBvaW50ZXIgdG8gYSBwYXR0ZXJuIGluc2lkZSBvZiBhIHNwZWNpZmljIHN0dWRpby4gVGhlIGFzayBjYW4gYmUgdXNlZCB0byBsb2FkIHRoZSBnaXZlbiBwYXR0ZXJuIHVzaW5nIGEgc2ltcGxlIG5hbWUsIGxpa2UgYSBzaG9ydGN1dCBvciBhbiBhbGlhcy4KCiAgICBUaGUgYXNrIGl0c2VsZiBpcyBzdG9yZWQgaW4gdGhlIHB1YmxpYyBhYiByZWNvcmQgc28gdGhhdCBhbnlvbmUgY2FuIHJlYWQgdGhlIHBvaW50ZXIgZmlsZSwgYnV0IHRoZSBwZXJtaXNzaW9ucyBmb3IgdGhlIHBhdHRlcm4gaW5zaWRlIHRoZSBzdHVkaW8gYXJlIHN0aWxsIG1hbmFnZWQgYnkgdGhlIG9yaWdpbmFsIGF1dGhvci4KCiAgICBBbnkgdXBkYXRlcyB0byBhbiBleGlzdGluZyBhc2sgd2lsbCBiZSBvdmVyd3JpdHRlbi4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcucHVibGlzaGFzayAtYXNrIDxhc2tJRD4gLXBhdHRlcm4gPHBhdHRlcm5JRD4gLXN0dWRpbyA8c3R1ZGlvSUQ+JywKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLWFzaycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIGFzayB0byBiZSBzZXQuJywKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1wYXR0ZXJuJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgcGF0dGVybiBzZXQgdGhlIGFzayB0byBwb2ludCBhdC4nLAogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXN0dWRpbycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHN0dWRpbyB0byBzZXQgdGhlIGFzayB0byBwb2ludCBhdC4gVGhpcyBpcyB0ZWNobmljYWxseSBvcHRpb25hbCwgaWYgbm90IHByb3ZpZGVkIHRoZW4gdGhlIHN0dWRpbyBJRCBvZiB0aGUgY3VycmVudGx5IGxvZ2dlZCBpbiB1c2VyIHdpbGwgYmUgdXNlZC4nLAogICAgICAgIH0KICAgIF0KfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndmlld3JlY29yZGRhdGEnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKCFsaW5rcy52aWV3UmVjb3JkRGF0YUFwcCkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiVmlld1JlY29yZCcpOwogICAgfQoKICAgIGNvbnN0IGlzQWxpYXMgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ0ZsYWcoYXJncywgJy1hJykKCiAgICBsZXQgcmVjb3JkTmFtZTsKCiAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICByZWNvcmROYW1lID0gYXJncy5qb2luKCcgJyk7CiAgICB9CgogICAgaWYgKGlzQWxpYXMpIHsKICAgICAgICBzd2l0Y2gocmVjb3JkTmFtZSkgewogICAgICAgICAgICBjYXNlICdwbGF5ZXInOgogICAgICAgICAgICAgICAgaWYgKGF1dGhCb3QpIHsKICAgICAgICAgICAgICAgICAgICByZWNvcmROYW1lID0gYXV0aEJvdC5pZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLnZpZXdyZWNvcmRkYXRhIG11c3QgYmUgbG9nZ2VkIGluIHRvIHZpZXcgcGxheWVyIHJlY29yZC5gKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnYWInOgogICAgICAgICAgICAgICAgcmVjb3JkTmFtZSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAudmlld3JlY29yZGRhdGEgY29tbWFuZCBkb2VzIG5vdCByZWNvZ25pemUgYWxpYXMgJHtyZWNvcmROYW1lfWApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFyZWNvcmROYW1lICYmIGF1dGhCb3QpIHsKICAgICAgICAgICAgcmVjb3JkTmFtZSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQogICAgfQogICAgCiAgICBpZiAocmVjb3JkTmFtZSkgewogICAgICAgIGxpbmtzLnZpZXdSZWNvcmREYXRhQXBwLm1vdW50KHsgcmVjb3JkTmFtZSB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLnZpZXdyZWNvcmRkYXRhIGNvbW1hbmQgcmVxdWlyZXMgYSByZWNvcmROYW1lYCk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdWaWV3IGRhdGEgc3RvcmVkIGluIHByb3ZpZGVkIHJlY29yZCBuYW1lLiBJZiByZWNvcmQgbmFtZSBpcyBub3QgcHJvdmlkZWQgdGhlbiBpdCB3aWxsIGRlZmF1bHQgdG8geW91ciBwZXJzb25hbCByZWNvcmQuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYFZpZXcgZGF0YSBzdG9yZWQgaW4gcHJvdmlkZWQgcmVjb3JkIG5hbWUuIElmIHJlY29yZCBuYW1lIGlzIG5vdCBwcm92aWRlZCB0aGVuIGl0IHdpbGwgZGVmYXVsdCB0byB5b3VyIHBlcnNvbmFsIHJlY29yZC4KCiAgICBUaGVyZSBhcmUgc29tZSBhbGlhc2VzIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCB0aGUgYWxpYXMgYXJndW1lbnQgdG8gbG9hZCBhIHJlY29yZCB2aWEgYWxpYXM6CiAgICAtIHBsYXllcjogeW91ciBwZXJzb25hbCByZWNvcmQKICAgIC0gYWI6IGFiJ3MgcHVibGljIHJlY29yZAogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy52aWV3cmVjb3JkZGF0YScsCiAgICAgICAgJy52aWV3cmVjb3JkZGF0YSBbcmVjb3JkTmFtZV0nLAogICAgICAgICctdmlld3JlY29yZGRhdGEgLWEgYWInICAKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLWEnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBwcm92aWRlZCByZWNvcmROYW1lIGlzIGFjdHVhbGx5IGFuIGFsaWFzLicKICAgICAgICB9CiAgICBdCn0pJwD/4Zm1AuaTCwhhcnRpZmFjdAIEAP/hmbUCkN4MKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAP/hmbUC5pMLFWxvYWRBQkNvbW1hbmRzTWFuYWdlcgIEAP/hmbUCt94M+i1ALyoqCiAqIEFCQ29tbWFuZHNNYW5hZ2VyIGlzIHBhcnQgb2YgYWJTaGVsbC4KICogWW91IGNhbiByZWdpc3RlciBjb21tYW5kcyB0byBpdCB0aGF0IGNhbiBiZSBpbnZva2VkIHVzaW5nICckPGNvbW1hbmQ+JyB3aXRoIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICogSXRzIGdlbmVyYWxseSBub3QgcmVjb21tZW5kZWQgdG8gY3JlYXRlIHRoaXMgeW91cnNlbGYgYnV0IGluc3RlYWQgdG8gbGlzdGVuIGZvciB0aGUgQG9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkIHNob3V0CiAqIGFuZCB0byByZWdpc3RlciB5b3VyIGNvbW1hbmRzIHRoZXJlLgogKiBAcHJvcCB7c3RyaW5nW119IGNvbW1hbmRzCiAqLwpjbGFzcyBBQkNvbW1hbmRzTWFuYWdlciB7CiAgICBjb21tYW5kczogUmVjb3JkPHN0cmluZywgQUJDb21tYW5kPjsKCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLmNvbW1hbmRzID0ge307CgogICAgICAgIC8vIFNob3V0IHRoYXQgYW4gaW5zdGFuY2Ugb2YgQUJDb21tYW5kc01hbmFnZXIgaGFzIGJlZW4gY3JlYXRlZCBhbmQgYWxsb3cgYW55IGxpc3RlbmVycwogICAgICAgIC8vIHRvIGFkZCB0aGVpciBvd24gY29tbWFuZHMgdG8gdGhlIGluc3RhbmNlLgogICAgICAgIHNob3V0KCdvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCcsIHRoaXMpOwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgY29tbWFuZCB0byBBQkNvbW1hbmRzTWFuYWdlci4KICAgICAqIFRoaXMgY29tbWFuZCB3aWxsIGJlIGF2YWlsYWJsZSB0byBpbnZva2UgdXNpbmcgJyQ8bmFtZT4nIG9uIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBzdWNjZXNzZnVsbHkgYWRkZWQuCiAgICAgKi8KICAgIGFkZENvbW1hbmQobmFtZTogc3RyaW5nLCBjYWxsYmFjazogQUJDb21tYW5kQ2FsbGJhY2ssIGhlbHA6IEFCQ29tbWFuZEhlbHApOiBib29sZWFuIHsKICAgICAgICBpZiAoIW5hbWUgfHwgdHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gc3RyaW5nIG5hbWUgaXMgcmVxdWlyZWQgZm9yIGNvbW1hbmRzLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgYWxyZWFkeSBleGlzdHMgYXMgYSBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWNhbGxiYWNrIHx8IHR5cGVvZiBjYWxsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBhIGNhbGxiYWNrIGZ1bmN0aW9uLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHApIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIGlzIG1pc3Npbmcgc2hvcnREZXNjcmlwdGlvbiBmcm9tIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbW1hbmRzW25hbWVdID0geyBuYW1lLCBjYWxsYmFjaywgaGVscCB9OwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGhhc0NvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29tbWFuZHNbbmFtZV0gIT0gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSBhIGNvbW1hbmQgZnJvbSBBQkNvbW1hbmRzTWFuYWdlcgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdhcyByZW1vdmVkLiBJZiB0aGUgY29tbWFuZCBkb2Vzbid0IGV4aXN0IGZhbHNlIHdpbGwgYWxzbyBiZSByZXR1cm5lZC4KICAgICAqLwogICAgcmVtb3ZlQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENhbGwgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdpdGggdGhlIHByb3ZpZGVkIGFyZ3MgKGlmIGFueSkuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgZXhlY3V0ZWQuCiAgICAgKi8KICAgIGNhbGxDb21tYW5kKG5hbWU6IHN0cmluZywgYXJncz86IGFueVtdKTogYm9vbGVhbiB7CiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgaWYgKGNvbW1hbmQpIHsKICAgICAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaGVscEFyZyBvZiBjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShoZWxwQXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaCguLi5oZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBc3NlcnQgdGhhdCB0aGUgaW5wdXQgYXJncyBhcmUgdmFsaWQgYWdhaW5zdCB0aGUgY29tbWFuZCBoZWxwIGRvY3VtZW50YXRpb24uCiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGVhc3kgd2F5IHRvIHZhbGlkYXRlIGFyZ3MgYmVmb3JlIGV4ZWN1dGluZyBhIGNvbW1hbmQuCiAgICAgICAgICAgICAgICBBQkNvbW1hbmRzTWFuYWdlci5hc3NlcnRWYWxpZEFyZ3MoYXJncywgdmFsaWRBcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21tYW5kLmNhbGxiYWNrKGFyZ3MpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgbm90IGEgdmFsaWQgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBwcm92aWRlZCBhcmcuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgYW5kIHZhbHVlIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ1ZhbHVlKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGFueSB7CiAgICAgICAgbGV0IHZhbHVlID0gbnVsbDsKCiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgbGV0IGRlbGV0ZUNvdW50ID0gMTsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlSW5kZXggPSBhcmdJbmRleCArIDE7CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlSW5kZXggPCBhcmdzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhcmdzW3ZhbHVlSW5kZXhdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSByZWxhdGVkIGFyZ3MgJiB2YWx1ZXMKICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCBkZWxldGVDb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB3ZXRoZXIgdGhlIGFyZyBmbGFnIGlzIHByb3ZpZGVkIGluIHRoZSBhcmdzLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ0ZsYWcoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFyZyBmbGFnLgogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIDEpOwoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICBzdGF0aWMgYXNzZXJ0VmFsaWRBcmdzKGFyZ3M6IGFueVtdLCB2YWxpZEFyZ3M6IGFueVtdKTogdm9pZCB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgaW52YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGFyZyBvZiBhcmdzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJnICYmIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcmcgd2Ugd2FudCB0byBldmFsdWF0ZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZEFyZ3MgfHwgIXZhbGlkQXJncy5pbmNsdWRlcyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGFyZyBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHZhbGlkQXJncywgdGh1cyB0aGUgYXJnIGlzIGludmFsaWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQXJncy5wdXNoKGFyZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgdGhpcyBhcmcgaXQgaXMgbW9zdGx5IGxpa2VseSBhIHZhbHVlIGFyZy4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpbnZhbGlkQXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgSW52YWxpZCBhcmd1bWVudHM6ICR7aW52YWxpZEFyZ3Muam9pbignLCAnKX1gOwoKICAgICAgICAgICAgICAgIG9zLnRvYXN0KGVycm9yTWVzc2FnZSwgNCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKZ2xvYmFsVGhpcy5BQkNvbW1hbmRzTWFuYWdlciA9IEFCQ29tbWFuZHNNYW5hZ2VyOycA/+GZtQLmkwsEaGVscAIEAP/hmbUCsowNKPCflJcyNGRjMDQzMS1mZmJiLTQ0OGQtYWE3NS05NzFiYWEwNzE4ZGMnAP/hmbUC5pMLCGNtZFNoZWV0AgQA/+GZtQLZjA3NFEBjb25zdCBhcmdzID0gdGhhdDsKCmxldCBwb3J0YWw7CmxldCBuZXdUYWIgPSBmYWxzZTsKCmlmIChhcmdzKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBhcmcgPSBhcmdzW2ldOwogICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgIGlmIChhcmcgPT09ICctdCcpIHsKICAgICAgICAgICAgICAgIG5ld1RhYiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFwb3J0YWwpIHsKICAgICAgICAgICAgcG9ydGFsID0gYXJnOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFwb3J0YWwpIHsKICAgIHBvcnRhbCA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKY29uc3QgaGVscGVyQm90cyA9IHsKICAgICdjb25maWdCb3QnOiBjb25maWdCb3QsCiAgICAnZ3JpZFBvcnRhbEJvdCc6IGdyaWRQb3J0YWxCb3QsCiAgICAnc2hlZXRQb3J0YWxCb3QnOiBzaGVldFBvcnRhbEJvdCwKICAgICdzeXN0ZW1Qb3J0YWxCb3QnOiBzeXN0ZW1Qb3J0YWxCb3QsCiAgICAnbWluaUdyaWRQb3J0YWxCb3QnOiBtaW5pR3JpZFBvcnRhbEJvdCwKICAgICdtYXBQb3J0YWxCb3QnOiBtYXBQb3J0YWxCb3QsCiAgICAnbWluaU1hcFBvcnRhbEJvdCc6IG1pbmlNYXBQb3J0YWxCb3QsCiAgICAnbWVudVBvcnRhbEJvdCc6IG1lbnVQb3J0YWxCb3QsCiAgICAnbGVmdFdyaXN0UG9ydGFsQm90JzogbGVmdFdyaXN0UG9ydGFsQm90LAogICAgJ3JpZ2h0V3Jpc3RQb3J0YWxCb3QnOiByaWdodFdyaXN0UG9ydGFsQm90LAogICAgJ21lZXRQb3J0YWxCb3QnOiBtZWV0UG9ydGFsQm90LAogICAgJ3RhZ1BvcnRhbEJvdCc6IHRhZ1BvcnRhbEJvdCwKICAgICdpbXVQb3J0YWxCb3QnOiBpbXVQb3J0YWxCb3QsCn07CgovLyBGdW5jdGlvbiB0byByZXNvbHZlIGEgcG9ydGFsIHJlZmVyZW5jZSB0byBhIHNwZWNpZmljIGJvdApmdW5jdGlvbiByZXNvbHZlUG9ydGFsVG9Cb3QocGF0aCkgewogICAgaWYgKCFwYXRoIHx8IHBhdGggPT09ICcnKSByZXR1cm4gbnVsbDsKICAgIAogICAgLy8gRmlyc3QgY2hlY2sgaWYgaXQncyBkaXJlY3RseSBpbiBoZWxwZXJCb3RzCiAgICBpZiAoaGVscGVyQm90c1twYXRoXSkgewogICAgICAgIHJldHVybiBoZWxwZXJCb3RzW3BhdGhdOwogICAgfQoKICAgIC8vIFBlcmhhcHMgdGhlIHBhdGggaXMgYSBib3QgaWQuCiAgICBsZXQgYm90RnJvbUlkU2VhcmNoID0gZ2V0Qm90KCdpZCcsIHBhdGgpOwogICAgaWYgKGJvdEZyb21JZFNlYXJjaCkgewogICAgICAgIHJldHVybiBib3RGcm9tSWRTZWFyY2g7CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGZvciBib3RoIGRpcmVjdCBhbmQgbmVzdGVkIHBhdGhzIGluIGdsb2JhbFRoaXMKICAgIGxldCBwYXRoUGFydHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICBsZXQgY3VycmVudE9iaiA9IGdsb2JhbFRoaXM7CiAgICBsZXQgc3RhcnRJbmRleCA9IDA7CiAgICAKICAgIC8vIEhhbmRsZSBpZiB0aGUgcGF0aCBleHBsaWNpdGx5IHN0YXJ0cyB3aXRoICdnbG9iYWxUaGlzJwogICAgaWYgKHBhdGhQYXJ0c1swXSA9PT0gJ2dsb2JhbFRoaXMnKSB7CiAgICAgICAgc3RhcnRJbmRleCA9IDE7IC8vIFNraXAgdGhlICdnbG9iYWxUaGlzJyBwYXJ0IHNpbmNlIHdlJ3JlIGFscmVhZHkgc3RhcnRpbmcgdGhlcmUKICAgIH0KICAgIAogICAgLy8gVHJhdmVyc2UgdGhlIHBhdGgKICAgIGZvciAobGV0IGkgPSBzdGFydEluZGV4OyBpIDwgcGF0aFBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcGFydCA9IHBhdGhQYXJ0c1tpXTsKICAgICAgICBpZiAoIWN1cnJlbnRPYmpbcGFydF0pIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIFBhdGggc2VnbWVudCBkb2Vzbid0IGV4aXN0CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRPYmogPSBjdXJyZW50T2JqW3BhcnRdOwogICAgfQogICAgCiAgICAvLyBDaGVjayBpZiB0aGUgZmluYWwgb2JqZWN0IGlzIGEgYm90IChoYXMgaWQgYW5kIHRhZ3MpCiAgICBpZiAoY3VycmVudE9iaiAmJiBjdXJyZW50T2JqLmlkICYmIGN1cnJlbnRPYmoudGFncykgewogICAgICAgIHJldHVybiBjdXJyZW50T2JqOwogICAgfQogICAgCiAgICByZXR1cm4gbnVsbDsgLy8gTm90IGEgdmFsaWQgYm90Cn0KCi8vIFNlYXJjaCB0byBzZWUgaWYgcG9ydGFsIGFyZ3VtZW50IGlzIHNwZWNpZmljIHRvIGEgYm90CmxldCB1bmlxdWVCb3QgPSByZXNvbHZlUG9ydGFsVG9Cb3QocG9ydGFsKTsKCmlmICh1bmlxdWVCb3QpIHsKICAgIGlmICh1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBMb2NhbCcgfHwKICAgICAgICB1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBTaGFyZWQnCiAgICApIHsKICAgICAgICAvLyBGb3JjZSBzaGVldCB0byBvcGVuIGluIHNhbWUgdGFiIGlmIHRoZSBib3Qgb25seSBsaXZlcyBpbiB0aGlzIHRhYi4KICAgICAgICBuZXdUYWIgPSBmYWxzZTsKICAgIH0KICAgIHBvcnRhbCA9IHVuaXF1ZUJvdC5pZDsKfQoKaWYgKG5ld1RhYikgewogICAgb3Mub3BlblVSTChgLz9pbnN0PSR7b3MuZ2V0Q3VycmVudEluc3QoKX0mc2hlZXRQb3J0YWw9JHtwb3J0YWx9YCk7Cn0gZWxzZSB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IHBvcnRhbDsKfScA/+GZtQLmkwsNY21kRG93bmxvYWRBQgIEAP/hmbUCp6ENowtAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgYXV4VmVyc2lvbjogc3RyaW5nID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXYnKTsKCmlmICghYXV4VmVyc2lvbikgewogICAgLy8gRGVmYXVsdCB0byBhdXggdmVyc2lvbiAyIGlmIGFyZ3VtZW50IGlzIG5vdCBwcm92aWRlZC4KICAgIGF1eFZlcnNpb24gPSAnMic7Cn0KCmlmIChhdXhWZXJzaW9uICE9PSAnMScgJiYgYXV4VmVyc2lvbiAhPT0gJzInKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBPbmx5IGF1eCBmb3JtYXQgdmVyc2lvbiAxIGFuZCAyIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGRvd25sb2FkIGFiIGNvbW1hbmQuYCk7CiAgICByZXR1cm47Cn0KCi8vIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiBmYWxzZSB9KTsKCmxldCBncm91cHMgPSBbXTsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgLy8gUmVtYWluaW5nIGFyZ3MgYXJlIGdyb3VwIG5hbWVzIHByb3ZpZGVkIHdpdGggdGhlIGNvbW1hbmQuCiAgICBncm91cHMgPSBhcmdzOwp9IGVsc2UgewogICAgbGV0IGdyb3VwID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCwgeyB0aXRsZTogJ0FCIEdyb3VwIFRhZycsIGF1dG9TZWxlY3Q6IHRydWUgfSk7CiAgICBpZiAoZ3JvdXApIHsKICAgICAgICBtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAgPSBncm91cDsKICAgICAgICBncm91cHMucHVzaChncm91cCk7CiAgICB9Cn0KCmNvbnN0IG1ham9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWFqb3JWZXJzaW9uOwpjb25zdCBtaW5vclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1pbm9yVmVyc2lvbjsKY29uc3QgYWJWZXJzaW9uID0gYCR7bWFqb3JWZXJzaW9ufS4ke21pbm9yVmVyc2lvbn1gOwoKZm9yIChsZXQgZ3JvdXAgb2YgZ3JvdXBzKSB7CiAgICBjb25zdCBncm91cEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgW2dyb3VwXTogdHJ1ZSwgc3BhY2U6ICdzaGFyZWQnIH0pKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwQm90cy5sZW5ndGg7IGkrKykgewogICAgICAgIGdyb3VwQm90c1tpXS50YWdzLmFiVmVyc2lvbiA9IGFiVmVyc2lvbjsKICAgIH0KCiAgICBpZiAoZ3JvdXAgPT0gImFiQ29uZmlnIikgewogICAgICAgIGdyb3VwID0gImFiMSI7CiAgICB9CgogICAgaWYgKGF1eFZlcnNpb24gPT09ICcxJykgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMQogICAgICAgIG9zLmRvd25sb2FkQm90cyhncm91cEJvdHMsIGdyb3VwKQogICAgfSBlbHNlIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDIKICAgICAgICBvcy5kb3dubG9hZEJvdHNBc0luaXRpYWx6YXRpb25VcGRhdGUoZ3JvdXBCb3RzLCBncm91cCk7CiAgICB9Cgp9CgonAP/hmbUC5pMLCWNtZEFCV2FrZQIEAP/hmbUCy6wNMUBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogdHJ1ZSB9KTsnAP/hmbUC5pMLCmNtZEFCU2xlZXACBAD/4Zm1Av2sDdABQGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiBmYWxzZSB9KTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cgp0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOycA/+GZtQLmkwsHY29uc29sZQIEAP/hmbUCzq4NKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAP/hmbUC5pMLDmNtZFVwbG9hZEZpbGVzAgQA/+GZtQL1rg2TEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScA/+GZtQLmkwsOY21kRG93bmxvYWRFZ2cCBAD/4Zm1Aom/DfkLQGNvbnN0IHJlY29yZEtleSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXksIHsKICAgIHRpdGxlOiAncmVjb3JkIHRvIGxvb2t1cCBlZ2cgaW4nLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleTpgLCByZWNvcmRLZXkpOwoKaWYgKCFyZWNvcmRLZXkpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5ID0gcmVjb3JkS2V5OwoKY29uc3QgZWdnTmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lLCB7CiAgICB0aXRsZTogJ25hbWUgb2YgZWdnJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2dOYW1lOmAsIGVnZ05hbWUpOwoKaWYgKCFlZ2dOYW1lKSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUgPSBlZ2dOYW1lOwoKY29uc3QgZWdnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgIGFiSUQ6IGVnZ05hbWUsCiAgICByZWNvcmRLZXksCiAgICByZXR1cm5UeXBlOiAnZWdnJwp9KQoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2c6YCwgZWdnKTsKCmlmICghQXJyYXkuaXNBcnJheShlZ2cuZWdnVmVyc2lvbkhpc3RvcnkpIHx8IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYERhdGEgZm91bmQgYXQgYWRkcmVzcyAnJHtlZ2dOYW1lfScgaW4gcmVjb3JkICcke3JlY29yZEtleX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlZ2cuYCkKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBlZ2dWZXJzaW9uT3B0aW9ucyA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7CiAgICByZXR1cm4geyBsYWJlbDogYHZlcnNpb24gJHtpbmRleCArIDF9YCwgdmFsdWU6IGluZGV4IH0KfSkKCmNvbnN0IHNlbGVjdGVkVmVyc2lvbk9wdGlvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChlZ2dWZXJzaW9uT3B0aW9ucy5sZW5ndGggLSAxLCB7CiAgICB0aXRsZTogJ2Rvd25sb2FkIGVnZyB2ZXJzaW9uJywKICAgIHR5cGU6ICdsaXN0JywKICAgIHN1YnR5cGU6ICdzZWxlY3QnLAogICAgaXRlbXM6IGVnZ1ZlcnNpb25PcHRpb25zLAp9KQoKaWYgKCFzZWxlY3RlZFZlcnNpb25PcHRpb24pIHsKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBhdXhEYXRhVXJsID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5W3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZV07CmNvbnN0IGF1eERhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGF1eERhdGFVcmwpOwpjb25zdCBhdXhGaWxlbmFtZSA9IGAke2VnZ05hbWV9X3Yke3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZSArIDF9LmF1eGA7Cgpvcy5kb3dubG9hZChhdXhEYXRhLCBhdXhGaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsnAP/hmbUC5pMLD2NtZERvd25sb2FkSW5zdAIEAP/hmbUCg8sNWUBhYi5saW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgcmVvcGVuQWJNZW51OiBmYWxzZSwgc291cmNlRXZlbnQ6ICdhYl9jbWRfZG93bmxvYWRfaW5zdCcgfSk7JwD/4Zm1AuaTCwZzZWFyY2gCBAD/4Zm1At3LDSjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwD/4Zm1AuaTCwV1dGlscwIEAP/hmbUChMwNKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAP/hmbUC5pMLCWNtZFN5c3RlbQIEAP/hmbUCq8wNkQdAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBzYW1lV2luZG93ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctdycpOwoKbGV0IHN5c3RlbVRhZ05hbWUgPSBudWxsOwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICBzeXN0ZW1UYWdOYW1lID0gYXJncy5qb2luKCcgJyk7Cn0KCmlmIChzYW1lV2luZG93KSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LgogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsID0gdHJ1ZTsKICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVRhZ05hbWUgPSBzeXN0ZW1UYWdOYW1lOwp9IGVsc2UgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIGEgbmV3IHRhYi4KICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKTsKCiAgICAvLyBSZW1vdmUgYW55IHBvcnRhbHMgdGhhdCBhcmUgc2V0IGluIHRoZSBVUkwuCiAgICBsZXQgcGFyYW1zID0gdXJsLnNlYXJjaFBhcmFtcy5rZXlzKCk7CiAgICBmb3IgKGxldCBwYXJhbSBvZiBwYXJhbXMpIHsKICAgICAgICBpZiAocGFyYW0uZW5kc1dpdGgoJ1BvcnRhbCcpKSB7CiAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKHBhcmFtKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gVHVybiBvbiB0aGUgc3lzdGVtIHBvcnRhbC4KICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1Qb3J0YWwnLCAndHJ1ZScpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3N5c3RlbVRhZ05hbWUnKTsKCiAgICBpZiAoc3lzdGVtVGFnTmFtZSkgewogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1UYWdOYW1lJywgc3lzdGVtVGFnTmFtZSk7CiAgICB9CgogICAgb3Mub3BlblVSTCh1cmwuaHJlZik7Cn0KJwD/4Zm1AuaTCw1hYkNoYXRCYXJPcGVuAgQA/+GZtQK90w2RA0BpZiAoYWIubGlua3MucmVtZW1iZXIudGFncy5hYkFsbG93Q2hhdEJhciA9PT0gZmFsc2UpIHsKICAgIHJldHVybjsKfQoKY29uc3QgewogICAgcHJlZmlsbCwKfSA9IHRoYXQgPz8ge30KCm1hc2tzLmNoYXRPcGVuID0gdHJ1ZTsKCm9zLnNob3dDaGF0KHsKICAgIHBsYWNlaG9sZGVyOiAnPiAuaGVscCB0byBzZWUgYXZhaWxhYmxlIGNvbW1hbmRzJywKICAgIGJhY2tncm91bmRDb2xvcjogJyMyZjJmMmYnLAogICAgZm9yZWdyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcGxhY2Vob2xkZXJDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHByZWZpbGwKfSkKCnNob3V0KCdvbkFCQ2hhdEJhck9wZW4nLCB7IHByZWZpbGwgfSk7JwD/4Zm1AuaTCw5hYkNoYXRCYXJDbG9zZQIEAP/hmbUCz9YNkgFAbWFza3MuY2hhdE9wZW4gPSBmYWxzZTsKb3MuaGlkZUNoYXQoKTsKCnNob3V0KCdvbkFCQ2hhdEJhckNsb3NlJyk7CgovLyBHaXZlIENhc3VhbE9TIGEgY2hhbmdlIHRvIGFjdHVhbGx5IHJlbW92ZSB0aGUgY2hhdCBiYXIuCmF3YWl0IG9zLnNsZWVwKDApOycA/+GZtQLmkwsLcGVyc29uYWxpdHkCBAD/4Zm1AuLXDSjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwD/4Zm1AuaTCwV0eXBlcwIEAP/hmbUCidgN8gLwn5OEdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9JwD/4Zm1AuaTCxF2aWV3UmVjb3JkRGF0YUFwcAIEAP/hmbUC+toNKPCflJc5MmZmNmQyOC0zMzUxLTRjZmItODQ2NC05ZDdjNjE0MjdhMjYnAP/hmbUC5pMLEWNtZERvd25sb2FkU3lzdGVtAgQA/+GZtQKh2w3eBkBjb25zdCBhcmdzID0gdGhhdDsKCmlmICghYXJncyB8fCBhcmdzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICdNdXN0IHByb3ZpZGUgc3lzdGVtIG5hbWUocykgdG8gZG93bmxvYWQuJywgbG9nVHlwZTogJ2Vycm9yJyB9KQogICAgcmV0dXJuOwp9Cgpjb25zdCBzeXN0ZW1OYW1lcyA9IGFyZ3M7Cgpmb3IgKGNvbnN0IHN5c3RlbU5hbWUgb2Ygc3lzdGVtTmFtZXMpIHsKICAgIGNvbnN0IHN5c3RlbU5hbWVQYXJ0cyA9IHN5c3RlbU5hbWUuc3BsaXQoJy4nKTsKCiAgICBjb25zdCBzeXN0ZW1Cb3RzID0gZ2V0Qm90cygoYikgPT4gewogICAgICAgIGlmIChiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5zeXN0ZW0pIHsKICAgICAgICAgICAgY29uc3Qgc3lzdGVtVGFnUGFydHMgPSBiLnRhZ3Muc3lzdGVtLnNwbGl0KCcuJyk7CiAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gc3lzdGVtTmFtZVBhcnRzLmV2ZXJ5KChzeXN0ZW1OYW1lUGFydCwgaW5kZXgpID0+IHN5c3RlbVRhZ1BhcnRzW2luZGV4XSA9PT0gc3lzdGVtTmFtZVBhcnQpOwogICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfQogICAgfSk7CgogICAgaWYgKHN5c3RlbUJvdHMgJiYgc3lzdGVtQm90cy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9IGAke3N5c3RlbU5hbWV9LmF1eGA7CiAgICAgICAgYWIubGlua3Muc3RvcmUuYWJEb3dubG9hZCh7IHBvc3NpYmxlQm90czogc3lzdGVtQm90cywgZmlsZW5hbWUsIHJlb3BlbkFiTWVudTogZmFsc2UsIHNvdXJjZUV2ZW50OiAnYWJfY21kX2Rvd25sb2FkX3N5c3RlbScgfSk7CiAgICB9Cn0nAP/hmbUC5pMLDWNtZFB1Ymxpc2hBc2sCBAD/4Zm1AoDiDaEPQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3QgYXNrSUQgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctYXNrJyk7CmNvbnN0IHBhdHRlcm5JRCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1wYXR0ZXJuJyk7CmxldCBzdHVkaW9JRCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1zdHVkaW8nKTsKCmlmICghYXNrSUQpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgLWFzayBpcyBhIHJlcXVpcmVkIGFyZ3VtZW50YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgppZiAoIXBhdHRlcm5JRCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGAtcGF0dGVybiBpcyBhIHJlcXVpcmVkIGFyZ3VtZW50YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgppZiAoIXN0dWRpb0lEKSB7CiAgICBpZiAoYXV0aEJvdCkgewogICAgICAgIHN0dWRpb0lEID0gYXV0aEJvdC5pZDsKICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBFaXRoZXIgcHJvdmlkZSBhIHN0dWRpbyBvciBsb2dpbiB0byB1c2UgeW91ciBwZXJzb25hbCBzdHVkaW8gZm9yIHRoZSBhc2suYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgICAgIHJldHVybjsKICAgIH0KfQoKbGV0IHB1Ymxpc2hSZXN1bHQ7Cgp0cnkgewogICAgcHVibGlzaFJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEFza0lEKHsgYXNrSUQsIHBhdHRlcm5JRCwgc3R1ZGlvSUQgfSk7Cn0gY2F0Y2ggKGUpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIHB1Ymxpc2ggYXNrICcke2Fza0lEfScuICR7bGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIHJldHVybjsKfQoKaWYgKHB1Ymxpc2hSZXN1bHQuc3VjY2VzcykgewogICAgLy8gTmVlZCB0byB1c2UgY29uZmlnQm90IHN0dWRpbyB0YWcgZm9yIGxvb2t1cC4KICAgIGNvbmZpZ0JvdC5tYXNrcy5zdHVkaW8gPSBzdHVkaW9JRDsKICAgIGF3YWl0IG9zLnNsZWVwKDApOwogICAgCiAgICB0cnkgewogICAgICAgIGNvbnN0IGxvb2t1cEFza1Jlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5sb29rdXBGcm9tU3R1ZGlvKHsgYXNrSUQsIGRhdGFPbmx5OiB0cnVlIH0pOwoKICAgICAgICBpZiAobG9va3VwQXNrUmVzdWx0LnN1Y2Nlc3MgJiYgbG9va3VwQXNrUmVzdWx0LmRhdGEpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBQdWJsaXNoZWQgYXNrICcke2Fza0lEfScuICR7SlNPTi5zdHJpbmdpZnkobG9va3VwQXNrUmVzdWx0LmRhdGEsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2xvZyd9KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEZhaWxlZCB0byBsb29rdXAgYXNrICcke2Fza0lEfScgaW4gc3R1ZGlvICcke3N0dWRpb0lEfScuYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgICAgIH0KICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEZhaWxlZCB0byBsb29rdXAgYXNrICcke2Fza0lEfScgaW4gc3R1ZGlvICcke3N0dWRpb0lEfScuICR7bGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIH0KCiAgICBjb25maWdCb3QubWFza3Muc3R1ZGlvID0gbnVsbDsKfSBlbHNlIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIHB1Ymxpc2ggYXNrICcke2Fza0lEfScuYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgoKAA=="}]}