{"version":2,"updates":[{"id":0,"timestamp":1755889062924,"update":"Ae8DyqzjgAkAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwDKrOOACQAGc3lzdGVtAgQAyqzjgAkBDWFiLnNoZWxsLmdyaWQnAMqs44AJAARmb3JtAgQAyqzjgAkPB25vdGhpbmcnAMqs44AJAAxvbkFueUJvdERyYWcCBADKrOOACRe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAMqs44AJAAhyZW1lbWJlcgIEAMqs44AJ0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAyqzjgAkACGFiSWdub3JlAgQAyqzjgAn6AQR0cnVlJwDKrOOACQAHYWJTaGVsbAIEAMqs44AJ/wEEdHJ1ZScAyqzjgAkACWFiVmVyc2lvbgIEAMqs44AJhAIEMTAuNicAyqzjgAkABWZvY3VzAgQAyqzjgAmJAqwEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKTsKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScAyqzjgAm2BgZzeXN0ZW0CBADKrOOACbcGE2FiLnNoZWxsLmNvbXBvbmVudHMnAMqs44AJtgYMQXBwQ29udGFpbmVyAgQAyqzjgAnLBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycAyqzjgAm2BghUZXh0TGluawIEAMqs44AJ+AqjA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwDKrOOACbYGBldpbmRvdwIEAMqs44AJnA62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAMqs44AJtgYMVGV4dExpbmsuY3NzAgQAyqzjgAnTEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwDKrOOACbYGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAMqs44AJwRJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAMqs44AJtgYKV2luZG93LmNzcwIEAMqs44AJsxOoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAMqs44AJtgYIcmVtZW1iZXICBADKrOOACdwWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMqs44AJtgYIYWJJZ25vcmUCBADKrOOACYMXBHRydWUnAMqs44AJtgYHYWJTaGVsbAIEAMqs44AJiBcEdHJ1ZScAyqzjgAm2BglhYlZlcnNpb24CBADKrOOACY0XBDEwLjYnAMqs44AJtgYLcGVyc29uYWxpdHkCBADKrOOACZIXKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYgEnAMqs44AJuRcHQXBwLmNzcwIEAMqs44AJuhexFjpyb290IHsKICAtLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgLS1vbi1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogIC0tYWItY29uc29sZS1oZWlnaHQ6IDMzdmg7Cn0KLyogRGFyayBtb2RlIHN1cHBvcnQgKi8KQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykgewogIDpyb290IHsKICAgIC0tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAgIC0tb24tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICB9Cn0KCi5hYi1jb25zb2xlLWJ0biB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiBpbmhlcml0OwogIGxldHRlci1zcGFjaW5nOiBpbmhlcml0OwogIGxpbmUtaGVpZ2h0OiBpbmhlcml0OwogIHRleHQtdHJhbnNmb3JtOiBpbmhlcml0OwogIHRleHQtaW5kZW50OiBpbmhlcml0OwogIHRleHQtc2hhZG93OiBpbmhlcml0OwogIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgbWFyZ2luOiBpbmhlcml0OwogIHBhZGRpbmctYmxvY2s6IGluaGVyaXQ7CiAgcGFkZGluZy1pbmxpbmU6IGluaGVyaXQ7CiAgYm9yZGVyOiBub25lOwogIHRyYW5zZm9ybTogc2NhbGUoMS4yKTsKfQoKLmFiLWNvbnNvbGUgewogIHdpZHRoOiAxMDB2dzsKICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogIHBhZGRpbmc6IDA7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KSBicmlnaHRuZXNzKDIwMCUpOwogIGFuaW1hdGlvbi1uYW1lOiBzbGlkZS1hcHAtaW47CiAgYW5pbWF0aW9uLWR1cmF0aW9uOiAwLjVzOwogIG92ZXJmbG93LXk6IGhpZGRlbjsKICB6LWluZGV4OiAxOwp9CgouYWItY29uc29sZTo6YWZ0ZXIgewogIGNvbnRlbnQ6ICIiOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB0b3A6IDA7CiAgbGVmdDogMDsKICByaWdodDogMDsKICBib3R0b206IDA7CiAgb3BhY2l0eTogMC45OwogIHotaW5kZXg6IDA7Cn0KCkBrZXlmcmFtZXMgc2xpZGUtYXBwLWluIHsKICBmcm9tIHsKICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGN1YmljLWJlemllciguNiwwLC43OSwxLjAzKTsKICAgIC8qIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMTAlKTsgKi8KICAgIC8qIGhlaWdodDogMHB4OyAqLwogICAgLyogbWluLWhlaWdodDogMHB4OyAqLwogICAgbWF4LWhlaWdodDogMHB4OwogIH0KCiAgdG8gewogICAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogICAgLyogbWluLWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOyAqLwogIH0KfQoKLmFiLWNvbnNvbGUgPiBkaXYgewogIHotaW5kZXg6IDE7CiAgcG9zaXRpb246IHJlbGF0aXZlCn0KCi5hYi1jb25zb2xlLXRvcC1iYXIgewogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHdpZHRoOiAxMDAlOwogIHRleHQtYWxpZ246IGNlbnRlcjsKICB1c2VyLXNlbGVjdDogbm9uZTsKICBkaXNwbGF5OiBmbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBlbmQ7CiAgcGFkZGluZzogMC41cmVtOwp9CgouYWItY29uc29sZS1sb2cgewogIG92ZXJmbG93LXk6IGF1dG87CiAgZmxleC1ncm93OiAxOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwogIG1pbi1oZWlnaHQ6IDI0cHg7CiAgcGFkZGluZzogMCAxcmVtOwogIGN1cnNvcjogcG9pbnRlcjsKICBvdmVyc2Nyb2xsLWJlaGF2aW9yOiBjb250YWluOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBjdXJzb3I6IGluaXRpYWw7Cn0KCi5hYi1jb25zb2xlLW1lc3NhZ2UtY29udGFpbmVyIHsKICBtYXJnaW46IDAuNXJlbSAwOwp9Ci5hYi1jb25zb2xlLW1lc3NhZ2UgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGdhcDogOHB4Owp9CgouYWItY29uc29sZS1zcGFjZXIgewogIGZsZXgtc2hyaW5rOiAwOwogIGZsZXgtZ3JvdzogMTsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgbWF4LXdpZHRoOiA4MHZ3OwogIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScAyqzjgAm5FwZnZXRBcHACBADKrOOACewt3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwDKrOOACbkXC2hpZGVDb25zb2xlAgQAyqzjgAnKUZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwDKrOOACbkXA2xvZwIEAMqs44AJ6lKFCUBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGF3YWl0IGNyZWF0ZShib3RUYWdzKTsKCnNob3V0KCJvbkFCTG9nIiwgbG9nQm90KTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwDKrOOACbkXC3Nob3dDb25zb2xlAgQAyqzjgAnwW+0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAyqzjgAm5FwZzeXN0ZW0CBADKrOOACd5fEGFiLnNoZWxsLmNvbnNvbGUnAMqs44AJuRcNdG9nZ2xlQ29uc29sZQIEAMqs44AJ71+WAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScAyqzjgAm5FwRmb3JtAgQAyqzjgAmGYQdub3RoaW5nJwDKrOOACbkXB2FiU2hlbGwCBADKrOOACY5hBHRydWUnAMqs44AJuRcKYWJJRE9yaWdpbgIEAMqs44AJk2EVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwDKrOOACbkXBlRvcEJhcgIEAMqs44AJqWHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAyqzjgAm5Fw1zaG93Q2hhdElucHV0AgQAyqzjgAmdZgVmYWxzZScAyqzjgAm5FwpzaG93VG9wQmFyAgQAyqzjgAmjZgVmYWxzZScAyqzjgAm5FwlhYlZlcnNpb24CBADKrOOACalmBDEwLjYnAMqs44AJuRcSc2V0QWJFeHBhbmRDb25zb2xlAgQAyqzjgAmuZpcCQGNvbnNvbGUubG9nKHRoaXNCb3QudmFycy5zZXRTaG93QWxsKQppZiAodHlwZW9mIHRoaXNCb3QudmFycy5zZXRTaG93QWxsICE9PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHMgPT4gIXMpOwp9IGVsc2UgaWYgKHRoYXQgPT0gdHJ1ZSkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwodHJ1ZSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChmYWxzZSk7Cn0KJwDKrOOACbkXCGFiSWdub3JlAgQAyqzjgAnGaAR0cnVlJwDKrOOACbkXB01lc3NhZ2UCBADKrOOACcto5xBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPgogICAgICAgICAgICAgICAgICAgIHttZXNzYWdlfQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gTWVzc2FnZTsnAMqs44AJuRcQb25BbnlCb3RzUmVtb3ZlZAIEAMqs44AJs3mtAkBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3RJZCBvZiBib3RJRHMpIHsNCiAgICBpZiAodGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgY29uc3QgZGVsZXRlZCA9IHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmRlbGV0ZShib3RJZCk7DQoNCiAgICAgICAgaWYgKGRlbGV0ZWQpIHsNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdElkOiBib3RJZCB9KTsNCiAgICAgICAgfQ0KICAgIH0NCn0nAMqs44AJuRcOb25BbnlCb3RzQWRkZWQCBADKrOOACeF7+ANAY29uc3QgeyBib3RzIH0gPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IG5ld0JvdCBvZiBib3RzKSB7DQogICAgaWYgKG5ld0JvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhuZXdCb3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQobmV3Qm90LmlkKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdDogbmV3Qm90IH0pOw0KICAgIH0NCn0nAMqs44AJuRcQb25BbnlCb3RzQ2hhbmdlZAIEAMqs44AJ2n/jBUBjb25zdCBib3RzID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3Qgb2YgYm90cykgew0KICAgIGlmIChib3QuYm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKGJvdC5ib3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQoYm90LmJvdC5pZCk7DQoNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IGJvdC5ib3QgfSk7DQogICAgICAgIH0gDQoNCiAgICAgICAgaWYgKGJvdC50YWdzLmluY2x1ZGVzKCJtZXNzYWdlIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoIm5hbWUiKSB8fCBib3QudGFncy5pbmNsdWRlcygidGltZXN0YW1wIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoImNvbnNvbGVMb2dNZXNzYWdlQm90IikpIHsNCiAgICAgICAgICAgIGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7ICAgICAgICANCiAgICAgICAgfQ0KICAgIH0NCn0nAMqs44AJuRcfb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZAIEAMqs44AJvoUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycAyqzjgAm5Fx1vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZAIEAMqs44AJ9YUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycBBGJvdHMkMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjAScAyqzjgAmshgEGc3lzdGVtAgQAyqzjgAmthgENYWIuc2hlbGwuaGVscCcAyqzjgAmshgEJb25LZXlEb3duAgQAyqzjgAm7hgGIAkBpZiAodGFncy5hY3RpdmUgJiYgdGhhdC5rZXlzLmluY2x1ZGVzKCdFc2NhcGUnKSkgewogICAgaWYgKHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgZm9yIChsZXQgY2FsbGJhY2sgb2YgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfScAyqzjgAmshgEHdW5tb3VudAIEAMqs44AJxIgBjgFAYXdhaXQgb3MuY29tcGlsZUFwcCh0YWdzLmFwcElkLCA8PjwvPik7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAodGFncy5hcHBJZCk7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IHVuZGVmaW5lZDsKbWFza3MuYWN0aXZlID0gZmFsc2U7JwDKrOOACayGAQlzdHlsZS5jc3MCBADKrOOACdOJAfEHLmhlbHAtdGFibGUgewogIHdpZHRoOiAxMDAlOwogIGJvcmRlci1zcGFjaW5nOiAwOwp9CgouaGVscC10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmhlbHAtdGFibGUgdGQgaDMgewogIG1hcmdpbjogMDsKfQoKLmhlbHAtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCi5zZWN0aW9uIHsKICBtYXJnaW4tdG9wOiAxNnB4Owp9Cgouc2VjdGlvbiBwOmZpcnN0LW9mLXR5cGUgewogIG1hcmdpbi10b3A6IDRweDsKICBtYXJnaW4tbGVmdDogMTZweDsKfQoKLmRlc2NyaXB0aW9uIHsgCiAgd2hpdGUtc3BhY2U6IHByZS1saW5lOwp9CgoudXNhZ2UtdGFibGUgewogIGJvcmRlci1zcGFjaW5nOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQsaDMgeyAKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKICBtYXJnaW46IDA7Cn0KCi51c2FnZS10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA2MHB4Owp9CgouYXJncy10YWJsZSB7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5hcmdzLXRhYmxlIHRkIHsKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHBhZGRpbmctYm90dG9tOiA4cHg7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouYXJncy10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA5MHB4OwogIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKQG1lZGlhIChtYXgtd2lkdGg6IDY0MHB4KSwgKG1heC1oZWlnaHQ6IDYwMHB4KSB7CiAgLmhlbHAtd2luZG93IHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbGVmdDogdW5zZXQ7CiAgICB0b3A6IHVuc2V0OwogICAgdHJhbnNmb3JtOiB1bnNldDsKICAgIG1heC13aWR0aDogdW5zZXQ7CiAgICBtYXgtaGVpZ2h0OiB1bnNldDsKICAgIGJveC1zaGFkb3c6IHVuc2V0OwogIH0KfScAyqzjgAmshgEJb25EZXN0cm95AgQAyqzjgAnFkQETQHRoaXNCb3QudW5tb3VudCgpOycAyqzjgAmshgEFbW91bnQCBADKrOOACdmRAfECQGNvbnN0IHsKICAgIGFiQ29tbWFuZHNNYW5hZ2VyLAogICAgc2VsZWN0ZWRDb21tYW5kCn0gPSB0aGF0ID8/IHt9OwoKaWYgKG1hc2tzLmFjdGl2ZSkgewogICAgYXdhaXQgdGhpc0JvdC51bm1vdW50KCk7Cn0KCmNvbnN0IEFwcCA9IHRoaXNCb3QuQXBwKCk7Cgphd2FpdCBvcy5yZWdpc3RlckFwcCh0YWdzLmFwcElkLCB0aGlzQm90KTsKYXdhaXQgb3MuY29tcGlsZUFwcCh0YWdzLmFwcElkLCA8QXBwIGNvbW1hbmRzPXthYkNvbW1hbmRzTWFuYWdlci5jb21tYW5kc30gaW5pdGlhbFNlbGVjdGVkQ29tbWFuZD17c2VsZWN0ZWRDb21tYW5kfS8+KTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gW107Cm1hc2tzLmFjdGl2ZSA9IHRydWU7JwDKrOOACayGAQpjb21wb25lbnRzAgQAyqzjgAnLlAEo8J+UlzExYzk1YzdkLWExOTMtNDAwZS1iNzEwLTNiYTA0ODZhNmExYScAyqzjgAmshgEFdXRpbHMCBADKrOOACfKUASjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDKrOOACayGAQhhYklnbm9yZQIEAMqs44AJmZUBBHRydWUnAMqs44AJrIYBB2FiU2hlbGwCBADKrOOACZ6VAQR0cnVlJwDKrOOACayGAQlhYlZlcnNpb24CBADKrOOACaOVAQQxMC42JwDKrOOACayGAQNBcHACBADKrOOACaiVAbIvQGNvbnN0IEFwcENvbnRhaW5lciA9IGxpbmtzLmNvbXBvbmVudHMuQXBwQ29udGFpbmVyKCk7CmNvbnN0IFdpbmRvdyA9IGxpbmtzLmNvbXBvbmVudHMuV2luZG93KCk7CmNvbnN0IFRleHRMaW5rID0gbGlua3MuY29tcG9uZW50cy5UZXh0TGluaygpOwpjb25zdCBjc3MgPSBsaW5rcy51dGlscy5hYkNvbXBpbGVDU1MoWyB0aGlzQm90LCBsaW5rcy5jb21wb25lbnRzIF0pOwoKY29uc3QgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlUmVmLCB1c2VNZW1vIH0gPSBvcy5hcHBIb29rczsKCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqLwpjb25zdCBBdmFpbGFibGVDb21tYW5kcyA9ICh7IGNvbW1hbmRzLCBvbkNvbW1hbmRDbGljayB9KSA9PiB7CiAgICBjb25zdCBjb21tYW5kTmFtZXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcykuc29ydCgpOwoKICAgIGNvbnN0IG9uQ2xvc2UgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQ2xvc2V9PnsneCBDbG9zZSd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj5BdmFpbGFibGUgQ29tbWFuZHM8L2gyPgogICAgICAgICAgICA8cD5Vc2FnZTogLmNvbW1hbmQgW29wdGlvbnNdPC9wPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgICAgIHtjb21tYW5kTmFtZXMubWFwKChuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRzW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PFRleHRMaW5rIG9uQ2xpY2s9eygpID0+IG9uQ29tbWFuZENsaWNrKGNvbW1hbmQubmFtZSl9Pntjb21tYW5kLm5hbWV9PC9UZXh0TGluaz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntkZXNjcmlwdGlvbn08L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7Q29tbWFuZH0gcHJvcHMuY29tbWFuZAogKi8KY29uc3QgU3BlY2lmaWNDb21tYW5kID0gKHsgY29tbWFuZCwgb25CYWNrIH0pID0+IHsKICAgIGxldCB1c2FnZSA9ICcnOwogICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKICAgIGxldCBhcmdzID0gbnVsbDsKCiAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC51c2FnZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb21tYW5kLmhlbHAudXNhZ2UpKSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZS5qb2luKCdcbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbjsKICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MgJiYgY29tbWFuZC5oZWxwLmFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhcmdzID0gY29tbWFuZC5oZWxwLmFyZ3M7CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+ICAKICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQmFja30+eyc8IEJhY2snfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+e2NvbW1hbmQubmFtZX08L2gyPgogICAgICAgICAgICB7IHVzYWdlICYmCiAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSd1c2FnZS10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGgzPlVzYWdlOjwvaDM+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2FnZX08L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgZGVzY3JpcHRpb24gJiYgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkRlc2NyaXB0aW9uOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdkZXNjcmlwdGlvbic+e2Rlc2NyaXB0aW9ufTwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgYXJncyAmJgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5Bcmd1bWVudHM6PC9oMz4KICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdhcmdzLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICAgICAgeyBhcmdzLm1hcCgoYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZy5pZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdJZGVudGlmaWVyRGlzcGxheSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyLmpvaW4oJyxcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmcuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBhcmcuZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnSWRlbnRpZmllckRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdEZXNjcmlwdGlvbkRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqIEBwYXJhbSB7YW55W119IFtwcm9wcy5hcmdzXQogKi8KY29uc3QgQXBwID0gKHsgY29tbWFuZHMsIGluaXRpYWxTZWxlY3RlZENvbW1hbmQgfSkgPT4gewogICAgY29uc3QgWyBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZCBdID0gdXNlU3RhdGUoaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCk7CgogICAgLy8gRXNjYXBlIGtleSBwcmVzcyBldmVudCBoYW5kbGVyCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IG9uRXNjYXBlS2V5UHJlc3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZENvbW1hbmQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnB1c2gob25Fc2NhcGVLZXlQcmVzcyk7CgogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrSW5kZXggPSB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5maW5kSW5kZXgoKGNhbGxiYWNrKSA9PiBjYWxsYmFjayA9PT0gb25Fc2NhcGVLZXlQcmVzcyk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnNwbGljZShjYWxsYmFja0luZGV4LCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFtzZWxlY3RlZENvbW1hbmRdKTsKICAgIAogICAgY29uc3Qgb25CYWNrZ3JvdW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CgogICAgY29uc3Qgb25Db21tYW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygobmFtZSkgPT4gewogICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChuYW1lKTsKICAgIH0sIFtzZXRTZWxlY3RlZENvbW1hbmRdKQoKICAgIGNvbnN0IGNvbnRlbnQgPSB1c2VNZW1vKCgpID0+IHsKICAgICAgICBpZiAoIXNlbGVjdGVkQ29tbWFuZCkgewogICAgICAgICAgICByZXR1cm4gPEF2YWlsYWJsZUNvbW1hbmRzIGNvbW1hbmRzPXtjb21tYW5kc30gb25Db21tYW5kQ2xpY2s9e29uQ29tbWFuZENsaWNrfS8+CiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgIHJldHVybiA8U3BlY2lmaWNDb21tYW5kIGNvbW1hbmQ9e2NvbW1hbmRzW3NlbGVjdGVkQ29tbWFuZF19IG9uQmFjaz17KCkgPT4gc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpfS8+CiAgICAgICAgfQogICAgfSwgW2NvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHN0eWxlPntjc3N9PC9zdHlsZT4KCiAgICAgICAgICAgIDxBcHBDb250YWluZXIgb25CYWNrZ3JvdW5kQ2xpY2s9e29uQmFja2dyb3VuZENsaWNrfT4KICAgICAgICAgICAgICAgIDxXaW5kb3c+CiAgICAgICAgICAgICAgICAgICAge2NvbnRlbnR9CiAgICAgICAgICAgICAgICA8L1dpbmRvdz4KICAgICAgICAgICAgPC9BcHBDb250YWluZXI+CiAgICAgICAgPC8+CiAgICApCn0KCnJldHVybiBBcHA7JwDKrOOACayGAQVhcHBJZAIEAMqs44AJ28QBD2FiLWNvbW1hbmQtaGVscCcBBGJvdHMkMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczAScAyqzjgAnrxAEGc3lzdGVtAgQAyqzjgAnsxAEPYWIuc2hlbGwuY3JlYXRlJwDKrOOACevEAQRmb3JtAgQAyqzjgAn8xAEHbm90aGluZycAyqzjgAnrxAELZGVzY3JpcHRpb24CBADKrOOACYTFAT1Cb3QgdXNlZCB0byBjcmVhdGUvbWFuaWZlc3QgYm90cyBpbnRvIGFuIGFjdHVhbCBzY2VuZS9wb3J0YWwuJwDKrOOACevEAQxhYkNyZWF0ZUJvdHMCBADKrOOACcLFAcQoQGxldCB7IAogICAgaW5pdGlhbEJvb3QsIC8vIGNoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4gKG9wdGlvbmFsKQogICAgYm90RGF0YSwgLy8gYm90cyB0byBiZSBnZW5lcmF0ZWQKICAgIG9yaWdpbiwgLy8gd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCiAgICBzdHVkaW8sIC8vIHdoYXQgc3R1ZGlvIGlzIHRoaXMgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgIHJlY29yZCwgLy8gUnlhbiBDb29rOiBkbyB3ZSBuZWVkIHRoaXMgaWYgd2UgYWxyZWFkeSBoYXZlIHN0dWRpbz8gKG9wdGlvbmFsKQogICAgdmVyc2lvbiwgLy8gdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCiAgICBlZ2dQYXJhbWV0ZXJzLCAvLyBkYXRhIHRvIHBhc3MgdG8gYWxsIGNyZWF0ZWQgYm90cyB2aWEgQG9uRWdnSGF0Y2guIChvcHRpb25hbCkKICAgIGlnbm9yZUdyaWRGb2N1cywgLy8gUnlhbiBDb29rOiBhZGRpbmcgdGhpcyBhcyBhbiBvcHRpb25hbCBmbGFnLiAob3B0aW9uYWwpCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIC8vIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIHRoZSBib3RzIGFyZSBjcmVhdGVkLiAob3B0aW9uYWwpCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsIHRvIGFiQ3JlYXRlQm90cy4gKG9wdGlvbmFsKS4KfSA9IHRoYXQ7CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBmb3Igd2hlbiBhYkNyZWF0ZUJvdHMgZXhwZWN0ZWQgImJvdHMiIHBhcmFtZXRlci4KaWYgKCFib3REYXRhICYmIHRoYXQuYm90cykgewogICAgYm90RGF0YSA9IHRoYXQuYm90czsKfQoKbGV0IGJvdENvdW50ID0gT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoOwpjb25zdCBhYkdyaWRGb2N1cyA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkRm9jdXM7CgovLyBSdW4gc29tZSBhYi1zcGVjaWZpYyBwcmVwcm9jZXNzaW5nIG9mIGJvdCBkYXRhLgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MpIHsKICAgICAgICBkYXRhLnRhZ3MuYWJJRE9yaWdpbiA9IG9yaWdpbjsKICAgICAgICBkYXRhLnRhZ3MuYWJJRFN0dWRpbyA9IHN0dWRpbzsKCiAgICAgICAgaWYgKGRhdGEudGFncy5jcmVhdG9yKSB7CiAgICAgICAgICAgIGRhdGEudGFncy5vbGRDcmVhdG9yID0gZGF0YS50YWdzLmNyZWF0b3I7CiAgICAgICAgfQoKICAgICAgICAvLyBSeWFuIENvb2s6IFRoaXMgdGFyZ2V0UG9zaXRpb24gc3R1ZmYgaXMgYXBwYXJlbnRseSB1c2VkIGZvciBib3QgcGFzdGluZz8gCiAgICAgICAgLy8gVGhpcyBpcyBzb21lIHJlYWxseSBjb25mdXNpbmcgbG9naWMgYW5kIHNob3VsZCBiZSByZWZhY3RvcmVkIGV2ZW50dWFsbHkuCiAgICAgICAgaWYgKChib3RDb3VudCA8IDIgfHwgYm90Q291bnQgPCAzICYmIGJvdERhdGEuYWJYUEJvdCAhPSBudWxsKSAmJiBhYkdyaWRGb2N1cyAmJiAhaWdub3JlR3JpZEZvY3VzKSB7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbiArICdYJ10gPSBhYkdyaWRGb2N1cy5wb3NpdGlvbi54OwogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uICsgJ1knXSA9IGFiR3JpZEZvY3VzLnBvc2l0aW9uLnk7CiAgICAgICAgfQogICAgfQp9CgovLyBEbyBhbm90aGVyIHByZXByb2Nlc3NpbmcgcGFzcyB0aGF0IGFsbG93cyBsaXN0ZW5lcnMgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIHRoZSBib3RzIGFyZWEgY3JlYXRlZC4KbGV0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKHByZXByb2Nlc3NBcmcpCn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUnLCBwcmVwcm9jZXNzQXJnKSk7CgppZiAodHlwZW9mIGJvdERhdGEgIT09ICdvYmplY3QnIHx8IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aCA9PT0gMCkgewogICAgLy8gVGhlcmUgaXNuJ3QgYW55IGJvdERhdGEgdG8gY3JlYXRlIGZyb20hCiAgICByZXR1cm47Cn0KCi8vIENyZWF0ZSBib3RzIGZyb20gdGhlIGJvdCBkYXRhLgpsZXQgaWRNYXAgPSBuZXcgTWFwKCk7CmxldCBuZXdCb3RzID0gW107CmxldCBuZXdCb3RJZHMgPSBbXTsKCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIHRyeSB7IAogICAgICAgICAgICBjb25zdCBuZXdCb3QgPSBjcmVhdGUoZGF0YS50YWdzKTsKCiAgICAgICAgICAgIGlkTWFwLnNldChkYXRhLmlkLCBuZXdCb3QuaWQpOwogICAgICAgICAgICBuZXdCb3RzLnB1c2gobmV3Qm90KTsKICAgICAgICAgICAgbmV3Qm90SWRzLnB1c2gobmV3Qm90LmlkKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaW52YWxpZCBib3RgLCBlKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpcHBlZCBib3Q6IGAsIGRhdGEpOwogICAgfQp9CgovLyBBcnJheSBvZiB0YWcgcmVsYXRpb25zaGlwcyB0byBiZSBwcmVzZXJ2ZWQKY29uc3QgbGlua1RhZ3MgPSBbImxpbmsiLCAiY3JlYXRvciIsICJjb25maWdCb3QiLCAibGluZVRvIiwgInRyYW5zZm9ybWVyIiwgImZvcm1MaWdodFRhcmdldCJdOwoKLy8gVGhpcyBsb29wIGNvbnRhaW5zIHRoZSBsb2dpYyBmb3IgcHJlc2VydmluZyB0aGUgbGlua1RhZ3MKZm9yIChsZXQgbmV3Qm90IG9mIG5ld0JvdHMpIHsKICAgIGZvciAobGV0IHRhZyBvZiBsaW5rVGFncykgewogICAgICAgIGxldCB2YWx1ZSA9IG5ld0JvdC50YWdzW3RhZ107CgogICAgICAgIGlmICh0YWcgPT0gImNyZWF0b3IiKSB7CiAgICAgICAgICAgIHZhbHVlID0gbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvcjsKICAgICAgICAgICAgbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVCb3RMaW5rcyhuZXdCb3QsIGlkTWFwKTsKCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgbGV0IG5ld1ZhbHVlID0gdmFsdWUubWFwKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWRNYXAuZ2V0KGlkKSB8fCBpZDsKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdJRCA9IGlkTWFwLmdldCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgaWYgKG5ld0lEKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3SUQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vIFRvYXN0cyBmb3IgaGF0Y2hlcywgYnV0IG9ubHkgb24gYnVpbGRlcgppZiAob3JpZ2luICYmIHZlcnNpb24gJiYgY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlID09IG51bGwgJiYgIWNvbmZpZ0JvdC50YWdzLnBoICYmIGJ1aWxkZXJWZXJzaW9uID09ICJidWlsZGVyIikgewogICAgb3MudG9hc3QoImhhdGNoZWQgIiArIG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uKTsKfQoKaWYgKG9yaWdpbikgewogICAgLy8gQ3JlYXRlIGFiRWdnIGJvdCB0aGF0IHRyYWNrcyBjYW4gYmUgdXNlZCB0byB0cmFjayB3aGF0IGVnZ3MgaGF2ZSBiZWVuIGhhdGNoZWQuCiAgICBjcmVhdGUoewogICAgICAgIHNwYWNlOiAic2hhcmVkIiwKICAgICAgICBhYjogdHJ1ZSwKICAgICAgICBhYkVnZzogdHJ1ZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBvcmlnaW5fYWI6IG9yaWdpbiwKICAgICAgICBvcmlnaW5fdmVyc2lvbjogdmVyc2lvbiwKICAgICAgICBvcmlnaW5fcmVjb3JkOiByZWNvcmQsCiAgICAgICAgb3JpZ2luX3N0dWRpbzogc3R1ZGlvLAogICAgICAgIGZvcm06ICJlZ2ciLAogICAgICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgICAgICBsYWJlbDogb3JpZ2luICsgIiB2IiArIHZlcnNpb24sCiAgICB9KTsKfQoKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47Cgp3aGlzcGVyKG5ld0JvdHMsICdvblByZUhhdGNoJywgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOwoKaWYgKGluaXRpYWxCb290KSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy8gb25FZ2dIYXRjaCBmb3IgYWxsIGp1c3QgaGF0Y2hlZCBib3RzCndoaXNwZXIobmV3Qm90cywgIm9uRWdnSGF0Y2giLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgZWdnUGFyYW1ldGVycywgc291cmNlRXZlbnQgfSk7CgovLyBvbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQUJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKc3VwZXJTaG91dCgib25BYkFkZGVkIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCnJldHVybiBuZXdCb3RzOycAyqzjgAnrxAEIcmVtZW1iZXICBADKrOOACYfuASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDKrOOACevEAQhhYklnbm9yZQIEAMqs44AJru4BBHRydWUnAMqs44AJ68QBB2FiU2hlbGwCBADKrOOACbPuAQR0cnVlJwDKrOOACevEAQlhYlZlcnNpb24CBADKrOOACbjuAQQxMC42JwDKrOOACevEAQtwZXJzb25hbGl0eQIEAMqs44AJve4BKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZgEnAMqs44AJ5O4BBnN5c3RlbQIEAMqs44AJ5e4BEGFiLnNoZWxsLnZlcnNpb24nAMqs44AJ5O4BBGZvcm0CBADKrOOACfbuAQdub3RoaW5nJwDKrOOACeTuAQhhYklnbm9yZQIEAMqs44AJ/u4BBHRydWUnAMqs44AJ5O4BB2FiU2hlbGwCBADKrOOACYPvAQR0cnVlJwDKrOOACeTuARNhYlNoZWxsTWFqb3JWZXJzaW9uAgQAyqzjgAmI7wEBMicAyqzjgAnk7gENb25Ta2lsbFVwZGF0ZQIEAMqs44AJiu8BlwFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJTaGVsbE1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJTaGVsbE1pbm9yVmVyc2lvbjsNCg0KY29uc29sZS5sb2coIltBQlNoZWxsXSBMb2FkZWQgQUIgc2hlbGwgdmVyc2lvbiAiICsgdmVyc2lvblN0cmluZyk7JwDKrOOACeTuAQlhYlZlcnNpb24CBADKrOOACaLwAQQxMC42JwDKrOOACeTuARNhYlNoZWxsTWlub3JWZXJzaW9uAgQAyqzjgAmn8AEBMScBBGJvdHMkNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmAScAyqzjgAmp8AEGc3lzdGVtAgQAyqzjgAmq8AEOYWIuc2hlbGwuc3RvcmUnAMqs44AJqfABBGZvcm0CBADKrOOACbnwAQdub3RoaW5nJwDKrOOACanwAQtkZXNjcmlwdGlvbgIEAMqs44AJwfABP1RoaXMgc2tpbGwgaXMgbWVhbnQgdG8gYmUgYSBjb25maWd1cmFibGUgbWVhbnMgdG8gcHVibGlzaCBkYXRhLicAyqzjgAmp8AEPYWJQdWJsaXNoUmVjb3JkAgQAyqzjgAmB8QHABkBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nOwpsZXQgcmVjb3JkRGF0YSA9IHRoYXQuZGF0YTsKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CmxldCBlbmRwb2ludCA9IHRoYXQuZW5kcG9pbnQgPyB0aGF0LmVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIXJlY29yZERhdGEpCnsKICAgIHJldHVybiAibm8gZGF0YSBzdXBwbGllZCI7Cn0KCmlmIChwdWJsaWNGYWNpbmcpCnsKICAgIHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHtlbmRwb2ludDogZW5kcG9pbnQsIG1hcmtlcnM6IFsicHVibGljUmVhZCJdfSk7Cn0KZWxzZQp7ICAgIAogICAgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEodXNlclJlY29yZCwgcmVjb3JkTmFtZSwgcmVjb3JkRGF0YSwge2VuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogW3JlY29yZE5hbWVdfSk7Cn0KCmlmIChyZWNvcmREYXRhLnN1Y2Nlc3MpCnsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZGF0YSByZWNvcmRlZCB0byAiICsgdXNlclJlY29yZCk7Cn0KZWxzZQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRhdGEgZmFpbGVkIHRvIHJlY29yZCIpOwp9CgpyZXR1cm4gcmVjb3JkRGF0YTsnAMqs44AJqfABDWFiUHVibGlzaEZpbGUCBADKrOOACcL3AawHQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgZmlsZSA9IHRoYXQuZmlsZTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlTmFtZTsKbGV0IG1pbWVUeXBlID0gdGhhdC5taW1lVHlwZTsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKaWYgKCFmaWxlKQp7CiAgICByZXR1cm4gIm5vIGZpbGUgc3VwcGxpZWQiOwp9CgpsZXQgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwge2Rlc2NyaXB0aW9uOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlfSk7CiAgICAKaWYgKCFmaWxlVXBsb2FkLnN1Y2Nlc3MpIAp7CiAgICBpZiAoZmlsZVVwbG9hZC5lcnJvckNvZGUgPT0gImZpbGVfYWxyZWFkeV9leGlzdHMiKQogICAgewogICAgICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZmlsZSBhbHJlYWR5IGV4aXN0cyBpbiAiICsgdXNlclJlY29yZCk7CgogICAgICAgIHJldHVybiBmaWxlVXBsb2FkOwogICAgfQoKICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbih1c2VyUmVjb3JkKTsKCiAgICBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIHJlY29yZGVkIHRvICIgKyB1c2VyUmVjb3JkKTsKfQplbHNlCnsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZmlsZSBmYWlsZWQgdG8gcmVjb3JkIik7Cn0KCnJldHVybiBmaWxlVXBsb2FkOycAyqzjgAmp8AEQYWJDb3JlTWVudUFjdGlvbgIEAMqs44AJ7/4BTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwDKrOOACanwAQtvblN0b3JlTWVudQIEAMqs44AJvf8B8JUBQGxldCBwb3NzaWJsZVB1Ymxpc2hCb3QgPSBuZXcgU2V0KCk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpKSB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzLmZvckVhY2goYiA9PiBwb3NzaWJsZVB1Ymxpc2hCb3QuYWRkKGIpKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcG9zc2libGVQdWJsaXNoQm90LmFkZChsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpOwogICAgfQp9CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgewogICAgcG9zc2libGVQdWJsaXNoQm90LmFkZChsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKTsKfQoKcG9zc2libGVQdWJsaXNoQm90ID0gQXJyYXkuZnJvbShwb3NzaWJsZVB1Ymxpc2hCb3QpOwoKY29uc3QgYmFzZUFCID0gIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMgPyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjogbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cy5pZDsKY29uc3QgYmFzZUJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBkZWZhdWx0cyA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbWFuYWdlcjogIvCflJciICsgdGhpc0JvdC5pZCwKICAgIG1hbmlmZXN0YXRpb246IHRhZ3MubWFuaWZlc3RhdGlvbiwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gCn0KCi8vIENyZWF0ZSBkb3dubG9hZCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICBsYWJlbDogImRvd25sb2FkIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtQWRkcmVzczogImdldF9hcHAiLAogICAgcG9zc2libGVCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJEb3dubG9hZCh7IHBvc3NpYmxlQm90czogbGlua3MucG9zc2libGVCb3R9KTtgCn0pOwoKaWYgKCFhdXRoQm90KSAKewogICAgLy8gQ3JlYXRlIGxvZ2luIG1lc3NhZ2UKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICAgICAgbGFiZWw6ICJwbGVhc2Ugc2lnbiBpbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIsCiAgICAgICAgb25DbGljazogYEAgb3MucmVxdWVzdEF1dGhCb3QoKWAKICAgIH0pOwoKICAgIHJldHVybjsKfQplbHNlIGlmIChhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciA9PSAiRnJlZVBsYXkiKSAKewogICAgLy8gQ3JlYXRlIHVwZ3JhZGUgc3Vic2NyaXB0aW9uIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAicGxlYXNlIHVwZ3JhZGUgeW91ciBzdWJzY3JpcHRpb24gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siCiAgICB9KTsKCiAgICByZXR1cm47Cn0KCgpsZXQgdXNlclN0dWRpb3MgPSBjb25maWdCb3QudGFncy51c2VyX3N0dWRpb3M7CgppZiAoIXVzZXJTdHVkaW9zKSAKewogICAgdXNlclN0dWRpb3MgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsKfQoKaWYgKHVzZXJTdHVkaW9zLnN1Y2Nlc3MpIAp7CiAgICBjb25zdCBhY3RpdmVTdHVkaW8gPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKTsKCiAgICBsZXQgYmFzZVN0dWRpbyA9IGF1dGhCb3QuaWQ7CgogICAgaWYgKGJhc2VTdHVkaW8gPT0gYXV0aEJvdC5pZCkgCiAgICB7CiAgICAgICAgYmFzZVN0dWRpbyA9ICJwbGF5ZXIiOwogICAgfQoKICAgIGlmIChhY3RpdmVTdHVkaW8gPT0gLTEgJiYgYmFzZVN0dWRpbyAhPSAicGxheWVyIikgCiAgICB7CiAgICAgICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBiYXNlU3R1ZGlvOwogICAgfQoKICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8gJiYgIWFjdGl2ZVN0dWRpbykgCiAgICB7CiAgICAgICAgY29uc3Qgc3R1ZGlvTWF0Y2ggPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbykKCiAgICAgICAgaWYgKHN0dWRpb01hdGNoICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2VTdHVkaW8gPSBiYXNlU3R1ZGlvOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBzdHVkaW9MYWJlbCA9IGFjdGl2ZVN0dWRpbyA9PSAtMSA/IGJhc2VTdHVkaW8gOiB1c2VyU3R1ZGlvcy5zdHVkaW9zW2FjdGl2ZVN0dWRpb10uZGlzcGxheU5hbWU7CgogICAgLy8gQ3JlYXRlIHN0dWRpbyBzZWxlY3QgYnV0dG9uCiAgICBjb25zdCBzdHVkaW9EaXNwbGF5QnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAic3R1ZGlvPSIgKyBzdHVkaW9MYWJlbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNSwKICAgICAgICBzdHVkaW9JbmZvcm1hdGlvbjogdXNlclN0dWRpb3MsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJpbnZlbnRvcnlfMiIsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5zdHVkaW9TZWxlY3QodGFncy5zdHVkaW9JbmZvcm1hdGlvbik7YAogICAgfSk7CgogICAgbWFza3Muc3R1ZGlvU2VsZWN0QnV0dG9uID0gZ2V0TGluayhzdHVkaW9EaXNwbGF5QnV0dG9uKTsKfQoKY29uc3QgdG90YWxCb3RDb3VudCA9IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggPiAwID8gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGg7CgovLyBDcmVhdGUgcHVibGlzaCBsYWJlbCBidXR0b24KY29uc3QgbGFiZWxCb3QgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGxhYmVsOiBgcHVibGlzaCBwYXR0ZXJuICR7YmFzZUJvdHMubGVuZ3RoID4gMCA/ICIiIDogImFzICJ9JHtiYXNlQUJ9ICgke3RvdGFsQm90Q291bnR9IGJvdCR7YmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICB0b3RhbEJvdHM6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGgsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBmb3JtQWRkcmVzczogbnVsbCwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHggOHB4IDBweCAwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci10b3Atc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBzaGlmdFN0YXRlOiBmYWxzZSwKICAgIG9uQ2xpY2s6IGBAIGNvbnN0IG1lbnVCb3RzID0gZ2V0Qm90cygnYWJNZW51U29ydE9yZGVyJyk7CgogICAgICAgIGlmICh0YWdzLnNoaWZ0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlVcCIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5RG93biIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGFncy5zaGlmdFN0YXRlID0gIXRhZ3Muc2hpZnRTdGF0ZTtgLAogICAgc2NhbGVZOiAiYXV0byIsCiAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBsZXQgdG90YWxCb3RzID0gY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID8gdGhhdC5hYkJvdHMgOiB0aGF0LmFiQm90cyArIHRoYXQubm9uQUJCb3RzOwoKICAgIGNvbnN0IHRvdGFsQm90VmFyID0gdG90YWxCb3RzID09IDEgPyAiIGJvdCIgOiAiIGJvdHMiOwogICAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHM/Lmxlbmd0aCAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIGlmIChnZXRCb3QoImFiSURPcmlnaW4iLCBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQikpCiAgICAgICAgewogICAgICAgICAgICBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpLmxlbmd0aDsKCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgYWJCb3RzICsgIiBib3RzKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gYWJCb3RzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggcGF0dGVybiBhcyAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgICAgIH0gICAKICAgIH0KICAgIGVsc2UKICAgIHsgICAKICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIHRoYXQuYWIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICB9YAp9KTsKCi8vIENyZWF0ZSBlbmNyeXB0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICBsYWJlbDogImVuY3J5cHQiLAogICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICBlbmNyeXB0U3RhdGU6IGZhbHNlLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgaWYodGFncy5lbmNyeXB0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gdHJ1ZTsKICAgICAgICB9YCwKfSk7CgpsZXQgYWJCdXR0b247CgppZiAocG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvLyBDcmVhdGUgaW5jbHVkZUJvdHMgYnV0dG9uCiAgICBhYkJ1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTIsCiAgICAgICAgYWJTZWxlY3Rpb25CdXR0b246IHRydWUsCiAgICAgICAgbGFiZWw6IGJhc2VCb3RzLmxlbmd0aCA+IDAgJiYgYmFzZUFCICE9IHVuZGVmaW5lZCA/IGBzZWxlY3RlZCBwYXR0ZXJuOiAke2Jhc2VBQn0gKCR7YmFzZUJvdHMubGVuZ3RofSBib3Qke2Jhc2VCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAgOiBgbmV3IHBhdHRlcm4gKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogJ2VnZycsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaFNlbGVjdCgpO2AsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyTm9uID0gdGhhdC5ub25BQkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgY29uc3QgYm90VmFyQUIgPSB0aGF0LmFiQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICAgICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSB0aGF0LmFiICsgIiAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyTm9uOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInNlbGVjdGVkIHBhdHRlcm46ICIgKyB0aGF0LmFiICsgIiAoIiArIHRoYXQuYWJCb3RzICsgYm90VmFyQUI7CiAgICAgICAgfWAKICAgIH0pOwp9CgppZiAobm9uQUJCb3RzLmxlbmd0aCA+IDAgJiYgcG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvL2ljbHVkZSBuZXcgYm90cwogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTMsCiAgICAgICAgYWJCdXR0b246IGdldExpbmsoYWJCdXR0b24pLAogICAgICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgICAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgICAgIGxhYmVsOiBgaW5jbHVkZSBuZXcgKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveCIsCiAgICAgICAgdW5jbGFpbWVkU3RhdGU6IGZhbHNlLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CgogICAgICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IGxpbmtzLmFiQnV0dG9uLnRhZ3MubGFiZWw7CgogICAgICAgICAgICAgICAgaWYgKGxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGFncy51bmNsYWltZWRTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25BQkJvdHMubGVuZ3RofSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwoKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IHRydWU7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogMH0pOwogICAgICAgICAgICB9YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cyA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIAogICAgICAgICAgICB0YWdzLmxhYmVsID0gImluY2x1ZGUgbmV3ICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXI7CgogICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gdGhhdC5hYjsKCiAgICAgICAgICAgIGlmKCFsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHB1YmxpYyBidXR0b24KaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSAKewogICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gZmFsc2U7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgICAgICBsYWJlbDogImlzUHVibGljIiwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgICAgICBwdWJsaWNTdGF0ZTogZmFsc2UsCiAgICAgICAgb25DbGljazogYEAgaWYodGFncy5wdWJsaWNTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSB0cnVlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSB2ZXJzaW9uIHNlbGVjdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgbGFiZWw6ICd2ZXJzaW9uRmxhZz1jdXJyZW50JywKICAgIGZvcm1BZGRyZXNzOiAnYWx0X3JvdXRlJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBzaG91dCgnc2hvd1ZlcnNpb25TZWxlY3RvcicpO2AsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAndmVyc2lvbkZsYWc9JyArIHRoYXQ7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICBgLAp9KTsKCi8vIEN1cnJlbnQgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnY3VycmVudCcsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gRmVlZGJhY2sgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnZmVlZGJhY2snLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnZmVlZGJhY2snOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIFN0YWJsZSBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdzdGFibGUnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTIsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnc3RhYmxlJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBDcmVhdGUgcHVibGlzaCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDQsCiAgICBmb3JtQWRkcmVzczogImVnZyIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCA4cHggOHB4IiwKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1ib3R0b20tc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybTogImlucHV0IiwKICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgIG9uSW5wdXRUeXBpbmc6IGBAIGxpbmtzLmxhYmVsQm90LnRhZ3MubGFiZWwgPSAncHVibGlzaCBwYXR0ZXJuIGFzICcgKyB0aGF0LnRleHQgKyAnICgnICsgbGlua3MubGFiZWxCb3QudGFncy50b3RhbEJvdHMgKyAnIGJvdCcgKyAobGlua3MubGFiZWxCb3QudGFncy50b3RhbEJvdHMgPT0gMSA/ICcpJyA6ICdzKScpO2AsCiAgICBtZW51SXRlbVNob3dTdWJtaXRXaGVuRW1wdHk6IHRydWUsCiAgICB0YXJnZXRCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgIG1lbnVJdGVtVGV4dDogYmFzZUFCLAogICAgb25TdWJtaXQ6IGBACiAgICAgICAgICAgIGlmICh0aGF0LnRleHQgPT0gbnVsbCAmJiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhhdC50ZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgIGNvbnN0IGNvbmZpcm1QdXNoID0gYXdhaXQgb3Muc2hvd0NvbmZpcm0oewogICAgICAgICAgICAgICAgdGl0bGU6ICJjb25maXJtIHB1Ymxpc2giLAogICAgICAgICAgICAgICAgY29udGVudDogInB1Ymxpc2ggIiArIHRoYXQudGV4dCArICIgdG8gIiArIHRhcmdldFN0dWRpbyArICI/IiwKICAgICAgICAgICAgICAgIGNvbmZpcm1UZXh0OiAicHVibGlzaCIsCiAgICAgICAgICAgICAgICBjYW5jZWxUZXh0OiAiY2FuY2VsIgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICghY29uZmlybVB1c2gpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoYXQudGV4dCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYlB1Ymxpc2hBQih7IGFiOiB0aGF0LnRleHQsIGJvdDogbGlua3MudGFyZ2V0Qm90LCBiYXNlQUI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBtYW51YWxQdWJsaXNoOiB0cnVlLCBzb3VyY2VFdmVudDogJ3N0b3JlX21lbnUnIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3MudG9hc3QoImFiIG5vdCBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgfQogICAgICAgIGAsCiAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCAKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IHRoYXQuYWI7CiAgICB9YAp9KTsKCmlmIChsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKSAKewogICAgLy8gQ3JlYXRlIGNvcHkgdG8gY2xpcGJvYXJkIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogOCwKICAgICAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLAogICAgICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICAgICAgfWAsCiAgICAgICAgbGFiZWw6ICJjb3B5IHRvIGNsaXBib2FyZCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJmaWxlX2NvcHkiLAogICAgICAgIHRhcmdldEJvdDogbGlua3MucmVtZW1iZXIudGFncy5hYkJvdEZvY3VzLAogICAgICAgIG9uQ2xpY2s6IGBAIGxldCBzZWxlY3RlZEJvdCA9IGxpbmtzLnRhcmdldEJvdDsKICAgICAgICAgICAgbGV0IHByZXBwZWRCb3QgPSBKU09OLnN0cmluZ2lmeShzZWxlY3RlZEJvdCk7CiAgICAgICAgICAgIGxldCBzdGF0ZSA9IHt9CgogICAgICAgICAgICBzdGF0ZVthYkluc3RNZW1vcnkudGFncy5hYkZvY3VzRGF0YV0gPSBzZWxlY3RlZEJvdDsKCiAgICAgICAgICAgIGxldCBuZXdGaWxlID0ge30KICAgICAgICAgICAgbmV3RmlsZS52ZXJzaW9uID0gMTsKICAgICAgICAgICAgbmV3RmlsZS5zdGF0ZSA9IHN0YXRlOwoKICAgICAgICAgICAgdmFyIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShuZXdGaWxlKTsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGZvcm1hdHRlZEZpbGUpOwoKICAgICAgICAgICAgb3MudG9hc3QoImJvdCBjb3BpZWQgdG8gY2xpcGJvYXJkIik7CgogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwogICAgICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKICAgICAgICBgLAogICAgfSk7Cn0KZWxzZSAKewogICAgLy8gQ3JlYXRlIHNjYW4gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxMCwKICAgICAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7ICAgICAgICAgICAgCiAgICAgICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLAogICAgICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICAgICAgfWAsCiAgICAgICAgbGFiZWw6ICJzY2FuIHRvIHB1Ymxpc2giLAogICAgICAgIGZvcm1BZGRyZXNzOiAicXJfY29kZV9zY2FubmVyIiwKICAgICAgICBvbkNsaWNrOiBgQCBjb25maWdCb3QudGFncy5wdWJsaXNoU2NhbiA9IHRydWU7IG9zLm9wZW5RUkNvZGVTY2FubmVyKCk7YCwKICAgIH0pOwp9CgpsZXQgaG9zdEJ1dHRvbiA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVNvcnRPcmRlcjogNTAsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBmb3JtQWRkcmVzczogImdyb3VwX2FkZCIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIGxlYXJuOiB0YWdzLmxlYXJuLAogICAgb25DbGljazogYEAgbGlua3MubGVhcm4uYWJDcmVhdGVIb3N0KHRoaXNCb3QpOwogICAgaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkKICAgIHsKICAgICAgICB0YWdzLmxhYmVsID0gJ2dlbmVyYXRpbmcgY29kZSBub3cnOwogICAgfWAsCn07CgppZiAobGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpIAp7CiAgICBob3N0QnV0dG9uLmxhYmVsID0gImpvaW4gY29kZTogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElELnN1YnN0cmluZygwLCAzKSArICItIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElELnN1YnN0cmluZygzKTsKfQplbHNlIAp7CiAgICBob3N0QnV0dG9uLmxhYmVsID0gImdlbmVyYXRlIGpvaW4gY29kZSI7Cn0KCmlmIChjb25maWdCb3QudGFncy5zdGF0aWNJbnN0ID09IHVuZGVmaW5lZCkKewogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oaG9zdEJ1dHRvbik7Ly9nZW5lcmF0ZSBhIGhvc3QgYnV0dG9uCn0nAMqs44AJqfABDmFiQ29yZU1lbnVJY29uAgQAyqzjgAmglQMJaW9zX3NoYXJlJwDKrOOACanwAQ9hYkNvcmVNZW51TGFiZWwCBADKrOOACaqVAwVzaGFyZScAyqzjgAmp8AETYWJDb3JlTWVudVNvcnRPcmRlcgIEAMqs44AJsJUDATMnAMqs44AJqfABCHJlbWVtYmVyAgQAyqzjgAmylQMo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAyqzjgAmp8AELYWJQdWJsaXNoQUICBADKrOOACdmVA/M0QGlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZzogInBhdHRlcm4gbmFtZXMgbWF5IG5vdCBjb250YWluIHNwYWNlcyBvciBxdW90YWlvbiBtYXJrcywgcGxlYXNlIHRyeSBhZ2Fpbi4iLCBsb2dUeXBlOiAiZXJyb3IiIH0pOwogICAgcmV0dXJuOwp9CgpsaW5rcy51dGlscy5hYkxvZyhgcHVibGlzaGluZyAke3RoYXQuYWJ9YCk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKLy9jbGVhciBhYiBidWlsZGVyCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCi8vYWIgdmFyaWFibGVzCmNvbnN0IGFiSUQgPSB0aGF0LmFiOwpsZXQga2V5ID0gdGhhdC5rZXk7CmxldCB0YXJnZXQgPSB0aGF0LnRhcmdldCA/IHRoYXQudGFyZ2V0IDogdGhhdC5ib3Q7CmNvbnN0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nID8/IGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZzsKY29uc3QgYmFzZUFCID0gdGhhdC5iYXNlQUIgPz8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8/IChjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkKTsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaCA9IHRoYXQub25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaDsgLy8gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBwcmVwcm9jZXNzIHRoZSBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuIChvcHRpb25hbCkKY29uc3QgbWFudWFsUHVibGlzaCA9IHRoYXQubWFudWFsUHVibGlzaDsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0LnNvdXJjZUV2ZW50OyAvLyBzb3VyY2VFdmVudCBpcyBhbiBldmVudCBuYW1lIHRoYXQgc3ltYm9saXplcyB3aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwuIChvcHRpb25hbCkKY29uc3Qgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CgpsZXQgYnVzeUluZGljYXRvcjsKaWYgKG1hbnVhbFB1Ymxpc2ggJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkgewogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQogICAgCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHVwbG9hZGluZyAke3RoYXQuYWJ9YCwgb25EZXN0cm95OiBgQGNvbnNvbGUubG9nKCdidXN5IGluZGljYXRvciBnbyBib29tJylgfSk7Cn0KCmlmICghdGFyZ2V0IHx8IHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkICYmIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIpIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSAmJiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gYWJJRCk7CgogICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CiAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgJiYgZ2V0Qm90KCJhYklET3JpZ2luIiwgYmFzZUFCKSkgewogICAgICAgIGNvbnN0IGVnZ0JvdHMgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSAmJiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQik7CiAgICAgICAgY29uc3QgbmV3Qm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09IG51bGwpOwoKICAgICAgICB0YXJnZXQgPSBbLi4uZWdnQm90cywgLi4ubmV3Qm90c107CiAgICB9IGVsc2UgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKICAgIH0KCiAgICBzZXRUYWcodGFyZ2V0LCAiYWJJRE9yaWdpbiIsIGFiSUQpOwoKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgPSBudWxsOwoKICAgIGlmICh0YXJnZXQubGVuZ3RoIDwgMSkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoIm5vIGJvdHMgZm91bmQgdG8gcHVibGlzaCIpOwoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL3RoaXMgbG9naWMgaGFuZGxlcyBnZW5lcmF0aW5nIGEga2V5IGZvciBlbmNyeXB0aW9uIChvcHRpb25hbCkKaWYgKGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24pIHsKICAgIGxldCBrZXlDaGVjazsKCiAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKCiAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoIiIsIHsKICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICB0aXRsZTogJ2VudGVyIGEgc2VjcmV0IGtleScKICAgIH0pOwoKICAgIGlmIChrZXkpIHsKICAgICAgICBrZXlDaGVjayA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdjb25maXJtIHNlY3JldCBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKGtleSAhPSBrZXlDaGVjaykgewogICAgICAgIGlmICgha2V5Q2hlY2spIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgibm8ga2V5IGVudGVyZWQiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJrZXlzIGRvIG5vdCBtYXRjaCIpOwogICAgICAgIH0KCiAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy9mb3JtYXR0aW5nIGJvdHMgZm9yIGZpbGUgc3RvcmFnZQppZiAoQXJyYXkuaXNBcnJheSh0YXJnZXQpKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgewogICAgICAgIGxldCBjdXJyZW50Qm90SUQgPSB0YXJnZXRbaV0uaWQ7CiAgICAgICAgbGV0IGN1cnJlbnRCb3REYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0YXJnZXRbaV0pKTsKCiAgICAgICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwogICAgfQp9CmVsc2UgewogICAgc3RhdGVbdGFyZ2V0LmlkXSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGFyZ2V0KSk7Cn0KCi8vY2hlY2tzIGZvciBwcmV2aW91cyBlZ2dzIGFuZCByZXR1cm5zIGRhdGEgZm9yIHByZXZpb3VzbHkgcHVibGlzaGVkIGFiJ3MKbGV0IGVnZ0NoZWNrID0gYXdhaXQgdGhpc0JvdC5hYlByZXZpb3VzRWdnQ2hlY2soeyBhYklEOiBhYklEIH0pOwoKLy9hZGQgeHAgYm90IGhlcmUKc3RhdGUuYWJYUEJvdCA9IHsKICAgIHNwYWNlOiAic2hhcmVkIiwKICAgIGlkOiAiYWJYUEJvdCIsCiAgICB0YWdzOiB7CiAgICAgICAgZm9ybTogIm5vdGhpbmciLAogICAgICAgIHN5c3RlbTogImFiLnBhdHRlcm4uYWJYUEJvdCIsCiAgICAgICAgYXV0aG9ySUQ6IGF1dGhCb3QuaWQsCiAgICAgICAgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uLAogICAgICAgIHhwOiBsaW5rcy5sZWFybi50YWdzLmFiWFAsCiAgICAgICAgc2lnbmF0dXJlOiBlZ2dDaGVjay5zaWduYXR1cmUsCiAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICB9Cn07CgovLyBEbyBhbm90aGVyIHByZXByb2Nlc3NpbmcgcGFzcyB0aGF0IGFsbG93cyBsaXN0ZW5lcnMgdG8gcHJlcHJvY2VzcyB0aGUgYWIgZGF0YSBiZWZvcmUgaXQgaXMgcHVibGlzaGVkLgpsZXQgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YTogc3RhdGUsIGFiOiBhYklELCBzdHVkaW8sIHB1YmxpY0ZhY2luZywgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoKHByZXByb2Nlc3NBcmcpCn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVQdWJsaXNoJywgcHJlcHJvY2Vzc0FyZykpOwoKLy9hZGRpdGlvbmFsIGZpbGUgZGF0YQpmb3JtYXR0ZWRGaWxlLnZlcnNpb24gPSAxOwpmb3JtYXR0ZWRGaWxlLnNpZ25hdHVyZSA9IGVnZ0NoZWNrLnNpZ25hdHVyZTsKZm9ybWF0dGVkRmlsZS5zdGF0ZSA9IHN0YXRlOwoKLy9hY3R1YWwgZW5jcnlwdGlvbiBpZiBjaG9zZW4KaWYgKGtleSkgewogICAgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KGZvcm1hdHRlZEZpbGUpOwogICAgZm9ybWF0dGVkRmlsZSA9IGNyeXB0by5lbmNyeXB0KGtleSwgZm9ybWF0dGVkRmlsZSk7Cn0KCi8vcHVibGlzaCB0aGUgZmlsZQpsZXQgcHVibGlzaEZpbGUgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaEZpbGUoeyBmaWxlOiBmb3JtYXR0ZWRGaWxlLCBmaWxlTmFtZTogYWJJRCB9KTsKCi8vZ2F0aGVyIGFkZGlvbmFsIGVnZyBkYXRhCmNvbnN0IGFpUGVybWl0Q2hlY2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhaV9wZXJtaXQiKTsKY29uc3QgYWlQZXJtaXRJRCA9IGFpUGVybWl0Q2hlY2suc3VjY2VzcyA/IGFpUGVybWl0Q2hlY2suZGF0YS5wZXJtaXRJRCA6IGZhbHNlOwoKZWdnQ2hlY2suZWdnRGF0YS5haVBlcm1pdCA9IGFpUGVybWl0SUQ7CmVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkucHVzaChwdWJsaXNoRmlsZS51cmwpOwplZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKZWdnQ2hlY2suZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CgovL3B1Ymxpc2ggZWdnL2FiIHJlY29yZApsZXQgcHVibGlzaFJlY29yZCA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoUmVjb3JkKHsgZGF0YTogZWdnQ2hlY2suZWdnRGF0YSwgcmVjb3JkTmFtZTogYWJJRCwgcHVibGljRmFjaW5nOiBwdWJsaWNGYWNpbmcgfSk7CmxldCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKCi8vcHVibGlzaGluZyBzaG91dApzdXBlclNob3V0KCJvbkFCUHVibGlzaGVkIiwgeyBzdWNjZXNzOiBwdWJsaXNoRmlsZS5zdWNjZXNzLCBhYjogYWJJRCwgZmlsZUFkZHJlc3M6IHB1Ymxpc2hGaWxlLnVybCB9KTsKc3VwZXJTaG91dCgib25BYlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7IC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoKLy9zZW5kIGRhdGEgYW5kIGZvcm1hdCB1cmwgaWYgZGF0YSBzdWNjZXNzZnVsbHkgc2VudAppZiAocHVibGlzaFJlY29yZC5zdWNjZXNzKSB7CiAgICBjb25zdCBiaW9zID0gcHVibGljRmFjaW5nID8gImZyZWUiIDogImxvY2FsIjsKICAgIGNvbnN0IGluc3RUeXBlID0gcHVibGljRmFjaW5nID8gImZyZWUiIDogImxvY2FsIjsKCiAgICBzZXRUYWdNYXNrKGxpbmtzLmxlYXJuLCAiYWJYUCIsICIwIiwgImxvY2FsIik7CgogICAgaWYgKG1hbnVhbFB1Ymxpc2gpIHsKICAgICAgICBjb25zdCB1cmwgPSBzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICImc3R1ZGlvPSIgKyBzdHVkaW8gKyAiJmJpb3M9IiArIGJpb3M7CiAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKHVybCk7CgogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgd2l0aCBlbmNyeXB0ZWQgZGF0YSBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9CiAgICB9CgogICAgdHJ5IHsKICAgICAgICBhd2FpdCBhbmFseXRpY3MucmVjb3JkRXZlbnQoJ2FiX2VnZ19wdWJsaXNoJywgeyBhYjogYWJJRCwgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICB9Cn0KZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiAncHVibGlzaGluZyBmYWlsZWQnLAogICAgICAgIGxvZ1R5cGU6ICdlcnJvcicsCiAgICAgICAgdG9hc3Q6ICFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUKICAgIH0pCgogICAgY29uc29sZS5lcnJvcihgZmFpbGVkIHB1Ymxpc2ggcmVjb3JkOmAsIHB1Ymxpc2hSZWNvcmQpOwp9CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIHB1Ymxpc2hSZWNvcmQ7JwDKrOOACanwAQhhYklnbm9yZQIEAMqs44AJzcoDBHRydWUnAMqs44AJqfABCmFiRG93bmxvYWQCBADKrOOACdLKA4EUQGNvbnN0IHBvc3NpYmxlQm90cyA9IHRoYXQ/LnBvc3NpYmxlQm90czsKbGV0IGZpbGVuYW1lID0gdGhhdD8uZmlsZW5hbWU7CmxldCBzb3VyY2VFdmVudCA9IHRoYXQ/LnNvdXJjZUV2ZW50OwpsZXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQgPSB0aGF0Py5vblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZDsKbGV0IGxvZyA9IHRoYXQ/LmxvZyA/PyB0cnVlOwpsZXQgcmVvcGVuQWJNZW51ID0gdGhhdD8ucmVvcGVuQWJNZW51ID8/IHRydWU7CgpsZXQgZG93bmxvYWRCb3RzOwoKY29uc3Qgc2hvdWxkRG93bmxvYWRJbnN0ID0gIXBvc3NpYmxlQm90cyB8fCAoQXJyYXkuaXNBcnJheShwb3NzaWJsZUJvdHMpICYmIHBvc3NpYmxlQm90cy5sZW5ndGggPT09IDApOwoKaWYgKHNob3VsZERvd25sb2FkSW5zdCkgewogICAgLy8gRG93bmxvYWQgaW5zdC4KICAgIGRvd25sb2FkQm90cyA9IGdldEJvdHMoYiA9PiAhYi50YWdzLmFiSWdub3JlICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsKCiAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgLy8gR2VuZXJhdGUgYSBmaWxlbmFtZSBpZiBvbmUgaXMgbm90IGdpdmVuLgogICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICB9CgogICAgaWYgKGxvZykgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKCdkb3dubG9hZCBpbnN0Jyk7CiAgICB9Cn0gZWxzZSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShwb3NzaWJsZUJvdHMpKSB7CiAgICAgICAgLy8gRG93bmxvYWQgYm90cy4KICAgICAgICBkb3dubG9hZEJvdHMgPSBwb3NzaWJsZUJvdHM7CiAgICAgICAgY29uc3QgYm90SWRzID0gcG9zc2libGVCb3RzLm1hcChiID0+IGIuaWQpLnNvcnQoKTsKICAgICAgICBsZXQgYm90SWRzU0hBMSA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIGJvdElkcyk7CgogICAgICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAgICAgLy8gR2VuZXJhdGUgYSBmaWxlbmFtZSBpZiBvbmUgaXMgbm90IGdpdmVuLgogICAgICAgICAgICBmaWxlbmFtZSA9IGAke29zLmdldEN1cnJlbnRJbnN0KCl9XyR7Ym90SWRzU0hBMS5zdWJzdHJpbmcoMCwgNyl9XyR7bGlua3MudXRpbHMuYWJGaWxlVGltZWNvZGUoKX1gOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxvZykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZyhgZG93bmxvYWQgJHtkb3dubG9hZEJvdHMubGVuZ3RofSBib3RzYCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICAvLyBEb3dubG9hZCBib3QuCiAgICAgICAgZG93bmxvYWRCb3RzID0gW3Bvc3NpYmxlQm90c107CgogICAgICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAgICAgLy8gR2VuZXJhdGUgYSBmaWxlbmFtZSBpZiBvbmUgaXMgbm90IGdpdmVuLgogICAgICAgICAgICBmaWxlbmFtZSA9IGAke29zLmdldEN1cnJlbnRJbnN0KCl9XyR7cG9zc2libGVCb3RzLmlkLnN1YnN0cmluZygwLCA3KX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9nKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKCdkb3dubG9hZCBib3QnKTsKICAgICAgICB9CiAgICB9Cn0KCmlmICghQXJyYXkuaXNBcnJheShkb3dubG9hZEJvdHMpKSB7CiAgICBkb3dubG9hZEJvdHMgPSBbZG93bmxvYWRCb3RzXTsKfQoKY29uc3Qgc3RhdGUgPSB7fTsKCi8vIEZvcm1hdCBib3RzIGZvciBmaWxlIHN0b3JhZ2UKZm9yIChsZXQgaSA9IDA7IGkgPCBkb3dubG9hZEJvdHMubGVuZ3RoOyBpKyspIHsKICAgIGxldCBjdXJyZW50Qm90SUQgPSBkb3dubG9hZEJvdHNbaV0uaWQ7CiAgICBsZXQgY3VycmVudEJvdERhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGRvd25sb2FkQm90c1tpXSkpOwoKICAgIHN0YXRlW2N1cnJlbnRCb3RJRF0gPSBjdXJyZW50Qm90RGF0YTsKfQoKaWYgKCFmaWxlbmFtZS5lbmRzV2l0aCgnLmF1eCcpKSB7CiAgICBmaWxlbmFtZSArPSAnLmF1eCc7Cn0KCi8vIERvIGEgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgaXQgaXMgcHVibGlzaGVkLgpjb25zdCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhOiBzdGF0ZSwgZmlsZW5hbWUsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkKHByZXByb2Nlc3NBcmcpOwp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQnLCBwcmVwcm9jZXNzQXJnKSk7CgovLyBEb3dubG9hZCBhcyB2MSBhdXggZmlsZS4KY29uc3QgYXV4RmlsZSA9IHsgdmVyc2lvbjogMSwgc3RhdGUgfTsKb3MuZG93bmxvYWQoYXV4RmlsZSwgZmlsZW5hbWUsICdhcHBsaWNhdGlvbi9qc29uJyk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKaWYgKHJlb3BlbkFiTWVudSkgewogICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7Cn0nAMqs44AJqfABDW1hbmlmZXN0YXRpb24CBADKrOOACdTeAyjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDKrOOACanwAQRtZW51AgQAyqzjgAn73gMo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAyqzjgAmp8AESYWJQcmV2aW91c0VnZ0NoZWNrAgQAyqzjgAmi3wOxD0AvL3RoaXMgZnVuY3Rpb24gY2hlY2tzIGZvciBwcmV2aW91cyBlZ2dzIGF0IGEgc3BlY2lmaWVkIGFiLCByZXR1cm5pbmcgYW55IGRhdGEgdGhhdCBpdCBmaW5kcwpjb25zdCBhYklEID0gdGhhdC5hYklEOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBlZ2dIaXN0b3J5OwpsZXQgZWdnSUQ7CmxldCB0YXJnZXRWZXJzaW9uTnVtOwpsZXQgbGFzdEhhc2g7CmxldCBtYXhWZXJzaW9uTnVtOwpsZXQgc3RhYmxlVmVyc2lvbjsKbGV0IGZlZWRiYWNrVmVyc2lvbjsKbGV0IHByZXZpb3VzWFA7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmxldCByZWNvcmRMb29rdXAgPSBhd2FpdCBvcy5nZXREYXRhKHVzZXJSZWNvcmQsIGFiSUQpLmNhdGNoKGUgPT4ge30pOwoKaWYgKHJlY29yZExvb2t1cC5zdWNjZXNzKSAKewogICAgZWdnSGlzdG9yeSA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5OwogICAgZWdnSUQgPSByZWNvcmRMb29rdXAuZGF0YS5lZ2dJRDsKICAgIHByZXZpb3VzWFAgPSByZWNvcmRMb29rdXAuZGF0YS54cCA/PyAwOwogICAgdGFyZ2V0VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKICAgIGxhc3RIYXNoID0gZWdnSGlzdG9yeVt0YXJnZXRWZXJzaW9uTnVtIC0gMV07CiAgICBzdGFibGVWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuc3RhYmxlVmVyc2lvbjsKICAgIGZlZWRiYWNrVmVyc2lvbiA9IHJlY29yZExvb2t1cC5kYXRhLmZlZWRiYWNrVmVyc2lvbjsKICAgIG1heFZlcnNpb25OdW0gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0gCmVsc2UgCnsKICAgIGVnZ0hpc3RvcnkgPSBbXTsKICAgIGVnZ0lEID0gdXVpZCgpOwogICAgdGFyZ2V0VmVyc2lvbk51bSA9IDE7CiAgICBsYXN0SGFzaCA9ICJub25lIjsKICAgIG1heFZlcnNpb25OdW0gPSAxOwogICAgcHJldmlvdXNYUCA9IDA7Cn0KCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9PSAiZmVlZGJhY2siKSAKewogICAgZmVlZGJhY2tWZXJzaW9uID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9CmVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJzdGFibGUiKQp7CiAgICBzdGFibGVWZXJzaW9uID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9Cgpjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CgpsZXQgZWdnID0ge307CgplZ2cuZWdnVmVyc2lvbkhpc3RvcnkgPSBlZ2dIaXN0b3J5OwplZ2cuZWdnRm9ybWF0VmVyc2lvbiA9IGVnZ0lEOwplZ2cudGFyZ2V0VmVyc2lvbiA9IHRhcmdldFZlcnNpb25OdW07CmVnZy5tYXhWZXJzaW9uID0gbWF4VmVyc2lvbk51bTsKZWdnLmxhYmVsID0gInYiK3RhcmdldFZlcnNpb25OdW07CmVnZy5zdGFibGVWZXJzaW9uID0gc3RhYmxlVmVyc2lvbjsKZWdnLmZlZWRiYWNrVmVyc2lvbiA9IGZlZWRiYWNrVmVyc2lvbjsKZWdnLmFiSUQgPSBhYklEOwplZ2cueHAgPSBsaW5rcy5sZWFybi50YWdzLmFiWFA7CgpsZXQgc2lnbmF0dXJlID0ge307CmxldCBkYXRlID0gbmV3IERhdGUoKTsKbGV0IHRpbWUgPSBkYXRlLmdldFRpbWUoKTsKCnNpZ25hdHVyZS5wcmV2aW91c0hhc2ggPSBsYXN0SGFzaDsKc2lnbmF0dXJlLmFiVmVyc2lvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJDb3JlVmVyc2lvbjsKc2lnbmF0dXJlLmVnZ1ZlcnNpb24gPSB0YWdzLmVnZ1VVSUQ7CnNpZ25hdHVyZS5lZ2dWZXJzaW9uTnVtID0gdGFncy5vdm9WZXJzaW9uOwpzaWduYXR1cmUudGltZVN0YW1wID0gdGltZTsKc2lnbmF0dXJlLmNhc3VhbE9TVmVyc2lvbiA9IFtvcy52ZXJzaW9uKCldOwoKcmV0dXJuIHtzaWduYXR1cmU6IHNpZ25hdHVyZSwgZWdnRGF0YTogZWdnfTsnAMqs44AJqfABD2FiQm90TWVudUFjdGlvbgIEAMqs44AJ1O4DTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwDKrOOACanwAQ5hYkJvdE1lbnVMYWJlbAIEAMqs44AJou8DBXNoYXJlJwDKrOOACanwAQ1hYkJvdE1lbnVJY29uAgQAyqzjgAmo7wMJaW9zX3NoYXJlJwDKrOOACanwARJhYkJvdE1lbnVTb3J0T3JkZXICBADKrOOACbLvAwMzLjUnAMqs44AJqfABBWxlYXJuAgQAyqzjgAm27wMo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAyqzjgAmp8AELYWJRUlB1Ymxpc2gCBADKrOOACd3vA+EBQGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gbnVsbDsKCmxldCBzY2FubmVkVVJMOwoKdHJ5IAp7CiAgICBzY2FubmVkVVJMID0gbmV3IFVSTCh0aGF0KTsKfQpjYXRjaCAoZSkgCnsKICAgIHNob3V0KCJhYlB1Ymxpc2hBQiIsIHthYjogdGhhdCwgc291cmNlRXZlbnQ6ICdxcl9wdWJsaXNoJ30pOwoKICAgIHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiB0aGF0fSk7CgogICAgcmV0dXJuOwp9JwDKrOOACanwAQZzZWFyY2gCBADKrOOACb/xAyjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwDKrOOACanwAQdhYlNoZWxsAgQAyqzjgAnm8QMEdHJ1ZScAyqzjgAmp8AEMc3R1ZGlvU2VsZWN0AgQAyqzjgAnr8QOLC0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlN0dWRpb01lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBzdHVkaW9zID0gdGhhdC5zdHVkaW9zOwpjb25zdCB0YXJnZXRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKY29uc3QgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5hYlN0dWRpb01lbnUgPSB0cnVlOwptZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlN0dWRpb01lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmxhYmVsID0gInBsYXllciBzdHVkaW8iOwptZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0U3R1ZGlvID09IGF1dGhCb3QuaWQgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKbWVudUJ1dHRvbi5zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cm1lbnVCdXR0b24ub25DbGljayA9IGBAIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gdGFncy5zdHVkaW9JRDsKCmxpbmtzLm1hbmFnZXIubGlua3Muc3R1ZGlvU2VsZWN0QnV0dG9uLnRhZ3MubGFiZWwgPSB0YWdzLmxhYmVsOwoKc2hvdXQoImFiU3R1ZGlvTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7YDsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBzdHVkaW9zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlU3R1ZGlvID0gc3R1ZGlvc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0U3R1ZGlvID09IGFjdGl2ZVN0dWRpby5zdHVkaW9JZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gYWN0aXZlU3R1ZGlvLmRpc3BsYXlOYW1lOwogICAgbWVudUJ1dHRvbi5zdHVkaW9JRCA9IGFjdGl2ZVN0dWRpby5zdHVkaW9JZDsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKfScAyqzjgAmp8AEOYWJQdWJsaXNoQXNrSUQCBADKrOOACfX8A9sFQGlmICghbGlua3MubWVudSkgewogICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKfQoKbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHB1Ymxpc2hpbmcgJHt0aGF0LmFza0lEfWB9KTsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7Cgpjb25zdCBwYXR0ZXJuSUQgPSB0aGF0LnBhdHRlcm5JRDsKY29uc3Qgc3R1ZGlvSUQgPSB0aGF0LnN0dWRpb0lEID8gdGhhdC5zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBhdXRoQm90LmlkOwpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQucmVwbGFjZUFsbCgiLSIsICIiKTsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmNvbnN0IHB1Ymxpc2hBc2sgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFza0lELCB7cGF0dGVybklEOiBwYXR0ZXJuSUQsIHN0dWRpb0lEOiBzdHVkaW9JRH0sIHtlbmRwb2ludDogZW5kcG9pbnQsIHVwZGF0ZVBvbGljeTogW2F1dGhCb3QuaWRdfSk7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gcHVibGlzaEFzazsnAMqs44AJqfABBWlucHV0AgQAyqzjgAnRggQo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAyqzjgAmp8AELYWJFbWJlZExpbmsCBADKrOOACfiCBKQDQGNvbnN0IGFiID0gdGhhdCA/IHRydWUgOiBmYWxzZTsKY29uc3QgZW1iZWRMaW5rID0gYWIgPyAiYWI9IiArIHRoYXQgOiAiaW5zdD0iICsgY29uZmlnQm90LnRhZ3MuaW5zdDsKY29uc3Qgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CmNvbnN0IGVtYmVkVGV4dCA9IGA8IURPQ1RZUEUgaHRtbD4KwqDCoMKgwqA8aHRtbD4KwqDCoMKgwqDCoMKgwqDCoDxoZWFkPjwvaGVhZD4KwqDCoMKgwqDCoMKgwqDCoDxib2R5PgrCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqA8aWZyYW1lIHNyYz0iJHtzaXRlT3JpZ2luICsgIi8/IiArIGVtYmVkTGlua30iIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjQwMCIgLz4KwqDCoMKgwqDCoMKgwqDCoDwvYm9keT4KwqDCoMKgwqA8L2h0bWw+YDsKCnJldHVybiBlbWJlZFRleHQ7JwDKrOOACanwAQ9hYlBhdHRlcm5VcGRhdGUCBADKrOOACfGFBKUFQC8vc2hvdXQoImFiUGF0dGVyblVwZGF0ZSIsIHthYklEOiBhYklELCBzdHVkaW86c3R1ZGlvPywgYm90czogYm90cz99KTsKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghYXV0aEJvdCkKewogICAgcmV0dXJuOwp9Cgpjb25zdCBhYklEID0gdGhhdC5hYklEOwpjb25zdCBzdHVkaW8gPSB0aGF0LnN0dWRpbyA/IHRoYXQuc3R1ZGlvIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKY29uc3QgYWJNYW5pZmVzdCA9IGdldEJvdChieU1vZCh7YWJFZ2c6IHRydWUsIG9yaWdpbl9hYjogYWJJRH0pKTsKCmlmICghYWJNYW5pZmVzdCkKewogICAgc2hvdXQoIm9uTG9va3VwQUJFZ2dzIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBhdXRvSGF0Y2g6IHRydWUsIHNvdXJjZUV2ZW50OiAncGF0dGVybl91cGRhdGUnfSk7CgogICAgcmV0dXJuOwp9Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHN0dWRpbzsKCmNvbnN0IGFiQm90cyA9IHRoYXQuYm90cyA/PyBnZXRCb3RzKCJhYklET3JpZ2luIiwgYWJJRCk7Cgphd2FpdCB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogYWJJRCwgdGFyZ2V0OiBhYkJvdHMsIHB1YmxpY0ZhY2luZzogdHJ1ZSwgc291cmNlRXZlbnQ6ICdwYXR0ZXJuX3VwZGF0ZSd9KTsnAMqs44AJqfABF2FiTXVsdGlwbGVCb3RNZW51QWN0aW9uAgQAyqzjgAmXiwRNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAMqs44AJqfABGmFiTXVsdGlwbGVCb3RNZW51U29ydE9yZGVyAgQAyqzjgAnliwQBMicAyqzjgAmp8AEVYWJNdWx0aXBsZUJvdE1lbnVJY29uAgQAyqzjgAnniwQJaW9zX3NoYXJlJwDKrOOACanwARZhYk11bHRpcGxlQm90TWVudUxhYmVsAgQAyqzjgAnxiwQFc2hhcmUnAMqs44AJqfABD2FiUHVibGlzaFNlbGVjdAIEAMqs44AJ94sEqhNALy9zaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJQYXR0ZXJuTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IGFsbEJvdHMgPSBnZXRCb3RzKCJhYklET3JpZ2luIik7CmNvbnN0IGFsbFBhdHRlcm5zID0gWyJuZXcgcGF0dGVybiJdOwoKYm90TG9vcDoKZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxCb3RzLmxlbmd0aDsgaSsrKQp7CiAgICBjb25zdCBhY3RpdmVCb3QgPSBhbGxCb3RzW2ldOwoKICAgIGlmIChhY3RpdmVCb3QudGFncy5hYklnbm9yZSkKICAgIHsKICAgICAgICBjb250aW51ZSBib3RMb29wOwogICAgfQoKICAgIGNvbnN0IHBvc3NpYmxlUGF0dGVybiA9IGFjdGl2ZUJvdC50YWdzLmFiSURPcmlnaW47CgogICAgZm9yIChsZXQgaiA9IDA7IGogPCBhbGxQYXR0ZXJucy5sZW5ndGg7IGorKykKICAgIHsKICAgICAgICBjb25zdCBhY3RpdmVQYXR0ZXJuID0gYWxsUGF0dGVybnNbal07CgogICAgICAgIGlmIChhY3RpdmVQYXR0ZXJuID09IHBvc3NpYmxlUGF0dGVybiApCiAgICAgICAgewogICAgICAgICAgICBjb250aW51ZSBib3RMb29wOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChqID09IGFsbFBhdHRlcm5zLmxlbmd0aCAtIDEpCiAgICAgICAgewogICAgICAgICAgICBhbGxQYXR0ZXJucy5wdXNoKHBvc3NpYmxlUGF0dGVybik7CiAgICAgICAgfQogICAgfQp9Cgpjb25zdCB0YXJnZXRBQiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiUGF0dGVybk1lbnUgPSB0cnVlOwptZW51QnV0dG9uLmFiUGF0dGVybk1lbnVTb3J0T3JkZXIgPSAwOwptZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnJlbWVtYmVyID0gdGFncy5yZW1lbWJlcjsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEBjb25zdCB0b3RhbFBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSB0YWdzLmxhYmVsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwpjb25zdCBub25QYXR0ZXJuQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKc2hvdXQoImFiU2VsZWN0VGl0bGVVcGRhdGUiLCB7YWI6IHRhZ3MubGFiZWwsIGFiQm90czogdG90YWxQYXR0ZXJuQm90cy5sZW5ndGgsIG5vbkFCQm90czogbm9uUGF0dGVybkJvdHMubGVuZ3RofSk7CgpsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSB0YWdzLmxhYmVsID09ICJuZXcgcGF0dGVybiIgPyBudWxsIDogdGFncy5sYWJlbDsKCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgPSB0YWdzLmxhYmVsID09ICJuZXcgcGF0dGVybiIgPyBudWxsIDogdGFncy5sYWJlbDsKCnNob3V0KCJhYlBhdHRlcm5NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKYWxsUGF0dGVybnMuc29ydCgpOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxQYXR0ZXJucy5sZW5ndGg7IGkrKykKewogICAgbGV0IGFjdGl2ZVBhdHRlcm5OYW1lID0gYWxsUGF0dGVybnNbaV07CgogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldEFCID09IGFjdGl2ZVBhdHRlcm5OYW1lID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVQYXR0ZXJuTmFtZTsKCiAgICBpZiAoYWN0aXZlUGF0dGVybk5hbWUgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBtZW51QnV0dG9uLmFiUGF0dGVybk1lbnVTb3J0T3JkZXIgPSAtMTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBtZW51QnV0dG9uLmFiUGF0dGVybk1lbnVTb3J0T3JkZXIgPSBpOwogICAgfQoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9CgppZiAoIWdldEJvdChieU1vZCh7YWJQYXR0ZXJuTWVudTogdHJ1ZSwgZm9ybUFkZHJlc3M6ICJyYWRpb19idXR0b25fY2hlY2tlZCJ9KSkpCnsKICAgIGNvbnN0IG5ld0JvdCA9IGdldEJvdChieU1vZCh7YWJQYXR0ZXJuTWVudTogdHJ1ZSwgbGFiZWw6ICJuZXcgcGF0dGVybiJ9KSk7CiAgICAKICAgIG5ld0JvdC50YWdzLmZvcm1BZGRyZXNzID0gInJhZGlvX2J1dHRvbl9jaGVja2VkIjsKfScAyqzjgAmp8AEJYWJWZXJzaW9uAgQAyqzjgAmgnwQEMTAuNicAyqzjgAmp8AELcGVyc29uYWxpdHkCBADKrOOACaWfBCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDKrOOACanwAQV1dGlscwIEAMqs44AJzJ8EKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAQRib3RzJDc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNwEnAMqs44AJ858EFWFiRmluZEFydGlmYWN0QnVuZGxlcwIEAMqs44AJ9J8EkwZAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9OwoKY29uc3QgYXJ0aWZhY3RCdW5kbGVzOiBSZWNvcmQ8c3RyaW5nLCBBQkFydGlmYWN0QnVuZGxlPiA9IHt9OyAvLyBLZXkgaXMgYXJ0aWZhY3QgaWQKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGUpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYi50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQgJiYgYWJBcnRpZmFjdEluc3RhbmNlSUQgIT09IGIudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBhcnRpZmFjdElkID0gYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGUuaWQ7CgogICAgICAgIGlmIChhcnRpZmFjdElkICYmICFhcnRpZmFjdEJ1bmRsZXNbYXJ0aWZhY3RJZF0pIHsKICAgICAgICAgICAgYXJ0aWZhY3RCdW5kbGVzW2FydGlmYWN0SWRdID0gYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgfQogICAgfQp9KTsKCnJldHVybiBhcnRpZmFjdEJ1bmRsZXM7JwDKrOOACfOfBAVzdG9yZQIEAMqs44AJiKYEKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAMqs44AJ858EBnN5c3RlbQIEAMqs44AJr6YEEWFiLnNoZWxsLmFydGlmYWN0JwDKrOOACfOfBAhhYklnbm9yZQIEAMqs44AJwaYEBHRydWUnAMqs44AJ858ECWFiVmVyc2lvbgIEAMqs44AJxqYEBDEwLjYnAMqs44AJ858EBWRlYnVnAgQAyqzjgAnLpgQFZmFsc2UnAMqs44AJ858ECHJlbWVtYmVyAgQAyqzjgAnRpgQo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAyqzjgAnznwQTYWJDcmVhdGVBcnRpZmFjdEJvdAIEAMqs44AJ+KYE1hJAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGRpbWVuc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJJbnN0ID8/ICdob21lJywKICAgIHBvc2l0aW9uID0gbmV3IFZlY3RvcjMoMCwgMCwgMCksCiAgICBvdGhlclRhZ3MgPSB7fSwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJvdCA9IGNyZWF0ZSh7CiAgICBzcGFjZTogJ3NoYXJlZCcsCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdEJvdDogdHJ1ZSwKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2Ake2RpbWVuc2lvbn1YYF06IHBvc2l0aW9uLngsCiAgICBbYCR7ZGltZW5zaW9ufVlgXTogcG9zaXRpb24ueSwKICAgIFtgJHtkaW1lbnNpb259WmBdOiBwb3NpdGlvbi56LAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIGxhYmVsQ29sb3I6IGFiQXJ0aWZhY3RMYWJlbENvbG9yLAogICAgc3Ryb2tlQ29sb3I6IGFiQXJ0aWZhY3RMYWJlbENvbG9yLAogICAgb25Cb3RBZGRlZDogYEAKICAgICAgICB0aGlzQm90LnVwZGF0ZUNvbXB1dGVkVGFncygpOwogICAgYCwKICAgIG9uQm90Q2hhbmdlZDogYEAKICAgICAgICBjb25zdCBjaGFuZ2VkVGFncyA9IHRoYXQudGFnczsKCiAgICAgICAgaWYgKGNoYW5nZWRUYWdzLnNvbWUodCA9PiB0ID09PSAnYWJBcnRpZmFjdEluc3RhbmNlSUQnIHx8IHQgPT09ICdhYkFydGlmYWN0TmFtZScpKSB7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlQ29tcHV0ZWRUYWdzKCk7CiAgICAgICAgfQogICAgYCwKICAgIHVwZGF0ZUNvbXB1dGVkVGFnczogYEAKICAgICAgICBsZXQgc3lzdGVtID0gJ2FiQXJ0aWZhY3RCb3QnOwoKICAgICAgICBpZiAodGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0TmFtZTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgICAgIHN5c3RlbSArPSAnLicgKyB0YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELnN1YnN0cmluZygwLCA3KTsKICAgICAgICB9CgogICAgICAgIHRhZ3Muc3lzdGVtID0gISFzeXN0ZW0gPyBzeXN0ZW0gOiBudWxsOwogICAgICAgIHRhZ3MubGFiZWwgPSB0YWdzLnN5c3RlbTsKICAgIGAsCiAgICBvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGU6IGBACiAgICAgICAgLy8gSGlkZSBhcnRpZmFjdCBib3Qgb25jZSBpdCBoYXMgYmVlbiByZWNvbnN0aXR1dGVkLgogICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2Zvcm0nLCAnbm90aGluZycsICdzaGFyZWQnKTsKICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdsYWJlbCcsICcgJywgJ3NoYXJlZCcpOwogICAgYCwKICAgIC4uLm90aGVyVGFncywKfSk7Cgp0cnkgewogICAgLy8gVXBkYXRlIGFsbCB0aGUgc2hhcmRzIGZvciB0aGlzIGFydGlmYWN0IGluc3RhbmNlIC0tIHdoaWNoIG5vdyBpbmNsdWRlcyB0aGlzIGJvdCEKICAgIGNvbnN0IHVwZGF0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCiAgICBpZiAoIXVwZGF0ZVJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gdXBkYXRlICcke2FiQXJ0aWZhY3ROYW1lfScgYXJ0aWZhY3Qgc2hhcmRzLmApOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2h0IGVycm9yIHdoaWxlIHVwZGF0ZSBhcnRpZmFjdCBzaGFyZHM6YCwgZSk7CiAgICBkZXN0cm95KGFiQXJ0aWZhY3RCb3QpOwogICAgcmV0dXJuIG51bGw7Cn0KCnJldHVybiBhYkFydGlmYWN0Qm90OycAyqzjgAnznwQWYWJBcnRpZmFjdFJlY29uc3RpdHV0ZQIEAMqs44AJz7kEriRAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmFzc2VydCh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJnIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLmApOwoKY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgYXMgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgQUJBcnRpZmFjdEJ1bmRsZS5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCB0byBiZSBvZiB0eXBlIHN0cmluZy5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmcgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKTsKY29uc3Qgc2hhcmRCb3RzID0gW107CgpmdW5jdGlvbiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKHsgYm90RGF0YSB9KSB7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkOyAvLyBJZiB0aGUgc2hhcmQgYm90IGhhcyBpdHNlbGYgbWFya2VkIGFzIHJlY29uc3RpdHV0ZWQgYWxyZWFkeSAocG9zc2libHkgZHVlIHRvIGFuIG92ZXJzaWdodCksIHRoZW4gcmVtb3ZlIGl0IQoKICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmc7IC8vIEFzc2lnbiB0aGUgYXJ0aWZhY3QgYnVuZGxlIGJhY2sgdG8gdGhlIGhhdGNoZWQgc2hhcmQgYm90LgogICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOyAvLyBVVUlEIG9mIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSB0aGF0IHRoaXMgYm90IGJlbG9uZ3MgdG8uCiAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7IC8vIFVVSUQgYXNzaWduZWQgdG8gdGhlIGJvdCBieSB0aGUgYXJ0aWZhY3Qgd2hlbiBsb2FkZWQuCiAgICB9Cn0KCmZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcykgewogICAgY29uc3QgZGVwZW5kZW5jeUJvdHMgPSBbXTsKCiAgICBpZiAodGhpc0JvdC5pc0VnZ0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICBjb25zdCBlZ2dEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeTsKICAgICAgICAKICAgICAgICAvLyBGaXJzdCB0cnkgdG8gbG9hZCBmcm9tIGVnZy4KICAgICAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgICAgICBhYklEOiBlZ2dEZXBlbmRlbmN5LmFiSUQsCiAgICAgICAgICAgIHJlY29yZEtleTogZWdnRGVwZW5kZW5jeS5yZWNvcmRLZXksCiAgICAgICAgICAgIGFiVmVyc2lvbjogZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24sCiAgICAgICAgICAgIGF1dG9IYXRjaDogdHJ1ZSwKICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUKICAgICAgICB9KQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAke2VnZ0RlcGVuZGVuY3kuYWJJRH0gbG9va3VwRWdnUmVzdWx0OmAsIGxvb2t1cEVnZ1Jlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9va3VwRWdnUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgbG9hZGVkIGRlcGVuZGVuY3kgYWJJRDogJHtlZ2dEZXBlbmRlbmN5LmFiSUR9LCBhYlZlcnNpb246ICR7ZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24gPz8gJ2xhdGVzdCd9YCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoY29uc3QgaGF0Y2hlZEJvdCBvZiBsb29rdXBFZ2dSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA9PT0gMCAmJiB0aGlzQm90LmlzQXNrRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgIGNvbnN0IGFza0RlcGVuZGVuY3kgPSBkZXBlbmRlbmN5IGFzIEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5OwoKICAgICAgICAvLyBUcnkgdG8gbG9hZCBmcm9tIGFzay4KICAgICAgICBjb25zdCBsb29rdXBBc2tSZXN1bHQ6IEFCTG9va3VwQXNrSURSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBc2tJRCh7CiAgICAgICAgICAgIGFza0lEOiBhc2tEZXBlbmRlbmN5LmFza0lELAogICAgICAgICAgICBzaG93SW5kaWNhdG9yOiBmYWxzZSwKICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQogICAgICAgIH0pCgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrUmVzdWx0OmAsIGxvb2t1cEFza1Jlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGNvbnN0IGhhdGNoZWRCb3Qgb2YgbG9va3VwQXNrUmVzdWx0LmhhdGNoZWRCb3RzKSB7CiAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChkZXBlbmRlbmN5Qm90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChjb25zdCBzaGFyZEJvdCBvZiBkZXBlbmRlbmN5Qm90cykgewogICAgICAgICAgICBzaGFyZEJvdHMucHVzaChzaGFyZEJvdCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gZmFpbGVkIHRvIGxvYWQgZGVwZW5kZW5jeTogJHtKU09OLnN0cmluZ2lmeShkZXBlbmRlbmN5KX1gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICB9Cn0KCmlmIChzaGFyZEJvdHMubGVuZ3RoID4gMCkgewogICAgLy8gVGVsbCBhbGwgaGF0Y2hlZCBzaGFyZCBib3RzIHRvIHJlY29uc3RpdHV0ZS4gVGhleSBhbGwgaGF2ZSBjb3BpZXMgb2YgdGhlIGFiQXJ0aWZhY3RCdW5kbGUgYW5kIGNhbiByZWNvbnN0aXR1dGUgdGhlbXNlbHZlcyBmcm9tIHRoYXQuCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUnLCB7IGRhdGE6IGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSB9KSk7CgogICAgZm9yIChsZXQgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7IC8vIFRoaXMgYm90IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQgaW4gdGhpcyBpbnN0LgogICAgfQoKICAgIGF3YWl0IHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICAKICAgIHNob3V0KCdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkJywgewogICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBhYkFydGlmYWN0QnVuZGxlLm5hbWUsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICBzaGFyZEJvdHMsCiAgICB9KQp9CgppZiAodG9hc3QpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZpbmlzaGVkIHJlY29uc3RpdHV0aW9uLmApCn0gZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyhgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfScgKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgZmluaXNoZWQgcmVjb25zdGl0dXRpb24uYCk7Cn0KJwDKrOOACfOfBBdhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbgIEAMqs44AJ/N0EATEnAMqs44AJ858EBnNlYXJjaAIEAMqs44AJ/t0EKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAMqs44AJ858EB2FiU2hlbGwCBADKrOOACaXeBAR0cnVlJwDKrOOACfOfBAV1dGlscwIEAMqs44AJqt4EKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAMqs44AJ858ED29uQW55Qm90Q2xpY2tlZAIEAMqs44AJ0d4EgQFAY29uc3QgeyBib3QgfSA9IHRoYXQ7CgppZiAoYm90ICYmIGJvdC50YWdzLmFiQXJ0aWZhY3RCb3QgPT09IHRydWUpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVPcGVuKHsgYWJBcnRpZmFjdEJvdDogYm90IH0pCn0nAMqs44AJ858EFmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMCBADKrOOACdPfBKMXQGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gdGhhdC5hYkFydGlmYWN0TmFtZTsKbGV0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gdGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRDsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3Qgc2hhcmRCb3RzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCmlmIChzaGFyZEJvdHMubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFRoZXJlIGFyZSBubyBzaGFyZHMgZm9yIGFydGlmYWN0IG5hbWUgJyR7YWJBcnRpZmFjdE5hbWV9Jy5gLCBsb2dUeXBlOiAnd2FybicgfSk7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CgoKY29uc3QgcHJldkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gc2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKY29uc3QgcHJldkFydGlmYWN0SUQgPSBwcmV2QXJ0aWZhY3RCdW5kbGUgPyBwcmV2QXJ0aWZhY3RCdW5kbGUuaWQgOiBudWxsOwoKbGV0IGNvbGxlY3RTaGFyZFJlc3VsdDogQUJBcnRpZmFjdENvbGxlY3RTaGFyZHNSZXN1bHQ7Cgp0cnkgewogICAgY29sbGVjdFNoYXJkUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hYkNvbGxlY3RBcnRpZmFjdFNoYXJkcyh7IHNoYXJkQm90cyB9KTsKCiAgICBpZiAoIWNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGNvbGxlY3RTaGFyZFJlc3VsdC5yZWFzb24sIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9IGNhdGNoKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFNvbWV0aGluZyB3ZW50IHdyb25nIGNvbGxlY3Rpbmcgc2hhcmRzLiBTZWUgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Cn0KCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSB0aGlzQm90LmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdFNoYXJkOiBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQgfSk7CgppZiAocHJldkFydGlmYWN0SUQgJiYgcHJldkFydGlmYWN0SUQgIT09IGFiQXJ0aWZhY3RCdW5kbGUuaWQpIHsKICAgIC8vIFRoZSBhcnRpZmFjdCBoYXMgYSBuZXcgaWQuIEFsbCBvZiB0aGUgc2hhcmQgYm90cyBuZWVkIGEgbmV3IGluc3RhbmNlIGlkIGFzIHdlbGwuCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKCiAgICBmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBhYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZpbmFsIG1lcmdlZCBhcnRpZmFjdCAke2FiQXJ0aWZhY3ROYW1lfTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKLy8gRXZlcnkgc2hhcmQgYm90IGdldHMgYSBjb3B5IG9mIHRoZSBhcnRpZmFjdCBidW5kbGUuCi8vIFRoaXMgbWFrZXMgdGhlIGFydGlmYWN0IGhvbG9ncmFwaGljIGJ5IG5hdHVyZS4gVGhpcyBtZWFucyB0aGF0IGFueSBzaGFyZCBjYW4gYmUgdXNlZCB0byByZWNvbnN0aXR1dGUgdGhlIHdob2xlLgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgLy8gTWFyayBlYWNoIHNoYXJkIGJvdCBhcyBiZWluZyAncmVjb25zdGl0dXRlZCcgd2hlbiB3ZSB1cGRhdGUgdGhlIGFydGlmYWN0LgogICAgLy8gQmVjYXVzZSB0aGlzIGlzIGEgc2hhcmVkIHRhZyBtYXNrLCBpdCB3aWxsIG9ubHkgYmUgdHJ1ZSBpbiB0aGUgY3VycmVudCBpbnN0LgogICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7CiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGUgPSAgJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIFJ5YW4gQ29vazogTmVlZCB0byBnaXZlIENhc3VhbE9TIGEgY2hhbmNlIHRvIGNhdGNodXAuCi8vIEZvdW5kIHRoYXQgaWYgd2UgZGlkbnQgZG8gdGhpcywgbW9kIHRhZ3Mgd291bGQgbm90IGJlIHJldHVybmVkIGFzIEpTT04gb2JqZWN0cyBidXQgaW5zdGVhZCB0aGUgcmF3IHN0cmluZy4KYXdhaXQgb3Muc2xlZXAoMCk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGVkIGFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScuIENvcGllZCBhcnRpZmFjdCBidW5kbGUgdG8gJHtzaGFyZEJvdHMubGVuZ3RofSBib3RzLiBhYkFydGlmYWN0QnVuZGxlOmAsIGFiQXJ0aWZhY3RCdW5kbGUpOwp9CgpzaG91dCgnb25BbnlBQkFydGlmYWN0U2hhcmRzVXBkYXRlZCcsIHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBhYkFydGlmYWN0QnVuZGxlLCBzaGFyZEJvdHMgfSkKCi8vIFNoYXJkIHVwZGF0ZSBzdWNjZXNzZnVsLgpyZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07JwDKrOOACfOfBARtZW51AgQAyqzjgAn19gQo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAyqzjgAnznwQFbGVhcm4CBADKrOOACZz3BCjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDKrOOACfOfBAtvbkdyaWRDbGljawIEAMqs44AJw/cERkBpZiAobGlua3MuYXJ0aWZhY3RNZW51Qm90cykgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7Cn0nAMqs44AJ858EGmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0AgQAyqzjgAmK+AQHI0FFQTFGRicAyqzjgAnznwQbYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0AgQAyqzjgAmS+AQHIzFlMWIyZCcAyqzjgAnznwQQb25BbnlCb3RzUmVtb3ZlZAIEAMqs44AJmvgElQFAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7CgppZiAobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkICYmIGJvdElEcy5pbmNsdWRlcyhtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQpKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfScAyqzjgAnznwQHdmVyc2lvbgIEAMqs44AJsPkEKPCflJc1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYnAMqs44AJ858EGGFiR2V0QXJ0aWZhY3ROYW1lc0luSW5zdAIEAMqs44AJ1/kErAFAY29uc3QgYWJBcnRpZmFjdE5hbWVzID0gbmV3IFNldCgpOwoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIGFiQXJ0aWZhY3ROYW1lcy5hZGQoYi50YWdzLmFiQXJ0aWZhY3ROYW1lKTsKICAgIH0KfSkKCnJldHVybiBhYkFydGlmYWN0TmFtZXM7JwDKrOOACfOfBBVhYkFydGlmYWN0Qm90TWVudU9wZW4CBADKrOOACYT7BPsVQGNvbnN0IHsgYWJBcnRpZmFjdEJvdCB9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0Qm90ICYmIGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCnNob3V0KCJhYkFydGlmYWN0Qm90TWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkFydGlmYWN0TWVudSI7CgppZiAoIXRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwp9Cgpjb25zdCBhYkFydGlmYWN0QmFzZUNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0QmFzZUNvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQ7CmNvbnN0IGFiQXJ0aWZhY3RMYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0TGFiZWxDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdDsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKCmxldCBpbmZvTGFiZWwgPSBgW2FydGlmYWN0IG5hbWVdOiAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGlkXTogJHthYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLCA3KX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGluc3RhbmNlIGlkXTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPz8gJ3Vuc2V0J30gXG5gOwppbmZvTGFiZWwgKz0gYFtyZWNvbnN0aXR1dGVkIGluIGluc3RdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkfVxuYDsKaW5mb0xhYmVsICs9IGBbZm9ybWF0XTogdiR7YWJBcnRpZmFjdEJ1bmRsZS5mb3JtYXRWZXJzaW9ufVxuYDsKaW5mb0xhYmVsICs9IGBbY3JlYXRlZCB0aW1lXTogJHtEYXRlVGltZS5mcm9tSVNPKGFiQXJ0aWZhY3RCdW5kbGUuY3JlYXRlZFRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoRGF0ZVRpbWUuREFURVRJTUVfU0hPUlRfV0lUSF9TRUNPTkRTKX1cbmA7CgovLyBIZWFkZXIKY29uc3QgaW5mb0JvdCA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51VGV4dCh7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGxhYmVsOiBpbmZvTGFiZWwsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2goaW5mb0JvdCk7CgovLyBEb3dubG9hZCBzaGFyZCBidXR0b24uCmNvbnN0IGRvd25sb2FkQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgYWJBcnRpZmFjdFRvb2w6IGdldExpbmsodGhpc0JvdCksCiAgICBmb3JtQWRkcmVzczogJ2Rvd25sb2FkJywKICAgIGxhYmVsOiBgZG93bmxvYWQgc2hhcmRgLAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGUgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9ICdhYkFydGlmYWN0LScgKyBhYkFydGlmYWN0QnVuZGxlLm5hbWUgKyAnLScgKyBhYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLDcpICsgJy5hdXgnOyAKICAgICAgICBvcy5kb3dubG9hZEJvdHMoWyBsaW5rcy5hYkFydGlmYWN0Qm90IF0sIGZpbGVuYW1lKTsKICAgICAgICAKICAgICAgICBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGRvd25sb2FkQnV0dG9uKTsKCi8vIFVwZGF0ZSBhcnRpZmFjdCBidXR0b24uCmNvbnN0IHVwZGF0ZUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdzeW5jJywKICAgIGxhYmVsOiBgdXBkYXRlIGFydGlmYWN0YCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBhYkFydGlmYWN0QnVuZGxlLm5hbWU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgCiAgICAgICAgYXdhaXQgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdEJvdE1lbnVPcGVuKHsgYWJBcnRpZmFjdEJvdDogbGlua3MuYWJBcnRpZmFjdEJvdCB9KTsKICAgIGAsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2godXBkYXRlQnV0dG9uKTsKCm1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCA9IGFiQXJ0aWZhY3RCb3QuaWQ7JwDKrOOACfOfBBlhYkRvd25sb2FkQXJ0aWZhY3RQYXR0ZXJuAgQAyqzjgAmAkQX8BEBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIHNoYXJkQm90cywKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3ROYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiRG93bmxvYWQoeyAKICAgIHBvc3NpYmxlQm90czogc2hhcmRCb3RzLAogICAgZmlsZW5hbWU6IGAke2FiQXJ0aWZhY3ROYW1lfWAsCiAgICBzb3VyY2VFdmVudDogJ2Rvd25sb2FkX2FydGlmYWN0X3BhdHRlcm4nLAogICAgcmVvcGVuQWJNZW51OiBmYWxzZSwKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkOiAoYXJnKSA9PiB7CiAgICAgICAgdGhpc0JvdC5hYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YShhcmcuYm90RGF0YSk7CiAgICB9Cn0pOycAyqzjgAnznwQWYWJBcnRpZmFjdEJvdE1lbnVSZXNldAIEAMqs44AJ/ZUF7wFAaWYgKHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzICYmIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLmxlbmd0aCA+IDApIHsKICAgIGRlc3Ryb3kodGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMpOwogICAgdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMgPSBbXTsKfQoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBudWxsOycAyqzjgAnznwQFdHlwZXMCBADKrOOACe2XBbcJ8J+ThGludGVyZmFjZSBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnIHsKICAgIGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGU7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRD86IHN0cmluZzsKICAgIHRvYXN0PzogYm9vbGVhbjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHsKICAgIGFiSUQ6IHN0cmluZzsKICAgIHJlY29yZEtleTogc3RyaW5nOwogICAgYWJWZXJzaW9uPzogbnVtYmVyOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3kgewogICAgYXNrSUQ6IHN0cmluZzsKfQoKdHlwZSBBQkFydGlmYWN0RGVwZW5kZW5jeSA9IEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHwgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgppbnRlcmZhY2UgQUJBcnRpZmFjdEJ1bmRsZSB7CiAgICBpZDogc3RyaW5nOwogICAgbmFtZTogc3RyaW5nOwogICAgZm9ybWF0VmVyc2lvbjogbnVtYmVyOwogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+OwogICAgY2FzdWFsT1NWZXJzaW9uOiBBdXhWZXJzaW9uOwogICAgY3JlYXRlZFRpbWVzdGFtcDogc3RyaW5nOwogICAgYWJTaGVsbFZlcnNpb246IHN0cmluZzsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RTaGFyZCB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+OwogICAgZGVwZW5kZW5jaWVzOiBBcnJheTxBQkFydGlmYWN0RGVwZW5kZW5jeT47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RXhwZXJpZW5jZSB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoIHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmc7CiAgICBhdXRob3JpemVkOiBib29sZWFuOwogICAgZmFpbHVyZVJlYXNvbjogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZVJlYXNvbjsKfQoKdHlwZSBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbicgfCAndXNlcl9kZWNsaW5lZF9pbnN0X3Blcm1pc3Npb24nIHwgJ3Vua25vd24nOwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICByZWFzb24/OiBhbnk7CiAgICBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwp9CicAyqzjgAnznwQab25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUCBADKrOOACaOhBd8zQGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKaWYgKHNvdXJjZUV2ZW50ID09PSAnYXNrJyB8fCAKICAgIHNvdXJjZUV2ZW50ID09PSAncGFzdGUnIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdib290JyB8fCAKICAgIHNvdXJjZUV2ZW50ID09PSAnZmlsZV91cGxvYWQnIHx8CiAgICBzb3VyY2VFdmVudCA9PT0gJ3Rvb2wnIHx8CiAgICBzb3VyY2VFdmVudCA9PT0gJ2NyZWF0ZV9hcnRpZmFjdF9wcm9taXNlJwopIHsKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYm90cyBiZWluZyBhZGRlZCBhcmUgYXJ0aWZhY3Qgc2hhcmRzIHRoYXQgbmVlZHMgdG8gYmUgcmVjb25zdGl0dXRlZC4KICAgIGNvbnN0IGFydGlmYWN0c1RvUmVjb25zdGl0dXRlOiBSZWNvcmQ8c3RyaW5nLCBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnPiA9IHt9OyAvLyBLZXkgaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMoKTsKICAgIGNvbnN0IGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVGhpcyBzZXQgdHJhY2tzIGFydGlmYWN0IGlkcyB0aGF0IGFyZSBhbHJlYWR5IHF1ZXVlZCB0byBiZSByZWNvbnN0aXR1dGVkIHdpdGggYSBuZXcgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7IC8vIFRyYWNrIG9yaWdpbmFsIGluc3RhbmNlIElEcyB0aGF0IHdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBnaXZlIG5ldyBpbnN0YW5jZXMKCiAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgaWYgKGRhdGEgJiYKICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICAgICAgICAgICFkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZT8uc3RhcnRzV2l0aCgn8J+nrCcpCiAgICAgICAgKSB7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmcgPSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBKU09OLnBhcnNlKGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlLnN1YnN0cmluZygyKSk7CgogICAgICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgICAgIC8vIFNoYXJkIGhhcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXNbYWJBcnRpZmFjdEluc3RhbmNlSURdICYmICFvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxOiBJbnN0YW5jZSBhbHJlYWR5IGV4aXN0cyAtIGNyZWF0ZSBuZXcgaW5zdGFuY2UgKGZpcnN0IHRpbWUgd2Ugc2VlIHRoaXMgY29sbGlzaW9uKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuYWRkKGFiQXJ0aWZhY3RCdW5kbGUuaWQpOyAvLyBUcmFjayB0aGF0IHdlJ3JlIGNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIGZvciB0aGlzIGFydGlmYWN0IElECiAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuYWRkKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsgLy8gVHJhY2sgdGhhdCB3ZSd2ZSBkZWNpZGVkIHRvIHJlcGxhY2UgdGhpcyBvcmlnaW5hbCBpbnN0YW5jZSBJRAoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMTogU2hhcmQgZnJvbSBleGlzdGluZyBpbnN0YW5jZS4gQ3JlYXRpbmcgbmV3IGluc3RhbmNlLiAob2xkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSwgbmV3OiAke25ld0FydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxYjogV2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBvcmlnaW5hbCBJRCAtIGFkZCB0aGlzIHNoYXJkIHRvIHRoYXQgbmV3IGluc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDFiOiBBZGRpdGlvbmFsIHNoYXJkIGZvciByZXBsYWNlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAob3JpZ2luYWw6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDI6IEluc3RhbmNlIGFscmVhZHkgcXVldWVkIGZvciByZWNvbnN0aXR1dGlvbiAtIGRpc3Bvc2UgZHVwbGljYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDI6IER1cGxpY2F0ZSBzaGFyZCBmb3IgcXVldWVkIGluc3RhbmNlLiBEaXNwb3NpbmcuIChhYkFydGlmYWN0SW5zdGFuY2VJRDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDM6IEluc3RhbmNlIHRvIHJlY29uc3RpdHV0ZSB3aXRoIGV4aXN0aW5nIElECiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAzOiBJbnN0YW5jZSB0byByZWNvbnN0aXR1dGUuIChhYkFydGlmYWN0SW5zdGFuY2VJRDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU2hhcmQgaGFzIG5vIGFydGlmYWN0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICBpZiAoYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuaGFzKGFiQXJ0aWZhY3RCdW5kbGUuaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSA0OiBBcnRpZmFjdCBhbHJlYWR5IGhhcyBuZXcgaW5zdGFuY2UgcXVldWVkIC0gZGlzcG9zZSBkdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgNDogRHVwbGljYXRlIHNoYXJkIGZvciBhcnRpZmFjdCB3aXRoIG5ldyBpbnN0YW5jZSBxdWV1ZWQuIERpc3Bvc2luZy4gKGFydGlmYWN0SWQ6ICR7YWJBcnRpZmFjdEJ1bmRsZS5pZH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDU6IENyZWF0ZSBuZXcgaW5zdGFuY2UgZm9yIGFydGlmYWN0IHdpdGhvdXQgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdBcnRpZmFjdEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbbmV3QXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IG5ld0FydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDU6IENyZWF0aW5nIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRC4gKG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgbm90IGEgc2hhcmQgYm90LiBJZ25vcmUgaXQuCiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZTpgLCBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZSk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzOmAsIGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXMpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6YCwgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQ6YCwgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQpOwogICAgfQoKICAgIGZvciAoY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpIHsKICAgICAgICBjb25zdCByZWNvbnN0aXR1dGVBcmc6IEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgPSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF07CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBSZWNvbnN0aXR1dGluZyBhcnRpZmFjdCBpbnN0YW5jZTogJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0UmVjb25zdGl0dXRlKHJlY29uc3RpdHV0ZUFyZyk7CiAgICB9Cn0nAMqs44AJ858EG29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaAIEAMqs44AJgdUF3A5AaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmNvbnN0IHsgYm90RGF0YSwgYWIsIHB1YmxpY0ZhY2luZywgc3R1ZGlvLCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKLy8gRGV0ZWN0IGFydGlmYWN0IGluc3RhbmNlcyB0aGF0IG5lZWQgdG8gYmUgY29udmVydGVkIGludG8gYXJ0aWZhY3QgcHJvbWlzZXMuCgovKioga2V5OiBhcnRpZmFjdCBpbnN0YW5jZSBpZCwgdmFsdWU6IGFydGlmYWN0IHByb21pc2UgZGF0YS4gKi8KY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZSA9IG5ldyBTZXQoKTsgLy8gS2VlcCB0cmFjayBvZiB3aGF0IGFydGlmYWN0IGluc3RhbmNlIElEcyBoYXZlIGhhZCBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUuCgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QuCiAgICAgICAgaWYgKCFhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmhhcyhkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgIC8vIFRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgbmVlZHMgYW4gYXJ0aWZhY3QgcHJvbWlzZSBtYWRlIGZvciBpdC4KICAgICAgICAgICAgY29uc3QgcHJvbWlzZUlkID0gdXVpZCgpOwoKICAgICAgICAgICAgYm90RGF0YVtwcm9taXNlSWRdID0gewogICAgICAgICAgICAgICAgaWQ6IHByb21pc2VJZCwKICAgICAgICAgICAgICAgIHNwYWNlOiAnc2hhcmVkJywKICAgICAgICAgICAgICAgIHRhZ3M6IHsKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdFByb21pc2U6IHRydWUsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvbnZlcnRlZCBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2RhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gaW50byBhbiBhcnRpZmFjdCBwcm9taXNlOmAsIGJvdERhdGFbcHJvbWlzZUlkXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGFydGlmYWN0SW5zdGFuY2VzV2l0aFByb21pc2UuYWRkKGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCk7CiAgICAgICAgfQoKICAgICAgICAvLyBSZW1vdmUgYXJ0aWZhY3QgaW5zdGFuY2Ugc2hhcmQgYm90IGZyb20gYm90RGF0YSB0aGF0IGlzIGFib3V0IHRvIGJlIHB1Ymxpc2hlZC4KICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5pc2hlZCBib3REYXRhOmAsIHsuLi5ib3REYXRhfSk7Cn0nAMqs44AJ858EFmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMCBADKrOOACd7jBcoHQGNvbnN0IHsgCiAgICBib3RzLAogICAgYWJBcnRpZmFjdE5hbWUsCn0gPSB0aGF0ID8/IHt9CgppZiAoYm90cykgewogICAgYXNzZXJ0KEFycmF5LmlzQXJyYXkoYm90cyksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyBtdXN0IGJlIGFuIGFycmF5LmApOwp9Cgpjb25zdCBpbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHt9IC8vIEtleSBpcyBhcnRpZmFjdCBpbnN0YW5jZSBpZC4KCmZ1bmN0aW9uIHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGJvdCkgewogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxldCBib3RBcnJheSA9IGluc3RhbmNlc1tib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgICAgIGlmICghYm90QXJyYXkpIHsKICAgICAgICAgICAgYm90QXJyYXkgPSBbXTsKICAgICAgICAgICAgaW5zdGFuY2VzW2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IGJvdEFycmF5OwogICAgICAgIH0KCiAgICAgICAgYm90QXJyYXkucHVzaChib3QpOwogICAgfQp9CgppZiAoYm90cykgewogICAgLy8gR2V0IGFydGlmYWN0IGluc3RhbmNlcyBpbiBwcm92aWRlZCBsaXN0IG9mIGJvdHMuCiAgICBib3RzLmZvckVhY2goYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShiKSk7Cn0gZWxzZSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgaW5zdGFuY2VzIGluIGluc3QuCiAgICBnZXRCb3RzKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYikpOwp9CgpyZXR1cm4gaW5zdGFuY2VzOycAyqzjgAnznwQVYWJHZXRBcnRpZmFjdFBhdHRlcm5zAgQAyqzjgAmp6wXzB0Bjb25zdCB7IAogICAgYm90cywKICAgIGFiQXJ0aWZhY3ROYW1lLAp9ID0gdGhhdCA/PyB7fQoKaWYgKGJvdHMpIHsKICAgIGFzc2VydChBcnJheS5pc0FycmF5KGJvdHMpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgbXVzdCBiZSBhbiBhcnJheS5gKTsKfQoKY29uc3QgcGF0dGVybnM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHt9IC8vIEtleSBpcyBhcnRpZmFjdCBuYW1lLgoKZnVuY3Rpb24gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihib3QpIHsKICAgIC8vIFBhdHRlcm4gYm90cyBoYXZlIGFiQXJ0aWZhY3ROYW1lIGJ1dCBubyBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmICFib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBib3QudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBsZXQgYm90QXJyYXkgPSBwYXR0ZXJuc1tib3QudGFncy5hYkFydGlmYWN0TmFtZV07CgogICAgICAgIGlmICghYm90QXJyYXkpIHsKICAgICAgICAgICAgYm90QXJyYXkgPSBbXTsKICAgICAgICAgICAgcGF0dGVybnNbYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWVdID0gYm90QXJyYXk7CiAgICAgICAgfQoKICAgICAgICBib3RBcnJheS5wdXNoKGJvdCk7CiAgICB9Cn0KCmlmIChib3RzKSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgcGF0dGVybnMgaW4gcHJvdmlkZWQgbGlzdCBvZiBib3RzLgogICAgYm90cy5mb3JFYWNoKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihiKSk7Cn0gZWxzZSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgcGF0dGVybnMgaW4gaW5zdC4KICAgIGdldEJvdHMoYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGIpKTsKfQoKcmV0dXJuIHBhdHRlcm5zOycAyqzjgAnznwQYYWJQdWJsaXNoQXJ0aWZhY3RQYXR0ZXJuAgQAyqzjgAmd8wX6BUBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIHN0dWRpbywKICAgIHNoYXJkQm90cywKICAgIG1hbnVhbFB1Ymxpc2gsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0TmFtZSA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIHN0dWRpbyA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3R1ZGlvIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSAmJiBzaGFyZEJvdHMubGVuZ3RoID4gMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgYSByZXF1aXJlZCBCb3QgYXJyYXkgcGFyYW1ldGVyLiBJdCBtdXN0IGhhdmUgYXQgbGVhc3QgMSBib3QuYCk7CgpyZXR1cm4gbGlua3Muc3RvcmUuYWJQdWJsaXNoQUIoewogICAgYWI6IGFiQXJ0aWZhY3ROYW1lLCAKICAgIHRhcmdldDogc2hhcmRCb3RzLCAKICAgIHN0dWRpbywKICAgIG1hbnVhbFB1Ymxpc2gsCiAgICBzb3VyY2VFdmVudDogJ3B1Ymxpc2hfYXJ0aWZhY3RfcGF0dGVybicsCiAgICBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOiAoYXJnKSA9PiB7CiAgICAgICAgdGhpc0JvdC5hYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YShhcmcuYm90RGF0YSk7CiAgICB9Cn0pOycAyqzjgAnznwQmYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGECBADKrOOACZj5BZ8FQGNvbnN0IGJvdERhdGEgPSB0aGF0OwoKYXNzZXJ0KGxpbmtzLnV0aWxzLmlzT2JqZWN0KGJvdERhdGEpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFyZ3VtZW50IG11c3QgYmUgYW4gb2JqZWN0LmApOwoKZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKICAgIAogICAgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICAgICAgLy8gUmVtb3ZlIGFydGlmYWN0IGJvdHMuCiAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAKICAgIH0gZWxzZSBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgLy8gU3RyaXAgYXJ0aWZhY3QgaW5zdGFuY2UgZGF0YSBmcm9tIGJvdC4KICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQ7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkOwoKICAgICAgICAvLyBSZW1vdmUgc29tZSBvdGhlcnMuCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5jcmVhdG9yOwogICAgfQp9CiAgICAnAMqs44AJ858ED2lzRWdnRGVwZW5kZW5jeQIEAMqs44AJuP4FUkByZXR1cm4gbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8uYWJJRCkgJiYgbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8ucmVjb3JkS2V5KTsnAMqs44AJ858ED2lzQXNrRGVwZW5kZW5jeQIEAMqs44AJi/8FKkByZXR1cm4gbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8uYXNrSUQpOycAyqzjgAnznwQQb25BbnlCb3RzQ2hhbmdlZAIEAMqs44AJtv8FyQhALy8gY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwoKZm9yIChjb25zdCBjaGFuZ2VkIG9mIHRoYXQpIHsKICAgIGlmIChjaGFuZ2VkID09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgIH0KCiAgICAvLyAxKSBvbmx5IGNhcmUgYWJvdXQgYm90cyB3aXRoIGFydGlmYWN0IHRhZ3MKICAgIGlmICghY2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0TmFtZSB8fCAhY2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgY29udGludWU7CgogICAgLy8gMikgYXJ0aWZhY3QgbXVzdCBiZSByZWNvbnN0aXR1dGVkLgogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIGNvbnRpbnVlOwoKICAgIGlmICh0aGlzQm90LmlzRXhwZXJpZW5jZUVuYWJsZWQoKSkgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2hhbmdlcyBvbiBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2NoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGRldGVjdGVkLCBjYWxsaW5nIHRvIHVwZGF0ZSBleHBlcmllbmNlLmAsIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgIGNoYW5nZWRCb3RJZDogY2hhbmdlZC5ib3QuaWQsCiAgICAgICAgICAgICAgICBjaGFuZ2VkVGFnczogY2hhbmdlZC50YWdzLAogICAgICAgICAgICB9KSk7CiAgICAgICAgfQogICAgICAgIHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdCBpbnN0YW5jZSAke2NoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGNoYW5nZWQgYnV0IGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICAgICAgfQogICAgfQp9CicAyqzjgAnznwQZZXhwZXJpZW5jZVRpY2tSYXRlTGltaXRNUwIEAMqs44AJgIgGBDUwMDAnAMqs44AJ858EFmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWcCBADKrOOACYWIBhlvbkFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzJwDKrOOACfOfBAhkZWJ1Z0V4cAIEAMqs44AJn4gGBWZhbHNlJwDKrOOACfOfBBdpc1JlY29uc3RpdHV0aW9uRW5hYmxlZAIEAMqs44AJpYgGfEBpZiAoY29uZmlnQm90LnRhZ3MuYWJBcnRpZmFjdFJlY29uc3RpdHV0aW9uID09PSBmYWxzZSkgewogICAgcmV0dXJuIGZhbHNlOwp9CgovLyBSZWNvbnN0aXR1dGlvbiBvbiBieSBkZWZhdWx0LgpyZXR1cm4gdHJ1ZTsnAMqs44AJ858EF2FiQ29sbGVjdEFydGlmYWN0U2hhcmRzAgQAyqzjgAmiiQbQGEBjb25zdCB7IHNoYXJkQm90cyB9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cyksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIHJlcXVpcmVkIHRvIGJlIGFuIGJvdCBhcnJheS5gKTsKCi8qKiBLZWVwIHRyYWNrIG9mIGRlcGVuZGVuY3kgaGFzaGVzLiBUaGlzIHByZXZlbnRzIGR1cGxpY2F0ZXMgaW4gdGhlIGFydGlmYWN0IGRlcGVuZGVuY2llcy4gKi8KY29uc3QgZGVwZW5kZW5jeUhhc2hlcyA9IG5ldyBTZXQoKTsKCmxldCBtZXJnZWRTaGFyZDogQUJBcnRpZmFjdFNoYXJkID0gewogICAgZGF0YToge30sCiAgICBkZXBlbmRlbmNpZXM6IFtdLAp9OwoKZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gc2hhcmRCb3QudGFncy5hYkFydGlmYWN0TmFtZTsKICAgIGNvbnN0IGJvdFNob3J0SWQgPSBzaGFyZEJvdC5pZC5zdWJzdHJpbmcoMCwgNSk7CgogICAgbGV0IHNoYXJkOiBBQkFydGlmYWN0U2hhcmQ7CiAgICBpZiAoc2hhcmRCb3QudGFnc1t0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKSB7CiAgICAgICAgaWYgKHNoYXJkQm90W3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10pIHsKICAgICAgICAgICAgc2hhcmQgPSBhd2FpdCBQcm9taXNlLnJlc29sdmUoc2hhcmRCb3RbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nICR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSB0YWcgaXMgZGVmaW5lZCBidXQgaXMgbm90IGEgdmFsaWQgZnVuY3Rpb24uYCB9OwogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdE5hbWV9LCBib3Q6ICR7Ym90U2hvcnRJZH0sIHNoYXJkOmAsIHNoYXJkKTsKICAgIH0KCiAgICBpZiAoc2hhcmQpIHsKICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzT2JqZWN0KHNoYXJkKSkgewogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgbXVzdCBiZSBhbiBvYmplY3QuYCB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHNoYXJkLmRhdGEpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc09iamVjdChzaGFyZC5kYXRhKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBAJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHNoYXJkICdkYXRhJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIG9iamVjdC5gIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNoYWxsb3cgbWVyZ2Ugc2hhcmQncyBkYXRhIHByb3BlcnRpZXMgaW50byBjb21iaW5lZCBhcnRpZmFjdCBkYXRhLgogICAgICAgICAgICBtZXJnZWRTaGFyZC5kYXRhID0geyAuLi5tZXJnZWRTaGFyZC5kYXRhLCAuLi5zaGFyZC5kYXRhIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgIGlmICghbGlua3MudXRpbHMuaXNBcnJheShzaGFyZC5kZXBlbmRlbmNpZXMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgJ2RlcGVuZGVuY2llcycgcHJvcGVydHkgbXVzdCBiZSBhbiBhcnJheS5gIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgICAgIC8vIFZhbGlkYXRlIHRoYXQgZGVwZW5kZW5jeSBpcyBvbmUgb2YgdGhlIHN1cHBvcnRlZCB0eXBlcy4KICAgICAgICAgICAgICAgIGlmICghdGhpc0JvdC5pc0VnZ0RlcGVuZGVuY3koZGVwZW5kZW5jeSkgJiYgIXRoaXNCb3QuaXNBc2tEZXBlbmRlbmN5KGRlcGVuZGVuY3kpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBoYXMgYSBkZXBlbmRlbmN5IGVudHJ5IHRoYXQgaXMgbmVpdGhlciBhbiBlZ2cgb3IgYXNrIGRlcGVuZGVuY3kgdHlwZS5gIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoaXMgZGVwZW5kZW5jeSBpc250IGFscmVhZHkgY29sbGVjdGVkLgogICAgICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIGRlcGVuZGVuY3kpOwoKICAgICAgICAgICAgICAgIGlmICghZGVwZW5kZW5jeUhhc2hlcy5oYXMoaGFzaCkpIHsKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmN5SGFzaGVzLmFkZChoYXNoKTsKICAgICAgICAgICAgICAgICAgICBtZXJnZWRTaGFyZC5kZXBlbmRlbmNpZXMucHVzaChkZXBlbmRlbmN5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gTWFrZSBzdXJlIHdlIGhhdmUgYXQgbGVhc3Qgb25lIGRlcGVuZGVuY3kuCmlmIChtZXJnZWRTaGFyZC5kZXBlbmRlbmNpZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBtdXN0IGxpc3QgYXQgbGVhc3Qgb25lIGRlcGVuZGVuY3kgaW4gb3JkZXIgdG8gcmVjb25zdGl0dXRlIHByb3Blcmx5LmAgfTsKfQoKY29uc3QgcmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdCA9IHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBzaGFyZDogbWVyZ2VkU2hhcmQsCn0KCnJldHVybiByZXN1bHQ7JwDKrOOACfOfBBdjYW5Vc2VyVXBkYXRlRXhwZXJpZW5jZQIEAMqs44AJ86EGzglAY29uc3QgewogICAgcmVtb3RlSWQgPSBjb25maWdCb3QuaWQsCiAgICBzaGFyZEJvdAp9ID0gdGhhdCA/PyB7fQoKaWYgKHNoYXJkQm90ICYmIAogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0TmFtZSAmJgogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRAopIHsKICAgIC8vIE5lZWQgdG8gZmlndXJlIG91dCBpZiB0aGlzIHVzZXIgaXMgYWxsb3dlZCB0byB1cGRhdGUgdGhlIGV4cGVyaWVuY2Ugb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgIGxldCBjYW5Vc2VyVXBkYXRlID0gZmFsc2U7CgogICAgc3dpdGNoIChzaGFyZEJvdC5zcGFjZSkgewogICAgICAgIGNhc2UgJ3NoYXJlZCc6CiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgIGNhc2UgJ3RlbXBTaGFyZWQnOgogICAgICAgICAgICAvLyB0ZW1wU2hhcmVkIHNwYWNlIG1lYW5zIHRoYXQgdGhpcyBib3QgaXMgYmFzaWNhbGx5IG93bmVkIGJ5IHRoaXMgdXNlci4KICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3JlbW90ZVRlbXBTaGFyZWQnOgogICAgICAgICAgICAvLyByZW1vdGVUZW1wU2hhcmVkIHNwYWNlIG1lYW5zIHRoYXQgdGhpcyBib3QgaXMgb3duZWQgYnkgc29tZW9uZSBlbHNlLgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2xvY2FsJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3RlbXBMb2NhbCc6CiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVW5yZWNvZ25pemVkIGJvdCBzcGFjZTpgLCBzaGFyZEJvdC5zcGFjZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBjYW5Vc2VyVXBkYXRlOwp9IGVsc2UgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwcm92aWRlZCBzaGFyZEJvdCBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgZnJvbSBhbiBhcnRpZmFjdCBpbnN0YW5jZS5gLCBzaGFyZEJvdCk7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7Cn0nAMqs44AJ858EGmFiQ3JlYXRlQXJ0aWZhY3RQcm9taXNlQm90AgQAyqzjgAnCqwasCkBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdFNoYXJkLAogICAgc3BhY2UgPSAnc2hhcmVkJywKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYm90RGF0YSA9IFtdOwpjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0QnVuZGxlKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBhYkFydGlmYWN0U2hhcmQgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBnZW5lcmF0ZWQgYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKYm90RGF0YVtwcm9taXNlSWRdID0gewogICAgaWQ6IHByb21pc2VJZCwKICAgIHNwYWNlLAogICAgdGFnczogewogICAgICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgIGFiQXJ0aWZhY3RCdW5kbGU6ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpLAogICAgICAgIGFiQXJ0aWZhY3RQcm9taXNlOiB0cnVlLAogICAgfQp9CgovLyBDcmVhdGUgYXJ0aWZhY3QgcHJvbWlzZSB0aHJvdWdoIGFiQ3JlYXRlQm90cy4gCi8vIFRoaXMgd2lsbCB0cmlnZ2VyIGFydGlmYWN0J3Mgb25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUgYW5kIGl0IHdpbGwgZmluZAovLyB0aGlzIGFydGlmYWN0IHByb21pc2UgYW5kIHVzZSB0aGUgZGF0YSB0byByZWNvbnN0aXR1dGUgaXQuCmNvbnN0IHJlc3VsdCA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3REYXRhLCBzb3VyY2VFdmVudDogJ2NyZWF0ZV9hcnRpZmFjdF9wcm9taXNlJyB9KQoKcmV0dXJuIHJlc3VsdDsnAMqs44AJ858EFmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUCBADKrOOACe21BpkIQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdFNoYXJkLAp9ID0gdGhhdDsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHsKICAgIG5hbWU6IGFiQXJ0aWZhY3ROYW1lLAogICAgZm9ybWF0VmVyc2lvbjogMSwKICAgIGRhdGE6IGFiQXJ0aWZhY3RTaGFyZC5kYXRhLAogICAgZGVwZW5kZW5jaWVzOiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLAp9CgovLyBHZW5lcmF0ZSB0aGUgYXJ0aWZhY3QgaWQsIHdoaWNoIGlzIHNoYTI1NiBoYXNoIG9mIHRoZSBjb3JlIGNvbnRlbnRzIG9mIHRoZSBhcnRpZmFjdC4KYWJBcnRpZmFjdEJ1bmRsZS5pZCA9IGNyeXB0by5zaGEyNTYoYWJBcnRpZmFjdEJ1bmRsZSk7CgovLyBTdG9yZSBzb21lIGV4dHJhIG1ldGFkYXRhIHByb3BlcnRpZXMgd2l0aCB0aGUgYXJ0aWZhY3QuCi8vIFRoZXNlIGFyZSBub3QgY29yZSB0byB0aGUgYXJ0aWZhY3QncyBmdW5jdGlvbmFsaXR5IGJ1dCBtYXkgYmUgdXNlZnVsIGFzIGFydGlmYWN0cyBldm9sdmUuCmFiQXJ0aWZhY3RCdW5kbGUuY2FzdWFsT1NWZXJzaW9uID0gb3MudmVyc2lvbigpOwphYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXAgPSBEYXRlVGltZS5ub3coKS50b0lTTygpOwphYkFydGlmYWN0QnVuZGxlLmFiU2hlbGxWZXJzaW9uID0gYCR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1ham9yVmVyc2lvbn0uJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWlub3JWZXJzaW9ufWA7CgpyZXR1cm4gYWJBcnRpZmFjdEJ1bmRsZTsnAMqs44AJ858EBmNyZWF0ZQIEAMqs44AJh74GKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAMqs44AJ858EE2lzRXhwZXJpZW5jZUVuYWJsZWQCBADKrOOACa6+BnRAaWYgKGNvbmZpZ0JvdC50YWdzLmFiQXJ0aWZhY3RFeHBlcmllbmNlID09PSB0cnVlKSB7CiAgICByZXR1cm4gdHJ1ZTsKfQoKLy8gRXhwZXJpZW5jZSBvZmYgYnkgZGVmYXVsdC4KcmV0dXJuIGZhbHNlOycAyqzjgAnznwQeYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50AgQAyqzjgAmjvwbcG0Bjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICByZXR1cm47Cn0KCmlmICghdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcyA9IHt9Owp9CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0pIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBhbHJlYWR5IGhhcyBhIGRvY3VtZW50IGxvYWRlZC5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKbGV0IGV4cGVyaWVuY2VBdXRoOiBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGggPSBhd2FpdCB0aGlzQm90LmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKaWYgKCFleHBlcmllbmNlQXV0aC5hdXRob3JpemVkKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQXJ0aWZhY3QgZXhwZXJpZW5jZSB3YXMgbm90IGF1dGhvcml6ZWQuIFJlYXNvbjogJHtleHBlcmllbmNlQXV0aC5mYWlsdXJlUmVhc29ufWApOwogICAgcmV0dXJuOwp9CgovLyBHZXQgdGhlIGFydGlmYWN0IGluc3RhbmNlJ3Mgc2hhcmVkIGRvY3VtZW50IGFzIHdlbGwgYXMgdGhlIGV4cGVyaWVuY2UgbWFwLgpjb25zdCBkb2N1bWVudCA9IGF3YWl0IG9zLmdldFNoYXJlZERvY3VtZW50KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLCBgYXJ0aWZhY3RJbnN0YW5jZV8ke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWAsICdtYWluJyk7CmNvbnN0IGV4cGVyaWVuY2VNYXAgPSBkb2N1bWVudC5nZXRNYXAoJ2V4cGVyaWVuY2UnKTsKCmNvbnN0IHNraXBLZXlzID0gbmV3IFNldChbCiAgICAnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcsCiAgICAvLyBBZGQgbW9yZSBrZXlzIGhlcmUgaWYgbmVlZGVkCiAgICAvLyAnc29tZU90aGVyS2V5JywKICAgIC8vICd5ZXRBbm90aGVyS2V5JwpdKTsKCmNvbnN0IGV4cGVyaWVuY2VTdWIgPSBleHBlcmllbmNlTWFwLmRlZXBDaGFuZ2VzLnN1YnNjcmliZSgoZXZlbnRzKSA9PiB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb24gZGVlcCBjaGFuZ2VzOmAsIGV2ZW50cyk7CiAgICB9CgogICAgLy8gQ29sbGVjdCBhbGwgY2hhbmdlZCBrZXlzCiAgICBjb25zdCBhbGxLZXlzID0gbmV3IFNldCgpOwogICAgZm9yIChjb25zdCBldnQgb2YgZXZlbnRzID8/IFtdKSB7CiAgICAgICAgY29uc3QgbSA9IGV2dD8uY2hhbmdlczsKICAgICAgICBpZiAobSAmJiB0eXBlb2YgbS5rZXlzID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgayBvZiBtLmtleXMoKSkgewogICAgICAgICAgICAgICAgYWxsS2V5cy5hZGQoayk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gU2tpcCBpZiAqYWxsKiBjaGFuZ2VzIGFyZSBpbnNpZGUgdGhlIHNraXAgbGlzdAogICAgY29uc3Qgc2hvdWxkU2tpcCA9IGFsbEtleXMuc2l6ZSA+IDAgJiYgWy4uLmFsbEtleXNdLmV2ZXJ5KChrKSA9PiBza2lwS2V5cy5oYXMoaykpOwogICAgaWYgKHNob3VsZFNraXApIHsKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraXBwaW5nIGNhbGwgdG8gYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UsIHRoZSBvbmx5IGNoYW5nZSB0byB0aGUgZXhwZXJpZW5jZSB3ZXJlIHNwZWNpYWwgcmVzZXJ2ZWQgcHJvcGVydGllcy5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfSk7Cgp0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsgZG9jdW1lbnQsIGV4cGVyaWVuY2VNYXAsIGV4cGVyaWVuY2VTdWJ9OwoKaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gaW5zdGFuY2UgZG9jdW1lbnQgbG9hZGVkOmAsIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdKTsKCiAgICBjb25zdCBleHBlcmllbmNlSlNPTiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXhwZXJpZW5jZU1hcC50b0pTT04oKSkpOwogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBsb2FkZWQgZXhwZXJpZW5jZSBtYXAgc3RhdGU6YCwgZXhwZXJpZW5jZUpTT04pOwp9Cgpjb25zdCBhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkID0gZXhwZXJpZW5jZU1hcC5nZXQoJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnKTsKCmlmIChhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkID09PSB0cnVlKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRpbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZnJvbSBleHBlcmllbmNlLmApOwogICAgfQogICAgLy8gSW1tZWRpYXRlbHkgZ2l2ZSB0aGUgc2hhcmQgYm90cyB0aGUgY3VycmVudCBleHBlcmllbmNlIHN0YXRlLgogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9IGVsc2UgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGluaXRpYWxpemluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBleHBlcmllbmNlLmApOwogICAgfQogICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXhwZXJpZW5jZSBzdGF0ZSB3aXRoIHRoZSBjdXJyZW50IHNoYXJkIGRhdGEuCiAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsgICAgCn0KJwDKrOOACfOfBCBhYlVubG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudAIEAMqs44AJgNsGiQZAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgY29uc3QgeyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1YiB9ID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07IAoKICAgIGlmIChleHBlcmllbmNlU3ViKSB7CiAgICAgICAgZXhwZXJpZW5jZVN1Yi51bnN1YnNjcmliZSgpOwoKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVuc3Vic2NyaWJlZCBmcm9tIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGV4cGVyaWVuY2UgbWFwLmApOwogICAgICAgIH0KICAgIH0KCiAgICBkZWxldGUgdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlbW92ZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZG9jdW1lbnQuYCk7CiAgICB9Cn0nAMqs44AJ858EHmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cwIEAMqs44AJiuEGtAJAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3Qgc2hhcmRCb3RzID0gZ2V0Qm90cygoYikgPT4gewogICAgcmV0dXJuIGIudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQKfSk7CgpyZXR1cm4gc2hhcmRCb3RzOycAyqzjgAnznwQmYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UCBADKrOOACb/jBukHQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKCF0aGlzQm90LmlzRXhwZXJpZW5jZUVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgIHJldHVybjsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IGluc3RhbmNlRG9jID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgaWYgKGluc3RhbmNlRG9jKSB7CiAgICAgICAgY29uc3Qgc2hhcmRCb3RzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMoeyBhYkFydGlmYWN0SW5zdGFuY2VJRH0pOwoKICAgICAgICBjb25zdCB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3ViIH0gPSBpbnN0YW5jZURvYzsKCiAgICAgICAgY29uc3QgZXhwZXJpZW5jZURhdGEgPSBleHBlcmllbmNlTWFwLnRvSlNPTigpOwoKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0aW5nIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IHdpdGggZXhwZXJpZW5jZSBzdGF0ZTpgLCBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VEYXRhKSkpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RFeHBlcmllbmNlJywgeyBkYXRhOiBleHBlcmllbmNlRGF0YSB9KSk7CiAgICB9Cn0nAMqs44AJ858EImFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUV4cGVyaWVuY2UCBADKrOOACanrBtAoQGltcG9ydCB7IFNoYXJlZE1hcCB9IGZyb20gJ2Nhc3VhbG9zJzsKCmNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKCF0aGlzQm90LmlzRXhwZXJpZW5jZUVuYWJsZWQoKSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgfQogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcykgewogICAgdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzID0gbmV3IFNldCgpOwp9CgppZiAodGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmhhcyhhYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIHVwZGF0ZSBpcyBhbHJlYWR5IGluIHByb2dyZXNzIGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWApOwogICAgfQogICAgcmV0dXJuOwp9Cgp0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuYWRkKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsKCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCBpbnN0YW5jZURvYyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmIChpbnN0YW5jZURvYykgewogICAgICAgIGNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgogICAgICAgIC8vIE5lZWQgdG8gYXNrIGlmIHRoaXMgdXNlciBpcyBhbGxvd2VkIHRvIHVwZGF0ZSB0aGUgZXhwZXJpZW5jZSBvZiB0aGlzIGFydGlmYWN0IGluc3RhbmNlLgogICAgICAgIGNvbnN0IGNhblVzZXJVcGRhdGUgPSBhd2FpdCB0aGlzQm90LmNhblVzZXJVcGRhdGVFeHBlcmllbmNlKHsgcmVtb3RlSWQ6IGNvbmZpZ0JvdC5pZCwgc2hhcmRCb3Q6IHNoYXJkQm90c1swXSB9KTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW4gdXNlciB1cGRhdGUgZXhwZXJpZW5jZSBmb3IgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHtzaGFyZEJvdHNbMF0udGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRC5zdWJzdHJpbmcoMCwgNyl9P2AsIGNhblVzZXJVcGRhdGUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNhblVzZXJVcGRhdGUpIHsKICAgICAgICAgICAgbGV0IGNvbGxlY3RTaGFyZFJlc3VsdDogQUJBcnRpZmFjdENvbGxlY3RTaGFyZHNSZXN1bHQ7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgY29sbGVjdFNoYXJkUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hYkNvbGxlY3RBcnRpZmFjdFNoYXJkcyh7IHNoYXJkQm90cyB9KTsKCiAgICAgICAgICAgICAgICBpZiAoIWNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihjb2xsZWN0U2hhcmRSZXN1bHQucmVhc29uKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQ6YCwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGBjb2xsZWN0U2hhcmRSZXN1bHQ6YCwgSlNPTi5zdHJpbmdpZnkoY29sbGVjdFNoYXJkUmVzdWx0KSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChjb2xsZWN0U2hhcmRSZXN1bHQgJiYgY29sbGVjdFNoYXJkUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIC8vIE9ubHkgdXBkYXRlIGVudHJ5IGluIGV4cGVyaWVuY2VNYXAgaWYgdGhlIGRhdGEgaXMgYWN0dWFsbHkgZGlmZmVyZW50LgogICAgICAgICAgICAgICAgY29uc3QgZXhwZXJpZW5jZU1hcDogU2hhcmVkTWFwID0gaW5zdGFuY2VEb2MuZXhwZXJpZW5jZU1hcDsKCiAgICAgICAgICAgICAgICAvLyBTYWZldHk6IHNoYXJkIGRhdGEgbWlnaHQgYmUgdW5kZWZpbmVkL251bGwKICAgICAgICAgICAgICAgIGNvbnN0IHNoYXJkRGF0YSA9IChjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQgJiYgY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkLmRhdGEpID8gY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkLmRhdGEgOiB7fTsKICAgICAgICAgICAgICAgIGNvbnN0IHNoYXJkRGF0YUtleXMgPSBPYmplY3Qua2V5cyhzaGFyZERhdGEpOwogICAgICAgICAgICAgICAgY29uc3Qga2V5c1RvRGVsZXRlID0gW107CgogICAgICAgICAgICAgICAgLy8gU2ltcGxlIGRlZXAtZXF1YWxpdHkgY2hlY2sgZm9yIEpTT04tc2VyaWFsaXphYmxlIHZhbHVlcwogICAgICAgICAgICAgICAgY29uc3QgaXNFcXVhbCA9IChhLCBiKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEgPT09IGIpIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShhKSA9PT0gSlNPTi5zdHJpbmdpZnkoYik7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIDEpIFVwc2VydCBvbmx5IHdoZW4gZGlmZmVyZW50CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBzaGFyZERhdGFLZXlzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3VmFsID0gc2hhcmREYXRhW2tleV07CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkVmFsID0gZXhwZXJpZW5jZU1hcC5nZXQoa2V5KTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRXF1YWwob2xkVmFsLCBuZXdWYWwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0aW5nIGV4cGVyaWVuY2VNYXAga2V5ICIke2tleX0iYCwgSlNPTi5zdHJpbmdpZnkoeyBvbGRWYWwsIG5ld1ZhbCB9KSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZXhwZXJpZW5jZU1hcC5zZXQoa2V5LCBuZXdWYWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAyKSBDb2xsZWN0IGtleXMgdGhhdCBleGlzdCBpbiB0aGUgbWFwIGJ1dCBub3QgaW4gdGhlIHNoYXJkIGRhdGEKICAgICAgICAgICAgICAgIC8vICAgICh3ZSBhdm9pZCBtdXRhdGluZyB0aGUgbWFwIHdoaWxlIGl0ZXJhdGluZyBpdCkKICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGV4cGVyaWVuY2VNYXAua2V5cygpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERvbid0IGRlbGV0ZSBhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkLiBJdHMgYSBzcGVjaWFsIHByb3BlcnR5LgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKCFzaGFyZERhdGFLZXlzLmluY2x1ZGVzKGtleSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5c1RvRGVsZXRlLnB1c2goa2V5KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMykgUmVtb3ZlIHN0YWxlIGtleXMKICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXNUb0RlbGV0ZSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGVsZXRpbmcgc3RhbGUgZXhwZXJpZW5jZU1hcCBrZXkgIiR7a2V5fSJgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZXhwZXJpZW5jZU1hcC5kZWxldGUoa2V5KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoZXhwZXJpZW5jZU1hcC5nZXQoJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnKSAhPSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgZXhwZXJpZW5jZU1hcC5zZXQoJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnLCB0cnVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IHVwZGF0ZSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBiZWNhdXNlIGluc3RhbmNlIGRvY3VtZW50IG5vdCBsb2FkZWQuYCk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgdXBkYXRlIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGJlY2F1c2UgaW5zdGFuY2UgZG9jdW1lbnRzIGhhdmUgbm90IGJlZW4gaW5pdGlhbGl6ZWQuYCk7CiAgICB9Cn0KCnRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5kZWxldGUoYWJBcnRpZmFjdEluc3RhbmNlSUQpOycAyqzjgAnznwQMb25JbnN0Sm9pbmVkAgQAyqzjgAn6kweBA0BtYXNrcy5pbnN0Sm9pbmVkID0gdHJ1ZTsKCmNvbnN0IGFydGlmYWN0SW5zdGFuY2VzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VzKCk7Cgpmb3IgKGxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBhcnRpZmFjdEluc3RhbmNlcykgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvYWRpbmcgYXJ0aWZhY3QgaW5zdGFuY2UgZG9jdW1lbnQgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICB9CiAgICAKICAgIHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0nAMqs44AJ858EDm9uQW55Qm90c0FkZGVkAgQAyqzjgAn8lgfCBEBpZiAoIW1hc2tzLmluc3RKb2luZWQpIHsKICAgIHJldHVybjsKfQoKY29uc3QgYWRkZWRCb3RzID0gdGhhdC5ib3RzOwoKZm9yIChjb25zdCBib3Qgb2YgYWRkZWRCb3RzKSB7CiAgICBpZiAoYm90ID09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgIH0KCiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICBhd2FpdCBvcy5zbGVlcCgyNTApOwoKICAgICAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZXRlY3RlZCBhZGRlZCBhYkFydGlmYWN0SW5zdGFuY2VJRDogJHtib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0uYCkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpc0JvdC5hYkxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQoeyBhYkFydGlmYWN0SW5zdGFuY2VJRDogYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICAgICAgfQogICAgfQp9JwDKrOOACfOfBBpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAMqs44AJv5sH3gVAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgncHJpbnRhcnRpZmFjdGV4cGVyaWVuY2UnLCAoYXJncykgPT4gewogICAgY29uc3QgaW5zdGFuY2VEb2NzID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jczsKCiAgICBsZXQgYWxsRXhwZXJpZW5jZSA9IHt9OwoKICAgIGZvciAobGV0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGluc3RhbmNlRG9jcykgewogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VNYXAgPSBpbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdLmV4cGVyaWVuY2VNYXA7CiAgICAgICAgY29uc3QgZXhwZXJpZW5jZUpTT04gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VNYXAudG9KU09OKCkpKTsKICAgICAgICBhbGxFeHBlcmllbmNlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IGV4cGVyaWVuY2VKU09OOwogICAgfQoKICAgIGNvbnNvbGUubG9nKGBbcHJpbnRhcnRpZmFjdGV4cGVyaWVuY2VdIEFsbCBjdXJyZW50IGFydGlmYWN0IGluc3RhbmNlIGV4cGVyaWVuY2Ugc3RhdGVzOmAsIGFsbEV4cGVyaWVuY2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnUHJpbnQgYWxsIGN1cnJlbnRseSBsb2FkZWQgYXJ0aWZhY3QgaW5zdGFuY2UgZXhwZXJpZW5jZSBzdGF0ZXMgdG8gdGhlIGNvbnNvbGUuJywKICAgIHVzYWdlOiBbJy5wcmludGFydGlmYWN0ZXhwZXJpZW5jZSddCn0pOycAyqzjgAnznwQYYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoAgQAyqzjgAmeoQfcEkBjb25zdCB7IAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IGV4cEF1dGhSZXN1bHQ6IEFCQXJ0aWZhY3RFeHBlcmllbmNlQXV0aCA9IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYXV0aG9yaXplZDogdW5kZWZpbmVkLAogICAgZmFpbHVyZVJlYXNvbjogdW5kZWZpbmVkLAp9CgppZiAoZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlKSB7CiAgICBleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSBmYWxzZTsKICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9IGFiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQ7CgogICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Cn0KCmxldCBteUF1dGhCb3QgPSBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwoKaWYgKCFteUF1dGhCb3QpIHsKICAgIC8vIE5vdCBzaWduZWQgaW4sIG5lZWQgdG8gc2lnbiBpbiB0byB1c2UgYXJ0aWZhY3QgZXhwZXJpZW5jZS4KICAgIGxldCBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlID0gZ2xvYmFsVGhpcy5hYkFydGlmYWN0VXNlckF1dGhQcm9taXNlOwoKICAgIGlmICghYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSkgewogICAgICAgIGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UgPSBvcy5zaG93Q29uZmlybSh7CiAgICAgICAgICAgIHRpdGxlOiAnU2lnbiBJbiBSZXF1aXJlZCcsCiAgICAgICAgICAgIGNvbnRlbnQ6ICdUaGlzIHNlcnZlciBoYXMgYXJ0aWZhY3RzIHRoYXQgd29yayBiZXN0IHdoZW4geW914oCZcmUgc2lnbmVkIGluLiBJZiB5b3UgY29udGludWUgd2l0aG91dCBzaWduaW5nIGluLCB0aGUgYXJ0aWZhY3RzIG1heSBub3Qgc3RheSBpbiBzeW5jLicsCiAgICAgICAgICAgIGNvbmZpcm1UZXh0OiAnU2lnbiBJbicsCiAgICAgICAgICAgIGNhbmNlbFRleHQ6ICdDb250aW51ZSBXaXRob3V0JwogICAgICAgIH0pOwoKICAgICAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UgPSBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlOwogICAgfQoKICAgIGNvbnN0IGNvbmZpcm1lZCA9IGF3YWl0IGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2U7CiAgICBkZWxldGUgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlOwoKICAgIGlmIChjb25maXJtZWQpIHsKICAgICAgICBteUF1dGhCb3QgPSBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwogICAgfSBlbHNlIHsKICAgICAgICBleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSBmYWxzZTsKICAgICAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSAndXNlcl9kZWNsaW5lZF9zaWduX2luJzsKICAgICAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUgPSBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb247CiAgICAgICAgCiAgICAgICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7CiAgICB9Cn0KCmlmICghbXlBdXRoQm90KSB7CiAgICBleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSBmYWxzZTsKICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9ICd1bmtub3duJzsKICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSA9IGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbjsKCiAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKfQoKLy8gY29uc3QgYWRtaW5QZXJtaXNzaW9uUmVzdWx0ID0gYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lKTsKLy8gY29uc29sZS5sb2coYGFkbWluUGVybWlzc2lvblJlc3VsdDpgLCBhZG1pblBlcm1pc3Npb25SZXN1bHQpOwoKLy8gaWYgKGFkbWluUGVybWlzc2lvblJlc3VsdC5zdWNjZXNzKSB7Ci8vICAgICBleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSB0cnVlOwoKLy8gICAgIHJldHVybiBleHBBdXRoUmVzdWx0OwovLyB9IGVsc2UgewovLyAgICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7Ci8vICAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSAndXNlcl9kZWNsaW5lZF9pbnN0X3Blcm1pc3Npb24nOwovLyAgICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlID0gZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uOwoKLy8gICAgIHJldHVybiBleHBBdXRoUmVzdWx0OwovLyB9CgpleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSB0cnVlOwoKcmV0dXJuIGV4cEF1dGhSZXN1bHQ7JwEEYm90cyQ5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMBJwDKrOOACfmzBw5hYkZpbGVUaW1lY29kZQIEAMqs44AJ+rMHZkBjb25zdCBkYXRlOiBEYXRlVGltZSA9IHRoYXQ/LmRhdGUgPz8gRGF0ZVRpbWUubm93KCk7CnJldHVybiBkYXRlLnRvVVRDKCkudG9Gb3JtYXQoJ3l5eXlNTWRkLUhIbW1zcycpOycAyqzjgAn5swcGc3lzdGVtAgQAyqzjgAnhtAcOYWIuc2hlbGwudXRpbHMnAMqs44AJ+bMHDGFiQ29tcGlsZUNTUwIEAMqs44AJ8LQHggRAbGV0IGJvdHMgPSB0aGF0OwoKYm90cyA9IEFycmF5LmlzQXJyYXkoYm90cykgPyBib3RzIDogW2JvdHNdOwoKbGV0IGNzcyA9IFtdOwoKZm9yIChsZXQgYm90IG9mIGJvdHMpIHsKICAgIGZvciAobGV0IGtleSBpbiBib3QudGFncykgewogICAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnY3NzJykpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgQ1NTIGtleTogJHtrZXl9YCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3NzLnB1c2goYm90LnRhZ3Nba2V5XSk7CiAgICAgICAgfQogICAgfQp9Cgpjb25zdCBjb21waWxlZCA9IGNzcy5qb2luKCdcblxuJyk7CmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNvbXBpbGVkIENTUzpcblxuYCwgY29tcGlsZWQpOwp9CgpyZXR1cm4gY29tcGlsZWQ7JwDKrOOACfmzBwhhYklnbm9yZQIEAMqs44AJ87gHBHRydWUnAMqs44AJ+bMHB2FiU2hlbGwCBADKrOOACfi4BwR0cnVlJwDKrOOACfmzBwlhYlZlcnNpb24CBADKrOOACf24BwQxMC42JwDKrOOACfmzBw1hYkxvZ0FuZFRvYXN0AgQAyqzjgAmCuQezCkBsZXQgbWVzc2FnZTsKbGV0IGR1cmF0aW9uOwpsZXQgbG9nVHlwZSA9ICdsb2cnOwpsZXQgdG9hc3QgPSB0cnVlOwoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgbWVzc2FnZSA9IHRoYXQ7CiAgICBkdXJhdGlvbiA9IHRoaXNCb3QuZXN0aW1hdGVSZWFkaW5nVGltZSh7IHRleHQ6IHRoYXQsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDA7Cn0gZWxzZSB7CiAgICBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uID8/ICh0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0Lm1lc3NhZ2UsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDApOwogICAgbG9nVHlwZSA9IHRoYXQubG9nVHlwZSA/PyBsb2dUeXBlOwogICAgdG9hc3QgPSB0aGF0LnRvYXN0ID8/IHRvYXN0Owp9CgppZiAobG9nVHlwZSA9PT0gJ2xvZycpIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnd2FybmluZycgfHwgbG9nVHlwZSA9PT0gJ3dhcm4nKSB7CiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogV2FybmluZzogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS53YXJuKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QoYFdhcm5pbmc6ICR7bWVzc2FnZX1gLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ2Vycm9yJykgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6IEVycm9yOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmVycm9yKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QoYEVycm9yOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9JwDKrOOACfmzBwhyZW1lbWJlcgIEAMqs44AJtsMHKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMqs44AJ+bMHBWFiTG9nAgQAyqzjgAndwwfHAUBpZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICB0aGlzQm90LmFiTG9nQW5kVG9hc3QoewogICAgICAgIG1lc3NhZ2U6IHRoYXQsCiAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgfSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LmFiTG9nQW5kVG9hc3QoewogICAgICAgIC4uLnRoYXQsCiAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgfSk7Cn0nAMqs44AJ+bMHE2VzdGltYXRlUmVhZGluZ1RpbWUCBADKrOOACaXFB9wDQGNvbnN0IHsKICAgIHRleHQgPSAnJywKICAgIHdvcmRzUGVyTWludXRlID0gMjUwLAogICAgZGVsYXlUaW1lID0gNTAwLAp9ID0gdGhhdDsKCi8vIENvdW50IHdvcmRzIChyb3VnaCBhcHByb3hpbWF0aW9uIGJ5IHNwbGl0dGluZyBvbiB3aGl0ZXNwYWNlKQpjb25zdCB3b3JkQ291bnQgPSB0ZXh0LnRyaW0oKS5zcGxpdCgvXHMrLykubGVuZ3RoOwpsZXQgdG90YWxUaW1lTXMgPSAwOwoKaWYgKHdvcmRDb3VudCA+IDApIHsKICAgIC8vIENhbGN1bGF0ZSByZWFkaW5nIHRpbWUgaW4gbWlsbGlzZWNvbmRzCiAgICBjb25zdCB3b3Jkc1BlclNlY29uZCA9IHdvcmRzUGVyTWludXRlIC8gNjA7CiAgICBjb25zdCByZWFkaW5nVGltZU1zID0gTWF0aC5jZWlsKCh3b3JkQ291bnQgLyB3b3Jkc1BlclNlY29uZCkgKiAxMDAwKTsKCiAgICB0b3RhbFRpbWVNcyA9IHJlYWRpbmdUaW1lTXMgKyBkZWxheVRpbWU7Cn0KCnJldHVybiB0b3RhbFRpbWVNczsnAMqs44AJ+bMHCGlzT2JqZWN0AgQAyqzjgAmCyQc5QHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkodGhhdCk7JwDKrOOACfmzBwdpc0FycmF5AgQAyqzjgAm8yQccQHJldHVybiBBcnJheS5pc0FycmF5KHRoYXQpOycAyqzjgAn5swcIaXNTdHJpbmcCBADKrOOACdnJByFAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJzsnAMqs44AJ+bMHD2dldEVycm9yTWVzc2FnZQIEAMqs44AJ+8kHwAJAZnVuY3Rpb24gZ2V0RXJyb3JNZXNzYWdlKGVycm9yKSB7CiAgICBpZiAoZXJyb3IpIHsKICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlKSB7CiAgICAgICAgICAgIHJldHVybiBlcnJvci5tZXNzYWdlOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IuZXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yTWVzc2FnZShlcnJvci5lcnJvcik7CiAgICAgICAgfQogICAgfQp9CgpyZXR1cm4gZ2V0RXJyb3JNZXNzYWdlKHRoYXQpOycBBGJvdHMkZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1AScAyqzjgAm8zAcGc3lzdGVtAgQAyqzjgAm9zAcPYWIuc2hlbGwuc2VhcmNoJwDKrOOACbzMBwRmb3JtAgQAyqzjgAnNzAcHbm90aGluZycAyqzjgAm8zAcOYWJSZXRyaWV2ZUZpbGUCBADKrOOACdXMB4IBQC8vcHVsbCBkb3duIGZpbGUgZGF0YQppZiAoIXRoYXQudXJsKQp7CiAgICByZXR1cm4gIm5vIGZpbGUgdXJsIHN1cHBsaWVkIjsKfQoKbGV0IGRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKHRoYXQudXJsKTsKCnJldHVybiBkYXRhOycAyqzjgAm8zAcQYWJSZXRyaWV2ZVJlY29yZAIEAMqs44AJ2M0H7ARALy9yZXRyaWV2ZSBzcGVjaWZpZWQgcmVjb3JkCmxldCByZWNvcmROYW1lID0gdGhhdC5yZWNvcmROYW1lOwoKbGV0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CgppZiAodGhhdC5yZWNvcmRLZXkpCnsKICAgIHJlY29yZEtleSA9IHRoYXQucmVjb3JkS2V5Owp9CmVsc2UgaWYgKGF1dGhCb3QpCnsKICAgIGlmIChhdXRoQm90LmlkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbykKICAgIHsKICAgICAgICByZWNvcmRLZXkgPSBhdXRoQm90LmlkOwoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgIH0KfQoKbGV0IHJlY29yZEVuZHBvaW50ID0gdGhhdC5yZWNvcmRFbmRwb2ludCA/IHRoYXQucmVjb3JkRW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CgppZiAoIXJlY29yZE5hbWUpCnsKICAgIHJldHVybiAibm8gcmVjb3JkIG5hbWUgc3VwcGxpZWQiOwp9CgpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIHJlY29yZE5hbWUsIHJlY29yZEVuZHBvaW50KTsKCi8vQUREIGFkZGl0aW9uYWwgZXJyb3IgaGFuZGxpbmc/CgpyZXR1cm4gZ2V0UmVjb3JkOycAyqzjgAm8zAcIcmVtZW1iZXICBADKrOOACcXSByjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDKrOOACbzMBw1tYW5pZmVzdGF0aW9uAgQAyqzjgAns0gco8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAyqzjgAm8zAcOb25Mb29rdXBBQkVnZ3MCBADKrOOACZPTB44xQGNvbnN0IHsgCiAgICBhYklELAogICAgYWJWZXJzaW9uLAogICAgaW5pdGlhbEJvb3QsCiAgICBhdXRvSGF0Y2gsCiAgICByZXR1cm5UeXBlLAogICAgZWdnUGFyYW1ldGVycywKICAgIGtleSA9IGNvbmZpZ0JvdC50YWdzLmtleSwKICAgIHRvYXN0ID0gdHJ1ZSwKICAgIHNob3dJbmRpY2F0b3IgPSB0cnVlLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsIC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQp9ID0gdGhhdDsKCmxldCB7CiAgICByZWNvcmRLZXkgPSBjb25maWdCb3QudGFncy5zdHVkaW8sCn0gPSB0aGF0OwoKYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBsb2FkaW5nICIgKyBhYklEKTsKCi8vY2xlYXIgYWItMQppZiAobGlua3MubWFuaWZlc3RhdGlvbiAmJiBjb25maWdCb3QudGFncy5tZW51UG9ydGFsID09ICJhYk1lbnUiKSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfQoKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvYWRpbmcgJHthYklEfWB9KTsKfQoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKbGV0IGVnZ0RhdGE7CgovL3RoaXMgbG9naWMgaGFuZGxlcyB0aGUgcmV0cmlldmVkIGRhdGEsIHNlYXJjaGVzIGFnYWluIGlmIG5vbmUgY2FtZSB0aHJvdWdoCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmIChwb3NzaWJsZUF1dGguaWQgPT0gcmVjb3JkS2V5ICYmCiAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSAmJgogICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJyZWNvcmRfbm90X2ZvdW5kIgogICAgKSB7CiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIikgewogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CiAgICB9IGVsc2UgaWYgKGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfbG9nZ2VkX2luIikgewogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgogICAgICAgIGlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MgJiYgCiAgICAgICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfYXV0aG9yaXplZCIKICAgICAgICApIHsKICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICAgICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgICAgICB9CiAgICB9Cn0KCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmICh0b2FzdCkgeyAKICAgICAgICBvcy50b2FzdChgbm8gZGF0YSBmb3VuZCBpbiAke2FiSUR9YCk7CiAgICB9CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICB9CgogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQplbHNlIHsKICAgIGNvbnN0IHB1YmxpY1JlYWRUZXN0ID0gZ2V0UmVjb3JkLm1hcmtlcnMuaW5kZXhPZigicHVibGljUmVhZCIpOwogICAgY29uc3QgYXV0aG9yID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCiAgICBpZiAocHVibGljUmVhZFRlc3QgIT0gLTEgJiYgYXV0aG9yKSB7CiAgICAgICAgaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGVnZ0hhdGNoRXZlbnQgPSBhYklEOwoKICAgICAgICAgICAgb3MucmVjb3JkRXZlbnQobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgZWdnSGF0Y2hFdmVudCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vcGFja2FnZSB0aGUgcmVjb3JkIGRhdGEKICAgIGVnZ0RhdGEgPSBnZXRSZWNvcmQuZGF0YTsKCiAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgLy8gQ2hhbmdlIGluaXRpYWwgdGFyZ2V0IHZlcnNpb24gb2YgdGhlIGVnZyBpZiBhYlZlcnNpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gYWJWZXJzaW9uOwogICAgfQp9CgpsaW5rcy51dGlscy5hYkxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgYWJJRCArICIgbG9hZGVkLCB2ZXJzaW9uICIgKyBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgZ2V0UmVjb3JkLmRhdGEubWF4VmVyc2lvbik7CgppZiAocmV0dXJuVHlwZSAhPSBudWxsKSB7CiAgICBpZiAoZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGxldCB2ZXJzaW9uID0gZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiAtIDE7CgogICAgICAgICAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKGFiVmVyc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gYWJWZXJzaW9uIC0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgICAgICAgICBjb25zdCByZXR1cm5EYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShlZ2dEYXRhVVJMKTsKCiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0dXJuRGF0YTsKICAgICAgICB9IGVsc2UgaWYgKHJldHVyblR5cGUgPT09ICJlZ2ciKSB7CiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKGVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkpOwogICAgICAgICAgICBjb25zdCBmaWxlVVVJRCA9IHZlcnNpb25BcnJheVtlZ2dEYXRhLm1heFZlcnNpb24gLSAxXTsKICAgICAgICAgICAgY29uc3QgZmlsZW5hbWVoYXNoTFRNID0gY3J5cHRvLnNoYTI1NihmaWxlVVVJRCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGV1cmxoYXNoTFRNID0gImF1eF8iICsgZmlsZW5hbWVoYXNoTFRNICsgJy5hdXgnOwogICAgICAgICAgICBjb25zdCB0YXJnZXRMVE1VUkwgPSAiaHR0cHM6Ly9idWlsZGVyLWx0bS1maWxlcy5zMy5hbWF6b25hd3MuY29tLyIgKyBmaWxldXJsaGFzaExUTTsKICAgICAgICAgICAgY29uc3QgbyA9IHsKICAgICAgICAgICAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgICAgICAgICAgICB1cmw6IHRhcmdldExUTVVSTAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbGV0IGZpbGVHZXQgPSBhd2FpdCB3ZWJob29rKG8pOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5tYW5pZmVzdE92byh7CiAgICBhYklELAogICAgc3R1ZGlvOiByZWNvcmRLZXksCiAgICBkaW1Nb2QsCiAgICBzcGFjZU1vZCwKICAgIGVnZ0RhdGEsCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwKfSk7CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBoYXRjaGVkQm90czogbWFuaWZlc3RSZXN1bHQ/LmhhdGNoZWRCb3RzLAp9OycAyqzjgAm8zAcLbWFuaWZlc3RPdm8CBADKrOOACaKECLUPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCmlmIChsaW5rcy5vdm9Cb3QpIHsKICAgIGRlc3Ryb3kobGlua3Mub3ZvQm90KTsKfQoKbGV0IGVnZ01vZCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGluaXRpYWxUaW1lcjogdHJ1ZSwKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBzb3VyY2VFdmVudCwKICAgIGN1cnNvcjogJ3BvaW50ZXInLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5pbnRlcmFjdE92bygpOwogICAgYCwKICAgIGZvcm06ICJlZ2ciLAogICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICBwcm9ncmVzc0JhckNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yLAogICAgcHJvZ3Jlc3NCYXJCYWNrZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNSwKICAgIG9uUG9pbnRlckVudGVyOiBgQAogICAgICAgIG1hc2tzLnRpcElkID0gYXdhaXQgb3MudGlwKHRhZ3MuYWJJRCArICcgdicgKyB0YWdzLnRhcmdldFZlcnNpb24pOwogICAgYCwKICAgIG9uUG9pbnRlckV4aXQ6IGBACiAgICAgICAgaWYgKG1hc2tzLnRpcElkKSB7CiAgICAgICAgICAgIG9zLmhpZGVUaXBzKG1hc2tzLnRpcElkKTsKICAgICAgICB9CiAgICBgLAogICAgbGFiZWxQb3NpdGlvbjogImZyb250IiwKICAgIG9yaWVudGF0aW9uTW9kZTogImJpbGxib2FyZEZyb250IiwKICAgIG9uRGVzdHJveTogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLm1hc2tzLm92b0JvdCA9IG51bGw7CiAgICBgLAogICAgZWdnVGltZXI6IGBACiAgICAgICAgaWYgKHRhZ3MucHJvZ3Jlc3NCYXIgPCAxKSB7CiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgKz0gMC4xOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7d2hpc3Blcih0aGlzQm90LCAiZWdnVGltZXIiKTt9LCA3NSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5vbkNsaWNrKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyID0gbnVsbDsKICAgICAgICB9CiAgICBgCn07CgoKY29uc3Qgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7Cm1hc2tzLm92b0JvdCA9IGdldExpbmsob3ZvKTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsKfQoKaWYgKG92by50YWdzLmF1dG9IYXRjaCkgewogICAgY29uc3QgaGF0Y2hlZEJvdHMgPSBhd2FpdCB0aGlzQm90LmhhdGNoT3ZvKG92byk7CiAgICByZXR1cm4geyBoYXRjaGVkQm90cyB9Owp9CmVsc2UgewogICAgb3ZvLnRhZ3MucHJvZ3Jlc3NCYXIgPSAwOwogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG92by50YWdzLm1heFZlcnNpb247CiAgICBzZXRUaW1lb3V0KCgpID0+IHsgd2hpc3Blcihvdm8sICJlZ2dUaW1lciIpOyB9LCA3NSk7Cn0nAMqs44AJvMwHCW9uS2V5RG93bgIEAMqs44AJ2JMIggZALy9oaWRkZW4gdmVyc2lvbiBidXR0b24gZm9yIGhhdGNoIG1lbnUKaWYgKCFsaW5rcy5vdm9Cb3QgfHwgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCAhPSAiYWJPdm9NZW51IikKewogICAgcmV0dXJuOwp9CgppZiAodGhhdC5rZXlzID09ICJTaGlmdCIpCnsKICAgIGxldCB2ZXJzaW9uQnV0dG9uID0ge307CgogICAgdmVyc2lvbkJ1dHRvbi5hYk92b01lbnUgPSB0cnVlOwogICAgdmVyc2lvbkJ1dHRvbi5vdm9Tb3J0T3JkZXIgPSAtMTsKICAgIHZlcnNpb25CdXR0b24ubWF4VmVyc2lvbiA9IGxpbmtzLm92b0JvdC50YWdzLm1heFZlcnNpb247CiAgICB2ZXJzaW9uQnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwogICAgdmVyc2lvbkJ1dHRvbi5sYWJlbCA9ICJjaGFuZ2UgZWdnIHZlcnNpb24iOwogICAgdmVyc2lvbkJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJjZW50ZXIiOwogICAgdmVyc2lvbkJ1dHRvbi5vdm9NZW51UmVzZXQgPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CiAgICB2ZXJzaW9uQnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvcjsKICAgIHZlcnNpb25CdXR0b24ub25LZXlVcCA9ICJAIGlmKHRoYXQua2V5cyA9PSAnU2hpZnQnKXtkZXN0cm95KHRoaXNCb3QpfTsiOwogICAgdmVyc2lvbkJ1dHRvbi5vbkNsaWNrID0gIkAgbGlua3MubWFuYWdlci5jaGFuZ2VPdm9WZXJzaW9uKCk7IjsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih2ZXJzaW9uQnV0dG9uKTsKfScAyqzjgAm8zAcIaGF0Y2hPdm8CBADKrOOACdmZCJ0VQC8vbG9naWMgZm9yIGhhdGNoaW5nIG9mIGFuIGFiCnNob3V0KCdvdm9NZW51UmVzZXQnKTsKCi8vZGF0YSBpbiByZWdhcmRzIHRvIHdoYXQgYWIgaXMgZ29pbmcgdG8gYmUgaGF0Y2hlZApjb25zdCBvdm8gPSB0aGF0OwoKLy9oYXRjaCBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGluaXRpYWxCb290ID0gb3ZvLnRhZ3MuaW5pdGlhbEJvb3Q7CmxldCB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiA/PyBvdm8udGFncy50YXJnZXRWZXJzaW9uOwoKaWYgKChjb25maWdCb3QudGFncy5hYlZlcnNpb24gfHwgY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb24pICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy5hYlZlcnNpb24gPz8gY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb247Cn0KCi8vdGFyZ2V0ZWQgdmVyc2lvbnMKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiIHx8ICFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkpCnsKICAgIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJmZWVkYmFjayIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmZlZWRiYWNrVmVyc2lvbjsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImN1cnJlbnQiKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICB9CiAgICBlbHNlIGlmICghaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnZlcnNpb24KICAgIH0KCiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gbnVsbDsKfQoKaWYgKGlzTmFOKHRhcmdldFZlcnNpb24pKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwp9CgpsZXQgdmVyc2lvbkFycmF5ID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3Rvcnk7CmxldCBmaWxlVVJMID0gdmVyc2lvbkFycmF5W3RhcmdldFZlcnNpb24gLSAxXTsKbGV0IGtleSA9IG92by50YWdzLmtleSA/IG92by50YWdzLmtleSA6IGNvbmZpZ0JvdC50YWdzLmtleTsKbGV0IGZpbGVHZXQ7CgovL2FjdHVhbCBmaWxlIHJldHJpZXZhbAp0cnkKewogICAgZmlsZUdldCA9IGF3YWl0IG9zLmdldEZpbGUoZmlsZVVSTCk7Cn0KY2F0Y2ggKGUpCnsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdubyBmaWxlIGZvdW5kJyk7CgogICAgcmV0dXJuOwp9CgovL2hhbmRsaW5nIGZvciBlbmNyeXB0ZWQgYWIgZmlsZQppZiAoY3J5cHRvLmlzRW5jcnlwdGVkKGZpbGVHZXQpKQp7CiAgICBpZiAoIWtleSkKICAgIHsKICAgICAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoJycsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnRW50ZXIga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGZpbGVHZXQgPSBjcnlwdG8uZGVjcnlwdChrZXksIGZpbGVHZXQpOwoKICAgIGlmIChmaWxlR2V0ID09IG51bGwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdpbmNvcnJlY3Qga2V5Jyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAKICAgIGZpbGVHZXQgPSBKU09OLnBhcnNlKGZpbGVHZXQpOwogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KZWxzZQp7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQoKLy9jbGVhbiB1cApkZXN0cm95KG92byk7CgovL3RvYXN0IGlmIG5vdCBvbiBzdGFibGUKaWYob3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiAhPSB0YXJnZXRWZXJzaW9uICYmICFjb25maWdCb3QudGFncy5hYlNpbGVudCkKewogICAgaWYgKG92by50YWdzLmZlZWRiYWNrVmVyc2lvbiA9PSB0YXJnZXRWZXJzaW9uKQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIGZlZWRiYWNrIHZlcnNpb24gb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIHZlcnNpb24gIiArIHRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggKyAiIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KfQoKLy9nZW5lcmF0ZSBib3RzIGJhc2VkIG9uIHRoZSBmaWxlIHJldHJpZXZlZCAqSEVSRSoKY29uc3QgbmV3Qm90cyA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoewogICAgYm90czogZmlsZUdldCwKICAgIG9yaWdpbjogb3ZvLnRhZ3MuYWJJRCwKICAgIHN0dWRpbzogb3ZvLnRhZ3Muc3R1ZGlvLAogICAgdmVyc2lvbjogdGFyZ2V0VmVyc2lvbiwKICAgIGluaXRpYWxCb290OiBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnM6IG92by50YWdzLmVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50OiBvdm8udGFncy5zb3VyY2VFdmVudCwKfSk7CgpyZXR1cm4gbmV3Qm90czsnAMqs44AJvMwHC2ludGVyYWN0T3ZvAgQAyqzjgAn3rgjpBkAvL21hbnVhbCBoYXRjaCBtZW51CmNvbnN0IG92b0JvdCA9IHRoYXQgPyB0aGF0IDogbGlua3Mub3ZvQm90OwoKaWYgKCFvdm9Cb3QpIHsKICAgIHJldHVybjsKfQoKc2hvdXQoIm92b01lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJPdm9NZW51IjsKCm1hc2tzLm9uR3JpZENsaWNrID0gYEAKICAgIHNob3V0KCJvdm9NZW51UmVzZXQiKTsKYDsKbWFza3Mub3ZvTWVudVJlc2V0ID0gYEAKICAgIG1hc2tzLm9uR3JpZENsaWNrID0gbnVsbDsKICAgIG1hc2tzLm92b01lbnVSZXNldCA9IG51bGw7CgogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKb3MudHdlZW5Ubyhvdm9Cb3QsIDE1LDQ1LDQ1LCA1KTsKCmNvbnN0IGVnZ01lbnVCdXR0b24gPSB7CiAgICBhYk92b01lbnU6IHRydWUsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb3ZvQm90OiBnZXRMaW5rKG92b0JvdCksCiAgICBjb2xvcjogYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgdGFyZ2V0VmVyc2lvbjogb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwKICAgIGxhYmVsOiBgaGF0Y2ggJHtvdm9Cb3QudGFncy5hYklEfSB2JHtvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9ufSBvZiAke292b0JvdC50YWdzLm1heFZlcnNpb259YCwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIG92b01lbnVSZXNldDogYEAKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgYCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOwogICAgYCwKfTsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGVnZ01lbnVCdXR0b24pOycAyqzjgAm8zAcGY3JlYXRlAgQAyqzjgAnhtQgo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAyqzjgAm8zAcQY2hhbmdlT3ZvVmVyc2lvbgIEAMqs44AJiLYI8AJALy9sb2dpYyBmb3IgdmVyc2lvbiBjaGFuZ2luZyB3aGVuIG1hbnVhbGx5IGhhdGNoaW5nIGFuIGFiCmNvbnN0IG92b0JvdCA9IGxpbmtzLm92b0JvdDsKCmxldCBuZXdWZXJzaW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sIHsKICAgIHBsYWNlaG9sZGVyOiAiZW50ZXIgYSB2ZXJzaW9uIGZyb20gMSB0byAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbgp9KTsKCm92b0JvdC50YWdzLnRhcmdldFZlcnNpb24gPSBuZXdWZXJzaW9uOwpvdm9Cb3QudGFncy5sYWJlbCA9ICd2JysgbmV3VmVyc2lvbjsKCmNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBuZXdWZXJzaW9uOwoKc2hvdXQoIm92b01lbnVSZXNldCIpOycAyqzjgAm8zAcEbWVudQIEAMqs44AJ+bgIKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAMqs44AJvMwHCGFiSWdub3JlAgQAyqzjgAmguQgEdHJ1ZScAyqzjgAm8zAcHYWJTaGVsbAIEAMqs44AJpbkIBHRydWUnAMqs44AJvMwHDGFiMUxUTVNlYXJjaAIEAMqs44AJqrkIM0AvL3N1cHBvcnQgb2xkIHN5bnRheAp0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOycAyqzjgAm8zAcNb25Mb29rdXBBc2tJRAIEAMqs44AJ3rkImB5AY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsKY29uc3Qgc2hvd0luZGljYXRvciA9IHRoYXQ/LnNob3dJbmRpY2F0b3IgPz8gdHJ1ZTsKY29uc3QgY2hhbm5lbENvbmZpZyA9IHRoYXQ/LmNoYW5uZWxDb25maWc7CmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOwpjb25zdCBlZ2dQYXJhbWV0ZXJzID0gdGhhdD8uZWdnUGFyYW1ldGVyczsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwoKYXNzZXJ0KHR5cGVvZiBhc2tJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvb2tpbmcgdXAgJHthc2tJRH1gIH0pOwp9CgovLyBGaXJzdCBjaGVjayB0aGUgY2FzdWFsIGNhdGFsb2cgZm9yIHRoZSBhc2suCmNvbnN0IGNhc3VhbENhdGFsb2dVUkwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2Fza3MvJHthc2tJRH0uYXV4YCk7Cgp0cnkgewogICAgY29uc3QgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICdHRVQnLCB1cmw6IGNhc3VhbENhdGFsb2dVUkwgfSk7CgogICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgIGlmIChjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAxICYmIGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnN0YXRlKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjEgYXV4IGZpbGUuCiAgICAgICAgICAgIGNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90czogY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUsIGlnbm9yZUdyaWRGb2N1czogdHJ1ZSwgb3JpZ2luOiBhc2tJRCwgZWdnUGFyYW1ldGVycywgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCBzb3VyY2VFdmVudCB9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycsCiAgICAgICAgICAgICAgICBoYXRjaGVkQm90czogbmV3Qm90cywKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiAmJiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS51cGRhdGVzKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjIgYXV4IGZpbGUuCiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXNrcyBvbmx5IHN1cHBvcnQgdjEgYXV4IGZpbGUgZm9ybWF0LmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UuCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgYXNrIHJlc3BvbnNlLmAsIGNhc3VhbENhdGFsb2dSZXNwb25zZSk7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS4gQ2hlY2sgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsb29rdXBBc2s7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIERpZCBub3QgZmluZCBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuCn0KCi8vIENoZWNrIHRoZSBhYiByZWNvcmQgZm9yIHRoZSBhc2suCmNvbnN0IGFiRm9ybWF0dGVkQXNrSUQgPSBhc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwoKdHJ5IHsKICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYGFza18ke2FiRm9ybWF0dGVkQXNrSUR9YCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsKfSBjYXRjaCB7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiRm9ybWF0dGVkQXNrSUQsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludCk7Cn0KCmxvb2t1cEFzay5vcmlnaW4gPSAnYWJfcmVjb3JkJzsKCmlmIChjaGFubmVsQ29uZmlnKSB7CiAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICB9CgogICAgcmV0dXJuIGxvb2t1cEFzazsKfSBlbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiBsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQpIHsKICAgIGlmIChsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA9PSAiQUIiKSB7CiAgICAgICAgLy8gUnlhbiBDb29rOiBUaGlzIGFwcGVhcnMgdG8gYmUgc29tZXRoaW5nIG5lZWRlZCBieSBhYkNoYW5uZWxzLgogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQobG9va3VwQXNrLmRhdGEucGF0dGVybklEKTsKCiAgICAgICAgc2hvdXQoIm9uQUJJbml0aWFsaXplZCIpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBMb29rdXAgdGhlIGVnZyB1c2luZyB0aGUgc3R1ZGlvSUQgYW5kIHBhdHRlcm5JRCBmcm9tIHRoZSBhYl9yZWNvcmQgYXNrLgogICAgICAgIGNvbnN0IGxvb2t1cEVnZzogQUJMb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogbG9va3VwQXNrLmRhdGEucGF0dGVybklELCByZWNvcmRLZXk6IGxvb2t1cEFzay5kYXRhLnN0dWRpb0lELCBhdXRvSGF0Y2gsIGVnZ1BhcmFtZXRlcnMsIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgc291cmNlRXZlbnQgfSk7CiAgICAgICAgCiAgICAgICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBsb29rdXBFZ2cuc3VjY2VzczsKICAgICAgICBsb29rdXBBc2suaGF0Y2hlZEJvdHMgPSBsb29rdXBFZ2cuaGF0Y2hlZEJvdHM7CiAgICB9Cn0gZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgIWxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCAmJiAhbG9va3VwQXNrLmRhdGEudXJsKSB7CiAgICBsb29rdXBBc2suc3VjY2VzcyA9IGZhbHNlOwp9CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIGxvb2t1cEFzazsnAMqs44AJvMwHBXR5cGVzAgQAyqzjgAn31wj2AfCfk4R0eXBlIEFCQXNrSURPcmlnaW4gPSAnY2FzdWFsX2NhdGFsb2cnIHwgJ2FiX3JlY29yZCc7CgppbnRlcmZhY2UgQUJMb29rdXBBc2tJRFJlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuOwogICAgb3JpZ2luOiBBQkFza0lET3JpZ2luOwogICAgaGF0Y2hlZEJvdHM/OiBCb3RbXTsKfQoKaW50ZXJmYWNlIEFCTG9va3VwRWdnUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW4sCiAgICBoYXRjaGVkQm90cz86IEJvdFtdLAp9CicAyqzjgAm8zAcFaW5wdXQCBADKrOOACezZCCjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDKrOOACbzMBwVoYXRjaAIEAMqs44AJk9oIwAFALy9zaG91dCgiaGF0Y2giLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGtleToga2V5LCBhdXRvSGF0Y2g6IGJvb2xlYW4sIHJldHVyblR5cGU6IGRhdGEvbnVsbCwgZWdnUGFyYW1ldGVyczogYXJnfSk7Cgpjb25zdCBsb29rVXAgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOwoKcmV0dXJuIGxvb2tVcDsnAMqs44AJvMwHCWFiVmVyc2lvbgIEAMqs44AJ1NsIBDEwLjYnAMqs44AJvMwHBWxlYXJuAgQAyqzjgAnZ2wgo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAyqzjgAm8zAcFdXRpbHMCBADKrOOACYDcCCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDKrOOACbzMBwtwZXJzb25hbGl0eQIEAMqs44AJp9wIKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJGY4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMAEnAMqs44AJztwIBnN5c3RlbQIEAMqs44AJz9wIDmFiLnNoZWxsLmlucHV0JwDKrOOACc7cCARmb3JtAgQAyqzjgAne3AgHbm90aGluZycAyqzjgAnO3AgJb25LZXlEb3duAgQAyqzjgAnm3Aj6CkBjb25zdCB7IGtleXMgfSA9IHRoYXQ7CgppZiAobWFza3MuY2hhdE9wZW4pIHsKICAgIGNvbnN0IGVzYyA9IHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJyk7CgogICAgaWYgKGVzYykgewogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYXJyb3dVcCA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dVcCcpOwogICAgICAgIGNvbnN0IGFycm93RG93biA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dEb3duJyk7CiAgICAgICAgCiAgICAgICAgaWYgKGFycm93VXAgfHwgYXJyb3dEb3duKSB7CiAgICAgICAgICAgIC8vIElmIEFycm93VXAgb3IgQXJyb3dEb3duIGFyZSBwcmVzc2VkIHdoaWxlIHRoZSBhYiBjaGF0IGJhciBpcyBvcGVuIHRoZW4KICAgICAgICAgICAgLy8gc3RhcnQgY29tYmluZyB0aHJvdWdoIGNoYXQgaGlzdG9yeS4KICAgICAgICAgICAgY29uc3QgZGlyID0gYXJyb3dVcCA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ICsgZGlyOwogICAgICAgICAgICBsZXQgaGlzdG9yaWNhbFRleHQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBoaXN0b3JpY2FsVGV4dCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeVtpbmRleF07CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPj0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgY2hhdCBiYXIuCiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKHsgcHJlZmlsbDogaGlzdG9yaWNhbFRleHQgfSk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgY29uc3QgYmFja3RpY2sgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ2AnKSB8fCB0aGF0LmtleXMuaW5jbHVkZXMoIkRlYWQiKTsKCiAgICBpZiAoYmFja3RpY2spIHsKICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgIH0KfQonAMqs44AJztwIBm9uQ2hhdAIEAMqs44AJ4ecIihhALy8gTm90IHN1cHBvcnRlZCBvdXRzaWRlIG9mIGJ1aWxkZXIgdmVyc2lvbgppZiAoIWJ1aWxkZXJWZXJzaW9uKSB7CiAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICByZXR1cm47Cn0KCmlmICghdGhhdC5tZXNzYWdlKSB7CiAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICByZXR1cm47Cn0KCi8vIEFwcGVuZCBtZXNzYWdlIHRvIGNoYXQgaGlzdG9yeSBhbmQgdXBkYXRlIHRoZSBjdXJyZW50IGhpc3RvcnkgaW5kZXguCnRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5wdXNoKHRoYXQubWVzc2FnZSk7CnRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwoKLy8gRnVuY3Rpb24gdG8gcGFyc2UgYXJndW1lbnRzIHdpdGggcXVvdGUgc3VwcG9ydCBhbmQgZXJyb3IgaGFuZGxpbmcKLy8gRXhhbXBsZXM6IAovLyAgICdhcmcxIGFyZzInIC0+IFsnYXJnMScsICdhcmcyJ10KLy8gICAnImFyZyB3aXRoIHNwYWNlcyIgYXJnMicgLT4gWydhcmcgd2l0aCBzcGFjZXMnLCAnYXJnMiddCi8vICAgJyJ1bmNsb3NlZCBxdW90ZScgLT4gdGhyb3dzIEVycm9yCmZ1bmN0aW9uIHBhcnNlQXJndW1lbnRzKGlucHV0KSB7CiAgICBjb25zdCBhcmdzID0gW107CiAgICBsZXQgY3VycmVudEFyZyA9ICcnOwogICAgbGV0IGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICBsZXQgcXVvdGVTdGFydFBvcyA9IC0xOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgY2hhciA9IGlucHV0W2ldOwogICAgICAgIAogICAgICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgaWYgKGNoYXIgPT09IGluc2lkZVF1b3RlcykgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gbnVsbDsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAnXFwnICYmIGkgKyAxIDwgaW5wdXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpKys7IC8vIFNraXAgdGhlIGJhY2tzbGFzaAogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBpbnB1dFtpXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gY2hhcjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgICAgICBpbnNpZGVRdW90ZXMgPSBjaGFyOwogICAgICAgICAgICAgICAgcXVvdGVTdGFydFBvcyA9IGk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJyAnKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEFyZy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGN1cnJlbnRBcmcpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgPSAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gY2hhcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKGluc2lkZVF1b3RlcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5jbG9zZWQgcXVvdGU6IGZvdW5kIG9wZW5pbmcgJHtpbnNpZGVRdW90ZXN9IGF0IHBvc2l0aW9uICR7cXVvdGVTdGFydFBvc30gYnV0IG5vIGNsb3NpbmcgcXVvdGVgKTsKICAgIH0KICAgIAogICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgIH0KICAgIAogICAgcmV0dXJuIGFyZ3M7Cn0KCmlmICh0aGF0Lm1lc3NhZ2VbMF0gPT0gIi4iKSB7CiAgICBjb25zdCBjb21tYW5kUGFydCA9IHRoYXQubWVzc2FnZS5zdWJzdHJpbmcoMSk7IC8vIFJlbW92ZSB0aGUgZG90CiAgICBjb25zdCBzcGFjZUluZGV4ID0gY29tbWFuZFBhcnQuaW5kZXhPZignICcpOwogICAgCiAgICBsZXQgY21kLCBhcmdzOwogICAgaWYgKHNwYWNlSW5kZXggPT09IC0xKSB7CiAgICAgICAgLy8gTm8gYXJndW1lbnRzCiAgICAgICAgY21kID0gY29tbWFuZFBhcnQ7CiAgICAgICAgYXJncyA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSGFzIGFyZ3VtZW50cwogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0LnN1YnN0cmluZygwLCBzcGFjZUluZGV4KTsKICAgICAgICBjb25zdCBhcmdzU3RyaW5nID0gY29tbWFuZFBhcnQuc3Vic3RyaW5nKHNwYWNlSW5kZXggKyAxKTsKICAgICAgICAKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VBcmd1bWVudHMoYXJnc1N0cmluZyk7CiAgICAgICAgICAgIGFyZ3MgPSBwYXJzZWRBcmdzLmxlbmd0aCA/IHBhcnNlZEFyZ3MgOiB1bmRlZmluZWQ7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBFcnJvciBwYXJzaW5nIGNvbW1hbmQgYXJndW1lbnRzOiAke2Vycm9yLm1lc3NhZ2V9YCwgbG9nVHlwZTogJ0Vycm9yJyB9KTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIC8vIENyZWF0ZSBhIGZyZXNoIENvbW1hbmRzTWFuYWdlciB3aXRoIGVhY2ggY2FsbCBzbyB0aGF0IHdlIGFsd2F5cyBoYXZlIHRoZSBsYXRlc3QgY29tbWFuZHMgYW5kIGZ1bmN0aW9uYWxpdHkuCiAgICBjb25zdCBhYkNvbW1hbmRzID0gbmV3IEFCQ29tbWFuZHNNYW5hZ2VyKCk7CgogICAgaWYgKGFiQ29tbWFuZHMgJiYgYWJDb21tYW5kcy5oYXNDb21tYW5kKGNtZCkpIHsKICAgICAgICAvLyBDYWxsIGNvbW1hbmQgd2l0aCBhcmdzLgogICAgICAgIGFiQ29tbWFuZHMuY2FsbENvbW1hbmQoY21kLCBhcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRXZhbHVhdGUgY29tbWFuZCBhcyBqYXZhc2NyaXB0LgogICAgICAgIGNvbnN0IGpzID0gdGhhdC5tZXNzYWdlLnN1YnN0cmluZygxKTsKICAgICAgICBvcy5ydW4oanMpOwogICAgfQp9Cgp0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7JwDKrOOACc7cCAtkZXNjcmlwdGlvbgIEAMqs44AJ7P8IQlRoaXMgaXMgbWVhbnQgdG8gaGFuZGxlIGFueSBub25lIG1lbnUgcmVsYXRlZCBpbnB1dHMvaW50ZXJhY3Rpb25zLicAyqzjgAnO3AgMb25GaWxlVXBsb2FkAgQAyqzjgAmvgAnfGUAvL2ZpbHRlciBvdXQgdGltZXMgd2hlbiBmaWxlIGxvYWRpbmcgaXMgbm90IGFsbG93ZWQKaWYgKCFidWlsZGVyVmVyc2lvbiB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiTGlzdGVuaW5nRm9yRmlsZVVwbG9hZHMgIT09IHRydWUpCnsKICAgIHJldHVybjsKfQoKLy92YXJpb3VzIGZpbGUgc3BlY2lmaWMgdmFyaWFibGVzCmxldCBmaWxlRXh0ZW5zaW9uID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CmxldCBzaXplID0gdGhhdC5maWxlLnNpemU7CmxldCBtaW1lVHlwZTsKbGV0IGJvdEluZm8gPSB7fTsKCi8vaGFyZCBsaW1pdCBiYXNlZCBvbiBmaWxlIHNpemUKaWYgKHNpemUgPiAyMDAwMDAwMDApCnsKICBvcy50b2FzdCgibWF4aW11bSBmaWxlIHNpemUgZXhjZWVkZWQgKDIwMCBtYikiKTsKCiAgcmV0dXJuOwp9CgovL3RoaXMgc3dpdGNoIGhhbmRsZXMgcG9zc2libGUgZmlsZXMgZXh0ZW5zaW9ucywgd2hpbGUgcmVqZWN0aW5nIGFueSBpdCBkb2VzIG5vdCByZWNvZ25pemUKc3dpdGNoKGZpbGVFeHRlbnNpb24pCnsKICBjYXNlICdqcGcnOgogIGNhc2UgJ2pwZWcnOgogIGNhc2UgJ3dlYnAnOgogIGNhc2UgJ2dpZic6CiAgY2FzZSAncG5nJzoKICAgIG1pbWVUeXBlID0gImltYWdlLyIgKyBmaWxlRXh0ZW5zaW9uOwogICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICBicmVhazsKICBjYXNlICdzdmcnOgogICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgIGJyZWFrOwogIGNhc2UgJ2dsYic6CiAgY2FzZSAnZXhyJzoKICBjYXNlICdnbHRmJzoKICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgIGJvdEluZm8uZm9ybSA9ICJtZXNoIjsKICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAiZ2x0ZiI7CiAgICBicmVhazsKICBjYXNlICdhdXgnOgogIGNhc2UgJ3BkZic6CiAgICBsZXQgYm90RGF0YSA9IGZpbGVFeHRlbnNpb24gPT0gIi5hdXgiID8gSlNPTi5wYXJzZSh0aGF0LmZpbGUuZGF0YSkuc3RhdGUgOiBvcy5wYXJzZUJvdHNGcm9tRGF0YSh0aGF0LmZpbGUuZGF0YSk7CgogICAgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7Ym90czogYm90RGF0YSwgb3JpZ2luOiBmaWxlTmFtZSwgc291cmNlRXZlbnQ6ICdmaWxlX3VwbG9hZCd9KTsKCiAgICByZXR1cm47Ci8vICAgY2FzZSAncGRmJzoKLy8gICAgIGJyZWFrOwogIGNhc2UgJ21wMyc6CiAgICBtaW1lVHlwZSA9ICdhdWRpby9tcGVnJzsKICAgIGJvdEluZm8ub25DbGljayA9ICJAIG9zLnBsYXlTb3VuZCh0YWdzLmZvcm1BZGRyZXNzKTsiOwogICAgYm90SW5mby5sYWJlbCA9ICJDbGljayB0byBQbGF5IjsKICAgIGJyZWFrOwogIGNhc2UgJ21wNCc6CiAgICBtaW1lVHlwZSA9ICd2aWRlby9tcDQnOwogICAgYm90SW5mby5mb3JtID0gImlmcmFtZSI7CiAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gInNyYyI7CiAgICBicmVhazsKICBjYXNlICdvdGYnOgogICAgbWltZVR5cGUgPSAnZm9udC9vdGYnOwogICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgIGJyZWFrOwogIGNhc2UgJ3dvZmYnOgogICAgbWltZVR5cGUgPSAnZm9udC93b2ZmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBkZWZhdWx0OgogICAgbGV0IHJlc3VsdCA9IG5ldyBFcnJvcigidW5oYW5kbGVkIGZpbGUgdHlwZTogIiArIGZpbGVFeHRlbnNpb24pOwogICAgb3MudG9hc3QoImZpbGUgdHlwZSBub3Qgc3VwcG9ydGVkIik7CiAgICBjb25zb2xlLndhcm4ocmVzdWx0KQogICAgcmV0dXJuIHJlc3VsdDsKfQoKLy90aGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhbmQgb2JqZWN0cyBzZXQgdXAgYSBsb2FkaW5nIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmxldCB1cGxvYWRSZXN1bHQ7CgppZiAoIWxpbmtzLm1lbnUpIHsKICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGB1cGxvYWRpbmdgfSk7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpb0lEID8/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsKCmlmICghY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpCnsKICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cn0KCi8vdGhpcyBpcyB0aGUgYWN0dWFsIHVwbG9hZCBmdW5jdGlvbmFsaXR5CnVwbG9hZFJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEZpbGUoe2ZpbGU6IHRoYXQuZmlsZS5kYXRhLCBmaWxlTmFtZTogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwoKLy9pZiB0aGUgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgYXMgYSBib3Qgd2l0aCBhIGxpbmssIHRoaXMgbG9naWMgaGFuZGxlcyB0aGF0CgppZiAobWltZVR5cGUuaW5jbHVkZXMoImZvbnQiKSkKewogICAgYm90SW5mb1tjb25maWdCb3QudGFncy5ncmlkUG9ydGFsXSA9IHRydWU7CiAgICBib3RJbmZvLmxhYmVsRm9udEFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9CmVsc2UgaWYgKE9iamVjdC5rZXlzKGJvdEluZm8pLmxlbmd0aCA+IDApCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5mb3JtQWRkcmVzcyA9IHVwbG9hZFJlc3VsdC51cmwgPyB1cGxvYWRSZXN1bHQudXJsIDogdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICBjcmVhdGUoYm90SW5mbyk7Cn0KCmNvbnN0IGNsaXBVUkwgPSB1cGxvYWRSZXN1bHQudXJsID8/IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7Cgpvcy5zZXRDbGlwYm9hcmQoY2xpcFVSTCk7Cgpvcy50b2FzdCgiZmlsZSB1cmwgYWRkZWQgc2V0IHRvIGNsaXBib2FyZCIpOwoKLy9jbGVhciB0aGUgcHJvZ3Jlc3MgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHVwbG9hZFJlc3VsdDsnAMqs44AJztwIBWxlYXJuAgQAyqzjgAmPmgko8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAyqzjgAnO3AgIcmVtZW1iZXICBADKrOOACbaaCSjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDKrOOACc7cCA1tYW5pZmVzdGF0aW9uAgQAyqzjgAndmgko8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAyqzjgAnO3AgIYWJJZ25vcmUCBADKrOOACYSbCQR0cnVlJwDKrOOACc7cCAZjcmVhdGUCBADKrOOACYmbCSjwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwDKrOOACc7cCAVzdG9yZQIEAMqs44AJsJsJKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAMqs44AJztwIBG1lbnUCBADKrOOACdebCSjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDKrOOACc7cCAdhYlNoZWxsAgQAyqzjgAn+mwkEdHJ1ZScAyqzjgAnO3AgJb25UYXBDb2RlAgQAyqzjgAmDnAmpAkBjb25zdCB0YXBDb2RlID0gdGhhdDsKCnN3aXRjaCAodGFwQ29kZSkKewogICAgY2FzZSAiMzM0MiI6CiAgICAgICAgb3MudG9hc3QoIndha2luZyAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSk7CgogICAgICAgIHRoaXNCb3Qub25DaGF0KHttZXNzYWdlOiAiLi4ifSk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICI0MjQyIjoKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgLy9jb25zb2xlLmxvZyh0YXBDb2RlKTsKfScAyqzjgAnO3AgDYXNrAgQAyqzjgAmtngko8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycAyqzjgAnO3AgJYWJWZXJzaW9uAgQAyqzjgAnUngkEMTAuNicAyqzjgAnO3AgKb25Cb3RBZGRlZAIEAMqs44AJ2Z4JQEB0aGlzQm90LmxvYWRBQkNvbW1hbmRzTWFuYWdlcigpOwp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkgPSBbXTsnAMqs44AJztwIGm9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkAgQAyqzjgAmanwnFREBsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKLy8gVGhlc2UgYXJlIGFsbCB0aGUgYnVpbHQtaW4gY29tbWFuZHMuCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2hlbHAnLCAoYXJncykgPT4gewogICAgY29uc3QgY29tbWFuZHMgPSBhYkNvbW1hbmRzLmNvbW1hbmRzOwogICAgY29uc3QgY29tbWFuZEtleXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcyk7CgogICAgbGV0IHNlbGVjdGVkQ29tbWFuZDsKICAgIGlmIChjb21tYW5kS2V5cyAmJiBjb21tYW5kS2V5cy5sZW5ndGggJiYgYXJncyAmJiBhcmdzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGNvbW1hbmRLZXlNYXRjaCA9IGNvbW1hbmRLZXlzLmZpbmQoa2V5ID0+IGtleSA9PT0gYXJnc1swXSk7CiAgICAgICAgc2VsZWN0ZWRDb21tYW5kID0gY29tbWFuZEtleU1hdGNoOwogICAgfQogICAgCiAgICBsaW5rcy5oZWxwLm1vdW50KHsgYWJDb21tYW5kc01hbmFnZXI6IGFiQ29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgdGhpcyBoZWxwIHdpbmRvdy4gQ2FuIHNwZWNpZnkgYSBjb21tYW5kIHRvIG9wZW4gdGhlIGhlbHAgcGFnZSBmb3IgdGhhdCBjb21tYW5kIGRpcmVjdGx5LicsCiAgICB1c2FnZTogWycuaGVscCcsICcuaGVscCBbY29tbWFuZF0nXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnLicsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy4uJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnd2FrZScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy53YWtlJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2xlZXAnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJTbGVlcChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1B1dCBhYiB0byBzbGVlcC4nLAogICAgdXNhZ2U6ICcuc2xlZXAnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhc2snLCAoYXJncykgPT4gewogICAgaWYgKGxpbmtzLmFzaykgewogICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBhc2tJbnB1dCA9IGFyZ3Muam9pbignICcpOwogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLmFzayBjb21tYW5kIHJlcXVpcmVzIGlucHV0YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhc2sgYm90IGlzIG5vdCBsb2FkZWQsIGNhbm5vdCBsb2FkIGFza2ApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQXNrIGFiJywKICAgIHVzYWdlOiAnLmFzayA8YXNrX25hbWU+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbmFtZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSwgeyB0aXRsZTogJ3doYXQgd291bGQgeW91IGxpa2UgdG8gY2FsbCBtZT8nIH0pOwogICAgc2V0VGFnTWFzayhsaW5rcy5wZXJzb25hbGl0eSwgJ2FiQnVpbGRlcklkZW50aXR5JywgbmFtZSwgJ2xvY2FsJyk7CiAgICBzaG91dCgnY2hhbmdlUGVyc29uYWxpdHlDb25maWcnLCB7IG5hbWU6IG5hbWUgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHaXZlIGFiIGEgbmV3IG5hbWUuJywKICAgIHVzYWdlOiAnLm5hbWVhYicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3N5c3RlbScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTeXN0ZW0oYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaW5zdC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGkgICAgCgogICAgWW91IG1heSBwcm92aWRlIGEgY3VzdG9tIHN5c3RlbVRhZ05hbWUgd2l0aCB0aGUgY29tbWFuZCwgaW4gb3JkZXIgdG8gb3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBvbmx5IGZvciBib3RzIHdpdGggdGhlIGdpdmVuIHN5c3RlbVRhZ05hbWUuIEJ5IGRlZmF1bHQsICJzeXN0ZW0iIHdpbGwgYmUgdXNlZCBhcyB0aGUgc3lzdGVtVGFnTmFtZS4KCiAgICBGb3IgZXhhbXBsZToKCiAgICA+IC5zeXN0ZW0KICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgInN5c3RlbSIgdGFnLgoKICAgID4gLnN5c3RlbSBteUdyb3VwCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJteUdyb3VwIiB0YWcuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnN5c3RlbScsCiAgICAgICAgJy5zeXN0ZW0gc3lzdGVtVGFnTmFtZScKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXcnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LiBCeSBkZWZhdWx0IHRoZSBzeXN0ZW0gcG9ydGFsIHdpbGwgb3BlbiBpbiBhIG5ldyB0YWIuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZycsIChhcmdzKSA9PiB7CiAgICBsaW5rcy5jb25zb2xlLnRvZ2dsZUNvbnNvbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1RvZ2dsZSB2aXNpYmxpdHkgb2YgdGhlIGFiIGxvZy4nLAogICAgdXNhZ2U6ICcubG9nJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2djbGVhcicsIChhcmdzKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlTG9nQm90cyA9IGdldEJvdHMoImNvbnNvbGVMb2dNZXNzYWdlQm90IiwgdHJ1ZSk7CiAgICBkZXN0cm95KG1lc3NhZ2VMb2dCb3RzKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0NsZWFyIGFsbCBhYiBsb2cgbWVzc2FnZXMuJywKICAgIHVzYWdlOiAnLmxvZ2NsZWFyJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzaGVldCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTaGVldChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3Igc3BlY2lmaWVkIGJvdCBvciBhbiBlbnRpcmUgZGltZW5zaW9uLicsCiAgICB1c2FnZTogWwogICAgICAgICcuc2hlZXQgW29wdGlvbnNdIFtwb3J0YWwgfCBoZWxwZXJCb3ROYW1lIHwgYm90SWQgfCBnbG9iYWxUaGlzUGF0aF0nLAogICAgICAgICdleC4gLnNoZWV0IGhvbWUnLAogICAgICAgICdleC4gLnNoZWV0IGNvbmZpZ0JvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgLXQgYTJjZjQ3MzktMzlhMi00ZmQ2LWIzZWYtY2M0NzgyZjk3MDg5JywKICAgICAgICAnZXguIC5zaGVldCBnbG9iYWxUaGlzLm15T2JqZWN0Lm15Qm90JywKICAgICAgICAnZXguIC5zaGVldCBteU9iamVjdC5teUJvdCcKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBpbiBhIG5ldyBicm93c2VyIHRhYi4gXG5cbk5PVEU6IC5zaGVldCB3aWxsIGF1dG9tYXRpY2FsbHkgaW5zcGVjdCB0aGUgc3BhY2Ugb2YgYSBib3QgYW5kIGZvcmNlIG9wZW5pbmcgaW4gdGhlIHNhbWUgdGFiIGlmIGEgYm90IGlzIGluIHRlbXBMb2NhbCBvciB0ZW1wU2hhcmVkIHNwYWNlLicsCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbWVudXNoZWV0JywgKGFyZ3MpID0+IHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKICAgIGlmICghY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2Fubm90IG9wZW4gc2hlZXRQb3J0YWwgZm9yIG1lbnVQb3J0YWwgYm90cy4gVGhlIG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IGRpc2FibGVkLmB9KQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciB0aGUgY3VycmVudCBtZW51IHBvcnRhbC4nLAogICAgdXNhZ2U6ICcubWVudVNoZWV0JywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkaW5zdCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEluc3QoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCB0aGUgaW5zdCB0byBkaXNrLicsCiAgICB1c2FnZTogJy5kb3dubG9hZGluc3QnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGFiJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkQUIoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBzcGVjaWZpZWQgYWIgZ3JvdXAocykgdG8gZGlzay4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suCgogICAgWW91IGNhbiBwcm92aWRlIGEgbGlzdCBvZiBncm91cHMgdG8gZG93bmxvYWQgYWxvbmcgd2l0aCB0aGUgY29tbWFuZDoKICAgID4gLmRvd25sb2FkYWIgYWJDb3JlIGFiU2hlbGwgYWJJbnRlcmZhY2UKCiAgICBJZiBncm91cChzKSBhcmUgbm90IHByb3ZpZGVkIHdpdGggdGhlIGNvbWFtYW5kIHRoZW4geW91IHdpbGwgYmUgcHJvbXB0ZWQgdG8gcHJvdmlkZSBvbmUgd2l0aCBhIGRpYWxvZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRhYiBbb3B0aW9uc10gW2dyb3VwLi4uXScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiBhYlNoZWxsIGFiSW50ZXJmYWNlJywKICAgICAgICAnZXguIC5kb3dubG9hZGFiIC12IDEgbXlHcm91cE5hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy12JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdTcGVjaWZ5IHRoZSBhdXggZm9ybWF0IHZlcnNpb24gbnVtYmVyLiBleC4gLXYgMSB3aWxsIGJlIGF1eCBmb3JtYXQgdmVyc2lvbiAxIChwdXJlIGJvdCBqc29uKS4gQnkgZGVmYXVsdCwgYWIgZmlsZXMgYXJlIHVzdWFsbHkgZG93bmxvYWRlZCBhcyB2ZXJzaW9uIDIgYXV4IGZpbGVzIChjb25mbGljdC1mcmVlIHVwZGF0ZSkuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkZWdnJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkRWdnKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLiBZb3Ugd2lsbCBuZWVkIHRvIHByb3ZpZGUgdGhlIHJlY29yZEtleSBhcyB3ZWxsIGFuZCB0aGUgbmFtZSBvZiB0aGUgZWdnLiBBIGRyb3Bkb3duIHNlbGVjdGlvbiB3aWxsIGJlIHByb3ZpZGVkIGZvciB0aGUgZWdnIGlmIGZvdW5kIHRvIHNlbGVjdCB3aGljaCB2ZXJzaW9uIHRvIGRvd25sb2FkLmAsCiAgICB1c2FnZTogJy5kb3dubG9hZGVnZycsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2Fkc2tpbGwnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKGFyZ3MpIHsKICAgICAgICBmb3IgKGxldCBza2lsbCBvZiBhcmdzKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoc2tpbGwpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnLmxvYWRza2lsbCByZXF1aXJlcyBzb21lIHNraWxsIG5hbWVzJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdMb2FkIHRoZSBzcGVjaWZpZWQgYWIgc2tpbGxzLicsCiAgICB1c2FnZTogJy5sb2FkU2tpbGwgW3NraWxsIC4uLl0nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cmxxcicsICgpID0+IG9zLnNob3dRUkNvZGUoY29uZmlnQm90LnRhZ3MudXJsKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgYSBRUiBjb2RlIGZvciB0aGUgYnJvd2VyIHRhYlwncyBjdXJyZW50IFVSTC4nLAogICAgdXNhZ2U6ICcudXJscXInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkaW0nLCAoYXJncykgPT4gewogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBuYW1lID0gYXJncy5qb2luKCcgJyk7CiAgICAgICAgb3MuZ29Ub0RpbWVuc2lvbihuYW1lKTsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYE1vdmVkIHRvICcke25hbWV9JyBkaW1lbnNpb24uYCwgZHVyYXRpb246IDMgfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dvIHRvIHNwZWNpZmllZCBkaW1lbnNpb24gLyBwb3J0YWwuJywKICAgIHVzYWdlOiAnLmRpbSA8ZGltZW5zaW9uIHwgcG9ydGFsPicsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1dWlkJywgKCkgPT4gewogICAgb3Muc2V0Q2xpcGJvYXJkKHV1aWQoKSk7CgogICAgbGV0IG1lc3NhZ2UgPSBgQ29waWVkIG5ldyB1dWlkIHRvIGNsaXBib2FyZGA7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYSB1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllciAodXVpZCkgYW5kIGNvcHkgaXQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcudXVpZCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2R1cCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBib3RJZCA9IGFyZ3MgPyBhcmdzWzBdIDogdW5kZWZpbmVkOwogICAgaWYgKGJvdElkKSB7CiAgICAgICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgICAgICBpZiAoYm90KSB7CiAgICAgICAgICAgIGNvbnN0IGR1cEJvdCA9IGNyZWF0ZShib3QpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZHVwQm90LmlkKTsKICAgICAgICAgICAgb3MudG9hc3QoJ0R1cGxpY2F0ZSBib3QgaWQgY29waWVkIHRvIGNsaXBib2FyZC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcy50b2FzdChgTm8gYm90IGZvdW5kIHdpdGggaWQgJHtib3RJZH1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCdQcm92aWRlIHRoZSBpZCBvZiB0aGUgYm90IHlvdSB3YW50IHRvIGR1cGxpY2F0ZScpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGEgc3BlY2lmaWVkIGJvdCBhbmQgY29weSB0aGUgbmV3IGJvdFwncyBpZCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy5kdXAgPGJvdElkPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGF1eCcsIChhcmdzKSA9PiB7CiAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIEFVWCBmaWxlKHMpIHRvIHRoZSBjdXJyZW50IGluc3QuJywKICAgIHVzYWdlOiAnLnVwbG9hZGF1eCcKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkZmlsZXMnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBsb2FkRmlsZXMoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgZmlsZShzKSBkaXJlY3RseSB0byByZWNvcmQuJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGxvYWRmaWxlcycsCiAgICAgICAgJy51cGxvYWRmaWxlcyAtcmVjb3JkIDxyZWNvcmRfaWQ+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcmVjb3JkJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcHRpb25hbGx5IHB1Ymxpc2ggZmlsZShzKSB0byBhIHNwZWNpZmljIHJlY29yZC4gSWYgb21pdHRlZCwgZmlsZShzKSB3aWxsIGJlIHB1Ymxpc2hlZCB0byB0aGUgdXNlclwncyBwZXJzb25hbCByZWNvcmQuJwogICAgICAgIH0KICAgIF0KfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndmlld3JlY29yZGRhdGEnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKCFsaW5rcy52aWV3UmVjb3JkRGF0YUFwcCkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiVmlld1JlY29yZCcpOwogICAgfQoKICAgIGxldCByZWNvcmROYW1lOwoKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgIHJlY29yZE5hbWUgPSBhcmdzLmpvaW4oJyAnKTsKICAgIH0KCiAgICBpZiAoIXJlY29yZE5hbWUpIHsKICAgICAgICByZWNvcmROYW1lID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWU7CiAgICB9CiAgICAKICAgIGxpbmtzLnZpZXdSZWNvcmREYXRhQXBwLm1vdW50KHsgcmVjb3JkTmFtZSB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1ZpZXcgZGF0YSBzdG9yZWQgaW4gcHJvdmlkZWQgcmVjb3JkIG5hbWUuIElmIHJlY29yZCBuYW1lIGlzIG5vdCBwcm92aWRlZCB0aGVuIGl0IHdpbGwgZGVmYXVsdCB0byBhYiByZWNvcmQuJywKICAgIHVzYWdlOiBbJy52aWV3cmVjb3JkZGF0YScsICcudmlld3JlY29yZGRhdGEgW3JlY29yZE5hbWVdJ10KfSknAMqs44AJztwICGFydGlmYWN0AgQAyqzjgAng4wko8J+Ulzc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNycAyqzjgAnO3AgVbG9hZEFCQ29tbWFuZHNNYW5hZ2VyAgQAyqzjgAmH5An6LUAvKioKICogQUJDb21tYW5kc01hbmFnZXIgaXMgcGFydCBvZiBhYlNoZWxsLgogKiBZb3UgY2FuIHJlZ2lzdGVyIGNvbW1hbmRzIHRvIGl0IHRoYXQgY2FuIGJlIGludm9rZWQgdXNpbmcgJyQ8Y29tbWFuZD4nIHdpdGggdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogKiBJdHMgZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZCB0byBjcmVhdGUgdGhpcyB5b3Vyc2VsZiBidXQgaW5zdGVhZCB0byBsaXN0ZW4gZm9yIHRoZSBAb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQgc2hvdXQKICogYW5kIHRvIHJlZ2lzdGVyIHlvdXIgY29tbWFuZHMgdGhlcmUuCiAqIEBwcm9wIHtzdHJpbmdbXX0gY29tbWFuZHMKICovCmNsYXNzIEFCQ29tbWFuZHNNYW5hZ2VyIHsKICAgIGNvbW1hbmRzOiBSZWNvcmQ8c3RyaW5nLCBBQkNvbW1hbmQ+OwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKCiAgICAgICAgLy8gU2hvdXQgdGhhdCBhbiBpbnN0YW5jZSBvZiBBQkNvbW1hbmRzTWFuYWdlciBoYXMgYmVlbiBjcmVhdGVkIGFuZCBhbGxvdyBhbnkgbGlzdGVuZXJzCiAgICAgICAgLy8gdG8gYWRkIHRoZWlyIG93biBjb21tYW5kcyB0byB0aGUgaW5zdGFuY2UuCiAgICAgICAgc2hvdXQoJ29uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkJywgdGhpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgYSBjb21tYW5kIHRvIEFCQ29tbWFuZHNNYW5hZ2VyLgogICAgICogVGhpcyBjb21tYW5kIHdpbGwgYmUgYXZhaWxhYmxlIHRvIGludm9rZSB1c2luZyAnJDxuYW1lPicgb24gdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIHN1Y2Nlc3NmdWxseSBhZGRlZC4KICAgICAqLwogICAgYWRkQ29tbWFuZChuYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjaywgaGVscDogQUJDb21tYW5kSGVscCk6IGJvb2xlYW4gewogICAgICAgIGlmICghbmFtZSB8fCB0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSBzdHJpbmcgbmFtZSBpcyByZXF1aXJlZCBmb3IgY29tbWFuZHMuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBhbHJlYWR5IGV4aXN0cyBhcyBhIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghY2FsbGJhY2sgfHwgdHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGEgY2FsbGJhY2sgZnVuY3Rpb24uYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgaXMgbWlzc2luZyBzaG9ydERlc2NyaXB0aW9uIGZyb20gaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29tbWFuZHNbbmFtZV0gPSB7IG5hbWUsIGNhbGxiYWNrLCBoZWxwIH07CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaGFzQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kc1tuYW1lXSAhPSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgY29tbWFuZCBmcm9tIEFCQ29tbWFuZHNNYW5hZ2VyCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2FzIHJlbW92ZWQuIElmIHRoZSBjb21tYW5kIGRvZXNuJ3QgZXhpc3QgZmFsc2Ugd2lsbCBhbHNvIGJlIHJldHVybmVkLgogICAgICovCiAgICByZW1vdmVDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ2FsbCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2l0aCB0aGUgcHJvdmlkZWQgYXJncyAoaWYgYW55KS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBleGVjdXRlZC4KICAgICAqLwogICAgY2FsbENvbW1hbmQobmFtZTogc3RyaW5nLCBhcmdzPzogYW55W10pOiBib29sZWFuIHsKICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICBpZiAoY29tbWFuZCkgewogICAgICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRBcmdzID0gW107CgogICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBoZWxwQXJnIG9mIGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhlbHBBcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKC4uLmhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaChoZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZSBpbnB1dCBhcmdzIGFyZSB2YWxpZCBhZ2FpbnN0IHRoZSBjb21tYW5kIGhlbHAgZG9jdW1lbnRhdGlvbi4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gZWFzeSB3YXkgdG8gdmFsaWRhdGUgYXJncyBiZWZvcmUgZXhlY3V0aW5nIGEgY29tbWFuZC4KICAgICAgICAgICAgICAgIEFCQ29tbWFuZHNNYW5hZ2VyLmFzc2VydFZhbGlkQXJncyhhcmdzLCB2YWxpZEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1hbmQuY2FsbGJhY2soYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBub3QgYSB2YWxpZCBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHByb3ZpZGVkIGFyZy4gV2lsbCByZW1vdmUgdGhlIGFyZyBhbmQgdmFsdWUgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnVmFsdWUoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYW55IHsKICAgICAgICBsZXQgdmFsdWUgPSBudWxsOwoKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICBsZXQgZGVsZXRlQ291bnQgPSAxOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWVJbmRleCA9IGFyZ0luZGV4ICsgMTsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWVJbmRleCA8IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbdmFsdWVJbmRleF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlbGF0ZWQgYXJncyAmIHZhbHVlcwogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIGRlbGV0ZUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHdldGhlciB0aGUgYXJnIGZsYWcgaXMgcHJvdmlkZWQgaW4gdGhlIGFyZ3MuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnRmxhZyhhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYXJnIGZsYWcuCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgMSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHN0YXRpYyBhc3NlcnRWYWxpZEFyZ3MoYXJnczogYW55W10sIHZhbGlkQXJnczogYW55W10pOiB2b2lkIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBpbnZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFyZyB3ZSB3YW50IHRvIGV2YWx1YXRlLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkQXJncyB8fCAhdmFsaWRBcmdzLmluY2x1ZGVzKGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXJnIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgdmFsaWRBcmdzLCB0aHVzIHRoZSBhcmcgaXMgaW52YWxpZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRBcmdzLnB1c2goYXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB0aGlzIGFyZyBpdCBpcyBtb3N0bHkgbGlrZWx5IGEgdmFsdWUgYXJnLgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGludmFsaWRBcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIGFyZ3VtZW50czogJHtpbnZhbGlkQXJncy5qb2luKCcsICcpfWA7CgogICAgICAgICAgICAgICAgb3MudG9hc3QoZXJyb3JNZXNzYWdlLCA0KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpnbG9iYWxUaGlzLkFCQ29tbWFuZHNNYW5hZ2VyID0gQUJDb21tYW5kc01hbmFnZXI7JwDKrOOACc7cCARoZWxwAgQAyqzjgAmCkgoo8J+UlzI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYycAyqzjgAnO3AgIY21kU2hlZXQCBADKrOOACamSCs0UQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IHBvcnRhbDsKbGV0IG5ld1RhYiA9IGZhbHNlOwoKaWYgKGFyZ3MpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV07CiAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJy10JykgewogICAgICAgICAgICAgICAgbmV3VGFiID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSBhcmc7CiAgICAgICAgfQogICAgfQp9CgppZiAoIXBvcnRhbCkgewogICAgcG9ydGFsID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9Cgpjb25zdCBoZWxwZXJCb3RzID0gewogICAgJ2NvbmZpZ0JvdCc6IGNvbmZpZ0JvdCwKICAgICdncmlkUG9ydGFsQm90JzogZ3JpZFBvcnRhbEJvdCwKICAgICdzaGVldFBvcnRhbEJvdCc6IHNoZWV0UG9ydGFsQm90LAogICAgJ3N5c3RlbVBvcnRhbEJvdCc6IHN5c3RlbVBvcnRhbEJvdCwKICAgICdtaW5pR3JpZFBvcnRhbEJvdCc6IG1pbmlHcmlkUG9ydGFsQm90LAogICAgJ21hcFBvcnRhbEJvdCc6IG1hcFBvcnRhbEJvdCwKICAgICdtaW5pTWFwUG9ydGFsQm90JzogbWluaU1hcFBvcnRhbEJvdCwKICAgICdtZW51UG9ydGFsQm90JzogbWVudVBvcnRhbEJvdCwKICAgICdsZWZ0V3Jpc3RQb3J0YWxCb3QnOiBsZWZ0V3Jpc3RQb3J0YWxCb3QsCiAgICAncmlnaHRXcmlzdFBvcnRhbEJvdCc6IHJpZ2h0V3Jpc3RQb3J0YWxCb3QsCiAgICAnbWVldFBvcnRhbEJvdCc6IG1lZXRQb3J0YWxCb3QsCiAgICAndGFnUG9ydGFsQm90JzogdGFnUG9ydGFsQm90LAogICAgJ2ltdVBvcnRhbEJvdCc6IGltdVBvcnRhbEJvdCwKfTsKCi8vIEZ1bmN0aW9uIHRvIHJlc29sdmUgYSBwb3J0YWwgcmVmZXJlbmNlIHRvIGEgc3BlY2lmaWMgYm90CmZ1bmN0aW9uIHJlc29sdmVQb3J0YWxUb0JvdChwYXRoKSB7CiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJycpIHJldHVybiBudWxsOwogICAgCiAgICAvLyBGaXJzdCBjaGVjayBpZiBpdCdzIGRpcmVjdGx5IGluIGhlbHBlckJvdHMKICAgIGlmIChoZWxwZXJCb3RzW3BhdGhdKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlckJvdHNbcGF0aF07CiAgICB9CgogICAgLy8gUGVyaGFwcyB0aGUgcGF0aCBpcyBhIGJvdCBpZC4KICAgIGxldCBib3RGcm9tSWRTZWFyY2ggPSBnZXRCb3QoJ2lkJywgcGF0aCk7CiAgICBpZiAoYm90RnJvbUlkU2VhcmNoKSB7CiAgICAgICAgcmV0dXJuIGJvdEZyb21JZFNlYXJjaDsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgZm9yIGJvdGggZGlyZWN0IGFuZCBuZXN0ZWQgcGF0aHMgaW4gZ2xvYmFsVGhpcwogICAgbGV0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIGxldCBjdXJyZW50T2JqID0gZ2xvYmFsVGhpczsKICAgIGxldCBzdGFydEluZGV4ID0gMDsKICAgIAogICAgLy8gSGFuZGxlIGlmIHRoZSBwYXRoIGV4cGxpY2l0bHkgc3RhcnRzIHdpdGggJ2dsb2JhbFRoaXMnCiAgICBpZiAocGF0aFBhcnRzWzBdID09PSAnZ2xvYmFsVGhpcycpIHsKICAgICAgICBzdGFydEluZGV4ID0gMTsgLy8gU2tpcCB0aGUgJ2dsb2JhbFRoaXMnIHBhcnQgc2luY2Ugd2UncmUgYWxyZWFkeSBzdGFydGluZyB0aGVyZQogICAgfQogICAgCiAgICAvLyBUcmF2ZXJzZSB0aGUgcGF0aAogICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBwYXRoUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwYXJ0ID0gcGF0aFBhcnRzW2ldOwogICAgICAgIGlmICghY3VycmVudE9ialtwYXJ0XSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gUGF0aCBzZWdtZW50IGRvZXNuJ3QgZXhpc3QKICAgICAgICB9CiAgICAgICAgY3VycmVudE9iaiA9IGN1cnJlbnRPYmpbcGFydF07CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGlmIHRoZSBmaW5hbCBvYmplY3QgaXMgYSBib3QgKGhhcyBpZCBhbmQgdGFncykKICAgIGlmIChjdXJyZW50T2JqICYmIGN1cnJlbnRPYmouaWQgJiYgY3VycmVudE9iai50YWdzKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRPYmo7CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOyAvLyBOb3QgYSB2YWxpZCBib3QKfQoKLy8gU2VhcmNoIHRvIHNlZSBpZiBwb3J0YWwgYXJndW1lbnQgaXMgc3BlY2lmaWMgdG8gYSBib3QKbGV0IHVuaXF1ZUJvdCA9IHJlc29sdmVQb3J0YWxUb0JvdChwb3J0YWwpOwoKaWYgKHVuaXF1ZUJvdCkgewogICAgaWYgKHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcExvY2FsJyB8fAogICAgICAgIHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcFNoYXJlZCcKICAgICkgewogICAgICAgIC8vIEZvcmNlIHNoZWV0IHRvIG9wZW4gaW4gc2FtZSB0YWIgaWYgdGhlIGJvdCBvbmx5IGxpdmVzIGluIHRoaXMgdGFiLgogICAgICAgIG5ld1RhYiA9IGZhbHNlOwogICAgfQogICAgcG9ydGFsID0gdW5pcXVlQm90LmlkOwp9CgppZiAobmV3VGFiKSB7CiAgICBvcy5vcGVuVVJMKGAvP2luc3Q9JHtvcy5nZXRDdXJyZW50SW5zdCgpfSZzaGVldFBvcnRhbD0ke3BvcnRhbH1gKTsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gcG9ydGFsOwp9JwDKrOOACc7cCA1jbWREb3dubG9hZEFCAgQAyqzjgAn3pgqtC0Bjb25zdCBhcmdzID0gdGhhdDsKCmxldCBhdXhWZXJzaW9uOiBzdHJpbmcgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctdicpOwoKaWYgKCFhdXhWZXJzaW9uKSB7CiAgICAvLyBEZWZhdWx0IHRvIGF1eCB2ZXJzaW9uIDIgaWYgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkLgogICAgYXV4VmVyc2lvbiA9ICcyJzsKfQoKaWYgKGF1eFZlcnNpb24gIT09ICcxJyAmJiBhdXhWZXJzaW9uICE9PSAnMicpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYE9ubHkgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgYW5kIDIgYXJlIHN1cHBvcnRlZCBpbiB0aGUgZG93bmxvYWQgYWIgY29tbWFuZC5gKTsKICAgIHJldHVybjsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmxldCBncm91cHMgPSBbXTsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgLy8gUmVtYWluaW5nIGFyZ3MgYXJlIGdyb3VwIG5hbWVzIHByb3ZpZGVkIHdpdGggdGhlIGNvbW1hbmQuCiAgICBncm91cHMgPSBhcmdzOwp9IGVsc2UgewogICAgbGV0IGdyb3VwID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCwgeyB0aXRsZTogJ0FCIEdyb3VwIFRhZycsIGF1dG9TZWxlY3Q6IHRydWUgfSk7CiAgICBpZiAoZ3JvdXApIHsKICAgICAgICBtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAgPSBncm91cDsKICAgICAgICBncm91cHMucHVzaChncm91cCk7CiAgICB9Cn0KCmNvbnN0IG1ham9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWFqb3JWZXJzaW9uOwpjb25zdCBtaW5vclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1pbm9yVmVyc2lvbjsKY29uc3QgYWJWZXJzaW9uID0gYCR7bWFqb3JWZXJzaW9ufS4ke21pbm9yVmVyc2lvbn1gOwoKZm9yIChsZXQgZ3JvdXAgb2YgZ3JvdXBzKSB7CiAgICBjb25zdCBncm91cEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgW2dyb3VwXTogdHJ1ZSwgc3BhY2U6ICdzaGFyZWQnIH0pKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwQm90cy5sZW5ndGg7IGkrKykgewogICAgICAgIGdyb3VwQm90c1tpXS50YWdzLmFiVmVyc2lvbiA9IGFiVmVyc2lvbjsKICAgIH0KCiAgICBpZiAoZ3JvdXAgPT0gImFiQ29uZmlnIikgewogICAgICAgIGdyb3VwID0gImFiMSI7CiAgICB9CgogICAgaWYgKGF1eFZlcnNpb24gPT09ICcxJykgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMQogICAgICAgIG9zLmRvd25sb2FkQm90cyhncm91cEJvdHMsIGdyb3VwKQogICAgfSBlbHNlIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDIKICAgICAgICBvcy5kb3dubG9hZEJvdHNBc0luaXRpYWx6YXRpb25VcGRhdGUoZ3JvdXBCb3RzLCBncm91cCk7CiAgICB9Cgp9CgonAMqs44AJztwICWNtZEFCV2FrZQIEAMqs44AJpbIK1gNAbGV0IHNraWxsQXJyYXkgPSBbImFiUGVyc29uYWxpdHkiLCAiYWJJbnRlcmZhY2UiLCAiYWJBY3Rpb24iLCAiYWJUZXN0cyJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwp9Cgphd2FpdCBvcy5zbGVlcCgzMDApOwoKLy9rZWVwIGFiIGF3YWtlCnNldFRhZ01hc2sobGlua3MucmVtZW1iZXIsICdhYkF3YWtlU3RhdGUnLCB0cnVlLCAnc2hhcmVkJykKCmlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47Cn0KZWxzZSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkF3YWtlIiwgImFiTWFuaWZlc3RTdGF0ZSIpOycAyqzjgAnO3AgKY21kQUJTbGVlcAIEAMqs44AJ/LUK3QFAY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cgp0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOycAyqzjgAnO3AgHY29uc29sZQIEAMqs44AJ2rcKKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAMqs44AJztwIDmNtZFVwbG9hZEZpbGVzAgQAyqzjgAmBuAqTEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScAyqzjgAnO3AgOY21kRG93bmxvYWRFZ2cCBADKrOOACZXICvkLQGNvbnN0IHJlY29yZEtleSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXksIHsKICAgIHRpdGxlOiAncmVjb3JkIHRvIGxvb2t1cCBlZ2cgaW4nLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleTpgLCByZWNvcmRLZXkpOwoKaWYgKCFyZWNvcmRLZXkpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5ID0gcmVjb3JkS2V5OwoKY29uc3QgZWdnTmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lLCB7CiAgICB0aXRsZTogJ25hbWUgb2YgZWdnJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2dOYW1lOmAsIGVnZ05hbWUpOwoKaWYgKCFlZ2dOYW1lKSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUgPSBlZ2dOYW1lOwoKY29uc3QgZWdnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgIGFiSUQ6IGVnZ05hbWUsCiAgICByZWNvcmRLZXksCiAgICByZXR1cm5UeXBlOiAnZWdnJwp9KQoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2c6YCwgZWdnKTsKCmlmICghQXJyYXkuaXNBcnJheShlZ2cuZWdnVmVyc2lvbkhpc3RvcnkpIHx8IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYERhdGEgZm91bmQgYXQgYWRkcmVzcyAnJHtlZ2dOYW1lfScgaW4gcmVjb3JkICcke3JlY29yZEtleX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlZ2cuYCkKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBlZ2dWZXJzaW9uT3B0aW9ucyA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7CiAgICByZXR1cm4geyBsYWJlbDogYHZlcnNpb24gJHtpbmRleCArIDF9YCwgdmFsdWU6IGluZGV4IH0KfSkKCmNvbnN0IHNlbGVjdGVkVmVyc2lvbk9wdGlvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChlZ2dWZXJzaW9uT3B0aW9ucy5sZW5ndGggLSAxLCB7CiAgICB0aXRsZTogJ2Rvd25sb2FkIGVnZyB2ZXJzaW9uJywKICAgIHR5cGU6ICdsaXN0JywKICAgIHN1YnR5cGU6ICdzZWxlY3QnLAogICAgaXRlbXM6IGVnZ1ZlcnNpb25PcHRpb25zLAp9KQoKaWYgKCFzZWxlY3RlZFZlcnNpb25PcHRpb24pIHsKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBhdXhEYXRhVXJsID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5W3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZV07CmNvbnN0IGF1eERhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGF1eERhdGFVcmwpOwpjb25zdCBhdXhGaWxlbmFtZSA9IGAke2VnZ05hbWV9X3Yke3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZSArIDF9LmF1eGA7Cgpvcy5kb3dubG9hZChhdXhEYXRhLCBhdXhGaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsnAMqs44AJztwID2NtZERvd25sb2FkSW5zdAIEAMqs44AJj9QKhQFAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBib3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwpvcy5kb3dubG9hZEJvdHMoYm90cywgb3MuZ2V0Q3VycmVudEluc3QoKSk7JwDKrOOACc7cCAZzZWFyY2gCBADKrOOACZXVCijwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwDKrOOACc7cCAV1dGlscwIEAMqs44AJvNUKKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAMqs44AJztwICWNtZFN5c3RlbQIEAMqs44AJ49UKkQdAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBzYW1lV2luZG93ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctdycpOwoKbGV0IHN5c3RlbVRhZ05hbWUgPSBudWxsOwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICBzeXN0ZW1UYWdOYW1lID0gYXJncy5qb2luKCcgJyk7Cn0KCmlmIChzYW1lV2luZG93KSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LgogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsID0gdHJ1ZTsKICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVRhZ05hbWUgPSBzeXN0ZW1UYWdOYW1lOwp9IGVsc2UgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIGEgbmV3IHRhYi4KICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKTsKCiAgICAvLyBSZW1vdmUgYW55IHBvcnRhbHMgdGhhdCBhcmUgc2V0IGluIHRoZSBVUkwuCiAgICBsZXQgcGFyYW1zID0gdXJsLnNlYXJjaFBhcmFtcy5rZXlzKCk7CiAgICBmb3IgKGxldCBwYXJhbSBvZiBwYXJhbXMpIHsKICAgICAgICBpZiAocGFyYW0uZW5kc1dpdGgoJ1BvcnRhbCcpKSB7CiAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKHBhcmFtKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gVHVybiBvbiB0aGUgc3lzdGVtIHBvcnRhbC4KICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1Qb3J0YWwnLCAndHJ1ZScpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3N5c3RlbVRhZ05hbWUnKTsKCiAgICBpZiAoc3lzdGVtVGFnTmFtZSkgewogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1UYWdOYW1lJywgc3lzdGVtVGFnTmFtZSk7CiAgICB9CgogICAgb3Mub3BlblVSTCh1cmwuaHJlZik7Cn0KJwDKrOOACc7cCA1hYkNoYXRCYXJPcGVuAgQAyqzjgAn13AqjAkBjb25zdCB7CiAgICBwcmVmaWxsLAp9ID0gdGhhdCA/PyB7fQoKbWFza3MuY2hhdE9wZW4gPSB0cnVlOwoKb3Muc2hvd0NoYXQoewogICAgcGxhY2Vob2xkZXI6ICc+IC5oZWxwIHRvIHNlZSBhdmFpbGFibGUgY29tbWFuZHMnLAogICAgYmFja2dyb3VuZENvbG9yOiAnIzJmMmYyZicsCiAgICBmb3JlZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwbGFjZWhvbGRlckNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcHJlZmlsbAp9KScAyqzjgAnO3AgOYWJDaGF0QmFyQ2xvc2UCBADKrOOACZnfCnZAbWFza3MuY2hhdE9wZW4gPSBmYWxzZTsKb3MuaGlkZUNoYXQoKTsKCi8vIEdpdmUgQ2FzdWFsT1MgYSBjaGFuZ2UgdG8gYWN0dWFsbHkgcmVtb3ZlIHRoZSBjaGF0IGJhci4KYXdhaXQgb3Muc2xlZXAoMCk7JwDKrOOACc7cCAtwZXJzb25hbGl0eQIEAMqs44AJkOAKKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAMqs44AJztwIBXR5cGVzAgQAyqzjgAm34AryAvCfk4R0eXBlIEFCQ29tbWFuZENhbGxiYWNrID0gKGFyZ3M/OiBhbnlbXSkgPT4gdm9pZDsKCmludGVyZmFjZSBBQkNvbW1hbmRBcmcgewogIGlkZW50aWZpZXI6IHN0cmluZ1tdIHwgc3RyaW5nOwogIGRlc2NyaXB0aW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkNvbW1hbmRIZWxwIHsKICBzaG9ydERlc2NyaXB0aW9uOiBzdHJpbmc7CiAgbG9uZ0Rlc2NyaXB0aW9uPzogc3RyaW5nOwogIGFyZ3M/OiBBQkNvbW1hbmRBcmdbXTsKICB1c2FnZT86IHN0cmluZyB8IHN0cmluZ1tdOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kIHsKICBuYW1lOiBzdHJpbmc7CiAgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrOwogIGhlbHA6IEFCQ29tbWFuZEhlbHA7Cn0nAMqs44AJztwIEXZpZXdSZWNvcmREYXRhQXBwAgQAyqzjgAmo4woo8J+UlzkyZmY2ZDI4LTMzNTEtNGNmYi04NDY0LTlkN2M2MTQyN2EyNgA="}]}