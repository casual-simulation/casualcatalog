{"version":2,"updates":[{"id":0,"timestamp":1758904550544,"update":"AZEEw7LHuQIAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwDDsse5AgAGc3lzdGVtAgQAw7LHuQIBDWFiLnNoZWxsLmdyaWQnAMOyx7kCAARmb3JtAgQAw7LHuQIPB25vdGhpbmcnAMOyx7kCAAxvbkFueUJvdERyYWcCBADDsse5Ahe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAMOyx7kCAAhyZW1lbWJlcgIEAMOyx7kC0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAw7LHuQIACGFiSWdub3JlAgQAw7LHuQL6AQR0cnVlJwDDsse5AgAHYWJTaGVsbAIEAMOyx7kC/wEEdHJ1ZScAw7LHuQIACWFiVmVyc2lvbgIEAMOyx7kChAIFMTAuMTAnAMOyx7kCAAVmb2N1cwIEAMOyx7kCigKrBEAvL3Nob3V0KCJmb2N1cyIsIHtib3Q6IGJvdCwgcG9zaXRpb246e3g6IHgsIHk6IHl9fSk7Cgpjb25zdCBmb2N1c1R5cGUgPSB0aGF0LmJvdCA/ICJib3QiIDogInBvc2l0aW9uIjsKY29uc3QgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uOwpjb25zdCB6b29tID0gdGhhdC56b29tID8/IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IDIwMDAgOiAxMDsKY29uc3Qgcm90YXRpb24gPSB0aGF0LnJvdGF0aW9uID8/IHt4OiA0NSwgeTogNDV9Owpjb25zdCBlYXNpbmcgPSB0aGF0LmVhc2luZyA/PyB7dHlwZTogImxpbmVhciIsIG1vZGU6ICJpbm91dCJ9Owpjb25zdCBmb2N1c09wdGlvbnMgPSB7CiAgICB6b29tOiB6b29tLAogICAgcm90YXRpb246IHJvdGF0aW9uLAogICAgZWFzaW5nOiBlYXNpbmcsCiAgICBkdXJhdGlvbjogZHVyYXRpb24KfTsKCmlmIChmb2N1c1R5cGUgPT0gImJvdCIpCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5ib3QsIGZvY3VzT3B0aW9ucykKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScAw7LHuQK2BgZzeXN0ZW0CBADDsse5ArcGE2FiLnNoZWxsLmNvbXBvbmVudHMnAMOyx7kCtgYMQXBwQ29udGFpbmVyAgQAw7LHuQLLBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycAw7LHuQK2BghUZXh0TGluawIEAMOyx7kC+AqjA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwDDsse5ArYGBldpbmRvdwIEAMOyx7kCnA62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAMOyx7kCtgYMVGV4dExpbmsuY3NzAgQAw7LHuQLTEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwDDsse5ArYGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAMOyx7kCwRJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAMOyx7kCtgYKV2luZG93LmNzcwIEAMOyx7kCsxOoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAMOyx7kCtgYIcmVtZW1iZXICBADDsse5AtwWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMOyx7kCtgYIYWJJZ25vcmUCBADDsse5AoMXBHRydWUnAMOyx7kCtgYHYWJTaGVsbAIEAMOyx7kCiBcEdHJ1ZScAw7LHuQK2BglhYlZlcnNpb24CBADDsse5Ao0XBTEwLjEwJwDDsse5ArYGC3BlcnNvbmFsaXR5AgQAw7LHuQKTFyjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwEEYm90cyQyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWIBJwDDsse5AroXB0FwcC5jc3MCBADDsse5ArsXyhY6cm9vdCB7CiAgLS1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIC0tb24tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAtLWFiLWNvbnNvbGUtaGVpZ2h0OiAzM3ZoOwp9Ci8qIERhcmsgbW9kZSBzdXBwb3J0ICovCkBtZWRpYSAocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIHsKICA6cm9vdCB7CiAgICAtLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgICAtLW9uLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgfQp9CgouYWItY29uc29sZS1idG4gewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogaW5oZXJpdDsKICBsZXR0ZXItc3BhY2luZzogaW5oZXJpdDsKICBsaW5lLWhlaWdodDogaW5oZXJpdDsKICB0ZXh0LXRyYW5zZm9ybTogaW5oZXJpdDsKICB0ZXh0LWluZGVudDogaW5oZXJpdDsKICB0ZXh0LXNoYWRvdzogaW5oZXJpdDsKICBiYWNrZ3JvdW5kLWNvbG9yOiBpbmhlcml0OwogIG1hcmdpbjogaW5oZXJpdDsKICBwYWRkaW5nLWJsb2NrOiBpbmhlcml0OwogIHBhZGRpbmctaW5saW5lOiBpbmhlcml0OwogIGJvcmRlcjogbm9uZTsKICB0cmFuc2Zvcm06IHNjYWxlKDEuMik7Cn0KCi5hYi1jb25zb2xlIHsKICB3aWR0aDogMTAwdnc7CiAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICBwYWRkaW5nOiAwOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCkgYnJpZ2h0bmVzcygyMDAlKTsKICBhbmltYXRpb24tbmFtZTogc2xpZGUtYXBwLWluOwogIGFuaW1hdGlvbi1kdXJhdGlvbjogMC41czsKICBvdmVyZmxvdy15OiBoaWRkZW47CiAgei1pbmRleDogMTsKfQoKLmFiLWNvbnNvbGU6OmFmdGVyIHsKICBjb250ZW50OiAiIjsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgdG9wOiAwOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgYm90dG9tOiAwOwogIG9wYWNpdHk6IDAuOTsKICB6LWluZGV4OiAwOwp9CgpAa2V5ZnJhbWVzIHNsaWRlLWFwcC1pbiB7CiAgZnJvbSB7CiAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBjdWJpYy1iZXppZXIoLjYsMCwuNzksMS4wMyk7CiAgICAvKiB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMTEwJSk7ICovCiAgICAvKiBoZWlnaHQ6IDBweDsgKi8KICAgIC8qIG1pbi1oZWlnaHQ6IDBweDsgKi8KICAgIG1heC1oZWlnaHQ6IDBweDsKICB9CgogIHRvIHsKICAgIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICAgIC8qIG1pbi1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsgKi8KICB9Cn0KCi5hYi1jb25zb2xlID4gZGl2IHsKICB6LWluZGV4OiAxOwogIHBvc2l0aW9uOiByZWxhdGl2ZQp9CgouYWItY29uc29sZS10b3AtYmFyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICB3aWR0aDogMTAwJTsKICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgZGlzcGxheTogZmxleDsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGp1c3RpZnktY29udGVudDogZW5kOwogIHBhZGRpbmc6IDAuNXJlbTsKfQoKLmFiLWNvbnNvbGUtbG9nIHsKICBvdmVyZmxvdy15OiBhdXRvOwogIGZsZXgtZ3JvdzogMTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW4tcmV2ZXJzZTsKICBtaW4taGVpZ2h0OiAyNHB4OwogIHBhZGRpbmc6IDAgMXJlbTsKICBjdXJzb3I6IHBvaW50ZXI7CiAgb3ZlcnNjcm9sbC1iZWhhdmlvcjogY29udGFpbjsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgY3Vyc29yOiBpbml0aWFsOwp9CgouYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciB7CiAgbWFyZ2luOiAwLjVyZW0gMDsKfQouYWItY29uc29sZS1tZXNzYWdlIHsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiByb3c7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKfQoKLmFiLWNvbnNvbGUtc3BhY2VyIHsKICBmbGV4LXNocmluazogMDsKICBmbGV4LWdyb3c6IDE7Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIG1heC13aWR0aDogODB2dzsKICBib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5hYi1jb25zb2xlLXRpbWVzdGFtcCB7CiAgb3BhY2l0eTogMC42Owp9CgouY29uc29sZS1zZW5kLWJ0biB7CiAgbWFyZ2luOiAwICFpbXBvcnRhbnQ7CiAgcGFkZGluZzogMCAxcmVtICFpbXBvcnRhbnQ7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9CgouY29uc29sZS1zZW5kLWJ0biA+IHNwYW4gewogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgzcHgpCn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGdhcDogMC43NXJlbTsKICBtYXJnaW46IDAuNXJlbSAxcmVtOwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciA+IGlucHV0IHsKICBiYWNrZ3JvdW5kOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgZmxleC1ncm93OiAxOwogIG91dGxpbmU6IG5vbmU7CiAgYm9yZGVyOiBub25lOwogIHBhZGRpbmc6IDFyZW07CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9JwDDsse5AroXBmdldEFwcAIEAMOyx7kChi7dI0Bjb25zdCB7IHVzZUVmZmVjdCwgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZVJlZiB9ID0gb3MuYXBwSG9va3MKY29uc3QgVG9wQmFyID0gdGhpc0JvdC5Ub3BCYXIoKTsKY29uc3QgTWVzc2FnZSA9IHRoaXNCb3QuTWVzc2FnZSgpOwoKY29uc3QgQXBwID0gKCkgPT4gewogICAgY29uc3QgW3BvaW50ZXJEb3duUG9zLCBzZXRQb2ludGVyRG93blBvc10gPSB1c2VTdGF0ZSh7eDogLTEsIHk6IC0xfSk7CiAgICBjb25zdCBbY29uc29sZUxvZywgc2V0Q29uc29sZUxvZ10gPSB1c2VTdGF0ZShbXSk7CiAgICBjb25zdCBbc2hvd0NoYXQsIHNldFNob3dDaGF0XSA9IHVzZVN0YXRlKHRhZ3Muc2hvd0NoYXRJbnB1dCk7CiAgICBjb25zdCBbdXNlcklucHV0LCBzZXRVc2VySW5wdXRdID0gdXNlU3RhdGUoJycpOwogICAgY29uc3QgW3Nob3dBbGwsIHNldFNob3dBbGxdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgaW5wdXRSZWYgPSB1c2VSZWYoKTsKCiAgICBjb25zdCB1cGRhdGVMb2cgPSAoKSA9PiB7CiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdHMgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkczsKICAgICAgICBjb25zdCBtZXNzYWdlTG9nQXJyID0gW107CgogICAgICAgIGZvciAoY29uc3QgYm90SUQgb2YgYm90cykgewogICAgICAgICAgICBjb25zdCBtZXNzYWdlQm90ID0gZ2V0Qm90KCJpZCIsIGJvdElEKTsKICAgICAgICAgICAgaWYgKG1lc3NhZ2VCb3QpIHsKICAgICAgICAgICAgICAgIG1lc3NhZ2VMb2dBcnIucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZUJvdC50YWdzLm1lc3NhZ2UsCiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBtZXNzYWdlQm90LnRhZ3MudGltZXN0YW1wLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG1lc3NhZ2VCb3QudGFncy5uYW1lCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBtZXNzYWdlTG9nQXJyLnNvcnQoIChhLCBiKSA9PiBuZXcgRGF0ZShhLnRpbWVzdGFtcCkgPCBuZXcgRGF0ZShiLnRpbWVzdGFtcCkgPyAxIDogLTEgKTsKCiAgICAgICAgc2V0Q29uc29sZUxvZyhtZXNzYWdlTG9nQXJyKTsKICAgIH0KCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIHRoaXNCb3QudmFycy51cGRhdGVMb2cgPSB1cGRhdGVMb2c7CiAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBzZXRTaG93QWxsOwoKICAgICAgICB1cGRhdGVMb2coKTsKCiAgICAgICAgcmV0dXJuICgoKSA9PiB7CiAgICAgICAgICAgIHRoaXNCb3QudmFycy51cGRhdGVMb2cgPSBudWxsOwogICAgICAgICAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCA9IG51bGw7CiAgICAgICAgfSk7CiAgICB9LCBbXSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoaW5wdXRSZWYuY3VycmVudCkgaW5wdXRSZWYuY3VycmVudC5mb2N1cygpOwogICAgfSwgW3Nob3dDaGF0XSk7CgogICAgY29uc3QgaGFuZGxlUG9pbnRlckRvd24gPSAoZSkgPT4gewogICAgICAgIHNldFBvaW50ZXJEb3duUG9zKHsKICAgICAgICAgICAgeDogZS5jbGllbnRYLAogICAgICAgICAgICB5OiBlLmNsaWVudFksCiAgICAgICAgfSkKICAgIH0KCiAgICBjb25zdCBoYW5kbGVQb2ludGVyVXAgPSAoZSkgPT4gewogICAgICAgIGNvbnN0IGRpZmZYID0gTWF0aC5hYnMoZS5jbGllbnRYIC0gcG9pbnRlckRvd25Qb3MueCk7CiAgICAgICAgY29uc3QgZGlmZlkgPSBNYXRoLmFicyhlLmNsaWVudFkgLSBwb2ludGVyRG93blBvcy55KTsKCiAgICAgICAgaWYgKGRpZmZYIDwgNSAmJiBkaWZmWSA8IDUpIHsKICAgICAgICAgICAgc2V0U2hvd0FsbChzID0+ICFzKTsKICAgICAgICB9CgogICAgICAgIHNldFBvaW50ZXJEb3duUG9zKHt4OiAtMSwgeTogLTF9KTsKICAgIH0KCiAgICBjb25zdCBoYW5kbGVTdWJtaXQgPSAoKSA9PiB7CiAgICAgICAgaWYgKHVzZXJJbnB1dCkgewogICAgICAgICAgICB3aGlzcGVyKGdldEJvdCgnc3lzdGVtJywgJ2FiLmFjdGlvbi5hc2snKSwgJ2FiQ29yZU1lbnVBY3Rpb24nLCB1c2VySW5wdXQpCiAgICAgICAgICAgIHNldFVzZXJJbnB1dCgnJyk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJpbnB1dFJlZjoiLCBpbnB1dFJlZi5jdXJyZW50KTsKICAgICAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQudmFsdWUgPSAnJzsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxzdHlsZT57dGFnc1snQXBwLmNzcyddfTwvc3R5bGU+CgogICAgICAgIDxkaXYKICAgICAgICAgICAgaWQ9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZSIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eyhlKSA9PiB7CiAgICAgICAgICAgICAgICBncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbFpvb21hYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH19CiAgICAgICAgICAgIG9uUG9pbnRlckxlYXZlPXsoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmlkID09ICJhYi1jb25zb2xlIil7CiAgICAgICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IHRydWU7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9fQogICAgICAgID4KICAgICAgICAgICAge3RhZ3Muc2hvd1RvcEJhciAmJiA8VG9wQmFyIC8+fQoKICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWxvZyIKICAgICAgICAgICAgICAgIG9uUG9pbnRlckRvd249e2hhbmRsZVBvaW50ZXJEb3dufQogICAgICAgICAgICAgICAgb25Qb2ludGVyVXA9e2hhbmRsZVBvaW50ZXJVcH0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgey8qIE1lc3NhZ2UgaGlzdG9yeSAqLyBBcnJheS5pc0FycmF5KGNvbnNvbGVMb2cpCiAgICAgICAgICAgICAgICA/IHNob3dBbGwKICAgICAgICAgICAgICAgICAgICA/IGNvbnNvbGVMb2cubWFwKChtLCBpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbSB8fCAhbS50aW1lc3RhbXAgfHwgIW0ubWVzc2FnZSkgeyByZXR1cm4gfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA9e20udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U9e20ubWVzc2FnZX0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXttLm5hbWV9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PXtgbWVzc2FnZS0ke2l9YH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICAgICAgICAgICl9KQogICAgICAgICAgICAgICAgICAgIDogPE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXtjb25zb2xlTG9nWzBdPy50aW1lc3RhbXB9CiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U9e2NvbnNvbGVMb2dbMF0/Lm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9e2NvbnNvbGVMb2dbMF0/Lm5hbWV9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgIDogPD48Lz59CgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICB7c2hvd0NoYXQgJiYKICAgICAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtaW5wdXQtY29udGFpbmVyIgogICAgICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgICAgIDxpbnB1dAogICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj0iYXNrIGFiLTEiCiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXtlID0+IHNldFVzZXJJbnB1dChlLnRhcmdldC52YWx1ZSl9CiAgICAgICAgICAgICAgICAgICAgICAgIG9uS2V5RG93bj17ZSA9PiB7IGlmIChlLmtleSA9PT0gJ0VudGVyJykgaGFuZGxlU3VibWl0KCkgfX0KICAgICAgICAgICAgICAgICAgICAgICAgcmVmPXtpbnB1dFJlZn0KICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBjb25zb2xlLXNlbmQtYnRuIG1kLWljb24gbWQtaWNvbi1mb250IgogICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtoYW5kbGVTdWJtaXR9CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6ICc0MHB4JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAnNDhweCcsCiAgICAgICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICAgICAgPnNlbmQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvZGl2Pn0KICAgICAgICA8L2Rpdj4KICAgIDwvPikKfQoKcmV0dXJuIEFwcAonAMOyx7kCuhcLaGlkZUNvbnNvbGUCBADDsse5AuRRnwFAdmFyIGN1cnJlbnRWZXIgPSBtYXNrcy5jb25zb2xlVmVyc2lvbiA/PyAwOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gKTsKbWFza3Mub3BlbiA9IGZhbHNlOwpncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbFpvb21hYmxlID0gbnVsbDsnAMOyx7kCuhcDbG9nAgQAw7LHuQKEU4UJQGxldCBib3RUYWdzID0ge307Cgpjb25zdCBfdGltZXN0YW1wID0gb3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZQoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgY29uc3QgX21lc3NhZ2VUZXh0ID0gU3RyaW5nKHRoYXQpLnNwbGl0KCc6ICcpOwogICAgY29uc3QgX25hbWUgPSBfbWVzc2FnZVRleHQuc2hpZnQoKTsKCiAgICBpZiAoIXRoYXQuaW5jbHVkZXMoJzogJykpIHsKICAgICAgICBib3RUYWdzID0gewogICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgIG5hbWU6ICIiLAogICAgICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiBfbmFtZSwKICAgICAgICAgICAgbWVzc2FnZTogX21lc3NhZ2VUZXh0LmpvaW4oJzogJyksCiAgICAgICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICAgICAgdGltZXN0YW1wOiBfdGltZXN0YW1wLAogICAgICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiCiAgICAgICAgfQogICAgfQoKfSBlbHNlIHsKICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiLAogICAgICAgIC4uLnRoYXQKICAgIH0KfQoKY29uc3QgbG9nQm90ID0gYXdhaXQgY3JlYXRlKGJvdFRhZ3MpOwoKc2hvdXQoIm9uQUJMb2ciLCBsb2dCb3QpOwoKaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAMOyx7kCuhcLc2hvd0NvbnNvbGUCBADDsse5Aopc7QNAaWYgKG1hc2tzLm9wZW4pIHsgcmV0dXJuIH07Cgpjb25maWdCb3QubWFza3MudGFnUG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbFNwYWNlID0gbnVsbDsKCi8vIFVucmVnaXN0ZXIgaW4gY2FzZSBpdCB3YXMgYWxyZWFkeSBvcGVuCnZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7CgpjdXJyZW50VmVyICs9IDE7Cm1hc2tzLmNvbnNvbGVWZXJzaW9uID0gY3VycmVudFZlcjsKLy8gR2V0LCByZWdpc3RlciwgYW5kIGNvbXBpbGUgdGhlIGFwcApjb25zdCBBcHAgPSB0aGlzQm90LmdldEFwcCgpOwphd2FpdCBvcy5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCwgdGhpc0JvdCk7Cm9zLmNvbXBpbGVBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIDxBcHAgLz4pOwptYXNrcy5vcGVuID0gdHJ1ZTsKJwDDsse5AroXBnN5c3RlbQIEAMOyx7kC+F8QYWIuc2hlbGwuY29uc29sZScAw7LHuQK6Fw10b2dnbGVDb25zb2xlAgQAw7LHuQKJYJYBQGlmIChtYXNrcy5vcGVuKSB7CiAgICB3aGlzcGVyKHRoaXNCb3QsICJoaWRlQ29uc29sZSIpOwogICAgbWFza3Mub3BlbiA9IGZhbHNlOwp9IGVsc2UgewogICAgd2hpc3Blcih0aGlzQm90LCAic2hvd0NvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSB0cnVlOwp9JwDDsse5AroXBGZvcm0CBADDsse5AqBhB25vdGhpbmcnAMOyx7kCuhcHYWJTaGVsbAIEAMOyx7kCqGEEdHJ1ZScAw7LHuQK6FwphYklET3JpZ2luAgQAw7LHuQKtYRVhYkNvbnNvbGUgdXBkYXRlIDctMTYnAMOyx7kCuhcGVG9wQmFyAgQAw7LHuQLDYfMEQGNvbnN0IG9mZnNldCA9IDgKY29uc3QgaW5pdGlhbEhlaWdodCA9IDI1Ngpjb25zdCBkcmFnSW50ZXJ2YWwgPSAyNQoKY29uc3QgQnV0dG9uc0JhciA9ICgpID0+IHsKCiAgICBjb25zdCBoYW5kbGVDbG9zZSA9ICgpID0+IHsKICAgICAgICBzaG91dCgnaGlkZUNvbnNvbGUnKTsKICAgIH0KCiAgICByZXR1cm4gKDw+CiAgICAgICAgPGRpdgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtdG9wLWJhciIKICAgICAgICA+CgogICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtYnRuIG1kLWljb24gbWQtaWNvbi1mb250IgogICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlQ2xvc2V9CiAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgIHRvcDogIjhweCIsCiAgICAgICAgICAgICAgICAgICAgcmlnaHQ6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHpJbmRleDogMiwKICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIGNsb3NlCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAKICAgICAgICA8L2Rpdj4KICAgIDwvPikKfQoKcmV0dXJuIEJ1dHRvbnNCYXIKJwDDsse5AroXDXNob3dDaGF0SW5wdXQCBADDsse5ArdmBWZhbHNlJwDDsse5AroXCnNob3dUb3BCYXICBADDsse5Ar1mBWZhbHNlJwDDsse5AroXCWFiVmVyc2lvbgIEAMOyx7kCw2YFMTAuMTAnAMOyx7kCuhcSc2V0QWJFeHBhbmRDb25zb2xlAgQAw7LHuQLJZpcCQGNvbnNvbGUubG9nKHRoaXNCb3QudmFycy5zZXRTaG93QWxsKQppZiAodHlwZW9mIHRoaXNCb3QudmFycy5zZXRTaG93QWxsICE9PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHMgPT4gIXMpOwp9IGVsc2UgaWYgKHRoYXQgPT0gdHJ1ZSkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwodHJ1ZSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChmYWxzZSk7Cn0KJwDDsse5AroXCGFiSWdub3JlAgQAw7LHuQLhaAR0cnVlJwDDsse5AroXB01lc3NhZ2UCBADDsse5AuZowRBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPnttZXNzYWdlfTwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIE1lc3NhZ2U7JwDDsse5AroXEG9uQW55Qm90c1JlbW92ZWQCBADDsse5Aqh5rQJAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90SWQgb2YgYm90SURzKSB7DQogICAgaWYgKHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5kZWxldGUoYm90SWQpOw0KDQogICAgICAgIGlmIChkZWxldGVkKSB7DQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3RJZDogYm90SWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9JwDDsse5AroXDm9uQW55Qm90c0FkZGVkAgQAw7LHuQLWe/gDQGNvbnN0IHsgYm90cyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBuZXdCb3Qgb2YgYm90cykgew0KICAgIGlmIChuZXdCb3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMobmV3Qm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKG5ld0JvdC5pZCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IG5ld0JvdCB9KTsNCiAgICB9DQp9JwDDsse5AroXEG9uQW55Qm90c0NoYW5nZWQCBADDsse5As9/4wVAY29uc3QgYm90cyA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90IG9mIGJvdHMpIHsNCiAgICBpZiAoYm90LmJvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhib3QuYm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKGJvdC5ib3QuaWQpOw0KDQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBib3QuYm90IH0pOw0KICAgICAgICB9IA0KDQogICAgICAgIGlmIChib3QudGFncy5pbmNsdWRlcygibWVzc2FnZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJuYW1lIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoInRpbWVzdGFtcCIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIpKSB7DQogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOyAgICAgICAgDQogICAgICAgIH0NCiAgICB9DQp9JwDDsse5AroXH29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQCBADDsse5ArOFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAMOyx7kCuhcdb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQCBADDsse5AuqFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAQRib3RzJDI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYwEnAMOyx7kCoYYBBnN5c3RlbQIEAMOyx7kCooYBDWFiLnNoZWxsLmhlbHAnAMOyx7kCoYYBCW9uS2V5RG93bgIEAMOyx7kCsIYBiAJAaWYgKHRhZ3MuYWN0aXZlICYmIHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJykpIHsKICAgIGlmICh0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgIGZvciAobGV0IGNhbGxiYWNrIG9mIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0nAMOyx7kCoYYBB3VubW91bnQCBADDsse5ArmIAY4BQGF3YWl0IG9zLmNvbXBpbGVBcHAodGFncy5hcHBJZCwgPD48Lz4pOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKHRhZ3MuYXBwSWQpOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSB1bmRlZmluZWQ7Cm1hc2tzLmFjdGl2ZSA9IGZhbHNlOycAw7LHuQKhhgEJc3R5bGUuY3NzAgQAw7LHuQLIiQHxBy5oZWxwLXRhYmxlIHsKICB3aWR0aDogMTAwJTsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLmhlbHAtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5oZWxwLXRhYmxlIHRkIGgzIHsKICBtYXJnaW46IDA7Cn0KCi5oZWxwLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9Cgouc2VjdGlvbiB7CiAgbWFyZ2luLXRvcDogMTZweDsKfQoKLnNlY3Rpb24gcDpmaXJzdC1vZi10eXBlIHsKICBtYXJnaW4tdG9wOiA0cHg7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5kZXNjcmlwdGlvbiB7IAogIHdoaXRlLXNwYWNlOiBwcmUtbGluZTsKfQoKLnVzYWdlLXRhYmxlIHsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLnVzYWdlLXRhYmxlIHRkLGgzIHsgCiAgdmVydGljYWwtYWxpZ246IHRvcDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgbWFyZ2luOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogNjBweDsKfQoKLmFyZ3MtdGFibGUgewogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouYXJncy10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmFyZ3MtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCksIChtYXgtaGVpZ2h0OiA2MDBweCkgewogIC5oZWxwLXdpbmRvdyB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGxlZnQ6IHVuc2V0OwogICAgdG9wOiB1bnNldDsKICAgIHRyYW5zZm9ybTogdW5zZXQ7CiAgICBtYXgtd2lkdGg6IHVuc2V0OwogICAgbWF4LWhlaWdodDogdW5zZXQ7CiAgICBib3gtc2hhZG93OiB1bnNldDsKICB9Cn0nAMOyx7kCoYYBCW9uRGVzdHJveQIEAMOyx7kCupEBE0B0aGlzQm90LnVubW91bnQoKTsnAMOyx7kCoYYBBW1vdW50AgQAw7LHuQLOkQHxAkBjb25zdCB7CiAgICBhYkNvbW1hbmRzTWFuYWdlciwKICAgIHNlbGVjdGVkQ29tbWFuZAp9ID0gdGhhdCA/PyB7fTsKCmlmIChtYXNrcy5hY3RpdmUpIHsKICAgIGF3YWl0IHRoaXNCb3QudW5tb3VudCgpOwp9Cgpjb25zdCBBcHAgPSB0aGlzQm90LkFwcCgpOwoKYXdhaXQgb3MucmVnaXN0ZXJBcHAodGFncy5hcHBJZCwgdGhpc0JvdCk7CmF3YWl0IG9zLmNvbXBpbGVBcHAodGFncy5hcHBJZCwgPEFwcCBjb21tYW5kcz17YWJDb21tYW5kc01hbmFnZXIuY29tbWFuZHN9IGluaXRpYWxTZWxlY3RlZENvbW1hbmQ9e3NlbGVjdGVkQ29tbWFuZH0vPik7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IFtdOwptYXNrcy5hY3RpdmUgPSB0cnVlOycAw7LHuQKhhgEKY29tcG9uZW50cwIEAMOyx7kCwJQBKPCflJcxMWM5NWM3ZC1hMTkzLTQwMGUtYjcxMC0zYmEwNDg2YTZhMWEnAMOyx7kCoYYBBXV0aWxzAgQAw7LHuQLnlAEo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAw7LHuQKhhgEIYWJJZ25vcmUCBADDsse5Ao6VAQR0cnVlJwDDsse5AqGGAQdhYlNoZWxsAgQAw7LHuQKTlQEEdHJ1ZScAw7LHuQKhhgEJYWJWZXJzaW9uAgQAw7LHuQKYlQEFMTAuMTAnAMOyx7kCoYYBA0FwcAIEAMOyx7kCnpUBsi9AY29uc3QgQXBwQ29udGFpbmVyID0gbGlua3MuY29tcG9uZW50cy5BcHBDb250YWluZXIoKTsKY29uc3QgV2luZG93ID0gbGlua3MuY29tcG9uZW50cy5XaW5kb3coKTsKY29uc3QgVGV4dExpbmsgPSBsaW5rcy5jb21wb25lbnRzLlRleHRMaW5rKCk7CmNvbnN0IGNzcyA9IGxpbmtzLnV0aWxzLmFiQ29tcGlsZUNTUyhbIHRoaXNCb3QsIGxpbmtzLmNvbXBvbmVudHMgXSk7Cgpjb25zdCB7IHVzZVN0YXRlLCB1c2VFZmZlY3QsIHVzZUNhbGxiYWNrLCB1c2VSZWYsIHVzZU1lbW8gfSA9IG9zLmFwcEhvb2tzOwoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBDb21tYW5kPn0gcHJvcHMuY29tbWFuZHMKICovCmNvbnN0IEF2YWlsYWJsZUNvbW1hbmRzID0gKHsgY29tbWFuZHMsIG9uQ29tbWFuZENsaWNrIH0pID0+IHsKICAgIGNvbnN0IGNvbW1hbmROYW1lcyA9IE9iamVjdC5rZXlzKGNvbW1hbmRzKS5zb3J0KCk7CgogICAgY29uc3Qgb25DbG9zZSA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgIH0sIFtdKTsKICAgIAogICAgcmV0dXJuICgKICAgICAgICA8PgogICAgICAgICAgICA8cD48VGV4dExpbmsgb25DbGljaz17b25DbG9zZX0+eyd4IENsb3NlJ308L1RleHRMaW5rPjwvcD4KICAgICAgICAgICAgPGgyPkF2YWlsYWJsZSBDb21tYW5kczwvaDI+CiAgICAgICAgICAgIDxwPlVzYWdlOiAuY29tbWFuZCBbb3B0aW9uc108L3A+CiAgICAgICAgICAgIDxici8+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2hlbHAtdGFibGUnPgogICAgICAgICAgICAgICAge2NvbW1hbmROYW1lcy5tYXAoKG5hbWUpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21tYW5kID0gY29tbWFuZHNbbmFtZV07CgogICAgICAgICAgICAgICAgICAgIGxldCBkZXNjcmlwdGlvbiA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48VGV4dExpbmsgb25DbGljaz17KCkgPT4gb25Db21tYW5kQ2xpY2soY29tbWFuZC5uYW1lKX0+e2NvbW1hbmQubmFtZX08L1RleHRMaW5rPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2Rlc2NyaXB0aW9ufTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSl9CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtDb21tYW5kfSBwcm9wcy5jb21tYW5kCiAqLwpjb25zdCBTcGVjaWZpY0NvbW1hbmQgPSAoeyBjb21tYW5kLCBvbkJhY2sgfSkgPT4gewogICAgbGV0IHVzYWdlID0gJyc7CiAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwogICAgbGV0IGFyZ3MgPSBudWxsOwoKICAgIGlmIChjb21tYW5kLmhlbHApIHsKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLnVzYWdlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbW1hbmQuaGVscC51c2FnZSkpIHsKICAgICAgICAgICAgICAgIHVzYWdlID0gY29tbWFuZC5oZWxwLnVzYWdlLmpvaW4oJ1xuJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5sb25nRGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uOwogICAgICAgIH0gZWxzZSBpZiAoY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAuYXJncyAmJiBjb21tYW5kLmhlbHAuYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGFyZ3MgPSBjb21tYW5kLmhlbHAuYXJnczsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4gIAogICAgICAgICAgICA8cD48VGV4dExpbmsgb25DbGljaz17b25CYWNrfT57JzwgQmFjayd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj57Y29tbWFuZC5uYW1lfTwvaDI+CiAgICAgICAgICAgIHsgdXNhZ2UgJiYKICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J3VzYWdlLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48aDM+VXNhZ2U6PC9oMz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e3VzYWdlfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeyBkZXNjcmlwdGlvbiAmJiAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uJz4KICAgICAgICAgICAgICAgICAgICA8aDM+RGVzY3JpcHRpb246PC9oMz4KICAgICAgICAgICAgICAgICAgICA8cCBjbGFzc05hbWU9J2Rlc2NyaXB0aW9uJz57ZGVzY3JpcHRpb259PC9wPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeyBhcmdzICYmCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkFyZ3VtZW50czo8L2gzPgogICAgICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2FyZ3MtdGFibGUnPgogICAgICAgICAgICAgICAgICAgICAgICB7IGFyZ3MubWFwKChhcmcpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJnLmlkZW50aWZpZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFyZy5pZGVudGlmaWVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gYXJnLmlkZW50aWZpZXIuam9pbignLFxuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gYXJnLmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5kZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0Rlc2NyaXB0aW9uRGlzcGxheSA9IGFyZy5kZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdJZGVudGlmaWVyRGlzcGxheSA/PyAnJ308L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2FyZ0Rlc2NyaXB0aW9uRGlzcGxheSA/PyAnJ308L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgfQogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICA8Lz4KICAgICkKfQoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBDb21tYW5kPn0gcHJvcHMuY29tbWFuZHMKICogQHBhcmFtIHthbnlbXX0gW3Byb3BzLmFyZ3NdCiAqLwpjb25zdCBBcHAgPSAoeyBjb21tYW5kcywgaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCB9KSA9PiB7CiAgICBjb25zdCBbIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kIF0gPSB1c2VTdGF0ZShpbml0aWFsU2VsZWN0ZWRDb21tYW5kKTsKCiAgICAvLyBFc2NhcGUga2V5IHByZXNzIGV2ZW50IGhhbmRsZXIKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgY29uc3Qgb25Fc2NhcGVLZXlQcmVzcyA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkQ29tbWFuZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MucHVzaChvbkVzY2FwZUtleVByZXNzKTsKCiAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tJbmRleCA9IHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLmZpbmRJbmRleCgoY2FsbGJhY2spID0+IGNhbGxiYWNrID09PSBvbkVzY2FwZUtleVByZXNzKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3Muc3BsaWNlKGNhbGxiYWNrSW5kZXgsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgW3NlbGVjdGVkQ29tbWFuZF0pOwogICAgCiAgICBjb25zdCBvbkJhY2tncm91bmRDbGljayA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgIH0sIFtdKTsKCiAgICBjb25zdCBvbkNvbW1hbmRDbGljayA9IHVzZUNhbGxiYWNrKChuYW1lKSA9PiB7CiAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG5hbWUpOwogICAgfSwgW3NldFNlbGVjdGVkQ29tbWFuZF0pCgogICAgY29uc3QgY29udGVudCA9IHVzZU1lbW8oKCkgPT4gewogICAgICAgIGlmICghc2VsZWN0ZWRDb21tYW5kKSB7CiAgICAgICAgICAgIHJldHVybiA8QXZhaWxhYmxlQ29tbWFuZHMgY29tbWFuZHM9e2NvbW1hbmRzfSBvbkNvbW1hbmRDbGljaz17b25Db21tYW5kQ2xpY2t9Lz4KICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgcmV0dXJuIDxTcGVjaWZpY0NvbW1hbmQgY29tbWFuZD17Y29tbWFuZHNbc2VsZWN0ZWRDb21tYW5kXX0gb25CYWNrPXsoKSA9PiBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCl9Lz4KICAgICAgICB9CiAgICB9LCBbY29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kXSk7CgogICAgcmV0dXJuICgKICAgICAgICA8PgogICAgICAgICAgICA8c3R5bGU+e2Nzc308L3N0eWxlPgoKICAgICAgICAgICAgPEFwcENvbnRhaW5lciBvbkJhY2tncm91bmRDbGljaz17b25CYWNrZ3JvdW5kQ2xpY2t9PgogICAgICAgICAgICAgICAgPFdpbmRvdz4KICAgICAgICAgICAgICAgICAgICB7Y29udGVudH0KICAgICAgICAgICAgICAgIDwvV2luZG93PgogICAgICAgICAgICA8L0FwcENvbnRhaW5lcj4KICAgICAgICA8Lz4KICAgICkKfQoKcmV0dXJuIEFwcDsnAMOyx7kCoYYBBWFwcElkAgQAw7LHuQLRxAEPYWItY29tbWFuZC1oZWxwJwEEYm90cyQzNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMBJwDDsse5AuHEAQZzeXN0ZW0CBADDsse5AuLEAQ9hYi5zaGVsbC5jcmVhdGUnAMOyx7kC4cQBBGZvcm0CBADDsse5AvLEAQdub3RoaW5nJwDDsse5AuHEAQtkZXNjcmlwdGlvbgIEAMOyx7kC+sQBPUJvdCB1c2VkIHRvIGNyZWF0ZS9tYW5pZmVzdCBib3RzIGludG8gYW4gYWN0dWFsIHNjZW5lL3BvcnRhbC4nAMOyx7kC4cQBDGFiQ3JlYXRlQm90cwIEAMOyx7kCuMUBsC5AbGV0IHsgCiAgICBpbml0aWFsQm9vdCwgLy8gY2hlY2tzIGZvciBpbml0aWFsIGJvb3QgYm9vbGVhbiAob3B0aW9uYWwpCiAgICBib3REYXRhLCAvLyBib3RzIHRvIGJlIGdlbmVyYXRlZAogICAgb3JpZ2luLCAvLyB3aGVyZSBkaWQgdGhlIGRhdGEgY29tZSBmcm9tIChvcHRpb25hbCkKICAgIHN0dWRpbywgLy8gd2hhdCBzdHVkaW8gaXMgdGhpcyBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgcmVjb3JkLCAvLyBSeWFuIENvb2s6IGRvIHdlIG5lZWQgdGhpcyBpZiB3ZSBhbHJlYWR5IGhhdmUgc3R1ZGlvPyAob3B0aW9uYWwpCiAgICB2ZXJzaW9uLCAvLyB2ZXJzaW9uIG9mIHRoZSBkYXRhIChvcHRpb25hbCkKICAgIGVnZ1BhcmFtZXRlcnMsIC8vIGRhdGEgdG8gcGFzcyB0byBhbGwgY3JlYXRlZCBib3RzIHZpYSBAb25FZ2dIYXRjaC4gKG9wdGlvbmFsKQogICAgaWdub3JlR3JpZEZvY3VzLCAvLyBSeWFuIENvb2s6IGFkZGluZyB0aGlzIGFzIGFuIG9wdGlvbmFsIGZsYWcuIChvcHRpb25hbCkKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgLy8gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlIGNyZWF0ZWQuIChvcHRpb25hbCkKICAgIHNvdXJjZUV2ZW50LCAvLyBzb3VyY2VFdmVudCBpcyBhbiBldmVudCBuYW1lIHRoYXQgc3ltYm9saXplcyB3aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwgdG8gYWJDcmVhdGVCb3RzLiAob3B0aW9uYWwpLgp9ID0gdGhhdDsKCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGZvciB3aGVuIGFiQ3JlYXRlQm90cyBleHBlY3RlZCAiYm90cyIgcGFyYW1ldGVyLgppZiAoIWJvdERhdGEgJiYgdGhhdC5ib3RzKSB7CiAgICBib3REYXRhID0gdGhhdC5ib3RzOwp9CgpsZXQgYm90Q291bnQgPSBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGg7CmNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCi8vIFJ1biBzb21lIGFiLXNwZWNpZmljIHByZXByb2Nlc3Npbmcgb2YgYm90IGRhdGEuCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIGRhdGEudGFncy5hYklET3JpZ2luID0gb3JpZ2luOwogICAgICAgIGRhdGEudGFncy5hYklEU3R1ZGlvID0gc3R1ZGlvOwoKICAgICAgICBpZiAoZGF0YS50YWdzLmNyZWF0b3IpIHsKICAgICAgICAgICAgZGF0YS50YWdzLm9sZENyZWF0b3IgPSBkYXRhLnRhZ3MuY3JlYXRvcjsKICAgICAgICB9CgogICAgICAgIC8vIFJ5YW4gQ29vazogVGhpcyB0YXJnZXRQb3NpdGlvbiBzdHVmZiBpcyBhcHBhcmVudGx5IHVzZWQgZm9yIGJvdCBwYXN0aW5nPyAKICAgICAgICAvLyBUaGlzIGlzIHNvbWUgcmVhbGx5IGNvbmZ1c2luZyBsb2dpYyBhbmQgc2hvdWxkIGJlIHJlZmFjdG9yZWQgZXZlbnR1YWxseS4KICAgICAgICBpZiAoKGJvdENvdW50IDwgMiB8fCBib3RDb3VudCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uICsgJ1gnXSA9IGFiR3JpZEZvY3VzLnBvc2l0aW9uLng7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWSddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueTsKICAgICAgICB9CiAgICB9Cn0KCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlYSBjcmVhdGVkLgpsZXQgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZScsIHByZXByb2Nlc3NBcmcpKTsKCmlmICh0eXBlb2YgYm90RGF0YSAhPT0gJ29iamVjdCcgfHwgT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICAvLyBUaGVyZSBpc24ndCBhbnkgYm90RGF0YSB0byBjcmVhdGUgZnJvbSEKICAgIHJldHVybjsKfQoKLy8gQ3JlYXRlIGJvdHMgZnJvbSB0aGUgYm90IGRhdGEuCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKbGV0IG5ld0JvdElkcyA9IFtdOwoKZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgIGNvbnN0IG5ld0JvdCA9IGNyZWF0ZShkYXRhLnRhZ3MpOwoKICAgICAgICAgICAgaWRNYXAuc2V0KGRhdGEuaWQsIG5ld0JvdC5pZCk7CiAgICAgICAgICAgIG5ld0JvdHMucHVzaChuZXdCb3QpOwogICAgICAgICAgICBuZXdCb3RJZHMucHVzaChuZXdCb3QuaWQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbnZhbGlkIGJvdGAsIGUpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGVkIGJvdDogYCwgZGF0YSk7CiAgICB9Cn0KCi8vIEFycmF5IG9mIHRhZyByZWxhdGlvbnNoaXBzIHRvIGJlIHByZXNlcnZlZApjb25zdCBsaW5rVGFncyA9IFsibGluayIsICJjcmVhdG9yIiwgImNvbmZpZ0JvdCIsICJsaW5lVG8iLCAidHJhbnNmb3JtZXIiLCAiZm9ybUxpZ2h0VGFyZ2V0Il07CgovLyBUaGlzIGxvb3AgY29udGFpbnMgdGhlIGxvZ2ljIGZvciBwcmVzZXJ2aW5nIHRoZSBsaW5rVGFncwpmb3IgKGxldCBuZXdCb3Qgb2YgbmV3Qm90cykgewogICAgZm9yIChsZXQgdGFnIG9mIGxpbmtUYWdzKSB7CiAgICAgICAgbGV0IHZhbHVlID0gbmV3Qm90LnRhZ3NbdGFnXTsKCiAgICAgICAgaWYgKHRhZyA9PSAiY3JlYXRvciIpIHsKICAgICAgICAgICAgdmFsdWUgPSBuZXdCb3QudGFncy5vbGRDcmVhdG9yOwogICAgICAgICAgICBuZXdCb3QudGFncy5vbGRDcmVhdG9yID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUJvdExpbmtzKG5ld0JvdCwgaWRNYXApOwoKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBsZXQgbmV3VmFsdWUgPSB2YWx1ZS5tYXAoaWQgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpZE1hcC5nZXQoaWQpIHx8IGlkOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lEID0gaWRNYXAuZ2V0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3SUQpIHsKICAgICAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdJRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gVG9hc3RzIGZvciBoYXRjaGVzLCBidXQgb25seSBvbiBidWlsZGVyCmlmIChvcmlnaW4gJiYgdmVyc2lvbiAmJiBjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUgPT0gbnVsbCAmJiAhY29uZmlnQm90LnRhZ3MucGggJiYgYnVpbGRlclZlcnNpb24gPT0gImJ1aWxkZXIiKSB7CiAgICBvcy50b2FzdCgiaGF0Y2hlZCAiICsgb3JpZ2luICsgIiB2IiArIHZlcnNpb24pOwp9CgovLyBDcmVhdGUgYWJFZ2cgYm90IHRoYXQgdHJhY2tzIGNhbiBiZSB1c2VkIHRvIHRyYWNrIHdoYXQgZWdncyBoYXZlIGJlZW4gaGF0Y2hlZC4KbGV0IGFiRWdnTGFiZWw7CgppZiAob3JpZ2luKSB7CiAgICBpZiAodmVyc2lvbikgewogICAgICAgIGFiRWdnTGFiZWwgPSBgJHtvcmlnaW59IHYke3ZlcnNpb259YDsKICAgIH0gZWxzZSB7CiAgICAgICAgYWJFZ2dMYWJlbCA9IG9yaWdpbjsKICAgIH0KfSBlbHNlIHsKICAgIGFiRWdnTGFiZWwgPSAndW5rbm93bic7Cn0KCmNvbnN0IGFiRWdnID0gY3JlYXRlKHsKICAgIHNwYWNlOiAic2hhcmVkIiwKICAgIGFiOiB0cnVlLAogICAgYWJFZ2c6IHRydWUsCiAgICBhYklnbm9yZTogdHJ1ZSwKICAgIG9yaWdpbl9hYjogb3JpZ2luLAogICAgb3JpZ2luX3ZlcnNpb246IHZlcnNpb24sCiAgICBvcmlnaW5fcmVjb3JkOiByZWNvcmQsCiAgICBvcmlnaW5fc3R1ZGlvOiBzdHVkaW8sCiAgICBib3RJZHM6IGDwn6esJHtKU09OLnN0cmluZ2lmeShuZXdCb3RJZHMpfWAsCiAgICBzb3VyY2VFdmVudCwKICAgIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LAogICAgZm9ybTogImVnZyIsCiAgICBlZ2dQYXJhbWV0ZXJzOiBlZ2dQYXJhbWV0ZXJzID8gYPCfp6wke0pTT04uc3RyaW5naWZ5KGVnZ1BhcmFtZXRlcnMpfWAgOiBudWxsLAogICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICBsYWJlbDogYWJFZ2dMYWJlbCwKICAgIGhhdGNoZXJSZW1vdGVJZDogY29uZmlnQm90LmlkLAp9KTsKCmNvbmZpZ0JvdC50YWdzLmxhc3RFZ2dIYXRjaGVkID0gb3JpZ2luOwoKd2hpc3BlcihuZXdCb3RzLCAnb25QcmVIYXRjaCcsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKCmlmIChpbml0aWFsQm9vdCkgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBvcmlnaW47Cn0KCi8vIG9uRWdnSGF0Y2ggZm9yIGFsbCBqdXN0IGhhdGNoZWQgYm90cwp3aGlzcGVyKG5ld0JvdHMsICJvbkVnZ0hhdGNoIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIGVnZ1BhcmFtZXRlcnMsIHNvdXJjZUV2ZW50IH0pOwoKLy8gb25BYkFkZGVkIGZvciBhbGwgYm90cyBpbiB0aGUgZXhwZXJpZW5jZQpzdXBlclNob3V0KCJvbkFCQWRkZWQiLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQgfSk7CnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgppZiAob3MuaXNDb2xsYWJvcmF0aXZlKCkpIHsKICAgIC8vIFJlbW90ZSBzaG91dCB0byBhbGwgb3RoZXIgY29ubmVjdGVkIHJlbW90ZXMgdGhhdCBhIHJlbW90ZSBoYXMgYWRkZWQgYW4gYWIuCiAgICBjb25zdCByZW1vdGVJZHMgPSBhd2FpdCBvcy5yZW1vdGVzKCk7CiAgICBjb25zdCBzZWxmSW5kZXggPSByZW1vdGVJZHMuaW5kZXhPZihjb25maWdCb3QuaWQpOwogICAgaWYgKHNlbGZJbmRleCA+IDApIHsKICAgICAgICByZW1vdGVJZHMuc3BsaWNlKHNlbGZJbmRleCwgMSk7CiAgICB9CgogICAgc2VuZFJlbW90ZURhdGEocmVtb3RlSWRzLCAncmVtb3RlX2FiX2FkZGVkJywgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50LCBhYkVnZ0lkOiBhYkVnZy5pZCB9KTsKCn0KCnJldHVybiBuZXdCb3RzOycAw7LHuQLhxAEIcmVtZW1iZXICBADDsse5AuXzASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDDsse5AuHEAQhhYklnbm9yZQIEAMOyx7kCjPQBBHRydWUnAMOyx7kC4cQBB2FiU2hlbGwCBADDsse5ApH0AQR0cnVlJwDDsse5AuHEAQlhYlZlcnNpb24CBADDsse5Apb0AQUxMC4xMCcAw7LHuQLhxAELcGVyc29uYWxpdHkCBADDsse5Apz0ASjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDDsse5AuHEAQxvblJlbW90ZURhdGECBADDsse5AsP0Ae4KQGlmICh0aGF0Lm5hbWUgPT09ICdyZW1vdGVfYWJfYWRkZWQnKSB7CiAgICBjb25zdCBhYkVnZ0lkID0gdGhhdC50aGF0LmFiRWdnSWQ7CgogICAgaWYgKGFiRWdnSWQpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXJ0aW5nIHNlYXJjaCBmb3IgYWJFZ2cgYm90IHdpdGggaWQgJHthYkVnZ0lkfSwgRXZlbnQgZGF0YTpgLCB0aGF0LnRoYXQpOwogICAgICAgIH0KCiAgICAgICAgLy8gV2FpdCBmb3IgdGhlIGFiRWdnIGJvdCB0byBhcnJpdmUuIE9uY2UgaXQgaGFzLCB3ZSBzaG91bGQgYmUgYWJsZSB0byBzYWZlbHkgc2hvdXQgb25SZW1vdGVBQkFkZGVkIGFuZCBoYXZlIGFsbCB0aGUgYm90cyBpbiB0aGUgaW5zdC4KICAgICAgICBsZXQgYWJFZ2cgPSBnZXRCb3QoJ2lkJywgYWJFZ2dJZCk7CiAgICAgICAgbGV0IGFjY3VtU2VhcmNoVGltZSA9IDA7CiAgICAgICAgY29uc3QgTUFYX1NFQVJDSF9USU1FX01TID0gMjAwMDA7CiAgICAgICAgY29uc3QgU0VBUkNIX0lOVEVSVkFMX01TID0gMjUwOwogICAgICAgIAogICAgICAgIHdoaWxlKCFhYkVnZykgewogICAgICAgICAgICBhd2FpdCBvcy5zbGVlcChTRUFSQ0hfSU5URVJWQUxfTVMpOwoKICAgICAgICAgICAgaWYgKGFjY3VtU2VhcmNoVGltZSA8PSBNQVhfU0VBUkNIX1RJTUVfTVMpIHsKICAgICAgICAgICAgICAgIGFjY3VtU2VhcmNoVGltZSArPSBTRUFSQ0hfSU5URVJWQUxfTVM7CiAgICAgICAgICAgICAgICBhYkVnZyA9IGdldEJvdCgnaWQnLCBhYkVnZ0lkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZW1vdGVfYWJfYWRkZWQgZXZlbnQgcmVjZWl2ZWQgYnV0IGFiRWdnSWQgJHthYkVnZ0lkfSBuZXZlciBhcnJpdmVkLmApOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChhYkVnZykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBhYkVnZyBib3Qgd2l0aCBpZCAke2FiRWdnSWR9YCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN1cGVyU2hvdXQoJ29uUmVtb3RlQUJBZGRlZCcsIHRoYXQudGhhdCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVtb3RlX2FiX2FkZGVkIGV2ZW50IHJlY2VpdmVkIGJ1dCBub3QgYWJFZ2dJZCB3YXMgcHJvdmlkZWQuIEV2ZW50IGRhdGE6YCwgdGhhdC50aGF0KTsKICAgIH0KfScAw7LHuQLhxAEFZGVidWcCBADDsse5ArL/AQVmYWxzZScBBGJvdHMkNTI4ZGMwZjktNDNlYy00M2YzLWE0NzAtZTJkZDZhMGRhOTVmAScAw7LHuQK4/wEGc3lzdGVtAgQAw7LHuQK5/wEQYWIuc2hlbGwudmVyc2lvbicAw7LHuQK4/wEEZm9ybQIEAMOyx7kCyv8BB25vdGhpbmcnAMOyx7kCuP8BCGFiSWdub3JlAgQAw7LHuQLS/wEEdHJ1ZScAw7LHuQK4/wEHYWJTaGVsbAIEAMOyx7kC1/8BBHRydWUnAMOyx7kCuP8BE2FiU2hlbGxNYWpvclZlcnNpb24CBADDsse5Atz/AQEzJwDDsse5Arj/AQ1vblNraWxsVXBkYXRlAgQAw7LHuQLe/wGXAUBjb25zdCB2ZXJzaW9uU3RyaW5nID0gdGFncy5hYlNoZWxsTWFqb3JWZXJzaW9uICsgIi4iICsgdGFncy5hYlNoZWxsTWlub3JWZXJzaW9uOw0KDQpjb25zb2xlLmxvZygiW0FCU2hlbGxdIExvYWRlZCBBQiBzaGVsbCB2ZXJzaW9uICIgKyB2ZXJzaW9uU3RyaW5nKTsnAMOyx7kCuP8BCWFiVmVyc2lvbgIEAMOyx7kC9oACBTEwLjEwJwDDsse5Arj/ARNhYlNoZWxsTWlub3JWZXJzaW9uAgQAw7LHuQL8gAIBNScBBGJvdHMkNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmAScAw7LHuQL+gAIGc3lzdGVtAgQAw7LHuQL/gAIOYWIuc2hlbGwuc3RvcmUnAMOyx7kC/oACBGZvcm0CBADDsse5Ao6BAgdub3RoaW5nJwDDsse5Av6AAgtkZXNjcmlwdGlvbgIEAMOyx7kCloECP1RoaXMgc2tpbGwgaXMgbWVhbnQgdG8gYmUgYSBjb25maWd1cmFibGUgbWVhbnMgdG8gcHVibGlzaCBkYXRhLicAw7LHuQL+gAIPYWJQdWJsaXNoUmVjb3JkAgQAw7LHuQLWgQL1C0Bhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nOwpsZXQgcmVjb3JkRGF0YSA9IHRoYXQuZGF0YTsKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CmxldCBlbmRwb2ludCA9IHRoYXQuZW5kcG9pbnQgPyB0aGF0LmVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgYWRkaXRpb25hbE1hcmtlcnMgPSB0aGF0LmFkZGl0aW9uYWxNYXJrZXJzOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CmxldCB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdHJ1ZTsKCmlmICghcmVjb3JkRGF0YSkgewogICAgcmV0dXJuICJubyBkYXRhIHN1cHBsaWVkIjsKfQoKaWYgKGFkZGl0aW9uYWxNYXJrZXJzKSB7CiAgICAvLyBNYWtlIHN1cmUgYWRkaXRpb25hbCBtYXJrZXJzIGlzIGluIGFuIGFycmF5LgogICAgaWYgKHR5cGVvZiBhZGRpdGlvbmFsTWFya2VycyA9PT0gJ3N0cmluZycpIHsKICAgICAgICBhZGRpdGlvbmFsTWFya2VycyA9IFthZGRpdGlvbmFsTWFya2Vyc107CiAgICB9Cn0KCmNvbnN0IG1hcmtlcnNTZXQgPSBuZXcgU2V0KGFkZGl0aW9uYWxNYXJrZXJzID8/IFtdKTsKbWFya2Vyc1NldC5hZGQocmVjb3JkTmFtZSk7CgppZiAocHVibGljRmFjaW5nKSB7CiAgICBtYXJrZXJzU2V0LmFkZCgncHVibGljUmVhZCcpOwp9CgpyZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7IGVuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogQXJyYXkuZnJvbShtYXJrZXJzU2V0KSB9KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZERhdGEgcmVzdWx0OmAsIHJlY29yZERhdGEpOwp9CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYGRhdGEgcHVibGlzaGVkIHRvIHJlY29yZCAke3VzZXJSZWNvcmR9IGF0IGFkZHJlc3MgJHtyZWNvcmROYW1lfWAsIGxvZ1R5cGU6ICdsb2cnLCB0b2FzdDogdG9hc3QgfSk7Cn0gZWxzZSB7CiAgICBhYi5saW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBkYXRhIGZhaWxlZCB0byBwdWJsaXNoIHRvIHJlY29yZCAke3VzZXJSZWNvcmR9IGF0IGFkZHJlc3MgJHtyZWNvcmROYW1lfVxuJHtKU09OLnN0cmluZ2lmeShyZWNvcmREYXRhLCB1bmRlZmluZWQsIDIpfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CgogICAgaWYgKHRvYXN0KSB7CiAgICAgICAgYWIubGlua3MudXRpbHMuYWJUb2FzdCh7IG1lc3NhZ2U6IGBkYXRhIGZhaWxlZCB0byBwdWJsaXNoIHRvIHJlY29yZCAke3VzZXJSZWNvcmR9IGF0IGFkZHJlc3MgJHtyZWNvcmROYW1lfS4gJHtyZWNvcmREYXRhLmVycm9yTWVzc2FnZX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgfQp9CgpyZXR1cm4gcmVjb3JkRGF0YTsnAMOyx7kC/oACDWFiUHVibGlzaEZpbGUCBADDsse5AsyNAr4JQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgppZiAoIXRoaXNCb3QuY2FuUHVibGlzaEZpbGUoKSkgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICBlcnJvckNvZGU6ICdub3RfYXV0aG9yaXplZCcsCiAgICAgICAgZXJyb3JNZXNzYWdlOiAnVXNlciBpcyBub3QgYXV0aG9yaXplZCB0byBwdWJsaXNoIGZpbGVzLicKICAgIH0KfQoKbGV0IGZpbGUgPSB0aGF0LmZpbGU7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZU5hbWU7CmxldCBtaW1lVHlwZSA9IHRoYXQubWltZVR5cGU7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghZmlsZSkgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICBlcnJvckNvZGU6ICdpbnZhbGlkX2ZpbGVfZGF0YScsCiAgICAgICAgZXJyb3JNZXNzYWdlOiAnQSBmaWxlIG11c3QgYmUgcHJvdmlkZWQgdG8gcHVibGlzaC4nCiAgICB9Cn0KCmxldCBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7IGRlc2NyaXB0aW9uOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlIH0pOwoKaWYgKCFmaWxlVXBsb2FkLnN1Y2Nlc3MpIHsKICAgIGlmIChmaWxlVXBsb2FkLmVycm9yQ29kZSA9PSAiZmlsZV9hbHJlYWR5X2V4aXN0cyIpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmaWxlIGFscmVhZHkgZXhpc3RzIGluICR7dXNlclJlY29yZH1gLCBsb2dUeXBlOiAnbG9nJyB9KTsKICAgICAgICByZXR1cm4gZmlsZVVwbG9hZDsKICAgIH0KCiAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24odXNlclJlY29yZCk7CgogICAgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwgeyBkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZSB9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykgewogICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmlsZSByZWNvcmRlZCB0byAke3VzZXJSZWNvcmR9YCwgbG9nVHlwZTogJ2xvZycgfSk7Cn0KZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmaWxlIGZhaWxlZCB0byByZWNvcmRgLCBsb2dUeXBlOiAnZXJyb3InIH0pOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAMOyx7kC/oACEGFiQ29yZU1lbnVBY3Rpb24CBADDsse5AouXAk1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAw7LHuQL+gAILb25TdG9yZU1lbnUCBADDsse5AtmXAvCVAUBsZXQgcG9zc2libGVQdWJsaXNoQm90ID0gbmV3IFNldCgpOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cykgewogICAgaWYgKEFycmF5LmlzQXJyYXkobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSkgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cy5mb3JFYWNoKGIgPT4gcG9zc2libGVQdWJsaXNoQm90LmFkZChiKSk7CiAgICB9IGVsc2UgewogICAgICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKTsKICAgIH0KfQoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIHsKICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyk7Cn0KCnBvc3NpYmxlUHVibGlzaEJvdCA9IEFycmF5LmZyb20ocG9zc2libGVQdWJsaXNoQm90KTsKCmNvbnN0IGJhc2VBQiA9ICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzID8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMuaWQ7CmNvbnN0IGJhc2VCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBiYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgZGVmYXVsdHMgPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIG1hbmFnZXI6ICLwn5SXIiArIHRoaXNCb3QuaWQsCiAgICBtYW5pZmVzdGF0aW9uOiB0YWdzLm1hbmlmZXN0YXRpb24sCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YAp9CgovLyBDcmVhdGUgZG93bmxvYWQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgbGFiZWw6ICJkb3dubG9hZCIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybUFkZHJlc3M6ICJnZXRfYXBwIiwKICAgIHBvc3NpYmxlQm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiRG93bmxvYWQoeyBwb3NzaWJsZUJvdHM6IGxpbmtzLnBvc3NpYmxlQm90fSk7YAp9KTsKCmlmICghYXV0aEJvdCkgCnsKICAgIC8vIENyZWF0ZSBsb2dpbiBtZXNzYWdlCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgICAgIGxhYmVsOiAicGxlYXNlIHNpZ24gaW4gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siLAogICAgICAgIG9uQ2xpY2s6IGBAIG9zLnJlcXVlc3RBdXRoQm90KClgCiAgICB9KTsKCiAgICByZXR1cm47Cn0KZWxzZSBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIgPT0gIkZyZWVQbGF5IikgCnsKICAgIC8vIENyZWF0ZSB1cGdyYWRlIHN1YnNjcmlwdGlvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInBsZWFzZSB1cGdyYWRlIHlvdXIgc3Vic2NyaXB0aW9uIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIgogICAgfSk7CgogICAgcmV0dXJuOwp9CgoKbGV0IHVzZXJTdHVkaW9zID0gY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zOwoKaWYgKCF1c2VyU3R1ZGlvcykgCnsKICAgIHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7Cn0KCmlmICh1c2VyU3R1ZGlvcy5zdWNjZXNzKSAKewogICAgY29uc3QgYWN0aXZlU3R1ZGlvID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCk7CgogICAgbGV0IGJhc2VTdHVkaW8gPSBhdXRoQm90LmlkOwoKICAgIGlmIChiYXNlU3R1ZGlvID09IGF1dGhCb3QuaWQpIAogICAgewogICAgICAgIGJhc2VTdHVkaW8gPSAicGxheWVyIjsKICAgIH0KCiAgICBpZiAoYWN0aXZlU3R1ZGlvID09IC0xICYmIGJhc2VTdHVkaW8gIT0gInBsYXllciIpIAogICAgewogICAgICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYmFzZVN0dWRpbzsKICAgIH0KCiAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICYmICFhY3RpdmVTdHVkaW8pIAogICAgewogICAgICAgIGNvbnN0IHN0dWRpb01hdGNoID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCgogICAgICAgIGlmIChzdHVkaW9NYXRjaCAhPSAtMSkgewogICAgICAgICAgICBiYXNlU3R1ZGlvID0gYmFzZVN0dWRpbzsKICAgICAgICB9CiAgICB9CgogICAgY29uc3Qgc3R1ZGlvTGFiZWwgPSBhY3RpdmVTdHVkaW8gPT0gLTEgPyBiYXNlU3R1ZGlvIDogdXNlclN0dWRpb3Muc3R1ZGlvc1thY3RpdmVTdHVkaW9dLmRpc3BsYXlOYW1lOwoKICAgIC8vIENyZWF0ZSBzdHVkaW8gc2VsZWN0IGJ1dHRvbgogICAgY29uc3Qgc3R1ZGlvRGlzcGxheUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInN0dWRpbz0iICsgc3R1ZGlvTGFiZWwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUsCiAgICAgICAgc3R1ZGlvSW5mb3JtYXRpb246IHVzZXJTdHVkaW9zLAogICAgICAgIGZvcm1BZGRyZXNzOiAiaW52ZW50b3J5XzIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuc3R1ZGlvU2VsZWN0KHRhZ3Muc3R1ZGlvSW5mb3JtYXRpb24pO2AKICAgIH0pOwoKICAgIG1hc2tzLnN0dWRpb1NlbGVjdEJ1dHRvbiA9IGdldExpbmsoc3R1ZGlvRGlzcGxheUJ1dHRvbik7Cn0KCmNvbnN0IHRvdGFsQm90Q291bnQgPSBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoID4gMCA/IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggbGFiZWwgYnV0dG9uCmNvbnN0IGxhYmVsQm90ID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBsYWJlbDogYHB1Ymxpc2ggcGF0dGVybiAke2Jhc2VCb3RzLmxlbmd0aCA+IDAgPyAiIiA6ICJhcyAifSR7YmFzZUFCfSAoJHt0b3RhbEJvdENvdW50fSBib3Qke2Jhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgdG90YWxCb3RzOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoLAogICAgYWJNZW51U29ydE9yZGVyOiAxLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgZm9ybUFkZHJlc3M6IG51bGwsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IDhweCAwcHggMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItdG9wLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgc2hpZnRTdGF0ZTogZmFsc2UsCiAgICBvbkNsaWNrOiBgQCBjb25zdCBtZW51Qm90cyA9IGdldEJvdHMoJ2FiTWVudVNvcnRPcmRlcicpOwoKICAgICAgICBpZiAodGFncy5zaGlmdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5VXAiLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleURvd24iLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRhZ3Muc2hpZnRTdGF0ZSA9ICF0YWdzLnNoaWZ0U3RhdGU7YCwKICAgIHNjYWxlWTogImF1dG8iLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgbGV0IHRvdGFsQm90cyA9IGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA/IHRoYXQuYWJCb3RzIDogdGhhdC5hYkJvdHMgKyB0aGF0Lm5vbkFCQm90czsKCiAgICBjb25zdCB0b3RhbEJvdFZhciA9IHRvdGFsQm90cyA9PSAxID8gIiBib3QiIDogIiBib3RzIjsKICAgIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzPy5sZW5ndGggID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICBpZiAoZ2V0Qm90KCJhYklET3JpZ2luIiwgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKS5sZW5ndGg7CgogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIGFiQm90cyArICIgYm90cykiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IGFiQm90czsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoIHBhdHRlcm4gYXMgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgICAgICB9ICAgCiAgICB9CiAgICBlbHNlCiAgICB7ICAgCiAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoICIgKyB0aGF0LmFiICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgfWAKfSk7CgovLyBDcmVhdGUgZW5jcnlwdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgbGFiZWw6ICJlbmNyeXB0IiwKICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgZW5jcnlwdFN0YXRlOiBmYWxzZSwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MuZW5jcnlwdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IHRydWU7CiAgICAgICAgfWAsCn0pOwoKbGV0IGFiQnV0dG9uOwoKaWYgKHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy8gQ3JlYXRlIGluY2x1ZGVCb3RzIGJ1dHRvbgogICAgYWJCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUyLAogICAgICAgIGFiU2VsZWN0aW9uQnV0dG9uOiB0cnVlLAogICAgICAgIGxhYmVsOiBiYXNlQm90cy5sZW5ndGggPiAwICYmIGJhc2VBQiAhPSB1bmRlZmluZWQgPyBgc2VsZWN0ZWQgcGF0dGVybjogJHtiYXNlQUJ9ICgke2Jhc2VCb3RzLmxlbmd0aH0gYm90JHtiYXNlQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgIDogYG5ldyBwYXR0ZXJuICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICdlZ2cnLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYlB1Ymxpc2hTZWxlY3QoKTtgLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhck5vbiA9IHRoYXQubm9uQUJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIGNvbnN0IGJvdFZhckFCID0gdGhhdC5hYkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gdGhhdC5hYiArICIgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhck5vbjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJzZWxlY3RlZCBwYXR0ZXJuOiAiICsgdGhhdC5hYiArICIgKCIgKyB0aGF0LmFiQm90cyArIGJvdFZhckFCOwogICAgICAgIH1gCiAgICB9KTsKfQoKaWYgKG5vbkFCQm90cy5sZW5ndGggPiAwICYmIHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy9pY2x1ZGUgbmV3IGJvdHMKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUzLAogICAgICAgIGFiQnV0dG9uOiBnZXRMaW5rKGFiQnV0dG9uKSwKICAgICAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICAgICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgICAgICBsYWJlbDogYGluY2x1ZGUgbmV3ICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3giLAogICAgICAgIHVuY2xhaW1lZFN0YXRlOiBmYWxzZSwKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSBsaW5rcy5hYkJ1dHRvbi50YWdzLmxhYmVsOwoKICAgICAgICAgICAgICAgIGlmIChsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRhZ3MudW5jbGFpbWVkU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogbm9uQUJCb3RzLmxlbmd0aH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKCiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IDB9KTsKICAgICAgICAgICAgfWAsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHMgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJpbmNsdWRlIG5ldyAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyOwoKICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IHRoYXQuYWI7CgogICAgICAgICAgICBpZighbGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSBwdWJsaWMgYnV0dG9uCmlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgCnsKICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IGZhbHNlOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICAgICAgbGFiZWw6ICJpc1B1YmxpYyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICAgICAgcHVibGljU3RhdGU6IGZhbHNlLAogICAgICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MucHVibGljU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgdmVyc2lvbiBzZWxlY3QgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGxhYmVsOiAndmVyc2lvbkZsYWc9Y3VycmVudCcsCiAgICBmb3JtQWRkcmVzczogJ2FsdF9yb3V0ZScsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgc2hvdXQoJ3Nob3dWZXJzaW9uU2VsZWN0b3InKTtgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmxhYmVsID0gJ3ZlcnNpb25GbGFnPScgKyB0aGF0OwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgYCwKfSk7CgovLyBDdXJyZW50IFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2N1cnJlbnQnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX2NoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIEZlZWRiYWNrIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2ZlZWRiYWNrJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTExLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ2ZlZWRiYWNrJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBTdGFibGUgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnc3RhYmxlJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEyLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ3N0YWJsZSc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA0LAogICAgZm9ybUFkZHJlc3M6ICJlZ2ciLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCAwcHggOHB4IDhweCIsCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItYm90dG9tLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm06ICJpbnB1dCIsCiAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICBvbklucHV0VHlwaW5nOiBgQCBsaW5rcy5sYWJlbEJvdC50YWdzLmxhYmVsID0gJ3B1Ymxpc2ggcGF0dGVybiBhcyAnICsgdGhhdC50ZXh0ICsgJyAoJyArIGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzICsgJyBib3QnICsgKGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzID09IDEgPyAnKScgOiAncyknKTtgLAogICAgbWVudUl0ZW1TaG93U3VibWl0V2hlbkVtcHR5OiB0cnVlLAogICAgdGFyZ2V0Qm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBtZW51SXRlbVRleHQ6IGJhc2VBQiwKICAgIG9uU3VibWl0OiBgQAogICAgICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQudGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0YXJnZXRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwogICAgICAgICAgICBjb25zdCBjb25maXJtUHVzaCA9IGF3YWl0IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgICAgIHRpdGxlOiAiY29uZmlybSBwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICJwdWJsaXNoICIgKyB0aGF0LnRleHQgKyAiIHRvICIgKyB0YXJnZXRTdHVkaW8gKyAiPyIsCiAgICAgICAgICAgICAgICBjb25maXJtVGV4dDogInB1Ymxpc2giLAogICAgICAgICAgICAgICAgY2FuY2VsVGV4dDogImNhbmNlbCIKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIWNvbmZpcm1QdXNoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoQUIoeyBhYjogdGhhdC50ZXh0LCBib3Q6IGxpbmtzLnRhcmdldEJvdCwgYmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgbWFudWFsUHVibGlzaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdzdG9yZV9tZW51JyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJhYiBub3Qgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSB0aGF0LmFiOwogICAgfWAKfSk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgCnsKICAgIC8vIENyZWF0ZSBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDgsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAiY29weSB0byBjbGlwYm9hcmQiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiZmlsZV9jb3B5IiwKICAgICAgICB0YXJnZXRCb3Q6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RGb2N1cywKICAgICAgICBvbkNsaWNrOiBgQCBsZXQgc2VsZWN0ZWRCb3QgPSBsaW5rcy50YXJnZXRCb3Q7CiAgICAgICAgICAgIGxldCBwcmVwcGVkQm90ID0gSlNPTi5zdHJpbmdpZnkoc2VsZWN0ZWRCb3QpOwogICAgICAgICAgICBsZXQgc3RhdGUgPSB7fQoKICAgICAgICAgICAgc3RhdGVbYWJJbnN0TWVtb3J5LnRhZ3MuYWJGb2N1c0RhdGFdID0gc2VsZWN0ZWRCb3Q7CgogICAgICAgICAgICBsZXQgbmV3RmlsZSA9IHt9CiAgICAgICAgICAgIG5ld0ZpbGUudmVyc2lvbiA9IDE7CiAgICAgICAgICAgIG5ld0ZpbGUuc3RhdGUgPSBzdGF0ZTsKCiAgICAgICAgICAgIHZhciBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkobmV3RmlsZSk7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChmb3JtYXR0ZWRGaWxlKTsKCiAgICAgICAgICAgIG9zLnRvYXN0KCJib3QgY29waWVkIHRvIGNsaXBib2FyZCIpOwoKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CiAgICAgICAgYCwKICAgIH0pOwp9CmVsc2UgCnsKICAgIC8vIENyZWF0ZSBzY2FuIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMTAsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyAgICAgICAgICAgIAogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAic2NhbiB0byBwdWJsaXNoIiwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgb25DbGljazogYEAgY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSB0cnVlOyBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpO2AsCiAgICB9KTsKfQoKbGV0IGhvc3RCdXR0b24gPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDUwLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgZm9ybUFkZHJlc3M6ICJncm91cF9hZGQiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLmxlYXJuLmFiQ3JlYXRlSG9zdCh0aGlzQm90KTsKICAgIGlmICghbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpCiAgICB7CiAgICAgICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKICAgIH1gLAp9OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMCwgMykgKyAiLSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMyk7Cn0KZWxzZSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJnZW5lcmF0ZSBqb2luIGNvZGUiOwp9CgppZiAoY29uZmlnQm90LnRhZ3Muc3RhdGljSW5zdCA9PSB1bmRlZmluZWQpCnsKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGhvc3RCdXR0b24pOy8vZ2VuZXJhdGUgYSBob3N0IGJ1dHRvbgp9JwDDsse5Av6AAg5hYkNvcmVNZW51SWNvbgIEAMOyx7kCvK0DCWlvc19zaGFyZScAw7LHuQL+gAIPYWJDb3JlTWVudUxhYmVsAgQAw7LHuQLGrQMFc2hhcmUnAMOyx7kC/oACE2FiQ29yZU1lbnVTb3J0T3JkZXICBADDsse5AsytAwEzJwDDsse5Av6AAghyZW1lbWJlcgIEAMOyx7kCzq0DKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMOyx7kC/oACC2FiUHVibGlzaEFCAgQAw7LHuQL1rQPwO0BpZiAoIWF1dGhCb3QpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAibXVzdCBiZSBsb2dnZWQgaW4gdG8gcHVibGlzaCBwYXR0ZXJucy4iLCBsb2dUeXBlOiAiZXJyb3IiIH0pOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QuY2FuUHVibGlzaEZpbGUoKSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJtdXN0IGhhdmUgc3Vic2NyaXB0aW9uIHRoYXQgc3VwcG9ydHMgZmlsZSBwdWJsaXNoaW5nLiIsIGxvZ1R5cGU6ICJlcnJvciIgfSk7CiAgICByZXR1cm4gCn0KCmlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJwYXR0ZXJuIG5hbWVzIG1heSBub3QgY29udGFpbiBzcGFjZXMgb3IgcXVvdGFpb24gbWFya3MsIHBsZWFzZSB0cnkgYWdhaW4uIiwgbG9nVHlwZTogImVycm9yIiB9KTsKICAgIHJldHVybjsKfQoKCmxpbmtzLnV0aWxzLmFiTG9nKGBwdWJsaXNoaW5nICR7dGhhdC5hYn1gKTsKCmlmICghdGhhdC5rZWVwTWVudSkgewogICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKfQoKLy9hYiB2YXJpYWJsZXMKY29uc3QgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKY29uc3QgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpjb25zdCBiYXNlQUIgPSB0aGF0LmJhc2VBQiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPz8gKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQpOwpjb25zdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoID0gdGhhdC5vblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOyAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4gKG9wdGlvbmFsKQpjb25zdCBtYW51YWxQdWJsaXNoID0gdGhhdC5tYW51YWxQdWJsaXNoOwpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQuc291cmNlRXZlbnQ7IC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQpjb25zdCBzdGF0ZSA9IHt9OwpsZXQgZm9ybWF0dGVkRmlsZSA9IHt9OwoKY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKCmxldCBidXN5SW5kaWNhdG9yOwppZiAobWFudWFsUHVibGlzaCAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKSB7CiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKICAgIGlmICghbGlua3MubWVudSkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7CiAgICB9CiAgICAKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgdXBsb2FkaW5nICR7dGhhdC5hYn1gLCBvbkRlc3Ryb3k6IGBAY29uc29sZS5sb2coJ2J1c3kgaW5kaWNhdG9yIGdvIGJvb20nKWB9KTsKfQoKLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byBzdGFydCBwdWJsaXNoaW5nLgpjb25zdCBiZWZvcmVQdWJsaXNoQXJnID0geyBhYjogYWJJRCwgc3R1ZGlvLCBwdWJsaWNGYWNpbmcsIHNvdXJjZUV2ZW50IH07CmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZVB1Ymxpc2gnLCBiZWZvcmVQdWJsaXNoQXJnKSk7CgppZiAoIXRhcmdldCB8fCB0YXJnZXQubGVuZ3RoIDwgMSkgewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCAmJiBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT09IGFiSUQpOwoKICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwogICAgfSBlbHNlIGlmIChjb25maWdCb3QudGFncy5zZWxlY3RlZEFCICYmIGdldEJvdCgiYWJJRE9yaWdpbiIsIGJhc2VBQikpIHsKICAgICAgICBjb25zdCBlZ2dCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIpOwogICAgICAgIGNvbnN0IG5ld0JvdHMgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSAmJiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsKTsKCiAgICAgICAgdGFyZ2V0ID0gWy4uLmVnZ0JvdHMsIC4uLm5ld0JvdHNdOwogICAgfSBlbHNlIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CiAgICB9CgogICAgc2V0VGFnKHRhcmdldCwgImFiSURPcmlnaW4iLCBhYklEKTsKCiAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCID0gbnVsbDsKCiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBib3RzIGZvdW5kIHRvIHB1Ymxpc2giKTsKCiAgICAgICAgaWYgKCF0aGF0LmtlZXBNZW51KSB7CiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7IAogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgZ2VuZXJhdGluZyBhIGtleSBmb3IgZW5jcnlwdGlvbiAob3B0aW9uYWwpCmlmIChjb25maWdCb3QudGFncy5lbmNyeXB0aW9uKSB7CiAgICBsZXQga2V5Q2hlY2s7CgogICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CgogICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgdGl0bGU6ICdlbnRlciBhIHNlY3JldCBrZXknCiAgICB9KTsKCiAgICBpZiAoa2V5KSB7CiAgICAgICAga2V5Q2hlY2sgPSBhd2FpdCBvcy5zaG93SW5wdXQoIiIsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnY29uZmlybSBzZWNyZXQga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGlmIChrZXkgIT0ga2V5Q2hlY2spIHsKICAgICAgICBpZiAoIWtleUNoZWNrKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoIm5vIGtleSBlbnRlcmVkIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgia2V5cyBkbyBub3QgbWF0Y2giKTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhhdC5rZWVwTWVudSkgewogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vZm9ybWF0dGluZyBib3RzIGZvciBmaWxlIHN0b3JhZ2UKaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YXJnZXQubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgY3VycmVudEJvdElEID0gdGFyZ2V0W2ldLmlkOwogICAgICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGFyZ2V0W2ldKSk7CgogICAgICAgIHN0YXRlW2N1cnJlbnRCb3RJRF0gPSBjdXJyZW50Qm90RGF0YTsKICAgIH0KfQplbHNlIHsKICAgIHN0YXRlW3RhcmdldC5pZF0gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldCkpOwp9CgovL2NoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhbmQgcmV0dXJucyBkYXRhIGZvciBwcmV2aW91c2x5IHB1Ymxpc2hlZCBhYidzCmxldCBlZ2dDaGVjayA9IGF3YWl0IHRoaXNCb3QuYWJQcmV2aW91c0VnZ0NoZWNrKHsgYWJJRDogYWJJRCB9KTsKCi8vYWRkIHhwIGJvdCBoZXJlCnN0YXRlLmFiWFBCb3QgPSB7CiAgICBzcGFjZTogInNoYXJlZCIsCiAgICBpZDogImFiWFBCb3QiLAogICAgdGFnczogewogICAgICAgIGZvcm06ICJub3RoaW5nIiwKICAgICAgICBzeXN0ZW06ICJhYi5wYXR0ZXJuLmFiWFBCb3QiLAogICAgICAgIGF1dGhvcklEOiBhdXRoQm90LmlkLAogICAgICAgIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbiwKICAgICAgICB4cDogbGlua3MubGVhcm4udGFncy5hYlhQLAogICAgICAgIHNpZ25hdHVyZTogZWdnQ2hlY2suc2lnbmF0dXJlLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgfQp9OwoKLy8gRG8gYW5vdGhlciBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGFiIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4KbGV0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBhYjogYWJJRCwgc3R1ZGlvLCBwdWJsaWNGYWNpbmcsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaChwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vYWRkaXRpb25hbCBmaWxlIGRhdGEKZm9ybWF0dGVkRmlsZS52ZXJzaW9uID0gMTsKZm9ybWF0dGVkRmlsZS5zaWduYXR1cmUgPSBlZ2dDaGVjay5zaWduYXR1cmU7CmZvcm1hdHRlZEZpbGUuc3RhdGUgPSBzdGF0ZTsKCi8vYWN0dWFsIGVuY3J5cHRpb24gaWYgY2hvc2VuCmlmIChrZXkpIHsKICAgIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRGaWxlKTsKICAgIGZvcm1hdHRlZEZpbGUgPSBjcnlwdG8uZW5jcnlwdChrZXksIGZvcm1hdHRlZEZpbGUpOwp9CgovL3B1Ymxpc2ggdGhlIGZpbGUgYW5kIHRoZSBlZ2cgcmVjb3JkLgpsZXQgcHVibGlzaEZpbGU7CmxldCBwdWJsaXNoUmVjb3JkOwoKcHVibGlzaEZpbGUgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaEZpbGUoeyBmaWxlOiBmb3JtYXR0ZWRGaWxlLCBmaWxlTmFtZTogYWJJRCB9KTsKCmlmIChwdWJsaXNoRmlsZS5zdWNjZXNzKSB7CiAgICAvL2dhdGhlciBhZGRpb25hbCBlZ2cgZGF0YQogICAgY29uc3QgYWlQZXJtaXRDaGVjayA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdC5pZCwgImFpX3Blcm1pdCIpOwogICAgY29uc3QgYWlQZXJtaXRJRCA9IGFpUGVybWl0Q2hlY2suc3VjY2VzcyA/IGFpUGVybWl0Q2hlY2suZGF0YS5wZXJtaXRJRCA6IGZhbHNlOwoKICAgIGVnZ0NoZWNrLmVnZ0RhdGEuYWlQZXJtaXQgPSBhaVBlcm1pdElEOwogICAgZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5wdXNoKHB1Ymxpc2hGaWxlLnVybCk7CiAgICBlZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKICAgIGVnZ0NoZWNrLmVnZ0RhdGEudGFyZ2V0VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwoKICAgIC8vcHVibGlzaCBlZ2cvYWIgcmVjb3JkCiAgICBwdWJsaXNoUmVjb3JkID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hSZWNvcmQoeyBkYXRhOiBlZ2dDaGVjay5lZ2dEYXRhLCByZWNvcmROYW1lOiBhYklELCBwdWJsaWNGYWNpbmc6IHB1YmxpY0ZhY2luZywgYWRkaXRpb25hbE1hcmtlcnM6IFsnYWJFZ2cnXSwgdG9hc3Q6IGZhbHNlIH0pOwp9CgppZiAocHVibGlzaEZpbGUuc3VjY2VzcyAmJiBwdWJsaXNoUmVjb3JkLnN1Y2Nlc3MpIHsKICAgIC8vcHVibGlzaGluZyBzaG91dAogICAgc3VwZXJTaG91dCgib25BQlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7CiAgICBzdXBlclNob3V0KCJvbkFiUHVibGlzaGVkIiwgeyBzdWNjZXNzOiBwdWJsaXNoRmlsZS5zdWNjZXNzLCBhYjogYWJJRCwgZmlsZUFkZHJlc3M6IHB1Ymxpc2hGaWxlLnVybCB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgogICAgY29uc3QgYmlvcyA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CiAgICBjb25zdCBpbnN0VHlwZSA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CgogICAgc2V0VGFnTWFzayhsaW5rcy5sZWFybiwgImFiWFAiLCAiMCIsICJsb2NhbCIpOwoKICAgIGlmIChtYW51YWxQdWJsaXNoKSB7CiAgICAgICAgbGV0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwogICAgICAgIGNvbnN0IHVybCA9IHNpdGVPcmlnaW4gKyAiLz9wYXR0ZXJuPSIgKyBhYklEICsgIiZzdHVkaW89IiArIHN0dWRpbyArICImYmlvcz0iICsgYmlvczsKICAgICAgICBvcy5zZXRDbGlwYm9hcmQodXJsKTsKCiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCB3aXRoIGVuY3J5cHRlZCBkYXRhIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7dXJsfWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7dXJsfWApOwogICAgICAgIH0KICAgIH0KCiAgICB0cnkgewogICAgICAgIGF3YWl0IGFuYWx5dGljcy5yZWNvcmRFdmVudCgnYWJfZWdnX3B1Ymxpc2gnLCB7IGFiOiBhYklELCB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgIH0KfQplbHNlIHsKICAgIGxldCBlcnJvck1lc3NhZ2U7CgogICAgaWYgKCFwdWJsaXNoRmlsZS5zdWNjZXNzKSB7CiAgICAgICAgZXJyb3JNZXNzYWdlID0gcHVibGlzaEZpbGUuZXJyb3JNZXNzYWdlID8/IHB1Ymxpc2hGaWxlLmVycm9yQ29kZTsKICAgIH0gZWxzZSBpZiAoIXB1Ymxpc2hSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGVycm9yTWVzc2FnZSA9IHB1YmxpY2hSZWNvcmQuZXJyb3JNZXNzYWdlID8/IHB1Ymxpc2hSZWNvcmQuZXJyb3JDb2RlOwogICAgfSBlbHNlIHsKICAgICAgICBlcnJvck1lc3NhZ2UgPSAnVW5rbm93biByZWFzb24nOwogICAgfQoKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoewogICAgICAgIG1lc3NhZ2U6IGBQdWJsaXNoaW5nIGZhaWxlZDogJHtlcnJvck1lc3NhZ2V9YCwKICAgICAgICBsb2dUeXBlOiAnZXJyb3InLAogICAgICAgIHRvYXN0OiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlCiAgICB9KQp9CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIHB1Ymxpc2hSZWNvcmQ7JwDDsse5Av6AAghhYklnbm9yZQIEAMOyx7kC5ukDBHRydWUnAMOyx7kC/oACCmFiRG93bmxvYWQCBADDsse5AuvpA7kVQGNvbnN0IHBvc3NpYmxlQm90cyA9IHRoYXQ/LnBvc3NpYmxlQm90czsKbGV0IGZpbGVuYW1lID0gdGhhdD8uZmlsZW5hbWU7CmxldCBzb3VyY2VFdmVudCA9IHRoYXQ/LnNvdXJjZUV2ZW50OwpsZXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQgPSB0aGF0Py5vblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZDsKbGV0IGxvZyA9IHRoYXQ/LmxvZyA/PyB0cnVlOwpsZXQgcmVvcGVuQWJNZW51ID0gdGhhdD8ucmVvcGVuQWJNZW51ID8/IHRydWU7CgovLyBMZXQgYWxsIGJvdHMga25vdyB0aGF0IGFiIGlzIGFib3V0IHRvIGRvd25sb2FkIGJvdHMuCmNvbnN0IGJlZm9yZURvd25sb2FkQXJnID0geyBmaWxlbmFtZSwgc291cmNlRXZlbnQgfTsKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCQmVmb3JlRG93bmxvYWQnLCBiZWZvcmVEb3dubG9hZEFyZykpOwoKbGV0IGRvd25sb2FkQm90czsKCmNvbnN0IHNob3VsZERvd25sb2FkSW5zdCA9ICFwb3NzaWJsZUJvdHMgfHwgKEFycmF5LmlzQXJyYXkocG9zc2libGVCb3RzKSAmJiBwb3NzaWJsZUJvdHMubGVuZ3RoID09PSAwKTsKCmlmIChzaG91bGREb3dubG9hZEluc3QpIHsKICAgIC8vIERvd25sb2FkIGluc3QuCiAgICBkb3dubG9hZEJvdHMgPSBnZXRCb3RzKGIgPT4gIWIudGFncy5hYklnbm9yZSAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyk7CgogICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgIC8vIEdlbmVyYXRlIGEgZmlsZW5hbWUgaWYgb25lIGlzIG5vdCBnaXZlbi4KICAgICAgICBmaWxlbmFtZSA9IGAke29zLmdldEN1cnJlbnRJbnN0KCl9XyR7bGlua3MudXRpbHMuYWJGaWxlVGltZWNvZGUoKX1gOwogICAgfQoKICAgIGlmIChsb2cpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZygnZG93bmxvYWQgaW5zdCcpOwogICAgfQp9IGVsc2UgewogICAgaWYgKEFycmF5LmlzQXJyYXkocG9zc2libGVCb3RzKSkgewogICAgICAgIC8vIERvd25sb2FkIGJvdHMuCiAgICAgICAgZG93bmxvYWRCb3RzID0gcG9zc2libGVCb3RzOwogICAgICAgIGNvbnN0IGJvdElkcyA9IHBvc3NpYmxlQm90cy5tYXAoYiA9PiBiLmlkKS5zb3J0KCk7CiAgICAgICAgbGV0IGJvdElkc1NIQTEgPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBib3RJZHMpOwoKICAgICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgICAgIC8vIEdlbmVyYXRlIGEgZmlsZW5hbWUgaWYgb25lIGlzIG5vdCBnaXZlbi4KICAgICAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2JvdElkc1NIQTEuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coYGRvd25sb2FkICR7ZG93bmxvYWRCb3RzLmxlbmd0aH0gYm90c2ApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRG93bmxvYWQgYm90LgogICAgICAgIGRvd25sb2FkQm90cyA9IFtwb3NzaWJsZUJvdHNdOwoKICAgICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgICAgIC8vIEdlbmVyYXRlIGEgZmlsZW5hbWUgaWYgb25lIGlzIG5vdCBnaXZlbi4KICAgICAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke3Bvc3NpYmxlQm90cy5pZC5zdWJzdHJpbmcoMCwgNyl9XyR7bGlua3MudXRpbHMuYWJGaWxlVGltZWNvZGUoKX1gOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxvZykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZygnZG93bmxvYWQgYm90Jyk7CiAgICAgICAgfQogICAgfQp9CgppZiAoIUFycmF5LmlzQXJyYXkoZG93bmxvYWRCb3RzKSkgewogICAgZG93bmxvYWRCb3RzID0gW2Rvd25sb2FkQm90c107Cn0KCmNvbnN0IHN0YXRlID0ge307CgovLyBGb3JtYXQgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmZvciAobGV0IGkgPSAwOyBpIDwgZG93bmxvYWRCb3RzLmxlbmd0aDsgaSsrKSB7CiAgICBsZXQgY3VycmVudEJvdElEID0gZG93bmxvYWRCb3RzW2ldLmlkOwogICAgbGV0IGN1cnJlbnRCb3REYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkb3dubG9hZEJvdHNbaV0pKTsKCiAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdERhdGE7Cn0KCmlmICghZmlsZW5hbWUuZW5kc1dpdGgoJy5hdXgnKSkgewogICAgZmlsZW5hbWUgKz0gJy5hdXgnOwp9CgovLyBEbyBhIHByZXByb2Nlc3NpbmcgcGFzcyB0aGF0IGFsbG93cyBsaXN0ZW5lcnMgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4KY29uc3QgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YTogc3RhdGUsIGZpbGVuYW1lLCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZChwcmVwcm9jZXNzQXJnKTsKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkJywgcHJlcHJvY2Vzc0FyZykpOwoKLy8gRG93bmxvYWQgYXMgdjEgYXV4IGZpbGUuCmNvbnN0IGF1eEZpbGUgPSB7IHZlcnNpb246IDEsIHN0YXRlIH07Cm9zLmRvd25sb2FkKGF1eEZpbGUsIGZpbGVuYW1lLCAnYXBwbGljYXRpb24vanNvbicpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmlmIChyZW9wZW5BYk1lbnUpIHsKICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwp9JwDDsse5Av6AAg1tYW5pZmVzdGF0aW9uAgQAw7LHuQKl/wMo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAw7LHuQL+gAIEbWVudQIEAMOyx7kCzP8DKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAMOyx7kC/oACEmFiUHJldmlvdXNFZ2dDaGVjawIEAMOyx7kC8/8DsQ9ALy90aGlzIGZ1bmN0aW9uIGNoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhdCBhIHNwZWNpZmllZCBhYiwgcmV0dXJuaW5nIGFueSBkYXRhIHRoYXQgaXQgZmluZHMKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgZWdnSGlzdG9yeTsKbGV0IGVnZ0lEOwpsZXQgdGFyZ2V0VmVyc2lvbk51bTsKbGV0IGxhc3RIYXNoOwpsZXQgbWF4VmVyc2lvbk51bTsKbGV0IHN0YWJsZVZlcnNpb247CmxldCBmZWVkYmFja1ZlcnNpb247CmxldCBwcmV2aW91c1hQOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpsZXQgcmVjb3JkTG9va3VwID0gYXdhaXQgb3MuZ2V0RGF0YSh1c2VyUmVjb3JkLCBhYklEKS5jYXRjaChlID0+IHt9KTsKCmlmIChyZWNvcmRMb29rdXAuc3VjY2VzcykgCnsKICAgIGVnZ0hpc3RvcnkgPSByZWNvcmRMb29rdXAuZGF0YS5lZ2dWZXJzaW9uSGlzdG9yeTsKICAgIGVnZ0lEID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnSUQ7CiAgICBwcmV2aW91c1hQID0gcmVjb3JkTG9va3VwLmRhdGEueHAgPz8gMDsKICAgIHRhcmdldFZlcnNpb25OdW0gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7CiAgICBsYXN0SGFzaCA9IGVnZ0hpc3RvcnlbdGFyZ2V0VmVyc2lvbk51bSAtIDFdOwogICAgc3RhYmxlVmVyc2lvbiA9IHJlY29yZExvb2t1cC5kYXRhLnN0YWJsZVZlcnNpb247CiAgICBmZWVkYmFja1ZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5mZWVkYmFja1ZlcnNpb247CiAgICBtYXhWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9IAplbHNlIAp7CiAgICBlZ2dIaXN0b3J5ID0gW107CiAgICBlZ2dJRCA9IHV1aWQoKTsKICAgIHRhcmdldFZlcnNpb25OdW0gPSAxOwogICAgbGFzdEhhc2ggPSAibm9uZSI7CiAgICBtYXhWZXJzaW9uTnVtID0gMTsKICAgIHByZXZpb3VzWFAgPSAwOwp9CgppZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gImZlZWRiYWNrIikgCnsKICAgIGZlZWRiYWNrVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQplbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9PSAic3RhYmxlIikKewogICAgc3RhYmxlVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQoKY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwoKbGV0IGVnZyA9IHt9OwoKZWdnLmVnZ1ZlcnNpb25IaXN0b3J5ID0gZWdnSGlzdG9yeTsKZWdnLmVnZ0Zvcm1hdFZlcnNpb24gPSBlZ2dJRDsKZWdnLnRhcmdldFZlcnNpb24gPSB0YXJnZXRWZXJzaW9uTnVtOwplZ2cubWF4VmVyc2lvbiA9IG1heFZlcnNpb25OdW07CmVnZy5sYWJlbCA9ICJ2Iit0YXJnZXRWZXJzaW9uTnVtOwplZ2cuc3RhYmxlVmVyc2lvbiA9IHN0YWJsZVZlcnNpb247CmVnZy5mZWVkYmFja1ZlcnNpb24gPSBmZWVkYmFja1ZlcnNpb247CmVnZy5hYklEID0gYWJJRDsKZWdnLnhwID0gbGlua3MubGVhcm4udGFncy5hYlhQOwoKbGV0IHNpZ25hdHVyZSA9IHt9OwpsZXQgZGF0ZSA9IG5ldyBEYXRlKCk7CmxldCB0aW1lID0gZGF0ZS5nZXRUaW1lKCk7CgpzaWduYXR1cmUucHJldmlvdXNIYXNoID0gbGFzdEhhc2g7CnNpZ25hdHVyZS5hYlZlcnNpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29yZVZlcnNpb247CnNpZ25hdHVyZS5lZ2dWZXJzaW9uID0gdGFncy5lZ2dVVUlEOwpzaWduYXR1cmUuZWdnVmVyc2lvbk51bSA9IHRhZ3Mub3ZvVmVyc2lvbjsKc2lnbmF0dXJlLnRpbWVTdGFtcCA9IHRpbWU7CnNpZ25hdHVyZS5jYXN1YWxPU1ZlcnNpb24gPSBbb3MudmVyc2lvbigpXTsKCnJldHVybiB7c2lnbmF0dXJlOiBzaWduYXR1cmUsIGVnZ0RhdGE6IGVnZ307JwDDsse5Av6AAg9hYkJvdE1lbnVBY3Rpb24CBADDsse5AqWPBE1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAw7LHuQL+gAIOYWJCb3RNZW51TGFiZWwCBADDsse5AvOPBAVzaGFyZScAw7LHuQL+gAINYWJCb3RNZW51SWNvbgIEAMOyx7kC+Y8ECWlvc19zaGFyZScAw7LHuQL+gAISYWJCb3RNZW51U29ydE9yZGVyAgQAw7LHuQKDkAQDMy41JwDDsse5Av6AAgVsZWFybgIEAMOyx7kCh5AEKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAMOyx7kC/oACC2FiUVJQdWJsaXNoAgQAw7LHuQKukAThAUBjb25maWdCb3QudGFncy5wdWJsaXNoU2NhbiA9IG51bGw7CgpsZXQgc2Nhbm5lZFVSTDsKCnRyeSAKewogICAgc2Nhbm5lZFVSTCA9IG5ldyBVUkwodGhhdCk7Cn0KY2F0Y2ggKGUpIAp7CiAgICBzaG91dCgiYWJQdWJsaXNoQUIiLCB7YWI6IHRoYXQsIHNvdXJjZUV2ZW50OiAncXJfcHVibGlzaCd9KTsKCiAgICB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogdGhhdH0pOwoKICAgIHJldHVybjsKfScAw7LHuQL+gAIGc2VhcmNoAgQAw7LHuQKQkgQo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAw7LHuQL+gAIHYWJTaGVsbAIEAMOyx7kCt5IEBHRydWUnAMOyx7kC/oACDHN0dWRpb1NlbGVjdAIEAMOyx7kCvJIEiwtALy9zaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJTdHVkaW9NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3Qgc3R1ZGlvcyA9IHRoYXQuc3R1ZGlvczsKY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJTdHVkaW9NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAwOwptZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uYWJTdHVkaW9NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5sYWJlbCA9ICJwbGF5ZXIgc3R1ZGlvIjsKbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldFN0dWRpbyA9PSBhdXRoQm90LmlkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24uc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQCBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHRhZ3Muc3R1ZGlvSUQ7CgpsaW5rcy5tYW5hZ2VyLmxpbmtzLnN0dWRpb1NlbGVjdEJ1dHRvbi50YWdzLmxhYmVsID0gdGFncy5sYWJlbDsKCnNob3V0KCJhYlN0dWRpb01lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc3R1ZGlvcy5sZW5ndGg7IGkrKykKewogICAgbGV0IGFjdGl2ZVN0dWRpbyA9IHN0dWRpb3NbaV07CgogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldFN0dWRpbyA9PSBhY3RpdmVTdHVkaW8uc3R1ZGlvSWQgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVN0dWRpby5kaXNwbGF5TmFtZTsKICAgIG1lbnVCdXR0b24uc3R1ZGlvSUQgPSBhY3RpdmVTdHVkaW8uc3R1ZGlvSWQ7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0nAMOyx7kC/oACDmFiUHVibGlzaEFza0lEAgQAw7LHuQLGnQS+EkBpZiAoIWxpbmtzLm1lbnUpIHsKICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7Cn0KCmxldCBtZW51RGltZW5zaW9uID0gdGhhdC5tZW51RGltZW5zaW9uID8/IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWw7CmxldCBwcm9ncmVzc0J1dHRvbjsKCmlmIChtZW51RGltZW5zaW9uKSB7CiAgICBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IFttZW51RGltZW5zaW9uXTogdHJ1ZSwgbGFiZWw6IGBwdWJsaXNoaW5nICR7dGhhdC5hc2tJRH1gIH0pOwp9Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKY29uc3QgcGF0dGVybklEID0gdGhhdC5wYXR0ZXJuSUQ7CmNvbnN0IHN0dWRpb0lEID0gdGhhdC5zdHVkaW9JRCA/IHRoYXQuc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogYXV0aEJvdC5pZDsKY29uc3QgYXNrSUQgPSAiYXNrXyIgKyB0aGF0LmFza0lELnJlcGxhY2VBbGwoIi0iLCAiIik7CmNvbnN0IGVuZHBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50Owpjb25zdCB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdHJ1ZTsKCi8vIENoZWNrIHRvIHNlZSBpZiB0aGlzIGFza0lEIGFscmVhZHkgZXhpc3RzIGluIHRoZSBjYXN1YWwgY2F0YWxvZy4gQ2FzdWFsIGNhdGFsb2cgYXNrcyBhbHdheXMgb3ZlcnJpZGUgYWIgYXNrcyBhbmQgc28gdXNlcidzIHNob3VsZCBiZSBhd2FyZS4KY29uc3QgZXhpc3RzSW5DYXN1YWxDYXRhbG9nID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLmFiQ2FzdWFsQ2F0YWxvZ0Fza0lERXhpc3RzKHsgYXNrSUQ6IHRoYXQuYXNrSUQgfSk7CgppZiAoIWV4aXN0c0luQ2FzdWFsQ2F0YWxvZykgewogICAgY29uc3QgcHVibGlzaEFzayA9IGF3YWl0IG9zLnJlY29yZERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIHsgcGF0dGVybklEOiBwYXR0ZXJuSUQsIHN0dWRpb0lEOiBzdHVkaW9JRCB9LCB7IGVuZHBvaW50OiBlbmRwb2ludCwgdXBkYXRlUG9saWN5OiBbYXV0aEJvdC5pZF0gfSk7CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHB1Ymxpc2hBc2sgcmVzdWx0OmAsIHB1Ymxpc2hBc2spOwogICAgfQoKICAgIGlmIChwdWJsaXNoQXNrLnN1Y2Nlc3MpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBhc2sgJHt0aGF0LmFza0lEfSBwdWJsaXNoZWQgdG8gYWIgcmVjb3JkLmAsIGxvZ1R5cGU6ICdsb2cnIH0pOwoKICAgICAgICBpZiAodG9hc3QpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJUb2FzdCh7IG1lc3NhZ2U6IGBhc2sgJHt0aGF0LmFza0lEfSBwdWJsaXNoZWQuYCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBhc2sgJHt0aGF0LmFza0lEfSBmYWlsZWQgdG8gcHVibGlzaCB0byBhYiByZWNvcmQuXG4ke0pTT04uc3RyaW5naWZ5KHB1Ymxpc2hBc2ssIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKCiAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgZmFpbGVkIHRvIHB1Ymxpc2ggYXNrICR7dGhhdC5hc2tJRH0uICR7cHVibGlzaEFzay5lcnJvck1lc3NhZ2V9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICB9CgogICAgcmV0dXJuIHB1Ymxpc2hBc2s7Cn0gZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYGFza0lEICcke3RoYXQuYXNrSUR9JyBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuIFBsZWFzZSBjaG9vc2UgYSBkaWZmZXJlbnQgbmFtZS5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQogICAgCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGluIHRoZSBzaGFwZSBvZiBSZWNvcmREYXRhRmFpbHVyZS4KICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgZXJyb3JDb2RlOiAnYXNraWRfZXhpc3RzX2Nhc3VhbF9jYXRhbG9nJywKICAgICAgICBlcnJvck1lc3NhZ2U6IGBDYXN1YWwgY2F0YWxvZyBhbHJlYWR5IGNvbnRhaW5zIHRoZSBhc2tJRCAnJHthc2tJRH0nYAogICAgfQp9JwDDsse5Av6AAgVpbnB1dAIEAMOyx7kChbAEKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAMOyx7kC/oACC2FiRW1iZWRMaW5rAgQAw7LHuQKssASkA0Bjb25zdCBhYiA9IHRoYXQgPyB0cnVlIDogZmFsc2U7CmNvbnN0IGVtYmVkTGluayA9IGFiID8gImFiPSIgKyB0aGF0IDogImluc3Q9IiArIGNvbmZpZ0JvdC50YWdzLmluc3Q7CmNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwpjb25zdCBlbWJlZFRleHQgPSBgPCFET0NUWVBFIGh0bWw+CsKgwqDCoMKgPGh0bWw+CsKgwqDCoMKgwqDCoMKgwqA8aGVhZD48L2hlYWQ+CsKgwqDCoMKgwqDCoMKgwqA8Ym9keT4KwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgPGlmcmFtZSBzcmM9IiR7c2l0ZU9yaWdpbiArICIvPyIgKyBlbWJlZExpbmt9IiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSI0MDAiIC8+CsKgwqDCoMKgwqDCoMKgwqA8L2JvZHk+CsKgwqDCoMKgPC9odG1sPmA7CgpyZXR1cm4gZW1iZWRUZXh0OycAw7LHuQL+gAIPYWJQYXR0ZXJuVXBkYXRlAgQAw7LHuQKlswSlBUAvL3Nob3V0KCJhYlBhdHRlcm5VcGRhdGUiLCB7YWJJRDogYWJJRCwgc3R1ZGlvOnN0dWRpbz8sIGJvdHM6IGJvdHM/fSk7CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgppZiAoIWF1dGhCb3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPyB0aGF0LnN0dWRpbyA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFiTWFuaWZlc3QgPSBnZXRCb3QoYnlNb2Qoe2FiRWdnOiB0cnVlLCBvcmlnaW5fYWI6IGFiSUR9KSk7CgppZiAoIWFiTWFuaWZlc3QpCnsKICAgIHNob3V0KCJvbkxvb2t1cEFCRWdncyIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywgYXV0b0hhdGNoOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm5fdXBkYXRlJ30pOwoKICAgIHJldHVybjsKfQoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBzdHVkaW87Cgpjb25zdCBhYkJvdHMgPSB0aGF0LmJvdHMgPz8gZ2V0Qm90cygiYWJJRE9yaWdpbiIsIGFiSUQpOwoKYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IGFiSUQsIHRhcmdldDogYWJCb3RzLCBwdWJsaWNGYWNpbmc6IHRydWUsIHNvdXJjZUV2ZW50OiAncGF0dGVybl91cGRhdGUnfSk7JwDDsse5Av6AAhdhYk11bHRpcGxlQm90TWVudUFjdGlvbgIEAMOyx7kCy7gETUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwDDsse5Av6AAhphYk11bHRpcGxlQm90TWVudVNvcnRPcmRlcgIEAMOyx7kCmbkEATInAMOyx7kC/oACFWFiTXVsdGlwbGVCb3RNZW51SWNvbgIEAMOyx7kCm7kECWlvc19zaGFyZScAw7LHuQL+gAIWYWJNdWx0aXBsZUJvdE1lbnVMYWJlbAIEAMOyx7kCpbkEBXNoYXJlJwDDsse5Av6AAg9hYlB1Ymxpc2hTZWxlY3QCBADDsse5Aqu5BKoTQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiUGF0dGVybk1lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBhbGxCb3RzID0gZ2V0Qm90cygiYWJJRE9yaWdpbiIpOwpjb25zdCBhbGxQYXR0ZXJucyA9IFsibmV3IHBhdHRlcm4iXTsKCmJvdExvb3A6CmZvciAobGV0IGkgPSAwOyBpIDwgYWxsQm90cy5sZW5ndGg7IGkrKykKewogICAgY29uc3QgYWN0aXZlQm90ID0gYWxsQm90c1tpXTsKCiAgICBpZiAoYWN0aXZlQm90LnRhZ3MuYWJJZ25vcmUpCiAgICB7CiAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgIH0KCiAgICBjb25zdCBwb3NzaWJsZVBhdHRlcm4gPSBhY3RpdmVCb3QudGFncy5hYklET3JpZ2luOwoKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBqKyspCiAgICB7CiAgICAgICAgY29uc3QgYWN0aXZlUGF0dGVybiA9IGFsbFBhdHRlcm5zW2pdOwoKICAgICAgICBpZiAoYWN0aXZlUGF0dGVybiA9PSBwb3NzaWJsZVBhdHRlcm4gKQogICAgICAgIHsKICAgICAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaiA9PSBhbGxQYXR0ZXJucy5sZW5ndGggLSAxKQogICAgICAgIHsKICAgICAgICAgICAgYWxsUGF0dGVybnMucHVzaChwb3NzaWJsZVBhdHRlcm4pOwogICAgICAgIH0KICAgIH0KfQoKY29uc3QgdGFyZ2V0QUIgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3QgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiUGF0dGVybk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKbWVudUJ1dHRvbi5yZW1lbWJlciA9IHRhZ3MucmVtZW1iZXI7Cm1lbnVCdXR0b24ub25DbGljayA9IGBAY29uc3QgdG90YWxQYXR0ZXJuQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gdGFncy5sYWJlbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKY29uc3Qgbm9uUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCnNob3V0KCJhYlNlbGVjdFRpdGxlVXBkYXRlIiwge2FiOiB0YWdzLmxhYmVsLCBhYkJvdHM6IHRvdGFsUGF0dGVybkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vblBhdHRlcm5Cb3RzLmxlbmd0aH0pOwoKbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZEFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJQYXR0ZXJuTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7YDsKCmFsbFBhdHRlcm5zLnNvcnQoKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVQYXR0ZXJuTmFtZSA9IGFsbFBhdHRlcm5zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRBQiA9PSBhY3RpdmVQYXR0ZXJuTmFtZSA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gYWN0aXZlUGF0dGVybk5hbWU7CgogICAgaWYgKGFjdGl2ZVBhdHRlcm5OYW1lID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gLTE7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gaTsKICAgIH0KCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKfQoKaWYgKCFnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGZvcm1BZGRyZXNzOiAicmFkaW9fYnV0dG9uX2NoZWNrZWQifSkpKQp7CiAgICBjb25zdCBuZXdCb3QgPSBnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGxhYmVsOiAibmV3IHBhdHRlcm4ifSkpOwogICAgCiAgICBuZXdCb3QudGFncy5mb3JtQWRkcmVzcyA9ICJyYWRpb19idXR0b25fY2hlY2tlZCI7Cn0nAMOyx7kC/oACCWFiVmVyc2lvbgIEAMOyx7kC1MwEBTEwLjEwJwDDsse5Av6AAgtwZXJzb25hbGl0eQIEAMOyx7kC2swEKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAMOyx7kC/oACBXV0aWxzAgQAw7LHuQKBzQQo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAw7LHuQL+gAIOY2FuUHVibGlzaEZpbGUCBADDsse5AqjNBP4DQGlmIChnbG9iYWxUaGlzLmFiKSB7CiAgICBpZiAoYXV0aEJvdCkgewogICAgICAgIGlmIChhYi5saW5rcy5yZW1lbWJlci50YWdzLnN1YnNjcmlwdGlvbnNFbmFibGVkKSB7CiAgICAgICAgICAgIGlmIChhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllcikgewogICAgICAgICAgICAgICAgcmV0dXJuIGF1dGhCb3QudGFncy5zdWJzY3JpcHRpb25UaWVyICE9PSAnRnJlZVBsYXknOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0gZWxzZSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gd2FpdCBmb3IgYWIgdG8gZmluaXNoIGJvb3RpbmcgYmVmb3JlIHF1ZXJ5aW5nICR7dGFnTmFtZX0uYCkKICAgIHJldHVybiBudWxsOwp9JwDDsse5Av6AAgVkZWJ1ZwIEAMOyx7kCp9EEBHRydWUnAQRib3RzJDc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNwEnAMOyx7kCrNEEFWFiRmluZEFydGlmYWN0QnVuZGxlcwIEAMOyx7kCrdEEkwZAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9OwoKY29uc3QgYXJ0aWZhY3RCdW5kbGVzOiBSZWNvcmQ8c3RyaW5nLCBBQkFydGlmYWN0QnVuZGxlPiA9IHt9OyAvLyBLZXkgaXMgYXJ0aWZhY3QgaWQKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGUpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYi50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQgJiYgYWJBcnRpZmFjdEluc3RhbmNlSUQgIT09IGIudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25zdCBhcnRpZmFjdElkID0gYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGUuaWQ7CgogICAgICAgIGlmIChhcnRpZmFjdElkICYmICFhcnRpZmFjdEJ1bmRsZXNbYXJ0aWZhY3RJZF0pIHsKICAgICAgICAgICAgYXJ0aWZhY3RCdW5kbGVzW2FydGlmYWN0SWRdID0gYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgfQogICAgfQp9KTsKCnJldHVybiBhcnRpZmFjdEJ1bmRsZXM7JwDDsse5AqzRBAVzdG9yZQIEAMOyx7kCwdcEKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAMOyx7kCrNEEBnN5c3RlbQIEAMOyx7kC6NcEEWFiLnNoZWxsLmFydGlmYWN0JwDDsse5AqzRBAhhYklnbm9yZQIEAMOyx7kC+tcEBHRydWUnAMOyx7kCrNEECWFiVmVyc2lvbgIEAMOyx7kC/9cEBTEwLjEwJwDDsse5AqzRBAVkZWJ1ZwIEAMOyx7kChdgEBWZhbHNlJwDDsse5AqzRBAhyZW1lbWJlcgIEAMOyx7kCi9gEKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMOyx7kCrNEEE2FiQ3JlYXRlQXJ0aWZhY3RCb3QCBADDsse5ArLYBNYSQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBkaW1lbnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiSW5zdCA/PyAnaG9tZScsCiAgICBwb3NpdGlvbiA9IG5ldyBWZWN0b3IzKDAsIDAsIDApLAogICAgb3RoZXJUYWdzID0ge30sCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBhYkFydGlmYWN0QmFzZUNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0QmFzZUNvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQ7CmNvbnN0IGFiQXJ0aWZhY3RMYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0TGFiZWxDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdDsKCmNvbnN0IGFiQXJ0aWZhY3RCb3QgPSBjcmVhdGUoewogICAgc3BhY2U6ICdzaGFyZWQnLAogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RCb3Q6IHRydWUsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtgJHtkaW1lbnNpb259WGBdOiBwb3NpdGlvbi54LAogICAgW2Ake2RpbWVuc2lvbn1ZYF06IHBvc2l0aW9uLnksCiAgICBbYCR7ZGltZW5zaW9ufVpgXTogcG9zaXRpb24ueiwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBsYWJlbENvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIHN0cm9rZUNvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIG9uQm90QWRkZWQ6IGBACiAgICAgICAgdGhpc0JvdC51cGRhdGVDb21wdXRlZFRhZ3MoKTsKICAgIGAsCiAgICBvbkJvdENoYW5nZWQ6IGBACiAgICAgICAgY29uc3QgY2hhbmdlZFRhZ3MgPSB0aGF0LnRhZ3M7CgogICAgICAgIGlmIChjaGFuZ2VkVGFncy5zb21lKHQgPT4gdCA9PT0gJ2FiQXJ0aWZhY3RJbnN0YW5jZUlEJyB8fCB0ID09PSAnYWJBcnRpZmFjdE5hbWUnKSkgewogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZUNvbXB1dGVkVGFncygpOwogICAgICAgIH0KICAgIGAsCiAgICB1cGRhdGVDb21wdXRlZFRhZ3M6IGBACiAgICAgICAgbGV0IHN5c3RlbSA9ICdhYkFydGlmYWN0Qm90JzsKCiAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgc3lzdGVtICs9ICcuJyArIHRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRC5zdWJzdHJpbmcoMCwgNyk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9ICEhc3lzdGVtID8gc3lzdGVtIDogbnVsbDsKICAgICAgICB0YWdzLmxhYmVsID0gdGFncy5zeXN0ZW07CiAgICBgLAogICAgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlOiBgQAogICAgICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnbGFiZWwnLCAnICcsICdzaGFyZWQnKTsKICAgIGAsCiAgICAuLi5vdGhlclRhZ3MsCn0pOwoKdHJ5IHsKICAgIC8vIFVwZGF0ZSBhbGwgdGhlIHNoYXJkcyBmb3IgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZSAtLSB3aGljaCBub3cgaW5jbHVkZXMgdGhpcyBib3QhCiAgICBjb25zdCB1cGRhdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgogICAgaWYgKCF1cGRhdGVSZXN1bHQuc3VjY2VzcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHVwZGF0ZSAnJHthYkFydGlmYWN0TmFtZX0nIGFydGlmYWN0IHNoYXJkcy5gKTsKICAgIH0KfSBjYXRjaCAoZSkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhdWdodCBlcnJvciB3aGlsZSB1cGRhdGUgYXJ0aWZhY3Qgc2hhcmRzOmAsIGUpOwogICAgZGVzdHJveShhYkFydGlmYWN0Qm90KTsKICAgIHJldHVybiBudWxsOwp9CgpyZXR1cm4gYWJBcnRpZmFjdEJvdDsnAMOyx7kCrNEEFmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGUCBADDsse5AonrBPkqQGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgphc3NlcnQodHlwZW9mIHRoYXQgPT09ICdvYmplY3QnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFyZyBvYmplY3QgbXVzdCBiZSBwcm92aWRlZC5gKTsKCmNvbnN0IHsgCiAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgZWdnUGFyYW1ldGVycywgLy8gRWdnIHBhcmFtdGVycyB0aGF0IHlvdSB3b3VsZCBsaWtlIHRvIGhhdmUgcGFzc2VkIHRvIHRoZSByZWNvbnNpdHV0ZWQgYm90cyAob3B0aW9uYWwpLgogICAgdG9hc3QgPSB0cnVlLAp9ID0gdGhhdCBhcyBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnOwoKYXNzZXJ0KGFiQXJ0aWZhY3RCdW5kbGUgJiYgYWJBcnRpZmFjdEJ1bmRsZS5kYXRhICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCdW5kbGUgaXMgcmVxdWlyZWQgdG8gYmUgb2YgdHlwZSBBQkFydGlmYWN0QnVuZGxlLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgc3RyaW5nLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZVN0cmluZyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwpjb25zdCBzaGFyZEJvdHMgPSBbXTsKCmZ1bmN0aW9uIGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUoeyBib3REYXRhIH0pIHsKICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7IC8vIElmIHRoZSBzaGFyZCBib3QgaGFzIGl0c2VsZiBtYXJrZWQgYXMgcmVjb25zdGl0dXRlZCBhbHJlYWR5IChwb3NzaWJseSBkdWUgdG8gYW4gb3ZlcnNpZ2h0KSwgdGhlbiByZW1vdmUgaXQhCgogICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJ1bmRsZVN0cmluZzsgLy8gQXNzaWduIHRoZSBhcnRpZmFjdCBidW5kbGUgYmFjayB0byB0aGUgaGF0Y2hlZCBzaGFyZCBib3QuCiAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gYWJBcnRpZmFjdEluc3RhbmNlSUQ7IC8vIFVVSUQgb2YgdGhlIGFydGlmYWN0IGluc3RhbmNlIHRoYXQgdGhpcyBib3QgYmVsb25ncyB0by4KICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsgLy8gVVVJRCBhc3NpZ25lZCB0byB0aGUgYm90IGJ5IHRoZSBhcnRpZmFjdCB3aGVuIGxvYWRlZC4KICAgIH0KfQoKZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzKSB7CiAgICBjb25zdCBkZXBlbmRlbmN5Qm90cyA9IFtdOwoKICAgIGlmICh0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgIGNvbnN0IGVnZ0RlcGVuZGVuY3kgPSBkZXBlbmRlbmN5IGFzIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5OwogICAgICAgIAogICAgICAgIC8vIEZpcnN0IHRyeSB0byBsb2FkIGZyb20gZWdnLgogICAgICAgIGNvbnN0IGxvb2t1cEVnZ1Jlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICAgICAgICAgIGFiSUQ6IGVnZ0RlcGVuZGVuY3kuYWJJRCwKICAgICAgICAgICAgcmVjb3JkS2V5OiBlZ2dEZXBlbmRlbmN5LnJlY29yZEtleSwKICAgICAgICAgICAgYWJWZXJzaW9uOiBlZ2dEZXBlbmRlbmN5LmFiVmVyc2lvbiwKICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgIGVnZ1BhcmFtZXRlcnMsCiAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQogICAgICAgIH0pCgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9ICR7ZWdnRGVwZW5kZW5jeS5hYklEfSBsb29rdXBFZ2dSZXN1bHQ6YCwgbG9va3VwRWdnUmVzdWx0KTsKICAgICAgICB9CgogICAgICAgIGlmIChsb29rdXBFZ2dSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBsb2FkZWQgZGVwZW5kZW5jeSBhYklEOiAke2VnZ0RlcGVuZGVuY3kuYWJJRH0sIGFiVmVyc2lvbjogJHtlZ2dEZXBlbmRlbmN5LmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBoYXRjaGVkQm90IG9mIGxvb2t1cEVnZ1Jlc3VsdC5oYXRjaGVkQm90cykgewogICAgICAgICAgICAgICAgZGVwZW5kZW5jeUJvdHMucHVzaChoYXRjaGVkQm90KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAoZGVwZW5kZW5jeUJvdHMubGVuZ3RoID09PSAwICYmIHRoaXNCb3QuaXNBc2tEZXBlbmRlbmN5KGRlcGVuZGVuY3kpKSB7CiAgICAgICAgY29uc3QgYXNrRGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kgYXMgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgogICAgICAgIC8vIFRyeSB0byBsb2FkIGZyb20gYXNrLgogICAgICAgIGNvbnN0IGxvb2t1cEFza1Jlc3VsdDogQUJMb29rdXBBc2tJRFJlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFza0lEKHsKICAgICAgICAgICAgYXNrSUQ6IGFza0RlcGVuZGVuY3kuYXNrSUQsCiAgICAgICAgICAgIHNob3dJbmRpY2F0b3I6IGZhbHNlLAogICAgICAgICAgICBhdXRvSGF0Y2g6IHRydWUsCiAgICAgICAgICAgIGlnbm9yZVJlc2VydmVkOiB0cnVlLAogICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgIGVnZ1BhcmFtZXRlcnMsCiAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQogICAgICAgIH0pCgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrUmVzdWx0OmAsIGxvb2t1cEFza1Jlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9va3VwQXNrUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBoYXRjaGVkQm90IG9mIGxvb2t1cEFza1Jlc3VsdC5oYXRjaGVkQm90cykgewogICAgICAgICAgICAgICAgZGVwZW5kZW5jeUJvdHMucHVzaChoYXRjaGVkQm90KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAoZGVwZW5kZW5jeUJvdHMubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoY29uc3Qgc2hhcmRCb3Qgb2YgZGVwZW5kZW5jeUJvdHMpIHsKICAgICAgICAgICAgc2hhcmRCb3RzLnB1c2goc2hhcmRCb3QpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9IGZhaWxlZCB0byBsb2FkIGRlcGVuZGVuY3k6ICR7SlNPTi5zdHJpbmdpZnkoZGVwZW5kZW5jeSl9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgfQp9CgoKaWYgKHNoYXJkQm90cy5sZW5ndGggPiAwKSB7CiAgICAvLyBUZWxsIGFsbCBoYXRjaGVkIHNoYXJkIGJvdHMgdG8gcmVjb25zdGl0dXRlLiBUaGV5IGFsbCBoYXZlIGNvcGllcyBvZiB0aGUgYWJBcnRpZmFjdEJ1bmRsZSBhbmQgY2FuIHJlY29uc3RpdHV0ZSB0aGVtc2VsdmVzIGZyb20gdGhhdC4KICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKHNoYXJkQm90cywgJ29uQUJBcnRpZmFjdFJlY29uc3RpdHV0ZScsIHsgZGF0YTogYWJBcnRpZmFjdEJ1bmRsZS5kYXRhIH0pKTsKCiAgICBmb3IgKGxldCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgICAgICBzZXRUYWdNYXNrKHNoYXJkQm90LCAnYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCcsIHRydWUsICdzaGFyZWQnKTsgLy8gVGhpcyBib3QgaGFzIGJlZW4gcmVjb25zdGl0dXRlZCBpbiB0aGlzIGluc3QuCiAgICB9CgogICAgYXdhaXQgdGhpc0JvdC5hYkxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKICAgIAogICAgY29uc3QgcmVjb25zdGl0dXRpb25SZXN1bHQgPSB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgc2hhcmRCb3RzLAogICAgfTsKCiAgICBzaG91dCgnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIHJlY29uc3RpdHV0aW9uUmVzdWx0KTsKCiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZpbmlzaGVkIHJlY29uc3RpdHV0aW9uLmAsIHRvYXN0OiB0b2FzdCB9KTsKCiAgICByZXR1cm4gcmVjb25zdGl0dXRpb25SZXN1bHQ7Cn0gZWxzZSB7CiAgICBjb25zdCBmYWlsdXJlUmVzdWx0ID0gewogICAgICAgIGVycm9yQ29kZTogJ25vX3NoYXJkX2JvdHMnLAogICAgICAgIGVycm9yTWVzc2FnZTogJ1JlY29uc3RpdHV0aW9uIHJlc3VsdHMgaW4gbm8gc2hhcmQgYm90cy4nLAogICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBhYkFydGlmYWN0QnVuZGxlLm5hbWUsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cywKICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgfTsKCiAgICBzaG91dCgnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBmYWlsdXJlUmVzdWx0KTsKCiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZhaWxlZCByZWNvbnN0aXR1dGlvbi5gLCB0b2FzdDogdG9hc3QgfSk7CiAgICAKICAgIHJldHVybiBmYWlsdXJlUmVzdWx0Owp9CicAw7LHuQKs0QQXYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24CBADDsse5AoGWBQExJwDDsse5AqzRBAZzZWFyY2gCBADDsse5AoOWBSjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwDDsse5AqzRBAdhYlNoZWxsAgQAw7LHuQKqlgUEdHJ1ZScAw7LHuQKs0QQFdXRpbHMCBADDsse5Aq+WBSjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDDsse5AqzRBA9vbkFueUJvdENsaWNrZWQCBADDsse5AtaWBYEBQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGJvdCB9KQp9JwDDsse5AqzRBBZhYlVwZGF0ZUFydGlmYWN0U2hhcmRzAgQAw7LHuQLYlwWjF0Bjb25zdCBhYkFydGlmYWN0TmFtZSA9IHRoYXQuYWJBcnRpZmFjdE5hbWU7CmxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQ7Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgppZiAoc2hhcmRCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBUaGVyZSBhcmUgbm8gc2hhcmRzIGZvciBhcnRpZmFjdCBuYW1lICcke2FiQXJ0aWZhY3ROYW1lfScuYCwgbG9nVHlwZTogJ3dhcm4nIH0pOwogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQoKCmNvbnN0IHByZXZBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHNoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CmNvbnN0IHByZXZBcnRpZmFjdElEID0gcHJldkFydGlmYWN0QnVuZGxlID8gcHJldkFydGlmYWN0QnVuZGxlLmlkIDogbnVsbDsKCmxldCBjb2xsZWN0U2hhcmRSZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0OwoKdHJ5IHsKICAgIGNvbGxlY3RTaGFyZFJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMoeyBzaGFyZEJvdHMgfSk7CgogICAgaWYgKCFjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBjb2xsZWN0U2hhcmRSZXN1bHQucmVhc29uLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KfSBjYXRjaChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBTb21ldGhpbmcgd2VudCB3cm9uZyBjb2xsZWN0aW5nIHNoYXJkcy4gU2VlIGNvbnNvbGUgZm9yIG1vcmUgZGV0YWlscy5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQp9Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0QnVuZGxlKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RTaGFyZDogY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkIH0pOwoKaWYgKHByZXZBcnRpZmFjdElEICYmIHByZXZBcnRpZmFjdElEICE9PSBhYkFydGlmYWN0QnVuZGxlLmlkKSB7CiAgICAvLyBUaGUgYXJ0aWZhY3QgaGFzIGEgbmV3IGlkLiBBbGwgb2YgdGhlIHNoYXJkIGJvdHMgbmVlZCBhIG5ldyBpbnN0YW5jZSBpZCBhcyB3ZWxsLgogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSB1dWlkKCk7CgogICAgZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0U2hhcmRJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5hbCBtZXJnZWQgYXJ0aWZhY3QgJHthYkFydGlmYWN0TmFtZX06YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIEV2ZXJ5IHNoYXJkIGJvdCBnZXRzIGEgY29weSBvZiB0aGUgYXJ0aWZhY3QgYnVuZGxlLgovLyBUaGlzIG1ha2VzIHRoZSBhcnRpZmFjdCBob2xvZ3JhcGhpYyBieSBuYXR1cmUuIFRoaXMgbWVhbnMgdGhhdCBhbnkgc2hhcmQgY2FuIGJlIHVzZWQgdG8gcmVjb25zdGl0dXRlIHRoZSB3aG9sZS4KZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIC8vIE1hcmsgZWFjaCBzaGFyZCBib3QgYXMgYmVpbmcgJ3JlY29uc3RpdHV0ZWQnIHdoZW4gd2UgdXBkYXRlIHRoZSBhcnRpZmFjdC4KICAgIC8vIEJlY2F1c2UgdGhpcyBpcyBhIHNoYXJlZCB0YWcgbWFzaywgaXQgd2lsbCBvbmx5IGJlIHRydWUgaW4gdGhlIGN1cnJlbnQgaW5zdC4KICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOwogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlID0gICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwp9CgovLyBSeWFuIENvb2s6IE5lZWQgdG8gZ2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byBjYXRjaHVwLgovLyBGb3VuZCB0aGF0IGlmIHdlIGRpZG50IGRvIHRoaXMsIG1vZCB0YWdzIHdvdWxkIG5vdCBiZSByZXR1cm5lZCBhcyBKU09OIG9iamVjdHMgYnV0IGluc3RlYWQgdGhlIHJhdyBzdHJpbmcuCmF3YWl0IG9zLnNsZWVwKDApOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRlZCBhcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nLiBDb3BpZWQgYXJ0aWZhY3QgYnVuZGxlIHRvICR7c2hhcmRCb3RzLmxlbmd0aH0gYm90cy4gYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKc2hvdXQoJ29uQW55QUJBcnRpZmFjdFNoYXJkc1VwZGF0ZWQnLCB7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdEJ1bmRsZSwgc2hhcmRCb3RzIH0pCgovLyBTaGFyZCB1cGRhdGUgc3VjY2Vzc2Z1bC4KcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9OycAw7LHuQKs0QQEbWVudQIEAMOyx7kC+q4FKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAMOyx7kCrNEEBWxlYXJuAgQAw7LHuQKhrwUo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAw7LHuQKs0QQLb25HcmlkQ2xpY2sCBADDsse5AsivBUZAaWYgKGxpbmtzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwp9JwDDsse5AqzRBBphYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdAIEAMOyx7kCj7AFByNBRUExRkYnAMOyx7kCrNEEG2FiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdAIEAMOyx7kCl7AFByMxZTFiMmQnAMOyx7kCrNEEEG9uQW55Qm90c1JlbW92ZWQCBADDsse5Ap+wBZUBQGNvbnN0IHsgYm90SURzIH0gPSB0aGF0OwoKaWYgKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCAmJiBib3RJRHMuaW5jbHVkZXMobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkKSkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7Cn0nAMOyx7kCrNEEB3ZlcnNpb24CBADDsse5ArWxBSjwn5SXNTI4ZGMwZjktNDNlYy00M2YzLWE0NzAtZTJkZDZhMGRhOTVmJwDDsse5AqzRBBhhYkdldEFydGlmYWN0TmFtZXNJbkluc3QCBADDsse5AtyxBawBQGNvbnN0IGFiQXJ0aWZhY3ROYW1lcyA9IG5ldyBTZXQoKTsKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICBhYkFydGlmYWN0TmFtZXMuYWRkKGIudGFncy5hYkFydGlmYWN0TmFtZSk7CiAgICB9Cn0pCgpyZXR1cm4gYWJBcnRpZmFjdE5hbWVzOycAw7LHuQKs0QQVYWJBcnRpZmFjdEJvdE1lbnVPcGVuAgQAw7LHuQKJswX7FUBjb25zdCB7IGFiQXJ0aWZhY3RCb3QgfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdEJvdCAmJiBhYkFydGlmYWN0Qm90LnNwYWNlICYmIGFiQXJ0aWZhY3RCb3QudGFncywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0Qm90IGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBCb3QuYCk7CgpzaG91dCgiYWJBcnRpZmFjdEJvdE1lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJBcnRpZmFjdE1lbnUiOwoKaWYgKCF0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cykgewogICAgdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMgPSBbXTsKfQoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CgpsZXQgaW5mb0xhYmVsID0gYFthcnRpZmFjdCBuYW1lXTogJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9XG5gOwppbmZvTGFiZWwgKz0gYFthcnRpZmFjdCBpZF06ICR7YWJBcnRpZmFjdEJ1bmRsZS5pZC5zdWJzdHJpbmcoMCwgNyl9XG5gOwppbmZvTGFiZWwgKz0gYFthcnRpZmFjdCBpbnN0YW5jZSBpZF06ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID8/ICd1bnNldCd9IFxuYDsKaW5mb0xhYmVsICs9IGBbcmVjb25zdGl0dXRlZCBpbiBpbnN0XTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZH1cbmA7CmluZm9MYWJlbCArPSBgW2Zvcm1hdF06IHYke2FiQXJ0aWZhY3RCdW5kbGUuZm9ybWF0VmVyc2lvbn1cbmA7CmluZm9MYWJlbCArPSBgW2NyZWF0ZWQgdGltZV06ICR7RGF0ZVRpbWUuZnJvbUlTTyhhYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXApLnRvTG9jYWxlU3RyaW5nKERhdGVUaW1lLkRBVEVUSU1FX1NIT1JUX1dJVEhfU0VDT05EUyl9XG5gOwoKLy8gSGVhZGVyCmNvbnN0IGluZm9Cb3QgPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudVRleHQoewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBsYWJlbDogaW5mb0xhYmVsLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGluZm9Cb3QpOwoKLy8gRG93bmxvYWQgc2hhcmQgYnV0dG9uLgpjb25zdCBkb3dubG9hZEJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdkb3dubG9hZCcsCiAgICBsYWJlbDogYGRvd25sb2FkIHNoYXJkYCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSAnYWJBcnRpZmFjdC0nICsgYWJBcnRpZmFjdEJ1bmRsZS5uYW1lICsgJy0nICsgYWJBcnRpZmFjdEJ1bmRsZS5pZC5zdWJzdHJpbmcoMCw3KSArICcuYXV4JzsgCiAgICAgICAgb3MuZG93bmxvYWRCb3RzKFsgbGlua3MuYWJBcnRpZmFjdEJvdCBdLCBmaWxlbmFtZSk7CiAgICAgICAgCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwogICAgYCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaChkb3dubG9hZEJ1dHRvbik7CgovLyBVcGRhdGUgYXJ0aWZhY3QgYnV0dG9uLgpjb25zdCB1cGRhdGVCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGFiQXJ0aWZhY3RCb3Q6IGdldExpbmsoYWJBcnRpZmFjdEJvdCksCiAgICBhYkFydGlmYWN0VG9vbDogZ2V0TGluayh0aGlzQm90KSwKICAgIGZvcm1BZGRyZXNzOiAnc3luYycsCiAgICBsYWJlbDogYHVwZGF0ZSBhcnRpZmFjdGAsCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IGxpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gYWJBcnRpZmFjdEJ1bmRsZS5uYW1lOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIAogICAgICAgIGF3YWl0IGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgogICAgICAgIGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGxpbmtzLmFiQXJ0aWZhY3RCb3QgfSk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKHVwZGF0ZUJ1dHRvbik7CgptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBhYkFydGlmYWN0Qm90LmlkOycAw7LHuQKs0QQZYWJEb3dubG9hZEFydGlmYWN0UGF0dGVybgIEAMOyx7kChckF/ARAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzaGFyZEJvdHMsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0TmFtZSA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpICYmIHNoYXJkQm90cy5sZW5ndGggPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyBhIHJlcXVpcmVkIEJvdCBhcnJheSBwYXJhbWV0ZXIuIEl0IG11c3QgaGF2ZSBhdCBsZWFzdCAxIGJvdC5gKTsKCnJldHVybiBsaW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgCiAgICBwb3NzaWJsZUJvdHM6IHNoYXJkQm90cywKICAgIGZpbGVuYW1lOiBgJHthYkFydGlmYWN0TmFtZX1gLAogICAgc291cmNlRXZlbnQ6ICdkb3dubG9hZF9hcnRpZmFjdF9wYXR0ZXJuJywKICAgIHJlb3BlbkFiTWVudTogZmFsc2UsCiAgICBvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZDogKGFyZykgPT4gewogICAgICAgIHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAMOyx7kCrNEEFmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQCBADDsse5AoLOBe8BQGlmICh0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyAmJiB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5sZW5ndGggPiAwKSB7CiAgICBkZXN0cm95KHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKTsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gbnVsbDsnAMOyx7kCrNEEBXR5cGVzAgQAw7LHuQLyzwX7CfCfk4RpbnRlcmZhY2UgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZyB7CiAgICBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ/OiBzdHJpbmc7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzPzogc3RyaW5nOwogICAgZWdnUGFyYW1ldGVycz86IGFueTsKICAgIHRvYXN0PzogYm9vbGVhbjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHsKICAgIGFiSUQ6IHN0cmluZzsKICAgIHJlY29yZEtleTogc3RyaW5nOwogICAgYWJWZXJzaW9uPzogbnVtYmVyOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3kgewogICAgYXNrSUQ6IHN0cmluZzsKfQoKdHlwZSBBQkFydGlmYWN0RGVwZW5kZW5jeSA9IEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHwgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgppbnRlcmZhY2UgQUJBcnRpZmFjdEJ1bmRsZSB7CiAgICBpZDogc3RyaW5nOwogICAgbmFtZTogc3RyaW5nOwogICAgZm9ybWF0VmVyc2lvbjogbnVtYmVyOwogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+OwogICAgY2FzdWFsT1NWZXJzaW9uOiBBdXhWZXJzaW9uOwogICAgY3JlYXRlZFRpbWVzdGFtcDogc3RyaW5nOwogICAgYWJTaGVsbFZlcnNpb246IHN0cmluZzsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RTaGFyZCB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+OwogICAgZGVwZW5kZW5jaWVzOiBBcnJheTxBQkFydGlmYWN0RGVwZW5kZW5jeT47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RXhwZXJpZW5jZSB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoIHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmc7CiAgICBhdXRob3JpemVkOiBib29sZWFuOwogICAgZmFpbHVyZVJlYXNvbjogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZVJlYXNvbjsKfQoKdHlwZSBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbicgfCAndXNlcl9kZWNsaW5lZF9pbnN0X3Blcm1pc3Npb24nIHwgJ3Vua25vd24nOwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICByZWFzb24/OiBhbnk7CiAgICBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwp9CicAw7LHuQKs0QQab25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUCBADDsse5AuzZBbw9QGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGF0KSkpOwp9CgppZiAoc291cmNlRXZlbnQgPT09ICdhc2snIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdwYXN0ZScgfHwgCiAgICBzb3VyY2VFdmVudCA9PT0gJ2Jvb3QnIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdmaWxlX3VwbG9hZCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAndG9vbCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnCikgewogICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBib3RzIGJlaW5nIGFkZGVkIGFyZSBhcnRpZmFjdCBzaGFyZHMgdGhhdCBuZWVkcyB0byBiZSByZWNvbnN0aXR1dGVkLgogICAgY29uc3QgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGU6IFJlY29yZDxzdHJpbmcsIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmc+ID0ge307IC8vIEtleSBpcyBhcnRpZmFjdCBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwogICAgY29uc3QgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpOyAvLyBUaGlzIHNldCB0cmFja3MgYXJ0aWZhY3QgaWRzIHRoYXQgYXJlIGFscmVhZHkgcXVldWVkIHRvIGJlIHJlY29uc3RpdHV0ZWQgd2l0aCBhIG5ldyBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVHJhY2sgb3JpZ2luYWwgaW5zdGFuY2UgSURzIHRoYXQgd2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGdpdmUgbmV3IGluc3RhbmNlcwoKICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICBpZiAoZGF0YSAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYKICAgICAgICAgICAgIWRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkICYmCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlPy5zdGFydHNXaXRoKCfwn6esJykKICAgICAgICApIHsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IHN0cmluZyA9IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IEpTT04ucGFyc2UoZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGUuc3Vic3RyaW5nKDIpKTsKCiAgICAgICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICAgICAgLy8gU2hhcmQgaGFzIGFuIGFydGlmYWN0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gJiYgIW9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmhhcyhhYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDE6IEluc3RhbmNlIGFscmVhZHkgZXhpc3RzIC0gY3JlYXRlIG5ldyBpbnN0YW5jZSAoZmlyc3QgdGltZSB3ZSBzZWUgdGhpcyBjb2xsaXNpb24pCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW25ld0FydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBuZXdBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXM6IGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuYWRkKGFiQXJ0aWZhY3RCdW5kbGUuaWQpOyAvLyBUcmFjayB0aGF0IHdlJ3JlIGNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIGZvciB0aGlzIGFydGlmYWN0IElECiAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuYWRkKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsgLy8gVHJhY2sgdGhhdCB3ZSd2ZSBkZWNpZGVkIHRvIHJlcGxhY2UgdGhpcyBvcmlnaW5hbCBpbnN0YW5jZSBJRAoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMTogU2hhcmQgZnJvbSBleGlzdGluZyBpbnN0YW5jZS4gQ3JlYXRpbmcgbmV3IGluc3RhbmNlLiAob2xkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSwgbmV3OiAke25ld0FydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxYjogV2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBvcmlnaW5hbCBJRCAtIGFkZCB0aGlzIHNoYXJkIHRvIHRoYXQgbmV3IGluc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDFiOiBBZGRpdGlvbmFsIHNoYXJkIGZvciByZXBsYWNlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAob3JpZ2luYWw6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDI6IEluc3RhbmNlIGFscmVhZHkgcXVldWVkIGZvciByZWNvbnN0aXR1dGlvbiAtIGRpc3Bvc2UgZHVwbGljYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDI6IER1cGxpY2F0ZSBzaGFyZCBmb3IgcXVldWVkIGluc3RhbmNlLiBEaXNwb3NpbmcuIChhYkFydGlmYWN0SW5zdGFuY2VJRDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDM6IEluc3RhbmNlIHRvIHJlY29uc3RpdHV0ZSB3aXRoIGV4aXN0aW5nIElECiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAzOiBJbnN0YW5jZSB0byByZWNvbnN0aXR1dGUuIChhYkFydGlmYWN0SW5zdGFuY2VJRDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU2hhcmQgaGFzIG5vIGFydGlmYWN0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICBpZiAoYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuaGFzKGFiQXJ0aWZhY3RCdW5kbGUuaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSA0OiBBcnRpZmFjdCBhbHJlYWR5IGhhcyBuZXcgaW5zdGFuY2UgcXVldWVkIC0gZGlzcG9zZSBkdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgNDogRHVwbGljYXRlIHNoYXJkIGZvciBhcnRpZmFjdCB3aXRoIG5ldyBpbnN0YW5jZSBxdWV1ZWQuIERpc3Bvc2luZy4gKGFydGlmYWN0SWQ6ICR7YWJBcnRpZmFjdEJ1bmRsZS5pZH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDU6IENyZWF0ZSBuZXcgaW5zdGFuY2UgZm9yIGFydGlmYWN0IHdpdGhvdXQgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdBcnRpZmFjdEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbbmV3QXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IG5ld0FydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDU6IENyZWF0aW5nIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRC4gKG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgbm90IGEgc2hhcmQgYm90LiBJZ25vcmUgaXQuCiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZTpgLCBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZSk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzOmAsIGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXMpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6YCwgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQ6YCwgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQpOwogICAgfQoKICAgIGZvciAoY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpIHsKICAgICAgICBjb25zdCByZWNvbnN0aXR1dGVBcmc6IEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgPSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF07CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBSZWNvbnN0aXR1dGluZyBhcnRpZmFjdCBpbnN0YW5jZTogJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0UmVjb25zdGl0dXRlKHJlY29uc3RpdHV0ZUFyZyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoc291cmNlRXZlbnQgPT09ICdjcmVhdGVfYXJ0aWZhY3RfcHJvbWlzZScpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICAgICAgLy8gRG8gYSBzcGVjaWFsIHNob3V0IHNvIHRoYXQgdGhlIGNyZWF0ZSBhcnRpZmFjdCBwcm9taXNlIGZ1bmN0aW9uIGNhbiBjYXRjaCB0aGlzIGVycm9yLgogICAgICAgICAgICAgICAgY29uc3QgZmFpbHVyZVJlc3VsdCA9IHsKICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGU6ICdhcnRpZmFjdF9wcm9taXNlX3JlY29uc3RpdHV0aW9uX2ZhaWxlZCcsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBgUmVjb25zdGl0dXRpb24gZnJvbSBhcnRpZmFjdCBwcm9taXNlIGhhcyBmYWlsZWQuIENhdWdodCBlcnJvcjogJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXM6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgICAgICAgICAgICAgICAgIGVnZ1BhcmFtZXRlcnM6IHJlY29uc3RpdHV0ZUFyZy5lZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGU6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBzaG91dCgnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBmYWlsdXJlUmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9Cn0nAMOyx7kCrNEEG29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaAIEAMOyx7kCp5cGpQJAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKdGhpc0JvdC5hYlByZXByb2Nlc3NCb3REYXRhVG9BcnRpZmFjdFByb21pc2VzKHsgYm90RGF0YTogdGhhdC5ib3REYXRhIH0pOycAw7LHuQKs0QQWYWJHZXRBcnRpZmFjdEluc3RhbmNlcwIEAMOyx7kCzZkGygdAY29uc3QgeyAKICAgIGJvdHMsCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge30KCmlmIChib3RzKSB7CiAgICBhc3NlcnQoQXJyYXkuaXNBcnJheShib3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIG11c3QgYmUgYW4gYXJyYXkuYCk7Cn0KCmNvbnN0IGluc3RhbmNlczogUmVjb3JkPHN0cmluZywgQm90W10+ID0ge30gLy8gS2V5IGlzIGFydGlmYWN0IGluc3RhbmNlIGlkLgoKZnVuY3Rpb24gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYm90KSB7CiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbGV0IGJvdEFycmF5ID0gaW5zdGFuY2VzW2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICAgICAgaWYgKCFib3RBcnJheSkgewogICAgICAgICAgICBib3RBcnJheSA9IFtdOwogICAgICAgICAgICBpbnN0YW5jZXNbYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSURdID0gYm90QXJyYXk7CiAgICAgICAgfQoKICAgICAgICBib3RBcnJheS5wdXNoKGJvdCk7CiAgICB9Cn0KCmlmIChib3RzKSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgaW5zdGFuY2VzIGluIHByb3ZpZGVkIGxpc3Qgb2YgYm90cy4KICAgIGJvdHMuZm9yRWFjaChiID0+IHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGIpKTsKfSBlbHNlIHsKICAgIC8vIEdldCBhcnRpZmFjdCBpbnN0YW5jZXMgaW4gaW5zdC4KICAgIGdldEJvdHMoYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShiKSk7Cn0KCnJldHVybiBpbnN0YW5jZXM7JwDDsse5AqzRBBVhYkdldEFydGlmYWN0UGF0dGVybnMCBADDsse5ApihBvMHQGNvbnN0IHsgCiAgICBib3RzLAogICAgYWJBcnRpZmFjdE5hbWUsCn0gPSB0aGF0ID8/IHt9CgppZiAoYm90cykgewogICAgYXNzZXJ0KEFycmF5LmlzQXJyYXkoYm90cyksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyBtdXN0IGJlIGFuIGFycmF5LmApOwp9Cgpjb25zdCBwYXR0ZXJuczogUmVjb3JkPHN0cmluZywgQm90W10+ID0ge30gLy8gS2V5IGlzIGFydGlmYWN0IG5hbWUuCgpmdW5jdGlvbiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGJvdCkgewogICAgLy8gUGF0dGVybiBib3RzIGhhdmUgYWJBcnRpZmFjdE5hbWUgYnV0IG5vIGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgIWJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxldCBib3RBcnJheSA9IHBhdHRlcm5zW2JvdC50YWdzLmFiQXJ0aWZhY3ROYW1lXTsKCiAgICAgICAgaWYgKCFib3RBcnJheSkgewogICAgICAgICAgICBib3RBcnJheSA9IFtdOwogICAgICAgICAgICBwYXR0ZXJuc1tib3QudGFncy5hYkFydGlmYWN0TmFtZV0gPSBib3RBcnJheTsKICAgICAgICB9CgogICAgICAgIGJvdEFycmF5LnB1c2goYm90KTsKICAgIH0KfQoKaWYgKGJvdHMpIHsKICAgIC8vIEdldCBhcnRpZmFjdCBwYXR0ZXJucyBpbiBwcm92aWRlZCBsaXN0IG9mIGJvdHMuCiAgICBib3RzLmZvckVhY2goYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGIpKTsKfSBlbHNlIHsKICAgIC8vIEdldCBhcnRpZmFjdCBwYXR0ZXJucyBpbiBpbnN0LgogICAgZ2V0Qm90cyhiID0+IHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYikpOwp9CgpyZXR1cm4gcGF0dGVybnM7JwDDsse5AqzRBBhhYlB1Ymxpc2hBcnRpZmFjdFBhdHRlcm4CBADDsse5AoypBvoFQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgc3R1ZGlvLAogICAgc2hhcmRCb3RzLAogICAgbWFudWFsUHVibGlzaCwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3ROYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2Ygc3R1ZGlvID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdHVkaW8gaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpICYmIHNoYXJkQm90cy5sZW5ndGggPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyBhIHJlcXVpcmVkIEJvdCBhcnJheSBwYXJhbWV0ZXIuIEl0IG11c3QgaGF2ZSBhdCBsZWFzdCAxIGJvdC5gKTsKCnJldHVybiBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hBQih7CiAgICBhYjogYWJBcnRpZmFjdE5hbWUsIAogICAgdGFyZ2V0OiBzaGFyZEJvdHMsIAogICAgc3R1ZGlvLAogICAgbWFudWFsUHVibGlzaCwKICAgIHNvdXJjZUV2ZW50OiAncHVibGlzaF9hcnRpZmFjdF9wYXR0ZXJuJywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2g6IChhcmcpID0+IHsKICAgICAgICB0aGlzQm90LmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhKGFyZy5ib3REYXRhKTsKICAgIH0KfSk7JwDDsse5AqzRBCZhYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YQIEAMOyx7kCh68G5gZAY29uc3QgYm90RGF0YSA9IHRoYXQ7Cgphc3NlcnQobGlua3MudXRpbHMuaXNPYmplY3QoYm90RGF0YSksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJndW1lbnQgbXVzdCBiZSBhbiBvYmplY3QuYCk7Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwogICAgCiAgICBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3RCb3QgPT09IHRydWUpIHsKICAgICAgICAvLyBSZW1vdmUgYXJ0aWZhY3QgYm90cy4KICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgIAogICAgfSBlbHNlIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAvLyBTdHJpcCBhcnRpZmFjdCBpbnN0YW5jZSBkYXRhIGZyb20gYm90LgogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7CgogICAgICAgIC8vIFJlbW92ZSBzb21lIG90aGVycy4KICAgICAgICBkZWxldGUgZGF0YS50YWdzLmNyZWF0b3I7CgogICAgICAgIC8vIEdpdmUgZWFjaCBib3QgYSBjaGFuY2UgdG8gc3RyaXAgaW5zdGFuY2UgZGF0YSBmcm9tIHRoZSBjb3B5IG9mIGl0cyBvd24gYm90IGRhdGEuCiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHdoaXNwZXIoZGF0YS5pZCwgJ29uQUJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEnLCB7IGRhdGEgfSkpOwogICAgfQp9CiAgICAnAMOyx7kCrNEED2lzRWdnRGVwZW5kZW5jeQIEAMOyx7kC7rUGUkByZXR1cm4gbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8uYWJJRCkgJiYgbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8ucmVjb3JkS2V5KTsnAMOyx7kCrNEED2lzQXNrRGVwZW5kZW5jeQIEAMOyx7kCwbYGKkByZXR1cm4gbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8uYXNrSUQpOycAw7LHuQKs0QQQb25BbnlCb3RzQ2hhbmdlZAIEAMOyx7kC7LYGyQhALy8gY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwoKZm9yIChjb25zdCBjaGFuZ2VkIG9mIHRoYXQpIHsKICAgIGlmIChjaGFuZ2VkID09IG51bGwpIHsKICAgICAgICBjb250aW51ZTsKICAgIH0KCiAgICAvLyAxKSBvbmx5IGNhcmUgYWJvdXQgYm90cyB3aXRoIGFydGlmYWN0IHRhZ3MKICAgIGlmICghY2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0TmFtZSB8fCAhY2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgY29udGludWU7CgogICAgLy8gMikgYXJ0aWZhY3QgbXVzdCBiZSByZWNvbnN0aXR1dGVkLgogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIGNvbnRpbnVlOwoKICAgIGlmICh0aGlzQm90LmlzRXhwZXJpZW5jZUVuYWJsZWQoKSkgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2hhbmdlcyBvbiBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2NoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGRldGVjdGVkLCBjYWxsaW5nIHRvIHVwZGF0ZSBleHBlcmllbmNlLmAsIEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgIGNoYW5nZWRCb3RJZDogY2hhbmdlZC5ib3QuaWQsCiAgICAgICAgICAgICAgICBjaGFuZ2VkVGFnczogY2hhbmdlZC50YWdzLAogICAgICAgICAgICB9KSk7CiAgICAgICAgfQogICAgICAgIHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdCBpbnN0YW5jZSAke2NoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGNoYW5nZWQgYnV0IGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICAgICAgfQogICAgfQp9CicAw7LHuQKs0QQZZXhwZXJpZW5jZVRpY2tSYXRlTGltaXRNUwIEAMOyx7kCtr8GBDUwMDAnAMOyx7kCrNEEFmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWcCBADDsse5Aru/BhlvbkFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzJwDDsse5AqzRBAhkZWJ1Z0V4cAIEAMOyx7kC1b8GBWZhbHNlJwDDsse5AqzRBBdpc1JlY29uc3RpdHV0aW9uRW5hYmxlZAIEAMOyx7kC278GfEBpZiAoY29uZmlnQm90LnRhZ3MuYWJBcnRpZmFjdFJlY29uc3RpdHV0aW9uID09PSBmYWxzZSkgewogICAgcmV0dXJuIGZhbHNlOwp9CgovLyBSZWNvbnN0aXR1dGlvbiBvbiBieSBkZWZhdWx0LgpyZXR1cm4gdHJ1ZTsnAMOyx7kCrNEEF2FiQ29sbGVjdEFydGlmYWN0U2hhcmRzAgQAw7LHuQLYwAbQGEBjb25zdCB7IHNoYXJkQm90cyB9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cyksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIHJlcXVpcmVkIHRvIGJlIGFuIGJvdCBhcnJheS5gKTsKCi8qKiBLZWVwIHRyYWNrIG9mIGRlcGVuZGVuY3kgaGFzaGVzLiBUaGlzIHByZXZlbnRzIGR1cGxpY2F0ZXMgaW4gdGhlIGFydGlmYWN0IGRlcGVuZGVuY2llcy4gKi8KY29uc3QgZGVwZW5kZW5jeUhhc2hlcyA9IG5ldyBTZXQoKTsKCmxldCBtZXJnZWRTaGFyZDogQUJBcnRpZmFjdFNoYXJkID0gewogICAgZGF0YToge30sCiAgICBkZXBlbmRlbmNpZXM6IFtdLAp9OwoKZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gc2hhcmRCb3QudGFncy5hYkFydGlmYWN0TmFtZTsKICAgIGNvbnN0IGJvdFNob3J0SWQgPSBzaGFyZEJvdC5pZC5zdWJzdHJpbmcoMCwgNSk7CgogICAgbGV0IHNoYXJkOiBBQkFydGlmYWN0U2hhcmQ7CiAgICBpZiAoc2hhcmRCb3QudGFnc1t0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKSB7CiAgICAgICAgaWYgKHNoYXJkQm90W3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10pIHsKICAgICAgICAgICAgc2hhcmQgPSBhd2FpdCBQcm9taXNlLnJlc29sdmUoc2hhcmRCb3RbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nICR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSB0YWcgaXMgZGVmaW5lZCBidXQgaXMgbm90IGEgdmFsaWQgZnVuY3Rpb24uYCB9OwogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdE5hbWV9LCBib3Q6ICR7Ym90U2hvcnRJZH0sIHNoYXJkOmAsIHNoYXJkKTsKICAgIH0KCiAgICBpZiAoc2hhcmQpIHsKICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzT2JqZWN0KHNoYXJkKSkgewogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgbXVzdCBiZSBhbiBvYmplY3QuYCB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHNoYXJkLmRhdGEpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc09iamVjdChzaGFyZC5kYXRhKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBAJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHNoYXJkICdkYXRhJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIG9iamVjdC5gIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNoYWxsb3cgbWVyZ2Ugc2hhcmQncyBkYXRhIHByb3BlcnRpZXMgaW50byBjb21iaW5lZCBhcnRpZmFjdCBkYXRhLgogICAgICAgICAgICBtZXJnZWRTaGFyZC5kYXRhID0geyAuLi5tZXJnZWRTaGFyZC5kYXRhLCAuLi5zaGFyZC5kYXRhIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgIGlmICghbGlua3MudXRpbHMuaXNBcnJheShzaGFyZC5kZXBlbmRlbmNpZXMpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgJ2RlcGVuZGVuY2llcycgcHJvcGVydHkgbXVzdCBiZSBhbiBhcnJheS5gIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgICAgIC8vIFZhbGlkYXRlIHRoYXQgZGVwZW5kZW5jeSBpcyBvbmUgb2YgdGhlIHN1cHBvcnRlZCB0eXBlcy4KICAgICAgICAgICAgICAgIGlmICghdGhpc0JvdC5pc0VnZ0RlcGVuZGVuY3koZGVwZW5kZW5jeSkgJiYgIXRoaXNCb3QuaXNBc2tEZXBlbmRlbmN5KGRlcGVuZGVuY3kpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBoYXMgYSBkZXBlbmRlbmN5IGVudHJ5IHRoYXQgaXMgbmVpdGhlciBhbiBlZ2cgb3IgYXNrIGRlcGVuZGVuY3kgdHlwZS5gIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoaXMgZGVwZW5kZW5jeSBpc250IGFscmVhZHkgY29sbGVjdGVkLgogICAgICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIGRlcGVuZGVuY3kpOwoKICAgICAgICAgICAgICAgIGlmICghZGVwZW5kZW5jeUhhc2hlcy5oYXMoaGFzaCkpIHsKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmN5SGFzaGVzLmFkZChoYXNoKTsKICAgICAgICAgICAgICAgICAgICBtZXJnZWRTaGFyZC5kZXBlbmRlbmNpZXMucHVzaChkZXBlbmRlbmN5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gTWFrZSBzdXJlIHdlIGhhdmUgYXQgbGVhc3Qgb25lIGRlcGVuZGVuY3kuCmlmIChtZXJnZWRTaGFyZC5kZXBlbmRlbmNpZXMubGVuZ3RoID09PSAwKSB7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBtdXN0IGxpc3QgYXQgbGVhc3Qgb25lIGRlcGVuZGVuY3kgaW4gb3JkZXIgdG8gcmVjb25zdGl0dXRlIHByb3Blcmx5LmAgfTsKfQoKY29uc3QgcmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdCA9IHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBzaGFyZDogbWVyZ2VkU2hhcmQsCn0KCnJldHVybiByZXN1bHQ7JwDDsse5AqzRBBdjYW5Vc2VyVXBkYXRlRXhwZXJpZW5jZQIEAMOyx7kCqdkGzglAY29uc3QgewogICAgcmVtb3RlSWQgPSBjb25maWdCb3QuaWQsCiAgICBzaGFyZEJvdAp9ID0gdGhhdCA/PyB7fQoKaWYgKHNoYXJkQm90ICYmIAogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0TmFtZSAmJgogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRAopIHsKICAgIC8vIE5lZWQgdG8gZmlndXJlIG91dCBpZiB0aGlzIHVzZXIgaXMgYWxsb3dlZCB0byB1cGRhdGUgdGhlIGV4cGVyaWVuY2Ugb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgIGxldCBjYW5Vc2VyVXBkYXRlID0gZmFsc2U7CgogICAgc3dpdGNoIChzaGFyZEJvdC5zcGFjZSkgewogICAgICAgIGNhc2UgJ3NoYXJlZCc6CiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgIGNhc2UgJ3RlbXBTaGFyZWQnOgogICAgICAgICAgICAvLyB0ZW1wU2hhcmVkIHNwYWNlIG1lYW5zIHRoYXQgdGhpcyBib3QgaXMgYmFzaWNhbGx5IG93bmVkIGJ5IHRoaXMgdXNlci4KICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3JlbW90ZVRlbXBTaGFyZWQnOgogICAgICAgICAgICAvLyByZW1vdGVUZW1wU2hhcmVkIHNwYWNlIG1lYW5zIHRoYXQgdGhpcyBib3QgaXMgb3duZWQgYnkgc29tZW9uZSBlbHNlLgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2xvY2FsJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ3RlbXBMb2NhbCc6CiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVW5yZWNvZ25pemVkIGJvdCBzcGFjZTpgLCBzaGFyZEJvdC5zcGFjZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgfQoKICAgIHJldHVybiBjYW5Vc2VyVXBkYXRlOwp9IGVsc2UgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwcm92aWRlZCBzaGFyZEJvdCBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgZnJvbSBhbiBhcnRpZmFjdCBpbnN0YW5jZS5gLCBzaGFyZEJvdCk7CiAgICB9CiAgICByZXR1cm4gZmFsc2U7Cn0nAMOyx7kCrNEEGmFiQ3JlYXRlQXJ0aWZhY3RQcm9taXNlQm90AgQAw7LHuQL44gb5E0Bjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdFNoYXJkLAogICAgc3BhY2UgPSAnc2hhcmVkJywKfSA9IHRoYXQgPz8ge307CgoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChhYkFydGlmYWN0U2hhcmQgJiYgYWJBcnRpZmFjdFNoYXJkLmRhdGEgJiYgYWJBcnRpZmFjdFNoYXJkLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0U2hhcmQgaXMgYSByZXF1aXJlZCB0byBiZSBhIEFCQXJ0aWZhY3RTaGFyZC5gKTsKCmNvbnN0IGJvdERhdGEgPSBbXTsKY29uc3QgcHJvbWlzZUlkID0gdXVpZCgpOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IHRoaXNCb3QuYWJDcmVhdGVBcnRpZmFjdEJ1bmRsZSh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdFNoYXJkIH0pOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2VuZXJhdGVkIGFiQXJ0aWZhY3RCdW5kbGU6YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCmJvdERhdGFbcHJvbWlzZUlkXSA9IHsKICAgIGlkOiBwcm9taXNlSWQsCiAgICBzcGFjZSwKICAgIHRhZ3M6IHsKICAgICAgICBhYkFydGlmYWN0TmFtZSwKICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKSwKICAgICAgICBhYkFydGlmYWN0UHJvbWlzZTogdHJ1ZSwKICAgIH0KfQoKLy8gQ3JlYXRlIGFydGlmYWN0IHByb21pc2UgdGhyb3VnaCBhYkNyZWF0ZUJvdHMuIAovLyBUaGlzIHdpbGwgdHJpZ2dlciBhcnRpZmFjdCdzIG9uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlIGFuZCBpdCB3aWxsIGZpbmQKLy8gdGhpcyBhcnRpZmFjdCBwcm9taXNlIGFuZCB1c2UgdGhlIGRhdGEgdG8gcmVjb25zdGl0dXRlIGl0LgpsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90RGF0YSwgc291cmNlRXZlbnQ6ICdjcmVhdGVfYXJ0aWZhY3RfcHJvbWlzZScgfSk7Cgpjb25zdCB3YWl0Rm9yUmVjb25zdGl0dXRpb24gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICBmdW5jdGlvbiBjbGVhbnVwKCkgewogICAgICAgIG9zLnJlbW92ZUJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkJywgaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQpOwogICAgICAgIG9zLnJlbW92ZUJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCk7CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQobGlzdGVuZXJUaGF0KSB7CiAgICAgICAgaWYgKGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQgfHwKICAgICAgICAgICAgbGlzdGVuZXJUaGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgKSB7CiAgICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICAgICAgcmVzb2x2ZShsaXN0ZW5lclRoYXQpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQobGlzdGVuZXJUaGF0KSB7CiAgICAgICAgaWYgKGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQgfHwKICAgICAgICAgICAgbGlzdGVuZXJUaGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgKSB7CiAgICAgICAgICAgIGNsZWFudXAoKTsKICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihsaXN0ZW5lclRoYXQuZXJyb3JNZXNzYWdlKSk7CiAgICAgICAgfQogICAgfQoKICAgIG9zLmFkZEJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkJywgaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQpOwogICAgb3MuYWRkQm90TGlzdGVuZXIodGhpc0JvdCwgJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkJywgaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkKTsKfSkKCmNvbnN0IHJlY29uc3RpdHV0ZVJlc3VsdCA9IGF3YWl0IHdhaXRGb3JSZWNvbnN0aXR1dGlvbjsKCnJldHVybiByZWNvbnN0aXR1dGVSZXN1bHQuc2hhcmRCb3RzOycAw7LHuQKs0QQWYWJDcmVhdGVBcnRpZmFjdEJ1bmRsZQIEAMOyx7kC8PYGmQhAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0U2hhcmQsCn0gPSB0aGF0OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQoYWJBcnRpZmFjdFNoYXJkICYmIGFiQXJ0aWZhY3RTaGFyZC5kYXRhICYmIGFiQXJ0aWZhY3RTaGFyZC5kZXBlbmRlbmNpZXMsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdFNoYXJkIGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBBQkFydGlmYWN0U2hhcmQuYCk7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gewogICAgbmFtZTogYWJBcnRpZmFjdE5hbWUsCiAgICBmb3JtYXRWZXJzaW9uOiAxLAogICAgZGF0YTogYWJBcnRpZmFjdFNoYXJkLmRhdGEsCiAgICBkZXBlbmRlbmNpZXM6IGFiQXJ0aWZhY3RTaGFyZC5kZXBlbmRlbmNpZXMsCn0KCi8vIEdlbmVyYXRlIHRoZSBhcnRpZmFjdCBpZCwgd2hpY2ggaXMgc2hhMjU2IGhhc2ggb2YgdGhlIGNvcmUgY29udGVudHMgb2YgdGhlIGFydGlmYWN0LgphYkFydGlmYWN0QnVuZGxlLmlkID0gY3J5cHRvLnNoYTI1NihhYkFydGlmYWN0QnVuZGxlKTsKCi8vIFN0b3JlIHNvbWUgZXh0cmEgbWV0YWRhdGEgcHJvcGVydGllcyB3aXRoIHRoZSBhcnRpZmFjdC4KLy8gVGhlc2UgYXJlIG5vdCBjb3JlIHRvIHRoZSBhcnRpZmFjdCdzIGZ1bmN0aW9uYWxpdHkgYnV0IG1heSBiZSB1c2VmdWwgYXMgYXJ0aWZhY3RzIGV2b2x2ZS4KYWJBcnRpZmFjdEJ1bmRsZS5jYXN1YWxPU1ZlcnNpb24gPSBvcy52ZXJzaW9uKCk7CmFiQXJ0aWZhY3RCdW5kbGUuY3JlYXRlZFRpbWVzdGFtcCA9IERhdGVUaW1lLm5vdygpLnRvSVNPKCk7CmFiQXJ0aWZhY3RCdW5kbGUuYWJTaGVsbFZlcnNpb24gPSBgJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWFqb3JWZXJzaW9ufS4ke2xpbmtzLnZlcnNpb24ucmF3LmFiU2hlbGxNaW5vclZlcnNpb259YDsKCnJldHVybiBhYkFydGlmYWN0QnVuZGxlOycAw7LHuQKs0QQGY3JlYXRlAgQAw7LHuQKK/wYo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAw7LHuQKs0QQTaXNFeHBlcmllbmNlRW5hYmxlZAIEAMOyx7kCsf8GdEBpZiAoY29uZmlnQm90LnRhZ3MuYWJBcnRpZmFjdEV4cGVyaWVuY2UgPT09IHRydWUpIHsKICAgIHJldHVybiB0cnVlOwp9CgovLyBFeHBlcmllbmNlIG9mZiBieSBkZWZhdWx0LgpyZXR1cm4gZmFsc2U7JwDDsse5AqzRBB5hYkxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQCBADDsse5AqaAB9wbQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKCF0aGlzQm90LmlzRXhwZXJpZW5jZUVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgIHJldHVybjsKfQoKaWYgKCF0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzID0ge307Cn0KCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGFscmVhZHkgaGFzIGEgZG9jdW1lbnQgbG9hZGVkLmApOwogICAgfQogICAgcmV0dXJuOwp9CgpsZXQgZXhwZXJpZW5jZUF1dGg6IEFCQXJ0aWZhY3RFeHBlcmllbmNlQXV0aCA9IGF3YWl0IHRoaXNCb3QuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgppZiAoIWV4cGVyaWVuY2VBdXRoLmF1dGhvcml6ZWQpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBBcnRpZmFjdCBleHBlcmllbmNlIHdhcyBub3QgYXV0aG9yaXplZC4gUmVhc29uOiAke2V4cGVyaWVuY2VBdXRoLmZhaWx1cmVSZWFzb259YCk7CiAgICByZXR1cm47Cn0KCi8vIEdldCB0aGUgYXJ0aWZhY3QgaW5zdGFuY2UncyBzaGFyZWQgZG9jdW1lbnQgYXMgd2VsbCBhcyB0aGUgZXhwZXJpZW5jZSBtYXAuCmNvbnN0IGRvY3VtZW50ID0gYXdhaXQgb3MuZ2V0U2hhcmVkRG9jdW1lbnQobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWUsIGBhcnRpZmFjdEluc3RhbmNlXyR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCwgJ21haW4nKTsKY29uc3QgZXhwZXJpZW5jZU1hcCA9IGRvY3VtZW50LmdldE1hcCgnZXhwZXJpZW5jZScpOwoKY29uc3Qgc2tpcEtleXMgPSBuZXcgU2V0KFsKICAgICdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJywKICAgIC8vIEFkZCBtb3JlIGtleXMgaGVyZSBpZiBuZWVkZWQKICAgIC8vICdzb21lT3RoZXJLZXknLAogICAgLy8gJ3lldEFub3RoZXJLZXknCl0pOwoKY29uc3QgZXhwZXJpZW5jZVN1YiA9IGV4cGVyaWVuY2VNYXAuZGVlcENoYW5nZXMuc3Vic2NyaWJlKChldmVudHMpID0+IHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBvbiBkZWVwIGNoYW5nZXM6YCwgZXZlbnRzKTsKICAgIH0KCiAgICAvLyBDb2xsZWN0IGFsbCBjaGFuZ2VkIGtleXMKICAgIGNvbnN0IGFsbEtleXMgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGV2dCBvZiBldmVudHMgPz8gW10pIHsKICAgICAgICBjb25zdCBtID0gZXZ0Py5jaGFuZ2VzOwogICAgICAgIGlmIChtICYmIHR5cGVvZiBtLmtleXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBrIG9mIG0ua2V5cygpKSB7CiAgICAgICAgICAgICAgICBhbGxLZXlzLmFkZChrKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBTa2lwIGlmICphbGwqIGNoYW5nZXMgYXJlIGluc2lkZSB0aGUgc2tpcCBsaXN0CiAgICBjb25zdCBzaG91bGRTa2lwID0gYWxsS2V5cy5zaXplID4gMCAmJiBbLi4uYWxsS2V5c10uZXZlcnkoKGspID0+IHNraXBLZXlzLmhhcyhrKSk7CiAgICBpZiAoc2hvdWxkU2tpcCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpcHBpbmcgY2FsbCB0byBhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZSwgdGhlIG9ubHkgY2hhbmdlIHRvIHRoZSBleHBlcmllbmNlIHdlcmUgc3BlY2lhbCByZXNlcnZlZCBwcm9wZXJ0aWVzLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICB9CgogICAgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9KTsKCnRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdID0geyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1Yn07CgppZiAodGFncy5kZWJ1Z0V4cCkgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBpbnN0YW5jZSBkb2N1bWVudCBsb2FkZWQ6YCwgdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0pOwoKICAgIGNvbnN0IGV4cGVyaWVuY2VKU09OID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlTWFwLnRvSlNPTigpKSk7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGxvYWRlZCBleHBlcmllbmNlIG1hcCBzdGF0ZTpgLCBleHBlcmllbmNlSlNPTik7Cn0KCmNvbnN0IGFiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQgPSBleHBlcmllbmNlTWFwLmdldCgnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcpOwoKaWYgKGFiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQgPT09IHRydWUpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBmcm9tIGV4cGVyaWVuY2UuYCk7CiAgICB9CiAgICAvLyBJbW1lZGlhdGVseSBnaXZlIHRoZSBzaGFyZCBib3RzIHRoZSBjdXJyZW50IGV4cGVyaWVuY2Ugc3RhdGUuCiAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaW5pdGlhbGl6aW5nIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGV4cGVyaWVuY2UuYCk7CiAgICB9CiAgICAvLyBJbml0aWFsaXplIHRoZSBleHBlcmllbmNlIHN0YXRlIHdpdGggdGhlIGN1cnJlbnQgc2hhcmQgZGF0YS4KICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOyAgICAKfQonAMOyx7kCrNEEIGFiVW5sb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50AgQAw7LHuQKDnAeJBkBjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3ViIH0gPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsgCgogICAgaWYgKGV4cGVyaWVuY2VTdWIpIHsKICAgICAgICBleHBlcmllbmNlU3ViLnVuc3Vic2NyaWJlKCk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdW5zdWJzY3JpYmVkIGZyb20gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZXhwZXJpZW5jZSBtYXAuYCk7CiAgICAgICAgfQogICAgfQoKICAgIGRlbGV0ZSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVtb3ZlZCBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBkb2N1bWVudC5gKTsKICAgIH0KfScAw7LHuQKs0QQeYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzAgQAw7LHuQKNoge0AkBjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBzaGFyZEJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICByZXR1cm4gYi50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRAp9KTsKCnJldHVybiBzaGFyZEJvdHM7JwDDsse5AqzRBCZhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZQIEAMOyx7kCwqQH6QdAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgcmV0dXJuOwp9CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgY29uc3QgaW5zdGFuY2VEb2MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICBpZiAoaW5zdGFuY2VEb2MpIHsKICAgICAgICBjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEfSk7CgogICAgICAgIGNvbnN0IHsgZG9jdW1lbnQsIGV4cGVyaWVuY2VNYXAsIGV4cGVyaWVuY2VTdWIgfSA9IGluc3RhbmNlRG9jOwoKICAgICAgICBjb25zdCBleHBlcmllbmNlRGF0YSA9IGV4cGVyaWVuY2VNYXAudG9KU09OKCk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRpbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gd2l0aCBleHBlcmllbmNlIHN0YXRlOmAsIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXhwZXJpZW5jZURhdGEpKSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKHNoYXJkQm90cywgJ29uQUJBcnRpZmFjdEV4cGVyaWVuY2UnLCB7IGRhdGE6IGV4cGVyaWVuY2VEYXRhIH0pKTsKICAgIH0KfScAw7LHuQKs0QQiYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRXhwZXJpZW5jZQIEAMOyx7kCrKwH0ChAaW1wb3J0IHsgU2hhcmVkTWFwIH0gZnJvbSAnY2FzdWFsb3MnOwoKY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICghdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzKSB7CiAgICB0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMgPSBuZXcgU2V0KCk7Cn0KCmlmICh0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgdXBkYXRlIGlzIGFscmVhZHkgaW4gcHJvZ3Jlc3MgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICB9CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5hZGQoYWJBcnRpZmFjdEluc3RhbmNlSUQpOwoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IGluc3RhbmNlRG9jID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgaWYgKGluc3RhbmNlRG9jKSB7CiAgICAgICAgY29uc3Qgc2hhcmRCb3RzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCiAgICAgICAgLy8gTmVlZCB0byBhc2sgaWYgdGhpcyB1c2VyIGlzIGFsbG93ZWQgdG8gdXBkYXRlIHRoZSBleHBlcmllbmNlIG9mIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UuCiAgICAgICAgY29uc3QgY2FuVXNlclVwZGF0ZSA9IGF3YWl0IHRoaXNCb3QuY2FuVXNlclVwZGF0ZUV4cGVyaWVuY2UoeyByZW1vdGVJZDogY29uZmlnQm90LmlkLCBzaGFyZEJvdDogc2hhcmRCb3RzWzBdIH0pOwoKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbiB1c2VyIHVwZGF0ZSBleHBlcmllbmNlIGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke3NoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELnN1YnN0cmluZygwLCA3KX0/YCwgY2FuVXNlclVwZGF0ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2FuVXNlclVwZGF0ZSkgewogICAgICAgICAgICBsZXQgY29sbGVjdFNoYXJkUmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdDsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb2xsZWN0U2hhcmRSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiQ29sbGVjdEFydGlmYWN0U2hhcmRzKHsgc2hhcmRCb3RzIH0pOwoKICAgICAgICAgICAgICAgIGlmICghY29sbGVjdFNoYXJkUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGNvbGxlY3RTaGFyZFJlc3VsdC5yZWFzb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRDpgLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYGNvbGxlY3RTaGFyZFJlc3VsdDpgLCBKU09OLnN0cmluZ2lmeShjb2xsZWN0U2hhcmRSZXN1bHQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbGxlY3RTaGFyZFJlc3VsdCAmJiBjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgLy8gT25seSB1cGRhdGUgZW50cnkgaW4gZXhwZXJpZW5jZU1hcCBpZiB0aGUgZGF0YSBpcyBhY3R1YWxseSBkaWZmZXJlbnQuCiAgICAgICAgICAgICAgICBjb25zdCBleHBlcmllbmNlTWFwOiBTaGFyZWRNYXAgPSBpbnN0YW5jZURvYy5leHBlcmllbmNlTWFwOwoKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogc2hhcmQgZGF0YSBtaWdodCBiZSB1bmRlZmluZWQvbnVsbAogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmREYXRhID0gKGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZCAmJiBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQuZGF0YSkgPyBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQuZGF0YSA6IHt9OwogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmREYXRhS2V5cyA9IE9iamVjdC5rZXlzKHNoYXJkRGF0YSk7CiAgICAgICAgICAgICAgICBjb25zdCBrZXlzVG9EZWxldGUgPSBbXTsKCiAgICAgICAgICAgICAgICAvLyBTaW1wbGUgZGVlcC1lcXVhbGl0eSBjaGVjayBmb3IgSlNPTi1zZXJpYWxpemFibGUgdmFsdWVzCiAgICAgICAgICAgICAgICBjb25zdCBpc0VxdWFsID0gKGEsIGIpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYSA9PT0gYikgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGEpID09PSBKU09OLnN0cmluZ2lmeShiKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gMSkgVXBzZXJ0IG9ubHkgd2hlbiBkaWZmZXJlbnQKICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHNoYXJkRGF0YUtleXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWwgPSBzaGFyZERhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWwgPSBleHBlcmllbmNlTWFwLmdldChrZXkpOwogICAgICAgICAgICAgICAgICAgIGlmICghaXNFcXVhbChvbGRWYWwsIG5ld1ZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRpbmcgZXhwZXJpZW5jZU1hcCBrZXkgIiR7a2V5fSJgLCBKU09OLnN0cmluZ2lmeSh7IG9sZFZhbCwgbmV3VmFsIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLnNldChrZXksIG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIpIENvbGxlY3Qga2V5cyB0aGF0IGV4aXN0IGluIHRoZSBtYXAgYnV0IG5vdCBpbiB0aGUgc2hhcmQgZGF0YQogICAgICAgICAgICAgICAgLy8gICAgKHdlIGF2b2lkIG11dGF0aW5nIHRoZSBtYXAgd2hpbGUgaXRlcmF0aW5nIGl0KQogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgZXhwZXJpZW5jZU1hcC5rZXlzKCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgZGVsZXRlIGFiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQuIEl0cyBhIHNwZWNpYWwgcHJvcGVydHkuCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoIXNoYXJkRGF0YUtleXMuaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXlzVG9EZWxldGUucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAzKSBSZW1vdmUgc3RhbGUga2V5cwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2Yga2V5c1RvRGVsZXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZWxldGluZyBzdGFsZSBleHBlcmllbmNlTWFwIGtleSAiJHtrZXl9ImApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLmRlbGV0ZShrZXkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChleHBlcmllbmNlTWFwLmdldCgnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcpICE9IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLnNldCgnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgdXBkYXRlIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGJlY2F1c2UgaW5zdGFuY2UgZG9jdW1lbnQgbm90IGxvYWRlZC5gKTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSBpbnN0YW5jZSBkb2N1bWVudHMgaGF2ZSBub3QgYmVlbiBpbml0aWFsaXplZC5gKTsKICAgIH0KfQoKdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmRlbGV0ZShhYkFydGlmYWN0SW5zdGFuY2VJRCk7JwDDsse5AqzRBAxvbkluc3RKb2luZWQCBADDsse5Av3UB4EDQG1hc2tzLmluc3RKb2luZWQgPSB0cnVlOwoKY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMoKTsKCmZvciAobGV0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGFydGlmYWN0SW5zdGFuY2VzKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9hZGluZyBhcnRpZmFjdCBpbnN0YW5jZSBkb2N1bWVudCBmb3IgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgIH0KICAgIAogICAgdGhpc0JvdC5hYkxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfScAw7LHuQKs0QQOb25BbnlCb3RzQWRkZWQCBADDsse5Av/XB8IEQGlmICghbWFza3MuaW5zdEpvaW5lZCkgewogICAgcmV0dXJuOwp9Cgpjb25zdCBhZGRlZEJvdHMgPSB0aGF0LmJvdHM7Cgpmb3IgKGNvbnN0IGJvdCBvZiBhZGRlZEJvdHMpIHsKICAgIGlmIChib3QgPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIGF3YWl0IG9zLnNsZWVwKDI1MCk7CgogICAgICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRldGVjdGVkIGFkZGVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEfS5gKQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKICAgICAgICB9CiAgICB9Cn0nAMOyx7kCrNEEGm9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkAgQAw7LHuQLC3AfeBUBsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdwcmludGFydGlmYWN0ZXhwZXJpZW5jZScsIChhcmdzKSA9PiB7CiAgICBjb25zdCBpbnN0YW5jZURvY3MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzOwoKICAgIGxldCBhbGxFeHBlcmllbmNlID0ge307CgogICAgZm9yIChsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gaW5zdGFuY2VEb2NzKSB7CiAgICAgICAgY29uc3QgZXhwZXJpZW5jZU1hcCA9IGluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0uZXhwZXJpZW5jZU1hcDsKICAgICAgICBjb25zdCBleHBlcmllbmNlSlNPTiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXhwZXJpZW5jZU1hcC50b0pTT04oKSkpOwogICAgICAgIGFsbEV4cGVyaWVuY2VbYWJBcnRpZmFjdEluc3RhbmNlSURdID0gZXhwZXJpZW5jZUpTT047CiAgICB9CgogICAgY29uc29sZS5sb2coYFtwcmludGFydGlmYWN0ZXhwZXJpZW5jZV0gQWxsIGN1cnJlbnQgYXJ0aWZhY3QgaW5zdGFuY2UgZXhwZXJpZW5jZSBzdGF0ZXM6YCwgYWxsRXhwZXJpZW5jZSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQcmludCBhbGwgY3VycmVudGx5IGxvYWRlZCBhcnRpZmFjdCBpbnN0YW5jZSBleHBlcmllbmNlIHN0YXRlcyB0byB0aGUgY29uc29sZS4nLAogICAgdXNhZ2U6IFsnLnByaW50YXJ0aWZhY3RleHBlcmllbmNlJ10KfSk7JwDDsse5AqzRBBhhYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgCBADDsse5AqHiB9wSQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgZXhwQXV0aFJlc3VsdDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhdXRob3JpemVkOiB1bmRlZmluZWQsCiAgICBmYWlsdXJlUmVhc29uOiB1bmRlZmluZWQsCn0KCmlmIChnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUpIHsKICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZDsKCiAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKfQoKbGV0IG15QXV0aEJvdCA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgppZiAoIW15QXV0aEJvdCkgewogICAgLy8gTm90IHNpZ25lZCBpbiwgbmVlZCB0byBzaWduIGluIHRvIHVzZSBhcnRpZmFjdCBleHBlcmllbmNlLgogICAgbGV0IGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UgPSBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2U7CgogICAgaWYgKCFhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlKSB7CiAgICAgICAgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgdGl0bGU6ICdTaWduIEluIFJlcXVpcmVkJywKICAgICAgICAgICAgY29udGVudDogJ1RoaXMgc2VydmVyIGhhcyBhcnRpZmFjdHMgdGhhdCB3b3JrIGJlc3Qgd2hlbiB5b3XigJlyZSBzaWduZWQgaW4uIElmIHlvdSBjb250aW51ZSB3aXRob3V0IHNpZ25pbmcgaW4sIHRoZSBhcnRpZmFjdHMgbWF5IG5vdCBzdGF5IGluIHN5bmMuJywKICAgICAgICAgICAgY29uZmlybVRleHQ6ICdTaWduIEluJywKICAgICAgICAgICAgY2FuY2VsVGV4dDogJ0NvbnRpbnVlIFdpdGhvdXQnCiAgICAgICAgfSk7CgogICAgICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2U7CiAgICB9CgogICAgY29uc3QgY29uZmlybWVkID0gYXdhaXQgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKICAgIGRlbGV0ZSBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmU7CgogICAgaWYgKGNvbmZpcm1lZCkgewogICAgICAgIG15QXV0aEJvdCA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICB9IGVsc2UgewogICAgICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX3NpZ25faW4nOwogICAgICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSA9IGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbjsKICAgICAgICAKICAgICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKICAgIH0KfQoKaWYgKCFteUF1dGhCb3QpIHsKICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3Vua25vd24nOwogICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlID0gZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uOwoKICAgIHJldHVybiBleHBBdXRoUmVzdWx0Owp9CgovLyBjb25zdCBhZG1pblBlcm1pc3Npb25SZXN1bHQgPSBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24obGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWUpOwovLyBjb25zb2xlLmxvZyhgYWRtaW5QZXJtaXNzaW9uUmVzdWx0OmAsIGFkbWluUGVybWlzc2lvblJlc3VsdCk7CgovLyBpZiAoYWRtaW5QZXJtaXNzaW9uUmVzdWx0LnN1Y2Nlc3MpIHsKLy8gICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IHRydWU7CgovLyAgICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Ci8vIH0gZWxzZSB7Ci8vICAgICBleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSBmYWxzZTsKLy8gICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX2luc3RfcGVybWlzc2lvbic7Ci8vICAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUgPSBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb247CgovLyAgICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Ci8vIH0KCmV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IHRydWU7CgpyZXR1cm4gZXhwQXV0aFJlc3VsdDsnAMOyx7kCrNEEEW9uQUJCZWZvcmVQdWJsaXNoAgQAw7LHuQL89AeHBEBpZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKLy8gW0lNUE9SVEFOVCBOT1RFXSAoU2VwdGVtYmVyIDQsIDIwMjUpOiBUaGlzIGlzIGEgd29ya2Fyb3VuZCB1bnRpbCB3ZSBoYXZlIGFiIGFydGlmYWN0IGV4cGVyaWVuY2Ugc3RhdGUgd29ya2luZy4gQXMgc29vbiBhcyBleHBlcmllbmNlIHN0YXRlIGhvb2tlZAovLyB1cCwgdGhpcyBwcm9jZXNzIHNob3VsZCBiZSBlbGltaW5hdGVkIGJlY2F1c2UgaXQgY2hhbmdlcyB0aGUgYXJ0aWZhY3QgaW5zdGFuY2UgaWQgd2hpY2ggaXMgbm90IGlkZWFsIC0gYnV0IGlzIHNlcnZpY2FibGUgdW50aWwKLy8gdGhlbiBmb3IgdGhlIG5lZWRzIHdlIGhhdmUgbm93LgoKLy8gTmFpdmVseSB1cGRhdGUgYWxsIGFydGlmYWN0IHNoYXJkcyBpbiB0aGlzIGluc3QgYmVmb3JlIGFiIHB1Ymxpc2hlcyBhbiBlZ2cuCmF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBbGxBcnRpZmFjdFNoYXJkcygpOycAw7LHuQKs0QQSb25BQkJlZm9yZURvd25sb2FkAgQAw7LHuQKE+QeHBEBpZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKLy8gW0lNUE9SVEFOVCBOT1RFXSAoU2VwdGVtYmVyIDQsIDIwMjUpOiBUaGlzIGlzIGEgd29ya2Fyb3VuZCB1bnRpbCB3ZSBoYXZlIGFiIGFydGlmYWN0IGV4cGVyaWVuY2Ugc3RhdGUgd29ya2luZy4gQXMgc29vbiBhcyBleHBlcmllbmNlIHN0YXRlIGhvb2tlZAovLyB1cCwgdGhpcyBwcm9jZXNzIHNob3VsZCBiZSBlbGltaW5hdGVkIGJlY2F1c2UgaXQgY2hhbmdlcyB0aGUgYXJ0aWZhY3QgaW5zdGFuY2UgaWQgd2hpY2ggaXMgbm90IGlkZWFsIC0gYnV0IGlzIHNlcnZpY2FibGUgdW50aWwKLy8gdGhlbiBmb3IgdGhlIG5lZWRzIHdlIGhhdmUgbm93LgoKLy8gTmFpdmVseSB1cGRhdGUgYWxsIGFydGlmYWN0IHNoYXJkcyBpbiB0aGlzIGluc3QgYmVmb3JlIGFiIHB1Ymxpc2hlcyBhbiBlZ2cuCmF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBbGxBcnRpZmFjdFNoYXJkcygpOycAw7LHuQKs0QQZYWJVcGRhdGVBbGxBcnRpZmFjdFNoYXJkcwIEAMOyx7kCjP0HvQRAY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwoKZm9yIChjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBhcnRpZmFjdEluc3RhbmNlcykgewogICAgY29uc3Qgc2hhcmRCb3QgPSBhcnRpZmFjdEluc3RhbmNlc1thYkFydGlmYWN0SW5zdGFuY2VJRF0uZmluZChiID0+IGIgIT0gbnVsbCk7CgogICAgaWYgKCFzaGFyZEJvdCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVuYWJsZSB0byB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSB0aGVyZSB3ZXJlIG5vIHNoYXJkIGJvdHMgZm91bmQuYCk7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgCiAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0nAMOyx7kCrNEEHG9uQUJQcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQCBADDsse5AsqBCOMCQGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmlmICh0aGF0LnNvdXJjZUV2ZW50ICE9PSAnZG93bmxvYWRfYXJ0aWZhY3RfcGF0dGVybicpIHsKICAgIHRoaXNCb3QuYWJQcmVwcm9jZXNzQm90RGF0YVRvQXJ0aWZhY3RQcm9taXNlcyh7IGJvdERhdGE6IHRoYXQuYm90RGF0YSB9KTsKfScAw7LHuQKs0QQlYWJQcmVwcm9jZXNzQm90RGF0YVRvQXJ0aWZhY3RQcm9taXNlcwIEAMOyx7kCroQIqg9ALyoqCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYm90RGF0YSAoZnJvbSBvbkFCUHJlcHJvY2Vzc0JlZm9yZSogY2FsbHMpIGFuZCByZXBsYWNlcyBhbnkgc2hhcmQgYm90cyB3aXRoIGFydGlmYWN0IHByb21pc2UgYm90cy4KICovCgpjb25zdCBib3REYXRhID0gdGhhdD8uYm90RGF0YTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXJ0aW5nIGJvdERhdGE6YCwgey4uLmJvdERhdGF9KTsKfQoKYXNzZXJ0KHR5cGVvZiBib3REYXRhID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3REYXRhIGlzIGEgcmVxdWlyZWQgb2JqZWN0LmApOwoKLy8gRGV0ZWN0IGFydGlmYWN0IGluc3RhbmNlcyB0aGF0IG5lZWQgdG8gYmUgY29udmVydGVkIGludG8gYXJ0aWZhY3QgcHJvbWlzZXMuCgovKioga2V5OiBhcnRpZmFjdCBpbnN0YW5jZSBpZCwgdmFsdWU6IGFydGlmYWN0IHByb21pc2UgZGF0YS4gKi8KY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZSA9IG5ldyBTZXQoKTsgLy8gS2VlcCB0cmFjayBvZiB3aGF0IGFydGlmYWN0IGluc3RhbmNlIElEcyBoYXZlIGhhZCBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUuCgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QuCiAgICAgICAgaWYgKCFhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmhhcyhkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgIC8vIFRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgbmVlZHMgYW4gYXJ0aWZhY3QgcHJvbWlzZSBtYWRlIGZvciBpdC4KICAgICAgICAgICAgY29uc3QgcHJvbWlzZUlkID0gdXVpZCgpOwoKICAgICAgICAgICAgYm90RGF0YVtwcm9taXNlSWRdID0gewogICAgICAgICAgICAgICAgaWQ6IHByb21pc2VJZCwKICAgICAgICAgICAgICAgIHNwYWNlOiAnc2hhcmVkJywKICAgICAgICAgICAgICAgIHRhZ3M6IHsKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdFByb21pc2U6IHRydWUsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvbnZlcnRlZCBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2RhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gaW50byBhbiBhcnRpZmFjdCBwcm9taXNlOmAsIGJvdERhdGFbcHJvbWlzZUlkXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGFydGlmYWN0SW5zdGFuY2VzV2l0aFByb21pc2UuYWRkKGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCk7CiAgICAgICAgfQoKICAgICAgICAvLyBSZW1vdmUgYXJ0aWZhY3QgaW5zdGFuY2Ugc2hhcmQgYm90IGZyb20gYm90RGF0YSB0aGF0IGlzIGFib3V0IHRvIGJlIHB1Ymxpc2hlZC4KICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5pc2hlZCBib3REYXRhOmAsIHsuLi5ib3REYXRhfSk7Cn0nAQRib3RzJDkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YwEnAMOyx7kC2ZMIDmFiRmlsZVRpbWVjb2RlAgQAw7LHuQLakwhmQGNvbnN0IGRhdGU6IERhdGVUaW1lID0gdGhhdD8uZGF0ZSA/PyBEYXRlVGltZS5ub3coKTsKcmV0dXJuIGRhdGUudG9VVEMoKS50b0Zvcm1hdCgneXl5eU1NZGQtSEhtbXNzJyk7JwDDsse5AtmTCAZzeXN0ZW0CBADDsse5AsGUCA5hYi5zaGVsbC51dGlscycAw7LHuQLZkwgMYWJDb21waWxlQ1NTAgQAw7LHuQLQlAiCBEBsZXQgYm90cyA9IHRoYXQ7Cgpib3RzID0gQXJyYXkuaXNBcnJheShib3RzKSA/IGJvdHMgOiBbYm90c107CgpsZXQgY3NzID0gW107Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgZm9yIChsZXQga2V5IGluIGJvdC50YWdzKSB7CiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCdjc3MnKSkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBDU1Mga2V5OiAke2tleX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3MucHVzaChib3QudGFnc1trZXldKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IGNvbXBpbGVkID0gY3NzLmpvaW4oJ1xuXG4nKTsKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY29tcGlsZWQgQ1NTOlxuXG5gLCBjb21waWxlZCk7Cn0KCnJldHVybiBjb21waWxlZDsnAMOyx7kC2ZMICGFiSWdub3JlAgQAw7LHuQLTmAgEdHJ1ZScAw7LHuQLZkwgHYWJTaGVsbAIEAMOyx7kC2JgIBHRydWUnAMOyx7kC2ZMICWFiVmVyc2lvbgIEAMOyx7kC3ZgIBTEwLjEwJwDDsse5AtmTCA1hYkxvZ0FuZFRvYXN0AgQAw7LHuQLjmAi4CkBsZXQgbWVzc2FnZTsKbGV0IGR1cmF0aW9uOwpsZXQgbG9nVHlwZSA9ICdsb2cnOwpsZXQgbmFtZSA9IGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eTsKbGV0IHRvYXN0ID0gdHJ1ZTsKbGV0IGFiTG9nID0gdHJ1ZTsKbGV0IGNvbnNvbGVMb2cgPSB0cnVlOwoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgbWVzc2FnZSA9IHRoYXQ7CiAgICBkdXJhdGlvbiA9IHRoaXNCb3QuZXN0aW1hdGVSZWFkaW5nVGltZSh7IHRleHQ6IHRoYXQsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDA7Cn0gZWxzZSB7CiAgICBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uID8/ICh0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0Lm1lc3NhZ2UsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDApOwogICAgbmFtZSA9IHRoYXQubmFtZSA/PyBuYW1lOwogICAgbG9nVHlwZSA9IHRoYXQubG9nVHlwZSA/PyBsb2dUeXBlOwogICAgdG9hc3QgPSB0aGF0LnRvYXN0ID8/IHRvYXN0OwogICAgYWJMb2cgPSB0aGF0LmFiTG9nID8/IGFiTG9nOwp9CgppZiAobG9nVHlwZSA9PT0gJ2xvZycpIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICd3YXJuaW5nJyB8fCBsb2dUeXBlID09PSAnd2FybicpIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiBXYXJuaW5nOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS53YXJuKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBXYXJuaW5nOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICdlcnJvcicpIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiBFcnJvcjogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUuZXJyb3IobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QoYEVycm9yOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgewogICAgaWYgKGFiTG9nKSBhYi5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmIChjb25zb2xlTG9nKSBjb25zb2xlLmxvZyhuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7Cn0nAMOyx7kC2ZMICHJlbWVtYmVyAgQAw7LHuQKcowgo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAw7LHuQLZkwgFYWJMb2cCBADDsse5AsOjCKUCQGlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgYWJMb2c6IHRydWUsCiAgICAgICAgY29uc29sZUxvZzogdHJ1ZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICBhYkxvZzogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nOiB0cnVlLAogICAgfSk7Cn0nAMOyx7kC2ZMIE2VzdGltYXRlUmVhZGluZ1RpbWUCBADDsse5AumlCNwDQGNvbnN0IHsKICAgIHRleHQgPSAnJywKICAgIHdvcmRzUGVyTWludXRlID0gMjUwLAogICAgZGVsYXlUaW1lID0gNTAwLAp9ID0gdGhhdDsKCi8vIENvdW50IHdvcmRzIChyb3VnaCBhcHByb3hpbWF0aW9uIGJ5IHNwbGl0dGluZyBvbiB3aGl0ZXNwYWNlKQpjb25zdCB3b3JkQ291bnQgPSB0ZXh0LnRyaW0oKS5zcGxpdCgvXHMrLykubGVuZ3RoOwpsZXQgdG90YWxUaW1lTXMgPSAwOwoKaWYgKHdvcmRDb3VudCA+IDApIHsKICAgIC8vIENhbGN1bGF0ZSByZWFkaW5nIHRpbWUgaW4gbWlsbGlzZWNvbmRzCiAgICBjb25zdCB3b3Jkc1BlclNlY29uZCA9IHdvcmRzUGVyTWludXRlIC8gNjA7CiAgICBjb25zdCByZWFkaW5nVGltZU1zID0gTWF0aC5jZWlsKCh3b3JkQ291bnQgLyB3b3Jkc1BlclNlY29uZCkgKiAxMDAwKTsKCiAgICB0b3RhbFRpbWVNcyA9IHJlYWRpbmdUaW1lTXMgKyBkZWxheVRpbWU7Cn0KCnJldHVybiB0b3RhbFRpbWVNczsnAMOyx7kC2ZMICGlzT2JqZWN0AgQAw7LHuQLGqQg5QHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkodGhhdCk7JwDDsse5AtmTCAdpc0FycmF5AgQAw7LHuQKAqggcQHJldHVybiBBcnJheS5pc0FycmF5KHRoYXQpOycAw7LHuQLZkwgIaXNTdHJpbmcCBADDsse5Ap2qCCFAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJzsnAMOyx7kC2ZMID2dldEVycm9yTWVzc2FnZQIEAMOyx7kCv6oIwAJAZnVuY3Rpb24gZ2V0RXJyb3JNZXNzYWdlKGVycm9yKSB7CiAgICBpZiAoZXJyb3IpIHsKICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlKSB7CiAgICAgICAgICAgIHJldHVybiBlcnJvci5tZXNzYWdlOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IuZXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yTWVzc2FnZShlcnJvci5lcnJvcik7CiAgICAgICAgfQogICAgfQp9CgpyZXR1cm4gZ2V0RXJyb3JNZXNzYWdlKHRoYXQpOycAw7LHuQLZkwgHYWJUb2FzdAIEAMOyx7kCgK0IpwJAaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIGFiTG9nOiBmYWxzZSwKICAgICAgICBjb25zb2xlTG9nOiBmYWxzZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIGFiTG9nOiBmYWxzZSwKICAgICAgICBjb25zb2xlTG9nOiBmYWxzZSwKICAgIH0pOwp9JwDDsse5AtmTCBhoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24CBADDsse5AqivCPwCQGxldCBoYXNQZXJtaXNzaW9uID0gZmFsc2U7Cgp0cnkgewogICAgaWYgKGdsb2JhbFRoaXMubmF2aWdhdG9yICYmIG5hdmlnYXRvci5wZXJtaXNzaW9ucykgewogICAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IG5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeSh7IG5hbWU6ICdnZW9sb2NhdGlvbicgfSk7CiAgICAgICAgaGFzUGVybWlzc2lvbiA9IHN0YXR1cz8uc3RhdGUgPT09ICdncmFudGVkJzsKICAgIH0KfSBjYXRjaCAoZSkgeyAKICAgIGNvbnNvbGUuZXJyb3IoYENhdWdodCBhbiBlcnJvciB3aWxsIHF1ZXJ5aW5nIHBlcm1pc3Npb25zLiBFcnJvcjpgLCBhYi5saW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSkpOwp9CgpyZXR1cm4gaGFzUGVybWlzc2lvbjsnAMOyx7kC2ZMIBWlzQm90AgQAw7LHuQKlsghUQHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcgJiYgdGhhdC50YWdzICYmIHRoYXQuaWQgJiYgdGhhdC5zcGFjZSAmJiB0aGF0LnZhcnM7JwEEYm90cyRkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUBJwDDsse5AvqyCAZzeXN0ZW0CBADDsse5AvuyCA9hYi5zaGVsbC5zZWFyY2gnAMOyx7kC+rIIBGZvcm0CBADDsse5AouzCAdub3RoaW5nJwDDsse5AvqyCA5hYlJldHJpZXZlRmlsZQIEAMOyx7kCk7MIggFALy9wdWxsIGRvd24gZmlsZSBkYXRhCmlmICghdGhhdC51cmwpCnsKICAgIHJldHVybiAibm8gZmlsZSB1cmwgc3VwcGxpZWQiOwp9CgpsZXQgZGF0YSA9IGF3YWl0IG9zLmdldEZpbGUodGhhdC51cmwpOwoKcmV0dXJuIGRhdGE7JwDDsse5AvqyCBBhYlJldHJpZXZlUmVjb3JkAgQAw7LHuQKWtAjsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwDDsse5AvqyCAhyZW1lbWJlcgIEAMOyx7kCg7kIKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMOyx7kC+rIIDW1hbmlmZXN0YXRpb24CBADDsse5Aqq5CCjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDDsse5AvqyCA5vbkxvb2t1cEFCRWdncwIEAMOyx7kC0bkIzzJAY29uc3QgeyAKICAgIGFiSUQsCiAgICBhYlZlcnNpb24sCiAgICBpbml0aWFsQm9vdCwKICAgIGF1dG9IYXRjaCwKICAgIHJldHVyblR5cGUsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5LAogICAgdG9hc3QgPSB0cnVlLAogICAgc2hvd0luZGljYXRvciA9IHRydWUsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsLiAob3B0aW9uYWwpCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBsb2FkaW5nICIgKyBhYklEKTsKCi8vY2xlYXIgYWItMQppZiAobGlua3MubWFuaWZlc3RhdGlvbiAmJiBjb25maWdCb3QudGFncy5tZW51UG9ydGFsID09ICJhYk1lbnUiKSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfQoKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvYWRpbmcgJHthYklEfWB9KTsKfQoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2V0UmVjb3JkOmAsIHsuLi5nZXRSZWNvcmR9KTsKfQoKbGV0IGVnZ0RhdGE7CgovL3RoaXMgbG9naWMgaGFuZGxlcyB0aGUgcmV0cmlldmVkIGRhdGEsIHNlYXJjaGVzIGFnYWluIGlmIG5vbmUgY2FtZSB0aHJvdWdoCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmIChwb3NzaWJsZUF1dGguaWQgPT0gcmVjb3JkS2V5ICYmCiAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSAmJgogICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJyZWNvcmRfbm90X2ZvdW5kIgogICAgKSB7CiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIikgewogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CiAgICB9IGVsc2UgaWYgKGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfbG9nZ2VkX2luIikgewogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgogICAgICAgIGlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MgJiYgCiAgICAgICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfYXV0aG9yaXplZCIKICAgICAgICApIHsKICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICAgICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgICAgICB9CiAgICB9Cn0KCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmICh0b2FzdCkgeyAKICAgICAgICBvcy50b2FzdChgbm8gZGF0YSBmb3VuZCBpbiAke2FiSUR9YCk7CiAgICB9CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICB9CgogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQplbHNlIHsKICAgIGNvbnN0IHB1YmxpY1JlYWRUZXN0ID0gZ2V0UmVjb3JkLm1hcmtlcnMuaW5kZXhPZigicHVibGljUmVhZCIpOwogICAgY29uc3QgYXV0aG9yID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCiAgICBpZiAocHVibGljUmVhZFRlc3QgIT0gLTEgJiYgYXV0aG9yKSB7CiAgICAgICAgaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGVnZ0hhdGNoRXZlbnQgPSBhYklEOwoKICAgICAgICAgICAgb3MucmVjb3JkRXZlbnQobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgZWdnSGF0Y2hFdmVudCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vcGFja2FnZSB0aGUgcmVjb3JkIGRhdGEKICAgIGVnZ0RhdGEgPSBnZXRSZWNvcmQuZGF0YTsKCiAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgLy8gQ2hhbmdlIGluaXRpYWwgdGFyZ2V0IHZlcnNpb24gb2YgdGhlIGVnZyBpZiBhYlZlcnNpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gYWJWZXJzaW9uOwogICAgfQp9CgpsaW5rcy51dGlscy5hYkxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgYWJJRCArICIgbG9hZGVkLCB2ZXJzaW9uICIgKyBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgZ2V0UmVjb3JkLmRhdGEubWF4VmVyc2lvbik7CgppZiAocmV0dXJuVHlwZSAhPSBudWxsKSB7CiAgICBpZiAoZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGxldCB2ZXJzaW9uID0gZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiAtIDE7CgogICAgICAgICAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKGFiVmVyc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gYWJWZXJzaW9uIC0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgICAgICAgICBjb25zdCByZXR1cm5EYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShlZ2dEYXRhVVJMKTsKCiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0dXJuRGF0YTsKICAgICAgICB9IGVsc2UgaWYgKHJldHVyblR5cGUgPT09ICJlZ2ciKSB7CiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKGVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkpOwogICAgICAgICAgICBjb25zdCBmaWxlVVVJRCA9IHZlcnNpb25BcnJheVtlZ2dEYXRhLm1heFZlcnNpb24gLSAxXTsKICAgICAgICAgICAgY29uc3QgZmlsZW5hbWVoYXNoTFRNID0gY3J5cHRvLnNoYTI1NihmaWxlVVVJRCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGV1cmxoYXNoTFRNID0gImF1eF8iICsgZmlsZW5hbWVoYXNoTFRNICsgJy5hdXgnOwogICAgICAgICAgICBjb25zdCB0YXJnZXRMVE1VUkwgPSAiaHR0cHM6Ly9idWlsZGVyLWx0bS1maWxlcy5zMy5hbWF6b25hd3MuY29tLyIgKyBmaWxldXJsaGFzaExUTTsKICAgICAgICAgICAgY29uc3QgbyA9IHsKICAgICAgICAgICAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgICAgICAgICAgICB1cmw6IHRhcmdldExUTVVSTAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbGV0IGZpbGVHZXQgPSBhd2FpdCB3ZWJob29rKG8pOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5tYW5pZmVzdE92byh7CiAgICBhYklELAogICAgc3R1ZGlvOiByZWNvcmRLZXksCiAgICBkaW1Nb2QsCiAgICBzcGFjZU1vZCwKICAgIGVnZ0RhdGEsCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwKfSk7CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBoYXRjaGVkQm90czogbWFuaWZlc3RSZXN1bHQ/LmhhdGNoZWRCb3RzLAp9OycAw7LHuQL6sggLbWFuaWZlc3RPdm8CBADDsse5AqHsCNQPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCAmJiAhY29uZmlnQm90LnRhZ3MuYWJTdGF5QXdha2UpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgppZiAobGlua3Mub3ZvQm90KSB7CiAgICBkZXN0cm95KGxpbmtzLm92b0JvdCk7Cn0KCmxldCBlZ2dNb2QgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBpbml0aWFsVGltZXI6IHRydWUsCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgc291cmNlRXZlbnQsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaW50ZXJhY3RPdm8oKTsKICAgIGAsCiAgICBmb3JtOiAiZWdnIiwKICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VMYWJlbENvbG9yLAogICAgcHJvZ3Jlc3NCYXJDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvciwKICAgIHByb2dyZXNzQmFyQmFja2dyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxTaXplOiAwLjUsCiAgICBvblBvaW50ZXJFbnRlcjogYEAKICAgICAgICBtYXNrcy50aXBJZCA9IGF3YWl0IG9zLnRpcCh0YWdzLmFiSUQgKyAnIHYnICsgdGFncy50YXJnZXRWZXJzaW9uKTsKICAgIGAsCiAgICBvblBvaW50ZXJFeGl0OiBgQAogICAgICAgIGlmIChtYXNrcy50aXBJZCkgewogICAgICAgICAgICBvcy5oaWRlVGlwcyhtYXNrcy50aXBJZCk7CiAgICAgICAgfQogICAgYCwKICAgIGxhYmVsUG9zaXRpb246ICJmcm9udCIsCiAgICBvcmllbnRhdGlvbk1vZGU6ICJiaWxsYm9hcmRGcm9udCIsCiAgICBvbkRlc3Ryb3k6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5tYXNrcy5vdm9Cb3QgPSBudWxsOwogICAgYCwKICAgIGVnZ1RpbWVyOiBgQAogICAgICAgIGlmICh0YWdzLnByb2dyZXNzQmFyIDwgMSkgewogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyICs9IDAuMTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge3doaXNwZXIodGhpc0JvdCwgImVnZ1RpbWVyIik7fSwgNzUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNCb3Qub25DbGljaygpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciA9IG51bGw7CiAgICAgICAgfQogICAgYAp9OwoKCmNvbnN0IG92byA9IGF3YWl0IGNyZWF0ZShlZ2dEYXRhLCBlZ2dNb2QsIGRpbU1vZCwgc3BhY2VNb2QpOwptYXNrcy5vdm9Cb3QgPSBnZXRMaW5rKG92byk7CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBvdm8udmFycy5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGUgPSBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU7Cn0KCmlmIChvdm8udGFncy5hdXRvSGF0Y2gpIHsKICAgIGNvbnN0IGhhdGNoZWRCb3RzID0gYXdhaXQgdGhpc0JvdC5oYXRjaE92byhvdm8pOwogICAgcmV0dXJuIHsgaGF0Y2hlZEJvdHMgfTsKfQplbHNlIHsKICAgIG92by50YWdzLnByb2dyZXNzQmFyID0gMDsKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBvdm8udGFncy5tYXhWZXJzaW9uOwogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9JwDDsse5AvqyCAlvbktleURvd24CBADDsse5Avb7CIIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAMOyx7kC+rIICGhhdGNoT3ZvAgQAw7LHuQL3gQmdFUAvL2xvZ2ljIGZvciBoYXRjaGluZyBvZiBhbiBhYgpzaG91dCgnb3ZvTWVudVJlc2V0Jyk7CgovL2RhdGEgaW4gcmVnYXJkcyB0byB3aGF0IGFiIGlzIGdvaW5nIHRvIGJlIGhhdGNoZWQKY29uc3Qgb3ZvID0gdGhhdDsKCi8vaGF0Y2ggc3BlY2lmaWMgdmFyaWFibGVzCmxldCBpbml0aWFsQm9vdCA9IG92by50YWdzLmluaXRpYWxCb290OwpsZXQgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLnN0YWJsZVZlcnNpb24gPz8gb3ZvLnRhZ3MudGFyZ2V0VmVyc2lvbjsKCmlmICgoY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uIHx8IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uKSAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIpKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uOwp9CgovL3RhcmdldGVkIHZlcnNpb25zCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYiB8fCAhaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpKQp7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiZmVlZGJhY2siKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5mZWVkYmFja1ZlcnNpb247CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJjdXJyZW50IikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgfQogICAgZWxzZSBpZiAoIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy52ZXJzaW9uCiAgICB9CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG51bGw7Cn0KCmlmIChpc05hTih0YXJnZXRWZXJzaW9uKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKfQoKbGV0IHZlcnNpb25BcnJheSA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5OwpsZXQgZmlsZVVSTCA9IHZlcnNpb25BcnJheVt0YXJnZXRWZXJzaW9uIC0gMV07CmxldCBrZXkgPSBvdm8udGFncy5rZXkgPyBvdm8udGFncy5rZXkgOiBjb25maWdCb3QudGFncy5rZXk7CmxldCBmaWxlR2V0OwoKLy9hY3R1YWwgZmlsZSByZXRyaWV2YWwKdHJ5CnsKICAgIGZpbGVHZXQgPSBhd2FpdCBvcy5nZXRGaWxlKGZpbGVVUkwpOwp9CmNhdGNoIChlKQp7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnbm8gZmlsZSBmb3VuZCcpOwoKICAgIHJldHVybjsKfQoKLy9oYW5kbGluZyBmb3IgZW5jcnlwdGVkIGFiIGZpbGUKaWYgKGNyeXB0by5pc0VuY3J5cHRlZChmaWxlR2V0KSkKewogICAgaWYgKCFrZXkpCiAgICB7CiAgICAgICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCcnLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ0VudGVyIGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBmaWxlR2V0ID0gY3J5cHRvLmRlY3J5cHQoa2V5LCBmaWxlR2V0KTsKCiAgICBpZiAoZmlsZUdldCA9PSBudWxsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnaW5jb3JyZWN0IGtleScpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgCiAgICBmaWxlR2V0ID0gSlNPTi5wYXJzZShmaWxlR2V0KTsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CmVsc2UKewogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KCi8vY2xlYW4gdXAKZGVzdHJveShvdm8pOwoKLy90b2FzdCBpZiBub3Qgb24gc3RhYmxlCmlmKG92by50YWdzLnN0YWJsZVZlcnNpb24gIT0gdGFyZ2V0VmVyc2lvbiAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnQpCnsKICAgIGlmIChvdm8udGFncy5mZWVkYmFja1ZlcnNpb24gPT0gdGFyZ2V0VmVyc2lvbikKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCBmZWVkYmFjayB2ZXJzaW9uIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCB2ZXJzaW9uICIgKyB0YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoICsgIiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9Cn0KCi8vZ2VuZXJhdGUgYm90cyBiYXNlZCBvbiB0aGUgZmlsZSByZXRyaWV2ZWQgKkhFUkUqCmNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsKICAgIGJvdHM6IGZpbGVHZXQsCiAgICBvcmlnaW46IG92by50YWdzLmFiSUQsCiAgICBzdHVkaW86IG92by50YWdzLnN0dWRpbywKICAgIHZlcnNpb246IHRhcmdldFZlcnNpb24sCiAgICBpbml0aWFsQm9vdDogaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzOiBvdm8udGFncy5lZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBvdm8udmFycy5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudDogb3ZvLnRhZ3Muc291cmNlRXZlbnQsCn0pOwoKcmV0dXJuIG5ld0JvdHM7JwDDsse5AvqyCAtpbnRlcmFjdE92bwIEAMOyx7kClZcJ6QZALy9tYW51YWwgaGF0Y2ggbWVudQpjb25zdCBvdm9Cb3QgPSB0aGF0ID8gdGhhdCA6IGxpbmtzLm92b0JvdDsKCmlmICghb3ZvQm90KSB7CiAgICByZXR1cm47Cn0KCnNob3V0KCJvdm9NZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiT3ZvTWVudSI7CgptYXNrcy5vbkdyaWRDbGljayA9IGBACiAgICBzaG91dCgib3ZvTWVudVJlc2V0Iik7CmA7Cm1hc2tzLm92b01lbnVSZXNldCA9IGBACiAgICBtYXNrcy5vbkdyaWRDbGljayA9IG51bGw7CiAgICBtYXNrcy5vdm9NZW51UmVzZXQgPSBudWxsOwoKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKYDsKCm9zLnR3ZWVuVG8ob3ZvQm90LCAxNSw0NSw0NSwgNSk7Cgpjb25zdCBlZ2dNZW51QnV0dG9uID0gewogICAgYWJPdm9NZW51OiB0cnVlLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG92b0JvdDogZ2V0TGluayhvdm9Cb3QpLAogICAgY29sb3I6IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHRhcmdldFZlcnNpb246IG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sCiAgICBsYWJlbDogYGhhdGNoICR7b3ZvQm90LnRhZ3MuYWJJRH0gdiR7b3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbn0gb2YgJHtvdm9Cb3QudGFncy5tYXhWZXJzaW9ufWAsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBvdm9NZW51UmVzZXQ6IGBACiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIGAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaGF0Y2hPdm8obGlua3Mub3ZvQm90KTsKICAgIGAsCn07CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihlZ2dNZW51QnV0dG9uKTsnAMOyx7kC+rIIBmNyZWF0ZQIEAMOyx7kC/50JKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAMOyx7kC+rIIEGNoYW5nZU92b1ZlcnNpb24CBADDsse5AqaeCfACQC8vbG9naWMgZm9yIHZlcnNpb24gY2hhbmdpbmcgd2hlbiBtYW51YWxseSBoYXRjaGluZyBhbiBhYgpjb25zdCBvdm9Cb3QgPSBsaW5rcy5vdm9Cb3Q7CgpsZXQgbmV3VmVyc2lvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uLCB7CiAgICBwbGFjZWhvbGRlcjogImVudGVyIGEgdmVyc2lvbiBmcm9tIDEgdG8gIiArIG92b0JvdC50YWdzLm1heFZlcnNpb24KfSk7Cgpvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uID0gbmV3VmVyc2lvbjsKb3ZvQm90LnRhZ3MubGFiZWwgPSAndicrIG5ld1ZlcnNpb247Cgpjb25maWdCb3QudGFncy52ZXJzaW9uID0gbmV3VmVyc2lvbjsKCnNob3V0KCJvdm9NZW51UmVzZXQiKTsnAMOyx7kC+rIIBG1lbnUCBADDsse5ApehCSjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDDsse5AvqyCAhhYklnbm9yZQIEAMOyx7kCvqEJBHRydWUnAMOyx7kC+rIIB2FiU2hlbGwCBADDsse5AsOhCQR0cnVlJwDDsse5AvqyCAxhYjFMVE1TZWFyY2gCBADDsse5AsihCTNALy9zdXBwb3J0IG9sZCBzeW50YXgKdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsnAMOyx7kC+rIIDW9uTG9va3VwQXNrSUQCBADDsse5AvyhCYEaQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IHNob3dJbmRpY2F0b3IgPSB0aGF0Py5zaG93SW5kaWNhdG9yID8/IHRydWU7CmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOwpjb25zdCBlZ2dQYXJhbWV0ZXJzID0gdGhhdD8uZWdnUGFyYW1ldGVyczsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwpjb25zdCBpZ25vcmVSZXNlcnZlZCA9IHRoYXQ/Lmlnbm9yZVJlc2VydmVkOwoKYXNzZXJ0KHR5cGVvZiBhc2tJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmlmIChzaG93SW5kaWNhdG9yKSB7CiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQoKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgbG9va2luZyB1cCAke2Fza0lEfWAgfSk7Cn0KCi8vQ2hlY2sgZm9yIHJlc2VydmVkIGtleXdvcmRzCmlmIChsaW5rcz8ubGVhcm4/LnRhZ3M/LnJlc2VydmVkQXNrcz8uaW5jbHVkZXMoYXNrSUQpICYmICFpZ25vcmVSZXNlcnZlZCAmJiBhdXRoQm90KSB7CiAgICBpZiAoIWdldEJvdCgiYWJJRE9yaWdpbiIsIGFza0lEKSkgewogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IHRoaXNCb3QubG9va3VwRnJvbVN0dWRpbyh7Li4udGhhdCwgcmVzZXJ2ZWQ6IHRydWV9KTsKICAgICAgICBpZiAobG9va3VwQXNrICYmIGxvb2t1cEFzay5zdWNjZXNzID09IHRydWUpIHsKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IExvYWRpbmcgYXNrIGZyb20gc3R1ZGlvIGJlZm9yZSBjYXRhbG9nIiwgbG9va3VwQXNrKTsKICAgICAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsKICAgICAgICB9CiAgICB9Cn0KCi8vIEZpcnN0IGNoZWNrIHRoZSBjYXN1YWwgY2F0YWxvZyBmb3IgdGhlIGFzay4KY29uc3QgY2FzdWFsQ2F0YWxvZ1VSTCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYXNrcy8ke2Fza0lEfS5hdXhgKTsKCnRyeSB7CiAgICBjb25zdCBjYXN1YWxDYXRhbG9nUmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogJ0dFVCcsIHVybDogY2FzdWFsQ2F0YWxvZ1VSTCB9KTsKCiAgICBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDEgJiYgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUpIHsKICAgICAgICAgICAgLy8gQ2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UgaXMgYSB2MSBhdXggZmlsZS4KICAgICAgICAgICAgY29uc3QgbmV3Qm90cyA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3RzOiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS5zdGF0ZSwgaWdub3JlR3JpZEZvY3VzOiB0cnVlLCBvcmlnaW46IGFza0lELCBlZ2dQYXJhbWV0ZXJzLCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIHNvdXJjZUV2ZW50IH0pOwoKICAgICAgICAgICAgbG9va3VwQXNrID0gewogICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJywKICAgICAgICAgICAgICAgIGhhdGNoZWRCb3RzOiBuZXdCb3RzLAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAyICYmIGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnVwZGF0ZXMpIHsKICAgICAgICAgICAgLy8gQ2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UgaXMgYSB2MiBhdXggZmlsZS4KICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBc2tzIG9ubHkgc3VwcG9ydCB2MSBhdXggZmlsZSBmb3JtYXQuYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwoKICAgICAgICAgICAgbG9va3VwQXNrID0gewogICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFVucmVjb2duaXplZCBjYXN1YWwgY2F0YWxvZyByZXNwb25zZS4KICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVucmVjb2duaXplZCBjYXN1YWwgY2F0YWxvZyBhc2sgcmVzcG9uc2UuYCwgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlKTsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgYXNrIHJlc3BvbnNlLiBDaGVjayBjb25zb2xlIGZvciBtb3JlIGRldGFpbHMuYCwgbG9nVHlwZTogJ2Vycm9yJ30pOwoKICAgICAgICAgICAgbG9va3VwQXNrID0gewogICAgICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsKICAgIH0KfSBjYXRjaCAoZSkgewogICAgLy8gRGlkIG5vdCBmaW5kIGluIHRoZSBjYXN1YWwgY2F0YWxvZy4KfQoKbG9va3VwQXNrID0gYXdhaXQgdGhpc0JvdC5sb29rdXBGcm9tU3R1ZGlvKHRoYXQpOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwRnJvbVN0dWRpbyByZXN1bHQ6YCwgey4uLmxvb2t1cEFza30pOwp9CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIGxvb2t1cEFzazsnAMOyx7kC+rIIBXR5cGVzAgQAw7LHuQL+uwn2AfCfk4R0eXBlIEFCQXNrSURPcmlnaW4gPSAnY2FzdWFsX2NhdGFsb2cnIHwgJ2FiX3JlY29yZCc7CgppbnRlcmZhY2UgQUJMb29rdXBBc2tJRFJlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuOwogICAgb3JpZ2luOiBBQkFza0lET3JpZ2luOwogICAgaGF0Y2hlZEJvdHM/OiBCb3RbXTsKfQoKaW50ZXJmYWNlIEFCTG9va3VwRWdnUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW4sCiAgICBoYXRjaGVkQm90cz86IEJvdFtdLAp9CicAw7LHuQL6sggFaW5wdXQCBADDsse5AvO9CSjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDDsse5AvqyCAVoYXRjaAIEAMOyx7kCmr4JwAFALy9zaG91dCgiaGF0Y2giLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGtleToga2V5LCBhdXRvSGF0Y2g6IGJvb2xlYW4sIHJldHVyblR5cGU6IGRhdGEvbnVsbCwgZWdnUGFyYW1ldGVyczogYXJnfSk7Cgpjb25zdCBsb29rVXAgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOwoKcmV0dXJuIGxvb2tVcDsnAMOyx7kC+rIICWFiVmVyc2lvbgIEAMOyx7kC278JBTEwLjEwJwDDsse5AvqyCAVsZWFybgIEAMOyx7kC4b8JKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAMOyx7kC+rIIBXV0aWxzAgQAw7LHuQKIwAko8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAw7LHuQL6sggLcGVyc29uYWxpdHkCBADDsse5Aq/ACSjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDDsse5AvqyCBBsb29rdXBGcm9tU3R1ZGlvAgQAw7LHuQLWwAneJUBjb25zdCBhc2tJRCA9IHRoYXQ/LmFza0lEOw0KY29uc3QgYXV0b0hhdGNoID0gdGhhdD8uYXV0b0hhdGNoID8/IHRydWU7DQpjb25zdCBlZ2dQYXJhbWV0ZXJzID0gdGhhdD8uZWdnUGFyYW1ldGVyczsNCmNvbnN0IHNvdXJjZUV2ZW50ID0gdGhhdD8uc291cmNlRXZlbnQ7DQpjb25zdCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUgPSB0aGF0Py5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGU7DQpjb25zdCByZXNlcnZlZCA9IHRoYXQ/LnJlc2VydmVkOw0KY29uc3QgaXNDaGFubmVsID0gdGhhdD8uaXNDaGFubmVsOw0KY29uc3QgZGF0YU9ubHkgPSB0aGF0Py5kYXRhT25seSA/PyBmYWxzZTsNCg0KbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsNCmxldCB1c2VkU3R1ZGlvOw0KDQppZiAodGFncy5kZWJ1Zykgew0KICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOw0KfQ0KDQovLyBDaGVjayB0aGUgYWIgcmVjb3JkIGZvciB0aGUgYXNrLg0KY29uc3QgYWJGb3JtYXR0ZWRBc2tJRCA9IGFza0lELnJlcGxhY2VBbGwoIi0iLCAiIik7DQoNCmlmICh0YWdzLmRlYnVnKSB7DQogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkZvcm1hdHRlZEFza0lEOmAsIGFiRm9ybWF0dGVkQXNrSUQpOw0KfQ0KDQppZiAocmVzZXJ2ZWQpIHsNCiAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvKSB7DQogICAgICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8gIT0gYXV0aEJvdC5pZCkgew0KICAgICAgICAgICAgY29uc3QgcGVybXMgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsNCiAgICAgICAgICAgIGlmIChwZXJtcy5zdWNjZXNzKSB7DQogICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSBwZXJtcy5zdHVkaW9zLmZpbmQoKHN0dWQpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChzdHVkLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IFVzZXIgcGVybWlzc2lvbnMgZm9yIHN0dWRpbyIsIGZvdW5kLCBwZXJtcyk7DQogICAgICAgICAgICAgICAgaWYgKCFmb3VuZCkgew0KICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogVXNlciBkb2VzIG5vdCBoYXZlIHBlcm1pc3Npb25zIGZvciB0aGlzIHN0dWRpby4iKQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9va3VwQXNrOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICB1c2VkU3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvOw0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbywgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihjb25maWdCb3QudGFncy5zdHVkaW8pOw0KICAgICAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8sIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYgKCFsb29rdXBBc2suc3VjY2Vzcykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBmYWlsdXJlIGxvb2tpbmcgdXAgYXNrIGluIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IExvb2tlZCB1cCBhc2sgaW4gc3R1ZGlvIiwgey4uLmxvb2t1cEFza30pOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgICAgdXNlZFN0dWRpbyA9IGF1dGhCb3Q/LmlkOw0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3Q/LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgaWYgKCFsb29rdXBBc2suc3VjY2VzcyAmJiBsb29rdXBBc2suZXJyb3JDb2RlICYmIGxvb2t1cEFzay5lcnJvckNvZGUgPT0gJ25vdF9hdXRob3JpemVkJykgew0KICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGF1dGhCb3Q/LmlkKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdD8uaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYgKCFsb29rdXBBc2suc3VjY2Vzcykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBmYWlsdXJlIGxvb2tpbmcgdXAgYXNrIGluIHVzZXIgc3R1ZGlvIiwgey4uLmxvb2t1cEFza30pOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogTG9va2VkIHVwIGFzayBpbiB1c2VyIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0NCn0gZWxzZSB7DQogICAgdXNlZFN0dWRpbyA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7DQogICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBgYXNrXyR7YWJGb3JtYXR0ZWRBc2tJRH1gLCBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQpOw0KICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMTpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgfQ0KICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MpIHsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYkZvcm1hdHRlZEFza0lELCBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQpOw0KICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2sgYXR0ZW1wdCAyOmAsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgfQ0KICAgIH0NCg0KICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MgJiYgaXNDaGFubmVsKSB7DQogICAgICAgIHVzZWRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZDsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFzayBhdHRlbXB0IDMgKGlzQ2hhbm5lbCk6YCwgey4uLmxvb2t1cEFza30pOw0KICAgICAgICB9DQogICAgICAgIGlmKGxvb2t1cEFzay5lcnJvckNvZGUgJiYgbG9va3VwQXNrLmVycm9yQ29kZSA9PSAnbm90X2F1dGhvcml6ZWQnKSB7DQogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQpOw0KICAgICAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIH0NCiAgICB9DQp9DQoNCmxvb2t1cEFzay5vcmlnaW4gPSAnYWJfcmVjb3JkJzsNCg0KaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmIChsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQgfHwgcmVzZXJ2ZWQgfHwgaXNDaGFubmVsKSkgew0KICAgIGlmIChkYXRhT25seSkgew0KICAgICAgICByZXR1cm4gbG9va3VwQXNrOw0KICAgIH0gZWxzZSB7DQogICAgICAgIC8vIExvb2t1cCB0aGUgZWdnIHVzaW5nIHRoZSBzdHVkaW9JRCBhbmQgcGF0dGVybklEIGZyb20gdGhlIGFiX3JlY29yZCBhc2suDQogICAgICAgIGNvbnN0IGxvb2t1cEVnZzogQUJMb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogKHJlc2VydmVkIHx8IGlzQ2hhbm5lbCkgPyBhYkZvcm1hdHRlZEFza0lEIDogbG9va3VwQXNrLmRhdGEucGF0dGVybklELCByZWNvcmRLZXk6IGxvb2t1cEFzay5kYXRhLnN0dWRpb0lEID8/IHVzZWRTdHVkaW8sIGF1dG9IYXRjaCwgZWdnUGFyYW1ldGVycywgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCBzb3VyY2VFdmVudCB9KTsNCiAgICAgICAgDQogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7DQogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEVnZzpgLCB7Li4ubG9va3VwRWdnfSk7DQogICAgICAgIH0NCg0KICAgICAgICBsb29rdXBBc2suc3VjY2VzcyA9IGxvb2t1cEVnZy5zdWNjZXNzOw0KICAgICAgICBsb29rdXBBc2suaGF0Y2hlZEJvdHMgPSBsb29rdXBFZ2cuaGF0Y2hlZEJvdHM7DQogICAgfQ0KfSBlbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiAhbG9va3VwQXNrLmRhdGEucGF0dGVybklEICYmICFsb29rdXBBc2suZGF0YS51cmwpIHsNCiAgICBsb29rdXBBc2suc3VjY2VzcyA9IGZhbHNlOw0KfQ0KDQpyZXR1cm4gbG9va3VwQXNrOycAw7LHuQL6sggFZGVidWcCBADDsse5ArXmCQR0cnVlJwDDsse5AvqyCBphYkNhc3VhbENhdGFsb2dBc2tJREV4aXN0cwIEAMOyx7kCuuYJuwhAY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsKY29uc3QgdXJsID0gbGlua3MubGVhcm4uYWJCdWlsZENhc3VhbENhdGFsb2dVUkwoYC9hc2tzLyR7YXNrSUR9LmF1eGApOwoKbGV0IGV4aXN0czsKbGV0IHJlc3BvbnNlOwoKdHJ5IHsKICAgIHJlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soewogICAgICAgIG1ldGhvZDogJ0dFVCcsIC8vIFNlcHRlbWJlciAyNSwgMjAyNTogVGhpcyBuZWVkcyB0byBiZSBHRVQgdW50aWwgY2FzdWFsIGNhdGFsb2cgc3VwcHBvcnRzIEhFQUQgcmVxdWVzdHMgcHJvcGVybHkuIEhFQUQgd2lsbCBmYWlsIG9uIGZpbGVzIHRoYXQgZXhpc3QsIGFuZCB0aGUgb25seSB3YXkgdG8ga25vdyByaWdodCBub3cgaXMgdG8gR0VUIHRoZW0uCiAgICAgICAgdXJsLAogICAgfSkKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVzcG9uc2U6YCwgcmVzcG9uc2UpOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICAvLyBDYWxsIHRvIGNhc3VhbCBjYXRhbG9nIGhhcyBmYWlsZWQsIHRoZSBhc2sgaWQgZG9lcyBub3QgZXhpc3QgdGhlcmUuCiAgICAvLyBOT1RFOiBJdCB3b3VsZCBiZSBuaWNlIGlmIHRoZSBDYXN1YWwgQ2F0YWxvZyBlbmRwb2ludCByZXR1cm5lZCBhIDQwNCBOb3QgRm91bmQgc3RhdHVzIGNvZGUganVzdCBzbyB3ZSBjYW4gcnVsZSBvdXQgYWN0dWFsIHNlcnZlciBlcnJvcnMuCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYXVnaHQgYW4gZXJyb3I6YCwgZSk7CiAgICB9CgogICAgZXhpc3RzID0gZmFsc2U7Cn0KCmlmIChyZXNwb25zZSAmJiByZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgZXhpc3RzID0gdHJ1ZTsKfSBlbHNlIHsKICAgIGV4aXN0cyA9IGZhbHNlOwp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhc2tJRCAnJHthc2tJRH0nIGV4aXN0cyBpbiBjYXN1YWwgY2F0YWxvZz9gLCBleGlzdHMpOwp9CgpyZXR1cm4gZXhpc3RzOwonAQRib3RzJGY4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMAEnAMOyx7kC9u4JBnN5c3RlbQIEAMOyx7kC9+4JDmFiLnNoZWxsLmlucHV0JwDDsse5AvbuCQRmb3JtAgQAw7LHuQKG7wkHbm90aGluZycAw7LHuQL27gkJb25LZXlEb3duAgQAw7LHuQKO7wn6CkBjb25zdCB7IGtleXMgfSA9IHRoYXQ7CgppZiAobWFza3MuY2hhdE9wZW4pIHsKICAgIGNvbnN0IGVzYyA9IHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJyk7CgogICAgaWYgKGVzYykgewogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYXJyb3dVcCA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dVcCcpOwogICAgICAgIGNvbnN0IGFycm93RG93biA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dEb3duJyk7CiAgICAgICAgCiAgICAgICAgaWYgKGFycm93VXAgfHwgYXJyb3dEb3duKSB7CiAgICAgICAgICAgIC8vIElmIEFycm93VXAgb3IgQXJyb3dEb3duIGFyZSBwcmVzc2VkIHdoaWxlIHRoZSBhYiBjaGF0IGJhciBpcyBvcGVuIHRoZW4KICAgICAgICAgICAgLy8gc3RhcnQgY29tYmluZyB0aHJvdWdoIGNoYXQgaGlzdG9yeS4KICAgICAgICAgICAgY29uc3QgZGlyID0gYXJyb3dVcCA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ICsgZGlyOwogICAgICAgICAgICBsZXQgaGlzdG9yaWNhbFRleHQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBoaXN0b3JpY2FsVGV4dCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeVtpbmRleF07CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPj0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgY2hhdCBiYXIuCiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKHsgcHJlZmlsbDogaGlzdG9yaWNhbFRleHQgfSk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgY29uc3QgYmFja3RpY2sgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ2AnKSB8fCB0aGF0LmtleXMuaW5jbHVkZXMoIkRlYWQiKTsKCiAgICBpZiAoYmFja3RpY2spIHsKICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgIH0KfQonAMOyx7kC9u4JBm9uQ2hhdAIEAMOyx7kCifoJihhALy8gTm90IHN1cHBvcnRlZCBvdXRzaWRlIG9mIGJ1aWxkZXIgdmVyc2lvbgppZiAoIWJ1aWxkZXJWZXJzaW9uKSB7CiAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICByZXR1cm47Cn0KCmlmICghdGhhdC5tZXNzYWdlKSB7CiAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICByZXR1cm47Cn0KCi8vIEFwcGVuZCBtZXNzYWdlIHRvIGNoYXQgaGlzdG9yeSBhbmQgdXBkYXRlIHRoZSBjdXJyZW50IGhpc3RvcnkgaW5kZXguCnRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5wdXNoKHRoYXQubWVzc2FnZSk7CnRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwoKLy8gRnVuY3Rpb24gdG8gcGFyc2UgYXJndW1lbnRzIHdpdGggcXVvdGUgc3VwcG9ydCBhbmQgZXJyb3IgaGFuZGxpbmcKLy8gRXhhbXBsZXM6IAovLyAgICdhcmcxIGFyZzInIC0+IFsnYXJnMScsICdhcmcyJ10KLy8gICAnImFyZyB3aXRoIHNwYWNlcyIgYXJnMicgLT4gWydhcmcgd2l0aCBzcGFjZXMnLCAnYXJnMiddCi8vICAgJyJ1bmNsb3NlZCBxdW90ZScgLT4gdGhyb3dzIEVycm9yCmZ1bmN0aW9uIHBhcnNlQXJndW1lbnRzKGlucHV0KSB7CiAgICBjb25zdCBhcmdzID0gW107CiAgICBsZXQgY3VycmVudEFyZyA9ICcnOwogICAgbGV0IGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICBsZXQgcXVvdGVTdGFydFBvcyA9IC0xOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgY2hhciA9IGlucHV0W2ldOwogICAgICAgIAogICAgICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgaWYgKGNoYXIgPT09IGluc2lkZVF1b3RlcykgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gbnVsbDsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAnXFwnICYmIGkgKyAxIDwgaW5wdXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpKys7IC8vIFNraXAgdGhlIGJhY2tzbGFzaAogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBpbnB1dFtpXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gY2hhcjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgICAgICBpbnNpZGVRdW90ZXMgPSBjaGFyOwogICAgICAgICAgICAgICAgcXVvdGVTdGFydFBvcyA9IGk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJyAnKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEFyZy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGN1cnJlbnRBcmcpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgPSAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gY2hhcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKGluc2lkZVF1b3RlcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5jbG9zZWQgcXVvdGU6IGZvdW5kIG9wZW5pbmcgJHtpbnNpZGVRdW90ZXN9IGF0IHBvc2l0aW9uICR7cXVvdGVTdGFydFBvc30gYnV0IG5vIGNsb3NpbmcgcXVvdGVgKTsKICAgIH0KICAgIAogICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgIH0KICAgIAogICAgcmV0dXJuIGFyZ3M7Cn0KCmlmICh0aGF0Lm1lc3NhZ2VbMF0gPT0gIi4iKSB7CiAgICBjb25zdCBjb21tYW5kUGFydCA9IHRoYXQubWVzc2FnZS5zdWJzdHJpbmcoMSk7IC8vIFJlbW92ZSB0aGUgZG90CiAgICBjb25zdCBzcGFjZUluZGV4ID0gY29tbWFuZFBhcnQuaW5kZXhPZignICcpOwogICAgCiAgICBsZXQgY21kLCBhcmdzOwogICAgaWYgKHNwYWNlSW5kZXggPT09IC0xKSB7CiAgICAgICAgLy8gTm8gYXJndW1lbnRzCiAgICAgICAgY21kID0gY29tbWFuZFBhcnQ7CiAgICAgICAgYXJncyA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSGFzIGFyZ3VtZW50cwogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0LnN1YnN0cmluZygwLCBzcGFjZUluZGV4KTsKICAgICAgICBjb25zdCBhcmdzU3RyaW5nID0gY29tbWFuZFBhcnQuc3Vic3RyaW5nKHNwYWNlSW5kZXggKyAxKTsKICAgICAgICAKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VBcmd1bWVudHMoYXJnc1N0cmluZyk7CiAgICAgICAgICAgIGFyZ3MgPSBwYXJzZWRBcmdzLmxlbmd0aCA/IHBhcnNlZEFyZ3MgOiB1bmRlZmluZWQ7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBFcnJvciBwYXJzaW5nIGNvbW1hbmQgYXJndW1lbnRzOiAke2Vycm9yLm1lc3NhZ2V9YCwgbG9nVHlwZTogJ0Vycm9yJyB9KTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIC8vIENyZWF0ZSBhIGZyZXNoIENvbW1hbmRzTWFuYWdlciB3aXRoIGVhY2ggY2FsbCBzbyB0aGF0IHdlIGFsd2F5cyBoYXZlIHRoZSBsYXRlc3QgY29tbWFuZHMgYW5kIGZ1bmN0aW9uYWxpdHkuCiAgICBjb25zdCBhYkNvbW1hbmRzID0gbmV3IEFCQ29tbWFuZHNNYW5hZ2VyKCk7CgogICAgaWYgKGFiQ29tbWFuZHMgJiYgYWJDb21tYW5kcy5oYXNDb21tYW5kKGNtZCkpIHsKICAgICAgICAvLyBDYWxsIGNvbW1hbmQgd2l0aCBhcmdzLgogICAgICAgIGFiQ29tbWFuZHMuY2FsbENvbW1hbmQoY21kLCBhcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRXZhbHVhdGUgY29tbWFuZCBhcyBqYXZhc2NyaXB0LgogICAgICAgIGNvbnN0IGpzID0gdGhhdC5tZXNzYWdlLnN1YnN0cmluZygxKTsKICAgICAgICBvcy5ydW4oanMpOwogICAgfQp9Cgp0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7JwDDsse5AvbuCQtkZXNjcmlwdGlvbgIEAMOyx7kClJIKQlRoaXMgaXMgbWVhbnQgdG8gaGFuZGxlIGFueSBub25lIG1lbnUgcmVsYXRlZCBpbnB1dHMvaW50ZXJhY3Rpb25zLicAw7LHuQL27gkMb25GaWxlVXBsb2FkAgQAw7LHuQLXkgqiNUBpbXBvcnQgeyBSZWNvcmRGaWxlUmVzdWx0IH0gZnJvbSAnY2FzdWFsb3MnOwoKLy9maWx0ZXIgb3V0IHRpbWVzIHdoZW4gZmlsZSBsb2FkaW5nIGlzIG5vdCBhbGxvd2VkCmlmICghYnVpbGRlclZlcnNpb24gfHwgbGlua3MucmVtZW1iZXIudGFncy5hYkxpc3RlbmluZ0ZvckZpbGVVcGxvYWRzICE9PSB0cnVlKSB7CiAgICByZXR1cm47Cn0KCi8vdmFyaW91cyBmaWxlIHNwZWNpZmljIHZhcmlhYmxlcwpsZXQgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCkudG9Mb3dlckNhc2UoKTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwpsZXQgc2l6ZSA9IHRoYXQuZmlsZS5zaXplOwpsZXQgY29weVVybCA9IHRoYXQuY29weVVybCA/PyB0cnVlOwpsZXQgZm9jdXNDYW1lcmEgPSB0aGF0LmZvY3VzQ2FtZXJhID8/IHRydWU7CmxldCBtaW1lVHlwZTsKY29uc3QgYm90SW5mbyA9IHt9OwoKLy9oYXJkIGxpbWl0IGJhc2VkIG9uIGZpbGUgc2l6ZQppZiAoc2l6ZSA+IDIwMDAwMDAwMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJtYXhpbXVtIGZpbGUgc2l6ZSBleGNlZWRlZCAoMjAwIG1iKSIsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICByZXR1cm47Cn0KCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gZm9yIHJldHJpZXZpbmcgaW1hZ2UgZGltZW5zaW9ucyAmIGFzcGVjdCBmcm9tIEFycmF5QnVmZmVyIGRhdGEuCiAqIFJlcXVpcmVzIENhc3VhbE9TIGJlIGNvbmZpZ3VyZWQgdG8gaGF2ZSBhY2Nlc3MgdG8gdGhlIERPTS4KICovCmZ1bmN0aW9uIGdldEltYWdlRGltZW5zaW9ucyhhcnJheUJ1ZmZlciwgbWltZVR5cGUpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFthcnJheUJ1ZmZlcl0sIHsgdHlwZTogbWltZVR5cGUgfSk7CiAgICAgICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgICAgICBjb25zdCBpbWcgPSBuZXcgc2VsZi5JbWFnZSgpOwogICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7CiAgICAgICAgICAgIHJlc29sdmUoeyB3aWR0aDogaW1nLm5hdHVyYWxXaWR0aCwgaGVpZ2h0OiBpbWcubmF0dXJhbEhlaWdodCwgYXNwZWN0OiBpbWcubmF0dXJhbFdpZHRoIC8gaW1nLm5hdHVyYWxIZWlnaHQgfSk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9OwogICAgICAgIGltZy5vbmVycm9yID0gcmVqZWN0OwogICAgICAgIGltZy5zcmMgPSB1cmw7CiAgICB9KTsKfQoKLy90aGlzIHN3aXRjaCBoYW5kbGVzIHBvc3NpYmxlIGZpbGVzIGV4dGVuc2lvbnMsIHdoaWxlIHJlamVjdGluZyBhbnkgaXQgZG9lcyBub3QgcmVjb2duaXplCnN3aXRjaCAoZmlsZUV4dGVuc2lvbikgewogICAgY2FzZSAnanBnJzoKICAgIGNhc2UgJ2pwZWcnOgogICAgY2FzZSAnd2VicCc6CiAgICBjYXNlICdnaWYnOgogICAgY2FzZSAncG5nJzoKICAgICAgICBtaW1lVHlwZSA9ICJpbWFnZS8iICsgZmlsZUV4dGVuc2lvbjsKICAgICAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgICAgICBib3RJbmZvLmFuY2hvclBvaW50ID0gJ/Cfp6xbMCwwLC0wLjAxXSc7CgogICAgICAgIGlmIChvcy5kZXZpY2UoKS5zdXBwb3J0c0RPTSkgewogICAgICAgICAgICBjb25zdCBpbWFnZURpbWVuc2lvbnMgPSBhd2FpdCBnZXRJbWFnZURpbWVuc2lvbnModGhhdC5maWxlLmRhdGEsIG1pbWVUeXBlKTsKCiAgICAgICAgICAgIC8vIEFkanVzdCBzY2FsZSB0byByZXNwZWN0IGFzcGVjdCByYXRpby4gVGhpcyBpcyAiY292ZXIiIHNjYWxpbmcgc3R5bGUuCiAgICAgICAgICAgIGlmIChpbWFnZURpbWVuc2lvbnMuYXNwZWN0ID49IDEpIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVYID0gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVZID0gMSAvIGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGJyZWFrOwogICAgY2FzZSAnc3ZnJzoKICAgICAgICBtaW1lVHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKICAgICAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgICAgICBib3RJbmZvLmFuY2hvclBvaW50ID0gJ/Cfp6xbMCwwLC0wLjAxXSc7CgogICAgICAgIGlmIChvcy5kZXZpY2UoKS5zdXBwb3J0c0RPTSkgewogICAgICAgICAgICBjb25zdCBpbWFnZURpbWVuc2lvbnMgPSBhd2FpdCBnZXRJbWFnZURpbWVuc2lvbnModGhhdC5maWxlLmRhdGEsIG1pbWVUeXBlKTsKCiAgICAgICAgICAgIC8vIEFkanVzdCBzY2FsZSB0byByZXNwZWN0IGFzcGVjdCByYXRpby4gVGhpcyBpcyAiY292ZXIiIHNjYWxpbmcgc3R5bGUuCiAgICAgICAgICAgIGlmIChpbWFnZURpbWVuc2lvbnMuYXNwZWN0ID49IDEpIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVYID0gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVZID0gMSAvIGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdnbGInOgogICAgY2FzZSAnZXhyJzoKICAgIGNhc2UgJ2dsdGYnOgogICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICBib3RJbmZvLmZvcm0gPSAibWVzaCI7CiAgICAgICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJnbHRmIjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ2F1eCc6CiAgICBjYXNlICdwZGYnOgogICAgICAgIGxldCBib3REYXRhID0gZmlsZUV4dGVuc2lvbiA9PSAiLmF1eCIgPyBKU09OLnBhcnNlKHRoYXQuZmlsZS5kYXRhKS5zdGF0ZSA6IG9zLnBhcnNlQm90c0Zyb21EYXRhKHRoYXQuZmlsZS5kYXRhKTsKICAgICAgICBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90czogYm90RGF0YSwgb3JpZ2luOiBmaWxlTmFtZSwgc291cmNlRXZlbnQ6ICdmaWxlX3VwbG9hZCcgfSk7CiAgICAgICAgcmV0dXJuOwogICAgY2FzZSAnbXAzJzoKICAgICAgICBtaW1lVHlwZSA9ICdhdWRpby9tcGVnJzsKICAgICAgICBib3RJbmZvLm9uQ2xpY2sgPSAiQCBvcy5wbGF5U291bmQodGFncy5mb3JtQWRkcmVzcyk7IjsKICAgICAgICBib3RJbmZvLmxhYmVsID0gIkNsaWNrIHRvIFBsYXkiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnbXA0JzoKICAgICAgICBtaW1lVHlwZSA9ICd2aWRlby9tcDQnOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJpZnJhbWUiOwogICAgICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAic3JjIjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ290Zic6CiAgICAgICAgbWltZVR5cGUgPSAnZm9udC9vdGYnOwogICAgICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICd3b2ZmJzoKICAgICAgICBtaW1lVHlwZSA9ICdmb250L3dvZmYnOwogICAgICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgZmlsZSB0eXBlIG5vdCBzdXBwb3J0ZWRgLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIHJldHVybiBuZXcgRXJyb3IoInVuaGFuZGxlZCBmaWxlIHR5cGU6ICIgKyBmaWxlRXh0ZW5zaW9uKTsKfQoKLy90aGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhbmQgb2JqZWN0cyBzZXQgdXAgYSBsb2FkaW5nIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmlmICghbGlua3MubWVudSkgewogICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKfQoKbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHVwbG9hZGluZ2AgfSk7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpb0lEID8/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsKCmlmICghY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpIHsKICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwp9CgovL3RoaXMgaXMgdGhlIGFjdHVhbCB1cGxvYWQgZnVuY3Rpb25hbGl0eQpsZXQgdXBsb2FkUmVzdWx0OiBSZWNvcmRGaWxlUmVzdWx0ID0gYXdhaXQgbGlua3Muc3RvcmUuYWJQdWJsaXNoRmlsZSh7IGZpbGU6IHRoYXQuZmlsZS5kYXRhLCBmaWxlTmFtZTogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZSB9KTsKCmlmICh1cGxvYWRSZXN1bHQpIHsKICAgIGlmICh1cGxvYWRSZXN1bHQuc3VjY2VzcyB8fCB1cGxvYWRSZXN1bHQuZXJyb3JDb2RlID09PSAnZmlsZV9hbHJlYWR5X2V4aXN0cycpIHsKICAgICAgICBjb25zdCBmaWxlVVJMID0gdXBsb2FkUmVzdWx0LnVybCA/PyB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKICAgICAgICAvL2lmIHRoZSBmaWxlIHNob3VsZCBiZSBpbmNsdWRlZCBhcyBhIGJvdCB3aXRoIGEgbGluaywgdGhpcyBsb2dpYyBoYW5kbGVzIHRoYXQKICAgICAgICBpZiAoT2JqZWN0LmtleXMoYm90SW5mbykubGVuZ3RoID4gMCkgewogICAgICAgICAgICBsZXQgZGltZW5zaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbjsKCiAgICAgICAgICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZmFsbGJhY2sgdG8gd2hhdGV2ZXIgaXMgdGhlIHZpc2libGUgcG9ydGFsLgogICAgICAgICAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgIGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgIGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaW1lbnNpb24pIHsKICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uXSA9IHRydWU7CgogICAgICAgICAgICAgICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcG9zaXRpb24gPSBnZXRCb3RQb3NpdGlvbihsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LCBkaW1lbnNpb24pOwogICAgICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uICsgJ1gnXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb24gKyAnWSddID0gcG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbiArICdaJ10gPSBwb3NpdGlvbi56OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobWltZVR5cGUuaW5jbHVkZXMoImZvbnQiKSkgewogICAgICAgICAgICAgICAgYm90SW5mby5sYWJlbEZvbnRBZGRyZXNzID0gZmlsZVVSTDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uZm9ybUFkZHJlc3MgPSBmaWxlVVJMOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBib3RJbmZvLmFiRmlsZVVwbG9hZCA9IHRydWU7CgogICAgICAgICAgICBjb25zdCBib3QgPSBjcmVhdGUoYm90SW5mbyk7CgogICAgICAgICAgICBpZiAoZm9jdXNDYW1lcmEpIHsKICAgICAgICAgICAgICAgIG9zLmZvY3VzT24oYm90LCB7IGR1cmF0aW9uOiAxIH0pLmNhdGNoKGUgPT4ge30pCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb3B5VXJsKSB7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChmaWxlVVJMKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgRmlsZSB1cmwgY29waWVkIHRvIGNsaXBib2FyZC5gLCBsb2dUeXBlOiAnbG9nJyB9KTsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgRmlsZSB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogJHtmaWxlVVJMfWAsIGxvZ1R5cGU6ICdsb2cnIH0pOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJUb2FzdCh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gdXBsb2FkIGZpbGUuIFJlYXNvbjogJHt1cGxvYWRSZXN1bHQuZXJyb3JNZXNzYWdlfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgRmFpbGVkIHRvIHVwbG9hZCBmaWxlLiBSZXN1bHQ6ICR7SlNPTi5zdHJpbmdpZnkodXBsb2FkUmVzdWx0KX1gLCBsb2dUeXBlOiBgZXJyb3JgfSk7CiAgICB9Cn0gZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFNvbWV0aGluZyB3ZW50IHdyb25nIHdpdGggZmlsZSB1cGxvYWQuYCwgbG9nVHlwZTogYGVycm9yYH0pOwp9CgovL2NsZWFyIHRoZSBwcm9ncmVzcyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKCmlmIChwcm9ncmVzc0J1dHRvbikgewogICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiB1cGxvYWRSZXN1bHQ7JwDDsse5AvbuCQVsZWFybgIEAMOyx7kC9scKKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAMOyx7kC9u4JCHJlbWVtYmVyAgQAw7LHuQKdyAoo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAw7LHuQL27gkNbWFuaWZlc3RhdGlvbgIEAMOyx7kCxMgKKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAMOyx7kC9u4JCGFiSWdub3JlAgQAw7LHuQLryAoEdHJ1ZScAw7LHuQL27gkGY3JlYXRlAgQAw7LHuQLwyAoo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAw7LHuQL27gkFc3RvcmUCBADDsse5ApfJCijwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwDDsse5AvbuCQRtZW51AgQAw7LHuQK+yQoo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAw7LHuQL27gkHYWJTaGVsbAIEAMOyx7kC5ckKBHRydWUnAMOyx7kC9u4JCW9uVGFwQ29kZQIEAMOyx7kC6skKqQJAY29uc3QgdGFwQ29kZSA9IHRoYXQ7Cgpzd2l0Y2ggKHRhcENvZGUpCnsKICAgIGNhc2UgIjMzNDIiOgogICAgICAgIG9zLnRvYXN0KCJ3YWtpbmcgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkpOwoKICAgICAgICB0aGlzQm90Lm9uQ2hhdCh7bWVzc2FnZTogIi4uIn0pOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAiNDI0MiI6CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIC8vY29uc29sZS5sb2codGFwQ29kZSk7Cn0nAMOyx7kC9u4JA2FzawIEAMOyx7kClMwKKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAMOyx7kC9u4JCWFiVmVyc2lvbgIEAMOyx7kCu8wKBTEwLjEwJwDDsse5AvbuCQpvbkJvdEFkZGVkAgQAw7LHuQLBzApAQHRoaXNCb3QubG9hZEFCQ29tbWFuZHNNYW5hZ2VyKCk7CnRoaXNCb3QudmFycy5jaGF0SGlzdG9yeSA9IFtdOycAw7LHuQL27gkab25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQCBADDsse5AoLNCtdrQGxldCBhYkNvbW1hbmRzOiBBQkNvbW1hbmRzTWFuYWdlciA9IHRoYXQ7CgovLyBUaGVzZSBhcmUgYWxsIHRoZSBidWlsdC1pbiBjb21tYW5kcy4KCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnaGVscCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBjb21tYW5kcyA9IGFiQ29tbWFuZHMuY29tbWFuZHM7CiAgICBjb25zdCBjb21tYW5kS2V5cyA9IE9iamVjdC5rZXlzKGNvbW1hbmRzKTsKCiAgICBsZXQgc2VsZWN0ZWRDb21tYW5kOwogICAgaWYgKGNvbW1hbmRLZXlzICYmIGNvbW1hbmRLZXlzLmxlbmd0aCAmJiBhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgY29tbWFuZEtleU1hdGNoID0gY29tbWFuZEtleXMuZmluZChrZXkgPT4ga2V5ID09PSBhcmdzWzBdKTsKICAgICAgICBzZWxlY3RlZENvbW1hbmQgPSBjb21tYW5kS2V5TWF0Y2g7CiAgICB9CiAgICAKICAgIGxpbmtzLmhlbHAubW91bnQoeyBhYkNvbW1hbmRzTWFuYWdlcjogYWJDb21tYW5kcywgc2VsZWN0ZWRDb21tYW5kIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnU2hvdyB0aGlzIGhlbHAgd2luZG93LiBDYW4gc3BlY2lmeSBhIGNvbW1hbmQgdG8gb3BlbiB0aGUgaGVscCBwYWdlIGZvciB0aGF0IGNvbW1hbmQgZGlyZWN0bHkuJywKICAgIHVzYWdlOiBbJy5oZWxwJywgJy5oZWxwIFtjb21tYW5kXSddCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCcuJywgYXJncyA9PiB0aGlzQm90LmNtZEFCV2FrZShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1dha2UgdXAgYWIuJywKICAgIHVzYWdlOiAnLi4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd3YWtlJywgYXJncyA9PiB0aGlzQm90LmNtZEFCV2FrZShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1dha2UgdXAgYWIuJywKICAgIHVzYWdlOiAnLndha2UnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzbGVlcCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQlNsZWVwKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnUHV0IGFiIHRvIHNsZWVwLicsCiAgICB1c2FnZTogJy5zbGVlcCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2FjY291bnQnLCBhc3luYyAoYXJncykgPT4gewogICAgY29uc3QgZW5kcG9pbnQgPSBhd2FpdCBvcy5nZXRSZWNvcmRzRW5kcG9pbnQoKTsKICAgIG9zLm9wZW5VUkwoZW5kcG9pbnQpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgYWNjb3VudC9yZWNvcmRzIHBhZ2UgaW4gYSBuZXcgdGFiLicsCiAgICB1c2FnZTogJy5hY2NvdW50Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYXNrJywgKGFyZ3MpID0+IHsKICAgIGlmIChsaW5rcy5hc2spIHsKICAgICAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgYXNrSW5wdXQgPSBhcmdzLmpvaW4oJyAnKTsKICAgICAgICAgICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrSW5wdXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC5hc2sgY29tbWFuZCByZXF1aXJlcyBpbnB1dGApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYXNrIGJvdCBpcyBub3QgbG9hZGVkLCBjYW5ub3QgbG9hZCBhc2tgKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0FzayBhYicsCiAgICB1c2FnZTogJy5hc2sgPGFza19uYW1lPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ25hbWVhYicsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBuYW1lID0gYXdhaXQgb3Muc2hvd0lucHV0KGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHksIHsgdGl0bGU6ICd3aGF0IHdvdWxkIHlvdSBsaWtlIHRvIGNhbGwgbWU/JyB9KTsKICAgIHNldFRhZ01hc2sobGlua3MucGVyc29uYWxpdHksICdhYkJ1aWxkZXJJZGVudGl0eScsIG5hbWUsICdsb2NhbCcpOwogICAgc2hvdXQoJ2NoYW5nZVBlcnNvbmFsaXR5Q29uZmlnJywgeyBuYW1lOiBuYW1lIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2l2ZSBhYiBhIG5ldyBuYW1lLicsCiAgICB1c2FnZTogJy5uYW1lYWInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGRhdGVhYicsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBsaW5rcy5sZWFybi51cGRhdGVBQigpOzsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwZGF0ZSBBQiBjb3JlIGFuZCBza2lsbHMgdG8gY3VycmVudCBjb2RlLicsCiAgICB1c2FnZTogJy51cGRhdGVhYicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3N5c3RlbScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTeXN0ZW0oYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaW5zdC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGkgICAgCgogICAgWW91IG1heSBwcm92aWRlIGEgY3VzdG9tIHN5c3RlbVRhZ05hbWUgd2l0aCB0aGUgY29tbWFuZCwgaW4gb3JkZXIgdG8gb3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBvbmx5IGZvciBib3RzIHdpdGggdGhlIGdpdmVuIHN5c3RlbVRhZ05hbWUuIEJ5IGRlZmF1bHQsICJzeXN0ZW0iIHdpbGwgYmUgdXNlZCBhcyB0aGUgc3lzdGVtVGFnTmFtZS4KCiAgICBGb3IgZXhhbXBsZToKCiAgICA+IC5zeXN0ZW0KICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgInN5c3RlbSIgdGFnLgoKICAgID4gLnN5c3RlbSBteUdyb3VwCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJteUdyb3VwIiB0YWcuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnN5c3RlbScsCiAgICAgICAgJy5zeXN0ZW0gc3lzdGVtVGFnTmFtZScKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXcnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LiBCeSBkZWZhdWx0IHRoZSBzeXN0ZW0gcG9ydGFsIHdpbGwgb3BlbiBpbiBhIG5ldyB0YWIuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZycsIChhcmdzKSA9PiB7CiAgICBsaW5rcy5jb25zb2xlLnRvZ2dsZUNvbnNvbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1RvZ2dsZSB2aXNpYmxpdHkgb2YgdGhlIGFiIGxvZy4nLAogICAgdXNhZ2U6ICcubG9nJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2djbGVhcicsIChhcmdzKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlTG9nQm90cyA9IGdldEJvdHMoImNvbnNvbGVMb2dNZXNzYWdlQm90IiwgdHJ1ZSk7CiAgICBkZXN0cm95KG1lc3NhZ2VMb2dCb3RzKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0NsZWFyIGFsbCBhYiBsb2cgbWVzc2FnZXMuJywKICAgIHVzYWdlOiAnLmxvZ2NsZWFyJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzaGVldCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTaGVldChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3Igc3BlY2lmaWVkIGJvdCBvciBhbiBlbnRpcmUgZGltZW5zaW9uLicsCiAgICB1c2FnZTogWwogICAgICAgICcuc2hlZXQgW29wdGlvbnNdIFtwb3J0YWwgfCBoZWxwZXJCb3ROYW1lIHwgYm90SWQgfCBnbG9iYWxUaGlzUGF0aF0nLAogICAgICAgICdleC4gLnNoZWV0IGhvbWUnLAogICAgICAgICdleC4gLnNoZWV0IGNvbmZpZ0JvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgLXQgYTJjZjQ3MzktMzlhMi00ZmQ2LWIzZWYtY2M0NzgyZjk3MDg5JywKICAgICAgICAnZXguIC5zaGVldCBnbG9iYWxUaGlzLm15T2JqZWN0Lm15Qm90JywKICAgICAgICAnZXguIC5zaGVldCBteU9iamVjdC5teUJvdCcKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBpbiBhIG5ldyBicm93c2VyIHRhYi4gXG5cbk5PVEU6IC5zaGVldCB3aWxsIGF1dG9tYXRpY2FsbHkgaW5zcGVjdCB0aGUgc3BhY2Ugb2YgYSBib3QgYW5kIGZvcmNlIG9wZW5pbmcgaW4gdGhlIHNhbWUgdGFiIGlmIGEgYm90IGlzIGluIHRlbXBMb2NhbCBvciB0ZW1wU2hhcmVkIHNwYWNlLicsCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbWVudXNoZWV0JywgKGFyZ3MpID0+IHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKICAgIGlmICghY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2Fubm90IG9wZW4gc2hlZXRQb3J0YWwgZm9yIG1lbnVQb3J0YWwgYm90cy4gVGhlIG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IGRpc2FibGVkLmB9KQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciB0aGUgY3VycmVudCBtZW51IHBvcnRhbC4nLAogICAgdXNhZ2U6ICcubWVudVNoZWV0JywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkaW5zdCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEluc3QoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCB0aGUgaW5zdCB0byBkaXNrLicsCiAgICB1c2FnZTogJy5kb3dubG9hZGluc3QnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZHN5c3RlbScsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZFN5c3RlbShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIHRoZSBzcGVjaWZpZWQgYm90IHN5c3RlbShzKSB0byBkaXNrLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCB0aGUgc3BlY2lmaWVkIGJvdCBzeXN0ZW0ocykgdG8gZGlzay4KICAgIAogICAgVGhlIHByb3ZpZGVkIHN5c3RlbU5hbWUocykgaWxsIGJlIHVzZWQgdG8gbWF0Y2ggYWdhaW5zdCBib3RzIHdob3NlIHN5c3RlbSB0YWcgc3RhcnRzIHdpdGggc3lzdGVtTmFtZShzKS4gSXQgd2lsbCByZXNwZWN0IHRoZSBkb3Qgbm90YXRpb24gb2YgdGhlIHN5c3RlbSB0YWcsIHNvIHBhcnRpYWwgbWF0Y2hlcyB3aWxsIG5vdCB3b3JrLiBTZWUgdGhlIGV4YW1wbGVzIGJlbG93IGZvciBhIGJldHRlciB1bmRlcnN0YW5kaW5nLgoKICAgIEZvciBleGFtcGxlIGlmIHN5c3RlbU5hbWUgaXMgImhlbGxvIjoKCiAgICBTeXN0ZW0gVGFnIC0+IERvd25sb2FkPwogICAgLSBoZWxsbyAtPiB5ZXMKICAgIC0gaGVsbG8ud29ybGQubWFpbiAtPiB5ZXMKICAgIC0gaGVsbG8ud29ybGQuZmlyZXdvcmtzIC0+IHllcwogICAgLSByYy5yZWRCb3QgLT4gbm8KICAgIC0gaGVsbG9Xb3JsZC5ib3QgLT4gbm8KICAgIC0gaGVsaXVtLmF0b20gLT4gbm8KICAgIC0gaGV4LmdyaWQuaGVsbG8gLT4gbm8KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRzeXN0ZW0gWy4uLnN5c3RlbU5hbWVdJwogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRhYicsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEFCKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIHNwZWNpZmllZCBhYiBncm91cChzKSB0byBkaXNrLgoKICAgIFlvdSBjYW4gcHJvdmlkZSBhIGxpc3Qgb2YgZ3JvdXBzIHRvIGRvd25sb2FkIGFsb25nIHdpdGggdGhlIGNvbW1hbmQ6CiAgICA+IC5kb3dubG9hZGFiIGFiQ29yZSBhYlNoZWxsIGFiSW50ZXJmYWNlCgogICAgSWYgZ3JvdXAocykgYXJlIG5vdCBwcm92aWRlZCB3aXRoIHRoZSBjb21hbWFuZCB0aGVuIHlvdSB3aWxsIGJlIHByb21wdGVkIHRvIHByb3ZpZGUgb25lIHdpdGggYSBkaWFsb2cuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRvd25sb2FkYWIgW29wdGlvbnNdIFtncm91cC4uLl0nLAogICAgICAgICdleC4gLmRvd25sb2FkYWIgYWJTaGVsbCBhYkludGVyZmFjZScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiAtdiAxIG15R3JvdXBOYW1lJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnU3BlY2lmeSB0aGUgYXV4IGZvcm1hdCB2ZXJzaW9uIG51bWJlci4gZXguIC12IDEgd2lsbCBiZSBhdXggZm9ybWF0IHZlcnNpb24gMSAocHVyZSBib3QganNvbikuIEJ5IGRlZmF1bHQsIGFiIGZpbGVzIGFyZSB1c3VhbGx5IGRvd25sb2FkZWQgYXMgdmVyc2lvbiAyIGF1eCBmaWxlcyAoY29uZmxpY3QtZnJlZSB1cGRhdGUpLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGVnZycsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEVnZyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4gWW91IHdpbGwgbmVlZCB0byBwcm92aWRlIHRoZSByZWNvcmRLZXkgYXMgd2VsbCBhbmQgdGhlIG5hbWUgb2YgdGhlIGVnZy4gQSBkcm9wZG93biBzZWxlY3Rpb24gd2lsbCBiZSBwcm92aWRlZCBmb3IgdGhlIGVnZyBpZiBmb3VuZCB0byBzZWxlY3Qgd2hpY2ggdmVyc2lvbiB0byBkb3dubG9hZC5gLAogICAgdXNhZ2U6ICcuZG93bmxvYWRlZ2cnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9hZHNraWxsJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm9yIChsZXQgc2tpbGwgb2YgYXJncykgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJy5sb2Fkc2tpbGwgcmVxdWlyZXMgc29tZSBza2lsbCBuYW1lcycpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTG9hZCB0aGUgc3BlY2lmaWVkIGFiIHNraWxscy4nLAogICAgdXNhZ2U6ICcubG9hZFNraWxsIFtza2lsbCAuLi5dJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXJscXInLCAoKSA9PiBvcy5zaG93UVJDb2RlKGNvbmZpZ0JvdC50YWdzLnVybCksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IGEgUVIgY29kZSBmb3IgdGhlIGJyb3dlciB0YWJcJ3MgY3VycmVudCBVUkwuJywKICAgIHVzYWdlOiAnLnVybHFyJwp9KTsKCmNvbnN0IERJTV9TVVBQT1JURURfUE9SVEFMUyA9IFsnZ3JpZCcsICdtYXAnLCAnbWluaUdyaWQnLCAnbWluaU1hcCcsICdzaGVldCcsICdzeXN0ZW0nLCAnbWVudScsICd0YWcnXTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZGltJywgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgbGV0IHBvcnRhbCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1wJyk7CiAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGFyZ3Muam9pbignICcpOwoKICAgICAgICBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSAnZ3JpZCc7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGltZW5zaW9uID09PSAibnVsbCIgfHwgZGltZW5zaW9uID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBkaW1lbnNpb24gPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKERJTV9TVVBQT1JURURfUE9SVEFMUy5pbmRleE9mKHBvcnRhbCkgPj0gMCkgewogICAgICAgICAgICBjb25maWdCb3QudGFnc1tgJHtwb3J0YWx9UG9ydGFsYF0gPSBkaW1lbnNpb247CgogICAgICAgICAgICBpZiAoZGltZW5zaW9uID09IG51bGwpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2xvc2VkICR7cG9ydGFsfVBvcnRhbC5gIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBTZXQgJHtwb3J0YWx9UG9ydGFsIHRvICcke2RpbWVuc2lvbn0nIGRpbWVuc2lvbi5gIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGAke3BvcnRhbH0gaXMgbm90IGEgc3VwcG9ydGVkIHBvcnRhbCBmb3IgdGhlIGRpbSBjb21tYW5kLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSkKICAgICAgICB9CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHbyB0byBzcGVjaWZpZWQgcG9ydGFsIGRpbWVuc2lvbi4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgR28gdG8gc3BlY2lmaWVkIHByb3RhbCBkaW1lbnNpb24uCiAgICAKICAgIElmIGEgcG9ydGFsIGFyZ3VtZW50IGlzIG5vdCBwcm92aWRlZCB0aGVuIGl0IHdpbGwgZGVmYXVsdCB0byB0aGUgZ3JpZFBvcnRhbC4KICAgIAogICAgSWYgYSBkaW1lbnNpb24gaXMgbm90IHByb3ZpZGVkIG9yIGlzICJudWxsIiB0aGVuIHRoZSBwb3J0YWwgd2lsbCBiZSBzZXQgdG8gbnVsbCBhbmQgYmUgY2xvc2VkLmAsCiAgICB1c2FnZTogWwogICAgICAgICcuZGltIDxkaW1lbnNpb24+JywKICAgICAgICAnLmRpbSAtcCA8cG9ydGFsPiA8ZGltZW5zaW9uPicKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXAnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogYFNwZWNpZnkgdGhlIHBvcnRhbCBuYW1lLiBDYW4gYmUgYW55b25lIG9mIHRoZSBmb2xsb3dpbmc6ICR7RElNX1NVUFBPUlRFRF9QT1JUQUxTLmpvaW4oJywgJyl9YAogICAgICAgIH0KICAgIF0KCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1dWlkJywgKCkgPT4gewogICAgb3Muc2V0Q2xpcGJvYXJkKHV1aWQoKSk7CgogICAgbGV0IG1lc3NhZ2UgPSBgQ29waWVkIG5ldyB1dWlkIHRvIGNsaXBib2FyZGA7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYSB1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllciAodXVpZCkgYW5kIGNvcHkgaXQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcudXVpZCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2R1cCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBib3RJZCA9IGFyZ3MgPyBhcmdzWzBdIDogdW5kZWZpbmVkOwogICAgaWYgKGJvdElkKSB7CiAgICAgICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgICAgICBpZiAoYm90KSB7CiAgICAgICAgICAgIGNvbnN0IGR1cEJvdCA9IGNyZWF0ZShib3QpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZHVwQm90LmlkKTsKICAgICAgICAgICAgb3MudG9hc3QoJ0R1cGxpY2F0ZSBib3QgaWQgY29waWVkIHRvIGNsaXBib2FyZC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcy50b2FzdChgTm8gYm90IGZvdW5kIHdpdGggaWQgJHtib3RJZH1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCdQcm92aWRlIHRoZSBpZCBvZiB0aGUgYm90IHlvdSB3YW50IHRvIGR1cGxpY2F0ZScpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGEgc3BlY2lmaWVkIGJvdCBhbmQgY29weSB0aGUgbmV3IGJvdFwncyBpZCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy5kdXAgPGJvdElkPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGF1eCcsIChhcmdzKSA9PiB7CiAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIEFVWCBmaWxlKHMpIHRvIHRoZSBjdXJyZW50IGluc3QuJywKICAgIHVzYWdlOiAnLnVwbG9hZGF1eCcKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkZmlsZXMnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBsb2FkRmlsZXMoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgZmlsZShzKSBkaXJlY3RseSB0byByZWNvcmQuJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGxvYWRmaWxlcycsCiAgICAgICAgJy51cGxvYWRmaWxlcyAtcmVjb3JkIDxyZWNvcmRfaWQ+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcmVjb3JkJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcHRpb25hbGx5IHB1Ymxpc2ggZmlsZShzKSB0byBhIHNwZWNpZmljIHJlY29yZC4gSWYgb21pdHRlZCwgZmlsZShzKSB3aWxsIGJlIHB1Ymxpc2hlZCB0byB0aGUgdXNlclwncyBwZXJzb25hbCByZWNvcmQuJwogICAgICAgIH0KICAgIF0KfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgncHVibGlzaGFzaycsIGFyZ3MgPT4gdGhpc0JvdC5jbWRQdWJsaXNoQXNrKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnUHVibGlzaCBhbiBhc2sgdG8gdGhlIHB1YmxpYyBhYiByZWNvcmQuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYFB1Ymxpc2ggYW4gYXNrIHRvIHRoZSBwdWJsaWMgYWIgcmVjb3JkLgoKICAgIEFuIGFiIGFzayBpcyBhIGxpdHRsZSBwb2ludGVyIHRvIGEgcGF0dGVybiBpbnNpZGUgb2YgYSBzcGVjaWZpYyBzdHVkaW8uIFRoZSBhc2sgY2FuIGJlIHVzZWQgdG8gbG9hZCB0aGUgZ2l2ZW4gcGF0dGVybiB1c2luZyBhIHNpbXBsZSBuYW1lLCBsaWtlIGEgc2hvcnRjdXQgb3IgYW4gYWxpYXMuCgogICAgVGhlIGFzayBpdHNlbGYgaXMgc3RvcmVkIGluIHRoZSBwdWJsaWMgYWIgcmVjb3JkIHNvIHRoYXQgYW55b25lIGNhbiByZWFkIHRoZSBwb2ludGVyIGZpbGUsIGJ1dCB0aGUgcGVybWlzc2lvbnMgZm9yIHRoZSBwYXR0ZXJuIGluc2lkZSB0aGUgc3R1ZGlvIGFyZSBzdGlsbCBtYW5hZ2VkIGJ5IHRoZSBvcmlnaW5hbCBhdXRob3IuCgogICAgQW55IHVwZGF0ZXMgdG8gYW4gZXhpc3RpbmcgYXNrIHdpbGwgYmUgb3ZlcndyaXR0ZW4uCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnB1Ymxpc2hhc2sgLWFzayA8YXNrSUQ+IC1wYXR0ZXJuIDxwYXR0ZXJuSUQ+IC1zdHVkaW8gPHN0dWRpb0lEPicsCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1hc2snLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBhc2sgdG8gYmUgc2V0LicsCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcGF0dGVybicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHBhdHRlcm4gc2V0IHRoZSBhc2sgdG8gcG9pbnQgYXQuJywKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1zdHVkaW8nLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBzdHVkaW8gdG8gc2V0IHRoZSBhc2sgdG8gcG9pbnQgYXQuIFRoaXMgaXMgdGVjaG5pY2FsbHkgb3B0aW9uYWwsIGlmIG5vdCBwcm92aWRlZCB0aGVuIHRoZSBzdHVkaW8gSUQgb2YgdGhlIGN1cnJlbnRseSBsb2dnZWQgaW4gdXNlciB3aWxsIGJlIHVzZWQuJywKICAgICAgICB9CiAgICBdCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3ZpZXdyZWNvcmRkYXRhJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmICghbGlua3Mudmlld1JlY29yZERhdGFBcHApIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYlZpZXdSZWNvcmQnKTsKICAgIH0KCiAgICBjb25zdCBpc0FsaWFzID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctYScpCgogICAgbGV0IHJlY29yZE5hbWU7CgogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgcmVjb3JkTmFtZSA9IGFyZ3Muam9pbignICcpOwogICAgfQoKICAgIGlmIChpc0FsaWFzKSB7CiAgICAgICAgc3dpdGNoKHJlY29yZE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAncGxheWVyJzoKICAgICAgICAgICAgICAgIGlmIChhdXRoQm90KSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTmFtZSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC52aWV3cmVjb3JkZGF0YSBtdXN0IGJlIGxvZ2dlZCBpbiB0byB2aWV3IHBsYXllciByZWNvcmQuYCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2FiJzoKICAgICAgICAgICAgICAgIHJlY29yZE5hbWUgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLnZpZXdyZWNvcmRkYXRhIGNvbW1hbmQgZG9lcyBub3QgcmVjb2duaXplIGFsaWFzICR7cmVjb3JkTmFtZX1gKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICghcmVjb3JkTmFtZSAmJiBhdXRoQm90KSB7CiAgICAgICAgICAgIHJlY29yZE5hbWUgPSBhdXRoQm90LmlkOwogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKHJlY29yZE5hbWUpIHsKICAgICAgICBsaW5rcy52aWV3UmVjb3JkRGF0YUFwcC5tb3VudCh7IHJlY29yZE5hbWUgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC52aWV3cmVjb3JkZGF0YSBjb21tYW5kIHJlcXVpcmVzIGEgcmVjb3JkTmFtZWApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVmlldyBkYXRhIHN0b3JlZCBpbiBwcm92aWRlZCByZWNvcmQgbmFtZS4gSWYgcmVjb3JkIG5hbWUgaXMgbm90IHByb3ZpZGVkIHRoZW4gaXQgd2lsbCBkZWZhdWx0IHRvIHlvdXIgcGVyc29uYWwgcmVjb3JkLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBWaWV3IGRhdGEgc3RvcmVkIGluIHByb3ZpZGVkIHJlY29yZCBuYW1lLiBJZiByZWNvcmQgbmFtZSBpcyBub3QgcHJvdmlkZWQgdGhlbiBpdCB3aWxsIGRlZmF1bHQgdG8geW91ciBwZXJzb25hbCByZWNvcmQuCgogICAgVGhlcmUgYXJlIHNvbWUgYWxpYXNlcyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggdGhlIGFsaWFzIGFyZ3VtZW50IHRvIGxvYWQgYSByZWNvcmQgdmlhIGFsaWFzOgogICAgLSBwbGF5ZXI6IHlvdXIgcGVyc29uYWwgcmVjb3JkCiAgICAtIGFiOiBhYidzIHB1YmxpYyByZWNvcmQKICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcudmlld3JlY29yZGRhdGEnLAogICAgICAgICcudmlld3JlY29yZGRhdGEgW3JlY29yZE5hbWVdJywKICAgICAgICAnLXZpZXdyZWNvcmRkYXRhIC1hIGFiJyAgCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1hJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgcHJvdmlkZWQgcmVjb3JkTmFtZSBpcyBhY3R1YWxseSBhbiBhbGlhcy4nCiAgICAgICAgfQogICAgXQp9KScAw7LHuQL27gkIYXJ0aWZhY3QCBADDsse5Atq4Cyjwn5SXNzhlNDE1MDMtYzkzMy00ZjhhLTgxN2EtYmE5N2JmOGQ1ZDI3JwDDsse5AvbuCRVsb2FkQUJDb21tYW5kc01hbmFnZXICBADDsse5AoG5C/otQC8qKgogKiBBQkNvbW1hbmRzTWFuYWdlciBpcyBwYXJ0IG9mIGFiU2hlbGwuCiAqIFlvdSBjYW4gcmVnaXN0ZXIgY29tbWFuZHMgdG8gaXQgdGhhdCBjYW4gYmUgaW52b2tlZCB1c2luZyAnJDxjb21tYW5kPicgd2l0aCB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAqIEl0cyBnZW5lcmFsbHkgbm90IHJlY29tbWVuZGVkIHRvIGNyZWF0ZSB0aGlzIHlvdXJzZWxmIGJ1dCBpbnN0ZWFkIHRvIGxpc3RlbiBmb3IgdGhlIEBvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCBzaG91dAogKiBhbmQgdG8gcmVnaXN0ZXIgeW91ciBjb21tYW5kcyB0aGVyZS4KICogQHByb3Age3N0cmluZ1tdfSBjb21tYW5kcwogKi8KY2xhc3MgQUJDb21tYW5kc01hbmFnZXIgewogICAgY29tbWFuZHM6IFJlY29yZDxzdHJpbmcsIEFCQ29tbWFuZD47CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgdGhpcy5jb21tYW5kcyA9IHt9OwoKICAgICAgICAvLyBTaG91dCB0aGF0IGFuIGluc3RhbmNlIG9mIEFCQ29tbWFuZHNNYW5hZ2VyIGhhcyBiZWVuIGNyZWF0ZWQgYW5kIGFsbG93IGFueSBsaXN0ZW5lcnMKICAgICAgICAvLyB0byBhZGQgdGhlaXIgb3duIGNvbW1hbmRzIHRvIHRoZSBpbnN0YW5jZS4KICAgICAgICBzaG91dCgnb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQnLCB0aGlzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZCBhIGNvbW1hbmQgdG8gQUJDb21tYW5kc01hbmFnZXIuCiAgICAgKiBUaGlzIGNvbW1hbmQgd2lsbCBiZSBhdmFpbGFibGUgdG8gaW52b2tlIHVzaW5nICckPG5hbWU+JyBvbiB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgc3VjY2Vzc2Z1bGx5IGFkZGVkLgogICAgICovCiAgICBhZGRDb21tYW5kKG5hbWU6IHN0cmluZywgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrLCBoZWxwOiBBQkNvbW1hbmRIZWxwKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKCFuYW1lIHx8IHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdIHN0cmluZyBuYW1lIGlzIHJlcXVpcmVkIGZvciBjb21tYW5kcy5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIGFscmVhZHkgZXhpc3RzIGFzIGEgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFjYWxsYmFjayB8fCB0eXBlb2YgY2FsbGJhY2sgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgYSBjYWxsYmFjayBmdW5jdGlvbi5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCBpcyBtaXNzaW5nIHNob3J0RGVzY3JpcHRpb24gZnJvbSBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb21tYW5kc1tuYW1lXSA9IHsgbmFtZSwgY2FsbGJhY2ssIGhlbHAgfTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBoYXNDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRzW25hbWVdICE9IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmUgYSBjb21tYW5kIGZyb20gQUJDb21tYW5kc01hbmFnZXIKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3YXMgcmVtb3ZlZC4gSWYgdGhlIGNvbW1hbmQgZG9lc24ndCBleGlzdCBmYWxzZSB3aWxsIGFsc28gYmUgcmV0dXJuZWQuCiAgICAgKi8KICAgIHJlbW92ZUNvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsIHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3aXRoIHRoZSBwcm92aWRlZCBhcmdzIChpZiBhbnkpLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIGV4ZWN1dGVkLgogICAgICovCiAgICBjYWxsQ29tbWFuZChuYW1lOiBzdHJpbmcsIGFyZ3M/OiBhbnlbXSk6IGJvb2xlYW4gewogICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgIGlmIChjb21tYW5kKSB7CiAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhlbHBBcmcgb2YgY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaGVscEFyZy5pZGVudGlmaWVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goLi4uaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKGhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXNzZXJ0IHRoYXQgdGhlIGlucHV0IGFyZ3MgYXJlIHZhbGlkIGFnYWluc3QgdGhlIGNvbW1hbmQgaGVscCBkb2N1bWVudGF0aW9uLgogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBlYXN5IHdheSB0byB2YWxpZGF0ZSBhcmdzIGJlZm9yZSBleGVjdXRpbmcgYSBjb21tYW5kLgogICAgICAgICAgICAgICAgQUJDb21tYW5kc01hbmFnZXIuYXNzZXJ0VmFsaWRBcmdzKGFyZ3MsIHZhbGlkQXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWFuZC5jYWxsYmFjayhhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIG5vdCBhIHZhbGlkIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgcHJvdmlkZWQgYXJnLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGFuZCB2YWx1ZSBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdWYWx1ZShhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBhbnkgewogICAgICAgIGxldCB2YWx1ZSA9IG51bGw7CgogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIGxldCBkZWxldGVDb3VudCA9IDE7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUluZGV4ID0gYXJnSW5kZXggKyAxOwoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZUluZGV4IDwgYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYXJnc1t2YWx1ZUluZGV4XTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgcmVsYXRlZCBhcmdzICYgdmFsdWVzCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgZGVsZXRlQ291bnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgd2V0aGVyIHRoZSBhcmcgZmxhZyBpcyBwcm92aWRlZCBpbiB0aGUgYXJncy4gV2lsbCByZW1vdmUgdGhlIGFyZyBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdGbGFnKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBhcmcgZmxhZy4KICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCAxKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgc3RhdGljIGFzc2VydFZhbGlkQXJncyhhcmdzOiBhbnlbXSwgdmFsaWRBcmdzOiBhbnlbXSk6IHZvaWQgewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGludmFsaWRBcmdzID0gW107CgogICAgICAgICAgICBmb3IgKGxldCBhcmcgb2YgYXJncykgewogICAgICAgICAgICAgICAgaWYgKGFyZyAmJiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJnIHdlIHdhbnQgdG8gZXZhbHVhdGUuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRBcmdzIHx8ICF2YWxpZEFyZ3MuaW5jbHVkZXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBhcmcgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB2YWxpZEFyZ3MsIHRodXMgdGhlIGFyZyBpcyBpbnZhbGlkLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZEFyZ3MucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHRoaXMgYXJnIGl0IGlzIG1vc3RseSBsaWtlbHkgYSB2YWx1ZSBhcmcuCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaW52YWxpZEFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYEludmFsaWQgYXJndW1lbnRzOiAke2ludmFsaWRBcmdzLmpvaW4oJywgJyl9YDsKCiAgICAgICAgICAgICAgICBvcy50b2FzdChlcnJvck1lc3NhZ2UsIDQpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdsb2JhbFRoaXMuQUJDb21tYW5kc01hbmFnZXIgPSBBQkNvbW1hbmRzTWFuYWdlcjsnAMOyx7kC9u4JBGhlbHACBADDsse5AvzmCyjwn5SXMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjJwDDsse5AvbuCQhjbWRTaGVldAIEAMOyx7kCo+cLzRRAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgcG9ydGFsOwpsZXQgbmV3VGFiID0gZmFsc2U7CgppZiAoYXJncykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYXJnID0gYXJnc1tpXTsKICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICBpZiAoYXJnID09PSAnLXQnKSB7CiAgICAgICAgICAgICAgICBuZXdUYWIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghcG9ydGFsKSB7CiAgICAgICAgICAgIHBvcnRhbCA9IGFyZzsKICAgICAgICB9CiAgICB9Cn0KCmlmICghcG9ydGFsKSB7CiAgICBwb3J0YWwgPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCmNvbnN0IGhlbHBlckJvdHMgPSB7CiAgICAnY29uZmlnQm90JzogY29uZmlnQm90LAogICAgJ2dyaWRQb3J0YWxCb3QnOiBncmlkUG9ydGFsQm90LAogICAgJ3NoZWV0UG9ydGFsQm90Jzogc2hlZXRQb3J0YWxCb3QsCiAgICAnc3lzdGVtUG9ydGFsQm90Jzogc3lzdGVtUG9ydGFsQm90LAogICAgJ21pbmlHcmlkUG9ydGFsQm90JzogbWluaUdyaWRQb3J0YWxCb3QsCiAgICAnbWFwUG9ydGFsQm90JzogbWFwUG9ydGFsQm90LAogICAgJ21pbmlNYXBQb3J0YWxCb3QnOiBtaW5pTWFwUG9ydGFsQm90LAogICAgJ21lbnVQb3J0YWxCb3QnOiBtZW51UG9ydGFsQm90LAogICAgJ2xlZnRXcmlzdFBvcnRhbEJvdCc6IGxlZnRXcmlzdFBvcnRhbEJvdCwKICAgICdyaWdodFdyaXN0UG9ydGFsQm90JzogcmlnaHRXcmlzdFBvcnRhbEJvdCwKICAgICdtZWV0UG9ydGFsQm90JzogbWVldFBvcnRhbEJvdCwKICAgICd0YWdQb3J0YWxCb3QnOiB0YWdQb3J0YWxCb3QsCiAgICAnaW11UG9ydGFsQm90JzogaW11UG9ydGFsQm90LAp9OwoKLy8gRnVuY3Rpb24gdG8gcmVzb2x2ZSBhIHBvcnRhbCByZWZlcmVuY2UgdG8gYSBzcGVjaWZpYyBib3QKZnVuY3Rpb24gcmVzb2x2ZVBvcnRhbFRvQm90KHBhdGgpIHsKICAgIGlmICghcGF0aCB8fCBwYXRoID09PSAnJykgcmV0dXJuIG51bGw7CiAgICAKICAgIC8vIEZpcnN0IGNoZWNrIGlmIGl0J3MgZGlyZWN0bHkgaW4gaGVscGVyQm90cwogICAgaWYgKGhlbHBlckJvdHNbcGF0aF0pIHsKICAgICAgICByZXR1cm4gaGVscGVyQm90c1twYXRoXTsKICAgIH0KCiAgICAvLyBQZXJoYXBzIHRoZSBwYXRoIGlzIGEgYm90IGlkLgogICAgbGV0IGJvdEZyb21JZFNlYXJjaCA9IGdldEJvdCgnaWQnLCBwYXRoKTsKICAgIGlmIChib3RGcm9tSWRTZWFyY2gpIHsKICAgICAgICByZXR1cm4gYm90RnJvbUlkU2VhcmNoOwogICAgfQogICAgCiAgICAvLyBDaGVjayBmb3IgYm90aCBkaXJlY3QgYW5kIG5lc3RlZCBwYXRocyBpbiBnbG9iYWxUaGlzCiAgICBsZXQgcGF0aFBhcnRzID0gcGF0aC5zcGxpdCgnLicpOwogICAgbGV0IGN1cnJlbnRPYmogPSBnbG9iYWxUaGlzOwogICAgbGV0IHN0YXJ0SW5kZXggPSAwOwogICAgCiAgICAvLyBIYW5kbGUgaWYgdGhlIHBhdGggZXhwbGljaXRseSBzdGFydHMgd2l0aCAnZ2xvYmFsVGhpcycKICAgIGlmIChwYXRoUGFydHNbMF0gPT09ICdnbG9iYWxUaGlzJykgewogICAgICAgIHN0YXJ0SW5kZXggPSAxOyAvLyBTa2lwIHRoZSAnZ2xvYmFsVGhpcycgcGFydCBzaW5jZSB3ZSdyZSBhbHJlYWR5IHN0YXJ0aW5nIHRoZXJlCiAgICB9CiAgICAKICAgIC8vIFRyYXZlcnNlIHRoZSBwYXRoCiAgICBmb3IgKGxldCBpID0gc3RhcnRJbmRleDsgaSA8IHBhdGhQYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHBhcnQgPSBwYXRoUGFydHNbaV07CiAgICAgICAgaWYgKCFjdXJyZW50T2JqW3BhcnRdKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBQYXRoIHNlZ21lbnQgZG9lc24ndCBleGlzdAogICAgICAgIH0KICAgICAgICBjdXJyZW50T2JqID0gY3VycmVudE9ialtwYXJ0XTsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgaWYgdGhlIGZpbmFsIG9iamVjdCBpcyBhIGJvdCAoaGFzIGlkIGFuZCB0YWdzKQogICAgaWYgKGN1cnJlbnRPYmogJiYgY3VycmVudE9iai5pZCAmJiBjdXJyZW50T2JqLnRhZ3MpIHsKICAgICAgICByZXR1cm4gY3VycmVudE9iajsKICAgIH0KICAgIAogICAgcmV0dXJuIG51bGw7IC8vIE5vdCBhIHZhbGlkIGJvdAp9CgovLyBTZWFyY2ggdG8gc2VlIGlmIHBvcnRhbCBhcmd1bWVudCBpcyBzcGVjaWZpYyB0byBhIGJvdApsZXQgdW5pcXVlQm90ID0gcmVzb2x2ZVBvcnRhbFRvQm90KHBvcnRhbCk7CgppZiAodW5pcXVlQm90KSB7CiAgICBpZiAodW5pcXVlQm90LnRhZ3Muc3BhY2UgPT09ICd0ZW1wTG9jYWwnIHx8CiAgICAgICAgdW5pcXVlQm90LnRhZ3Muc3BhY2UgPT09ICd0ZW1wU2hhcmVkJwogICAgKSB7CiAgICAgICAgLy8gRm9yY2Ugc2hlZXQgdG8gb3BlbiBpbiBzYW1lIHRhYiBpZiB0aGUgYm90IG9ubHkgbGl2ZXMgaW4gdGhpcyB0YWIuCiAgICAgICAgbmV3VGFiID0gZmFsc2U7CiAgICB9CiAgICBwb3J0YWwgPSB1bmlxdWVCb3QuaWQ7Cn0KCmlmIChuZXdUYWIpIHsKICAgIG9zLm9wZW5VUkwoYC8/aW5zdD0ke29zLmdldEN1cnJlbnRJbnN0KCl9JnNoZWV0UG9ydGFsPSR7cG9ydGFsfWApOwp9IGVsc2UgewogICAgY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgPSBwb3J0YWw7Cn0nAMOyx7kC9u4JDWNtZERvd25sb2FkQUICBADDsse5AvH7C6MLQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IGF1eFZlcnNpb246IHN0cmluZyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy12Jyk7CgppZiAoIWF1eFZlcnNpb24pIHsKICAgIC8vIERlZmF1bHQgdG8gYXV4IHZlcnNpb24gMiBpZiBhcmd1bWVudCBpcyBub3QgcHJvdmlkZWQuCiAgICBhdXhWZXJzaW9uID0gJzInOwp9CgppZiAoYXV4VmVyc2lvbiAhPT0gJzEnICYmIGF1eFZlcnNpb24gIT09ICcyJykgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgT25seSBhdXggZm9ybWF0IHZlcnNpb24gMSBhbmQgMiBhcmUgc3VwcG9ydGVkIGluIHRoZSBkb3dubG9hZCBhYiBjb21tYW5kLmApOwogICAgcmV0dXJuOwp9CgovLyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogZmFsc2UgfSk7CgpsZXQgZ3JvdXBzID0gW107CgppZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgIC8vIFJlbWFpbmluZyBhcmdzIGFyZSBncm91cCBuYW1lcyBwcm92aWRlZCB3aXRoIHRoZSBjb21tYW5kLgogICAgZ3JvdXBzID0gYXJnczsKfSBlbHNlIHsKICAgIGxldCBncm91cCA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAsIHsgdGl0bGU6ICdBQiBHcm91cCBUYWcnLCBhdXRvU2VsZWN0OiB0cnVlIH0pOwogICAgaWYgKGdyb3VwKSB7CiAgICAgICAgbWFza3MucHJldklucHV0RG93bmxvYWRBQkdyb3VwID0gZ3JvdXA7CiAgICAgICAgZ3JvdXBzLnB1c2goZ3JvdXApOwogICAgfQp9Cgpjb25zdCBtYWpvclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1ham9yVmVyc2lvbjsKY29uc3QgbWlub3JWZXJzaW9uID0gbGlua3MubGVhcm4udGFncy5hYkNvcmVNaW5vclZlcnNpb247CmNvbnN0IGFiVmVyc2lvbiA9IGAke21ham9yVmVyc2lvbn0uJHttaW5vclZlcnNpb259YDsKCmZvciAobGV0IGdyb3VwIG9mIGdyb3VwcykgewogICAgY29uc3QgZ3JvdXBCb3RzID0gZ2V0Qm90cyhieU1vZCh7IFtncm91cF06IHRydWUsIHNwYWNlOiAnc2hhcmVkJyB9KSk7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncm91cEJvdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBncm91cEJvdHNbaV0udGFncy5hYlZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9CgogICAgaWYgKGdyb3VwID09ICJhYkNvbmZpZyIpIHsKICAgICAgICBncm91cCA9ICJhYjEiOwogICAgfQoKICAgIGlmIChhdXhWZXJzaW9uID09PSAnMScpIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDEKICAgICAgICBvcy5kb3dubG9hZEJvdHMoZ3JvdXBCb3RzLCBncm91cCkKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRG93bmxvYWQgYXMgdmVyc2lvbiAyCiAgICAgICAgb3MuZG93bmxvYWRCb3RzQXNJbml0aWFsemF0aW9uVXBkYXRlKGdyb3VwQm90cywgZ3JvdXApOwogICAgfQoKfQoKJwDDsse5AvbuCQljbWRBQldha2UCBADDsse5ApWHDDFAbGlua3MubWFuaWZlc3RhdGlvbi5hYlNldEF3YWtlKHsgYXdha2U6IHRydWUgfSk7JwDDsse5AvbuCQpjbWRBQlNsZWVwAgQAw7LHuQLHhwzQAUBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogZmFsc2UgfSk7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwoKdGFnUG9ydGFsQm90Lm1hc2tzLnRhZ1BvcnRhbEFuY2hvclBvaW50ID0gbnVsbDsnAMOyx7kC9u4JB2NvbnNvbGUCBADDsse5ApiJDCjwn5SXMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViJwDDsse5AvbuCQ5jbWRVcGxvYWRGaWxlcwIEAMOyx7kCv4kMkxBAY29uc3QgYXJncyA9IHRoYXQ7Cgphc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlKHsgZmlsZSwgcmVjb3JkS2V5IH0pIHsKICAgIGxldCBmaWxlRXh0ZW5zaW9uID0gZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCk7CiAgICBsZXQgZmlsZU5hbWUgPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwogICAgbGV0IG1pbWVUeXBlOwoKICAgIHN3aXRjaCAoZmlsZUV4dGVuc2lvbikgewogICAgICAgIGNhc2UgJ3N2Zyc6CiAgICAgICAgICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdnbGInOgogICAgICAgIGNhc2UgJ2dsdGYnOgogICAgICAgICAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIG1pbWVUeXBlID0gZmlsZS5taW1lVHlwZTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgbGV0IHVybDsKICAgICAgICAKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gcmVjb3JkS2V5OwogICAgY29uc3QgW3Jlc3VsdF0gPSBhd2FpdCBQcm9taXNlLmFsbChzaG91dCgnYWJQdWJsaXNoRmlsZScsIHsgZmlsZSwgZmlsZU5hbWUsIG1pbWVUeXBlIH0pKTsKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gbnVsbDsKICAgIAogICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQudXJsOwogICAgfSBlbHNlIGlmIChyZXN1bHQuZXhpc3RpbmdGaWxlVXJsKSB7CiAgICAgICAgdXJsID0gcmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKICAgIH0KCiAgICByZXR1cm4geyB1cmwgfTsKfQoKY29uc3QgcmVjb3JkS2V5ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXJlY29yZCcpOwpjb25zdCBzZWxlY3RlZEZpbGVzID0gYXdhaXQgb3Muc2hvd1VwbG9hZEZpbGVzKCk7CmNvbnN0IHB1Ymxpc2hSZWNvcmQgPSBnZXRCb3QoJ3N5c3RlbScsICdyYy1wYWNrYWdlLWRldi5wdWJsaXNoUmVjb3JkJyk7CgppZiAoc2VsZWN0ZWRGaWxlcyAmJiBzZWxlY3RlZEZpbGVzLmxlbmd0aCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVwbG9hZCAke3NlbGVjdGVkRmlsZXMubGVuZ3RofSBmaWxlcy4uLmApOwogICAgfQoKICAgIGxldCBkb25lSHRtbCA9ICcnOwoKICAgIGlmIChyZWNvcmRLZXkpIHsKICAgICAgICBkb25lSHRtbCArPSBgPGgyPlJlY29yZCBJZDwvaDI+YDsKICAgICAgICBkb25lSHRtbCArPSBgPHA+JHtyZWNvcmRLZXl9PC9wPmA7CiAgICB9CgogICAgZG9uZUh0bWwgKz0gJzxoMj5VcGxvYWRlZCBGaWxlczwvaDI+JzsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEZpbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb3Muc2hvd0h0bWwoYFVwbG9hZGluZyAke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX0uLi5gKTsKICAgICAgICAKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1cGxvYWRGaWxlKHsKICAgICAgICAgICAgZmlsZTogc2VsZWN0ZWRGaWxlc1tpXSwKICAgICAgICAgICAgcmVjb3JkS2V5LAogICAgICAgICAgICBvblByb2dyZXNzOiAoZmlsZVByb2dyZXNzKSA9PiB7CiAgICAgICAgICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSAke01hdGguY2VpbChmaWxlUHJvZ3Jlc3MgKiAxMDApfSVgKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGlmIChyZXN1bHQudXJsKSB7CiAgICAgICAgICAgIGRvbmVIdG1sICs9IGA8YSBocmVmPSIke3Jlc3VsdC51cmx9IiB0YXJnZXQ9Il9ibGFuayI+JHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9PC9hPjwvYnI+YDsKICAgICAgICB9CgogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSByZXN1bHQ6YCwgcmVzdWx0KTsKICAgIH0KCiAgICBvcy5zaG93SHRtbChkb25lSHRtbCk7Cn0nAMOyx7kC9u4JDmNtZERvd25sb2FkRWdnAgQAw7LHuQLTmQz5C0Bjb25zdCByZWNvcmRLZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5LCB7CiAgICB0aXRsZTogJ3JlY29yZCB0byBsb29rdXAgZWdnIGluJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXk6YCwgcmVjb3JkS2V5KTsKCmlmICghcmVjb3JkS2V5KSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ1JlY29yZEtleSA9IHJlY29yZEtleTsKCmNvbnN0IGVnZ05hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnTmFtZSwgewogICAgdGl0bGU6ICduYW1lIG9mIGVnZycsCiAgICB0eXBlOiAndGV4dCcsCn0pCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTmFtZTpgLCBlZ2dOYW1lKTsKCmlmICghZWdnTmFtZSkgewogICAgcmV0dXJuOwp9CgptYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lID0gZWdnTmFtZTsKCmNvbnN0IGVnZyA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICBhYklEOiBlZ2dOYW1lLAogICAgcmVjb3JkS2V5LAogICAgcmV0dXJuVHlwZTogJ2VnZycKfSkKCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnOmAsIGVnZyk7CgppZiAoIUFycmF5LmlzQXJyYXkoZWdnLmVnZ1ZlcnNpb25IaXN0b3J5KSB8fCBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBEYXRhIGZvdW5kIGF0IGFkZHJlc3MgJyR7ZWdnTmFtZX0nIGluIHJlY29yZCAnJHtyZWNvcmRLZXl9JyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYW4gZWdnLmApCiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgZWdnVmVyc2lvbk9wdGlvbnMgPSBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubWFwKChpdGVtLCBpbmRleCkgPT4gewogICAgcmV0dXJuIHsgbGFiZWw6IGB2ZXJzaW9uICR7aW5kZXggKyAxfWAsIHZhbHVlOiBpbmRleCB9Cn0pCgpjb25zdCBzZWxlY3RlZFZlcnNpb25PcHRpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQoZWdnVmVyc2lvbk9wdGlvbnMubGVuZ3RoIC0gMSwgewogICAgdGl0bGU6ICdkb3dubG9hZCBlZ2cgdmVyc2lvbicsCiAgICB0eXBlOiAnbGlzdCcsCiAgICBzdWJ0eXBlOiAnc2VsZWN0JywKICAgIGl0ZW1zOiBlZ2dWZXJzaW9uT3B0aW9ucywKfSkKCmlmICghc2VsZWN0ZWRWZXJzaW9uT3B0aW9uKSB7CiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgYXV4RGF0YVVybCA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeVtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWVdOwpjb25zdCBhdXhEYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShhdXhEYXRhVXJsKTsKY29uc3QgYXV4RmlsZW5hbWUgPSBgJHtlZ2dOYW1lfV92JHtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWUgKyAxfS5hdXhgOwoKb3MuZG93bmxvYWQoYXV4RGF0YSwgYXV4RmlsZW5hbWUsICdhcHBsaWNhdGlvbi9qc29uJyk7JwDDsse5AvbuCQ9jbWREb3dubG9hZEluc3QCBADDsse5As2lDIUBQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3QgYm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKb3MuZG93bmxvYWRCb3RzKGJvdHMsIG9zLmdldEN1cnJlbnRJbnN0KCkpOycAw7LHuQL27gkGc2VhcmNoAgQAw7LHuQLTpgwo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAw7LHuQL27gkFdXRpbHMCBADDsse5AvqmDCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDDsse5AvbuCQljbWRTeXN0ZW0CBADDsse5AqGnDJEHQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3Qgc2FtZVdpbmRvdyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnRmxhZyhhcmdzLCAnLXcnKTsKCmxldCBzeXN0ZW1UYWdOYW1lID0gbnVsbDsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgc3lzdGVtVGFnTmFtZSA9IGFyZ3Muam9pbignICcpOwp9CgppZiAoc2FtZVdpbmRvdykgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4KICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVBvcnRhbCA9IHRydWU7CiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1UYWdOYW1lID0gc3lzdGVtVGFnTmFtZTsKfSBlbHNlIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiBhIG5ldyB0YWIuCiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCk7CgogICAgLy8gUmVtb3ZlIGFueSBwb3J0YWxzIHRoYXQgYXJlIHNldCBpbiB0aGUgVVJMLgogICAgbGV0IHBhcmFtcyA9IHVybC5zZWFyY2hQYXJhbXMua2V5cygpOwogICAgZm9yIChsZXQgcGFyYW0gb2YgcGFyYW1zKSB7CiAgICAgICAgaWYgKHBhcmFtLmVuZHNXaXRoKCdQb3J0YWwnKSkgewogICAgICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZShwYXJhbSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIFR1cm4gb24gdGhlIHN5c3RlbSBwb3J0YWwuCiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtUG9ydGFsJywgJ3RydWUnKTsKICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCdzeXN0ZW1UYWdOYW1lJyk7CgogICAgaWYgKHN5c3RlbVRhZ05hbWUpIHsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtVGFnTmFtZScsIHN5c3RlbVRhZ05hbWUpOwogICAgfQoKICAgIG9zLm9wZW5VUkwodXJsLmhyZWYpOwp9CicAw7LHuQL27gkNYWJDaGF0QmFyT3BlbgIEAMOyx7kCs64MowJAY29uc3QgewogICAgcHJlZmlsbCwKfSA9IHRoYXQgPz8ge30KCm1hc2tzLmNoYXRPcGVuID0gdHJ1ZTsKCm9zLnNob3dDaGF0KHsKICAgIHBsYWNlaG9sZGVyOiAnPiAuaGVscCB0byBzZWUgYXZhaWxhYmxlIGNvbW1hbmRzJywKICAgIGJhY2tncm91bmRDb2xvcjogJyMyZjJmMmYnLAogICAgZm9yZWdyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcGxhY2Vob2xkZXJDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHByZWZpbGwKfSknAMOyx7kC9u4JDmFiQ2hhdEJhckNsb3NlAgQAw7LHuQLXsAx2QG1hc2tzLmNoYXRPcGVuID0gZmFsc2U7Cm9zLmhpZGVDaGF0KCk7CgovLyBHaXZlIENhc3VhbE9TIGEgY2hhbmdlIHRvIGFjdHVhbGx5IHJlbW92ZSB0aGUgY2hhdCBiYXIuCmF3YWl0IG9zLnNsZWVwKDApOycAw7LHuQL27gkLcGVyc29uYWxpdHkCBADDsse5As6xDCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDDsse5AvbuCQV0eXBlcwIEAMOyx7kC9bEM8gLwn5OEdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9JwDDsse5AvbuCRF2aWV3UmVjb3JkRGF0YUFwcAIEAMOyx7kC5rQMKPCflJc5MmZmNmQyOC0zMzUxLTRjZmItODQ2NC05ZDdjNjE0MjdhMjYnAMOyx7kC9u4JEWNtZERvd25sb2FkU3lzdGVtAgQAw7LHuQKNtQyGBkBjb25zdCBhcmdzID0gdGhhdDsKCmlmICghYXJncyB8fCBhcmdzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICdNdXN0IHByb3ZpZGUgc3lzdGVtIG5hbWUocykgdG8gZG93bmxvYWQuJywgbG9nVHlwZTogJ2Vycm9yJyB9KQogICAgcmV0dXJuOwp9Cgpjb25zdCBzeXN0ZW1OYW1lcyA9IGFyZ3M7Cgpmb3IgKGNvbnN0IHN5c3RlbU5hbWUgb2Ygc3lzdGVtTmFtZXMpIHsKICAgIGNvbnN0IHN5c3RlbU5hbWVQYXJ0cyA9IHN5c3RlbU5hbWUuc3BsaXQoJy4nKTsKCiAgICBjb25zdCBzeXN0ZW1Cb3RzID0gZ2V0Qm90cygoYikgPT4gewogICAgICAgIGlmIChiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5zeXN0ZW0pIHsKICAgICAgICAgICAgY29uc3Qgc3lzdGVtVGFnUGFydHMgPSBiLnRhZ3Muc3lzdGVtLnNwbGl0KCcuJyk7CiAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gc3lzdGVtTmFtZVBhcnRzLmV2ZXJ5KChzeXN0ZW1OYW1lUGFydCwgaW5kZXgpID0+IHN5c3RlbVRhZ1BhcnRzW2luZGV4XSA9PT0gc3lzdGVtTmFtZVBhcnQpOwogICAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfQogICAgfSk7CgogICAgaWYgKHN5c3RlbUJvdHMgJiYgc3lzdGVtQm90cy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9IGAke3N5c3RlbU5hbWV9LmF1eGA7CiAgICAgICAgb3MuZG93bmxvYWRCb3RzKHN5c3RlbUJvdHMsIGZpbGVuYW1lKTsKICAgIH0KfScAw7LHuQL27gkNY21kUHVibGlzaEFzawIEAMOyx7kClLsMoQ9AY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBhc2tJRCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1hc2snKTsKY29uc3QgcGF0dGVybklEID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXBhdHRlcm4nKTsKbGV0IHN0dWRpb0lEID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXN0dWRpbycpOwoKaWYgKCFhc2tJRCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGAtYXNrIGlzIGEgcmVxdWlyZWQgYXJndW1lbnRgLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCmlmICghcGF0dGVybklEKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYC1wYXR0ZXJuIGlzIGEgcmVxdWlyZWQgYXJndW1lbnRgLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCmlmICghc3R1ZGlvSUQpIHsKICAgIGlmIChhdXRoQm90KSB7CiAgICAgICAgc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEVpdGhlciBwcm92aWRlIGEgc3R1ZGlvIG9yIGxvZ2luIHRvIHVzZSB5b3VyIHBlcnNvbmFsIHN0dWRpbyBmb3IgdGhlIGFzay5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICAgICAgcmV0dXJuOwogICAgfQp9CgpsZXQgcHVibGlzaFJlc3VsdDsKCnRyeSB7CiAgICBwdWJsaXNoUmVzdWx0ID0gYXdhaXQgbGlua3Muc3RvcmUuYWJQdWJsaXNoQXNrSUQoeyBhc2tJRCwgcGF0dGVybklELCBzdHVkaW9JRCB9KTsKfSBjYXRjaCAoZSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gcHVibGlzaCBhc2sgJyR7YXNrSUR9Jy4gJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgppZiAocHVibGlzaFJlc3VsdC5zdWNjZXNzKSB7CiAgICAvLyBOZWVkIHRvIHVzZSBjb25maWdCb3Qgc3R1ZGlvIHRhZyBmb3IgbG9va3VwLgogICAgY29uZmlnQm90Lm1hc2tzLnN0dWRpbyA9IHN0dWRpb0lEOwogICAgYXdhaXQgb3Muc2xlZXAoMCk7CiAgICAKICAgIHRyeSB7CiAgICAgICAgY29uc3QgbG9va3VwQXNrUmVzdWx0ID0gYXdhaXQgbGlua3Muc2VhcmNoLmxvb2t1cEZyb21TdHVkaW8oeyBhc2tJRCwgZGF0YU9ubHk6IHRydWUgfSk7CgogICAgICAgIGlmIChsb29rdXBBc2tSZXN1bHQuc3VjY2VzcyAmJiBsb29rdXBBc2tSZXN1bHQuZGF0YSkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFB1Ymxpc2hlZCBhc2sgJyR7YXNrSUR9Jy4gJHtKU09OLnN0cmluZ2lmeShsb29rdXBBc2tSZXN1bHQuZGF0YSwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnbG9nJ30pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIGxvb2t1cCBhc2sgJyR7YXNrSUR9JyBpbiBzdHVkaW8gJyR7c3R1ZGlvSUR9Jy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIGxvb2t1cCBhc2sgJyR7YXNrSUR9JyBpbiBzdHVkaW8gJyR7c3R1ZGlvSUR9Jy4gJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgfQoKICAgIGNvbmZpZ0JvdC5tYXNrcy5zdHVkaW8gPSBudWxsOwp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gcHVibGlzaCBhc2sgJyR7YXNrSUR9Jy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCgoA"}]}