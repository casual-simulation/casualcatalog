{"version":2,"updates":[{"id":0,"timestamp":1753722829331,"update":"Ab0DkZClLgAnAQRib3RzJDAyODM2NWE0LTAzNmYtNDFkMC05YWYxLTcxNWFkNGYyYWE3YQEnAJGQpS4ABnN5c3RlbQIEAJGQpS4BDWFiLnNoZWxsLmdyaWQnAJGQpS4ABGZvcm0CBACRkKUuDwdub3RoaW5nJwCRkKUuAAxvbkFueUJvdERyYWcCBACRkKUuF7sBQC8vY29udHJvbHMgZ3JpZCBzbmFwCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZFNuYXBTdGF0ZSkKewogICAgb3MuYWRkRHJvcFNuYXAoImdyaWQiKTsKfQoKLy9jb250cm9scyBib3Qgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkJvdFNuYXBTdGF0ZSkKewogICAgb3MuYWRkRHJvcFNuYXAoImZhY2UiKTsKfScAkZClLgAIcmVtZW1iZXICBACRkKUu0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAkZClLgAIYWJJZ25vcmUCBACRkKUu+gEEdHJ1ZScAkZClLgAHYWJTaGVsbAIEAJGQpS7/AQR0cnVlJwCRkKUuAAlhYlZlcnNpb24CBACRkKUuhAIEMTAuNScAkZClLgAFZm9jdXMCBACRkKUuiQKsBEAvL3Nob3V0KCJmb2N1cyIsIHtib3Q6IGJvdCwgcG9zaXRpb246e3g6IHgsIHk6IHl9fSk7Cgpjb25zdCBmb2N1c1R5cGUgPSB0aGF0LmJvdCA/ICJib3QiIDogInBvc2l0aW9uIjsKY29uc3QgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uOwpjb25zdCB6b29tID0gdGhhdC56b29tID8/IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IDIwMDAgOiAxMDsKY29uc3Qgcm90YXRpb24gPSB0aGF0LnJvdGF0aW9uID8/IHt4OiA0NSwgeTogNDV9Owpjb25zdCBlYXNpbmcgPSB0aGF0LmVhc2luZyA/PyB7dHlwZTogImxpbmVhciIsIG1vZGU6ICJpbm91dCJ9Owpjb25zdCBmb2N1c09wdGlvbnMgPSB7CiAgICB6b29tOiB6b29tLAogICAgcm90YXRpb246IHJvdGF0aW9uLAogICAgZWFzaW5nOiBlYXNpbmcsCiAgICBkdXJhdGlvbjogZHVyYXRpb24KfTsKCmlmIChmb2N1c1R5cGUgPT0gImJvdCIpCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5ib3QsIGZvY3VzT3B0aW9ucyk7Cn0KZWxzZQp7CiAgICBhd2FpdCBvcy5mb2N1c09uKHRoYXQucG9zaXRpb24sIGZvY3VzT3B0aW9ucyk7Cn0nAQRib3RzJDExYzk1YzdkLWExOTMtNDAwZS1iNzEwLTNiYTA0ODZhNmExYQEnAJGQpS62BgZzeXN0ZW0CBACRkKUutwYTYWIuc2hlbGwuY29tcG9uZW50cycAkZClLrYGDEFwcENvbnRhaW5lcgIEAJGQpS7LBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycAkZClLrYGCFRleHRMaW5rAgQAkZClLvgKowNAY29uc3QgVGV4dExpbmsgPSAoewogICAgb25DbGljaywKICAgIGNoaWxkcmVuLAp9KSA9PiB7CiAgICByZXR1cm4gKAogICAgICAgIDxzcGFuIAogICAgICAgICAgICBjbGFzc05hbWU9J2FiLWFwcC10ZXh0LWxpbmsgYm9sZCcgCiAgICAgICAgICAgIG9uQ2xpY2s9e29uQ2xpY2t9CiAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAnLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yJzogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstaG92ZXItY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmx1ZXByaW50Q29sb3IKICAgICAgICAgICAgfX0KICAgICAgICA+e2NoaWxkcmVufTwvc3Bhbj4KICAgICkKfQoKcmV0dXJuIFRleHRMaW5rOycAkZClLrYGBldpbmRvdwIEAJGQpS6cDrYCQGNvbnN0IFdpbmRvdyA9ICh7CiAgICBpZCwKICAgIGRpc2FibGVTaGFkb3csCiAgICBjaGlsZHJlbiwKfSkgPT4gewoKICAgIGxldCB3aW5kb3dDbGFzc05hbWUgPSAnYWItYXBwLXdpbmRvdyc7CgogICAgaWYgKGRpc2FibGVTaGFkb3cpIHsKICAgICAgICB3aW5kb3dDbGFzc05hbWUgKz0gJyBuby1zaGFkb3cnOwogICAgfQoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17aWR9IGNsYXNzTmFtZT17d2luZG93Q2xhc3NOYW1lfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gV2luZG93OycAkZClLrYGDFRleHRMaW5rLmNzcwIEAJGQpS7TEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwCRkKUutgYVQmFja2dyb3VuZE92ZXJsYXkuY3NzAgQAkZClLsEScS5hYi1hcHAtYmcgewogICAgcG9zaXRpb246IGZpeGVkOwogICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjMzKTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwp9JwCRkKUutgYKV2luZG93LmNzcwIEAJGQpS6zE6gDLmFiLWFwcC13aW5kb3cgewogICAgcG9zaXRpb246IGZpeGVkOwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIGJhY2tncm91bmQtY29sb3I6ICMyZjJmMmY7CiAgICB3aWR0aDogODB2dzsKICAgIGhlaWdodDogNzB2aDsKICAgIG1heC13aWR0aDogMTUwMHB4OwogICAgbWF4LWhlaWdodDogMTAwMHB4OwogICAgbGVmdDogNTAlOwogICAgdG9wOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDBweCAwcHggMTJweCAwcHggYmxhY2s7CiAgICBvdmVyZmxvdzogYXV0bzsKICAgIHBhZGRpbmctbGVmdDogOHB4OwogICAgcGFkZGluZy1yaWdodDogOHB4Owp9CgouYWItYXBwLXdpbmRvdy5uby1zaGFkb3cgewogICAgYm94LXNoYWRvdzogbm9uZTsKfScAkZClLrYGCHJlbWVtYmVyAgQAkZClLtwWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJGQpS62BghhYklnbm9yZQIEAJGQpS6DFwR0cnVlJwCRkKUutgYHYWJTaGVsbAIEAJGQpS6IFwR0cnVlJwCRkKUutgYJYWJWZXJzaW9uAgQAkZClLo0XBDEwLjUnAJGQpS62BgtwZXJzb25hbGl0eQIEAJGQpS6SFyjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwEEYm90cyQyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWIBJwCRkKUuuRcHQXBwLmNzcwIEAJGQpS66F7EWOnJvb3QgewogIC0tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICAtLW9uLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgLS1hYi1jb25zb2xlLWhlaWdodDogMzN2aDsKfQovKiBEYXJrIG1vZGUgc3VwcG9ydCAqLwpAbWVkaWEgKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKSB7CiAgOnJvb3QgewogICAgLS1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogICAgLS1vbi1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIH0KfQoKLmFiLWNvbnNvbGUtYnRuIHsKICBjdXJzb3I6IHBvaW50ZXI7CiAgY29sb3I6IGluaGVyaXQ7CiAgbGV0dGVyLXNwYWNpbmc6IGluaGVyaXQ7CiAgbGluZS1oZWlnaHQ6IGluaGVyaXQ7CiAgdGV4dC10cmFuc2Zvcm06IGluaGVyaXQ7CiAgdGV4dC1pbmRlbnQ6IGluaGVyaXQ7CiAgdGV4dC1zaGFkb3c6IGluaGVyaXQ7CiAgYmFja2dyb3VuZC1jb2xvcjogaW5oZXJpdDsKICBtYXJnaW46IGluaGVyaXQ7CiAgcGFkZGluZy1ibG9jazogaW5oZXJpdDsKICBwYWRkaW5nLWlubGluZTogaW5oZXJpdDsKICBib3JkZXI6IG5vbmU7CiAgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOwp9CgouYWItY29uc29sZSB7CiAgd2lkdGg6IDEwMHZ3OwogIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgcGFkZGluZzogMDsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpIGJyaWdodG5lc3MoMjAwJSk7CiAgYW5pbWF0aW9uLW5hbWU6IHNsaWRlLWFwcC1pbjsKICBhbmltYXRpb24tZHVyYXRpb246IDAuNXM7CiAgb3ZlcmZsb3cteTogaGlkZGVuOwogIHotaW5kZXg6IDE7Cn0KCi5hYi1jb25zb2xlOjphZnRlciB7CiAgY29udGVudDogIiI7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgcG9zaXRpb246IGFic29sdXRlOwogIHRvcDogMDsKICBsZWZ0OiAwOwogIHJpZ2h0OiAwOwogIGJvdHRvbTogMDsKICBvcGFjaXR5OiAwLjk7CiAgei1pbmRleDogMDsKfQoKQGtleWZyYW1lcyBzbGlkZS1hcHAtaW4gewogIGZyb20gewogICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogY3ViaWMtYmV6aWVyKC42LDAsLjc5LDEuMDMpOwogICAgLyogdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDExMCUpOyAqLwogICAgLyogaGVpZ2h0OiAwcHg7ICovCiAgICAvKiBtaW4taGVpZ2h0OiAwcHg7ICovCiAgICBtYXgtaGVpZ2h0OiAwcHg7CiAgfQoKICB0byB7CiAgICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgICAvKiBtaW4taGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7ICovCiAgfQp9CgouYWItY29uc29sZSA+IGRpdiB7CiAgei1pbmRleDogMTsKICBwb3NpdGlvbjogcmVsYXRpdmUKfQoKLmFiLWNvbnNvbGUtdG9wLWJhciB7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgd2lkdGg6IDEwMCU7CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIHVzZXItc2VsZWN0OiBub25lOwogIGRpc3BsYXk6IGZsZXg7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBqdXN0aWZ5LWNvbnRlbnQ6IGVuZDsKICBwYWRkaW5nOiAwLjVyZW07Cn0KCi5hYi1jb25zb2xlLWxvZyB7CiAgb3ZlcmZsb3cteTogYXV0bzsKICBmbGV4LWdyb3c6IDE7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uLXJldmVyc2U7CiAgbWluLWhlaWdodDogMjRweDsKICBwYWRkaW5nOiAwIDFyZW07CiAgY3Vyc29yOiBwb2ludGVyOwogIG92ZXJzY3JvbGwtYmVoYXZpb3I6IGNvbnRhaW47Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIGN1cnNvcjogaW5pdGlhbDsKfQoKLmFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIgewogIG1hcmdpbjogMC41cmVtIDA7Cn0KLmFiLWNvbnNvbGUtbWVzc2FnZSB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgZ2FwOiA4cHg7Cn0KCi5hYi1jb25zb2xlLXNwYWNlciB7CiAgZmxleC1zaHJpbms6IDA7CiAgZmxleC1ncm93OiAxOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBtYXgtd2lkdGg6IDgwdnc7CiAgYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgcGFkZGluZzogMC41cmVtIDFyZW07Cn0KCi5hYi1jb25zb2xlLXRpbWVzdGFtcCB7CiAgb3BhY2l0eTogMC42Owp9CgouY29uc29sZS1zZW5kLWJ0biB7CiAgbWFyZ2luOiAwICFpbXBvcnRhbnQ7CiAgcGFkZGluZzogMCAxcmVtICFpbXBvcnRhbnQ7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9CgouY29uc29sZS1zZW5kLWJ0biA+IHNwYW4gewogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgzcHgpCn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGdhcDogMC43NXJlbTsKICBtYXJnaW46IDAuNXJlbSAxcmVtOwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciA+IGlucHV0IHsKICBiYWNrZ3JvdW5kOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgZmxleC1ncm93OiAxOwogIG91dGxpbmU6IG5vbmU7CiAgYm9yZGVyOiBub25lOwogIHBhZGRpbmc6IDFyZW07CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9JwCRkKUuuRcGZ2V0QXBwAgQAkZClLuwt3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwCRkKUuuRcLaGlkZUNvbnNvbGUCBACRkKUuylGfAUB2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwptYXNrcy5vcGVuID0gZmFsc2U7CmdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSBudWxsOycAkZClLrkXA2xvZwIEAJGQpS7qUuQIQGxldCBib3RUYWdzID0ge307Cgpjb25zdCBfdGltZXN0YW1wID0gb3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZQoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgY29uc3QgX21lc3NhZ2VUZXh0ID0gU3RyaW5nKHRoYXQpLnNwbGl0KCc6ICcpOwogICAgY29uc3QgX25hbWUgPSBfbWVzc2FnZVRleHQuc2hpZnQoKTsKCiAgICBpZiAoIXRoYXQuaW5jbHVkZXMoJzogJykpIHsKICAgICAgICBib3RUYWdzID0gewogICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgIG5hbWU6ICIiLAogICAgICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiBfbmFtZSwKICAgICAgICAgICAgbWVzc2FnZTogX21lc3NhZ2VUZXh0LmpvaW4oJzogJyksCiAgICAgICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICAgICAgdGltZXN0YW1wOiBfdGltZXN0YW1wLAogICAgICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiCiAgICAgICAgfQogICAgfQoKfSBlbHNlIHsKICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiLAogICAgICAgIC4uLnRoYXQKICAgIH0KfQoKY29uc3QgbG9nQm90ID0gY3JlYXRlKGJvdFRhZ3MpOwoKaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAJGQpS65FwtzaG93Q29uc29sZQIEAJGQpS7PW+0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAkZClLrkXBnN5c3RlbQIEAJGQpS69XxBhYi5zaGVsbC5jb25zb2xlJwCRkKUuuRcNdG9nZ2xlQ29uc29sZQIEAJGQpS7OX5YBQGlmIChtYXNrcy5vcGVuKSB7CiAgICB3aGlzcGVyKHRoaXNCb3QsICJoaWRlQ29uc29sZSIpOwogICAgbWFza3Mub3BlbiA9IGZhbHNlOwp9IGVsc2UgewogICAgd2hpc3Blcih0aGlzQm90LCAic2hvd0NvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSB0cnVlOwp9JwCRkKUuuRcEZm9ybQIEAJGQpS7lYAdub3RoaW5nJwCRkKUuuRcHYWJTaGVsbAIEAJGQpS7tYAR0cnVlJwCRkKUuuRcKYWJJRE9yaWdpbgIEAJGQpS7yYBVhYkNvbnNvbGUgdXBkYXRlIDctMTYnAJGQpS65FwZUb3BCYXICBACRkKUuiGHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAkZClLrkXDXNob3dDaGF0SW5wdXQCBACRkKUu/GUFZmFsc2UnAJGQpS65FwpzaG93VG9wQmFyAgQAkZClLoJmBWZhbHNlJwCRkKUuuRcJYWJWZXJzaW9uAgQAkZClLohmBDEwLjUnAJGQpS65FxJzZXRBYkV4cGFuZENvbnNvbGUCBACRkKUujWaXAkBjb25zb2xlLmxvZyh0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCkKaWYgKHR5cGVvZiB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuOwp9CgppZiAodGhhdCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChzID0+ICFzKTsKfSBlbHNlIGlmICh0aGF0ID09IHRydWUpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHRydWUpOwp9IGVsc2UgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwoZmFsc2UpOwp9CicAkZClLrkXCGFiSWdub3JlAgQAkZClLqVoBHRydWUnAJGQpS65FwdNZXNzYWdlAgQAkZClLqpo5xBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPgogICAgICAgICAgICAgICAgICAgIHttZXNzYWdlfQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gTWVzc2FnZTsnAJGQpS65FxBvbkFueUJvdHNSZW1vdmVkAgQAkZClLpJ5rQJAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90SWQgb2YgYm90SURzKSB7DQogICAgaWYgKHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5kZWxldGUoYm90SWQpOw0KDQogICAgICAgIGlmIChkZWxldGVkKSB7DQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3RJZDogYm90SWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9JwCRkKUuuRcOb25BbnlCb3RzQWRkZWQCBACRkKUuwHv4A0Bjb25zdCB7IGJvdHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgbmV3Qm90IG9mIGJvdHMpIHsNCiAgICBpZiAobmV3Qm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKG5ld0JvdC5pZCkpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmFkZChuZXdCb3QuaWQpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBuZXdCb3QgfSk7DQogICAgfQ0KfScAkZClLrkXEG9uQW55Qm90c0NoYW5nZWQCBACRkKUuuX/jBUBjb25zdCBib3RzID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3Qgb2YgYm90cykgew0KICAgIGlmIChib3QuYm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKGJvdC5ib3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQoYm90LmJvdC5pZCk7DQoNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IGJvdC5ib3QgfSk7DQogICAgICAgIH0gDQoNCiAgICAgICAgaWYgKGJvdC50YWdzLmluY2x1ZGVzKCJtZXNzYWdlIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoIm5hbWUiKSB8fCBib3QudGFncy5pbmNsdWRlcygidGltZXN0YW1wIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoImNvbnNvbGVMb2dNZXNzYWdlQm90IikpIHsNCiAgICAgICAgICAgIGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7ICAgICAgICANCiAgICAgICAgfQ0KICAgIH0NCn0nAJGQpS65Fx9vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkAgQAkZClLp2FATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAJGQpS65Fx1vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZAIEAJGQpS7UhQE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwEEYm90cyQyNGRjMDQzMS1mZmJiLTQ0OGQtYWE3NS05NzFiYWEwNzE4ZGMBJwCRkKUui4YBBnN5c3RlbQIEAJGQpS6MhgENYWIuc2hlbGwuaGVscCcAkZClLouGAQlvbktleURvd24CBACRkKUumoYBjAJAaWYgKHRhZ3MuaGVscEFjdGl2ZSAmJiB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICBmb3IgKGxldCBjYWxsYmFjayBvZiB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9JwCRkKUui4YBB3VubW91bnQCBACRkKUup4gBoAFAYXdhaXQgb3MuY29tcGlsZUFwcCgnYWItY29tbWFuZC1oZWxwJywgPD48Lz4pOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKCdhYi1jb21tYW5kLWhlbHAnKTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gdW5kZWZpbmVkOwptYXNrcy5oZWxwQWN0aXZlID0gZmFsc2U7JwCRkKUui4YBCXN0eWxlLmNzcwIEAJGQpS7IiQHxBy5oZWxwLXRhYmxlIHsKICB3aWR0aDogMTAwJTsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLmhlbHAtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5oZWxwLXRhYmxlIHRkIGgzIHsKICBtYXJnaW46IDA7Cn0KCi5oZWxwLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9Cgouc2VjdGlvbiB7CiAgbWFyZ2luLXRvcDogMTZweDsKfQoKLnNlY3Rpb24gcDpmaXJzdC1vZi10eXBlIHsKICBtYXJnaW4tdG9wOiA0cHg7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5kZXNjcmlwdGlvbiB7IAogIHdoaXRlLXNwYWNlOiBwcmUtbGluZTsKfQoKLnVzYWdlLXRhYmxlIHsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLnVzYWdlLXRhYmxlIHRkLGgzIHsgCiAgdmVydGljYWwtYWxpZ246IHRvcDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgbWFyZ2luOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogNjBweDsKfQoKLmFyZ3MtdGFibGUgewogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouYXJncy10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmFyZ3MtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCksIChtYXgtaGVpZ2h0OiA2MDBweCkgewogIC5oZWxwLXdpbmRvdyB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGxlZnQ6IHVuc2V0OwogICAgdG9wOiB1bnNldDsKICAgIHRyYW5zZm9ybTogdW5zZXQ7CiAgICBtYXgtd2lkdGg6IHVuc2V0OwogICAgbWF4LWhlaWdodDogdW5zZXQ7CiAgICBib3gtc2hhZG93OiB1bnNldDsKICB9Cn0nAJGQpS6LhgEJb25EZXN0cm95AgQAkZClLrqRARNAdGhpc0JvdC51bm1vdW50KCk7JwCRkKUui4YBBW1vdW50AgQAkZClLs6RAZMDQGNvbnN0IHsKICAgIGFiQ29tbWFuZHNNYW5hZ2VyLAogICAgc2VsZWN0ZWRDb21tYW5kCn0gPSB0aGF0ID8/IHt9OwoKaWYgKG1hc2tzLmhlbHBBY3RpdmUpIHsKICAgIGF3YWl0IHRoaXNCb3QudW5tb3VudCgpOwp9Cgpjb25zdCBIZWxwQXBwID0gdGhpc0JvdC5IZWxwQXBwKCk7Cgphd2FpdCBvcy5yZWdpc3RlckFwcCgnYWItY29tbWFuZC1oZWxwJywgdGhpc0JvdCk7CmF3YWl0IG9zLmNvbXBpbGVBcHAoJ2FiLWNvbW1hbmQtaGVscCcsIDxIZWxwQXBwIGNvbW1hbmRzPXthYkNvbW1hbmRzTWFuYWdlci5jb21tYW5kc30gaW5pdGlhbFNlbGVjdGVkQ29tbWFuZD17c2VsZWN0ZWRDb21tYW5kfS8+KTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gW107Cm1hc2tzLmhlbHBBY3RpdmUgPSB0cnVlOycAkZClLouGAQdIZWxwQXBwAgQAkZClLuKUAbovQGNvbnN0IEFwcENvbnRhaW5lciA9IGxpbmtzLmNvbXBvbmVudHMuQXBwQ29udGFpbmVyKCk7CmNvbnN0IFdpbmRvdyA9IGxpbmtzLmNvbXBvbmVudHMuV2luZG93KCk7CmNvbnN0IFRleHRMaW5rID0gbGlua3MuY29tcG9uZW50cy5UZXh0TGluaygpOwpjb25zdCBjc3MgPSBsaW5rcy51dGlscy5hYkNvbXBpbGVDU1MoWyB0aGlzQm90LCBsaW5rcy5jb21wb25lbnRzIF0pOwoKY29uc3QgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlUmVmLCB1c2VNZW1vIH0gPSBvcy5hcHBIb29rczsKCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqLwpjb25zdCBBdmFpbGFibGVDb21tYW5kcyA9ICh7IGNvbW1hbmRzLCBvbkNvbW1hbmRDbGljayB9KSA9PiB7CiAgICBjb25zdCBjb21tYW5kTmFtZXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcykuc29ydCgpOwoKICAgIGNvbnN0IG9uQ2xvc2UgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQ2xvc2V9PnsneCBDbG9zZSd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj5BdmFpbGFibGUgQ29tbWFuZHM8L2gyPgogICAgICAgICAgICA8cD5Vc2FnZTogLmNvbW1hbmQgW29wdGlvbnNdPC9wPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgICAgIHtjb21tYW5kTmFtZXMubWFwKChuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRzW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PFRleHRMaW5rIG9uQ2xpY2s9eygpID0+IG9uQ29tbWFuZENsaWNrKGNvbW1hbmQubmFtZSl9Pntjb21tYW5kLm5hbWV9PC9UZXh0TGluaz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntkZXNjcmlwdGlvbn08L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7Q29tbWFuZH0gcHJvcHMuY29tbWFuZAogKi8KY29uc3QgU3BlY2lmaWNDb21tYW5kID0gKHsgY29tbWFuZCwgb25CYWNrIH0pID0+IHsKICAgIGxldCB1c2FnZSA9ICcnOwogICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKICAgIGxldCBhcmdzID0gbnVsbDsKCiAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC51c2FnZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb21tYW5kLmhlbHAudXNhZ2UpKSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZS5qb2luKCdcbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbjsKICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MgJiYgY29tbWFuZC5oZWxwLmFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhcmdzID0gY29tbWFuZC5oZWxwLmFyZ3M7CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+ICAKICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQmFja30+eyc8IEJhY2snfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+e2NvbW1hbmQubmFtZX08L2gyPgogICAgICAgICAgICB7IHVzYWdlICYmCiAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSd1c2FnZS10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGgzPlVzYWdlOjwvaDM+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2FnZX08L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgZGVzY3JpcHRpb24gJiYgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkRlc2NyaXB0aW9uOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdkZXNjcmlwdGlvbic+e2Rlc2NyaXB0aW9ufTwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgYXJncyAmJgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5Bcmd1bWVudHM6PC9oMz4KICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdhcmdzLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICAgICAgeyBhcmdzLm1hcCgoYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZy5pZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdJZGVudGlmaWVyRGlzcGxheSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyLmpvaW4oJyxcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmcuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBhcmcuZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnSWRlbnRpZmllckRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdEZXNjcmlwdGlvbkRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqIEBwYXJhbSB7YW55W119IFtwcm9wcy5hcmdzXQogKi8KY29uc3QgSGVscEFwcCA9ICh7IGNvbW1hbmRzLCBpbml0aWFsU2VsZWN0ZWRDb21tYW5kIH0pID0+IHsKICAgIGNvbnN0IFsgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmQgXSA9IHVzZVN0YXRlKGluaXRpYWxTZWxlY3RlZENvbW1hbmQpOwoKICAgIC8vIEVzY2FwZSBrZXkgcHJlc3MgZXZlbnQgaGFuZGxlcgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBjb25zdCBvbkVzY2FwZUtleVByZXNzID0gKCkgPT4gewogICAgICAgICAgICBpZiAoc2VsZWN0ZWRDb21tYW5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5wdXNoKG9uRXNjYXBlS2V5UHJlc3MpOwoKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBjb25zdCBjYWxsYmFja0luZGV4ID0gdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MuZmluZEluZGV4KChjYWxsYmFjaykgPT4gY2FsbGJhY2sgPT09IG9uRXNjYXBlS2V5UHJlc3MpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5zcGxpY2UoY2FsbGJhY2tJbmRleCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBbc2VsZWN0ZWRDb21tYW5kXSk7CiAgICAKICAgIGNvbnN0IG9uQmFja2dyb3VuZENsaWNrID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwoKICAgIGNvbnN0IG9uQ29tbWFuZENsaWNrID0gdXNlQ2FsbGJhY2soKG5hbWUpID0+IHsKICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobmFtZSk7CiAgICB9LCBbc2V0U2VsZWN0ZWRDb21tYW5kXSkKCiAgICBjb25zdCBjb250ZW50ID0gdXNlTWVtbygoKSA9PiB7CiAgICAgICAgaWYgKCFzZWxlY3RlZENvbW1hbmQpIHsKICAgICAgICAgICAgcmV0dXJuIDxBdmFpbGFibGVDb21tYW5kcyBjb21tYW5kcz17Y29tbWFuZHN9IG9uQ29tbWFuZENsaWNrPXtvbkNvbW1hbmRDbGlja30vPgogICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICByZXR1cm4gPFNwZWNpZmljQ29tbWFuZCBjb21tYW5kPXtjb21tYW5kc1tzZWxlY3RlZENvbW1hbmRdfSBvbkJhY2s9eygpID0+IHNldFNlbGVjdGVkQ29tbWFuZChudWxsKX0vPgogICAgICAgIH0KICAgIH0sIFtjb21tYW5kcywgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmRdKTsKCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxzdHlsZT57Y3NzfTwvc3R5bGU+CgogICAgICAgICAgICA8QXBwQ29udGFpbmVyIG9uQmFja2dyb3VuZENsaWNrPXtvbkJhY2tncm91bmRDbGlja30+CiAgICAgICAgICAgICAgICA8V2luZG93PgogICAgICAgICAgICAgICAgICAgIHtjb250ZW50fQogICAgICAgICAgICAgICAgPC9XaW5kb3c+CiAgICAgICAgICAgIDwvQXBwQ29udGFpbmVyPgogICAgICAgIDwvPgogICAgKQp9CgpyZXR1cm4gSGVscEFwcDsnAJGQpS6LhgEKY29tcG9uZW50cwIEAJGQpS6dxAEo8J+UlzExYzk1YzdkLWExOTMtNDAwZS1iNzEwLTNiYTA0ODZhNmExYScAkZClLouGAQV1dGlscwIEAJGQpS7ExAEo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAkZClLouGAQhhYklnbm9yZQIEAJGQpS7rxAEEdHJ1ZScAkZClLouGAQdhYlNoZWxsAgQAkZClLvDEAQR0cnVlJwCRkKUui4YBCWFiVmVyc2lvbgIEAJGQpS71xAEEMTAuNScBBGJvdHMkMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczAScAkZClLvrEAQZzeXN0ZW0CBACRkKUu+8QBD2FiLnNoZWxsLmNyZWF0ZScAkZClLvrEAQRmb3JtAgQAkZClLovFAQdub3RoaW5nJwCRkKUu+sQBC2Rlc2NyaXB0aW9uAgQAkZClLpPFAT1Cb3QgdXNlZCB0byBjcmVhdGUvbWFuaWZlc3QgYm90cyBpbnRvIGFuIGFjdHVhbCBzY2VuZS9wb3J0YWwuJwCRkKUu+sQBDGFiQ3JlYXRlQm90cwIEAJGQpS7RxQG+KEBsZXQgeyAKICAgIGluaXRpYWxCb290LCAvLyBjaGVja3MgZm9yIGluaXRpYWwgYm9vdCBib29sZWFuIChvcHRpb25hbCkKICAgIGJvdERhdGEsIC8vIGJvdHMgdG8gYmUgZ2VuZXJhdGVkCiAgICBvcmlnaW4sIC8vIHdoZXJlIGRpZCB0aGUgZGF0YSBjb21lIGZyb20gKG9wdGlvbmFsKQogICAgc3R1ZGlvLCAvLyB3aGF0IHN0dWRpbyBpcyB0aGlzIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICByZWNvcmQsIC8vIFJ5YW4gQ29vazogZG8gd2UgbmVlZCB0aGlzIGlmIHdlIGFscmVhZHkgaGF2ZSBzdHVkaW8/IChvcHRpb25hbCkKICAgIHZlcnNpb24sIC8vIHZlcnNpb24gb2YgdGhlIGRhdGEgKG9wdGlvbmFsKQogICAgZWdnUGFyYW1ldGVycywgLy8gZGF0YSB0byBwYXNzIHRvIGFsbCBjcmVhdGVkIGJvdHMgdmlhIEBvbkVnZ0hhdGNoLiAob3B0aW9uYWwpCiAgICBpZ25vcmVHcmlkRm9jdXMsIC8vIFJ5YW4gQ29vazogYWRkaW5nIHRoaXMgYXMgYW4gb3B0aW9uYWwgZmxhZy4gKG9wdGlvbmFsKQogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSB0aGUgYm90cyBhcmUgY3JlYXRlZC4gKG9wdGlvbmFsKQogICAgc291cmNlRXZlbnQsIC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbCB0byBhYkNyZWF0ZUJvdHMuIChvcHRpb25hbCkuCn0gPSB0aGF0OwoKLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZm9yIHdoZW4gYWJDcmVhdGVCb3RzIGV4cGVjdGVkICJib3RzIiBwYXJhbWV0ZXIuCmlmICghYm90RGF0YSAmJiB0aGF0LmJvdHMpIHsKICAgIGJvdERhdGEgPSB0aGF0LmJvdHM7Cn0KCmxldCBib3RDb3VudCA9IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aDsKY29uc3QgYWJHcmlkRm9jdXMgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKLy8gUnVuIHNvbWUgYWItc3BlY2lmaWMgcHJlcHJvY2Vzc2luZyBvZiBib3QgZGF0YS4KZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgZGF0YS50YWdzLmFiSURPcmlnaW4gPSBvcmlnaW47CiAgICAgICAgZGF0YS50YWdzLmFiSURTdHVkaW8gPSBzdHVkaW87CgogICAgICAgIGlmIChkYXRhLnRhZ3MuY3JlYXRvcikgewogICAgICAgICAgICBkYXRhLnRhZ3Mub2xkQ3JlYXRvciA9IGRhdGEudGFncy5jcmVhdG9yOwogICAgICAgIH0KCiAgICAgICAgLy8gUnlhbiBDb29rOiBUaGlzIHRhcmdldFBvc2l0aW9uIHN0dWZmIGlzIGFwcGFyZW50bHkgdXNlZCBmb3IgYm90IHBhc3Rpbmc/IAogICAgICAgIC8vIFRoaXMgaXMgc29tZSByZWFsbHkgY29uZnVzaW5nIGxvZ2ljIGFuZCBzaG91bGQgYmUgcmVmYWN0b3JlZCBldmVudHVhbGx5LgogICAgICAgIGlmICgoYm90Q291bnQgPCAyIHx8IGJvdENvdW50IDwgMyAmJiBib3REYXRhLmFiWFBCb3QgIT0gbnVsbCkgJiYgYWJHcmlkRm9jdXMgJiYgIWlnbm9yZUdyaWRGb2N1cykgewogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWCddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueDsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbiArICdZJ10gPSBhYkdyaWRGb2N1cy5wb3NpdGlvbi55OwogICAgICAgIH0KICAgIH0KfQoKLy8gRG8gYW5vdGhlciBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSB0aGUgYm90cyBhcmVhIGNyZWF0ZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhLCBvcmlnaW4sIHN0dWRpbywgcmVjb3JkLCB2ZXJzaW9uLCBlZ2dQYXJhbWV0ZXJzLCBpbml0aWFsQm9vdCwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZShwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlJywgcHJlcHJvY2Vzc0FyZykpOwoKaWYgKHR5cGVvZiBib3REYXRhICE9PSAnb2JqZWN0JyB8fCBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGggPT09IDApIHsKICAgIC8vIFRoZXJlIGlzbid0IGFueSBib3REYXRhIHRvIGNyZWF0ZSBmcm9tIQogICAgcmV0dXJuOwp9CgovLyBDcmVhdGUgYm90cyBmcm9tIHRoZSBib3QgZGF0YS4KbGV0IGlkTWFwID0gbmV3IE1hcCgpOwpsZXQgbmV3Qm90cyA9IFtdOwpsZXQgbmV3Qm90SWRzID0gW107Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MpIHsKICAgICAgICB0cnkgeyAKICAgICAgICAgICAgY29uc3QgbmV3Qm90ID0gY3JlYXRlKGRhdGEudGFncyk7CgogICAgICAgICAgICBpZE1hcC5zZXQoZGF0YS5pZCwgbmV3Qm90LmlkKTsKICAgICAgICAgICAgbmV3Qm90cy5wdXNoKG5ld0JvdCk7CiAgICAgICAgICAgIG5ld0JvdElkcy5wdXNoKG5ld0JvdC5pZCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGludmFsaWQgYm90YCwgZSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraXBwZWQgYm90OiBgLCBkYXRhKTsKICAgIH0KfQoKLy8gQXJyYXkgb2YgdGFnIHJlbGF0aW9uc2hpcHMgdG8gYmUgcHJlc2VydmVkCmNvbnN0IGxpbmtUYWdzID0gWyJsaW5rIiwgImNyZWF0b3IiLCAiY29uZmlnQm90IiwgImxpbmVUbyIsICJ0cmFuc2Zvcm1lciIsICJmb3JtTGlnaHRUYXJnZXQiXTsKCi8vIFRoaXMgbG9vcCBjb250YWlucyB0aGUgbG9naWMgZm9yIHByZXNlcnZpbmcgdGhlIGxpbmtUYWdzCmZvciAobGV0IG5ld0JvdCBvZiBuZXdCb3RzKSB7CiAgICBmb3IgKGxldCB0YWcgb2YgbGlua1RhZ3MpIHsKICAgICAgICBsZXQgdmFsdWUgPSBuZXdCb3QudGFnc1t0YWddOwoKICAgICAgICBpZiAodGFnID09ICJjcmVhdG9yIikgewogICAgICAgICAgICB2YWx1ZSA9IG5ld0JvdC50YWdzLm9sZENyZWF0b3I7CiAgICAgICAgICAgIG5ld0JvdC50YWdzLm9sZENyZWF0b3IgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlQm90TGlua3MobmV3Qm90LCBpZE1hcCk7CgogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGxldCBuZXdWYWx1ZSA9IHZhbHVlLm1hcChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkTWFwLmdldChpZCkgfHwgaWQ7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgbmV3SUQgPSBpZE1hcC5nZXQodmFsdWUpOwoKICAgICAgICAgICAgICAgIGlmIChuZXdJRCkgewogICAgICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld0lEOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBUb2FzdHMgZm9yIGhhdGNoZXMsIGJ1dCBvbmx5IG9uIGJ1aWxkZXIKaWYgKG9yaWdpbiAmJiB2ZXJzaW9uICYmIGNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSA9PSBudWxsICYmICFjb25maWdCb3QudGFncy5waCAmJiBidWlsZGVyVmVyc2lvbiA9PSAiYnVpbGRlciIpIHsKICAgIG9zLnRvYXN0KCJoYXRjaGVkICIgKyBvcmlnaW4gKyAiIHYiICsgdmVyc2lvbik7Cn0KCmlmIChvcmlnaW4pIHsKICAgIC8vIENyZWF0ZSBhYkVnZyBib3QgdGhhdCB0cmFja3MgY2FuIGJlIHVzZWQgdG8gdHJhY2sgd2hhdCBlZ2dzIGhhdmUgYmVlbiBoYXRjaGVkLgogICAgY3JlYXRlKHsKICAgICAgICBzcGFjZTogInNoYXJlZCIsCiAgICAgICAgYWI6IHRydWUsCiAgICAgICAgYWJFZ2c6IHRydWUsCiAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgb3JpZ2luX2FiOiBvcmlnaW4sCiAgICAgICAgb3JpZ2luX3ZlcnNpb246IHZlcnNpb24sCiAgICAgICAgb3JpZ2luX3JlY29yZDogcmVjb3JkLAogICAgICAgIG9yaWdpbl9zdHVkaW86IHN0dWRpbywKICAgICAgICBmb3JtOiAiZWdnIiwKICAgICAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICAgICAgbGFiZWw6IG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uLAogICAgfSk7Cn0KCmNvbmZpZ0JvdC50YWdzLmxhc3RFZ2dIYXRjaGVkID0gb3JpZ2luOwoKd2hpc3BlcihuZXdCb3RzLCAnb25QcmVIYXRjaCcsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKCmlmIChpbml0aWFsQm9vdCkgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBvcmlnaW47Cn0KCi8vIG9uRWdnSGF0Y2ggZm9yIGFsbCBqdXN0IGhhdGNoZWQgYm90cwp3aGlzcGVyKG5ld0JvdHMsICJvbkVnZ0hhdGNoIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIGVnZ1BhcmFtZXRlcnMsIHNvdXJjZUV2ZW50IH0pOwoKLy8gb25BYkFkZGVkIGZvciBhbGwgYm90cyBpbiB0aGUgZXhwZXJpZW5jZQpzdXBlclNob3V0KCJvbkFCQWRkZWQiLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQgfSk7CnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgpyZXR1cm4gbmV3Qm90czsnAJGQpS76xAEIcmVtZW1iZXICBACRkKUukO4BKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJGQpS76xAEIYWJJZ25vcmUCBACRkKUut+4BBHRydWUnAJGQpS76xAEHYWJTaGVsbAIEAJGQpS687gEEdHJ1ZScAkZClLvrEAQlhYlZlcnNpb24CBACRkKUuwe4BBDEwLjUnAJGQpS76xAELcGVyc29uYWxpdHkCBACRkKUuxu4BKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZgEnAJGQpS7t7gEGc3lzdGVtAgQAkZClLu7uARBhYi5zaGVsbC52ZXJzaW9uJwCRkKUu7e4BBGZvcm0CBACRkKUu/+4BB25vdGhpbmcnAJGQpS7t7gEIYWJJZ25vcmUCBACRkKUuh+8BBHRydWUnAJGQpS7t7gEHYWJTaGVsbAIEAJGQpS6M7wEEdHJ1ZScAkZClLu3uARNhYlNoZWxsTWFqb3JWZXJzaW9uAgQAkZClLpHvAQExJwCRkKUu7e4BDW9uU2tpbGxVcGRhdGUCBACRkKUuk+8BlwFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJTaGVsbE1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJTaGVsbE1pbm9yVmVyc2lvbjsNCg0KY29uc29sZS5sb2coIltBQlNoZWxsXSBMb2FkZWQgQUIgc2hlbGwgdmVyc2lvbiAiICsgdmVyc2lvblN0cmluZyk7JwCRkKUu7e4BCWFiVmVyc2lvbgIEAJGQpS6r8AEEMTAuNScAkZClLu3uARNhYlNoZWxsTWlub3JWZXJzaW9uAgQAkZClLrDwAQIxNScBBGJvdHMkNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmAScAkZClLrPwAQZzeXN0ZW0CBACRkKUutPABDmFiLnNoZWxsLnN0b3JlJwCRkKUus/ABBGZvcm0CBACRkKUuw/ABB25vdGhpbmcnAJGQpS6z8AELZGVzY3JpcHRpb24CBACRkKUuy/ABP1RoaXMgc2tpbGwgaXMgbWVhbnQgdG8gYmUgYSBjb25maWd1cmFibGUgbWVhbnMgdG8gcHVibGlzaCBkYXRhLicAkZClLrPwAQ9hYlB1Ymxpc2hSZWNvcmQCBACRkKUui/EBwAZAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBwdWJsaWNGYWNpbmcgPSB0aGF0LnB1YmxpY0ZhY2luZzsKbGV0IHJlY29yZERhdGEgPSB0aGF0LmRhdGE7CmxldCByZWNvcmROYW1lID0gdGhhdC5yZWNvcmROYW1lOwpsZXQgZW5kcG9pbnQgPSB0aGF0LmVuZHBvaW50ID8gdGhhdC5lbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKaWYgKCFyZWNvcmREYXRhKQp7CiAgICByZXR1cm4gIm5vIGRhdGEgc3VwcGxpZWQiOwp9CgppZiAocHVibGljRmFjaW5nKQp7CiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbInB1YmxpY1JlYWQiXX0pOwp9CmVsc2UKeyAgICAKICAgIHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHtlbmRwb2ludDogZW5kcG9pbnQsIG1hcmtlcnM6IFtyZWNvcmROYW1lXX0pOwp9CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRhdGEgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIHJlY29yZERhdGE7JwCRkKUus/ABDWFiUHVibGlzaEZpbGUCBACRkKUuzPcBrAdAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBmaWxlID0gdGhhdC5maWxlOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGVOYW1lOwpsZXQgbWltZVR5cGUgPSB0aGF0Lm1pbWVUeXBlOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIWZpbGUpCnsKICAgIHJldHVybiAibm8gZmlsZSBzdXBwbGllZCI7Cn0KCmxldCBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKICAgIAppZiAoIWZpbGVVcGxvYWQuc3VjY2VzcykgCnsKICAgIGlmIChmaWxlVXBsb2FkLmVycm9yQ29kZSA9PSAiZmlsZV9hbHJlYWR5X2V4aXN0cyIpCiAgICB7CiAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGFscmVhZHkgZXhpc3RzIGluICIgKyB1c2VyUmVjb3JkKTsKCiAgICAgICAgcmV0dXJuIGZpbGVVcGxvYWQ7CiAgICB9CgogICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHVzZXJSZWNvcmQpOwoKICAgIGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHtkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwp9CgppZiAoZmlsZVVwbG9hZC5zdWNjZXNzKQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIGZpbGVVcGxvYWQ7JwCRkKUus/ABEGFiQ29yZU1lbnVBY3Rpb24CBACRkKUu+f4BTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCRkKUus/ABC29uU3RvcmVNZW51AgQAkZClLsf/AdWVAUBsZXQgcG9zc2libGVQdWJsaXNoQm90ID0gbmV3IFNldCgpOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cykgewogICAgaWYgKEFycmF5LmlzQXJyYXkobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSkgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cy5mb3JFYWNoKGIgPT4gcG9zc2libGVQdWJsaXNoQm90LmFkZChiKSk7CiAgICB9IGVsc2UgewogICAgICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKTsKICAgIH0KfQoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIHsKICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyk7Cn0KCnBvc3NpYmxlUHVibGlzaEJvdCA9IEFycmF5LmZyb20ocG9zc2libGVQdWJsaXNoQm90KTsKCmNvbnN0IGJhc2VBQiA9ICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzID8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMuaWQ7CmNvbnN0IGJhc2VCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBiYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgZGVmYXVsdHMgPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIG1hbmFnZXI6ICLwn5SXIiArIHRoaXNCb3QuaWQsCiAgICBtYW5pZmVzdGF0aW9uOiB0YWdzLm1hbmlmZXN0YXRpb24sCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YAp9CgovLyBDcmVhdGUgZG93bmxvYWQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgbGFiZWw6ICJkb3dubG9hZCIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybUFkZHJlc3M6ICJnZXRfYXBwIiwKICAgIHBvc3NpYmxlQm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiRG93bmxvYWQoeyBwb3NzaWJsZUJvdHM6IGxpbmtzLnBvc3NpYmxlQm90fSk7YAp9KTsKCmlmICghYXV0aEJvdCkgCnsKICAgIC8vIENyZWF0ZSBsb2dpbiBtZXNzYWdlCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgICAgIGxhYmVsOiAicGxlYXNlIHNpZ24gaW4gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siLAogICAgICAgIG9uQ2xpY2s6IGBAIG9zLnJlcXVlc3RBdXRoQm90KClgCiAgICB9KTsKCiAgICByZXR1cm47Cn0KZWxzZSBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIgPT0gIkZyZWVQbGF5IikgCnsKICAgIC8vIENyZWF0ZSB1cGdyYWRlIHN1YnNjcmlwdGlvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInBsZWFzZSB1cGdyYWRlIHlvdXIgc3Vic2NyaXB0aW9uIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIgogICAgfSk7CgogICAgcmV0dXJuOwp9CgoKbGV0IHVzZXJTdHVkaW9zID0gY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zOwoKaWYgKCF1c2VyU3R1ZGlvcykgCnsKICAgIHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7Cn0KCmlmICh1c2VyU3R1ZGlvcy5zdWNjZXNzKSAKewogICAgY29uc3QgYWN0aXZlU3R1ZGlvID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCk7CgogICAgbGV0IGJhc2VTdHVkaW8gPSBhdXRoQm90LmlkOwoKICAgIGlmIChiYXNlU3R1ZGlvID09IGF1dGhCb3QuaWQpIAogICAgewogICAgICAgIGJhc2VTdHVkaW8gPSAicGxheWVyIjsKICAgIH0KCiAgICBpZiAoYWN0aXZlU3R1ZGlvID09IC0xICYmIGJhc2VTdHVkaW8gIT0gInBsYXllciIpIAogICAgewogICAgICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYmFzZVN0dWRpbzsKICAgIH0KCiAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICYmICFhY3RpdmVTdHVkaW8pIAogICAgewogICAgICAgIGNvbnN0IHN0dWRpb01hdGNoID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCgogICAgICAgIGlmIChzdHVkaW9NYXRjaCAhPSAtMSkgewogICAgICAgICAgICBiYXNlU3R1ZGlvID0gYmFzZVN0dWRpbzsKICAgICAgICB9CiAgICB9CgogICAgY29uc3Qgc3R1ZGlvTGFiZWwgPSBhY3RpdmVTdHVkaW8gPT0gLTEgPyBiYXNlU3R1ZGlvIDogdXNlclN0dWRpb3Muc3R1ZGlvc1thY3RpdmVTdHVkaW9dLmRpc3BsYXlOYW1lOwoKICAgIC8vIENyZWF0ZSBzdHVkaW8gc2VsZWN0IGJ1dHRvbgogICAgY29uc3Qgc3R1ZGlvRGlzcGxheUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInN0dWRpbz0iICsgc3R1ZGlvTGFiZWwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUsCiAgICAgICAgc3R1ZGlvSW5mb3JtYXRpb246IHVzZXJTdHVkaW9zLAogICAgICAgIGZvcm1BZGRyZXNzOiAiaW52ZW50b3J5XzIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuc3R1ZGlvU2VsZWN0KHRhZ3Muc3R1ZGlvSW5mb3JtYXRpb24pO2AKICAgIH0pOwoKICAgIG1hc2tzLnN0dWRpb1NlbGVjdEJ1dHRvbiA9IGdldExpbmsoc3R1ZGlvRGlzcGxheUJ1dHRvbik7Cn0KCmNvbnN0IHRvdGFsQm90Q291bnQgPSBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoID4gMCA/IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggbGFiZWwgYnV0dG9uCmNvbnN0IGxhYmVsQm90ID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBsYWJlbDogYHB1Ymxpc2ggcGF0dGVybiAke2Jhc2VCb3RzLmxlbmd0aCA+IDAgPyAiIiA6ICJhcyAifSR7YmFzZUFCfSAoJHt0b3RhbEJvdENvdW50fSBib3Qke2Jhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgdG90YWxCb3RzOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoLAogICAgYWJNZW51U29ydE9yZGVyOiAxLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgZm9ybUFkZHJlc3M6IG51bGwsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IDhweCAwcHggMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItdG9wLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgc2hpZnRTdGF0ZTogZmFsc2UsCiAgICBvbkNsaWNrOiBgQCBjb25zdCBtZW51Qm90cyA9IGdldEJvdHMoJ2FiTWVudVNvcnRPcmRlcicpOwoKICAgICAgICBpZiAodGFncy5zaGlmdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5VXAiLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleURvd24iLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRhZ3Muc2hpZnRTdGF0ZSA9ICF0YWdzLnNoaWZ0U3RhdGU7YCwKICAgIHNjYWxlWTogImF1dG8iLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgbGV0IHRvdGFsQm90cyA9IGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA/IHRoYXQuYWJCb3RzIDogdGhhdC5hYkJvdHMgKyB0aGF0Lm5vbkFCQm90czsKCiAgICBjb25zdCB0b3RhbEJvdFZhciA9IHRvdGFsQm90cyA9PSAxID8gIiBib3QiIDogIiBib3RzIjsKICAgIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzPy5sZW5ndGggID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICBpZiAoZ2V0Qm90KCJhYklET3JpZ2luIiwgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKS5sZW5ndGg7CgogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIGFiQm90cyArICIgYm90cykiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IGFiQm90czsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoIHBhdHRlcm4gYXMgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgICAgICB9ICAgCiAgICB9CiAgICBlbHNlCiAgICB7ICAgCiAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoICIgKyB0aGF0LmFiICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgfWAKfSk7CgovLyBDcmVhdGUgZW5jcnlwdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgbGFiZWw6ICJlbmNyeXB0IiwKICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgZW5jcnlwdFN0YXRlOiBmYWxzZSwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MuZW5jcnlwdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IHRydWU7CiAgICAgICAgfWAsCn0pOwoKbGV0IGFiQnV0dG9uOwoKaWYgKHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy8gQ3JlYXRlIGluY2x1ZGVCb3RzIGJ1dHRvbgogICAgYWJCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUyLAogICAgICAgIGFiU2VsZWN0aW9uQnV0dG9uOiB0cnVlLAogICAgICAgIGxhYmVsOiBiYXNlQm90cy5sZW5ndGggPiAwICYmIGJhc2VBQiAhPSB1bmRlZmluZWQgPyBgc2VsZWN0ZWQgcGF0dGVybjogJHtiYXNlQUJ9ICgke2Jhc2VCb3RzLmxlbmd0aH0gYm90JHtiYXNlQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgIDogYG5ldyBwYXR0ZXJuICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICdlZ2cnLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYlB1Ymxpc2hTZWxlY3QoKTtgLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhck5vbiA9IHRoYXQubm9uQUJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIGNvbnN0IGJvdFZhckFCID0gdGhhdC5hYkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gdGhhdC5hYiArICIgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhck5vbjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJzZWxlY3RlZCBwYXR0ZXJuOiAiICsgdGhhdC5hYiArICIgKCIgKyB0aGF0LmFiQm90cyArIGJvdFZhckFCOwogICAgICAgIH1gCiAgICB9KTsKfQoKaWYgKG5vbkFCQm90cy5sZW5ndGggPiAwICYmIHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy9pY2x1ZGUgbmV3IGJvdHMKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUzLAogICAgICAgIGFiQnV0dG9uOiBnZXRMaW5rKGFiQnV0dG9uKSwKICAgICAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICAgICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgICAgICBsYWJlbDogYGluY2x1ZGUgbmV3ICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3giLAogICAgICAgIHVuY2xhaW1lZFN0YXRlOiBmYWxzZSwKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSBsaW5rcy5hYkJ1dHRvbi50YWdzLmxhYmVsOwoKICAgICAgICAgICAgICAgIGlmIChsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRhZ3MudW5jbGFpbWVkU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogbm9uQUJCb3RzLmxlbmd0aH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKCiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IDB9KTsKICAgICAgICAgICAgfWAsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHMgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJpbmNsdWRlIG5ldyAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyOwoKICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IHRoYXQuYWI7CgogICAgICAgICAgICBpZighbGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSBwdWJsaWMgYnV0dG9uCmlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgCnsKICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IGZhbHNlOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICAgICAgbGFiZWw6ICJpc1B1YmxpYyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICAgICAgcHVibGljU3RhdGU6IGZhbHNlLAogICAgICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MucHVibGljU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgdmVyc2lvbiBzZWxlY3QgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGxhYmVsOiAndmVyc2lvbkZsYWc9Y3VycmVudCcsCiAgICBmb3JtQWRkcmVzczogJ2FsdF9yb3V0ZScsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgc2hvdXQoJ3Nob3dWZXJzaW9uU2VsZWN0b3InKTtgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmxhYmVsID0gJ3ZlcnNpb25GbGFnPScgKyB0aGF0OwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgYCwKfSk7CgovLyBDdXJyZW50IFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2N1cnJlbnQnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX2NoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIEZlZWRiYWNrIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2ZlZWRiYWNrJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTExLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ2ZlZWRiYWNrJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBTdGFibGUgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnc3RhYmxlJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEyLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ3N0YWJsZSc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA0LAogICAgZm9ybUFkZHJlc3M6ICJlZ2ciLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCAwcHggOHB4IDhweCIsCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItYm90dG9tLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm06ICJpbnB1dCIsCiAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICBvbklucHV0VHlwaW5nOiBgQCBsaW5rcy5sYWJlbEJvdC50YWdzLmxhYmVsID0gJ3B1Ymxpc2ggcGF0dGVybiBhcyAnICsgdGhhdC50ZXh0ICsgJyAoJyArIGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzICsgJyBib3QnICsgKGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzID09IDEgPyAnKScgOiAncyknKTtgLAogICAgbWVudUl0ZW1TaG93U3VibWl0V2hlbkVtcHR5OiB0cnVlLAogICAgdGFyZ2V0Qm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBtZW51SXRlbVRleHQ6IGJhc2VBQiwKICAgIG9uU3VibWl0OiBgQAogICAgICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQudGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0YXJnZXRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwogICAgICAgICAgICBjb25zdCBjb25maXJtUHVzaCA9IGF3YWl0IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgICAgIHRpdGxlOiAiY29uZmlybSBwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICJwdWJsaXNoICIgKyB0aGF0LnRleHQgKyAiIHRvICIgKyB0YXJnZXRTdHVkaW8gKyAiPyIsCiAgICAgICAgICAgICAgICBjb25maXJtVGV4dDogInB1Ymxpc2giLAogICAgICAgICAgICAgICAgY2FuY2VsVGV4dDogImNhbmNlbCIKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIWNvbmZpcm1QdXNoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoQUIoeyBhYjogdGhhdC50ZXh0LCBib3Q6IGxpbmtzLnRhcmdldEJvdCwgYmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgbWFudWFsUHVibGlzaDogdHJ1ZSB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJhYiBub3Qgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSB0aGF0LmFiOwogICAgfWAKfSk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgCnsKICAgIC8vIENyZWF0ZSBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDgsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAiY29weSB0byBjbGlwYm9hcmQiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiZmlsZV9jb3B5IiwKICAgICAgICB0YXJnZXRCb3Q6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RGb2N1cywKICAgICAgICBvbkNsaWNrOiBgQCBsZXQgc2VsZWN0ZWRCb3QgPSBsaW5rcy50YXJnZXRCb3Q7CiAgICAgICAgICAgIGxldCBwcmVwcGVkQm90ID0gSlNPTi5zdHJpbmdpZnkoc2VsZWN0ZWRCb3QpOwogICAgICAgICAgICBsZXQgc3RhdGUgPSB7fQoKICAgICAgICAgICAgc3RhdGVbYWJJbnN0TWVtb3J5LnRhZ3MuYWJGb2N1c0RhdGFdID0gc2VsZWN0ZWRCb3Q7CgogICAgICAgICAgICBsZXQgbmV3RmlsZSA9IHt9CiAgICAgICAgICAgIG5ld0ZpbGUudmVyc2lvbiA9IDE7CiAgICAgICAgICAgIG5ld0ZpbGUuc3RhdGUgPSBzdGF0ZTsKCiAgICAgICAgICAgIHZhciBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkobmV3RmlsZSk7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChmb3JtYXR0ZWRGaWxlKTsKCiAgICAgICAgICAgIG9zLnRvYXN0KCJib3QgY29waWVkIHRvIGNsaXBib2FyZCIpOwoKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CiAgICAgICAgYCwKICAgIH0pOwp9CmVsc2UgCnsKICAgIC8vIENyZWF0ZSBzY2FuIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMTAsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyAgICAgICAgICAgIAogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAic2NhbiB0byBwdWJsaXNoIiwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgb25DbGljazogYEAgY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSB0cnVlOyBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpO2AsCiAgICB9KTsKfQoKbGV0IGhvc3RCdXR0b24gPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDUwLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgZm9ybUFkZHJlc3M6ICJncm91cF9hZGQiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLmxlYXJuLmFiQ3JlYXRlSG9zdCh0aGlzQm90KTsKICAgIGlmICghbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpCiAgICB7CiAgICAgICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKICAgIH1gLAp9OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMCwgMykgKyAiLSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMyk7Cn0KZWxzZSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJnZW5lcmF0ZSBqb2luIGNvZGUiOwp9CgppZiAoY29uZmlnQm90LnRhZ3Muc3RhdGljSW5zdCA9PSB1bmRlZmluZWQpCnsKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGhvc3RCdXR0b24pOy8vZ2VuZXJhdGUgYSBob3N0IGJ1dHRvbgp9JwCRkKUus/ABDmFiQ29yZU1lbnVJY29uAgQAkZClLo+VAwlpb3Nfc2hhcmUnAJGQpS6z8AEPYWJDb3JlTWVudUxhYmVsAgQAkZClLpmVAwVzaGFyZScAkZClLrPwARNhYkNvcmVNZW51U29ydE9yZGVyAgQAkZClLp+VAwEzJwCRkKUus/ABCHJlbWVtYmVyAgQAkZClLqGVAyjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCRkKUus/ABC2FiUHVibGlzaEFCAgQAkZClLsiVA5AzQGlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZzogInBhdHRlcm4gbmFtZXMgbWF5IG5vdCBjb250YWluIHNwYWNlcyBvciBxdW90YWlvbiBtYXJrcywgcGxlYXNlIHRyeSBhZ2Fpbi4iLCBsb2dUeXBlOiAiZXJyb3IiIH0pOwogICAgcmV0dXJuOwp9CgpsaW5rcy51dGlscy5hYkxvZyhgcHVibGlzaGluZyAke3RoYXQuYWJ9YCk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKLy9jbGVhciBhYiBidWlsZGVyCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCi8vYWIgdmFyaWFibGVzCmNvbnN0IGFiSUQgPSB0aGF0LmFiOwpsZXQga2V5ID0gdGhhdC5rZXk7CmxldCB0YXJnZXQgPSB0aGF0LnRhcmdldCA/IHRoYXQudGFyZ2V0IDogdGhhdC5ib3Q7CmNvbnN0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nID8/IGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZzsKY29uc3QgYmFzZUFCID0gdGhhdC5iYXNlQUIgPz8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8/IChjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkKTsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaCA9IHRoYXQub25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaDsgLy8gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBwcmVwcm9jZXNzIHRoZSBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuIChvcHRpb25hbCkKY29uc3QgbWFudWFsUHVibGlzaCA9IHRoYXQubWFudWFsUHVibGlzaDsKY29uc3Qgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CgpsZXQgYnVzeUluZGljYXRvcjsKaWYgKG1hbnVhbFB1Ymxpc2ggJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkgewogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgdXBsb2FkaW5nICR7dGhhdC5hYn1gLCBvbkRlc3Ryb3k6IGBAY29uc29sZS5sb2coJ2J1c3kgaW5kaWNhdG9yIGdvIGJvb20nKWB9KTsKfQoKaWYgKCF0YXJnZXQgfHwgdGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgIGlmIChjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgJiYgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQikgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBhYklEKTsKCiAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiAmJiBnZXRCb3QoImFiSURPcmlnaW4iLCBiYXNlQUIpKSB7CiAgICAgICAgY29uc3QgZWdnQm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKTsKICAgICAgICBjb25zdCBuZXdCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCk7CgogICAgICAgIHRhcmdldCA9IFsuLi5lZ2dCb3RzLCAuLi5uZXdCb3RzXTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgfQoKICAgIHNldFRhZyh0YXJnZXQsICJhYklET3JpZ2luIiwgYWJJRCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IG51bGw7CgogICAgaWYgKHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgibm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikgewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkgewogICAgICAgIGtleUNoZWNrID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ2NvbmZpcm0gc2VjcmV0IGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBpZiAoa2V5ICE9IGtleUNoZWNrKSB7CiAgICAgICAgaWYgKCFrZXlDaGVjaykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBrZXkgZW50ZXJlZCIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGN1cnJlbnRCb3RJRCA9IHRhcmdldFtpXS5pZDsKICAgICAgICBsZXQgY3VycmVudEJvdERhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldFtpXSkpOwoKICAgICAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdERhdGE7CiAgICB9Cn0KZWxzZSB7CiAgICBzdGF0ZVt0YXJnZXQuaWRdID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0YXJnZXQpKTsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7IGFiSUQ6IGFiSUQgfSk7CgovL2FkZCB4cCBib3QgaGVyZQpzdGF0ZS5hYlhQQm90ID0gewogICAgc3BhY2U6ICJzaGFyZWQiLAogICAgaWQ6ICJhYlhQQm90IiwKICAgIHRhZ3M6IHsKICAgICAgICBmb3JtOiAibm90aGluZyIsCiAgICAgICAgc3lzdGVtOiAiYWIucGF0dGVybi5hYlhQQm90IiwKICAgICAgICBhdXRob3JJRDogYXV0aEJvdC5pZCwKICAgICAgICB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24sCiAgICAgICAgeHA6IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUCwKICAgICAgICBzaWduYXR1cmU6IGVnZ0NoZWNrLnNpZ25hdHVyZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgIH0KfTsKCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBhYiBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhOiBzdGF0ZSwgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nIH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaCkgewogICAgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaChwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vYWRkaXRpb25hbCBmaWxlIGRhdGEKZm9ybWF0dGVkRmlsZS52ZXJzaW9uID0gMTsKZm9ybWF0dGVkRmlsZS5zaWduYXR1cmUgPSBlZ2dDaGVjay5zaWduYXR1cmU7CmZvcm1hdHRlZEZpbGUuc3RhdGUgPSBzdGF0ZTsKCi8vYWN0dWFsIGVuY3J5cHRpb24gaWYgY2hvc2VuCmlmIChrZXkpIHsKICAgIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRGaWxlKTsKICAgIGZvcm1hdHRlZEZpbGUgPSBjcnlwdG8uZW5jcnlwdChrZXksIGZvcm1hdHRlZEZpbGUpOwp9CgovL3B1Ymxpc2ggdGhlIGZpbGUKbGV0IHB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUQgfSk7CgovL2dhdGhlciBhZGRpb25hbCBlZ2cgZGF0YQpjb25zdCBhaVBlcm1pdENoZWNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWlfcGVybWl0Iik7CmNvbnN0IGFpUGVybWl0SUQgPSBhaVBlcm1pdENoZWNrLnN1Y2Nlc3MgPyBhaVBlcm1pdENoZWNrLmRhdGEucGVybWl0SUQgOiBmYWxzZTsKCmVnZ0NoZWNrLmVnZ0RhdGEuYWlQZXJtaXQgPSBhaVBlcm1pdElEOwplZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5LnB1c2gocHVibGlzaEZpbGUudXJsKTsKZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CmVnZ0NoZWNrLmVnZ0RhdGEudGFyZ2V0VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwoKLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKbGV0IHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7IGRhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogcHVibGljRmFjaW5nIH0pOwpsZXQgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CgovL3B1Ymxpc2hpbmcgc2hvdXQKc3VwZXJTaG91dCgib25BQlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7CnN1cGVyU2hvdXQoIm9uQWJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCi8vc2VuZCBkYXRhIGFuZCBmb3JtYXQgdXJsIGlmIGRhdGEgc3VjY2Vzc2Z1bGx5IHNlbnQKaWYgKHB1Ymxpc2hSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3QgYmlvcyA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CiAgICBjb25zdCBpbnN0VHlwZSA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CgogICAgc2V0VGFnTWFzayhsaW5rcy5sZWFybiwgImFiWFAiLCAiMCIsICJsb2NhbCIpOwoKICAgIGlmIChtYW51YWxQdWJsaXNoKSB7CiAgICAgICAgY29uc3QgdXJsID0gc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJnN0dWRpbz0iICsgc3R1ZGlvICsgIiZiaW9zPSIgKyBiaW9zOwogICAgICAgIG9zLnNldENsaXBib2FyZCh1cmwpOwoKICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIHdpdGggZW5jcnlwdGVkIGRhdGEgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgYW5hbHl0aWNzLnJlY29yZEV2ZW50KCdhYl9lZ2dfcHVibGlzaCcsIHsgYWI6IGFiSUQsIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgfQp9CmVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogJ3B1Ymxpc2hpbmcgZmFpbGVkJywKICAgICAgICBsb2dUeXBlOiAnZXJyb3InLAogICAgICAgIHRvYXN0OiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlCiAgICB9KQoKICAgIGNvbnNvbGUuZXJyb3IoYGZhaWxlZCBwdWJsaXNoIHJlY29yZDpgLCBwdWJsaXNoUmVjb3JkKTsKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBwdWJsaXNoUmVjb3JkOycAkZClLrPwAQhhYklnbm9yZQIEAJGQpS7ZyAMEdHJ1ZScAkZClLrPwAQphYkRvd25sb2FkAgQAkZClLt7IA7kIQGNvbnN0IHsgcG9zc2libGVCb3RzIH0gPSB0aGF0ID8/IHt9OwoKbGV0IGRvd25sb2FkQm90czsKbGV0IGZpbGVuYW1lOwpsZXQgdGltZWNvZGUgPSBEYXRlVGltZS5ub3coKS50b1VUQygpLnRvRm9ybWF0KCd5eXl5TU1kZC1ISG1tc3MnKTsKCmlmIChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykpIHsKICAgIGlmIChwb3NzaWJsZUJvdHMubGVuZ3RoID4gMCkgewogICAgICAgIGRvd25sb2FkQm90cyA9IHBvc3NpYmxlQm90czsKICAgICAgICBjb25zdCBib3RJZHMgPSBwb3NzaWJsZUJvdHMubWFwKGIgPT4gYi5pZCkuc29ydCgpOwogICAgICAgIGxldCBib3RJZHNTSEExID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90SWRzKTsKICAgICAgICBmaWxlbmFtZSA9IGAke29zLmdldEN1cnJlbnRJbnN0KCl9XyR7Ym90SWRzU0hBMS5zdWJzdHJpbmcoMCwgNyl9XyR7dGltZWNvZGV9YDsKCiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coYGRvd25sb2FkaW5nICR7ZG93bmxvYWRCb3RzLmxlbmd0aH0gYm90c2ApOwogICAgfQogICAgZWxzZSB7OwogICAgICAgIGRvd25sb2FkQm90cyA9IGdldEJvdHMoYiA9PiAhYi50YWdzLmFiSWdub3JlICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnKTsKICAgICAgICBmaWxlbmFtZSA9IGAke29zLmdldEN1cnJlbnRJbnN0KCl9XyR7dGltZWNvZGV9YDsKCiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkaW5nIGluc3QnKTsKICAgIH0KfQplbHNlIHsKICAgIGRvd25sb2FkQm90cyA9IFtwb3NzaWJsZUJvdHNdOwogICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke3Bvc3NpYmxlQm90cy5pZC5zdWJzdHJpbmcoMCwgNyl9XyR7dGltZWNvZGV9YDsKCiAgICBsaW5rcy51dGlscy5hYkxvZygnZG93bmxvYWRpbmcgYm90Jyk7Cn0KCmlmICghQXJyYXkuaXNBcnJheShkb3dubG9hZEJvdHMpKSB7CiAgICBkb3dubG9hZEJvdHMgPSBbZG93bmxvYWRCb3RzXTsKfQoKb3MuZG93bmxvYWRCb3RzKGRvd25sb2FkQm90cywgZmlsZW5hbWUpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOycAkZClLrPwAQ1tYW5pZmVzdGF0aW9uAgQAkZClLpjRAyjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCRkKUus/ABBG1lbnUCBACRkKUuv9EDKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJGQpS6z8AESYWJQcmV2aW91c0VnZ0NoZWNrAgQAkZClLubRA7EPQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGVnZ0hpc3Rvcnk7CmxldCBlZ2dJRDsKbGV0IHRhcmdldFZlcnNpb25OdW07CmxldCBsYXN0SGFzaDsKbGV0IG1heFZlcnNpb25OdW07CmxldCBzdGFibGVWZXJzaW9uOwpsZXQgZmVlZGJhY2tWZXJzaW9uOwpsZXQgcHJldmlvdXNYUDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKbGV0IHJlY29yZExvb2t1cCA9IGF3YWl0IG9zLmdldERhdGEodXNlclJlY29yZCwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycAkZClLrPwAQ9hYkJvdE1lbnVBY3Rpb24CBACRkKUumOEDTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCRkKUus/ABDmFiQm90TWVudUxhYmVsAgQAkZClLubhAwVzaGFyZScAkZClLrPwAQ1hYkJvdE1lbnVJY29uAgQAkZClLuzhAwlpb3Nfc2hhcmUnAJGQpS6z8AESYWJCb3RNZW51U29ydE9yZGVyAgQAkZClLvbhAwMzLjUnAJGQpS6z8AEFbGVhcm4CBACRkKUu+uEDKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJGQpS6z8AELYWJRUlB1Ymxpc2gCBACRkKUuoeIDxgFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0fSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAJGQpS6z8AEGc2VhcmNoAgQAkZClLujjAyjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCRkKUus/ABB2FiU2hlbGwCBACRkKUuj+QDBHRydWUnAJGQpS6z8AEMc3R1ZGlvU2VsZWN0AgQAkZClLpTkA4sLQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwCRkKUus/ABDmFiUHVibGlzaEFza0lEAgQAkZClLp7vA5cFQGxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGBwdWJsaXNoaW5nICR7dGhhdC5hc2tJRH1gfSk7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKY29uc3QgcGF0dGVybklEID0gdGhhdC5wYXR0ZXJuSUQ7CmNvbnN0IHN0dWRpb0lEID0gdGhhdC5zdHVkaW9JRCA/IHRoYXQuc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogYXV0aEJvdC5pZDsKY29uc3QgYXNrSUQgPSAiYXNrXyIgKyB0aGF0LmFza0lELnJlcGxhY2VBbGwoIi0iLCAiIik7CmNvbnN0IGVuZHBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50Owpjb25zdCBwdWJsaXNoQXNrID0gYXdhaXQgb3MucmVjb3JkRGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwge3BhdHRlcm5JRDogcGF0dGVybklELCBzdHVkaW9JRDogc3R1ZGlvSUR9LCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCB1cGRhdGVQb2xpY3k6IFthdXRoQm90LmlkXX0pOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHB1Ymxpc2hBc2s7JwCRkKUus/ABBWlucHV0AgQAkZClLrb0Ayjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwCRkKUus/ABC2FiRW1iZWRMaW5rAgQAkZClLt30A6QDQGNvbnN0IGFiID0gdGhhdCA/IHRydWUgOiBmYWxzZTsKY29uc3QgZW1iZWRMaW5rID0gYWIgPyAiYWI9IiArIHRoYXQgOiAiaW5zdD0iICsgY29uZmlnQm90LnRhZ3MuaW5zdDsKY29uc3Qgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CmNvbnN0IGVtYmVkVGV4dCA9IGA8IURPQ1RZUEUgaHRtbD4KwqDCoMKgwqA8aHRtbD4KwqDCoMKgwqDCoMKgwqDCoDxoZWFkPjwvaGVhZD4KwqDCoMKgwqDCoMKgwqDCoDxib2R5PgrCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqA8aWZyYW1lIHNyYz0iJHtzaXRlT3JpZ2luICsgIi8/IiArIGVtYmVkTGlua30iIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjQwMCIgLz4KwqDCoMKgwqDCoMKgwqDCoDwvYm9keT4KwqDCoMKgwqA8L2h0bWw+YDsKCnJldHVybiBlbWJlZFRleHQ7JwCRkKUus/ABD2FiUGF0dGVyblVwZGF0ZQIEAJGQpS7W9wOFBUAvL3Nob3V0KCJhYlBhdHRlcm5VcGRhdGUiLCB7YWJJRDogYWJJRCwgc3R1ZGlvOnN0dWRpbz8sIGJvdHM6IGJvdHM/fSk7CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgppZiAoIWF1dGhCb3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPyB0aGF0LnN0dWRpbyA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFiTWFuaWZlc3QgPSBnZXRCb3QoYnlNb2Qoe2FiRWdnOiB0cnVlLCBvcmlnaW5fYWI6IGFiSUR9KSk7CgppZiAoIWFiTWFuaWZlc3QpCnsKICAgIHNob3V0KCJvbkxvb2t1cEFCRWdncyIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywgYXV0b0hhdGNoOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm51cGRhdGUnfSk7CgogICAgcmV0dXJuOwp9Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHN0dWRpbzsKCmNvbnN0IGFiQm90cyA9IHRoYXQuYm90cyA/PyBnZXRCb3RzKCJhYklET3JpZ2luIiwgYWJJRCk7Cgphd2FpdCB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogYWJJRCwgdGFyZ2V0OiBhYkJvdHMsIHB1YmxpY0ZhY2luZzogdHJ1ZX0pOycAkZClLrPwARdhYk11bHRpcGxlQm90TWVudUFjdGlvbgIEAJGQpS7c/ANNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAJGQpS6z8AEaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBACRkKUuqv0DATInAJGQpS6z8AEVYWJNdWx0aXBsZUJvdE1lbnVJY29uAgQAkZClLqz9Awlpb3Nfc2hhcmUnAJGQpS6z8AEWYWJNdWx0aXBsZUJvdE1lbnVMYWJlbAIEAJGQpS62/QMFc2hhcmUnAJGQpS6z8AEPYWJQdWJsaXNoU2VsZWN0AgQAkZClLrz9A6oTQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiUGF0dGVybk1lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBhbGxCb3RzID0gZ2V0Qm90cygiYWJJRE9yaWdpbiIpOwpjb25zdCBhbGxQYXR0ZXJucyA9IFsibmV3IHBhdHRlcm4iXTsKCmJvdExvb3A6CmZvciAobGV0IGkgPSAwOyBpIDwgYWxsQm90cy5sZW5ndGg7IGkrKykKewogICAgY29uc3QgYWN0aXZlQm90ID0gYWxsQm90c1tpXTsKCiAgICBpZiAoYWN0aXZlQm90LnRhZ3MuYWJJZ25vcmUpCiAgICB7CiAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgIH0KCiAgICBjb25zdCBwb3NzaWJsZVBhdHRlcm4gPSBhY3RpdmVCb3QudGFncy5hYklET3JpZ2luOwoKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBqKyspCiAgICB7CiAgICAgICAgY29uc3QgYWN0aXZlUGF0dGVybiA9IGFsbFBhdHRlcm5zW2pdOwoKICAgICAgICBpZiAoYWN0aXZlUGF0dGVybiA9PSBwb3NzaWJsZVBhdHRlcm4gKQogICAgICAgIHsKICAgICAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaiA9PSBhbGxQYXR0ZXJucy5sZW5ndGggLSAxKQogICAgICAgIHsKICAgICAgICAgICAgYWxsUGF0dGVybnMucHVzaChwb3NzaWJsZVBhdHRlcm4pOwogICAgICAgIH0KICAgIH0KfQoKY29uc3QgdGFyZ2V0QUIgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3QgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiUGF0dGVybk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKbWVudUJ1dHRvbi5yZW1lbWJlciA9IHRhZ3MucmVtZW1iZXI7Cm1lbnVCdXR0b24ub25DbGljayA9IGBAY29uc3QgdG90YWxQYXR0ZXJuQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gdGFncy5sYWJlbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKY29uc3Qgbm9uUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCnNob3V0KCJhYlNlbGVjdFRpdGxlVXBkYXRlIiwge2FiOiB0YWdzLmxhYmVsLCBhYkJvdHM6IHRvdGFsUGF0dGVybkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vblBhdHRlcm5Cb3RzLmxlbmd0aH0pOwoKbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZEFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJQYXR0ZXJuTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7YDsKCmFsbFBhdHRlcm5zLnNvcnQoKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVQYXR0ZXJuTmFtZSA9IGFsbFBhdHRlcm5zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRBQiA9PSBhY3RpdmVQYXR0ZXJuTmFtZSA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gYWN0aXZlUGF0dGVybk5hbWU7CgogICAgaWYgKGFjdGl2ZVBhdHRlcm5OYW1lID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gLTE7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gaTsKICAgIH0KCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKfQoKaWYgKCFnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGZvcm1BZGRyZXNzOiAicmFkaW9fYnV0dG9uX2NoZWNrZWQifSkpKQp7CiAgICBjb25zdCBuZXdCb3QgPSBnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGxhYmVsOiAibmV3IHBhdHRlcm4ifSkpOwogICAgCiAgICBuZXdCb3QudGFncy5mb3JtQWRkcmVzcyA9ICJyYWRpb19idXR0b25fY2hlY2tlZCI7Cn0nAJGQpS6z8AEJYWJWZXJzaW9uAgQAkZClLuWQBAQxMC41JwCRkKUus/ABC3BlcnNvbmFsaXR5AgQAkZClLuqQBCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwCRkKUus/ABBXV0aWxzAgQAkZClLpGRBCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwEEYm90cyQ3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcBJwCRkKUuuJEEFWFiRmluZEFydGlmYWN0QnVuZGxlcwIEAJGQpS65kQSuBEBjb25zdCB7IGFiQXJ0aWZhY3ROYW1lIH0gPSB0aGF0ID8/IHt9OwoKY29uc3QgYXJ0aWZhY3RCdW5kbGVzOiBSZWNvcmQ8c3RyaW5nLCBBQkFydGlmYWN0QnVuZGxlPiA9IHt9OwoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSAmJiBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYXJ0aWZhY3RJZCA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlLmlkOwoKICAgICAgICBpZiAoYXJ0aWZhY3RJZCAmJiAhYXJ0aWZhY3RCdW5kbGVzW2FydGlmYWN0SWRdKSB7CiAgICAgICAgICAgIGFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIH0KICAgIH0KfSk7CgpyZXR1cm4gYXJ0aWZhY3RCdW5kbGVzOycAkZClLriRBAVzdG9yZQIEAJGQpS7olQQo8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicAkZClLriRBAZzeXN0ZW0CBACRkKUuj5YEEWFiLnNoZWxsLmFydGlmYWN0JwCRkKUuuJEECGFiSWdub3JlAgQAkZClLqGWBAR0cnVlJwCRkKUuuJEECWFiVmVyc2lvbgIEAJGQpS6mlgQEMTAuNScAkZClLriRBAVkZWJ1ZwIEAJGQpS6rlgQEdHJ1ZScAkZClLriRBAhyZW1lbWJlcgIEAJGQpS6wlgQo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAkZClLriRBBNhYkNyZWF0ZUFydGlmYWN0Qm90AgQAkZClLteWBO8PQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgZGltZW5zaW9uID0gbGlua3MubGVhcm4udGFncy5hYkluc3QgPz8gJ2hvbWUnLAogICAgcG9zaXRpb24gPSBuZXcgVmVjdG9yMygwLCAwLCAwKQp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJvdCA9IGNyZWF0ZSh7CiAgICBzcGFjZTogJ3NoYXJlZCcsCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RCb3Q6IHRydWUsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtgJHtkaW1lbnNpb259WGBdOiBwb3NpdGlvbi54LAogICAgW2Ake2RpbWVuc2lvbn1ZYF06IHBvc2l0aW9uLnksCiAgICBbYCR7ZGltZW5zaW9ufVpgXTogcG9zaXRpb24ueiwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBsYWJlbENvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIHN0cm9rZUNvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIGxhYmVsOiBgYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdE5hbWV9YCwKICAgIG9uQm90Q2hhbmdlZDogYEAKICAgICAgICBjb25zdCBjaGFuZ2VkVGFncyA9IHRoYXQudGFnczsKCiAgICAgICAgaWYgKGNoYW5nZWRUYWdzLnNvbWUodCA9PiB0ID09PSAnYWJBcnRpZmFjdEJ1bmRsZScgfHwgdCA9PT0gJ2FiQXJ0aWZhY3ROYW1lJykpIHsKICAgICAgICAgICAgbGV0IHN5c3RlbSA9ICdhYkFydGlmYWN0JzsKCiAgICAgICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0TmFtZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSAmJiB0YWdzLmFiQXJ0aWZhY3RCdW5kbGUuaWQpIHsKICAgICAgICAgICAgICAgIHN5c3RlbSArPSAnLicgKyB0YWdzLmFiQXJ0aWZhY3RCdW5kbGUuaWQuc3Vic3RyaW5nKDAsIDcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0YWdzLnN5c3RlbSA9IHN5c3RlbTsKICAgICAgICB9CiAgICBgLAogICAgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlOiBgQAogICAgICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnbGFiZWwnLCAnICcsICdzaGFyZWQnKTsKICAgIGAKfSk7Cgp0cnkgewogICAgLy8gVXBkYXRlIGFsbCB0aGUgc2hhcmRzIGZvciB0aGlzIGFydGlmYWN0IC0tIHdoaWNoIG5vdyBpbmNsdWRlcyB0aGlzIGJvdCEKICAgIGNvbnN0IHVwZGF0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lIH0pOwoKICAgIGlmICghdXBkYXRlUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byB1cGRhdGUgJyR7YWJBcnRpZmFjdE5hbWV9JyBhcnRpZmFjdCBzaGFyZHMuYCk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaHQgZXJyb3Igd2hpbGUgdXBkYXRlIGFydGlmYWN0IHNoYXJkczpgLCBlKTsKICAgIGRlc3Ryb3koYWJBcnRpZmFjdEJvdCk7CiAgICByZXR1cm4gbnVsbDsKfQoKcmV0dXJuIGFiQXJ0aWZhY3RCb3Q7JwCRkKUuuJEEFmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGUCBACRkKUux6YE6ghAaWYgKCFjb25maWdCb3QudGFncy5yZWNvbnN0aXR1dGlvbikgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKYXNzZXJ0KHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmcgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuYCk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9Cgpjb25zdCB7IAogICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCBhcyBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnOwoKYXNzZXJ0KGFiQXJ0aWZhY3RCdW5kbGUgJiYgYWJBcnRpZmFjdEJ1bmRsZS5kYXRhICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCdW5kbGUgaXMgYSByZXF1aXJlZCB0byBiZSBhIEFCQXJ0aWZhY3RCdW5kbGUuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgdG8gYmUgb2YgdHlwZSBzdHJpbmcuYCk7Cgpjb25zdCBmb3JtYXRWZXJzaW9uID0gYWJBcnRpZmFjdEJ1bmRsZS5mb3JtYXRWZXJzaW9uOwoKaWYgKGZvcm1hdFZlcnNpb24gPT0gbnVsbCkgewogICAgdGhyb3cgbmV3IEVycm9yKGBmb3JtYXRWZXJzaW9uICR7Zm9ybWF0VmVyc2lvbn0gaXMgbm90IHZhbGlkLmApOwp9Cgpjb25zdCBmdW5jVGFnTmFtZSA9IGBhYkFydGlmYWN0UmVjb25zdGl0dXRlX3Yke2Zvcm1hdFZlcnNpb259YDsKCmlmICh0eXBlb2YgdGhpc0JvdFtmdW5jVGFnTmFtZV0gIT09ICdmdW5jdGlvbicpIHsKICAgIHRocm93IG5ldyBFcnJvcihgJHtmdW5jVGFnTmFtZX0gaXMgbm90IGEgZnVuY3Rpb24uYCkKfQoKLy8gQ2FsbCB0aGUgdmVyc2lvbmVkIHJlY29uc3RpdHV0ZSBmdW5jdGlvbi4KcmV0dXJuIGF3YWl0IHRoaXNCb3RbZnVuY1RhZ05hbWVdKHRoYXQpOycAkZClLriRBBdhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbgIEAJGQpS6yrwQBMScAkZClLriRBAZzZWFyY2gCBACRkKUutK8EKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAJGQpS64kQQHYWJTaGVsbAIEAJGQpS7brwQEdHJ1ZScAkZClLriRBAV1dGlscwIEAJGQpS7grwQo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAkZClLriRBBlhYkFydGlmYWN0UmVjb25zdGl0dXRlX3YxAgQAkZClLoewBKcYQGlmICghY29uZmlnQm90LnRhZ3MucmVjb25zdGl0dXRpb24pIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmFzc2VydCh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJnIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLmApOwoKY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgYXMgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgQUJBcnRpZmFjdEJ1bmRsZS5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCB0byBiZSBvZiB0eXBlIHN0cmluZy5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmcgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKTsKCmNvbnN0IHNoYXJkQm90cyA9IFtdOwoKZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzKSB7CiAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgIGFiSUQ6IGRlcGVuZGVuY3kuYWJJRCwKICAgICAgICByZWNvcmRLZXk6IGRlcGVuZGVuY3kucmVjb3JkS2V5LAogICAgICAgIGFiVmVyc2lvbjogZGVwZW5kZW5jeS5hYlZlcnNpb24sCiAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgIHNvdXJjZUV2ZW50OiAncmVjb25zdGl0dXRlJywKICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6ICh7IGJvdERhdGEgfSkgPT4gewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZDsgLy8gSWYgdGhlIHNoYXJkIGJvdCBoYXMgaXRzZWxmIG1hcmtlZCBhcyByZWNvbnN0aXR1dGVkIGFscmVhZHkgKHBvc3NpYmx5IGR1ZSB0byBhbiBvdmVyc2lnaHQpLCB0aGVuIHJlbW92ZSBpdCEKCiAgICAgICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmc7IC8vIEFzc2lnbiB0aGUgYXJ0aWZhY3QgYnVuZGxlIGJhY2sgdG8gdGhlIGhhdGNoZWQgc2hhcmQgYm90LgogICAgICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gYWJBcnRpZmFjdEluc3RhbmNlSUQ7IC8vIFVVSUQgb2YgdGhlIGFydGlmYWN0IGluc3RhbmNlIHRoYXQgdGhpcyBib3QgYmVsb25ncyB0by4KICAgICAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRJbnN0YW5jZUlEID0gdXVpZCgpOyAvLyBVVUlEIGFzc2lnbmVkIHRvIHRoZSBib3QgYnkgdGhlIGFydGlmYWN0IHdoZW4gbG9hZGVkLgogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSkKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9ICR7ZGVwZW5kZW5jeS5hYklEfSBsb29rdXBFZ2dSZXN1bHQ6YCwgbG9va3VwRWdnUmVzdWx0KTsKICAgIH0KCiAgICBpZiAobG9va3VwRWdnUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZyhgJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9IChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGxvYWRlZCBkZXBlbmRlbmN5IGFiSUQ6ICR7ZGVwZW5kZW5jeS5hYklEfSwgYWJWZXJzaW9uOiAke2RlcGVuZGVuY3kuYWJWZXJzaW9uID8/ICdsYXRlc3QnfWApOwogICAgICAgIH0KCiAgICAgICAgZm9yIChjb25zdCBzaGFyZEJvdCBvZiBsb29rdXBFZ2dSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7IC8vIFRoaXMgYm90IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQgaW4gdGhpcyBpbnN0LgogICAgICAgICAgICBzaGFyZEJvdHMucHVzaChzaGFyZEJvdCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gZmFpbGVkIHRvIGxvYWQgZGVwZW5kZW5jeSBhYklEOiAke2RlcGVuZGVuY3kuYWJJRH0sIGFiVmVyc2lvbjogJHtkZXBlbmRlbmN5LmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICB9Cn0KCi8vIFRlbGwgYWxsIGhhdGNoZWQgc2hhcmQgYm90cyB0byByZWNvbnN0aXR1dGUuIAovLyBUaGV5IGFsbCBoYXZlIGNvcGllcyBvZiB0aGUgYWJBcnRpZmFjdEJ1bmRsZSBhbmQgY2FuIHJlY29uc3RpdHV0ZSB0aGVtc2VsdmVzIGZyb20gdGhhdC4Kd2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUnKTsKCmlmICh0b2FzdCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfScgKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC5gKQp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2coYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQuYCk7Cn0KJwCRkKUuuJEEGGFiR2V0QXJ0aWZhY3RJbnN0YW5jZUlEcwIEAJGQpS6tyATjAUBjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRHMgPSBuZXcgU2V0KCk7CgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGIudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEcy5hZGQoYi50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsKICAgIH0KfSkKCnJldHVybiBhYkFydGlmYWN0SW5zdGFuY2VJRHM7JwCRkKUuuJEED29uQW55Qm90Q2xpY2tlZAIEAJGQpS6RygSBAUBjb25zdCB7IGJvdCB9ID0gdGhhdDsKCmlmIChib3QgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEJvdCA9PT0gdHJ1ZSkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBib3QgfSkKfScAkZClLriRBBZhYlVwZGF0ZUFydGlmYWN0U2hhcmRzAgQAkZClLpPLBNIFQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uID0gdGFncy5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiAvLyBEZWZhdWx0IHRvIHRoZSBjdXJyZW50IGZvcm1hdCB2ZXJzaW9uLgp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XWAsIHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uIH0pOwoKaWYgKGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uID09IG51bGwpIHsKICAgIHRocm93IG5ldyBFcnJvcihgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gJHthYkFydGlmYWN0Rm9ybWF0VmVyc2lvbn0gaXMgbm90IHZhbGlkLmApOwp9Cgpjb25zdCBmdW5jVGFnTmFtZSA9IGBhYlVwZGF0ZUFydGlmYWN0U2hhcmRzX3Yke2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9ufWA7CgppZiAodHlwZW9mIHRoaXNCb3RbZnVuY1RhZ05hbWVdICE9PSAnZnVuY3Rpb24nKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZnVuY1RhZ05hbWV9IGlzIG5vdCBhIGZ1bmN0aW9uLmApCn0KCi8vIENhbGwgdGhlIHZlcnNpb25lZCBjcmVhdGUgZnVuY3Rpb24uCnJldHVybiB0aGlzQm90W2Z1bmNUYWdOYW1lXSh0aGF0KTsnAJGQpS64kQQZYWJVcGRhdGVBcnRpZmFjdFNoYXJkc192MQIEAJGQpS7m0ATmLEBjb25zdCB7IAogICAgYWJBcnRpZmFjdE5hbWUsCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUcgPSAnb25BQkFydGlmYWN0Q29sbGVjdFNoYXJkcyc7Cgpjb25zdCBzaGFyZEJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICByZXR1cm4gYi50YWdzLmFiQXJ0aWZhY3ROYW1lID09PSBhYkFydGlmYWN0TmFtZQp9KTsKCmlmIChzaGFyZEJvdHMubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFRoZXJlIGFyZSBubyBzaGFyZHMgZm9yIGFydGlmYWN0IG5hbWUgJyR7YWJBcnRpZmFjdE5hbWV9Jy5gLCBsb2dUeXBlOiAnd2FybicgfSk7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CgovKiogQW4gYXJ0aWZhY3QgYnVuZGxlIGlzIHRoZSBjb21iaW5hdGlvbiBvZiBzaGFyZCBkYXRhIGFuZCBzaGFyZCBkZXBlbmRlbmNpZXMuICovCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSB7CiAgICBuYW1lOiBhYkFydGlmYWN0TmFtZSwKICAgIGZvcm1hdFZlcnNpb246IDEsCiAgICBkYXRhOiB7fSwKICAgIGRlcGVuZGVuY2llczogW10sCn0KCi8qKiBLZWVwIHRyYWNrIG9mIGRlcGVuZGVuY3kgaGFzaGVzLiBUaGlzIHByZXZlbnRzIGR1cGxpY2F0ZXMgaW4gdGhlIGFydGlmYWN0IGRlcGVuZGVuY2llcy4gKi8KY29uc3QgZGVwZW5kZW5jeUhhc2hlcyA9IG5ldyBTZXQoKTsgCgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgY29uc3QgYm90U2hvcnRJZCA9IHNoYXJkQm90LmlkLnN1YnN0cmluZygwLCA1KTsKCiAgICBsZXQgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKICAgIGlmIChzaGFyZEJvdC50YWdzW0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR10pIHsKICAgICAgICBpZiAoc2hhcmRCb3RbQVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHXSkgewogICAgICAgICAgICBzaGFyZCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShzaGFyZEJvdFtBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUddKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nICR7QVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHfSB0YWcgaXMgZGVmaW5lZCBidXQgaXMgbm90IGEgdmFsaWQgZnVuY3Rpb24uYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBzaGFyZDpgLCBzaGFyZCk7CiAgICB9CgogICAgaWYgKHNoYXJkKSB7CiAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc09iamVjdChzaGFyZCkpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7QVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHfSBzaGFyZCBtdXN0IGJlIGFuIG9iamVjdC5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHNoYXJkLmRhdGEpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc09iamVjdChzaGFyZC5kYXRhKSkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7QVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHfSBzaGFyZCAnZGF0YScgcHJvcGVydHkgbXVzdCBiZSBhbiBvYmplY3QuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNoYWxsb3cgbWVyZ2Ugc2hhcmQncyBkYXRhIHByb3BlcnRpZXMgaW50byBjb21iaW5lZCBhcnRpZmFjdCBkYXRhLgogICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLmRhdGEgPSB7IC4uLmFiQXJ0aWZhY3RCdW5kbGUuZGF0YSwgLi4uc2hhcmQuZGF0YSB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzQXJyYXkoc2hhcmQuZGVwZW5kZW5jaWVzKSkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7QVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHfSBzaGFyZCAnZGVwZW5kZW5jaWVzJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIGFycmF5LmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGNvbnN0IGRlcGVuZGVuY3kgb2Ygc2hhcmQuZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgICAgICAvLyBWYWxpZGF0ZSBkZXBlbmRlbmN5IGZvcm1hdC4KICAgICAgICAgICAgICAgIGlmICghbGlua3MudXRpbHMuaXNTdHJpbmcoZGVwZW5kZW5jeS5yZWNvcmRLZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgZGVwZW5kZW5jeSBlbnRyaWVzIG11c3QgY29udGFpbiBhICdyZWNvcmRLZXknIHN0cmluZyBwcm9wZXJ0eS5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc1N0cmluZyhkZXBlbmRlbmN5LmFiSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgZGVwZW5kZW5jeSBlbnRyaWVzIG11c3QgY29udGFpbiBhICdhYklEJyBzdHJpbmcgcHJvcGVydHkuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGRlcGVuZGVuY3kgaXNudCBhbHJlYWR5IGNvbGxlY3RlZC4KICAgICAgICAgICAgICAgIGNvbnN0IGhhc2ggPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBkZXBlbmRlbmN5KTsKCiAgICAgICAgICAgICAgICBpZiAoIWRlcGVuZGVuY3lIYXNoZXMuaGFzKGhhc2gpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeUhhc2hlcy5hZGQoaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZS5kZXBlbmRlbmNpZXMucHVzaChkZXBlbmRlbmN5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gTWFrZSBzdXJlIHdlIGhhdmUgYXQgbGVhc3Qgb25lIGRlcGVuZGVuY3kuCmlmIChhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcy5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBtdXN0IGxpc3QgYXQgbGVhc3Qgb25lIGRlcGVuZGVuY3kgaW4gb3JkZXIgdG8gcmVjb25zdGl0dXRlIHByb3Blcmx5LmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CgovLyBHZW5lcmF0ZSB0aGUgYXJ0aWZhY3QgaWQsIHdoaWNoIGlzIHNoYTI1NiBoYXNoIG9mIHRoZSBjb3JlIGNvbnRlbnRzIG9mIHRoZSBhcnRpZmFjdC4KYWJBcnRpZmFjdEJ1bmRsZS5pZCA9IGNyeXB0by5zaGEyNTYoYWJBcnRpZmFjdEJ1bmRsZSk7CgovLyBTdG9yZSBzb21lIGV4dHJhIG1ldGFkYXRhIHByb3BlcnRpZXMgd2l0aCB0aGUgYXJ0aWZhY3QuCi8vIFRoZXNlIGFyZSBub3QgY29yZSB0byB0aGUgYXJ0aWZhY3QncyBmdW5jdGlvbmFsaXR5IGJ1dCBtYXkgYmUgdXNlZnVsIGFzIGFydGlmYWN0cyBldm9sdmUuCmFiQXJ0aWZhY3RCdW5kbGUuY2FzdWFsT1NWZXJzaW9uID0gb3MudmVyc2lvbigpOwphYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXAgPSBEYXRlVGltZS5ub3coKS50b0lTTygpOwphYkFydGlmYWN0QnVuZGxlLmFiU2hlbGxWZXJzaW9uID0gYCR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1ham9yVmVyc2lvbn0uJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWlub3JWZXJzaW9ufWA7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5hbCBtZXJnZWQgYXJ0aWZhY3QgJHthYkFydGlmYWN0TmFtZX06YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIEV2ZXJ5IHNoYXJkIGJvdCBnZXRzIGEgY29weSBvZiB0aGUgYXJ0aWZhY3QgYnVuZGxlLgovLyBUaGlzIG1ha2VzIHRoZSBhcnRpZmFjdCBob2xvZ3JhcGhpYyBieSBuYXR1cmUuIFRoaXMgbWVhbnMgdGhhdCBhbnkgc2hhcmQgY2FuIGJlIHVzZWQgdG8gcmVjb25zdGl0dXRlIHRoZSB3aG9sZS4KZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIC8vIE1hcmsgZWFjaCBzaGFyZCBib3QgYXMgYmVpbmcgJ3JlY29uc3RpdHV0ZWQnIHdoZW4gd2UgdXBkYXRlIHRoZSBhcnRpZmFjdC4KICAgIC8vIEJlY2F1c2UgdGhpcyBpcyBhIHNoYXJlZCB0YWcgbWFzaywgaXQgd2lsbCBvbmx5IGJlIHRydWUgaW4gdGhlIGN1cnJlbnQgaW5zdC4KICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOwogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlID0gICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwp9CgovLyBSeWFuIENvb2s6IE5lZWQgdG8gZ2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byBjYXRjaHVwLgovLyBGb3VuZCB0aGF0IGlmIHdlIGRpZG50IGRvIHRoaXMsIG1vZCB0YWdzIHdvdWxkIG5vdCBiZSByZXR1cm5lZCBhcyBKU09OIG9iamVjdHMgYnV0IGluc3RlYWQgdGhlIHJhdyBzdHJpbmcuCmF3YWl0IG9zLnNsZWVwKDApOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRlZCBhcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nLiBDb3BpZWQgYXJ0aWZhY3QgYnVuZGxlIHRvICR7c2hhcmRCb3RzLmxlbmd0aH0gYm90cy4gYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKLy8gU2hhcmQgdXBkYXRlIHN1Y2Nlc3NmdWwuCnJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTsnAJGQpS64kQQEbWVudQIEAJGQpS7L/QQo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAkZClLriRBAVsZWFybgIEAJGQpS7y/QQo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAkZClLriRBAtvbkdyaWRDbGljawIEAJGQpS6Z/gRGQGlmIChsaW5rcy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfScAkZClLriRBBphYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdAIEAJGQpS7g/gQHI0FFQTFGRicAkZClLriRBBthYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQCBACRkKUu6P4EByMxZTFiMmQnAJGQpS64kQQQb25BbnlCb3RzUmVtb3ZlZAIEAJGQpS7w/gSVAUBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsKCmlmIChtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgJiYgYm90SURzLmluY2x1ZGVzKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCkpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwp9JwCRkKUuuJEEB3ZlcnNpb24CBACRkKUuhoAFKPCflJc1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYnAJGQpS64kQQYYWJHZXRBcnRpZmFjdE5hbWVzSW5JbnN0AgQAkZClLq2ABawBQGNvbnN0IGFiQXJ0aWZhY3ROYW1lcyA9IG5ldyBTZXQoKTsKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICBhYkFydGlmYWN0TmFtZXMuYWRkKGIudGFncy5hYkFydGlmYWN0TmFtZSk7CiAgICB9Cn0pCgpyZXR1cm4gYWJBcnRpZmFjdE5hbWVzOycAkZClLriRBBVhYkFydGlmYWN0Qm90TWVudU9wZW4CBACRkKUu2oEF0hVAY29uc3QgeyBhYkFydGlmYWN0Qm90IH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3RCb3QgJiYgYWJBcnRpZmFjdEJvdC5zcGFjZSAmJiBhYkFydGlmYWN0Qm90LnRhZ3MsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJvdCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQm90LmApOwoKc2hvdXQoImFiQXJ0aWZhY3RCb3RNZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiQXJ0aWZhY3RNZW51IjsKCmlmICghdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwoKbGV0IGluZm9MYWJlbCA9IGBbYXJ0aWZhY3QgbmFtZV06ICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaWRdOiAke2FiQXJ0aWZhY3RCdW5kbGUuaWQuc3Vic3RyaW5nKDAsIDcpfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaW5zdGFuY2UgaWRdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA/PyAndW5zZXQnfSBcbmA7CmluZm9MYWJlbCArPSBgW3NoYXJkIGluc3RhbmNlIGlkXTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA/PyAndW5zZXQnfSBcbmA7CmluZm9MYWJlbCArPSBgW3JlY29uc3RpdHV0ZWQgaW4gaW5zdF06ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWR9XG5gOwppbmZvTGFiZWwgKz0gYFtmb3JtYXRdOiB2JHthYkFydGlmYWN0QnVuZGxlLmZvcm1hdFZlcnNpb259XG5gOwppbmZvTGFiZWwgKz0gYFtjcmVhdGVkIHRpbWVdOiAke0RhdGVUaW1lLmZyb21JU08oYWJBcnRpZmFjdEJ1bmRsZS5jcmVhdGVkVGltZXN0YW1wKS50b0xvY2FsZVN0cmluZyhEYXRlVGltZS5EQVRFVElNRV9TSE9SVF9XSVRIX1NFQ09ORFMpfVxuYDsKCi8vIEhlYWRlcgpjb25zdCBpbmZvQm90ID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVUZXh0KHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgbGFiZWw6IGluZm9MYWJlbCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaChpbmZvQm90KTsKCi8vIERvd25sb2FkIGFydGlmYWN0IGJ1dHRvbi4KY29uc3QgZG93bmxvYWRCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGFiQXJ0aWZhY3RCb3Q6IGdldExpbmsoYWJBcnRpZmFjdEJvdCksCiAgICBhYkFydGlmYWN0VG9vbDogZ2V0TGluayh0aGlzQm90KSwKICAgIGZvcm1BZGRyZXNzOiAnZG93bmxvYWQnLAogICAgbGFiZWw6IGBkb3dubG9hZCBhcnRpZmFjdGAsCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IGxpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gJ2FiQXJ0aWZhY3QtJyArIGFiQXJ0aWZhY3RCdW5kbGUubmFtZSArICctJyArIGFiQXJ0aWZhY3RCdW5kbGUuaWQuc3Vic3RyaW5nKDAsNykgKyAnLmF1eCc7IAogICAgICAgIG9zLmRvd25sb2FkQm90cyhbIGxpbmtzLmFiQXJ0aWZhY3RCb3QgXSwgZmlsZW5hbWUpOwogICAgICAgIAogICAgICAgIGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKICAgIGAsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2goZG93bmxvYWRCdXR0b24pOwoKLy8gVXBkYXRlIGFydGlmYWN0IGJ1dHRvbi4KY29uc3QgdXBkYXRlQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgYWJBcnRpZmFjdFRvb2w6IGdldExpbmsodGhpc0JvdCksCiAgICBmb3JtQWRkcmVzczogJ3N5bmMnLAogICAgbGFiZWw6IGB1cGRhdGUgYXJ0aWZhY3RgLAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGUgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBhd2FpdCBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCdW5kbGUubmFtZSB9KTsKCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdEJvdE1lbnVPcGVuKHsgYWJBcnRpZmFjdEJvdDogbGlua3MuYWJBcnRpZmFjdEJvdCB9KTsKICAgIGAsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2godXBkYXRlQnV0dG9uKTsKCm1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCA9IGFiQXJ0aWZhY3RCb3QuaWQ7JwCRkKUuuJEEFmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQCBACRkKUurZcF7wFAaWYgKHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzICYmIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLmxlbmd0aCA+IDApIHsKICAgIGRlc3Ryb3kodGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMpOwogICAgdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMgPSBbXTsKfQoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBudWxsOycAkZClLriRBAV0eXBlcwIEAJGQpS6dmQXjBPCfk4RpbnRlcmZhY2UgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZyB7CiAgICBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ/OiBzdHJpbmc7CiAgICB0b2FzdD86IGJvb2xlYW47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RGVwZW5kZW5jeSB7CiAgICBhYklEOiBzdHJpbmc7CiAgICByZWNvcmRLZXk6IHN0cmluZzsKICAgIGFiVmVyc2lvbj86IG51bWJlcjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RCdW5kbGUgewogICAgaWQ6IHN0cmluZzsKICAgIG5hbWU6IHN0cmluZzsKICAgIGZvcm1hdFZlcnNpb246IG51bWJlcjsKICAgIGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT47CiAgICBkZXBlbmRlbmNpZXM6IEFycmF5PEFCQXJ0aWZhY3REZXBlbmRlbmN5PjsKICAgIGNhc3VhbE9TVmVyc2lvbjogQXV4VmVyc2lvbjsKICAgIGNyZWF0ZWRUaW1lc3RhbXA6IHN0cmluZzsKICAgIGFiU2hlbGxWZXJzaW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0U2hhcmQgewogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+Owp9JwCRkKUuuJEEEGFiR2V0QXJ0aWZhY3RJRHMCBACRkKUu/50FygFAY29uc3QgYWJBcnRpZmFjdElEcyA9IG5ldyBTZXQoKTsKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGU/LmlkKSB7CiAgICAgICAgYWJBcnRpZmFjdElEcy5hZGQoYi50YWdzLmFiQXJ0aWZhY3RCdW5kbGUuaWQpOwogICAgfQp9KQoKcmV0dXJuIGFiQXJ0aWZhY3RJRHM7JwCRkKUuuJEEGm9uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlAgQAkZClLsqfBfIxQGlmICghY29uZmlnQm90LnRhZ3MucmVjb25zdGl0dXRpb24pIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmNvbnN0IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9CgppZiAoc291cmNlRXZlbnQgPT09ICdhc2snIHx8IHNvdXJjZUV2ZW50ID09PSAncGFzdGUnIHx8IHNvdXJjZUV2ZW50ID09PSAnZmlsZXVwbG9hZCcpIHsKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYm90cyBiZWluZyBhZGRlZCBhcmUgYXJ0aWZhY3Qgc2hhcmRzIHRoYXQgbmVlZHMgdG8gYmUgcmVjb25zdGl0dXRlZC4KICAgIGNvbnN0IGFydGlmYWN0c1RvUmVjb25zdGl0dXRlOiBSZWNvcmQ8c3RyaW5nLCBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnPiA9IHt9OyAvLyBLZXkgaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VJRHM6IFNldDxzdHJpbmc+ID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VJRHMoKTsKICAgIGNvbnN0IGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVGhpcyBzZXQgdHJhY2tzIGFydGlmYWN0IGlkcyB0aGF0IGFyZSBhbHJlYWR5IHF1ZXVlZCB0byBiZSByZWNvbnN0aXR1dGVkIHdpdGggYSBuZXcgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7IC8vIFRyYWNrIG9yaWdpbmFsIGluc3RhbmNlIElEcyB0aGF0IHdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBnaXZlIG5ldyBpbnN0YW5jZXMKCiAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgaWYgKGRhdGEgJiYKICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICAgICAgICAgICFkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZT8uc3RhcnRzV2l0aCgn8J+nrCcpCiAgICAgICAgKSB7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmcgPSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBKU09OLnBhcnNlKGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlLnN1YnN0cmluZygyKSk7CgogICAgICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgICAgIC8vIFNoYXJkIGhhcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZUlEcy5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpICYmICFvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxOiBJbnN0YW5jZSBhbHJlYWR5IGV4aXN0cyAtIGNyZWF0ZSBuZXcgaW5zdGFuY2UgKGZpcnN0IHRpbWUgd2Ugc2VlIHRoaXMgY29sbGlzaW9uKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuYWRkKGFiQXJ0aWZhY3RCdW5kbGUuaWQpOyAvLyBUcmFjayB0aGF0IHdlJ3JlIGNyZWF0aW5nIGEgbmV3IGluc3RhbmNlIGZvciB0aGlzIGFydGlmYWN0IElECiAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuYWRkKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsgLy8gVHJhY2sgdGhhdCB3ZSd2ZSBkZWNpZGVkIHRvIHJlcGxhY2UgdGhpcyBvcmlnaW5hbCBpbnN0YW5jZSBJRAoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMTogU2hhcmQgZnJvbSBleGlzdGluZyBpbnN0YW5jZS4gQ3JlYXRpbmcgbmV3IGluc3RhbmNlLiAob2xkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSwgbmV3OiAke25ld0FydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxYjogV2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBvcmlnaW5hbCBJRCAtIGFkZCB0aGlzIHNoYXJkIHRvIHRoYXQgbmV3IGluc3RhbmNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDFiOiBBZGRpdGlvbmFsIHNoYXJkIGZvciByZXBsYWNlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAob3JpZ2luYWw6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF0pIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDI6IEluc3RhbmNlIGFscmVhZHkgcXVldWVkIGZvciByZWNvbnN0aXR1dGlvbiAtIGRpc3Bvc2UgZHVwbGljYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDI6IER1cGxpY2F0ZSBzaGFyZCBmb3IgcXVldWVkIGluc3RhbmNlLiBEaXNwb3NpbmcuIChhYkFydGlmYWN0SW5zdGFuY2VJRDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDM6IE5ldyBpbnN0YW5jZSB0byByZWNvbnN0aXR1dGUgd2l0aCBleGlzdGluZyBJRAogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMzogTmV3IGluc3RhbmNlIHRvIHJlY29uc3RpdHV0ZS4gKGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTaGFyZCBoYXMgbm8gYXJ0aWZhY3QgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgIGlmIChhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5oYXMoYWJBcnRpZmFjdEJ1bmRsZS5pZCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDQ6IEFydGlmYWN0IGFscmVhZHkgaGFzIG5ldyBpbnN0YW5jZSBxdWV1ZWQgLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSA0OiBEdXBsaWNhdGUgc2hhcmQgZm9yIGFydGlmYWN0IHdpdGggbmV3IGluc3RhbmNlIHF1ZXVlZC4gRGlzcG9zaW5nLiAoYXJ0aWZhY3RJZDogJHthYkFydGlmYWN0QnVuZGxlLmlkfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgNTogQ3JlYXRlIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuYWRkKGFiQXJ0aWZhY3RCdW5kbGUuaWQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgNTogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIGZvciBhcnRpZmFjdCB3aXRob3V0IGluc3RhbmNlIElELiAobmV3OiAke25ld0FydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgYSBzaGFyZCBib3QuIElnbm9yZSBpdC4KICAgICAgICB9CiAgICB9CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlOmAsIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZUlEczpgLCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VJRHMpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6YCwgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQ6YCwgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQpOwogICAgfQoKICAgIGZvciAoY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpIHsKICAgICAgICBjb25zdCByZWNvbnN0aXR1dGVBcmc6IEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgPSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF07CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBSZWNvbnN0aXR1dGluZyBhcnRpZmFjdCBpbnN0YW5jZTogJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpc0JvdC5hYkFydGlmYWN0UmVjb25zdGl0dXRlKHJlY29uc3RpdHV0ZUFyZyk7CiAgICB9Cn0nAJGQpS64kQQbb25BQlByZXByb2Nlc3NCZWZvcmVQdWJsaXNoAgQAkZClLrvRBdYBQGlmICghY29uZmlnQm90LnRhZ3MucmVjb25zdGl0dXRpb24pIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfScAkZClLriRBA9hYlB1Ymxpc2hTaGFyZHMCBACRkKUuktMF6ghAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzdHVkaW8sCiAgICBzaGFyZEJvdHMsCiAgICBtYW51YWxQdWJsaXNoLAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdE5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBzdHVkaW8gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0dWRpbyBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiUHVibGlzaEFCKHsgCiAgICBhYjogYWJBcnRpZmFjdE5hbWUsIAogICAgdGFyZ2V0OiBzaGFyZEJvdHMsIAogICAgc3R1ZGlvLAogICAgbWFudWFsUHVibGlzaCwKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2g6IChhcmcpID0+IHsKICAgICAgICAvLyBSZW1vdmUgYWxsIGFydGlmYWN0IGRhdGEgZnJvbSB0aGUgYm90IGRhdGEgYmVpbmcgcHVibGlzaGVkIChleGNlcHQgZm9yIGFiQXJ0aWZhY3ROYW1lKS4KICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBhcmcuYm90RGF0YSkgewogICAgICAgICAgICBjb25zdCBkYXRhID0gYXJnLmJvdERhdGFba2V5XTsKCiAgICAgICAgICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQ7CiAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0pOycBBGJvdHMkOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjAScAkZClLv3bBQZzeXN0ZW0CBACRkKUu/tsFDmFiLnNoZWxsLnV0aWxzJwCRkKUu/dsFDGFiQ29tcGlsZUNTUwIEAJGQpS6N3AWCBEBsZXQgYm90cyA9IHRoYXQ7Cgpib3RzID0gQXJyYXkuaXNBcnJheShib3RzKSA/IGJvdHMgOiBbYm90c107CgpsZXQgY3NzID0gW107Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgZm9yIChsZXQga2V5IGluIGJvdC50YWdzKSB7CiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCdjc3MnKSkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBDU1Mga2V5OiAke2tleX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3MucHVzaChib3QudGFnc1trZXldKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IGNvbXBpbGVkID0gY3NzLmpvaW4oJ1xuXG4nKTsKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY29tcGlsZWQgQ1NTOlxuXG5gLCBjb21waWxlZCk7Cn0KCnJldHVybiBjb21waWxlZDsnAJGQpS792wUIYWJJZ25vcmUCBACRkKUukOAFBHRydWUnAJGQpS792wUHYWJTaGVsbAIEAJGQpS6V4AUEdHJ1ZScAkZClLv3bBQlhYlZlcnNpb24CBACRkKUumuAFBDEwLjUnAJGQpS792wUNYWJMb2dBbmRUb2FzdAIEAJGQpS6f4AWzCkBsZXQgbWVzc2FnZTsKbGV0IGR1cmF0aW9uOwpsZXQgbG9nVHlwZSA9ICdsb2cnOwpsZXQgdG9hc3QgPSB0cnVlOwoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgbWVzc2FnZSA9IHRoYXQ7CiAgICBkdXJhdGlvbiA9IHRoaXNCb3QuZXN0aW1hdGVSZWFkaW5nVGltZSh7IHRleHQ6IHRoYXQsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDA7Cn0gZWxzZSB7CiAgICBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uID8/ICh0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0Lm1lc3NhZ2UsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDApOwogICAgbG9nVHlwZSA9IHRoYXQubG9nVHlwZSA/PyBsb2dUeXBlOwogICAgdG9hc3QgPSB0aGF0LnRvYXN0ID8/IHRvYXN0Owp9CgppZiAobG9nVHlwZSA9PT0gJ2xvZycpIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnd2FybmluZycgfHwgbG9nVHlwZSA9PT0gJ3dhcm4nKSB7CiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogV2FybmluZzogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS53YXJuKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QoYFdhcm5pbmc6ICR7bWVzc2FnZX1gLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ2Vycm9yJykgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6IEVycm9yOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmVycm9yKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QoYEVycm9yOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9JwCRkKUu/dsFCHJlbWVtYmVyAgQAkZClLtPqBSjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCRkKUu/dsFBWFiTG9nAgQAkZClLvrqBccBQGlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICB9KTsKfSBlbHNlIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgLi4udGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICB9KTsKfScAkZClLv3bBRNlc3RpbWF0ZVJlYWRpbmdUaW1lAgQAkZClLsLsBdwDQGNvbnN0IHsKICAgIHRleHQgPSAnJywKICAgIHdvcmRzUGVyTWludXRlID0gMjUwLAogICAgZGVsYXlUaW1lID0gNTAwLAp9ID0gdGhhdDsKCi8vIENvdW50IHdvcmRzIChyb3VnaCBhcHByb3hpbWF0aW9uIGJ5IHNwbGl0dGluZyBvbiB3aGl0ZXNwYWNlKQpjb25zdCB3b3JkQ291bnQgPSB0ZXh0LnRyaW0oKS5zcGxpdCgvXHMrLykubGVuZ3RoOwpsZXQgdG90YWxUaW1lTXMgPSAwOwoKaWYgKHdvcmRDb3VudCA+IDApIHsKICAgIC8vIENhbGN1bGF0ZSByZWFkaW5nIHRpbWUgaW4gbWlsbGlzZWNvbmRzCiAgICBjb25zdCB3b3Jkc1BlclNlY29uZCA9IHdvcmRzUGVyTWludXRlIC8gNjA7CiAgICBjb25zdCByZWFkaW5nVGltZU1zID0gTWF0aC5jZWlsKCh3b3JkQ291bnQgLyB3b3Jkc1BlclNlY29uZCkgKiAxMDAwKTsKCiAgICB0b3RhbFRpbWVNcyA9IHJlYWRpbmdUaW1lTXMgKyBkZWxheVRpbWU7Cn0KCnJldHVybiB0b3RhbFRpbWVNczsnAJGQpS792wUIaXNPYmplY3QCBACRkKUun/AFOUByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdvYmplY3QnICYmICFBcnJheS5pc0FycmF5KHRoYXQpOycAkZClLv3bBQdpc0FycmF5AgQAkZClLtnwBRxAcmV0dXJuIEFycmF5LmlzQXJyYXkodGhhdCk7JwCRkKUu/dsFCGlzU3RyaW5nAgQAkZClLvbwBSFAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJzsnAQRib3RzJGQ4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNQEnAJGQpS6Y8QUGc3lzdGVtAgQAkZClLpnxBQ9hYi5zaGVsbC5zZWFyY2gnAJGQpS6Y8QUEZm9ybQIEAJGQpS6p8QUHbm90aGluZycAkZClLpjxBQ5hYlJldHJpZXZlRmlsZQIEAJGQpS6x8QWCAUAvL3B1bGwgZG93biBmaWxlIGRhdGEKaWYgKCF0aGF0LnVybCkKewogICAgcmV0dXJuICJubyBmaWxlIHVybCBzdXBwbGllZCI7Cn0KCmxldCBkYXRhID0gYXdhaXQgb3MuZ2V0RmlsZSh0aGF0LnVybCk7CgpyZXR1cm4gZGF0YTsnAJGQpS6Y8QUQYWJSZXRyaWV2ZVJlY29yZAIEAJGQpS608gXsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwCRkKUumPEFCHJlbWVtYmVyAgQAkZClLqH3BSjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCRkKUumPEFDW1hbmlmZXN0YXRpb24CBACRkKUuyPcFKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJGQpS6Y8QUOb25Mb29rdXBBQkVnZ3MCBACRkKUu7/cFjjFAY29uc3QgeyAKICAgIGFiSUQsCiAgICBhYlZlcnNpb24sCiAgICBpbml0aWFsQm9vdCwKICAgIGF1dG9IYXRjaCwKICAgIHJldHVyblR5cGUsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5LAogICAgdG9hc3QgPSB0cnVlLAogICAgc2hvd0luZGljYXRvciA9IHRydWUsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsLiAob3B0aW9uYWwpCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgphYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGxvYWRpbmcgIiArIGFiSUQpOwoKLy9jbGVhciBhYi0xCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uICYmIGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgPT0gImFiTWVudSIpIHsKICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwp9CgpsZXQgYnVzeUluZGljYXRvcjsKCmlmIChzaG93SW5kaWNhdG9yKSB7CiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQoKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgbG9hZGluZyAke2FiSUR9YH0pOwp9Cgpjb25zdCBwb3NzaWJsZUF1dGggPSBhdXRoQm90ID8gYXV0aEJvdCA6IHRydWU7CmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgpsZXQgZWdnRGF0YTsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYKICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5ICYmCiAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gInJlY29yZF9ub3RfZm91bmQiCiAgICApIHsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiKSB7CiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9sb2dnZWRfaW4iKSB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCiAgICAgICAgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiAKICAgICAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIgogICAgICAgICkgewogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHRvYXN0KSB7IAogICAgICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKICAgIH0KCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgIH0KCiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CmVsc2UgewogICAgY29uc3QgcHVibGljUmVhZFRlc3QgPSBnZXRSZWNvcmQubWFya2Vycy5pbmRleE9mKCJwdWJsaWNSZWFkIik7CiAgICBjb25zdCBhdXRob3IgPSBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwoKICAgIGlmIChwdWJsaWNSZWFkVGVzdCAhPSAtMSAmJiBhdXRob3IpIHsKICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIHsKICAgICAgICAgICAgY29uc3QgZWdnSGF0Y2hFdmVudCA9IGFiSUQ7CgogICAgICAgICAgICBvcy5yZWNvcmRFdmVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBlZ2dIYXRjaEV2ZW50KTsKICAgICAgICB9CiAgICB9CgogICAgLy9wYWNrYWdlIHRoZSByZWNvcmQgZGF0YQogICAgZWdnRGF0YSA9IGdldFJlY29yZC5kYXRhOwoKICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAvLyBDaGFuZ2UgaW5pdGlhbCB0YXJnZXQgdmVyc2lvbiBvZiB0aGUgZWdnIGlmIGFiVmVyc2lvbiBpcyBwcm92aWRlZC4KICAgICAgICBlZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBhYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCmlmIChyZXR1cm5UeXBlICE9IG51bGwpIHsKICAgIGlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICAgICAgICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYWJWZXJzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSBhYlZlcnNpb24gLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlZ2dEYXRhVVJMID0gZ2V0UmVjb3JkLmRhdGEuZWdnVmVyc2lvbkhpc3RvcnlbdmVyc2lvbl07CiAgICAgICAgICAgIGNvbnN0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXR1cm5EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocmV0dXJuVHlwZSA9PT0gImVnZyIpIHsKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNpbXBseSByZXR1cm4gdGhlIGVnZyBkYXRhIGlmIHJlcXVlc3RlZC4KICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZC5kYXRhOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVGhpcyBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgYXV4IGZpbGVzIHN0b3JlZCBiZWZvcmUgdGhlIHJlY29yZCBzeXN0ZW0gZXhpc3RlZC4KICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGNvbnN0IHZlcnNpb25BcnJheSA9IEpTT04ucGFyc2UoZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeSk7CiAgICAgICAgICAgIGNvbnN0IGZpbGVVVUlEID0gdmVyc2lvbkFycmF5W2VnZ0RhdGEubWF4VmVyc2lvbiAtIDFdOwogICAgICAgICAgICBjb25zdCBmaWxlbmFtZWhhc2hMVE0gPSBjcnlwdG8uc2hhMjU2KGZpbGVVVUlEKTsKICAgICAgICAgICAgY29uc3QgZmlsZXVybGhhc2hMVE0gPSAiYXV4XyIgKyBmaWxlbmFtZWhhc2hMVE0gKyAnLmF1eCc7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldExUTVVSTCA9ICJodHRwczovL2J1aWxkZXItbHRtLWZpbGVzLnMzLmFtYXpvbmF3cy5jb20vIiArIGZpbGV1cmxoYXNoTFRNOwogICAgICAgICAgICBjb25zdCBvID0gewogICAgICAgICAgICAgICAgbWV0aG9kOiAiR0VUIiwKICAgICAgICAgICAgICAgIHVybDogdGFyZ2V0TFRNVVJMCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsZXQgZmlsZUdldCA9IGF3YWl0IHdlYmhvb2sobyk7CgogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZpbGVHZXQuc3RhdHVzICE9IDIwMCkgewogICAgICAgICAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgb3MudG9hc3QoIm5vIGZpbGUgZm91bmQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CgogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZpbGVHZXQgPSBmaWxlR2V0LmRhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmaWxlR2V0OwogICAgICAgIH0KICAgIH0KfQoKLy9hYiBzcGVjaWZpYyB2YXJpYWJsZXMgZm9yIHVuZGVyc3RhbmRpbmcgaWYgYSBwb3NpdGlvbiBpcyBzcGVjaWZpZWQKbGV0IGN1cnJlbnREaW07CmxldCBzcGFjZU1vZDsKbGV0IGRpbWVuc2lvblg7CmxldCBkaW1lbnNpb25ZOwpsZXQgZGltTW9kOwoKLy9oYW5kbGUgZGltZW5zaW9uIGlkZW50aWZpY2F0aW9uCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGNvbnN0IGFiQm90ID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdDsKCiAgICAgICAgY3VycmVudERpbSA9IGFiQm90LnRhZ3MuZGltZW5zaW9uOwogICAgfQp9CmVsc2UgewogICAgY3VycmVudERpbSA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKLy9jaGVja3MgZm9yIGdyaWQgZm9jdXMKaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzKSB7CiAgICBkaW1lbnNpb25YID0gbnVsbDsKICAgIGRpbWVuc2lvblkgPSBudWxsOwp9CmVsc2UgewogICAgbGV0IGhhdGNoUG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKICAgIGN1cnJlbnREaW0gPSBoYXRjaFBvaW50LmRpbWVuc2lvbjsKICAgIGRpbWVuc2lvblggPSBoYXRjaFBvaW50LnBvc2l0aW9uLng7CiAgICBkaW1lbnNpb25ZID0gaGF0Y2hQb2ludC5wb3NpdGlvbi55OwogICAgc3BhY2VNb2QgPSB7IHNwYWNlOiAic2hhcmVkIiB9Owp9CgovL3RoaXMgbG9naWMgaGFuZGxlcyBsb2dpYyBhcm91bmQgYXV0b0hhdGNoIHZzIG1hbnVhbCBoYXRjaGluZwppZiAoIWF1dG9IYXRjaCAmJiBjb25maWdCb3QudGFncy5wYXR0ZXJuID09IG51bGwpIHsKICAgIGRpbU1vZCA9IHsKICAgICAgICBbY3VycmVudERpbV06IHRydWUsCiAgICAgICAgW2N1cnJlbnREaW0gKyAiWCJdOiBkaW1lbnNpb25YLAogICAgICAgIFtjdXJyZW50RGltICsgIlkiXTogZGltZW5zaW9uWSwKICAgICAgICBkaW1lbnNpb246IGN1cnJlbnREaW0KICAgIH07Cn0KZWxzZSB7CiAgICBkaW1Nb2QgPSB7IGF1dG9IYXRjaDogdHJ1ZSwga2V5IH07Cn0KCi8vY2FsbCBmb3Igb3ZvIHdpdGggaW5mb3JtYXRpb24gcHJvdmlkZWQKY29uc3QgbWFuaWZlc3RSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm1hbmlmZXN0T3ZvKHsKICAgIGFiSUQsCiAgICBzdHVkaW86IHJlY29yZEtleSwKICAgIGRpbU1vZCwKICAgIHNwYWNlTW9kLAogICAgZWdnRGF0YSwKICAgIGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50LAp9KTsKCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIGhhdGNoZWRCb3RzOiBtYW5pZmVzdFJlc3VsdD8uaGF0Y2hlZEJvdHMsCn07JwCRkKUumPEFC21hbmlmZXN0T3ZvAgQAkZClLv6oBrUPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCmlmIChsaW5rcy5vdm9Cb3QpIHsKICAgIGRlc3Ryb3kobGlua3Mub3ZvQm90KTsKfQoKbGV0IGVnZ01vZCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGluaXRpYWxUaW1lcjogdHJ1ZSwKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBzb3VyY2VFdmVudCwKICAgIGN1cnNvcjogJ3BvaW50ZXInLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5pbnRlcmFjdE92bygpOwogICAgYCwKICAgIGZvcm06ICJlZ2ciLAogICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICBwcm9ncmVzc0JhckNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yLAogICAgcHJvZ3Jlc3NCYXJCYWNrZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNSwKICAgIG9uUG9pbnRlckVudGVyOiBgQAogICAgICAgIG1hc2tzLnRpcElkID0gYXdhaXQgb3MudGlwKHRhZ3MuYWJJRCArICcgdicgKyB0YWdzLnRhcmdldFZlcnNpb24pOwogICAgYCwKICAgIG9uUG9pbnRlckV4aXQ6IGBACiAgICAgICAgaWYgKG1hc2tzLnRpcElkKSB7CiAgICAgICAgICAgIG9zLmhpZGVUaXBzKG1hc2tzLnRpcElkKTsKICAgICAgICB9CiAgICBgLAogICAgbGFiZWxQb3NpdGlvbjogImZyb250IiwKICAgIG9yaWVudGF0aW9uTW9kZTogImJpbGxib2FyZEZyb250IiwKICAgIG9uRGVzdHJveTogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLm1hc2tzLm92b0JvdCA9IG51bGw7CiAgICBgLAogICAgZWdnVGltZXI6IGBACiAgICAgICAgaWYgKHRhZ3MucHJvZ3Jlc3NCYXIgPCAxKSB7CiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgKz0gMC4xOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7d2hpc3Blcih0aGlzQm90LCAiZWdnVGltZXIiKTt9LCA3NSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5vbkNsaWNrKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyID0gbnVsbDsKICAgICAgICB9CiAgICBgCn07CgoKY29uc3Qgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7Cm1hc2tzLm92b0JvdCA9IGdldExpbmsob3ZvKTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsKfQoKaWYgKG92by50YWdzLmF1dG9IYXRjaCkgewogICAgY29uc3QgaGF0Y2hlZEJvdHMgPSBhd2FpdCB0aGlzQm90LmhhdGNoT3ZvKG92byk7CiAgICByZXR1cm4geyBoYXRjaGVkQm90cyB9Owp9CmVsc2UgewogICAgb3ZvLnRhZ3MucHJvZ3Jlc3NCYXIgPSAwOwogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG92by50YWdzLm1heFZlcnNpb247CiAgICBzZXRUaW1lb3V0KCgpID0+IHsgd2hpc3Blcihvdm8sICJlZ2dUaW1lciIpOyB9LCA3NSk7Cn0nAJGQpS6Y8QUJb25LZXlEb3duAgQAkZClLrS4BoIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAJGQpS6Y8QUIaGF0Y2hPdm8CBACRkKUutb4GnRVALy9sb2dpYyBmb3IgaGF0Y2hpbmcgb2YgYW4gYWIKc2hvdXQoJ292b01lbnVSZXNldCcpOwoKLy9kYXRhIGluIHJlZ2FyZHMgdG8gd2hhdCBhYiBpcyBnb2luZyB0byBiZSBoYXRjaGVkCmNvbnN0IG92byA9IHRoYXQ7CgovL2hhdGNoIHNwZWNpZmljIHZhcmlhYmxlcwpsZXQgaW5pdGlhbEJvb3QgPSBvdm8udGFncy5pbml0aWFsQm9vdDsKbGV0IHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5zdGFibGVWZXJzaW9uID8/IG92by50YWdzLnRhcmdldFZlcnNpb247CgppZiAoKGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbiB8fCBjb25maWdCb3QudGFncy5wYXR0ZXJuVmVyc2lvbikgJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbiA/PyBjb25maWdCb3QudGFncy5wYXR0ZXJuVmVyc2lvbjsKfQoKLy90YXJnZXRlZCB2ZXJzaW9ucwppZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIgfHwgIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKSkKewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImZlZWRiYWNrIikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uOwogICAgfQogICAgZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiY3VycmVudCIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKICAgIH0KICAgIGVsc2UgaWYgKCFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MudmVyc2lvbgogICAgfQoKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBudWxsOwp9CgppZiAoaXNOYU4odGFyZ2V0VmVyc2lvbikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7Cn0KCmxldCB2ZXJzaW9uQXJyYXkgPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeTsKbGV0IGZpbGVVUkwgPSB2ZXJzaW9uQXJyYXlbdGFyZ2V0VmVyc2lvbiAtIDFdOwpsZXQga2V5ID0gb3ZvLnRhZ3Mua2V5ID8gb3ZvLnRhZ3Mua2V5IDogY29uZmlnQm90LnRhZ3Mua2V5OwpsZXQgZmlsZUdldDsKCi8vYWN0dWFsIGZpbGUgcmV0cmlldmFsCnRyeQp7CiAgICBmaWxlR2V0ID0gYXdhaXQgb3MuZ2V0RmlsZShmaWxlVVJMKTsKfQpjYXRjaCAoZSkKewogICAgY29uc29sZS5lcnJvcihlKTsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJ25vIGZpbGUgZm91bmQnKTsKCiAgICByZXR1cm47Cn0KCi8vaGFuZGxpbmcgZm9yIGVuY3J5cHRlZCBhYiBmaWxlCmlmIChjcnlwdG8uaXNFbmNyeXB0ZWQoZmlsZUdldCkpCnsKICAgIGlmICgha2V5KQogICAgewogICAgICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgnJywgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdFbnRlciBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgZmlsZUdldCA9IGNyeXB0by5kZWNyeXB0KGtleSwgZmlsZUdldCk7CgogICAgaWYgKGZpbGVHZXQgPT0gbnVsbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJ2luY29ycmVjdCBrZXknKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgIAogICAgZmlsZUdldCA9IEpTT04ucGFyc2UoZmlsZUdldCk7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQplbHNlCnsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CgovL2NsZWFuIHVwCmRlc3Ryb3kob3ZvKTsKCi8vdG9hc3QgaWYgbm90IG9uIHN0YWJsZQppZihvdm8udGFncy5zdGFibGVWZXJzaW9uICE9IHRhcmdldFZlcnNpb24gJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50KQp7CiAgICBpZiAob3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uID09IHRhcmdldFZlcnNpb24pCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWQgZmVlZGJhY2sgdmVyc2lvbiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWQgdmVyc2lvbiAiICsgdGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCArICIgb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQp9CgovL2dlbmVyYXRlIGJvdHMgYmFzZWQgb24gdGhlIGZpbGUgcmV0cmlldmVkICpIRVJFKgpjb25zdCBuZXdCb3RzID0gYXdhaXQgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7CiAgICBib3RzOiBmaWxlR2V0LAogICAgb3JpZ2luOiBvdm8udGFncy5hYklELAogICAgc3R1ZGlvOiBvdm8udGFncy5zdHVkaW8sCiAgICB2ZXJzaW9uOiB0YXJnZXRWZXJzaW9uLAogICAgaW5pdGlhbEJvb3Q6IGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVyczogb3ZvLnRhZ3MuZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogb3ZvLnZhcnMub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQ6IG92by50YWdzLnNvdXJjZUV2ZW50LAp9KTsKCnJldHVybiBuZXdCb3RzOycAkZClLpjxBQtpbnRlcmFjdE92bwIEAJGQpS7T0wbpBkAvL21hbnVhbCBoYXRjaCBtZW51CmNvbnN0IG92b0JvdCA9IHRoYXQgPyB0aGF0IDogbGlua3Mub3ZvQm90OwoKaWYgKCFvdm9Cb3QpIHsKICAgIHJldHVybjsKfQoKc2hvdXQoIm92b01lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJPdm9NZW51IjsKCm1hc2tzLm9uR3JpZENsaWNrID0gYEAKICAgIHNob3V0KCJvdm9NZW51UmVzZXQiKTsKYDsKbWFza3Mub3ZvTWVudVJlc2V0ID0gYEAKICAgIG1hc2tzLm9uR3JpZENsaWNrID0gbnVsbDsKICAgIG1hc2tzLm92b01lbnVSZXNldCA9IG51bGw7CgogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKb3MudHdlZW5Ubyhvdm9Cb3QsIDE1LDQ1LDQ1LCA1KTsKCmNvbnN0IGVnZ01lbnVCdXR0b24gPSB7CiAgICBhYk92b01lbnU6IHRydWUsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb3ZvQm90OiBnZXRMaW5rKG92b0JvdCksCiAgICBjb2xvcjogYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgdGFyZ2V0VmVyc2lvbjogb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwKICAgIGxhYmVsOiBgaGF0Y2ggJHtvdm9Cb3QudGFncy5hYklEfSB2JHtvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9ufSBvZiAke292b0JvdC50YWdzLm1heFZlcnNpb259YCwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIG92b01lbnVSZXNldDogYEAKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgYCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOwogICAgYCwKfTsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGVnZ01lbnVCdXR0b24pOycAkZClLpjxBQZjcmVhdGUCBACRkKUuvdoGKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAJGQpS6Y8QUQY2hhbmdlT3ZvVmVyc2lvbgIEAJGQpS7k2gbwAkAvL2xvZ2ljIGZvciB2ZXJzaW9uIGNoYW5naW5nIHdoZW4gbWFudWFsbHkgaGF0Y2hpbmcgYW4gYWIKY29uc3Qgb3ZvQm90ID0gbGlua3Mub3ZvQm90OwoKbGV0IG5ld1ZlcnNpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQob3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwgewogICAgcGxhY2Vob2xkZXI6ICJlbnRlciBhIHZlcnNpb24gZnJvbSAxIHRvICIgKyBvdm9Cb3QudGFncy5tYXhWZXJzaW9uCn0pOwoKb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiA9IG5ld1ZlcnNpb247Cm92b0JvdC50YWdzLmxhYmVsID0gJ3YnKyBuZXdWZXJzaW9uOwoKY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG5ld1ZlcnNpb247CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7JwCRkKUumPEFBG1lbnUCBACRkKUu1d0GKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJGQpS6Y8QUIYWJJZ25vcmUCBACRkKUu/N0GBHRydWUnAJGQpS6Y8QUHYWJTaGVsbAIEAJGQpS6B3gYEdHJ1ZScAkZClLpjxBQxhYjFMVE1TZWFyY2gCBACRkKUuht4GM0AvL3N1cHBvcnQgb2xkIHN5bnRheAp0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOycAkZClLpjxBQ1vbkxvb2t1cEFza0lEAgQAkZClLrreBtUIQGxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGBsb29rdXAgdXAgJHt0aGF0LmFza0lEfWB9KTsKCmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRDsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0LnNvdXJjZUV2ZW50Owpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKbGV0IGxvb2t1cEFzazsgCgp0cnkKewogICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwgZW5kcG9pbnQpOwp9CmNhdGNoCnsKICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgdGhhdC5hc2tJRCwgZW5kcG9pbnQpOwp9CgppZiAodGhhdC5jaGFubmVsQ29uZmlnKQp7CiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pCiAgICB7CiAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICB9CiAgICAKICAgIHJldHVybiBsb29rdXBBc2s7Cn0KZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmRhdGEucGF0dGVybklEKQp7CiAgICBpZiAobG9va3VwQXNrLmRhdGEuc3R1ZGlvSUQgPT0gIkFCIikKICAgIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCk7CgogICAgICAgIHNob3V0KCJvbkFCSW5pdGlhbGl6ZWQiKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHthYklEOiBsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQsIHJlY29yZEtleTogbG9va3VwQXNrLmRhdGEuc3R1ZGlvSUQsIGF1dG9IYXRjaDogdHJ1ZSwgc291cmNlRXZlbnQgfSk7ICAKICAgIH0KfQplbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiAhbG9va3VwQXNrLmRhdGEudXJsKQp7CiAgICBsb29rdXBBc2suc3VjY2VzcyA9ICFsb29rdXBBc2suc3VjY2VzczsKfQoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIGxvb2t1cEFzazsnAJGQpS6Y8QUFaW5wdXQCBACRkKUukOcGKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAJGQpS6Y8QUFaGF0Y2gCBACRkKUut+cGwAFALy9zaG91dCgiaGF0Y2giLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGtleToga2V5LCBhdXRvSGF0Y2g6IGJvb2xlYW4sIHJldHVyblR5cGU6IGRhdGEvbnVsbCwgZWdnUGFyYW1ldGVyczogYXJnfSk7Cgpjb25zdCBsb29rVXAgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOwoKcmV0dXJuIGxvb2tVcDsnAJGQpS6Y8QUJYWJWZXJzaW9uAgQAkZClLvjoBgQxMC41JwCRkKUumPEFBWxlYXJuAgQAkZClLv3oBijwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCRkKUumPEFCmFiTG9hZFRvb2wCBACRkKUupOkGsAdAbGV0IHsKICAgIHRvb2xOYW1lLAogICAgdG9vbFBhcmFtZXRlcnMsCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodG9vbE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdG9vbE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7Cgpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRvb2xQYXJhbWV0ZXJzOmAsIHRvb2xQYXJhbWV0ZXJzKTsKCmNvbnN0IHVybCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWJ0b29scy8ke3Rvb2xOYW1lfS5hdXhgKTsKCmxldCBhdXg7Cgp0cnkgewogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7CiAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICB1cmwsCiAgICB9KQoKICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgIGF1eCA9IHJlc3BvbnNlLmRhdGE7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGxldCBtZXNzYWdlID0gYEZhaWxlZCB0byBkb3dubG9hZCB0b29sICcke3Rvb2xOYW1lfScuYDsKICAgIGlmIChlLm1lc3NhZ2UpIHsKICAgICAgICBtZXNzYWdlICs9IGAgRXJyb3I6ICR7ZS5tZXNzYWdlfWA7CiAgICB9CgogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChtZXNzYWdlKTsKfQppZiAoYXV4KSB7CiAgICBpZiAoYXV4LnZlcnNpb24gPT09IDEpIHsKICAgICAgICByZXR1cm4gbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdHM6IGF1eC5zdGF0ZSwgZWdnUGFyYW1ldGVyczogdG9vbFBhcmFtZXRlcnMsIGlnbm9yZUdyaWRGb2N1czogdHJ1ZSB9KQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhYiB0b29scyBtdXN0IGJlIGluIGF1eCBmb3JtYXQgdjEuICcke3Rvb2xOYW1lfScgaXMgYXV4IGZvcm1hdCB2JHthdXgudmVyc2lvbn1gKTsKICAgIH0KfScAkZClLpjxBQV1dGlscwIEAJGQpS7V8AYo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAkZClLpjxBQtwZXJzb25hbGl0eQIEAJGQpS788AYo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicBBGJvdHMkZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwAScAkZClLqPxBhFjbWRVcGRhdGVBcnRpZmFjdAIEAJGQpS6k8QaYCEBjb25zdCBhcmdzID0gdGhhdDsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgLy8gVXBkYXRlIHVzZXIgcHJvdmlkZWQgYXJ0aWZhY3QgbmFtZXMuCiAgICBmb3IgKGNvbnN0IGFiQXJ0aWZhY3ROYW1lIG9mIGFyZ3MpIHsKICAgICAgICBsaW5rcy5hcnRpZmFjdC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWUgfSk7CiAgICB9Cn0gZWxzZSB7CiAgICAvLyBIYXZlIHVzZXIgc2VsZWN0IGFydGlmYWN0IG5hbWVzIHRvIHVwZGF0ZS4KICAgIGxldCBhYkFydGlmYWN0TmFtZXMgPSBBcnJheS5mcm9tKGxpbmtzLmFydGlmYWN0LmFiR2V0QXJ0aWZhY3ROYW1lc0luSW5zdCgpKTsKCiAgICBpZiAoYWJBcnRpZmFjdE5hbWVzICYmIGFiQXJ0aWZhY3ROYW1lcy5sZW5ndGggPiAwKSB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWVzLnNvcnQoKTsKCiAgICAgICAgY29uc3Qgc2VsZWN0aW9uT3B0aW9ucyA9IGFiQXJ0aWZhY3ROYW1lcy5tYXAoKGVudHJ5KSA9PiB7CiAgICAgICAgICAgIHJldHVybiB7IGxhYmVsOiBlbnRyeSwgdmFsdWU6IGVudHJ5IH0KICAgICAgICB9KQoKICAgICAgICBjb25zdCBzZWxlY3RlZE9wdGlvbnMgPSBhd2FpdCBvcy5zaG93SW5wdXQobnVsbCwgewogICAgICAgICAgICB0aXRsZTogJ1VwZGF0ZSBhcnRpZmFjdHMnLAogICAgICAgICAgICB0eXBlOiAnbGlzdCcsCiAgICAgICAgICAgIHN1YnR5cGU6ICdjaGVja2JveCcsCiAgICAgICAgICAgIGl0ZW1zOiBzZWxlY3Rpb25PcHRpb25zCiAgICAgICAgfSkKCiAgICAgICAgZm9yIChjb25zdCBzZWxlY3RlZCBvZiBzZWxlY3RlZE9wdGlvbnMpIHsKICAgICAgICAgICAgbGlua3MuYXJ0aWZhY3QuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lOiBzZWxlY3RlZC52YWx1ZSB9KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYENhbm5vdCB1cGRhdGUgYXJ0aWZhY3RzIGJlY2F1c2UgdGhlcmUgYXJlIG5vIGFydGlmYWN0cyBpbiB0aGUgaW5zdC5gKTsKICAgIH0KfQonAJGQpS6j8QYGc3lzdGVtAgQAkZClLr35Bg5hYi5zaGVsbC5pbnB1dCcAkZClLqPxBgRmb3JtAgQAkZClLsz5Bgdub3RoaW5nJwCRkKUuo/EGCW9uS2V5RG93bgIEAJGQpS7U+Qb6CkBjb25zdCB7IGtleXMgfSA9IHRoYXQ7CgppZiAobWFza3MuY2hhdE9wZW4pIHsKICAgIGNvbnN0IGVzYyA9IHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJyk7CgogICAgaWYgKGVzYykgewogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYXJyb3dVcCA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dVcCcpOwogICAgICAgIGNvbnN0IGFycm93RG93biA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dEb3duJyk7CiAgICAgICAgCiAgICAgICAgaWYgKGFycm93VXAgfHwgYXJyb3dEb3duKSB7CiAgICAgICAgICAgIC8vIElmIEFycm93VXAgb3IgQXJyb3dEb3duIGFyZSBwcmVzc2VkIHdoaWxlIHRoZSBhYiBjaGF0IGJhciBpcyBvcGVuIHRoZW4KICAgICAgICAgICAgLy8gc3RhcnQgY29tYmluZyB0aHJvdWdoIGNoYXQgaGlzdG9yeS4KICAgICAgICAgICAgY29uc3QgZGlyID0gYXJyb3dVcCA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ICsgZGlyOwogICAgICAgICAgICBsZXQgaGlzdG9yaWNhbFRleHQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBoaXN0b3JpY2FsVGV4dCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeVtpbmRleF07CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPj0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgY2hhdCBiYXIuCiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKHsgcHJlZmlsbDogaGlzdG9yaWNhbFRleHQgfSk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgY29uc3QgYmFja3RpY2sgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ2AnKSB8fCB0aGF0LmtleXMuaW5jbHVkZXMoIkRlYWQiKTsKCiAgICBpZiAoYmFja3RpY2spIHsKICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgIH0KfQonAJGQpS6j8QYGb25DaGF0AgQAkZClLs+EB4oYQC8vIE5vdCBzdXBwb3J0ZWQgb3V0c2lkZSBvZiBidWlsZGVyIHZlcnNpb24KaWYgKCFidWlsZGVyVmVyc2lvbikgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgppZiAoIXRoYXQubWVzc2FnZSkgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgovLyBBcHBlbmQgbWVzc2FnZSB0byBjaGF0IGhpc3RvcnkgYW5kIHVwZGF0ZSB0aGUgY3VycmVudCBoaXN0b3J5IGluZGV4Lgp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkucHVzaCh0aGF0Lm1lc3NhZ2UpOwp0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKCi8vIEZ1bmN0aW9uIHRvIHBhcnNlIGFyZ3VtZW50cyB3aXRoIHF1b3RlIHN1cHBvcnQgYW5kIGVycm9yIGhhbmRsaW5nCi8vIEV4YW1wbGVzOiAKLy8gICAnYXJnMSBhcmcyJyAtPiBbJ2FyZzEnLCAnYXJnMiddCi8vICAgJyJhcmcgd2l0aCBzcGFjZXMiIGFyZzInIC0+IFsnYXJnIHdpdGggc3BhY2VzJywgJ2FyZzInXQovLyAgICcidW5jbG9zZWQgcXVvdGUnIC0+IHRocm93cyBFcnJvcgpmdW5jdGlvbiBwYXJzZUFyZ3VtZW50cyhpbnB1dCkgewogICAgY29uc3QgYXJncyA9IFtdOwogICAgbGV0IGN1cnJlbnRBcmcgPSAnJzsKICAgIGxldCBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgbGV0IHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGNoYXIgPSBpbnB1dFtpXTsKICAgICAgICAKICAgICAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSBpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJ1xcJyAmJiBpICsgMSA8IGlucHV0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaSsrOyAvLyBTa2lwIHRoZSBiYWNrc2xhc2gKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gaW5wdXRbaV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gJyInIHx8IGNoYXIgPT09ICInIikgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gY2hhcjsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSBpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICcgJykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50QXJnID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuY2xvc2VkIHF1b3RlOiBmb3VuZCBvcGVuaW5nICR7aW5zaWRlUXVvdGVzfSBhdCBwb3NpdGlvbiAke3F1b3RlU3RhcnRQb3N9IGJ1dCBubyBjbG9zaW5nIHF1b3RlYCk7CiAgICB9CiAgICAKICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICB9CiAgICAKICAgIHJldHVybiBhcmdzOwp9CgppZiAodGhhdC5tZXNzYWdlWzBdID09ICIuIikgewogICAgY29uc3QgY29tbWFuZFBhcnQgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOyAvLyBSZW1vdmUgdGhlIGRvdAogICAgY29uc3Qgc3BhY2VJbmRleCA9IGNvbW1hbmRQYXJ0LmluZGV4T2YoJyAnKTsKICAgIAogICAgbGV0IGNtZCwgYXJnczsKICAgIGlmIChzcGFjZUluZGV4ID09PSAtMSkgewogICAgICAgIC8vIE5vIGFyZ3VtZW50cwogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0OwogICAgICAgIGFyZ3MgPSB1bmRlZmluZWQ7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEhhcyBhcmd1bWVudHMKICAgICAgICBjbWQgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoMCwgc3BhY2VJbmRleCk7CiAgICAgICAgY29uc3QgYXJnc1N0cmluZyA9IGNvbW1hbmRQYXJ0LnN1YnN0cmluZyhzcGFjZUluZGV4ICsgMSk7CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcGFyc2VkQXJncyA9IHBhcnNlQXJndW1lbnRzKGFyZ3NTdHJpbmcpOwogICAgICAgICAgICBhcmdzID0gcGFyc2VkQXJncy5sZW5ndGggPyBwYXJzZWRBcmdzIDogdW5kZWZpbmVkOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRXJyb3IgcGFyc2luZyBjb21tYW5kIGFyZ3VtZW50czogJHtlcnJvci5tZXNzYWdlfWAsIGxvZ1R5cGU6ICdFcnJvcicgfSk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDcmVhdGUgYSBmcmVzaCBDb21tYW5kc01hbmFnZXIgd2l0aCBlYWNoIGNhbGwgc28gdGhhdCB3ZSBhbHdheXMgaGF2ZSB0aGUgbGF0ZXN0IGNvbW1hbmRzIGFuZCBmdW5jdGlvbmFsaXR5LgogICAgY29uc3QgYWJDb21tYW5kcyA9IG5ldyBBQkNvbW1hbmRzTWFuYWdlcigpOwoKICAgIGlmIChhYkNvbW1hbmRzICYmIGFiQ29tbWFuZHMuaGFzQ29tbWFuZChjbWQpKSB7CiAgICAgICAgLy8gQ2FsbCBjb21tYW5kIHdpdGggYXJncy4KICAgICAgICBhYkNvbW1hbmRzLmNhbGxDb21tYW5kKGNtZCwgYXJncyk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEV2YWx1YXRlIGNvbW1hbmQgYXMgamF2YXNjcmlwdC4KICAgICAgICBjb25zdCBqcyA9IHRoYXQubWVzc2FnZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgb3MucnVuKGpzKTsKICAgIH0KfQoKdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOycAkZClLqPxBgtkZXNjcmlwdGlvbgIEAJGQpS7anAdCVGhpcyBpcyBtZWFudCB0byBoYW5kbGUgYW55IG5vbmUgbWVudSByZWxhdGVkIGlucHV0cy9pbnRlcmFjdGlvbnMuJwCRkKUuo/EGDG9uRmlsZVVwbG9hZAIEAJGQpS6dnQeZGUAvL2ZpbHRlciBvdXQgdGltZXMgd2hlbiBmaWxlIGxvYWRpbmcgaXMgbm90IGFsbG93ZWQKaWYgKCFidWlsZGVyVmVyc2lvbiB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiTGlzdGVuaW5nRm9yRmlsZVVwbG9hZHMgIT09IHRydWUpCnsKICAgIHJldHVybjsKfQoKLy92YXJpb3VzIGZpbGUgc3BlY2lmaWMgdmFyaWFibGVzCmxldCBmaWxlRXh0ZW5zaW9uID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CmxldCBzaXplID0gdGhhdC5maWxlLnNpemU7CmxldCBtaW1lVHlwZTsKbGV0IGJvdEluZm8gPSB7fTsKCi8vaGFyZCBsaW1pdCBiYXNlZCBvbiBmaWxlIHNpemUKaWYgKHNpemUgPiAyMDAwMDAwMDApCnsKICBvcy50b2FzdCgibWF4aW11bSBmaWxlIHNpemUgZXhjZWVkZWQgKDIwMCBtYikiKTsKCiAgcmV0dXJuOwp9CgovL3RoaXMgc3dpdGNoIGhhbmRsZXMgcG9zc2libGUgZmlsZXMgZXh0ZW5zaW9ucywgd2hpbGUgcmVqZWN0aW5nIGFueSBpdCBkb2VzIG5vdCByZWNvZ25pemUKc3dpdGNoKGZpbGVFeHRlbnNpb24pCnsKICBjYXNlICdqcGcnOgogIGNhc2UgJ2pwZWcnOgogIGNhc2UgJ3dlYnAnOgogIGNhc2UgJ2dpZic6CiAgY2FzZSAncG5nJzoKICAgIG1pbWVUeXBlID0gImltYWdlLyIgKyBmaWxlRXh0ZW5zaW9uOwogICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICBicmVhazsKICBjYXNlICdzdmcnOgogICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgIGJyZWFrOwogIGNhc2UgJ2dsYic6CiAgY2FzZSAnZXhyJzoKICBjYXNlICdnbHRmJzoKICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgIGJvdEluZm8uZm9ybSA9ICJtZXNoIjsKICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAiZ2x0ZiI7CiAgICBicmVhazsKICBjYXNlICdhdXgnOgogIGNhc2UgJ3BkZic6CiAgICBsZXQgYm90RGF0YSA9IGZpbGVFeHRlbnNpb24gPT0gIi5hdXgiID8gSlNPTi5wYXJzZSh0aGF0LmZpbGUuZGF0YSkuc3RhdGUgOiBvcy5wYXJzZUJvdHNGcm9tRGF0YSh0aGF0LmZpbGUuZGF0YSk7CgogICAgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7Ym90czogYm90RGF0YSwgb3JpZ2luOiBmaWxlTmFtZSwgc291cmNlRXZlbnQ6ICdmaWxldXBsb2FkJ30pOwoKICAgIHJldHVybjsKLy8gICBjYXNlICdwZGYnOgovLyAgICAgYnJlYWs7CiAgY2FzZSAnbXAzJzoKICAgIG1pbWVUeXBlID0gJ2F1ZGlvL21wZWcnOwogICAgYm90SW5mby5vbkNsaWNrID0gIkAgb3MucGxheVNvdW5kKHRhZ3MuZm9ybUFkZHJlc3MpOyI7CiAgICBib3RJbmZvLmxhYmVsID0gIkNsaWNrIHRvIFBsYXkiOwogICAgYnJlYWs7CiAgY2FzZSAnbXA0JzoKICAgIG1pbWVUeXBlID0gJ3ZpZGVvL21wNCc7CiAgICBib3RJbmZvLmZvcm0gPSAiaWZyYW1lIjsKICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAic3JjIjsKICAgIGJyZWFrOwogIGNhc2UgJ290Zic6CiAgICBtaW1lVHlwZSA9ICdmb250L290Zic7CiAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgYnJlYWs7CiAgY2FzZSAnd29mZic6CiAgICBtaW1lVHlwZSA9ICdmb250L3dvZmYnOwogICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgIGJyZWFrOwogIGRlZmF1bHQ6CiAgICBsZXQgcmVzdWx0ID0gbmV3IEVycm9yKCJ1bmhhbmRsZWQgZmlsZSB0eXBlOiAiICsgZmlsZUV4dGVuc2lvbik7CiAgICBvcy50b2FzdCgiZmlsZSB0eXBlIG5vdCBzdXBwb3J0ZWQiKTsKICAgIGNvbnNvbGUud2FybihyZXN1bHQpCiAgICByZXR1cm4gcmVzdWx0Owp9CgovL3RoZSBmb2xsb3dpbmcgdmFyaWFibGVzIGFuZCBvYmplY3RzIHNldCB1cCBhIGxvYWRpbmcgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKbGV0IHVwbG9hZFJlc3VsdDsKbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHVwbG9hZGluZ2B9KTsKCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvOwoKaWYgKCFjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCkKewogIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYXV0aEJvdC5pZDsKfQoKLy90aGlzIGlzIHRoZSBhY3R1YWwgdXBsb2FkIGZ1bmN0aW9uYWxpdHkKdXBsb2FkUmVzdWx0ID0gYXdhaXQgbGlua3Muc3RvcmUuYWJQdWJsaXNoRmlsZSh7ZmlsZTogdGhhdC5maWxlLmRhdGEsIGZpbGVOYW1lOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlfSk7CgovL2lmIHRoZSBmaWxlIHNob3VsZCBiZSBpbmNsdWRlZCBhcyBhIGJvdCB3aXRoIGEgbGluaywgdGhpcyBsb2dpYyBoYW5kbGVzIHRoYXQKCmlmIChtaW1lVHlwZS5pbmNsdWRlcygiZm9udCIpKQp7CiAgICBib3RJbmZvW2NvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWxdID0gdHJ1ZTsKICAgIGJvdEluZm8ubGFiZWxGb250QWRkcmVzcyA9IHVwbG9hZFJlc3VsdC51cmwgPyB1cGxvYWRSZXN1bHQudXJsIDogdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICBjcmVhdGUoYm90SW5mbyk7Cn0KZWxzZSBpZiAoT2JqZWN0LmtleXMoYm90SW5mbykubGVuZ3RoID4gMCkKewogICAgYm90SW5mb1tjb25maWdCb3QudGFncy5ncmlkUG9ydGFsXSA9IHRydWU7CiAgICBib3RJbmZvLmZvcm1BZGRyZXNzID0gdXBsb2FkUmVzdWx0LnVybCA/IHVwbG9hZFJlc3VsdC51cmwgOiB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKICAgIGNyZWF0ZShib3RJbmZvKTsKfQoKY29uc3QgY2xpcFVSTCA9IHVwbG9hZFJlc3VsdC51cmwgPz8gdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCm9zLnNldENsaXBib2FyZChjbGlwVVJMKTsKCm9zLnRvYXN0KCJmaWxlIHVybCBhZGRlZCBzZXQgdG8gY2xpcGJvYXJkIik7CgovL2NsZWFyIHRoZSBwcm9ncmVzcyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKCmlmIChwcm9ncmVzc0J1dHRvbikKewogIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gdXBsb2FkUmVzdWx0OycAkZClLqPxBgVsZWFybgIEAJGQpS63tgco8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAkZClLqPxBghyZW1lbWJlcgIEAJGQpS7etgco8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAkZClLqPxBg1tYW5pZmVzdGF0aW9uAgQAkZClLoW3Byjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCRkKUuo/EGCGFiSWdub3JlAgQAkZClLqy3BwR0cnVlJwCRkKUuo/EGBmNyZWF0ZQIEAJGQpS6xtwco8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAkZClLqPxBgVzdG9yZQIEAJGQpS7Ytwco8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicAkZClLqPxBgRtZW51AgQAkZClLv+3Byjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCRkKUuo/EGB2FiU2hlbGwCBACRkKUuprgHBHRydWUnAJGQpS6j8QYJb25UYXBDb2RlAgQAkZClLqu4B6kCQGNvbnN0IHRhcENvZGUgPSB0aGF0OwoKc3dpdGNoICh0YXBDb2RlKQp7CiAgICBjYXNlICIzMzQyIjoKICAgICAgICBvcy50b2FzdCgid2FraW5nICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5KTsKCiAgICAgICAgdGhpc0JvdC5vbkNoYXQoe21lc3NhZ2U6ICIuLiJ9KTsKICAgICAgICBicmVhazsKICAgIGNhc2UgIjQyNDIiOgogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICAvL2NvbnNvbGUubG9nKHRhcENvZGUpOwp9JwCRkKUuo/EGA2FzawIEAJGQpS7Vugco8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycAkZClLqPxBglhYlZlcnNpb24CBACRkKUu/LoHBDEwLjUnAJGQpS6j8QYKb25Cb3RBZGRlZAIEAJGQpS6BuwdAQHRoaXNCb3QubG9hZEFCQ29tbWFuZHNNYW5hZ2VyKCk7CnRoaXNCb3QudmFycy5jaGF0SGlzdG9yeSA9IFtdOycAkZClLqPxBhpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAJGQpS7CuwfzQkBsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKLy8gVGhlc2UgYXJlIGFsbCB0aGUgYnVpbHQtaW4gY29tbWFuZHMuCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2hlbHAnLCAoYXJncykgPT4gewogICAgY29uc3QgY29tbWFuZHMgPSBhYkNvbW1hbmRzLmNvbW1hbmRzOwogICAgY29uc3QgY29tbWFuZEtleXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcyk7CgogICAgbGV0IHNlbGVjdGVkQ29tbWFuZDsKICAgIGlmIChjb21tYW5kS2V5cyAmJiBjb21tYW5kS2V5cy5sZW5ndGggJiYgYXJncyAmJiBhcmdzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGNvbW1hbmRLZXlNYXRjaCA9IGNvbW1hbmRLZXlzLmZpbmQoa2V5ID0+IGtleSA9PT0gYXJnc1swXSk7CiAgICAgICAgc2VsZWN0ZWRDb21tYW5kID0gY29tbWFuZEtleU1hdGNoOwogICAgfQogICAgCiAgICBsaW5rcy5oZWxwLm1vdW50KHsgYWJDb21tYW5kc01hbmFnZXI6IGFiQ29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgdGhpcyBoZWxwIHdpbmRvdy4gQ2FuIHNwZWNpZnkgYSBjb21tYW5kIHRvIG9wZW4gdGhlIGhlbHAgcGFnZSBmb3IgdGhhdCBjb21tYW5kIGRpcmVjdGx5LicsCiAgICB1c2FnZTogWycuaGVscCcsICcuaGVscCBbY29tbWFuZF0nXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnLicsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy4uJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnd2FrZScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy53YWtlJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2xlZXAnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJTbGVlcChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1B1dCBhYiB0byBzbGVlcC4nLAogICAgdXNhZ2U6ICcuc2xlZXAnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhc2snLCAoYXJncykgPT4gewogICAgaWYgKGxpbmtzLmFzaykgewogICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBhc2tJbnB1dCA9IGFyZ3Muam9pbignICcpOwogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLmFzayBjb21tYW5kIHJlcXVpcmVzIGlucHV0YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhc2sgYm90IGlzIG5vdCBsb2FkZWQsIGNhbm5vdCBsb2FkIGFza2ApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQXNrIGFiJywKICAgIHVzYWdlOiAnLmFzayA8YXNrX25hbWU+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbmFtZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSwgeyB0aXRsZTogJ3doYXQgd291bGQgeW91IGxpa2UgdG8gY2FsbCBtZT8nIH0pOwogICAgc2V0VGFnTWFzayhsaW5rcy5wZXJzb25hbGl0eSwgJ2FiQnVpbGRlcklkZW50aXR5JywgbmFtZSwgJ2xvY2FsJyk7CiAgICBzaG91dCgnY2hhbmdlUGVyc29uYWxpdHlDb25maWcnLCB7IG5hbWU6IG5hbWUgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHaXZlIGFiIGEgbmV3IG5hbWUuJywKICAgIHVzYWdlOiAnLm5hbWVhYicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3N5c3RlbScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTeXN0ZW0oYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaW5zdC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGkgICAgCgogICAgWW91IG1heSBwcm92aWRlIGEgY3VzdG9tIHN5c3RlbVRhZ05hbWUgd2l0aCB0aGUgY29tbWFuZCwgaW4gb3JkZXIgdG8gb3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBvbmx5IGZvciBib3RzIHdpdGggdGhlIGdpdmVuIHN5c3RlbVRhZ05hbWUuIEJ5IGRlZmF1bHQsICJzeXN0ZW0iIHdpbGwgYmUgdXNlZCBhcyB0aGUgc3lzdGVtVGFnTmFtZS4KCiAgICBGb3IgZXhhbXBsZToKCiAgICA+IC5zeXN0ZW0KICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgInN5c3RlbSIgdGFnLgoKICAgID4gLnN5c3RlbSBteUdyb3VwCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJteUdyb3VwIiB0YWcuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnN5c3RlbScsCiAgICAgICAgJy5zeXN0ZW0gc3lzdGVtVGFnTmFtZScKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXcnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LiBCeSBkZWZhdWx0IHRoZSBzeXN0ZW0gcG9ydGFsIHdpbGwgb3BlbiBpbiBhIG5ldyB0YWIuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZycsIChhcmdzKSA9PiB7CiAgICBsaW5rcy5jb25zb2xlLnRvZ2dsZUNvbnNvbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1RvZ2dsZSB2aXNpYmxpdHkgb2YgdGhlIGFiIGxvZy4nLAogICAgdXNhZ2U6ICcubG9nJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2djbGVhcicsIChhcmdzKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlTG9nQm90cyA9IGdldEJvdHMoImNvbnNvbGVMb2dNZXNzYWdlQm90IiwgdHJ1ZSk7CiAgICBkZXN0cm95KG1lc3NhZ2VMb2dCb3RzKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0NsZWFyIGFsbCBhYiBsb2cgbWVzc2FnZXMuJywKICAgIHVzYWdlOiAnLmxvZ2NsZWFyJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzaGVldCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTaGVldChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3Igc3BlY2lmaWVkIGJvdCBvciBhbiBlbnRpcmUgZGltZW5zaW9uLicsCiAgICB1c2FnZTogWwogICAgICAgICcuc2hlZXQgW29wdGlvbnNdIFtwb3J0YWwgfCBoZWxwZXJCb3ROYW1lIHwgYm90SWQgfCBnbG9iYWxUaGlzUGF0aF0nLAogICAgICAgICdleC4gLnNoZWV0IGhvbWUnLAogICAgICAgICdleC4gLnNoZWV0IGNvbmZpZ0JvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgLXQgYTJjZjQ3MzktMzlhMi00ZmQ2LWIzZWYtY2M0NzgyZjk3MDg5JywKICAgICAgICAnZXguIC5zaGVldCBnbG9iYWxUaGlzLm15T2JqZWN0Lm15Qm90JywKICAgICAgICAnZXguIC5zaGVldCBteU9iamVjdC5teUJvdCcKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBpbiBhIG5ldyBicm93c2VyIHRhYi4gXG5cbk5PVEU6IC5zaGVldCB3aWxsIGF1dG9tYXRpY2FsbHkgaW5zcGVjdCB0aGUgc3BhY2Ugb2YgYSBib3QgYW5kIGZvcmNlIG9wZW5pbmcgaW4gdGhlIHNhbWUgdGFiIGlmIGEgYm90IGlzIGluIHRlbXBMb2NhbCBvciB0ZW1wU2hhcmVkIHNwYWNlLicsCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbWVudXNoZWV0JywgKGFyZ3MpID0+IHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKICAgIGlmICghY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2Fubm90IG9wZW4gc2hlZXRQb3J0YWwgZm9yIG1lbnVQb3J0YWwgYm90cy4gVGhlIG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IGRpc2FibGVkLmB9KQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciB0aGUgY3VycmVudCBtZW51IHBvcnRhbC4nLAogICAgdXNhZ2U6ICcubWVudVNoZWV0JywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkaW5zdCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEluc3QoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCB0aGUgaW5zdCB0byBkaXNrLicsCiAgICB1c2FnZTogJy5kb3dubG9hZGluc3QnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGFiJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkQUIoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBzcGVjaWZpZWQgYWIgZ3JvdXAocykgdG8gZGlzay4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suCgogICAgWW91IGNhbiBwcm92aWRlIGEgbGlzdCBvZiBncm91cHMgdG8gZG93bmxvYWQgYWxvbmcgd2l0aCB0aGUgY29tbWFuZDoKICAgID4gLmRvd25sb2FkYWIgYWJDb3JlIGFiU2hlbGwgYWJJbnRlcmZhY2UKCiAgICBJZiBncm91cChzKSBhcmUgbm90IHByb3ZpZGVkIHdpdGggdGhlIGNvbWFtYW5kIHRoZW4geW91IHdpbGwgYmUgcHJvbXB0ZWQgdG8gcHJvdmlkZSBvbmUgd2l0aCBhIGRpYWxvZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRhYiBbb3B0aW9uc10gW2dyb3VwLi4uXScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiBhYlNoZWxsIGFiSW50ZXJmYWNlJywKICAgICAgICAnZXguIC5kb3dubG9hZGFiIC12IDEgbXlHcm91cE5hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy12JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdTcGVjaWZ5IHRoZSBhdXggZm9ybWF0IHZlcnNpb24gbnVtYmVyLiBleC4gLXYgMSB3aWxsIGJlIGF1eCBmb3JtYXQgdmVyc2lvbiAxIChwdXJlIGJvdCBqc29uKS4gQnkgZGVmYXVsdCwgYWIgZmlsZXMgYXJlIHVzdWFsbHkgZG93bmxvYWRlZCBhcyB2ZXJzaW9uIDIgYXV4IGZpbGVzIChjb25mbGljdC1mcmVlIHVwZGF0ZSkuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkZWdnJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkRWdnKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLiBZb3Ugd2lsbCBuZWVkIHRvIHByb3ZpZGUgdGhlIHJlY29yZEtleSBhcyB3ZWxsIGFuZCB0aGUgbmFtZSBvZiB0aGUgZWdnLiBBIGRyb3Bkb3duIHNlbGVjdGlvbiB3aWxsIGJlIHByb3ZpZGVkIGZvciB0aGUgZWdnIGlmIGZvdW5kIHRvIHNlbGVjdCB3aGljaCB2ZXJzaW9uIHRvIGRvd25sb2FkLmAsCiAgICB1c2FnZTogJy5kb3dubG9hZGVnZycsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2Fkc2tpbGwnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKGFyZ3MpIHsKICAgICAgICBmb3IgKGxldCBza2lsbCBvZiBhcmdzKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoc2tpbGwpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnLmxvYWRza2lsbCByZXF1aXJlcyBzb21lIHNraWxsIG5hbWVzJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdMb2FkIHRoZSBzcGVjaWZpZWQgYWIgc2tpbGxzLicsCiAgICB1c2FnZTogJy5sb2FkU2tpbGwgW3NraWxsIC4uLl0nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cmxxcicsICgpID0+IG9zLnNob3dRUkNvZGUoY29uZmlnQm90LnRhZ3MudXJsKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgYSBRUiBjb2RlIGZvciB0aGUgYnJvd2VyIHRhYlwncyBjdXJyZW50IFVSTC4nLAogICAgdXNhZ2U6ICcudXJscXInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkaW0nLCAoYXJncykgPT4gewogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBuYW1lID0gYXJncy5qb2luKCcgJyk7CiAgICAgICAgb3MuZ29Ub0RpbWVuc2lvbihuYW1lKTsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYE1vdmVkIHRvICcke25hbWV9JyBkaW1lbnNpb24uYCwgZHVyYXRpb246IDMgfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dvIHRvIHNwZWNpZmllZCBkaW1lbnNpb24gLyBwb3J0YWwuJywKICAgIHVzYWdlOiAnLmRpbSA8ZGltZW5zaW9uIHwgcG9ydGFsPicsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1dWlkJywgKCkgPT4gewogICAgb3Muc2V0Q2xpcGJvYXJkKHV1aWQoKSk7CgogICAgbGV0IG1lc3NhZ2UgPSBgQ29waWVkIG5ldyB1dWlkIHRvIGNsaXBib2FyZGA7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYSB1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllciAodXVpZCkgYW5kIGNvcHkgaXQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcudXVpZCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2R1cCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBib3RJZCA9IGFyZ3MgPyBhcmdzWzBdIDogdW5kZWZpbmVkOwogICAgaWYgKGJvdElkKSB7CiAgICAgICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgICAgICBpZiAoYm90KSB7CiAgICAgICAgICAgIGNvbnN0IGR1cEJvdCA9IGNyZWF0ZShib3QpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZHVwQm90LmlkKTsKICAgICAgICAgICAgb3MudG9hc3QoJ0R1cGxpY2F0ZSBib3QgaWQgY29waWVkIHRvIGNsaXBib2FyZC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcy50b2FzdChgTm8gYm90IGZvdW5kIHdpdGggaWQgJHtib3RJZH1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCdQcm92aWRlIHRoZSBpZCBvZiB0aGUgYm90IHlvdSB3YW50IHRvIGR1cGxpY2F0ZScpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGEgc3BlY2lmaWVkIGJvdCBhbmQgY29weSB0aGUgbmV3IGJvdFwncyBpZCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy5kdXAgPGJvdElkPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGF1eCcsIChhcmdzKSA9PiB7CiAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIEFVWCBmaWxlKHMpIHRvIHRoZSBjdXJyZW50IGluc3QuJywKICAgIHVzYWdlOiAnLnVwbG9hZGF1eCcKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkZmlsZXMnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBsb2FkRmlsZXMoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgZmlsZShzKSBkaXJlY3RseSB0byByZWNvcmQuJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGxvYWRmaWxlcycsCiAgICAgICAgJy51cGxvYWRmaWxlcyAtcmVjb3JkIDxyZWNvcmRfaWQ+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcmVjb3JkJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcHRpb25hbGx5IHB1Ymxpc2ggZmlsZShzKSB0byBhIHNwZWNpZmljIHJlY29yZC4gSWYgb21pdHRlZCwgZmlsZShzKSB3aWxsIGJlIHB1Ymxpc2hlZCB0byB0aGUgdXNlclwncyBwZXJzb25hbCByZWNvcmQuJwogICAgICAgIH0KICAgIF0KfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBkYXRlYXJ0aWZhY3QnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBkYXRlQXJ0aWZhY3QoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdNYW51YWxseSB1cGRhdGUgYW4gYXJ0aWZhY3QgaW4gdGhlIGN1cnJlbnQgaW5zdC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgTWFudWFsbHkgdXBkYXRlIGFuIGFydGlmYWN0IGluIHRoZSBjdXJyZW50IGluc3QuCiAgICAKICAgIEEgZGlhbG9nIHdpbGwgYmUgc2hvd24gYWxsb3dpbmcgeW91IHRvIHNlbGVjdCB3aGljaCBhcnRpZmFjdHMgdG8gdXBkYXRlIGluIHRoZSBjdXJyZW50IGluc3QuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnVwZGF0ZWFydGlmYWN0JywKICAgIF0KfSknAJGQpS6j8QYIYXJ0aWZhY3QCBACRkKUutv4HKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAJGQpS6j8QYVbG9hZEFCQ29tbWFuZHNNYW5hZ2VyAgQAkZClLt3+B/otQC8qKgogKiBBQkNvbW1hbmRzTWFuYWdlciBpcyBwYXJ0IG9mIGFiU2hlbGwuCiAqIFlvdSBjYW4gcmVnaXN0ZXIgY29tbWFuZHMgdG8gaXQgdGhhdCBjYW4gYmUgaW52b2tlZCB1c2luZyAnJDxjb21tYW5kPicgd2l0aCB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAqIEl0cyBnZW5lcmFsbHkgbm90IHJlY29tbWVuZGVkIHRvIGNyZWF0ZSB0aGlzIHlvdXJzZWxmIGJ1dCBpbnN0ZWFkIHRvIGxpc3RlbiBmb3IgdGhlIEBvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCBzaG91dAogKiBhbmQgdG8gcmVnaXN0ZXIgeW91ciBjb21tYW5kcyB0aGVyZS4KICogQHByb3Age3N0cmluZ1tdfSBjb21tYW5kcwogKi8KY2xhc3MgQUJDb21tYW5kc01hbmFnZXIgewogICAgY29tbWFuZHM6IFJlY29yZDxzdHJpbmcsIEFCQ29tbWFuZD47CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgdGhpcy5jb21tYW5kcyA9IHt9OwoKICAgICAgICAvLyBTaG91dCB0aGF0IGFuIGluc3RhbmNlIG9mIEFCQ29tbWFuZHNNYW5hZ2VyIGhhcyBiZWVuIGNyZWF0ZWQgYW5kIGFsbG93IGFueSBsaXN0ZW5lcnMKICAgICAgICAvLyB0byBhZGQgdGhlaXIgb3duIGNvbW1hbmRzIHRvIHRoZSBpbnN0YW5jZS4KICAgICAgICBzaG91dCgnb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQnLCB0aGlzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZCBhIGNvbW1hbmQgdG8gQUJDb21tYW5kc01hbmFnZXIuCiAgICAgKiBUaGlzIGNvbW1hbmQgd2lsbCBiZSBhdmFpbGFibGUgdG8gaW52b2tlIHVzaW5nICckPG5hbWU+JyBvbiB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgc3VjY2Vzc2Z1bGx5IGFkZGVkLgogICAgICovCiAgICBhZGRDb21tYW5kKG5hbWU6IHN0cmluZywgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrLCBoZWxwOiBBQkNvbW1hbmRIZWxwKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKCFuYW1lIHx8IHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdIHN0cmluZyBuYW1lIGlzIHJlcXVpcmVkIGZvciBjb21tYW5kcy5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIGFscmVhZHkgZXhpc3RzIGFzIGEgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFjYWxsYmFjayB8fCB0eXBlb2YgY2FsbGJhY2sgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgYSBjYWxsYmFjayBmdW5jdGlvbi5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCBpcyBtaXNzaW5nIHNob3J0RGVzY3JpcHRpb24gZnJvbSBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb21tYW5kc1tuYW1lXSA9IHsgbmFtZSwgY2FsbGJhY2ssIGhlbHAgfTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBoYXNDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRzW25hbWVdICE9IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmUgYSBjb21tYW5kIGZyb20gQUJDb21tYW5kc01hbmFnZXIKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3YXMgcmVtb3ZlZC4gSWYgdGhlIGNvbW1hbmQgZG9lc24ndCBleGlzdCBmYWxzZSB3aWxsIGFsc28gYmUgcmV0dXJuZWQuCiAgICAgKi8KICAgIHJlbW92ZUNvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsIHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3aXRoIHRoZSBwcm92aWRlZCBhcmdzIChpZiBhbnkpLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIGV4ZWN1dGVkLgogICAgICovCiAgICBjYWxsQ29tbWFuZChuYW1lOiBzdHJpbmcsIGFyZ3M/OiBhbnlbXSk6IGJvb2xlYW4gewogICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgIGlmIChjb21tYW5kKSB7CiAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhlbHBBcmcgb2YgY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaGVscEFyZy5pZGVudGlmaWVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goLi4uaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKGhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXNzZXJ0IHRoYXQgdGhlIGlucHV0IGFyZ3MgYXJlIHZhbGlkIGFnYWluc3QgdGhlIGNvbW1hbmQgaGVscCBkb2N1bWVudGF0aW9uLgogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBlYXN5IHdheSB0byB2YWxpZGF0ZSBhcmdzIGJlZm9yZSBleGVjdXRpbmcgYSBjb21tYW5kLgogICAgICAgICAgICAgICAgQUJDb21tYW5kc01hbmFnZXIuYXNzZXJ0VmFsaWRBcmdzKGFyZ3MsIHZhbGlkQXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWFuZC5jYWxsYmFjayhhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIG5vdCBhIHZhbGlkIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgcHJvdmlkZWQgYXJnLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGFuZCB2YWx1ZSBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdWYWx1ZShhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBhbnkgewogICAgICAgIGxldCB2YWx1ZSA9IG51bGw7CgogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIGxldCBkZWxldGVDb3VudCA9IDE7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUluZGV4ID0gYXJnSW5kZXggKyAxOwoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZUluZGV4IDwgYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYXJnc1t2YWx1ZUluZGV4XTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgcmVsYXRlZCBhcmdzICYgdmFsdWVzCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgZGVsZXRlQ291bnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgd2V0aGVyIHRoZSBhcmcgZmxhZyBpcyBwcm92aWRlZCBpbiB0aGUgYXJncy4gV2lsbCByZW1vdmUgdGhlIGFyZyBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdGbGFnKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBhcmcgZmxhZy4KICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCAxKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgc3RhdGljIGFzc2VydFZhbGlkQXJncyhhcmdzOiBhbnlbXSwgdmFsaWRBcmdzOiBhbnlbXSk6IHZvaWQgewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGludmFsaWRBcmdzID0gW107CgogICAgICAgICAgICBmb3IgKGxldCBhcmcgb2YgYXJncykgewogICAgICAgICAgICAgICAgaWYgKGFyZyAmJiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJnIHdlIHdhbnQgdG8gZXZhbHVhdGUuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRBcmdzIHx8ICF2YWxpZEFyZ3MuaW5jbHVkZXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBhcmcgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB2YWxpZEFyZ3MsIHRodXMgdGhlIGFyZyBpcyBpbnZhbGlkLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZEFyZ3MucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHRoaXMgYXJnIGl0IGlzIG1vc3RseSBsaWtlbHkgYSB2YWx1ZSBhcmcuCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaW52YWxpZEFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYEludmFsaWQgYXJndW1lbnRzOiAke2ludmFsaWRBcmdzLmpvaW4oJywgJyl9YDsKCiAgICAgICAgICAgICAgICBvcy50b2FzdChlcnJvck1lc3NhZ2UsIDQpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdsb2JhbFRoaXMuQUJDb21tYW5kc01hbmFnZXIgPSBBQkNvbW1hbmRzTWFuYWdlcjsnAJGQpS6j8QYEaGVscAIEAJGQpS7YrAgo8J+UlzI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYycAkZClLqPxBghjbWRTaGVldAIEAJGQpS7/rAjNFEBjb25zdCBhcmdzID0gdGhhdDsKCmxldCBwb3J0YWw7CmxldCBuZXdUYWIgPSBmYWxzZTsKCmlmIChhcmdzKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBhcmcgPSBhcmdzW2ldOwogICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgIGlmIChhcmcgPT09ICctdCcpIHsKICAgICAgICAgICAgICAgIG5ld1RhYiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFwb3J0YWwpIHsKICAgICAgICAgICAgcG9ydGFsID0gYXJnOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFwb3J0YWwpIHsKICAgIHBvcnRhbCA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKY29uc3QgaGVscGVyQm90cyA9IHsKICAgICdjb25maWdCb3QnOiBjb25maWdCb3QsCiAgICAnZ3JpZFBvcnRhbEJvdCc6IGdyaWRQb3J0YWxCb3QsCiAgICAnc2hlZXRQb3J0YWxCb3QnOiBzaGVldFBvcnRhbEJvdCwKICAgICdzeXN0ZW1Qb3J0YWxCb3QnOiBzeXN0ZW1Qb3J0YWxCb3QsCiAgICAnbWluaUdyaWRQb3J0YWxCb3QnOiBtaW5pR3JpZFBvcnRhbEJvdCwKICAgICdtYXBQb3J0YWxCb3QnOiBtYXBQb3J0YWxCb3QsCiAgICAnbWluaU1hcFBvcnRhbEJvdCc6IG1pbmlNYXBQb3J0YWxCb3QsCiAgICAnbWVudVBvcnRhbEJvdCc6IG1lbnVQb3J0YWxCb3QsCiAgICAnbGVmdFdyaXN0UG9ydGFsQm90JzogbGVmdFdyaXN0UG9ydGFsQm90LAogICAgJ3JpZ2h0V3Jpc3RQb3J0YWxCb3QnOiByaWdodFdyaXN0UG9ydGFsQm90LAogICAgJ21lZXRQb3J0YWxCb3QnOiBtZWV0UG9ydGFsQm90LAogICAgJ3RhZ1BvcnRhbEJvdCc6IHRhZ1BvcnRhbEJvdCwKICAgICdpbXVQb3J0YWxCb3QnOiBpbXVQb3J0YWxCb3QsCn07CgovLyBGdW5jdGlvbiB0byByZXNvbHZlIGEgcG9ydGFsIHJlZmVyZW5jZSB0byBhIHNwZWNpZmljIGJvdApmdW5jdGlvbiByZXNvbHZlUG9ydGFsVG9Cb3QocGF0aCkgewogICAgaWYgKCFwYXRoIHx8IHBhdGggPT09ICcnKSByZXR1cm4gbnVsbDsKICAgIAogICAgLy8gRmlyc3QgY2hlY2sgaWYgaXQncyBkaXJlY3RseSBpbiBoZWxwZXJCb3RzCiAgICBpZiAoaGVscGVyQm90c1twYXRoXSkgewogICAgICAgIHJldHVybiBoZWxwZXJCb3RzW3BhdGhdOwogICAgfQoKICAgIC8vIFBlcmhhcHMgdGhlIHBhdGggaXMgYSBib3QgaWQuCiAgICBsZXQgYm90RnJvbUlkU2VhcmNoID0gZ2V0Qm90KCdpZCcsIHBhdGgpOwogICAgaWYgKGJvdEZyb21JZFNlYXJjaCkgewogICAgICAgIHJldHVybiBib3RGcm9tSWRTZWFyY2g7CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGZvciBib3RoIGRpcmVjdCBhbmQgbmVzdGVkIHBhdGhzIGluIGdsb2JhbFRoaXMKICAgIGxldCBwYXRoUGFydHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICBsZXQgY3VycmVudE9iaiA9IGdsb2JhbFRoaXM7CiAgICBsZXQgc3RhcnRJbmRleCA9IDA7CiAgICAKICAgIC8vIEhhbmRsZSBpZiB0aGUgcGF0aCBleHBsaWNpdGx5IHN0YXJ0cyB3aXRoICdnbG9iYWxUaGlzJwogICAgaWYgKHBhdGhQYXJ0c1swXSA9PT0gJ2dsb2JhbFRoaXMnKSB7CiAgICAgICAgc3RhcnRJbmRleCA9IDE7IC8vIFNraXAgdGhlICdnbG9iYWxUaGlzJyBwYXJ0IHNpbmNlIHdlJ3JlIGFscmVhZHkgc3RhcnRpbmcgdGhlcmUKICAgIH0KICAgIAogICAgLy8gVHJhdmVyc2UgdGhlIHBhdGgKICAgIGZvciAobGV0IGkgPSBzdGFydEluZGV4OyBpIDwgcGF0aFBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcGFydCA9IHBhdGhQYXJ0c1tpXTsKICAgICAgICBpZiAoIWN1cnJlbnRPYmpbcGFydF0pIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIFBhdGggc2VnbWVudCBkb2Vzbid0IGV4aXN0CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRPYmogPSBjdXJyZW50T2JqW3BhcnRdOwogICAgfQogICAgCiAgICAvLyBDaGVjayBpZiB0aGUgZmluYWwgb2JqZWN0IGlzIGEgYm90IChoYXMgaWQgYW5kIHRhZ3MpCiAgICBpZiAoY3VycmVudE9iaiAmJiBjdXJyZW50T2JqLmlkICYmIGN1cnJlbnRPYmoudGFncykgewogICAgICAgIHJldHVybiBjdXJyZW50T2JqOwogICAgfQogICAgCiAgICByZXR1cm4gbnVsbDsgLy8gTm90IGEgdmFsaWQgYm90Cn0KCi8vIFNlYXJjaCB0byBzZWUgaWYgcG9ydGFsIGFyZ3VtZW50IGlzIHNwZWNpZmljIHRvIGEgYm90CmxldCB1bmlxdWVCb3QgPSByZXNvbHZlUG9ydGFsVG9Cb3QocG9ydGFsKTsKCmlmICh1bmlxdWVCb3QpIHsKICAgIGlmICh1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBMb2NhbCcgfHwKICAgICAgICB1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBTaGFyZWQnCiAgICApIHsKICAgICAgICAvLyBGb3JjZSBzaGVldCB0byBvcGVuIGluIHNhbWUgdGFiIGlmIHRoZSBib3Qgb25seSBsaXZlcyBpbiB0aGlzIHRhYi4KICAgICAgICBuZXdUYWIgPSBmYWxzZTsKICAgIH0KICAgIHBvcnRhbCA9IHVuaXF1ZUJvdC5pZDsKfQoKaWYgKG5ld1RhYikgewogICAgb3Mub3BlblVSTChgLz9pbnN0PSR7b3MuZ2V0Q3VycmVudEluc3QoKX0mc2hlZXRQb3J0YWw9JHtwb3J0YWx9YCk7Cn0gZWxzZSB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IHBvcnRhbDsKfScAkZClLqPxBg1jbWREb3dubG9hZEFCAgQAkZClLs3BCK0LQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IGF1eFZlcnNpb246IHN0cmluZyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy12Jyk7CgppZiAoIWF1eFZlcnNpb24pIHsKICAgIC8vIERlZmF1bHQgdG8gYXV4IHZlcnNpb24gMiBpZiBhcmd1bWVudCBpcyBub3QgcHJvdmlkZWQuCiAgICBhdXhWZXJzaW9uID0gJzInOwp9CgppZiAoYXV4VmVyc2lvbiAhPT0gJzEnICYmIGF1eFZlcnNpb24gIT09ICcyJykgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgT25seSBhdXggZm9ybWF0IHZlcnNpb24gMSBhbmQgMiBhcmUgc3VwcG9ydGVkIGluIHRoZSBkb3dubG9hZCBhYiBjb21tYW5kLmApOwogICAgcmV0dXJuOwp9CgpjaGFuZ2VTdGF0ZShsaW5rcy5tYW5pZmVzdGF0aW9uLCAiQXNsZWVwIiwgImFiTWFuaWZlc3RTdGF0ZSIpOwoKbGV0IGdyb3VwcyA9IFtdOwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAvLyBSZW1haW5pbmcgYXJncyBhcmUgZ3JvdXAgbmFtZXMgcHJvdmlkZWQgd2l0aCB0aGUgY29tbWFuZC4KICAgIGdyb3VwcyA9IGFyZ3M7Cn0gZWxzZSB7CiAgICBsZXQgZ3JvdXAgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldklucHV0RG93bmxvYWRBQkdyb3VwLCB7IHRpdGxlOiAnQUIgR3JvdXAgVGFnJywgYXV0b1NlbGVjdDogdHJ1ZSB9KTsKICAgIGlmIChncm91cCkgewogICAgICAgIG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCA9IGdyb3VwOwogICAgICAgIGdyb3Vwcy5wdXNoKGdyb3VwKTsKICAgIH0KfQoKY29uc3QgbWFqb3JWZXJzaW9uID0gbGlua3MubGVhcm4udGFncy5hYkNvcmVNYWpvclZlcnNpb247CmNvbnN0IG1pbm9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWlub3JWZXJzaW9uOwpjb25zdCBhYlZlcnNpb24gPSBgJHttYWpvclZlcnNpb259LiR7bWlub3JWZXJzaW9ufWA7Cgpmb3IgKGxldCBncm91cCBvZiBncm91cHMpIHsKICAgIGNvbnN0IGdyb3VwQm90cyA9IGdldEJvdHMoYnlNb2QoeyBbZ3JvdXBdOiB0cnVlLCBzcGFjZTogJ3NoYXJlZCcgfSkpOwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JvdXBCb3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZ3JvdXBCb3RzW2ldLnRhZ3MuYWJWZXJzaW9uID0gYWJWZXJzaW9uOwogICAgfQoKICAgIGlmIChncm91cCA9PSAiYWJDb25maWciKSB7CiAgICAgICAgZ3JvdXAgPSAiYWIxIjsKICAgIH0KCiAgICBpZiAoYXV4VmVyc2lvbiA9PT0gJzEnKSB7CiAgICAgICAgLy8gRG93bmxvYWQgYXMgdmVyc2lvbiAxCiAgICAgICAgb3MuZG93bmxvYWRCb3RzKGdyb3VwQm90cywgZ3JvdXApCiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMgogICAgICAgIG9zLmRvd25sb2FkQm90c0FzSW5pdGlhbHphdGlvblVwZGF0ZShncm91cEJvdHMsIGdyb3VwKTsKICAgIH0KCn0KCicAkZClLqPxBgljbWRBQldha2UCBACRkKUu+8wIxANAbGV0IHNraWxsQXJyYXkgPSBbImFiUGVyc29uYWxpdHkiLCAiYWJJbnRlcmZhY2UiLCAiYWJBY3Rpb24iLCAiYWJUZXN0cyJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwp9Cgphd2FpdCBvcy5zbGVlcCgzMDApOwoKLy9rZWVwIGFiIGF3YWtlCmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBd2FrZVN0YXRlID0gdHJ1ZTsKCmlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47Cn0KZWxzZSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkF3YWtlIiwgImFiTWFuaWZlc3RTdGF0ZSIpOycAkZClLqPxBgpjbWRBQlNsZWVwAgQAkZClLsDQCN0BQGNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBc2xlZXAiLCAiYWJNYW5pZmVzdFN0YXRlIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwoKdGFnUG9ydGFsQm90Lm1hc2tzLnRhZ1BvcnRhbEFuY2hvclBvaW50ID0gbnVsbDsnAJGQpS6j8QYHY29uc29sZQIEAJGQpS6e0ggo8J+UlzI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYicAkZClLqPxBg5jbWRVcGxvYWRGaWxlcwIEAJGQpS7F0giTEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScAkZClLqPxBg5jbWREb3dubG9hZEVnZwIEAJGQpS7Z4gj5C0Bjb25zdCByZWNvcmRLZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5LCB7CiAgICB0aXRsZTogJ3JlY29yZCB0byBsb29rdXAgZWdnIGluJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXk6YCwgcmVjb3JkS2V5KTsKCmlmICghcmVjb3JkS2V5KSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ1JlY29yZEtleSA9IHJlY29yZEtleTsKCmNvbnN0IGVnZ05hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnTmFtZSwgewogICAgdGl0bGU6ICduYW1lIG9mIGVnZycsCiAgICB0eXBlOiAndGV4dCcsCn0pCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTmFtZTpgLCBlZ2dOYW1lKTsKCmlmICghZWdnTmFtZSkgewogICAgcmV0dXJuOwp9CgptYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lID0gZWdnTmFtZTsKCmNvbnN0IGVnZyA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICBhYklEOiBlZ2dOYW1lLAogICAgcmVjb3JkS2V5LAogICAgcmV0dXJuVHlwZTogJ2VnZycKfSkKCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnOmAsIGVnZyk7CgppZiAoIUFycmF5LmlzQXJyYXkoZWdnLmVnZ1ZlcnNpb25IaXN0b3J5KSB8fCBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBEYXRhIGZvdW5kIGF0IGFkZHJlc3MgJyR7ZWdnTmFtZX0nIGluIHJlY29yZCAnJHtyZWNvcmRLZXl9JyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYW4gZWdnLmApCiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgZWdnVmVyc2lvbk9wdGlvbnMgPSBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubWFwKChpdGVtLCBpbmRleCkgPT4gewogICAgcmV0dXJuIHsgbGFiZWw6IGB2ZXJzaW9uICR7aW5kZXggKyAxfWAsIHZhbHVlOiBpbmRleCB9Cn0pCgpjb25zdCBzZWxlY3RlZFZlcnNpb25PcHRpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQoZWdnVmVyc2lvbk9wdGlvbnMubGVuZ3RoIC0gMSwgewogICAgdGl0bGU6ICdkb3dubG9hZCBlZ2cgdmVyc2lvbicsCiAgICB0eXBlOiAnbGlzdCcsCiAgICBzdWJ0eXBlOiAnc2VsZWN0JywKICAgIGl0ZW1zOiBlZ2dWZXJzaW9uT3B0aW9ucywKfSkKCmlmICghc2VsZWN0ZWRWZXJzaW9uT3B0aW9uKSB7CiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgYXV4RGF0YVVybCA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeVtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWVdOwpjb25zdCBhdXhEYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShhdXhEYXRhVXJsKTsKY29uc3QgYXV4RmlsZW5hbWUgPSBgJHtlZ2dOYW1lfV92JHtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWUgKyAxfS5hdXhgOwoKb3MuZG93bmxvYWQoYXV4RGF0YSwgYXV4RmlsZW5hbWUsICdhcHBsaWNhdGlvbi9qc29uJyk7JwCRkKUuo/EGD2NtZERvd25sb2FkSW5zdAIEAJGQpS7T7giFAUBjb25zdCBhcmdzID0gdGhhdDsKCmNvbnN0IGJvdHMgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7Cm9zLmRvd25sb2FkQm90cyhib3RzLCBvcy5nZXRDdXJyZW50SW5zdCgpKTsnAJGQpS6j8QYGc2VhcmNoAgQAkZClLtnvCCjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCRkKUuo/EGBXV0aWxzAgQAkZClLoDwCCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCRkKUuo/EGCWNtZFN5c3RlbQIEAJGQpS6n8AiRB0Bjb25zdCBhcmdzID0gdGhhdDsKCmNvbnN0IHNhbWVXaW5kb3cgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ0ZsYWcoYXJncywgJy13Jyk7CgpsZXQgc3lzdGVtVGFnTmFtZSA9IG51bGw7CgppZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgIHN5c3RlbVRhZ05hbWUgPSBhcmdzLmpvaW4oJyAnKTsKfQoKaWYgKHNhbWVXaW5kb3cpIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiB0aGUgY3VycmVudCB3aW5kb3cuCiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1Qb3J0YWwgPSB0cnVlOwogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtVGFnTmFtZSA9IHN5c3RlbVRhZ05hbWU7Cn0gZWxzZSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gYSBuZXcgdGFiLgogICAgY29uc3QgdXJsID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpOwoKICAgIC8vIFJlbW92ZSBhbnkgcG9ydGFscyB0aGF0IGFyZSBzZXQgaW4gdGhlIFVSTC4KICAgIGxldCBwYXJhbXMgPSB1cmwuc2VhcmNoUGFyYW1zLmtleXMoKTsKICAgIGZvciAobGV0IHBhcmFtIG9mIHBhcmFtcykgewogICAgICAgIGlmIChwYXJhbS5lbmRzV2l0aCgnUG9ydGFsJykpIHsKICAgICAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUocGFyYW0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBUdXJuIG9uIHRoZSBzeXN0ZW0gcG9ydGFsLgogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3N5c3RlbVBvcnRhbCcsICd0cnVlJyk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZSgnc3lzdGVtVGFnTmFtZScpOwoKICAgIGlmIChzeXN0ZW1UYWdOYW1lKSB7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3N5c3RlbVRhZ05hbWUnLCBzeXN0ZW1UYWdOYW1lKTsKICAgIH0KCiAgICBvcy5vcGVuVVJMKHVybC5ocmVmKTsKfQonAJGQpS6j8QYNYWJDaGF0QmFyT3BlbgIEAJGQpS659wijAkBjb25zdCB7CiAgICBwcmVmaWxsLAp9ID0gdGhhdCA/PyB7fQoKbWFza3MuY2hhdE9wZW4gPSB0cnVlOwoKb3Muc2hvd0NoYXQoewogICAgcGxhY2Vob2xkZXI6ICc+IC5oZWxwIHRvIHNlZSBhdmFpbGFibGUgY29tbWFuZHMnLAogICAgYmFja2dyb3VuZENvbG9yOiAnIzJmMmYyZicsCiAgICBmb3JlZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwbGFjZWhvbGRlckNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcHJlZmlsbAp9KScAkZClLqPxBg5hYkNoYXRCYXJDbG9zZQIEAJGQpS7d+Qh2QG1hc2tzLmNoYXRPcGVuID0gZmFsc2U7Cm9zLmhpZGVDaGF0KCk7CgovLyBHaXZlIENhc3VhbE9TIGEgY2hhbmdlIHRvIGFjdHVhbGx5IHJlbW92ZSB0aGUgY2hhdCBiYXIuCmF3YWl0IG9zLnNsZWVwKDApOycAkZClLqPxBgtwZXJzb25hbGl0eQIEAJGQpS7U+ggo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicAkZClLqPxBgV0eXBlcwIEAJGQpS77+gjyAvCfk4R0eXBlIEFCQ29tbWFuZENhbGxiYWNrID0gKGFyZ3M/OiBhbnlbXSkgPT4gdm9pZDsKCmludGVyZmFjZSBBQkNvbW1hbmRBcmcgewogIGlkZW50aWZpZXI6IHN0cmluZ1tdIHwgc3RyaW5nOwogIGRlc2NyaXB0aW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkNvbW1hbmRIZWxwIHsKICBzaG9ydERlc2NyaXB0aW9uOiBzdHJpbmc7CiAgbG9uZ0Rlc2NyaXB0aW9uPzogc3RyaW5nOwogIGFyZ3M/OiBBQkNvbW1hbmRBcmdbXTsKICB1c2FnZT86IHN0cmluZyB8IHN0cmluZ1tdOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kIHsKICBuYW1lOiBzdHJpbmc7CiAgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrOwogIGhlbHA6IEFCQ29tbWFuZEhlbHA7Cn0A"}]}