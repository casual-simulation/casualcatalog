{"version":2,"updates":[{"id":0,"timestamp":1753123285300,"update":"AakDmKzluAgAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwCYrOW4CAAGc3lzdGVtAgQAmKzluAgBDWFiLnNoZWxsLmdyaWQnAJis5bgIAARmb3JtAgQAmKzluAgPB25vdGhpbmcnAJis5bgIAAxvbkFueUJvdERyYWcCBACYrOW4CBe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAJis5bgIAAhyZW1lbWJlcgIEAJis5bgI0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAmKzluAgACGFiSWdub3JlAgQAmKzluAj6AQR0cnVlJwCYrOW4CAAHYWJTaGVsbAIEAJis5bgI/wEEdHJ1ZScAmKzluAgACWFiVmVyc2lvbgIEAJis5bgIhAIEMTAuNScAmKzluAgABWZvY3VzAgQAmKzluAiJAqwEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKTsKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScAmKzluAi2BgZzeXN0ZW0CBACYrOW4CLcGE2FiLnNoZWxsLmNvbXBvbmVudHMnAJis5bgItgYMQXBwQ29udGFpbmVyAgQAmKzluAjLBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycAmKzluAi2BghUZXh0TGluawIEAJis5bgI+AqjA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwCYrOW4CLYGBldpbmRvdwIEAJis5bgInA62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAJis5bgItgYMVGV4dExpbmsuY3NzAgQAmKzluAjTEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwCYrOW4CLYGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAJis5bgIwRJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAJis5bgItgYKV2luZG93LmNzcwIEAJis5bgIsxOoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAJis5bgItgYIcmVtZW1iZXICBACYrOW4CNwWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJis5bgItgYIYWJJZ25vcmUCBACYrOW4CIMXBHRydWUnAJis5bgItgYHYWJTaGVsbAIEAJis5bgIiBcEdHJ1ZScAmKzluAi2BglhYlZlcnNpb24CBACYrOW4CI0XBDEwLjUnAJis5bgItgYLcGVyc29uYWxpdHkCBACYrOW4CJIXKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYgEnAJis5bgIuRcHQXBwLmNzcwIEAJis5bgIuhexFjpyb290IHsKICAtLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgLS1vbi1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogIC0tYWItY29uc29sZS1oZWlnaHQ6IDMzdmg7Cn0KLyogRGFyayBtb2RlIHN1cHBvcnQgKi8KQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykgewogIDpyb290IHsKICAgIC0tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAgIC0tb24tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICB9Cn0KCi5hYi1jb25zb2xlLWJ0biB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiBpbmhlcml0OwogIGxldHRlci1zcGFjaW5nOiBpbmhlcml0OwogIGxpbmUtaGVpZ2h0OiBpbmhlcml0OwogIHRleHQtdHJhbnNmb3JtOiBpbmhlcml0OwogIHRleHQtaW5kZW50OiBpbmhlcml0OwogIHRleHQtc2hhZG93OiBpbmhlcml0OwogIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgbWFyZ2luOiBpbmhlcml0OwogIHBhZGRpbmctYmxvY2s6IGluaGVyaXQ7CiAgcGFkZGluZy1pbmxpbmU6IGluaGVyaXQ7CiAgYm9yZGVyOiBub25lOwogIHRyYW5zZm9ybTogc2NhbGUoMS4yKTsKfQoKLmFiLWNvbnNvbGUgewogIHdpZHRoOiAxMDB2dzsKICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogIHBhZGRpbmc6IDA7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KSBicmlnaHRuZXNzKDIwMCUpOwogIGFuaW1hdGlvbi1uYW1lOiBzbGlkZS1hcHAtaW47CiAgYW5pbWF0aW9uLWR1cmF0aW9uOiAwLjVzOwogIG92ZXJmbG93LXk6IGhpZGRlbjsKICB6LWluZGV4OiAxOwp9CgouYWItY29uc29sZTo6YWZ0ZXIgewogIGNvbnRlbnQ6ICIiOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB0b3A6IDA7CiAgbGVmdDogMDsKICByaWdodDogMDsKICBib3R0b206IDA7CiAgb3BhY2l0eTogMC45OwogIHotaW5kZXg6IDA7Cn0KCkBrZXlmcmFtZXMgc2xpZGUtYXBwLWluIHsKICBmcm9tIHsKICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGN1YmljLWJlemllciguNiwwLC43OSwxLjAzKTsKICAgIC8qIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMTAlKTsgKi8KICAgIC8qIGhlaWdodDogMHB4OyAqLwogICAgLyogbWluLWhlaWdodDogMHB4OyAqLwogICAgbWF4LWhlaWdodDogMHB4OwogIH0KCiAgdG8gewogICAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogICAgLyogbWluLWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOyAqLwogIH0KfQoKLmFiLWNvbnNvbGUgPiBkaXYgewogIHotaW5kZXg6IDE7CiAgcG9zaXRpb246IHJlbGF0aXZlCn0KCi5hYi1jb25zb2xlLXRvcC1iYXIgewogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHdpZHRoOiAxMDAlOwogIHRleHQtYWxpZ246IGNlbnRlcjsKICB1c2VyLXNlbGVjdDogbm9uZTsKICBkaXNwbGF5OiBmbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBlbmQ7CiAgcGFkZGluZzogMC41cmVtOwp9CgouYWItY29uc29sZS1sb2cgewogIG92ZXJmbG93LXk6IGF1dG87CiAgZmxleC1ncm93OiAxOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwogIG1pbi1oZWlnaHQ6IDI0cHg7CiAgcGFkZGluZzogMCAxcmVtOwogIGN1cnNvcjogcG9pbnRlcjsKICBvdmVyc2Nyb2xsLWJlaGF2aW9yOiBjb250YWluOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBjdXJzb3I6IGluaXRpYWw7Cn0KCi5hYi1jb25zb2xlLW1lc3NhZ2UtY29udGFpbmVyIHsKICBtYXJnaW46IDAuNXJlbSAwOwp9Ci5hYi1jb25zb2xlLW1lc3NhZ2UgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGdhcDogOHB4Owp9CgouYWItY29uc29sZS1zcGFjZXIgewogIGZsZXgtc2hyaW5rOiAwOwogIGZsZXgtZ3JvdzogMTsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgbWF4LXdpZHRoOiA4MHZ3OwogIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScAmKzluAi5FwZnZXRBcHACBACYrOW4COwt3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwCYrOW4CLkXC2hpZGVDb25zb2xlAgQAmKzluAjKUZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwCYrOW4CLkXA2xvZwIEAJis5bgI6lLkCEBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGNyZWF0ZShib3RUYWdzKTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwCYrOW4CLkXC3Nob3dDb25zb2xlAgQAmKzluAjPW+0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAmKzluAi5FwZzeXN0ZW0CBACYrOW4CL1fEGFiLnNoZWxsLmNvbnNvbGUnAJis5bgIuRcNdG9nZ2xlQ29uc29sZQIEAJis5bgIzl+WAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScAmKzluAi5FwRmb3JtAgQAmKzluAjlYAdub3RoaW5nJwCYrOW4CLkXB2FiU2hlbGwCBACYrOW4CO1gBHRydWUnAJis5bgIuRcKYWJJRE9yaWdpbgIEAJis5bgI8mAVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwCYrOW4CLkXBlRvcEJhcgIEAJis5bgIiGHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAmKzluAi5Fw1zaG93Q2hhdElucHV0AgQAmKzluAj8ZQVmYWxzZScAmKzluAi5FwpzaG93VG9wQmFyAgQAmKzluAiCZgVmYWxzZScAmKzluAi5FwlhYlZlcnNpb24CBACYrOW4CIhmBDEwLjUnAJis5bgIuRcSc2V0QWJFeHBhbmRDb25zb2xlAgQAmKzluAiNZpcCQGNvbnNvbGUubG9nKHRoaXNCb3QudmFycy5zZXRTaG93QWxsKQppZiAodHlwZW9mIHRoaXNCb3QudmFycy5zZXRTaG93QWxsICE9PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHMgPT4gIXMpOwp9IGVsc2UgaWYgKHRoYXQgPT0gdHJ1ZSkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwodHJ1ZSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChmYWxzZSk7Cn0KJwCYrOW4CLkXCGFiSWdub3JlAgQAmKzluAilaAR0cnVlJwCYrOW4CLkXB01lc3NhZ2UCBACYrOW4CKpo5xBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPgogICAgICAgICAgICAgICAgICAgIHttZXNzYWdlfQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gTWVzc2FnZTsnAJis5bgIuRcQb25BbnlCb3RzUmVtb3ZlZAIEAJis5bgIknmtAkBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3RJZCBvZiBib3RJRHMpIHsNCiAgICBpZiAodGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgY29uc3QgZGVsZXRlZCA9IHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmRlbGV0ZShib3RJZCk7DQoNCiAgICAgICAgaWYgKGRlbGV0ZWQpIHsNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdElkOiBib3RJZCB9KTsNCiAgICAgICAgfQ0KICAgIH0NCn0nAJis5bgIuRcOb25BbnlCb3RzQWRkZWQCBACYrOW4CMB7+ANAY29uc3QgeyBib3RzIH0gPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IG5ld0JvdCBvZiBib3RzKSB7DQogICAgaWYgKG5ld0JvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhuZXdCb3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQobmV3Qm90LmlkKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdDogbmV3Qm90IH0pOw0KICAgIH0NCn0nAJis5bgIuRcQb25BbnlCb3RzQ2hhbmdlZAIEAJis5bgIuX/jBUBjb25zdCBib3RzID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3Qgb2YgYm90cykgew0KICAgIGlmIChib3QuYm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKGJvdC5ib3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQoYm90LmJvdC5pZCk7DQoNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IGJvdC5ib3QgfSk7DQogICAgICAgIH0gDQoNCiAgICAgICAgaWYgKGJvdC50YWdzLmluY2x1ZGVzKCJtZXNzYWdlIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoIm5hbWUiKSB8fCBib3QudGFncy5pbmNsdWRlcygidGltZXN0YW1wIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoImNvbnNvbGVMb2dNZXNzYWdlQm90IikpIHsNCiAgICAgICAgICAgIGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7ICAgICAgICANCiAgICAgICAgfQ0KICAgIH0NCn0nAJis5bgIuRcfb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZAIEAJis5bgInYUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycAmKzluAi5Fx1vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZAIEAJis5bgI1IUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycBBGJvdHMkMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjAScAmKzluAiLhgEGc3lzdGVtAgQAmKzluAiMhgENYWIuc2hlbGwuaGVscCcAmKzluAiLhgEJb25LZXlEb3duAgQAmKzluAiahgGMAkBpZiAodGFncy5oZWxwQWN0aXZlICYmIHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJykpIHsKICAgIGlmICh0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgIGZvciAobGV0IGNhbGxiYWNrIG9mIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0nAJis5bgIi4YBB3VubW91bnQCBACYrOW4CKeIAaABQGF3YWl0IG9zLmNvbXBpbGVBcHAoJ2FiLWNvbW1hbmQtaGVscCcsIDw+PC8+KTsKYXdhaXQgb3MudW5yZWdpc3RlckFwcCgnYWItY29tbWFuZC1oZWxwJyk7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IHVuZGVmaW5lZDsKbWFza3MuaGVscEFjdGl2ZSA9IGZhbHNlOycAmKzluAiLhgEJc3R5bGUuY3NzAgQAmKzluAjIiQHxBy5oZWxwLXRhYmxlIHsKICB3aWR0aDogMTAwJTsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLmhlbHAtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5oZWxwLXRhYmxlIHRkIGgzIHsKICBtYXJnaW46IDA7Cn0KCi5oZWxwLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9Cgouc2VjdGlvbiB7CiAgbWFyZ2luLXRvcDogMTZweDsKfQoKLnNlY3Rpb24gcDpmaXJzdC1vZi10eXBlIHsKICBtYXJnaW4tdG9wOiA0cHg7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5kZXNjcmlwdGlvbiB7IAogIHdoaXRlLXNwYWNlOiBwcmUtbGluZTsKfQoKLnVzYWdlLXRhYmxlIHsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLnVzYWdlLXRhYmxlIHRkLGgzIHsgCiAgdmVydGljYWwtYWxpZ246IHRvcDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgbWFyZ2luOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogNjBweDsKfQoKLmFyZ3MtdGFibGUgewogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouYXJncy10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmFyZ3MtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCksIChtYXgtaGVpZ2h0OiA2MDBweCkgewogIC5oZWxwLXdpbmRvdyB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGxlZnQ6IHVuc2V0OwogICAgdG9wOiB1bnNldDsKICAgIHRyYW5zZm9ybTogdW5zZXQ7CiAgICBtYXgtd2lkdGg6IHVuc2V0OwogICAgbWF4LWhlaWdodDogdW5zZXQ7CiAgICBib3gtc2hhZG93OiB1bnNldDsKICB9Cn0nAJis5bgIi4YBCW9uRGVzdHJveQIEAJis5bgIupEBE0B0aGlzQm90LnVubW91bnQoKTsnAJis5bgIi4YBBW1vdW50AgQAmKzluAjOkQGTA0Bjb25zdCB7CiAgICBhYkNvbW1hbmRzTWFuYWdlciwKICAgIHNlbGVjdGVkQ29tbWFuZAp9ID0gdGhhdCA/PyB7fTsKCmlmIChtYXNrcy5oZWxwQWN0aXZlKSB7CiAgICBhd2FpdCB0aGlzQm90LnVubW91bnQoKTsKfQoKY29uc3QgSGVscEFwcCA9IHRoaXNCb3QuSGVscEFwcCgpOwoKYXdhaXQgb3MucmVnaXN0ZXJBcHAoJ2FiLWNvbW1hbmQtaGVscCcsIHRoaXNCb3QpOwphd2FpdCBvcy5jb21waWxlQXBwKCdhYi1jb21tYW5kLWhlbHAnLCA8SGVscEFwcCBjb21tYW5kcz17YWJDb21tYW5kc01hbmFnZXIuY29tbWFuZHN9IGluaXRpYWxTZWxlY3RlZENvbW1hbmQ9e3NlbGVjdGVkQ29tbWFuZH0vPik7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IFtdOwptYXNrcy5oZWxwQWN0aXZlID0gdHJ1ZTsnAJis5bgIi4YBB0hlbHBBcHACBACYrOW4COKUAbovQGNvbnN0IEFwcENvbnRhaW5lciA9IGxpbmtzLmNvbXBvbmVudHMuQXBwQ29udGFpbmVyKCk7CmNvbnN0IFdpbmRvdyA9IGxpbmtzLmNvbXBvbmVudHMuV2luZG93KCk7CmNvbnN0IFRleHRMaW5rID0gbGlua3MuY29tcG9uZW50cy5UZXh0TGluaygpOwpjb25zdCBjc3MgPSBsaW5rcy51dGlscy5hYkNvbXBpbGVDU1MoWyB0aGlzQm90LCBsaW5rcy5jb21wb25lbnRzIF0pOwoKY29uc3QgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlUmVmLCB1c2VNZW1vIH0gPSBvcy5hcHBIb29rczsKCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqLwpjb25zdCBBdmFpbGFibGVDb21tYW5kcyA9ICh7IGNvbW1hbmRzLCBvbkNvbW1hbmRDbGljayB9KSA9PiB7CiAgICBjb25zdCBjb21tYW5kTmFtZXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcykuc29ydCgpOwoKICAgIGNvbnN0IG9uQ2xvc2UgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQ2xvc2V9PnsneCBDbG9zZSd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj5BdmFpbGFibGUgQ29tbWFuZHM8L2gyPgogICAgICAgICAgICA8cD5Vc2FnZTogLmNvbW1hbmQgW29wdGlvbnNdPC9wPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgICAgIHtjb21tYW5kTmFtZXMubWFwKChuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRzW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PFRleHRMaW5rIG9uQ2xpY2s9eygpID0+IG9uQ29tbWFuZENsaWNrKGNvbW1hbmQubmFtZSl9Pntjb21tYW5kLm5hbWV9PC9UZXh0TGluaz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntkZXNjcmlwdGlvbn08L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7Q29tbWFuZH0gcHJvcHMuY29tbWFuZAogKi8KY29uc3QgU3BlY2lmaWNDb21tYW5kID0gKHsgY29tbWFuZCwgb25CYWNrIH0pID0+IHsKICAgIGxldCB1c2FnZSA9ICcnOwogICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKICAgIGxldCBhcmdzID0gbnVsbDsKCiAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC51c2FnZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb21tYW5kLmhlbHAudXNhZ2UpKSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZS5qb2luKCdcbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbjsKICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MgJiYgY29tbWFuZC5oZWxwLmFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhcmdzID0gY29tbWFuZC5oZWxwLmFyZ3M7CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+ICAKICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQmFja30+eyc8IEJhY2snfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+e2NvbW1hbmQubmFtZX08L2gyPgogICAgICAgICAgICB7IHVzYWdlICYmCiAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSd1c2FnZS10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGgzPlVzYWdlOjwvaDM+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2FnZX08L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgZGVzY3JpcHRpb24gJiYgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkRlc2NyaXB0aW9uOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdkZXNjcmlwdGlvbic+e2Rlc2NyaXB0aW9ufTwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgYXJncyAmJgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5Bcmd1bWVudHM6PC9oMz4KICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdhcmdzLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICAgICAgeyBhcmdzLm1hcCgoYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZy5pZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdJZGVudGlmaWVyRGlzcGxheSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyLmpvaW4oJyxcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmcuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBhcmcuZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnSWRlbnRpZmllckRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdEZXNjcmlwdGlvbkRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqIEBwYXJhbSB7YW55W119IFtwcm9wcy5hcmdzXQogKi8KY29uc3QgSGVscEFwcCA9ICh7IGNvbW1hbmRzLCBpbml0aWFsU2VsZWN0ZWRDb21tYW5kIH0pID0+IHsKICAgIGNvbnN0IFsgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmQgXSA9IHVzZVN0YXRlKGluaXRpYWxTZWxlY3RlZENvbW1hbmQpOwoKICAgIC8vIEVzY2FwZSBrZXkgcHJlc3MgZXZlbnQgaGFuZGxlcgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBjb25zdCBvbkVzY2FwZUtleVByZXNzID0gKCkgPT4gewogICAgICAgICAgICBpZiAoc2VsZWN0ZWRDb21tYW5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5wdXNoKG9uRXNjYXBlS2V5UHJlc3MpOwoKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBjb25zdCBjYWxsYmFja0luZGV4ID0gdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MuZmluZEluZGV4KChjYWxsYmFjaykgPT4gY2FsbGJhY2sgPT09IG9uRXNjYXBlS2V5UHJlc3MpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5zcGxpY2UoY2FsbGJhY2tJbmRleCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBbc2VsZWN0ZWRDb21tYW5kXSk7CiAgICAKICAgIGNvbnN0IG9uQmFja2dyb3VuZENsaWNrID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwoKICAgIGNvbnN0IG9uQ29tbWFuZENsaWNrID0gdXNlQ2FsbGJhY2soKG5hbWUpID0+IHsKICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobmFtZSk7CiAgICB9LCBbc2V0U2VsZWN0ZWRDb21tYW5kXSkKCiAgICBjb25zdCBjb250ZW50ID0gdXNlTWVtbygoKSA9PiB7CiAgICAgICAgaWYgKCFzZWxlY3RlZENvbW1hbmQpIHsKICAgICAgICAgICAgcmV0dXJuIDxBdmFpbGFibGVDb21tYW5kcyBjb21tYW5kcz17Y29tbWFuZHN9IG9uQ29tbWFuZENsaWNrPXtvbkNvbW1hbmRDbGlja30vPgogICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICByZXR1cm4gPFNwZWNpZmljQ29tbWFuZCBjb21tYW5kPXtjb21tYW5kc1tzZWxlY3RlZENvbW1hbmRdfSBvbkJhY2s9eygpID0+IHNldFNlbGVjdGVkQ29tbWFuZChudWxsKX0vPgogICAgICAgIH0KICAgIH0sIFtjb21tYW5kcywgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmRdKTsKCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxzdHlsZT57Y3NzfTwvc3R5bGU+CgogICAgICAgICAgICA8QXBwQ29udGFpbmVyIG9uQmFja2dyb3VuZENsaWNrPXtvbkJhY2tncm91bmRDbGlja30+CiAgICAgICAgICAgICAgICA8V2luZG93PgogICAgICAgICAgICAgICAgICAgIHtjb250ZW50fQogICAgICAgICAgICAgICAgPC9XaW5kb3c+CiAgICAgICAgICAgIDwvQXBwQ29udGFpbmVyPgogICAgICAgIDwvPgogICAgKQp9CgpyZXR1cm4gSGVscEFwcDsnAJis5bgIi4YBCmNvbXBvbmVudHMCBACYrOW4CJ3EASjwn5SXMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhJwCYrOW4CIuGAQV1dGlscwIEAJis5bgIxMQBKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAJis5bgIi4YBCGFiSWdub3JlAgQAmKzluAjrxAEEdHJ1ZScAmKzluAiLhgEHYWJTaGVsbAIEAJis5bgI8MQBBHRydWUnAJis5bgIi4YBCWFiVmVyc2lvbgIEAJis5bgI9cQBBDEwLjUnAQRib3RzJDM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MwEnAJis5bgI+sQBBnN5c3RlbQIEAJis5bgI+8QBD2FiLnNoZWxsLmNyZWF0ZScAmKzluAj6xAEEZm9ybQIEAJis5bgIi8UBB25vdGhpbmcnAJis5bgI+sQBC2Rlc2NyaXB0aW9uAgQAmKzluAiTxQE9Qm90IHVzZWQgdG8gY3JlYXRlL21hbmlmZXN0IGJvdHMgaW50byBhbiBhY3R1YWwgc2NlbmUvcG9ydGFsLicAmKzluAj6xAEMYWJDcmVhdGVCb3RzAgQAmKzluAjRxQGkJ0BsZXQgeyAKICAgIGluaXRpYWxCb290LCAvLyBjaGVja3MgZm9yIGluaXRpYWwgYm9vdCBib29sZWFuIChvcHRpb25hbCkKICAgIGJvdERhdGEsIC8vIGJvdHMgdG8gYmUgZ2VuZXJhdGVkCiAgICBvcmlnaW4sIC8vIHdoZXJlIGRpZCB0aGUgZGF0YSBjb21lIGZyb20gKG9wdGlvbmFsKQogICAgc3R1ZGlvLCAvLyB3aGF0IHN0dWRpbyBpcyB0aGlzIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICByZWNvcmQsIC8vIFJ5YW4gQ29vazogZG8gd2UgbmVlZCB0aGlzIGlmIHdlIGFscmVhZHkgaGF2ZSBzdHVkaW8/IChvcHRpb25hbCkKICAgIHZlcnNpb24sIC8vIHZlcnNpb24gb2YgdGhlIGRhdGEgKG9wdGlvbmFsKQogICAgZWdnUGFyYW1ldGVycywgLy8gZGF0YSB0byBwYXNzIHRvIGFsbCBjcmVhdGVkIGJvdHMgdmlhIEBvbkVnZ0hhdGNoLiAob3B0aW9uYWwpCiAgICBpZ25vcmVHcmlkRm9jdXMsIC8vIFJ5YW4gQ29vazogYWRkaW5nIHRoaXMgYXMgYW4gb3B0aW9uYWwgZmxhZy4gKG9wdGlvbmFsKQogICAgb25QcmVwcm9jZXNzQm90RGF0YSwgLy8gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlIGNyZWF0ZWQuIChvcHRpb25hbCkKICAgIHNvdXJjZUV2ZW50LCAvLyBzb3VyY2VFdmVudCBpcyBhbiBldmVudCBuYW1lIHRoYXQgc3ltYm9saXplcyB3aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwgdG8gYWJDcmVhdGVCb3RzLiAob3B0aW9uYWwpLgp9ID0gdGhhdDsKCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGZvciB3aGVuIGFiQ3JlYXRlQm90cyBleHBlY3RlZCAiYm90cyIgcGFyYW1ldGVyLgppZiAoIWJvdERhdGEgJiYgdGhhdC5ib3RzKSB7CiAgICBib3REYXRhID0gdGhhdC5ib3RzOwp9CgpsZXQgYm90Q291bnQgPSBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGg7CmNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCi8vIFJ1biBzb21lIGFiLXNwZWNpZmljIHByZXByb2Nlc3Npbmcgb2YgYm90IGRhdGEuCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIGRhdGEudGFncy5hYklET3JpZ2luID0gb3JpZ2luOwogICAgICAgIGRhdGEudGFncy5hYklEU3R1ZGlvID0gc3R1ZGlvOwoKICAgICAgICBpZiAoZGF0YS50YWdzLmNyZWF0b3IpIHsKICAgICAgICAgICAgZGF0YS50YWdzLm9sZENyZWF0b3IgPSBkYXRhLnRhZ3MuY3JlYXRvcjsKICAgICAgICB9CgogICAgICAgIC8vIFJ5YW4gQ29vazogVGhpcyB0YXJnZXRQb3NpdGlvbiBzdHVmZiBpcyBhcHBhcmVudGx5IHVzZWQgZm9yIGJvdCBwYXN0aW5nPyAKICAgICAgICAvLyBUaGlzIGlzIHNvbWUgcmVhbGx5IGNvbmZ1c2luZyBsb2dpYyBhbmQgc2hvdWxkIGJlIHJlZmFjdG9yZWQgZXZlbnR1YWxseS4KICAgICAgICBpZiAoKGJvdENvdW50IDwgMiB8fCBib3RDb3VudCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uICsgJ1gnXSA9IGFiR3JpZEZvY3VzLnBvc2l0aW9uLng7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWSddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueTsKICAgICAgICB9CiAgICB9Cn0KCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlYSBjcmVhdGVkLgpsZXQgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQm90RGF0YSkgewogICAgb25QcmVwcm9jZXNzQm90RGF0YShwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQm90RGF0YScsIHByZXByb2Nlc3NBcmcpKTsKCi8vIENyZWF0ZSBib3RzIGZyb20gdGhlIGJvdCBkYXRhLgpsZXQgaWRNYXAgPSBuZXcgTWFwKCk7CmxldCBuZXdCb3RzID0gW107CmxldCBuZXdCb3RJZHMgPSBbXTsKCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIHRyeSB7IAogICAgICAgICAgICBjb25zdCBuZXdCb3QgPSBjcmVhdGUoZGF0YS50YWdzKTsKCiAgICAgICAgICAgIGlkTWFwLnNldChkYXRhLmlkLCBuZXdCb3QuaWQpOwogICAgICAgICAgICBuZXdCb3RzLnB1c2gobmV3Qm90KTsKICAgICAgICAgICAgbmV3Qm90SWRzLnB1c2gobmV3Qm90LmlkKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaW52YWxpZCBib3RgLCBlKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpcHBlZCBib3Q6IGAsIGRhdGEpOwogICAgfQp9CgovLyBBcnJheSBvZiB0YWcgcmVsYXRpb25zaGlwcyB0byBiZSBwcmVzZXJ2ZWQKY29uc3QgbGlua1RhZ3MgPSBbImxpbmsiLCAiY3JlYXRvciIsICJjb25maWdCb3QiLCAibGluZVRvIiwgInRyYW5zZm9ybWVyIiwgImZvcm1MaWdodFRhcmdldCJdOwoKLy8gVGhpcyBsb29wIGNvbnRhaW5zIHRoZSBsb2dpYyBmb3IgcHJlc2VydmluZyB0aGUgbGlua1RhZ3MKZm9yIChsZXQgbmV3Qm90IG9mIG5ld0JvdHMpIHsKICAgIGZvciAobGV0IHRhZyBvZiBsaW5rVGFncykgewogICAgICAgIGxldCB2YWx1ZSA9IG5ld0JvdC50YWdzW3RhZ107CgogICAgICAgIGlmICh0YWcgPT0gImNyZWF0b3IiKSB7CiAgICAgICAgICAgIHZhbHVlID0gbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvcjsKICAgICAgICAgICAgbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVCb3RMaW5rcyhuZXdCb3QsIGlkTWFwKTsKCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgbGV0IG5ld1ZhbHVlID0gdmFsdWUubWFwKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWRNYXAuZ2V0KGlkKSB8fCBpZDsKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdJRCA9IGlkTWFwLmdldCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgaWYgKG5ld0lEKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3SUQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vIFRvYXN0cyBmb3IgaGF0Y2hlcywgYnV0IG9ubHkgb24gYnVpbGRlcgppZiAob3JpZ2luICYmIHZlcnNpb24gJiYgY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlID09IG51bGwgJiYgIWNvbmZpZ0JvdC50YWdzLnBoICYmIGJ1aWxkZXJWZXJzaW9uID09ICJidWlsZGVyIikgewogICAgb3MudG9hc3QoImhhdGNoZWQgIiArIG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uKTsKfQoKaWYgKG9yaWdpbikgewogICAgLy8gQ3JlYXRlIGFiRWdnIGJvdCB0aGF0IHRyYWNrcyBjYW4gYmUgdXNlZCB0byB0cmFjayB3aGF0IGVnZ3MgaGF2ZSBiZWVuIGhhdGNoZWQuCiAgICBjcmVhdGUoewogICAgICAgIHNwYWNlOiAic2hhcmVkIiwKICAgICAgICBhYjogdHJ1ZSwKICAgICAgICBhYkVnZzogdHJ1ZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBvcmlnaW5fYWI6IG9yaWdpbiwKICAgICAgICBvcmlnaW5fdmVyc2lvbjogdmVyc2lvbiwKICAgICAgICBvcmlnaW5fcmVjb3JkOiByZWNvcmQsCiAgICAgICAgb3JpZ2luX3N0dWRpbzogc3R1ZGlvLAogICAgICAgIGZvcm06ICJlZ2ciLAogICAgICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgICAgICBsYWJlbDogb3JpZ2luICsgIiB2IiArIHZlcnNpb24sCiAgICB9KTsKfQoKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47Cgp3aGlzcGVyKG5ld0JvdHMsICdvblByZUhhdGNoJywgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOwoKaWYgKGluaXRpYWxCb290KSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy8gb25FZ2dIYXRjaCBmb3IgYWxsIGp1c3QgaGF0Y2hlZCBib3RzCndoaXNwZXIobmV3Qm90cywgIm9uRWdnSGF0Y2giLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgZWdnUGFyYW1ldGVycywgc291cmNlRXZlbnQgfSk7CgovLyBvbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQUJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKc3VwZXJTaG91dCgib25BYkFkZGVkIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCnJldHVybiBuZXdCb3RzOycAmKzluAj6xAEIcmVtZW1iZXICBACYrOW4CPbsASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCYrOW4CPrEAQhhYklnbm9yZQIEAJis5bgIne0BBHRydWUnAJis5bgI+sQBB2FiU2hlbGwCBACYrOW4CKLtAQR0cnVlJwCYrOW4CPrEAQlhYlZlcnNpb24CBACYrOW4CKftAQQxMC41JwCYrOW4CPrEAQtwZXJzb25hbGl0eQIEAJis5bgIrO0BKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZgEnAJis5bgI0+0BBnN5c3RlbQIEAJis5bgI1O0BEGFiLnNoZWxsLnZlcnNpb24nAJis5bgI0+0BBGZvcm0CBACYrOW4COXtAQdub3RoaW5nJwCYrOW4CNPtAQhhYklnbm9yZQIEAJis5bgI7e0BBHRydWUnAJis5bgI0+0BB2FiU2hlbGwCBACYrOW4CPLtAQR0cnVlJwCYrOW4CNPtARNhYlNoZWxsTWFqb3JWZXJzaW9uAgQAmKzluAj37QEBMScAmKzluAjT7QENb25Ta2lsbFVwZGF0ZQIEAJis5bgI+e0BlwFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJTaGVsbE1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJTaGVsbE1pbm9yVmVyc2lvbjsNCg0KY29uc29sZS5sb2coIltBQlNoZWxsXSBMb2FkZWQgQUIgc2hlbGwgdmVyc2lvbiAiICsgdmVyc2lvblN0cmluZyk7JwCYrOW4CNPtAQlhYlZlcnNpb24CBACYrOW4CJHvAQQxMC41JwCYrOW4CNPtARNhYlNoZWxsTWlub3JWZXJzaW9uAgQAmKzluAiW7wECMTMnAQRib3RzJDc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZgEnAJis5bgIme8BBnN5c3RlbQIEAJis5bgImu8BDmFiLnNoZWxsLnN0b3JlJwCYrOW4CJnvAQRmb3JtAgQAmKzluAip7wEHbm90aGluZycAmKzluAiZ7wELZGVzY3JpcHRpb24CBACYrOW4CLHvAT9UaGlzIHNraWxsIGlzIG1lYW50IHRvIGJlIGEgY29uZmlndXJhYmxlIG1lYW5zIHRvIHB1Ymxpc2ggZGF0YS4nAJis5bgIme8BD2FiUHVibGlzaFJlY29yZAIEAJis5bgI8e8BwAZAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBwdWJsaWNGYWNpbmcgPSB0aGF0LnB1YmxpY0ZhY2luZzsKbGV0IHJlY29yZERhdGEgPSB0aGF0LmRhdGE7CmxldCByZWNvcmROYW1lID0gdGhhdC5yZWNvcmROYW1lOwpsZXQgZW5kcG9pbnQgPSB0aGF0LmVuZHBvaW50ID8gdGhhdC5lbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKaWYgKCFyZWNvcmREYXRhKQp7CiAgICByZXR1cm4gIm5vIGRhdGEgc3VwcGxpZWQiOwp9CgppZiAocHVibGljRmFjaW5nKQp7CiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbInB1YmxpY1JlYWQiXX0pOwp9CmVsc2UKeyAgICAKICAgIHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHtlbmRwb2ludDogZW5kcG9pbnQsIG1hcmtlcnM6IFtyZWNvcmROYW1lXX0pOwp9CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRhdGEgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIHJlY29yZERhdGE7JwCYrOW4CJnvAQ1hYlB1Ymxpc2hGaWxlAgQAmKzluAiy9gGsB0Bhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGZpbGUgPSB0aGF0LmZpbGU7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZU5hbWU7CmxldCBtaW1lVHlwZSA9IHRoYXQubWltZVR5cGU7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghZmlsZSkKewogICAgcmV0dXJuICJubyBmaWxlIHN1cHBsaWVkIjsKfQoKbGV0IGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHtkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwogICAgCmlmICghZmlsZVVwbG9hZC5zdWNjZXNzKSAKewogICAgaWYgKGZpbGVVcGxvYWQuZXJyb3JDb2RlID09ICJmaWxlX2FscmVhZHlfZXhpc3RzIikKICAgIHsKICAgICAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgYWxyZWFkeSBleGlzdHMgaW4gIiArIHVzZXJSZWNvcmQpOwoKICAgICAgICByZXR1cm4gZmlsZVVwbG9hZDsKICAgIH0KCiAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24odXNlclJlY29yZCk7CgogICAgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwge2Rlc2NyaXB0aW9uOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlfSk7Cn0KCmlmIChmaWxlVXBsb2FkLnN1Y2Nlc3MpCnsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZmlsZSByZWNvcmRlZCB0byAiICsgdXNlclJlY29yZCk7Cn0KZWxzZQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgZmFpbGVkIHRvIHJlY29yZCIpOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAJis5bgIme8BEGFiQ29yZU1lbnVBY3Rpb24CBACYrOW4CN/9AU1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAmKzluAiZ7wELb25TdG9yZU1lbnUCBACYrOW4CK3+AcuTAUBjb25zdCB0YXJnZXRCb3RzID0gWy4uLm5ldyBTZXQobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKV07CmNvbnN0IHBvc3NpYmxlUHVibGlzaEJvdCA9IHRhcmdldEJvdHM/Lmxlbmd0aCA+IDAgPyB0YXJnZXRCb3RzIDogbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyA/IFtsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzXSA6IFtdOwpjb25zdCBiYXNlQUIgPSAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyA/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOiBsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzLmlkOwpjb25zdCBiYXNlQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IGJhc2VBQiwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhieU1vZCh7YWJJRE9yaWdpbjogbnVsbCwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBkZWZhdWx0cyA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbWFuYWdlcjogIvCflJciICsgdGhpc0JvdC5pZCwKICAgIG1hbmlmZXN0YXRpb246IHRhZ3MubWFuaWZlc3RhdGlvbiwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gCn0KCi8vIENyZWF0ZSBkb3dubG9hZCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICBsYWJlbDogImRvd25sb2FkIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtQWRkcmVzczogImdldF9hcHAiLAogICAgcG9zc2libGVCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJEb3dubG9hZCh7YmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgcG9zc2libGVCb3RzOiBsaW5rcy5wb3NzaWJsZUJvdH0pO2AKfSk7CgppZiAoIWF1dGhCb3QpIAp7CiAgICAvLyBDcmVhdGUgbG9naW4gbWVzc2FnZQogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgICAgICBsYWJlbDogInBsZWFzZSBzaWduIGluIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIiwKICAgICAgICBvbkNsaWNrOiBgQCBvcy5yZXF1ZXN0QXV0aEJvdCgpYAogICAgfSk7CgogICAgcmV0dXJuOwp9CmVsc2UgaWYgKGF1dGhCb3QudGFncy5zdWJzY3JpcHRpb25UaWVyID09ICJGcmVlUGxheSIpIAp7CiAgICAvLyBDcmVhdGUgdXBncmFkZSBzdWJzY3JpcHRpb24gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJwbGVhc2UgdXBncmFkZSB5b3VyIHN1YnNjcmlwdGlvbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIKICAgIH0pOwoKICAgIHJldHVybjsKfQoKCmxldCB1c2VyU3R1ZGlvcyA9IGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvczsKCmlmICghdXNlclN0dWRpb3MpIAp7CiAgICB1c2VyU3R1ZGlvcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOwp9CgppZiAodXNlclN0dWRpb3Muc3VjY2VzcykgCnsKICAgIGNvbnN0IGFjdGl2ZVN0dWRpbyA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpOwoKICAgIGxldCBiYXNlU3R1ZGlvID0gYXV0aEJvdC5pZDsKCiAgICBpZiAoYmFzZVN0dWRpbyA9PSBhdXRoQm90LmlkKSAKICAgIHsKICAgICAgICBiYXNlU3R1ZGlvID0gInBsYXllciI7CiAgICB9CgogICAgaWYgKGFjdGl2ZVN0dWRpbyA9PSAtMSAmJiBiYXNlU3R1ZGlvICE9ICJwbGF5ZXIiKSAKICAgIHsKICAgICAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGJhc2VTdHVkaW87CiAgICB9CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyAmJiAhYWN0aXZlU3R1ZGlvKSAKICAgIHsKICAgICAgICBjb25zdCBzdHVkaW9NYXRjaCA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQoKICAgICAgICBpZiAoc3R1ZGlvTWF0Y2ggIT0gLTEpIHsKICAgICAgICAgICAgYmFzZVN0dWRpbyA9IGJhc2VTdHVkaW87CiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHN0dWRpb0xhYmVsID0gYWN0aXZlU3R1ZGlvID09IC0xID8gYmFzZVN0dWRpbyA6IHVzZXJTdHVkaW9zLnN0dWRpb3NbYWN0aXZlU3R1ZGlvXS5kaXNwbGF5TmFtZTsKCiAgICAvLyBDcmVhdGUgc3R1ZGlvIHNlbGVjdCBidXR0b24KICAgIGNvbnN0IHN0dWRpb0Rpc3BsYXlCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJzdHVkaW89IiArIHN0dWRpb0xhYmVsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41LAogICAgICAgIHN0dWRpb0luZm9ybWF0aW9uOiB1c2VyU3R1ZGlvcywKICAgICAgICBmb3JtQWRkcmVzczogImludmVudG9yeV8yIiwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLnN0dWRpb1NlbGVjdCh0YWdzLnN0dWRpb0luZm9ybWF0aW9uKTtgCiAgICB9KTsKCiAgICBtYXNrcy5zdHVkaW9TZWxlY3RCdXR0b24gPSBnZXRMaW5rKHN0dWRpb0Rpc3BsYXlCdXR0b24pOwp9Cgpjb25zdCB0b3RhbEJvdENvdW50ID0gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA+IDAgPyBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoIDogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aDsKCi8vIENyZWF0ZSBwdWJsaXNoIGxhYmVsIGJ1dHRvbgpjb25zdCBsYWJlbEJvdCA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgbGFiZWw6IGBwdWJsaXNoIHBhdHRlcm4gJHtiYXNlQm90cy5sZW5ndGggPiAwID8gIiIgOiAiYXMgIn0ke2Jhc2VBQn0gKCR7dG90YWxCb3RDb3VudH0gYm90JHtiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgIHRvdGFsQm90czogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCwKICAgIGFiTWVudVNvcnRPcmRlcjogMSwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIGZvcm1BZGRyZXNzOiBudWxsLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCA4cHggMHB4IDBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLXRvcC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIHNoaWZ0U3RhdGU6IGZhbHNlLAogICAgb25DbGljazogYEAgY29uc3QgbWVudUJvdHMgPSBnZXRCb3RzKCdhYk1lbnVTb3J0T3JkZXInKTsKCiAgICAgICAgaWYgKHRhZ3Muc2hpZnRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleVVwIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlEb3duIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0YWdzLnNoaWZ0U3RhdGUgPSAhdGFncy5zaGlmdFN0YXRlO2AsCiAgICBzY2FsZVk6ICJhdXRvIiwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGxldCB0b3RhbEJvdHMgPSBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPyB0aGF0LmFiQm90cyA6IHRoYXQuYWJCb3RzICsgdGhhdC5ub25BQkJvdHM7CgogICAgY29uc3QgdG90YWxCb3RWYXIgPSB0b3RhbEJvdHMgPT0gMSA/ICIgYm90IiA6ICIgYm90cyI7CiAgICBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cz8ubGVuZ3RoICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgaWYgKGdldEJvdCgiYWJJRE9yaWdpbiIsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCKSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpLmxlbmd0aDsKCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgYWJCb3RzICsgIiBib3RzKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gYWJCb3RzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggcGF0dGVybiBhcyAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgICAgIH0gICAKICAgIH0KICAgIGVsc2UKICAgIHsgICAKICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIHRoYXQuYWIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICB9YAp9KTsKCi8vIENyZWF0ZSBlbmNyeXB0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICBsYWJlbDogImVuY3J5cHQiLAogICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICBlbmNyeXB0U3RhdGU6IGZhbHNlLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgaWYodGFncy5lbmNyeXB0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gdHJ1ZTsKICAgICAgICB9YCwKfSk7CgpsZXQgYWJCdXR0b247CgppZiAocG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvLyBDcmVhdGUgaW5jbHVkZUJvdHMgYnV0dG9uCiAgICBhYkJ1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTIsCiAgICAgICAgYWJTZWxlY3Rpb25CdXR0b246IHRydWUsCiAgICAgICAgbGFiZWw6IGJhc2VCb3RzLmxlbmd0aCA+IDAgJiYgYmFzZUFCICE9IHVuZGVmaW5lZCA/IGBzZWxlY3RlZCBwYXR0ZXJuOiAke2Jhc2VBQn0gKCR7YmFzZUJvdHMubGVuZ3RofSBib3Qke2Jhc2VCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAgOiBgbmV3IHBhdHRlcm4gKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogJ2VnZycsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaFNlbGVjdCgpO2AsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyTm9uID0gdGhhdC5ub25BQkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgY29uc3QgYm90VmFyQUIgPSB0aGF0LmFiQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICAgICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSB0aGF0LmFiICsgIiAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyTm9uOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInNlbGVjdGVkIHBhdHRlcm46ICIgKyB0aGF0LmFiICsgIiAoIiArIHRoYXQuYWJCb3RzICsgYm90VmFyQUI7CiAgICAgICAgfWAKICAgIH0pOwp9CgppZiAobm9uQUJCb3RzLmxlbmd0aCA+IDAgJiYgcG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvL2ljbHVkZSBuZXcgYm90cwogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTMsCiAgICAgICAgYWJCdXR0b246IGdldExpbmsoYWJCdXR0b24pLAogICAgICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgICAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgICAgIGxhYmVsOiBgaW5jbHVkZSBuZXcgKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveCIsCiAgICAgICAgdW5jbGFpbWVkU3RhdGU6IGZhbHNlLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CgogICAgICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IGxpbmtzLmFiQnV0dG9uLnRhZ3MubGFiZWw7CgogICAgICAgICAgICAgICAgaWYgKGxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRhZ3MudW5jbGFpbWVkU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IG51bGwsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CgogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25BQkJvdHMubGVuZ3RofSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwoKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IHRydWU7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogMH0pOwogICAgICAgICAgICB9YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cyA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIAogICAgICAgICAgICB0YWdzLmxhYmVsID0gImluY2x1ZGUgbmV3ICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXI7CgogICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gdGhhdC5hYjsKCiAgICAgICAgICAgIGlmKCFsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHB1YmxpYyBidXR0b24KaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSAKewogICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gZmFsc2U7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgICAgICBsYWJlbDogImlzUHVibGljIiwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgICAgICBwdWJsaWNTdGF0ZTogZmFsc2UsCiAgICAgICAgb25DbGljazogYEAgaWYodGFncy5wdWJsaWNTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSB0cnVlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSB2ZXJzaW9uIHNlbGVjdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgbGFiZWw6ICd2ZXJzaW9uRmxhZz1jdXJyZW50JywKICAgIGZvcm1BZGRyZXNzOiAnYWx0X3JvdXRlJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBzaG91dCgnc2hvd1ZlcnNpb25TZWxlY3RvcicpO2AsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAndmVyc2lvbkZsYWc9JyArIHRoYXQ7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICBgLAp9KTsKCi8vIEN1cnJlbnQgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnY3VycmVudCcsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gRmVlZGJhY2sgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnZmVlZGJhY2snLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnZmVlZGJhY2snOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIFN0YWJsZSBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdzdGFibGUnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTIsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnc3RhYmxlJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBDcmVhdGUgcHVibGlzaCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDQsCiAgICBmb3JtQWRkcmVzczogImVnZyIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCA4cHggOHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWJvdHRvbS1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtOiAiaW5wdXQiLAogICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgb25JbnB1dFR5cGluZzogYEAgbGlua3MubGFiZWxCb3QudGFncy5sYWJlbCA9ICdwdWJsaXNoIHBhdHRlcm4gYXMgJyArIHRoYXQudGV4dCArICcgKCcgKyBsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyArICcgYm90JyArIChsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyA9PSAxID8gJyknIDogJ3MpJyk7YCwKICAgIG1lbnVJdGVtU2hvd1N1Ym1pdFdoZW5FbXB0eTogdHJ1ZSwKICAgIHRhcmdldEJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgbWVudUl0ZW1UZXh0OiBiYXNlQUIsCiAgICBvblN1Ym1pdDogYEAKICAgICAgICAgICAgaWYgKHRoYXQudGV4dCA9PSBudWxsICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGF0LnRleHQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKICAgICAgICAgICAgY29uc3QgY29uZmlybVB1c2ggPSBhd2FpdCBvcy5zaG93Q29uZmlybSh7CiAgICAgICAgICAgICAgICB0aXRsZTogImNvbmZpcm0gcHVibGlzaCIsCiAgICAgICAgICAgICAgICBjb250ZW50OiAicHVibGlzaCAiICsgdGhhdC50ZXh0ICsgIiB0byAiICsgdGFyZ2V0U3R1ZGlvICsgIj8iLAogICAgICAgICAgICAgICAgY29uZmlybVRleHQ6ICJwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNhbmNlbFRleHQ6ICJjYW5jZWwiCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKCFjb25maXJtUHVzaCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25maWdCb3QudGFncy5tYW51YWxQdWJsaXNoID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoQUIoe2FiOiB0aGF0LnRleHQsIG1hbnVhbFB1Ymxpc2g6IHRydWUsIGJvdDogbGlua3MudGFyZ2V0Qm90LCBiYXNlQUI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvcy50b2FzdCgiYWIgbm90IHNwZWNpZmllZCIpOwogICAgICAgICAgICB9CiAgICAgICAgYCwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIAogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gdGhhdC5hYjsKICAgIH1gCn0pOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIAp7CiAgICAvLyBDcmVhdGUgY29weSB0byBjbGlwYm9hcmQgYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA4LAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogImNvcHkgdG8gY2xpcGJvYXJkIiwKICAgICAgICBmb3JtQWRkcmVzczogImZpbGVfY29weSIsCiAgICAgICAgdGFyZ2V0Qm90OiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90Rm9jdXMsCiAgICAgICAgb25DbGljazogYEAgbGV0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwogICAgICAgICAgICBsZXQgcHJlcHBlZEJvdCA9IEpTT04uc3RyaW5naWZ5KHNlbGVjdGVkQm90KTsKICAgICAgICAgICAgbGV0IHN0YXRlID0ge30KCiAgICAgICAgICAgIHN0YXRlW2FiSW5zdE1lbW9yeS50YWdzLmFiRm9jdXNEYXRhXSA9IHNlbGVjdGVkQm90OwoKICAgICAgICAgICAgbGV0IG5ld0ZpbGUgPSB7fQogICAgICAgICAgICBuZXdGaWxlLnZlcnNpb24gPSAxOwogICAgICAgICAgICBuZXdGaWxlLnN0YXRlID0gc3RhdGU7CgogICAgICAgICAgICB2YXIgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KG5ld0ZpbGUpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZm9ybWF0dGVkRmlsZSk7CgogICAgICAgICAgICBvcy50b2FzdCgiYm90IGNvcGllZCB0byBjbGlwYm9hcmQiKTsKCiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIGAsCiAgICB9KTsKfQplbHNlIAp7CiAgICAvLyBDcmVhdGUgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEwLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsgICAgICAgICAgICAKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogInNjYW4gdG8gcHVibGlzaCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJxcl9jb2RlX3NjYW5uZXIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gdHJ1ZTsgb3Mub3BlblFSQ29kZVNjYW5uZXIoKTtgLAogICAgfSk7Cn0KCmxldCBob3N0QnV0dG9uID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51U29ydE9yZGVyOiA1MCwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGZvcm1BZGRyZXNzOiAiZ3JvdXBfYWRkIiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5sZWFybi5hYkNyZWF0ZUhvc3QodGhpc0JvdCk7CiAgICBpZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKQogICAgewogICAgICAgIHRhZ3MubGFiZWwgPSAnZ2VuZXJhdGluZyBjb2RlIG5vdyc7CiAgICB9YCwKfTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiam9pbiBjb2RlOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDAsIDMpICsgIi0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDMpOwp9CmVsc2UgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiZ2VuZXJhdGUgam9pbiBjb2RlIjsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnN0YXRpY0luc3QgPT0gdW5kZWZpbmVkKQp7CiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihob3N0QnV0dG9uKTsvL2dlbmVyYXRlIGEgaG9zdCBidXR0b24KfScAmKzluAiZ7wEOYWJDb3JlTWVudUljb24CBACYrOW4COuRAwlpb3Nfc2hhcmUnAJis5bgIme8BD2FiQ29yZU1lbnVMYWJlbAIEAJis5bgI9ZEDBXNoYXJlJwCYrOW4CJnvARNhYkNvcmVNZW51U29ydE9yZGVyAgQAmKzluAj7kQMBMycAmKzluAiZ7wEIcmVtZW1iZXICBACYrOW4CP2RAyjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCYrOW4CJnvAQthYlB1Ymxpc2hBQgIEAJis5bgIpJIDmTRALy9zaG91dCgiYWJQdWJsaXNoQUIiLCB7YWI6ICIiLCBrZXk6ICIiLCB0YXJnZXQ6ICIifSk7CmlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgb3MudG9hc3QoInBhdHRlcm4gbmFtZXMgbWF5IG5vdCBjb250YWluIHNwYWNlcyBvciBxdW90YWlvbiBtYXJrcywgcGxlYXNlIHRyeSBhZ2Fpbi4iKTsKCiAgICByZXR1cm47Cn0KCmFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogcHVibGlzaGluZyAiICsgdGhhdC5hYik7CgpsZXQgcHJvZ3Jlc3NCdXR0b247CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKLy9jbGVhciBhYiBidWlsZGVyCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCi8vcHJvZ3Jlc3MgYmFyIGZvciBtYW51YWwgcHVibGlzaGluZyBjb25maXJtYXRpb24KaWYgKGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2gpIHsKICAgIHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgdXBsb2FkaW5nICR7dGhhdC5hYn1gKTsKfQoKLy9hYiB2YXJpYWJsZXMKbGV0IGFiSUQgPSB0aGF0LmFiOwpsZXQga2V5ID0gdGhhdC5rZXk7CmxldCB0YXJnZXQgPSB0aGF0LnRhcmdldCA/IHRoYXQudGFyZ2V0IDogdGhhdC5ib3Q7CmxldCByZXR1cm5UeXBlID0gdGhhdC5yZXR1cm5UeXBlOwpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpsZXQgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CgovL3RoaXMgbG9naWMgZm9ybWF0cyB0aGUgc3BlY2lmaWVkIGJvdHMgYW5kIHBhY2thZ2VzIHRoZW0gZm9yIHB1Ymxpc2hpbmcKaWYgKCFBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgdGFyZ2V0ICE9IG51bGwgJiYgdGFyZ2V0ICE9IHVuZGVmaW5lZCkgewoKfQplbHNlIGlmICghdGFyZ2V0IHx8IHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICBjb25zdCBiYXNlQUIgPSB0aGF0LmJhc2VBQiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKCiAgICBpZiAoY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkICYmIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIpIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGJ5TW9kKHsgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbCwgYWJJRE9yaWdpbjogYWJJRCB9KSk7CgogICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy5zZWxlY3RlZEFCICYmIGdldEJvdCgiYWJJRE9yaWdpbiIsIGJhc2VBQikpIHsKICAgICAgICBjb25zdCBlZ2dCb3RzID0gZ2V0Qm90cyhieU1vZCh7IHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGwsIGFiSURPcmlnaW46IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgfSkpOwogICAgICAgIGNvbnN0IG5ld0JvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbCwgYWJJRE9yaWdpbjogbnVsbCB9KSk7CgogICAgICAgIHRhcmdldCA9IFsuLi5lZ2dCb3RzLCAuLi5uZXdCb3RzXTsKICAgIH0KICAgIGVsc2UgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYnlNb2QoeyBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsIH0pKTsKICAgIH0KCiAgICBzZXRUYWcodGFyZ2V0LCAiYWJJRE9yaWdpbiIsIGFiSUQpOwoKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgPSBudWxsOwoKICAgIGlmICh0YXJnZXQubGVuZ3RoIDwgMSkgewogICAgICAgIG9zLnRvYXN0KCJObyBib3RzIGZvdW5kIHRvIHB1Ymxpc2giKTsKCiAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgZ2VuZXJhdGluZyBhIGtleSBmb3IgZW5jcnlwdGlvbiAob3B0aW9uYWwpCmlmIChjb25maWdCb3QudGFncy5lbmNyeXB0aW9uKSB7CiAgICBsZXQga2V5Q2hlY2s7CgogICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CgogICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgdGl0bGU6ICdlbnRlciBhIHNlY3JldCBrZXknCiAgICB9KTsKCiAgICBpZiAoa2V5KSB7CiAgICAgICAga2V5Q2hlY2sgPSBhd2FpdCBvcy5zaG93SW5wdXQoIiIsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnY29uZmlybSBzZWNyZXQga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGlmIChrZXkgIT0ga2V5Q2hlY2spIHsKICAgICAgICBpZiAoIWtleUNoZWNrKSB7CiAgICAgICAgICAgIG9zLnRvYXN0KCJubyBrZXkgZW50ZXJlZCIpOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgb3MudG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGN1cnJlbnRCb3RJRCA9IHRhcmdldFtpXS5pZDsKICAgICAgICBsZXQgY3VycmVudEJvdCA9IHRhcmdldFtpXTsKCiAgICAgICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3Q7CiAgICB9Cn0KZWxzZSB7CiAgICBzdGF0ZVt0YXJnZXQuaWRdID0gdGFyZ2V0Owp9CgovL2NoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhbmQgcmV0dXJucyBkYXRhIGZvciBwcmV2aW91c2x5IHB1Ymxpc2hlZCBhYidzCmxldCBlZ2dDaGVjayA9IGF3YWl0IHRoaXNCb3QuYWJQcmV2aW91c0VnZ0NoZWNrKHsgYWJJRDogYWJJRCB9KTsKCi8vYWRkIHhwIGJvdCBoZXJlCmNvbnN0IHhwVmVyc2lvbkJvdCA9IHt9OwoKeHBWZXJzaW9uQm90LnNwYWNlID0gInNoYXJlZCI7CnhwVmVyc2lvbkJvdC5pZCA9ICJhYlhQQm90IjsKeHBWZXJzaW9uQm90LnRhZ3MgPSB7fTsKeHBWZXJzaW9uQm90LnRhZ3MuZm9ybSA9ICJub3RoaW5nIjsKeHBWZXJzaW9uQm90LnRhZ3Muc3lzdGVtID0gImFiLnBhdHRlcm4uYWJYUEJvdCI7CnhwVmVyc2lvbkJvdC50YWdzLmF1dGhvcklEID0gYXV0aEJvdC5pZDsKeHBWZXJzaW9uQm90LnRhZ3MudmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbjsKeHBWZXJzaW9uQm90LnRhZ3MueHAgPSBsaW5rcy5sZWFybi50YWdzLmFiWFA7CnhwVmVyc2lvbkJvdC50YWdzLnNpZ25hdHVyZSA9IGVnZ0NoZWNrLnNpZ25hdHVyZTsKeHBWZXJzaW9uQm90LnRhZ3MuYWJJZ25vcmUgPSB0cnVlOwoKc3RhdGUuYWJYUEJvdCA9IHhwVmVyc2lvbkJvdDsKCi8vYWRkaXRpb25hbCBmaWxlIGRhdGEKZm9ybWF0dGVkRmlsZS52ZXJzaW9uID0gMTsKZm9ybWF0dGVkRmlsZS5zaWduYXR1cmUgPSBlZ2dDaGVjay5zaWduYXR1cmU7CmZvcm1hdHRlZEZpbGUuc3RhdGUgPSBzdGF0ZTsKCi8vYWN0dWFsIGVuY3J5cHRpb24gaWYgY2hvc2VuCmlmIChrZXkpIHsKICAgIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRGaWxlKTsKCiAgICBmb3JtYXR0ZWRGaWxlID0gY3J5cHRvLmVuY3J5cHQoa2V5LCBmb3JtYXR0ZWRGaWxlKTsKfQoKLy9wdWJsaXNoIHRoZSBmaWxlCmxldCBwdWJsaXNoRmlsZSA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoRmlsZSh7IGZpbGU6IGZvcm1hdHRlZEZpbGUsIGZpbGVOYW1lOiBhYklEIH0pOwoKLy9nYXRoZXIgYWRkaW9uYWwgZWdnIGRhdGEKY29uc3QgYWlQZXJtaXRDaGVjayA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdC5pZCwgImFpX3Blcm1pdCIpOwpjb25zdCBhaVBlcm1pdElEID0gYWlQZXJtaXRDaGVjay5zdWNjZXNzID8gYWlQZXJtaXRDaGVjay5kYXRhLnBlcm1pdElEIDogZmFsc2U7CgplZ2dDaGVjay5lZ2dEYXRhLmFpUGVybWl0ID0gYWlQZXJtaXRJRDsKZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5wdXNoKHB1Ymxpc2hGaWxlLnVybCk7CmVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwplZ2dDaGVjay5lZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKCi8vcHVibGlzaCBlZ2cvYWIgcmVjb3JkCmxldCBwdWJsaXNoUmVjb3JkID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hSZWNvcmQoeyBkYXRhOiBlZ2dDaGVjay5lZ2dEYXRhLCByZWNvcmROYW1lOiBhYklELCBwdWJsaWNGYWNpbmc6IHB1YmxpY0ZhY2luZyB9KTsKbGV0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwoKLy9wdWJsaXNoaW5nIHNob3V0CnN1cGVyU2hvdXQoIm9uQUJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOwpzdXBlclNob3V0KCJvbkFiUHVibGlzaGVkIiwgeyBzdWNjZXNzOiBwdWJsaXNoRmlsZS5zdWNjZXNzLCBhYjogYWJJRCwgZmlsZUFkZHJlc3M6IHB1Ymxpc2hGaWxlLnVybCB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgpjb25zdCBzdHVkaW9MaW5rID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCi8vc2VuZCBkYXRhIGFuZCBmb3JtYXQgdXJsIGlmIGRhdGEgc3VjY2Vzc2Z1bGx5IHNlbnQKaWYgKHB1Ymxpc2hSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3QgYmlvcyA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CiAgICBjb25zdCBpbnN0VHlwZSA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CgogICAgc2V0VGFnTWFzayhsaW5rcy5sZWFybiwgImFiWFAiLCAiMCIsICJsb2NhbCIpOwoKICAgIGlmIChjb25maWdCb3QudGFncy5tYW51YWxQdWJsaXNoKSB7CiAgICAgICAgY29uc3QgdXJsID0gc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJnN0dWRpbz0iICsgc3R1ZGlvTGluayArICImYmlvcz0iICsgYmlvczsKICAgICAgICBvcy5zZXRDbGlwYm9hcmQodXJsKTsKCiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICBvcy50b2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgd2l0aCBlbmNyeXB0ZWQgZGF0YSBjb3BpZWQgdG8gY2xpcGJvYXJkYCwgNSk7CiAgICAgICAgICAgIGFiLmxvZyhgJHtsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5fTogJHtpbnN0VHlwZX0gaW5zdCB1cmwgd2l0aCBlbmNyeXB0ZWQgZGF0YSBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7bGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX06ICR7aW5zdFR5cGV9IGluc3QgdXJsIHdpdGggZW5jcnlwdGVkIGRhdGEgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3MudG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmRgLCA1KTsKICAgICAgICAgICAgYWIubG9nKGAke2xpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHl9OiAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICAgICAgY29uc29sZS5sb2coYCR7bGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX06ICR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7dXJsfWApOwogICAgICAgIH0KICAgIH0KCiAgICB0cnkgewogICAgICAgIGF3YWl0IGFuYWx5dGljcy5yZWNvcmRFdmVudCgnYWJfZWdnX3B1Ymxpc2gnLCB7IGFiOiBhYklELCB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCB9KTsKICAgIH0KICAgIGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICB9Cn0KZWxzZSB7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkgewogICAgICAgIG9zLnRvYXN0KCJwdWJsaXNoaW5nIGZhaWxlZCwgcGxlYXNlIHRyeSBhZ2FpbiIpOwogICAgfQoKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogcHVibGlzaGluZyBmYWlsZWQiKTsKCiAgICBjb25zb2xlLmxvZyhwdWJsaXNoUmVjb3JkKTsKfQoKLy9jbGVhciBwcm9ncmVzcyBiYXIKaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCA9IG51bGw7CgpyZXR1cm4gcHVibGlzaFJlY29yZDsnAJis5bgIme8BCGFiSWdub3JlAgQAmKzluAi+xgMEdHJ1ZScAmKzluAiZ7wEKYWJEb3dubG9hZAIEAJis5bgIw8YD0AZALy9kb3dubG9hZCBib3RzIChlaXRoZXIgc2VsZWN0ZWQgb3IgYWxsIGV4cGVyaWVuY2UpCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zb2xlLmxvZygiZG93bmxvYWQiLCB0aGF0KTsKCmlmIChBcnJheS5pc0FycmF5KHRoYXQucG9zc2libGVCb3RzKSkKewogICAgaWYgKHRoYXQucG9zc2libGVCb3RzLmxlbmd0aCA+IDApCiAgICB7CiAgICAgICAgZG93bmxvYWRCb3RzID0gdGhhdC5wb3NzaWJsZUJvdHM7CgogICAgICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZG93bmxvYWRpbmcgYm90cyIpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGRvd25sb2FkQm90cyA9IGdldEJvdHMoYnlNb2QoeyJhYklnbm9yZSI6IG51bGwsICJzcGFjZSI6ICJzaGFyZWQifSkpOwoKICAgICAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRvd25sb2FkaW5nIGluc3QiKTsKICAgIH0gICAgCn0KZWxzZQp7CgoKICAgIGRvd25sb2FkQm90cyA9IFt0aGF0LnBvc3NpYmxlQm90c107CgogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkb3dubG9hZGluZyBib3QiKTsKfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpCnsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9CgpsZXQgY3VycmVudEluc3QgPSBvcy5nZXRDdXJyZW50SW5zdCgpOwoKb3MuZG93bmxvYWRCb3RzKGRvd25sb2FkQm90cywgY3VycmVudEluc3QpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOycAmKzluAiZ7wENbWFuaWZlc3RhdGlvbgIEAJis5bgIlM0DKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJis5bgIme8BBG1lbnUCBACYrOW4CLvNAyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCYrOW4CJnvARJhYlByZXZpb3VzRWdnQ2hlY2sCBACYrOW4COLNA7EPQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGVnZ0hpc3Rvcnk7CmxldCBlZ2dJRDsKbGV0IHRhcmdldFZlcnNpb25OdW07CmxldCBsYXN0SGFzaDsKbGV0IG1heFZlcnNpb25OdW07CmxldCBzdGFibGVWZXJzaW9uOwpsZXQgZmVlZGJhY2tWZXJzaW9uOwpsZXQgcHJldmlvdXNYUDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKbGV0IHJlY29yZExvb2t1cCA9IGF3YWl0IG9zLmdldERhdGEodXNlclJlY29yZCwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycAmKzluAiZ7wEPYWJCb3RNZW51QWN0aW9uAgQAmKzluAiU3QNNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAJis5bgIme8BDmFiQm90TWVudUxhYmVsAgQAmKzluAji3QMFc2hhcmUnAJis5bgIme8BDWFiQm90TWVudUljb24CBACYrOW4COjdAwlpb3Nfc2hhcmUnAJis5bgIme8BEmFiQm90TWVudVNvcnRPcmRlcgIEAJis5bgI8t0DAzMuNScAmKzluAiZ7wEFbGVhcm4CBACYrOW4CPbdAyjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCYrOW4CJnvAQthYlFSUHVibGlzaAIEAJis5bgInd4DxgFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0fSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAJis5bgIme8BBnNlYXJjaAIEAJis5bgI5N8DKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAJis5bgIme8BB2FiU2hlbGwCBACYrOW4CIvgAwR0cnVlJwCYrOW4CJnvAQxzdHVkaW9TZWxlY3QCBACYrOW4CJDgA4sLQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwCYrOW4CJnvAQ5hYlB1Ymxpc2hBc2tJRAIEAJis5bgImusD9ARAbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgcHVibGlzaGluZyAke3RoYXQuYXNrSUR9YCk7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKY29uc3QgcGF0dGVybklEID0gdGhhdC5wYXR0ZXJuSUQ7CmNvbnN0IHN0dWRpb0lEID0gdGhhdC5zdHVkaW9JRCA/IHRoYXQuc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogYXV0aEJvdC5pZDsKY29uc3QgYXNrSUQgPSAiYXNrXyIgKyB0aGF0LmFza0lELnJlcGxhY2VBbGwoIi0iLCAiIik7CmNvbnN0IGVuZHBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50Owpjb25zdCBwdWJsaXNoQXNrID0gYXdhaXQgb3MucmVjb3JkRGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwge3BhdHRlcm5JRDogcGF0dGVybklELCBzdHVkaW9JRDogc3R1ZGlvSUR9LCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCB1cGRhdGVQb2xpY3k6IFthdXRoQm90LmlkXX0pOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHB1Ymxpc2hBc2s7JwCYrOW4CJnvAQVpbnB1dAIEAJis5bgIj/ADKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAJis5bgIme8BC2FiRW1iZWRMaW5rAgQAmKzluAi28AOkA0Bjb25zdCBhYiA9IHRoYXQgPyB0cnVlIDogZmFsc2U7CmNvbnN0IGVtYmVkTGluayA9IGFiID8gImFiPSIgKyB0aGF0IDogImluc3Q9IiArIGNvbmZpZ0JvdC50YWdzLmluc3Q7CmNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwpjb25zdCBlbWJlZFRleHQgPSBgPCFET0NUWVBFIGh0bWw+CsKgwqDCoMKgPGh0bWw+CsKgwqDCoMKgwqDCoMKgwqA8aGVhZD48L2hlYWQ+CsKgwqDCoMKgwqDCoMKgwqA8Ym9keT4KwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgPGlmcmFtZSBzcmM9IiR7c2l0ZU9yaWdpbiArICIvPyIgKyBlbWJlZExpbmt9IiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSI0MDAiIC8+CsKgwqDCoMKgwqDCoMKgwqA8L2JvZHk+CsKgwqDCoMKgPC9odG1sPmA7CgpyZXR1cm4gZW1iZWRUZXh0OycAmKzluAiZ7wEPYWJQYXR0ZXJuVXBkYXRlAgQAmKzluAiv8wOFBUAvL3Nob3V0KCJhYlBhdHRlcm5VcGRhdGUiLCB7YWJJRDogYWJJRCwgc3R1ZGlvOnN0dWRpbz8sIGJvdHM6IGJvdHM/fSk7CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgppZiAoIWF1dGhCb3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPyB0aGF0LnN0dWRpbyA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFiTWFuaWZlc3QgPSBnZXRCb3QoYnlNb2Qoe2FiRWdnOiB0cnVlLCBvcmlnaW5fYWI6IGFiSUR9KSk7CgppZiAoIWFiTWFuaWZlc3QpCnsKICAgIHNob3V0KCJvbkxvb2t1cEFCRWdncyIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywgYXV0b0hhdGNoOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm51cGRhdGUnfSk7CgogICAgcmV0dXJuOwp9Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHN0dWRpbzsKCmNvbnN0IGFiQm90cyA9IHRoYXQuYm90cyA/PyBnZXRCb3RzKCJhYklET3JpZ2luIiwgYWJJRCk7Cgphd2FpdCB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogYWJJRCwgdGFyZ2V0OiBhYkJvdHMsIHB1YmxpY0ZhY2luZzogdHJ1ZX0pOycAmKzluAiZ7wEXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBACYrOW4CLX4A01AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAmKzluAiZ7wEaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBACYrOW4CIP5AwEyJwCYrOW4CJnvARVhYk11bHRpcGxlQm90TWVudUljb24CBACYrOW4CIX5Awlpb3Nfc2hhcmUnAJis5bgIme8BFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBACYrOW4CI/5AwVzaGFyZScAmKzluAiZ7wEPYWJQdWJsaXNoU2VsZWN0AgQAmKzluAiV+QOJE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiB0YWdzLmxhYmVsLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwpjb25zdCBub25QYXR0ZXJuQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IG51bGwsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwCYrOW4CJnvAQlhYlZlcnNpb24CBACYrOW4CJ2MBAQxMC41JwCYrOW4CJnvAQtwZXJzb25hbGl0eQIEAJis5bgIoowEKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNwEnAJis5bgIyYwEBnN5c3RlbQIEAJis5bgIyowEEWFiLnNoZWxsLmFydGlmYWN0JwCYrOW4CMmMBAhhYklnbm9yZQIEAJis5bgI3IwEBHRydWUnAJis5bgIyYwECWFiVmVyc2lvbgIEAJis5bgI4YwEBDEwLjUnAJis5bgIyYwEBWRlYnVnAgQAmKzluAjmjAQEdHJ1ZScAmKzluAjJjAQIcmVtZW1iZXICBACYrOW4COuMBCjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCYrOW4CMmMBBNhYkNyZWF0ZUFydGlmYWN0Qm90AgQAmKzluAiSjQTQCkBjb25zdCB7IAogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBkaW1lbnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiSW5zdCA/PyAnaG9tZScsCiAgICBwb3NpdGlvbiA9IG5ldyBWZWN0b3IzKDAsIDAsIDApCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0Qm90ID0gY3JlYXRlKHsKICAgIHNwYWNlOiAnc2hhcmVkJywKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEJvdDogdHJ1ZSwKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2Ake2RpbWVuc2lvbn1YYF06IHBvc2l0aW9uLngsCiAgICBbYCR7ZGltZW5zaW9ufVlgXTogcG9zaXRpb24ueSwKICAgIFtgJHtkaW1lbnNpb259WmBdOiBwb3NpdGlvbi56LAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIGxhYmVsQ29sb3I6IGFiQXJ0aWZhY3RMYWJlbENvbG9yLAogICAgc3Ryb2tlQ29sb3I6IGFiQXJ0aWZhY3RMYWJlbENvbG9yLAogICAgbGFiZWw6IGBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX1gLAogICAgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlOiBgQAogICAgICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnbGFiZWwnLCAnICcsICdzaGFyZWQnKTsKICAgIGAKfSk7CgovLyBVcGRhdGUgYWxsIHRoZSBzaGFyZHMgZm9yIHRoaXMgYXJ0aWZhY3QgLS0gd2hpY2ggbm93IGluY2x1ZGVzIHRoaXMgYm90IQphd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSB9KTsKCmNvbnN0IGhhc2ggPSBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZS5jb250ZW50U0hBMjU2LnN1YnN0cmluZygwLCA3KTsKYWJBcnRpZmFjdEJvdC50YWdzLnN5c3RlbSA9IGBhYkFydGlmYWN0LiR7YWJBcnRpZmFjdE5hbWV9LSR7aGFzaH1gCgpyZXR1cm4gYWJBcnRpZmFjdEJvdDsnAJis5bgIyYwEFmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGUCBACYrOW4COOXBKkIQGludGVyZmFjZSBBQkFydGlmYWN0UmVjb25zaXR1dGVBcmcgewogICAgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZTsKICAgIHRvYXN0PzogYm9vbGVhbjsKfQoKaWYgKCFjb25maWdCb3QudGFncy5yZWNvbnN0aXR1dGlvbikgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKYXNzZXJ0KHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmcgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuYCk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9Cgpjb25zdCB7IAogICAgYWJBcnRpZmFjdEJ1bmRsZQp9ID0gdGhhdCBhcyBBQkFydGlmYWN0UmVjb25zaXR1dGVBcmc7Cgphc3NlcnQoYWJBcnRpZmFjdEJ1bmRsZSAmJiBhYkFydGlmYWN0QnVuZGxlLmRhdGEgJiYgYWJBcnRpZmFjdEJ1bmRsZS5kZXBlbmRlbmNpZXMsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJ1bmRsZSBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdEJ1bmRsZS5gKTsKCmNvbnN0IGZvcm1hdFZlcnNpb24gPSBhYkFydGlmYWN0QnVuZGxlLmZvcm1hdFZlcnNpb247CgppZiAoZm9ybWF0VmVyc2lvbiA9PSBudWxsKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYGZvcm1hdFZlcnNpb24gJHtmb3JtYXRWZXJzaW9ufSBpcyBub3QgdmFsaWQuYCk7Cn0KCmNvbnN0IGZ1bmNUYWdOYW1lID0gYGFiQXJ0aWZhY3RSZWNvbnN0aXR1dGVfdiR7Zm9ybWF0VmVyc2lvbn1gOwoKaWYgKHR5cGVvZiB0aGlzQm90W2Z1bmNUYWdOYW1lXSAhPT0gJ2Z1bmN0aW9uJykgewogICAgdGhyb3cgbmV3IEVycm9yKGAke2Z1bmNUYWdOYW1lfSBpcyBub3QgYSBmdW5jdGlvbi5gKQp9CgovLyBDYWxsIHRoZSB2ZXJzaW9uZWQgcmVjb25zdGl0dXRlIGZ1bmN0aW9uLgpyZXR1cm4gYXdhaXQgdGhpc0JvdFtmdW5jVGFnTmFtZV0odGhhdCk7JwCYrOW4CMmMBBdhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbgIEAJis5bgIjaAEATEnAJis5bgIyYwEBnNlYXJjaAIEAJis5bgIj6AEKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAJis5bgIyYwEB2FiU2hlbGwCBACYrOW4CLagBAR0cnVlJwCYrOW4CMmMBAV1dGlscwIEAJis5bgIu6AEKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAJis5bgIyYwEGWFiQXJ0aWZhY3RSZWNvbnN0aXR1dGVfdjECBACYrOW4COKgBOcZQGFzc2VydCh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJnIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLmApOwoKaWYgKCFjb25maWdCb3QudGFncy5yZWNvbnN0aXR1dGlvbikgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICB0b2FzdCA9IHRydWUsCn0gPSB0aGF0IGFzIEFCQXJ0aWZhY3RSZWNvbnNpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBBQkFydGlmYWN0QnVuZGxlLmApOwoKLy8gR2VuZXJhdGUgYXJ0aWZhY3QgaW5zdGFuY2UgaWQgZm9yIHRoaXMgYXJ0aWZhY3QgdGhhdCBpcyBiZWluZyByZWNvbnN0aXR1dGVkLgpjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZVN0cmluZyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwoKY29uc3Qgc2hhcmRCb3RzID0gW107Cgpmb3IgKGNvbnN0IGRlcGVuZGVuY3kgb2YgYWJBcnRpZmFjdEJ1bmRsZS5kZXBlbmRlbmNpZXMpIHsKICAgIGNvbnN0IGxvb2t1cEVnZ1Jlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICAgICAgYWJJRDogZGVwZW5kZW5jeS5hYklELAogICAgICAgIHJlY29yZEtleTogZGVwZW5kZW5jeS5yZWNvcmRLZXksCiAgICAgICAgYWJWZXJzaW9uOiBkZXBlbmRlbmN5LmFiVmVyc2lvbiwKICAgICAgICBhdXRvSGF0Y2g6IHRydWUsCiAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgIG9uUHJlcHJvY2Vzc0JvdERhdGE6ICh7IGJvdERhdGEgfSkgPT4gewogICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzaGFyZCBib3QgaGFzIGl0c2VsZiBtYXJrZWQgYXMgcmVjb25zdGl0dXRlZCBhbHJlYWR5IChwb3NzaWJseSBkdWUgdG8gYW4gb3ZlcnNpZ2h0KSwgdGhlbiByZW1vdmUgaXQhCiAgICAgICAgICAgICAgICBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9KQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gJHtkZXBlbmRlbmN5LmFiSUR9IGxvb2t1cEVnZ1Jlc3VsdDpgLCBsb29rdXBFZ2dSZXN1bHQpOwogICAgfQoKICAgIGlmIChsb29rdXBFZ2dSZXN1bHQuc3VjY2VzcykgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgbG9hZGVkIGRlcGVuZGVuY3kgYWJJRDogJHtkZXBlbmRlbmN5LmFiSUR9LCBhYlZlcnNpb246ICR7ZGVwZW5kZW5jeS5hYlZlcnNpb24gPz8gJ2xhdGVzdCd9YCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGNvbnN0IHNoYXJkQm90IG9mIGxvb2t1cEVnZ1Jlc3VsdC5oYXRjaGVkQm90cykgewogICAgICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0aW5nID0gbnVsbDsKICAgICAgICAgICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7IC8vIFRoaXMgYm90IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQgaW4gdGhpcyBpbnN0LgogICAgICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGUgPSBhYkFydGlmYWN0QnVuZGxlU3RyaW5nOyAvLyBBc3NpZ24gdGhlIGFydGlmYWN0IGJ1bmRsZSBiYWNrIHRvIHRoZSBoYXRjaGVkIHNoYXJkIGJvdC4KICAgICAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOyAvLyBVVUlEIG9mIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSB0aGF0IHRoaXMgYm90IGJlbG9uZ3MgdG8uCiAgICAgICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsgLy8gVVVJRCBhc3NpZ25lZCB0byB0aGUgYm90IGJ5IHRoZSBhcnRpZmFjdCB3aGVuIGxvYWRlZC4KICAgICAgICAgICAgc2hhcmRCb3QudGFncy5hYklnbm9yZSA9IHRydWU7IC8vIERvbid0IHB1Ymxpc2ggcmVjb25zdGl0dXRlZCBhcnRpZmFjdHMuCgogICAgICAgICAgICBzaGFyZEJvdHMucHVzaChzaGFyZEJvdCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gZmFpbGVkIHRvIGxvYWQgZGVwZW5kZW5jeSBhYklEOiAke2RlcGVuZGVuY3kuYWJJRH0sIGFiVmVyc2lvbjogJHtkZXBlbmRlbmN5LmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICB9Cn0KCi8vIFRlbGwgYWxsIGhhdGNoZWQgc2hhcmQgYm90cyB0byByZWNvbnN0aXR1dGUuIAovLyBUaGV5IGFsbCBoYXZlIGNvcGllcyBvZiB0aGUgYWJBcnRpZmFjdEJ1bmRsZSBhbmQgY2FuIHJlY29uc3RpdHV0ZSB0aGVtc2VsdmVzIGZyb20gdGhhdC4Kd2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUnKTsKCmlmICh0b2FzdCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfScgKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC5gKQp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2coYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQuYCk7Cn0KJwCYrOW4CMmMBA5vbkFueUJvdHNBZGRlZAIEAJis5bgIyLoEZkBjb25zdCB7IGJvdHMgfSA9IHRoYXQ7Cgpmb3IgKGNvbnN0IGJvdCBvZiBib3RzKSB7CiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAKICAgIH0KfScAmKzluAjJjAQJb25BQkFkZGVkAgQAmKzluAivuwTaEUBpbXBvcnQgeyBCb3QgfSBmcm9tICdjYXN1YWxvcyc7CgppZiAoIWNvbmZpZ0JvdC50YWdzLnJlY29uc3RpdHV0aW9uKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGFiLCB2ZXJzaW9uLCBpbnN0LCBib3RJZHMsIHNvdXJjZUV2ZW50IH0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKaWYgKGluc3QgIT09IG9zLmdldEN1cnJlbnRJbnN0KCkpIHsKICAgIC8vIElnbm9yZSBvbkFCQWRkZWQgc2hvdXRzIGZyb20gb3RoZXIgaW5zdHMuCiAgICByZXR1cm47Cn0KCmlmIChzb3VyY2VFdmVudCA9PT0gJ3JlY29uc3RpdHV0ZScpIHsKICAgIC8vIFdlIGRvIG5vdCB3YW50IHRvIHJlY29uc3RpdHV0ZSBib3RzIHRoYXQgYXJlIGNvbWluZyBmcm9tIGEgcmVjb25zdGl0dXRpb24gcHJvY2Vzcy4KICAgIHJldHVybjsKfQoKLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBhZGRlZCBib3RzIGFyZSBhcnRpZmFjdCBzaGFyZHMgdGhhdCBuZWVkcyB0byBiZSByZWNvbnN0aXR1dGVkLgpjb25zdCB1bmNvbnN0aXR1dGVkU2hhcmRCb3RNYXA6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHt9OyAvLyBUcmFjayBzaGFyZCBib3RzIGJ5IGFiQXJ0aWZhY3ROYW1lLgoKZm9yIChjb25zdCBib3RJZCBvZiBib3RJZHMpIHsKICAgIGNvbnN0IGJvdCA9IGdldEJvdCgnaWQnLCBib3RJZCk7CgogICAgaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiAhYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCAmJiAhYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRpbmcpIHsKICAgICAgICBsZXQgc2hhcmRCb3RzID0gdW5jb25zdGl0dXRlZFNoYXJkQm90TWFwW2JvdC50YWdzLmFiQXJ0aWZhY3ROYW1lXTsKCiAgICAgICAgaWYgKCFzaGFyZEJvdHMpIHsKICAgICAgICAgICAgc2hhcmRCb3RzID0gW107CiAgICAgICAgICAgIHVuY29uc3RpdHV0ZWRTaGFyZEJvdE1hcFtib3QudGFncy5hYkFydGlmYWN0TmFtZV0gPSBzaGFyZEJvdHM7CiAgICAgICAgfQoKICAgICAgICBzaGFyZEJvdHMucHVzaChib3QpOwogICAgfQp9Cgpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVuY29uc3RpdHV0ZWRTaGFyZEJvdE1hcDpgLCB1bmNvbnN0aXR1dGVkU2hhcmRCb3RNYXApOwoKY29uc3QgYWJBcnRpZmFjdE5hbWVzID0gT2JqZWN0LmtleXModW5jb25zdGl0dXRlZFNoYXJkQm90TWFwKTsKCmlmIChhYkFydGlmYWN0TmFtZXMubGVuZ3RoID09PSAwKSB7CiAgICAvLyBObyBzaGFyZHMgZGV0ZWN0ZWQuCiAgICByZXR1cm47Cn0KCmZvciAoY29uc3QgYWJBcnRpZmFjdE5hbWUgb2YgYWJBcnRpZmFjdE5hbWVzKSB7CiAgICBjb25zdCBzaGFyZEJvdHMgPSB1bmNvbnN0aXR1dGVkU2hhcmRCb3RNYXBbYWJBcnRpZmFjdE5hbWVdOwoKICAgIC8vIEdyYWIgdGhlIGFydGlmYWN0IGJ1bmRsZSBmcm9tIG9uZSBvZiB0aGUgc2hhcmRzIGF2YWlsYWJsZSBmb3IgdGhpcyBhcnRpZmFjdC4KICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBzaGFyZEJvdHNbMF0udGFncy5hYkFydGlmYWN0QnVuZGxlIAogICAgCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3QgYnVuZGxlIGZvciAnJHthYkFydGlmYWN0TmFtZX0nOmAsIGFiQXJ0aWZhY3RCdW5kbGUpOwogICAgfQoKICAgIC8vIERlc3Ryb3kgYWxsIHNoYXJkcyB0aGF0IHdlcmUganVzdCBhZGRlZCBmb3IgdGhpcyBhcnRpZmFjdC4gV2UgYXJlIGFib3V0IHRvIHJlY29uc3RpdHV0ZSwKICAgIC8vIGFuZCBubyBsb25nZXIgbmVlZCB0aGVzZSBvbGQgc2hhcmRzLgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlc3Ryb3lpbmcgJHtzaGFyZEJvdHMubGVuZ3RofSBvbGQgc2hhcmQgYm90cyBmcm9tICR7YWJBcnRpZmFjdE5hbWV9LmApOwogICAgfQogICAgZGVzdHJveShzaGFyZEJvdHMpOwoKICAgIC8vIFJlY29uc3RpdHV0ZSB1c2luZyB0aGUgYWJBcnRpZmFjdEJ1bmRsZS4KICAgIHRoaXNCb3QuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZSh7IGFiQXJ0aWZhY3RCdW5kbGUgfSk7Cn0nAJis5bgIyYwED29uQW55Qm90Q2xpY2tlZAIEAJis5bgIis0EeEBjb25zdCB7IGJvdCB9ID0gdGhhdDsKCmlmIChib3QgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEJvdCkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBib3QgfSkKfScAmKzluAjJjAQWYWJVcGRhdGVBcnRpZmFjdFNoYXJkcwIEAJis5bgIg84E0gVAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gPSB0YWdzLmFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uIC8vIERlZmF1bHQgdG8gdGhlIGN1cnJlbnQgZm9ybWF0IHZlcnNpb24uCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7Cgpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dYCwgeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gfSk7CgppZiAoYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gPT0gbnVsbCkgewogICAgdGhyb3cgbmV3IEVycm9yKGBhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiAke2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9ufSBpcyBub3QgdmFsaWQuYCk7Cn0KCmNvbnN0IGZ1bmNUYWdOYW1lID0gYGFiVXBkYXRlQXJ0aWZhY3RTaGFyZHNfdiR7YWJBcnRpZmFjdEZvcm1hdFZlcnNpb259YDsKCmlmICh0eXBlb2YgdGhpc0JvdFtmdW5jVGFnTmFtZV0gIT09ICdmdW5jdGlvbicpIHsKICAgIHRocm93IG5ldyBFcnJvcihgJHtmdW5jVGFnTmFtZX0gaXMgbm90IGEgZnVuY3Rpb24uYCkKfQoKLy8gQ2FsbCB0aGUgdmVyc2lvbmVkIGNyZWF0ZSBmdW5jdGlvbi4KcmV0dXJuIHRoaXNCb3RbZnVuY1RhZ05hbWVdKHRoYXQpOycAmKzluAjJjAQZYWJVcGRhdGVBcnRpZmFjdFNoYXJkc192MQIEAJis5bgI1tMEnTBAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3ROYW1lLAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3REZXBlbmRlbmN5IHsKICAgIGFiSUQ6IHN0cmluZzsKICAgIHJlY29yZEtleTogc3RyaW5nOwogICAgYWJWZXJzaW9uPzogbnVtYmVyOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEJ1bmRsZSB7CiAgICBuYW1lOiBzdHJpbmc7CiAgICBmb3JtYXRWZXJzaW9uOiBudW1iZXI7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+OwogICAgZGVwZW5kZW5jaWVzOiBBcnJheTxBQkFydGlmYWN0RGVwZW5kZW5jeT47CiAgICBjb250ZW50U0hBMjU2OiBzdHJpbmc7CiAgICBjYXN1YWxPU1ZlcnNpb246IEF1eFZlcnNpb247CiAgICBjcmVhdGVkVGltZXN0YW1wOiBzdHJpbmc7CiAgICBhYlNoZWxsVmVyc2lvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdFNoYXJkIHsKICAgIGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT47CiAgICBkZXBlbmRlbmNpZXM6IEFycmF5PEFCQXJ0aWZhY3REZXBlbmRlbmN5PjsKfQoKY29uc3QgQVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHID0gJ29uQUJBcnRpZmFjdENvbGxlY3RTaGFyZHMnOwoKZnVuY3Rpb24gaXNPYmplY3Qob2JqOiBhbnkpOiBib29sZWFuIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShvYmopOwp9CgpmdW5jdGlvbiBpc0FycmF5KG9iajogYW55KTogYm9vbGVhbiB7CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheShvYmopOwp9CgpmdW5jdGlvbiBpc1N0cmluZyhvYmo6IGFueSk6IGJvb2xlYW4gewogICAgcmV0dXJuIHR5cGVvZiBvYmogPT09ICdzdHJpbmcnOwp9Cgpjb25zdCBzaGFyZEJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICByZXR1cm4gYi50YWdzLmFiQXJ0aWZhY3ROYW1lID09PSBhYkFydGlmYWN0TmFtZQp9KTsKCmlmIChzaGFyZEJvdHMubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFRoZXJlIGFyZSBubyBzaGFyZHMgZm9yIGFydGlmYWN0IG5hbWUgJyR7YWJBcnRpZmFjdE5hbWV9Jy5gLCBsb2dUeXBlOiAnd2FybicgfSk7CiAgICByZXR1cm47Cn0KCi8qKiBBbiBhcnRpZmFjdCBidW5kbGUgaXMgdGhlIGNvbWJpbmF0aW9uIG9mIHNoYXJkIGRhdGEgYW5kIHNoYXJkIGRlcGVuZGVuY2llcy4gKi8KY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHsKICAgIG5hbWU6IGFiQXJ0aWZhY3ROYW1lLAogICAgZm9ybWF0VmVyc2lvbjogMSwKICAgIGRhdGE6IHt9LAogICAgZGVwZW5kZW5jaWVzOiBbXSwKfQoKLyoqIEtlZXAgdHJhY2sgb2YgZGVwZW5kZW5jeSBoYXNoZXMuIFRoaXMgcHJldmVudHMgZHVwbGljYXRlcyBpbiB0aGUgYXJ0aWZhY3QgZGVwZW5kZW5jaWVzLiAqLwpjb25zdCBkZXBlbmRlbmN5SGFzaGVzID0gbmV3IFNldCgpOyAKCmZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICBjb25zdCBib3RTaG9ydElkID0gc2hhcmRCb3QuaWQuc3Vic3RyaW5nKDAsIDUpOwoKICAgIGxldCBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwogICAgaWYgKHNoYXJkQm90LnRhZ3NbQVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHXSkgewogICAgICAgIGlmIChzaGFyZEJvdFtBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUddKSB7CiAgICAgICAgICAgIHNoYXJkID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKHNoYXJkQm90W0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR10oKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgJHtBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUd9IHRhZyBpcyBkZWZpbmVkIGJ1dCBpcyBub3QgYSB2YWxpZCBmdW5jdGlvbi5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgc2hhcmQ6YCwgc2hhcmQpOwogICAgfQoKICAgIGlmIChzaGFyZCkgewogICAgICAgIGlmICghaXNPYmplY3Qoc2hhcmQpKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR30gc2hhcmQgbXVzdCBiZSBhbiBvYmplY3QuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHNoYXJkLmRhdGEpIHsKICAgICAgICAgICAgaWYgKCFpc09iamVjdChzaGFyZC5kYXRhKSkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7QVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHfSBzaGFyZCAnZGF0YScgcHJvcGVydHkgbXVzdCBiZSBhbiBvYmplY3QuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2hhbGxvdyBtZXJnZSBzaGFyZCdzIGRhdGEgcHJvcGVydGllcyBpbnRvIGNvbWJpbmVkIGFydGlmYWN0IGRhdGEuCiAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSA9IHsgLi4uYWJBcnRpZmFjdEJ1bmRsZS5kYXRhLCAuLi5zaGFyZC5kYXRhIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgIGlmICghaXNBcnJheShzaGFyZC5kZXBlbmRlbmNpZXMpKSB7CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBAJHtBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUd9IHNoYXJkICdkZXBlbmRlbmNpZXMnIHByb3BlcnR5IG11c3QgYmUgYW4gYXJyYXkuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgZGVwZW5kZW5jeSBmb3JtYXQuCiAgICAgICAgICAgICAgICBpZiAoIWlzU3RyaW5nKGRlcGVuZGVuY3kucmVjb3JkS2V5KSkgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIGRlcGVuZGVuY3kgZW50cmllcyBtdXN0IGNvbnRhaW4gYSAncmVjb3JkS2V5JyBzdHJpbmcgcHJvcGVydHkuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFpc1N0cmluZyhkZXBlbmRlbmN5LmFiSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgZGVwZW5kZW5jeSBlbnRyaWVzIG11c3QgY29udGFpbiBhICdhYklEJyBzdHJpbmcgcHJvcGVydHkuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoaXMgZGVwZW5kZW5jeSBpc250IGFscmVhZHkgY29sbGVjdGVkLgogICAgICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIGRlcGVuZGVuY3kpOwoKICAgICAgICAgICAgICAgIGlmICghZGVwZW5kZW5jeUhhc2hlcy5oYXMoaGFzaCkpIHsKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmN5SGFzaGVzLmFkZChoYXNoKTsKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBNYWtlIHN1cmUgd2UgaGF2ZSBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeS4KaWYgKGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIG11c3QgbGlzdCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeSBpbiBvcmRlciB0byByZWNvbnN0aXR1dGUgcHJvcGVybHkuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIHJldHVybjsKfQoKLy8gU3RvcmUgc29tZSBleHRyYSBtZXRhZGF0YSBwcm9wZXJ0aWVzIHdpdGggdGhlIGFydGlmYWN0LgovLyBUaGVzZSBhcmUgbm90IGNvcmUgdG8gdGhlIGFydGlmYWN0J3MgZnVuY3Rpb25hbGl0eSBidXQgbWF5IGJlIHVzZWZ1bCBhcyBhcnRpZmFjdHMgZXZvbHZlLgphYkFydGlmYWN0QnVuZGxlLmNvbnRlbnRTSEEyNTYgPSBjcnlwdG8uc2hhMjU2KGFiQXJ0aWZhY3RCdW5kbGUpOyAvLyBDcmVhdGUgYW5kIHN0b3JlIGEgaGFzaCBvZiBhcnRpZmFjdCdzIGNvbnRlbnQuCmFiQXJ0aWZhY3RCdW5kbGUuY2FzdWFsT1NWZXJzaW9uID0gb3MudmVyc2lvbigpOwphYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXAgPSBEYXRlVGltZS5ub3coKS50b0lTTygpOwphYkFydGlmYWN0QnVuZGxlLmFiU2hlbGxWZXJzaW9uID0gYCR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1ham9yVmVyc2lvbn0uJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWlub3JWZXJzaW9ufWA7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5hbCBtZXJnZWQgYXJ0aWZhY3QgJHthYkFydGlmYWN0TmFtZX06YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIEV2ZXJ5IHNoYXJkIGJvdCBnZXRzIGEgY29weSBvZiB0aGUgYXJ0aWZhY3QgYnVuZGxlLgovLyBUaGlzIG1ha2VzIHRoZSBhcnRpZmFjdCBob2xvZ3JhcGhpYyBieSBuYXR1cmUuIFRoaXMgbWVhbnMgdGhhdCBhbnkgc2hhcmQgY2FuIGJlIHVzZWQgdG8gcmVjb25zdGl0dXRlIHRoZSB3aG9sZS4KZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIC8vIE1hcmsgZWFjaCBzaGFyZCBib3QgYXMgYmVpbmcgJ3JlY29uc3RpdHV0ZWQnIHdoZW4gd2UgdXBkYXRlIHRoZSBhcnRpZmFjdC4KICAgIC8vIEJlY2F1c2UgdGhpcyBpcyBhIHNoYXJlZCB0YWcgbWFzaywgaXQgd2lsbCBvbmx5IGJlIHRydWUgaW4gdGhlIGN1cnJlbnQgaW5zdC4KICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOwogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlID0gICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwp9CgovLyBSeWFuIENvb2s6IE5lZWQgdG8gZ2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byBjYXRjaHVwLgovLyBGb3VuZCB0aGF0IGlmIHdlIGRpZG50IGRvIHRoaXMsIG1vZCB0YWdzIHdvdWxkIG5vdCBiZSByZXR1cm5lZCBhcyBKU09OIG9iamVjdHMgYnV0IGluc3RlYWQgdGhlIHJhdyBzdHJpbmcuCmF3YWl0IG9zLnNsZWVwKDApOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRlZCBhcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nLiBDb3BpZWQgYXJ0aWZhY3QgYnVuZGxlIHRvICR7c2hhcmRCb3RzLmxlbmd0aH0gYm90cy4gYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfScAmKzluAjJjAQEbWVudQIEAJis5bgI8oMFKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJis5bgIyYwEBWxlYXJuAgQAmKzluAiZhAUo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAmKzluAjJjAQLb25HcmlkQ2xpY2sCBACYrOW4CMCEBUZAaWYgKGxpbmtzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwp9JwCYrOW4CMmMBBphYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdAIEAJis5bgIh4UFByNBRUExRkYnAJis5bgIyYwEG2FiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdAIEAJis5bgIj4UFByMxZTFiMmQnAJis5bgIyYwEEG9uQW55Qm90c1JlbW92ZWQCBACYrOW4CJeFBZUBQGNvbnN0IHsgYm90SURzIH0gPSB0aGF0OwoKaWYgKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCAmJiBib3RJRHMuaW5jbHVkZXMobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkKSkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7Cn0nAJis5bgIyYwEB3ZlcnNpb24CBACYrOW4CK2GBSjwn5SXNTI4ZGMwZjktNDNlYy00M2YzLWE0NzAtZTJkZDZhMGRhOTVmJwCYrOW4CMmMBBhhYkdldEFydGlmYWN0TmFtZXNJbkluc3QCBACYrOW4CNSGBYkCQGxldCBhYkFydGlmYWN0TmFtZXMgPSBuZXcgU2V0KCk7CgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lICYmICFhYkFydGlmYWN0TmFtZXMuaGFzKGIudGFncy5hYkFydGlmYWN0TmFtZSkpIHsKICAgICAgICBhYkFydGlmYWN0TmFtZXMuYWRkKGIudGFncy5hYkFydGlmYWN0TmFtZSk7CiAgICB9Cn0pCgphYkFydGlmYWN0TmFtZXMgPSBBcnJheS5mcm9tKGFiQXJ0aWZhY3ROYW1lcyk7CgpyZXR1cm4gYWJBcnRpZmFjdE5hbWVzOycAmKzluAjJjAQVYWJBcnRpZmFjdEJvdE1lbnVPcGVuAgQAmKzluAjeiAWhDkBjb25zdCB7IGFiQXJ0aWZhY3RCb3QgfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdEJvdCAmJiBhYkFydGlmYWN0Qm90LnNwYWNlICYmIGFiQXJ0aWZhY3RCb3QudGFncywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0Qm90IGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBCb3QuYCk7CgpzaG91dCgiYWJBcnRpZmFjdEJvdE1lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJBcnRpZmFjdE1lbnUiOwoKY29uc3QgYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CgpsZXQgaW5mb0xhYmVsID0gYGFydGlmYWN0OiAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX1cbmA7CmluZm9MYWJlbCArPSBgaGFzaDogJHthYkFydGlmYWN0QnVuZGxlLmNvbnRlbnRTSEEyNTYuc3Vic3RyaW5nKDAsIDcpfVxuYDsKaW5mb0xhYmVsICs9IGByZWNvbnN0aXR1dGVkIGluIGluc3Q6ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWR9XG5gOwppbmZvTGFiZWwgKz0gYGZvcm1hdDogdiR7YWJBcnRpZmFjdEJ1bmRsZS5mb3JtYXRWZXJzaW9ufVxuYDsKaW5mb0xhYmVsICs9IGBjcmVhdGVkIHRpbWU6ICR7RGF0ZVRpbWUuZnJvbUlTTyhhYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXApLnRvTG9jYWxlU3RyaW5nKERhdGVUaW1lLkRBVEVUSU1FX1NIT1JUX1dJVEhfU0VDT05EUyl9XG5gOwoKLy8gSGVhZGVyCmNvbnN0IGluZm9Cb3QgPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudVRleHQoewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBsYWJlbDogaW5mb0xhYmVsLAp9KQphcnRpZmFjdE1lbnVCb3RzLnB1c2goaW5mb0JvdCk7CgovLyBEb3dubG9hZCBhcnRpZmFjdCBidXR0b24uCmNvbnN0IGRvd25sb2FkQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdkb3dubG9hZCcsCiAgICBsYWJlbDogYGRvd25sb2FkIGFydGlmYWN0YCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSAnYWJBcnRpZmFjdC0nICsgYWJBcnRpZmFjdEJ1bmRsZS5uYW1lICsgJy0nICsgYWJBcnRpZmFjdEJ1bmRsZS5jb250ZW50U0hBMjU2LnN1YnN0cmluZygwLDcpICsgJy5hdXgnOyAKICAgICAgICBvcy5kb3dubG9hZEJvdHMoWyBsaW5rcy5hYkFydGlmYWN0Qm90IF0sIGZpbGVuYW1lKTsKICAgIGAsCn0pCmFydGlmYWN0TWVudUJvdHMucHVzaChkb3dubG9hZEJ1dHRvbik7CgptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBhYkFydGlmYWN0Qm90LmlkOwptYXNrcy5hcnRpZmFjdE1lbnVCb3RzID0gZ2V0TGluayhhcnRpZmFjdE1lbnVCb3RzKTsnAJis5bgIyYwEFmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQCBACYrOW4CICXBbABQGlmIChsaW5rcy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICBkZXN0cm95KGxpbmtzLmFydGlmYWN0TWVudUJvdHMpOwogICAgbGlua3MuYXJ0aWZhY3RNZW51Qm90cyA9IG51bGw7Cn0KCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gbnVsbDsnAQRib3RzJDkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YwEnAJis5bgIsZgFBnN5c3RlbQIEAJis5bgIspgFDmFiLnNoZWxsLnV0aWxzJwCYrOW4CLGYBQxhYkNvbXBpbGVDU1MCBACYrOW4CMGYBYIEQGxldCBib3RzID0gdGhhdDsKCmJvdHMgPSBBcnJheS5pc0FycmF5KGJvdHMpID8gYm90cyA6IFtib3RzXTsKCmxldCBjc3MgPSBbXTsKCmZvciAobGV0IGJvdCBvZiBib3RzKSB7CiAgICBmb3IgKGxldCBrZXkgaW4gYm90LnRhZ3MpIHsKICAgICAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJ2NzcycpKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIENTUyBrZXk6ICR7a2V5fWApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNzcy5wdXNoKGJvdC50YWdzW2tleV0pOwogICAgICAgIH0KICAgIH0KfQoKY29uc3QgY29tcGlsZWQgPSBjc3Muam9pbignXG5cbicpOwppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb21waWxlZCBDU1M6XG5cbmAsIGNvbXBpbGVkKTsKfQoKcmV0dXJuIGNvbXBpbGVkOycAmKzluAixmAUIYWJJZ25vcmUCBACYrOW4CMScBQR0cnVlJwCYrOW4CLGYBQdhYlNoZWxsAgQAmKzluAjJnAUEdHJ1ZScAmKzluAixmAUJYWJWZXJzaW9uAgQAmKzluAjOnAUEMTAuNScAmKzluAixmAUNYWJMb2dBbmRUb2FzdAIEAJis5bgI05wFswpAbGV0IG1lc3NhZ2U7CmxldCBkdXJhdGlvbjsKbGV0IGxvZ1R5cGUgPSAnbG9nJzsKbGV0IHRvYXN0ID0gdHJ1ZTsKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIG1lc3NhZ2UgPSB0aGF0OwogICAgZHVyYXRpb24gPSB0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0LCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwOwp9IGVsc2UgewogICAgbWVzc2FnZSA9IHRoYXQubWVzc2FnZTsKICAgIGR1cmF0aW9uID0gdGhhdC5kdXJhdGlvbiA/PyAodGhpc0JvdC5lc3RpbWF0ZVJlYWRpbmdUaW1lKHsgdGV4dDogdGhhdC5tZXNzYWdlLCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwKTsKICAgIGxvZ1R5cGUgPSB0aGF0LmxvZ1R5cGUgPz8gbG9nVHlwZTsKICAgIHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0b2FzdDsKfQoKaWYgKGxvZ1R5cGUgPT09ICdsb2cnKSB7CiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ3dhcm5pbmcnIHx8IGxvZ1R5cGUgPT09ICd3YXJuJykgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6IFdhcm5pbmc6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUud2FybihhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBXYXJuaW5nOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICdlcnJvcicpIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiBFcnJvcjogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5lcnJvcihhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBFcnJvcjogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfScAmKzluAixmAUIcmVtZW1iZXICBACYrOW4CIenBSjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCYrOW4CLGYBQVhYkxvZwIEAJis5bgIrqcFxwFAaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgIH0pOwp9JwCYrOW4CLGYBRNlc3RpbWF0ZVJlYWRpbmdUaW1lAgQAmKzluAj2qAXcA0Bjb25zdCB7CiAgICB0ZXh0ID0gJycsCiAgICB3b3Jkc1Blck1pbnV0ZSA9IDI1MCwKICAgIGRlbGF5VGltZSA9IDUwMCwKfSA9IHRoYXQ7CgovLyBDb3VudCB3b3JkcyAocm91Z2ggYXBwcm94aW1hdGlvbiBieSBzcGxpdHRpbmcgb24gd2hpdGVzcGFjZSkKY29uc3Qgd29yZENvdW50ID0gdGV4dC50cmltKCkuc3BsaXQoL1xzKy8pLmxlbmd0aDsKbGV0IHRvdGFsVGltZU1zID0gMDsKCmlmICh3b3JkQ291bnQgPiAwKSB7CiAgICAvLyBDYWxjdWxhdGUgcmVhZGluZyB0aW1lIGluIG1pbGxpc2Vjb25kcwogICAgY29uc3Qgd29yZHNQZXJTZWNvbmQgPSB3b3Jkc1Blck1pbnV0ZSAvIDYwOwogICAgY29uc3QgcmVhZGluZ1RpbWVNcyA9IE1hdGguY2VpbCgod29yZENvdW50IC8gd29yZHNQZXJTZWNvbmQpICogMTAwMCk7CgogICAgdG90YWxUaW1lTXMgPSByZWFkaW5nVGltZU1zICsgZGVsYXlUaW1lOwp9CgpyZXR1cm4gdG90YWxUaW1lTXM7JwEEYm90cyRkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUBJwCYrOW4CNOsBQZzeXN0ZW0CBACYrOW4CNSsBQ9hYi5zaGVsbC5zZWFyY2gnAJis5bgI06wFBGZvcm0CBACYrOW4COSsBQdub3RoaW5nJwCYrOW4CNOsBQ5hYlJldHJpZXZlRmlsZQIEAJis5bgI7KwFggFALy9wdWxsIGRvd24gZmlsZSBkYXRhCmlmICghdGhhdC51cmwpCnsKICAgIHJldHVybiAibm8gZmlsZSB1cmwgc3VwcGxpZWQiOwp9CgpsZXQgZGF0YSA9IGF3YWl0IG9zLmdldEZpbGUodGhhdC51cmwpOwoKcmV0dXJuIGRhdGE7JwCYrOW4CNOsBRBhYlJldHJpZXZlUmVjb3JkAgQAmKzluAjvrQXsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwCYrOW4CNOsBQhyZW1lbWJlcgIEAJis5bgI3LIFKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJis5bgI06wFDW1hbmlmZXN0YXRpb24CBACYrOW4CIOzBSjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCYrOW4CNOsBQ5vbkxvb2t1cEFCRWdncwIEAJis5bgIqrMFzC9AY29uc3QgeyAKICAgIGFiSUQsCiAgICBhYlZlcnNpb24sCiAgICBpbml0aWFsQm9vdCwKICAgIGF1dG9IYXRjaCwKICAgIHJldHVyblR5cGUsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5LAogICAgdG9hc3QgPSB0cnVlLAogICAgb25QcmVwcm9jZXNzQm90RGF0YSwKICAgIHNvdXJjZUV2ZW50LCAvLyBzb3VyY2VFdmVudCBpcyBhbiBldmVudCBuYW1lIHRoYXQgc3ltYm9saXplcyB3aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwuIChvcHRpb25hbCkKfSA9IHRoYXQ7CgpsZXQgewogICAgcmVjb3JkS2V5ID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvLAp9ID0gdGhhdDsKCmFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogbG9hZGluZyAiICsgYWJJRCk7CgovL2NsZWFyIGFiLTEKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24gJiYgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9PSAiYWJNZW51IikgewogICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYGxvYWRpbmcgJHthYklEfWApOwoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKbGV0IGVnZ0RhdGE7CgovL3RoaXMgbG9naWMgaGFuZGxlcyB0aGUgcmV0cmlldmVkIGRhdGEsIHNlYXJjaGVzIGFnYWluIGlmIG5vbmUgY2FtZSB0aHJvdWdoCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmIChwb3NzaWJsZUF1dGguaWQgPT0gcmVjb3JkS2V5ICYmCiAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSAmJgogICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJyZWNvcmRfbm90X2ZvdW5kIgogICAgKSB7CiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIikgewogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CiAgICB9IGVsc2UgaWYgKGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfbG9nZ2VkX2luIikgewogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgogICAgICAgIGlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MgJiYgCiAgICAgICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfYXV0aG9yaXplZCIKICAgICAgICApIHsKICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICAgICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgICAgICB9CiAgICB9Cn0KCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmICh0b2FzdCkgeyAKICAgICAgICBvcy50b2FzdChgbm8gZGF0YSBmb3VuZCBpbiAke2FiSUR9YCk7CiAgICB9CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KCiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CmVsc2UgewogICAgY29uc3QgcHVibGljUmVhZFRlc3QgPSBnZXRSZWNvcmQubWFya2Vycy5pbmRleE9mKCJwdWJsaWNSZWFkIik7CiAgICBjb25zdCBhdXRob3IgPSBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwoKICAgIGlmIChwdWJsaWNSZWFkVGVzdCAhPSAtMSAmJiBhdXRob3IpIHsKICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIHsKICAgICAgICAgICAgY29uc3QgZWdnSGF0Y2hFdmVudCA9IGFiSUQ7CgogICAgICAgICAgICBvcy5yZWNvcmRFdmVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBlZ2dIYXRjaEV2ZW50KTsKICAgICAgICB9CiAgICB9CgogICAgLy9wYWNrYWdlIHRoZSByZWNvcmQgZGF0YQogICAgZWdnRGF0YSA9IGdldFJlY29yZC5kYXRhOwoKICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAvLyBDaGFuZ2UgaW5pdGlhbCB0YXJnZXQgdmVyc2lvbiBvZiB0aGUgZWdnIGlmIGFiVmVyc2lvbiBpcyBwcm92aWRlZC4KICAgICAgICBlZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9Cn0KCmFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgYWJJRCArICIgbG9hZGVkLCB2ZXJzaW9uICIgKyBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgZ2V0UmVjb3JkLmRhdGEubWF4VmVyc2lvbik7CgppZiAocmV0dXJuVHlwZSAhPSBudWxsKSB7CiAgICBpZiAoZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGxldCB2ZXJzaW9uID0gZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiAtIDE7CgogICAgICAgICAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKGFiVmVyc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gYWJWZXJzaW9uIC0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgICAgICAgICBjb25zdCByZXR1cm5EYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShlZ2dEYXRhVVJMKTsKCiAgICAgICAgICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgICAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXR1cm5EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocmV0dXJuVHlwZSA9PT0gImVnZyIpIHsKICAgICAgICAgICAgaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2ltcGx5IHJldHVybiB0aGUgZWdnIGRhdGEgaWYgcmVxdWVzdGVkLgogICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkLmRhdGE7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICAvLyBUaGlzIGlzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIG9sZCBhdXggZmlsZXMgc3RvcmVkIGJlZm9yZSB0aGUgcmVjb3JkIHN5c3RlbSBleGlzdGVkLgogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgY29uc3QgdmVyc2lvbkFycmF5ID0gSlNPTi5wYXJzZShlZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5KTsKICAgICAgICAgICAgY29uc3QgZmlsZVVVSUQgPSB2ZXJzaW9uQXJyYXlbZWdnRGF0YS5tYXhWZXJzaW9uIC0gMV07CiAgICAgICAgICAgIGNvbnN0IGZpbGVuYW1laGFzaExUTSA9IGNyeXB0by5zaGEyNTYoZmlsZVVVSUQpOwogICAgICAgICAgICBjb25zdCBmaWxldXJsaGFzaExUTSA9ICJhdXhfIiArIGZpbGVuYW1laGFzaExUTSArICcuYXV4JzsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TFRNVVJMID0gImh0dHBzOi8vYnVpbGRlci1sdG0tZmlsZXMuczMuYW1hem9uYXdzLmNvbS8iICsgZmlsZXVybGhhc2hMVE07CiAgICAgICAgICAgIGNvbnN0IG8gPSB7CiAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgICAgICAgdXJsOiB0YXJnZXRMVE1VUkwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGxldCBmaWxlR2V0ID0gYXdhaXQgd2ViaG9vayhvKTsKCiAgICAgICAgICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgICAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5tYW5pZmVzdE92byh7CiAgICBhYklELAogICAgc3R1ZGlvOiByZWNvcmRLZXksCiAgICBkaW1Nb2QsCiAgICBzcGFjZU1vZCwKICAgIGVnZ0RhdGEsCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCb3REYXRhLAogICAgc291cmNlRXZlbnQsCn0pOwoKaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBoYXRjaGVkQm90czogbWFuaWZlc3RSZXN1bHQ/LmhhdGNoZWRCb3RzLAp9OycAmKzluAjTrAULbWFuaWZlc3RPdm8CBACYrOW4CPfiBaEPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQm90RGF0YSwKICAgIHNvdXJjZUV2ZW50LAp9ID0gdGhhdDsKCi8vZWdnIHZpc3VhbGl6YXRpb24Kc2hvdXQoImFiTWVudVJlc2V0Iik7CgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgppZiAobGlua3Mub3ZvQm90KSB7CiAgICBkZXN0cm95KGxpbmtzLm92b0JvdCk7Cn0KCmxldCBlZ2dNb2QgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBpbml0aWFsVGltZXI6IHRydWUsCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgc291cmNlRXZlbnQsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaW50ZXJhY3RPdm8oKTsKICAgIGAsCiAgICBmb3JtOiAiZWdnIiwKICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VMYWJlbENvbG9yLAogICAgcHJvZ3Jlc3NCYXJDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvciwKICAgIHByb2dyZXNzQmFyQmFja2dyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxTaXplOiAwLjUsCiAgICBvblBvaW50ZXJFbnRlcjogYEAKICAgICAgICBtYXNrcy50aXBJZCA9IGF3YWl0IG9zLnRpcCh0YWdzLmFiSUQgKyAnIHYnICsgdGFncy50YXJnZXRWZXJzaW9uKTsKICAgIGAsCiAgICBvblBvaW50ZXJFeGl0OiBgQAogICAgICAgIGlmIChtYXNrcy50aXBJZCkgewogICAgICAgICAgICBvcy5oaWRlVGlwcyhtYXNrcy50aXBJZCk7CiAgICAgICAgfQogICAgYCwKICAgIGxhYmVsUG9zaXRpb246ICJmcm9udCIsCiAgICBvcmllbnRhdGlvbk1vZGU6ICJiaWxsYm9hcmRGcm9udCIsCiAgICBvbkRlc3Ryb3k6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5tYXNrcy5vdm9Cb3QgPSBudWxsOwogICAgYCwKICAgIGVnZ1RpbWVyOiBgQAogICAgICAgIGlmICh0YWdzLnByb2dyZXNzQmFyIDwgMSkgewogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyICs9IDAuMTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge3doaXNwZXIodGhpc0JvdCwgImVnZ1RpbWVyIik7fSwgNzUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNCb3Qub25DbGljaygpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciA9IG51bGw7CiAgICAgICAgfQogICAgYAp9OwoKCmNvbnN0IG92byA9IGF3YWl0IGNyZWF0ZShlZ2dEYXRhLCBlZ2dNb2QsIGRpbU1vZCwgc3BhY2VNb2QpOwptYXNrcy5vdm9Cb3QgPSBnZXRMaW5rKG92byk7CgppZiAob25QcmVwcm9jZXNzQm90RGF0YSkgewogICAgb3ZvLnZhcnMub25QcmVwcm9jZXNzQm90RGF0YSA9IG9uUHJlcHJvY2Vzc0JvdERhdGE7Cn0KCmlmIChvdm8udGFncy5hdXRvSGF0Y2gpIHsKICAgIGNvbnN0IGhhdGNoZWRCb3RzID0gYXdhaXQgdGhpc0JvdC5oYXRjaE92byhvdm8pOwogICAgcmV0dXJuIHsgaGF0Y2hlZEJvdHMgfTsKfQplbHNlIHsKICAgIG92by50YWdzLnByb2dyZXNzQmFyID0gMDsKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBvdm8udGFncy5tYXhWZXJzaW9uOwogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9JwCYrOW4CNOsBQlvbktleURvd24CBACYrOW4CJnyBYIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAJis5bgI06wFCGhhdGNoT3ZvAgQAmKzluAia+AWTFUAvL2xvZ2ljIGZvciBoYXRjaGluZyBvZiBhbiBhYgpzaG91dCgnb3ZvTWVudVJlc2V0Jyk7CgovL2RhdGEgaW4gcmVnYXJkcyB0byB3aGF0IGFiIGlzIGdvaW5nIHRvIGJlIGhhdGNoZWQKY29uc3Qgb3ZvID0gdGhhdDsKCi8vaGF0Y2ggc3BlY2lmaWMgdmFyaWFibGVzCmxldCBpbml0aWFsQm9vdCA9IG92by50YWdzLmluaXRpYWxCb290OwpsZXQgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLnN0YWJsZVZlcnNpb24gPz8gb3ZvLnRhZ3MudGFyZ2V0VmVyc2lvbjsKCmlmICgoY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uIHx8IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uKSAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIpKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uOwp9CgovL3RhcmdldGVkIHZlcnNpb25zCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYiB8fCAhaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpKQp7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiZmVlZGJhY2siKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5mZWVkYmFja1ZlcnNpb247CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJjdXJyZW50IikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgfQogICAgZWxzZSBpZiAoIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy52ZXJzaW9uCiAgICB9CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG51bGw7Cn0KCmlmIChpc05hTih0YXJnZXRWZXJzaW9uKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKfQoKbGV0IHZlcnNpb25BcnJheSA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5OwpsZXQgZmlsZVVSTCA9IHZlcnNpb25BcnJheVt0YXJnZXRWZXJzaW9uIC0gMV07CmxldCBrZXkgPSBvdm8udGFncy5rZXkgPyBvdm8udGFncy5rZXkgOiBjb25maWdCb3QudGFncy5rZXk7CmxldCBmaWxlR2V0OwoKLy9hY3R1YWwgZmlsZSByZXRyaWV2YWwKdHJ5CnsKICAgIGZpbGVHZXQgPSBhd2FpdCBvcy5nZXRGaWxlKGZpbGVVUkwpOwp9CmNhdGNoIChlKQp7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnbm8gZmlsZSBmb3VuZCcpOwoKICAgIHJldHVybjsKfQoKLy9oYW5kbGluZyBmb3IgZW5jcnlwdGVkIGFiIGZpbGUKaWYgKGNyeXB0by5pc0VuY3J5cHRlZChmaWxlR2V0KSkKewogICAgaWYgKCFrZXkpCiAgICB7CiAgICAgICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCcnLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ0VudGVyIGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBmaWxlR2V0ID0gY3J5cHRvLmRlY3J5cHQoa2V5LCBmaWxlR2V0KTsKCiAgICBpZiAoZmlsZUdldCA9PSBudWxsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnaW5jb3JyZWN0IGtleScpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgCiAgICBmaWxlR2V0ID0gSlNPTi5wYXJzZShmaWxlR2V0KTsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CmVsc2UKewogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KCi8vY2xlYW4gdXAKZGVzdHJveShvdm8pOwoKLy90b2FzdCBpZiBub3Qgb24gc3RhYmxlCmlmKG92by50YWdzLnN0YWJsZVZlcnNpb24gIT0gdGFyZ2V0VmVyc2lvbiAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnQpCnsKICAgIGlmIChvdm8udGFncy5mZWVkYmFja1ZlcnNpb24gPT0gdGFyZ2V0VmVyc2lvbikKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCBmZWVkYmFjayB2ZXJzaW9uIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCB2ZXJzaW9uICIgKyB0YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoICsgIiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9Cn0KCi8vZ2VuZXJhdGUgYm90cyBiYXNlZCBvbiB0aGUgZmlsZSByZXRyaWV2ZWQgKkhFUkUqCmNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsKICAgIGJvdHM6IGZpbGVHZXQsCiAgICBvcmlnaW46IG92by50YWdzLmFiSUQsCiAgICBzdHVkaW86IG92by50YWdzLnN0dWRpbywKICAgIHZlcnNpb246IHRhcmdldFZlcnNpb24sCiAgICBpbml0aWFsQm9vdDogaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzOiBvdm8udGFncy5lZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQm90RGF0YTogb3ZvLnZhcnMub25QcmVwcm9jZXNzQm90RGF0YSwKICAgIHNvdXJjZUV2ZW50OiBvdm8udGFncy5zb3VyY2VFdmVudCwKfSk7CgpyZXR1cm4gbmV3Qm90czsnAJis5bgI06wFC2ludGVyYWN0T3ZvAgQAmKzluAiujQbpBkAvL21hbnVhbCBoYXRjaCBtZW51CmNvbnN0IG92b0JvdCA9IHRoYXQgPyB0aGF0IDogbGlua3Mub3ZvQm90OwoKaWYgKCFvdm9Cb3QpIHsKICAgIHJldHVybjsKfQoKc2hvdXQoIm92b01lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJPdm9NZW51IjsKCm1hc2tzLm9uR3JpZENsaWNrID0gYEAKICAgIHNob3V0KCJvdm9NZW51UmVzZXQiKTsKYDsKbWFza3Mub3ZvTWVudVJlc2V0ID0gYEAKICAgIG1hc2tzLm9uR3JpZENsaWNrID0gbnVsbDsKICAgIG1hc2tzLm92b01lbnVSZXNldCA9IG51bGw7CgogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKb3MudHdlZW5Ubyhvdm9Cb3QsIDE1LDQ1LDQ1LCA1KTsKCmNvbnN0IGVnZ01lbnVCdXR0b24gPSB7CiAgICBhYk92b01lbnU6IHRydWUsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb3ZvQm90OiBnZXRMaW5rKG92b0JvdCksCiAgICBjb2xvcjogYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgdGFyZ2V0VmVyc2lvbjogb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwKICAgIGxhYmVsOiBgaGF0Y2ggJHtvdm9Cb3QudGFncy5hYklEfSB2JHtvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9ufSBvZiAke292b0JvdC50YWdzLm1heFZlcnNpb259YCwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIG92b01lbnVSZXNldDogYEAKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgYCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOwogICAgYCwKfTsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGVnZ01lbnVCdXR0b24pOycAmKzluAjTrAUGY3JlYXRlAgQAmKzluAiYlAYo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAmKzluAjTrAUQY2hhbmdlT3ZvVmVyc2lvbgIEAJis5bgIv5QG8AJALy9sb2dpYyBmb3IgdmVyc2lvbiBjaGFuZ2luZyB3aGVuIG1hbnVhbGx5IGhhdGNoaW5nIGFuIGFiCmNvbnN0IG92b0JvdCA9IGxpbmtzLm92b0JvdDsKCmxldCBuZXdWZXJzaW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sIHsKICAgIHBsYWNlaG9sZGVyOiAiZW50ZXIgYSB2ZXJzaW9uIGZyb20gMSB0byAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbgp9KTsKCm92b0JvdC50YWdzLnRhcmdldFZlcnNpb24gPSBuZXdWZXJzaW9uOwpvdm9Cb3QudGFncy5sYWJlbCA9ICd2JysgbmV3VmVyc2lvbjsKCmNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBuZXdWZXJzaW9uOwoKc2hvdXQoIm92b01lbnVSZXNldCIpOycAmKzluAjTrAUEbWVudQIEAJis5bgIsJcGKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJis5bgI06wFCGFiSWdub3JlAgQAmKzluAjXlwYEdHJ1ZScAmKzluAjTrAUHYWJTaGVsbAIEAJis5bgI3JcGBHRydWUnAJis5bgI06wFDGFiMUxUTVNlYXJjaAIEAJis5bgI4ZcGM0AvL3N1cHBvcnQgb2xkIHN5bnRheAp0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOycAmKzluAjTrAUNb25Mb29rdXBBc2tJRAIEAJis5bgIlZgGswhAbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgbG9va2luZyB1cCAke3RoYXQuYXNrSUR9YCk7Cgpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQ7CmNvbnN0IHNvdXJjZUV2ZW50ID0gdGhhdC5zb3VyY2VFdmVudDsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCBsb29rdXBBc2s7IAoKdHJ5CnsKICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIGVuZHBvaW50KTsKfQpjYXRjaAp7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIHRoYXQuYXNrSUQsIGVuZHBvaW50KTsKfQoKaWYgKHRoYXQuY2hhbm5lbENvbmZpZykKewogICAgaWYgKHByb2dyZXNzQnV0dG9uKQogICAgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQogICAgCiAgICByZXR1cm4gbG9va3VwQXNrOwp9CmVsc2UgaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmIGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCkKewogICAgaWYgKGxvb2t1cEFzay5kYXRhLnN0dWRpb0lEID09ICJBQiIpCiAgICB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQpOwoKICAgICAgICBzaG91dCgib25BQkluaXRpYWxpemVkIik7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh7YWJJRDogbG9va3VwQXNrLmRhdGEucGF0dGVybklELCByZWNvcmRLZXk6IGxvb2t1cEFzay5kYXRhLnN0dWRpb0lELCBhdXRvSGF0Y2g6IHRydWUsIHNvdXJjZUV2ZW50IH0pOyAgCiAgICB9Cn0KZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgIWxvb2t1cEFzay5kYXRhLnVybCkKewogICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSAhbG9va3VwQXNrLnN1Y2Nlc3M7Cn0KCmlmIChwcm9ncmVzc0J1dHRvbikKewogICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiBsb29rdXBBc2s7JwCYrOW4CNOsBQVpbnB1dAIEAJis5bgIyaAGKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAJis5bgI06wFBWhhdGNoAgQAmKzluAjwoAbAAUAvL3Nob3V0KCJoYXRjaCIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywga2V5OiBrZXksIGF1dG9IYXRjaDogYm9vbGVhbiwgcmV0dXJuVHlwZTogZGF0YS9udWxsLCBlZ2dQYXJhbWV0ZXJzOiBhcmd9KTsKCmNvbnN0IGxvb2tVcCA9IGF3YWl0IHRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7CgpyZXR1cm4gbG9va1VwOycAmKzluAjTrAUJYWJWZXJzaW9uAgQAmKzluAixogYEMTAuNScAmKzluAjTrAUFbGVhcm4CBACYrOW4CLaiBijwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCYrOW4CNOsBQphYkxvYWRUb29sAgQAmKzluAjdogawB0BsZXQgewogICAgdG9vbE5hbWUsCiAgICB0b29sUGFyYW1ldGVycywKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0b29sTmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0b29sTmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdG9vbFBhcmFtZXRlcnM6YCwgdG9vbFBhcmFtZXRlcnMpOwoKY29uc3QgdXJsID0gbGlua3MubGVhcm4uYWJCdWlsZENhc3VhbENhdGFsb2dVUkwoYC9hYnRvb2xzLyR7dG9vbE5hbWV9LmF1eGApOwoKbGV0IGF1eDsKCnRyeSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsKICAgICAgICBtZXRob2Q6ICdHRVQnLAogICAgICAgIHVybCwKICAgIH0pCgogICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgYXV4ID0gcmVzcG9uc2UuZGF0YTsKICAgIH0KfSBjYXRjaCAoZSkgewogICAgbGV0IG1lc3NhZ2UgPSBgRmFpbGVkIHRvIGRvd25sb2FkIHRvb2wgJyR7dG9vbE5hbWV9Jy5gOwogICAgaWYgKGUubWVzc2FnZSkgewogICAgICAgIG1lc3NhZ2UgKz0gYCBFcnJvcjogJHtlLm1lc3NhZ2V9YDsKICAgIH0KCiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KG1lc3NhZ2UpOwp9CmlmIChhdXgpIHsKICAgIGlmIChhdXgudmVyc2lvbiA9PT0gMSkgewogICAgICAgIHJldHVybiBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90czogYXV4LnN0YXRlLCBlZ2dQYXJhbWV0ZXJzOiB0b29sUGFyYW1ldGVycywgaWdub3JlR3JpZEZvY3VzOiB0cnVlIH0pCiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYGFiIHRvb2xzIG11c3QgYmUgaW4gYXV4IGZvcm1hdCB2MS4gJyR7dG9vbE5hbWV9JyBpcyBhdXggZm9ybWF0IHYke2F1eC52ZXJzaW9ufWApOwogICAgfQp9JwCYrOW4CNOsBQV1dGlscwIEAJis5bgIjqoGKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAJis5bgI06wFC3BlcnNvbmFsaXR5AgQAmKzluAi1qgYo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicBBGJvdHMkZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwAScAmKzluAjcqgYRY21kVXBkYXRlQXJ0aWZhY3QCBACYrOW4CN2qBowIQGNvbnN0IGFyZ3MgPSB0aGF0OwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAvLyBVcGRhdGUgdXNlciBwcm92aWRlZCBhcnRpZmFjdCBuYW1lcy4KICAgIGZvciAoY29uc3QgYWJBcnRpZmFjdE5hbWUgb2YgYXJncykgewogICAgICAgIGxpbmtzLmFydGlmYWN0LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSB9KTsKICAgIH0KfSBlbHNlIHsKICAgIC8vIEhhdmUgdXNlciBzZWxlY3QgYXJ0aWZhY3QgbmFtZXMgdG8gdXBkYXRlLgogICAgbGV0IGFiQXJ0aWZhY3ROYW1lcyA9IGxpbmtzLmFydGlmYWN0LmFiR2V0QXJ0aWZhY3ROYW1lc0luSW5zdCgpOwoKICAgIGlmIChhYkFydGlmYWN0TmFtZXMgJiYgYWJBcnRpZmFjdE5hbWVzLmxlbmd0aCA+IDApIHsKICAgICAgICBhYkFydGlmYWN0TmFtZXMuc29ydCgpOwoKICAgICAgICBjb25zdCBzZWxlY3Rpb25PcHRpb25zID0gYWJBcnRpZmFjdE5hbWVzLm1hcCgoZW50cnkpID0+IHsKICAgICAgICAgICAgcmV0dXJuIHsgbGFiZWw6IGVudHJ5LCB2YWx1ZTogZW50cnkgfQogICAgICAgIH0pCgogICAgICAgIGNvbnN0IHNlbGVjdGVkT3B0aW9ucyA9IGF3YWl0IG9zLnNob3dJbnB1dChudWxsLCB7CiAgICAgICAgICAgIHRpdGxlOiAnVXBkYXRlIGFydGlmYWN0cycsCiAgICAgICAgICAgIHR5cGU6ICdsaXN0JywKICAgICAgICAgICAgc3VidHlwZTogJ2NoZWNrYm94JywKICAgICAgICAgICAgaXRlbXM6IHNlbGVjdGlvbk9wdGlvbnMKICAgICAgICB9KQoKICAgICAgICBmb3IgKGNvbnN0IHNlbGVjdGVkIG9mIHNlbGVjdGVkT3B0aW9ucykgewogICAgICAgICAgICBsaW5rcy5hcnRpZmFjdC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWU6IHNlbGVjdGVkLnZhbHVlIH0pOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgQ2Fubm90IHVwZGF0ZSBhcnRpZmFjdHMgYmVjYXVzZSB0aGVyZSBhcmUgbm8gYXJ0aWZhY3RzIGluIHRoZSBpbnN0LmApOwogICAgfQp9CicAmKzluAjcqgYGc3lzdGVtAgQAmKzluAjqsgYOYWIuc2hlbGwuaW5wdXQnAJis5bgI3KoGBGZvcm0CBACYrOW4CPmyBgdub3RoaW5nJwCYrOW4CNyqBglvbktleURvd24CBACYrOW4CIGzBvoKQGNvbnN0IHsga2V5cyB9ID0gdGhhdDsKCmlmIChtYXNrcy5jaGF0T3BlbikgewogICAgY29uc3QgZXNjID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdFc2NhcGUnKTsKCiAgICBpZiAoZXNjKSB7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhcnJvd1VwID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd1VwJyk7CiAgICAgICAgY29uc3QgYXJyb3dEb3duID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd0Rvd24nKTsKICAgICAgICAKICAgICAgICBpZiAoYXJyb3dVcCB8fCBhcnJvd0Rvd24pIHsKICAgICAgICAgICAgLy8gSWYgQXJyb3dVcCBvciBBcnJvd0Rvd24gYXJlIHByZXNzZWQgd2hpbGUgdGhlIGFiIGNoYXQgYmFyIGlzIG9wZW4gdGhlbgogICAgICAgICAgICAvLyBzdGFydCBjb21iaW5nIHRocm91Z2ggY2hhdCBoaXN0b3J5LgogICAgICAgICAgICBjb25zdCBkaXIgPSBhcnJvd1VwID8gLTEgOiAxOwogICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggKyBkaXI7CiAgICAgICAgICAgIGxldCBoaXN0b3JpY2FsVGV4dCA9IG51bGw7CgogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiBpbmRleCA8IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGhpc3RvcmljYWxUZXh0ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5W2luZGV4XTsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSAtMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA+PSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBjaGF0IGJhci4KICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oeyBwcmVmaWxsOiBoaXN0b3JpY2FsVGV4dCB9KTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBjb25zdCBiYWNrdGljayA9IHRoYXQua2V5cy5pbmNsdWRlcygnYCcpIHx8IHRoYXQua2V5cy5pbmNsdWRlcygiRGVhZCIpOwoKICAgIGlmIChiYWNrdGljaykgewogICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgfQp9CicAmKzluAjcqgYGb25DaGF0AgQAmKzluAj8vQaKGEAvLyBOb3Qgc3VwcG9ydGVkIG91dHNpZGUgb2YgYnVpbGRlciB2ZXJzaW9uCmlmICghYnVpbGRlclZlcnNpb24pIHsKICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIHJldHVybjsKfQoKaWYgKCF0aGF0Lm1lc3NhZ2UpIHsKICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIHJldHVybjsKfQoKLy8gQXBwZW5kIG1lc3NhZ2UgdG8gY2hhdCBoaXN0b3J5IGFuZCB1cGRhdGUgdGhlIGN1cnJlbnQgaGlzdG9yeSBpbmRleC4KdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5LnB1c2godGhhdC5tZXNzYWdlKTsKdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CgovLyBGdW5jdGlvbiB0byBwYXJzZSBhcmd1bWVudHMgd2l0aCBxdW90ZSBzdXBwb3J0IGFuZCBlcnJvciBoYW5kbGluZwovLyBFeGFtcGxlczogCi8vICAgJ2FyZzEgYXJnMicgLT4gWydhcmcxJywgJ2FyZzInXQovLyAgICciYXJnIHdpdGggc3BhY2VzIiBhcmcyJyAtPiBbJ2FyZyB3aXRoIHNwYWNlcycsICdhcmcyJ10KLy8gICAnInVuY2xvc2VkIHF1b3RlJyAtPiB0aHJvd3MgRXJyb3IKZnVuY3Rpb24gcGFyc2VBcmd1bWVudHMoaW5wdXQpIHsKICAgIGNvbnN0IGFyZ3MgPSBbXTsKICAgIGxldCBjdXJyZW50QXJnID0gJyc7CiAgICBsZXQgaW5zaWRlUXVvdGVzID0gbnVsbDsKICAgIGxldCBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaGFyID0gaW5wdXRbaV07CiAgICAgICAgCiAgICAgICAgaWYgKGluc2lkZVF1b3RlcykgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgICAgICBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgICAgICAgICAgICAgcXVvdGVTdGFydFBvcyA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICdcXCcgJiYgaSArIDEgPCBpbnB1dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGkrKzsgLy8gU2tpcCB0aGUgYmFja3NsYXNoCiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGlucHV0W2ldOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBjaGFyOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGNoYXIgPT09ICciJyB8fCBjaGFyID09PSAiJyIpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IGNoYXI7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gaTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAnICcpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudEFyZyA9ICcnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBjaGFyOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmNsb3NlZCBxdW90ZTogZm91bmQgb3BlbmluZyAke2luc2lkZVF1b3Rlc30gYXQgcG9zaXRpb24gJHtxdW90ZVN0YXJ0UG9zfSBidXQgbm8gY2xvc2luZyBxdW90ZWApOwogICAgfQogICAgCiAgICBpZiAoY3VycmVudEFyZy5sZW5ndGggPiAwKSB7CiAgICAgICAgYXJncy5wdXNoKGN1cnJlbnRBcmcpOwogICAgfQogICAgCiAgICByZXR1cm4gYXJnczsKfQoKaWYgKHRoYXQubWVzc2FnZVswXSA9PSAiLiIpIHsKICAgIGNvbnN0IGNvbW1hbmRQYXJ0ID0gdGhhdC5tZXNzYWdlLnN1YnN0cmluZygxKTsgLy8gUmVtb3ZlIHRoZSBkb3QKICAgIGNvbnN0IHNwYWNlSW5kZXggPSBjb21tYW5kUGFydC5pbmRleE9mKCcgJyk7CiAgICAKICAgIGxldCBjbWQsIGFyZ3M7CiAgICBpZiAoc3BhY2VJbmRleCA9PT0gLTEpIHsKICAgICAgICAvLyBObyBhcmd1bWVudHMKICAgICAgICBjbWQgPSBjb21tYW5kUGFydDsKICAgICAgICBhcmdzID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBIYXMgYXJndW1lbnRzCiAgICAgICAgY21kID0gY29tbWFuZFBhcnQuc3Vic3RyaW5nKDAsIHNwYWNlSW5kZXgpOwogICAgICAgIGNvbnN0IGFyZ3NTdHJpbmcgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoc3BhY2VJbmRleCArIDEpOwogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSBwYXJzZUFyZ3VtZW50cyhhcmdzU3RyaW5nKTsKICAgICAgICAgICAgYXJncyA9IHBhcnNlZEFyZ3MubGVuZ3RoID8gcGFyc2VkQXJncyA6IHVuZGVmaW5lZDsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEVycm9yIHBhcnNpbmcgY29tbWFuZCBhcmd1bWVudHM6ICR7ZXJyb3IubWVzc2FnZX1gLCBsb2dUeXBlOiAnRXJyb3InIH0pOwogICAgICAgICAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgLy8gQ3JlYXRlIGEgZnJlc2ggQ29tbWFuZHNNYW5hZ2VyIHdpdGggZWFjaCBjYWxsIHNvIHRoYXQgd2UgYWx3YXlzIGhhdmUgdGhlIGxhdGVzdCBjb21tYW5kcyBhbmQgZnVuY3Rpb25hbGl0eS4KICAgIGNvbnN0IGFiQ29tbWFuZHMgPSBuZXcgQUJDb21tYW5kc01hbmFnZXIoKTsKCiAgICBpZiAoYWJDb21tYW5kcyAmJiBhYkNvbW1hbmRzLmhhc0NvbW1hbmQoY21kKSkgewogICAgICAgIC8vIENhbGwgY29tbWFuZCB3aXRoIGFyZ3MuCiAgICAgICAgYWJDb21tYW5kcy5jYWxsQ29tbWFuZChjbWQsIGFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBFdmFsdWF0ZSBjb21tYW5kIGFzIGphdmFzY3JpcHQuCiAgICAgICAgY29uc3QganMgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOwogICAgICAgIG9zLnJ1bihqcyk7CiAgICB9Cn0KCnRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsnAJis5bgI3KoGC2Rlc2NyaXB0aW9uAgQAmKzluAiH1gZCVGhpcyBpcyBtZWFudCB0byBoYW5kbGUgYW55IG5vbmUgbWVudSByZWxhdGVkIGlucHV0cy9pbnRlcmFjdGlvbnMuJwCYrOW4CNyqBgxvbkZpbGVVcGxvYWQCBACYrOW4CMrWBtcYQC8vZmlsdGVyIG91dCB0aW1lcyB3aGVuIGZpbGUgbG9hZGluZyBpcyBub3QgYWxsb3dlZAppZiAoIWJ1aWxkZXJWZXJzaW9uIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJMaXN0ZW5pbmdGb3JGaWxlVXBsb2FkcyAhPT0gdHJ1ZSkKewogICAgcmV0dXJuOwp9CgovL3ZhcmlvdXMgZmlsZSBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykuc2hpZnQoKTsKbGV0IHNpemUgPSB0aGF0LmZpbGUuc2l6ZTsKbGV0IG1pbWVUeXBlOwpsZXQgYm90SW5mbyA9IHt9OwoKLy9oYXJkIGxpbWl0IGJhc2VkIG9uIGZpbGUgc2l6ZQppZiAoc2l6ZSA+IDIwMDAwMDAwMCkKewogIG9zLnRvYXN0KCJtYXhpbXVtIGZpbGUgc2l6ZSBleGNlZWRlZCAoMjAwIG1iKSIpOwoKICByZXR1cm47Cn0KCi8vdGhpcyBzd2l0Y2ggaGFuZGxlcyBwb3NzaWJsZSBmaWxlcyBleHRlbnNpb25zLCB3aGlsZSByZWplY3RpbmcgYW55IGl0IGRvZXMgbm90IHJlY29nbml6ZQpzd2l0Y2goZmlsZUV4dGVuc2lvbikKewogIGNhc2UgJ2pwZyc6CiAgY2FzZSAnanBlZyc6CiAgY2FzZSAnd2VicCc6CiAgY2FzZSAnZ2lmJzoKICBjYXNlICdwbmcnOgogICAgbWltZVR5cGUgPSAiaW1hZ2UvIiArIGZpbGVFeHRlbnNpb247CiAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgIGJyZWFrOwogIGNhc2UgJ3N2Zyc6CiAgICBtaW1lVHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgYnJlYWs7CiAgY2FzZSAnZ2xiJzoKICBjYXNlICdleHInOgogIGNhc2UgJ2dsdGYnOgogICAgbWltZVR5cGUgPSAidGV4dC94bWwiOwogICAgYm90SW5mby5mb3JtID0gIm1lc2giOwogICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJnbHRmIjsKICAgIGJyZWFrOwogIGNhc2UgJ2F1eCc6CiAgY2FzZSAncGRmJzoKICAgIGxldCBib3REYXRhID0gZmlsZUV4dGVuc2lvbiA9PSAiLmF1eCIgPyBKU09OLnBhcnNlKHRoYXQuZmlsZS5kYXRhKS5zdGF0ZSA6IG9zLnBhcnNlQm90c0Zyb21EYXRhKHRoYXQuZmlsZS5kYXRhKTsKCiAgICBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHtib3RzOiBib3REYXRhLCBvcmlnaW46IGZpbGVOYW1lfSk7CgogICAgcmV0dXJuOwovLyAgIGNhc2UgJ3BkZic6Ci8vICAgICBicmVhazsKICBjYXNlICdtcDMnOgogICAgbWltZVR5cGUgPSAnYXVkaW8vbXBlZyc7CiAgICBib3RJbmZvLm9uQ2xpY2sgPSAiQCBvcy5wbGF5U291bmQodGFncy5mb3JtQWRkcmVzcyk7IjsKICAgIGJvdEluZm8ubGFiZWwgPSAiQ2xpY2sgdG8gUGxheSI7CiAgICBicmVhazsKICBjYXNlICdtcDQnOgogICAgbWltZVR5cGUgPSAndmlkZW8vbXA0JzsKICAgIGJvdEluZm8uZm9ybSA9ICJpZnJhbWUiOwogICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJzcmMiOwogICAgYnJlYWs7CiAgY2FzZSAnb3RmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvb3RmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBjYXNlICd3b2ZmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvd29mZic7CiAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgYnJlYWs7CiAgZGVmYXVsdDoKICAgIGxldCByZXN1bHQgPSBuZXcgRXJyb3IoInVuaGFuZGxlZCBmaWxlIHR5cGU6ICIgKyBmaWxlRXh0ZW5zaW9uKTsKICAgIG9zLnRvYXN0KCJmaWxlIHR5cGUgbm90IHN1cHBvcnRlZCIpOwogICAgY29uc29sZS53YXJuKHJlc3VsdCkKICAgIHJldHVybiByZXN1bHQ7Cn0KCi8vdGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYW5kIG9iamVjdHMgc2V0IHVwIGEgbG9hZGluZyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgpsZXQgdXBsb2FkUmVzdWx0OwpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCB0aGlzQm90LmFiUHJvZ3Jlc3NCYXIoYHVwbG9hZGluZ2ApOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBjb25maWdCb3QudGFncy5zdHVkaW9JRCA/PyBjb25maWdCb3QudGFncy5zdHVkaW87CgppZiAoIWNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKQp7CiAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwp9CgovL3RoaXMgaXMgdGhlIGFjdHVhbCB1cGxvYWQgZnVuY3Rpb25hbGl0eQp1cGxvYWRSZXN1bHQgPSBhd2FpdCBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hGaWxlKHtmaWxlOiB0aGF0LmZpbGUuZGF0YSwgZmlsZU5hbWU6IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKCi8vaWYgdGhlIGZpbGUgc2hvdWxkIGJlIGluY2x1ZGVkIGFzIGEgYm90IHdpdGggYSBsaW5rLCB0aGlzIGxvZ2ljIGhhbmRsZXMgdGhhdAoKaWYgKG1pbWVUeXBlLmluY2x1ZGVzKCJmb250IikpCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5sYWJlbEZvbnRBZGRyZXNzID0gdXBsb2FkUmVzdWx0LnVybCA/IHVwbG9hZFJlc3VsdC51cmwgOiB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKICAgIGNyZWF0ZShib3RJbmZvKTsKfQplbHNlIGlmIChPYmplY3Qua2V5cyhib3RJbmZvKS5sZW5ndGggPiAwKQp7CiAgICBib3RJbmZvW2NvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWxdID0gdHJ1ZTsKICAgIGJvdEluZm8uZm9ybUFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9Cgpjb25zdCBjbGlwVVJMID0gdXBsb2FkUmVzdWx0LnVybCA/PyB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKb3Muc2V0Q2xpcGJvYXJkKGNsaXBVUkwpOwoKb3MudG9hc3QoImZpbGUgdXJsIGFkZGVkIHNldCB0byBjbGlwYm9hcmQiKTsKCi8vY2xlYXIgdGhlIHByb2dyZXNzIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiB1cGxvYWRSZXN1bHQ7JwCYrOW4CNyqBgVsZWFybgIEAJis5bgIou8GKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJis5bgI3KoGCHJlbWVtYmVyAgQAmKzluAjJ7wYo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAmKzluAjcqgYNbWFuaWZlc3RhdGlvbgIEAJis5bgI8O8GKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJis5bgI3KoGCGFiSWdub3JlAgQAmKzluAiX8AYEdHJ1ZScAmKzluAjcqgYGY3JlYXRlAgQAmKzluAic8AYo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAmKzluAjcqgYFc3RvcmUCBACYrOW4CMPwBijwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwCYrOW4CNyqBgRtZW51AgQAmKzluAjq8AYo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAmKzluAjcqgYHYWJTaGVsbAIEAJis5bgIkfEGBHRydWUnAJis5bgI3KoGDWFiUHJvZ3Jlc3NCYXICBACYrOW4CJbxBv0JQGlmICghY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKQp7CiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwp9CgpsZXQgbG9hZExhYmVsID0gdGhhdCA/PyAidXBkYXRpbmciOwpsZXQgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwptZW51QnV0dG9uLmFiTWVudSA9IHRydWU7Cm1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IHsKICAgICJib3JkZXItcmFkaXVzIjoiOHB4IiwgCiAgICAibWFyZ2luLXRvcCI6IjhweCIsIAogICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKfTs7Cm1lbnVCdXR0b24udHJhY2tOdW0gPSAtMTsKbWVudUJ1dHRvbi5vbkNyZWF0ZSA9IGBACiAgICBpZiAodGFncy50cmFja051bSA9PSAyKQogICAgewogICAgICAgIHRhZ3MudHJhY2tOdW0gPSAwOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MudHJhY2tOdW0rKzsKICAgIH0KCiAgICB0YWdzLmxhYmVsID0gdGFnc1sibGFiZWwiK3RhZ3MudHJhY2tOdW1dOwogICAgdGFncy5mb3JtQWRkcmVzcyA9IHRhZ3NbImZvcm0iK3RhZ3MudHJhY2tOdW1dOwoKICAgIHNldFRpbWVvdXQoKCkgPT4gd2hpc3Blcih0aGlzQm90LCAib25DcmVhdGUiKSwgNTAwKTtgOwptZW51QnV0dG9uLmxhYmVsMCA9IGxvYWRMYWJlbCArICIuIjsKbWVudUJ1dHRvbi5sYWJlbDEgPSBsb2FkTGFiZWwgKyAiLi4iOwptZW51QnV0dG9uLmxhYmVsMiA9IGxvYWRMYWJlbCArICIuLi4iOwptZW51QnV0dG9uLmZvcm0wID0gImhvdXJnbGFzc19ib3R0b20iOwptZW51QnV0dG9uLmZvcm0xID0gImhvdXJnbGFzc190b3AiOwptZW51QnV0dG9uLmZvcm0yID0gImhvdXJnbGFzc19ib3R0b20iOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5sYWJlbENvbG9yID0gImJsYWNrIjsKbWVudUJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJjZW50ZXIiOwptZW51QnV0dG9uLmFiUHJvZ3Jlc3NSZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5vbkRlc3Ryb3kgPSAiQCBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7IjsKCm1lbnVCdXR0b24gPSBjcmVhdGUobWVudUJ1dHRvbik7CgpyZXR1cm4gbWVudUJ1dHRvbjsnAJis5bgI3KoGCW9uVGFwQ29kZQIEAJis5bgIlPsGqQJAY29uc3QgdGFwQ29kZSA9IHRoYXQ7Cgpzd2l0Y2ggKHRhcENvZGUpCnsKICAgIGNhc2UgIjMzNDIiOgogICAgICAgIG9zLnRvYXN0KCJ3YWtpbmcgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkpOwoKICAgICAgICB0aGlzQm90Lm9uQ2hhdCh7bWVzc2FnZTogIi4uIn0pOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAiNDI0MiI6CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIC8vY29uc29sZS5sb2codGFwQ29kZSk7Cn0nAJis5bgI3KoGA2FzawIEAJis5bgIvv0GKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAJis5bgI3KoGCWFiVmVyc2lvbgIEAJis5bgI5f0GBDEwLjUnAJis5bgI3KoGCm9uQm90QWRkZWQCBACYrOW4COr9BkBAdGhpc0JvdC5sb2FkQUJDb21tYW5kc01hbmFnZXIoKTsKdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5ID0gW107JwCYrOW4CNyqBhpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAJis5bgIq/4G80JAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCi8vIFRoZXNlIGFyZSBhbGwgdGhlIGJ1aWx0LWluIGNvbW1hbmRzLgoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdoZWxwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGNvbW1hbmRzID0gYWJDb21tYW5kcy5jb21tYW5kczsKICAgIGNvbnN0IGNvbW1hbmRLZXlzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpOwoKICAgIGxldCBzZWxlY3RlZENvbW1hbmQ7CiAgICBpZiAoY29tbWFuZEtleXMgJiYgY29tbWFuZEtleXMubGVuZ3RoICYmIGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb21tYW5kS2V5TWF0Y2ggPSBjb21tYW5kS2V5cy5maW5kKGtleSA9PiBrZXkgPT09IGFyZ3NbMF0pOwogICAgICAgIHNlbGVjdGVkQ29tbWFuZCA9IGNvbW1hbmRLZXlNYXRjaDsKICAgIH0KICAgIAogICAgbGlua3MuaGVscC5tb3VudCh7IGFiQ29tbWFuZHNNYW5hZ2VyOiBhYkNvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IHRoaXMgaGVscCB3aW5kb3cuIENhbiBzcGVjaWZ5IGEgY29tbWFuZCB0byBvcGVuIHRoZSBoZWxwIHBhZ2UgZm9yIHRoYXQgY29tbWFuZCBkaXJlY3RseS4nLAogICAgdXNhZ2U6IFsnLmhlbHAnLCAnLmhlbHAgW2NvbW1hbmRdJ10KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJy4nLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcuLicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3dha2UnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcud2FrZScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NsZWVwJywgYXJncyA9PiB0aGlzQm90LmNtZEFCU2xlZXAoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdXQgYWIgdG8gc2xlZXAuJywKICAgIHVzYWdlOiAnLnNsZWVwJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYXNrJywgKGFyZ3MpID0+IHsKICAgIGlmIChsaW5rcy5hc2spIHsKICAgICAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgYXNrSW5wdXQgPSBhcmdzLmpvaW4oJyAnKTsKICAgICAgICAgICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrSW5wdXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC5hc2sgY29tbWFuZCByZXF1aXJlcyBpbnB1dGApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYXNrIGJvdCBpcyBub3QgbG9hZGVkLCBjYW5ub3QgbG9hZCBhc2tgKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0FzayBhYicsCiAgICB1c2FnZTogJy5hc2sgPGFza19uYW1lPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ25hbWVhYicsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBuYW1lID0gYXdhaXQgb3Muc2hvd0lucHV0KGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHksIHsgdGl0bGU6ICd3aGF0IHdvdWxkIHlvdSBsaWtlIHRvIGNhbGwgbWU/JyB9KTsKICAgIHNldFRhZ01hc2sobGlua3MucGVyc29uYWxpdHksICdhYkJ1aWxkZXJJZGVudGl0eScsIG5hbWUsICdsb2NhbCcpOwogICAgc2hvdXQoJ2NoYW5nZVBlcnNvbmFsaXR5Q29uZmlnJywgeyBuYW1lOiBuYW1lIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2l2ZSBhYiBhIG5ldyBuYW1lLicsCiAgICB1c2FnZTogJy5uYW1lYWInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzeXN0ZW0nLCBhcmdzID0+IHRoaXNCb3QuY21kU3lzdGVtKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGluc3QuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYE9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpICAgIAoKICAgIFlvdSBtYXkgcHJvdmlkZSBhIGN1c3RvbSBzeXN0ZW1UYWdOYW1lIHdpdGggdGhlIGNvbW1hbmQsIGluIG9yZGVyIHRvIG9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgb25seSBmb3IgYm90cyB3aXRoIHRoZSBnaXZlbiBzeXN0ZW1UYWdOYW1lLiBCeSBkZWZhdWx0LCAic3lzdGVtIiB3aWxsIGJlIHVzZWQgYXMgdGhlIHN5c3RlbVRhZ05hbWUuCgogICAgRm9yIGV4YW1wbGU6CgogICAgPiAuc3lzdGVtCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJzeXN0ZW0iIHRhZy4KCiAgICA+IC5zeXN0ZW0gbXlHcm91cAogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAibXlHcm91cCIgdGFnLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zeXN0ZW0nLAogICAgICAgICcuc3lzdGVtIHN5c3RlbVRhZ05hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy13JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4gQnkgZGVmYXVsdCB0aGUgc3lzdGVtIHBvcnRhbCB3aWxsIG9wZW4gaW4gYSBuZXcgdGFiLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2cnLCAoYXJncykgPT4gewogICAgbGlua3MuY29uc29sZS50b2dnbGVDb25zb2xlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdUb2dnbGUgdmlzaWJsaXR5IG9mIHRoZSBhYiBsb2cuJywKICAgIHVzYWdlOiAnLmxvZycKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nY2xlYXInLCAoYXJncykgPT4gewogICAgY29uc3QgbWVzc2FnZUxvZ0JvdHMgPSBnZXRCb3RzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIsIHRydWUpOwogICAgZGVzdHJveShtZXNzYWdlTG9nQm90cyk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdDbGVhciBhbGwgYWIgbG9nIG1lc3NhZ2VzLicsCiAgICB1c2FnZTogJy5sb2djbGVhcicKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2hlZXQnLCBhcmdzID0+IHRoaXNCb3QuY21kU2hlZXQoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHNwZWNpZmllZCBib3Qgb3IgYW4gZW50aXJlIGRpbWVuc2lvbi4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnNoZWV0IFtvcHRpb25zXSBbcG9ydGFsIHwgaGVscGVyQm90TmFtZSB8IGJvdElkIHwgZ2xvYmFsVGhpc1BhdGhdJywKICAgICAgICAnZXguIC5zaGVldCBob21lJywKICAgICAgICAnZXguIC5zaGVldCBjb25maWdCb3QnLAogICAgICAgICdleC4gLnNoZWV0IC10IGEyY2Y0NzM5LTM5YTItNGZkNi1iM2VmLWNjNDc4MmY5NzA4OScsCiAgICAgICAgJ2V4LiAuc2hlZXQgZ2xvYmFsVGhpcy5teU9iamVjdC5teUJvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgbXlPYmplY3QubXlCb3QnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy10JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgaW4gYSBuZXcgYnJvd3NlciB0YWIuIFxuXG5OT1RFOiAuc2hlZXQgd2lsbCBhdXRvbWF0aWNhbGx5IGluc3BlY3QgdGhlIHNwYWNlIG9mIGEgYm90IGFuZCBmb3JjZSBvcGVuaW5nIGluIHRoZSBzYW1lIHRhYiBpZiBhIGJvdCBpcyBpbiB0ZW1wTG9jYWwgb3IgdGVtcFNoYXJlZCBzcGFjZS4nLAogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ21lbnVzaGVldCcsIChhcmdzKSA9PiB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWw7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYENhbm5vdCBvcGVuIHNoZWV0UG9ydGFsIGZvciBtZW51UG9ydGFsIGJvdHMuIFRoZSBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBkaXNhYmxlZC5gfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3IgdGhlIGN1cnJlbnQgbWVudSBwb3J0YWwuJywKICAgIHVzYWdlOiAnLm1lbnVTaGVldCcsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGluc3QnLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRJbnN0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgdGhlIGluc3QgdG8gZGlzay4nLAogICAgdXNhZ2U6ICcuZG93bmxvYWRpbnN0Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRhYicsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEFCKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIHNwZWNpZmllZCBhYiBncm91cChzKSB0byBkaXNrLgoKICAgIFlvdSBjYW4gcHJvdmlkZSBhIGxpc3Qgb2YgZ3JvdXBzIHRvIGRvd25sb2FkIGFsb25nIHdpdGggdGhlIGNvbW1hbmQ6CiAgICA+IC5kb3dubG9hZGFiIGFiQ29yZSBhYlNoZWxsIGFiSW50ZXJmYWNlCgogICAgSWYgZ3JvdXAocykgYXJlIG5vdCBwcm92aWRlZCB3aXRoIHRoZSBjb21hbWFuZCB0aGVuIHlvdSB3aWxsIGJlIHByb21wdGVkIHRvIHByb3ZpZGUgb25lIHdpdGggYSBkaWFsb2cuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRvd25sb2FkYWIgW29wdGlvbnNdIFtncm91cC4uLl0nLAogICAgICAgICdleC4gLmRvd25sb2FkYWIgYWJTaGVsbCBhYkludGVyZmFjZScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiAtdiAxIG15R3JvdXBOYW1lJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnU3BlY2lmeSB0aGUgYXV4IGZvcm1hdCB2ZXJzaW9uIG51bWJlci4gZXguIC12IDEgd2lsbCBiZSBhdXggZm9ybWF0IHZlcnNpb24gMSAocHVyZSBib3QganNvbikuIEJ5IGRlZmF1bHQsIGFiIGZpbGVzIGFyZSB1c3VhbGx5IGRvd25sb2FkZWQgYXMgdmVyc2lvbiAyIGF1eCBmaWxlcyAoY29uZmxpY3QtZnJlZSB1cGRhdGUpLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGVnZycsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEVnZyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4gWW91IHdpbGwgbmVlZCB0byBwcm92aWRlIHRoZSByZWNvcmRLZXkgYXMgd2VsbCBhbmQgdGhlIG5hbWUgb2YgdGhlIGVnZy4gQSBkcm9wZG93biBzZWxlY3Rpb24gd2lsbCBiZSBwcm92aWRlZCBmb3IgdGhlIGVnZyBpZiBmb3VuZCB0byBzZWxlY3Qgd2hpY2ggdmVyc2lvbiB0byBkb3dubG9hZC5gLAogICAgdXNhZ2U6ICcuZG93bmxvYWRlZ2cnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9hZHNraWxsJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm9yIChsZXQgc2tpbGwgb2YgYXJncykgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJy5sb2Fkc2tpbGwgcmVxdWlyZXMgc29tZSBza2lsbCBuYW1lcycpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTG9hZCB0aGUgc3BlY2lmaWVkIGFiIHNraWxscy4nLAogICAgdXNhZ2U6ICcubG9hZFNraWxsIFtza2lsbCAuLi5dJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXJscXInLCAoKSA9PiBvcy5zaG93UVJDb2RlKGNvbmZpZ0JvdC50YWdzLnVybCksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IGEgUVIgY29kZSBmb3IgdGhlIGJyb3dlciB0YWJcJ3MgY3VycmVudCBVUkwuJywKICAgIHVzYWdlOiAnLnVybHFyJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZGltJywgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgbmFtZSA9IGFyZ3Muam9pbignICcpOwogICAgICAgIG9zLmdvVG9EaW1lbnNpb24obmFtZSk7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBNb3ZlZCB0byAnJHtuYW1lfScgZGltZW5zaW9uLmAsIGR1cmF0aW9uOiAzIH0pCiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHbyB0byBzcGVjaWZpZWQgZGltZW5zaW9uIC8gcG9ydGFsLicsCiAgICB1c2FnZTogJy5kaW0gPGRpbWVuc2lvbiB8IHBvcnRhbD4nLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXVpZCcsICgpID0+IHsKICAgIG9zLnNldENsaXBib2FyZCh1dWlkKCkpOwoKICAgIGxldCBtZXNzYWdlID0gYENvcGllZCBuZXcgdXVpZCB0byBjbGlwYm9hcmRgOwogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBvcy50b2FzdChtZXNzYWdlKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dlbmVyYXRlIGEgdW5pdmVyc2FsbHkgdW5pcXVlIGlkZW50aWZpZXIgKHV1aWQpIGFuZCBjb3B5IGl0IHRvIHRoZSBjbGlwYm9hcmQuJywKICAgIHVzYWdlOiAnLnV1aWQnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkdXAnLCAoYXJncykgPT4gewogICAgY29uc3QgYm90SWQgPSBhcmdzID8gYXJnc1swXSA6IHVuZGVmaW5lZDsKICAgIGlmIChib3RJZCkgewogICAgICAgIGNvbnN0IGJvdCA9IGdldEJvdCgnaWQnLCBib3RJZCk7CiAgICAgICAgaWYgKGJvdCkgewogICAgICAgICAgICBjb25zdCBkdXBCb3QgPSBjcmVhdGUoYm90KTsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGR1cEJvdC5pZCk7CiAgICAgICAgICAgIG9zLnRvYXN0KCdEdXBsaWNhdGUgYm90IGlkIGNvcGllZCB0byBjbGlwYm9hcmQuJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3MudG9hc3QoYE5vIGJvdCBmb3VuZCB3aXRoIGlkICR7Ym90SWR9YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBvcy50b2FzdCgnUHJvdmlkZSB0aGUgaWQgb2YgdGhlIGJvdCB5b3Ugd2FudCB0byBkdXBsaWNhdGUnKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0R1cGxpY2F0ZSBhIHNwZWNpZmllZCBib3QgYW5kIGNvcHkgdGhlIG5ldyBib3RcJ3MgaWQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcuZHVwIDxib3RJZD4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGxvYWRhdXgnLCAoYXJncykgPT4gewogICAgb3Muc2hvd1VwbG9hZEF1eEZpbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwbG9hZCBBVVggZmlsZShzKSB0byB0aGUgY3VycmVudCBpbnN0LicsCiAgICB1c2FnZTogJy51cGxvYWRhdXgnCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGZpbGVzJywgYXJncyA9PiB0aGlzQm90LmNtZFVwbG9hZEZpbGVzKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIGZpbGUocykgZGlyZWN0bHkgdG8gcmVjb3JkLicsCiAgICB1c2FnZTogWwogICAgICAgICcudXBsb2FkZmlsZXMnLAogICAgICAgICcudXBsb2FkZmlsZXMgLXJlY29yZCA8cmVjb3JkX2lkPicKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXJlY29yZCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3B0aW9uYWxseSBwdWJsaXNoIGZpbGUocykgdG8gYSBzcGVjaWZpYyByZWNvcmQuIElmIG9taXR0ZWQsIGZpbGUocykgd2lsbCBiZSBwdWJsaXNoZWQgdG8gdGhlIHVzZXJcJ3MgcGVyc29uYWwgcmVjb3JkLicKICAgICAgICB9CiAgICBdCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwZGF0ZWFydGlmYWN0JywgYXJncyA9PiB0aGlzQm90LmNtZFVwZGF0ZUFydGlmYWN0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTWFudWFsbHkgdXBkYXRlIGFuIGFydGlmYWN0IGluIHRoZSBjdXJyZW50IGluc3QuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYE1hbnVhbGx5IHVwZGF0ZSBhbiBhcnRpZmFjdCBpbiB0aGUgY3VycmVudCBpbnN0LgogICAgCiAgICBBIGRpYWxvZyB3aWxsIGJlIHNob3duIGFsbG93aW5nIHlvdSB0byBzZWxlY3Qgd2hpY2ggYXJ0aWZhY3RzIHRvIHVwZGF0ZSBpbiB0aGUgY3VycmVudCBpbnN0LgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGRhdGVhcnRpZmFjdCcsCiAgICBdCn0pJwCYrOW4CNyqBghhcnRpZmFjdAIEAJis5bgIn8EHKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAJis5bgI3KoGFWxvYWRBQkNvbW1hbmRzTWFuYWdlcgIEAJis5bgIxsEH6jBAdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9CgovKioKICogQUJDb21tYW5kc01hbmFnZXIgaXMgcGFydCBvZiBhYlNoZWxsLgogKiBZb3UgY2FuIHJlZ2lzdGVyIGNvbW1hbmRzIHRvIGl0IHRoYXQgY2FuIGJlIGludm9rZWQgdXNpbmcgJyQ8Y29tbWFuZD4nIHdpdGggdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogKiBJdHMgZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZCB0byBjcmVhdGUgdGhpcyB5b3Vyc2VsZiBidXQgaW5zdGVhZCB0byBsaXN0ZW4gZm9yIHRoZSBAb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQgc2hvdXQKICogYW5kIHRvIHJlZ2lzdGVyIHlvdXIgY29tbWFuZHMgdGhlcmUuCiAqIEBwcm9wIHtzdHJpbmdbXX0gY29tbWFuZHMKICovCmNsYXNzIEFCQ29tbWFuZHNNYW5hZ2VyIHsKICAgIGNvbW1hbmRzOiBSZWNvcmQ8c3RyaW5nLCBBQkNvbW1hbmQ+OwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKCiAgICAgICAgLy8gU2hvdXQgdGhhdCBhbiBpbnN0YW5jZSBvZiBBQkNvbW1hbmRzTWFuYWdlciBoYXMgYmVlbiBjcmVhdGVkIGFuZCBhbGxvdyBhbnkgbGlzdGVuZXJzCiAgICAgICAgLy8gdG8gYWRkIHRoZWlyIG93biBjb21tYW5kcyB0byB0aGUgaW5zdGFuY2UuCiAgICAgICAgc2hvdXQoJ29uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkJywgdGhpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgYSBjb21tYW5kIHRvIEFCQ29tbWFuZHNNYW5hZ2VyLgogICAgICogVGhpcyBjb21tYW5kIHdpbGwgYmUgYXZhaWxhYmxlIHRvIGludm9rZSB1c2luZyAnJDxuYW1lPicgb24gdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIHN1Y2Nlc3NmdWxseSBhZGRlZC4KICAgICAqLwogICAgYWRkQ29tbWFuZChuYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjaywgaGVscDogQUJDb21tYW5kSGVscCk6IGJvb2xlYW4gewogICAgICAgIGlmICghbmFtZSB8fCB0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSBzdHJpbmcgbmFtZSBpcyByZXF1aXJlZCBmb3IgY29tbWFuZHMuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBhbHJlYWR5IGV4aXN0cyBhcyBhIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghY2FsbGJhY2sgfHwgdHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGEgY2FsbGJhY2sgZnVuY3Rpb24uYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgaXMgbWlzc2luZyBzaG9ydERlc2NyaXB0aW9uIGZyb20gaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29tbWFuZHNbbmFtZV0gPSB7IG5hbWUsIGNhbGxiYWNrLCBoZWxwIH07CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaGFzQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kc1tuYW1lXSAhPSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgY29tbWFuZCBmcm9tIEFCQ29tbWFuZHNNYW5hZ2VyCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2FzIHJlbW92ZWQuIElmIHRoZSBjb21tYW5kIGRvZXNuJ3QgZXhpc3QgZmFsc2Ugd2lsbCBhbHNvIGJlIHJldHVybmVkLgogICAgICovCiAgICByZW1vdmVDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ2FsbCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2l0aCB0aGUgcHJvdmlkZWQgYXJncyAoaWYgYW55KS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBleGVjdXRlZC4KICAgICAqLwogICAgY2FsbENvbW1hbmQobmFtZTogc3RyaW5nLCBhcmdzPzogYW55W10pOiBib29sZWFuIHsKICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICBpZiAoY29tbWFuZCkgewogICAgICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRBcmdzID0gW107CgogICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBoZWxwQXJnIG9mIGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhlbHBBcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKC4uLmhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaChoZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZSBpbnB1dCBhcmdzIGFyZSB2YWxpZCBhZ2FpbnN0IHRoZSBjb21tYW5kIGhlbHAgZG9jdW1lbnRhdGlvbi4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gZWFzeSB3YXkgdG8gdmFsaWRhdGUgYXJncyBiZWZvcmUgZXhlY3V0aW5nIGEgY29tbWFuZC4KICAgICAgICAgICAgICAgIEFCQ29tbWFuZHNNYW5hZ2VyLmFzc2VydFZhbGlkQXJncyhhcmdzLCB2YWxpZEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1hbmQuY2FsbGJhY2soYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBub3QgYSB2YWxpZCBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHByb3ZpZGVkIGFyZy4gV2lsbCByZW1vdmUgdGhlIGFyZyBhbmQgdmFsdWUgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnVmFsdWUoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYW55IHsKICAgICAgICBsZXQgdmFsdWUgPSBudWxsOwoKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICBsZXQgZGVsZXRlQ291bnQgPSAxOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWVJbmRleCA9IGFyZ0luZGV4ICsgMTsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWVJbmRleCA8IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbdmFsdWVJbmRleF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlbGF0ZWQgYXJncyAmIHZhbHVlcwogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIGRlbGV0ZUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHdldGhlciB0aGUgYXJnIGZsYWcgaXMgcHJvdmlkZWQgaW4gdGhlIGFyZ3MuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnRmxhZyhhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYXJnIGZsYWcuCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgMSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHN0YXRpYyBhc3NlcnRWYWxpZEFyZ3MoYXJnczogYW55W10sIHZhbGlkQXJnczogYW55W10pOiB2b2lkIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBpbnZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFyZyB3ZSB3YW50IHRvIGV2YWx1YXRlLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkQXJncyB8fCAhdmFsaWRBcmdzLmluY2x1ZGVzKGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXJnIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgdmFsaWRBcmdzLCB0aHVzIHRoZSBhcmcgaXMgaW52YWxpZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRBcmdzLnB1c2goYXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB0aGlzIGFyZyBpdCBpcyBtb3N0bHkgbGlrZWx5IGEgdmFsdWUgYXJnLgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGludmFsaWRBcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIGFyZ3VtZW50czogJHtpbnZhbGlkQXJncy5qb2luKCcsICcpfWA7CgogICAgICAgICAgICAgICAgb3MudG9hc3QoZXJyb3JNZXNzYWdlLCA0KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpnbG9iYWxUaGlzLkFCQ29tbWFuZHNNYW5hZ2VyID0gQUJDb21tYW5kc01hbmFnZXI7JwCYrOW4CNyqBgRoZWxwAgQAmKzluAix8gco8J+UlzI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYycAmKzluAjcqgYIY21kU2hlZXQCBACYrOW4CNjyB80UQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IHBvcnRhbDsKbGV0IG5ld1RhYiA9IGZhbHNlOwoKaWYgKGFyZ3MpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV07CiAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJy10JykgewogICAgICAgICAgICAgICAgbmV3VGFiID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSBhcmc7CiAgICAgICAgfQogICAgfQp9CgppZiAoIXBvcnRhbCkgewogICAgcG9ydGFsID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9Cgpjb25zdCBoZWxwZXJCb3RzID0gewogICAgJ2NvbmZpZ0JvdCc6IGNvbmZpZ0JvdCwKICAgICdncmlkUG9ydGFsQm90JzogZ3JpZFBvcnRhbEJvdCwKICAgICdzaGVldFBvcnRhbEJvdCc6IHNoZWV0UG9ydGFsQm90LAogICAgJ3N5c3RlbVBvcnRhbEJvdCc6IHN5c3RlbVBvcnRhbEJvdCwKICAgICdtaW5pR3JpZFBvcnRhbEJvdCc6IG1pbmlHcmlkUG9ydGFsQm90LAogICAgJ21hcFBvcnRhbEJvdCc6IG1hcFBvcnRhbEJvdCwKICAgICdtaW5pTWFwUG9ydGFsQm90JzogbWluaU1hcFBvcnRhbEJvdCwKICAgICdtZW51UG9ydGFsQm90JzogbWVudVBvcnRhbEJvdCwKICAgICdsZWZ0V3Jpc3RQb3J0YWxCb3QnOiBsZWZ0V3Jpc3RQb3J0YWxCb3QsCiAgICAncmlnaHRXcmlzdFBvcnRhbEJvdCc6IHJpZ2h0V3Jpc3RQb3J0YWxCb3QsCiAgICAnbWVldFBvcnRhbEJvdCc6IG1lZXRQb3J0YWxCb3QsCiAgICAndGFnUG9ydGFsQm90JzogdGFnUG9ydGFsQm90LAogICAgJ2ltdVBvcnRhbEJvdCc6IGltdVBvcnRhbEJvdCwKfTsKCi8vIEZ1bmN0aW9uIHRvIHJlc29sdmUgYSBwb3J0YWwgcmVmZXJlbmNlIHRvIGEgc3BlY2lmaWMgYm90CmZ1bmN0aW9uIHJlc29sdmVQb3J0YWxUb0JvdChwYXRoKSB7CiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJycpIHJldHVybiBudWxsOwogICAgCiAgICAvLyBGaXJzdCBjaGVjayBpZiBpdCdzIGRpcmVjdGx5IGluIGhlbHBlckJvdHMKICAgIGlmIChoZWxwZXJCb3RzW3BhdGhdKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlckJvdHNbcGF0aF07CiAgICB9CgogICAgLy8gUGVyaGFwcyB0aGUgcGF0aCBpcyBhIGJvdCBpZC4KICAgIGxldCBib3RGcm9tSWRTZWFyY2ggPSBnZXRCb3QoJ2lkJywgcGF0aCk7CiAgICBpZiAoYm90RnJvbUlkU2VhcmNoKSB7CiAgICAgICAgcmV0dXJuIGJvdEZyb21JZFNlYXJjaDsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgZm9yIGJvdGggZGlyZWN0IGFuZCBuZXN0ZWQgcGF0aHMgaW4gZ2xvYmFsVGhpcwogICAgbGV0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIGxldCBjdXJyZW50T2JqID0gZ2xvYmFsVGhpczsKICAgIGxldCBzdGFydEluZGV4ID0gMDsKICAgIAogICAgLy8gSGFuZGxlIGlmIHRoZSBwYXRoIGV4cGxpY2l0bHkgc3RhcnRzIHdpdGggJ2dsb2JhbFRoaXMnCiAgICBpZiAocGF0aFBhcnRzWzBdID09PSAnZ2xvYmFsVGhpcycpIHsKICAgICAgICBzdGFydEluZGV4ID0gMTsgLy8gU2tpcCB0aGUgJ2dsb2JhbFRoaXMnIHBhcnQgc2luY2Ugd2UncmUgYWxyZWFkeSBzdGFydGluZyB0aGVyZQogICAgfQogICAgCiAgICAvLyBUcmF2ZXJzZSB0aGUgcGF0aAogICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBwYXRoUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwYXJ0ID0gcGF0aFBhcnRzW2ldOwogICAgICAgIGlmICghY3VycmVudE9ialtwYXJ0XSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gUGF0aCBzZWdtZW50IGRvZXNuJ3QgZXhpc3QKICAgICAgICB9CiAgICAgICAgY3VycmVudE9iaiA9IGN1cnJlbnRPYmpbcGFydF07CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGlmIHRoZSBmaW5hbCBvYmplY3QgaXMgYSBib3QgKGhhcyBpZCBhbmQgdGFncykKICAgIGlmIChjdXJyZW50T2JqICYmIGN1cnJlbnRPYmouaWQgJiYgY3VycmVudE9iai50YWdzKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRPYmo7CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOyAvLyBOb3QgYSB2YWxpZCBib3QKfQoKLy8gU2VhcmNoIHRvIHNlZSBpZiBwb3J0YWwgYXJndW1lbnQgaXMgc3BlY2lmaWMgdG8gYSBib3QKbGV0IHVuaXF1ZUJvdCA9IHJlc29sdmVQb3J0YWxUb0JvdChwb3J0YWwpOwoKaWYgKHVuaXF1ZUJvdCkgewogICAgaWYgKHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcExvY2FsJyB8fAogICAgICAgIHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcFNoYXJlZCcKICAgICkgewogICAgICAgIC8vIEZvcmNlIHNoZWV0IHRvIG9wZW4gaW4gc2FtZSB0YWIgaWYgdGhlIGJvdCBvbmx5IGxpdmVzIGluIHRoaXMgdGFiLgogICAgICAgIG5ld1RhYiA9IGZhbHNlOwogICAgfQogICAgcG9ydGFsID0gdW5pcXVlQm90LmlkOwp9CgppZiAobmV3VGFiKSB7CiAgICBvcy5vcGVuVVJMKGAvP2luc3Q9JHtvcy5nZXRDdXJyZW50SW5zdCgpfSZzaGVldFBvcnRhbD0ke3BvcnRhbH1gKTsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gcG9ydGFsOwp9JwCYrOW4CNyqBg1jbWREb3dubG9hZEFCAgQAmKzluAimhwitC0Bjb25zdCBhcmdzID0gdGhhdDsKCmxldCBhdXhWZXJzaW9uOiBzdHJpbmcgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctdicpOwoKaWYgKCFhdXhWZXJzaW9uKSB7CiAgICAvLyBEZWZhdWx0IHRvIGF1eCB2ZXJzaW9uIDIgaWYgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkLgogICAgYXV4VmVyc2lvbiA9ICcyJzsKfQoKaWYgKGF1eFZlcnNpb24gIT09ICcxJyAmJiBhdXhWZXJzaW9uICE9PSAnMicpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYE9ubHkgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgYW5kIDIgYXJlIHN1cHBvcnRlZCBpbiB0aGUgZG93bmxvYWQgYWIgY29tbWFuZC5gKTsKICAgIHJldHVybjsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmxldCBncm91cHMgPSBbXTsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgLy8gUmVtYWluaW5nIGFyZ3MgYXJlIGdyb3VwIG5hbWVzIHByb3ZpZGVkIHdpdGggdGhlIGNvbW1hbmQuCiAgICBncm91cHMgPSBhcmdzOwp9IGVsc2UgewogICAgbGV0IGdyb3VwID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCwgeyB0aXRsZTogJ0FCIEdyb3VwIFRhZycsIGF1dG9TZWxlY3Q6IHRydWUgfSk7CiAgICBpZiAoZ3JvdXApIHsKICAgICAgICBtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAgPSBncm91cDsKICAgICAgICBncm91cHMucHVzaChncm91cCk7CiAgICB9Cn0KCmNvbnN0IG1ham9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWFqb3JWZXJzaW9uOwpjb25zdCBtaW5vclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1pbm9yVmVyc2lvbjsKY29uc3QgYWJWZXJzaW9uID0gYCR7bWFqb3JWZXJzaW9ufS4ke21pbm9yVmVyc2lvbn1gOwoKZm9yIChsZXQgZ3JvdXAgb2YgZ3JvdXBzKSB7CiAgICBjb25zdCBncm91cEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgW2dyb3VwXTogdHJ1ZSwgc3BhY2U6ICdzaGFyZWQnIH0pKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwQm90cy5sZW5ndGg7IGkrKykgewogICAgICAgIGdyb3VwQm90c1tpXS50YWdzLmFiVmVyc2lvbiA9IGFiVmVyc2lvbjsKICAgIH0KCiAgICBpZiAoZ3JvdXAgPT0gImFiQ29uZmlnIikgewogICAgICAgIGdyb3VwID0gImFiMSI7CiAgICB9CgogICAgaWYgKGF1eFZlcnNpb24gPT09ICcxJykgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMQogICAgICAgIG9zLmRvd25sb2FkQm90cyhncm91cEJvdHMsIGdyb3VwKQogICAgfSBlbHNlIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDIKICAgICAgICBvcy5kb3dubG9hZEJvdHNBc0luaXRpYWx6YXRpb25VcGRhdGUoZ3JvdXBCb3RzLCBncm91cCk7CiAgICB9Cgp9CgonAJis5bgI3KoGCWNtZEFCV2FrZQIEAJis5bgI1JIIxANAbGV0IHNraWxsQXJyYXkgPSBbImFiUGVyc29uYWxpdHkiLCAiYWJJbnRlcmZhY2UiLCAiYWJBY3Rpb24iLCAiYWJUZXN0cyJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwp9Cgphd2FpdCBvcy5zbGVlcCgzMDApOwoKLy9rZWVwIGFiIGF3YWtlCmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBd2FrZVN0YXRlID0gdHJ1ZTsKCmlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47Cn0KZWxzZSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkF3YWtlIiwgImFiTWFuaWZlc3RTdGF0ZSIpOycAmKzluAjcqgYKY21kQUJTbGVlcAIEAJis5bgImZYI3QFAY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cgp0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOycAmKzluAjcqgYHY29uc29sZQIEAJis5bgI95cIKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAJis5bgI3KoGDmNtZFVwbG9hZEZpbGVzAgQAmKzluAiemAiTEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScAmKzluAjcqgYOY21kRG93bmxvYWRFZ2cCBACYrOW4CLKoCPkLQGNvbnN0IHJlY29yZEtleSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXksIHsKICAgIHRpdGxlOiAncmVjb3JkIHRvIGxvb2t1cCBlZ2cgaW4nLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleTpgLCByZWNvcmRLZXkpOwoKaWYgKCFyZWNvcmRLZXkpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5ID0gcmVjb3JkS2V5OwoKY29uc3QgZWdnTmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lLCB7CiAgICB0aXRsZTogJ25hbWUgb2YgZWdnJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2dOYW1lOmAsIGVnZ05hbWUpOwoKaWYgKCFlZ2dOYW1lKSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUgPSBlZ2dOYW1lOwoKY29uc3QgZWdnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgIGFiSUQ6IGVnZ05hbWUsCiAgICByZWNvcmRLZXksCiAgICByZXR1cm5UeXBlOiAnZWdnJwp9KQoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2c6YCwgZWdnKTsKCmlmICghQXJyYXkuaXNBcnJheShlZ2cuZWdnVmVyc2lvbkhpc3RvcnkpIHx8IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYERhdGEgZm91bmQgYXQgYWRkcmVzcyAnJHtlZ2dOYW1lfScgaW4gcmVjb3JkICcke3JlY29yZEtleX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlZ2cuYCkKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBlZ2dWZXJzaW9uT3B0aW9ucyA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7CiAgICByZXR1cm4geyBsYWJlbDogYHZlcnNpb24gJHtpbmRleCArIDF9YCwgdmFsdWU6IGluZGV4IH0KfSkKCmNvbnN0IHNlbGVjdGVkVmVyc2lvbk9wdGlvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChlZ2dWZXJzaW9uT3B0aW9ucy5sZW5ndGggLSAxLCB7CiAgICB0aXRsZTogJ2Rvd25sb2FkIGVnZyB2ZXJzaW9uJywKICAgIHR5cGU6ICdsaXN0JywKICAgIHN1YnR5cGU6ICdzZWxlY3QnLAogICAgaXRlbXM6IGVnZ1ZlcnNpb25PcHRpb25zLAp9KQoKaWYgKCFzZWxlY3RlZFZlcnNpb25PcHRpb24pIHsKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBhdXhEYXRhVXJsID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5W3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZV07CmNvbnN0IGF1eERhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGF1eERhdGFVcmwpOwpjb25zdCBhdXhGaWxlbmFtZSA9IGAke2VnZ05hbWV9X3Yke3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZSArIDF9LmF1eGA7Cgpvcy5kb3dubG9hZChhdXhEYXRhLCBhdXhGaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsnAJis5bgI3KoGD2NtZERvd25sb2FkSW5zdAIEAJis5bgIrLQIb0Bjb25zdCBhcmdzID0gdGhhdDsKCm9zLmRvd25sb2FkQm90cyhnZXRCb3RzKGJ5TW9kKHsgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbCB9KSksIG9zLmdldEN1cnJlbnRJbnN0KCkpOycAmKzluAjcqgYGc2VhcmNoAgQAmKzluAictQgo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAmKzluAjcqgYFdXRpbHMCBACYrOW4CMO1CCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCYrOW4CNyqBgljbWRTeXN0ZW0CBACYrOW4COq1CJEHQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3Qgc2FtZVdpbmRvdyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnRmxhZyhhcmdzLCAnLXcnKTsKCmxldCBzeXN0ZW1UYWdOYW1lID0gbnVsbDsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgc3lzdGVtVGFnTmFtZSA9IGFyZ3Muam9pbignICcpOwp9CgppZiAoc2FtZVdpbmRvdykgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4KICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVBvcnRhbCA9IHRydWU7CiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1UYWdOYW1lID0gc3lzdGVtVGFnTmFtZTsKfSBlbHNlIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiBhIG5ldyB0YWIuCiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCk7CgogICAgLy8gUmVtb3ZlIGFueSBwb3J0YWxzIHRoYXQgYXJlIHNldCBpbiB0aGUgVVJMLgogICAgbGV0IHBhcmFtcyA9IHVybC5zZWFyY2hQYXJhbXMua2V5cygpOwogICAgZm9yIChsZXQgcGFyYW0gb2YgcGFyYW1zKSB7CiAgICAgICAgaWYgKHBhcmFtLmVuZHNXaXRoKCdQb3J0YWwnKSkgewogICAgICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZShwYXJhbSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIFR1cm4gb24gdGhlIHN5c3RlbSBwb3J0YWwuCiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtUG9ydGFsJywgJ3RydWUnKTsKICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCdzeXN0ZW1UYWdOYW1lJyk7CgogICAgaWYgKHN5c3RlbVRhZ05hbWUpIHsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtVGFnTmFtZScsIHN5c3RlbVRhZ05hbWUpOwogICAgfQoKICAgIG9zLm9wZW5VUkwodXJsLmhyZWYpOwp9CicAmKzluAjcqgYNYWJDaGF0QmFyT3BlbgIEAJis5bgI/LwIowJAY29uc3QgewogICAgcHJlZmlsbCwKfSA9IHRoYXQgPz8ge30KCm1hc2tzLmNoYXRPcGVuID0gdHJ1ZTsKCm9zLnNob3dDaGF0KHsKICAgIHBsYWNlaG9sZGVyOiAnPiAuaGVscCB0byBzZWUgYXZhaWxhYmxlIGNvbW1hbmRzJywKICAgIGJhY2tncm91bmRDb2xvcjogJyMyZjJmMmYnLAogICAgZm9yZWdyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcGxhY2Vob2xkZXJDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHByZWZpbGwKfSknAJis5bgI3KoGDmFiQ2hhdEJhckNsb3NlAgQAmKzluAigvwh2QG1hc2tzLmNoYXRPcGVuID0gZmFsc2U7Cm9zLmhpZGVDaGF0KCk7CgovLyBHaXZlIENhc3VhbE9TIGEgY2hhbmdlIHRvIGFjdHVhbGx5IHJlbW92ZSB0aGUgY2hhdCBiYXIuCmF3YWl0IG9zLnNsZWVwKDApOycAmKzluAjcqgYLcGVyc29uYWxpdHkCBACYrOW4CJfACCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiAA=="}]}