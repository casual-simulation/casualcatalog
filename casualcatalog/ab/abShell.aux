{"version":2,"updates":[{"id":0,"timestamp":1770419409817,"update":"AbsEwtbV9A8AJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwDC1tX0DwAGc3lzdGVtAgQAwtbV9A8BDWFiLnNoZWxsLmdyaWQnAMLW1fQPAARmb3JtAgQAwtbV9A8PB25vdGhpbmcnAMLW1fQPAAxvbkFueUJvdERyYWcCBADC1tX0Dxe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAMLW1fQPAAhyZW1lbWJlcgIEAMLW1fQP0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAwtbV9A8ACGFiSWdub3JlAgQAwtbV9A/6AQR0cnVlJwDC1tX0DwAHYWJTaGVsbAIEAMLW1fQP/wEEdHJ1ZScAwtbV9A8ACWFiVmVyc2lvbgIEAMLW1fQPhAIFMTAuMzcnAMLW1fQPAAVmb2N1cwIEAMLW1fQPigKrBEAvL3Nob3V0KCJmb2N1cyIsIHtib3Q6IGJvdCwgcG9zaXRpb246e3g6IHgsIHk6IHl9fSk7Cgpjb25zdCBmb2N1c1R5cGUgPSB0aGF0LmJvdCA/ICJib3QiIDogInBvc2l0aW9uIjsKY29uc3QgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uOwpjb25zdCB6b29tID0gdGhhdC56b29tID8/IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IDIwMDAgOiAxMDsKY29uc3Qgcm90YXRpb24gPSB0aGF0LnJvdGF0aW9uID8/IHt4OiA0NSwgeTogNDV9Owpjb25zdCBlYXNpbmcgPSB0aGF0LmVhc2luZyA/PyB7dHlwZTogImxpbmVhciIsIG1vZGU6ICJpbm91dCJ9Owpjb25zdCBmb2N1c09wdGlvbnMgPSB7CiAgICB6b29tOiB6b29tLAogICAgcm90YXRpb246IHJvdGF0aW9uLAogICAgZWFzaW5nOiBlYXNpbmcsCiAgICBkdXJhdGlvbjogZHVyYXRpb24KfTsKCmlmIChmb2N1c1R5cGUgPT0gImJvdCIpCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5ib3QsIGZvY3VzT3B0aW9ucykKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScAwtbV9A+2BgZzeXN0ZW0CBADC1tX0D7cGE2FiLnNoZWxsLmNvbXBvbmVudHMnAMLW1fQPtgYMQXBwQ29udGFpbmVyAgQAwtbV9A/LBsUEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfSAvPgogICAgICAgICAgICA8ZGl2PntjaGlsZHJlbn08L2Rpdj4KICAgICAgICA8Lz4KICAgICkKfQoKcmV0dXJuIEFwcENvbnRhaW5lcjsnAMLW1fQPtgYIVGV4dExpbmsCBADC1tX0D5ELowNAY29uc3QgVGV4dExpbmsgPSAoewogICAgb25DbGljaywKICAgIGNoaWxkcmVuLAp9KSA9PiB7CiAgICByZXR1cm4gKAogICAgICAgIDxzcGFuIAogICAgICAgICAgICBjbGFzc05hbWU9J2FiLWFwcC10ZXh0LWxpbmsgYm9sZCcgCiAgICAgICAgICAgIG9uQ2xpY2s9e29uQ2xpY2t9CiAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAnLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yJzogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstaG92ZXItY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmx1ZXByaW50Q29sb3IKICAgICAgICAgICAgfX0KICAgICAgICA+e2NoaWxkcmVufTwvc3Bhbj4KICAgICkKfQoKcmV0dXJuIFRleHRMaW5rOycAwtbV9A+2BgZXaW5kb3cCBADC1tX0D7UOtgJAY29uc3QgV2luZG93ID0gKHsKICAgIGlkLAogICAgZGlzYWJsZVNoYWRvdywKICAgIGNoaWxkcmVuLAp9KSA9PiB7CgogICAgbGV0IHdpbmRvd0NsYXNzTmFtZSA9ICdhYi1hcHAtd2luZG93JzsKCiAgICBpZiAoZGlzYWJsZVNoYWRvdykgewogICAgICAgIHdpbmRvd0NsYXNzTmFtZSArPSAnIG5vLXNoYWRvdyc7CiAgICB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2IGlkPXtpZH0gY2xhc3NOYW1lPXt3aW5kb3dDbGFzc05hbWV9PgogICAgICAgICAgICB7Y2hpbGRyZW59CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBXaW5kb3c7JwDC1tX0D7YGDFRleHRMaW5rLmNzcwIEAMLW1fQP7BDtAS5hYi1hcHAtdGV4dC1saW5rIHsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1jb2xvciwgcmdiKDcxIDI1NSAxMzcpKTsKfQoKLmFiLWFwcC10ZXh0LWxpbms6aG92ZXIgewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvciwgcmdiKDAgMTkyIDI1NSkpOwp9CgouYWItYXBwLXRleHQtbGluay5ib2xkIHsKICBmb250LXdlaWdodDogYm9sZDsKfScAwtbV9A+2BhVCYWNrZ3JvdW5kT3ZlcmxheS5jc3MCBADC1tX0D9oScS5hYi1hcHAtYmcgewogICAgcG9zaXRpb246IGZpeGVkOwogICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjMzKTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwp9JwDC1tX0D7YGCldpbmRvdy5jc3MCBADC1tX0D8wTqAMuYWItYXBwLXdpbmRvdyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgY29sb3I6IHdoaXRlOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzJmMmYyZjsKICAgIHdpZHRoOiA4MHZ3OwogICAgaGVpZ2h0OiA3MHZoOwogICAgbWF4LXdpZHRoOiAxNTAwcHg7CiAgICBtYXgtaGVpZ2h0OiAxMDAwcHg7CiAgICBsZWZ0OiA1MCU7CiAgICB0b3A6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMHB4IDBweCAxMnB4IDBweCBibGFjazsKICAgIG92ZXJmbG93OiBhdXRvOwogICAgcGFkZGluZy1sZWZ0OiA4cHg7CiAgICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCi5hYi1hcHAtd2luZG93Lm5vLXNoYWRvdyB7CiAgICBib3gtc2hhZG93OiBub25lOwp9JwDC1tX0D7YGCHJlbWVtYmVyAgQAwtbV9A/1Fijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDC1tX0D7YGCGFiSWdub3JlAgQAwtbV9A+cFwR0cnVlJwDC1tX0D7YGB2FiU2hlbGwCBADC1tX0D6EXBHRydWUnAMLW1fQPtgYJYWJWZXJzaW9uAgQAwtbV9A+mFwUxMC4zNycAwtbV9A+2BgtwZXJzb25hbGl0eQIEAMLW1fQPrBco8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicBBGJvdHMkMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViAScAwtbV9A/TFwdBcHAuY3NzAgQAwtbV9A/UF8oWOnJvb3QgewogIC0tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICAtLW9uLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgLS1hYi1jb25zb2xlLWhlaWdodDogMzN2aDsKfQovKiBEYXJrIG1vZGUgc3VwcG9ydCAqLwpAbWVkaWEgKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKSB7CiAgOnJvb3QgewogICAgLS1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogICAgLS1vbi1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIH0KfQoKLmFiLWNvbnNvbGUtYnRuIHsKICBjdXJzb3I6IHBvaW50ZXI7CiAgY29sb3I6IGluaGVyaXQ7CiAgbGV0dGVyLXNwYWNpbmc6IGluaGVyaXQ7CiAgbGluZS1oZWlnaHQ6IGluaGVyaXQ7CiAgdGV4dC10cmFuc2Zvcm06IGluaGVyaXQ7CiAgdGV4dC1pbmRlbnQ6IGluaGVyaXQ7CiAgdGV4dC1zaGFkb3c6IGluaGVyaXQ7CiAgYmFja2dyb3VuZC1jb2xvcjogaW5oZXJpdDsKICBtYXJnaW46IGluaGVyaXQ7CiAgcGFkZGluZy1ibG9jazogaW5oZXJpdDsKICBwYWRkaW5nLWlubGluZTogaW5oZXJpdDsKICBib3JkZXI6IG5vbmU7CiAgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOwp9CgouYWItY29uc29sZSB7CiAgd2lkdGg6IDEwMHZ3OwogIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgcGFkZGluZzogMDsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpIGJyaWdodG5lc3MoMjAwJSk7CiAgYW5pbWF0aW9uLW5hbWU6IHNsaWRlLWFwcC1pbjsKICBhbmltYXRpb24tZHVyYXRpb246IDAuNXM7CiAgb3ZlcmZsb3cteTogaGlkZGVuOwogIHotaW5kZXg6IDE7Cn0KCi5hYi1jb25zb2xlOjphZnRlciB7CiAgY29udGVudDogIiI7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgcG9zaXRpb246IGFic29sdXRlOwogIHRvcDogMDsKICBsZWZ0OiAwOwogIHJpZ2h0OiAwOwogIGJvdHRvbTogMDsKICBvcGFjaXR5OiAwLjk7CiAgei1pbmRleDogMDsKfQoKQGtleWZyYW1lcyBzbGlkZS1hcHAtaW4gewogIGZyb20gewogICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogY3ViaWMtYmV6aWVyKC42LDAsLjc5LDEuMDMpOwogICAgLyogdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDExMCUpOyAqLwogICAgLyogaGVpZ2h0OiAwcHg7ICovCiAgICAvKiBtaW4taGVpZ2h0OiAwcHg7ICovCiAgICBtYXgtaGVpZ2h0OiAwcHg7CiAgfQoKICB0byB7CiAgICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgICAvKiBtaW4taGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7ICovCiAgfQp9CgouYWItY29uc29sZSA+IGRpdiB7CiAgei1pbmRleDogMTsKICBwb3NpdGlvbjogcmVsYXRpdmUKfQoKLmFiLWNvbnNvbGUtdG9wLWJhciB7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgd2lkdGg6IDEwMCU7CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIHVzZXItc2VsZWN0OiBub25lOwogIGRpc3BsYXk6IGZsZXg7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBqdXN0aWZ5LWNvbnRlbnQ6IGVuZDsKICBwYWRkaW5nOiAwLjVyZW07Cn0KCi5hYi1jb25zb2xlLWxvZyB7CiAgb3ZlcmZsb3cteTogYXV0bzsKICBmbGV4LWdyb3c6IDE7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uLXJldmVyc2U7CiAgbWluLWhlaWdodDogMjRweDsKICBwYWRkaW5nOiAwIDFyZW07CiAgY3Vyc29yOiBwb2ludGVyOwogIG92ZXJzY3JvbGwtYmVoYXZpb3I6IGNvbnRhaW47Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIGN1cnNvcjogaW5pdGlhbDsKfQoKLmFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIgewogIG1hcmdpbjogMC41cmVtIDA7Cn0KLmFiLWNvbnNvbGUtbWVzc2FnZSB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgZ2FwOiA4cHg7Cn0KCi5hYi1jb25zb2xlLXNwYWNlciB7CiAgZmxleC1zaHJpbms6IDA7CiAgZmxleC1ncm93OiAxOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBtYXgtd2lkdGg6IDgwdnc7CiAgYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScAwtbV9A/TFwZnZXRBcHACBADC1tX0D58u3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwDC1tX0D9MXC2hpZGVDb25zb2xlAgQAwtbV9A/9UZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwDC1tX0D9MXA2xvZwIEAMLW1fQPnVOFCUBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGF3YWl0IGNyZWF0ZShib3RUYWdzKTsKCnNob3V0KCJvbkFCTG9nIiwgbG9nQm90KTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwDC1tX0D9MXC3Nob3dDb25zb2xlAgQAwtbV9A+jXO0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAwtbV9A/TFwZzeXN0ZW0CBADC1tX0D5FgEGFiLnNoZWxsLmNvbnNvbGUnAMLW1fQP0xcNdG9nZ2xlQ29uc29sZQIEAMLW1fQPomCWAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScAwtbV9A/TFwRmb3JtAgQAwtbV9A+5YQdub3RoaW5nJwDC1tX0D9MXB2FiU2hlbGwCBADC1tX0D8FhBHRydWUnAMLW1fQP0xcKYWJJRE9yaWdpbgIEAMLW1fQPxmEVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwDC1tX0D9MXBlRvcEJhcgIEAMLW1fQP3GHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAwtbV9A/TFw1zaG93Q2hhdElucHV0AgQAwtbV9A/QZgVmYWxzZScAwtbV9A/TFwpzaG93VG9wQmFyAgQAwtbV9A/WZgVmYWxzZScAwtbV9A/TFwlhYlZlcnNpb24CBADC1tX0D9xmBTEwLjM3JwDC1tX0D9MXEnNldEFiRXhwYW5kQ29uc29sZQIEAMLW1fQP4maXAkBjb25zb2xlLmxvZyh0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCkKaWYgKHR5cGVvZiB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuOwp9CgppZiAodGhhdCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChzID0+ICFzKTsKfSBlbHNlIGlmICh0aGF0ID09IHRydWUpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHRydWUpOwp9IGVsc2UgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwoZmFsc2UpOwp9CicAwtbV9A/TFwhhYklnbm9yZQIEAMLW1fQP+mgEdHJ1ZScAwtbV9A/TFwdNZXNzYWdlAgQAwtbV9A//aMEQQGNvbnN0IHsgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZUVmZmVjdCB9ID0gb3MuYXBwSG9va3MKY29uc3QgVG9wQmFyID0gdGhpc0JvdC5Ub3BCYXIoKQoKY29uc3QgTWVzc2FnZSA9ICh7IHRpbWVzdGFtcCwgbWVzc2FnZSwgbmFtZSB9KSA9PiB7CiAgICBjb25zdCBbc2hvd1RpbWUsIHNldFNob3dUaW1lXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IFt1c2VyTWVzc2FnZSwgc2V0VXNlck1lc3NhZ2VdID0gdXNlU3RhdGUoZmFsc2UpOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGF1dGhCb3QgJiYgYXV0aEJvdC50YWdzLm5hbWUpIHsKICAgICAgICAgICAgaWYgKGF1dGhCb3QudGFncy5uYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChtYXNrcy5wcmVmZXJyZWROYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobmFtZSA9PSAidXNlciIgfHwgbmFtZSA9PSAiVXNlciIpIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UoZmFsc2UpOwogICAgICAgIH0KCiAgICB9LCBbbmFtZV0pCgogICAgY29uc3QgdGltZVRleHQgPSB1c2VNZW1vKAogICAgICAgICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aW1lc3RhbXApIHsgcmV0dXJuIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoCiAgICAgICAgICAgICAgICAgICAnZW4tdXMnLCB7dGltZVN0eWxlOiAnbWVkaXVtJ30pfSwKICAgICAgICBbdGltZXN0YW1wXQogICAgKTsKCiAgICBpZiAoIXRpbWVzdGFtcCB8fCAhbWVzc2FnZSkgeyByZXR1cm4gPD48Lz4gfQoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoKSA9PiBzZXRTaG93VGltZSh0cnVlKX0KICAgICAgICAgICAgb25Qb2ludGVyTGVhdmU9eygpID0+IHNldFNob3dUaW1lKGZhbHNlKX0KICAgICAgICA+CiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIHN0eWxlPXt1c2VyTWVzc2FnZSAmJiB7dGV4dEFsaWduOiAncmlnaHQnfX0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAge25hbWV9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlIiBzdHlsZT17ewogICAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3JvdycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ3Jvdy1yZXZlcnNlJwogICAgICAgICAgICB9fT4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXNwYWNlciIKICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0QWxpZ246IHVzZXJNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncmlnaHQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnbGVmdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHNob3dUaW1lID8gMC42IDogMAogICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAge3RpbWVUZXh0fQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1jb250ZW50Ij57bWVzc2FnZX08L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBNZXNzYWdlOycAwtbV9A/TFxBvbkFueUJvdHNSZW1vdmVkAgQAwtbV9A/Bea0CQGNvbnN0IHsgYm90SURzIH0gPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IGJvdElkIG9mIGJvdElEcykgew0KICAgIGlmICh0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICBjb25zdCBkZWxldGVkID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuZGVsZXRlKGJvdElkKTsNCg0KICAgICAgICBpZiAoZGVsZXRlZCkgew0KICAgICAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90SWQ6IGJvdElkIH0pOw0KICAgICAgICB9DQogICAgfQ0KfScAwtbV9A/TFw5vbkFueUJvdHNBZGRlZAIEAMLW1fQP73v4A0Bjb25zdCB7IGJvdHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgbmV3Qm90IG9mIGJvdHMpIHsNCiAgICBpZiAobmV3Qm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKG5ld0JvdC5pZCkpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmFkZChuZXdCb3QuaWQpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBuZXdCb3QgfSk7DQogICAgfQ0KfScAwtbV9A/TFxBvbkFueUJvdHNDaGFuZ2VkAgQAwtbV9A/of+MFQGNvbnN0IGJvdHMgPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IGJvdCBvZiBib3RzKSB7DQogICAgaWYgKGJvdC5ib3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMoYm90LmJvdC5pZCkpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmFkZChib3QuYm90LmlkKTsNCg0KICAgICAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdDogYm90LmJvdCB9KTsNCiAgICAgICAgfSANCg0KICAgICAgICBpZiAoYm90LnRhZ3MuaW5jbHVkZXMoIm1lc3NhZ2UiKSB8fCBib3QudGFncy5pbmNsdWRlcygibmFtZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJ0aW1lc3RhbXAiKSB8fCBib3QudGFncy5pbmNsdWRlcygiY29uc29sZUxvZ01lc3NhZ2VCb3QiKSkgew0KICAgICAgICAgICAgaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsgICAgICAgIA0KICAgICAgICB9DQogICAgfQ0KfScAwtbV9A/TFx9vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkAgQAwtbV9A/MhQE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwDC1tX0D9MXHW9uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkAgQAwtbV9A+DhgE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwEEYm90cyQyNGRjMDQzMS1mZmJiLTQ0OGQtYWE3NS05NzFiYWEwNzE4ZGMBJwDC1tX0D7qGAQZzeXN0ZW0CBADC1tX0D7uGAQ1hYi5zaGVsbC5oZWxwJwDC1tX0D7qGAQlvbktleURvd24CBADC1tX0D8mGAYgCQGlmICh0YWdzLmFjdGl2ZSAmJiB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICBmb3IgKGxldCBjYWxsYmFjayBvZiB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9JwDC1tX0D7qGAQd1bm1vdW50AgQAwtbV9A/SiAGOAUBhd2FpdCBvcy5jb21waWxlQXBwKHRhZ3MuYXBwSWQsIDw+PC8+KTsKYXdhaXQgb3MudW5yZWdpc3RlckFwcCh0YWdzLmFwcElkKTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gdW5kZWZpbmVkOwptYXNrcy5hY3RpdmUgPSBmYWxzZTsnAMLW1fQPuoYBCXN0eWxlLmNzcwIEAMLW1fQP4YkB8QcuaGVscC10YWJsZSB7CiAgd2lkdGg6IDEwMCU7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi5oZWxwLXRhYmxlIHRkIHsKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHBhZGRpbmctYm90dG9tOiA4cHg7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouaGVscC10YWJsZSB0ZCBoMyB7CiAgbWFyZ2luOiAwOwp9CgouaGVscC10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA5MHB4OwogIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLnNlY3Rpb24gewogIG1hcmdpbi10b3A6IDE2cHg7Cn0KCi5zZWN0aW9uIHA6Zmlyc3Qtb2YtdHlwZSB7CiAgbWFyZ2luLXRvcDogNHB4OwogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouZGVzY3JpcHRpb24geyAKICB3aGl0ZS1zcGFjZTogcHJlLWxpbmU7Cn0KCi51c2FnZS10YWJsZSB7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi51c2FnZS10YWJsZSB0ZCxoMyB7IAogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogIG1hcmdpbjogMDsKfQoKLnVzYWdlLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDYwcHg7Cn0KCi5hcmdzLXRhYmxlIHsKICBtYXJnaW4tbGVmdDogMTZweDsKfQoKLmFyZ3MtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5hcmdzLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9CgpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpLCAobWF4LWhlaWdodDogNjAwcHgpIHsKICAuaGVscC13aW5kb3cgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBsZWZ0OiB1bnNldDsKICAgIHRvcDogdW5zZXQ7CiAgICB0cmFuc2Zvcm06IHVuc2V0OwogICAgbWF4LXdpZHRoOiB1bnNldDsKICAgIG1heC1oZWlnaHQ6IHVuc2V0OwogICAgYm94LXNoYWRvdzogdW5zZXQ7CiAgfQp9JwDC1tX0D7qGAQlvbkRlc3Ryb3kCBADC1tX0D9ORARNAdGhpc0JvdC51bm1vdW50KCk7JwDC1tX0D7qGAQVtb3VudAIEAMLW1fQP55EB8QJAY29uc3QgewogICAgYWJDb21tYW5kc01hbmFnZXIsCiAgICBzZWxlY3RlZENvbW1hbmQKfSA9IHRoYXQgPz8ge307CgppZiAobWFza3MuYWN0aXZlKSB7CiAgICBhd2FpdCB0aGlzQm90LnVubW91bnQoKTsKfQoKY29uc3QgQXBwID0gdGhpc0JvdC5BcHAoKTsKCmF3YWl0IG9zLnJlZ2lzdGVyQXBwKHRhZ3MuYXBwSWQsIHRoaXNCb3QpOwphd2FpdCBvcy5jb21waWxlQXBwKHRhZ3MuYXBwSWQsIDxBcHAgY29tbWFuZHM9e2FiQ29tbWFuZHNNYW5hZ2VyLmNvbW1hbmRzfSBpbml0aWFsU2VsZWN0ZWRDb21tYW5kPXtzZWxlY3RlZENvbW1hbmR9Lz4pOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSBbXTsKbWFza3MuYWN0aXZlID0gdHJ1ZTsnAMLW1fQPuoYBCmNvbXBvbmVudHMCBADC1tX0D9mUASjwn5SXMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhJwDC1tX0D7qGAQV1dGlscwIEAMLW1fQPgJUBKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAMLW1fQPuoYBCGFiSWdub3JlAgQAwtbV9A+nlQEEdHJ1ZScAwtbV9A+6hgEHYWJTaGVsbAIEAMLW1fQPrJUBBHRydWUnAMLW1fQPuoYBCWFiVmVyc2lvbgIEAMLW1fQPsZUBBTEwLjM3JwDC1tX0D7qGAQNBcHACBADC1tX0D7eVAbIvQGNvbnN0IEFwcENvbnRhaW5lciA9IGxpbmtzLmNvbXBvbmVudHMuQXBwQ29udGFpbmVyKCk7CmNvbnN0IFdpbmRvdyA9IGxpbmtzLmNvbXBvbmVudHMuV2luZG93KCk7CmNvbnN0IFRleHRMaW5rID0gbGlua3MuY29tcG9uZW50cy5UZXh0TGluaygpOwpjb25zdCBjc3MgPSBsaW5rcy51dGlscy5hYkNvbXBpbGVDU1MoWyB0aGlzQm90LCBsaW5rcy5jb21wb25lbnRzIF0pOwoKY29uc3QgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlUmVmLCB1c2VNZW1vIH0gPSBvcy5hcHBIb29rczsKCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqLwpjb25zdCBBdmFpbGFibGVDb21tYW5kcyA9ICh7IGNvbW1hbmRzLCBvbkNvbW1hbmRDbGljayB9KSA9PiB7CiAgICBjb25zdCBjb21tYW5kTmFtZXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcykuc29ydCgpOwoKICAgIGNvbnN0IG9uQ2xvc2UgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQ2xvc2V9PnsneCBDbG9zZSd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj5BdmFpbGFibGUgQ29tbWFuZHM8L2gyPgogICAgICAgICAgICA8cD5Vc2FnZTogLmNvbW1hbmQgW29wdGlvbnNdPC9wPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgICAgIHtjb21tYW5kTmFtZXMubWFwKChuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRzW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PFRleHRMaW5rIG9uQ2xpY2s9eygpID0+IG9uQ29tbWFuZENsaWNrKGNvbW1hbmQubmFtZSl9Pntjb21tYW5kLm5hbWV9PC9UZXh0TGluaz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntkZXNjcmlwdGlvbn08L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7Q29tbWFuZH0gcHJvcHMuY29tbWFuZAogKi8KY29uc3QgU3BlY2lmaWNDb21tYW5kID0gKHsgY29tbWFuZCwgb25CYWNrIH0pID0+IHsKICAgIGxldCB1c2FnZSA9ICcnOwogICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKICAgIGxldCBhcmdzID0gbnVsbDsKCiAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC51c2FnZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb21tYW5kLmhlbHAudXNhZ2UpKSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZS5qb2luKCdcbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbjsKICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MgJiYgY29tbWFuZC5oZWxwLmFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhcmdzID0gY29tbWFuZC5oZWxwLmFyZ3M7CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+ICAKICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQmFja30+eyc8IEJhY2snfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+e2NvbW1hbmQubmFtZX08L2gyPgogICAgICAgICAgICB7IHVzYWdlICYmCiAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSd1c2FnZS10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGgzPlVzYWdlOjwvaDM+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2FnZX08L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgZGVzY3JpcHRpb24gJiYgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkRlc2NyaXB0aW9uOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdkZXNjcmlwdGlvbic+e2Rlc2NyaXB0aW9ufTwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgYXJncyAmJgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5Bcmd1bWVudHM6PC9oMz4KICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdhcmdzLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICAgICAgeyBhcmdzLm1hcCgoYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZy5pZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdJZGVudGlmaWVyRGlzcGxheSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyLmpvaW4oJyxcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmcuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBhcmcuZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnSWRlbnRpZmllckRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdEZXNjcmlwdGlvbkRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqIEBwYXJhbSB7YW55W119IFtwcm9wcy5hcmdzXQogKi8KY29uc3QgQXBwID0gKHsgY29tbWFuZHMsIGluaXRpYWxTZWxlY3RlZENvbW1hbmQgfSkgPT4gewogICAgY29uc3QgWyBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZCBdID0gdXNlU3RhdGUoaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCk7CgogICAgLy8gRXNjYXBlIGtleSBwcmVzcyBldmVudCBoYW5kbGVyCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IG9uRXNjYXBlS2V5UHJlc3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZENvbW1hbmQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnB1c2gob25Fc2NhcGVLZXlQcmVzcyk7CgogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrSW5kZXggPSB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5maW5kSW5kZXgoKGNhbGxiYWNrKSA9PiBjYWxsYmFjayA9PT0gb25Fc2NhcGVLZXlQcmVzcyk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnNwbGljZShjYWxsYmFja0luZGV4LCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFtzZWxlY3RlZENvbW1hbmRdKTsKICAgIAogICAgY29uc3Qgb25CYWNrZ3JvdW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CgogICAgY29uc3Qgb25Db21tYW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygobmFtZSkgPT4gewogICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChuYW1lKTsKICAgIH0sIFtzZXRTZWxlY3RlZENvbW1hbmRdKQoKICAgIGNvbnN0IGNvbnRlbnQgPSB1c2VNZW1vKCgpID0+IHsKICAgICAgICBpZiAoIXNlbGVjdGVkQ29tbWFuZCkgewogICAgICAgICAgICByZXR1cm4gPEF2YWlsYWJsZUNvbW1hbmRzIGNvbW1hbmRzPXtjb21tYW5kc30gb25Db21tYW5kQ2xpY2s9e29uQ29tbWFuZENsaWNrfS8+CiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgIHJldHVybiA8U3BlY2lmaWNDb21tYW5kIGNvbW1hbmQ9e2NvbW1hbmRzW3NlbGVjdGVkQ29tbWFuZF19IG9uQmFjaz17KCkgPT4gc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpfS8+CiAgICAgICAgfQogICAgfSwgW2NvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHN0eWxlPntjc3N9PC9zdHlsZT4KCiAgICAgICAgICAgIDxBcHBDb250YWluZXIgb25CYWNrZ3JvdW5kQ2xpY2s9e29uQmFja2dyb3VuZENsaWNrfT4KICAgICAgICAgICAgICAgIDxXaW5kb3c+CiAgICAgICAgICAgICAgICAgICAge2NvbnRlbnR9CiAgICAgICAgICAgICAgICA8L1dpbmRvdz4KICAgICAgICAgICAgPC9BcHBDb250YWluZXI+CiAgICAgICAgPC8+CiAgICApCn0KCnJldHVybiBBcHA7JwDC1tX0D7qGAQVhcHBJZAIEAMLW1fQP6sQBD2FiLWNvbW1hbmQtaGVscCcBBGJvdHMkMzE1YmU0ZGUtZjk2MC00NDA4LTgxMzItODFkOTI1NmNkZjljAScAwtbV9A/6xAEKb25Cb3RBZGRlZAIEAMLW1fQP+8QB0QxALyoqCiAqIExpc3RlbmVyU3RyaW5nIGlzIGEgZnVuY3Rpb24gdGhhdCBjYW4gdHVybiBhbnkgZnVuY3Rpb24gaW50byBhIENhc3VhbE9TIGxpc3RlbmVyIHRhZyBzdHJpbmcuCiAqLwpmdW5jdGlvbiBMaXN0ZW5lclN0cmluZyhmdW5jKSB7CiAgICBpZiAodHlwZW9mIGZ1bmMgPT09ICdzdHJpbmcnICYmIGZ1bmNbMF0gPT09ICdAJykgewogICAgICAgIC8vIElzIGFscmVhZHkgYSBsaXN0ZW5lciBzdHJpbmcuCiAgICAgICAgcmV0dXJuIGRlZGVudChmdW5jKTsKICAgIH0KCiAgICBpZiAodHlwZW9mIGZ1bmMgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYExpc3RlbmVyU3RyaW5nIGNhbiBvbmx5IGNvbnZlcnQgZnVuY3Rpb24gb2JqZWN0cyB0byBzdHJpbmdzLmApOwogICAgfQoKICAgIGNvbnN0IGZ1bmNTdHJpbmcgPSBmdW5jLnRvU3RyaW5nKCk7CiAgICAKICAgIGlmIChmdW5jU3RyaW5nLmluY2x1ZGVzKCc9PicpKSB7CiAgICAgICAgLy8gSGFuZGxlIGFycm93IGZ1bmN0aW9ucwogICAgICAgIGNvbnN0IGFycm93SW5kZXggPSBmdW5jU3RyaW5nLmluZGV4T2YoJz0+Jyk7CiAgICAgICAgY29uc3QgYWZ0ZXJBcnJvdyA9IGZ1bmNTdHJpbmcuc3Vic3RyaW5nKGFycm93SW5kZXggKyAyKS50cmltKCk7CiAgICAgICAgCiAgICAgICAgaWYgKGFmdGVyQXJyb3cuc3RhcnRzV2l0aCgneycpKSB7CiAgICAgICAgICAgIC8vIEFycm93IGZ1bmN0aW9uIHdpdGggYmxvY2sgYm9keQogICAgICAgICAgICBjb25zdCBtYXRjaCA9IGFmdGVyQXJyb3cubWF0Y2goL1x7KFtcc1xTXSopXH0vKTsKICAgICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZGVkZW50KCdAJyArIG1hdGNoWzFdLnRyaW0oKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBBcnJvdyBmdW5jdGlvbiB3aXRoIGNvbmNpc2UgYm9keQogICAgICAgICAgICByZXR1cm4gZGVkZW50KCdAJyArIGFmdGVyQXJyb3cpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSGFuZGxlIHJlZ3VsYXIgZnVuY3Rpb25zCiAgICAgICAgY29uc3QgbWF0Y2ggPSBmdW5jU3RyaW5nLm1hdGNoKC9ceyhbXHNcU10qKVx9Lyk7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIHJldHVybiBkZWRlbnQoJ0AnICsgbWF0Y2hbMV0udHJpbSgpKTsKICAgICAgICB9CiAgICB9Cn0KCi8vIEV4dGVuZCBGdW5jdGlvbiBwcm90b3R5cGUgdG8gaW5jbHVkZSBhIC50b0xpc3RlbmVyU3RyaW5nKCkgZnVuY3Rpb24uCi8vIE5vdyB5b3UgY2FuIGNhbGwgLnRvTGlzdGVuZXJTdHJpbmcoKSBvbiBhbnkgZnVuY3Rpb24gYW5kIGhhdmUgaXQgY29udmVydGVkIHRvIGEgbGlzdGVuZXIgc3RyaW5nLgpPYmplY3QuZGVmaW5lUHJvcGVydHkoRnVuY3Rpb24ucHJvdG90eXBlLCAndG9MaXN0ZW5lclN0cmluZycsIHsKICAgIHZhbHVlOiBmdW5jdGlvbigpIHsgcmV0dXJuIExpc3RlbmVyU3RyaW5nKHRoaXMpIH0sCiAgICB3cml0YWJsZTogdHJ1ZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgIGVudW1lcmFibGU6IGZhbHNlLAp9KTsKCmdsb2JhbFRoaXMuTGlzdGVuZXJTdHJpbmcgPSBMaXN0ZW5lclN0cmluZzsnAMLW1fQP+sQBCW9uRGVzdHJveQIEAMLW1fQPzdEBTkBkZWxldGUgZ2xvYmFsVGhpcy5MaXN0ZW5lclN0cmluZzsKZGVsZXRlIEZ1bmN0aW9uLnByb3RvdHlwZS50b0xpc3RlbmVyU3RyaW5nOycAwtbV9A/6xAEGc3lzdGVtAgQAwtbV9A+c0gEYYWIuc2hlbGwubGlzdGVuZXJfc3RyaW5nJwDC1tX0D/rEAQhhYklnbm9yZQIEAMLW1fQPtdIBBHRydWUnAMLW1fQP+sQBB2FiU2hlbGwCBADC1tX0D7rSAQR0cnVlJwDC1tX0D/rEAQlhYlZlcnNpb24CBADC1tX0D7/SAQUxMC4zNycBBGJvdHMkMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczAScAwtbV9A/F0gEGc3lzdGVtAgQAwtbV9A/G0gEPYWIuc2hlbGwuY3JlYXRlJwDC1tX0D8XSAQRmb3JtAgQAwtbV9A/W0gEHbm90aGluZycAwtbV9A/F0gELZGVzY3JpcHRpb24CBADC1tX0D97SAT1Cb3QgdXNlZCB0byBjcmVhdGUvbWFuaWZlc3QgYm90cyBpbnRvIGFuIGFjdHVhbCBzY2VuZS9wb3J0YWwuJwDC1tX0D8XSAQxhYkNyZWF0ZUJvdHMCBADC1tX0D5zTAe4vQGxldCB7IAogICAgaW5pdGlhbEJvb3QsIC8vIGNoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4gKG9wdGlvbmFsKQogICAgYm90RGF0YSwgLy8gYm90cyB0byBiZSBnZW5lcmF0ZWQKICAgIG9yaWdpbiwgLy8gd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCiAgICBzdHVkaW8sIC8vIHdoYXQgc3R1ZGlvIGlzIHRoaXMgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgIHJlY29yZCwgLy8gUnlhbiBDb29rOiBkbyB3ZSBuZWVkIHRoaXMgaWYgd2UgYWxyZWFkeSBoYXZlIHN0dWRpbz8gKG9wdGlvbmFsKQogICAgdmVyc2lvbiwgLy8gdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCiAgICBlZ2dQYXJhbWV0ZXJzLCAvLyBkYXRhIHRvIHBhc3MgdG8gYWxsIGNyZWF0ZWQgYm90cyB2aWEgQG9uRWdnSGF0Y2guIChvcHRpb25hbCkKICAgIGlnbm9yZUdyaWRGb2N1cywgLy8gUnlhbiBDb29rOiBhZGRpbmcgdGhpcyBhcyBhbiBvcHRpb25hbCBmbGFnLiAob3B0aW9uYWwpCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIC8vIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIHRoZSBib3RzIGFyZSBjcmVhdGVkLiAob3B0aW9uYWwpCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsIHRvIGFiQ3JlYXRlQm90cy4gKG9wdGlvbmFsKS4KfSA9IHRoYXQ7CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBmb3Igd2hlbiBhYkNyZWF0ZUJvdHMgZXhwZWN0ZWQgImJvdHMiIHBhcmFtZXRlci4KaWYgKCFib3REYXRhICYmIHRoYXQuYm90cykgewogICAgYm90RGF0YSA9IHRoYXQuYm90czsKfQoKbGV0IGJvdENvdW50ID0gT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoOwpjb25zdCBib3REYXRhSGFzaE9yaWdpbmFsID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90RGF0YSk7CmNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCi8vIFJ1biBzb21lIGFiLXNwZWNpZmljIHByZXByb2Nlc3Npbmcgb2YgYm90IGRhdGEuCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIGRhdGEudGFncy5hYklET3JpZ2luID0gb3JpZ2luOwogICAgICAgIGRhdGEudGFncy5hYklEU3R1ZGlvID0gc3R1ZGlvOwoKICAgICAgICBpZiAoZGF0YS50YWdzLmNyZWF0b3IpIHsKICAgICAgICAgICAgZGF0YS50YWdzLm9sZENyZWF0b3IgPSBkYXRhLnRhZ3MuY3JlYXRvcjsKICAgICAgICB9CgogICAgICAgIC8vIFJ5YW4gQ29vazogVGhpcyB0YXJnZXRQb3NpdGlvbiBzdHVmZiBpcyBhcHBhcmVudGx5IHVzZWQgZm9yIGJvdCBwYXN0aW5nPyAKICAgICAgICAvLyBUaGlzIGlzIHNvbWUgcmVhbGx5IGNvbmZ1c2luZyBsb2dpYyBhbmQgc2hvdWxkIGJlIHJlZmFjdG9yZWQgZXZlbnR1YWxseS4KICAgICAgICBpZiAoKGJvdENvdW50IDwgMiB8fCBib3RDb3VudCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uICsgJ1gnXSA9IGFiR3JpZEZvY3VzLnBvc2l0aW9uLng7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWSddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueTsKICAgICAgICB9CiAgICB9Cn0KCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlYSBjcmVhdGVkLgpsZXQgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZScsIHByZXByb2Nlc3NBcmcpKTsKCmlmICh0eXBlb2YgYm90RGF0YSAhPT0gJ29iamVjdCcgfHwgT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoID09PSAwKSB7CiAgICAvLyBUaGVyZSBpc24ndCBhbnkgYm90RGF0YSB0byBjcmVhdGUgZnJvbSEKICAgIHJldHVybjsKfQoKLy8gQ3JlYXRlIGJvdHMgZnJvbSB0aGUgYm90IGRhdGEuCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKbGV0IG5ld0JvdElkcyA9IFtdOwoKZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgdHJ5IHsgCiAgICAgICAgICAgIGNvbnN0IG5ld0JvdCA9IGNyZWF0ZShkYXRhLnRhZ3MpOwoKICAgICAgICAgICAgaWRNYXAuc2V0KGRhdGEuaWQsIG5ld0JvdC5pZCk7CiAgICAgICAgICAgIG5ld0JvdHMucHVzaChuZXdCb3QpOwogICAgICAgICAgICBuZXdCb3RJZHMucHVzaChuZXdCb3QuaWQpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbnZhbGlkIGJvdGAsIGUpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGVkIGJvdDogYCwgZGF0YSk7CiAgICB9Cn0KCi8vIEFycmF5IG9mIHRhZyByZWxhdGlvbnNoaXBzIHRvIGJlIHByZXNlcnZlZApjb25zdCBsaW5rVGFncyA9IFsibGluayIsICJjcmVhdG9yIiwgImNvbmZpZ0JvdCIsICJsaW5lVG8iLCAidHJhbnNmb3JtZXIiLCAiZm9ybUxpZ2h0VGFyZ2V0Il07CgovLyBUaGlzIGxvb3AgY29udGFpbnMgdGhlIGxvZ2ljIGZvciBwcmVzZXJ2aW5nIHRoZSBsaW5rVGFncwpmb3IgKGxldCBuZXdCb3Qgb2YgbmV3Qm90cykgewogICAgZm9yIChsZXQgdGFnIG9mIGxpbmtUYWdzKSB7CiAgICAgICAgbGV0IHZhbHVlID0gbmV3Qm90LnRhZ3NbdGFnXTsKCiAgICAgICAgaWYgKHRhZyA9PSAiY3JlYXRvciIpIHsKICAgICAgICAgICAgdmFsdWUgPSBuZXdCb3QudGFncy5vbGRDcmVhdG9yOwogICAgICAgICAgICBuZXdCb3QudGFncy5vbGRDcmVhdG9yID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUJvdExpbmtzKG5ld0JvdCwgaWRNYXApOwoKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBsZXQgbmV3VmFsdWUgPSB2YWx1ZS5tYXAoaWQgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpZE1hcC5nZXQoaWQpIHx8IGlkOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lEID0gaWRNYXAuZ2V0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3SUQpIHsKICAgICAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdJRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy8gVG9hc3RzIGZvciBoYXRjaGVzLCBidXQgb25seSBvbiBidWlsZGVyCmlmIChvcmlnaW4gJiYgdmVyc2lvbiAmJiBjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUgPT0gbnVsbCAmJiAhY29uZmlnQm90LnRhZ3MucGggJiYgYnVpbGRlclZlcnNpb24gPT0gImJ1aWxkZXIiKSB7CiAgICBvcy50b2FzdCgiaGF0Y2hlZCAiICsgb3JpZ2luICsgIiB2IiArIHZlcnNpb24pOwp9CgovLyBDcmVhdGUgYWJFZ2cgYm90IHRoYXQgdHJhY2tzIGNhbiBiZSB1c2VkIHRvIHRyYWNrIHdoYXQgZWdncyBoYXZlIGJlZW4gaGF0Y2hlZC4KbGV0IGFiRWdnTGFiZWw7CgppZiAob3JpZ2luKSB7CiAgICBpZiAodmVyc2lvbikgewogICAgICAgIGFiRWdnTGFiZWwgPSBgJHtvcmlnaW59IHYke3ZlcnNpb259YDsKICAgIH0gZWxzZSB7CiAgICAgICAgYWJFZ2dMYWJlbCA9IG9yaWdpbjsKICAgIH0KfSBlbHNlIHsKICAgIGFiRWdnTGFiZWwgPSAndW5rbm93bic7Cn0KCmNvbnN0IGFiRWdnID0gY3JlYXRlKHsKICAgIHNwYWNlOiAic2hhcmVkIiwKICAgIGFiOiB0cnVlLAogICAgYWJFZ2c6IHRydWUsCiAgICBhYklnbm9yZTogdHJ1ZSwKICAgIG9yaWdpbl9hYjogb3JpZ2luLAogICAgb3JpZ2luX3ZlcnNpb246IHZlcnNpb24sCiAgICBvcmlnaW5fcmVjb3JkOiByZWNvcmQsCiAgICBvcmlnaW5fc3R1ZGlvOiBzdHVkaW8sCiAgICBjcmVhdGVkVGltZXN0YW1wOiBEYXRlVGltZS5mcm9tTWlsbGlzKG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUpLAogICAgYm90SWRzOiBg8J+nrCR7SlNPTi5zdHJpbmdpZnkobmV3Qm90SWRzKX1gLAogICAgYm90RGF0YUhhc2hPcmlnaW5hbCwKICAgIHNvdXJjZUV2ZW50LAogICAgaW5zdDogYWIudGFncy5hYkluc3QsCiAgICBmb3JtOiAiZWdnIiwKICAgIGVnZ1BhcmFtZXRlcnM6IGVnZ1BhcmFtZXRlcnMgPyBg8J+nrCR7SlNPTi5zdHJpbmdpZnkoZWdnUGFyYW1ldGVycyl9YCA6IG51bGwsCiAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgIGxhYmVsOiBhYkVnZ0xhYmVsLAogICAgaGF0Y2hlclJlbW90ZUlkOiBjb25maWdCb3QuaWQsCn0pOwoKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47Cgp3aGlzcGVyKG5ld0JvdHMsICdvblByZUhhdGNoJywgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOwoKaWYgKGluaXRpYWxCb290KSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy8gb25FZ2dIYXRjaCBmb3IgYWxsIGp1c3QgaGF0Y2hlZCBib3RzCndoaXNwZXIobmV3Qm90cywgIm9uRWdnSGF0Y2giLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgZWdnUGFyYW1ldGVycywgc291cmNlRXZlbnQgfSk7CgovLyBvbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQUJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKc3VwZXJTaG91dCgib25BYkFkZGVkIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCmlmIChvcy5pc0NvbGxhYm9yYXRpdmUoKSkgewogICAgLy8gUmVtb3RlIHNob3V0IHRvIGFsbCBvdGhlciBjb25uZWN0ZWQgcmVtb3RlcyB0aGF0IGEgcmVtb3RlIGhhcyBhZGRlZCBhbiBhYi4KICAgIGNvbnN0IHJlbW90ZUlkcyA9IGF3YWl0IG9zLnJlbW90ZXMoKTsKICAgIGNvbnN0IHNlbGZJbmRleCA9IHJlbW90ZUlkcy5pbmRleE9mKGNvbmZpZ0JvdC5pZCk7CiAgICBpZiAoc2VsZkluZGV4ID4gMCkgewogICAgICAgIHJlbW90ZUlkcy5zcGxpY2Uoc2VsZkluZGV4LCAxKTsKICAgIH0KCiAgICBzZW5kUmVtb3RlRGF0YShyZW1vdGVJZHMsICdyZW1vdGVfYWJfYWRkZWQnLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQsIGFiRWdnSWQ6IGFiRWdnLmlkIH0pOwoKfQoKcmV0dXJuIG5ld0JvdHM7JwDC1tX0D8XSAQhyZW1lbWJlcgIEAMLW1fQPh4MCKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMLW1fQPxdIBCGFiSWdub3JlAgQAwtbV9A+ugwIEdHJ1ZScAwtbV9A/F0gEHYWJTaGVsbAIEAMLW1fQPs4MCBHRydWUnAMLW1fQPxdIBCWFiVmVyc2lvbgIEAMLW1fQPuIMCBTEwLjM3JwDC1tX0D8XSAQtwZXJzb25hbGl0eQIEAMLW1fQPvoMCKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAMLW1fQPxdIBDG9uUmVtb3RlRGF0YQIEAMLW1fQP5YMC7gpAaWYgKHRoYXQubmFtZSA9PT0gJ3JlbW90ZV9hYl9hZGRlZCcpIHsKICAgIGNvbnN0IGFiRWdnSWQgPSB0aGF0LnRoYXQuYWJFZ2dJZDsKCiAgICBpZiAoYWJFZ2dJZCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhcnRpbmcgc2VhcmNoIGZvciBhYkVnZyBib3Qgd2l0aCBpZCAke2FiRWdnSWR9LCBFdmVudCBkYXRhOmAsIHRoYXQudGhhdCk7CiAgICAgICAgfQoKICAgICAgICAvLyBXYWl0IGZvciB0aGUgYWJFZ2cgYm90IHRvIGFycml2ZS4gT25jZSBpdCBoYXMsIHdlIHNob3VsZCBiZSBhYmxlIHRvIHNhZmVseSBzaG91dCBvblJlbW90ZUFCQWRkZWQgYW5kIGhhdmUgYWxsIHRoZSBib3RzIGluIHRoZSBpbnN0LgogICAgICAgIGxldCBhYkVnZyA9IGdldEJvdCgnaWQnLCBhYkVnZ0lkKTsKICAgICAgICBsZXQgYWNjdW1TZWFyY2hUaW1lID0gMDsKICAgICAgICBjb25zdCBNQVhfU0VBUkNIX1RJTUVfTVMgPSAyMDAwMDsKICAgICAgICBjb25zdCBTRUFSQ0hfSU5URVJWQUxfTVMgPSAyNTA7CiAgICAgICAgCiAgICAgICAgd2hpbGUoIWFiRWdnKSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnNsZWVwKFNFQVJDSF9JTlRFUlZBTF9NUyk7CgogICAgICAgICAgICBpZiAoYWNjdW1TZWFyY2hUaW1lIDw9IE1BWF9TRUFSQ0hfVElNRV9NUykgewogICAgICAgICAgICAgICAgYWNjdW1TZWFyY2hUaW1lICs9IFNFQVJDSF9JTlRFUlZBTF9NUzsKICAgICAgICAgICAgICAgIGFiRWdnID0gZ2V0Qm90KCdpZCcsIGFiRWdnSWQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlbW90ZV9hYl9hZGRlZCBldmVudCByZWNlaXZlZCBidXQgYWJFZ2dJZCAke2FiRWdnSWR9IG5ldmVyIGFycml2ZWQuYCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGFiRWdnKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIGFiRWdnIGJvdCB3aXRoIGlkICR7YWJFZ2dJZH1gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3VwZXJTaG91dCgnb25SZW1vdGVBQkFkZGVkJywgdGhhdC50aGF0KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZW1vdGVfYWJfYWRkZWQgZXZlbnQgcmVjZWl2ZWQgYnV0IG5vdCBhYkVnZ0lkIHdhcyBwcm92aWRlZC4gRXZlbnQgZGF0YTpgLCB0aGF0LnRoYXQpOwogICAgfQp9JwDC1tX0D8XSAQVkZWJ1ZwIEAMLW1fQP1I4CBWZhbHNlJwEEYm90cyQ1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYBJwDC1tX0D9qOAgZzeXN0ZW0CBADC1tX0D9uOAhBhYi5zaGVsbC52ZXJzaW9uJwDC1tX0D9qOAgRmb3JtAgQAwtbV9A/sjgIHbm90aGluZycAwtbV9A/ajgIIYWJJZ25vcmUCBADC1tX0D/SOAgR0cnVlJwDC1tX0D9qOAgdhYlNoZWxsAgQAwtbV9A/5jgIEdHJ1ZScAwtbV9A/ajgITYWJTaGVsbE1ham9yVmVyc2lvbgIEAMLW1fQP/o4CATMnAMLW1fQP2o4CDW9uU2tpbGxVcGRhdGUCBADC1tX0D4CPApcBQGNvbnN0IHZlcnNpb25TdHJpbmcgPSB0YWdzLmFiU2hlbGxNYWpvclZlcnNpb24gKyAiLiIgKyB0YWdzLmFiU2hlbGxNaW5vclZlcnNpb247DQoNCmNvbnNvbGUubG9nKCJbQUJTaGVsbF0gTG9hZGVkIEFCIHNoZWxsIHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAwtbV9A/ajgIJYWJWZXJzaW9uAgQAwtbV9A+YkAIFMTAuMzcnAMLW1fQP2o4CE2FiU2hlbGxNaW5vclZlcnNpb24CBADC1tX0D56QAgIzMicBBGJvdHMkNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmAScAwtbV9A+hkAIGc3lzdGVtAgQAwtbV9A+ikAIOYWIuc2hlbGwuc3RvcmUnAMLW1fQPoZACBGZvcm0CBADC1tX0D7GQAgdub3RoaW5nJwDC1tX0D6GQAgtkZXNjcmlwdGlvbgIEAMLW1fQPuZACP1RoaXMgc2tpbGwgaXMgbWVhbnQgdG8gYmUgYSBjb25maWd1cmFibGUgbWVhbnMgdG8gcHVibGlzaCBkYXRhLicAwtbV9A+hkAIPYWJQdWJsaXNoUmVjb3JkAgQAwtbV9A/5kALlC0Bhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nOwpsZXQgcmVjb3JkRGF0YSA9IHRoYXQuZGF0YTsKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CmxldCBlbmRwb2ludCA9IHRoYXQuZW5kcG9pbnQgPyB0aGF0LmVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgbWFya2VyU2V0ID0gdGhhdC5tYXJrZXJTZXQgPz8gbmV3IFNldCgpOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CmxldCB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdHJ1ZTsKCmlmICghcmVjb3JkRGF0YSkgewogICAgcmV0dXJuICJubyBkYXRhIHN1cHBsaWVkIjsKfQoKYXNzZXJ0KG1hcmtlclNldCBpbnN0YW5jZW9mIFNldCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXJrZXJTZXQgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBTZXRgKTsKCi8vIFtSeWFuIENvb2tdIEhBQ0s6IFRoZXJlIGFyZSBpc3N1ZXMgd2l0aCBjdXN0b20gbWFya2Vycy4gQ2xlYXIgYWxsIG9mIHRoZSBleGNlcHQgZm9yIHB1YmxpY1JlYWQuCm1hcmtlclNldC5jbGVhcigpOwoKaWYgKHB1YmxpY0ZhY2luZykgewogICAgbWFya2VyU2V0LmFkZCgncHVibGljUmVhZCcpOwp9CgpyZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7IGVuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogbWFya2VyU2V0LnNpemUgPiAwID8gQXJyYXkuZnJvbShtYXJrZXJTZXQpIDogdW5kZWZpbmVkIH0pOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb3JkRGF0YSByZXN1bHQ6YCwgcmVjb3JkRGF0YSk7Cn0KCmlmIChyZWNvcmREYXRhLnN1Y2Nlc3MpIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgZGF0YSBwdWJsaXNoZWQgdG8gcmVjb3JkICR7dXNlclJlY29yZH0gYXQgYWRkcmVzcyAke3JlY29yZE5hbWV9YCwgbG9nVHlwZTogJ2xvZycsIHRvYXN0OiB0b2FzdCB9KTsKfSBlbHNlIHsKICAgIGFiLmxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGRhdGEgZmFpbGVkIHRvIHB1Ymxpc2ggdG8gcmVjb3JkICR7dXNlclJlY29yZH0gYXQgYWRkcmVzcyAke3JlY29yZE5hbWV9XG4ke0pTT04uc3RyaW5naWZ5KHJlY29yZERhdGEsIHVuZGVmaW5lZCwgMil9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKCiAgICBpZiAodG9hc3QpIHsKICAgICAgICBhYi5saW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYGRhdGEgZmFpbGVkIHRvIHB1Ymxpc2ggdG8gcmVjb3JkICR7dXNlclJlY29yZH0gYXQgYWRkcmVzcyAke3JlY29yZE5hbWV9LiAke3JlY29yZERhdGEuZXJyb3JNZXNzYWdlfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICB9Cn0KCnJldHVybiByZWNvcmREYXRhOycAwtbV9A+hkAINYWJQdWJsaXNoRmlsZQIEAMLW1fQP35wCsQ1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghdGhpc0JvdC5jYW5QdWJsaXNoRmlsZSgpKSB7CiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIGVycm9yQ29kZTogJ25vdF9hdXRob3JpemVkJywKICAgICAgICBlcnJvck1lc3NhZ2U6ICdVc2VyIGlzIG5vdCBhdXRob3JpemVkIHRvIHB1Ymxpc2ggZmlsZXMuJwogICAgfQp9CgpsZXQgZmlsZSA9IHRoYXQuZmlsZTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlTmFtZTsKbGV0IG1pbWVUeXBlID0gdGhhdC5taW1lVHlwZTsKbGV0IG1hcmtlclNldCA9IHRoYXQubWFya2VyU2V0ID8/IG5ldyBTZXQoKTsKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nID8/IHRydWU7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghZmlsZSkgewogICAgcmV0dXJuIHsKICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICBlcnJvckNvZGU6ICdpbnZhbGlkX2ZpbGVfZGF0YScsCiAgICAgICAgZXJyb3JNZXNzYWdlOiAnQSBmaWxlIG11c3QgYmUgcHJvdmlkZWQgdG8gcHVibGlzaC4nCiAgICB9Cn0KCmFzc2VydChtYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CgovLyBbUnlhbiBDb29rXSBIQUNLOiBUaGVyZSBhcmUgaXNzdWVzIHdpdGggY3VzdG9tIG1hcmtlcnMuIENsZWFyIGFsbCBvZiB0aGUgZXhjZXB0IGZvciBwdWJsaWNSZWFkLgptYXJrZXJTZXQuY2xlYXIoKTsKCmlmIChwdWJsaWNGYWNpbmcpIHsKICAgIG1hcmtlclNldC5hZGQoJ3B1YmxpY1JlYWQnKTsKfQoKbGV0IGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHsgZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUsIG1hcmtlcnM6IG1hcmtlclNldC5zaXplID4gMCA/IEFycmF5LmZyb20obWFya2VyU2V0KSA6IHVuZGVmaW5lZCB9KTsKCmlmICghZmlsZVVwbG9hZC5zdWNjZXNzKSB7CiAgICBpZiAoZmlsZVVwbG9hZC5lcnJvckNvZGUgPT0gImZpbGVfYWxyZWFkeV9leGlzdHMiKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmlsZSBhbHJlYWR5IGV4aXN0cyBpbiAke3VzZXJSZWNvcmR9YCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgcmV0dXJuIGZpbGVVcGxvYWQ7CiAgICB9CgogICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHVzZXJSZWNvcmQpOwoKICAgIGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHsgZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUsIG1hcmtlcnM6IG1hcmtlclNldC5zaXplID4gMCA/IEFycmF5LmZyb20obWFya2VyU2V0KSA6IHVuZGVmaW5lZCB9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykgewogICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZmlsZSByZWNvcmRlZCB0byAke3VzZXJSZWNvcmR9YCwgbG9nVHlwZTogJ2xvZycgfSk7Cn0KZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmaWxlIGZhaWxlZCB0byByZWNvcmRgLCBsb2dUeXBlOiAnZXJyb3InIH0pOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAMLW1fQPoZACEGFiQ29yZU1lbnVBY3Rpb24CBADC1tX0D5GqAk1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAwtbV9A+hkAILb25TdG9yZU1lbnUCBADC1tX0D9+qAo2YAUBsZXQgcG9zc2libGVQdWJsaXNoQm90ID0gbmV3IFNldCgpOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cykgewogICAgaWYgKEFycmF5LmlzQXJyYXkobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSkgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cy5mb3JFYWNoKGIgPT4gcG9zc2libGVQdWJsaXNoQm90LmFkZChiKSk7CiAgICB9IGVsc2UgewogICAgICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKTsKICAgIH0KfQoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIHsKICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyk7Cn0KCnBvc3NpYmxlUHVibGlzaEJvdCA9IEFycmF5LmZyb20ocG9zc2libGVQdWJsaXNoQm90KTsKCmNvbnN0IGJhc2VBQiA9ICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzID8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMuaWQ7CmNvbnN0IGJhc2VCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBiYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgZGVmYXVsdHMgPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBtYW5hZ2VyOiAi8J+UlyIgKyB0aGlzQm90LmlkLAogICAgbWFuaWZlc3RhdGlvbjogdGFncy5tYW5pZmVzdGF0aW9uLAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAKfQoKLy8gQ3JlYXRlIGRvd25sb2FkIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgIGxhYmVsOiAiZG93bmxvYWQiLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm1BZGRyZXNzOiAiZ2V0X2FwcCIsCiAgICBwb3NzaWJsZUJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYkRvd25sb2FkKHsgcG9zc2libGVCb3RzOiBsaW5rcy5wb3NzaWJsZUJvdCwgc291cmNlRXZlbnQ6ICdhYl9zdG9yZV9tZW51X2Rvd25sb2FkJyB9KTtgCn0pOwoKaWYgKCFhdXRoQm90KSAKewogICAgLy8gQ3JlYXRlIGxvZ2luIG1lc3NhZ2UKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICAgICAgbGFiZWw6ICJwbGVhc2Ugc2lnbiBpbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIsCiAgICAgICAgb25DbGljazogYEAgb3MucmVxdWVzdEF1dGhCb3QoKWAKICAgIH0pOwoKICAgIHJldHVybjsKfQplbHNlIGlmIChhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciA9PSAiRnJlZVBsYXkiKSAKewogICAgLy8gQ3JlYXRlIHVwZ3JhZGUgc3Vic2NyaXB0aW9uIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAicGxlYXNlIHVwZ3JhZGUgeW91ciBzdWJzY3JpcHRpb24gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siCiAgICB9KTsKCiAgICByZXR1cm47Cn0KCgpsZXQgdXNlclN0dWRpb3MgPSBjb25maWdCb3QudGFncy51c2VyX3N0dWRpb3M7CgppZiAoIXVzZXJTdHVkaW9zKSAKewogICAgdXNlclN0dWRpb3MgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsKfQoKaWYgKHVzZXJTdHVkaW9zLnN1Y2Nlc3MpIAp7CiAgICBjb25zdCBhY3RpdmVTdHVkaW8gPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKTsKCiAgICBsZXQgYmFzZVN0dWRpbyA9IGF1dGhCb3QuaWQ7CgogICAgaWYgKGJhc2VTdHVkaW8gPT0gYXV0aEJvdC5pZCkgCiAgICB7CiAgICAgICAgYmFzZVN0dWRpbyA9ICJwbGF5ZXIiOwogICAgfQoKICAgIGlmIChhY3RpdmVTdHVkaW8gPT0gLTEgJiYgYmFzZVN0dWRpbyAhPSAicGxheWVyIikgCiAgICB7CiAgICAgICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBiYXNlU3R1ZGlvOwogICAgfQoKICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8gJiYgIWFjdGl2ZVN0dWRpbykgCiAgICB7CiAgICAgICAgY29uc3Qgc3R1ZGlvTWF0Y2ggPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbykKCiAgICAgICAgaWYgKHN0dWRpb01hdGNoICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2VTdHVkaW8gPSBiYXNlU3R1ZGlvOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBzdHVkaW9MYWJlbCA9IGFjdGl2ZVN0dWRpbyA9PSAtMSA/IGJhc2VTdHVkaW8gOiB1c2VyU3R1ZGlvcy5zdHVkaW9zW2FjdGl2ZVN0dWRpb10uZGlzcGxheU5hbWU7CgogICAgLy8gQ3JlYXRlIHN0dWRpbyBzZWxlY3QgYnV0dG9uCiAgICBjb25zdCBzdHVkaW9EaXNwbGF5QnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAic3R1ZGlvPSIgKyBzdHVkaW9MYWJlbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNSwKICAgICAgICBzdHVkaW9JbmZvcm1hdGlvbjogdXNlclN0dWRpb3MsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJpbnZlbnRvcnlfMiIsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5zdHVkaW9TZWxlY3QodGFncy5zdHVkaW9JbmZvcm1hdGlvbik7YAogICAgfSk7CgogICAgbWFza3Muc3R1ZGlvU2VsZWN0QnV0dG9uID0gZ2V0TGluayhzdHVkaW9EaXNwbGF5QnV0dG9uKTsKfQoKY29uc3QgdG90YWxCb3RDb3VudCA9IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggPiAwID8gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGg7CgovLyBDcmVhdGUgcHVibGlzaCBsYWJlbCBidXR0b24KY29uc3QgbGFiZWxCb3QgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGxhYmVsOiBgcHVibGlzaCBwYXR0ZXJuICR7YmFzZUJvdHMubGVuZ3RoID4gMCA/ICIiIDogImFzICJ9JHtiYXNlQUJ9ICgke3RvdGFsQm90Q291bnR9IGJvdCR7YmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICB0b3RhbEJvdHM6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGgsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBmb3JtQWRkcmVzczogbnVsbCwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHggOHB4IDBweCAwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci10b3Atc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBzaGlmdFN0YXRlOiBmYWxzZSwKICAgIG9uQ2xpY2s6IGBAIGNvbnN0IG1lbnVCb3RzID0gZ2V0Qm90cygnYWJNZW51U29ydE9yZGVyJyk7CgogICAgICAgIGlmICh0YWdzLnNoaWZ0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlVcCIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5RG93biIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGFncy5zaGlmdFN0YXRlID0gIXRhZ3Muc2hpZnRTdGF0ZTtgLAogICAgc2NhbGVZOiAiYXV0byIsCiAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBsZXQgdG90YWxCb3RzID0gY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID8gdGhhdC5hYkJvdHMgOiB0aGF0LmFiQm90cyArIHRoYXQubm9uQUJCb3RzOwoKICAgIGNvbnN0IHRvdGFsQm90VmFyID0gdG90YWxCb3RzID09IDEgPyAiIGJvdCIgOiAiIGJvdHMiOwogICAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHM/Lmxlbmd0aCAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIGlmIChnZXRCb3QoImFiSURPcmlnaW4iLCBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQikpCiAgICAgICAgewogICAgICAgICAgICBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpLmxlbmd0aDsKCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgYWJCb3RzICsgIiBib3RzKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gYWJCb3RzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggcGF0dGVybiBhcyAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgICAgIH0gICAKICAgIH0KICAgIGVsc2UKICAgIHsgICAKICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIHRoYXQuYWIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICB9YAp9KTsKCi8vIENyZWF0ZSBlbmNyeXB0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICBsYWJlbDogImVuY3J5cHQiLAogICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICBlbmNyeXB0U3RhdGU6IGZhbHNlLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgaWYodGFncy5lbmNyeXB0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gdHJ1ZTsKICAgICAgICB9YCwKfSk7CgpsZXQgYWJCdXR0b247CgppZiAocG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvLyBDcmVhdGUgaW5jbHVkZUJvdHMgYnV0dG9uCiAgICBhYkJ1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTIsCiAgICAgICAgYWJTZWxlY3Rpb25CdXR0b246IHRydWUsCiAgICAgICAgbGFiZWw6IGJhc2VCb3RzLmxlbmd0aCA+IDAgJiYgYmFzZUFCICE9IHVuZGVmaW5lZCA/IGBzZWxlY3RlZCBwYXR0ZXJuOiAke2Jhc2VBQn0gKCR7YmFzZUJvdHMubGVuZ3RofSBib3Qke2Jhc2VCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAgOiBgbmV3IHBhdHRlcm4gKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogJ2VnZycsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaFNlbGVjdCgpO2AsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyTm9uID0gdGhhdC5ub25BQkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgY29uc3QgYm90VmFyQUIgPSB0aGF0LmFiQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICAgICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSB0aGF0LmFiICsgIiAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyTm9uOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInNlbGVjdGVkIHBhdHRlcm46ICIgKyB0aGF0LmFiICsgIiAoIiArIHRoYXQuYWJCb3RzICsgYm90VmFyQUI7CiAgICAgICAgfWAKICAgIH0pOwp9CgppZiAobm9uQUJCb3RzLmxlbmd0aCA+IDAgJiYgcG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvL2ljbHVkZSBuZXcgYm90cwogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTMsCiAgICAgICAgYWJCdXR0b246IGdldExpbmsoYWJCdXR0b24pLAogICAgICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgICAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgICAgIGxhYmVsOiBgaW5jbHVkZSBuZXcgKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveCIsCiAgICAgICAgdW5jbGFpbWVkU3RhdGU6IGZhbHNlLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CgogICAgICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IGxpbmtzLmFiQnV0dG9uLnRhZ3MubGFiZWw7CgogICAgICAgICAgICAgICAgaWYgKGxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGFncy51bmNsYWltZWRTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25BQkJvdHMubGVuZ3RofSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwoKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IHRydWU7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogMH0pOwogICAgICAgICAgICB9YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cyA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIAogICAgICAgICAgICB0YWdzLmxhYmVsID0gImluY2x1ZGUgbmV3ICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXI7CgogICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gdGhhdC5hYjsKCiAgICAgICAgICAgIGlmKCFsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHB1YmxpYyBidXR0b24KaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSAKewogICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gZmFsc2U7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgICAgICBsYWJlbDogImlzUHVibGljIiwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgICAgICBwdWJsaWNTdGF0ZTogZmFsc2UsCiAgICAgICAgb25DbGljazogYEAgaWYodGFncy5wdWJsaWNTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSB0cnVlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSB2ZXJzaW9uIHNlbGVjdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgbGFiZWw6ICd2ZXJzaW9uRmxhZz1jdXJyZW50JywKICAgIGZvcm1BZGRyZXNzOiAnYWx0X3JvdXRlJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBzaG91dCgnc2hvd1ZlcnNpb25TZWxlY3RvcicpO2AsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAndmVyc2lvbkZsYWc9JyArIHRoYXQ7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICBgLAp9KTsKCi8vIEN1cnJlbnQgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnY3VycmVudCcsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gRmVlZGJhY2sgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnZmVlZGJhY2snLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnZmVlZGJhY2snOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIFN0YWJsZSBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdzdGFibGUnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTIsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnc3RhYmxlJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBDcmVhdGUgcHVibGlzaCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDQsCiAgICBmb3JtQWRkcmVzczogImVnZyIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCA4cHggOHB4IiwKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItYm90dG9tLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAke2FiUGVyc29uYWxpdHkudGFncy5hYkJhc2VTaGFkb3dDb2xvcn0iLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm06ICJpbnB1dCIsCiAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICBvbklucHV0VHlwaW5nOiBgQCBsaW5rcy5sYWJlbEJvdC50YWdzLmxhYmVsID0gJ3B1Ymxpc2ggcGF0dGVybiBhcyAnICsgdGhhdC50ZXh0ICsgJyAoJyArIGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzICsgJyBib3QnICsgKGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzID09IDEgPyAnKScgOiAncyknKTtgLAogICAgbWVudUl0ZW1TaG93U3VibWl0V2hlbkVtcHR5OiB0cnVlLAogICAgdGFyZ2V0Qm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBtZW51SXRlbVRleHQ6IGJhc2VBQiwKICAgIG9uU3VibWl0OiBgQAogICAgICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQudGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgY29uZmlybVB1c2ggPSBmYWxzZTsKICAgICAgICAgICAgbGV0IGluWFIgPSBjb25maWdCb3QudGFncy5hckVuYWJsZWQgfHwgY29uZmlnQm90LnRhZ3MudnJFbmFibGVkOwoKICAgICAgICAgICAgaWYgKGluWFIpIHsKICAgICAgICAgICAgICAgIGNvbmZpcm1QdXNoID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgICAgICBjb25maXJtUHVzaCA9IGF3YWl0IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgICAgICAgICB0aXRsZTogImNvbmZpcm0gcHVibGlzaCIsCiAgICAgICAgICAgICAgICAgICAgY29udGVudDogInB1Ymxpc2ggIiArIHRoYXQudGV4dCArICIgdG8gIiArIHRhcmdldFN0dWRpbyArICI/IiwKICAgICAgICAgICAgICAgICAgICBjb25maXJtVGV4dDogInB1Ymxpc2giLAogICAgICAgICAgICAgICAgICAgIGNhbmNlbFRleHQ6ICJjYW5jZWwiCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFjb25maXJtUHVzaCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhhdC50ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaEFCKHsgYWI6IHRoYXQudGV4dCwgYm90OiBsaW5rcy50YXJnZXRCb3QsIGJhc2VBQjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIG1hbnVhbFB1Ymxpc2g6IHRydWUsIHNvdXJjZUV2ZW50OiAnc3RvcmVfbWVudScgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvcy50b2FzdCgiYWIgbm90IHNwZWNpZmllZCIpOwogICAgICAgICAgICB9CiAgICAgICAgYCwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIAogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gdGhhdC5hYjsKICAgIH1gCn0pOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIAp7CiAgICAvLyBDcmVhdGUgY29weSB0byBjbGlwYm9hcmQgYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA4LAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogImNvcHkgdG8gY2xpcGJvYXJkIiwKICAgICAgICBmb3JtQWRkcmVzczogImZpbGVfY29weSIsCiAgICAgICAgdGFyZ2V0Qm90OiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90Rm9jdXMsCiAgICAgICAgb25DbGljazogYEAgCiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwoKICAgICAgICAgICAgYWIubGlua3MucGFzdGUuYWJDb3B5Qm90c1RvQ2xpcGJvYXJkKHsgYm90czogW2xpbmtzLnRhcmdldEJvdF0sIHNvdXJjZUV2ZW50OiAnYWJfc3RvcmVfbWVudV9jb3B5X2NsaXBib2FyZCcgfSkKCiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIGAsCiAgICB9KTsKfQplbHNlIAp7CiAgICAvLyBDcmVhdGUgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEwLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsgICAgICAgICAgICAKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiR7YWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZVNoYWRvd0NvbG9yfSIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlU2hhZG93Q29sb3J9IiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogInNjYW4gdG8gcHVibGlzaCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJxcl9jb2RlX3NjYW5uZXIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gdHJ1ZTsgb3Mub3BlblFSQ29kZVNjYW5uZXIoKTtgLAogICAgfSk7Cn0KCmxldCBob3N0QnV0dG9uID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51U29ydE9yZGVyOiA1MCwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGZvcm1BZGRyZXNzOiAiZ3JvdXBfYWRkIiwKICAgIGxlYXJuOiB0YWdzLmxlYXJuLAogICAgb25DbGljazogYEAgCiAgICAgICAgbGlua3MubGVhcm4uYWJDcmVhdGVIb3N0KHRoaXNCb3QpOwogICAgICAgIGlmICghYWIubGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKICAgICAgICB9CiAgICBgLAp9OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSB7CiAgICBob3N0QnV0dG9uLmxhYmVsID0gImpvaW4gY29kZTogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEOwp9IGVsc2UgewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJnZW5lcmF0ZSBqb2luIGNvZGUiOwp9CgppZiAoY29uZmlnQm90LnRhZ3Muc3RhdGljSW5zdCA9PSB1bmRlZmluZWQpCnsKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGhvc3RCdXR0b24pOy8vZ2VuZXJhdGUgYSBob3N0IGJ1dHRvbgp9JwDC1tX0D6GQAg5hYkNvcmVNZW51SWNvbgIEAMLW1fQP38IDCWlvc19zaGFyZScAwtbV9A+hkAIPYWJDb3JlTWVudUxhYmVsAgQAwtbV9A/pwgMFc2hhcmUnAMLW1fQPoZACE2FiQ29yZU1lbnVTb3J0T3JkZXICBADC1tX0D+/CAwEzJwDC1tX0D6GQAghyZW1lbWJlcgIEAMLW1fQP8cIDKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMLW1fQPoZACC2FiUHVibGlzaEFCAgQAwtbV9A+YwwO5P0BpZiAoIWF1dGhCb3QpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAibXVzdCBiZSBsb2dnZWQgaW4gdG8gcHVibGlzaCBwYXR0ZXJucy4iLCBsb2dUeXBlOiAiZXJyb3IiIH0pOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QuY2FuUHVibGlzaEZpbGUoKSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJtdXN0IGhhdmUgc3Vic2NyaXB0aW9uIHRoYXQgc3VwcG9ydHMgZmlsZSBwdWJsaXNoaW5nLiIsIGxvZ1R5cGU6ICJlcnJvciIgfSk7CiAgICByZXR1cm4gCn0KCmlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJwYXR0ZXJuIG5hbWVzIG1heSBub3QgY29udGFpbiBzcGFjZXMgb3IgcXVvdGFpb24gbWFya3MsIHBsZWFzZSB0cnkgYWdhaW4uIiwgbG9nVHlwZTogImVycm9yIiB9KTsKICAgIHJldHVybjsKfQoKCmxpbmtzLnV0aWxzLmFiTG9nKGBwdWJsaXNoaW5nICR7dGhhdC5hYn1gKTsKCmlmICghdGhhdC5rZWVwTWVudSkgewogICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKfQoKLy9hYiB2YXJpYWJsZXMKY29uc3QgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKY29uc3QgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpjb25zdCBiYXNlQUIgPSB0aGF0LmJhc2VBQiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPz8gKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQpOwpjb25zdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoID0gdGhhdC5vblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOyAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4gKG9wdGlvbmFsKQpjb25zdCBtYW51YWxQdWJsaXNoID0gdGhhdC5tYW51YWxQdWJsaXNoOwpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQuc291cmNlRXZlbnQ7IC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQpjb25zdCBlZ2dNYXJrZXJTZXQgPSB0aGF0LmVnZ01hcmtlclNldCA/PyBuZXcgU2V0KCk7CmNvbnN0IGF1eE1hcmtlclNldCA9IHRoYXQuYXV4TWFya2VyU2V0ID8/IG5ldyBTZXQoKTsKY29uc3Qgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmFzc2VydChlZ2dNYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CmFzc2VydChhdXhNYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXV4TWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7Cgpjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwoKZWdnTWFya2VyU2V0LmFkZCgnYWJFZ2cnKTsKZWdnTWFya2VyU2V0LmFkZChhYklEKTsKCmF1eE1hcmtlclNldC5hZGQoJ2FiQXV4Jyk7CmF1eE1hcmtlclNldC5hZGQoYWJJRCk7CgpsZXQgYnVzeUluZGljYXRvcjsKaWYgKG1hbnVhbFB1Ymxpc2ggJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkgewogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQogICAgCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHVwbG9hZGluZyAke3RoYXQuYWJ9YCwgb25EZXN0cm95OiBgQGNvbnNvbGUubG9nKCdidXN5IGluZGljYXRvciBnbyBib29tJylgfSk7Cn0KCi8vIExldCBhbGwgYm90cyBrbm93IHRoYXQgYWIgaXMgYWJvdXQgdG8gc3RhcnQgcHVibGlzaGluZy4KY29uc3QgYmVmb3JlUHVibGlzaEFyZyA9IHsgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nLCBzb3VyY2VFdmVudCB9Owphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJCZWZvcmVQdWJsaXNoJywgYmVmb3JlUHVibGlzaEFyZykpOwoKaWYgKCF0YXJnZXQgfHwgdGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgIGlmIChjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgJiYgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQikgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBhYklEKTsKCiAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiAmJiBnZXRCb3QoImFiSURPcmlnaW4iLCBiYXNlQUIpKSB7CiAgICAgICAgY29uc3QgZWdnQm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKTsKICAgICAgICBjb25zdCBuZXdCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCk7CgogICAgICAgIHRhcmdldCA9IFsuLi5lZ2dCb3RzLCAuLi5uZXdCb3RzXTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgfQoKICAgIHNldFRhZyh0YXJnZXQsICJhYklET3JpZ2luIiwgYWJJRCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IG51bGw7CgogICAgaWYgKHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgibm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIGlmICghdGhhdC5rZWVwTWVudSkgewogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikgewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkgewogICAgICAgIGtleUNoZWNrID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ2NvbmZpcm0gc2VjcmV0IGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBpZiAoa2V5ICE9IGtleUNoZWNrKSB7CiAgICAgICAgaWYgKCFrZXlDaGVjaykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBrZXkgZW50ZXJlZCIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoYXQua2VlcE1lbnUpIHsKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsgCiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGN1cnJlbnRCb3RJRCA9IHRhcmdldFtpXS5pZDsKICAgICAgICBsZXQgY3VycmVudEJvdERhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldFtpXSkpOwoKICAgICAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdERhdGE7CiAgICB9Cn0KZWxzZSB7CiAgICBzdGF0ZVt0YXJnZXQuaWRdID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0YXJnZXQpKTsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7IGFiSUQ6IGFiSUQgfSk7CgovL2FkZCB4cCBib3QgaGVyZQpzdGF0ZS5hYlhQQm90ID0gewogICAgc3BhY2U6ICJzaGFyZWQiLAogICAgaWQ6ICJhYlhQQm90IiwKICAgIHRhZ3M6IHsKICAgICAgICBmb3JtOiAibm90aGluZyIsCiAgICAgICAgc3lzdGVtOiAiYWIucGF0dGVybi5hYlhQQm90IiwKICAgICAgICBhdXRob3JJRDogYXV0aEJvdC5pZCwKICAgICAgICB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24sCiAgICAgICAgeHA6IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUCwKICAgICAgICBzaWduYXR1cmU6IGVnZ0NoZWNrLnNpZ25hdHVyZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgIH0KfTsKCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBhYiBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhOiBzdGF0ZSwgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nLCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gnLCBwcmVwcm9jZXNzQXJnKSk7CgovL2FkZGl0aW9uYWwgZmlsZSBkYXRhCmZvcm1hdHRlZEZpbGUudmVyc2lvbiA9IDE7CmZvcm1hdHRlZEZpbGUuc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwpmb3JtYXR0ZWRGaWxlLnN0YXRlID0gc3RhdGU7CgovL2FjdHVhbCBlbmNyeXB0aW9uIGlmIGNob3NlbgppZiAoa2V5KSB7CiAgICBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkoZm9ybWF0dGVkRmlsZSk7CiAgICBmb3JtYXR0ZWRGaWxlID0gY3J5cHRvLmVuY3J5cHQoa2V5LCBmb3JtYXR0ZWRGaWxlKTsKfQoKLy9wdWJsaXNoIHRoZSBmaWxlIGFuZCB0aGUgZWdnIHJlY29yZC4KbGV0IHB1Ymxpc2hGaWxlOwpsZXQgcHVibGlzaFJlY29yZDsKCnB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogdHJ1ZSwgbWFya2VyU2V0OiBhdXhNYXJrZXJTZXQgfSk7CgppZiAocHVibGlzaEZpbGUuc3VjY2VzcykgewogICAgLy9nYXRoZXIgYWRkaW9uYWwgZWdnIGRhdGEKICAgIGNvbnN0IGFpUGVybWl0Q2hlY2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhaV9wZXJtaXQiKTsKICAgIGNvbnN0IGFpUGVybWl0SUQgPSBhaVBlcm1pdENoZWNrLnN1Y2Nlc3MgPyBhaVBlcm1pdENoZWNrLmRhdGEucGVybWl0SUQgOiBmYWxzZTsKCiAgICBlZ2dDaGVjay5lZ2dEYXRhLmFpUGVybWl0ID0gYWlQZXJtaXRJRDsKICAgIGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkucHVzaChwdWJsaXNoRmlsZS51cmwpOwogICAgZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICBlZ2dDaGVjay5lZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKICAgIAogICAgLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKICAgIHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7IGRhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZywgbWFya2VyU2V0OiBlZ2dNYXJrZXJTZXQsIHRvYXN0OiBmYWxzZSB9KTsKfQoKaWYgKHB1Ymxpc2hGaWxlLnN1Y2Nlc3MgJiYgcHVibGlzaFJlY29yZC5zdWNjZXNzKSB7CiAgICAvL3B1Ymxpc2hpbmcgc2hvdXQKICAgIHN1cGVyU2hvdXQoIm9uQUJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOwogICAgc3VwZXJTaG91dCgib25BYlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7IC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoKICAgIGNvbnN0IGJpb3MgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwogICAgY29uc3QgaW5zdFR5cGUgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwoKICAgIHNldFRhZ01hc2sobGlua3MubGVhcm4sICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKCiAgICBpZiAobWFudWFsUHVibGlzaCkgewogICAgICAgIGxldCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKICAgICAgICBjb25zdCB1cmwgPSBzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICImc3R1ZGlvPSIgKyBzdHVkaW8gKyAiJmJpb3M9IiArIGJpb3M7CiAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKHVybCk7CgogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgd2l0aCBlbmNyeXB0ZWQgZGF0YSBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9CiAgICB9CgogICAgdHJ5IHsKICAgICAgICBhd2FpdCBhbmFseXRpY3MucmVjb3JkRXZlbnQoJ2FiX2VnZ19wdWJsaXNoJywgeyBhYjogYWJJRCwgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICB9Cn0KZWxzZSB7CiAgICBsZXQgZXJyb3JNZXNzYWdlOwoKICAgIGlmICghcHVibGlzaEZpbGUuc3VjY2VzcykgewogICAgICAgIGVycm9yTWVzc2FnZSA9IHB1Ymxpc2hGaWxlLmVycm9yTWVzc2FnZSA/PyBwdWJsaXNoRmlsZS5lcnJvckNvZGU7CiAgICB9IGVsc2UgaWYgKCFwdWJsaXNoUmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBlcnJvck1lc3NhZ2UgPSBwdWJsaWNoUmVjb3JkLmVycm9yTWVzc2FnZSA/PyBwdWJsaXNoUmVjb3JkLmVycm9yQ29kZTsKICAgIH0gZWxzZSB7CiAgICAgICAgZXJyb3JNZXNzYWdlID0gJ1Vua25vd24gcmVhc29uJzsKICAgIH0KCiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiBgUHVibGlzaGluZyBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWAsCiAgICAgICAgbG9nVHlwZTogJ2Vycm9yJywKICAgICAgICB0b2FzdDogIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZQogICAgfSkKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBwdWJsaXNoUmVjb3JkOycAwtbV9A+hkAIIYWJJZ25vcmUCBADC1tX0D9KCBAR0cnVlJwDC1tX0D6GQAgphYkRvd25sb2FkAgQAwtbV9A/XggS5FUBjb25zdCBwb3NzaWJsZUJvdHMgPSB0aGF0Py5wb3NzaWJsZUJvdHM7CmxldCBmaWxlbmFtZSA9IHRoYXQ/LmZpbGVuYW1lOwpsZXQgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKbGV0IG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ7CmxldCBsb2cgPSB0aGF0Py5sb2cgPz8gdHJ1ZTsKbGV0IHJlb3BlbkFiTWVudSA9IHRoYXQ/LnJlb3BlbkFiTWVudSA/PyB0cnVlOwoKLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byBkb3dubG9hZCBib3RzLgpjb25zdCBiZWZvcmVEb3dubG9hZEFyZyA9IHsgZmlsZW5hbWUsIHNvdXJjZUV2ZW50IH07CmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZURvd25sb2FkJywgYmVmb3JlRG93bmxvYWRBcmcpKTsKCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zdCBzaG91bGREb3dubG9hZEluc3QgPSAhcG9zc2libGVCb3RzIHx8IChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykgJiYgcG9zc2libGVCb3RzLmxlbmd0aCA9PT0gMCk7CgppZiAoc2hvdWxkRG93bmxvYWRJbnN0KSB7CiAgICAvLyBEb3dubG9hZCBpbnN0LgogICAgZG93bmxvYWRCb3RzID0gZ2V0Qm90cyhiID0+ICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOwoKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgIH0KCiAgICBpZiAobG9nKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGluc3QnKTsKICAgIH0KfSBlbHNlIHsKICAgIGlmIChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykpIHsKICAgICAgICAvLyBEb3dubG9hZCBib3RzLgogICAgICAgIGRvd25sb2FkQm90cyA9IHBvc3NpYmxlQm90czsKICAgICAgICBjb25zdCBib3RJZHMgPSBwb3NzaWJsZUJvdHMubWFwKGIgPT4gYi5pZCkuc29ydCgpOwogICAgICAgIGxldCBib3RJZHNTSEExID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90SWRzKTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtib3RJZHNTSEExLnN1YnN0cmluZygwLCA3KX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9nKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGBkb3dubG9hZCAke2Rvd25sb2FkQm90cy5sZW5ndGh9IGJvdHNgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGJvdC4KICAgICAgICBkb3dubG9hZEJvdHMgPSBbcG9zc2libGVCb3RzXTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtwb3NzaWJsZUJvdHMuaWQuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGJvdCcpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpIHsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9Cgpjb25zdCBzdGF0ZSA9IHt9OwoKLy8gRm9ybWF0IGJvdHMgZm9yIGZpbGUgc3RvcmFnZQpmb3IgKGxldCBpID0gMDsgaSA8IGRvd25sb2FkQm90cy5sZW5ndGg7IGkrKykgewogICAgbGV0IGN1cnJlbnRCb3RJRCA9IGRvd25sb2FkQm90c1tpXS5pZDsKICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZG93bmxvYWRCb3RzW2ldKSk7CgogICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwp9CgppZiAoIWZpbGVuYW1lLmVuZHNXaXRoKCcuYXV4JykpIHsKICAgIGZpbGVuYW1lICs9ICcuYXV4JzsKfQoKLy8gRG8gYSBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmNvbnN0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBmaWxlbmFtZSwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQocHJlcHJvY2Vzc0FyZyk7Cn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vIERvd25sb2FkIGFzIHYxIGF1eCBmaWxlLgpjb25zdCBhdXhGaWxlID0geyB2ZXJzaW9uOiAxLCBzdGF0ZSB9Owpvcy5kb3dubG9hZChhdXhGaWxlLCBmaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgppZiAocmVvcGVuQWJNZW51KSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfScAwtbV9A+hkAINbWFuaWZlc3RhdGlvbgIEAMLW1fQPkZgEKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAMLW1fQPoZACBG1lbnUCBADC1tX0D7iYBCjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDC1tX0D6GQAhJhYlByZXZpb3VzRWdnQ2hlY2sCBADC1tX0D9+YBIARQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0Py5hYklEOwpjb25zdCByZWNvcmRLZXlPck5hbWUgPSB0aGF0Py5yZWNvcmRLZXlPck5hbWUgPz8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQ7Cgphc3NlcnQodHlwZW9mIGFiSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyYCk7CmFzc2VydCh0eXBlb2YgcmVjb3JkS2V5T3JOYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXlPck5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBlZ2dIaXN0b3J5OwpsZXQgZWdnSUQ7CmxldCB0YXJnZXRWZXJzaW9uTnVtOwpsZXQgbGFzdEhhc2g7CmxldCBtYXhWZXJzaW9uTnVtOwpsZXQgc3RhYmxlVmVyc2lvbjsKbGV0IGZlZWRiYWNrVmVyc2lvbjsKbGV0IHByZXZpb3VzWFA7CmxldCByZWNvcmRMb29rdXAgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleU9yTmFtZSwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycAwtbV9A+hkAIPYWJCb3RNZW51QWN0aW9uAgQAwtbV9A/gqQRNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAMLW1fQPoZACDmFiQm90TWVudUxhYmVsAgQAwtbV9A+uqgQFc2hhcmUnAMLW1fQPoZACDWFiQm90TWVudUljb24CBADC1tX0D7SqBAlpb3Nfc2hhcmUnAMLW1fQPoZACEmFiQm90TWVudVNvcnRPcmRlcgIEAMLW1fQPvqoEAzMuNScAwtbV9A+hkAIFbGVhcm4CBADC1tX0D8KqBCjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDC1tX0D6GQAgthYlFSUHVibGlzaAIEAMLW1fQP6aoE4QFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0LCBzb3VyY2VFdmVudDogJ3FyX3B1Ymxpc2gnfSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAMLW1fQPoZACBnNlYXJjaAIEAMLW1fQPy6wEKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAMLW1fQPoZACB2FiU2hlbGwCBADC1tX0D/KsBAR0cnVlJwDC1tX0D6GQAgxzdHVkaW9TZWxlY3QCBADC1tX0D/esBIULQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwDC1tX0D6GQAg5hYlB1Ymxpc2hBc2tJRAIEAMLW1fQP+7cE3xVAaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgbWVudURpbWVuc2lvbiA9IHRoYXQubWVudURpbWVuc2lvbiA/PyBjb25maWdCb3QudGFncy5tZW51UG9ydGFsOwpsZXQgcHJvZ3Jlc3NCdXR0b247CgppZiAobWVudURpbWVuc2lvbikgewogICAgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBbbWVudURpbWVuc2lvbl06IHRydWUsIGxhYmVsOiBgcHVibGlzaGluZyAke3RoYXQuYXNrSUR9YCB9KTsKfQoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmNvbnN0IHBhdHRlcm5JRCA9IHRoYXQucGF0dGVybklEOwpjb25zdCBzdHVkaW9JRCA9IHRoYXQuc3R1ZGlvSUQgPyB0aGF0LnN0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKY29uc3QgbWFya2VyU2V0ID0gdGhhdC5tYXJrZXJTZXQgPz8gbmV3IFNldCgpOwpjb25zdCB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdHJ1ZTsKCmFzc2VydChtYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CgptYXJrZXJTZXQuYWRkKCdwdWJsaWNSZWFkJyk7Cm1hcmtlclNldC5hZGQoJ2FiQXNrJyk7CgovLyBbUnlhbiBDb29rXSBIQUNLOiBUaGVyZSBhcmUgaXNzdWVzIHdpdGggY3VzdG9tIG1hcmtlcnMuIENsZWFyIGFsbCBvZiB0aGUgZXhjZXB0IGZvciBwdWJsaWNSZWFkLgptYXJrZXJTZXQuY2xlYXIoKTsKbWFya2VyU2V0LmFkZCgncHVibGljUmVhZCcpOwoKLy8gQ2hlY2sgdG8gc2VlIGlmIHRoaXMgYXNrSUQgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBDYXN1YWwgY2F0YWxvZyBhc2tzIGFsd2F5cyBvdmVycmlkZSBhYiBhc2tzIGFuZCBzbyB1c2VyJ3Mgc2hvdWxkIGJlIGF3YXJlLgpjb25zdCBleGlzdHNJbkNhc3VhbENhdGFsb2cgPSBhd2FpdCBhYi5saW5rcy5zZWFyY2guYWJDYXN1YWxDYXRhbG9nQXNrSURFeGlzdHMoeyBhc2tJRDogdGhhdC5hc2tJRCB9KTsKCmlmICghZXhpc3RzSW5DYXN1YWxDYXRhbG9nKSB7CiAgICBjb25zdCBwdWJsaXNoQXNrID0gYXdhaXQgb3MucmVjb3JkRGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwgeyBwYXR0ZXJuSUQ6IHBhdHRlcm5JRCwgc3R1ZGlvSUQ6IHN0dWRpb0lEIH0sIHsgZW5kcG9pbnQ6IGVuZHBvaW50LCB1cGRhdGVQb2xpY3k6IFthdXRoQm90LmlkXSwgbWFya2VyczogbWFya2VyU2V0LnNpemUgPiAwID8gQXJyYXkuZnJvbShtYXJrZXJTZXQpIDogdW5kZWZpbmVkIH0pOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwdWJsaXNoQXNrIHJlc3VsdDpgLCBwdWJsaXNoQXNrKTsKICAgIH0KCiAgICBpZiAocHVibGlzaEFzay5zdWNjZXNzKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gcHVibGlzaGVkIHRvIGFiIHJlY29yZC5gLCBsb2dUeXBlOiAnbG9nJyB9KTsKCiAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gcHVibGlzaGVkLmAsIGxvZ1R5cGU6ICdsb2cnIH0pOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gZmFpbGVkIHRvIHB1Ymxpc2ggdG8gYWIgcmVjb3JkLlxuJHtKU09OLnN0cmluZ2lmeShwdWJsaXNoQXNrLCB1bmRlZmluZWQsIDIpfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CgogICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYGZhaWxlZCB0byBwdWJsaXNoIGFzayAke3RoYXQuYXNrSUR9LiAke3B1Ymxpc2hBc2suZXJyb3JNZXNzYWdlfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQoKICAgIHJldHVybiBwdWJsaXNoQXNrOwp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBhc2tJRCAnJHt0aGF0LmFza0lEfScgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBQbGVhc2UgY2hvb3NlIGEgZGlmZmVyZW50IG5hbWUuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKCiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KICAgIAogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBpbiB0aGUgc2hhcGUgb2YgUmVjb3JkRGF0YUZhaWx1cmUuCiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIGVycm9yQ29kZTogJ2Fza2lkX2V4aXN0c19jYXN1YWxfY2F0YWxvZycsCiAgICAgICAgZXJyb3JNZXNzYWdlOiBgQ2FzdWFsIGNhdGFsb2cgYWxyZWFkeSBjb250YWlucyB0aGUgYXNrSUQgJyR7YXNrSUR9J2AKICAgIH0KfScAwtbV9A+hkAIFaW5wdXQCBADC1tX0D9vNBCjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDC1tX0D6GQAgthYkVtYmVkTGluawIEAMLW1fQPgs4EpANAY29uc3QgYWIgPSB0aGF0ID8gdHJ1ZSA6IGZhbHNlOwpjb25zdCBlbWJlZExpbmsgPSBhYiA/ICJhYj0iICsgdGhhdCA6ICJpbnN0PSIgKyBjb25maWdCb3QudGFncy5pbnN0Owpjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKY29uc3QgZW1iZWRUZXh0ID0gYDwhRE9DVFlQRSBodG1sPgrCoMKgwqDCoDxodG1sPgrCoMKgwqDCoMKgwqDCoMKgPGhlYWQ+PC9oZWFkPgrCoMKgwqDCoMKgwqDCoMKgPGJvZHk+CsKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoDxpZnJhbWUgc3JjPSIke3NpdGVPcmlnaW4gKyAiLz8iICsgZW1iZWRMaW5rfSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iNDAwIiAvPgrCoMKgwqDCoMKgwqDCoMKgPC9ib2R5PgrCoMKgwqDCoDwvaHRtbD5gOwoKcmV0dXJuIGVtYmVkVGV4dDsnAMLW1fQPoZACD2FiUGF0dGVyblVwZGF0ZQIEAMLW1fQP+9AEpQVALy9zaG91dCgiYWJQYXR0ZXJuVXBkYXRlIiwge2FiSUQ6IGFiSUQsIHN0dWRpbzpzdHVkaW8/LCBib3RzOiBib3RzP30pOwphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKaWYgKCFhdXRoQm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8gdGhhdC5zdHVkaW8gOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBhYk1hbmlmZXN0ID0gZ2V0Qm90KGJ5TW9kKHthYkVnZzogdHJ1ZSwgb3JpZ2luX2FiOiBhYklEfSkpOwoKaWYgKCFhYk1hbmlmZXN0KQp7CiAgICBzaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGF1dG9IYXRjaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdwYXR0ZXJuX3VwZGF0ZSd9KTsKCiAgICByZXR1cm47Cn0KCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gc3R1ZGlvOwoKY29uc3QgYWJCb3RzID0gdGhhdC5ib3RzID8/IGdldEJvdHMoImFiSURPcmlnaW4iLCBhYklEKTsKCmF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBhYklELCB0YXJnZXQ6IGFiQm90cywgcHVibGljRmFjaW5nOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm5fdXBkYXRlJ30pOycAwtbV9A+hkAIXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBADC1tX0D6HWBE1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAwtbV9A+hkAIaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBADC1tX0D+/WBAEyJwDC1tX0D6GQAhVhYk11bHRpcGxlQm90TWVudUljb24CBADC1tX0D/HWBAlpb3Nfc2hhcmUnAMLW1fQPoZACFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBADC1tX0D/vWBAVzaGFyZScAwtbV9A+hkAIPYWJQdWJsaXNoU2VsZWN0AgQAwtbV9A+B1wSkE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IHRhZ3MubGFiZWwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vblBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwDC1tX0D6GQAglhYlZlcnNpb24CBADC1tX0D6TqBAUxMC4zNycAwtbV9A+hkAILcGVyc29uYWxpdHkCBADC1tX0D6rqBCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDC1tX0D6GQAgV1dGlscwIEAMLW1fQP0eoEKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAMLW1fQPoZACDmNhblB1Ymxpc2hGaWxlAgQAwtbV9A/46gT+A0BpZiAoZ2xvYmFsVGhpcy5hYikgewogICAgaWYgKGF1dGhCb3QpIHsKICAgICAgICBpZiAoYWIubGlua3MucmVtZW1iZXIudGFncy5zdWJzY3JpcHRpb25zRW5hYmxlZCkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciAhPT0gJ0ZyZWVQbGF5JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9IGVsc2UgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdhaXQgZm9yIGFiIHRvIGZpbmlzaCBib290aW5nIGJlZm9yZSBxdWVyeWluZyAke3RhZ05hbWV9LmApCiAgICByZXR1cm4gbnVsbDsKfScAwtbV9A+hkAIFZGVidWcCBADC1tX0D/fuBAR0cnVlJwEEYm90cyQ3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcBJwDC1tX0D/zuBBVhYkZpbmRBcnRpZmFjdEJ1bmRsZXMCBADC1tX0D/3uBJMGQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmNvbnN0IGFydGlmYWN0QnVuZGxlczogUmVjb3JkPHN0cmluZywgQUJBcnRpZmFjdEJ1bmRsZT4gPSB7fTsgLy8gS2V5IGlzIGFydGlmYWN0IGlkCgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGIudGFncy5hYkFydGlmYWN0QnVuZGxlKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGIudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEICYmIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICE9PSBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYXJ0aWZhY3RJZCA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlLmlkOwoKICAgICAgICBpZiAoYXJ0aWZhY3RJZCAmJiAhYXJ0aWZhY3RCdW5kbGVzW2FydGlmYWN0SWRdKSB7CiAgICAgICAgICAgIGFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIH0KICAgIH0KfSk7CgpyZXR1cm4gYXJ0aWZhY3RCdW5kbGVzOycAwtbV9A/87gQFc3RvcmUCBADC1tX0D5H1BCjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwDC1tX0D/zuBAZzeXN0ZW0CBADC1tX0D7j1BBFhYi5zaGVsbC5hcnRpZmFjdCcAwtbV9A/87gQIYWJJZ25vcmUCBADC1tX0D8r1BAR0cnVlJwDC1tX0D/zuBAlhYlZlcnNpb24CBADC1tX0D8/1BAUxMC4zNycAwtbV9A/87gQFZGVidWcCBADC1tX0D9X1BAVmYWxzZScAwtbV9A/87gQjYWJDaGVja0FydGlmYWN0UmVjb25zdGl0dXRpb25BdFJlc3QCBADC1tX0D9v1BLMGQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNoZWNraW5nLi4uYCk7Cn0KCi8vIENsZWFyIGFueSBjdXJyZW50bHkgcnVubmluZyAiYXQgcmVzdCIgY2hlY2suCmlmIChtYXNrcy5hdFJlc3RUaW1lb3V0SWQpIHsKICAgIGNsZWFyVGltZW91dChtYXNrcy5hdFJlc3RUaW1lb3V0SWQpOwogICAgbWFza3MuYXRSZXN0VGltZW91dElkID0gbnVsbDsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2xlYXJlZCBwcmV2aW91cyAiYXQgcmVzdCIgY2hlY2suYCk7CiAgICB9Cn0KCmFzeW5jIGZ1bmN0aW9uIGNoZWNrKCkgewogICAgY29uc3QgcmVjb25zdGl0dXRpbmdTaWduYWxCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RTaWduYWxCb3QpOwoKICAgIGlmIChyZWNvbnN0aXR1dGluZ1NpZ25hbEJvdHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdCByZWNvbnNpdGl0dXRpb24gaXMgYXQgcmVzdGApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBzaG91dCgnb25BQkFydGlmYWN0UmVjb25zdGl0dXRpb25BdFJlc3QnKTsKICAgIH0KCiAgICBtYXNrcy5hdFJlc3RUaW1lb3V0SWQgPSBudWxsOwp9CgptYXNrcy5hdFJlc3RUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGNoZWNrLCB0YWdzLmNoZWNrQXRSZXN0V2FpdE1TKTsKJwDC1tX0D/zuBAhyZW1lbWJlcgIEAMLW1fQPj/wEKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMLW1fQP/O4EE2FiQ3JlYXRlQXJ0aWZhY3RCb3QCBADC1tX0D7b8BN4TQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLAogICAgZGltZW5zaW9uID0gbGlua3MubGVhcm4udGFncy5hYkluc3QgPz8gJ2hvbWUnLAogICAgcG9zaXRpb24gPSBuZXcgVmVjdG9yMygwLCAwLCAwKSwKICAgIG90aGVyVGFncyA9IHt9LAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0Qm90ID0gY3JlYXRlKHsKICAgIHNwYWNlOiAnc2hhcmVkJywKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgIGFiQXJ0aWZhY3RCb3Q6IHRydWUsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtgJHtkaW1lbnNpb259WGBdOiBwb3NpdGlvbi54LAogICAgW2Ake2RpbWVuc2lvbn1ZYF06IHBvc2l0aW9uLnksCiAgICBbYCR7ZGltZW5zaW9ufVpgXTogcG9zaXRpb24ueiwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBsYWJlbENvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIHN0cm9rZUNvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIG9uQm90QWRkZWQ6IGBACiAgICAgICAgdGhpc0JvdC51cGRhdGVDb21wdXRlZFRhZ3MoKTsKICAgIGAsCiAgICBvbkJvdENoYW5nZWQ6IGBACiAgICAgICAgY29uc3QgY2hhbmdlZFRhZ3MgPSB0aGF0LnRhZ3M7CgogICAgICAgIGlmIChjaGFuZ2VkVGFncy5zb21lKHQgPT4gdCA9PT0gJ2FiQXJ0aWZhY3RJbnN0YW5jZUlEJyB8fCB0ID09PSAnYWJBcnRpZmFjdE5hbWUnKSkgewogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZUNvbXB1dGVkVGFncygpOwogICAgICAgIH0KICAgIGAsCiAgICB1cGRhdGVDb21wdXRlZFRhZ3M6IGBACiAgICAgICAgbGV0IHN5c3RlbSA9ICdhYkFydGlmYWN0Qm90JzsKCiAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgc3lzdGVtICs9ICcuJyArIHRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRC5zdWJzdHJpbmcoMCwgNyk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9ICEhc3lzdGVtID8gc3lzdGVtIDogbnVsbDsKICAgICAgICB0YWdzLmxhYmVsID0gdGFncy5zeXN0ZW07CiAgICBgLAogICAgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlOiBgQAogICAgICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnbGFiZWwnLCAnICcsICdzaGFyZWQnKTsKICAgIGAsCiAgICAuLi5vdGhlclRhZ3MsCn0pOwoKdHJ5IHsKICAgIC8vIFVwZGF0ZSBhbGwgdGhlIHNoYXJkcyBmb3IgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZSAtLSB3aGljaCBub3cgaW5jbHVkZXMgdGhpcyBib3QhCiAgICBjb25zdCB1cGRhdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwoKICAgIGlmICghdXBkYXRlUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byB1cGRhdGUgJyR7YWJBcnRpZmFjdE5hbWV9JyBhcnRpZmFjdCBzaGFyZHMuYCk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaHQgZXJyb3Igd2hpbGUgdXBkYXRlIGFydGlmYWN0IHNoYXJkczpgLCBlKTsKICAgIGRlc3Ryb3koYWJBcnRpZmFjdEJvdCk7CiAgICByZXR1cm4gbnVsbDsKfQoKcmV0dXJuIGFiQXJ0aWZhY3RCb3Q7JwDC1tX0D/zuBBZhYkFydGlmYWN0UmVjb25zdGl0dXRlAgQAwtbV9A+VkAWkP0BpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKYXNzZXJ0KHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmcgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuYCk7Cgpjb25zdCB7CiAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBhdXRoQm90Py5pZCA/PyBhYi5saW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwKICAgIGVnZ1BhcmFtZXRlcnMsIC8vIEVnZyBwYXJhbXRlcnMgdGhhdCB5b3Ugd291bGQgbGlrZSB0byBoYXZlIHBhc3NlZCB0byB0aGUgcmVjb25zaXR1dGVkIGJvdHMgKG9wdGlvbmFsKS4KICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgYXMgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgQUJBcnRpZmFjdEJ1bmRsZS5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCB0byBiZSBvZiB0eXBlIHN0cmluZy5gKTsKCi8vIENyZWF0ZSBhIHRlbXBTaGFyZWQgYm90IHRoYXQgYWN0cyBhcyBhIHNpZ25hbCB0byBldmVyeW9uZSB0aGF0IHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaXMgaW4gdGhlIHByb2Nlc3Mgb2YgYmVpbmcgcmVjb25zdGl0dXRlZC4KY29uc3QgcmVjb25zdGl0dXRpbmdTaWduYWxCb3QgPSBjcmVhdGUoewogICAgc3BhY2U6ICd0ZW1wU2hhcmVkJywKICAgIGFiQm90OiB0cnVlLAogICAgYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0U2lnbmFsQm90OiB0cnVlLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIGNyZWF0ZWRUaW1lOiBvcy5pc0NvbGxhYm9yYXRpdmUoKSA/IG9zLmFncmVlZFVwb25UaW1lIDogb3MubG9jYWxUaW1lLCAvLyBUaGUgdGltZSB0aGlzIHNpZ25hbCBib3Qgd2FzIGNyZWF0ZWQuCiAgICBhYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RJbnN0YW5jZUlEOiBhYkFydGlmYWN0SW5zdGFuY2VJRCwgLy8gVGhlIGluc3RhbmNlIGlkIG9mIHRoZSBhcnRpZmFjdCBiZWluZyByZWNvbnN0aXR1dGVkLgogICAgYWJSZWNvbnN0aXR1dGlvbkJ5UmVtb3RlSWQ6IGNvbmZpZ0JvdC5pZCwgLy8gVGhlIHJlbW90ZSBpZCBvZiB0aGUgdXNlciBwZXJmb3JtaW5nIHRoZSByZWNvbnNpdHV0aW9uLgogICAgYWJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzogJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkodGhhdCksIC8vIEEgY29weSBvZiB0aGUgcmVjb25zdGl0dXRlIGFyZyBvYmplY3QgZm9yIHRoaXMgZnVuY3Rpb24gaW4gY2FzZSBpdCdzIG5lZWRlZC4KICAgIG9uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQ6IExpc3RlbmVyU3RyaW5nKCgpID0+IHsKICAgICAgICBjb25zdCB7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0gPSB0aGF0OwoKICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IHRhZ3MuYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0SW5zdGFuY2VJRCAmJiB0aGlzQm90LnNwYWNlICE9PSAncmVtb3RlVGVtcFNoYXJlZCcpIHsKICAgICAgICAgICAgaWYgKGxpbmtzLm1hbmFnZXIudGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFthYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RTaWduYWxCb3RdIGRlc3Ryb3lpbmcgc2VsZiBiZWNhdXNlIGFydGlmYWN0IGluc3RhbmNlIGlkICR7dGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RJbnN0YW5jZUlEfSBoYXMgcmVjb25zdGl0dXRlZC5gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICB9CiAgICB9KSwKICAgIG9uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkOiBMaXN0ZW5lclN0cmluZygoKSA9PiB7CiAgICAgICAgY29uc3QgeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9ID0gdGhhdDsKCiAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSB0YWdzLmFiUmVjb25zdGl0dXRpbmdBcnRpZmFjdEluc3RhbmNlSUQgJiYgdGhpc0JvdC5zcGFjZSAhPT0gJ3JlbW90ZVRlbXBTaGFyZWQnKSB7CiAgICAgICAgICAgIGlmIChsaW5rcy5tYW5hZ2VyLnRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0U2lnbmFsQm90XSBkZXN0cm95aW5nIHNlbGYgYmVjYXVzZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCAke3RhZ3MuYWJSZWNvbnN0aXR1dGluZ0FydGlmYWN0SW5zdGFuY2VJRH0gZmFpbGVkIHRvIHJlY29uc3RpdHV0ZS5gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgICAgICB9CiAgICB9KQp9KTsKCnRyeSB7CgogICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZVN0cmluZyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwogICAgY29uc3Qgc2hhcmRCb3RzID0gW107CgogICAgZnVuY3Rpb24gaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSh7IGJvdERhdGEgfSkgewogICAgICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZDsgLy8gSWYgdGhlIHNoYXJkIGJvdCBoYXMgaXRzZWxmIG1hcmtlZCBhcyByZWNvbnN0aXR1dGVkIGFscmVhZHkgKHBvc3NpYmx5IGR1ZSB0byBhbiBvdmVyc2lnaHQpLCB0aGVuIHJlbW92ZSBpdCEKCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJ1bmRsZVN0cmluZzsgLy8gQXNzaWduIHRoZSBhcnRpZmFjdCBidW5kbGUgYmFjayB0byB0aGUgaGF0Y2hlZCBzaGFyZCBib3QuCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOyAvLyBVVUlEIG9mIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSB0aGF0IHRoaXMgYm90IGJlbG9uZ3MgdG8uCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOyAvLyBUaGUgdXNlciBpZCB0aGUgb3duZXIgb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7IC8vIFVVSUQgYXNzaWduZWQgdG8gdGhlIGJvdCBieSB0aGUgYXJ0aWZhY3Qgd2hlbiBsb2FkZWQuCiAgICAgICAgfQogICAgfQoKICAgIGZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcykgewogICAgICAgIGNvbnN0IGRlcGVuZGVuY3lCb3RzID0gW107CgogICAgICAgIGlmICh0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgICAgICBjb25zdCBlZ2dEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeTsKCiAgICAgICAgICAgIC8vIEZpcnN0IHRyeSB0byBsb2FkIGZyb20gZWdnLgogICAgICAgICAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgICAgICAgICAgYWJJRDogZWdnRGVwZW5kZW5jeS5hYklELAogICAgICAgICAgICAgICAgcmVjb3JkS2V5OiBlZ2dEZXBlbmRlbmN5LnJlY29yZEtleSwKICAgICAgICAgICAgICAgIGFiVmVyc2lvbjogZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24sCiAgICAgICAgICAgICAgICBhdXRvSGF0Y2g6IHRydWUsCiAgICAgICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlCiAgICAgICAgICAgIH0pCgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gJHtlZ2dEZXBlbmRlbmN5LmFiSUR9IGxvb2t1cEVnZ1Jlc3VsdDpgLCBsb29rdXBFZ2dSZXN1bHQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobG9va3VwRWdnUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBsb2FkZWQgZGVwZW5kZW5jeSBhYklEOiAke2VnZ0RlcGVuZGVuY3kuYWJJRH0sIGFiVmVyc2lvbjogJHtlZ2dEZXBlbmRlbmN5LmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhhdGNoZWRCb3Qgb2YgbG9va3VwRWdnUmVzdWx0LmhhdGNoZWRCb3RzKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeUJvdHMucHVzaChoYXRjaGVkQm90KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA9PT0gMCAmJiB0aGlzQm90LmlzQXNrRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgICAgICBjb25zdCBhc2tEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0QXNrRGVwZW5kZW5jeTsKCiAgICAgICAgICAgIC8vIFRyeSB0byBsb2FkIGZyb20gYXNrLgogICAgICAgICAgICBjb25zdCBsb29rdXBBc2tSZXN1bHQ6IEFCTG9va3VwQXNrSURSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBc2tJRCh7CiAgICAgICAgICAgICAgICBhc2tJRDogYXNrRGVwZW5kZW5jeS5hc2tJRCwKICAgICAgICAgICAgICAgIHNob3dJbmRpY2F0b3I6IGZhbHNlLAogICAgICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICAgICAgaWdub3JlUmVzZXJ2ZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlCiAgICAgICAgICAgIH0pCgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2tSZXN1bHQ6YCwgbG9va3VwQXNrUmVzdWx0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGxvb2t1cEFza1Jlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhhdGNoZWRCb3Qgb2YgbG9va3VwQXNrUmVzdWx0LmhhdGNoZWRCb3RzKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeUJvdHMucHVzaChoYXRjaGVkQm90KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgZm9yIChjb25zdCBzaGFyZEJvdCBvZiBkZXBlbmRlbmN5Qm90cykgewogICAgICAgICAgICAgICAgc2hhcmRCb3RzLnB1c2goc2hhcmRCb3QpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9IGZhaWxlZCB0byBsb2FkIGRlcGVuZGVuY3k6ICR7SlNPTi5zdHJpbmdpZnkoZGVwZW5kZW5jeSl9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICB9CiAgICB9CgoKICAgIGlmIChzaGFyZEJvdHMubGVuZ3RoID4gMCkgewogICAgICAgIC8vIFRlbGwgYWxsIGhhdGNoZWQgc2hhcmQgYm90cyB0byByZWNvbnN0aXR1dGUuIFRoZXkgYWxsIGhhdmUgY29waWVzIG9mIHRoZSBhYkFydGlmYWN0QnVuZGxlIGFuZCBjYW4gcmVjb25zdGl0dXRlIHRoZW1zZWx2ZXMgZnJvbSB0aGF0LgogICAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKHNoYXJkQm90cywgJ29uQUJBcnRpZmFjdFJlY29uc3RpdHV0ZScsIHsgZGF0YTogYWJBcnRpZmFjdEJ1bmRsZS5kYXRhIH0pKTsKCiAgICAgICAgZm9yIChsZXQgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOyAvLyBUaGlzIGJvdCBoYXMgYmVlbiByZWNvbnN0aXR1dGVkIGluIHRoaXMgaW5zdC4KICAgICAgICB9CgogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwoKICAgICAgICBjb25zdCByZWNvbnN0aXR1dGlvblJlc3VsdCA9IHsKICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICBzaGFyZEJvdHMsCiAgICAgICAgfTsKCiAgICAgICAgd2hpc3BlcihzaGFyZEJvdHMsICdvblJlY29uc3RpdHV0ZWQnLCByZWNvbnN0aXR1dGlvblJlc3VsdCk7CiAgICAgICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCByZWNvbnN0aXR1dGlvblJlc3VsdCk7CgogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfScgKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgZmluaXNoZWQgcmVjb25zdGl0dXRpb24uYCwgdG9hc3Q6IHRvYXN0IH0pOwoKICAgICAgICByZXR1cm4gcmVjb25zdGl0dXRpb25SZXN1bHQ7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGZhaWx1cmVSZXN1bHQgPSB7CiAgICAgICAgICAgIGVycm9yQ29kZTogJ25vX3NoYXJkX2JvdHMnLAogICAgICAgICAgICBlcnJvck1lc3NhZ2U6ICdSZWNvbnN0aXR1dGlvbiByZXN1bHRzIGluIG5vIHNoYXJkIGJvdHMuJywKICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgIH07CgogICAgICAgIHNob3V0KCdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGZhaWx1cmVSZXN1bHQpOwoKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZhaWxlZCByZWNvbnN0aXR1dGlvbi5gLCB0b2FzdDogdG9hc3QgfSk7CgogICAgICAgIHJldHVybiBmYWlsdXJlUmVzdWx0OwogICAgfQoKfSBmaW5hbGx5IHsKICAgIGRlc3Ryb3kocmVjb25zdGl0dXRpbmdTaWduYWxCb3QpOwp9CicAwtbV9A/87gQXYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24CBADC1tX0D7bPBQExJwDC1tX0D/zuBAZzZWFyY2gCBADC1tX0D7jPBSjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwDC1tX0D/zuBAdhYlNoZWxsAgQAwtbV9A/fzwUEdHJ1ZScAwtbV9A/87gQFdXRpbHMCBADC1tX0D+TPBSjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDC1tX0D/zuBA9vbkFueUJvdENsaWNrZWQCBADC1tX0D4vQBYEBQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGJvdCB9KQp9JwDC1tX0D/zuBBZhYlVwZGF0ZUFydGlmYWN0U2hhcmRzAgQAwtbV9A+N0QWyHEBjb25zdCBhYkFydGlmYWN0TmFtZSA9IHRoYXQuYWJBcnRpZmFjdE5hbWU7CmxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CmxldCBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IHRoYXQuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPz8gYXV0aEJvdD8uaWQgPz8gYWIubGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWU7Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgppZiAoc2hhcmRCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBUaGVyZSBhcmUgbm8gc2hhcmRzIGZvciBhcnRpZmFjdCBuYW1lICcke2FiQXJ0aWZhY3ROYW1lfScuYCwgbG9nVHlwZTogJ3dhcm4nIH0pOwogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQoKY29uc3QgcHJldkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gc2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKY29uc3QgcHJldkFydGlmYWN0SUQgPSBwcmV2QXJ0aWZhY3RCdW5kbGUgPyBwcmV2QXJ0aWZhY3RCdW5kbGUuaWQgOiBudWxsOwpjb25zdCBwcmV2QXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gc2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CgpsZXQgY29sbGVjdFNoYXJkUmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdDsKCnRyeSB7CiAgICBjb2xsZWN0U2hhcmRSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiQ29sbGVjdEFydGlmYWN0U2hhcmRzKHsgc2hhcmRCb3RzIH0pOwoKICAgIGlmICghY29sbGVjdFNoYXJkUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogY29sbGVjdFNoYXJkUmVzdWx0LnJlYXNvbiwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICB9Cn0gY2F0Y2goZSkgewogICAgY29uc29sZS5lcnJvcihlKTsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgU29tZXRoaW5nIHdlbnQgd3JvbmcgY29sbGVjdGluZyBzaGFyZHMuIFNlZSBjb25zb2xlIGZvciBtb3JlIGRldGFpbHMuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH0KfQoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHRoaXNCb3QuYWJDcmVhdGVBcnRpZmFjdEJ1bmRsZSh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0U2hhcmQ6IGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZCB9KTsKCmlmIChwcmV2QXJ0aWZhY3RJRCAmJiBwcmV2QXJ0aWZhY3RJRCAhPT0gYWJBcnRpZmFjdEJ1bmRsZS5pZCkgewogICAgLy8gVGhlIGFydGlmYWN0IGhhcyBhIG5ldyBpZC4gQWxsIG9mIHRoZSBzaGFyZCBib3RzIG5lZWQgYSBuZXcgaW5zdGFuY2UgaWQgYXMgd2VsbC4KICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwoKICAgIGZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZpbmFsIG1lcmdlZCBhcnRpZmFjdCAke2FiQXJ0aWZhY3ROYW1lfTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKLy8gRXZlcnkgc2hhcmQgYm90IGdldHMgYSBjb3B5IG9mIHRoZSBhcnRpZmFjdCBidW5kbGUuCi8vIFRoaXMgbWFrZXMgdGhlIGFydGlmYWN0IGhvbG9ncmFwaGljIGJ5IG5hdHVyZS4gVGhpcyBtZWFucyB0aGF0IGFueSBzaGFyZCBjYW4gYmUgdXNlZCB0byByZWNvbnN0aXR1dGUgdGhlIHdob2xlLgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgLy8gTWFyayBlYWNoIHNoYXJkIGJvdCBhcyBiZWluZyAncmVjb25zdGl0dXRlZCcgd2hlbiB3ZSB1cGRhdGUgdGhlIGFydGlmYWN0LgogICAgLy8gQmVjYXVzZSB0aGlzIGlzIGEgc2hhcmVkIHRhZyBtYXNrLCBpdCB3aWxsIG9ubHkgYmUgdHJ1ZSBpbiB0aGUgY3VycmVudCBpbnN0LgogICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7CiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGUgPSAgJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoYWJBcnRpZmFjdEJ1bmRsZSk7CgogICAgLy8gSWYgdGhlIHNoYXJkQm90IGhhc250IGJlZW4gbWFya2VkIGFzIGhhdmluZyBhbiBpbnN0YW5jZSBvd25lciBPUiBpdHMgb3duZXIgZG9lc250IG1hdGNoIHRoZSBvbmUgYmVpbmcgcHJvdmlkZWQgdG8KICAgIC8vIHRoaXMgdXBkYXRlIGZ1bmN0aW9uIHRoZW4gd2UgY2hhbmdlIGl0LgogICAgaWYgKCFzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIHx8IHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgIT09IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyKSB7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgfQp9CgovLyBSeWFuIENvb2s6IE5lZWQgdG8gZ2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byBjYXRjaHVwLgovLyBGb3VuZCB0aGF0IGlmIHdlIGRpZG50IGRvIHRoaXMsIG1vZCB0YWdzIHdvdWxkIG5vdCBiZSByZXR1cm5lZCBhcyBKU09OIG9iamVjdHMgYnV0IGluc3RlYWQgdGhlIHJhdyBzdHJpbmcuCmF3YWl0IG9zLnNsZWVwKDApOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRlZCBhcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nLiBDb3BpZWQgYXJ0aWZhY3QgYnVuZGxlIHRvICR7c2hhcmRCb3RzLmxlbmd0aH0gYm90cy4gYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKc2hvdXQoJ29uQW55QUJBcnRpZmFjdFNoYXJkc1VwZGF0ZWQnLCB7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsIGFiQXJ0aWZhY3RCdW5kbGUsIHNoYXJkQm90cyB9KQoKLy8gU2hhcmQgdXBkYXRlIHN1Y2Nlc3NmdWwuCnJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTsnAMLW1fQP/O4EBG1lbnUCBADC1tX0D77tBSjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDC1tX0D/zuBAVsZWFybgIEAMLW1fQP5e0FKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAMLW1fQP/O4EC29uR3JpZENsaWNrAgQAwtbV9A+M7gVGQGlmIChsaW5rcy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfScAwtbV9A/87gQaYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQCBADC1tX0D9PuBQcjQUVBMUZGJwDC1tX0D/zuBBthYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQCBADC1tX0D9vuBQcjMWUxYjJkJwDC1tX0D/zuBBBvbkFueUJvdHNSZW1vdmVkAgQAwtbV9A/j7gWMBEBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsKCmlmIChtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgJiYgYm90SURzLmluY2x1ZGVzKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCkpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwp9Cgpmb3IgKGxldCBib3RJRCBvZiBib3RJRHMpIHsKICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMucmVjb25zdGl0dXRpbmdTaWduYWxCb3RJZHMuZGVsZXRlKGJvdElEKTsKCiAgICBpZiAoZGVsZXRlZCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGV0ZWN0ZWQgcmVtb3ZlZCByZWNvbnN0aXR1dGlvbiBzaWduYWwgYm90LCB3aWxsIG5vdyBiZWdpbiBjaGVjayBpZiByZWNvbnNpdGl0dWlvbiBpcyBhdCByZXN0LmApOwogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC5hYkNoZWNrQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkF0UmVzdCgpOwogICAgfQp9JwDC1tX0D/zuBAd2ZXJzaW9uAgQAwtbV9A/w8gUo8J+UlzUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZicAwtbV9A/87gQYYWJHZXRBcnRpZmFjdE5hbWVzSW5JbnN0AgQAwtbV9A+X8wWsAUBjb25zdCBhYkFydGlmYWN0TmFtZXMgPSBuZXcgU2V0KCk7CgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWVzLmFkZChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpOwogICAgfQp9KQoKcmV0dXJuIGFiQXJ0aWZhY3ROYW1lczsnAMLW1fQP/O4EFWFiQXJ0aWZhY3RCb3RNZW51T3BlbgIEAMLW1fQPxPQF1RdAY29uc3QgeyBhYkFydGlmYWN0Qm90IH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3RCb3QgJiYgYWJBcnRpZmFjdEJvdC5zcGFjZSAmJiBhYkFydGlmYWN0Qm90LnRhZ3MsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJvdCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQm90LmApOwoKc2hvdXQoImFiQXJ0aWZhY3RCb3RNZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiQXJ0aWZhY3RNZW51IjsKCmlmICghdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwoKbGV0IGluZm9MYWJlbCA9IGBbYXJ0aWZhY3QgbmFtZV06ICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaWRdOiAke2FiQXJ0aWZhY3RCdW5kbGUuaWQuc3Vic3RyaW5nKDAsIDcpfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaW5zdGFuY2UgaWRdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA/PyAndW5zZXQnfSBcbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGluc3RhbmNlIG93bmVyXTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPz8gJ3Vuc2V0J30gXG5gOwppbmZvTGFiZWwgKz0gYFtyZWNvbnN0aXR1dGVkIGluIGluc3RdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkfVxuYDsKaW5mb0xhYmVsICs9IGBbZm9ybWF0XTogdiR7YWJBcnRpZmFjdEJ1bmRsZS5mb3JtYXRWZXJzaW9ufVxuYDsKaW5mb0xhYmVsICs9IGBbY3JlYXRlZCB0aW1lXTogJHtEYXRlVGltZS5mcm9tSVNPKGFiQXJ0aWZhY3RCdW5kbGUuY3JlYXRlZFRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoRGF0ZVRpbWUuREFURVRJTUVfU0hPUlRfV0lUSF9TRUNPTkRTKX1cbmA7CgovLyBIZWFkZXIKY29uc3QgaW5mb0JvdCA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51VGV4dCh7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGxhYmVsOiBpbmZvTGFiZWwsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2goaW5mb0JvdCk7CgovLyBEb3dubG9hZCBzaGFyZCBidXR0b24uCmNvbnN0IGRvd25sb2FkQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgYWJBcnRpZmFjdFRvb2w6IGdldExpbmsodGhpc0JvdCksCiAgICBmb3JtQWRkcmVzczogJ2Rvd25sb2FkJywKICAgIGxhYmVsOiBgZG93bmxvYWQgc2hhcmRgLAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGUgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9ICdhYkFydGlmYWN0LScgKyBhYkFydGlmYWN0QnVuZGxlLm5hbWUgKyAnLScgKyBhYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLDcpICsgJy5hdXgnOyAKICAgICAgICBvcy5kb3dubG9hZEJvdHMoWyBsaW5rcy5hYkFydGlmYWN0Qm90IF0sIGZpbGVuYW1lKTsKICAgICAgICAKICAgICAgICBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGRvd25sb2FkQnV0dG9uKTsKCi8vIFVwZGF0ZSBhcnRpZmFjdCBidXR0b24uCmNvbnN0IHVwZGF0ZUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdzeW5jJywKICAgIGxhYmVsOiBgdXBkYXRlIGFydGlmYWN0YCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBhYkFydGlmYWN0QnVuZGxlLm5hbWU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CiAgICAgICAgCiAgICAgICAgYXdhaXQgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgfSk7CgogICAgICAgIGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGxpbmtzLmFiQXJ0aWZhY3RCb3QgfSk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKHVwZGF0ZUJ1dHRvbik7CgptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBhYkFydGlmYWN0Qm90LmlkOycAwtbV9A/87gQZYWJEb3dubG9hZEFydGlmYWN0UGF0dGVybgIEAMLW1fQPmowGiAVAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzaGFyZEJvdHMsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0TmFtZSA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpICYmIHNoYXJkQm90cy5sZW5ndGggPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyBhIHJlcXVpcmVkIEJvdCBhcnJheSBwYXJhbWV0ZXIuIEl0IG11c3QgaGF2ZSBhdCBsZWFzdCAxIGJvdC5gKTsKCnJldHVybiBsaW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgCiAgICBwb3NzaWJsZUJvdHM6IHNoYXJkQm90cywKICAgIGZpbGVuYW1lOiBgJHthYkFydGlmYWN0TmFtZX1gLAogICAgc291cmNlRXZlbnQ6ICdkb3dubG9hZF9hcnRpZmFjdF9wYXR0ZXJuJywKICAgIHJlb3BlbkFiTWVudTogZmFsc2UsCiAgICBvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZDogYXN5bmMgKGFyZykgPT4gewogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAMLW1fQP/O4EFmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQCBADC1tX0D6ORBu8BQGlmICh0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyAmJiB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5sZW5ndGggPiAwKSB7CiAgICBkZXN0cm95KHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKTsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gbnVsbDsnAMLW1fQP/O4EBXR5cGVzAgQAwtbV9A+Tkwb7CfCfk4RpbnRlcmZhY2UgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZyB7CiAgICBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ/OiBzdHJpbmc7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzPzogc3RyaW5nOwogICAgZWdnUGFyYW1ldGVycz86IGFueTsKICAgIHRvYXN0PzogYm9vbGVhbjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHsKICAgIGFiSUQ6IHN0cmluZzsKICAgIHJlY29yZEtleTogc3RyaW5nOwogICAgYWJWZXJzaW9uPzogbnVtYmVyOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3kgewogICAgYXNrSUQ6IHN0cmluZzsKfQoKdHlwZSBBQkFydGlmYWN0RGVwZW5kZW5jeSA9IEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHwgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgppbnRlcmZhY2UgQUJBcnRpZmFjdEJ1bmRsZSB7CiAgICBpZDogc3RyaW5nOwogICAgbmFtZTogc3RyaW5nOwogICAgZm9ybWF0VmVyc2lvbjogbnVtYmVyOwogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+OwogICAgY2FzdWFsT1NWZXJzaW9uOiBBdXhWZXJzaW9uOwogICAgY3JlYXRlZFRpbWVzdGFtcDogc3RyaW5nOwogICAgYWJTaGVsbFZlcnNpb246IHN0cmluZzsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RTaGFyZCB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+OwogICAgZGVwZW5kZW5jaWVzOiBBcnJheTxBQkFydGlmYWN0RGVwZW5kZW5jeT47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RXhwZXJpZW5jZSB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoIHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmc7CiAgICBhdXRob3JpemVkOiBib29sZWFuOwogICAgZmFpbHVyZVJlYXNvbjogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZVJlYXNvbjsKfQoKdHlwZSBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbicgfCAndXNlcl9kZWNsaW5lZF9pbnN0X3Blcm1pc3Npb24nIHwgJ3Vua25vd24nOwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICByZWFzb24/OiBhbnk7CiAgICBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwp9CicAwtbV9A/87gQab25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUCBADC1tX0D42dBuE/QGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGF0KSkpOwp9CgppZiAoc291cmNlRXZlbnQgPT09ICdhc2snIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdwYXN0ZScgfHwgCiAgICBzb3VyY2VFdmVudCA9PT0gJ2Jvb3QnIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdmaWxlX3VwbG9hZCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAndG9vbCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnCikgewogICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBib3RzIGJlaW5nIGFkZGVkIGFyZSBhcnRpZmFjdCBzaGFyZHMgdGhhdCBuZWVkcyB0byBiZSByZWNvbnN0aXR1dGVkLgogICAgY29uc3QgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGU6IFJlY29yZDxzdHJpbmcsIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmc+ID0ge307IC8vIEtleSBpcyBhcnRpZmFjdCBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwogICAgY29uc3QgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpOyAvLyBUaGlzIHNldCB0cmFja3MgYXJ0aWZhY3QgaWRzIHRoYXQgYXJlIGFscmVhZHkgcXVldWVkIHRvIGJlIHJlY29uc3RpdHV0ZWQgd2l0aCBhIG5ldyBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVHJhY2sgb3JpZ2luYWwgaW5zdGFuY2UgSURzIHRoYXQgd2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGdpdmUgbmV3IGluc3RhbmNlcwoKICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICBpZiAoZGF0YSAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYKICAgICAgICAgICAgIWRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkICYmCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlPy5zdGFydHNXaXRoKCfwn6esJykKICAgICAgICApIHsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IHN0cmluZyA9IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlT3duZXI6IHN0cmluZyA9IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IEpTT04ucGFyc2UoZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGUuc3Vic3RyaW5nKDIpKTsKCiAgICAgICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICAgICAgLy8gU2hhcmQgaGFzIGFuIGFydGlmYWN0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gJiYgIW9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmhhcyhhYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDE6IEluc3RhbmNlIGFscmVhZHkgZXhpc3RzIC0gY3JlYXRlIG5ldyBpbnN0YW5jZSAoZmlyc3QgdGltZSB3ZSBzZWUgdGhpcyBjb2xsaXNpb24pCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW25ld0FydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBuZXdBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXM6IGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsgLy8gVHJhY2sgdGhhdCB3ZSdyZSBjcmVhdGluZyBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBhcnRpZmFjdCBJRAogICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7IC8vIFRyYWNrIHRoYXQgd2UndmUgZGVjaWRlZCB0byByZXBsYWNlIHRoaXMgb3JpZ2luYWwgaW5zdGFuY2UgSUQKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDE6IFNoYXJkIGZyb20gZXhpc3RpbmcgaW5zdGFuY2UuIENyZWF0aW5nIG5ldyBpbnN0YW5jZS4gKG9sZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0sIG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMWI6IFdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2UgZm9yIHRoaXMgb3JpZ2luYWwgSUQgLSBkaXNwb3NlLgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAxYjogQWRkaXRpb25hbCBzaGFyZCBmb3IgcmVwbGFjZWQgaW5zdGFuY2UuIERpc3Bvc2luZy4gKG9yaWdpbmFsOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAyOiBJbnN0YW5jZSBhbHJlYWR5IHF1ZXVlZCBmb3IgcmVjb25zdGl0dXRpb24gLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAyOiBEdXBsaWNhdGUgc2hhcmQgZm9yIHF1ZXVlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAoYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAzOiBJbnN0YW5jZSB0byByZWNvbnN0aXR1dGUgd2l0aCBleGlzdGluZyBJRAogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDM6IEluc3RhbmNlIHRvIHJlY29uc3RpdHV0ZS4gKGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTaGFyZCBoYXMgbm8gYXJ0aWZhY3QgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgIGlmIChhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5oYXMoYWJBcnRpZmFjdEJ1bmRsZS5pZCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDQ6IEFydGlmYWN0IGFscmVhZHkgaGFzIG5ldyBpbnN0YW5jZSBxdWV1ZWQgLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSA0OiBEdXBsaWNhdGUgc2hhcmQgZm9yIGFydGlmYWN0IHdpdGggbmV3IGluc3RhbmNlIHF1ZXVlZC4gRGlzcG9zaW5nLiAoYXJ0aWZhY3RJZDogJHthYkFydGlmYWN0QnVuZGxlLmlkfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgNTogQ3JlYXRlIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDU6IENyZWF0aW5nIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRC4gKG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIFRoaXMgaXMgbm90IGEgc2hhcmQgYm90LiBJZ25vcmUgaXQuCiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZTpgLCBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZSk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzOmAsIGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXMpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6YCwgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQ6YCwgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQpOwogICAgfQoKICAgIGZvciAoY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpIHsKICAgICAgICBjb25zdCByZWNvbnN0aXR1dGVBcmc6IEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgPSBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF07CiAgICAgICAgCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBSZWNvbnN0aXR1dGluZyBhcnRpZmFjdCBpbnN0YW5jZTogJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0UmVjb25zdGl0dXRlKHJlY29uc3RpdHV0ZUFyZyk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBpZiAoc291cmNlRXZlbnQgPT09ICdjcmVhdGVfYXJ0aWZhY3RfcHJvbWlzZScpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICAgICAgLy8gRG8gYSBzcGVjaWFsIHNob3V0IHNvIHRoYXQgdGhlIGNyZWF0ZSBhcnRpZmFjdCBwcm9taXNlIGZ1bmN0aW9uIGNhbiBjYXRjaCB0aGlzIGVycm9yLgogICAgICAgICAgICAgICAgY29uc3QgZmFpbHVyZVJlc3VsdCA9IHsKICAgICAgICAgICAgICAgICAgICBlcnJvckNvZGU6ICdhcnRpZmFjdF9wcm9taXNlX3JlY29uc3RpdHV0aW9uX2ZhaWxlZCcsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBgUmVjb25zdGl0dXRpb24gZnJvbSBhcnRpZmFjdCBwcm9taXNlIGhhcyBmYWlsZWQuIENhdWdodCBlcnJvcjogJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RCdW5kbGUubmFtZSwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXM6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVyczogcmVjb25zdGl0dXRlQXJnLmVnZ1BhcmFtZXRlcnMsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIHNob3V0KCdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGZhaWx1cmVSZXN1bHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgIH0KfScAwtbV9A/87gQbb25BQlByZXByb2Nlc3NCZWZvcmVQdWJsaXNoAgQAwtbV9A/t3AalAkBpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9Cgp0aGlzQm90LmFiUHJlcHJvY2Vzc0JvdERhdGFUb0FydGlmYWN0UHJvbWlzZXMoeyBib3REYXRhOiB0aGF0LmJvdERhdGEgfSk7JwDC1tX0D/zuBBZhYkdldEFydGlmYWN0SW5zdGFuY2VzAgQAwtbV9A+T3wbKB0Bjb25zdCB7IAogICAgYm90cywKICAgIGFiQXJ0aWZhY3ROYW1lLAp9ID0gdGhhdCA/PyB7fQoKaWYgKGJvdHMpIHsKICAgIGFzc2VydChBcnJheS5pc0FycmF5KGJvdHMpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgbXVzdCBiZSBhbiBhcnJheS5gKTsKfQoKY29uc3QgaW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB7fSAvLyBLZXkgaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaWQuCgpmdW5jdGlvbiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShib3QpIHsKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiBib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBib3QudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBsZXQgYm90QXJyYXkgPSBpbnN0YW5jZXNbYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgICAgICBpZiAoIWJvdEFycmF5KSB7CiAgICAgICAgICAgIGJvdEFycmF5ID0gW107CiAgICAgICAgICAgIGluc3RhbmNlc1tib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRF0gPSBib3RBcnJheTsKICAgICAgICB9CgogICAgICAgIGJvdEFycmF5LnB1c2goYm90KTsKICAgIH0KfQoKaWYgKGJvdHMpIHsKICAgIC8vIEdldCBhcnRpZmFjdCBpbnN0YW5jZXMgaW4gcHJvdmlkZWQgbGlzdCBvZiBib3RzLgogICAgYm90cy5mb3JFYWNoKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYikpOwp9IGVsc2UgewogICAgLy8gR2V0IGFydGlmYWN0IGluc3RhbmNlcyBpbiBpbnN0LgogICAgZ2V0Qm90cyhiID0+IHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGIpKTsKfQoKcmV0dXJuIGluc3RhbmNlczsnAMLW1fQP/O4EFWFiR2V0QXJ0aWZhY3RQYXR0ZXJucwIEAMLW1fQP3uYG8wdAY29uc3QgeyAKICAgIGJvdHMsCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge30KCmlmIChib3RzKSB7CiAgICBhc3NlcnQoQXJyYXkuaXNBcnJheShib3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIG11c3QgYmUgYW4gYXJyYXkuYCk7Cn0KCmNvbnN0IHBhdHRlcm5zOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB7fSAvLyBLZXkgaXMgYXJ0aWZhY3QgbmFtZS4KCmZ1bmN0aW9uIHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYm90KSB7CiAgICAvLyBQYXR0ZXJuIGJvdHMgaGF2ZSBhYkFydGlmYWN0TmFtZSBidXQgbm8gYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiAhYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbGV0IGJvdEFycmF5ID0gcGF0dGVybnNbYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWVdOwoKICAgICAgICBpZiAoIWJvdEFycmF5KSB7CiAgICAgICAgICAgIGJvdEFycmF5ID0gW107CiAgICAgICAgICAgIHBhdHRlcm5zW2JvdC50YWdzLmFiQXJ0aWZhY3ROYW1lXSA9IGJvdEFycmF5OwogICAgICAgIH0KCiAgICAgICAgYm90QXJyYXkucHVzaChib3QpOwogICAgfQp9CgppZiAoYm90cykgewogICAgLy8gR2V0IGFydGlmYWN0IHBhdHRlcm5zIGluIHByb3ZpZGVkIGxpc3Qgb2YgYm90cy4KICAgIGJvdHMuZm9yRWFjaChiID0+IHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYikpOwp9IGVsc2UgewogICAgLy8gR2V0IGFydGlmYWN0IHBhdHRlcm5zIGluIGluc3QuCiAgICBnZXRCb3RzKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihiKSk7Cn0KCnJldHVybiBwYXR0ZXJuczsnAMLW1fQP/O4EGGFiUHVibGlzaEFydGlmYWN0UGF0dGVybgIEAMLW1fQP0u4GhgZAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzdHVkaW8sCiAgICBzaGFyZEJvdHMsCiAgICBtYW51YWxQdWJsaXNoLAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdE5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBzdHVkaW8gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0dWRpbyBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiUHVibGlzaEFCKHsKICAgIGFiOiBhYkFydGlmYWN0TmFtZSwgCiAgICB0YXJnZXQ6IHNoYXJkQm90cywgCiAgICBzdHVkaW8sCiAgICBtYW51YWxQdWJsaXNoLAogICAgc291cmNlRXZlbnQ6ICdwdWJsaXNoX2FydGlmYWN0X3BhdHRlcm4nLAogICAgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaDogYXN5bmMgKGFyZykgPT4gewogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAMLW1fQP/O4EJmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhAgQAwtbV9A/Z9AaTB0Bjb25zdCBib3REYXRhID0gdGhhdDsKCmFzc2VydChsaW5rcy51dGlscy5pc09iamVjdChib3REYXRhKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmd1bWVudCBtdXN0IGJlIGFuIG9iamVjdC5gKTsKCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CiAgICAKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdEJvdCA9PT0gdHJ1ZSkgewogICAgICAgIC8vIFJlbW92ZSBhcnRpZmFjdCBib3RzLgogICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgCiAgICB9IGVsc2UgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIC8vIFN0cmlwIGFydGlmYWN0IGluc3RhbmNlIGRhdGEgZnJvbSBib3QuCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRJbnN0YW5jZUlEOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwoKICAgICAgICAvLyBSZW1vdmUgc29tZSBvdGhlcnMuCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5jcmVhdG9yOwoKICAgICAgICAvLyBHaXZlIGVhY2ggYm90IGEgY2hhbmNlIHRvIHN0cmlwIGluc3RhbmNlIGRhdGEgZnJvbSB0aGUgY29weSBvZiBpdHMgb3duIGJvdCBkYXRhLgogICAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKGRhdGEuaWQsICdvbkFCU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhJywgeyBkYXRhIH0pKTsKICAgIH0KfScAwtbV9A/87gQPaXNFZ2dEZXBlbmRlbmN5AgQAwtbV9A/t+wZSQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hYklEKSAmJiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5yZWNvcmRLZXkpOycAwtbV9A/87gQPaXNBc2tEZXBlbmRlbmN5AgQAwtbV9A/A/AYqQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hc2tJRCk7JwDC1tX0D/zuBBBvbkFueUJvdHNDaGFuZ2VkAgQAwtbV9A/r/AbJCEAvLyBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cgpmb3IgKGNvbnN0IGNoYW5nZWQgb2YgdGhhdCkgewogICAgaWYgKGNoYW5nZWQgPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIC8vIDEpIG9ubHkgY2FyZSBhYm91dCBib3RzIHdpdGggYXJ0aWZhY3QgdGFncwogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lIHx8ICFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSBjb250aW51ZTsKCiAgICAvLyAyKSBhcnRpZmFjdCBtdXN0IGJlIHJlY29uc3RpdHV0ZWQuCiAgICBpZiAoIWNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCkgY29udGludWU7CgogICAgaWYgKHRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGFuZ2VzIG9uIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gZGV0ZWN0ZWQsIGNhbGxpbmcgdG8gdXBkYXRlIGV4cGVyaWVuY2UuYCwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgY2hhbmdlZEJvdElkOiBjaGFuZ2VkLmJvdC5pZCwKICAgICAgICAgICAgICAgIGNoYW5nZWRUYWdzOiBjaGFuZ2VkLnRhZ3MsCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0IGluc3RhbmNlICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gY2hhbmdlZCBidXQgZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KJwDC1tX0D/zuBBlleHBlcmllbmNlVGlja1JhdGVMaW1pdE1TAgQAwtbV9A+1hQcENTAwMCcAwtbV9A/87gQWY29sbGVjdFNoYXJkc0xpc3RlblRhZwIEAMLW1fQPuoUHGW9uQUJBcnRpZmFjdENvbGxlY3RTaGFyZHMnAMLW1fQP/O4ECGRlYnVnRXhwAgQAwtbV9A/UhQcFZmFsc2UnAMLW1fQP/O4EF2lzUmVjb25zdGl0dXRpb25FbmFibGVkAgQAwtbV9A/ahQd8QGlmIChjb25maWdCb3QudGFncy5hYkFydGlmYWN0UmVjb25zdGl0dXRpb24gPT09IGZhbHNlKSB7CiAgICByZXR1cm4gZmFsc2U7Cn0KCi8vIFJlY29uc3RpdHV0aW9uIG9uIGJ5IGRlZmF1bHQuCnJldHVybiB0cnVlOycAwtbV9A/87gQXYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMCBADC1tX0D9eGB9AYQGNvbnN0IHsgc2hhcmRCb3RzIH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgcmVxdWlyZWQgdG8gYmUgYW4gYm90IGFycmF5LmApOwoKLyoqIEtlZXAgdHJhY2sgb2YgZGVwZW5kZW5jeSBoYXNoZXMuIFRoaXMgcHJldmVudHMgZHVwbGljYXRlcyBpbiB0aGUgYXJ0aWZhY3QgZGVwZW5kZW5jaWVzLiAqLwpjb25zdCBkZXBlbmRlbmN5SGFzaGVzID0gbmV3IFNldCgpOwoKbGV0IG1lcmdlZFNoYXJkOiBBQkFydGlmYWN0U2hhcmQgPSB7CiAgICBkYXRhOiB7fSwKICAgIGRlcGVuZGVuY2llczogW10sCn07Cgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgY29uc3QgYm90U2hvcnRJZCA9IHNoYXJkQm90LmlkLnN1YnN0cmluZygwLCA1KTsKCiAgICBsZXQgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKICAgIGlmIChzaGFyZEJvdC50YWdzW3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10pIHsKICAgICAgICBpZiAoc2hhcmRCb3RbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSkgewogICAgICAgICAgICBzaGFyZCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShzaGFyZEJvdFt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHRhZyBpcyBkZWZpbmVkIGJ1dCBpcyBub3QgYSB2YWxpZCBmdW5jdGlvbi5gIH07CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgc2hhcmQ6YCwgc2hhcmQpOwogICAgfQoKICAgIGlmIChzaGFyZCkgewogICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQpKSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCBtdXN0IGJlIGFuIG9iamVjdC5gIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGF0YSkgewogICAgICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzT2JqZWN0KHNoYXJkLmRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgJ2RhdGEnIHByb3BlcnR5IG11c3QgYmUgYW4gb2JqZWN0LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2hhbGxvdyBtZXJnZSBzaGFyZCdzIGRhdGEgcHJvcGVydGllcyBpbnRvIGNvbWJpbmVkIGFydGlmYWN0IGRhdGEuCiAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRhdGEgPSB7IC4uLm1lcmdlZFNoYXJkLmRhdGEsIC4uLnNoYXJkLmRhdGEgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc0FycmF5KHNoYXJkLmRlcGVuZGVuY2llcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCAnZGVwZW5kZW5jaWVzJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIGFycmF5LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgdGhhdCBkZXBlbmRlbmN5IGlzIG9uZSBvZiB0aGUgc3VwcG9ydGVkIHR5cGVzLgogICAgICAgICAgICAgICAgaWYgKCF0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSAmJiAhdGhpc0JvdC5pc0Fza0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIGhhcyBhIGRlcGVuZGVuY3kgZW50cnkgdGhhdCBpcyBuZWl0aGVyIGFuIGVnZyBvciBhc2sgZGVwZW5kZW5jeSB0eXBlLmAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBkZXBlbmRlbmN5IGlzbnQgYWxyZWFkeSBjb2xsZWN0ZWQuCiAgICAgICAgICAgICAgICBjb25zdCBoYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgZGVwZW5kZW5jeSk7CgogICAgICAgICAgICAgICAgaWYgKCFkZXBlbmRlbmN5SGFzaGVzLmhhcyhoYXNoKSkgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lIYXNoZXMuYWRkKGhhc2gpOwogICAgICAgICAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBNYWtlIHN1cmUgd2UgaGF2ZSBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeS4KaWYgKG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIG11c3QgbGlzdCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeSBpbiBvcmRlciB0byByZWNvbnN0aXR1dGUgcHJvcGVybHkuYCB9Owp9Cgpjb25zdCByZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0ID0gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIHNoYXJkOiBtZXJnZWRTaGFyZCwKfQoKcmV0dXJuIHJlc3VsdDsnAMLW1fQP/O4EF2NhblVzZXJVcGRhdGVFeHBlcmllbmNlAgQAwtbV9A+onwfOCUBjb25zdCB7CiAgICByZW1vdGVJZCA9IGNvbmZpZ0JvdC5pZCwKICAgIHNoYXJkQm90Cn0gPSB0aGF0ID8/IHt9CgppZiAoc2hhcmRCb3QgJiYgCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlECikgewogICAgLy8gTmVlZCB0byBmaWd1cmUgb3V0IGlmIHRoaXMgdXNlciBpcyBhbGxvd2VkIHRvIHVwZGF0ZSB0aGUgZXhwZXJpZW5jZSBvZiB0aGlzIGFydGlmYWN0IGluc3RhbmNlLgogICAgbGV0IGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKCiAgICBzd2l0Y2ggKHNoYXJkQm90LnNwYWNlKSB7CiAgICAgICAgY2FzZSAnc2hhcmVkJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgY2FzZSAndGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBiYXNpY2FsbHkgb3duZWQgYnkgdGhpcyB1c2VyLgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncmVtb3RlVGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHJlbW90ZVRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBvd25lZCBieSBzb21lb25lIGVsc2UuCiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnbG9jYWwnOgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAndGVtcExvY2FsJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgYm90IHNwYWNlOmAsIHNoYXJkQm90LnNwYWNlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIGNhblVzZXJVcGRhdGU7Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHByb3ZpZGVkIHNoYXJkQm90IGRvZXMgbm90IGFwcGVhciB0byBiZSBmcm9tIGFuIGFydGlmYWN0IGluc3RhbmNlLmAsIHNoYXJkQm90KTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKfScAwtbV9A/87gQaYWJDcmVhdGVBcnRpZmFjdFByb21pc2VCb3QCBADC1tX0D/eoB+IVQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0U2hhcmQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLAogICAgc3BhY2UgPSAnc2hhcmVkJywKfSA9IHRoYXQgPz8ge307CgoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYm90RGF0YSA9IFtdOwpjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0QnVuZGxlKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RTaGFyZCB9KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdlbmVyYXRlZCBhYkFydGlmYWN0QnVuZGxlOmAsIGFiQXJ0aWZhY3RCdW5kbGUpOwp9Cgpib3REYXRhW3Byb21pc2VJZF0gPSB7CiAgICBpZDogcHJvbWlzZUlkLAogICAgc3BhY2UsCiAgICB0YWdzOiB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoYWJBcnRpZmFjdEJ1bmRsZSksCiAgICAgICAgYWJBcnRpZmFjdFByb21pc2U6IHRydWUsCiAgICB9Cn0KCi8vIENyZWF0ZSBhcnRpZmFjdCBwcm9taXNlIHRocm91Z2ggYWJDcmVhdGVCb3RzLiAKLy8gVGhpcyB3aWxsIHRyaWdnZXIgYXJ0aWZhY3QncyBvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSBhbmQgaXQgd2lsbCBmaW5kCi8vIHRoaXMgYXJ0aWZhY3QgcHJvbWlzZSBhbmQgdXNlIHRoZSBkYXRhIHRvIHJlY29uc3RpdHV0ZSBpdC4KbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdERhdGEsIHNvdXJjZUV2ZW50OiAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnIH0pOwoKY29uc3Qgd2FpdEZvclJlY29uc3RpdHV0aW9uID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnVuY3Rpb24gY2xlYW51cCgpIHsKICAgICAgICBvcy5yZW1vdmVCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKTsKICAgICAgICBvcy5yZW1vdmVCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKGxpc3RlbmVyVGhhdCkgewogICAgICAgIGlmIChsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIHx8CiAgICAgICAgICAgIGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgICkgewogICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgIHJlc29sdmUobGlzdGVuZXJUaGF0KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkKGxpc3RlbmVyVGhhdCkgewogICAgICAgIGlmIChsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIHx8CiAgICAgICAgICAgIGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgICkgewogICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IobGlzdGVuZXJUaGF0LmVycm9yTWVzc2FnZSkpOwogICAgICAgIH0KICAgIH0KCiAgICBvcy5hZGRCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKTsKICAgIG9zLmFkZEJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCk7Cn0pCgpjb25zdCByZWNvbnN0aXR1dGVSZXN1bHQgPSBhd2FpdCB3YWl0Rm9yUmVjb25zdGl0dXRpb247CgpyZXR1cm4gcmVjb25zdGl0dXRlUmVzdWx0LnNoYXJkQm90czsnAMLW1fQP/O4EFmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUCBADC1tX0D9i+B5kIQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdFNoYXJkLAp9ID0gdGhhdDsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHsKICAgIG5hbWU6IGFiQXJ0aWZhY3ROYW1lLAogICAgZm9ybWF0VmVyc2lvbjogMSwKICAgIGRhdGE6IGFiQXJ0aWZhY3RTaGFyZC5kYXRhLAogICAgZGVwZW5kZW5jaWVzOiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLAp9CgovLyBHZW5lcmF0ZSB0aGUgYXJ0aWZhY3QgaWQsIHdoaWNoIGlzIHNoYTI1NiBoYXNoIG9mIHRoZSBjb3JlIGNvbnRlbnRzIG9mIHRoZSBhcnRpZmFjdC4KYWJBcnRpZmFjdEJ1bmRsZS5pZCA9IGNyeXB0by5zaGEyNTYoYWJBcnRpZmFjdEJ1bmRsZSk7CgovLyBTdG9yZSBzb21lIGV4dHJhIG1ldGFkYXRhIHByb3BlcnRpZXMgd2l0aCB0aGUgYXJ0aWZhY3QuCi8vIFRoZXNlIGFyZSBub3QgY29yZSB0byB0aGUgYXJ0aWZhY3QncyBmdW5jdGlvbmFsaXR5IGJ1dCBtYXkgYmUgdXNlZnVsIGFzIGFydGlmYWN0cyBldm9sdmUuCmFiQXJ0aWZhY3RCdW5kbGUuY2FzdWFsT1NWZXJzaW9uID0gb3MudmVyc2lvbigpOwphYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXAgPSBEYXRlVGltZS5ub3coKS50b0lTTygpOwphYkFydGlmYWN0QnVuZGxlLmFiU2hlbGxWZXJzaW9uID0gYCR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1ham9yVmVyc2lvbn0uJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWlub3JWZXJzaW9ufWA7CgpyZXR1cm4gYWJBcnRpZmFjdEJ1bmRsZTsnAMLW1fQP/O4EBmNyZWF0ZQIEAMLW1fQP8sYHKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAMLW1fQP/O4EE2lzRXhwZXJpZW5jZUVuYWJsZWQCBADC1tX0D5nHB3RAaWYgKGNvbmZpZ0JvdC50YWdzLmFiQXJ0aWZhY3RFeHBlcmllbmNlID09PSB0cnVlKSB7CiAgICByZXR1cm4gdHJ1ZTsKfQoKLy8gRXhwZXJpZW5jZSBvZmYgYnkgZGVmYXVsdC4KcmV0dXJuIGZhbHNlOycAwtbV9A/87gQeYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50AgQAwtbV9A+OyAfJHEBjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLCAvLyBbUnlhbiBDb29rXTogSSB3aWxsIG5lZWQgdGhpcyB3aGVuIEkgZ2V0IGJhY2sgdG8gYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZS4KfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MgPSB7fTsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYWxyZWFkeSBoYXMgYSBkb2N1bWVudCBsb2FkZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmxldCBleHBlcmllbmNlQXV0aDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCmlmICghZXhwZXJpZW5jZUF1dGguYXV0aG9yaXplZCkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEFydGlmYWN0IGV4cGVyaWVuY2Ugd2FzIG5vdCBhdXRob3JpemVkLiBSZWFzb246ICR7ZXhwZXJpZW5jZUF1dGguZmFpbHVyZVJlYXNvbn1gKTsKICAgIHJldHVybjsKfQoKLy8gR2V0IHRoZSBhcnRpZmFjdCBpbnN0YW5jZSdzIHNoYXJlZCBkb2N1bWVudCBhcyB3ZWxsIGFzIHRoZSBleHBlcmllbmNlIG1hcC4KY29uc3QgZG9jdW1lbnQgPSBhd2FpdCBvcy5nZXRTaGFyZWREb2N1bWVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwgYGFydGlmYWN0SW5zdGFuY2VfJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gLCAnbWFpbicpOwpjb25zdCBleHBlcmllbmNlTWFwID0gZG9jdW1lbnQuZ2V0TWFwKCdleHBlcmllbmNlJyk7Cgpjb25zdCBza2lwS2V5cyA9IG5ldyBTZXQoWwogICAgJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnLAogICAgLy8gQWRkIG1vcmUga2V5cyBoZXJlIGlmIG5lZWRlZAogICAgLy8gJ3NvbWVPdGhlcktleScsCiAgICAvLyAneWV0QW5vdGhlcktleScKXSk7Cgpjb25zdCBleHBlcmllbmNlU3ViID0gZXhwZXJpZW5jZU1hcC5kZWVwQ2hhbmdlcy5zdWJzY3JpYmUoKGV2ZW50cykgPT4gewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9uIGRlZXAgY2hhbmdlczpgLCBldmVudHMpOwogICAgfQoKICAgIC8vIENvbGxlY3QgYWxsIGNoYW5nZWQga2V5cwogICAgY29uc3QgYWxsS2V5cyA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZXZ0IG9mIGV2ZW50cyA/PyBbXSkgewogICAgICAgIGNvbnN0IG0gPSBldnQ/LmNoYW5nZXM7CiAgICAgICAgaWYgKG0gJiYgdHlwZW9mIG0ua2V5cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBmb3IgKGNvbnN0IGsgb2YgbS5rZXlzKCkpIHsKICAgICAgICAgICAgICAgIGFsbEtleXMuYWRkKGspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFNraXAgaWYgKmFsbCogY2hhbmdlcyBhcmUgaW5zaWRlIHRoZSBza2lwIGxpc3QKICAgIGNvbnN0IHNob3VsZFNraXAgPSBhbGxLZXlzLnNpemUgPiAwICYmIFsuLi5hbGxLZXlzXS5ldmVyeSgoaykgPT4gc2tpcEtleXMuaGFzKGspKTsKICAgIGlmIChzaG91bGRTa2lwKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYWxsIHRvIGFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlLCB0aGUgb25seSBjaGFuZ2UgdG8gdGhlIGV4cGVyaWVuY2Ugd2VyZSBzcGVjaWFsIHJlc2VydmVkIHByb3BlcnRpZXMuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0pOwoKdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gPSB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3VifTsKCmlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGluc3RhbmNlIGRvY3VtZW50IGxvYWRlZDpgLCB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSk7CgogICAgY29uc3QgZXhwZXJpZW5jZUpTT04gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VNYXAudG9KU09OKCkpKTsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gbG9hZGVkIGV4cGVyaWVuY2UgbWFwIHN0YXRlOmAsIGV4cGVyaWVuY2VKU09OKTsKfQoKY29uc3QgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9IGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJyk7CgppZiAoYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9PT0gdHJ1ZSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0aW5nIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGZyb20gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEltbWVkaWF0ZWx5IGdpdmUgdGhlIHNoYXJkIGJvdHMgdGhlIGN1cnJlbnQgZXhwZXJpZW5jZSBzdGF0ZS4KICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbml0aWFsaXppbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEluaXRpYWxpemUgdGhlIGV4cGVyaWVuY2Ugc3RhdGUgd2l0aCB0aGUgY3VycmVudCBzaGFyZCBkYXRhLgogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7ICAgIAp9CicAwtbV9A/87gQgYWJVbmxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQCBADC1tX0D9jkB4kGQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IHsgZG9jdW1lbnQsIGV4cGVyaWVuY2VNYXAsIGV4cGVyaWVuY2VTdWIgfSA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOyAKCiAgICBpZiAoZXhwZXJpZW5jZVN1YikgewogICAgICAgIGV4cGVyaWVuY2VTdWIudW5zdWJzY3JpYmUoKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bnN1YnNjcmliZWQgZnJvbSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBleHBlcmllbmNlIG1hcC5gKTsKICAgICAgICB9CiAgICB9CgogICAgZGVsZXRlIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZW1vdmVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGRvY3VtZW50LmApOwogICAgfQp9JwDC1tX0D/zuBB5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMCBADC1tX0D+LqB7QCQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgIHJldHVybiBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0pOwoKcmV0dXJuIHNoYXJkQm90czsnAMLW1fQP/O4EJmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlAgQAwtbV9A+X7QfpB0Bjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICByZXR1cm47Cn0KCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCBpbnN0YW5jZURvYyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmIChpbnN0YW5jZURvYykgewogICAgICAgIGNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUR9KTsKCiAgICAgICAgY29uc3QgeyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1YiB9ID0gaW5zdGFuY2VEb2M7CgogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VEYXRhID0gZXhwZXJpZW5jZU1hcC50b0pTT04oKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSB3aXRoIGV4cGVyaWVuY2Ugc3RhdGU6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlRGF0YSkpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHdoaXNwZXIoc2hhcmRCb3RzLCAnb25BQkFydGlmYWN0RXhwZXJpZW5jZScsIHsgZGF0YTogZXhwZXJpZW5jZURhdGEgfSkpOwogICAgfQp9JwDC1tX0D/zuBCJhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlAgQAwtbV9A+B9QfQKEBpbXBvcnQgeyBTaGFyZWRNYXAgfSBmcm9tICdjYXN1YWxvcyc7Cgpjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKCF0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMpIHsKICAgIHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcyA9IG5ldyBTZXQoKTsKfQoKaWYgKHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSB1cGRhdGUgaXMgYWxyZWFkeSBpbiBwcm9ncmVzcyBmb3IgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgIH0KICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgY29uc3QgaW5zdGFuY2VEb2MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICBpZiAoaW5zdGFuY2VEb2MpIHsKICAgICAgICBjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKICAgICAgICAvLyBOZWVkIHRvIGFzayBpZiB0aGlzIHVzZXIgaXMgYWxsb3dlZCB0byB1cGRhdGUgdGhlIGV4cGVyaWVuY2Ugb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgICAgICBjb25zdCBjYW5Vc2VyVXBkYXRlID0gYXdhaXQgdGhpc0JvdC5jYW5Vc2VyVXBkYXRlRXhwZXJpZW5jZSh7IHJlbW90ZUlkOiBjb25maWdCb3QuaWQsIHNoYXJkQm90OiBzaGFyZEJvdHNbMF0gfSk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2FuIHVzZXIgdXBkYXRlIGV4cGVyaWVuY2UgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7c2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQuc3Vic3RyaW5nKDAsIDcpfT9gLCBjYW5Vc2VyVXBkYXRlKTsKICAgICAgICB9CgogICAgICAgIGlmIChjYW5Vc2VyVXBkYXRlKSB7CiAgICAgICAgICAgIGxldCBjb2xsZWN0U2hhcmRSZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0OwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbGxlY3RTaGFyZFJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMoeyBzaGFyZEJvdHMgfSk7CgogICAgICAgICAgICAgICAgaWYgKCFjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY29sbGVjdFNoYXJkUmVzdWx0LnJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOmAsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBgY29sbGVjdFNoYXJkUmVzdWx0OmAsIEpTT04uc3RyaW5naWZ5KGNvbGxlY3RTaGFyZFJlc3VsdCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29sbGVjdFNoYXJkUmVzdWx0ICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBlbnRyeSBpbiBleHBlcmllbmNlTWFwIGlmIHRoZSBkYXRhIGlzIGFjdHVhbGx5IGRpZmZlcmVudC4KICAgICAgICAgICAgICAgIGNvbnN0IGV4cGVyaWVuY2VNYXA6IFNoYXJlZE1hcCA9IGluc3RhbmNlRG9jLmV4cGVyaWVuY2VNYXA7CgogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBzaGFyZCBkYXRhIG1pZ2h0IGJlIHVuZGVmaW5lZC9udWxsCiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGEgPSAoY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhKSA/IGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhIDoge307CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGFLZXlzID0gT2JqZWN0LmtleXMoc2hhcmREYXRhKTsKICAgICAgICAgICAgICAgIGNvbnN0IGtleXNUb0RlbGV0ZSA9IFtdOwoKICAgICAgICAgICAgICAgIC8vIFNpbXBsZSBkZWVwLWVxdWFsaXR5IGNoZWNrIGZvciBKU09OLXNlcmlhbGl6YWJsZSB2YWx1ZXMKICAgICAgICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSAoYSwgYikgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChhID09PSBiKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYSkgPT09IEpTT04uc3RyaW5naWZ5KGIpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyAxKSBVcHNlcnQgb25seSB3aGVuIGRpZmZlcmVudAogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2Ygc2hhcmREYXRhS2V5cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1ZhbCA9IHNoYXJkRGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbCA9IGV4cGVyaWVuY2VNYXAuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0VxdWFsKG9sZFZhbCwgbmV3VmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBleHBlcmllbmNlTWFwIGtleSAiJHtrZXl9ImAsIEpTT04uc3RyaW5naWZ5KHsgb2xkVmFsLCBuZXdWYWwgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KGtleSwgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMikgQ29sbGVjdCBrZXlzIHRoYXQgZXhpc3QgaW4gdGhlIG1hcCBidXQgbm90IGluIHRoZSBzaGFyZCBkYXRhCiAgICAgICAgICAgICAgICAvLyAgICAod2UgYXZvaWQgbXV0YXRpbmcgdGhlIG1hcCB3aGlsZSBpdGVyYXRpbmcgaXQpCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBleHBlcmllbmNlTWFwLmtleXMoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09ICdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBkZWxldGUgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZC4gSXRzIGEgc3BlY2lhbCBwcm9wZXJ0eS4KICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICghc2hhcmREYXRhS2V5cy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleXNUb0RlbGV0ZS5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMpIFJlbW92ZSBzdGFsZSBrZXlzCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzVG9EZWxldGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlbGV0aW5nIHN0YWxlIGV4cGVyaWVuY2VNYXAga2V5ICIke2tleX0iYCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgIT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSBpbnN0YW5jZSBkb2N1bWVudCBub3QgbG9hZGVkLmApOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IHVwZGF0ZSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBiZWNhdXNlIGluc3RhbmNlIGRvY3VtZW50cyBoYXZlIG5vdCBiZWVuIGluaXRpYWxpemVkLmApOwogICAgfQp9Cgp0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuZGVsZXRlKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsnAMLW1fQP/O4EDG9uSW5zdEpvaW5lZAIEAMLW1fQP0p0IkAZAbWFza3MuaW5zdEpvaW5lZCA9IHRydWU7Cgpjb25zdCBhcnRpZmFjdEluc3RhbmNlcyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwoKZm9yIChsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RJbnN0YW5jZXMpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb2FkaW5nIGFydGlmYWN0IGluc3RhbmNlIGRvY3VtZW50IGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWApOwogICAgfQogICAgCiAgICB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9CgovLyBDb2xsZWN0IGFsbCByZWNvbnN0aXR1dGlvbiBzaWduYWwgYm90cyBpbnRvIGEgbG9jYWwgc2V0IHNvIHdlIGtub3cgd2hlbiB0aGV5IGFyZSByZW1vdmVkLgpjb25zdCByZWNvbnN0aXR1dGluZ1NpZ25hbEJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiUmVjb25zdGl0dXRpbmdBcnRpZmFjdFNpZ25hbEJvdCk7CmZvciAoY29uc3Qgc2lnbmFsQm90IG9mIHJlY29uc3RpdHV0aW5nU2lnbmFsQm90cykgewogICAgdGhpc0JvdC52YXJzLnJlY29uc3RpdHV0aW5nU2lnbmFsQm90SWRzLmFkZChzaWduYWxCb3QuaWQpOwp9CgppZiAocmVjb25zdGl0dXRpbmdTaWduYWxCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgdGhpc0JvdC5hYkNoZWNrQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkF0UmVzdCgpOwp9JwDC1tX0D/zuBA5vbkFueUJvdHNBZGRlZAIEAMLW1fQP46MIwQVAaWYgKCFtYXNrcy5pbnN0Sm9pbmVkKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFkZGVkQm90cyA9IHRoYXQuYm90czsKCmZvciAoY29uc3QgYm90IG9mIGFkZGVkQm90cykgewogICAgaWYgKGJvdCA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjUwKTsKCiAgICAgICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGV0ZWN0ZWQgYWRkZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7Ym90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9LmApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgICAgIH0KICAgIH0gCiAgICBlbHNlIGlmIChib3QudGFncy5hYlJlY29uc3RpdHV0aW5nQXJ0aWZhY3RTaWduYWxCb3QpIHsKICAgICAgICB0aGlzQm90LnZhcnMucmVjb25zdGl0dXRpbmdTaWduYWxCb3RJZHMuYWRkKGJvdC5pZCk7CiAgICB9Cn0nAMLW1fQP/O4EGm9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkAgQAwtbV9A+lqQjeBUBsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdwcmludGFydGlmYWN0ZXhwZXJpZW5jZScsIChhcmdzKSA9PiB7CiAgICBjb25zdCBpbnN0YW5jZURvY3MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzOwoKICAgIGxldCBhbGxFeHBlcmllbmNlID0ge307CgogICAgZm9yIChsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gaW5zdGFuY2VEb2NzKSB7CiAgICAgICAgY29uc3QgZXhwZXJpZW5jZU1hcCA9IGluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0uZXhwZXJpZW5jZU1hcDsKICAgICAgICBjb25zdCBleHBlcmllbmNlSlNPTiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXhwZXJpZW5jZU1hcC50b0pTT04oKSkpOwogICAgICAgIGFsbEV4cGVyaWVuY2VbYWJBcnRpZmFjdEluc3RhbmNlSURdID0gZXhwZXJpZW5jZUpTT047CiAgICB9CgogICAgY29uc29sZS5sb2coYFtwcmludGFydGlmYWN0ZXhwZXJpZW5jZV0gQWxsIGN1cnJlbnQgYXJ0aWZhY3QgaW5zdGFuY2UgZXhwZXJpZW5jZSBzdGF0ZXM6YCwgYWxsRXhwZXJpZW5jZSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQcmludCBhbGwgY3VycmVudGx5IGxvYWRlZCBhcnRpZmFjdCBpbnN0YW5jZSBleHBlcmllbmNlIHN0YXRlcyB0byB0aGUgY29uc29sZS4nLAogICAgdXNhZ2U6IFsnLnByaW50YXJ0aWZhY3RleHBlcmllbmNlJ10KfSk7JwDC1tX0D/zuBBhhYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgCBADC1tX0D4SvCNwSQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgZXhwQXV0aFJlc3VsdDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhdXRob3JpemVkOiB1bmRlZmluZWQsCiAgICBmYWlsdXJlUmVhc29uOiB1bmRlZmluZWQsCn0KCmlmIChnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUpIHsKICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZDsKCiAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKfQoKbGV0IG15QXV0aEJvdCA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgppZiAoIW15QXV0aEJvdCkgewogICAgLy8gTm90IHNpZ25lZCBpbiwgbmVlZCB0byBzaWduIGluIHRvIHVzZSBhcnRpZmFjdCBleHBlcmllbmNlLgogICAgbGV0IGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UgPSBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2U7CgogICAgaWYgKCFhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlKSB7CiAgICAgICAgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgdGl0bGU6ICdTaWduIEluIFJlcXVpcmVkJywKICAgICAgICAgICAgY29udGVudDogJ1RoaXMgc2VydmVyIGhhcyBhcnRpZmFjdHMgdGhhdCB3b3JrIGJlc3Qgd2hlbiB5b3XigJlyZSBzaWduZWQgaW4uIElmIHlvdSBjb250aW51ZSB3aXRob3V0IHNpZ25pbmcgaW4sIHRoZSBhcnRpZmFjdHMgbWF5IG5vdCBzdGF5IGluIHN5bmMuJywKICAgICAgICAgICAgY29uZmlybVRleHQ6ICdTaWduIEluJywKICAgICAgICAgICAgY2FuY2VsVGV4dDogJ0NvbnRpbnVlIFdpdGhvdXQnCiAgICAgICAgfSk7CgogICAgICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IGFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2U7CiAgICB9CgogICAgY29uc3QgY29uZmlybWVkID0gYXdhaXQgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKICAgIGRlbGV0ZSBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmU7CgogICAgaWYgKGNvbmZpcm1lZCkgewogICAgICAgIG15QXV0aEJvdCA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICB9IGVsc2UgewogICAgICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX3NpZ25faW4nOwogICAgICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSA9IGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbjsKICAgICAgICAKICAgICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKICAgIH0KfQoKaWYgKCFteUF1dGhCb3QpIHsKICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwogICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3Vua25vd24nOwogICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlID0gZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uOwoKICAgIHJldHVybiBleHBBdXRoUmVzdWx0Owp9CgovLyBjb25zdCBhZG1pblBlcm1pc3Npb25SZXN1bHQgPSBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24obGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWUpOwovLyBjb25zb2xlLmxvZyhgYWRtaW5QZXJtaXNzaW9uUmVzdWx0OmAsIGFkbWluUGVybWlzc2lvblJlc3VsdCk7CgovLyBpZiAoYWRtaW5QZXJtaXNzaW9uUmVzdWx0LnN1Y2Nlc3MpIHsKLy8gICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IHRydWU7CgovLyAgICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Ci8vIH0gZWxzZSB7Ci8vICAgICBleHBBdXRoUmVzdWx0LmF1dGhvcml6ZWQgPSBmYWxzZTsKLy8gICAgIGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX2luc3RfcGVybWlzc2lvbic7Ci8vICAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUgPSBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb247CgovLyAgICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Ci8vIH0KCmV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IHRydWU7CgpyZXR1cm4gZXhwQXV0aFJlc3VsdDsnAMLW1fQP/O4EEW9uQUJCZWZvcmVQdWJsaXNoAgQAwtbV9A/fwQiGBEBpZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwDC1tX0D/zuBBJvbkFCQmVmb3JlRG93bmxvYWQCBADC1tX0D+bFCIYEQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCi8vIFtJTVBPUlRBTlQgTk9URV0gKFNlcHRlbWJlciA0LCAyMDI1KTogVGhpcyBpcyBhIHdvcmthcm91bmQgdW50aWwgd2UgaGF2ZSBhYiBhcnRpZmFjdCBleHBlcmllbmNlIHN0YXRlIHdvcmtpbmcuIEFzIHNvb24gYXMgZXhwZXJpZW5jZSBzdGF0ZSBob29rZWQKLy8gdXAsIHRoaXMgcHJvY2VzcyBzaG91bGQgYmUgZWxpbWluYXRlZCBiZWNhdXNlIGl0IGNoYW5nZXMgdGhlIGFydGlmYWN0IGluc3RhbmNlIGlkIHdoaWNoIGlzIG5vdCBpZGVhbCAtIGJ1dCBpcyBzZXJ2aWNhYmxlIHVudGlsCi8vIHRoZW4gZm9yIHRoZSBuZWVkcyB3ZSBoYXZlIG5vdy4KCi8vIE5haXZlbHkgdXBkYXRlIGFsbCBhcnRpZmFjdCBzaGFyZHMgaW4gdGhpcyBpbnN0IGJlZm9yZSBhYiBwdWJsaXNoZXMgYW4gZWdnLgphd2FpdCB0aGlzQm90LmFiVXBkYXRlQWxsQXJ0aWZhY3RTaGFyZHMoKTsnAMLW1fQP/O4EGWFiVXBkYXRlQWxsQXJ0aWZhY3RTaGFyZHMCBADC1tX0D+3JCKEFQGNvbnN0IGFydGlmYWN0SW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMoKTsKCmZvciAoY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RJbnN0YW5jZXMpIHsKICAgIGNvbnN0IHNoYXJkQm90ID0gYXJ0aWZhY3RJbnN0YW5jZXNbYWJBcnRpZmFjdEluc3RhbmNlSURdLmZpbmQoYiA9PiBiICE9IG51bGwpOwoKICAgIGlmICghc2hhcmRCb3QpIHsKICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bmFibGUgdG8gdXBkYXRlIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGJlY2F1c2UgdGhlcmUgd2VyZSBubyBzaGFyZCBib3RzIGZvdW5kLmApOwogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gc2hhcmRCb3QudGFncy5hYkFydGlmYWN0TmFtZTsKICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKICAgIAogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBhYkFydGlmYWN0SW5zdGFuY2VPd25lciB9KTsKfScAwtbV9A/87gQcb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZAIEAMLW1fQPj88I4wJAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKaWYgKHRoYXQuc291cmNlRXZlbnQgIT09ICdkb3dubG9hZF9hcnRpZmFjdF9wYXR0ZXJuJykgewogICAgdGhpc0JvdC5hYlByZXByb2Nlc3NCb3REYXRhVG9BcnRpZmFjdFByb21pc2VzKHsgYm90RGF0YTogdGhhdC5ib3REYXRhIH0pOwp9JwDC1tX0D/zuBCVhYlByZXByb2Nlc3NCb3REYXRhVG9BcnRpZmFjdFByb21pc2VzAgQAwtbV9A/z0Qj6D0AvKioKICogVGhpcyBmdW5jdGlvbiB0YWtlcyBib3REYXRhIChmcm9tIG9uQUJQcmVwcm9jZXNzQmVmb3JlKiBjYWxscykgYW5kIHJlcGxhY2VzIGFueSBzaGFyZCBib3RzIHdpdGggYXJ0aWZhY3QgcHJvbWlzZSBib3RzLgogKi8KCmNvbnN0IGJvdERhdGEgPSB0aGF0Py5ib3REYXRhOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3RhcnRpbmcgYm90RGF0YTpgLCB7Li4uYm90RGF0YX0pOwp9Cgphc3NlcnQodHlwZW9mIGJvdERhdGEgPT09ICdvYmplY3QnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdERhdGEgaXMgYSByZXF1aXJlZCBvYmplY3QuYCk7CgovLyBEZXRlY3QgYXJ0aWZhY3QgaW5zdGFuY2VzIHRoYXQgbmVlZCB0byBiZSBjb252ZXJ0ZWQgaW50byBhcnRpZmFjdCBwcm9taXNlcy4KCi8qKiBrZXk6IGFydGlmYWN0IGluc3RhbmNlIGlkLCB2YWx1ZTogYXJ0aWZhY3QgcHJvbWlzZSBkYXRhLiAqLwpjb25zdCBhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlID0gbmV3IFNldCgpOyAvLyBLZWVwIHRyYWNrIG9mIHdoYXQgYXJ0aWZhY3QgaW5zdGFuY2UgSURzIGhhdmUgaGFkIGFuIGFydGlmYWN0IHByb21pc2UgbWFkZS4KCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSAmJiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBUaGlzIGlzIGFuIGFydGlmYWN0IGluc3RhbmNlIHNoYXJkIGJvdC4KICAgICAgICBpZiAoIWFydGlmYWN0SW5zdGFuY2VzV2l0aFByb21pc2UuaGFzKGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgLy8gVGhpcyBhcnRpZmFjdCBpbnN0YW5jZSBuZWVkcyBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUgZm9yIGl0LgogICAgICAgICAgICBjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7CgogICAgICAgICAgICBib3REYXRhW3Byb21pc2VJZF0gPSB7CiAgICAgICAgICAgICAgICBpZDogcHJvbWlzZUlkLAogICAgICAgICAgICAgICAgc3BhY2U6ICdzaGFyZWQnLAogICAgICAgICAgICAgICAgdGFnczogewogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjogZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGU6IGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RQcm9taXNlOiB0cnVlLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb252ZXJ0ZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHtkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGludG8gYW4gYXJ0aWZhY3QgcHJvbWlzZTpgLCBib3REYXRhW3Byb21pc2VJZF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmFkZChkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpOwogICAgICAgIH0KCiAgICAgICAgLy8gUmVtb3ZlIGFydGlmYWN0IGluc3RhbmNlIHNoYXJkIGJvdCBmcm9tIGJvdERhdGEgdGhhdCBpcyBhYm91dCB0byBiZSBwdWJsaXNoZWQuCiAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZmluaXNoZWQgYm90RGF0YTpgLCB7Li4uYm90RGF0YX0pOwp9JwDC1tX0D/zuBB1vbkFCQmVmb3JlQ29weUJvdHNUb0NsaXBib2FyZAIEAMLW1fQP7uEIyAdAY29uc3QgeyBib3RzIH0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cn0KCi8vIFtJTVBPUlRBTlQgTk9URV0gKFNlcHRlbWJlciA0LCAyMDI1KTogVGhpcyBpcyBhIHdvcmthcm91bmQgdW50aWwgd2UgaGF2ZSBhYiBhcnRpZmFjdCBleHBlcmllbmNlIHN0YXRlIHdvcmtpbmcuIEFzIHNvb24gYXMgZXhwZXJpZW5jZSBzdGF0ZSBob29rZWQKLy8gdXAsIHRoaXMgcHJvY2VzcyBzaG91bGQgYmUgZWxpbWluYXRlZCBiZWNhdXNlIGl0IGNoYW5nZXMgdGhlIGFydGlmYWN0IGluc3RhbmNlIGlkIHdoaWNoIGlzIG5vdCBpZGVhbCAtIGJ1dCBpcyBzZXJ2aWNhYmxlIHVudGlsCi8vIHRoZW4gZm9yIHRoZSBuZWVkcyB3ZSBoYXZlIG5vdy4KY29uc3QgdXBkYXRlZEluc3RhbmNlcyA9IG5ldyBTZXQoKTsKCmZvciAobGV0IGJvdCBvZiBib3RzKSB7CiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICBpZiAoIXVwZGF0ZWRJbnN0YW5jZXMuaGFzKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICB1cGRhdGVkSW5zdGFuY2VzLmFkZChib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCk7CgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoewogICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lLAogICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXI6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0KfScAwtbV9A/87gQRY2hlY2tBdFJlc3RXYWl0TVMCBADC1tX0D7fpCAM1MDAnAMLW1fQP/O4ECm9uQm90QWRkZWQCBADC1tX0D7vpCDVAdGhpc0JvdC52YXJzLnJlY29uc3RpdHV0aW5nU2lnbmFsQm90SWRzID0gbmV3IFNldCgpOycBBGJvdHMkOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjAScAwtbV9A/x6QgPY2FsY01hcFJvdGF0aW9uAgQAwtbV9A/y6QiBDkBjb25zdCB7IG1hcFBvc2l0aW9uLCBhdXhSb3RhdGlvbiB9ID0gdGhhdDsKCmxldCBUSFJFRSA9IHRoaXNCb3QudmFycy5USFJFRTsKaWYgKCFUSFJFRSkgewogICAgVEhSRUUgPSBhd2FpdCBpbXBvcnQoJ3RocmVlJyk7CiAgICB0aGlzQm90LnZhcnMuVEhSRUUgPSBUSFJFRTsKfQoKY29uc3QgZGVnVG9SYWQgPSAoZCkgPT4gKGQgKiBNYXRoLlBJKSAvIDE4MDsKCmZ1bmN0aW9uIHRhbmdlbnRCYXNpc0Zyb21Mb25MYXQobG9uRGVnLCBsYXREZWcpIHsKICAgIGNvbnN0IGxvbiA9IGRlZ1RvUmFkKGxvbkRlZyk7CiAgICBjb25zdCBsYXQgPSBkZWdUb1JhZChsYXREZWcpOwoKICAgIC8vIE5vcm1hbCBwb2ludGluZyBvdXQgb2YgdGhlIGdsb2JlLgogICAgY29uc3QgbiA9IG5ldyBUSFJFRS5WZWN0b3IzKAogICAgICAgIE1hdGguY29zKGxhdCkgKiBNYXRoLmNvcyhsb24pLAogICAgICAgIE1hdGguY29zKGxhdCkgKiBNYXRoLnNpbihsb24pLAogICAgICAgIE1hdGguc2luKGxhdCksCiAgICApLm5vcm1hbGl6ZSgpOwoKICAgIC8vIEJ1aWxkIGVhc3Qvbm9ydGggZnJvbSB0aGUgbm9ybWFsCiAgICBjb25zdCB3b3JsZFVwID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMSk7CiAgICBsZXQgZWFzdCA9IHdvcmxkVXAuY2xvbmUoKS5jcm9zcyhuKS5ub3JtYWxpemUoKTsKICAgIGlmIChlYXN0Lmxlbmd0aFNxKCkgPT09IDApIGVhc3QgPSBuZXcgVEhSRUUuVmVjdG9yMygxLCAwLCAwKTsgLy8gcG9sZSBndWFyZAogICAgY29uc3Qgbm9ydGggPSBuLmNsb25lKCkuY3Jvc3MoZWFzdCkubm9ybWFsaXplKCk7CgogICAgLy8gQmFzaXM6IGNvbHVtbnMgPSBlYXN0LCBub3J0aCwgbm9ybWFsCiAgICBjb25zdCBiYXNpcyA9IG5ldyBUSFJFRS5NYXRyaXg0KCkubWFrZUJhc2lzKGVhc3QsIG5vcnRoLCBuKTsKICAgIHJldHVybiBiYXNpczsKfQoKLy8gR2l2ZW4gcG9ydGFsIGJvdCB0YWdzIGFuZCBhIGdpem1vIG9iamVjdDNELCBhbGlnbiBnaXptbyByb3RhdGlvbgpmdW5jdGlvbiBjYWxjTWFwUm90YXRpb24obWFwUG9zaXRpb24sIGF1eFJvdGF0aW9uKSB7CiAgICBjb25zdCBsb24gPSBtYXBQb3NpdGlvbi54OyAvLyBYID0gbG9uZ2l0dWRlIChkZWdyZWVzKQogICAgY29uc3QgbGF0ID0gbWFwUG9zaXRpb24ueTsgLy8gWSA9IGxhdGl0dWRlIChkZWdyZWVzKQogICAgY29uc3QgYXV4UXVhdCA9IGF1eFJvdGF0aW9uLnF1YXRlcm5pb247CgogICAgaWYgKGxvbiA9PSBudWxsIHx8IGxhdCA9PSBudWxsIHx8IGF1eFF1YXQgPT0gbnVsbCkgcmV0dXJuOwoKICAgIGNvbnN0IHF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbihhdXhRdWF0LngsIGF1eFF1YXQueSwgYXV4UXVhdC56LCBhdXhRdWF0LncpOwoKICAgIGNvbnN0IGJhc2lzID0gdGFuZ2VudEJhc2lzRnJvbUxvbkxhdChsb24sIGxhdCk7CiAgICBjb25zdCBiYXNpc0ludiA9IGJhc2lzLmNsb25lKCkuaW52ZXJ0KCk7CiAgICBjb25zdCBiYXNpc0ludlF1YXQgPSBuZXcgVEhSRUUuUXVhdGVybmlvbigpLnNldEZyb21Sb3RhdGlvbk1hdHJpeChiYXNpc0ludik7CgogICAgLy8gQXBwbHkgdGhlIHRhbmdlbnQgY29ycmVjdGlvbgogICAgY29uc3Qgd29ybGRRdWF0ID0gcXVhdC5jbG9uZSgpLnByZW11bHRpcGx5KGJhc2lzSW52UXVhdCk7CgogICAgcmV0dXJuIG5ldyBSb3RhdGlvbih7IHF1YXRlcm5pb246IHsgeDogd29ybGRRdWF0LngsIHk6IHdvcmxkUXVhdC55LCB6OiB3b3JsZFF1YXQueiwgdzogd29ybGRRdWF0LncgfX0pOwp9CgpyZXR1cm4gY2FsY01hcFJvdGF0aW9uKG1hcFBvc2l0aW9uLCBhdXhSb3RhdGlvbik7JwDC1tX0D/HpCA5hYkZpbGVUaW1lY29kZQIEAMLW1fQP9PcIZkBjb25zdCBkYXRlOiBEYXRlVGltZSA9IHRoYXQ/LmRhdGUgPz8gRGF0ZVRpbWUubm93KCk7CnJldHVybiBkYXRlLnRvVVRDKCkudG9Gb3JtYXQoJ3l5eXlNTWRkLUhIbW1zcycpOycAwtbV9A/x6QgGc3lzdGVtAgQAwtbV9A/b+AgOYWIuc2hlbGwudXRpbHMnAMLW1fQP8ekIDGFiQ29tcGlsZUNTUwIEAMLW1fQP6vgIggRAbGV0IGJvdHMgPSB0aGF0OwoKYm90cyA9IEFycmF5LmlzQXJyYXkoYm90cykgPyBib3RzIDogW2JvdHNdOwoKbGV0IGNzcyA9IFtdOwoKZm9yIChsZXQgYm90IG9mIGJvdHMpIHsKICAgIGZvciAobGV0IGtleSBpbiBib3QudGFncykgewogICAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnY3NzJykpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgQ1NTIGtleTogJHtrZXl9YCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3NzLnB1c2goYm90LnRhZ3Nba2V5XSk7CiAgICAgICAgfQogICAgfQp9Cgpjb25zdCBjb21waWxlZCA9IGNzcy5qb2luKCdcblxuJyk7CmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNvbXBpbGVkIENTUzpcblxuYCwgY29tcGlsZWQpOwp9CgpyZXR1cm4gY29tcGlsZWQ7JwDC1tX0D/HpCAhhYklnbm9yZQIEAMLW1fQP7fwIBHRydWUnAMLW1fQP8ekIB2FiU2hlbGwCBADC1tX0D/L8CAR0cnVlJwDC1tX0D/HpCAlhYlZlcnNpb24CBADC1tX0D/f8CAUxMC4zNycAwtbV9A/x6QgNYWJMb2dBbmRUb2FzdAIEAMLW1fQP/fwIuApAbGV0IG1lc3NhZ2U7CmxldCBkdXJhdGlvbjsKbGV0IGxvZ1R5cGUgPSAnbG9nJzsKbGV0IG5hbWUgPSBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHk7CmxldCB0b2FzdCA9IHRydWU7CmxldCBhYkxvZyA9IHRydWU7CmxldCBjb25zb2xlTG9nID0gdHJ1ZTsKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIG1lc3NhZ2UgPSB0aGF0OwogICAgZHVyYXRpb24gPSB0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0LCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwOwp9IGVsc2UgewogICAgbWVzc2FnZSA9IHRoYXQubWVzc2FnZTsKICAgIGR1cmF0aW9uID0gdGhhdC5kdXJhdGlvbiA/PyAodGhpc0JvdC5lc3RpbWF0ZVJlYWRpbmdUaW1lKHsgdGV4dDogdGhhdC5tZXNzYWdlLCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwKTsKICAgIG5hbWUgPSB0aGF0Lm5hbWUgPz8gbmFtZTsKICAgIGxvZ1R5cGUgPSB0aGF0LmxvZ1R5cGUgPz8gbG9nVHlwZTsKICAgIHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0b2FzdDsKICAgIGFiTG9nID0gdGhhdC5hYkxvZyA/PyBhYkxvZzsKfQoKaWYgKGxvZ1R5cGUgPT09ICdsb2cnKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnd2FybmluZycgfHwgbG9nVHlwZSA9PT0gJ3dhcm4nKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogV2FybmluZzogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUud2FybihuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChgV2FybmluZzogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnZXJyb3InKSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogRXJyb3I6ICcgKyBtZXNzYWdlKTsKICAgIGlmIChjb25zb2xlTG9nKSBjb25zb2xlLmVycm9yKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBFcnJvcjogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9JwDC1tX0D/HpCAhyZW1lbWJlcgIEAMLW1fQPtocJKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMLW1fQP8ekIBWFiTG9nAgQAwtbV9A/dhwmlAkBpZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICB0aGlzQm90LmFiTG9nQW5kVG9hc3QoewogICAgICAgIG1lc3NhZ2U6IHRoYXQsCiAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgIGFiTG9nOiB0cnVlLAogICAgICAgIGNvbnNvbGVMb2c6IHRydWUsCiAgICB9KTsKfSBlbHNlIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgLi4udGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgYWJMb2c6IHRydWUsCiAgICAgICAgY29uc29sZUxvZzogdHJ1ZSwKICAgIH0pOwp9JwDC1tX0D/HpCBNlc3RpbWF0ZVJlYWRpbmdUaW1lAgQAwtbV9A+DigncA0Bjb25zdCB7CiAgICB0ZXh0ID0gJycsCiAgICB3b3Jkc1Blck1pbnV0ZSA9IDI1MCwKICAgIGRlbGF5VGltZSA9IDUwMCwKfSA9IHRoYXQ7CgovLyBDb3VudCB3b3JkcyAocm91Z2ggYXBwcm94aW1hdGlvbiBieSBzcGxpdHRpbmcgb24gd2hpdGVzcGFjZSkKY29uc3Qgd29yZENvdW50ID0gdGV4dC50cmltKCkuc3BsaXQoL1xzKy8pLmxlbmd0aDsKbGV0IHRvdGFsVGltZU1zID0gMDsKCmlmICh3b3JkQ291bnQgPiAwKSB7CiAgICAvLyBDYWxjdWxhdGUgcmVhZGluZyB0aW1lIGluIG1pbGxpc2Vjb25kcwogICAgY29uc3Qgd29yZHNQZXJTZWNvbmQgPSB3b3Jkc1Blck1pbnV0ZSAvIDYwOwogICAgY29uc3QgcmVhZGluZ1RpbWVNcyA9IE1hdGguY2VpbCgod29yZENvdW50IC8gd29yZHNQZXJTZWNvbmQpICogMTAwMCk7CgogICAgdG90YWxUaW1lTXMgPSByZWFkaW5nVGltZU1zICsgZGVsYXlUaW1lOwp9CgpyZXR1cm4gdG90YWxUaW1lTXM7JwDC1tX0D/HpCAhpc09iamVjdAIEAMLW1fQP4I0JOUByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdvYmplY3QnICYmICFBcnJheS5pc0FycmF5KHRoYXQpOycAwtbV9A/x6QgHaXNBcnJheQIEAMLW1fQPmo4JHEByZXR1cm4gQXJyYXkuaXNBcnJheSh0aGF0KTsnAMLW1fQP8ekICGlzU3RyaW5nAgQAwtbV9A+3jgkhQHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZyc7JwDC1tX0D/HpCA9nZXRFcnJvck1lc3NhZ2UCBADC1tX0D9mOCcACQGZ1bmN0aW9uIGdldEVycm9yTWVzc2FnZShlcnJvcikgewogICAgaWYgKGVycm9yKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcnJvciA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgcmV0dXJuIGVycm9yOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IubWVzc2FnZSkgewogICAgICAgICAgICByZXR1cm4gZXJyb3IubWVzc2FnZTsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yLmVycm9yKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck1lc3NhZ2UoZXJyb3IuZXJyb3IpOwogICAgICAgIH0KICAgIH0KfQoKcmV0dXJuIGdldEVycm9yTWVzc2FnZSh0aGF0KTsnAMLW1fQP8ekIB2FiVG9hc3QCBADC1tX0D5qRCacCQGlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICBhYkxvZzogZmFsc2UsCiAgICAgICAgY29uc29sZUxvZzogZmFsc2UsCiAgICB9KTsKfSBlbHNlIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgLi4udGhhdCwKICAgICAgICB0b2FzdDogdHJ1ZSwKICAgICAgICBhYkxvZzogZmFsc2UsCiAgICAgICAgY29uc29sZUxvZzogZmFsc2UsCiAgICB9KTsKfScAwtbV9A/x6QgYaGFzR2VvbG9jYXRpb25QZXJtaXNzaW9uAgQAwtbV9A/Ckwn8AkBsZXQgaGFzUGVybWlzc2lvbiA9IGZhbHNlOwoKdHJ5IHsKICAgIGlmIChnbG9iYWxUaGlzLm5hdmlnYXRvciAmJiBuYXZpZ2F0b3IucGVybWlzc2lvbnMpIHsKICAgICAgICBjb25zdCBzdGF0dXMgPSBhd2FpdCBuYXZpZ2F0b3IucGVybWlzc2lvbnMucXVlcnkoeyBuYW1lOiAnZ2VvbG9jYXRpb24nIH0pOwogICAgICAgIGhhc1Blcm1pc3Npb24gPSBzdGF0dXM/LnN0YXRlID09PSAnZ3JhbnRlZCc7CiAgICB9Cn0gY2F0Y2ggKGUpIHsgCiAgICBjb25zb2xlLmVycm9yKGBDYXVnaHQgYW4gZXJyb3Igd2lsbCBxdWVyeWluZyBwZXJtaXNzaW9ucy4gRXJyb3I6YCwgYWIubGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpKTsKfQoKcmV0dXJuIGhhc1Blcm1pc3Npb247JwDC1tX0D/HpCAVpc0JvdAIEAMLW1fQPv5YJVEByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdvYmplY3QnICYmIHRoYXQudGFncyAmJiB0aGF0LmlkICYmIHRoYXQuc3BhY2UgJiYgdGhhdC52YXJzOycAwtbV9A/x6QgOYXBwbHlLZXlUb1RleHQCBADC1tX0D5SXCeUIQGxldCB7IHRleHQsIGtleSB9ID0gdGhhdDsKCnRleHQgPSAodGV4dCA/PyAnJykudG9TdHJpbmcoKTsKCmNvbnN0IERFQlVHID0gZmFsc2U7Cgpzd2l0Y2ggKGtleSkgewogICAgY2FzZSAnQmFja3NwYWNlJzoKICAgICAgICB0ZXh0ID0gdGV4dC5zdWJzdHJpbmcoMCwgdGV4dC5sZW5ndGggLSAxKTsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ0RlbGV0ZSc6CiAgICBjYXNlICdDbGVhcic6CiAgICAgICAgdGV4dCA9ICcnOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnRW50ZXInOgogICAgICAgIHRleHQgKz0gJ1xuJzsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ1RhYic6CiAgICAgICAgLy8gQ29udmVydCB0YWJzIHRvIHNwYWNlcy4KICAgICAgICB0ZXh0ICs9ICcgJy5yZXBlYXQoNCk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdFc2NhcGUnOgogICAgY2FzZSAnU2hpZnQnOgogICAgY2FzZSAnQ2Fwc0xvY2snOgogICAgY2FzZSAnQ29udHJvbCc6CiAgICBjYXNlICdBbHQnOgogICAgY2FzZSAnTWV0YSc6CiAgICBjYXNlICdDb250ZXh0TWVudSc6CiAgICBjYXNlICdQYWdlVXAnOgogICAgY2FzZSAnUGFnZURvd24nOgogICAgY2FzZSAnSG9tZSc6CiAgICBjYXNlICdFbmQnOgogICAgY2FzZSAnSGVscCc6CiAgICBjYXNlICdGMSc6CiAgICBjYXNlICdGMic6CiAgICBjYXNlICdGMyc6CiAgICBjYXNlICdGNCc6CiAgICBjYXNlICdGNSc6CiAgICBjYXNlICdGNic6CiAgICBjYXNlICdGNyc6CiAgICBjYXNlICdGOCc6CiAgICBjYXNlICdGOSc6CiAgICBjYXNlICdGMTAnOgogICAgY2FzZSAnRjExJzoKICAgIGNhc2UgJ0YxMic6CiAgICBjYXNlICdGMTMnOgogICAgY2FzZSAnQXJyb3dVcCc6CiAgICBjYXNlICdBcnJvd1JpZ2h0JzoKICAgIGNhc2UgJ0Fycm93RG93bic6CiAgICBjYXNlICdBcnJvd0xlZnQnOgogICAgICAgIC8vIElnbm9yZSBrZXlzdHJva2UuCiAgICAgICAgaWYgKERFQlVHKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaWdub3Jpbmcga2V5c3Ryb2tlOmAsIGtleSk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICB0ZXh0ICs9IGtleTsKfQoKcmV0dXJuIHRleHQ7JwEEYm90cyRkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUBJwDC1tX0D/qfCQZzeXN0ZW0CBADC1tX0D/ufCQ9hYi5zaGVsbC5zZWFyY2gnAMLW1fQP+p8JBGZvcm0CBADC1tX0D4ugCQdub3RoaW5nJwDC1tX0D/qfCQ5hYlJldHJpZXZlRmlsZQIEAMLW1fQPk6AJggFALy9wdWxsIGRvd24gZmlsZSBkYXRhCmlmICghdGhhdC51cmwpCnsKICAgIHJldHVybiAibm8gZmlsZSB1cmwgc3VwcGxpZWQiOwp9CgpsZXQgZGF0YSA9IGF3YWl0IG9zLmdldEZpbGUodGhhdC51cmwpOwoKcmV0dXJuIGRhdGE7JwDC1tX0D/qfCRBhYlJldHJpZXZlUmVjb3JkAgQAwtbV9A+WoQnsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwDC1tX0D/qfCQhyZW1lbWJlcgIEAMLW1fQPg6YJKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMLW1fQP+p8JDW1hbmlmZXN0YXRpb24CBADC1tX0D6qmCSjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDC1tX0D/qfCQ5vbkxvb2t1cEFCRWdncwIEAMLW1fQP0aYJzzJAY29uc3QgeyAKICAgIGFiSUQsCiAgICBhYlZlcnNpb24sCiAgICBpbml0aWFsQm9vdCwKICAgIGF1dG9IYXRjaCwKICAgIHJldHVyblR5cGUsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5LAogICAgdG9hc3QgPSB0cnVlLAogICAgc2hvd0luZGljYXRvciA9IHRydWUsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsLiAob3B0aW9uYWwpCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBsb2FkaW5nICIgKyBhYklEKTsKCi8vY2xlYXIgYWItMQppZiAobGlua3MubWFuaWZlc3RhdGlvbiAmJiBjb25maWdCb3QudGFncy5tZW51UG9ydGFsID09ICJhYk1lbnUiKSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfQoKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvYWRpbmcgJHthYklEfWB9KTsKfQoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2V0UmVjb3JkOmAsIHsuLi5nZXRSZWNvcmR9KTsKfQoKbGV0IGVnZ0RhdGE7CgovL3RoaXMgbG9naWMgaGFuZGxlcyB0aGUgcmV0cmlldmVkIGRhdGEsIHNlYXJjaGVzIGFnYWluIGlmIG5vbmUgY2FtZSB0aHJvdWdoCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmIChwb3NzaWJsZUF1dGguaWQgPT0gcmVjb3JkS2V5ICYmCiAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSAmJgogICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJyZWNvcmRfbm90X2ZvdW5kIgogICAgKSB7CiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIikgewogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CiAgICB9IGVsc2UgaWYgKGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfbG9nZ2VkX2luIikgewogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgogICAgICAgIGlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MgJiYgCiAgICAgICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfYXV0aG9yaXplZCIKICAgICAgICApIHsKICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICAgICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgICAgICB9CiAgICB9Cn0KCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmICh0b2FzdCkgeyAKICAgICAgICBvcy50b2FzdChgbm8gZGF0YSBmb3VuZCBpbiAke2FiSUR9YCk7CiAgICB9CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICB9CgogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQplbHNlIHsKICAgIGNvbnN0IHB1YmxpY1JlYWRUZXN0ID0gZ2V0UmVjb3JkLm1hcmtlcnMuaW5kZXhPZigicHVibGljUmVhZCIpOwogICAgY29uc3QgYXV0aG9yID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCiAgICBpZiAocHVibGljUmVhZFRlc3QgIT0gLTEgJiYgYXV0aG9yKSB7CiAgICAgICAgaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGVnZ0hhdGNoRXZlbnQgPSBhYklEOwoKICAgICAgICAgICAgb3MucmVjb3JkRXZlbnQobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgZWdnSGF0Y2hFdmVudCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vcGFja2FnZSB0aGUgcmVjb3JkIGRhdGEKICAgIGVnZ0RhdGEgPSBnZXRSZWNvcmQuZGF0YTsKCiAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgLy8gQ2hhbmdlIGluaXRpYWwgdGFyZ2V0IHZlcnNpb24gb2YgdGhlIGVnZyBpZiBhYlZlcnNpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gYWJWZXJzaW9uOwogICAgfQp9CgppZiAocmV0dXJuVHlwZSAhPSBudWxsKSB7CiAgICBpZiAoZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGxldCB2ZXJzaW9uID0gZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiAtIDE7CgogICAgICAgICAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKGFiVmVyc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gYWJWZXJzaW9uIC0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgICAgICAgICBjb25zdCByZXR1cm5EYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShlZ2dEYXRhVVJMKTsKCiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0dXJuRGF0YTsKICAgICAgICB9IGVsc2UgaWYgKHJldHVyblR5cGUgPT09ICJlZ2ciKSB7CiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKGVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkpOwogICAgICAgICAgICBjb25zdCBmaWxlVVVJRCA9IHZlcnNpb25BcnJheVtlZ2dEYXRhLm1heFZlcnNpb24gLSAxXTsKICAgICAgICAgICAgY29uc3QgZmlsZW5hbWVoYXNoTFRNID0gY3J5cHRvLnNoYTI1NihmaWxlVVVJRCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGV1cmxoYXNoTFRNID0gImF1eF8iICsgZmlsZW5hbWVoYXNoTFRNICsgJy5hdXgnOwogICAgICAgICAgICBjb25zdCB0YXJnZXRMVE1VUkwgPSAiaHR0cHM6Ly9idWlsZGVyLWx0bS1maWxlcy5zMy5hbWF6b25hd3MuY29tLyIgKyBmaWxldXJsaGFzaExUTTsKICAgICAgICAgICAgY29uc3QgbyA9IHsKICAgICAgICAgICAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgICAgICAgICAgICB1cmw6IHRhcmdldExUTVVSTAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbGV0IGZpbGVHZXQgPSBhd2FpdCB3ZWJob29rKG8pOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5tYW5pZmVzdE92byh7CiAgICBhYklELAogICAgc3R1ZGlvOiByZWNvcmRLZXksCiAgICBkaW1Nb2QsCiAgICBzcGFjZU1vZCwKICAgIGVnZ0RhdGEsCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwKfSk7CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKbGlua3MudXRpbHMuYWJMb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogIiArIGFiSUQgKyAiIGxvYWRlZCwgdmVyc2lvbiAiICsgZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIGdldFJlY29yZC5kYXRhLm1heFZlcnNpb24pOwoKcmV0dXJuIHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBoYXRjaGVkQm90czogbWFuaWZlc3RSZXN1bHQ/LmhhdGNoZWRCb3RzLAp9OycAwtbV9A/6nwkLbWFuaWZlc3RPdm8CBADC1tX0D6HZCdQPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCAmJiAhY29uZmlnQm90LnRhZ3MuYWJTdGF5QXdha2UpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgppZiAobGlua3Mub3ZvQm90KSB7CiAgICBkZXN0cm95KGxpbmtzLm92b0JvdCk7Cn0KCmxldCBlZ2dNb2QgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBpbml0aWFsVGltZXI6IHRydWUsCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgc291cmNlRXZlbnQsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaW50ZXJhY3RPdm8oKTsKICAgIGAsCiAgICBmb3JtOiAiZWdnIiwKICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VMYWJlbENvbG9yLAogICAgcHJvZ3Jlc3NCYXJDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvciwKICAgIHByb2dyZXNzQmFyQmFja2dyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxTaXplOiAwLjUsCiAgICBvblBvaW50ZXJFbnRlcjogYEAKICAgICAgICBtYXNrcy50aXBJZCA9IGF3YWl0IG9zLnRpcCh0YWdzLmFiSUQgKyAnIHYnICsgdGFncy50YXJnZXRWZXJzaW9uKTsKICAgIGAsCiAgICBvblBvaW50ZXJFeGl0OiBgQAogICAgICAgIGlmIChtYXNrcy50aXBJZCkgewogICAgICAgICAgICBvcy5oaWRlVGlwcyhtYXNrcy50aXBJZCk7CiAgICAgICAgfQogICAgYCwKICAgIGxhYmVsUG9zaXRpb246ICJmcm9udCIsCiAgICBvcmllbnRhdGlvbk1vZGU6ICJiaWxsYm9hcmRGcm9udCIsCiAgICBvbkRlc3Ryb3k6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5tYXNrcy5vdm9Cb3QgPSBudWxsOwogICAgYCwKICAgIGVnZ1RpbWVyOiBgQAogICAgICAgIGlmICh0YWdzLnByb2dyZXNzQmFyIDwgMSkgewogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyICs9IDAuMTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge3doaXNwZXIodGhpc0JvdCwgImVnZ1RpbWVyIik7fSwgNzUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNCb3Qub25DbGljaygpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciA9IG51bGw7CiAgICAgICAgfQogICAgYAp9OwoKCmNvbnN0IG92byA9IGF3YWl0IGNyZWF0ZShlZ2dEYXRhLCBlZ2dNb2QsIGRpbU1vZCwgc3BhY2VNb2QpOwptYXNrcy5vdm9Cb3QgPSBnZXRMaW5rKG92byk7CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBvdm8udmFycy5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGUgPSBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU7Cn0KCmlmIChvdm8udGFncy5hdXRvSGF0Y2gpIHsKICAgIGNvbnN0IGhhdGNoZWRCb3RzID0gYXdhaXQgdGhpc0JvdC5oYXRjaE92byhvdm8pOwogICAgcmV0dXJuIHsgaGF0Y2hlZEJvdHMgfTsKfQplbHNlIHsKICAgIG92by50YWdzLnByb2dyZXNzQmFyID0gMDsKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBvdm8udGFncy5tYXhWZXJzaW9uOwogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9JwDC1tX0D/qfCQlvbktleURvd24CBADC1tX0D/boCYIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAMLW1fQP+p8JCGhhdGNoT3ZvAgQAwtbV9A/37gmdFUAvL2xvZ2ljIGZvciBoYXRjaGluZyBvZiBhbiBhYgpzaG91dCgnb3ZvTWVudVJlc2V0Jyk7CgovL2RhdGEgaW4gcmVnYXJkcyB0byB3aGF0IGFiIGlzIGdvaW5nIHRvIGJlIGhhdGNoZWQKY29uc3Qgb3ZvID0gdGhhdDsKCi8vaGF0Y2ggc3BlY2lmaWMgdmFyaWFibGVzCmxldCBpbml0aWFsQm9vdCA9IG92by50YWdzLmluaXRpYWxCb290OwpsZXQgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLnN0YWJsZVZlcnNpb24gPz8gb3ZvLnRhZ3MudGFyZ2V0VmVyc2lvbjsKCmlmICgoY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uIHx8IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uKSAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIpKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uOwp9CgovL3RhcmdldGVkIHZlcnNpb25zCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYiB8fCAhaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpKQp7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiZmVlZGJhY2siKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5mZWVkYmFja1ZlcnNpb247CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJjdXJyZW50IikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgfQogICAgZWxzZSBpZiAoIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy52ZXJzaW9uCiAgICB9CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG51bGw7Cn0KCmlmIChpc05hTih0YXJnZXRWZXJzaW9uKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKfQoKbGV0IHZlcnNpb25BcnJheSA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5OwpsZXQgZmlsZVVSTCA9IHZlcnNpb25BcnJheVt0YXJnZXRWZXJzaW9uIC0gMV07CmxldCBrZXkgPSBvdm8udGFncy5rZXkgPyBvdm8udGFncy5rZXkgOiBjb25maWdCb3QudGFncy5rZXk7CmxldCBmaWxlR2V0OwoKLy9hY3R1YWwgZmlsZSByZXRyaWV2YWwKdHJ5CnsKICAgIGZpbGVHZXQgPSBhd2FpdCBvcy5nZXRGaWxlKGZpbGVVUkwpOwp9CmNhdGNoIChlKQp7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnbm8gZmlsZSBmb3VuZCcpOwoKICAgIHJldHVybjsKfQoKLy9oYW5kbGluZyBmb3IgZW5jcnlwdGVkIGFiIGZpbGUKaWYgKGNyeXB0by5pc0VuY3J5cHRlZChmaWxlR2V0KSkKewogICAgaWYgKCFrZXkpCiAgICB7CiAgICAgICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCcnLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ0VudGVyIGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBmaWxlR2V0ID0gY3J5cHRvLmRlY3J5cHQoa2V5LCBmaWxlR2V0KTsKCiAgICBpZiAoZmlsZUdldCA9PSBudWxsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnaW5jb3JyZWN0IGtleScpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgCiAgICBmaWxlR2V0ID0gSlNPTi5wYXJzZShmaWxlR2V0KTsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CmVsc2UKewogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KCi8vY2xlYW4gdXAKZGVzdHJveShvdm8pOwoKLy90b2FzdCBpZiBub3Qgb24gc3RhYmxlCmlmKG92by50YWdzLnN0YWJsZVZlcnNpb24gIT0gdGFyZ2V0VmVyc2lvbiAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnQpCnsKICAgIGlmIChvdm8udGFncy5mZWVkYmFja1ZlcnNpb24gPT0gdGFyZ2V0VmVyc2lvbikKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCBmZWVkYmFjayB2ZXJzaW9uIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCB2ZXJzaW9uICIgKyB0YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoICsgIiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9Cn0KCi8vZ2VuZXJhdGUgYm90cyBiYXNlZCBvbiB0aGUgZmlsZSByZXRyaWV2ZWQgKkhFUkUqCmNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsKICAgIGJvdHM6IGZpbGVHZXQsCiAgICBvcmlnaW46IG92by50YWdzLmFiSUQsCiAgICBzdHVkaW86IG92by50YWdzLnN0dWRpbywKICAgIHZlcnNpb246IHRhcmdldFZlcnNpb24sCiAgICBpbml0aWFsQm9vdDogaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzOiBvdm8udGFncy5lZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBvdm8udmFycy5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudDogb3ZvLnRhZ3Muc291cmNlRXZlbnQsCn0pOwoKcmV0dXJuIG5ld0JvdHM7JwDC1tX0D/qfCQtpbnRlcmFjdE92bwIEAMLW1fQPlYQK6QZALy9tYW51YWwgaGF0Y2ggbWVudQpjb25zdCBvdm9Cb3QgPSB0aGF0ID8gdGhhdCA6IGxpbmtzLm92b0JvdDsKCmlmICghb3ZvQm90KSB7CiAgICByZXR1cm47Cn0KCnNob3V0KCJvdm9NZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiT3ZvTWVudSI7CgptYXNrcy5vbkdyaWRDbGljayA9IGBACiAgICBzaG91dCgib3ZvTWVudVJlc2V0Iik7CmA7Cm1hc2tzLm92b01lbnVSZXNldCA9IGBACiAgICBtYXNrcy5vbkdyaWRDbGljayA9IG51bGw7CiAgICBtYXNrcy5vdm9NZW51UmVzZXQgPSBudWxsOwoKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKYDsKCm9zLnR3ZWVuVG8ob3ZvQm90LCAxNSw0NSw0NSwgNSk7Cgpjb25zdCBlZ2dNZW51QnV0dG9uID0gewogICAgYWJPdm9NZW51OiB0cnVlLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG92b0JvdDogZ2V0TGluayhvdm9Cb3QpLAogICAgY29sb3I6IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHRhcmdldFZlcnNpb246IG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sCiAgICBsYWJlbDogYGhhdGNoICR7b3ZvQm90LnRhZ3MuYWJJRH0gdiR7b3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbn0gb2YgJHtvdm9Cb3QudGFncy5tYXhWZXJzaW9ufWAsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBvdm9NZW51UmVzZXQ6IGBACiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIGAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaGF0Y2hPdm8obGlua3Mub3ZvQm90KTsKICAgIGAsCn07CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihlZ2dNZW51QnV0dG9uKTsnAMLW1fQP+p8JBmNyZWF0ZQIEAMLW1fQP/4oKKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAMLW1fQP+p8JEGNoYW5nZU92b1ZlcnNpb24CBADC1tX0D6aLCvACQC8vbG9naWMgZm9yIHZlcnNpb24gY2hhbmdpbmcgd2hlbiBtYW51YWxseSBoYXRjaGluZyBhbiBhYgpjb25zdCBvdm9Cb3QgPSBsaW5rcy5vdm9Cb3Q7CgpsZXQgbmV3VmVyc2lvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uLCB7CiAgICBwbGFjZWhvbGRlcjogImVudGVyIGEgdmVyc2lvbiBmcm9tIDEgdG8gIiArIG92b0JvdC50YWdzLm1heFZlcnNpb24KfSk7Cgpvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uID0gbmV3VmVyc2lvbjsKb3ZvQm90LnRhZ3MubGFiZWwgPSAndicrIG5ld1ZlcnNpb247Cgpjb25maWdCb3QudGFncy52ZXJzaW9uID0gbmV3VmVyc2lvbjsKCnNob3V0KCJvdm9NZW51UmVzZXQiKTsnAMLW1fQP+p8JBG1lbnUCBADC1tX0D5eOCijwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDC1tX0D/qfCQhhYklnbm9yZQIEAMLW1fQPvo4KBHRydWUnAMLW1fQP+p8JB2FiU2hlbGwCBADC1tX0D8OOCgR0cnVlJwDC1tX0D/qfCQxhYjFMVE1TZWFyY2gCBADC1tX0D8iOCjNALy9zdXBwb3J0IG9sZCBzeW50YXgKdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsnAMLW1fQP+p8JDW9uTG9va3VwQXNrSUQCBADC1tX0D/yOCrIgQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IHNob3dJbmRpY2F0b3IgPSB0aGF0Py5zaG93SW5kaWNhdG9yID8/IHRydWU7CmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOwpjb25zdCBlZ2dQYXJhbWV0ZXJzID0gdGhhdD8uZWdnUGFyYW1ldGVyczsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwpjb25zdCBpZ25vcmVSZXNlcnZlZCA9IHRoYXQ/Lmlnbm9yZVJlc2VydmVkOwpjb25zdCBkYXRhT25seSA9IHRoYXQ/LmRhdGFPbmx5ID8/IGZhbHNlOwoKYXNzZXJ0KHR5cGVvZiBhc2tJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmlmIChzaG93SW5kaWNhdG9yKSB7CiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQoKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgbG9va2luZyB1cCAke2Fza0lEfWAgfSk7Cn0KCi8vQ2hlY2sgZm9yIHJlc2VydmVkIGtleXdvcmRzCmlmIChsaW5rcz8ubGVhcm4/LnRhZ3M/LnJlc2VydmVkQXNrcz8uaW5jbHVkZXMoYXNrSUQpICYmICFpZ25vcmVSZXNlcnZlZCAmJiBhdXRoQm90KSB7CiAgICBpZiAoIWdldEJvdCgiYWJJRE9yaWdpbiIsIGFza0lEKSkgewogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IHRoaXNCb3QubG9va3VwRnJvbVN0dWRpbyh7Li4udGhhdCwgcmVzZXJ2ZWQ6IHRydWUsIGRhdGFPbmx5IH0pOwogICAgICAgIGlmIChsb29rdXBBc2sgJiYgbG9va3VwQXNrLnN1Y2Nlc3MgPT0gdHJ1ZSkgewogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZXR1cm5pbmcgcmVzZXJ2ZWQgYXNrICcke2Fza0lEfScgZm91bmQgaW4gc3R1ZGlvOmAsIGxvb2t1cEFzayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsKICAgICAgICB9CiAgICB9Cn0KCi8vIEZpcnN0IGNoZWNrIHRoZSBjYXN1YWwgY2F0YWxvZyBmb3IgdGhlIGFzay4KY29uc3QgY2FzdWFsQ2F0YWxvZ1VSTCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYXNrcy8ke2Fza0lEfS5hdXhgKTsKCnRyeSB7CiAgICBjb25zdCBjYXN1YWxDYXRhbG9nUmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogJ0dFVCcsIHVybDogY2FzdWFsQ2F0YWxvZ1VSTCB9KTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2FzdWFsIGNhdGFsb2cgcmVzcG9uc2U6YCwgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlKTsKICAgIH0KCiAgICBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDEgJiYgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUpIHsKICAgICAgICAgICAgaWYgKGRhdGFPbmx5KSB7CiAgICAgICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycsCiAgICAgICAgICAgICAgICAgICAgZGF0YTogY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBDYXN1YWwgY2F0YWxvZyByZXNwb25zZSBpcyBhIHYxIGF1eCBmaWxlLgogICAgICAgICAgICAgICAgY29uc3QgbmV3Qm90cyA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyAKICAgICAgICAgICAgICAgICAgICBib3RzOiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS5zdGF0ZSwKICAgICAgICAgICAgICAgICAgICBpZ25vcmVHcmlkRm9jdXM6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiBhc2tJRCwKICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgICAgICAgICAgICAgICAgICBzb3VyY2VFdmVudCwKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJywKICAgICAgICAgICAgICAgICAgICBoYXRjaGVkQm90czogbmV3Qm90cywKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiAmJiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS51cGRhdGVzKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjIgYXV4IGZpbGUuCiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXNrcyBvbmx5IHN1cHBvcnQgdjEgYXV4IGZpbGUgZm9ybWF0LmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UuCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgYXNrIHJlc3BvbnNlLmAsIGNhc3VhbENhdGFsb2dSZXNwb25zZSk7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS4gQ2hlY2sgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmV0dXJuaW5nIGFzayAnJHthc2tJRH0nIGZvdW5kIGluIGNhc3VhbCBjYXRhbG9nOmAsIGxvb2t1cEFzaykKICAgICAgICB9CgogICAgICAgIHJldHVybiBsb29rdXBBc2s7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIERpZCBub3QgZmluZCBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuCn0KCmxvb2t1cEFzayA9IGF3YWl0IHRoaXNCb3QubG9va3VwRnJvbVN0dWRpbyh0aGF0KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEZyb21TdHVkaW8gcmVzdWx0OmAsIHsuLi5sb29rdXBBc2t9KTsKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBsb29rdXBBc2s7JwDC1tX0D/qfCQV0eXBlcwIEAMLW1fQPr68K9gHwn5OEdHlwZSBBQkFza0lET3JpZ2luID0gJ2Nhc3VhbF9jYXRhbG9nJyB8ICdhYl9yZWNvcmQnOwoKaW50ZXJmYWNlIEFCTG9va3VwQXNrSURSZXN1bHQgewogICAgc3VjY2VzczogYm9vbGVhbjsKICAgIG9yaWdpbjogQUJBc2tJRE9yaWdpbjsKICAgIGhhdGNoZWRCb3RzPzogQm90W107Cn0KCmludGVyZmFjZSBBQkxvb2t1cEVnZ1Jlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuLAogICAgaGF0Y2hlZEJvdHM/OiBCb3RbXSwKfQonAMLW1fQP+p8JBWlucHV0AgQAwtbV9A+ksQoo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAwtbV9A/6nwkFaGF0Y2gCBADC1tX0D8uxCsABQC8vc2hvdXQoImhhdGNoIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBrZXk6IGtleSwgYXV0b0hhdGNoOiBib29sZWFuLCByZXR1cm5UeXBlOiBkYXRhL251bGwsIGVnZ1BhcmFtZXRlcnM6IGFyZ30pOwoKY29uc3QgbG9va1VwID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsKCnJldHVybiBsb29rVXA7JwDC1tX0D/qfCQlhYlZlcnNpb24CBADC1tX0D4yzCgUxMC4zNycAwtbV9A/6nwkFbGVhcm4CBADC1tX0D5KzCijwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDC1tX0D/qfCQV1dGlscwIEAMLW1fQPubMKKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAMLW1fQP+p8JC3BlcnNvbmFsaXR5AgQAwtbV9A/gswoo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicAwtbV9A/6nwkQbG9va3VwRnJvbVN0dWRpbwIEAMLW1fQPh7QK+CpAY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsNCmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOw0KY29uc3QgZWdnUGFyYW1ldGVycyA9IHRoYXQ/LmVnZ1BhcmFtZXRlcnM7DQpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQ/LnNvdXJjZUV2ZW50Ow0KY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOw0KY29uc3QgcmVzZXJ2ZWQgPSB0aGF0Py5yZXNlcnZlZDsNCmNvbnN0IGlzQ2hhbm5lbCA9IHRoYXQ/LmlzQ2hhbm5lbDsNCmNvbnN0IGlzVVVBQiA9IHRoYXQ/LmlzVVVBQjsNCmNvbnN0IGRhdGFPbmx5ID0gdGhhdD8uZGF0YU9ubHkgPz8gZmFsc2U7DQoNCmxldCBsb29rdXBBc2s6IEFCTG9va3VwQXNrSURSZXN1bHQ7DQpsZXQgdXNlZFN0dWRpbzsNCg0KaWYgKHRhZ3MuZGVidWcpIHsNCiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsNCn0NCg0KLy8gQ2hlY2sgdGhlIGFiIHJlY29yZCBmb3IgdGhlIGFzay4NCmNvbnN0IGFiRm9ybWF0dGVkQXNrSUQgPSBhc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOw0KDQppZiAodGFncy5kZWJ1Zykgew0KICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJGb3JtYXR0ZWRBc2tJRDpgLCBhYkZvcm1hdHRlZEFza0lEKTsNCn0NCg0KaWYgKHJlc2VydmVkKSB7DQogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbykgew0KICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICE9IGF1dGhCb3QuaWQpIHsNCiAgICAgICAgICAgIGNvbnN0IHBlcm1zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7DQogICAgICAgICAgICBpZiAocGVybXMuc3VjY2Vzcykgew0KICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gcGVybXMuc3R1ZGlvcy5maW5kKChzdHVkKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAoc3R1ZC5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBVc2VyIHBlcm1pc3Npb25zIGZvciBzdHVkaW8iLCBmb3VuZCwgcGVybXMpOw0KICAgICAgICAgICAgICAgIGlmICghZm91bmQpIHsNCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IFVzZXIgZG9lcyBub3QgaGF2ZSBwZXJtaXNzaW9ucyBmb3IgdGhpcyBzdHVkaW8uIikNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdXNlZFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8sIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzICYmIGxvb2t1cEFzay5lcnJvckNvZGUgJiYgbG9va3VwQXNrLmVycm9yQ29kZSA9PSAnbm90X2F1dGhvcml6ZWQnKSB7DQogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oY29uZmlnQm90LnRhZ3Muc3R1ZGlvKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogZmFpbHVyZSBsb29raW5nIHVwIGFzayBpbiBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBMb29rZWQgdXAgYXNrIGluIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICAgIHVzZWRTdHVkaW8gPSBhdXRoQm90Py5pZDsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90Py5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90Py5pZCk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3Q/LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogZmFpbHVyZSBsb29raW5nIHVwIGFzayBpbiB1c2VyIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IExvb2tlZCB1cCBhc2sgaW4gdXNlciBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQp9IGVsc2Ugew0KICAgIHVzZWRTdHVkaW8gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5Ow0KICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYGFza18ke2FiRm9ybWF0dGVkQXNrSUR9YCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsNCiAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFzayBhdHRlbXB0IDE6YCwgey4uLmxvb2t1cEFza30pOw0KICAgIH0NCiAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzKSB7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYWJGb3JtYXR0ZWRBc2tJRCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsNCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMjpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzICYmIGlzVVVBQikgew0KICAgICAgICB1c2VkU3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQ7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2sgYXR0ZW1wdCAzIChpc1VVQUIpOmAsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgfQ0KICAgICAgICBpZihsb29rdXBBc2suZXJyb3JDb2RlICYmIGxvb2t1cEFzay5lcnJvckNvZGUgPT0gJ25vdF9hdXRob3JpemVkJykgew0KICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKCFsb29rdXBBc2suc3VjY2VzcyAmJiBpc0NoYW5uZWwpIHsNCiAgICAgICAgdXNlZFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkOw0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMyAoaXNDaGFubmVsKTpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgIH0NCiAgICAgICAgaWYobG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KbG9va3VwQXNrLm9yaWdpbiA9ICdhYl9yZWNvcmQnOw0KDQppZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgKGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCB8fCByZXNlcnZlZCB8fCBpc0NoYW5uZWwgfHwgaXNVVUFCKSkgew0KICAgIGlmIChkYXRhT25seSkgew0KICAgICAgICByZXR1cm4gbG9va3VwQXNrOw0KICAgIH0gZWxzZSB7DQogICAgICAgIC8vIExvb2t1cCB0aGUgZWdnIHVzaW5nIHRoZSBzdHVkaW9JRCBhbmQgcGF0dGVybklEIGZyb20gdGhlIGFiX3JlY29yZCBhc2suDQogICAgICAgIGNvbnN0IGxvb2t1cEVnZzogQUJMb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogKHJlc2VydmVkIHx8IGlzQ2hhbm5lbCB8fCBpc1VVQUIpID8gYWJGb3JtYXR0ZWRBc2tJRCA6IGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA/PyB1c2VkU3R1ZGlvLCBhdXRvSGF0Y2gsIGVnZ1BhcmFtZXRlcnMsIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgc291cmNlRXZlbnQgfSk7DQogICAgICAgIA0KICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBFZ2c6YCwgey4uLmxvb2t1cEVnZ30pOw0KICAgICAgICB9DQoNCiAgICAgICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBsb29rdXBFZ2cuc3VjY2VzczsNCiAgICAgICAgbG9va3VwQXNrLmhhdGNoZWRCb3RzID0gbG9va3VwRWdnLmhhdGNoZWRCb3RzOw0KICAgIH0NCn0gZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgIWxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCAmJiAhbG9va3VwQXNrLmRhdGEudXJsKSB7DQogICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBmYWxzZTsNCn0NCg0KcmV0dXJuIGxvb2t1cEFzazsnAMLW1fQP+p8JBWRlYnVnAgQAwtbV9A+A3woEdHJ1ZScAwtbV9A/6nwkaYWJDYXN1YWxDYXRhbG9nQXNrSURFeGlzdHMCBADC1tX0D4XfCoIHQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IHVybCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYXNrcy8ke2Fza0lEfS5hdXhgKTsKCmxldCBleGlzdHM7CmxldCByZXNwb25zZTsKCnRyeSB7CiAgICByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsKICAgICAgICBtZXRob2Q6ICdIRUFEJywKICAgICAgICB1cmwsCiAgICB9KQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZXNwb25zZTpgLCByZXNwb25zZSk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIENhbGwgdG8gY2FzdWFsIGNhdGFsb2cgaGFzIGZhaWxlZCwgdGhlIGFzayBpZCBkb2VzIG5vdCBleGlzdCB0aGVyZS4KICAgIC8vIE5PVEU6IEl0IHdvdWxkIGJlIG5pY2UgaWYgdGhlIENhc3VhbCBDYXRhbG9nIGVuZHBvaW50IHJldHVybmVkIGEgNDA0IE5vdCBGb3VuZCBzdGF0dXMgY29kZSBqdXN0IHNvIHdlIGNhbiBydWxlIG91dCBhY3R1YWwgc2VydmVyIGVycm9ycy4KICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBhbiBlcnJvcjpgLCBlKTsKICAgIH0KCiAgICBleGlzdHMgPSBmYWxzZTsKfQoKaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICBleGlzdHMgPSB0cnVlOwp9IGVsc2UgewogICAgZXhpc3RzID0gZmFsc2U7Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEICcke2Fza0lEfScgZXhpc3RzIGluIGNhc3VhbCBjYXRhbG9nP2AsIGV4aXN0cyk7Cn0KCnJldHVybiBleGlzdHM7CicAwtbV9A/6nwkZYWJDaGVja0Fza1VwZGF0ZUF2YWlsYWJsZQIEAMLW1fQPiOYKyw5AY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsKY29uc3QgY3VycmVudEhhc2ggPSB0aGF0Py5jdXJyZW50SGFzaDsKY29uc3QgaGFzaEFsZ29yaXRobSA9IHRoYXQ/Lmhhc2hBbGdvcml0aG0gPz8gJ3NoYTEnOwpjb25zdCBoYXNoRm9ybWF0ID0gdGhhdD8uaGFzaEZvcm1hdCA/PyAnaGV4JzsKCmFzc2VydCh0eXBlb2YgYXNrSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBjdXJyZW50SGFzaCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3VycmVudEhhc2ggaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApCgpjb25zdCBhc2tEYXRhID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLm9uTG9va3VwQXNrSUQoeyBhc2tJRCwgc2hvd0luZGljYXRvcjogZmFsc2UsIGRhdGFPbmx5OiB0cnVlLCBzb3VyY2VFdmVudDogJ2Fza191cGRhdGVfY2hlY2snIH0pOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrRGF0YTpgLCBhc2tEYXRhKTsKfQoKaWYgKGFza0RhdGEuc3VjY2VzcykgewogICAgaWYgKGFza0RhdGEuZGF0YS5wYXR0ZXJuSUQgJiYgYXNrRGF0YS5kYXRhLnN0dWRpb0lEKSB7CiAgICAgICAgLy8gQXNrIGlzIGEgcG9pbnRlciB0byBhbiBlZ2cgaW4gYSBzdHVkaW8uCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYWJEYXRhID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogYXNrRGF0YS5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBhc2tEYXRhLmRhdGEuc3R1ZGlvSUQsIHJldHVyblR5cGU6ICdkYXRhJ30pOwogICAgICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgYWJEYXRhLnN0YXRlKTsKCiAgICAgICAgICAgIHJldHVybiB7IAogICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2gsCiAgICAgICAgICAgICAgICBjdXJyZW50SGFzaCwKICAgICAgICAgICAgICAgIGxhdGVzdEhhc2gsCiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaHQgYW4gZXJyb3IuYCwgZSk7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH0KICAgICAgICB9CiAgICB9ICBlbHNlIGlmIChhc2tEYXRhLmRhdGEudmVyc2lvbiA9PT0gMSAmJiBhc2tEYXRhLmRhdGEuc3RhdGUpIHsKICAgICAgICAvLyBBc2sgaXMgYSB2MSBhdXggZmlsZS4KICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgYXNrRGF0YS5kYXRhLnN0YXRlKTsKCiAgICAgICAgcmV0dXJuIHsgCiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2gsCiAgICAgICAgICAgIGN1cnJlbnRIYXNoLAogICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVucmVjb2duaXplZCBhc2tEYXRhIHN0cnVjdHVyZS5gLCBhc2tEYXRhKTsKICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICB9Cn0gZWxzZSB7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Cn0KJwDC1tX0D/qfCRlhYkNoZWNrRWdnVXBkYXRlQXZhaWxhYmxlAgQAwtbV9A/U9AqZB0Bjb25zdCBhYklEID0gdGhhdD8uYWJJRDsKY29uc3QgY3VycmVudEFCVmVyc2lvbiA9IHRoYXQ/LmN1cnJlbnRBQlZlcnNpb247IC8vIDEtYmFzZWQgdmVyc2lvbiBudW1iZXIuCmNvbnN0IHJlY29yZEtleU9yTmFtZSA9IHRoYXQ/LnJlY29yZEtleU9yTmFtZTsKCmFzc2VydCh0eXBlb2YgYWJJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXJgKTsKYXNzZXJ0KE51bWJlci5pc0ludGVnZXIoY3VycmVudEFCVmVyc2lvbikgJiYgY3VycmVudEFCVmVyc2lvbiA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3VycmVudEFCVmVyc2lvbiBtdXN0IGJlIGFuIGludGVnZXIgZ3JlYXRlciB0aGFuIDAuYCk7CmFzc2VydCh0eXBlb2YgcmVjb3JkS2V5T3JOYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXlPck5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgZWdnID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsgYWJJRCwgcmVjb3JkS2V5OiByZWNvcmRLZXlPck5hbWUsIHJldHVyblR5cGU6ICdlZ2cnfSk7CgppZiAoIWVnZyB8fCBlZ2cuc3VjY2VzcyA9PT0gZmFsc2UpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogZmFsc2UKICAgIH0KfSBlbHNlIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPiBjdXJyZW50QUJWZXJzaW9uLAogICAgICAgIGN1cnJlbnRBQlZlcnNpb24sCiAgICAgICAgbGF0ZXN0QUJWZXJzaW9uOiBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoLAogICAgfQp9CicBBGJvdHMkZjFlNjZjYzktMGI2Ni00OWMzLTgzYzktYzcwMmY1NGIzNTlmAScAwtbV9A/u+woGc3lzdGVtAgQAwtbV9A/v+woPYWIuc2hlbGwuZGVkZW50JwDC1tX0D+77CgpvbkJvdEFkZGVkAgQAwtbV9A//+wrRCUAvLyBkZWRlbnQtanMgaHR0cHM6Ly9naXRodWIuY29tL01hcnRpbktvbGFyaWsvZGVkZW50LWpzCgovKioKICogUmVtb3ZlcyBpbmRlbnRhdGlvbiBmcm9tIG11bHRpbGluZSBzdHJpbmdzLiBXb3JrcyB3aXRoIGJvdGggdGFicyBhbmQgc3BhY2VzLgogKi8KZnVuY3Rpb24gZGVkZW50ICh0ZW1wbGF0ZVN0cmluZ3MsIC4uLnZhbHVlcykgewoJbGV0IG1hdGNoZXMgPSBbXTsKCWxldCBzdHJpbmdzID0gdHlwZW9mIHRlbXBsYXRlU3RyaW5ncyA9PT0gJ3N0cmluZycgPyBbIHRlbXBsYXRlU3RyaW5ncyBdIDogdGVtcGxhdGVTdHJpbmdzLnNsaWNlKCk7CgoJLy8gMS4gUmVtb3ZlIHRyYWlsaW5nIHdoaXRlc3BhY2UuCglzdHJpbmdzW3N0cmluZ3MubGVuZ3RoIC0gMV0gPSBzdHJpbmdzW3N0cmluZ3MubGVuZ3RoIC0gMV0ucmVwbGFjZSgvXHI/XG4oW1x0IF0qKSQvLCAnJyk7CgoJLy8gMi4gRmluZCBhbGwgbGluZSBicmVha3MgdG8gZGV0ZXJtaW5lIHRoZSBoaWdoZXN0IGNvbW1vbiBpbmRlbnRhdGlvbiBsZXZlbC4KCWZvciAobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGg7IGkrKykgewoJCWxldCBtYXRjaDsKCgkJaWYgKG1hdGNoID0gc3RyaW5nc1tpXS5tYXRjaCgvXG5bXHQgXSsvZykpIHsKCQkJbWF0Y2hlcy5wdXNoKC4uLm1hdGNoKTsKCQl9Cgl9CgoJLy8gMy4gUmVtb3ZlIHRoZSBjb21tb24gaW5kZW50YXRpb24gZnJvbSBhbGwgc3RyaW5ncy4KCWlmIChtYXRjaGVzLmxlbmd0aCkgewoJCWxldCBzaXplID0gTWF0aC5taW4oLi4ubWF0Y2hlcy5tYXAodmFsdWUgPT4gdmFsdWUubGVuZ3RoIC0gMSkpOwoJCWxldCBwYXR0ZXJuID0gbmV3IFJlZ0V4cChgXG5bXHQgXXske3NpemV9fWAsICdnJyk7CgoJCWZvciAobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGg7IGkrKykgewoJCQlzdHJpbmdzW2ldID0gc3RyaW5nc1tpXS5yZXBsYWNlKHBhdHRlcm4sICdcbicpOwoJCX0KCX0KCgkvLyA0LiBSZW1vdmUgbGVhZGluZyB3aGl0ZXNwYWNlLgoJc3RyaW5nc1swXSA9IHN0cmluZ3NbMF0ucmVwbGFjZSgvXlxyP1xuLywgJycpOwoKCS8vIDUuIFBlcmZvcm0gaW50ZXJwb2xhdGlvbi4KCWxldCBzdHJpbmcgPSBzdHJpbmdzWzBdOwoKCWZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7CgkJc3RyaW5nICs9IHZhbHVlc1tpXSArIHN0cmluZ3NbaSArIDFdOwoJfQoKCXJldHVybiBzdHJpbmc7Cn0KCmdsb2JhbFRoaXMuZGVkZW50ID0gZGVkZW50OycAwtbV9A/u+woJb25EZXN0cm95AgQAwtbV9A/RhQsZZGVsZXRlIGdsb2JhbFRoaXMuZGVkZW50OycAwtbV9A/u+woIYWJJZ25vcmUCBADC1tX0D+uFCwR0cnVlJwDC1tX0D+77CgdhYlNoZWxsAgQAwtbV9A/whQsEdHJ1ZScAwtbV9A/u+woJYWJWZXJzaW9uAgQAwtbV9A/1hQsFMTAuMzcnAQRib3RzJGY4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMAEnAMLW1fQP+4ULBnN5c3RlbQIEAMLW1fQP/IULDmFiLnNoZWxsLmlucHV0JwDC1tX0D/uFCwRmb3JtAgQAwtbV9A+LhgsHbm90aGluZycAwtbV9A/7hQsJb25LZXlEb3duAgQAwtbV9A+ThgvAC0BpZiAoYWIubGlua3MucmVtZW1iZXIudGFncy5hYkFsbG93Q2hhdEJhciA9PT0gZmFsc2UpIHsKICAgIHJldHVybjsKfQoKY29uc3QgeyBrZXlzIH0gPSB0aGF0OwoKaWYgKG1hc2tzLmNoYXRPcGVuKSB7CiAgICBjb25zdCBlc2MgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpOwoKICAgIGlmIChlc2MpIHsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFycm93VXAgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93VXAnKTsKICAgICAgICBjb25zdCBhcnJvd0Rvd24gPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93RG93bicpOwogICAgICAgIAogICAgICAgIGlmIChhcnJvd1VwIHx8IGFycm93RG93bikgewogICAgICAgICAgICAvLyBJZiBBcnJvd1VwIG9yIEFycm93RG93biBhcmUgcHJlc3NlZCB3aGlsZSB0aGUgYWIgY2hhdCBiYXIgaXMgb3BlbiB0aGVuCiAgICAgICAgICAgIC8vIHN0YXJ0IGNvbWJpbmcgdGhyb3VnaCBjaGF0IGhpc3RvcnkuCiAgICAgICAgICAgIGNvbnN0IGRpciA9IGFycm93VXAgPyAtMSA6IDE7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCArIGRpcjsKICAgICAgICAgICAgbGV0IGhpc3RvcmljYWxUZXh0ID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIGluZGV4IDwgdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaGlzdG9yaWNhbFRleHQgPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnlbaW5kZXhdOwogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IGluZGV4OwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID49IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGNoYXQgYmFyLgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3Blbih7IHByZWZpbGw6IGhpc3RvcmljYWxUZXh0IH0pOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGNvbnN0IGJhY2t0aWNrID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdgJykgfHwgdGhhdC5rZXlzLmluY2x1ZGVzKCJEZWFkIik7CgogICAgaWYgKGJhY2t0aWNrKSB7CiAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICB9Cn0KJwDC1tX0D/uFCwZvbkNoYXQCBADC1tX0D9SRC4oYQC8vIE5vdCBzdXBwb3J0ZWQgb3V0c2lkZSBvZiBidWlsZGVyIHZlcnNpb24KaWYgKCFidWlsZGVyVmVyc2lvbikgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgppZiAoIXRoYXQubWVzc2FnZSkgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgovLyBBcHBlbmQgbWVzc2FnZSB0byBjaGF0IGhpc3RvcnkgYW5kIHVwZGF0ZSB0aGUgY3VycmVudCBoaXN0b3J5IGluZGV4Lgp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkucHVzaCh0aGF0Lm1lc3NhZ2UpOwp0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKCi8vIEZ1bmN0aW9uIHRvIHBhcnNlIGFyZ3VtZW50cyB3aXRoIHF1b3RlIHN1cHBvcnQgYW5kIGVycm9yIGhhbmRsaW5nCi8vIEV4YW1wbGVzOiAKLy8gICAnYXJnMSBhcmcyJyAtPiBbJ2FyZzEnLCAnYXJnMiddCi8vICAgJyJhcmcgd2l0aCBzcGFjZXMiIGFyZzInIC0+IFsnYXJnIHdpdGggc3BhY2VzJywgJ2FyZzInXQovLyAgICcidW5jbG9zZWQgcXVvdGUnIC0+IHRocm93cyBFcnJvcgpmdW5jdGlvbiBwYXJzZUFyZ3VtZW50cyhpbnB1dCkgewogICAgY29uc3QgYXJncyA9IFtdOwogICAgbGV0IGN1cnJlbnRBcmcgPSAnJzsKICAgIGxldCBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgbGV0IHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGNoYXIgPSBpbnB1dFtpXTsKICAgICAgICAKICAgICAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSBpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJ1xcJyAmJiBpICsgMSA8IGlucHV0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaSsrOyAvLyBTa2lwIHRoZSBiYWNrc2xhc2gKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gaW5wdXRbaV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gJyInIHx8IGNoYXIgPT09ICInIikgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gY2hhcjsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSBpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICcgJykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50QXJnID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuY2xvc2VkIHF1b3RlOiBmb3VuZCBvcGVuaW5nICR7aW5zaWRlUXVvdGVzfSBhdCBwb3NpdGlvbiAke3F1b3RlU3RhcnRQb3N9IGJ1dCBubyBjbG9zaW5nIHF1b3RlYCk7CiAgICB9CiAgICAKICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICB9CiAgICAKICAgIHJldHVybiBhcmdzOwp9CgppZiAodGhhdC5tZXNzYWdlWzBdID09ICIuIikgewogICAgY29uc3QgY29tbWFuZFBhcnQgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOyAvLyBSZW1vdmUgdGhlIGRvdAogICAgY29uc3Qgc3BhY2VJbmRleCA9IGNvbW1hbmRQYXJ0LmluZGV4T2YoJyAnKTsKICAgIAogICAgbGV0IGNtZCwgYXJnczsKICAgIGlmIChzcGFjZUluZGV4ID09PSAtMSkgewogICAgICAgIC8vIE5vIGFyZ3VtZW50cwogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0OwogICAgICAgIGFyZ3MgPSB1bmRlZmluZWQ7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEhhcyBhcmd1bWVudHMKICAgICAgICBjbWQgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoMCwgc3BhY2VJbmRleCk7CiAgICAgICAgY29uc3QgYXJnc1N0cmluZyA9IGNvbW1hbmRQYXJ0LnN1YnN0cmluZyhzcGFjZUluZGV4ICsgMSk7CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcGFyc2VkQXJncyA9IHBhcnNlQXJndW1lbnRzKGFyZ3NTdHJpbmcpOwogICAgICAgICAgICBhcmdzID0gcGFyc2VkQXJncy5sZW5ndGggPyBwYXJzZWRBcmdzIDogdW5kZWZpbmVkOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRXJyb3IgcGFyc2luZyBjb21tYW5kIGFyZ3VtZW50czogJHtlcnJvci5tZXNzYWdlfWAsIGxvZ1R5cGU6ICdFcnJvcicgfSk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDcmVhdGUgYSBmcmVzaCBDb21tYW5kc01hbmFnZXIgd2l0aCBlYWNoIGNhbGwgc28gdGhhdCB3ZSBhbHdheXMgaGF2ZSB0aGUgbGF0ZXN0IGNvbW1hbmRzIGFuZCBmdW5jdGlvbmFsaXR5LgogICAgY29uc3QgYWJDb21tYW5kcyA9IG5ldyBBQkNvbW1hbmRzTWFuYWdlcigpOwoKICAgIGlmIChhYkNvbW1hbmRzICYmIGFiQ29tbWFuZHMuaGFzQ29tbWFuZChjbWQpKSB7CiAgICAgICAgLy8gQ2FsbCBjb21tYW5kIHdpdGggYXJncy4KICAgICAgICBhYkNvbW1hbmRzLmNhbGxDb21tYW5kKGNtZCwgYXJncyk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEV2YWx1YXRlIGNvbW1hbmQgYXMgamF2YXNjcmlwdC4KICAgICAgICBjb25zdCBqcyA9IHRoYXQubWVzc2FnZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgb3MucnVuKGpzKTsKICAgIH0KfQoKdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOycAwtbV9A/7hQsLZGVzY3JpcHRpb24CBADC1tX0D9+pC0JUaGlzIGlzIG1lYW50IHRvIGhhbmRsZSBhbnkgbm9uZSBtZW51IHJlbGF0ZWQgaW5wdXRzL2ludGVyYWN0aW9ucy4nAMLW1fQP+4ULDG9uRmlsZVVwbG9hZAIEAMLW1fQPoqoLojVAaW1wb3J0IHsgUmVjb3JkRmlsZVJlc3VsdCB9IGZyb20gJ2Nhc3VhbG9zJzsKCi8vZmlsdGVyIG91dCB0aW1lcyB3aGVuIGZpbGUgbG9hZGluZyBpcyBub3QgYWxsb3dlZAppZiAoIWJ1aWxkZXJWZXJzaW9uIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJMaXN0ZW5pbmdGb3JGaWxlVXBsb2FkcyAhPT0gdHJ1ZSkgewogICAgcmV0dXJuOwp9CgovL3ZhcmlvdXMgZmlsZSBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykuc2hpZnQoKTsKbGV0IHNpemUgPSB0aGF0LmZpbGUuc2l6ZTsKbGV0IGNvcHlVcmwgPSB0aGF0LmNvcHlVcmwgPz8gdHJ1ZTsKbGV0IGZvY3VzQ2FtZXJhID0gdGhhdC5mb2N1c0NhbWVyYSA/PyB0cnVlOwpsZXQgbWltZVR5cGU7CmNvbnN0IGJvdEluZm8gPSB7fTsKCi8vaGFyZCBsaW1pdCBiYXNlZCBvbiBmaWxlIHNpemUKaWYgKHNpemUgPiAyMDAwMDAwMDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAibWF4aW11bSBmaWxlIHNpemUgZXhjZWVkZWQgKDIwMCBtYikiLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgcmV0dXJuOwp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIGZvciByZXRyaWV2aW5nIGltYWdlIGRpbWVuc2lvbnMgJiBhc3BlY3QgZnJvbSBBcnJheUJ1ZmZlciBkYXRhLgogKiBSZXF1aXJlcyBDYXN1YWxPUyBiZSBjb25maWd1cmVkIHRvIGhhdmUgYWNjZXNzIHRvIHRoZSBET00uCiAqLwpmdW5jdGlvbiBnZXRJbWFnZURpbWVuc2lvbnMoYXJyYXlCdWZmZXIsIG1pbWVUeXBlKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbYXJyYXlCdWZmZXJdLCB7IHR5cGU6IG1pbWVUeXBlIH0pOwogICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7CiAgICAgICAgY29uc3QgaW1nID0gbmV3IHNlbGYuSW1hZ2UoKTsKICAgICAgICBpbWcub25sb2FkID0gKCkgPT4gewogICAgICAgICAgICByZXNvbHZlKHsgd2lkdGg6IGltZy5uYXR1cmFsV2lkdGgsIGhlaWdodDogaW1nLm5hdHVyYWxIZWlnaHQsIGFzcGVjdDogaW1nLm5hdHVyYWxXaWR0aCAvIGltZy5uYXR1cmFsSGVpZ2h0IH0pOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7CiAgICAgICAgfTsKICAgICAgICBpbWcub25lcnJvciA9IHJlamVjdDsKICAgICAgICBpbWcuc3JjID0gdXJsOwogICAgfSk7Cn0KCi8vdGhpcyBzd2l0Y2ggaGFuZGxlcyBwb3NzaWJsZSBmaWxlcyBleHRlbnNpb25zLCB3aGlsZSByZWplY3RpbmcgYW55IGl0IGRvZXMgbm90IHJlY29nbml6ZQpzd2l0Y2ggKGZpbGVFeHRlbnNpb24pIHsKICAgIGNhc2UgJ2pwZyc6CiAgICBjYXNlICdqcGVnJzoKICAgIGNhc2UgJ3dlYnAnOgogICAgY2FzZSAnZ2lmJzoKICAgIGNhc2UgJ3BuZyc6CiAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2UvIiArIGZpbGVFeHRlbnNpb247CiAgICAgICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICAgICAgYm90SW5mby5hbmNob3JQb2ludCA9ICfwn6esWzAsMCwtMC4wMV0nOwoKICAgICAgICBpZiAob3MuZGV2aWNlKCkuc3VwcG9ydHNET00pIHsKICAgICAgICAgICAgY29uc3QgaW1hZ2VEaW1lbnNpb25zID0gYXdhaXQgZ2V0SW1hZ2VEaW1lbnNpb25zKHRoYXQuZmlsZS5kYXRhLCBtaW1lVHlwZSk7CgogICAgICAgICAgICAvLyBBZGp1c3Qgc2NhbGUgdG8gcmVzcGVjdCBhc3BlY3QgcmF0aW8uIFRoaXMgaXMgImNvdmVyIiBzY2FsaW5nIHN0eWxlLgogICAgICAgICAgICBpZiAoaW1hZ2VEaW1lbnNpb25zLmFzcGVjdCA+PSAxKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWCA9IGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWSA9IDEgLyBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBicmVhazsKICAgIGNhc2UgJ3N2Zyc6CiAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICAgICAgYm90SW5mby5hbmNob3JQb2ludCA9ICfwn6esWzAsMCwtMC4wMV0nOwoKICAgICAgICBpZiAob3MuZGV2aWNlKCkuc3VwcG9ydHNET00pIHsKICAgICAgICAgICAgY29uc3QgaW1hZ2VEaW1lbnNpb25zID0gYXdhaXQgZ2V0SW1hZ2VEaW1lbnNpb25zKHRoYXQuZmlsZS5kYXRhLCBtaW1lVHlwZSk7CgogICAgICAgICAgICAvLyBBZGp1c3Qgc2NhbGUgdG8gcmVzcGVjdCBhc3BlY3QgcmF0aW8uIFRoaXMgaXMgImNvdmVyIiBzY2FsaW5nIHN0eWxlLgogICAgICAgICAgICBpZiAoaW1hZ2VEaW1lbnNpb25zLmFzcGVjdCA+PSAxKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWCA9IGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLnNjYWxlWSA9IDEgLyBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGJyZWFrOwogICAgY2FzZSAnZ2xiJzoKICAgIGNhc2UgJ2V4cic6CiAgICBjYXNlICdnbHRmJzoKICAgICAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICAgICAgYm90SW5mby5mb3JtID0gIm1lc2giOwogICAgICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAiZ2x0ZiI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdhdXgnOgogICAgY2FzZSAncGRmJzoKICAgICAgICBsZXQgYm90RGF0YSA9IGZpbGVFeHRlbnNpb24gPT0gIi5hdXgiID8gSlNPTi5wYXJzZSh0aGF0LmZpbGUuZGF0YSkuc3RhdGUgOiBvcy5wYXJzZUJvdHNGcm9tRGF0YSh0aGF0LmZpbGUuZGF0YSk7CiAgICAgICAgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdHM6IGJvdERhdGEsIG9yaWdpbjogZmlsZU5hbWUsIHNvdXJjZUV2ZW50OiAnZmlsZV91cGxvYWQnIH0pOwogICAgICAgIHJldHVybjsKICAgIGNhc2UgJ21wMyc6CiAgICAgICAgbWltZVR5cGUgPSAnYXVkaW8vbXBlZyc7CiAgICAgICAgYm90SW5mby5vbkNsaWNrID0gIkAgb3MucGxheVNvdW5kKHRhZ3MuZm9ybUFkZHJlc3MpOyI7CiAgICAgICAgYm90SW5mby5sYWJlbCA9ICJDbGljayB0byBQbGF5IjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ21wNCc6CiAgICAgICAgbWltZVR5cGUgPSAndmlkZW8vbXA0JzsKICAgICAgICBib3RJbmZvLmZvcm0gPSAiaWZyYW1lIjsKICAgICAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gInNyYyI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdvdGYnOgogICAgICAgIG1pbWVUeXBlID0gJ2ZvbnQvb3RmJzsKICAgICAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnd29mZic6CiAgICAgICAgbWltZVR5cGUgPSAnZm9udC93b2ZmJzsKICAgICAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYGZpbGUgdHlwZSBub3Qgc3VwcG9ydGVkYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICByZXR1cm4gbmV3IEVycm9yKCJ1bmhhbmRsZWQgZmlsZSB0eXBlOiAiICsgZmlsZUV4dGVuc2lvbik7Cn0KCi8vdGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYW5kIG9iamVjdHMgc2V0IHVwIGEgbG9hZGluZyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgppZiAoIWxpbmtzLm1lbnUpIHsKICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGB1cGxvYWRpbmdgIH0pOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBjb25maWdCb3QudGFncy5zdHVkaW9JRCA/PyBjb25maWdCb3QudGFncy5zdHVkaW87CgppZiAoIWNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKSB7CiAgICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYXV0aEJvdC5pZDsKfQoKLy90aGlzIGlzIHRoZSBhY3R1YWwgdXBsb2FkIGZ1bmN0aW9uYWxpdHkKbGV0IHVwbG9hZFJlc3VsdDogUmVjb3JkRmlsZVJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEZpbGUoeyBmaWxlOiB0aGF0LmZpbGUuZGF0YSwgZmlsZU5hbWU6IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGUgfSk7CgppZiAodXBsb2FkUmVzdWx0KSB7CiAgICBpZiAodXBsb2FkUmVzdWx0LnN1Y2Nlc3MgfHwgdXBsb2FkUmVzdWx0LmVycm9yQ29kZSA9PT0gJ2ZpbGVfYWxyZWFkeV9leGlzdHMnKSB7CiAgICAgICAgY29uc3QgZmlsZVVSTCA9IHVwbG9hZFJlc3VsdC51cmwgPz8gdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICAgICAgLy9pZiB0aGUgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgYXMgYSBib3Qgd2l0aCBhIGxpbmssIHRoaXMgbG9naWMgaGFuZGxlcyB0aGF0CiAgICAgICAgaWYgKE9iamVjdC5rZXlzKGJvdEluZm8pLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgbGV0IGRpbWVuc2lvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBY3RpdmVEaW1lbnNpb247CgogICAgICAgICAgICBpZiAoIWRpbWVuc2lvbikgewogICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGZhbGxiYWNrIHRvIHdoYXRldmVyIGlzIHRoZSB2aXNpYmxlIHBvcnRhbC4KICAgICAgICAgICAgICAgIGlmIChjb25maWdCb3QudGFncy5tYXBQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICBkaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5tYXBQb3J0YWw7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwpIHsKICAgICAgICAgICAgICAgICAgICBkaW1lbnNpb24gPSBjb25maWdCb3QudGFncy5ncmlkUG9ydGFsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZGltZW5zaW9uKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbl0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHBvc2l0aW9uID0gZ2V0Qm90UG9zaXRpb24obGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCwgZGltZW5zaW9uKTsKICAgICAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbiArICdYJ10gPSBwb3NpdGlvbi54OwogICAgICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uICsgJ1knXSA9IHBvc2l0aW9uLnk7CiAgICAgICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb24gKyAnWiddID0gcG9zaXRpb24uejsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG1pbWVUeXBlLmluY2x1ZGVzKCJmb250IikpIHsKICAgICAgICAgICAgICAgIGJvdEluZm8ubGFiZWxGb250QWRkcmVzcyA9IGZpbGVVUkw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLmZvcm1BZGRyZXNzID0gZmlsZVVSTDsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYm90SW5mby5hYkZpbGVVcGxvYWQgPSB0cnVlOwoKICAgICAgICAgICAgY29uc3QgYm90ID0gY3JlYXRlKGJvdEluZm8pOwoKICAgICAgICAgICAgaWYgKGZvY3VzQ2FtZXJhKSB7CiAgICAgICAgICAgICAgICBvcy5mb2N1c09uKGJvdCwgeyBkdXJhdGlvbjogMSB9KS5jYXRjaChlID0+IHt9KQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY29weVVybCkgewogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZmlsZVVSTCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYEZpbGUgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQuYCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYEZpbGUgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7ZmlsZVVSTH1gLCBsb2dUeXBlOiAnbG9nJyB9KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIHVwbG9hZCBmaWxlLiBSZWFzb246ICR7dXBsb2FkUmVzdWx0LmVycm9yTWVzc2FnZX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYEZhaWxlZCB0byB1cGxvYWQgZmlsZS4gUmVzdWx0OiAke0pTT04uc3RyaW5naWZ5KHVwbG9hZFJlc3VsdCl9YCwgbG9nVHlwZTogYGVycm9yYH0pOwogICAgfQp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aXRoIGZpbGUgdXBsb2FkLmAsIGxvZ1R5cGU6IGBlcnJvcmB9KTsKfQoKLy9jbGVhciB0aGUgcHJvZ3Jlc3MgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CgppZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gdXBsb2FkUmVzdWx0OycAwtbV9A/7hQsFbGVhcm4CBADC1tX0D8HfCyjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDC1tX0D/uFCwhyZW1lbWJlcgIEAMLW1fQP6N8LKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMLW1fQP+4ULDW1hbmlmZXN0YXRpb24CBADC1tX0D4/gCyjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDC1tX0D/uFCwhhYklnbm9yZQIEAMLW1fQPtuALBHRydWUnAMLW1fQP+4ULBmNyZWF0ZQIEAMLW1fQPu+ALKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAMLW1fQP+4ULBXN0b3JlAgQAwtbV9A/i4Aso8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicAwtbV9A/7hQsEbWVudQIEAMLW1fQPieELKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAMLW1fQP+4ULB2FiU2hlbGwCBADC1tX0D7DhCwR0cnVlJwDC1tX0D/uFCwlvblRhcENvZGUCBADC1tX0D7XhC6kCQGNvbnN0IHRhcENvZGUgPSB0aGF0OwoKc3dpdGNoICh0YXBDb2RlKQp7CiAgICBjYXNlICIzMzQyIjoKICAgICAgICBvcy50b2FzdCgid2FraW5nICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5KTsKCiAgICAgICAgdGhpc0JvdC5vbkNoYXQoe21lc3NhZ2U6ICIuLiJ9KTsKICAgICAgICBicmVhazsKICAgIGNhc2UgIjQyNDIiOgogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICAvL2NvbnNvbGUubG9nKHRhcENvZGUpOwp9JwDC1tX0D/uFCwNhc2sCBADC1tX0D9/jCyjwn5SXZWM4NWMxZDYtOWYxYS00MGQ0LTgyZTEtNWJkNjgwMzQ5YzI3JwDC1tX0D/uFCwlhYlZlcnNpb24CBADC1tX0D4bkCwUxMC4zNycAwtbV9A/7hQsKb25Cb3RBZGRlZAIEAMLW1fQPjOQLQEB0aGlzQm90LmxvYWRBQkNvbW1hbmRzTWFuYWdlcigpOwp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkgPSBbXTsnAMLW1fQP+4ULGm9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkAgQAwtbV9A/N5AvXa0BsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKLy8gVGhlc2UgYXJlIGFsbCB0aGUgYnVpbHQtaW4gY29tbWFuZHMuCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2hlbHAnLCAoYXJncykgPT4gewogICAgY29uc3QgY29tbWFuZHMgPSBhYkNvbW1hbmRzLmNvbW1hbmRzOwogICAgY29uc3QgY29tbWFuZEtleXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcyk7CgogICAgbGV0IHNlbGVjdGVkQ29tbWFuZDsKICAgIGlmIChjb21tYW5kS2V5cyAmJiBjb21tYW5kS2V5cy5sZW5ndGggJiYgYXJncyAmJiBhcmdzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGNvbW1hbmRLZXlNYXRjaCA9IGNvbW1hbmRLZXlzLmZpbmQoa2V5ID0+IGtleSA9PT0gYXJnc1swXSk7CiAgICAgICAgc2VsZWN0ZWRDb21tYW5kID0gY29tbWFuZEtleU1hdGNoOwogICAgfQogICAgCiAgICBsaW5rcy5oZWxwLm1vdW50KHsgYWJDb21tYW5kc01hbmFnZXI6IGFiQ29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgdGhpcyBoZWxwIHdpbmRvdy4gQ2FuIHNwZWNpZnkgYSBjb21tYW5kIHRvIG9wZW4gdGhlIGhlbHAgcGFnZSBmb3IgdGhhdCBjb21tYW5kIGRpcmVjdGx5LicsCiAgICB1c2FnZTogWycuaGVscCcsICcuaGVscCBbY29tbWFuZF0nXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnLicsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy4uJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnd2FrZScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy53YWtlJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2xlZXAnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJTbGVlcChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1B1dCBhYiB0byBzbGVlcC4nLAogICAgdXNhZ2U6ICcuc2xlZXAnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhY2NvdW50JywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGVuZHBvaW50ID0gYXdhaXQgb3MuZ2V0UmVjb3Jkc0VuZHBvaW50KCk7CiAgICBvcy5vcGVuVVJMKGVuZHBvaW50KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIGFjY291bnQvcmVjb3JkcyBwYWdlIGluIGEgbmV3IHRhYi4nLAogICAgdXNhZ2U6ICcuYWNjb3VudCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2FzaycsIChhcmdzKSA9PiB7CiAgICBpZiAobGlua3MuYXNrKSB7CiAgICAgICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGFza0lucHV0ID0gYXJncy5qb2luKCcgJyk7CiAgICAgICAgICAgIGxpbmtzLmFzay5hYkNvcmVNZW51QWN0aW9uKGFza0lucHV0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAuYXNrIGNvbW1hbmQgcmVxdWlyZXMgaW5wdXRgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYGFzayBib3QgaXMgbm90IGxvYWRlZCwgY2Fubm90IGxvYWQgYXNrYCk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdBc2sgYWInLAogICAgdXNhZ2U6ICcuYXNrIDxhc2tfbmFtZT4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCduYW1lYWInLCBhc3luYyAoYXJncykgPT4gewogICAgY29uc3QgbmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5LCB7IHRpdGxlOiAnd2hhdCB3b3VsZCB5b3UgbGlrZSB0byBjYWxsIG1lPycgfSk7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnBlcnNvbmFsaXR5LCAnYWJCdWlsZGVySWRlbnRpdHknLCBuYW1lLCAnbG9jYWwnKTsKICAgIHNob3V0KCdjaGFuZ2VQZXJzb25hbGl0eUNvbmZpZycsIHsgbmFtZTogbmFtZSB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dpdmUgYWIgYSBuZXcgbmFtZS4nLAogICAgdXNhZ2U6ICcubmFtZWFiJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBkYXRlYWInLCBhc3luYyAoYXJncykgPT4gewogICAgbGlua3MubGVhcm4udXBkYXRlQUIoKTs7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGRhdGUgQUIgY29yZSBhbmQgc2tpbGxzIHRvIGN1cnJlbnQgY29kZS4nLAogICAgdXNhZ2U6ICcudXBkYXRlYWInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzeXN0ZW0nLCBhcmdzID0+IHRoaXNCb3QuY21kU3lzdGVtKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGluc3QuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYE9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpICAgIAoKICAgIFlvdSBtYXkgcHJvdmlkZSBhIGN1c3RvbSBzeXN0ZW1UYWdOYW1lIHdpdGggdGhlIGNvbW1hbmQsIGluIG9yZGVyIHRvIG9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgb25seSBmb3IgYm90cyB3aXRoIHRoZSBnaXZlbiBzeXN0ZW1UYWdOYW1lLiBCeSBkZWZhdWx0LCAic3lzdGVtIiB3aWxsIGJlIHVzZWQgYXMgdGhlIHN5c3RlbVRhZ05hbWUuCgogICAgRm9yIGV4YW1wbGU6CgogICAgPiAuc3lzdGVtCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJzeXN0ZW0iIHRhZy4KCiAgICA+IC5zeXN0ZW0gbXlHcm91cAogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAibXlHcm91cCIgdGFnLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zeXN0ZW0nLAogICAgICAgICcuc3lzdGVtIHN5c3RlbVRhZ05hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy13JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4gQnkgZGVmYXVsdCB0aGUgc3lzdGVtIHBvcnRhbCB3aWxsIG9wZW4gaW4gYSBuZXcgdGFiLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2cnLCAoYXJncykgPT4gewogICAgbGlua3MuY29uc29sZS50b2dnbGVDb25zb2xlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdUb2dnbGUgdmlzaWJsaXR5IG9mIHRoZSBhYiBsb2cuJywKICAgIHVzYWdlOiAnLmxvZycKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nY2xlYXInLCAoYXJncykgPT4gewogICAgY29uc3QgbWVzc2FnZUxvZ0JvdHMgPSBnZXRCb3RzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIsIHRydWUpOwogICAgZGVzdHJveShtZXNzYWdlTG9nQm90cyk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdDbGVhciBhbGwgYWIgbG9nIG1lc3NhZ2VzLicsCiAgICB1c2FnZTogJy5sb2djbGVhcicKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2hlZXQnLCBhcmdzID0+IHRoaXNCb3QuY21kU2hlZXQoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHNwZWNpZmllZCBib3Qgb3IgYW4gZW50aXJlIGRpbWVuc2lvbi4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnNoZWV0IFtvcHRpb25zXSBbcG9ydGFsIHwgaGVscGVyQm90TmFtZSB8IGJvdElkIHwgZ2xvYmFsVGhpc1BhdGhdJywKICAgICAgICAnZXguIC5zaGVldCBob21lJywKICAgICAgICAnZXguIC5zaGVldCBjb25maWdCb3QnLAogICAgICAgICdleC4gLnNoZWV0IC10IGEyY2Y0NzM5LTM5YTItNGZkNi1iM2VmLWNjNDc4MmY5NzA4OScsCiAgICAgICAgJ2V4LiAuc2hlZXQgZ2xvYmFsVGhpcy5teU9iamVjdC5teUJvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgbXlPYmplY3QubXlCb3QnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy10JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgaW4gYSBuZXcgYnJvd3NlciB0YWIuIFxuXG5OT1RFOiAuc2hlZXQgd2lsbCBhdXRvbWF0aWNhbGx5IGluc3BlY3QgdGhlIHNwYWNlIG9mIGEgYm90IGFuZCBmb3JjZSBvcGVuaW5nIGluIHRoZSBzYW1lIHRhYiBpZiBhIGJvdCBpcyBpbiB0ZW1wTG9jYWwgb3IgdGVtcFNoYXJlZCBzcGFjZS4nLAogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ21lbnVzaGVldCcsIChhcmdzKSA9PiB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWw7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYENhbm5vdCBvcGVuIHNoZWV0UG9ydGFsIGZvciBtZW51UG9ydGFsIGJvdHMuIFRoZSBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBkaXNhYmxlZC5gfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3IgdGhlIGN1cnJlbnQgbWVudSBwb3J0YWwuJywKICAgIHVzYWdlOiAnLm1lbnVTaGVldCcsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGluc3QnLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRJbnN0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgdGhlIGluc3QgdG8gZGlzay4nLAogICAgdXNhZ2U6ICcuZG93bmxvYWRpbnN0Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRzeXN0ZW0nLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRTeXN0ZW0oYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCB0aGUgc3BlY2lmaWVkIGJvdCBzeXN0ZW0ocykgdG8gZGlzay4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgdGhlIHNwZWNpZmllZCBib3Qgc3lzdGVtKHMpIHRvIGRpc2suCiAgICAKICAgIFRoZSBwcm92aWRlZCBzeXN0ZW1OYW1lKHMpIGlsbCBiZSB1c2VkIHRvIG1hdGNoIGFnYWluc3QgYm90cyB3aG9zZSBzeXN0ZW0gdGFnIHN0YXJ0cyB3aXRoIHN5c3RlbU5hbWUocykuIEl0IHdpbGwgcmVzcGVjdCB0aGUgZG90IG5vdGF0aW9uIG9mIHRoZSBzeXN0ZW0gdGFnLCBzbyBwYXJ0aWFsIG1hdGNoZXMgd2lsbCBub3Qgd29yay4gU2VlIHRoZSBleGFtcGxlcyBiZWxvdyBmb3IgYSBiZXR0ZXIgdW5kZXJzdGFuZGluZy4KCiAgICBGb3IgZXhhbXBsZSBpZiBzeXN0ZW1OYW1lIGlzICJoZWxsbyI6CgogICAgU3lzdGVtIFRhZyAtPiBEb3dubG9hZD8KICAgIC0gaGVsbG8gLT4geWVzCiAgICAtIGhlbGxvLndvcmxkLm1haW4gLT4geWVzCiAgICAtIGhlbGxvLndvcmxkLmZpcmV3b3JrcyAtPiB5ZXMKICAgIC0gcmMucmVkQm90IC0+IG5vCiAgICAtIGhlbGxvV29ybGQuYm90IC0+IG5vCiAgICAtIGhlbGl1bS5hdG9tIC0+IG5vCiAgICAtIGhleC5ncmlkLmhlbGxvIC0+IG5vCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRvd25sb2Fkc3lzdGVtIFsuLi5zeXN0ZW1OYW1lXScKICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkYWInLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRBQihhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIHNwZWNpZmllZCBhYiBncm91cChzKSB0byBkaXNrLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBzcGVjaWZpZWQgYWIgZ3JvdXAocykgdG8gZGlzay4KCiAgICBZb3UgY2FuIHByb3ZpZGUgYSBsaXN0IG9mIGdyb3VwcyB0byBkb3dubG9hZCBhbG9uZyB3aXRoIHRoZSBjb21tYW5kOgogICAgPiAuZG93bmxvYWRhYiBhYkNvcmUgYWJTaGVsbCBhYkludGVyZmFjZQoKICAgIElmIGdyb3VwKHMpIGFyZSBub3QgcHJvdmlkZWQgd2l0aCB0aGUgY29tYW1hbmQgdGhlbiB5b3Ugd2lsbCBiZSBwcm9tcHRlZCB0byBwcm92aWRlIG9uZSB3aXRoIGEgZGlhbG9nLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5kb3dubG9hZGFiIFtvcHRpb25zXSBbZ3JvdXAuLi5dJywKICAgICAgICAnZXguIC5kb3dubG9hZGFiIGFiU2hlbGwgYWJJbnRlcmZhY2UnLAogICAgICAgICdleC4gLmRvd25sb2FkYWIgLXYgMSBteUdyb3VwTmFtZScKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXYnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1NwZWNpZnkgdGhlIGF1eCBmb3JtYXQgdmVyc2lvbiBudW1iZXIuIGV4LiAtdiAxIHdpbGwgYmUgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgKHB1cmUgYm90IGpzb24pLiBCeSBkZWZhdWx0LCBhYiBmaWxlcyBhcmUgdXN1YWxseSBkb3dubG9hZGVkIGFzIHZlcnNpb24gMiBhdXggZmlsZXMgKGNvbmZsaWN0LWZyZWUgdXBkYXRlKS4nCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRlZ2cnLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRFZ2coYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuIFlvdSB3aWxsIG5lZWQgdG8gcHJvdmlkZSB0aGUgcmVjb3JkS2V5IGFzIHdlbGwgYW5kIHRoZSBuYW1lIG9mIHRoZSBlZ2cuIEEgZHJvcGRvd24gc2VsZWN0aW9uIHdpbGwgYmUgcHJvdmlkZWQgZm9yIHRoZSBlZ2cgaWYgZm91bmQgdG8gc2VsZWN0IHdoaWNoIHZlcnNpb24gdG8gZG93bmxvYWQuYCwKICAgIHVzYWdlOiAnLmRvd25sb2FkZWdnJywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvYWRza2lsbCcsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBpZiAoYXJncykgewogICAgICAgIGZvciAobGV0IHNraWxsIG9mIGFyZ3MpIHsKICAgICAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChza2lsbCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCcubG9hZHNraWxsIHJlcXVpcmVzIHNvbWUgc2tpbGwgbmFtZXMnKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0xvYWQgdGhlIHNwZWNpZmllZCBhYiBza2lsbHMuJywKICAgIHVzYWdlOiAnLmxvYWRTa2lsbCBbc2tpbGwgLi4uXScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VybHFyJywgKCkgPT4gb3Muc2hvd1FSQ29kZShjb25maWdCb3QudGFncy51cmwpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnU2hvdyBhIFFSIGNvZGUgZm9yIHRoZSBicm93ZXIgdGFiXCdzIGN1cnJlbnQgVVJMLicsCiAgICB1c2FnZTogJy51cmxxcicKfSk7Cgpjb25zdCBESU1fU1VQUE9SVEVEX1BPUlRBTFMgPSBbJ2dyaWQnLCAnbWFwJywgJ21pbmlHcmlkJywgJ21pbmlNYXAnLCAnc2hlZXQnLCAnc3lzdGVtJywgJ21lbnUnLCAndGFnJ107CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2RpbScsIChhcmdzKSA9PiB7CiAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCkgewogICAgICAgIGxldCBwb3J0YWwgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcCcpOwogICAgICAgIGxldCBkaW1lbnNpb24gPSBhcmdzLmpvaW4oJyAnKTsKCiAgICAgICAgaWYgKCFwb3J0YWwpIHsKICAgICAgICAgICAgcG9ydGFsID0gJ2dyaWQnOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpbWVuc2lvbiA9PT0gIm51bGwiIHx8IGRpbWVuc2lvbiA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGltZW5zaW9uID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChESU1fU1VQUE9SVEVEX1BPUlRBTFMuaW5kZXhPZihwb3J0YWwpID49IDApIHsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3NbYCR7cG9ydGFsfVBvcnRhbGBdID0gZGltZW5zaW9uOwoKICAgICAgICAgICAgaWYgKGRpbWVuc2lvbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYENsb3NlZCAke3BvcnRhbH1Qb3J0YWwuYCB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgU2V0ICR7cG9ydGFsfVBvcnRhbCB0byAnJHtkaW1lbnNpb259JyBkaW1lbnNpb24uYCB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgJHtwb3J0YWx9IGlzIG5vdCBhIHN1cHBvcnRlZCBwb3J0YWwgZm9yIHRoZSBkaW0gY29tbWFuZC5gLCBsb2dUeXBlOiAnZXJyb3InIH0pCiAgICAgICAgfQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR28gdG8gc3BlY2lmaWVkIHBvcnRhbCBkaW1lbnNpb24uJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYEdvIHRvIHNwZWNpZmllZCBwcm90YWwgZGltZW5zaW9uLgogICAgCiAgICBJZiBhIHBvcnRhbCBhcmd1bWVudCBpcyBub3QgcHJvdmlkZWQgdGhlbiBpdCB3aWxsIGRlZmF1bHQgdG8gdGhlIGdyaWRQb3J0YWwuCiAgICAKICAgIElmIGEgZGltZW5zaW9uIGlzIG5vdCBwcm92aWRlZCBvciBpcyAibnVsbCIgdGhlbiB0aGUgcG9ydGFsIHdpbGwgYmUgc2V0IHRvIG51bGwgYW5kIGJlIGNsb3NlZC5gLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRpbSA8ZGltZW5zaW9uPicsCiAgICAgICAgJy5kaW0gLXAgPHBvcnRhbD4gPGRpbWVuc2lvbj4nCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1wJywKICAgICAgICAgICAgZGVzY3JpcHRpb246IGBTcGVjaWZ5IHRoZSBwb3J0YWwgbmFtZS4gQ2FuIGJlIGFueW9uZSBvZiB0aGUgZm9sbG93aW5nOiAke0RJTV9TVVBQT1JURURfUE9SVEFMUy5qb2luKCcsICcpfWAKICAgICAgICB9CiAgICBdCgp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXVpZCcsICgpID0+IHsKICAgIG9zLnNldENsaXBib2FyZCh1dWlkKCkpOwoKICAgIGxldCBtZXNzYWdlID0gYENvcGllZCBuZXcgdXVpZCB0byBjbGlwYm9hcmRgOwogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBvcy50b2FzdChtZXNzYWdlKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dlbmVyYXRlIGEgdW5pdmVyc2FsbHkgdW5pcXVlIGlkZW50aWZpZXIgKHV1aWQpIGFuZCBjb3B5IGl0IHRvIHRoZSBjbGlwYm9hcmQuJywKICAgIHVzYWdlOiAnLnV1aWQnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkdXAnLCAoYXJncykgPT4gewogICAgY29uc3QgYm90SWQgPSBhcmdzID8gYXJnc1swXSA6IHVuZGVmaW5lZDsKICAgIGlmIChib3RJZCkgewogICAgICAgIGNvbnN0IGJvdCA9IGdldEJvdCgnaWQnLCBib3RJZCk7CiAgICAgICAgaWYgKGJvdCkgewogICAgICAgICAgICBjb25zdCBkdXBCb3QgPSBjcmVhdGUoYm90KTsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGR1cEJvdC5pZCk7CiAgICAgICAgICAgIG9zLnRvYXN0KCdEdXBsaWNhdGUgYm90IGlkIGNvcGllZCB0byBjbGlwYm9hcmQuJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3MudG9hc3QoYE5vIGJvdCBmb3VuZCB3aXRoIGlkICR7Ym90SWR9YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBvcy50b2FzdCgnUHJvdmlkZSB0aGUgaWQgb2YgdGhlIGJvdCB5b3Ugd2FudCB0byBkdXBsaWNhdGUnKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0R1cGxpY2F0ZSBhIHNwZWNpZmllZCBib3QgYW5kIGNvcHkgdGhlIG5ldyBib3RcJ3MgaWQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcuZHVwIDxib3RJZD4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGxvYWRhdXgnLCAoYXJncykgPT4gewogICAgb3Muc2hvd1VwbG9hZEF1eEZpbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwbG9hZCBBVVggZmlsZShzKSB0byB0aGUgY3VycmVudCBpbnN0LicsCiAgICB1c2FnZTogJy51cGxvYWRhdXgnCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGZpbGVzJywgYXJncyA9PiB0aGlzQm90LmNtZFVwbG9hZEZpbGVzKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIGZpbGUocykgZGlyZWN0bHkgdG8gcmVjb3JkLicsCiAgICB1c2FnZTogWwogICAgICAgICcudXBsb2FkZmlsZXMnLAogICAgICAgICcudXBsb2FkZmlsZXMgLXJlY29yZCA8cmVjb3JkX2lkPicKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXJlY29yZCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3B0aW9uYWxseSBwdWJsaXNoIGZpbGUocykgdG8gYSBzcGVjaWZpYyByZWNvcmQuIElmIG9taXR0ZWQsIGZpbGUocykgd2lsbCBiZSBwdWJsaXNoZWQgdG8gdGhlIHVzZXJcJ3MgcGVyc29uYWwgcmVjb3JkLicKICAgICAgICB9CiAgICBdCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3B1Ymxpc2hhc2snLCBhcmdzID0+IHRoaXNCb3QuY21kUHVibGlzaEFzayhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1B1Ymxpc2ggYW4gYXNrIHRvIHRoZSBwdWJsaWMgYWIgcmVjb3JkLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBQdWJsaXNoIGFuIGFzayB0byB0aGUgcHVibGljIGFiIHJlY29yZC4KCiAgICBBbiBhYiBhc2sgaXMgYSBsaXR0bGUgcG9pbnRlciB0byBhIHBhdHRlcm4gaW5zaWRlIG9mIGEgc3BlY2lmaWMgc3R1ZGlvLiBUaGUgYXNrIGNhbiBiZSB1c2VkIHRvIGxvYWQgdGhlIGdpdmVuIHBhdHRlcm4gdXNpbmcgYSBzaW1wbGUgbmFtZSwgbGlrZSBhIHNob3J0Y3V0IG9yIGFuIGFsaWFzLgoKICAgIFRoZSBhc2sgaXRzZWxmIGlzIHN0b3JlZCBpbiB0aGUgcHVibGljIGFiIHJlY29yZCBzbyB0aGF0IGFueW9uZSBjYW4gcmVhZCB0aGUgcG9pbnRlciBmaWxlLCBidXQgdGhlIHBlcm1pc3Npb25zIGZvciB0aGUgcGF0dGVybiBpbnNpZGUgdGhlIHN0dWRpbyBhcmUgc3RpbGwgbWFuYWdlZCBieSB0aGUgb3JpZ2luYWwgYXV0aG9yLgoKICAgIEFueSB1cGRhdGVzIHRvIGFuIGV4aXN0aW5nIGFzayB3aWxsIGJlIG92ZXJ3cml0dGVuLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5wdWJsaXNoYXNrIC1hc2sgPGFza0lEPiAtcGF0dGVybiA8cGF0dGVybklEPiAtc3R1ZGlvIDxzdHVkaW9JRD4nLAogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctYXNrJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgYXNrIHRvIGJlIHNldC4nLAogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXBhdHRlcm4nLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBwYXR0ZXJuIHNldCB0aGUgYXNrIHRvIHBvaW50IGF0LicsCiAgICAgICAgfSwKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctc3R1ZGlvJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgc3R1ZGlvIHRvIHNldCB0aGUgYXNrIHRvIHBvaW50IGF0LiBUaGlzIGlzIHRlY2huaWNhbGx5IG9wdGlvbmFsLCBpZiBub3QgcHJvdmlkZWQgdGhlbiB0aGUgc3R1ZGlvIElEIG9mIHRoZSBjdXJyZW50bHkgbG9nZ2VkIGluIHVzZXIgd2lsbCBiZSB1c2VkLicsCiAgICAgICAgfQogICAgXQp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd2aWV3cmVjb3JkZGF0YScsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBpZiAoIWxpbmtzLnZpZXdSZWNvcmREYXRhQXBwKSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJWaWV3UmVjb3JkJyk7CiAgICB9CgogICAgY29uc3QgaXNBbGlhcyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnRmxhZyhhcmdzLCAnLWEnKQoKICAgIGxldCByZWNvcmROYW1lOwoKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgIHJlY29yZE5hbWUgPSBhcmdzLmpvaW4oJyAnKTsKICAgIH0KCiAgICBpZiAoaXNBbGlhcykgewogICAgICAgIHN3aXRjaChyZWNvcmROYW1lKSB7CiAgICAgICAgICAgIGNhc2UgJ3BsYXllcic6CiAgICAgICAgICAgICAgICBpZiAoYXV0aEJvdCkgewogICAgICAgICAgICAgICAgICAgIHJlY29yZE5hbWUgPSBhdXRoQm90LmlkOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAudmlld3JlY29yZGRhdGEgbXVzdCBiZSBsb2dnZWQgaW4gdG8gdmlldyBwbGF5ZXIgcmVjb3JkLmApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlICdhYic6CiAgICAgICAgICAgICAgICByZWNvcmROYW1lID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC52aWV3cmVjb3JkZGF0YSBjb21tYW5kIGRvZXMgbm90IHJlY29nbml6ZSBhbGlhcyAke3JlY29yZE5hbWV9YCk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBpZiAoIXJlY29yZE5hbWUgJiYgYXV0aEJvdCkgewogICAgICAgICAgICByZWNvcmROYW1lID0gYXV0aEJvdC5pZDsKICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmIChyZWNvcmROYW1lKSB7CiAgICAgICAgbGlua3Mudmlld1JlY29yZERhdGFBcHAubW91bnQoeyByZWNvcmROYW1lIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAudmlld3JlY29yZGRhdGEgY29tbWFuZCByZXF1aXJlcyBhIHJlY29yZE5hbWVgKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1ZpZXcgZGF0YSBzdG9yZWQgaW4gcHJvdmlkZWQgcmVjb3JkIG5hbWUuIElmIHJlY29yZCBuYW1lIGlzIG5vdCBwcm92aWRlZCB0aGVuIGl0IHdpbGwgZGVmYXVsdCB0byB5b3VyIHBlcnNvbmFsIHJlY29yZC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgVmlldyBkYXRhIHN0b3JlZCBpbiBwcm92aWRlZCByZWNvcmQgbmFtZS4gSWYgcmVjb3JkIG5hbWUgaXMgbm90IHByb3ZpZGVkIHRoZW4gaXQgd2lsbCBkZWZhdWx0IHRvIHlvdXIgcGVyc29uYWwgcmVjb3JkLgoKICAgIFRoZXJlIGFyZSBzb21lIGFsaWFzZXMgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIHRoZSBhbGlhcyBhcmd1bWVudCB0byBsb2FkIGEgcmVjb3JkIHZpYSBhbGlhczoKICAgIC0gcGxheWVyOiB5b3VyIHBlcnNvbmFsIHJlY29yZAogICAgLSBhYjogYWIncyBwdWJsaWMgcmVjb3JkCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnZpZXdyZWNvcmRkYXRhJywKICAgICAgICAnLnZpZXdyZWNvcmRkYXRhIFtyZWNvcmROYW1lXScsCiAgICAgICAgJy12aWV3cmVjb3JkZGF0YSAtYSBhYicgIAogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctYScsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHByb3ZpZGVkIHJlY29yZE5hbWUgaXMgYWN0dWFsbHkgYW4gYWxpYXMuJwogICAgICAgIH0KICAgIF0KfSknAMLW1fQP+4ULCGFydGlmYWN0AgQAwtbV9A+l0Awo8J+Ulzc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNycAwtbV9A/7hQsVbG9hZEFCQ29tbWFuZHNNYW5hZ2VyAgQAwtbV9A/M0Az6LUAvKioKICogQUJDb21tYW5kc01hbmFnZXIgaXMgcGFydCBvZiBhYlNoZWxsLgogKiBZb3UgY2FuIHJlZ2lzdGVyIGNvbW1hbmRzIHRvIGl0IHRoYXQgY2FuIGJlIGludm9rZWQgdXNpbmcgJyQ8Y29tbWFuZD4nIHdpdGggdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogKiBJdHMgZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZCB0byBjcmVhdGUgdGhpcyB5b3Vyc2VsZiBidXQgaW5zdGVhZCB0byBsaXN0ZW4gZm9yIHRoZSBAb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQgc2hvdXQKICogYW5kIHRvIHJlZ2lzdGVyIHlvdXIgY29tbWFuZHMgdGhlcmUuCiAqIEBwcm9wIHtzdHJpbmdbXX0gY29tbWFuZHMKICovCmNsYXNzIEFCQ29tbWFuZHNNYW5hZ2VyIHsKICAgIGNvbW1hbmRzOiBSZWNvcmQ8c3RyaW5nLCBBQkNvbW1hbmQ+OwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKCiAgICAgICAgLy8gU2hvdXQgdGhhdCBhbiBpbnN0YW5jZSBvZiBBQkNvbW1hbmRzTWFuYWdlciBoYXMgYmVlbiBjcmVhdGVkIGFuZCBhbGxvdyBhbnkgbGlzdGVuZXJzCiAgICAgICAgLy8gdG8gYWRkIHRoZWlyIG93biBjb21tYW5kcyB0byB0aGUgaW5zdGFuY2UuCiAgICAgICAgc2hvdXQoJ29uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkJywgdGhpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgYSBjb21tYW5kIHRvIEFCQ29tbWFuZHNNYW5hZ2VyLgogICAgICogVGhpcyBjb21tYW5kIHdpbGwgYmUgYXZhaWxhYmxlIHRvIGludm9rZSB1c2luZyAnJDxuYW1lPicgb24gdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIHN1Y2Nlc3NmdWxseSBhZGRlZC4KICAgICAqLwogICAgYWRkQ29tbWFuZChuYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjaywgaGVscDogQUJDb21tYW5kSGVscCk6IGJvb2xlYW4gewogICAgICAgIGlmICghbmFtZSB8fCB0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSBzdHJpbmcgbmFtZSBpcyByZXF1aXJlZCBmb3IgY29tbWFuZHMuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBhbHJlYWR5IGV4aXN0cyBhcyBhIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghY2FsbGJhY2sgfHwgdHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGEgY2FsbGJhY2sgZnVuY3Rpb24uYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgaXMgbWlzc2luZyBzaG9ydERlc2NyaXB0aW9uIGZyb20gaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29tbWFuZHNbbmFtZV0gPSB7IG5hbWUsIGNhbGxiYWNrLCBoZWxwIH07CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaGFzQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kc1tuYW1lXSAhPSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgY29tbWFuZCBmcm9tIEFCQ29tbWFuZHNNYW5hZ2VyCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2FzIHJlbW92ZWQuIElmIHRoZSBjb21tYW5kIGRvZXNuJ3QgZXhpc3QgZmFsc2Ugd2lsbCBhbHNvIGJlIHJldHVybmVkLgogICAgICovCiAgICByZW1vdmVDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ2FsbCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2l0aCB0aGUgcHJvdmlkZWQgYXJncyAoaWYgYW55KS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBleGVjdXRlZC4KICAgICAqLwogICAgY2FsbENvbW1hbmQobmFtZTogc3RyaW5nLCBhcmdzPzogYW55W10pOiBib29sZWFuIHsKICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICBpZiAoY29tbWFuZCkgewogICAgICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRBcmdzID0gW107CgogICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBoZWxwQXJnIG9mIGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhlbHBBcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKC4uLmhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaChoZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZSBpbnB1dCBhcmdzIGFyZSB2YWxpZCBhZ2FpbnN0IHRoZSBjb21tYW5kIGhlbHAgZG9jdW1lbnRhdGlvbi4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gZWFzeSB3YXkgdG8gdmFsaWRhdGUgYXJncyBiZWZvcmUgZXhlY3V0aW5nIGEgY29tbWFuZC4KICAgICAgICAgICAgICAgIEFCQ29tbWFuZHNNYW5hZ2VyLmFzc2VydFZhbGlkQXJncyhhcmdzLCB2YWxpZEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1hbmQuY2FsbGJhY2soYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBub3QgYSB2YWxpZCBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHByb3ZpZGVkIGFyZy4gV2lsbCByZW1vdmUgdGhlIGFyZyBhbmQgdmFsdWUgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnVmFsdWUoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYW55IHsKICAgICAgICBsZXQgdmFsdWUgPSBudWxsOwoKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICBsZXQgZGVsZXRlQ291bnQgPSAxOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWVJbmRleCA9IGFyZ0luZGV4ICsgMTsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWVJbmRleCA8IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbdmFsdWVJbmRleF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlbGF0ZWQgYXJncyAmIHZhbHVlcwogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIGRlbGV0ZUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHdldGhlciB0aGUgYXJnIGZsYWcgaXMgcHJvdmlkZWQgaW4gdGhlIGFyZ3MuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnRmxhZyhhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYXJnIGZsYWcuCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgMSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHN0YXRpYyBhc3NlcnRWYWxpZEFyZ3MoYXJnczogYW55W10sIHZhbGlkQXJnczogYW55W10pOiB2b2lkIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBpbnZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFyZyB3ZSB3YW50IHRvIGV2YWx1YXRlLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkQXJncyB8fCAhdmFsaWRBcmdzLmluY2x1ZGVzKGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXJnIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgdmFsaWRBcmdzLCB0aHVzIHRoZSBhcmcgaXMgaW52YWxpZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRBcmdzLnB1c2goYXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB0aGlzIGFyZyBpdCBpcyBtb3N0bHkgbGlrZWx5IGEgdmFsdWUgYXJnLgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGludmFsaWRBcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIGFyZ3VtZW50czogJHtpbnZhbGlkQXJncy5qb2luKCcsICcpfWA7CgogICAgICAgICAgICAgICAgb3MudG9hc3QoZXJyb3JNZXNzYWdlLCA0KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpnbG9iYWxUaGlzLkFCQ29tbWFuZHNNYW5hZ2VyID0gQUJDb21tYW5kc01hbmFnZXI7JwDC1tX0D/uFCwRoZWxwAgQAwtbV9A/H/gwo8J+UlzI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYycAwtbV9A/7hQsIY21kU2hlZXQCBADC1tX0D+7+DM0UQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IHBvcnRhbDsKbGV0IG5ld1RhYiA9IGZhbHNlOwoKaWYgKGFyZ3MpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV07CiAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJy10JykgewogICAgICAgICAgICAgICAgbmV3VGFiID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSBhcmc7CiAgICAgICAgfQogICAgfQp9CgppZiAoIXBvcnRhbCkgewogICAgcG9ydGFsID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9Cgpjb25zdCBoZWxwZXJCb3RzID0gewogICAgJ2NvbmZpZ0JvdCc6IGNvbmZpZ0JvdCwKICAgICdncmlkUG9ydGFsQm90JzogZ3JpZFBvcnRhbEJvdCwKICAgICdzaGVldFBvcnRhbEJvdCc6IHNoZWV0UG9ydGFsQm90LAogICAgJ3N5c3RlbVBvcnRhbEJvdCc6IHN5c3RlbVBvcnRhbEJvdCwKICAgICdtaW5pR3JpZFBvcnRhbEJvdCc6IG1pbmlHcmlkUG9ydGFsQm90LAogICAgJ21hcFBvcnRhbEJvdCc6IG1hcFBvcnRhbEJvdCwKICAgICdtaW5pTWFwUG9ydGFsQm90JzogbWluaU1hcFBvcnRhbEJvdCwKICAgICdtZW51UG9ydGFsQm90JzogbWVudVBvcnRhbEJvdCwKICAgICdsZWZ0V3Jpc3RQb3J0YWxCb3QnOiBsZWZ0V3Jpc3RQb3J0YWxCb3QsCiAgICAncmlnaHRXcmlzdFBvcnRhbEJvdCc6IHJpZ2h0V3Jpc3RQb3J0YWxCb3QsCiAgICAnbWVldFBvcnRhbEJvdCc6IG1lZXRQb3J0YWxCb3QsCiAgICAndGFnUG9ydGFsQm90JzogdGFnUG9ydGFsQm90LAogICAgJ2ltdVBvcnRhbEJvdCc6IGltdVBvcnRhbEJvdCwKfTsKCi8vIEZ1bmN0aW9uIHRvIHJlc29sdmUgYSBwb3J0YWwgcmVmZXJlbmNlIHRvIGEgc3BlY2lmaWMgYm90CmZ1bmN0aW9uIHJlc29sdmVQb3J0YWxUb0JvdChwYXRoKSB7CiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJycpIHJldHVybiBudWxsOwogICAgCiAgICAvLyBGaXJzdCBjaGVjayBpZiBpdCdzIGRpcmVjdGx5IGluIGhlbHBlckJvdHMKICAgIGlmIChoZWxwZXJCb3RzW3BhdGhdKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlckJvdHNbcGF0aF07CiAgICB9CgogICAgLy8gUGVyaGFwcyB0aGUgcGF0aCBpcyBhIGJvdCBpZC4KICAgIGxldCBib3RGcm9tSWRTZWFyY2ggPSBnZXRCb3QoJ2lkJywgcGF0aCk7CiAgICBpZiAoYm90RnJvbUlkU2VhcmNoKSB7CiAgICAgICAgcmV0dXJuIGJvdEZyb21JZFNlYXJjaDsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgZm9yIGJvdGggZGlyZWN0IGFuZCBuZXN0ZWQgcGF0aHMgaW4gZ2xvYmFsVGhpcwogICAgbGV0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIGxldCBjdXJyZW50T2JqID0gZ2xvYmFsVGhpczsKICAgIGxldCBzdGFydEluZGV4ID0gMDsKICAgIAogICAgLy8gSGFuZGxlIGlmIHRoZSBwYXRoIGV4cGxpY2l0bHkgc3RhcnRzIHdpdGggJ2dsb2JhbFRoaXMnCiAgICBpZiAocGF0aFBhcnRzWzBdID09PSAnZ2xvYmFsVGhpcycpIHsKICAgICAgICBzdGFydEluZGV4ID0gMTsgLy8gU2tpcCB0aGUgJ2dsb2JhbFRoaXMnIHBhcnQgc2luY2Ugd2UncmUgYWxyZWFkeSBzdGFydGluZyB0aGVyZQogICAgfQogICAgCiAgICAvLyBUcmF2ZXJzZSB0aGUgcGF0aAogICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBwYXRoUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwYXJ0ID0gcGF0aFBhcnRzW2ldOwogICAgICAgIGlmICghY3VycmVudE9ialtwYXJ0XSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gUGF0aCBzZWdtZW50IGRvZXNuJ3QgZXhpc3QKICAgICAgICB9CiAgICAgICAgY3VycmVudE9iaiA9IGN1cnJlbnRPYmpbcGFydF07CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGlmIHRoZSBmaW5hbCBvYmplY3QgaXMgYSBib3QgKGhhcyBpZCBhbmQgdGFncykKICAgIGlmIChjdXJyZW50T2JqICYmIGN1cnJlbnRPYmouaWQgJiYgY3VycmVudE9iai50YWdzKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRPYmo7CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOyAvLyBOb3QgYSB2YWxpZCBib3QKfQoKLy8gU2VhcmNoIHRvIHNlZSBpZiBwb3J0YWwgYXJndW1lbnQgaXMgc3BlY2lmaWMgdG8gYSBib3QKbGV0IHVuaXF1ZUJvdCA9IHJlc29sdmVQb3J0YWxUb0JvdChwb3J0YWwpOwoKaWYgKHVuaXF1ZUJvdCkgewogICAgaWYgKHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcExvY2FsJyB8fAogICAgICAgIHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcFNoYXJlZCcKICAgICkgewogICAgICAgIC8vIEZvcmNlIHNoZWV0IHRvIG9wZW4gaW4gc2FtZSB0YWIgaWYgdGhlIGJvdCBvbmx5IGxpdmVzIGluIHRoaXMgdGFiLgogICAgICAgIG5ld1RhYiA9IGZhbHNlOwogICAgfQogICAgcG9ydGFsID0gdW5pcXVlQm90LmlkOwp9CgppZiAobmV3VGFiKSB7CiAgICBvcy5vcGVuVVJMKGAvP2luc3Q9JHtvcy5nZXRDdXJyZW50SW5zdCgpfSZzaGVldFBvcnRhbD0ke3BvcnRhbH1gKTsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gcG9ydGFsOwp9JwDC1tX0D/uFCw1jbWREb3dubG9hZEFCAgQAwtbV9A+8kw2jC0Bjb25zdCBhcmdzID0gdGhhdDsKCmxldCBhdXhWZXJzaW9uOiBzdHJpbmcgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctdicpOwoKaWYgKCFhdXhWZXJzaW9uKSB7CiAgICAvLyBEZWZhdWx0IHRvIGF1eCB2ZXJzaW9uIDIgaWYgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkLgogICAgYXV4VmVyc2lvbiA9ICcyJzsKfQoKaWYgKGF1eFZlcnNpb24gIT09ICcxJyAmJiBhdXhWZXJzaW9uICE9PSAnMicpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYE9ubHkgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgYW5kIDIgYXJlIHN1cHBvcnRlZCBpbiB0aGUgZG93bmxvYWQgYWIgY29tbWFuZC5gKTsKICAgIHJldHVybjsKfQoKLy8gbGlua3MubWFuaWZlc3RhdGlvbi5hYlNldEF3YWtlKHsgYXdha2U6IGZhbHNlIH0pOwoKbGV0IGdyb3VwcyA9IFtdOwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAvLyBSZW1haW5pbmcgYXJncyBhcmUgZ3JvdXAgbmFtZXMgcHJvdmlkZWQgd2l0aCB0aGUgY29tbWFuZC4KICAgIGdyb3VwcyA9IGFyZ3M7Cn0gZWxzZSB7CiAgICBsZXQgZ3JvdXAgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldklucHV0RG93bmxvYWRBQkdyb3VwLCB7IHRpdGxlOiAnQUIgR3JvdXAgVGFnJywgYXV0b1NlbGVjdDogdHJ1ZSB9KTsKICAgIGlmIChncm91cCkgewogICAgICAgIG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCA9IGdyb3VwOwogICAgICAgIGdyb3Vwcy5wdXNoKGdyb3VwKTsKICAgIH0KfQoKY29uc3QgbWFqb3JWZXJzaW9uID0gbGlua3MubGVhcm4udGFncy5hYkNvcmVNYWpvclZlcnNpb247CmNvbnN0IG1pbm9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWlub3JWZXJzaW9uOwpjb25zdCBhYlZlcnNpb24gPSBgJHttYWpvclZlcnNpb259LiR7bWlub3JWZXJzaW9ufWA7Cgpmb3IgKGxldCBncm91cCBvZiBncm91cHMpIHsKICAgIGNvbnN0IGdyb3VwQm90cyA9IGdldEJvdHMoYnlNb2QoeyBbZ3JvdXBdOiB0cnVlLCBzcGFjZTogJ3NoYXJlZCcgfSkpOwoKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ3JvdXBCb3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgZ3JvdXBCb3RzW2ldLnRhZ3MuYWJWZXJzaW9uID0gYWJWZXJzaW9uOwogICAgfQoKICAgIGlmIChncm91cCA9PSAiYWJDb25maWciKSB7CiAgICAgICAgZ3JvdXAgPSAiYWIxIjsKICAgIH0KCiAgICBpZiAoYXV4VmVyc2lvbiA9PT0gJzEnKSB7CiAgICAgICAgLy8gRG93bmxvYWQgYXMgdmVyc2lvbiAxCiAgICAgICAgb3MuZG93bmxvYWRCb3RzKGdyb3VwQm90cywgZ3JvdXApCiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMgogICAgICAgIG9zLmRvd25sb2FkQm90c0FzSW5pdGlhbHphdGlvblVwZGF0ZShncm91cEJvdHMsIGdyb3VwKTsKICAgIH0KCn0KCicAwtbV9A/7hQsJY21kQUJXYWtlAgQAwtbV9A/gng0xQGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiB0cnVlIH0pOycAwtbV9A/7hQsKY21kQUJTbGVlcAIEAMLW1fQPkp8N0AFAbGlua3MubWFuaWZlc3RhdGlvbi5hYlNldEF3YWtlKHsgYXdha2U6IGZhbHNlIH0pOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbFNwYWNlID0gbnVsbDsKCnRhZ1BvcnRhbEJvdC5tYXNrcy50YWdQb3J0YWxBbmNob3JQb2ludCA9IG51bGw7JwDC1tX0D/uFCwdjb25zb2xlAgQAwtbV9A/joA0o8J+UlzI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYicAwtbV9A/7hQsOY21kVXBsb2FkRmlsZXMCBADC1tX0D4qhDZMQQGNvbnN0IGFyZ3MgPSB0aGF0OwoKYXN5bmMgZnVuY3Rpb24gdXBsb2FkRmlsZSh7IGZpbGUsIHJlY29yZEtleSB9KSB7CiAgICBsZXQgZmlsZUV4dGVuc2lvbiA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpOwogICAgbGV0IGZpbGVOYW1lID0gZmlsZS5uYW1lLnNwbGl0KCcuJykuc2hpZnQoKTsKICAgIGxldCBtaW1lVHlwZTsKCiAgICBzd2l0Y2ggKGZpbGVFeHRlbnNpb24pIHsKICAgICAgICBjYXNlICdzdmcnOgogICAgICAgICAgICBtaW1lVHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnZ2xiJzoKICAgICAgICBjYXNlICdnbHRmJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAidGV4dC94bWwiOwogICAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICBtaW1lVHlwZSA9IGZpbGUubWltZVR5cGU7CiAgICAgICAgICAgIGJyZWFrOwogICAgfQoKICAgIGxldCB1cmw7CiAgICAgICAgCiAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHJlY29yZEtleTsKICAgIGNvbnN0IFtyZXN1bHRdID0gYXdhaXQgUHJvbWlzZS5hbGwoc2hvdXQoJ2FiUHVibGlzaEZpbGUnLCB7IGZpbGUsIGZpbGVOYW1lLCBtaW1lVHlwZSB9KSk7CiAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IG51bGw7CiAgICAKICAgIGlmIChyZXN1bHQudXJsKSB7CiAgICAgICAgdXJsID0gcmVzdWx0LnVybDsKICAgIH0gZWxzZSBpZiAocmVzdWx0LmV4aXN0aW5nRmlsZVVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CiAgICB9CgogICAgcmV0dXJuIHsgdXJsIH07Cn0KCmNvbnN0IHJlY29yZEtleSA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1yZWNvcmQnKTsKY29uc3Qgc2VsZWN0ZWRGaWxlcyA9IGF3YWl0IG9zLnNob3dVcGxvYWRGaWxlcygpOwpjb25zdCBwdWJsaXNoUmVjb3JkID0gZ2V0Qm90KCdzeXN0ZW0nLCAncmMtcGFja2FnZS1kZXYucHVibGlzaFJlY29yZCcpOwoKaWYgKHNlbGVjdGVkRmlsZXMgJiYgc2VsZWN0ZWRGaWxlcy5sZW5ndGgpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzLmxlbmd0aH0gZmlsZXMuLi5gKTsKICAgIH0KCiAgICBsZXQgZG9uZUh0bWwgPSAnJzsKCiAgICBpZiAocmVjb3JkS2V5KSB7CiAgICAgICAgZG9uZUh0bWwgKz0gYDxoMj5SZWNvcmQgSWQ8L2gyPmA7CiAgICAgICAgZG9uZUh0bWwgKz0gYDxwPiR7cmVjb3JkS2V5fTwvcD5gOwogICAgfQoKICAgIGRvbmVIdG1sICs9ICc8aDI+VXBsb2FkZWQgRmlsZXM8L2gyPic7CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2VsZWN0ZWRGaWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9Li4uYCk7CiAgICAgICAgCiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXBsb2FkRmlsZSh7CiAgICAgICAgICAgIGZpbGU6IHNlbGVjdGVkRmlsZXNbaV0sCiAgICAgICAgICAgIHJlY29yZEtleSwKICAgICAgICAgICAgb25Qcm9ncmVzczogKGZpbGVQcm9ncmVzcykgPT4gewogICAgICAgICAgICAgICAgb3Muc2hvd0h0bWwoYFVwbG9hZGluZyAke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX0gJHtNYXRoLmNlaWwoZmlsZVByb2dyZXNzICogMTAwKX0lYCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICAKICAgICAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgICAgICBkb25lSHRtbCArPSBgPGEgaHJlZj0iJHtyZXN1bHQudXJsfSIgdGFyZ2V0PSJfYmxhbmsiPiR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfTwvYT48L2JyPmA7CiAgICAgICAgfQoKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVwbG9hZCAke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX0gcmVzdWx0OmAsIHJlc3VsdCk7CiAgICB9CgogICAgb3Muc2hvd0h0bWwoZG9uZUh0bWwpOwp9JwDC1tX0D/uFCw5jbWREb3dubG9hZEVnZwIEAMLW1fQPnrEN+QtAY29uc3QgcmVjb3JkS2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZEb3dubG9hZEVnZ1JlY29yZEtleSwgewogICAgdGl0bGU6ICdyZWNvcmQgdG8gbG9va3VwIGVnZyBpbicsCiAgICB0eXBlOiAndGV4dCcsCn0pCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb3JkS2V5OmAsIHJlY29yZEtleSk7CgppZiAoIXJlY29yZEtleSkgewogICAgcmV0dXJuOwp9CgptYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXkgPSByZWNvcmRLZXk7Cgpjb25zdCBlZ2dOYW1lID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUsIHsKICAgIHRpdGxlOiAnbmFtZSBvZiBlZ2cnLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVnZ05hbWU6YCwgZWdnTmFtZSk7CgppZiAoIWVnZ05hbWUpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnTmFtZSA9IGVnZ05hbWU7Cgpjb25zdCBlZ2cgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgYWJJRDogZWdnTmFtZSwKICAgIHJlY29yZEtleSwKICAgIHJldHVyblR5cGU6ICdlZ2cnCn0pCgpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGVnZzpgLCBlZ2cpOwoKaWYgKCFBcnJheS5pc0FycmF5KGVnZy5lZ2dWZXJzaW9uSGlzdG9yeSkgfHwgZWdnLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgRGF0YSBmb3VuZCBhdCBhZGRyZXNzICcke2VnZ05hbWV9JyBpbiByZWNvcmQgJyR7cmVjb3JkS2V5fScgZG9lcyBub3QgYXBwZWFyIHRvIGJlIGFuIGVnZy5gKQogICAgcmV0dXJuIG51bGw7Cn0KCmNvbnN0IGVnZ1ZlcnNpb25PcHRpb25zID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5Lm1hcCgoaXRlbSwgaW5kZXgpID0+IHsKICAgIHJldHVybiB7IGxhYmVsOiBgdmVyc2lvbiAke2luZGV4ICsgMX1gLCB2YWx1ZTogaW5kZXggfQp9KQoKY29uc3Qgc2VsZWN0ZWRWZXJzaW9uT3B0aW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KGVnZ1ZlcnNpb25PcHRpb25zLmxlbmd0aCAtIDEsIHsKICAgIHRpdGxlOiAnZG93bmxvYWQgZWdnIHZlcnNpb24nLAogICAgdHlwZTogJ2xpc3QnLAogICAgc3VidHlwZTogJ3NlbGVjdCcsCiAgICBpdGVtczogZWdnVmVyc2lvbk9wdGlvbnMsCn0pCgppZiAoIXNlbGVjdGVkVmVyc2lvbk9wdGlvbikgewogICAgcmV0dXJuIG51bGw7Cn0KCmNvbnN0IGF1eERhdGFVcmwgPSBlZ2cuZWdnVmVyc2lvbkhpc3Rvcnlbc2VsZWN0ZWRWZXJzaW9uT3B0aW9uLnZhbHVlXTsKY29uc3QgYXV4RGF0YSA9IGF3YWl0IG9zLmdldEZpbGUoYXV4RGF0YVVybCk7CmNvbnN0IGF1eEZpbGVuYW1lID0gYCR7ZWdnTmFtZX1fdiR7c2VsZWN0ZWRWZXJzaW9uT3B0aW9uLnZhbHVlICsgMX0uYXV4YDsKCm9zLmRvd25sb2FkKGF1eERhdGEsIGF1eEZpbGVuYW1lLCAnYXBwbGljYXRpb24vanNvbicpOycAwtbV9A/7hQsPY21kRG93bmxvYWRJbnN0AgQAwtbV9A+YvQ1ZQGFiLmxpbmtzLnN0b3JlLmFiRG93bmxvYWQoeyByZW9wZW5BYk1lbnU6IGZhbHNlLCBzb3VyY2VFdmVudDogJ2FiX2NtZF9kb3dubG9hZF9pbnN0JyB9KTsnAMLW1fQP+4ULBnNlYXJjaAIEAMLW1fQP8r0NKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAMLW1fQP+4ULBXV0aWxzAgQAwtbV9A+Zvg0o8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAwtbV9A/7hQsJY21kU3lzdGVtAgQAwtbV9A/Avg2RB0Bjb25zdCBhcmdzID0gdGhhdDsKCmNvbnN0IHNhbWVXaW5kb3cgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ0ZsYWcoYXJncywgJy13Jyk7CgpsZXQgc3lzdGVtVGFnTmFtZSA9IG51bGw7CgppZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgIHN5c3RlbVRhZ05hbWUgPSBhcmdzLmpvaW4oJyAnKTsKfQoKaWYgKHNhbWVXaW5kb3cpIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiB0aGUgY3VycmVudCB3aW5kb3cuCiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1Qb3J0YWwgPSB0cnVlOwogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtVGFnTmFtZSA9IHN5c3RlbVRhZ05hbWU7Cn0gZWxzZSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gYSBuZXcgdGFiLgogICAgY29uc3QgdXJsID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpOwoKICAgIC8vIFJlbW92ZSBhbnkgcG9ydGFscyB0aGF0IGFyZSBzZXQgaW4gdGhlIFVSTC4KICAgIGxldCBwYXJhbXMgPSB1cmwuc2VhcmNoUGFyYW1zLmtleXMoKTsKICAgIGZvciAobGV0IHBhcmFtIG9mIHBhcmFtcykgewogICAgICAgIGlmIChwYXJhbS5lbmRzV2l0aCgnUG9ydGFsJykpIHsKICAgICAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUocGFyYW0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBUdXJuIG9uIHRoZSBzeXN0ZW0gcG9ydGFsLgogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3N5c3RlbVBvcnRhbCcsICd0cnVlJyk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZSgnc3lzdGVtVGFnTmFtZScpOwoKICAgIGlmIChzeXN0ZW1UYWdOYW1lKSB7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3N5c3RlbVRhZ05hbWUnLCBzeXN0ZW1UYWdOYW1lKTsKICAgIH0KCiAgICBvcy5vcGVuVVJMKHVybC5ocmVmKTsKfQonAMLW1fQP+4ULDWFiQ2hhdEJhck9wZW4CBADC1tX0D9LFDZEDQGlmIChhYi5saW5rcy5yZW1lbWJlci50YWdzLmFiQWxsb3dDaGF0QmFyID09PSBmYWxzZSkgewogICAgcmV0dXJuOwp9Cgpjb25zdCB7CiAgICBwcmVmaWxsLAp9ID0gdGhhdCA/PyB7fQoKbWFza3MuY2hhdE9wZW4gPSB0cnVlOwoKb3Muc2hvd0NoYXQoewogICAgcGxhY2Vob2xkZXI6ICc+IC5oZWxwIHRvIHNlZSBhdmFpbGFibGUgY29tbWFuZHMnLAogICAgYmFja2dyb3VuZENvbG9yOiAnIzJmMmYyZicsCiAgICBmb3JlZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwbGFjZWhvbGRlckNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcHJlZmlsbAp9KQoKc2hvdXQoJ29uQUJDaGF0QmFyT3BlbicsIHsgcHJlZmlsbCB9KTsnAMLW1fQP+4ULDmFiQ2hhdEJhckNsb3NlAgQAwtbV9A/kyA2SAUBtYXNrcy5jaGF0T3BlbiA9IGZhbHNlOwpvcy5oaWRlQ2hhdCgpOwoKc2hvdXQoJ29uQUJDaGF0QmFyQ2xvc2UnKTsKCi8vIEdpdmUgQ2FzdWFsT1MgYSBjaGFuZ2UgdG8gYWN0dWFsbHkgcmVtb3ZlIHRoZSBjaGF0IGJhci4KYXdhaXQgb3Muc2xlZXAoMCk7JwDC1tX0D/uFCwtwZXJzb25hbGl0eQIEAMLW1fQP98kNKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAMLW1fQP+4ULBXR5cGVzAgQAwtbV9A+eyg3yAvCfk4R0eXBlIEFCQ29tbWFuZENhbGxiYWNrID0gKGFyZ3M/OiBhbnlbXSkgPT4gdm9pZDsKCmludGVyZmFjZSBBQkNvbW1hbmRBcmcgewogIGlkZW50aWZpZXI6IHN0cmluZ1tdIHwgc3RyaW5nOwogIGRlc2NyaXB0aW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkNvbW1hbmRIZWxwIHsKICBzaG9ydERlc2NyaXB0aW9uOiBzdHJpbmc7CiAgbG9uZ0Rlc2NyaXB0aW9uPzogc3RyaW5nOwogIGFyZ3M/OiBBQkNvbW1hbmRBcmdbXTsKICB1c2FnZT86IHN0cmluZyB8IHN0cmluZ1tdOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kIHsKICBuYW1lOiBzdHJpbmc7CiAgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrOwogIGhlbHA6IEFCQ29tbWFuZEhlbHA7Cn0nAMLW1fQP+4ULEXZpZXdSZWNvcmREYXRhQXBwAgQAwtbV9A+PzQ0o8J+UlzkyZmY2ZDI4LTMzNTEtNGNmYi04NDY0LTlkN2M2MTQyN2EyNicAwtbV9A/7hQsRY21kRG93bmxvYWRTeXN0ZW0CBADC1tX0D7bNDd4GQGNvbnN0IGFyZ3MgPSB0aGF0OwoKaWYgKCFhcmdzIHx8IGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogJ011c3QgcHJvdmlkZSBzeXN0ZW0gbmFtZShzKSB0byBkb3dubG9hZC4nLCBsb2dUeXBlOiAnZXJyb3InIH0pCiAgICByZXR1cm47Cn0KCmNvbnN0IHN5c3RlbU5hbWVzID0gYXJnczsKCmZvciAoY29uc3Qgc3lzdGVtTmFtZSBvZiBzeXN0ZW1OYW1lcykgewogICAgY29uc3Qgc3lzdGVtTmFtZVBhcnRzID0gc3lzdGVtTmFtZS5zcGxpdCgnLicpOwoKICAgIGNvbnN0IHN5c3RlbUJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICAgICAgaWYgKGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLnN5c3RlbSkgewogICAgICAgICAgICBjb25zdCBzeXN0ZW1UYWdQYXJ0cyA9IGIudGFncy5zeXN0ZW0uc3BsaXQoJy4nKTsKICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBzeXN0ZW1OYW1lUGFydHMuZXZlcnkoKHN5c3RlbU5hbWVQYXJ0LCBpbmRleCkgPT4gc3lzdGVtVGFnUGFydHNbaW5kZXhdID09PSBzeXN0ZW1OYW1lUGFydCk7CiAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICB9CiAgICB9KTsKCiAgICBpZiAoc3lzdGVtQm90cyAmJiBzeXN0ZW1Cb3RzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gYCR7c3lzdGVtTmFtZX0uYXV4YDsKICAgICAgICBhYi5saW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgcG9zc2libGVCb3RzOiBzeXN0ZW1Cb3RzLCBmaWxlbmFtZSwgcmVvcGVuQWJNZW51OiBmYWxzZSwgc291cmNlRXZlbnQ6ICdhYl9jbWRfZG93bmxvYWRfc3lzdGVtJyB9KTsKICAgIH0KfScAwtbV9A/7hQsNY21kUHVibGlzaEFzawIEAMLW1fQPldQNoQ9AY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBhc2tJRCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1hc2snKTsKY29uc3QgcGF0dGVybklEID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXBhdHRlcm4nKTsKbGV0IHN0dWRpb0lEID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXN0dWRpbycpOwoKaWYgKCFhc2tJRCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGAtYXNrIGlzIGEgcmVxdWlyZWQgYXJndW1lbnRgLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCmlmICghcGF0dGVybklEKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYC1wYXR0ZXJuIGlzIGEgcmVxdWlyZWQgYXJndW1lbnRgLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCmlmICghc3R1ZGlvSUQpIHsKICAgIGlmIChhdXRoQm90KSB7CiAgICAgICAgc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEVpdGhlciBwcm92aWRlIGEgc3R1ZGlvIG9yIGxvZ2luIHRvIHVzZSB5b3VyIHBlcnNvbmFsIHN0dWRpbyBmb3IgdGhlIGFzay5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICAgICAgcmV0dXJuOwogICAgfQp9CgpsZXQgcHVibGlzaFJlc3VsdDsKCnRyeSB7CiAgICBwdWJsaXNoUmVzdWx0ID0gYXdhaXQgbGlua3Muc3RvcmUuYWJQdWJsaXNoQXNrSUQoeyBhc2tJRCwgcGF0dGVybklELCBzdHVkaW9JRCB9KTsKfSBjYXRjaCAoZSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gcHVibGlzaCBhc2sgJyR7YXNrSUR9Jy4gJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgppZiAocHVibGlzaFJlc3VsdC5zdWNjZXNzKSB7CiAgICAvLyBOZWVkIHRvIHVzZSBjb25maWdCb3Qgc3R1ZGlvIHRhZyBmb3IgbG9va3VwLgogICAgY29uZmlnQm90Lm1hc2tzLnN0dWRpbyA9IHN0dWRpb0lEOwogICAgYXdhaXQgb3Muc2xlZXAoMCk7CiAgICAKICAgIHRyeSB7CiAgICAgICAgY29uc3QgbG9va3VwQXNrUmVzdWx0ID0gYXdhaXQgbGlua3Muc2VhcmNoLmxvb2t1cEZyb21TdHVkaW8oeyBhc2tJRCwgZGF0YU9ubHk6IHRydWUgfSk7CgogICAgICAgIGlmIChsb29rdXBBc2tSZXN1bHQuc3VjY2VzcyAmJiBsb29rdXBBc2tSZXN1bHQuZGF0YSkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFB1Ymxpc2hlZCBhc2sgJyR7YXNrSUR9Jy4gJHtKU09OLnN0cmluZ2lmeShsb29rdXBBc2tSZXN1bHQuZGF0YSwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnbG9nJ30pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIGxvb2t1cCBhc2sgJyR7YXNrSUR9JyBpbiBzdHVkaW8gJyR7c3R1ZGlvSUR9Jy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIGxvb2t1cCBhc2sgJyR7YXNrSUR9JyBpbiBzdHVkaW8gJyR7c3R1ZGlvSUR9Jy4gJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgfQoKICAgIGNvbmZpZ0JvdC5tYXNrcy5zdHVkaW8gPSBudWxsOwp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gcHVibGlzaCBhc2sgJyR7YXNrSUR9Jy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCgoA"}]}