{"version":2,"updates":[{"id":0,"timestamp":1752004201503,"update":"AZADm9SFiwsAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwCb1IWLCwAGc3lzdGVtAgQAm9SFiwsBDWFiLnNoZWxsLmdyaWQnAJvUhYsLAARmb3JtAgQAm9SFiwsPB25vdGhpbmcnAJvUhYsLAAxvbkFueUJvdERyYWcCBACb1IWLCxe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAJvUhYsLAAhyZW1lbWJlcgIEAJvUhYsL0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAm9SFiwsACGFiSWdub3JlAgQAm9SFiwv6AQR0cnVlJwCb1IWLCwAHYWJTaGVsbAIEAJvUhYsL/wEEdHJ1ZScAm9SFiwsACWFiVmVyc2lvbgIEAJvUhYsLhAIEMTAuNCcAm9SFiwsABWZvY3VzAgQAm9SFiwuJAqwEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKTsKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScAm9SFiwu2BgZzeXN0ZW0CBACb1IWLC7cGE2FiLnNoZWxsLmNvbXBvbmVudHMnAJvUhYsLtgYMQXBwQ29udGFpbmVyAgQAm9SFiwvLBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycAm9SFiwu2BghUZXh0TGluawIEAJvUhYsL+AqdA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwCb1IWLC7YGBldpbmRvdwIEAJvUhYsLlg62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAJvUhYsLtgYMVGV4dExpbmsuY3NzAgQAm9SFiwvNEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwCb1IWLC7YGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAJvUhYsLuxJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAJvUhYsLtgYKV2luZG93LmNzcwIEAJvUhYsLrROoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAJvUhYsLtgYIcmVtZW1iZXICBACb1IWLC9YWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJvUhYsLtgYIYWJJZ25vcmUCBACb1IWLC/0WBHRydWUnAJvUhYsLtgYHYWJTaGVsbAIEAJvUhYsLghcEdHJ1ZScAm9SFiwu2BglhYlZlcnNpb24CBACb1IWLC4cXBDEwLjQnAQRib3RzJDI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYgEnAJvUhYsLjBcHQXBwLmNzcwIEAJvUhYsLjRexFjpyb290IHsKICAtLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgLS1vbi1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogIC0tYWItY29uc29sZS1oZWlnaHQ6IDMzdmg7Cn0KLyogRGFyayBtb2RlIHN1cHBvcnQgKi8KQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykgewogIDpyb290IHsKICAgIC0tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAgIC0tb24tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICB9Cn0KCi5hYi1jb25zb2xlLWJ0biB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiBpbmhlcml0OwogIGxldHRlci1zcGFjaW5nOiBpbmhlcml0OwogIGxpbmUtaGVpZ2h0OiBpbmhlcml0OwogIHRleHQtdHJhbnNmb3JtOiBpbmhlcml0OwogIHRleHQtaW5kZW50OiBpbmhlcml0OwogIHRleHQtc2hhZG93OiBpbmhlcml0OwogIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgbWFyZ2luOiBpbmhlcml0OwogIHBhZGRpbmctYmxvY2s6IGluaGVyaXQ7CiAgcGFkZGluZy1pbmxpbmU6IGluaGVyaXQ7CiAgYm9yZGVyOiBub25lOwogIHRyYW5zZm9ybTogc2NhbGUoMS4yKTsKfQoKLmFiLWNvbnNvbGUgewogIHdpZHRoOiAxMDB2dzsKICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogIHBhZGRpbmc6IDA7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KSBicmlnaHRuZXNzKDIwMCUpOwogIGFuaW1hdGlvbi1uYW1lOiBzbGlkZS1hcHAtaW47CiAgYW5pbWF0aW9uLWR1cmF0aW9uOiAwLjVzOwogIG92ZXJmbG93LXk6IGhpZGRlbjsKICB6LWluZGV4OiAxOwp9CgouYWItY29uc29sZTo6YWZ0ZXIgewogIGNvbnRlbnQ6ICIiOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB0b3A6IDA7CiAgbGVmdDogMDsKICByaWdodDogMDsKICBib3R0b206IDA7CiAgb3BhY2l0eTogMC45OwogIHotaW5kZXg6IDA7Cn0KCkBrZXlmcmFtZXMgc2xpZGUtYXBwLWluIHsKICBmcm9tIHsKICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGN1YmljLWJlemllciguNiwwLC43OSwxLjAzKTsKICAgIC8qIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMTAlKTsgKi8KICAgIC8qIGhlaWdodDogMHB4OyAqLwogICAgLyogbWluLWhlaWdodDogMHB4OyAqLwogICAgbWF4LWhlaWdodDogMHB4OwogIH0KCiAgdG8gewogICAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogICAgLyogbWluLWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOyAqLwogIH0KfQoKLmFiLWNvbnNvbGUgPiBkaXYgewogIHotaW5kZXg6IDE7CiAgcG9zaXRpb246IHJlbGF0aXZlCn0KCi5hYi1jb25zb2xlLXRvcC1iYXIgewogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHdpZHRoOiAxMDAlOwogIHRleHQtYWxpZ246IGNlbnRlcjsKICB1c2VyLXNlbGVjdDogbm9uZTsKICBkaXNwbGF5OiBmbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBlbmQ7CiAgcGFkZGluZzogMC41cmVtOwp9CgouYWItY29uc29sZS1sb2cgewogIG92ZXJmbG93LXk6IGF1dG87CiAgZmxleC1ncm93OiAxOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwogIG1pbi1oZWlnaHQ6IDI0cHg7CiAgcGFkZGluZzogMCAxcmVtOwogIGN1cnNvcjogcG9pbnRlcjsKICBvdmVyc2Nyb2xsLWJlaGF2aW9yOiBjb250YWluOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBjdXJzb3I6IGluaXRpYWw7Cn0KCi5hYi1jb25zb2xlLW1lc3NhZ2UtY29udGFpbmVyIHsKICBtYXJnaW46IDAuNXJlbSAwOwp9Ci5hYi1jb25zb2xlLW1lc3NhZ2UgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGdhcDogOHB4Owp9CgouYWItY29uc29sZS1zcGFjZXIgewogIGZsZXgtc2hyaW5rOiAwOwogIGZsZXgtZ3JvdzogMTsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgbWF4LXdpZHRoOiA4MHZ3OwogIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScAm9SFiwuMFwZnZXRBcHACBACb1IWLC78t3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwCb1IWLC4wXC2hpZGVDb25zb2xlAgQAm9SFiwudUZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwCb1IWLC4wXA2xvZwIEAJvUhYsLvVLkCEBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGNyZWF0ZShib3RUYWdzKTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwCb1IWLC4wXC3Nob3dDb25zb2xlAgQAm9SFiwuiW+0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAm9SFiwuMFwZzeXN0ZW0CBACb1IWLC5BfEGFiLnNoZWxsLmNvbnNvbGUnAJvUhYsLjBcNdG9nZ2xlQ29uc29sZQIEAJvUhYsLoV+WAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScAm9SFiwuMFwRmb3JtAgQAm9SFiwu4YAdub3RoaW5nJwCb1IWLC4wXB2FiU2hlbGwCBACb1IWLC8BgBHRydWUnAJvUhYsLjBcKYWJJRE9yaWdpbgIEAJvUhYsLxWAVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwCb1IWLC4wXBlRvcEJhcgIEAJvUhYsL22DzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAm9SFiwuMFw1zaG93Q2hhdElucHV0AgQAm9SFiwvPZQVmYWxzZSgAm9SFiwuMFwpzaG93VG9wQmFyAXknAJvUhYsLjBcJYWJWZXJzaW9uAgQAm9SFiwvWZQQxMC40JwCb1IWLC4wXEnNldEFiRXhwYW5kQ29uc29sZQIEAJvUhYsL22WXAkBjb25zb2xlLmxvZyh0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCkKaWYgKHR5cGVvZiB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuOwp9CgppZiAodGhhdCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChzID0+ICFzKTsKfSBlbHNlIGlmICh0aGF0ID09IHRydWUpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHRydWUpOwp9IGVsc2UgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwoZmFsc2UpOwp9CicAm9SFiwuMFwhhYklnbm9yZQIEAJvUhYsL82cEdHJ1ZScAm9SFiwuMFwdNZXNzYWdlAgQAm9SFiwv4Z+cQQGNvbnN0IHsgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZUVmZmVjdCB9ID0gb3MuYXBwSG9va3MKY29uc3QgVG9wQmFyID0gdGhpc0JvdC5Ub3BCYXIoKQoKY29uc3QgTWVzc2FnZSA9ICh7IHRpbWVzdGFtcCwgbWVzc2FnZSwgbmFtZSB9KSA9PiB7CiAgICBjb25zdCBbc2hvd1RpbWUsIHNldFNob3dUaW1lXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IFt1c2VyTWVzc2FnZSwgc2V0VXNlck1lc3NhZ2VdID0gdXNlU3RhdGUoZmFsc2UpOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGF1dGhCb3QgJiYgYXV0aEJvdC50YWdzLm5hbWUpIHsKICAgICAgICAgICAgaWYgKGF1dGhCb3QudGFncy5uYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChtYXNrcy5wcmVmZXJyZWROYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobmFtZSA9PSAidXNlciIgfHwgbmFtZSA9PSAiVXNlciIpIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UoZmFsc2UpOwogICAgICAgIH0KCiAgICB9LCBbbmFtZV0pCgogICAgY29uc3QgdGltZVRleHQgPSB1c2VNZW1vKAogICAgICAgICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aW1lc3RhbXApIHsgcmV0dXJuIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoCiAgICAgICAgICAgICAgICAgICAnZW4tdXMnLCB7dGltZVN0eWxlOiAnbWVkaXVtJ30pfSwKICAgICAgICBbdGltZXN0YW1wXQogICAgKTsKCiAgICBpZiAoIXRpbWVzdGFtcCB8fCAhbWVzc2FnZSkgeyByZXR1cm4gPD48Lz4gfQoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoKSA9PiBzZXRTaG93VGltZSh0cnVlKX0KICAgICAgICAgICAgb25Qb2ludGVyTGVhdmU9eygpID0+IHNldFNob3dUaW1lKGZhbHNlKX0KICAgICAgICA+CiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIHN0eWxlPXt1c2VyTWVzc2FnZSAmJiB7dGV4dEFsaWduOiAncmlnaHQnfX0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAge25hbWV9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlIiBzdHlsZT17ewogICAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3JvdycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ3Jvdy1yZXZlcnNlJwogICAgICAgICAgICB9fT4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXNwYWNlciIKICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0QWxpZ246IHVzZXJNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncmlnaHQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnbGVmdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHNob3dUaW1lID8gMC42IDogMAogICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAge3RpbWVUZXh0fQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1jb250ZW50Ij4KICAgICAgICAgICAgICAgICAgICB7bWVzc2FnZX0KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIE1lc3NhZ2U7JwCb1IWLC4wXEG9uQW55Qm90c1JlbW92ZWQCBACb1IWLC+B4rQJAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90SWQgb2YgYm90SURzKSB7DQogICAgaWYgKHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5kZWxldGUoYm90SWQpOw0KDQogICAgICAgIGlmIChkZWxldGVkKSB7DQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3RJZDogYm90SWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9JwCb1IWLC4wXDm9uQW55Qm90c0FkZGVkAgQAm9SFiwuOe/gDQGNvbnN0IHsgYm90cyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBuZXdCb3Qgb2YgYm90cykgew0KICAgIGlmIChuZXdCb3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMobmV3Qm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKG5ld0JvdC5pZCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IG5ld0JvdCB9KTsNCiAgICB9DQp9JwCb1IWLC4wXEG9uQW55Qm90c0NoYW5nZWQCBACb1IWLC4d/4wVAY29uc3QgYm90cyA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90IG9mIGJvdHMpIHsNCiAgICBpZiAoYm90LmJvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhib3QuYm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKGJvdC5ib3QuaWQpOw0KDQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBib3QuYm90IH0pOw0KICAgICAgICB9IA0KDQogICAgICAgIGlmIChib3QudGFncy5pbmNsdWRlcygibWVzc2FnZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJuYW1lIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoInRpbWVzdGFtcCIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIpKSB7DQogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOyAgICAgICAgDQogICAgICAgIH0NCiAgICB9DQp9JwCb1IWLC4wXH29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQCBACb1IWLC+uEATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAJvUhYsLjBcdb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQCBACb1IWLC6KFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAQRib3RzJDI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYwEnAJvUhYsL2YUBBnN5c3RlbQIEAJvUhYsL2oUBDWFiLnNoZWxsLmhlbHAnAJvUhYsL2YUBCW9uS2V5RG93bgIEAJvUhYsL6IUBjAJAaWYgKHRhZ3MuaGVscEFjdGl2ZSAmJiB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICBmb3IgKGxldCBjYWxsYmFjayBvZiB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9JwCb1IWLC9mFAQd1bm1vdW50AgQAm9SFiwv1hwGgAUBhd2FpdCBvcy5jb21waWxlQXBwKCdhYi1jb21tYW5kLWhlbHAnLCA8PjwvPik7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoJ2FiLWNvbW1hbmQtaGVscCcpOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSB1bmRlZmluZWQ7Cm1hc2tzLmhlbHBBY3RpdmUgPSBmYWxzZTsnAJvUhYsL2YUBCXN0eWxlLmNzcwIEAJvUhYsLlokB8QcuaGVscC10YWJsZSB7CiAgd2lkdGg6IDEwMCU7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi5oZWxwLXRhYmxlIHRkIHsKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHBhZGRpbmctYm90dG9tOiA4cHg7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouaGVscC10YWJsZSB0ZCBoMyB7CiAgbWFyZ2luOiAwOwp9CgouaGVscC10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA5MHB4OwogIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLnNlY3Rpb24gewogIG1hcmdpbi10b3A6IDE2cHg7Cn0KCi5zZWN0aW9uIHA6Zmlyc3Qtb2YtdHlwZSB7CiAgbWFyZ2luLXRvcDogNHB4OwogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouZGVzY3JpcHRpb24geyAKICB3aGl0ZS1zcGFjZTogcHJlLWxpbmU7Cn0KCi51c2FnZS10YWJsZSB7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi51c2FnZS10YWJsZSB0ZCxoMyB7IAogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogIG1hcmdpbjogMDsKfQoKLnVzYWdlLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDYwcHg7Cn0KCi5hcmdzLXRhYmxlIHsKICBtYXJnaW4tbGVmdDogMTZweDsKfQoKLmFyZ3MtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5hcmdzLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9CgpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpLCAobWF4LWhlaWdodDogNjAwcHgpIHsKICAuaGVscC13aW5kb3cgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBsZWZ0OiB1bnNldDsKICAgIHRvcDogdW5zZXQ7CiAgICB0cmFuc2Zvcm06IHVuc2V0OwogICAgbWF4LXdpZHRoOiB1bnNldDsKICAgIG1heC1oZWlnaHQ6IHVuc2V0OwogICAgYm94LXNoYWRvdzogdW5zZXQ7CiAgfQp9JwCb1IWLC9mFAQlvbkRlc3Ryb3kCBACb1IWLC4iRARNAdGhpc0JvdC51bm1vdW50KCk7JwCb1IWLC9mFAQVtb3VudAIEAJvUhYsLnJEBkwNAY29uc3QgewogICAgYWJDb21tYW5kc01hbmFnZXIsCiAgICBzZWxlY3RlZENvbW1hbmQKfSA9IHRoYXQgPz8ge307CgppZiAobWFza3MuaGVscEFjdGl2ZSkgewogICAgYXdhaXQgdGhpc0JvdC51bm1vdW50KCk7Cn0KCmNvbnN0IEhlbHBBcHAgPSB0aGlzQm90LkhlbHBBcHAoKTsKCmF3YWl0IG9zLnJlZ2lzdGVyQXBwKCdhYi1jb21tYW5kLWhlbHAnLCB0aGlzQm90KTsKYXdhaXQgb3MuY29tcGlsZUFwcCgnYWItY29tbWFuZC1oZWxwJywgPEhlbHBBcHAgY29tbWFuZHM9e2FiQ29tbWFuZHNNYW5hZ2VyLmNvbW1hbmRzfSBpbml0aWFsU2VsZWN0ZWRDb21tYW5kPXtzZWxlY3RlZENvbW1hbmR9Lz4pOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSBbXTsKbWFza3MuaGVscEFjdGl2ZSA9IHRydWU7JwCb1IWLC9mFAQdIZWxwQXBwAgQAm9SFiwuwlAG6L0Bjb25zdCBBcHBDb250YWluZXIgPSBsaW5rcy5jb21wb25lbnRzLkFwcENvbnRhaW5lcigpOwpjb25zdCBXaW5kb3cgPSBsaW5rcy5jb21wb25lbnRzLldpbmRvdygpOwpjb25zdCBUZXh0TGluayA9IGxpbmtzLmNvbXBvbmVudHMuVGV4dExpbmsoKTsKY29uc3QgY3NzID0gbGlua3MudXRpbHMuYWJDb21waWxlQ1NTKFsgdGhpc0JvdCwgbGlua3MuY29tcG9uZW50cyBdKTsKCmNvbnN0IHsgdXNlU3RhdGUsIHVzZUVmZmVjdCwgdXNlQ2FsbGJhY2ssIHVzZVJlZiwgdXNlTWVtbyB9ID0gb3MuYXBwSG9va3M7CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKi8KY29uc3QgQXZhaWxhYmxlQ29tbWFuZHMgPSAoeyBjb21tYW5kcywgb25Db21tYW5kQ2xpY2sgfSkgPT4gewogICAgY29uc3QgY29tbWFuZE5hbWVzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpLnNvcnQoKTsKCiAgICBjb25zdCBvbkNsb3NlID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkNsb3NlfT57J3ggQ2xvc2UnfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+QXZhaWxhYmxlIENvbW1hbmRzPC9oMj4KICAgICAgICAgICAgPHA+VXNhZ2U6IC5jb21tYW5kIFtvcHRpb25zXTwvcD4KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgICAgICB7Y29tbWFuZE5hbWVzLm1hcCgobmFtZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSBjb21tYW5kc1tuYW1lXTsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxUZXh0TGluayBvbkNsaWNrPXsoKSA9PiBvbkNvbW1hbmRDbGljayhjb21tYW5kLm5hbWUpfT57Y29tbWFuZC5uYW1lfTwvVGV4dExpbms+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57ZGVzY3JpcHRpb259PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICA8Lz4KICAgICkKfQoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge0NvbW1hbmR9IHByb3BzLmNvbW1hbmQKICovCmNvbnN0IFNwZWNpZmljQ29tbWFuZCA9ICh7IGNvbW1hbmQsIG9uQmFjayB9KSA9PiB7CiAgICBsZXQgdXNhZ2UgPSAnJzsKICAgIGxldCBkZXNjcmlwdGlvbiA9IG51bGw7CiAgICBsZXQgYXJncyA9IG51bGw7CgogICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgIGlmIChjb21tYW5kLmhlbHAudXNhZ2UpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29tbWFuZC5oZWxwLnVzYWdlKSkgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2Uuam9pbignXG4nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVzYWdlID0gY29tbWFuZC5oZWxwLnVzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5sb25nRGVzY3JpcHRpb247CiAgICAgICAgfSBlbHNlIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzICYmIGNvbW1hbmQuaGVscC5hcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgYXJncyA9IGNvbW1hbmQuaGVscC5hcmdzOwogICAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuICgKICAgICAgICA8PiAgCiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkJhY2t9PnsnPCBCYWNrJ308L1RleHRMaW5rPjwvcD4KICAgICAgICAgICAgPGgyPntjb21tYW5kLm5hbWV9PC9oMj4KICAgICAgICAgICAgeyB1c2FnZSAmJgogICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0ndXNhZ2UtdGFibGUnPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxoMz5Vc2FnZTo8L2gzPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57dXNhZ2V9PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGRlc2NyaXB0aW9uICYmIAogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5EZXNjcmlwdGlvbjo8L2gzPgogICAgICAgICAgICAgICAgICAgIDxwIGNsYXNzTmFtZT0nZGVzY3JpcHRpb24nPntkZXNjcmlwdGlvbn08L3A+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGFyZ3MgJiYKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uJz4KICAgICAgICAgICAgICAgICAgICA8aDM+QXJndW1lbnRzOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0nYXJncy10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgICAgIHsgYXJncy5tYXAoKGFyZykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcmcuaWRlbnRpZmllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ0Rlc2NyaXB0aW9uRGlzcGxheSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllci5qb2luKCcsXG4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLmRlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gYXJnLmRlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2FyZ0lkZW50aWZpZXJEaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnRGVzY3JpcHRpb25EaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgfSl9CiAgICAgICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIDxici8+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2hlbHAtdGFibGUnPgogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKiBAcGFyYW0ge2FueVtdfSBbcHJvcHMuYXJnc10KICovCmNvbnN0IEhlbHBBcHAgPSAoeyBjb21tYW5kcywgaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCB9KSA9PiB7CiAgICBjb25zdCBbIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kIF0gPSB1c2VTdGF0ZShpbml0aWFsU2VsZWN0ZWRDb21tYW5kKTsKCiAgICAvLyBFc2NhcGUga2V5IHByZXNzIGV2ZW50IGhhbmRsZXIKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgY29uc3Qgb25Fc2NhcGVLZXlQcmVzcyA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkQ29tbWFuZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MucHVzaChvbkVzY2FwZUtleVByZXNzKTsKCiAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tJbmRleCA9IHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLmZpbmRJbmRleCgoY2FsbGJhY2spID0+IGNhbGxiYWNrID09PSBvbkVzY2FwZUtleVByZXNzKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3Muc3BsaWNlKGNhbGxiYWNrSW5kZXgsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgW3NlbGVjdGVkQ29tbWFuZF0pOwogICAgCiAgICBjb25zdCBvbkJhY2tncm91bmRDbGljayA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgIH0sIFtdKTsKCiAgICBjb25zdCBvbkNvbW1hbmRDbGljayA9IHVzZUNhbGxiYWNrKChuYW1lKSA9PiB7CiAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG5hbWUpOwogICAgfSwgW3NldFNlbGVjdGVkQ29tbWFuZF0pCgogICAgY29uc3QgY29udGVudCA9IHVzZU1lbW8oKCkgPT4gewogICAgICAgIGlmICghc2VsZWN0ZWRDb21tYW5kKSB7CiAgICAgICAgICAgIHJldHVybiA8QXZhaWxhYmxlQ29tbWFuZHMgY29tbWFuZHM9e2NvbW1hbmRzfSBvbkNvbW1hbmRDbGljaz17b25Db21tYW5kQ2xpY2t9Lz4KICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgcmV0dXJuIDxTcGVjaWZpY0NvbW1hbmQgY29tbWFuZD17Y29tbWFuZHNbc2VsZWN0ZWRDb21tYW5kXX0gb25CYWNrPXsoKSA9PiBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCl9Lz4KICAgICAgICB9CiAgICB9LCBbY29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kXSk7CgogICAgcmV0dXJuICgKICAgICAgICA8PgogICAgICAgICAgICA8c3R5bGU+e2Nzc308L3N0eWxlPgoKICAgICAgICAgICAgPEFwcENvbnRhaW5lciBvbkJhY2tncm91bmRDbGljaz17b25CYWNrZ3JvdW5kQ2xpY2t9PgogICAgICAgICAgICAgICAgPFdpbmRvdz4KICAgICAgICAgICAgICAgICAgICB7Y29udGVudH0KICAgICAgICAgICAgICAgIDwvV2luZG93PgogICAgICAgICAgICA8L0FwcENvbnRhaW5lcj4KICAgICAgICA8Lz4KICAgICkKfQoKcmV0dXJuIEhlbHBBcHA7JwCb1IWLC9mFAQpjb21wb25lbnRzAgQAm9SFiwvrwwEo8J+UlzExYzk1YzdkLWExOTMtNDAwZS1iNzEwLTNiYTA0ODZhNmExYScAm9SFiwvZhQEFdXRpbHMCBACb1IWLC5LEASjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCb1IWLC9mFAQhhYklnbm9yZQIEAJvUhYsLucQBBHRydWUnAJvUhYsL2YUBB2FiU2hlbGwCBACb1IWLC77EAQR0cnVlJwCb1IWLC9mFAQlhYlZlcnNpb24CBACb1IWLC8PEAQQxMC40JwEEYm90cyQzNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMBJwCb1IWLC8jEAQZzeXN0ZW0CBACb1IWLC8nEAQ9hYi5zaGVsbC5jcmVhdGUnAJvUhYsLyMQBBGZvcm0CBACb1IWLC9nEAQdub3RoaW5nJwCb1IWLC8jEAQtkZXNjcmlwdGlvbgIEAJvUhYsL4cQBPUJvdCB1c2VkIHRvIGNyZWF0ZS9tYW5pZmVzdCBib3RzIGludG8gYW4gYWN0dWFsIHNjZW5lL3BvcnRhbC4nAJvUhYsLyMQBDGFiQ3JlYXRlQm90cwIEAJvUhYsLn8UBtyJALy9jaGVja3MgZm9yIGluaXRpYWwgYm9vdCBib29sZWFuCmxldCBpbml0aWFsQm9vdCA9IHRoYXQuaW5pdGlhbEJvb3Q7Ci8vYm90cyB0byBiZSBnZW5lcmF0ZWQKbGV0IGJvdERhdGEgPSB0aGF0LmJvdHM7Ci8vd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCmxldCBvcmlnaW4gPSB0aGF0Lm9yaWdpbjsKLy93aGF0IHN0dWRpbyBpcyB0aGlzIGRhdGEgZnJvbSAob3B0aW9uYWwpCmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvCi8vdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCmxldCB2ZXJzaW9uID0gdGhhdC52ZXJzaW9uOwovLyBSeWFuIENvb2s6IGFkZGluZyB0aGlzIGFzIGFuIG9wdGlvbmFsIGZsYWcuCmxldCBpZ25vcmVHcmlkRm9jdXMgPSB0aGF0Lmlnbm9yZUdyaWRGb2N1czsKLy9pZE1hcCBhbmQgbmV3Qm90cyBhcmUgdXNlZCB0byBtYW5hZ2UgdGhlIGluY29taW5nIGJvdCBkYXRhCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKCi8vdGhpcyBsb29wIGNyZWF0ZXMgdGhlIG5ldyBib3RzIGFuZCB0aGVuIHBhY2thZ2VzIHRoZW0gZm9yIGFkZGl0aW9uYWwgcHJvY2Vzc2luZywgd2hpbGUgYWRkaW5nIGFueSBuZWVkZWQgYWRkaXRpb25hbCB0YWdzCmZvciAoY29uc3QgcHJvcGVydHkgaW4gYm90RGF0YSkgewogICAgY29uc3QgbmV3Qm90ID0gYm90RGF0YVtwcm9wZXJ0eV07CiAgICBjb25zdCBib3RUb3RhbCA9IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aDsKICAgIGNvbnN0IGFiSURPcmlnaW4gPSB7IGFiSURPcmlnaW46IG9yaWdpbiwgYWJJRFN0dWRpbzogdGhhdC5zdHVkaW8gfTsKICAgIGNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBpZiAobmV3Qm90LnRhZ3MpIHsKICAgICAgICBpZiAobmV3Qm90LnRhZ3MuY3JlYXRvcikgewogICAgICAgICAgICBhYklET3JpZ2luLm9sZENyZWF0b3IgPSBuZXdCb3QudGFncy5jcmVhdG9yOwogICAgICAgIH0KCiAgICAgICAgbGV0IHRhcmdldFBvc2l0aW9uOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBSeWFuIENvb2s6IFRoaXMgdGFyZ2V0UG9zaXRpb24gc3R1ZmYgaXMgYXBwYXJlbnRseSB1c2VkIGZvciBib3QgcGFzdGluZz8gCiAgICAgICAgICAgIC8vIFRoaXMgaXMgc29tZSByZWFsbHkgY29uZnVzaW5nIGxvZ2ljIGFuZCBzaG91bGQgYmUgcmVmYWN0b3JlZCBldmVudHVhbGx5LgogICAgICAgICAgICBpZiAoKGJvdFRvdGFsIDwgMiB8fCBib3RUb3RhbCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXREaW1lbnNpb24gPSBhYkdyaWRGb2N1cy5kaW1lbnNpb247CgogICAgICAgICAgICAgICAgdGFyZ2V0UG9zaXRpb24gPSB7IFt0YXJnZXREaW1lbnNpb25dOiB0cnVlLCBbdGFyZ2V0RGltZW5zaW9uICsgIlgiXTogYWJHcmlkRm9jdXMucG9zaXRpb24ueCwgW3RhcmdldERpbWVuc2lvbiArICJZIl06IGFiR3JpZEZvY3VzLnBvc2l0aW9uLnkgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGIgPSBjcmVhdGUobmV3Qm90LnRhZ3MsIHRhcmdldFBvc2l0aW9uLCBhYklET3JpZ2luKTsKCiAgICAgICAgICAgIGlkTWFwLnNldChib3REYXRhW3Byb3BlcnR5XS5pZCwgYi5pZCk7CiAgICAgICAgICAgIG5ld0JvdHMucHVzaChiKTsKCiAgICAgICAgICAgIGlmIChiLnRhZ3MuY3JlYXRvciA9PSB0aGlzQm90LmlkKSB7CiAgICAgICAgICAgICAgICBiLnRhZ3MuY3JlYXRvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJpbnZhbGlkIGJvdCIsIGVycm9yKTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZygic2tpcHBlZCBib3Q6ICIgKyBuZXdCb3QpOwogICAgfQp9CgovL2FycmF5IG9mIHRhZyByZWxhdGlvbnNoaXBzIHRvIGJlIHByZXNlcnZlZApsZXQgbGlua1RhZ3MgPSBbImxpbmsiLCAiY3JlYXRvciIsICJjb25maWdCb3QiLCAibGluZVRvIiwgInRyYW5zZm9ybWVyIiwgImZvcm1MaWdodFRhcmdldCJdOwoKLy90aGlzIGxvb3AgY29udGFpbnMgdGhlIGxvZ2ljIGZvciBwcmVzZXJ2aW5nIHRoZSBsaW5rVGFncwpmb3IgKGxldCBuZXdCb3Qgb2YgbmV3Qm90cykgewogICAgZm9yIChsZXQgdGFnIG9mIGxpbmtUYWdzKSB7CiAgICAgICAgbGV0IHZhbHVlID0gbmV3Qm90LnRhZ3NbdGFnXTsKCiAgICAgICAgaWYgKHRhZyA9PSAiY3JlYXRvciIpIHsKICAgICAgICAgICAgdmFsdWUgPSBuZXdCb3QudGFncy5vbGRDcmVhdG9yOwogICAgICAgICAgICBuZXdCb3QudGFncy5vbGRDcmVhdG9yID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUJvdExpbmtzKG5ld0JvdCwgaWRNYXApOwoKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBsZXQgbmV3VmFsdWUgPSB2YWx1ZS5tYXAoaWQgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpZE1hcC5nZXQoaWQpIHx8IGlkOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lEID0gaWRNYXAuZ2V0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3SUQpIHsKICAgICAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdJRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy90b2FzdHMgZm9yIGhhdGNoZXMsIGJ1dCBvbmx5IG9uIGJ1aWxkZXIKaWYgKGNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSA9PSBudWxsICYmICFjb25maWdCb3QudGFncy5waCAmJiBidWlsZGVyVmVyc2lvbiA9PSAiYnVpbGRlciIpIHsKICAgIG9zLnRvYXN0KCJoYXRjaGVkICIgKyBvcmlnaW4gKyAiIHYiICsgdmVyc2lvbik7Cn0KCmlmIChvcmlnaW4pIHsKICAgIGxldCBhYkVnZyA9IHt9OwoKICAgIGFiRWdnLmFiID0gdHJ1ZTsKICAgIGFiRWdnLmFiRWdnID0gdHJ1ZTsKICAgIC8vYWJFZ2cuc3BhY2UgPSAibG9jYWwiOwogICAgYWJFZ2cuYWJJZ25vcmUgPSB0cnVlOwogICAgYWJFZ2cub3JpZ2luX2FiID0gb3JpZ2luOwogICAgYWJFZ2cub3JpZ2luX3ZlcnNpb24gPSB2ZXJzaW9uOwogICAgYWJFZ2cub3JpZ2luX3JlY29yZCA9IHRoYXQucmVjb3JkOwogICAgYWJFZ2cub3JpZ2luX3N0dWRpbyA9IHN0dWRpbzsKICAgIGFiRWdnLmZvcm0gPSAiZWdnIjsKICAgIGFiRWdnLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VDb2xvcjsKICAgIGFiRWdnLmxhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3I7CiAgICBhYkVnZy5sYWJlbCA9IG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uOwogICAgYWJFZ2cuYWJYID0gZ2V0Qm90cygiYWIiKS5sZW5ndGggKiAxLjU7CgogICAgY3JlYXRlKGFiRWdnKTsKfQoKLy9hZGRpdGlvbmFsIGhhdGNoIGRhdGEKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47CgovL2NoZWNrIGFuZCBleGVjdXRlIG9uUHJlSGF0Y2ggY29kZQpmb3IgKGNvbnN0IGhhdGNoaW5nQm90IG9mIG5ld0JvdHMpIHsKICAgIGlmIChoYXRjaGluZ0JvdC50YWdzLm9uUHJlSGF0Y2gpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBoYXRjaGluZ0JvdC5vblByZUhhdGNoKHsgYWI6IG9yaWdpbiwgdmVyc2lvbjogdmVyc2lvbiB9KTsKICAgICAgICB9CiAgICAgICAgY2F0Y2gKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBvblByZUhhdGNoIG5vdCB2YWxpZCBvbiBib3QgJHtoYXRjaGluZ0JvdC5pZH1gKTsKICAgICAgICB9CiAgICB9Cn0KCi8vaW5pdGlhbCBib290IGxvZ2ljIFdIQVQgSVMgVEhJUz8/PwppZiAoaW5pdGlhbEJvb3QpIHsKICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gb3JpZ2luOwp9CgovL29uRWdnSGF0Y2ggZm9yIGFsbCBqdXN0IGhhdGNoZWQgYm90cwp3aGlzcGVyKG5ld0JvdHMsICJvbkVnZ0hhdGNoIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uOiB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgZWdnUGFyYW1ldGVyczogdGhhdC5lZ2dQYXJhbWV0ZXJzIH0pOwoKLy9vbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbjogdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QgfSk7CgpyZXR1cm4gbmV3Qm90czsnAJvUhYsLyMQBCHJlbWVtYmVyAgQAm9SFiwvX5wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAm9SFiwvIxAEJb25BYkFkZGVkAgQAm9SFiwv+5wFdQGNvbnNvbGUubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyB0aGF0LmFiLCAidmVyc2lvbjogIiArIHRoYXQudmVyc2lvbik7JwCb1IWLC8jEAQhhYklnbm9yZQIEAJvUhYsL3OgBBHRydWUnAJvUhYsLyMQBB2FiU2hlbGwCBACb1IWLC+HoAQR0cnVlJwCb1IWLC8jEAQlhYlZlcnNpb24CBACb1IWLC+boAQQxMC40JwEEYm90cyQ1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYBJwCb1IWLC+voAQZzeXN0ZW0CBACb1IWLC+zoARBhYi5zaGVsbC52ZXJzaW9uJwCb1IWLC+voAQRmb3JtAgQAm9SFiwv96AEHbm90aGluZycAm9SFiwvr6AEIYWJJZ25vcmUCBACb1IWLC4XpAQR0cnVlJwCb1IWLC+voAQdhYlNoZWxsAgQAm9SFiwuK6QEEdHJ1ZScAm9SFiwvr6AETYWJTaGVsbE1ham9yVmVyc2lvbgIEAJvUhYsLj+kBATEnAJvUhYsL6+gBDW9uU2tpbGxVcGRhdGUCBACb1IWLC5HpAZcBQGNvbnN0IHZlcnNpb25TdHJpbmcgPSB0YWdzLmFiU2hlbGxNYWpvclZlcnNpb24gKyAiLiIgKyB0YWdzLmFiU2hlbGxNaW5vclZlcnNpb247DQoNCmNvbnNvbGUubG9nKCJbQUJTaGVsbF0gTG9hZGVkIEFCIHNoZWxsIHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAm9SFiwvr6AEJYWJWZXJzaW9uAgQAm9SFiwup6gEEMTAuNCcAm9SFiwvr6AETYWJTaGVsbE1pbm9yVmVyc2lvbgIEAJvUhYsLruoBAjEwJwEEYm90cyQ3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YBJwCb1IWLC7HqAQZzeXN0ZW0CBACb1IWLC7LqAQ5hYi5zaGVsbC5zdG9yZScAm9SFiwux6gEEZm9ybQIEAJvUhYsLweoBB25vdGhpbmcnAJvUhYsLseoBC2Rlc2NyaXB0aW9uAgQAm9SFiwvJ6gE/VGhpcyBza2lsbCBpcyBtZWFudCB0byBiZSBhIGNvbmZpZ3VyYWJsZSBtZWFucyB0byBwdWJsaXNoIGRhdGEuJwCb1IWLC7HqAQ9hYlB1Ymxpc2hSZWNvcmQCBACb1IWLC4nrAbIGQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmc7CmxldCByZWNvcmREYXRhID0gdGhhdC5kYXRhOwpsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKbGV0IGVuZHBvaW50ID0gdGhhdC5lbmRwb2ludCA/IHRoYXQuZW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghcmVjb3JkRGF0YSkKewogICAgcmV0dXJuICJubyBkYXRhIHN1cHBsaWVkIjsKfQoKaWYgKHB1YmxpY0ZhY2luZykKewogICAgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEodXNlclJlY29yZCwgcmVjb3JkTmFtZSwgcmVjb3JkRGF0YSwge2VuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogWyJwdWJsaWNSZWFkIl19KTsKfQplbHNlCnsgICAgCiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbcmVjb3JkTmFtZV19KTsKfQoKaWYgKHJlY29yZERhdGEuc3VjY2VzcykKewogICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRhdGEgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRhdGEgZmFpbGVkIHRvIHJlY29yZCIpOwp9CgpyZXR1cm4gcmVjb3JkRGF0YTsnAJvUhYsLseoBDWFiUHVibGlzaEZpbGUCBACb1IWLC7zxAZcHQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgZmlsZSA9IHRoYXQuZmlsZTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlTmFtZTsKbGV0IG1pbWVUeXBlID0gdGhhdC5taW1lVHlwZTsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKaWYgKCFmaWxlKQp7CiAgICByZXR1cm4gIm5vIGZpbGUgc3VwcGxpZWQiOwp9CgpsZXQgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwge2Rlc2NyaXB0aW9uOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlfSk7CiAgICAKaWYgKCFmaWxlVXBsb2FkLnN1Y2Nlc3MpIAp7CiAgICBpZiAoZmlsZVVwbG9hZC5lcnJvckNvZGUgPT0gImZpbGVfYWxyZWFkeV9leGlzdHMiKQogICAgewogICAgICAgIGFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGFscmVhZHkgZXhpc3RzIGluICIgKyB1c2VyUmVjb3JkKTsKCiAgICAgICAgcmV0dXJuIGZpbGVVcGxvYWQ7CiAgICB9CgogICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHVzZXJSZWNvcmQpOwoKICAgIGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHtkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwp9CgppZiAoZmlsZVVwbG9hZC5zdWNjZXNzKQp7CiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZmlsZSByZWNvcmRlZCB0byAiICsgdXNlclJlY29yZCk7Cn0KZWxzZQp7CiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZmlsZSBmYWlsZWQgdG8gcmVjb3JkIik7Cn0KCnJldHVybiBmaWxlVXBsb2FkOycAm9SFiwux6gEQYWJDb3JlTWVudUFjdGlvbgIEAJvUhYsL1PgBTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCb1IWLC7HqAQtvblN0b3JlTWVudQIEAJvUhYsLovkB0ZMBQGNvbnN0IHRhcmdldEJvdHMgPSBbLi4ubmV3IFNldChsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpXTsKY29uc3QgcG9zc2libGVQdWJsaXNoQm90ID0gdGFyZ2V0Qm90cz8ubGVuZ3RoID4gMCA/IHRhcmdldEJvdHMgOiBsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzID8gW2xpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXNdIDogW107CmNvbnN0IGJhc2VBQiA9ICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzID8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMuaWQ7CmNvbnN0IGJhc2VCb3RzID0gZ2V0Qm90cyhieU1vZCh7YWJJRE9yaWdpbjogYmFzZUFCLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwpjb25zdCBub25BQkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiBudWxsLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IGRlZmF1bHRzID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBtYW5hZ2VyOiAi8J+UlyIgKyB0aGlzQm90LmlkLAogICAgbWFuaWZlc3RhdGlvbjogdGFncy5tYW5pZmVzdGF0aW9uLAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAKfQoKLy8gQ3JlYXRlIGRvd25sb2FkIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgIGxhYmVsOiAiZG93bmxvYWQiLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm1BZGRyZXNzOiAiZ2V0X2FwcCIsCiAgICBwb3NzaWJsZUJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYkRvd25sb2FkKHtiYXNlQUI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBwb3NzaWJsZUJvdHM6IGxpbmtzLnBvc3NpYmxlQm90fSk7YAp9KTsKCmlmICghYXV0aEJvdCkgCnsKICAgIC8vIENyZWF0ZSBsb2dpbiBtZXNzYWdlCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgICAgIGxhYmVsOiAicGxlYXNlIHNpZ24gaW4gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siLAogICAgICAgIG9uQ2xpY2s6IGBAIG9zLnJlcXVlc3RBdXRoQm90KClgCiAgICB9KTsKCiAgICByZXR1cm47Cn0KZWxzZSBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIgPT0gIkZyZWVQbGF5IikgCnsKICAgIC8vIENyZWF0ZSB1cGdyYWRlIHN1YnNjcmlwdGlvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInBsZWFzZSB1cGdyYWRlIHlvdXIgc3Vic2NyaXB0aW9uIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIgogICAgfSk7CgogICAgcmV0dXJuOwp9CgoKbGV0IHVzZXJTdHVkaW9zID0gY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zOwoKaWYgKCF1c2VyU3R1ZGlvcykgCnsKICAgIHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7Cn0KCmlmICh1c2VyU3R1ZGlvcy5zdWNjZXNzKSAKewogICAgY29uc3QgYWN0aXZlU3R1ZGlvID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCk7CgogICAgbGV0IGJhc2VTdHVkaW8gPSBhdXRoQm90LmlkOwoKICAgIGlmIChiYXNlU3R1ZGlvID09IGF1dGhCb3QuaWQpIAogICAgewogICAgICAgIGJhc2VTdHVkaW8gPSAicGxheWVyIjsKICAgIH0KCiAgICBpZiAoYWN0aXZlU3R1ZGlvID09IC0xICYmIGJhc2VTdHVkaW8gIT0gInBsYXllciIpIAogICAgewogICAgICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYmFzZVN0dWRpbzsKICAgIH0KCiAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICYmICFhY3RpdmVTdHVkaW8pIAogICAgewogICAgICAgIGNvbnN0IHN0dWRpb01hdGNoID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCgogICAgICAgIGlmIChzdHVkaW9NYXRjaCAhPSAtMSkgewogICAgICAgICAgICBiYXNlU3R1ZGlvID0gYmFzZVN0dWRpbzsKICAgICAgICB9CiAgICB9CgogICAgY29uc3Qgc3R1ZGlvTGFiZWwgPSBhY3RpdmVTdHVkaW8gPT0gLTEgPyBiYXNlU3R1ZGlvIDogdXNlclN0dWRpb3Muc3R1ZGlvc1thY3RpdmVTdHVkaW9dLmRpc3BsYXlOYW1lOwoKICAgIC8vIENyZWF0ZSBzdHVkaW8gc2VsZWN0IGJ1dHRvbgogICAgY29uc3Qgc3R1ZGlvRGlzcGxheUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInN0dWRpbz0iICsgc3R1ZGlvTGFiZWwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUsCiAgICAgICAgc3R1ZGlvSW5mb3JtYXRpb246IHVzZXJTdHVkaW9zLAogICAgICAgIGZvcm1BZGRyZXNzOiAiaW52ZW50b3J5XzIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuc3R1ZGlvU2VsZWN0KHRhZ3Muc3R1ZGlvSW5mb3JtYXRpb24pO2AKICAgIH0pOwoKICAgIG1hc2tzLnN0dWRpb1NlbGVjdEJ1dHRvbiA9IGdldExpbmsoc3R1ZGlvRGlzcGxheUJ1dHRvbik7Cn0KCmNvbnN0IHRvdGFsQm90Q291bnQgPSBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoID4gMCA/IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggbGFiZWwgYnV0dG9uCmNvbnN0IGxhYmVsQm90ID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBsYWJlbDogYHB1Ymxpc2ggcGF0dGVybiAke2Jhc2VCb3RzLmxlbmd0aCA+IDAgPyAiIiA6ICJhcyAifSR7YmFzZUFCfSAoJHt0b3RhbEJvdENvdW50fSBib3Qke2Jhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgdG90YWxCb3RzOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoLAogICAgYWJNZW51U29ydE9yZGVyOiAxLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgZm9ybUFkZHJlc3M6IG51bGwsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IDhweCAwcHggMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItdG9wLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgc2hpZnRTdGF0ZTogZmFsc2UsCiAgICBvbkNsaWNrOiBgQCBjb25zdCBtZW51Qm90cyA9IGdldEJvdHMoJ2FiTWVudVNvcnRPcmRlcicpOwoKICAgICAgICBpZiAodGFncy5zaGlmdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5VXAiLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleURvd24iLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRhZ3Muc2hpZnRTdGF0ZSA9ICF0YWdzLnNoaWZ0U3RhdGU7YCwKICAgIHNjYWxlWTogImF1dG8iLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgbGV0IHRvdGFsQm90cyA9IGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA/IHRoYXQuYWJCb3RzIDogdGhhdC5hYkJvdHMgKyB0aGF0Lm5vbkFCQm90czsKCiAgICBjb25zdCB0b3RhbEJvdFZhciA9IHRvdGFsQm90cyA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHM/Lmxlbmd0aCAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIGlmIChnZXRCb3QoImFiSURPcmlnaW4iLCBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQikpCiAgICAgICAgewogICAgICAgICAgICBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKS5sZW5ndGg7CgogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIGFiQm90cyArICIgYm90cykiOwoKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSBhYkJvdHM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCBwYXR0ZXJuIGFzICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjsKCiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgICAgIH0gICAKICAgIH0KICAgIGVsc2UKICAgIHsgICAKICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIHRoYXQuYWIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7OwoKICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgIH1gCn0pOwoKLy8gQ3JlYXRlIGVuY3J5cHQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgIGxhYmVsOiAiZW5jcnlwdCIsCiAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgIGVuY3J5cHRTdGF0ZTogZmFsc2UsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBpZih0YWdzLmVuY3J5cHRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSB0cnVlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSB0cnVlOwogICAgICAgIH1gLAp9KTsKCmxldCBhYkJ1dHRvbjsKCmlmIChwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vIENyZWF0ZSBpbmNsdWRlQm90cyBidXR0b24KICAgIGFiQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MiwKICAgICAgICBhYlNlbGVjdGlvbkJ1dHRvbjogdHJ1ZSwKICAgICAgICBsYWJlbDogYmFzZUJvdHMubGVuZ3RoID4gMCAmJiBiYXNlQUIgIT0gdW5kZWZpbmVkID8gYHNlbGVjdGVkIHBhdHRlcm46ICR7YmFzZUFCfSAoJHtiYXNlQm90cy5sZW5ndGh9IGJvdCR7YmFzZUJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCA6IGBuZXcgcGF0dGVybiAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAnZWdnJywKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoU2VsZWN0KCk7YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXJOb24gPSB0aGF0Lm5vbkFCQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICBjb25zdCBib3RWYXJBQiA9IHRoYXQuYWJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgICAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9IHRoYXQuYWIgKyAiICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXJOb247CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAic2VsZWN0ZWQgcGF0dGVybjogIiArIHRoYXQuYWIgKyAiICgiICsgdGhhdC5hYkJvdHMgKyBib3RWYXJBQjsKICAgICAgICB9YAogICAgfSk7Cn0KCmlmIChub25BQkJvdHMubGVuZ3RoID4gMCAmJiBwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vaWNsdWRlIG5ldyBib3RzCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MywKICAgICAgICBhYkJ1dHRvbjogZ2V0TGluayhhYkJ1dHRvbiksCiAgICAgICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICAgICAgbGFiZWw6IGBpbmNsdWRlIG5ldyAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94IiwKICAgICAgICB1bmNsYWltZWRTdGF0ZTogZmFsc2UsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gbGlua3MuYWJCdXR0b24udGFncy5sYWJlbDsKCiAgICAgICAgICAgICAgICBpZiAobGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYodGFncy51bmNsYWltZWRTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhieU1vZCh7YWJJRE9yaWdpbjogbnVsbCwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKCiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vbkFCQm90cy5sZW5ndGh9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CgogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiAwfSk7CiAgICAgICAgICAgIH1gLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAiaW5jbHVkZSBuZXcgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhcjsKCiAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSB0aGF0LmFiOwoKICAgICAgICAgICAgaWYoIWxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgcHVibGljIGJ1dHRvbgppZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIAp7CiAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBmYWxzZTsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgICAgIGxhYmVsOiAiaXNQdWJsaWMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgICAgIHB1YmxpY1N0YXRlOiBmYWxzZSwKICAgICAgICBvbkNsaWNrOiBgQCBpZih0YWdzLnB1YmxpY1N0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IHRydWU7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHZlcnNpb24gc2VsZWN0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBsYWJlbDogJ3ZlcnNpb25GbGFnPWN1cnJlbnQnLAogICAgZm9ybUFkZHJlc3M6ICdhbHRfcm91dGUnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIHNob3V0KCdzaG93VmVyc2lvblNlbGVjdG9yJyk7YCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICd2ZXJzaW9uRmxhZz0nICsgdGhhdDsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgIGAsCn0pOwoKLy8gQ3VycmVudCBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdjdXJyZW50JywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl9jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBGZWVkYmFjayBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdmZWVkYmFjaycsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdmZWVkYmFjayc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gU3RhYmxlIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ3N0YWJsZScsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMiwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdzdGFibGUnOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIENyZWF0ZSBwdWJsaXNoIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogNCwKICAgIGZvcm1BZGRyZXNzOiAiZWdnIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHggMHB4IDhweCA4cHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLCAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItYm90dG9tLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm06ICJpbnB1dCIsCiAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICBvbklucHV0VHlwaW5nOiBgQCBsaW5rcy5sYWJlbEJvdC50YWdzLmxhYmVsID0gJ3B1Ymxpc2ggcGF0dGVybiBhcyAnICsgdGhhdC50ZXh0ICsgJyAoJyArIGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzICsgJyBib3QnICsgKGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzID09IDEgPyAnKScgOiAncyknKTtgLAogICAgbWVudUl0ZW1TaG93U3VibWl0V2hlbkVtcHR5OiB0cnVlLAogICAgdGFyZ2V0Qm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBtZW51SXRlbVRleHQ6IGJhc2VBQiwKICAgIG9uU3VibWl0OiBgQAogICAgICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQudGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0YXJnZXRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwogICAgICAgICAgICBjb25zdCBjb25maXJtUHVzaCA9IGF3YWl0IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgICAgIHRpdGxlOiAiY29uZmlybSBwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICJwdWJsaXNoICIgKyB0aGF0LnRleHQgKyAiIHRvICIgKyB0YXJnZXRTdHVkaW8gKyAiPyIsCiAgICAgICAgICAgICAgICBjb25maXJtVGV4dDogInB1Ymxpc2giLAogICAgICAgICAgICAgICAgY2FuY2VsVGV4dDogImNhbmNlbCIKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIWNvbmZpcm1QdXNoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2ggPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHRoYXQudGV4dCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGlua3MubWFuYWdlci5hYlB1Ymxpc2hBQih7YWI6IHRoYXQudGV4dCwgbWFudWFsUHVibGlzaDogdHJ1ZSwgYm90OiBsaW5rcy50YXJnZXRCb3QsIGJhc2VBQjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUJ9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJhYiBub3Qgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSB0aGF0LmFiOwogICAgfWAKfSk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgCnsKICAgIC8vIENyZWF0ZSBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDgsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAiY29weSB0byBjbGlwYm9hcmQiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiZmlsZV9jb3B5IiwKICAgICAgICB0YXJnZXRCb3Q6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RGb2N1cywKICAgICAgICBvbkNsaWNrOiBgQCBsZXQgc2VsZWN0ZWRCb3QgPSBsaW5rcy50YXJnZXRCb3Q7CiAgICAgICAgICAgIGxldCBwcmVwcGVkQm90ID0gSlNPTi5zdHJpbmdpZnkoc2VsZWN0ZWRCb3QpOwogICAgICAgICAgICBsZXQgc3RhdGUgPSB7fQoKICAgICAgICAgICAgc3RhdGVbYWJJbnN0TWVtb3J5LnRhZ3MuYWJGb2N1c0RhdGFdID0gc2VsZWN0ZWRCb3Q7CgogICAgICAgICAgICBsZXQgbmV3RmlsZSA9IHt9CiAgICAgICAgICAgIG5ld0ZpbGUudmVyc2lvbiA9IDE7CiAgICAgICAgICAgIG5ld0ZpbGUuc3RhdGUgPSBzdGF0ZTsKCiAgICAgICAgICAgIHZhciBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkobmV3RmlsZSk7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChmb3JtYXR0ZWRGaWxlKTsKCiAgICAgICAgICAgIG9zLnRvYXN0KCJib3QgY29waWVkIHRvIGNsaXBib2FyZCIpOwoKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CiAgICAgICAgYCwKICAgIH0pOwp9CmVsc2UgCnsKICAgIC8vIENyZWF0ZSBzY2FuIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMTAsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyAgICAgICAgICAgIAogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAic2NhbiB0byBwdWJsaXNoIiwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgb25DbGljazogYEAgY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSB0cnVlOyBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpO2AsCiAgICB9KTsKfQoKbGV0IGhvc3RCdXR0b24gPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDUwLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgZm9ybUFkZHJlc3M6ICJncm91cF9hZGQiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLmxlYXJuLmFiQ3JlYXRlSG9zdCh0aGlzQm90KTsKICAgIGlmICghbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpCiAgICB7CiAgICAgICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKICAgIH1gLAp9OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMCwgMykgKyAiLSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMyk7Cn0KZWxzZSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJnZW5lcmF0ZSBqb2luIGNvZGUiOwp9CgppZiAoY29uZmlnQm90LnRhZ3Muc3RhdGljSW5zdCA9PSB1bmRlZmluZWQpCnsKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGhvc3RCdXR0b24pOy8vZ2VuZXJhdGUgYSBob3N0IGJ1dHRvbgp9JwCb1IWLC7HqAQ5hYkNvcmVNZW51SWNvbgIEAJvUhYsL5owDCWlvc19zaGFyZScAm9SFiwux6gEPYWJDb3JlTWVudUxhYmVsAgQAm9SFiwvwjAMFc2hhcmUnAJvUhYsLseoBE2FiQ29yZU1lbnVTb3J0T3JkZXICBACb1IWLC/aMAwEzJwCb1IWLC7HqAQhyZW1lbWJlcgIEAJvUhYsL+IwDKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAJvUhYsLseoBC2FiUHVibGlzaEFCAgQAm9SFiwufjQOxMUAvL3Nob3V0KCJhYlB1Ymxpc2hBQiIsIHthYjogIiIsIGtleTogIiIsIHRhcmdldDogIiJ9KTsKaWYgKHRoYXQuYWIuaW5kZXhPZigiICIpICE9IC0xIHx8IHRoYXQuYWIuaW5kZXhPZignIicpICE9IC0xKQp7CiAgICBvcy50b2FzdCgicGF0dGVybiBuYW1lcyBtYXkgbm90IGNvbnRhaW4gc3BhY2VzIG9yIHF1b3RhaW9uIG1hcmtzLCBwbGVhc2UgdHJ5IGFnYWluLiIpOwoKICAgIHJldHVybjsKfQoKYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IHB1Ymxpc2hpbmcgIiArIHRoYXQuYWIpOwoKbGV0IHByb2dyZXNzQnV0dG9uOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCi8vY2xlYXIgYWIgYnVpbGRlcgppZiAobGlua3MubWFuaWZlc3RhdGlvbikKewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpCiAgICB7CiAgICAgICAgZGVzdHJveShsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KTsKICAgIH0KfQoKLy9wcm9ncmVzcyBiYXIgZm9yIG1hbnVhbCBwdWJsaXNoaW5nIGNvbmZpcm1hdGlvbgppZiAoY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCkKewogICAgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5pbnB1dC5hYlByb2dyZXNzQmFyKGB1cGxvYWRpbmcgJHt0aGF0LmFifWApOwp9CgovL2FiIHZhcmlhYmxlcwpsZXQgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKbGV0IHJldHVyblR5cGUgPSB0aGF0LnJldHVyblR5cGU7CmxldCBwdWJsaWNGYWNpbmcgPSB0aGF0LnB1YmxpY0ZhY2luZyA/PyBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmc7CmxldCBzdGF0ZSA9IHt9OwpsZXQgZm9ybWF0dGVkRmlsZSA9IHt9OwoKY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKCi8vdGhpcyBsb2dpYyBmb3JtYXRzIHRoZSBzcGVjaWZpZWQgYm90cyBhbmQgcGFja2FnZXMgdGhlbSBmb3IgcHVibGlzaGluZwppZiAoIUFycmF5LmlzQXJyYXkodGFyZ2V0KSAmJiB0YXJnZXQgIT0gbnVsbCAmJiB0YXJnZXQgIT0gdW5kZWZpbmVkKQp7Cgp9CmVsc2UgaWYgKCF0YXJnZXQgfHwgdGFyZ2V0Lmxlbmd0aCA8IDEpCnsKICAgIGNvbnN0IGJhc2VBQiA9IHRoYXQuYmFzZUFCID8/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwoKICAgIGlmIChjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgJiYgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQikKICAgIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGJ5TW9kKHtzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsLCBhYklET3JpZ2luOiBhYklEfSkpOwoKICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwogICAgfQogICAgZWxzZSBpZiAoY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiAmJiBnZXRCb3QoImFiSURPcmlnaW4iLCBiYXNlQUIpKQogICAgewogICAgICAgIGNvbnN0IGVnZ0JvdHMgPSBnZXRCb3RzKGJ5TW9kKHtzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsLCBhYklET3JpZ2luOiBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCfSkpOwogICAgICAgIGNvbnN0IG5ld0JvdHMgPSBnZXRCb3RzKGJ5TW9kKHtzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsLCBhYklET3JpZ2luOiBudWxsfSkpOwoKICAgICAgICB0YXJnZXQgPSBbLi4uZWdnQm90cywgLi4ubmV3Qm90c107CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhieU1vZCh7c3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKICAgIH0KCiAgICBzZXRUYWcodGFyZ2V0LCAiYWJJRE9yaWdpbiIsIGFiSUQpOwoKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgPSBudWxsOwoKICAgIGlmICh0YXJnZXQubGVuZ3RoIDwgMSkKICAgIHsKICAgICAgICBvcy50b2FzdCgiTm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikKewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkKICAgIHsKICAgICAgICBrZXlDaGVjayA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdjb25maXJtIHNlY3JldCBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKGtleSAhPSBrZXlDaGVjaykgewogICAgICAgIGlmICgha2V5Q2hlY2spCiAgICAgICAgewogICAgICAgICAgICBvcy50b2FzdCgibm8ga2V5IGVudGVyZWQiKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgb3MudG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIAp7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgewogICAgICAgIGxldCBjdXJyZW50Qm90SUQgPSB0YXJnZXRbaV0uaWQ7CiAgICAgICAgbGV0IGN1cnJlbnRCb3QgPSB0YXJnZXRbaV07CiAgICAgICAgCiAgICAgICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3Q7CiAgICB9Cn0KZWxzZSAKewogICAgc3RhdGVbdGFyZ2V0LmlkXSA9IHRhcmdldDsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7YWJJRDogYWJJRH0pOwoKLy9hZGQgeHAgYm90IGhlcmUKY29uc3QgeHBWZXJzaW9uQm90ID0ge307Cgp4cFZlcnNpb25Cb3Quc3BhY2UgPSAic2hhcmVkIjsKeHBWZXJzaW9uQm90LmlkID0gImFiWFBCb3QiOwp4cFZlcnNpb25Cb3QudGFncyA9IHt9Owp4cFZlcnNpb25Cb3QudGFncy5mb3JtID0gIm5vdGhpbmciOwp4cFZlcnNpb25Cb3QudGFncy5zeXN0ZW0gPSAiYWIucGF0dGVybi5hYlhQQm90IjsKeHBWZXJzaW9uQm90LnRhZ3MuYXV0aG9ySUQgPSBhdXRoQm90LmlkOwp4cFZlcnNpb25Cb3QudGFncy52ZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uOwp4cFZlcnNpb25Cb3QudGFncy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKeHBWZXJzaW9uQm90LnRhZ3Muc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwp4cFZlcnNpb25Cb3QudGFncy5hYklnbm9yZSA9IHRydWU7CgpzdGF0ZS5hYlhQQm90ID0geHBWZXJzaW9uQm90OwoKLy9hZGRpdGlvbmFsIGZpbGUgZGF0YQpmb3JtYXR0ZWRGaWxlLnZlcnNpb24gPSAxOwpmb3JtYXR0ZWRGaWxlLnNpZ25hdHVyZSA9IGVnZ0NoZWNrLnNpZ25hdHVyZTsKZm9ybWF0dGVkRmlsZS5zdGF0ZSA9IHN0YXRlOwoKLy9hY3R1YWwgZW5jcnlwdGlvbiBpZiBjaG9zZW4KaWYgKGtleSkgCnsKICAgIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRGaWxlKTsKCiAgICBmb3JtYXR0ZWRGaWxlID0gY3J5cHRvLmVuY3J5cHQoa2V5LCBmb3JtYXR0ZWRGaWxlKTsKfQoKLy9wdWJsaXNoIHRoZSBmaWxlCmxldCBwdWJsaXNoRmlsZSA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoRmlsZSh7ZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUR9KTsKCi8vZ2F0aGVyIGFkZGlvbmFsIGVnZyBkYXRhCmNvbnN0IGFpUGVybWl0Q2hlY2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhaV9wZXJtaXQiKTsKY29uc3QgYWlQZXJtaXRJRCA9IGFpUGVybWl0Q2hlY2suc3VjY2VzcyA/IGFpUGVybWl0Q2hlY2suZGF0YS5wZXJtaXRJRCA6IGZhbHNlOwoKZWdnQ2hlY2suZWdnRGF0YS5haVBlcm1pdCA9IGFpUGVybWl0SUQ7CmVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkucHVzaChwdWJsaXNoRmlsZS51cmwpOwplZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKZWdnQ2hlY2suZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CgovL3B1Ymxpc2ggZWdnL2FiIHJlY29yZApsZXQgcHVibGlzaFJlY29yZCA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoUmVjb3JkKHtkYXRhOiBlZ2dDaGVjay5lZ2dEYXRhLCByZWNvcmROYW1lOiBhYklELCBwdWJsaWNGYWNpbmc6IHB1YmxpY0ZhY2luZ30pOwpsZXQgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CgovL3B1Ymxpc2hpbmcgc2hvdXQKc3VwZXJTaG91dCgib25BQlB1Ymxpc2hlZCIsIHtzdWNjZXNzOiBwdWJsaXNoRmlsZS5zdWNjZXNzLCBhYjogYWJJRCwgZmlsZUFkZHJlc3M6IHB1Ymxpc2hGaWxlLnVybH0pOy8vUkVNT1ZFIFRISVMgRVZFTlRVQUxMWQpzdXBlclNob3V0KCJvbkFiUHVibGlzaGVkIiwge3N1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsfSk7Cgpjb25zdCBzdHVkaW9MaW5rID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCi8vc2VuZCBkYXRhIGFuZCBmb3JtYXQgdXJsIGlmIGRhdGEgc3VjY2Vzc2Z1bGx5IHNlbnQKaWYgKHB1Ymxpc2hSZWNvcmQuc3VjY2VzcykKewogICAgY29uc3QgYmlvcyA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlJTIwaW5zdCIgOiAibG9jYWwlMjBpbnN0IjsKICAgIGNvbnN0IGluc3RUeXBlID0gcHVibGljRmFjaW5nID8gImZyZWUiIDogImxvY2FsIgoKICAgIHNldFRhZ01hc2sobGlua3MubGVhcm4sICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKCiAgICBpZiAoa2V5ICYmIGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2gpIAogICAgewogICAgICAgIG9zLnNldENsaXBib2FyZChzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICIma2V5PSIgKyBrZXkgKyAiJnN0dWRpbz0iICsgc3R1ZGlvTGluayArICImYmlvcz0iICsgYmlvcyk7CiAgICAgICAgCiAgICAgICAgb3MudG9hc3QoYGVuY3J5cHRlZCBkYXRhIHdpdGggYSAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkYCk7CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy5tYW51YWxQdWJsaXNoKQogICAgewogICAgICAgIG9zLnNldENsaXBib2FyZChzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICImc3R1ZGlvPSIgKyBzdHVkaW9MaW5rICsgIiZiaW9zPSIgKyBiaW9zKTsKCiAgICAgICAgb3MudG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmRgKTsKICAgIH0KCiAgICB0cnkgCiAgICB7CiAgICAgICAgYXdhaXQgYW5hbHl0aWNzLnJlY29yZEV2ZW50KCdhYl9lZ2dfcHVibGlzaCcsIHsgYWI6IGFiSUQsIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoIH0pOwogICAgfQogICAgY2F0Y2ggKGUpIAogICAgewogICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgfQp9CmVsc2UKewogICAgaWYgKCFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUpCiAgICB7CiAgICAgICAgb3MudG9hc3QoInB1Ymxpc2hpbmcgZmFpbGVkLCBwbGVhc2UgdHJ5IGFnYWluIik7CiAgICB9CgogICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IHB1Ymxpc2hpbmcgZmFpbGVkIik7CiAgICAKICAgIGNvbnNvbGUubG9nKHB1Ymxpc2hSZWNvcmQpOwp9CgovL2NsZWFyIHByb2dyZXNzIGJhcgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9Cgpjb25maWdCb3QudGFncy5tYW51YWxQdWJsaXNoID0gbnVsbDsKCnJldHVybiBwdWJsaXNoUmVjb3JkOycAm9SFiwux6gEIYWJJZ25vcmUCBACb1IWLC9G+AwR0cnVlJwCb1IWLC7HqAQphYkRvd25sb2FkAgQAm9SFiwvWvgO7BkAvL2Rvd25sb2FkIGJvdHMgKGVpdGhlciBzZWxlY3RlZCBvciBhbGwgZXhwZXJpZW5jZSkKbGV0IGRvd25sb2FkQm90czsKCmNvbnNvbGUubG9nKCJkb3dubG9hZCIsIHRoYXQpOwoKaWYgKEFycmF5LmlzQXJyYXkodGhhdC5wb3NzaWJsZUJvdHMpKQp7CiAgICBpZiAodGhhdC5wb3NzaWJsZUJvdHMubGVuZ3RoID4gMCkKICAgIHsKICAgICAgICBkb3dubG9hZEJvdHMgPSB0aGF0LnBvc3NpYmxlQm90czsKCiAgICAgICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRvd25sb2FkaW5nIGJvdHMiKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBkb3dubG9hZEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsiYWJJZ25vcmUiOiBudWxsLCAic3BhY2UiOiAic2hhcmVkIn0pKTsKCiAgICAgICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRvd25sb2FkaW5nIGluc3QiKTsKICAgIH0gICAgCn0KZWxzZQp7CgoKICAgIGRvd25sb2FkQm90cyA9IFt0aGF0LnBvc3NpYmxlQm90c107CgogICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRvd25sb2FkaW5nIGJvdCIpOwp9CgppZiAoIUFycmF5LmlzQXJyYXkoZG93bmxvYWRCb3RzKSkKewogICAgZG93bmxvYWRCb3RzID0gW2Rvd25sb2FkQm90c107Cn0KCmxldCBjdXJyZW50SW5zdCA9IG9zLmdldEN1cnJlbnRJbnN0KCk7Cgpvcy5kb3dubG9hZEJvdHMoZG93bmxvYWRCb3RzLCBjdXJyZW50SW5zdCk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7JwCb1IWLC7HqAQ1tYW5pZmVzdGF0aW9uAgQAm9SFiwuSxQMo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAm9SFiwux6gEEbWVudQIEAJvUhYsLucUDKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJvUhYsLseoBEmFiUHJldmlvdXNFZ2dDaGVjawIEAJvUhYsL4MUDsQ9ALy90aGlzIGZ1bmN0aW9uIGNoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhdCBhIHNwZWNpZmllZCBhYiwgcmV0dXJuaW5nIGFueSBkYXRhIHRoYXQgaXQgZmluZHMKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgZWdnSGlzdG9yeTsKbGV0IGVnZ0lEOwpsZXQgdGFyZ2V0VmVyc2lvbk51bTsKbGV0IGxhc3RIYXNoOwpsZXQgbWF4VmVyc2lvbk51bTsKbGV0IHN0YWJsZVZlcnNpb247CmxldCBmZWVkYmFja1ZlcnNpb247CmxldCBwcmV2aW91c1hQOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpsZXQgcmVjb3JkTG9va3VwID0gYXdhaXQgb3MuZ2V0RGF0YSh1c2VyUmVjb3JkLCBhYklEKS5jYXRjaChlID0+IHt9KTsKCmlmIChyZWNvcmRMb29rdXAuc3VjY2VzcykgCnsKICAgIGVnZ0hpc3RvcnkgPSByZWNvcmRMb29rdXAuZGF0YS5lZ2dWZXJzaW9uSGlzdG9yeTsKICAgIGVnZ0lEID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnSUQ7CiAgICBwcmV2aW91c1hQID0gcmVjb3JkTG9va3VwLmRhdGEueHAgPz8gMDsKICAgIHRhcmdldFZlcnNpb25OdW0gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7CiAgICBsYXN0SGFzaCA9IGVnZ0hpc3RvcnlbdGFyZ2V0VmVyc2lvbk51bSAtIDFdOwogICAgc3RhYmxlVmVyc2lvbiA9IHJlY29yZExvb2t1cC5kYXRhLnN0YWJsZVZlcnNpb247CiAgICBmZWVkYmFja1ZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5mZWVkYmFja1ZlcnNpb247CiAgICBtYXhWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9IAplbHNlIAp7CiAgICBlZ2dIaXN0b3J5ID0gW107CiAgICBlZ2dJRCA9IHV1aWQoKTsKICAgIHRhcmdldFZlcnNpb25OdW0gPSAxOwogICAgbGFzdEhhc2ggPSAibm9uZSI7CiAgICBtYXhWZXJzaW9uTnVtID0gMTsKICAgIHByZXZpb3VzWFAgPSAwOwp9CgppZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gImZlZWRiYWNrIikgCnsKICAgIGZlZWRiYWNrVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQplbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9PSAic3RhYmxlIikKewogICAgc3RhYmxlVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQoKY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwoKbGV0IGVnZyA9IHt9OwoKZWdnLmVnZ1ZlcnNpb25IaXN0b3J5ID0gZWdnSGlzdG9yeTsKZWdnLmVnZ0Zvcm1hdFZlcnNpb24gPSBlZ2dJRDsKZWdnLnRhcmdldFZlcnNpb24gPSB0YXJnZXRWZXJzaW9uTnVtOwplZ2cubWF4VmVyc2lvbiA9IG1heFZlcnNpb25OdW07CmVnZy5sYWJlbCA9ICJ2Iit0YXJnZXRWZXJzaW9uTnVtOwplZ2cuc3RhYmxlVmVyc2lvbiA9IHN0YWJsZVZlcnNpb247CmVnZy5mZWVkYmFja1ZlcnNpb24gPSBmZWVkYmFja1ZlcnNpb247CmVnZy5hYklEID0gYWJJRDsKZWdnLnhwID0gbGlua3MubGVhcm4udGFncy5hYlhQOwoKbGV0IHNpZ25hdHVyZSA9IHt9OwpsZXQgZGF0ZSA9IG5ldyBEYXRlKCk7CmxldCB0aW1lID0gZGF0ZS5nZXRUaW1lKCk7CgpzaWduYXR1cmUucHJldmlvdXNIYXNoID0gbGFzdEhhc2g7CnNpZ25hdHVyZS5hYlZlcnNpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29yZVZlcnNpb247CnNpZ25hdHVyZS5lZ2dWZXJzaW9uID0gdGFncy5lZ2dVVUlEOwpzaWduYXR1cmUuZWdnVmVyc2lvbk51bSA9IHRhZ3Mub3ZvVmVyc2lvbjsKc2lnbmF0dXJlLnRpbWVTdGFtcCA9IHRpbWU7CnNpZ25hdHVyZS5jYXN1YWxPU1ZlcnNpb24gPSBbb3MudmVyc2lvbigpXTsKCnJldHVybiB7c2lnbmF0dXJlOiBzaWduYXR1cmUsIGVnZ0RhdGE6IGVnZ307JwCb1IWLC7HqAQ9hYkJvdE1lbnVBY3Rpb24CBACb1IWLC5LVA01AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAm9SFiwux6gEOYWJCb3RNZW51TGFiZWwCBACb1IWLC+DVAwVzaGFyZScAm9SFiwux6gENYWJCb3RNZW51SWNvbgIEAJvUhYsL5tUDCWlvc19zaGFyZScAm9SFiwux6gESYWJCb3RNZW51U29ydE9yZGVyAgQAm9SFiwvw1QMDMy41JwCb1IWLC7HqAQVsZWFybgIEAJvUhYsL9NUDKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJvUhYsLseoBC2FiUVJQdWJsaXNoAgQAm9SFiwub1gPGAUBjb25maWdCb3QudGFncy5wdWJsaXNoU2NhbiA9IG51bGw7CgpsZXQgc2Nhbm5lZFVSTDsKCnRyeSAKewogICAgc2Nhbm5lZFVSTCA9IG5ldyBVUkwodGhhdCk7Cn0KY2F0Y2ggKGUpIAp7CiAgICBzaG91dCgiYWJQdWJsaXNoQUIiLCB7YWI6IHRoYXR9KTsKCiAgICB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogdGhhdH0pOwoKICAgIHJldHVybjsKfScAm9SFiwux6gEGc2VhcmNoAgQAm9SFiwvi1wMo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAm9SFiwux6gEHYWJTaGVsbAIEAJvUhYsLidgDBHRydWUnAJvUhYsLseoBDHN0dWRpb1NlbGVjdAIEAJvUhYsLjtgDiwtALy9zaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJTdHVkaW9NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3Qgc3R1ZGlvcyA9IHRoYXQuc3R1ZGlvczsKY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJTdHVkaW9NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAwOwptZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uYWJTdHVkaW9NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5sYWJlbCA9ICJwbGF5ZXIgc3R1ZGlvIjsKbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldFN0dWRpbyA9PSBhdXRoQm90LmlkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24uc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQCBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHRhZ3Muc3R1ZGlvSUQ7CgpsaW5rcy5tYW5hZ2VyLmxpbmtzLnN0dWRpb1NlbGVjdEJ1dHRvbi50YWdzLmxhYmVsID0gdGFncy5sYWJlbDsKCnNob3V0KCJhYlN0dWRpb01lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc3R1ZGlvcy5sZW5ndGg7IGkrKykKewogICAgbGV0IGFjdGl2ZVN0dWRpbyA9IHN0dWRpb3NbaV07CgogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldFN0dWRpbyA9PSBhY3RpdmVTdHVkaW8uc3R1ZGlvSWQgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVN0dWRpby5kaXNwbGF5TmFtZTsKICAgIG1lbnVCdXR0b24uc3R1ZGlvSUQgPSBhY3RpdmVTdHVkaW8uc3R1ZGlvSWQ7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0nAJvUhYsLseoBDmFiUHVibGlzaEFza0lEAgQAm9SFiwuY4wP0BEBsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5pbnB1dC5hYlByb2dyZXNzQmFyKGBwdWJsaXNoaW5nICR7dGhhdC5hc2tJRH1gKTsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7Cgpjb25zdCBwYXR0ZXJuSUQgPSB0aGF0LnBhdHRlcm5JRDsKY29uc3Qgc3R1ZGlvSUQgPSB0aGF0LnN0dWRpb0lEID8gdGhhdC5zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBhdXRoQm90LmlkOwpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQucmVwbGFjZUFsbCgiLSIsICIiKTsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmNvbnN0IHB1Ymxpc2hBc2sgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFza0lELCB7cGF0dGVybklEOiBwYXR0ZXJuSUQsIHN0dWRpb0lEOiBzdHVkaW9JRH0sIHtlbmRwb2ludDogZW5kcG9pbnQsIHVwZGF0ZVBvbGljeTogW2F1dGhCb3QuaWRdfSk7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gcHVibGlzaEFzazsnAJvUhYsLseoBBWlucHV0AgQAm9SFiwuN6AMo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAm9SFiwux6gELYWJFbWJlZExpbmsCBACb1IWLC7ToA6QDQGNvbnN0IGFiID0gdGhhdCA/IHRydWUgOiBmYWxzZTsKY29uc3QgZW1iZWRMaW5rID0gYWIgPyAiYWI9IiArIHRoYXQgOiAiaW5zdD0iICsgY29uZmlnQm90LnRhZ3MuaW5zdDsKY29uc3Qgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CmNvbnN0IGVtYmVkVGV4dCA9IGA8IURPQ1RZUEUgaHRtbD4KwqDCoMKgwqA8aHRtbD4KwqDCoMKgwqDCoMKgwqDCoDxoZWFkPjwvaGVhZD4KwqDCoMKgwqDCoMKgwqDCoDxib2R5PgrCoMKgwqDCoMKgwqDCoMKgwqDCoMKgwqA8aWZyYW1lIHNyYz0iJHtzaXRlT3JpZ2luICsgIi8/IiArIGVtYmVkTGlua30iIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjQwMCIgLz4KwqDCoMKgwqDCoMKgwqDCoDwvYm9keT4KwqDCoMKgwqA8L2h0bWw+YDsKCnJldHVybiBlbWJlZFRleHQ7JwCb1IWLC7HqAQ9hYlBhdHRlcm5VcGRhdGUCBACb1IWLC63rA+cEQC8vc2hvdXQoImFiUGF0dGVyblVwZGF0ZSIsIHthYklEOiBhYklELCBzdHVkaW86c3R1ZGlvPywgYm90czogYm90cz99KTsKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghYXV0aEJvdCkKewogICAgcmV0dXJuOwp9Cgpjb25zdCBhYklEID0gdGhhdC5hYklEOwpjb25zdCBzdHVkaW8gPSB0aGF0LnN0dWRpbyA/IHRoYXQuc3R1ZGlvIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKY29uc3QgYWJNYW5pZmVzdCA9IGdldEJvdChieU1vZCh7YWJFZ2c6IHRydWUsIG9yaWdpbl9hYjogYWJJRH0pKTsKCmlmICghYWJNYW5pZmVzdCkKewogICAgc2hvdXQoIm9uTG9va3VwQUJFZ2dzIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBhdXRvSGF0Y2g6IHRydWV9KTsKCiAgICByZXR1cm47Cn0KCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gc3R1ZGlvOwoKY29uc3QgYWJCb3RzID0gdGhhdC5ib3RzID8/IGdldEJvdHMoImFiSURPcmlnaW4iLCBhYklEKTsKCmF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBhYklELCB0YXJnZXQ6IGFiQm90cywgcHVibGljRmFjaW5nOiB0cnVlfSk7JwCb1IWLC7HqARdhYk11bHRpcGxlQm90TWVudUFjdGlvbgIEAJvUhYsLlfADTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCb1IWLC7HqARphYk11bHRpcGxlQm90TWVudVNvcnRPcmRlcgIEAJvUhYsL4/ADATInAJvUhYsLseoBFWFiTXVsdGlwbGVCb3RNZW51SWNvbgIEAJvUhYsL5fADCWlvc19zaGFyZScAm9SFiwux6gEWYWJNdWx0aXBsZUJvdE1lbnVMYWJlbAIEAJvUhYsL7/ADBXNoYXJlJwCb1IWLC7HqAQ9hYlB1Ymxpc2hTZWxlY3QCBACb1IWLC/XwA4kTQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiUGF0dGVybk1lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBhbGxCb3RzID0gZ2V0Qm90cygiYWJJRE9yaWdpbiIpOwpjb25zdCBhbGxQYXR0ZXJucyA9IFsibmV3IHBhdHRlcm4iXTsKCmJvdExvb3A6CmZvciAobGV0IGkgPSAwOyBpIDwgYWxsQm90cy5sZW5ndGg7IGkrKykKewogICAgY29uc3QgYWN0aXZlQm90ID0gYWxsQm90c1tpXTsKCiAgICBpZiAoYWN0aXZlQm90LnRhZ3MuYWJJZ25vcmUpCiAgICB7CiAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgIH0KCiAgICBjb25zdCBwb3NzaWJsZVBhdHRlcm4gPSBhY3RpdmVCb3QudGFncy5hYklET3JpZ2luOwoKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBqKyspCiAgICB7CiAgICAgICAgY29uc3QgYWN0aXZlUGF0dGVybiA9IGFsbFBhdHRlcm5zW2pdOwoKICAgICAgICBpZiAoYWN0aXZlUGF0dGVybiA9PSBwb3NzaWJsZVBhdHRlcm4gKQogICAgICAgIHsKICAgICAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaiA9PSBhbGxQYXR0ZXJucy5sZW5ndGggLSAxKQogICAgICAgIHsKICAgICAgICAgICAgYWxsUGF0dGVybnMucHVzaChwb3NzaWJsZVBhdHRlcm4pOwogICAgICAgIH0KICAgIH0KfQoKY29uc3QgdGFyZ2V0QUIgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3QgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiUGF0dGVybk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKbWVudUJ1dHRvbi5yZW1lbWJlciA9IHRhZ3MucmVtZW1iZXI7Cm1lbnVCdXR0b24ub25DbGljayA9IGBAY29uc3QgdG90YWxQYXR0ZXJuQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IHRhZ3MubGFiZWwsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CmNvbnN0IG5vblBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhieU1vZCh7YWJJRE9yaWdpbjogbnVsbCwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKCnNob3V0KCJhYlNlbGVjdFRpdGxlVXBkYXRlIiwge2FiOiB0YWdzLmxhYmVsLCBhYkJvdHM6IHRvdGFsUGF0dGVybkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vblBhdHRlcm5Cb3RzLmxlbmd0aH0pOwoKbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZEFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJQYXR0ZXJuTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7YDsKCmFsbFBhdHRlcm5zLnNvcnQoKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVQYXR0ZXJuTmFtZSA9IGFsbFBhdHRlcm5zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRBQiA9PSBhY3RpdmVQYXR0ZXJuTmFtZSA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gYWN0aXZlUGF0dGVybk5hbWU7CgogICAgaWYgKGFjdGl2ZVBhdHRlcm5OYW1lID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gLTE7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gaTsKICAgIH0KCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKfQoKaWYgKCFnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGZvcm1BZGRyZXNzOiAicmFkaW9fYnV0dG9uX2NoZWNrZWQifSkpKQp7CiAgICBjb25zdCBuZXdCb3QgPSBnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGxhYmVsOiAibmV3IHBhdHRlcm4ifSkpOwogICAgCiAgICBuZXdCb3QudGFncy5mb3JtQWRkcmVzcyA9ICJyYWRpb19idXR0b25fY2hlY2tlZCI7Cn0nAJvUhYsLseoBCWFiVmVyc2lvbgIEAJvUhYsL/YMEBDEwLjQnAQRib3RzJDc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNwEnAJvUhYsLgoQEBnN5c3RlbQIEAJvUhYsLg4QEEWFiLnNoZWxsLmFydGlmYWN0JwCb1IWLC4KEBAhhYklnbm9yZQIEAJvUhYsLlYQEBHRydWUnAJvUhYsLgoQECWFiVmVyc2lvbgIEAJvUhYsLmoQEBDEwLjQnAJvUhYsLgoQEBWRlYnVnAgQAm9SFiwufhAQEdHJ1ZScAm9SFiwuChAQIcmVtZW1iZXICBACb1IWLC6SEBCjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCb1IWLC4KEBBNhYkNyZWF0ZUFydGlmYWN0Qm90AgQAm9SFiwvLhASILEBjb25zdCB7IAogICAgYWJBcnRpZmFjdE5hbWUsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKY29uc3QgQVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHID0gJ29uQUJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMnOwpjb25zdCBBUlRJRkFDVF9ERVBFTkRFTkNJRVNfVEFHID0gJ2FiQXJ0aWZhY3REZXBlbmRlbmNpZXMnOwogICAgCmNvbnN0IGFydGlmYWN0Qm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgIHJldHVybiBiLnRhZ3MuYWJBcnRpZmFjdE5hbWUgPT09IGFiQXJ0aWZhY3ROYW1lICYmCiAgICAgICAgICAgIWIudGFncy5hcnRpZmFjdCAvLyBJZ25vcmUgYW55IGFydGlmYWN0IGJvdHMgdGhlbXNlbHZlcy4KfSk7CgpsZXQgc2hhcmRzID0ge307CmxldCBkZXBlbmRlbmNpZXMgPSBbXTsKCmZvciAoY29uc3QgYXJ0aWZhY3RCb3Qgb2YgYXJ0aWZhY3RCb3RzKSB7CiAgICBjb25zdCBib3RTaG9ydElkID0gYXJ0aWZhY3RCb3QuaWQuc3Vic3RyaW5nKDAsIDUpOwogICAgY29uc3Qgc2hhcmQgPSBhd2FpdCB3aGlzcGVyKGFydGlmYWN0Qm90LCBBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUcsIHsgYWJBcnRpZmFjdE5hbWUgfSlbMF07CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBzaGFyZDpgLCBzaGFyZCk7CiAgICB9CgogICAgaWYgKHNoYXJkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzaGFyZCAhPT0gJ29iamVjdCcgfHwgQXJyYXkuaXNBcnJheShzaGFyZCkpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgbXVzdCByZXR1cm4gYW4gb2JqZWN0IGZyb20gQCR7QVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNoYXJkcyA9IHsgLi4uc2hhcmRzLCAuLi5zaGFyZCB9OwogICAgfQoKICAgIGNvbnN0IGRlcHMgPSBhcnRpZmFjdEJvdC50YWdzW0FSVElGQUNUX0RFUEVOREVOQ0lFU19UQUddOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgZGVwczpgLCBkZXBzKTsKICAgIH0KCiAgICBpZiAoZGVwcykgewogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShkZXBzKSkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyB0YWcgJHtBUlRJRkFDVF9ERVBFTkRFTkNJRVNfVEFHfSBtdXN0IGJlIGFuIGFycmF5LmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAoY29uc3QgZGVwIG9mIGRlcHMpIHsKICAgICAgICAgICAgLy8gVmFsaWRhdGUgZGVwZW5kZW5jeSBmb3JtYXQuCiAgICAgICAgICAgIGlmICghZGVwLnJlY29yZEtleSkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgdGFnICR7QVJUSUZBQ1RfREVQRU5ERU5DSUVTX1RBR30gZW50cmllcyBtdXN0IGNvbnRhaW4gJ3JlY29yZEtleScuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFkZXAuYWJJRCkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgdGFnICR7QVJUSUZBQ1RfREVQRU5ERU5DSUVTX1RBR30gZW50cmllcyBtdXN0IGNvbnRhaW4gJ2FiSUQnLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGRlcGVuZGVuY3kgaXNudCBhbHJlYWR5IGNvbGxlY3RlZC4KICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyeXB0by5zaGEyNTYoZGVwKTsKICAgICAgICAgICAgY29uc3QgY29udGFpbnMgPSBkZXBlbmRlbmNpZXMuc29tZShkID0+IGNyeXB0by5zaGEyNTYoZCkgPT09IGhhc2gpOyAvLyBUT0RPOiBDYW4gb3B0aW1pemUgd2l0aCBtYXAvZGljdCBpbnN0ZWFkIG9mIGFycmF5LgoKICAgICAgICAgICAgaWYgKCFjb250YWlucykgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBhZGRpbmcgZGVwOmAsIGRlcCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLnB1c2goZGVwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdE5hbWV9LCBzaGFyZHM6YCwgc2hhcmRzLCAnZGVwZW5kZW5jaWVzOicsIGRlcGVuZGVuY2llcyk7Cn0KCmNvbnN0IGhhdmVBcnRpZmFjdERhdGEgPSBPYmplY3Qua2V5cyhzaGFyZHMpLmxlbmd0aCA+IDA7CgppZiAoaGF2ZUFydGlmYWN0RGF0YSkgewogICAgY29uc3QgYXJ0aWZhY3RNb2QgPSB7fTsKCiAgICBhcnRpZmFjdE1vZC5zcGFjZSA9ICdzaGFyZWQnOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdCA9IHRydWU7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0TmFtZSA9IGFiQXJ0aWZhY3ROYW1lOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdERhdGEgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShzaGFyZHMpOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdERlcGVuZGVuY2llcyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGRlcGVuZGVuY2llcyk7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiA9IHRhZ3MuYWJBcnRpZmFjdEZvcm1hdFZlcnNpb247CgogICAgLy8gQ3JlYXRlIGFuZCBzdG9yZSBhIGhhc2ggb2YgYXJ0aWZhY3QncyBjb250ZW50LgogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdEhhc2ggPSBjcnlwdG8uc2hhMjU2KGFydGlmYWN0TW9kKTsKICAgIAogICAgLy8gRXh0cmEgdGFncyBmb3Igc3lzdGVtIHBvcnRhbCBhbmQgb3RoZXIgbWV0YWRhdGEuCiAgICBhcnRpZmFjdE1vZC5zeXN0ZW0gPSBgYWJBcnRpZmFjdC4ke2FiQXJ0aWZhY3ROYW1lfS0ke2FydGlmYWN0TW9kLmFiQXJ0aWZhY3RIYXNoLnN1YnN0cmluZygwLCA3KX1gOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdENhc3VhbE9TVmVyc2lvbiA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KG9zLnZlcnNpb24oKSk7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0Q3JlYXRlZFRpbWVzdGFtcCA9IERhdGVUaW1lLm5vdygpOwogICAgYXJ0aWZhY3RNb2QuYWJWZXJzaW9uID0gdGFncy5hYlZlcnNpb247CgogICAgLy8gU2V0dXAgYXJ0aWZhY3QncyBsb2FkaW5nIGxvZ2ljLgogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQgPSBmYWxzZTsKICAgIGFydGlmYWN0TW9kLmFiQXJ0aWZhY3REZWJ1ZyA9IHRhZ3MuZGVidWc7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0VG9vbCA9IGdldExpbmsodGhpc0JvdCk7CiAgICBhcnRpZmFjdE1vZC5vbkNyZWF0ZSA9IGBACiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7CiAgICAgICAgdGFncy5vbkNyZWF0ZSA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3REZWJ1ZykgewogICAgICAgICAgICBjb25zdCBsb2dNYXJrZXIgPSAnWycgKyB0YWdzLnN5c3RlbSArICddJzsKICAgICAgICAgICAgY29uc29sZS5sb2cobG9nTWFya2VyLCAnbWFya2VkIGFydGlmYWN0IGFzIGxvYWRlZCBvbiBjcmVhdGUgc28gdGhhdCBpdCBkb2VzbnQgbG9hZCByaWdodCBhd2F5Jyk7CiAgICAgICAgfQogICAgYDsKICAgIGFydGlmYWN0TW9kLm9uQm90QWRkZWQgPSBgQAogICAgICAgIGlmIChnbG9iYWxUaGlzLmFiKSB7CiAgICAgICAgICAgIHRoaXNCb3QuX3JlY29uc3RpdHV0ZSgpOwogICAgICAgIH0KICAgIGA7CiAgICBhcnRpZmFjdE1vZC5vbkFCSW5pdGlhbGl6ZWQgPSBgQAogICAgICAgIHRoaXNCb3QuX3JlY29uc3RpdHV0ZSgpOwogICAgYDsKICAgIGFydGlmYWN0TW9kLl9yZWNvbnN0aXR1dGUgPSBgQAogICAgICAgIGNvbnN0IGxvZ01hcmtlciA9ICdbJyArIHRhZ3Muc3lzdGVtICsgJ10nOwoKICAgICAgICBpZiAoIWxpbmtzLmFiQXJ0aWZhY3RUb29sKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3REZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2cobG9nTWFya2VyLCAnYXJ0aWZhY3QgdG9vbCBub3QgZm91bmQsIGFkYXB0aW5nIGFiIHdpdGggYWN0aW9uJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBhYi5hYkFkYXB0KCJhYlNoZWxsIik7CgogICAgICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobG9nTWFya2VyLCAnZmFpbGVkIHRvIGFkYXB0IGFiIHdpdGggYWJTaGVsbCcpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWxpbmtzLmFiQXJ0aWZhY3RUb29sKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGxvZ01hcmtlciwgJ2ZhaWxlZCB0byBmaW5kIGFiQXJ0aWZhY3RUb29sJyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZSh7IGFiQXJ0aWZhY3RCb3Q6IHRoaXNCb3QgfSkKICAgIGA7CgogICAgY29uc3QgYXJ0aWZhY3RCb3QgPSBjcmVhdGUoYXJ0aWZhY3RNb2QpOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDpgLCBhcnRpZmFjdEJvdCk7CiAgICB9CgogICAgcmV0dXJuIGFydGlmYWN0Qm90Owp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGRpZCBub3QgcmV0dXJuIGFueSBkYXRhIHZpYSBAJHtBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUd9LmAsIGxvZ1R5cGU6ICd3YXJuaW5nJyB9KTsKfScAm9SFiwuChAQgYWJBcHBseUFydGlmYWN0TWFuaWZlc3RhdGlvblRhZ3MCBACb1IWLC86wBIULQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0Qm90LAogICAgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCA/PyAnaG9tZScsCiAgICBwb3NpdGlvbiA9IG5ldyBWZWN0b3IzKDAsIDAsIDApLAogICAgY3VzdG9tVGFncyA9IHt9Cn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3RCb3QgJiYgYWJBcnRpZmFjdEJvdC5zcGFjZSAmJiBhYkFydGlmYWN0Qm90LnRhZ3MsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJvdCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQm90LmApOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7CgphYkFydGlmYWN0Qm90LnRhZ3NbZGltZW5zaW9uXSA9IHRydWU7CmFiQXJ0aWZhY3RCb3QudGFnc1tgJHtkaW1lbnNpb259WGBdID0gcG9zaXRpb24ueDsKYWJBcnRpZmFjdEJvdC50YWdzW2Ake2RpbWVuc2lvbn1ZYF0gPSBwb3NpdGlvbi55OwphYkFydGlmYWN0Qm90LnRhZ3NbYCR7ZGltZW5zaW9ufVpgXSA9IHBvc2l0aW9uLno7CmFiQXJ0aWZhY3RCb3QudGFncy5jb2xvciA9IGFiQXJ0aWZhY3RCYXNlQ29sb3I7CmFiQXJ0aWZhY3RCb3QudGFncy5jdXJzb3IgPSAncG9pbnRlcic7CmFiQXJ0aWZhY3RCb3QudGFncy5sYWJlbENvbG9yID0gYWJBcnRpZmFjdExhYmVsQ29sb3I7CmFiQXJ0aWZhY3RCb3QudGFncy5zdHJva2VDb2xvciA9IGFiQXJ0aWZhY3RMYWJlbENvbG9yOwphYkFydGlmYWN0Qm90LnRhZ3MubGFiZWwgPSBgYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lfWA7CmFiQXJ0aWZhY3RCb3QudGFncy5vbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUgPSBgQAogICAgY29uc3QgeyBhYkFydGlmYWN0TmFtZSB9ID0gdGhhdDsKICAgIAogICAgaWYgKGFiQXJ0aWZhY3ROYW1lICE9PSB0YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2Zvcm0nLCAnbm90aGluZycsICdzaGFyZWQnKTsKICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2xhYmVsJywgJyAnLCAnc2hhcmVkJyk7CmAKCmZvciAoY29uc3QgdGFnTmFtZSBpbiBjdXN0b21UYWdzKSB7CiAgICBhYkFydGlmYWN0Qm90cy50YWdzW3RhZ05hbWVdID0gY3VzdG9tVGFnc1t0YWdOYW1lXTsKfQoKcmV0dXJuIGFiQXJ0aWZhY3RCb3Q7JwCb1IWLC4KEBBZhYkFydGlmYWN0UmVjb25zdGl0dXRlAgQAm9SFiwvUuwSKBUBjb25zdCB7IAogICAgYWJBcnRpZmFjdEJvdAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0Qm90ICYmIGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uID0gYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uOwoKaWYgKGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uID09IG51bGwpIHsKICAgIHRocm93IG5ldyBFcnJvcihgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gJHthYkFydGlmYWN0Rm9ybWF0VmVyc2lvbn0gaXMgbm90IHZhbGlkLmApOwp9Cgpjb25zdCBmdW5jVGFnTmFtZSA9IGBhYkFydGlmYWN0UmVjb25zdGl0dXRlX3Yke2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9ufWA7CgppZiAodHlwZW9mIHRoaXNCb3RbZnVuY1RhZ05hbWVdICE9PSAnZnVuY3Rpb24nKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZnVuY1RhZ05hbWV9IGlzIG5vdCBhIGZ1bmN0aW9uLmApCn0KCi8vIENhbGwgdGhlIHZlcnNpb25lZCByZWNvbnNpdHV0ZSBmdW5jdGlvbi4KdGhpc0JvdFtmdW5jVGFnTmFtZV0odGhhdCk7JwCb1IWLC4KEBBdhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbgIEAJvUhYsL38AEATInAJvUhYsLgoQEBnNlYXJjaAIEAJvUhYsL4cAEKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAJvUhYsLgoQEB2FiU2hlbGwCBACb1IWLC4jBBAR0cnVlJwCb1IWLC4KEBAV1dGlscwIEAJvUhYsLjcEEKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAJvUhYsLgoQEGWFiQXJ0aWZhY3RSZWNvbnN0aXR1dGVfdjECBACb1IWLC7TBBK8MQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0Qm90LAogICAgdG9hc3QgPSB0cnVlLAp9ID0gdGhhdCA/PyB7fTsKCmNvbnN0IGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uID0gYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uOwoKaWYgKGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0UmVjb25zdGl0dXRlZCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7YWJBcnRpZmFjdEJvdC50YWdzLnN5c3RlbX0gaXMgYWxyZWFkeSByZWNvbnNpdGl0dXRlZC5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKY29uc3QgZGVwZW5kZW5jaWVzID0gYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3REZXBlbmRlbmNpZXM7Cgpmb3IgKGNvbnN0IGRlcCBvZiBkZXBlbmRlbmNpZXMpIHsKICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICAgICAgYWJJRDogZGVwLmFiSUQsCiAgICAgICAgcmVjb3JkS2V5OiBkZXAucmVjb3JkS2V5LAogICAgICAgIGFiVmVyc2lvbjogZGVwLmFiVmVyc2lvbiwKICAgICAgICBhdXRvSGF0Y2g6IHRydWUsCiAgICB9KQoKICAgIGlmIChyZXN1bHQuc3VjY2VzcykgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBgJHthYkFydGlmYWN0Qm90LnRhZ3Muc3lzdGVtfSBsb2FkZWQgZGVwZW5kZW5jeSBhYklEOiAke2RlcC5hYklEfSwgYWJWZXJzaW9uOiAke2RlcC5hYlZlcnNpb24gPz8gJ2xhdGVzdCd9YDsKICAgICAgICAgICAgYWIubG9nKGxvZ01lc3NhZ2UpOwogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7bG9nTWVzc2FnZX1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGAke2FiQXJ0aWZhY3RCb3QudGFncy5zeXN0ZW19IGZhaWxlZCB0byBsb2FkIGRlcGVuZGVuY3kgYWJJRDogJHtkZXAuYWJJRH0sIGFiVmVyc2lvbjogJHtkZXAuYWJWZXJzaW9uID8/ICdsYXRlc3QnfWA7CiAgICAgICAgYWIubG9nKGVycm9yTWVzc2FnZSk7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7ZXJyb3JNZXNzYWdlfWApOwogICAgfQp9CgpzaG91dChgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlYCwgewogICAgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3REYXRhOiBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdERhdGEsCiAgICBhYkFydGlmYWN0Qm90OiBhYkFydGlmYWN0Qm90Cn0pCgphYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQgPSB0cnVlOwoKY29uc3QgbG9nTWVzc2FnZSA9IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdE5hbWV9JyBoYXMgYmVlbiByZWNvbnN0aXR1dGVkLmA7CmFiLmxvZyhsb2dNZXNzYWdlKTsKaWYgKHRvYXN0KSB7CiAgICBvcy50b2FzdChsb2dNZXNzYWdlKTsKfQonAJvUhYsLgoQEGWFiQXJ0aWZhY3RSZWNvbnN0aXR1dGVfdjICBACb1IWLC+TNBAhALy8gVE9ETycAm9SFiwuChAQPb25BbnlCb3RDbGlja2VkAgQAm9SFiwvtzQRyQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0KSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGJvdCB9KQp9JwCb1IWLC4KEBARtZW51AgQAm9SFiwvgzgQo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAm9SFiwuChAQFbGVhcm4CBACb1IWLC4fPBCjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCb1IWLC4KEBBNhYkFydGlmYWN0TWVudVJlc2V0AgQAm9SFiwuuzwSwAUBpZiAobGlua3MuYXJ0aWZhY3RNZW51Qm90cykgewogICAgZGVzdHJveShsaW5rcy5hcnRpZmFjdE1lbnVCb3RzKTsKICAgIGxpbmtzLmFydGlmYWN0TWVudUJvdHMgPSBudWxsOwp9Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7Cm1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCA9IG51bGw7JwCb1IWLC4KEBBJhYkFydGlmYWN0TWVudU9wZW4CBACb1IWLC9/QBIINQGNvbnN0IHsgYWJBcnRpZmFjdEJvdCB9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0Qm90ICYmIGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCnNob3V0KCJhYkFydGlmYWN0TWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkFydGlmYWN0TWVudSI7Cgpjb25zdCBhcnRpZmFjdE1lbnVCb3RzID0gW107Cgpjb25zdCBhYkFydGlmYWN0QmFzZUNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0QmFzZUNvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQ7CmNvbnN0IGFiQXJ0aWZhY3RMYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0TGFiZWxDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdDsKCmxldCBpbmZvTGFiZWwgPSBgYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lfVxuYDsKaW5mb0xhYmVsICs9IGBoYXNoOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0SGFzaC5zdWJzdHJpbmcoMCwgNyl9XG5gOwppbmZvTGFiZWwgKz0gYHJlY29uc3RpdHV0ZWQgaW4gaW5zdDogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWR9XG5gOwppbmZvTGFiZWwgKz0gYGZvcm1hdDogdiR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9ufVxuYDsKaW5mb0xhYmVsICs9IGBjcmVhdGVkIHRpbWU6ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RDcmVhdGVkVGltZXN0YW1wLnRvTG9jYWxlU3RyaW5nKERhdGVUaW1lLkRBVEVUSU1FX1NIT1JUX1dJVEhfU0VDT05EUyl9XG5gOwoKLy8gSGVhZGVyCmNvbnN0IGluZm9Cb3QgPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudVRleHQoewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBsYWJlbDogaW5mb0xhYmVsLAp9KQphcnRpZmFjdE1lbnVCb3RzLnB1c2goaW5mb0JvdCk7CgovLyBEb3dubG9hZCBhcnRpZmFjdCBidXR0b24uCmNvbnN0IGRvd25sb2FkQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdkb3dubG9hZCcsCiAgICBsYWJlbDogYGRvd25sb2FkIGFydGlmYWN0YCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBvcy5kb3dubG9hZEJvdHMoWyBsaW5rcy5hYkFydGlmYWN0Qm90IF0sIFxgYWJBcnRpZmFjdC1cJHtsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdE5hbWV9LVwke2xpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0SGFzaC5zdWJzdHJpbmcoMCwgNyl9LmF1eFxgKQogICAgYCwKfSkKYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGRvd25sb2FkQnV0dG9uKTsKCm1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCA9IGFiQXJ0aWZhY3RCb3QuaWQ7Cm1hc2tzLmFydGlmYWN0TWVudUJvdHMgPSBnZXRMaW5rKGFydGlmYWN0TWVudUJvdHMpOycAm9SFiwuChAQLb25HcmlkQ2xpY2sCBACb1IWLC+LdBH1AY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBncmlkIGNsaWNrZWRgKTsKCmlmIChsaW5rcy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RNZW51UmVzZXQoKTsKfScAm9SFiwuChAQaYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQCBACb1IWLC+DeBAcjQUVBMUZGJwCb1IWLC4KEBBthYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQCBACb1IWLC+jeBAcjMWUxYjJkJwCb1IWLC4KEBBBvbkFueUJvdHNSZW1vdmVkAgQAm9SFiwvw3gSSAUBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsKCmlmIChtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgJiYgYm90SURzLmluY2x1ZGVzKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCkpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdE1lbnVSZXNldCgpOwp9JwEEYm90cyQ5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMBJwCb1IWLC4PgBAZzeXN0ZW0CBACb1IWLC4TgBA5hYi5zaGVsbC51dGlscycAm9SFiwuD4AQMYWJDb21waWxlQ1NTAgQAm9SFiwuT4ASCBEBsZXQgYm90cyA9IHRoYXQ7Cgpib3RzID0gQXJyYXkuaXNBcnJheShib3RzKSA/IGJvdHMgOiBbYm90c107CgpsZXQgY3NzID0gW107Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgZm9yIChsZXQga2V5IGluIGJvdC50YWdzKSB7CiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCdjc3MnKSkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBDU1Mga2V5OiAke2tleX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3MucHVzaChib3QudGFnc1trZXldKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IGNvbXBpbGVkID0gY3NzLmpvaW4oJ1xuXG4nKTsKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY29tcGlsZWQgQ1NTOlxuXG5gLCBjb21waWxlZCk7Cn0KCnJldHVybiBjb21waWxlZDsnAJvUhYsLg+AECGFiSWdub3JlAgQAm9SFiwuW5AQEdHJ1ZScAm9SFiwuD4AQHYWJTaGVsbAIEAJvUhYsLm+QEBHRydWUnAJvUhYsLg+AECWFiVmVyc2lvbgIEAJvUhYsLoOQEBDEwLjQnAJvUhYsLg+AEDWFiTG9nQW5kVG9hc3QCBACb1IWLC6XkBMcIQGxldCBtZXNzYWdlOwpsZXQgZHVyYXRpb24gPSA1OwpsZXQgbG9nVHlwZSA9ICdsb2cnOwoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgbWVzc2FnZSA9IHRoYXQ7Cn0gZWxzZSB7CiAgICBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uID8/IGR1cmF0aW9uOwogICAgbG9nVHlwZSA9IHRoYXQubG9nVHlwZSA/PyBsb2dUeXBlOwp9CgppZiAobG9nVHlwZSA9PT0gJ2xvZycpIHsKICAgIGFiLmxvZyhsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5sb2cobGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnd2FybmluZycgfHwgbG9nVHlwZSA9PT0gJ3dhcm4nKSB7CiAgICBhYi5sb2cobGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6IFdhcm5pbmc6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUud2FybihsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgb3MudG9hc3QoYFdhcm5pbmc6ICR7bWVzc2FnZX1gLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ2Vycm9yJykgewogICAgYWIubG9nKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiBFcnJvcjogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5lcnJvcihsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgb3MudG9hc3QoYEVycm9yOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgewogICAgYWIubG9nKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmxvZyhsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9JwCb1IWLC4PgBAhyZW1lbWJlcgIEAJvUhYsL7ewEKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAQRib3RzJGQ4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNQEnAJvUhYsLlO0EBnN5c3RlbQIEAJvUhYsLle0ED2FiLnNoZWxsLnNlYXJjaCcAm9SFiwuU7QQEZm9ybQIEAJvUhYsLpe0EB25vdGhpbmcnAJvUhYsLlO0EDmFiUmV0cmlldmVGaWxlAgQAm9SFiwut7QSCAUAvL3B1bGwgZG93biBmaWxlIGRhdGEKaWYgKCF0aGF0LnVybCkKewogICAgcmV0dXJuICJubyBmaWxlIHVybCBzdXBwbGllZCI7Cn0KCmxldCBkYXRhID0gYXdhaXQgb3MuZ2V0RmlsZSh0aGF0LnVybCk7CgpyZXR1cm4gZGF0YTsnAJvUhYsLlO0EEGFiUmV0cmlldmVSZWNvcmQCBACb1IWLC7DuBOwEQC8vcmV0cmlldmUgc3BlY2lmaWVkIHJlY29yZApsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKCmxldCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKaWYgKHRoYXQucmVjb3JkS2V5KQp7CiAgICByZWNvcmRLZXkgPSB0aGF0LnJlY29yZEtleTsKfQplbHNlIGlmIChhdXRoQm90KQp7CiAgICBpZiAoYXV0aEJvdC5pZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCiAgICB7CiAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKCiAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICB9Cn0KCmxldCByZWNvcmRFbmRwb2ludCA9IHRoYXQucmVjb3JkRW5kcG9pbnQgPyB0aGF0LnJlY29yZEVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwoKaWYgKCFyZWNvcmROYW1lKQp7CiAgICByZXR1cm4gIm5vIHJlY29yZCBuYW1lIHN1cHBsaWVkIjsKfQoKbGV0IGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCByZWNvcmROYW1lLCByZWNvcmRFbmRwb2ludCk7CgovL0FERCBhZGRpdGlvbmFsIGVycm9yIGhhbmRsaW5nPwoKcmV0dXJuIGdldFJlY29yZDsnAJvUhYsLlO0ECHJlbWVtYmVyAgQAm9SFiwud8wQo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAm9SFiwuU7QQNbWFuaWZlc3RhdGlvbgIEAJvUhYsLxPMEKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJvUhYsLlO0EDm9uTG9va3VwQUJFZ2dzAgQAm9SFiwvr8wS+LEBjb25zdCB7IAogICAgYWJJRCwKICAgIGFiVmVyc2lvbiwKICAgIGluaXRpYWxCb290LAogICAgYXV0b0hhdGNoLAogICAgcmV0dXJuVHlwZSwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBrZXkgPSBjb25maWdCb3QudGFncy5rZXksCiAgICB0b2FzdCA9IHRydWUsCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgphYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogbG9hZGluZyAiICsgYWJJRCk7CgovL2NsZWFyIGFiLTEKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24gJiYgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9PSAiYWJNZW51IikgewogICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYGxvYWRpbmcgJHthYklEfWApOwoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKbGV0IG5ld0VnZzsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYKICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5ICYmCiAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gInJlY29yZF9ub3RfZm91bmQiCiAgICApIHsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiKSB7CiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9sb2dnZWRfaW4iKSB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCiAgICAgICAgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiAKICAgICAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIgogICAgICAgICkgewogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHRvYXN0KSB7IAogICAgICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKICAgIH0KCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQoKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KZWxzZSB7CiAgICBjb25zdCBwdWJsaWNSZWFkVGVzdCA9IGdldFJlY29yZC5tYXJrZXJzLmluZGV4T2YoInB1YmxpY1JlYWQiKTsKICAgIGNvbnN0IGF1dGhvciA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgogICAgaWYgKHB1YmxpY1JlYWRUZXN0ICE9IC0xICYmIGF1dGhvcikgewogICAgICAgIGlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgewogICAgICAgICAgICBjb25zdCBlZ2dIYXRjaEV2ZW50ID0gYWJJRDsKCiAgICAgICAgICAgIG9zLnJlY29yZEV2ZW50KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGVnZ0hhdGNoRXZlbnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvL3BhY2thZ2UgdGhlIHJlY29yZCBkYXRhCiAgICBuZXdFZ2cgPSBnZXRSZWNvcmQuZGF0YTsKfQoKYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBhYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCmlmIChyZXR1cm5UeXBlICE9IG51bGwpIHsKICAgIGlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICAgICAgICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYWJWZXJzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSBhYlZlcnNpb24gLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlZ2dEYXRhVVJMID0gZ2V0UmVjb3JkLmRhdGEuZWdnVmVyc2lvbkhpc3RvcnlbdmVyc2lvbl07CiAgICAgICAgICAgIGNvbnN0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgICAgICAgICAgaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldHVybkRhdGE7CiAgICAgICAgfSBlbHNlIGlmIChyZXR1cm5UeXBlID09PSAiZWdnIikgewogICAgICAgICAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKG5ld0VnZy5lZ2dWZXJzaW9uSGlzdG9yeSk7CiAgICAgICAgICAgIGNvbnN0IGZpbGVVVUlEID0gdmVyc2lvbkFycmF5W25ld0VnZy5tYXhWZXJzaW9uIC0gMV07CiAgICAgICAgICAgIGNvbnN0IGZpbGVuYW1laGFzaExUTSA9IGNyeXB0by5zaGEyNTYoZmlsZVVVSUQpOwogICAgICAgICAgICBjb25zdCBmaWxldXJsaGFzaExUTSA9ICJhdXhfIiArIGZpbGVuYW1laGFzaExUTSArICcuYXV4JzsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TFRNVVJMID0gImh0dHBzOi8vYnVpbGRlci1sdG0tZmlsZXMuczMuYW1hem9uYXdzLmNvbS8iICsgZmlsZXVybGhhc2hMVE07CiAgICAgICAgICAgIGNvbnN0IG8gPSB7CiAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgICAgICAgdXJsOiB0YXJnZXRMVE1VUkwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGxldCBmaWxlR2V0ID0gYXdhaXQgd2ViaG9vayhvKTsKCiAgICAgICAgICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgICAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmF3YWl0IHRoaXNCb3QubWFuaWZlc3RPdm8oewogICAgYWJJRCwKICAgIHN0dWRpbzogcmVjb3JkS2V5LAogICAgZGltTW9kLAogICAgc3BhY2VNb2QsCiAgICBlZ2dEYXRhOiBuZXdFZ2csCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMgCn0pOwoKaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9OycAm9SFiwuU7QQLbWFuaWZlc3RPdm8CBACb1IWLC6qgBeQNQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAp9ID0gdGhhdDsKCi8vZWdnIHZpc3VhbGl6YXRpb24Kc2hvdXQoImFiTWVudVJlc2V0Iik7CgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgppZiAobGlua3Mub3ZvQm90KSB7CiAgICBkZXN0cm95KGxpbmtzLm92b0JvdCk7Cn0KCmxldCBlZ2dNb2QgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBpbml0aWFsVGltZXI6IHRydWUsCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb25DbGljazogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLmludGVyYWN0T3ZvKCk7CiAgICBgLAogICAgZm9ybTogImVnZyIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgIHByb2dyZXNzQmFyQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3IsCiAgICBwcm9ncmVzc0JhckJhY2tncm91bmRDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC41LAogICAgb25Qb2ludGVyRW50ZXI6IGBACiAgICAgICAgbWFza3MudGlwSWQgPSBhd2FpdCBvcy50aXAodGFncy5hYklEICsgJyB2JyArIHRhZ3MudGFyZ2V0VmVyc2lvbik7CiAgICBgLAogICAgb25Qb2ludGVyRXhpdDogYEAKICAgICAgICBpZiAobWFza3MudGlwSWQpIHsKICAgICAgICAgICAgb3MuaGlkZVRpcHMobWFza3MudGlwSWQpOwogICAgICAgIH0KICAgIGAsCiAgICBsYWJlbFBvc2l0aW9uOiAiZnJvbnQiLAogICAgb3JpZW50YXRpb25Nb2RlOiAiYmlsbGJvYXJkRnJvbnQiLAogICAgb25EZXN0cm95OiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3Mub3ZvQm90ID0gbnVsbDsKICAgIGAsCiAgICBlZ2dUaW1lcjogYEAKICAgICAgICBpZiAodGFncy5wcm9ncmVzc0JhciA8IDEpIHsKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciArPSAwLjE7CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90Lm9uQ2xpY2soKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgPSBudWxsOwogICAgICAgIH0KICAgIGAKfTsKCgpsZXQgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7CgppZiAob3ZvLnRhZ3MuYXV0b0hhdGNoKSB7CiAgICBhd2FpdCB0aGlzQm90LmhhdGNoT3ZvKG92byk7Cn0KZWxzZSB7CiAgICBvdm8udGFncy5wcm9ncmVzc0JhciA9IDA7CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG92by50YWdzLm1heFZlcnNpb247CgogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9CgptYXNrcy5vdm9Cb3QgPSBnZXRMaW5rKG92byk7CgpyZXR1cm47JwCb1IWLC5TtBAlvbktleURvd24CBACb1IWLC4+uBYIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAJvUhYsLlO0ECGhhdGNoT3ZvAgQAm9SFiwuQtAWpFEAvL2xvZ2ljIGZvciBoYXRjaGluZyBvZiBhbiBhYgpzaG91dCgnb3ZvTWVudVJlc2V0Jyk7CgovL2RhdGEgaW4gcmVnYXJkcyB0byB3aGF0IGFiIGlzIGdvaW5nIHRvIGJlIGhhdGNoZWQKY29uc3Qgb3ZvID0gdGhhdDsKCi8vaGF0Y2ggc3BlY2lmaWMgdmFyaWFibGVzCmxldCBpbml0aWFsQm9vdCA9IG92by50YWdzLmluaXRpYWxCb290OwpsZXQgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLnN0YWJsZVZlcnNpb24gPz8gb3ZvLnRhZ3MudGFyZ2V0VmVyc2lvbjsKCmlmICgoY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uIHx8IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uKSAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIpKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uOwp9CgovL3RhcmdldGVkIHZlcnNpb25zCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYiB8fCAhaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpKQp7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiZmVlZGJhY2siKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5mZWVkYmFja1ZlcnNpb247CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJjdXJyZW50IikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgfQogICAgZWxzZSBpZiAoIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy52ZXJzaW9uCiAgICB9CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG51bGw7Cn0KCmlmIChpc05hTih0YXJnZXRWZXJzaW9uKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKfQoKbGV0IHZlcnNpb25BcnJheSA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5OwpsZXQgZmlsZVVSTCA9IHZlcnNpb25BcnJheVt0YXJnZXRWZXJzaW9uIC0gMV07CmxldCBrZXkgPSBvdm8udGFncy5rZXkgPyBvdm8udGFncy5rZXkgOiBjb25maWdCb3QudGFncy5rZXk7CmxldCBmaWxlR2V0OwoKLy9hY3R1YWwgZmlsZSByZXRyaWV2YWwKdHJ5CnsKICAgIGZpbGVHZXQgPSBhd2FpdCBvcy5nZXRGaWxlKGZpbGVVUkwpOwp9CmNhdGNoIChlcnJvcikKewogICAgY29uc29sZS5sb2coZXJyb3IpOwoKICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CgogICAgcmV0dXJuOwp9CgovL2hhbmRsaW5nIGZvciBlbmNyeXB0ZWQgYWIgZmlsZQppZiAoY3J5cHRvLmlzRW5jcnlwdGVkKGZpbGVHZXQpKQp7CiAgICBpZiAoIWtleSkKICAgIHsKICAgICAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoJycsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnRW50ZXIga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIHRyeQogICAgewogICAgICAgIGZpbGVHZXQgPSBjcnlwdG8uZGVjcnlwdChrZXksIGZpbGVHZXQpOwogICAgfQogICAgY2F0Y2ggKGVycm9yKQogICAgewogICAgICAgIGNvbnNvbGUubG9nKGVycm9yKQoKICAgICAgICBvcy50b2FzdCgia2V5IGRvZXMgbm90IG1hdGNoIGZpbGUiKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQogICAKICAgIGZpbGVHZXQgPSBKU09OLnBhcnNlKGZpbGVHZXQpOwoKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CmVsc2UKewogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KCi8vY2xlYW4gdXAKZGVzdHJveShvdm8pOwoKLy90b2FzdCBpZiBub3Qgb24gc3RhYmxlCmlmKG92by50YWdzLnN0YWJsZVZlcnNpb24gIT0gdGFyZ2V0VmVyc2lvbiAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnQpCnsKICAgIGlmIChvdm8udGFncy5mZWVkYmFja1ZlcnNpb24gPT0gdGFyZ2V0VmVyc2lvbikKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZGluZyBmZWVkYmFjayB2ZXJzaW9uIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZGluZyB2ZXJzaW9uICIgKyB0YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoICsgIiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9Cn0KCi8vZ2VuZXJhdGUgYm90cyBiYXNlZCBvbiB0aGUgZmlsZSByZXRyaWV2ZWQgKkhFUkUqCmF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoe2JvdHM6IGZpbGVHZXQsIG9yaWdpbjogb3ZvLnRhZ3MuYWJJRCwgc3R1ZGlvOiBvdm8udGFncy5zdHVkaW8sIHZlcnNpb246IHRhcmdldFZlcnNpb24sIGluaXRpYWxCb290OiBpbml0aWFsQm9vdCwgZWdnUGFyYW1ldGVyczogb3ZvLnRhZ3MuZWdnUGFyYW1ldGVyc30pOwoKcmV0dXJuOycAm9SFiwuU7QQLaW50ZXJhY3RPdm8CBACb1IWLC7rIBeoGQC8vbWFudWFsIGhhdGNoIG1lbnUKY29uc3Qgb3ZvQm90ID0gdGhhdCA/IHRoYXQgOiBsaW5rcy5vdm9Cb3Q7CgppZiAoIW92b0JvdCkgewogICAgcmV0dXJuOwp9CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk92b01lbnUiOwoKbWFza3Mub25HcmlkQ2xpY2sgPSBgQAogICAgc2hvdXQoIm92b01lbnVSZXNldCIpOwpgOwptYXNrcy5vdm9NZW51UmVzZXQgPSBgQAogICAgbWFza3Mub25HcmlkQ2xpY2sgPSBudWxsOwogICAgbWFza3Mub3ZvTWVudVJlc2V0ID0gbnVsbDsKCiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7Cgpvcy50d2VlblRvKG92b0JvdCwgMTUsNDUsNDUsIDUpOwoKY29uc3QgZWdnTWVudUJ1dHRvbiA9IHsKICAgIGFiT3ZvTWVudTogdHJ1ZSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvdm9Cb3Q6IGdldExpbmsob3ZvQm90KSwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUNvbG9yLAogICAgdGFyZ2V0VmVyc2lvbjogb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwKICAgIGxhYmVsOiBgaGF0Y2ggJHtvdm9Cb3QudGFncy5hYklEfSB2JHtvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9ufSBvZiAke292b0JvdC50YWdzLm1heFZlcnNpb259YCwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIG92b01lbnVSZXNldDogYEAKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgYCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOwogICAgYCwKfTsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGVnZ01lbnVCdXR0b24pOycAm9SFiwuU7QQGY3JlYXRlAgQAm9SFiwulzwUo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAm9SFiwuU7QQQY2hhbmdlT3ZvVmVyc2lvbgIEAJvUhYsLzM8F8AJALy9sb2dpYyBmb3IgdmVyc2lvbiBjaGFuZ2luZyB3aGVuIG1hbnVhbGx5IGhhdGNoaW5nIGFuIGFiCmNvbnN0IG92b0JvdCA9IGxpbmtzLm92b0JvdDsKCmxldCBuZXdWZXJzaW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sIHsKICAgIHBsYWNlaG9sZGVyOiAiZW50ZXIgYSB2ZXJzaW9uIGZyb20gMSB0byAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbgp9KTsKCm92b0JvdC50YWdzLnRhcmdldFZlcnNpb24gPSBuZXdWZXJzaW9uOwpvdm9Cb3QudGFncy5sYWJlbCA9ICd2JysgbmV3VmVyc2lvbjsKCmNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBuZXdWZXJzaW9uOwoKc2hvdXQoIm92b01lbnVSZXNldCIpOycAm9SFiwuU7QQEbWVudQIEAJvUhYsLvdIFKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAJvUhYsLlO0ECGFiSWdub3JlAgQAm9SFiwvk0gUEdHJ1ZScAm9SFiwuU7QQHYWJTaGVsbAIEAJvUhYsL6dIFBHRydWUnAJvUhYsLlO0EDGFiMUxUTVNlYXJjaAIEAJvUhYsL7tIFM0AvL3N1cHBvcnQgb2xkIHN5bnRheAp0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOycAm9SFiwuU7QQNb25Mb29rdXBBc2tJRAIEAJvUhYsLotMF/wdAbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgbG9va2luZyB1cCAke3RoYXQuYXNrSUR9YCk7Cgpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQ7CmNvbnN0IGVuZHBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgbG9va3VwQXNrOyAKCnRyeQp7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFza0lELCBlbmRwb2ludCk7Cn0KY2F0Y2gKewogICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCB0aGF0LmFza0lELCBlbmRwb2ludCk7Cn0KCmlmICh0aGF0LmNoYW5uZWxDb25maWcpCnsKICAgIGlmIChwcm9ncmVzc0J1dHRvbikKICAgIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KICAgIAogICAgcmV0dXJuIGxvb2t1cEFzazsKfQplbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiBsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQpCnsKICAgIGlmIChsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA9PSAiQUIiKQogICAgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQobG9va3VwQXNrLmRhdGEucGF0dGVybklEKTsKCiAgICAgICAgc2hvdXQoIm9uQUJJbml0aWFsaXplZCIpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXNCb3Qub25Mb29rdXBBQkVnZ3Moe2FiSUQ6IGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBsb29rdXBBc2suZGF0YS5zdHVkaW9JRCwgYXV0b0hhdGNoOiB0cnVlfSk7ICAKICAgIH0KfQplbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiAhbG9va3VwQXNrLmRhdGEudXJsKQp7CiAgICBsb29rdXBBc2suc3VjY2VzcyA9ICFsb29rdXBBc2suc3VjY2VzczsKfQoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIGxvb2t1cEFzazsnAJvUhYsLlO0EBWlucHV0AgQAm9SFiwui2wUo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAm9SFiwuU7QQFaGF0Y2gCBACb1IWLC8nbBcABQC8vc2hvdXQoImhhdGNoIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBrZXk6IGtleSwgYXV0b0hhdGNoOiBib29sZWFuLCByZXR1cm5UeXBlOiBkYXRhL251bGwsIGVnZ1BhcmFtZXRlcnM6IGFyZ30pOwoKY29uc3QgbG9va1VwID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsKCnJldHVybiBsb29rVXA7JwCb1IWLC5TtBAlhYlZlcnNpb24CBACb1IWLC4rdBQQxMC40JwCb1IWLC5TtBAVsZWFybgIEAJvUhYsLj90FKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJvUhYsLlO0ECmFiTG9hZFRvb2wCBACb1IWLC7bdBbAHQGxldCB7CiAgICB0b29sTmFtZSwKICAgIHRvb2xQYXJhbWV0ZXJzLAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHRvb2xOYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRvb2xOYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0b29sUGFyYW1ldGVyczpgLCB0b29sUGFyYW1ldGVycyk7Cgpjb25zdCB1cmwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FidG9vbHMvJHt0b29sTmFtZX0uYXV4YCk7CgpsZXQgYXV4OwoKdHJ5IHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soewogICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgdXJsLAogICAgfSkKCiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICBhdXggPSByZXNwb25zZS5kYXRhOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBsZXQgbWVzc2FnZSA9IGBGYWlsZWQgdG8gZG93bmxvYWQgdG9vbCAnJHt0b29sTmFtZX0nLmA7CiAgICBpZiAoZS5tZXNzYWdlKSB7CiAgICAgICAgbWVzc2FnZSArPSBgIEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgfQoKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QobWVzc2FnZSk7Cn0KaWYgKGF1eCkgewogICAgaWYgKGF1eC52ZXJzaW9uID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3RzOiBhdXguc3RhdGUsIGVnZ1BhcmFtZXRlcnM6IHRvb2xQYXJhbWV0ZXJzLCBpZ25vcmVHcmlkRm9jdXM6IHRydWUgfSkKICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYWIgdG9vbHMgbXVzdCBiZSBpbiBhdXggZm9ybWF0IHYxLiAnJHt0b29sTmFtZX0nIGlzIGF1eCBmb3JtYXQgdiR7YXV4LnZlcnNpb259YCk7CiAgICB9Cn0nAJvUhYsLlO0EBXV0aWxzAgQAm9SFiwvn5AUo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycBBGJvdHMkZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwAScAm9SFiwuO5QUGc3lzdGVtAgQAm9SFiwuP5QUOYWIuc2hlbGwuaW5wdXQnAJvUhYsLjuUFBGZvcm0CBACb1IWLC57lBQdub3RoaW5nJwCb1IWLC47lBQlvbktleURvd24CBACb1IWLC6blBfoKQGNvbnN0IHsga2V5cyB9ID0gdGhhdDsKCmlmIChtYXNrcy5jaGF0T3BlbikgewogICAgY29uc3QgZXNjID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdFc2NhcGUnKTsKCiAgICBpZiAoZXNjKSB7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhcnJvd1VwID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd1VwJyk7CiAgICAgICAgY29uc3QgYXJyb3dEb3duID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd0Rvd24nKTsKICAgICAgICAKICAgICAgICBpZiAoYXJyb3dVcCB8fCBhcnJvd0Rvd24pIHsKICAgICAgICAgICAgLy8gSWYgQXJyb3dVcCBvciBBcnJvd0Rvd24gYXJlIHByZXNzZWQgd2hpbGUgdGhlIGFiIGNoYXQgYmFyIGlzIG9wZW4gdGhlbgogICAgICAgICAgICAvLyBzdGFydCBjb21iaW5nIHRocm91Z2ggY2hhdCBoaXN0b3J5LgogICAgICAgICAgICBjb25zdCBkaXIgPSBhcnJvd1VwID8gLTEgOiAxOwogICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggKyBkaXI7CiAgICAgICAgICAgIGxldCBoaXN0b3JpY2FsVGV4dCA9IG51bGw7CgogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiBpbmRleCA8IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGhpc3RvcmljYWxUZXh0ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5W2luZGV4XTsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSAtMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA+PSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBjaGF0IGJhci4KICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oeyBwcmVmaWxsOiBoaXN0b3JpY2FsVGV4dCB9KTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBjb25zdCBiYWNrdGljayA9IHRoYXQua2V5cy5pbmNsdWRlcygnYCcpIHx8IHRoYXQua2V5cy5pbmNsdWRlcygiRGVhZCIpOwoKICAgIGlmIChiYWNrdGljaykgewogICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgfQp9CicAm9SFiwuO5QUGb25DaGF0AgQAm9SFiwuh8AWGCEAvL25vdCBzdXBwb3J0ZWQgb3V0c2lkZSBvZiBidWlsZGVyIHZlcnNpb24KaWYgKCFidWlsZGVyVmVyc2lvbikgewogICAgcmV0dXJuOwp9CgovL3RoaXMgbG9vcCBpZGVudGlmaWVzIHBvc3NpYmxlIGFiIHNwZWNpZmljIG1lc3NhZ2VzLCBhbmQgY2FsbHMgYSBzZXQgbGlzdCBvZiBjb21tYW5kcwppZiAodGhhdC5tZXNzYWdlWzBdID09ICIuIikgewogICAgLy8gR2V0IGNvbW1hbmQgYW5kIGFyZ3MuCiAgICBsZXQgYXJncyA9IHRoYXQubWVzc2FnZS5zcGxpdCgnICcpOwogICAgY29uc3QgY21kID0gYXJnc1swXS5zbGljZSgxKTsKICAgIGFyZ3Muc3BsaWNlKDAsIDEpOwogICAgYXJncyA9IGFyZ3MuZmlsdGVyKGFyZyA9PiBhcmcgIT09ICcnKTsKICAgIGFyZ3MgPSBhcmdzLmxlbmd0aCA/IGFyZ3MgOiB1bmRlZmluZWQ7CgogICAgLy8gQ3JlYXRlIGEgZnJlc2ggQ29tbWFuZHNNYW5hZ2VyIHdpdGggZWFjaCBjYWxsIHNvIHRoYXQgd2UgYWx3YXlzIGhhdmUgdGhlIGxhdGVzdCBjb21tYW5kcyBhbmQgZnVuY3Rpb25hbGl0eS4KICAgIGNvbnN0IGFiQ29tbWFuZHMgPSBuZXcgQUJDb21tYW5kc01hbmFnZXIoKTsKCiAgICBpZiAoYWJDb21tYW5kcyAmJiBhYkNvbW1hbmRzLmhhc0NvbW1hbmQoY21kKSkgewogICAgICAgIC8vIENhbGwgY29tbWFuZCB3aXRoIGFyZ3MuCiAgICAgICAgYWJDb21tYW5kcy5jYWxsQ29tbWFuZChjbWQsIGFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBFdmFsdWF0ZSBjb21tYW5kIGFzIGphdmFzY3JpcHQuCiAgICAgICAgb3MucnVuKGNtZCk7CiAgICB9Cn0KCmlmICh0aGF0Lm1lc3NhZ2UpIHsKICAgIC8vIEFwcGVuZCBtZXNzYWdlIHRvIGNoYXQgaGlzdG9yeSBhbmQgdXBkYXRlIHRoZSBjdXJyZW50IGhpc3RvcnkgaW5kZXguCiAgICB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkucHVzaCh0aGF0Lm1lc3NhZ2UpOwogICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7Cn0KCnRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsnAJvUhYsLjuUFC2Rlc2NyaXB0aW9uAgQAm9SFiwuo+AVCVGhpcyBpcyBtZWFudCB0byBoYW5kbGUgYW55IG5vbmUgbWVudSByZWxhdGVkIGlucHV0cy9pbnRlcmFjdGlvbnMuJwCb1IWLC47lBQxvbkZpbGVVcGxvYWQCBACb1IWLC+v4BdcYQC8vZmlsdGVyIG91dCB0aW1lcyB3aGVuIGZpbGUgbG9hZGluZyBpcyBub3QgYWxsb3dlZAppZiAoIWJ1aWxkZXJWZXJzaW9uIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJMaXN0ZW5pbmdGb3JGaWxlVXBsb2FkcyAhPT0gdHJ1ZSkKewogICAgcmV0dXJuOwp9CgovL3ZhcmlvdXMgZmlsZSBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykuc2hpZnQoKTsKbGV0IHNpemUgPSB0aGF0LmZpbGUuc2l6ZTsKbGV0IG1pbWVUeXBlOwpsZXQgYm90SW5mbyA9IHt9OwoKLy9oYXJkIGxpbWl0IGJhc2VkIG9uIGZpbGUgc2l6ZQppZiAoc2l6ZSA+IDIwMDAwMDAwMCkKewogIG9zLnRvYXN0KCJtYXhpbXVtIGZpbGUgc2l6ZSBleGNlZWRlZCAoMjAwIG1iKSIpOwoKICByZXR1cm47Cn0KCi8vdGhpcyBzd2l0Y2ggaGFuZGxlcyBwb3NzaWJsZSBmaWxlcyBleHRlbnNpb25zLCB3aGlsZSByZWplY3RpbmcgYW55IGl0IGRvZXMgbm90IHJlY29nbml6ZQpzd2l0Y2goZmlsZUV4dGVuc2lvbikKewogIGNhc2UgJ2pwZyc6CiAgY2FzZSAnanBlZyc6CiAgY2FzZSAnd2VicCc6CiAgY2FzZSAnZ2lmJzoKICBjYXNlICdwbmcnOgogICAgbWltZVR5cGUgPSAiaW1hZ2UvIiArIGZpbGVFeHRlbnNpb247CiAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgIGJyZWFrOwogIGNhc2UgJ3N2Zyc6CiAgICBtaW1lVHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgYnJlYWs7CiAgY2FzZSAnZ2xiJzoKICBjYXNlICdleHInOgogIGNhc2UgJ2dsdGYnOgogICAgbWltZVR5cGUgPSAidGV4dC94bWwiOwogICAgYm90SW5mby5mb3JtID0gIm1lc2giOwogICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJnbHRmIjsKICAgIGJyZWFrOwogIGNhc2UgJ2F1eCc6CiAgY2FzZSAncGRmJzoKICAgIGxldCBib3REYXRhID0gZmlsZUV4dGVuc2lvbiA9PSAiLmF1eCIgPyBKU09OLnBhcnNlKHRoYXQuZmlsZS5kYXRhKS5zdGF0ZSA6IG9zLnBhcnNlQm90c0Zyb21EYXRhKHRoYXQuZmlsZS5kYXRhKTsKCiAgICBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHtib3RzOiBib3REYXRhLCBvcmlnaW46IGZpbGVOYW1lfSk7CgogICAgcmV0dXJuOwovLyAgIGNhc2UgJ3BkZic6Ci8vICAgICBicmVhazsKICBjYXNlICdtcDMnOgogICAgbWltZVR5cGUgPSAnYXVkaW8vbXBlZyc7CiAgICBib3RJbmZvLm9uQ2xpY2sgPSAiQCBvcy5wbGF5U291bmQodGFncy5mb3JtQWRkcmVzcyk7IjsKICAgIGJvdEluZm8ubGFiZWwgPSAiQ2xpY2sgdG8gUGxheSI7CiAgICBicmVhazsKICBjYXNlICdtcDQnOgogICAgbWltZVR5cGUgPSAndmlkZW8vbXA0JzsKICAgIGJvdEluZm8uZm9ybSA9ICJpZnJhbWUiOwogICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJzcmMiOwogICAgYnJlYWs7CiAgY2FzZSAnb3RmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvb3RmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBjYXNlICd3b2ZmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvd29mZic7CiAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgYnJlYWs7CiAgZGVmYXVsdDoKICAgIGxldCByZXN1bHQgPSBuZXcgRXJyb3IoInVuaGFuZGxlZCBmaWxlIHR5cGU6ICIgKyBmaWxlRXh0ZW5zaW9uKTsKICAgIG9zLnRvYXN0KCJmaWxlIHR5cGUgbm90IHN1cHBvcnRlZCIpOwogICAgY29uc29sZS53YXJuKHJlc3VsdCkKICAgIHJldHVybiByZXN1bHQ7Cn0KCi8vdGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYW5kIG9iamVjdHMgc2V0IHVwIGEgbG9hZGluZyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgpsZXQgdXBsb2FkUmVzdWx0OwpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCB0aGlzQm90LmFiUHJvZ3Jlc3NCYXIoYHVwbG9hZGluZ2ApOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBjb25maWdCb3QudGFncy5zdHVkaW9JRCA/PyBjb25maWdCb3QudGFncy5zdHVkaW87CgppZiAoIWNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKQp7CiAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwp9CgovL3RoaXMgaXMgdGhlIGFjdHVhbCB1cGxvYWQgZnVuY3Rpb25hbGl0eQp1cGxvYWRSZXN1bHQgPSBhd2FpdCBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hGaWxlKHtmaWxlOiB0aGF0LmZpbGUuZGF0YSwgZmlsZU5hbWU6IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKCi8vaWYgdGhlIGZpbGUgc2hvdWxkIGJlIGluY2x1ZGVkIGFzIGEgYm90IHdpdGggYSBsaW5rLCB0aGlzIGxvZ2ljIGhhbmRsZXMgdGhhdAoKaWYgKG1pbWVUeXBlLmluY2x1ZGVzKCJmb250IikpCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5sYWJlbEZvbnRBZGRyZXNzID0gdXBsb2FkUmVzdWx0LnVybCA/IHVwbG9hZFJlc3VsdC51cmwgOiB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKICAgIGNyZWF0ZShib3RJbmZvKTsKfQplbHNlIGlmIChPYmplY3Qua2V5cyhib3RJbmZvKS5sZW5ndGggPiAwKQp7CiAgICBib3RJbmZvW2NvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWxdID0gdHJ1ZTsKICAgIGJvdEluZm8uZm9ybUFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9Cgpjb25zdCBjbGlwVVJMID0gdXBsb2FkUmVzdWx0LnVybCA/PyB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKb3Muc2V0Q2xpcGJvYXJkKGNsaXBVUkwpOwoKb3MudG9hc3QoImZpbGUgdXJsIGFkZGVkIHNldCB0byBjbGlwYm9hcmQiKTsKCi8vY2xlYXIgdGhlIHByb2dyZXNzIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiB1cGxvYWRSZXN1bHQ7JwCb1IWLC47lBQVsZWFybgIEAJvUhYsLw5EGKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAJvUhYsLjuUFCHJlbWVtYmVyAgQAm9SFiwvqkQYo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAm9SFiwuO5QUNbWFuaWZlc3RhdGlvbgIEAJvUhYsLkZIGKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAJvUhYsLjuUFCGFiSWdub3JlAgQAm9SFiwu4kgYEdHJ1ZScAm9SFiwuO5QUGY3JlYXRlAgQAm9SFiwu9kgYo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAm9SFiwuO5QUFc3RvcmUCBACb1IWLC+SSBijwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwCb1IWLC47lBQRtZW51AgQAm9SFiwuLkwYo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAm9SFiwuO5QUHYWJTaGVsbAIEAJvUhYsLspMGBHRydWUnAJvUhYsLjuUFDWFiUHJvZ3Jlc3NCYXICBACb1IWLC7eTBv0JQGlmICghY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKQp7CiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwp9CgpsZXQgbG9hZExhYmVsID0gdGhhdCA/PyAidXBkYXRpbmciOwpsZXQgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwptZW51QnV0dG9uLmFiTWVudSA9IHRydWU7Cm1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IHsKICAgICJib3JkZXItcmFkaXVzIjoiOHB4IiwgCiAgICAibWFyZ2luLXRvcCI6IjhweCIsIAogICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKfTs7Cm1lbnVCdXR0b24udHJhY2tOdW0gPSAtMTsKbWVudUJ1dHRvbi5vbkNyZWF0ZSA9IGBACiAgICBpZiAodGFncy50cmFja051bSA9PSAyKQogICAgewogICAgICAgIHRhZ3MudHJhY2tOdW0gPSAwOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MudHJhY2tOdW0rKzsKICAgIH0KCiAgICB0YWdzLmxhYmVsID0gdGFnc1sibGFiZWwiK3RhZ3MudHJhY2tOdW1dOwogICAgdGFncy5mb3JtQWRkcmVzcyA9IHRhZ3NbImZvcm0iK3RhZ3MudHJhY2tOdW1dOwoKICAgIHNldFRpbWVvdXQoKCkgPT4gd2hpc3Blcih0aGlzQm90LCAib25DcmVhdGUiKSwgNTAwKTtgOwptZW51QnV0dG9uLmxhYmVsMCA9IGxvYWRMYWJlbCArICIuIjsKbWVudUJ1dHRvbi5sYWJlbDEgPSBsb2FkTGFiZWwgKyAiLi4iOwptZW51QnV0dG9uLmxhYmVsMiA9IGxvYWRMYWJlbCArICIuLi4iOwptZW51QnV0dG9uLmZvcm0wID0gImhvdXJnbGFzc19ib3R0b20iOwptZW51QnV0dG9uLmZvcm0xID0gImhvdXJnbGFzc190b3AiOwptZW51QnV0dG9uLmZvcm0yID0gImhvdXJnbGFzc19ib3R0b20iOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5sYWJlbENvbG9yID0gImJsYWNrIjsKbWVudUJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJjZW50ZXIiOwptZW51QnV0dG9uLmFiUHJvZ3Jlc3NSZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5vbkRlc3Ryb3kgPSAiQCBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7IjsKCm1lbnVCdXR0b24gPSBjcmVhdGUobWVudUJ1dHRvbik7CgpyZXR1cm4gbWVudUJ1dHRvbjsnAJvUhYsLjuUFCW9uVGFwQ29kZQIEAJvUhYsLtZ0GqQJAY29uc3QgdGFwQ29kZSA9IHRoYXQ7Cgpzd2l0Y2ggKHRhcENvZGUpCnsKICAgIGNhc2UgIjMzNDIiOgogICAgICAgIG9zLnRvYXN0KCJ3YWtpbmcgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkpOwoKICAgICAgICB0aGlzQm90Lm9uQ2hhdCh7bWVzc2FnZTogIi4uIn0pOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAiNDI0MiI6CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIC8vY29uc29sZS5sb2codGFwQ29kZSk7Cn0nAJvUhYsLjuUFA2FzawIEAJvUhYsL358GKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAJvUhYsLjuUFCWFiVmVyc2lvbgIEAJvUhYsLhqAGBDEwLjQnAJvUhYsLjuUFCm9uQm90QWRkZWQCBACb1IWLC4ugBkBAdGhpc0JvdC5sb2FkQUJDb21tYW5kc01hbmFnZXIoKTsKdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5ID0gW107JwCb1IWLC47lBRpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAJvUhYsLzKAG4DxAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCi8vIFRoZXNlIGFyZSBhbGwgdGhlIGJ1aWx0LWluIGNvbW1hbmRzLgoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdoZWxwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGNvbW1hbmRzID0gYWJDb21tYW5kcy5jb21tYW5kczsKICAgIGNvbnN0IGNvbW1hbmRLZXlzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpOwoKICAgIGxldCBzZWxlY3RlZENvbW1hbmQ7CiAgICBpZiAoY29tbWFuZEtleXMgJiYgY29tbWFuZEtleXMubGVuZ3RoICYmIGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb21tYW5kS2V5TWF0Y2ggPSBjb21tYW5kS2V5cy5maW5kKGtleSA9PiBrZXkgPT09IGFyZ3NbMF0pOwogICAgICAgIHNlbGVjdGVkQ29tbWFuZCA9IGNvbW1hbmRLZXlNYXRjaDsKICAgIH0KICAgIAogICAgbGlua3MuaGVscC5tb3VudCh7IGFiQ29tbWFuZHNNYW5hZ2VyOiBhYkNvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IHRoaXMgaGVscCB3aW5kb3cuIENhbiBzcGVjaWZ5IGEgY29tbWFuZCB0byBvcGVuIHRoZSBoZWxwIHBhZ2UgZm9yIHRoYXQgY29tbWFuZCBkaXJlY3RseS4nLAogICAgdXNhZ2U6IFsnLmhlbHAnLCAnLmhlbHAgW2NvbW1hbmRdJ10KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJy4nLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcuLicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3dha2UnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcud2FrZScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NsZWVwJywgYXJncyA9PiB0aGlzQm90LmNtZEFCU2xlZXAoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdXQgYWIgdG8gc2xlZXAuJywKICAgIHVzYWdlOiAnLnNsZWVwJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYXNrJywgKGFyZ3MpID0+IHsKICAgIGlmIChsaW5rcy5hc2spIHsKICAgICAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgYXNrSW5wdXQgPSBhcmdzLmpvaW4oJyAnKTsKICAgICAgICAgICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrSW5wdXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC5hc2sgY29tbWFuZCByZXF1aXJlcyBpbnB1dGApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYXNrIGJvdCBpcyBub3QgbG9hZGVkLCBjYW5ub3QgbG9hZCBhc2tgKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0FzayBhYicsCiAgICB1c2FnZTogJy5hc2sgPGFza19uYW1lPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ25hbWVhYicsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBuYW1lID0gYXdhaXQgb3Muc2hvd0lucHV0KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHksIHsgdGl0bGU6ICd3aGF0IHdvdWxkIHlvdSBsaWtlIHRvIGNhbGwgbWU/JyB9KTsKICAgIHNldFRhZ01hc2sobGlua3MucmVtZW1iZXIsICdhYkJ1aWxkZXJJZGVudGl0eScsIG5hbWUsICdsb2NhbCcpOwogICAgc2hvdXQoJ2J1aWxkZXJJZGVudGl0eV9zYXZlJywgeyBuYW1lOiBuYW1lIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2l2ZSBhYiBhIG5ldyBuYW1lLicsCiAgICB1c2FnZTogJy5uYW1lYWInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzeXN0ZW0nLCBhcmdzID0+IHRoaXNCb3QuY21kU3lzdGVtKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGluc3QuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYE9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpICAgIAoKICAgIFlvdSBtYXkgcHJvdmlkZSBhIGN1c3RvbSBzeXN0ZW1UYWdOYW1lIHdpdGggdGhlIGNvbW1hbmQsIGluIG9yZGVyIHRvIG9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgb25seSBmb3IgYm90cyB3aXRoIHRoZSBnaXZlbiBzeXN0ZW1UYWdOYW1lLiBCeSBkZWZhdWx0LCAic3lzdGVtIiB3aWxsIGJlIHVzZWQgYXMgdGhlIHN5c3RlbVRhZ05hbWUuCgogICAgRm9yIGV4YW1wbGU6CgogICAgPiAuc3lzdGVtCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJzeXN0ZW0iIHRhZy4KCiAgICA+IC5zeXN0ZW0gbXlHcm91cAogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAibXlHcm91cCIgdGFnLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zeXN0ZW0nLAogICAgICAgICcuc3lzdGVtIHN5c3RlbVRhZ05hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy13JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4gQnkgZGVmYXVsdCB0aGUgc3lzdGVtIHBvcnRhbCB3aWxsIG9wZW4gaW4gYSBuZXcgdGFiLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2cnLCAoYXJncykgPT4gewogICAgbGlua3MuY29uc29sZS50b2dnbGVDb25zb2xlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdUb2dnbGUgdmlzaWJsaXR5IG9mIHRoZSBhYiBsb2cuJywKICAgIHVzYWdlOiAnLmxvZycKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nY2xlYXInLCAoYXJncykgPT4gewogICAgY29uc3QgbWVzc2FnZUxvZ0JvdHMgPSBnZXRCb3RzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIsIHRydWUpOwogICAgZGVzdHJveShtZXNzYWdlTG9nQm90cyk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdDbGVhciBhbGwgYWIgbG9nIG1lc3NhZ2VzLicsCiAgICB1c2FnZTogJy5sb2djbGVhcicKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2hlZXQnLCBhcmdzID0+IHRoaXNCb3QuY21kU2hlZXQoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHNwZWNpZmllZCBib3Qgb3IgYW4gZW50aXJlIGRpbWVuc2lvbi4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnNoZWV0IFtvcHRpb25zXSBbcG9ydGFsIHwgaGVscGVyQm90TmFtZSB8IGJvdElkIHwgZ2xvYmFsVGhpc1BhdGhdJywKICAgICAgICAnZXguIC5zaGVldCBob21lJywKICAgICAgICAnZXguIC5zaGVldCBjb25maWdCb3QnLAogICAgICAgICdleC4gLnNoZWV0IC10IGEyY2Y0NzM5LTM5YTItNGZkNi1iM2VmLWNjNDc4MmY5NzA4OScsCiAgICAgICAgJ2V4LiAuc2hlZXQgZ2xvYmFsVGhpcy5teU9iamVjdC5teUJvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgbXlPYmplY3QubXlCb3QnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy10JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgaW4gYSBuZXcgYnJvd3NlciB0YWIuIFxuXG5OT1RFOiAuc2hlZXQgd2lsbCBhdXRvbWF0aWNhbGx5IGluc3BlY3QgdGhlIHNwYWNlIG9mIGEgYm90IGFuZCBmb3JjZSBvcGVuaW5nIGluIHRoZSBzYW1lIHRhYiBpZiBhIGJvdCBpcyBpbiB0ZW1wTG9jYWwgb3IgdGVtcFNoYXJlZCBzcGFjZS4nLAogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ21lbnVzaGVldCcsIChhcmdzKSA9PiB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWw7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYENhbm5vdCBvcGVuIHNoZWV0UG9ydGFsIGZvciBtZW51UG9ydGFsIGJvdHMuIFRoZSBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBkaXNhYmxlZC5gfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3IgdGhlIGN1cnJlbnQgbWVudSBwb3J0YWwuJywKICAgIHVzYWdlOiAnLm1lbnVTaGVldCcsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGluc3QnLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRJbnN0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgdGhlIGluc3QgdG8gZGlzay4nLAogICAgdXNhZ2U6ICcuZG93bmxvYWRpbnN0Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRhYicsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEFCKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgc3BlY2lmaWVkIGFiIGZpbGUgdG8gZGlzay4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRvd25sb2FkYWInLAogICAgICAgICcuZG93bmxvYWRhYiAtdiAxJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnU3BlY2lmeSB0aGUgYXV4IGZvcm1hdCB2ZXJzaW9uIG51bWJlci4gZXguIC12IDEgd2lsbCBiZSBhdXggZm9ybWF0IHZlcnNpb24gMSAocHVyZSBib3QganNvbikuIEJ5IGRlZmF1bHQsIGFiIGZpbGVzIGFyZSB1c3VhbGx5IGRvd25sb2FkZWQgYXMgdmVyc2lvbiAyIGF1eCBmaWxlcyAoY29uZmxpY3QtZnJlZSB1cGRhdGUpLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGVnZycsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEVnZyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4gWW91IHdpbGwgbmVlZCB0byBwcm92aWRlIHRoZSByZWNvcmRLZXkgYXMgd2VsbCBhbmQgdGhlIG5hbWUgb2YgdGhlIGVnZy4gQSBkcm9wZG93biBzZWxlY3Rpb24gd2lsbCBiZSBwcm92aWRlZCBmb3IgdGhlIGVnZyBpZiBmb3VuZCB0byBzZWxlY3Qgd2hpY2ggdmVyc2lvbiB0byBkb3dubG9hZC5gLAogICAgdXNhZ2U6ICcuZG93bmxvYWRlZ2cnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9hZHNraWxsJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm9yIChsZXQgc2tpbGwgb2YgYXJncykgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJy5sb2Fkc2tpbGwgcmVxdWlyZXMgc29tZSBza2lsbCBuYW1lcycpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTG9hZCB0aGUgc3BlY2lmaWVkIGFiIHNraWxscy4nLAogICAgdXNhZ2U6ICcubG9hZFNraWxsIFtza2lsbCAuLi5dJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXJscXInLCAoKSA9PiBvcy5zaG93UVJDb2RlKGNvbmZpZ0JvdC50YWdzLnVybCksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IGEgUVIgY29kZSBmb3IgdGhlIGJyb3dlciB0YWJcJ3MgY3VycmVudCBVUkwuJywKICAgIHVzYWdlOiAnLnVybHFyJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZGltJywgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgbmFtZSA9IGFyZ3Muam9pbignICcpOwogICAgICAgIG9zLmdvVG9EaW1lbnNpb24obmFtZSk7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBNb3ZlZCB0byAnJHtuYW1lfScgZGltZW5zaW9uLmAsIGR1cmF0aW9uOiAzIH0pCiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHbyB0byBzcGVjaWZpZWQgZGltZW5zaW9uIC8gcG9ydGFsLicsCiAgICB1c2FnZTogJy5kaW0gPGRpbWVuc2lvbiB8IHBvcnRhbD4nLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXVpZCcsICgpID0+IHsKICAgIG9zLnNldENsaXBib2FyZCh1dWlkKCkpOwoKICAgIGxldCBtZXNzYWdlID0gYENvcGllZCBuZXcgdXVpZCB0byBjbGlwYm9hcmRgOwogICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYSB1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllciAodXVpZCkgYW5kIGNvcHkgaXQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcudXVpZCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2R1cCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBib3RJZCA9IGFyZ3MgPyBhcmdzWzBdIDogdW5kZWZpbmVkOwogICAgaWYgKGJvdElkKSB7CiAgICAgICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgICAgICBpZiAoYm90KSB7CiAgICAgICAgICAgIGNvbnN0IGR1cEJvdCA9IGNyZWF0ZShib3QpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZHVwQm90LmlkKTsKICAgICAgICAgICAgb3MudG9hc3QoJ0R1cGxpY2F0ZSBib3QgaWQgY29waWVkIHRvIGNsaXBib2FyZC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcy50b2FzdChgTm8gYm90IGZvdW5kIHdpdGggaWQgJHtib3RJZH1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCdQcm92aWRlIHRoZSBpZCBvZiB0aGUgYm90IHlvdSB3YW50IHRvIGR1cGxpY2F0ZScpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGEgc3BlY2lmaWVkIGJvdCBhbmQgY29weSB0aGUgbmV3IGJvdFwncyBpZCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy5kdXAgPGJvdElkPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGF1eCcsIChhcmdzKSA9PiB7CiAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIEFVWCBmaWxlKHMpIHRvIHRoZSBjdXJyZW50IGluc3QuJywKICAgIHVzYWdlOiAnLnVwbG9hZGF1eCcKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkZmlsZXMnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBsb2FkRmlsZXMoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgZmlsZShzKSBkaXJlY3RseSB0byByZWNvcmQuJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGxvYWRmaWxlcycsCiAgICAgICAgJy51cGxvYWRmaWxlcyAtcmVjb3JkIDxyZWNvcmRfaWQ+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcmVjb3JkJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcHRpb25hbGx5IHB1Ymxpc2ggZmlsZShzKSB0byBhIHNwZWNpZmljIHJlY29yZC4gSWYgb21pdHRlZCwgZmlsZShzKSB3aWxsIGJlIHB1Ymxpc2hlZCB0byB0aGUgdXNlclwncyBwZXJzb25hbCByZWNvcmQuJwogICAgICAgIH0KICAgIF0KfSknAJvUhYsLjuUFFWxvYWRBQkNvbW1hbmRzTWFuYWdlcgIEAJvUhYsLrd0G6jBAdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9CgovKioKICogQUJDb21tYW5kc01hbmFnZXIgaXMgcGFydCBvZiBhYlNoZWxsLgogKiBZb3UgY2FuIHJlZ2lzdGVyIGNvbW1hbmRzIHRvIGl0IHRoYXQgY2FuIGJlIGludm9rZWQgdXNpbmcgJyQ8Y29tbWFuZD4nIHdpdGggdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogKiBJdHMgZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZCB0byBjcmVhdGUgdGhpcyB5b3Vyc2VsZiBidXQgaW5zdGVhZCB0byBsaXN0ZW4gZm9yIHRoZSBAb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQgc2hvdXQKICogYW5kIHRvIHJlZ2lzdGVyIHlvdXIgY29tbWFuZHMgdGhlcmUuCiAqIEBwcm9wIHtzdHJpbmdbXX0gY29tbWFuZHMKICovCmNsYXNzIEFCQ29tbWFuZHNNYW5hZ2VyIHsKICAgIGNvbW1hbmRzOiBSZWNvcmQ8c3RyaW5nLCBBQkNvbW1hbmQ+OwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKCiAgICAgICAgLy8gU2hvdXQgdGhhdCBhbiBpbnN0YW5jZSBvZiBBQkNvbW1hbmRzTWFuYWdlciBoYXMgYmVlbiBjcmVhdGVkIGFuZCBhbGxvdyBhbnkgbGlzdGVuZXJzCiAgICAgICAgLy8gdG8gYWRkIHRoZWlyIG93biBjb21tYW5kcyB0byB0aGUgaW5zdGFuY2UuCiAgICAgICAgc2hvdXQoJ29uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkJywgdGhpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgYSBjb21tYW5kIHRvIEFCQ29tbWFuZHNNYW5hZ2VyLgogICAgICogVGhpcyBjb21tYW5kIHdpbGwgYmUgYXZhaWxhYmxlIHRvIGludm9rZSB1c2luZyAnJDxuYW1lPicgb24gdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIHN1Y2Nlc3NmdWxseSBhZGRlZC4KICAgICAqLwogICAgYWRkQ29tbWFuZChuYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjaywgaGVscDogQUJDb21tYW5kSGVscCk6IGJvb2xlYW4gewogICAgICAgIGlmICghbmFtZSB8fCB0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSBzdHJpbmcgbmFtZSBpcyByZXF1aXJlZCBmb3IgY29tbWFuZHMuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBhbHJlYWR5IGV4aXN0cyBhcyBhIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghY2FsbGJhY2sgfHwgdHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGEgY2FsbGJhY2sgZnVuY3Rpb24uYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgaXMgbWlzc2luZyBzaG9ydERlc2NyaXB0aW9uIGZyb20gaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29tbWFuZHNbbmFtZV0gPSB7IG5hbWUsIGNhbGxiYWNrLCBoZWxwIH07CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaGFzQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kc1tuYW1lXSAhPSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgY29tbWFuZCBmcm9tIEFCQ29tbWFuZHNNYW5hZ2VyCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2FzIHJlbW92ZWQuIElmIHRoZSBjb21tYW5kIGRvZXNuJ3QgZXhpc3QgZmFsc2Ugd2lsbCBhbHNvIGJlIHJldHVybmVkLgogICAgICovCiAgICByZW1vdmVDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ2FsbCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2l0aCB0aGUgcHJvdmlkZWQgYXJncyAoaWYgYW55KS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBleGVjdXRlZC4KICAgICAqLwogICAgY2FsbENvbW1hbmQobmFtZTogc3RyaW5nLCBhcmdzPzogYW55W10pOiBib29sZWFuIHsKICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICBpZiAoY29tbWFuZCkgewogICAgICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRBcmdzID0gW107CgogICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBoZWxwQXJnIG9mIGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhlbHBBcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKC4uLmhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaChoZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZSBpbnB1dCBhcmdzIGFyZSB2YWxpZCBhZ2FpbnN0IHRoZSBjb21tYW5kIGhlbHAgZG9jdW1lbnRhdGlvbi4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gZWFzeSB3YXkgdG8gdmFsaWRhdGUgYXJncyBiZWZvcmUgZXhlY3V0aW5nIGEgY29tbWFuZC4KICAgICAgICAgICAgICAgIEFCQ29tbWFuZHNNYW5hZ2VyLmFzc2VydFZhbGlkQXJncyhhcmdzLCB2YWxpZEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1hbmQuY2FsbGJhY2soYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBub3QgYSB2YWxpZCBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHByb3ZpZGVkIGFyZy4gV2lsbCByZW1vdmUgdGhlIGFyZyBhbmQgdmFsdWUgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnVmFsdWUoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYW55IHsKICAgICAgICBsZXQgdmFsdWUgPSBudWxsOwoKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICBsZXQgZGVsZXRlQ291bnQgPSAxOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWVJbmRleCA9IGFyZ0luZGV4ICsgMTsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWVJbmRleCA8IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbdmFsdWVJbmRleF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlbGF0ZWQgYXJncyAmIHZhbHVlcwogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIGRlbGV0ZUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHdldGhlciB0aGUgYXJnIGZsYWcgaXMgcHJvdmlkZWQgaW4gdGhlIGFyZ3MuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnRmxhZyhhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYXJnIGZsYWcuCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgMSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHN0YXRpYyBhc3NlcnRWYWxpZEFyZ3MoYXJnczogYW55W10sIHZhbGlkQXJnczogYW55W10pOiB2b2lkIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBpbnZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFyZyB3ZSB3YW50IHRvIGV2YWx1YXRlLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkQXJncyB8fCAhdmFsaWRBcmdzLmluY2x1ZGVzKGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXJnIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgdmFsaWRBcmdzLCB0aHVzIHRoZSBhcmcgaXMgaW52YWxpZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRBcmdzLnB1c2goYXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB0aGlzIGFyZyBpdCBpcyBtb3N0bHkgbGlrZWx5IGEgdmFsdWUgYXJnLgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGludmFsaWRBcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIGFyZ3VtZW50czogJHtpbnZhbGlkQXJncy5qb2luKCcsICcpfWA7CgogICAgICAgICAgICAgICAgb3MudG9hc3QoZXJyb3JNZXNzYWdlLCA0KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpnbG9iYWxUaGlzLkFCQ29tbWFuZHNNYW5hZ2VyID0gQUJDb21tYW5kc01hbmFnZXI7JwCb1IWLC47lBQRoZWxwAgQAm9SFiwuYjgco8J+UlzI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYycAm9SFiwuO5QUIY21kU2hlZXQCBACb1IWLC7+OB80UQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IHBvcnRhbDsKbGV0IG5ld1RhYiA9IGZhbHNlOwoKaWYgKGFyZ3MpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV07CiAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJy10JykgewogICAgICAgICAgICAgICAgbmV3VGFiID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSBhcmc7CiAgICAgICAgfQogICAgfQp9CgppZiAoIXBvcnRhbCkgewogICAgcG9ydGFsID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9Cgpjb25zdCBoZWxwZXJCb3RzID0gewogICAgJ2NvbmZpZ0JvdCc6IGNvbmZpZ0JvdCwKICAgICdncmlkUG9ydGFsQm90JzogZ3JpZFBvcnRhbEJvdCwKICAgICdzaGVldFBvcnRhbEJvdCc6IHNoZWV0UG9ydGFsQm90LAogICAgJ3N5c3RlbVBvcnRhbEJvdCc6IHN5c3RlbVBvcnRhbEJvdCwKICAgICdtaW5pR3JpZFBvcnRhbEJvdCc6IG1pbmlHcmlkUG9ydGFsQm90LAogICAgJ21hcFBvcnRhbEJvdCc6IG1hcFBvcnRhbEJvdCwKICAgICdtaW5pTWFwUG9ydGFsQm90JzogbWluaU1hcFBvcnRhbEJvdCwKICAgICdtZW51UG9ydGFsQm90JzogbWVudVBvcnRhbEJvdCwKICAgICdsZWZ0V3Jpc3RQb3J0YWxCb3QnOiBsZWZ0V3Jpc3RQb3J0YWxCb3QsCiAgICAncmlnaHRXcmlzdFBvcnRhbEJvdCc6IHJpZ2h0V3Jpc3RQb3J0YWxCb3QsCiAgICAnbWVldFBvcnRhbEJvdCc6IG1lZXRQb3J0YWxCb3QsCiAgICAndGFnUG9ydGFsQm90JzogdGFnUG9ydGFsQm90LAogICAgJ2ltdVBvcnRhbEJvdCc6IGltdVBvcnRhbEJvdCwKfTsKCi8vIEZ1bmN0aW9uIHRvIHJlc29sdmUgYSBwb3J0YWwgcmVmZXJlbmNlIHRvIGEgc3BlY2lmaWMgYm90CmZ1bmN0aW9uIHJlc29sdmVQb3J0YWxUb0JvdChwYXRoKSB7CiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJycpIHJldHVybiBudWxsOwogICAgCiAgICAvLyBGaXJzdCBjaGVjayBpZiBpdCdzIGRpcmVjdGx5IGluIGhlbHBlckJvdHMKICAgIGlmIChoZWxwZXJCb3RzW3BhdGhdKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlckJvdHNbcGF0aF07CiAgICB9CgogICAgLy8gUGVyaGFwcyB0aGUgcGF0aCBpcyBhIGJvdCBpZC4KICAgIGxldCBib3RGcm9tSWRTZWFyY2ggPSBnZXRCb3QoJ2lkJywgcGF0aCk7CiAgICBpZiAoYm90RnJvbUlkU2VhcmNoKSB7CiAgICAgICAgcmV0dXJuIGJvdEZyb21JZFNlYXJjaDsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgZm9yIGJvdGggZGlyZWN0IGFuZCBuZXN0ZWQgcGF0aHMgaW4gZ2xvYmFsVGhpcwogICAgbGV0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIGxldCBjdXJyZW50T2JqID0gZ2xvYmFsVGhpczsKICAgIGxldCBzdGFydEluZGV4ID0gMDsKICAgIAogICAgLy8gSGFuZGxlIGlmIHRoZSBwYXRoIGV4cGxpY2l0bHkgc3RhcnRzIHdpdGggJ2dsb2JhbFRoaXMnCiAgICBpZiAocGF0aFBhcnRzWzBdID09PSAnZ2xvYmFsVGhpcycpIHsKICAgICAgICBzdGFydEluZGV4ID0gMTsgLy8gU2tpcCB0aGUgJ2dsb2JhbFRoaXMnIHBhcnQgc2luY2Ugd2UncmUgYWxyZWFkeSBzdGFydGluZyB0aGVyZQogICAgfQogICAgCiAgICAvLyBUcmF2ZXJzZSB0aGUgcGF0aAogICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBwYXRoUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwYXJ0ID0gcGF0aFBhcnRzW2ldOwogICAgICAgIGlmICghY3VycmVudE9ialtwYXJ0XSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gUGF0aCBzZWdtZW50IGRvZXNuJ3QgZXhpc3QKICAgICAgICB9CiAgICAgICAgY3VycmVudE9iaiA9IGN1cnJlbnRPYmpbcGFydF07CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGlmIHRoZSBmaW5hbCBvYmplY3QgaXMgYSBib3QgKGhhcyBpZCBhbmQgdGFncykKICAgIGlmIChjdXJyZW50T2JqICYmIGN1cnJlbnRPYmouaWQgJiYgY3VycmVudE9iai50YWdzKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRPYmo7CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOyAvLyBOb3QgYSB2YWxpZCBib3QKfQoKLy8gU2VhcmNoIHRvIHNlZSBpZiBwb3J0YWwgYXJndW1lbnQgaXMgc3BlY2lmaWMgdG8gYSBib3QKbGV0IHVuaXF1ZUJvdCA9IHJlc29sdmVQb3J0YWxUb0JvdChwb3J0YWwpOwoKaWYgKHVuaXF1ZUJvdCkgewogICAgaWYgKHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcExvY2FsJyB8fAogICAgICAgIHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcFNoYXJlZCcKICAgICkgewogICAgICAgIC8vIEZvcmNlIHNoZWV0IHRvIG9wZW4gaW4gc2FtZSB0YWIgaWYgdGhlIGJvdCBvbmx5IGxpdmVzIGluIHRoaXMgdGFiLgogICAgICAgIG5ld1RhYiA9IGZhbHNlOwogICAgfQogICAgcG9ydGFsID0gdW5pcXVlQm90LmlkOwp9CgppZiAobmV3VGFiKSB7CiAgICBvcy5vcGVuVVJMKGAvP2luc3Q9JHtvcy5nZXRDdXJyZW50SW5zdCgpfSZzaGVldFBvcnRhbD0ke3BvcnRhbH1gKTsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gcG9ydGFsOwp9JwCb1IWLC47lBQ1jbWREb3dubG9hZEFCAgQAm9SFiwuNowfOCEBjb25zdCBhcmdzID0gdGhhdDsKCmxldCBhdXhWZXJzaW9uOiBzdHJpbmcgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctdicpOwoKaWYgKCFhdXhWZXJzaW9uKSB7CiAgICAvLyBEZWZhdWx0IHRvIGF1eCB2ZXJzaW9uIDIgaWYgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkLgogICAgYXV4VmVyc2lvbiA9ICcyJzsKfQoKaWYgKGF1eFZlcnNpb24gIT09ICcxJyAmJiBhdXhWZXJzaW9uICE9PSAnMicpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYE9ubHkgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgYW5kIDIgYXJlIHN1cHBvcnRlZCBpbiB0aGUgZG93bmxvYWQgYWIgY29tbWFuZC5gKTsKICAgIHJldHVybjsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmxldCBncm91cCA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRBQkdyb3VwLCB7IHRpdGxlOiAnQUIgR3JvdXAgVGFnJywgYXV0b1NlbGVjdDogdHJ1ZSB9KTsKbWFza3MucHJldkRvd25sb2FkQUJHcm91cCA9IGdyb3VwOwoKY29uc3QgbWFqb3JWZXJzaW9uID0gbGlua3MubGVhcm4udGFncy5hYkNvcmVNYWpvclZlcnNpb247CmNvbnN0IG1pbm9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWlub3JWZXJzaW9uOwpjb25zdCBhYlZlcnNpb24gPSBgJHttYWpvclZlcnNpb259LiR7bWlub3JWZXJzaW9ufWA7Cgpjb25zdCBhYkdyb3VwID0gZ2V0Qm90cyhncm91cCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFiR3JvdXAubGVuZ3RoOyBpKyspIHsKICAgIGFiR3JvdXBbaV0udGFncy5hYlZlcnNpb24gPSBhYlZlcnNpb247Cn0KCmlmIChncm91cCA9PSAiYWJDb25maWciKSB7CiAgICBncm91cCA9ICJhYjEiOwp9CgppZiAoYXV4VmVyc2lvbiA9PT0gJzEnKSB7CiAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDEKICAgIG9zLmRvd25sb2FkQm90cyhhYkdyb3VwLCBncm91cCkKfSBlbHNlIHsKICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMgogICAgb3MuZG93bmxvYWRCb3RzQXNJbml0aWFsemF0aW9uVXBkYXRlKGFiR3JvdXAsIGdyb3VwKTsKfQonAJvUhYsLjuUFCWNtZEFCV2FrZQIEAJvUhYsL3KsHswNAbGV0IHNraWxsQXJyYXkgPSBbImFiSW50ZXJmYWNlIiwgImFiQWN0aW9uIiwgImFiVGVzdHMiXTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc2tpbGxBcnJheS5sZW5ndGg7IGkrKykgewogICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChza2lsbEFycmF5W2ldKTsKfQoKYXdhaXQgb3Muc2xlZXAoMzAwKTsKCi8va2VlcCBhYiBhd2FrZQpsaW5rcy5yZW1lbWJlci50YWdzLmFiQXdha2VTdGF0ZSA9IHRydWU7CgppZiAoY29uZmlnQm90LnRhZ3MucGF0dGVybikgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuOwp9CmVsc2UgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSB1dWlkKCk7Cn0KCmNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBd2FrZSIsICJhYk1hbmlmZXN0U3RhdGUiKTsnAJvUhYsLjuUFCmNtZEFCU2xlZXACBACb1IWLC5CvB90BQGNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBc2xlZXAiLCAiYWJNYW5pZmVzdFN0YXRlIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwoKdGFnUG9ydGFsQm90Lm1hc2tzLnRhZ1BvcnRhbEFuY2hvclBvaW50ID0gbnVsbDsnAJvUhYsLjuUFB2NvbnNvbGUCBACb1IWLC+6wByjwn5SXMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViJwCb1IWLC47lBQ5jbWRVcGxvYWRGaWxlcwIEAJvUhYsLlbEHkxBAY29uc3QgYXJncyA9IHRoYXQ7Cgphc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlKHsgZmlsZSwgcmVjb3JkS2V5IH0pIHsKICAgIGxldCBmaWxlRXh0ZW5zaW9uID0gZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCk7CiAgICBsZXQgZmlsZU5hbWUgPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwogICAgbGV0IG1pbWVUeXBlOwoKICAgIHN3aXRjaCAoZmlsZUV4dGVuc2lvbikgewogICAgICAgIGNhc2UgJ3N2Zyc6CiAgICAgICAgICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdnbGInOgogICAgICAgIGNhc2UgJ2dsdGYnOgogICAgICAgICAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIG1pbWVUeXBlID0gZmlsZS5taW1lVHlwZTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgbGV0IHVybDsKICAgICAgICAKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gcmVjb3JkS2V5OwogICAgY29uc3QgW3Jlc3VsdF0gPSBhd2FpdCBQcm9taXNlLmFsbChzaG91dCgnYWJQdWJsaXNoRmlsZScsIHsgZmlsZSwgZmlsZU5hbWUsIG1pbWVUeXBlIH0pKTsKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gbnVsbDsKICAgIAogICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQudXJsOwogICAgfSBlbHNlIGlmIChyZXN1bHQuZXhpc3RpbmdGaWxlVXJsKSB7CiAgICAgICAgdXJsID0gcmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKICAgIH0KCiAgICByZXR1cm4geyB1cmwgfTsKfQoKY29uc3QgcmVjb3JkS2V5ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXJlY29yZCcpOwpjb25zdCBzZWxlY3RlZEZpbGVzID0gYXdhaXQgb3Muc2hvd1VwbG9hZEZpbGVzKCk7CmNvbnN0IHB1Ymxpc2hSZWNvcmQgPSBnZXRCb3QoJ3N5c3RlbScsICdyYy1wYWNrYWdlLWRldi5wdWJsaXNoUmVjb3JkJyk7CgppZiAoc2VsZWN0ZWRGaWxlcyAmJiBzZWxlY3RlZEZpbGVzLmxlbmd0aCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVwbG9hZCAke3NlbGVjdGVkRmlsZXMubGVuZ3RofSBmaWxlcy4uLmApOwogICAgfQoKICAgIGxldCBkb25lSHRtbCA9ICcnOwoKICAgIGlmIChyZWNvcmRLZXkpIHsKICAgICAgICBkb25lSHRtbCArPSBgPGgyPlJlY29yZCBJZDwvaDI+YDsKICAgICAgICBkb25lSHRtbCArPSBgPHA+JHtyZWNvcmRLZXl9PC9wPmA7CiAgICB9CgogICAgZG9uZUh0bWwgKz0gJzxoMj5VcGxvYWRlZCBGaWxlczwvaDI+JzsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEZpbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb3Muc2hvd0h0bWwoYFVwbG9hZGluZyAke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX0uLi5gKTsKICAgICAgICAKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1cGxvYWRGaWxlKHsKICAgICAgICAgICAgZmlsZTogc2VsZWN0ZWRGaWxlc1tpXSwKICAgICAgICAgICAgcmVjb3JkS2V5LAogICAgICAgICAgICBvblByb2dyZXNzOiAoZmlsZVByb2dyZXNzKSA9PiB7CiAgICAgICAgICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSAke01hdGguY2VpbChmaWxlUHJvZ3Jlc3MgKiAxMDApfSVgKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGlmIChyZXN1bHQudXJsKSB7CiAgICAgICAgICAgIGRvbmVIdG1sICs9IGA8YSBocmVmPSIke3Jlc3VsdC51cmx9IiB0YXJnZXQ9Il9ibGFuayI+JHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9PC9hPjwvYnI+YDsKICAgICAgICB9CgogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSByZXN1bHQ6YCwgcmVzdWx0KTsKICAgIH0KCiAgICBvcy5zaG93SHRtbChkb25lSHRtbCk7Cn0nAJvUhYsLjuUFDmNtZERvd25sb2FkRWdnAgQAm9SFiwupwQf5C0Bjb25zdCByZWNvcmRLZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5LCB7CiAgICB0aXRsZTogJ3JlY29yZCB0byBsb29rdXAgZWdnIGluJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXk6YCwgcmVjb3JkS2V5KTsKCmlmICghcmVjb3JkS2V5KSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ1JlY29yZEtleSA9IHJlY29yZEtleTsKCmNvbnN0IGVnZ05hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnTmFtZSwgewogICAgdGl0bGU6ICduYW1lIG9mIGVnZycsCiAgICB0eXBlOiAndGV4dCcsCn0pCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTmFtZTpgLCBlZ2dOYW1lKTsKCmlmICghZWdnTmFtZSkgewogICAgcmV0dXJuOwp9CgptYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lID0gZWdnTmFtZTsKCmNvbnN0IGVnZyA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICBhYklEOiBlZ2dOYW1lLAogICAgcmVjb3JkS2V5LAogICAgcmV0dXJuVHlwZTogJ2VnZycKfSkKCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnOmAsIGVnZyk7CgppZiAoIUFycmF5LmlzQXJyYXkoZWdnLmVnZ1ZlcnNpb25IaXN0b3J5KSB8fCBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBEYXRhIGZvdW5kIGF0IGFkZHJlc3MgJyR7ZWdnTmFtZX0nIGluIHJlY29yZCAnJHtyZWNvcmRLZXl9JyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYW4gZWdnLmApCiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgZWdnVmVyc2lvbk9wdGlvbnMgPSBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubWFwKChpdGVtLCBpbmRleCkgPT4gewogICAgcmV0dXJuIHsgbGFiZWw6IGB2ZXJzaW9uICR7aW5kZXggKyAxfWAsIHZhbHVlOiBpbmRleCB9Cn0pCgpjb25zdCBzZWxlY3RlZFZlcnNpb25PcHRpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQoZWdnVmVyc2lvbk9wdGlvbnMubGVuZ3RoIC0gMSwgewogICAgdGl0bGU6ICdkb3dubG9hZCBlZ2cgdmVyc2lvbicsCiAgICB0eXBlOiAnbGlzdCcsCiAgICBzdWJ0eXBlOiAnc2VsZWN0JywKICAgIGl0ZW1zOiBlZ2dWZXJzaW9uT3B0aW9ucywKfSkKCmlmICghc2VsZWN0ZWRWZXJzaW9uT3B0aW9uKSB7CiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgYXV4RGF0YVVybCA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeVtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWVdOwpjb25zdCBhdXhEYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShhdXhEYXRhVXJsKTsKY29uc3QgYXV4RmlsZW5hbWUgPSBgJHtlZ2dOYW1lfV92JHtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWUgKyAxfS5hdXhgOwoKb3MuZG93bmxvYWQoYXV4RGF0YSwgYXV4RmlsZW5hbWUsICdhcHBsaWNhdGlvbi9qc29uJyk7JwCb1IWLC47lBQ9jbWREb3dubG9hZEluc3QCBACb1IWLC6PNB29AY29uc3QgYXJncyA9IHRoYXQ7Cgpvcy5kb3dubG9hZEJvdHMoZ2V0Qm90cyhieU1vZCh7IHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGwgfSkpLCBvcy5nZXRDdXJyZW50SW5zdCgpKTsnAJvUhYsLjuUFBnNlYXJjaAIEAJvUhYsLk84HKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAJvUhYsLjuUFBXV0aWxzAgQAm9SFiwu6zgco8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAm9SFiwuO5QUJY21kU3lzdGVtAgQAm9SFiwvhzgeRB0Bjb25zdCBhcmdzID0gdGhhdDsKCmNvbnN0IHNhbWVXaW5kb3cgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ0ZsYWcoYXJncywgJy13Jyk7CgpsZXQgc3lzdGVtVGFnTmFtZSA9IG51bGw7CgppZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgIHN5c3RlbVRhZ05hbWUgPSBhcmdzLmpvaW4oJyAnKTsKfQoKaWYgKHNhbWVXaW5kb3cpIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiB0aGUgY3VycmVudCB3aW5kb3cuCiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1Qb3J0YWwgPSB0cnVlOwogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtVGFnTmFtZSA9IHN5c3RlbVRhZ05hbWU7Cn0gZWxzZSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gYSBuZXcgdGFiLgogICAgY29uc3QgdXJsID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpOwoKICAgIC8vIFJlbW92ZSBhbnkgcG9ydGFscyB0aGF0IGFyZSBzZXQgaW4gdGhlIFVSTC4KICAgIGxldCBwYXJhbXMgPSB1cmwuc2VhcmNoUGFyYW1zLmtleXMoKTsKICAgIGZvciAobGV0IHBhcmFtIG9mIHBhcmFtcykgewogICAgICAgIGlmIChwYXJhbS5lbmRzV2l0aCgnUG9ydGFsJykpIHsKICAgICAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUocGFyYW0pOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBUdXJuIG9uIHRoZSBzeXN0ZW0gcG9ydGFsLgogICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3N5c3RlbVBvcnRhbCcsICd0cnVlJyk7CiAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZSgnc3lzdGVtVGFnTmFtZScpOwoKICAgIGlmIChzeXN0ZW1UYWdOYW1lKSB7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3N5c3RlbVRhZ05hbWUnLCBzeXN0ZW1UYWdOYW1lKTsKICAgIH0KCiAgICBvcy5vcGVuVVJMKHVybC5ocmVmKTsKfQonAJvUhYsLjuUFDWFiQ2hhdEJhck9wZW4CBACb1IWLC/PVB50CQGNvbnN0IHsKICAgIHByZWZpbGwsCn0gPSB0aGF0ID8/IHt9CgptYXNrcy5jaGF0T3BlbiA9IHRydWU7Cgpvcy5zaG93Q2hhdCh7CiAgICBwbGFjZWhvbGRlcjogJz4gLmhlbHAgdG8gc2VlIGF2YWlsYWJsZSBjb21tYW5kcycsCiAgICBiYWNrZ3JvdW5kQ29sb3I6ICcjMmYyZjJmJywKICAgIGZvcmVncm91bmRDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VDb2xvciwKICAgIHBsYWNlaG9sZGVyQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwcmVmaWxsCn0pJwCb1IWLC47lBQ5hYkNoYXRCYXJDbG9zZQIEAJvUhYsLkdgHdkBtYXNrcy5jaGF0T3BlbiA9IGZhbHNlOwpvcy5oaWRlQ2hhdCgpOwoKLy8gR2l2ZSBDYXN1YWxPUyBhIGNoYW5nZSB0byBhY3R1YWxseSByZW1vdmUgdGhlIGNoYXQgYmFyLgphd2FpdCBvcy5zbGVlcCgwKTsA"}]}