{"version":2,"updates":[{"id":0,"timestamp":1761665892614,"update":"AZcE8fbqrg0AJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwDx9uquDQAGc3lzdGVtAgQA8fbqrg0BDWFiLnNoZWxsLmdyaWQnAPH26q4NAARmb3JtAgQA8fbqrg0PB25vdGhpbmcnAPH26q4NAAxvbkFueUJvdERyYWcCBADx9uquDRe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAPH26q4NAAhyZW1lbWJlcgIEAPH26q4N0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA8fbqrg0ACGFiSWdub3JlAgQA8fbqrg36AQR0cnVlJwDx9uquDQAHYWJTaGVsbAIEAPH26q4N/wEEdHJ1ZScA8fbqrg0ACWFiVmVyc2lvbgIEAPH26q4NhAIFMTAuMjknAPH26q4NAAVmb2N1cwIEAPH26q4NigKrBEAvL3Nob3V0KCJmb2N1cyIsIHtib3Q6IGJvdCwgcG9zaXRpb246e3g6IHgsIHk6IHl9fSk7Cgpjb25zdCBmb2N1c1R5cGUgPSB0aGF0LmJvdCA/ICJib3QiIDogInBvc2l0aW9uIjsKY29uc3QgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uOwpjb25zdCB6b29tID0gdGhhdC56b29tID8/IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IDIwMDAgOiAxMDsKY29uc3Qgcm90YXRpb24gPSB0aGF0LnJvdGF0aW9uID8/IHt4OiA0NSwgeTogNDV9Owpjb25zdCBlYXNpbmcgPSB0aGF0LmVhc2luZyA/PyB7dHlwZTogImxpbmVhciIsIG1vZGU6ICJpbm91dCJ9Owpjb25zdCBmb2N1c09wdGlvbnMgPSB7CiAgICB6b29tOiB6b29tLAogICAgcm90YXRpb246IHJvdGF0aW9uLAogICAgZWFzaW5nOiBlYXNpbmcsCiAgICBkdXJhdGlvbjogZHVyYXRpb24KfTsKCmlmIChmb2N1c1R5cGUgPT0gImJvdCIpCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5ib3QsIGZvY3VzT3B0aW9ucykKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScA8fbqrg22BgZzeXN0ZW0CBADx9uquDbcGE2FiLnNoZWxsLmNvbXBvbmVudHMnAPH26q4NtgYMQXBwQ29udGFpbmVyAgQA8fbqrg3LBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycA8fbqrg22BghUZXh0TGluawIEAPH26q4N+AqjA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwDx9uquDbYGBldpbmRvdwIEAPH26q4NnA62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAPH26q4NtgYMVGV4dExpbmsuY3NzAgQA8fbqrg3TEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwDx9uquDbYGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAPH26q4NwRJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAPH26q4NtgYKV2luZG93LmNzcwIEAPH26q4NsxOoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAPH26q4NtgYIcmVtZW1iZXICBADx9uquDdwWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAPH26q4NtgYIYWJJZ25vcmUCBADx9uquDYMXBHRydWUnAPH26q4NtgYHYWJTaGVsbAIEAPH26q4NiBcEdHJ1ZScA8fbqrg22BglhYlZlcnNpb24CBADx9uquDY0XBTEwLjI5JwDx9uquDbYGC3BlcnNvbmFsaXR5AgQA8fbqrg2TFyjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwEEYm90cyQyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWIBJwDx9uquDboXB0FwcC5jc3MCBADx9uquDbsXyhY6cm9vdCB7CiAgLS1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIC0tb24tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAtLWFiLWNvbnNvbGUtaGVpZ2h0OiAzM3ZoOwp9Ci8qIERhcmsgbW9kZSBzdXBwb3J0ICovCkBtZWRpYSAocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIHsKICA6cm9vdCB7CiAgICAtLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgICAtLW9uLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgfQp9CgouYWItY29uc29sZS1idG4gewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogaW5oZXJpdDsKICBsZXR0ZXItc3BhY2luZzogaW5oZXJpdDsKICBsaW5lLWhlaWdodDogaW5oZXJpdDsKICB0ZXh0LXRyYW5zZm9ybTogaW5oZXJpdDsKICB0ZXh0LWluZGVudDogaW5oZXJpdDsKICB0ZXh0LXNoYWRvdzogaW5oZXJpdDsKICBiYWNrZ3JvdW5kLWNvbG9yOiBpbmhlcml0OwogIG1hcmdpbjogaW5oZXJpdDsKICBwYWRkaW5nLWJsb2NrOiBpbmhlcml0OwogIHBhZGRpbmctaW5saW5lOiBpbmhlcml0OwogIGJvcmRlcjogbm9uZTsKICB0cmFuc2Zvcm06IHNjYWxlKDEuMik7Cn0KCi5hYi1jb25zb2xlIHsKICB3aWR0aDogMTAwdnc7CiAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICBwYWRkaW5nOiAwOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCkgYnJpZ2h0bmVzcygyMDAlKTsKICBhbmltYXRpb24tbmFtZTogc2xpZGUtYXBwLWluOwogIGFuaW1hdGlvbi1kdXJhdGlvbjogMC41czsKICBvdmVyZmxvdy15OiBoaWRkZW47CiAgei1pbmRleDogMTsKfQoKLmFiLWNvbnNvbGU6OmFmdGVyIHsKICBjb250ZW50OiAiIjsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgdG9wOiAwOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgYm90dG9tOiAwOwogIG9wYWNpdHk6IDAuOTsKICB6LWluZGV4OiAwOwp9CgpAa2V5ZnJhbWVzIHNsaWRlLWFwcC1pbiB7CiAgZnJvbSB7CiAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBjdWJpYy1iZXppZXIoLjYsMCwuNzksMS4wMyk7CiAgICAvKiB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMTEwJSk7ICovCiAgICAvKiBoZWlnaHQ6IDBweDsgKi8KICAgIC8qIG1pbi1oZWlnaHQ6IDBweDsgKi8KICAgIG1heC1oZWlnaHQ6IDBweDsKICB9CgogIHRvIHsKICAgIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICAgIC8qIG1pbi1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsgKi8KICB9Cn0KCi5hYi1jb25zb2xlID4gZGl2IHsKICB6LWluZGV4OiAxOwogIHBvc2l0aW9uOiByZWxhdGl2ZQp9CgouYWItY29uc29sZS10b3AtYmFyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICB3aWR0aDogMTAwJTsKICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgZGlzcGxheTogZmxleDsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGp1c3RpZnktY29udGVudDogZW5kOwogIHBhZGRpbmc6IDAuNXJlbTsKfQoKLmFiLWNvbnNvbGUtbG9nIHsKICBvdmVyZmxvdy15OiBhdXRvOwogIGZsZXgtZ3JvdzogMTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW4tcmV2ZXJzZTsKICBtaW4taGVpZ2h0OiAyNHB4OwogIHBhZGRpbmc6IDAgMXJlbTsKICBjdXJzb3I6IHBvaW50ZXI7CiAgb3ZlcnNjcm9sbC1iZWhhdmlvcjogY29udGFpbjsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgY3Vyc29yOiBpbml0aWFsOwp9CgouYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciB7CiAgbWFyZ2luOiAwLjVyZW0gMDsKfQouYWItY29uc29sZS1tZXNzYWdlIHsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiByb3c7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKfQoKLmFiLWNvbnNvbGUtc3BhY2VyIHsKICBmbGV4LXNocmluazogMDsKICBmbGV4LWdyb3c6IDE7Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIG1heC13aWR0aDogODB2dzsKICBib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5hYi1jb25zb2xlLXRpbWVzdGFtcCB7CiAgb3BhY2l0eTogMC42Owp9CgouY29uc29sZS1zZW5kLWJ0biB7CiAgbWFyZ2luOiAwICFpbXBvcnRhbnQ7CiAgcGFkZGluZzogMCAxcmVtICFpbXBvcnRhbnQ7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9CgouY29uc29sZS1zZW5kLWJ0biA+IHNwYW4gewogIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgzcHgpCn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGdhcDogMC43NXJlbTsKICBtYXJnaW46IDAuNXJlbSAxcmVtOwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCi5hYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciA+IGlucHV0IHsKICBiYWNrZ3JvdW5kOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgZmxleC1ncm93OiAxOwogIG91dGxpbmU6IG5vbmU7CiAgYm9yZGVyOiBub25lOwogIHBhZGRpbmc6IDFyZW07CiAgYm9yZGVyLXJhZGl1czogNHB4Owp9JwDx9uquDboXBmdldEFwcAIEAPH26q4Nhi7dI0Bjb25zdCB7IHVzZUVmZmVjdCwgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZVJlZiB9ID0gb3MuYXBwSG9va3MKY29uc3QgVG9wQmFyID0gdGhpc0JvdC5Ub3BCYXIoKTsKY29uc3QgTWVzc2FnZSA9IHRoaXNCb3QuTWVzc2FnZSgpOwoKY29uc3QgQXBwID0gKCkgPT4gewogICAgY29uc3QgW3BvaW50ZXJEb3duUG9zLCBzZXRQb2ludGVyRG93blBvc10gPSB1c2VTdGF0ZSh7eDogLTEsIHk6IC0xfSk7CiAgICBjb25zdCBbY29uc29sZUxvZywgc2V0Q29uc29sZUxvZ10gPSB1c2VTdGF0ZShbXSk7CiAgICBjb25zdCBbc2hvd0NoYXQsIHNldFNob3dDaGF0XSA9IHVzZVN0YXRlKHRhZ3Muc2hvd0NoYXRJbnB1dCk7CiAgICBjb25zdCBbdXNlcklucHV0LCBzZXRVc2VySW5wdXRdID0gdXNlU3RhdGUoJycpOwogICAgY29uc3QgW3Nob3dBbGwsIHNldFNob3dBbGxdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgaW5wdXRSZWYgPSB1c2VSZWYoKTsKCiAgICBjb25zdCB1cGRhdGVMb2cgPSAoKSA9PiB7CiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGJvdHMgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkczsKICAgICAgICBjb25zdCBtZXNzYWdlTG9nQXJyID0gW107CgogICAgICAgIGZvciAoY29uc3QgYm90SUQgb2YgYm90cykgewogICAgICAgICAgICBjb25zdCBtZXNzYWdlQm90ID0gZ2V0Qm90KCJpZCIsIGJvdElEKTsKICAgICAgICAgICAgaWYgKG1lc3NhZ2VCb3QpIHsKICAgICAgICAgICAgICAgIG1lc3NhZ2VMb2dBcnIucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZUJvdC50YWdzLm1lc3NhZ2UsCiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wOiBtZXNzYWdlQm90LnRhZ3MudGltZXN0YW1wLAogICAgICAgICAgICAgICAgICAgIG5hbWU6IG1lc3NhZ2VCb3QudGFncy5uYW1lCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBtZXNzYWdlTG9nQXJyLnNvcnQoIChhLCBiKSA9PiBuZXcgRGF0ZShhLnRpbWVzdGFtcCkgPCBuZXcgRGF0ZShiLnRpbWVzdGFtcCkgPyAxIDogLTEgKTsKCiAgICAgICAgc2V0Q29uc29sZUxvZyhtZXNzYWdlTG9nQXJyKTsKICAgIH0KCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIHRoaXNCb3QudmFycy51cGRhdGVMb2cgPSB1cGRhdGVMb2c7CiAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBzZXRTaG93QWxsOwoKICAgICAgICB1cGRhdGVMb2coKTsKCiAgICAgICAgcmV0dXJuICgoKSA9PiB7CiAgICAgICAgICAgIHRoaXNCb3QudmFycy51cGRhdGVMb2cgPSBudWxsOwogICAgICAgICAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCA9IG51bGw7CiAgICAgICAgfSk7CiAgICB9LCBbXSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoaW5wdXRSZWYuY3VycmVudCkgaW5wdXRSZWYuY3VycmVudC5mb2N1cygpOwogICAgfSwgW3Nob3dDaGF0XSk7CgogICAgY29uc3QgaGFuZGxlUG9pbnRlckRvd24gPSAoZSkgPT4gewogICAgICAgIHNldFBvaW50ZXJEb3duUG9zKHsKICAgICAgICAgICAgeDogZS5jbGllbnRYLAogICAgICAgICAgICB5OiBlLmNsaWVudFksCiAgICAgICAgfSkKICAgIH0KCiAgICBjb25zdCBoYW5kbGVQb2ludGVyVXAgPSAoZSkgPT4gewogICAgICAgIGNvbnN0IGRpZmZYID0gTWF0aC5hYnMoZS5jbGllbnRYIC0gcG9pbnRlckRvd25Qb3MueCk7CiAgICAgICAgY29uc3QgZGlmZlkgPSBNYXRoLmFicyhlLmNsaWVudFkgLSBwb2ludGVyRG93blBvcy55KTsKCiAgICAgICAgaWYgKGRpZmZYIDwgNSAmJiBkaWZmWSA8IDUpIHsKICAgICAgICAgICAgc2V0U2hvd0FsbChzID0+ICFzKTsKICAgICAgICB9CgogICAgICAgIHNldFBvaW50ZXJEb3duUG9zKHt4OiAtMSwgeTogLTF9KTsKICAgIH0KCiAgICBjb25zdCBoYW5kbGVTdWJtaXQgPSAoKSA9PiB7CiAgICAgICAgaWYgKHVzZXJJbnB1dCkgewogICAgICAgICAgICB3aGlzcGVyKGdldEJvdCgnc3lzdGVtJywgJ2FiLmFjdGlvbi5hc2snKSwgJ2FiQ29yZU1lbnVBY3Rpb24nLCB1c2VySW5wdXQpCiAgICAgICAgICAgIHNldFVzZXJJbnB1dCgnJyk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJpbnB1dFJlZjoiLCBpbnB1dFJlZi5jdXJyZW50KTsKICAgICAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQudmFsdWUgPSAnJzsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxzdHlsZT57dGFnc1snQXBwLmNzcyddfTwvc3R5bGU+CgogICAgICAgIDxkaXYKICAgICAgICAgICAgaWQ9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZSIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eyhlKSA9PiB7CiAgICAgICAgICAgICAgICBncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbFpvb21hYmxlID0gZmFsc2U7CiAgICAgICAgICAgIH19CiAgICAgICAgICAgIG9uUG9pbnRlckxlYXZlPXsoZSkgPT4gewogICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0LmlkID09ICJhYi1jb25zb2xlIil7CiAgICAgICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IHRydWU7IAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9fQogICAgICAgID4KICAgICAgICAgICAge3RhZ3Muc2hvd1RvcEJhciAmJiA8VG9wQmFyIC8+fQoKICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWxvZyIKICAgICAgICAgICAgICAgIG9uUG9pbnRlckRvd249e2hhbmRsZVBvaW50ZXJEb3dufQogICAgICAgICAgICAgICAgb25Qb2ludGVyVXA9e2hhbmRsZVBvaW50ZXJVcH0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgey8qIE1lc3NhZ2UgaGlzdG9yeSAqLyBBcnJheS5pc0FycmF5KGNvbnNvbGVMb2cpCiAgICAgICAgICAgICAgICA/IHNob3dBbGwKICAgICAgICAgICAgICAgICAgICA/IGNvbnNvbGVMb2cubWFwKChtLCBpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbSB8fCAhbS50aW1lc3RhbXAgfHwgIW0ubWVzc2FnZSkgeyByZXR1cm4gfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA9e20udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U9e20ubWVzc2FnZX0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXttLm5hbWV9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PXtgbWVzc2FnZS0ke2l9YH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICAgICAgICAgICl9KQogICAgICAgICAgICAgICAgICAgIDogPE1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXtjb25zb2xlTG9nWzBdPy50aW1lc3RhbXB9CiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U9e2NvbnNvbGVMb2dbMF0/Lm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9e2NvbnNvbGVMb2dbMF0/Lm5hbWV9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgIDogPD48Lz59CgogICAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICAgICAgICB7c2hvd0NoYXQgJiYKICAgICAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtaW5wdXQtY29udGFpbmVyIgogICAgICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgICAgIDxpbnB1dAogICAgICAgICAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj0iYXNrIGFiLTEiCiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXtlID0+IHNldFVzZXJJbnB1dChlLnRhcmdldC52YWx1ZSl9CiAgICAgICAgICAgICAgICAgICAgICAgIG9uS2V5RG93bj17ZSA9PiB7IGlmIChlLmtleSA9PT0gJ0VudGVyJykgaGFuZGxlU3VibWl0KCkgfX0KICAgICAgICAgICAgICAgICAgICAgICAgcmVmPXtpbnB1dFJlZn0KICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBjb25zb2xlLXNlbmQtYnRuIG1kLWljb24gbWQtaWNvbi1mb250IgogICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXtoYW5kbGVTdWJtaXR9CiAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6ICc0MHB4JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAnNDhweCcsCiAgICAgICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICAgICAgPnNlbmQ8L2J1dHRvbj4KICAgICAgICAgICAgICAgIDwvZGl2Pn0KICAgICAgICA8L2Rpdj4KICAgIDwvPikKfQoKcmV0dXJuIEFwcAonAPH26q4NuhcLaGlkZUNvbnNvbGUCBADx9uquDeRRnwFAdmFyIGN1cnJlbnRWZXIgPSBtYXNrcy5jb25zb2xlVmVyc2lvbiA/PyAwOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gKTsKbWFza3Mub3BlbiA9IGZhbHNlOwpncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbFpvb21hYmxlID0gbnVsbDsnAPH26q4NuhcDbG9nAgQA8fbqrg2EU4UJQGxldCBib3RUYWdzID0ge307Cgpjb25zdCBfdGltZXN0YW1wID0gb3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZQoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgY29uc3QgX21lc3NhZ2VUZXh0ID0gU3RyaW5nKHRoYXQpLnNwbGl0KCc6ICcpOwogICAgY29uc3QgX25hbWUgPSBfbWVzc2FnZVRleHQuc2hpZnQoKTsKCiAgICBpZiAoIXRoYXQuaW5jbHVkZXMoJzogJykpIHsKICAgICAgICBib3RUYWdzID0gewogICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgIG5hbWU6ICIiLAogICAgICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiBfbmFtZSwKICAgICAgICAgICAgbWVzc2FnZTogX21lc3NhZ2VUZXh0LmpvaW4oJzogJyksCiAgICAgICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICAgICAgdGltZXN0YW1wOiBfdGltZXN0YW1wLAogICAgICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiCiAgICAgICAgfQogICAgfQoKfSBlbHNlIHsKICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiLAogICAgICAgIC4uLnRoYXQKICAgIH0KfQoKY29uc3QgbG9nQm90ID0gYXdhaXQgY3JlYXRlKGJvdFRhZ3MpOwoKc2hvdXQoIm9uQUJMb2ciLCBsb2dCb3QpOwoKaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAPH26q4NuhcLc2hvd0NvbnNvbGUCBADx9uquDYpc7QNAaWYgKG1hc2tzLm9wZW4pIHsgcmV0dXJuIH07Cgpjb25maWdCb3QubWFza3MudGFnUG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbFNwYWNlID0gbnVsbDsKCi8vIFVucmVnaXN0ZXIgaW4gY2FzZSBpdCB3YXMgYWxyZWFkeSBvcGVuCnZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7CgpjdXJyZW50VmVyICs9IDE7Cm1hc2tzLmNvbnNvbGVWZXJzaW9uID0gY3VycmVudFZlcjsKLy8gR2V0LCByZWdpc3RlciwgYW5kIGNvbXBpbGUgdGhlIGFwcApjb25zdCBBcHAgPSB0aGlzQm90LmdldEFwcCgpOwphd2FpdCBvcy5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCwgdGhpc0JvdCk7Cm9zLmNvbXBpbGVBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIDxBcHAgLz4pOwptYXNrcy5vcGVuID0gdHJ1ZTsKJwDx9uquDboXBnN5c3RlbQIEAPH26q4N+F8QYWIuc2hlbGwuY29uc29sZScA8fbqrg26Fw10b2dnbGVDb25zb2xlAgQA8fbqrg2JYJYBQGlmIChtYXNrcy5vcGVuKSB7CiAgICB3aGlzcGVyKHRoaXNCb3QsICJoaWRlQ29uc29sZSIpOwogICAgbWFza3Mub3BlbiA9IGZhbHNlOwp9IGVsc2UgewogICAgd2hpc3Blcih0aGlzQm90LCAic2hvd0NvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSB0cnVlOwp9JwDx9uquDboXBGZvcm0CBADx9uquDaBhB25vdGhpbmcnAPH26q4NuhcHYWJTaGVsbAIEAPH26q4NqGEEdHJ1ZScA8fbqrg26FwphYklET3JpZ2luAgQA8fbqrg2tYRVhYkNvbnNvbGUgdXBkYXRlIDctMTYnAPH26q4NuhcGVG9wQmFyAgQA8fbqrg3DYfMEQGNvbnN0IG9mZnNldCA9IDgKY29uc3QgaW5pdGlhbEhlaWdodCA9IDI1Ngpjb25zdCBkcmFnSW50ZXJ2YWwgPSAyNQoKY29uc3QgQnV0dG9uc0JhciA9ICgpID0+IHsKCiAgICBjb25zdCBoYW5kbGVDbG9zZSA9ICgpID0+IHsKICAgICAgICBzaG91dCgnaGlkZUNvbnNvbGUnKTsKICAgIH0KCiAgICByZXR1cm4gKDw+CiAgICAgICAgPGRpdgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtdG9wLWJhciIKICAgICAgICA+CgogICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtYnRuIG1kLWljb24gbWQtaWNvbi1mb250IgogICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlQ2xvc2V9CiAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgIHRvcDogIjhweCIsCiAgICAgICAgICAgICAgICAgICAgcmlnaHQ6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHpJbmRleDogMiwKICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIGNsb3NlCiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAKICAgICAgICA8L2Rpdj4KICAgIDwvPikKfQoKcmV0dXJuIEJ1dHRvbnNCYXIKJwDx9uquDboXDXNob3dDaGF0SW5wdXQCBADx9uquDbdmBWZhbHNlJwDx9uquDboXCnNob3dUb3BCYXICBADx9uquDb1mBWZhbHNlJwDx9uquDboXCWFiVmVyc2lvbgIEAPH26q4Nw2YFMTAuMjknAPH26q4NuhcSc2V0QWJFeHBhbmRDb25zb2xlAgQA8fbqrg3JZpcCQGNvbnNvbGUubG9nKHRoaXNCb3QudmFycy5zZXRTaG93QWxsKQppZiAodHlwZW9mIHRoaXNCb3QudmFycy5zZXRTaG93QWxsICE9PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHMgPT4gIXMpOwp9IGVsc2UgaWYgKHRoYXQgPT0gdHJ1ZSkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwodHJ1ZSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChmYWxzZSk7Cn0KJwDx9uquDboXCGFiSWdub3JlAgQA8fbqrg3haAR0cnVlJwDx9uquDboXB01lc3NhZ2UCBADx9uquDeZowRBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPnttZXNzYWdlfTwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIE1lc3NhZ2U7JwDx9uquDboXEG9uQW55Qm90c1JlbW92ZWQCBADx9uquDah5rQJAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90SWQgb2YgYm90SURzKSB7DQogICAgaWYgKHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5kZWxldGUoYm90SWQpOw0KDQogICAgICAgIGlmIChkZWxldGVkKSB7DQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3RJZDogYm90SWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9JwDx9uquDboXDm9uQW55Qm90c0FkZGVkAgQA8fbqrg3We/gDQGNvbnN0IHsgYm90cyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBuZXdCb3Qgb2YgYm90cykgew0KICAgIGlmIChuZXdCb3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMobmV3Qm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKG5ld0JvdC5pZCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IG5ld0JvdCB9KTsNCiAgICB9DQp9JwDx9uquDboXEG9uQW55Qm90c0NoYW5nZWQCBADx9uquDc9/4wVAY29uc3QgYm90cyA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90IG9mIGJvdHMpIHsNCiAgICBpZiAoYm90LmJvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhib3QuYm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKGJvdC5ib3QuaWQpOw0KDQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBib3QuYm90IH0pOw0KICAgICAgICB9IA0KDQogICAgICAgIGlmIChib3QudGFncy5pbmNsdWRlcygibWVzc2FnZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJuYW1lIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoInRpbWVzdGFtcCIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIpKSB7DQogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOyAgICAgICAgDQogICAgICAgIH0NCiAgICB9DQp9JwDx9uquDboXH29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQCBADx9uquDbOFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAPH26q4Nuhcdb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQCBADx9uquDeqFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAQRib3RzJDI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYwEnAPH26q4NoYYBBnN5c3RlbQIEAPH26q4NooYBDWFiLnNoZWxsLmhlbHAnAPH26q4NoYYBCW9uS2V5RG93bgIEAPH26q4NsIYBiAJAaWYgKHRhZ3MuYWN0aXZlICYmIHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJykpIHsKICAgIGlmICh0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgIGZvciAobGV0IGNhbGxiYWNrIG9mIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0nAPH26q4NoYYBB3VubW91bnQCBADx9uquDbmIAY4BQGF3YWl0IG9zLmNvbXBpbGVBcHAodGFncy5hcHBJZCwgPD48Lz4pOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKHRhZ3MuYXBwSWQpOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSB1bmRlZmluZWQ7Cm1hc2tzLmFjdGl2ZSA9IGZhbHNlOycA8fbqrg2hhgEJc3R5bGUuY3NzAgQA8fbqrg3IiQHxBy5oZWxwLXRhYmxlIHsKICB3aWR0aDogMTAwJTsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLmhlbHAtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5oZWxwLXRhYmxlIHRkIGgzIHsKICBtYXJnaW46IDA7Cn0KCi5oZWxwLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9Cgouc2VjdGlvbiB7CiAgbWFyZ2luLXRvcDogMTZweDsKfQoKLnNlY3Rpb24gcDpmaXJzdC1vZi10eXBlIHsKICBtYXJnaW4tdG9wOiA0cHg7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5kZXNjcmlwdGlvbiB7IAogIHdoaXRlLXNwYWNlOiBwcmUtbGluZTsKfQoKLnVzYWdlLXRhYmxlIHsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLnVzYWdlLXRhYmxlIHRkLGgzIHsgCiAgdmVydGljYWwtYWxpZ246IHRvcDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgbWFyZ2luOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogNjBweDsKfQoKLmFyZ3MtdGFibGUgewogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouYXJncy10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmFyZ3MtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCksIChtYXgtaGVpZ2h0OiA2MDBweCkgewogIC5oZWxwLXdpbmRvdyB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGxlZnQ6IHVuc2V0OwogICAgdG9wOiB1bnNldDsKICAgIHRyYW5zZm9ybTogdW5zZXQ7CiAgICBtYXgtd2lkdGg6IHVuc2V0OwogICAgbWF4LWhlaWdodDogdW5zZXQ7CiAgICBib3gtc2hhZG93OiB1bnNldDsKICB9Cn0nAPH26q4NoYYBCW9uRGVzdHJveQIEAPH26q4NupEBE0B0aGlzQm90LnVubW91bnQoKTsnAPH26q4NoYYBBW1vdW50AgQA8fbqrg3OkQHxAkBjb25zdCB7CiAgICBhYkNvbW1hbmRzTWFuYWdlciwKICAgIHNlbGVjdGVkQ29tbWFuZAp9ID0gdGhhdCA/PyB7fTsKCmlmIChtYXNrcy5hY3RpdmUpIHsKICAgIGF3YWl0IHRoaXNCb3QudW5tb3VudCgpOwp9Cgpjb25zdCBBcHAgPSB0aGlzQm90LkFwcCgpOwoKYXdhaXQgb3MucmVnaXN0ZXJBcHAodGFncy5hcHBJZCwgdGhpc0JvdCk7CmF3YWl0IG9zLmNvbXBpbGVBcHAodGFncy5hcHBJZCwgPEFwcCBjb21tYW5kcz17YWJDb21tYW5kc01hbmFnZXIuY29tbWFuZHN9IGluaXRpYWxTZWxlY3RlZENvbW1hbmQ9e3NlbGVjdGVkQ29tbWFuZH0vPik7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IFtdOwptYXNrcy5hY3RpdmUgPSB0cnVlOycA8fbqrg2hhgEKY29tcG9uZW50cwIEAPH26q4NwJQBKPCflJcxMWM5NWM3ZC1hMTkzLTQwMGUtYjcxMC0zYmEwNDg2YTZhMWEnAPH26q4NoYYBBXV0aWxzAgQA8fbqrg3nlAEo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycA8fbqrg2hhgEIYWJJZ25vcmUCBADx9uquDY6VAQR0cnVlJwDx9uquDaGGAQdhYlNoZWxsAgQA8fbqrg2TlQEEdHJ1ZScA8fbqrg2hhgEJYWJWZXJzaW9uAgQA8fbqrg2YlQEFMTAuMjknAPH26q4NoYYBA0FwcAIEAPH26q4NnpUBsi9AY29uc3QgQXBwQ29udGFpbmVyID0gbGlua3MuY29tcG9uZW50cy5BcHBDb250YWluZXIoKTsKY29uc3QgV2luZG93ID0gbGlua3MuY29tcG9uZW50cy5XaW5kb3coKTsKY29uc3QgVGV4dExpbmsgPSBsaW5rcy5jb21wb25lbnRzLlRleHRMaW5rKCk7CmNvbnN0IGNzcyA9IGxpbmtzLnV0aWxzLmFiQ29tcGlsZUNTUyhbIHRoaXNCb3QsIGxpbmtzLmNvbXBvbmVudHMgXSk7Cgpjb25zdCB7IHVzZVN0YXRlLCB1c2VFZmZlY3QsIHVzZUNhbGxiYWNrLCB1c2VSZWYsIHVzZU1lbW8gfSA9IG9zLmFwcEhvb2tzOwoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBDb21tYW5kPn0gcHJvcHMuY29tbWFuZHMKICovCmNvbnN0IEF2YWlsYWJsZUNvbW1hbmRzID0gKHsgY29tbWFuZHMsIG9uQ29tbWFuZENsaWNrIH0pID0+IHsKICAgIGNvbnN0IGNvbW1hbmROYW1lcyA9IE9iamVjdC5rZXlzKGNvbW1hbmRzKS5zb3J0KCk7CgogICAgY29uc3Qgb25DbG9zZSA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgIH0sIFtdKTsKICAgIAogICAgcmV0dXJuICgKICAgICAgICA8PgogICAgICAgICAgICA8cD48VGV4dExpbmsgb25DbGljaz17b25DbG9zZX0+eyd4IENsb3NlJ308L1RleHRMaW5rPjwvcD4KICAgICAgICAgICAgPGgyPkF2YWlsYWJsZSBDb21tYW5kczwvaDI+CiAgICAgICAgICAgIDxwPlVzYWdlOiAuY29tbWFuZCBbb3B0aW9uc108L3A+CiAgICAgICAgICAgIDxici8+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2hlbHAtdGFibGUnPgogICAgICAgICAgICAgICAge2NvbW1hbmROYW1lcy5tYXAoKG5hbWUpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21tYW5kID0gY29tbWFuZHNbbmFtZV07CgogICAgICAgICAgICAgICAgICAgIGxldCBkZXNjcmlwdGlvbiA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48VGV4dExpbmsgb25DbGljaz17KCkgPT4gb25Db21tYW5kQ2xpY2soY29tbWFuZC5uYW1lKX0+e2NvbW1hbmQubmFtZX08L1RleHRMaW5rPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2Rlc2NyaXB0aW9ufTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSl9CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtDb21tYW5kfSBwcm9wcy5jb21tYW5kCiAqLwpjb25zdCBTcGVjaWZpY0NvbW1hbmQgPSAoeyBjb21tYW5kLCBvbkJhY2sgfSkgPT4gewogICAgbGV0IHVzYWdlID0gJyc7CiAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwogICAgbGV0IGFyZ3MgPSBudWxsOwoKICAgIGlmIChjb21tYW5kLmhlbHApIHsKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLnVzYWdlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbW1hbmQuaGVscC51c2FnZSkpIHsKICAgICAgICAgICAgICAgIHVzYWdlID0gY29tbWFuZC5oZWxwLnVzYWdlLmpvaW4oJ1xuJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5sb25nRGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uOwogICAgICAgIH0gZWxzZSBpZiAoY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAuYXJncyAmJiBjb21tYW5kLmhlbHAuYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGFyZ3MgPSBjb21tYW5kLmhlbHAuYXJnczsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4gIAogICAgICAgICAgICA8cD48VGV4dExpbmsgb25DbGljaz17b25CYWNrfT57JzwgQmFjayd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj57Y29tbWFuZC5uYW1lfTwvaDI+CiAgICAgICAgICAgIHsgdXNhZ2UgJiYKICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J3VzYWdlLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48aDM+VXNhZ2U6PC9oMz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e3VzYWdlfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeyBkZXNjcmlwdGlvbiAmJiAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uJz4KICAgICAgICAgICAgICAgICAgICA8aDM+RGVzY3JpcHRpb246PC9oMz4KICAgICAgICAgICAgICAgICAgICA8cCBjbGFzc05hbWU9J2Rlc2NyaXB0aW9uJz57ZGVzY3JpcHRpb259PC9wPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeyBhcmdzICYmCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkFyZ3VtZW50czo8L2gzPgogICAgICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2FyZ3MtdGFibGUnPgogICAgICAgICAgICAgICAgICAgICAgICB7IGFyZ3MubWFwKChhcmcpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJnLmlkZW50aWZpZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFyZy5pZGVudGlmaWVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gYXJnLmlkZW50aWZpZXIuam9pbignLFxuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gYXJnLmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5kZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0Rlc2NyaXB0aW9uRGlzcGxheSA9IGFyZy5kZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdJZGVudGlmaWVyRGlzcGxheSA/PyAnJ308L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2FyZ0Rlc2NyaXB0aW9uRGlzcGxheSA/PyAnJ308L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgfQogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICA8Lz4KICAgICkKfQoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBDb21tYW5kPn0gcHJvcHMuY29tbWFuZHMKICogQHBhcmFtIHthbnlbXX0gW3Byb3BzLmFyZ3NdCiAqLwpjb25zdCBBcHAgPSAoeyBjb21tYW5kcywgaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCB9KSA9PiB7CiAgICBjb25zdCBbIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kIF0gPSB1c2VTdGF0ZShpbml0aWFsU2VsZWN0ZWRDb21tYW5kKTsKCiAgICAvLyBFc2NhcGUga2V5IHByZXNzIGV2ZW50IGhhbmRsZXIKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgY29uc3Qgb25Fc2NhcGVLZXlQcmVzcyA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkQ29tbWFuZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MucHVzaChvbkVzY2FwZUtleVByZXNzKTsKCiAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tJbmRleCA9IHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLmZpbmRJbmRleCgoY2FsbGJhY2spID0+IGNhbGxiYWNrID09PSBvbkVzY2FwZUtleVByZXNzKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3Muc3BsaWNlKGNhbGxiYWNrSW5kZXgsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgW3NlbGVjdGVkQ29tbWFuZF0pOwogICAgCiAgICBjb25zdCBvbkJhY2tncm91bmRDbGljayA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgIH0sIFtdKTsKCiAgICBjb25zdCBvbkNvbW1hbmRDbGljayA9IHVzZUNhbGxiYWNrKChuYW1lKSA9PiB7CiAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG5hbWUpOwogICAgfSwgW3NldFNlbGVjdGVkQ29tbWFuZF0pCgogICAgY29uc3QgY29udGVudCA9IHVzZU1lbW8oKCkgPT4gewogICAgICAgIGlmICghc2VsZWN0ZWRDb21tYW5kKSB7CiAgICAgICAgICAgIHJldHVybiA8QXZhaWxhYmxlQ29tbWFuZHMgY29tbWFuZHM9e2NvbW1hbmRzfSBvbkNvbW1hbmRDbGljaz17b25Db21tYW5kQ2xpY2t9Lz4KICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgcmV0dXJuIDxTcGVjaWZpY0NvbW1hbmQgY29tbWFuZD17Y29tbWFuZHNbc2VsZWN0ZWRDb21tYW5kXX0gb25CYWNrPXsoKSA9PiBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCl9Lz4KICAgICAgICB9CiAgICB9LCBbY29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kXSk7CgogICAgcmV0dXJuICgKICAgICAgICA8PgogICAgICAgICAgICA8c3R5bGU+e2Nzc308L3N0eWxlPgoKICAgICAgICAgICAgPEFwcENvbnRhaW5lciBvbkJhY2tncm91bmRDbGljaz17b25CYWNrZ3JvdW5kQ2xpY2t9PgogICAgICAgICAgICAgICAgPFdpbmRvdz4KICAgICAgICAgICAgICAgICAgICB7Y29udGVudH0KICAgICAgICAgICAgICAgIDwvV2luZG93PgogICAgICAgICAgICA8L0FwcENvbnRhaW5lcj4KICAgICAgICA8Lz4KICAgICkKfQoKcmV0dXJuIEFwcDsnAPH26q4NoYYBBWFwcElkAgQA8fbqrg3RxAEPYWItY29tbWFuZC1oZWxwJwEEYm90cyQzNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMBJwDx9uquDeHEAQZzeXN0ZW0CBADx9uquDeLEAQ9hYi5zaGVsbC5jcmVhdGUnAPH26q4N4cQBBGZvcm0CBADx9uquDfLEAQdub3RoaW5nJwDx9uquDeHEAQtkZXNjcmlwdGlvbgIEAPH26q4N+sQBPUJvdCB1c2VkIHRvIGNyZWF0ZS9tYW5pZmVzdCBib3RzIGludG8gYW4gYWN0dWFsIHNjZW5lL3BvcnRhbC4nAPH26q4N4cQBDGFiQ3JlYXRlQm90cwIEAPH26q4NuMUB7i9AbGV0IHsgCiAgICBpbml0aWFsQm9vdCwgLy8gY2hlY2tzIGZvciBpbml0aWFsIGJvb3QgYm9vbGVhbiAob3B0aW9uYWwpCiAgICBib3REYXRhLCAvLyBib3RzIHRvIGJlIGdlbmVyYXRlZAogICAgb3JpZ2luLCAvLyB3aGVyZSBkaWQgdGhlIGRhdGEgY29tZSBmcm9tIChvcHRpb25hbCkKICAgIHN0dWRpbywgLy8gd2hhdCBzdHVkaW8gaXMgdGhpcyBkYXRhIGZyb20gKG9wdGlvbmFsKQogICAgcmVjb3JkLCAvLyBSeWFuIENvb2s6IGRvIHdlIG5lZWQgdGhpcyBpZiB3ZSBhbHJlYWR5IGhhdmUgc3R1ZGlvPyAob3B0aW9uYWwpCiAgICB2ZXJzaW9uLCAvLyB2ZXJzaW9uIG9mIHRoZSBkYXRhIChvcHRpb25hbCkKICAgIGVnZ1BhcmFtZXRlcnMsIC8vIGRhdGEgdG8gcGFzcyB0byBhbGwgY3JlYXRlZCBib3RzIHZpYSBAb25FZ2dIYXRjaC4gKG9wdGlvbmFsKQogICAgaWdub3JlR3JpZEZvY3VzLCAvLyBSeWFuIENvb2s6IGFkZGluZyB0aGlzIGFzIGFuIG9wdGlvbmFsIGZsYWcuIChvcHRpb25hbCkKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgLy8gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBwcmVwcm9jZXNzIHRoZSBib3QgZGF0YSBiZWZvcmUgdGhlIGJvdHMgYXJlIGNyZWF0ZWQuIChvcHRpb25hbCkKICAgIHNvdXJjZUV2ZW50LCAvLyBzb3VyY2VFdmVudCBpcyBhbiBldmVudCBuYW1lIHRoYXQgc3ltYm9saXplcyB3aGF0IHRyaWdnZXJlZCB0aGlzIGNhbGwgdG8gYWJDcmVhdGVCb3RzLiAob3B0aW9uYWwpLgp9ID0gdGhhdDsKCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IGZvciB3aGVuIGFiQ3JlYXRlQm90cyBleHBlY3RlZCAiYm90cyIgcGFyYW1ldGVyLgppZiAoIWJvdERhdGEgJiYgdGhhdC5ib3RzKSB7CiAgICBib3REYXRhID0gdGhhdC5ib3RzOwp9CgpsZXQgYm90Q291bnQgPSBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGg7CmNvbnN0IGJvdERhdGFIYXNoT3JpZ2luYWwgPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBib3REYXRhKTsKY29uc3QgYWJHcmlkRm9jdXMgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKLy8gUnVuIHNvbWUgYWItc3BlY2lmaWMgcHJlcHJvY2Vzc2luZyBvZiBib3QgZGF0YS4KZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgZGF0YS50YWdzLmFiSURPcmlnaW4gPSBvcmlnaW47CiAgICAgICAgZGF0YS50YWdzLmFiSURTdHVkaW8gPSBzdHVkaW87CgogICAgICAgIGlmIChkYXRhLnRhZ3MuY3JlYXRvcikgewogICAgICAgICAgICBkYXRhLnRhZ3Mub2xkQ3JlYXRvciA9IGRhdGEudGFncy5jcmVhdG9yOwogICAgICAgIH0KCiAgICAgICAgLy8gUnlhbiBDb29rOiBUaGlzIHRhcmdldFBvc2l0aW9uIHN0dWZmIGlzIGFwcGFyZW50bHkgdXNlZCBmb3IgYm90IHBhc3Rpbmc/IAogICAgICAgIC8vIFRoaXMgaXMgc29tZSByZWFsbHkgY29uZnVzaW5nIGxvZ2ljIGFuZCBzaG91bGQgYmUgcmVmYWN0b3JlZCBldmVudHVhbGx5LgogICAgICAgIGlmICgoYm90Q291bnQgPCAyIHx8IGJvdENvdW50IDwgMyAmJiBib3REYXRhLmFiWFBCb3QgIT0gbnVsbCkgJiYgYWJHcmlkRm9jdXMgJiYgIWlnbm9yZUdyaWRGb2N1cykgewogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWCddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueDsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbiArICdZJ10gPSBhYkdyaWRGb2N1cy5wb3NpdGlvbi55OwogICAgICAgIH0KICAgIH0KfQoKLy8gRG8gYW5vdGhlciBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSB0aGUgYm90cyBhcmVhIGNyZWF0ZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhLCBvcmlnaW4sIHN0dWRpbywgcmVjb3JkLCB2ZXJzaW9uLCBlZ2dQYXJhbWV0ZXJzLCBpbml0aWFsQm9vdCwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZShwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlJywgcHJlcHJvY2Vzc0FyZykpOwoKaWYgKHR5cGVvZiBib3REYXRhICE9PSAnb2JqZWN0JyB8fCBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGggPT09IDApIHsKICAgIC8vIFRoZXJlIGlzbid0IGFueSBib3REYXRhIHRvIGNyZWF0ZSBmcm9tIQogICAgcmV0dXJuOwp9CgovLyBDcmVhdGUgYm90cyBmcm9tIHRoZSBib3QgZGF0YS4KbGV0IGlkTWFwID0gbmV3IE1hcCgpOwpsZXQgbmV3Qm90cyA9IFtdOwpsZXQgbmV3Qm90SWRzID0gW107Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MpIHsKICAgICAgICB0cnkgeyAKICAgICAgICAgICAgY29uc3QgbmV3Qm90ID0gY3JlYXRlKGRhdGEudGFncyk7CgogICAgICAgICAgICBpZE1hcC5zZXQoZGF0YS5pZCwgbmV3Qm90LmlkKTsKICAgICAgICAgICAgbmV3Qm90cy5wdXNoKG5ld0JvdCk7CiAgICAgICAgICAgIG5ld0JvdElkcy5wdXNoKG5ld0JvdC5pZCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGludmFsaWQgYm90YCwgZSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraXBwZWQgYm90OiBgLCBkYXRhKTsKICAgIH0KfQoKLy8gQXJyYXkgb2YgdGFnIHJlbGF0aW9uc2hpcHMgdG8gYmUgcHJlc2VydmVkCmNvbnN0IGxpbmtUYWdzID0gWyJsaW5rIiwgImNyZWF0b3IiLCAiY29uZmlnQm90IiwgImxpbmVUbyIsICJ0cmFuc2Zvcm1lciIsICJmb3JtTGlnaHRUYXJnZXQiXTsKCi8vIFRoaXMgbG9vcCBjb250YWlucyB0aGUgbG9naWMgZm9yIHByZXNlcnZpbmcgdGhlIGxpbmtUYWdzCmZvciAobGV0IG5ld0JvdCBvZiBuZXdCb3RzKSB7CiAgICBmb3IgKGxldCB0YWcgb2YgbGlua1RhZ3MpIHsKICAgICAgICBsZXQgdmFsdWUgPSBuZXdCb3QudGFnc1t0YWddOwoKICAgICAgICBpZiAodGFnID09ICJjcmVhdG9yIikgewogICAgICAgICAgICB2YWx1ZSA9IG5ld0JvdC50YWdzLm9sZENyZWF0b3I7CiAgICAgICAgICAgIG5ld0JvdC50YWdzLm9sZENyZWF0b3IgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlQm90TGlua3MobmV3Qm90LCBpZE1hcCk7CgogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGxldCBuZXdWYWx1ZSA9IHZhbHVlLm1hcChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkTWFwLmdldChpZCkgfHwgaWQ7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgbmV3SUQgPSBpZE1hcC5nZXQodmFsdWUpOwoKICAgICAgICAgICAgICAgIGlmIChuZXdJRCkgewogICAgICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld0lEOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBUb2FzdHMgZm9yIGhhdGNoZXMsIGJ1dCBvbmx5IG9uIGJ1aWxkZXIKaWYgKG9yaWdpbiAmJiB2ZXJzaW9uICYmIGNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSA9PSBudWxsICYmICFjb25maWdCb3QudGFncy5waCAmJiBidWlsZGVyVmVyc2lvbiA9PSAiYnVpbGRlciIpIHsKICAgIG9zLnRvYXN0KCJoYXRjaGVkICIgKyBvcmlnaW4gKyAiIHYiICsgdmVyc2lvbik7Cn0KCi8vIENyZWF0ZSBhYkVnZyBib3QgdGhhdCB0cmFja3MgY2FuIGJlIHVzZWQgdG8gdHJhY2sgd2hhdCBlZ2dzIGhhdmUgYmVlbiBoYXRjaGVkLgpsZXQgYWJFZ2dMYWJlbDsKCmlmIChvcmlnaW4pIHsKICAgIGlmICh2ZXJzaW9uKSB7CiAgICAgICAgYWJFZ2dMYWJlbCA9IGAke29yaWdpbn0gdiR7dmVyc2lvbn1gOwogICAgfSBlbHNlIHsKICAgICAgICBhYkVnZ0xhYmVsID0gb3JpZ2luOwogICAgfQp9IGVsc2UgewogICAgYWJFZ2dMYWJlbCA9ICd1bmtub3duJzsKfQoKY29uc3QgYWJFZ2cgPSBjcmVhdGUoewogICAgc3BhY2U6ICJzaGFyZWQiLAogICAgYWI6IHRydWUsCiAgICBhYkVnZzogdHJ1ZSwKICAgIGFiSWdub3JlOiB0cnVlLAogICAgb3JpZ2luX2FiOiBvcmlnaW4sCiAgICBvcmlnaW5fdmVyc2lvbjogdmVyc2lvbiwKICAgIG9yaWdpbl9yZWNvcmQ6IHJlY29yZCwKICAgIG9yaWdpbl9zdHVkaW86IHN0dWRpbywKICAgIGNyZWF0ZWRUaW1lc3RhbXA6IERhdGVUaW1lLmZyb21NaWxsaXMob3MuaXNDb2xsYWJvcmF0aXZlKCkgPyBvcy5hZ3JlZWRVcG9uVGltZSA6IG9zLmxvY2FsVGltZSksCiAgICBib3RJZHM6IGDwn6esJHtKU09OLnN0cmluZ2lmeShuZXdCb3RJZHMpfWAsCiAgICBib3REYXRhSGFzaE9yaWdpbmFsLAogICAgc291cmNlRXZlbnQsCiAgICBpbnN0OiBhYi50YWdzLmFiSW5zdCwKICAgIGZvcm06ICJlZ2ciLAogICAgZWdnUGFyYW1ldGVyczogZWdnUGFyYW1ldGVycyA/IGDwn6esJHtKU09OLnN0cmluZ2lmeShlZ2dQYXJhbWV0ZXJzKX1gIDogbnVsbCwKICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VMYWJlbENvbG9yLAogICAgbGFiZWw6IGFiRWdnTGFiZWwsCiAgICBoYXRjaGVyUmVtb3RlSWQ6IGNvbmZpZ0JvdC5pZCwKfSk7Cgpjb25maWdCb3QudGFncy5sYXN0RWdnSGF0Y2hlZCA9IG9yaWdpbjsKCndoaXNwZXIobmV3Qm90cywgJ29uUHJlSGF0Y2gnLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQgfSk7CgppZiAoaW5pdGlhbEJvb3QpIHsKICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gb3JpZ2luOwp9CgovLyBvbkVnZ0hhdGNoIGZvciBhbGwganVzdCBoYXRjaGVkIGJvdHMKd2hpc3BlcihuZXdCb3RzLCAib25FZ2dIYXRjaCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBlZ2dQYXJhbWV0ZXJzLCBzb3VyY2VFdmVudCB9KTsKCi8vIG9uQWJBZGRlZCBmb3IgYWxsIGJvdHMgaW4gdGhlIGV4cGVyaWVuY2UKc3VwZXJTaG91dCgib25BQkFkZGVkIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOwpzdXBlclNob3V0KCJvbkFiQWRkZWQiLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQgfSk7IC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoKaWYgKG9zLmlzQ29sbGFib3JhdGl2ZSgpKSB7CiAgICAvLyBSZW1vdGUgc2hvdXQgdG8gYWxsIG90aGVyIGNvbm5lY3RlZCByZW1vdGVzIHRoYXQgYSByZW1vdGUgaGFzIGFkZGVkIGFuIGFiLgogICAgY29uc3QgcmVtb3RlSWRzID0gYXdhaXQgb3MucmVtb3RlcygpOwogICAgY29uc3Qgc2VsZkluZGV4ID0gcmVtb3RlSWRzLmluZGV4T2YoY29uZmlnQm90LmlkKTsKICAgIGlmIChzZWxmSW5kZXggPiAwKSB7CiAgICAgICAgcmVtb3RlSWRzLnNwbGljZShzZWxmSW5kZXgsIDEpOwogICAgfQoKICAgIHNlbmRSZW1vdGVEYXRhKHJlbW90ZUlkcywgJ3JlbW90ZV9hYl9hZGRlZCcsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCwgYWJFZ2dJZDogYWJFZ2cuaWQgfSk7Cgp9CgpyZXR1cm4gbmV3Qm90czsnAPH26q4N4cQBCHJlbWVtYmVyAgQA8fbqrg2j9QEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA8fbqrg3hxAEIYWJJZ25vcmUCBADx9uquDcr1AQR0cnVlJwDx9uquDeHEAQdhYlNoZWxsAgQA8fbqrg3P9QEEdHJ1ZScA8fbqrg3hxAEJYWJWZXJzaW9uAgQA8fbqrg3U9QEFMTAuMjknAPH26q4N4cQBC3BlcnNvbmFsaXR5AgQA8fbqrg3a9QEo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicA8fbqrg3hxAEMb25SZW1vdGVEYXRhAgQA8fbqrg2B9gHuCkBpZiAodGhhdC5uYW1lID09PSAncmVtb3RlX2FiX2FkZGVkJykgewogICAgY29uc3QgYWJFZ2dJZCA9IHRoYXQudGhhdC5hYkVnZ0lkOwoKICAgIGlmIChhYkVnZ0lkKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdGFydGluZyBzZWFyY2ggZm9yIGFiRWdnIGJvdCB3aXRoIGlkICR7YWJFZ2dJZH0sIEV2ZW50IGRhdGE6YCwgdGhhdC50aGF0KTsKICAgICAgICB9CgogICAgICAgIC8vIFdhaXQgZm9yIHRoZSBhYkVnZyBib3QgdG8gYXJyaXZlLiBPbmNlIGl0IGhhcywgd2Ugc2hvdWxkIGJlIGFibGUgdG8gc2FmZWx5IHNob3V0IG9uUmVtb3RlQUJBZGRlZCBhbmQgaGF2ZSBhbGwgdGhlIGJvdHMgaW4gdGhlIGluc3QuCiAgICAgICAgbGV0IGFiRWdnID0gZ2V0Qm90KCdpZCcsIGFiRWdnSWQpOwogICAgICAgIGxldCBhY2N1bVNlYXJjaFRpbWUgPSAwOwogICAgICAgIGNvbnN0IE1BWF9TRUFSQ0hfVElNRV9NUyA9IDIwMDAwOwogICAgICAgIGNvbnN0IFNFQVJDSF9JTlRFUlZBTF9NUyA9IDI1MDsKICAgICAgICAKICAgICAgICB3aGlsZSghYWJFZ2cpIHsKICAgICAgICAgICAgYXdhaXQgb3Muc2xlZXAoU0VBUkNIX0lOVEVSVkFMX01TKTsKCiAgICAgICAgICAgIGlmIChhY2N1bVNlYXJjaFRpbWUgPD0gTUFYX1NFQVJDSF9USU1FX01TKSB7CiAgICAgICAgICAgICAgICBhY2N1bVNlYXJjaFRpbWUgKz0gU0VBUkNIX0lOVEVSVkFMX01TOwogICAgICAgICAgICAgICAgYWJFZ2cgPSBnZXRCb3QoJ2lkJywgYWJFZ2dJZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVtb3RlX2FiX2FkZGVkIGV2ZW50IHJlY2VpdmVkIGJ1dCBhYkVnZ0lkICR7YWJFZ2dJZH0gbmV2ZXIgYXJyaXZlZC5gKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoYWJFZ2cpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgYWJFZ2cgYm90IHdpdGggaWQgJHthYkVnZ0lkfWApOwogICAgICAgICAgICB9CgogICAgICAgICAgICBzdXBlclNob3V0KCdvblJlbW90ZUFCQWRkZWQnLCB0aGF0LnRoYXQpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlbW90ZV9hYl9hZGRlZCBldmVudCByZWNlaXZlZCBidXQgbm90IGFiRWdnSWQgd2FzIHByb3ZpZGVkLiBFdmVudCBkYXRhOmAsIHRoYXQudGhhdCk7CiAgICB9Cn0nAPH26q4N4cQBBWRlYnVnAgQA8fbqrg3wgAIFZmFsc2UnAQRib3RzJDUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZgEnAPH26q4N9oACBnN5c3RlbQIEAPH26q4N94ACEGFiLnNoZWxsLnZlcnNpb24nAPH26q4N9oACBGZvcm0CBADx9uquDYiBAgdub3RoaW5nJwDx9uquDfaAAghhYklnbm9yZQIEAPH26q4NkIECBHRydWUnAPH26q4N9oACB2FiU2hlbGwCBADx9uquDZWBAgR0cnVlJwDx9uquDfaAAhNhYlNoZWxsTWFqb3JWZXJzaW9uAgQA8fbqrg2agQIBMycA8fbqrg32gAINb25Ta2lsbFVwZGF0ZQIEAPH26q4NnIEClwFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJTaGVsbE1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJTaGVsbE1pbm9yVmVyc2lvbjsNCg0KY29uc29sZS5sb2coIltBQlNoZWxsXSBMb2FkZWQgQUIgc2hlbGwgdmVyc2lvbiAiICsgdmVyc2lvblN0cmluZyk7JwDx9uquDfaAAglhYlZlcnNpb24CBADx9uquDbSCAgUxMC4yOScA8fbqrg32gAITYWJTaGVsbE1pbm9yVmVyc2lvbgIEAPH26q4NuoICAjE4JwEEYm90cyQ3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YBJwDx9uquDb2CAgZzeXN0ZW0CBADx9uquDb6CAg5hYi5zaGVsbC5zdG9yZScA8fbqrg29ggIEZm9ybQIEAPH26q4NzYICB25vdGhpbmcnAPH26q4NvYICC2Rlc2NyaXB0aW9uAgQA8fbqrg3VggI/VGhpcyBza2lsbCBpcyBtZWFudCB0byBiZSBhIGNvbmZpZ3VyYWJsZSBtZWFucyB0byBwdWJsaXNoIGRhdGEuJwDx9uquDb2CAg9hYlB1Ymxpc2hSZWNvcmQCBADx9uquDZWDAuULQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmc7CmxldCByZWNvcmREYXRhID0gdGhhdC5kYXRhOwpsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKbGV0IGVuZHBvaW50ID0gdGhhdC5lbmRwb2ludCA/IHRoYXQuZW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCBtYXJrZXJTZXQgPSB0aGF0Lm1hcmtlclNldCA/PyBuZXcgU2V0KCk7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKbGV0IHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0cnVlOwoKaWYgKCFyZWNvcmREYXRhKSB7CiAgICByZXR1cm4gIm5vIGRhdGEgc3VwcGxpZWQiOwp9Cgphc3NlcnQobWFya2VyU2V0IGluc3RhbmNlb2YgU2V0LCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG1hcmtlclNldCBtdXN0IGJlIGFuIGluc3RhbmNlIG9mIFNldGApOwoKLy8gW1J5YW4gQ29va10gSEFDSzogVGhlcmUgYXJlIGlzc3VlcyB3aXRoIGN1c3RvbSBtYXJrZXJzLiBDbGVhciBhbGwgb2YgdGhlIGV4Y2VwdCBmb3IgcHVibGljUmVhZC4KbWFya2VyU2V0LmNsZWFyKCk7CgppZiAocHVibGljRmFjaW5nKSB7CiAgICBtYXJrZXJTZXQuYWRkKCdwdWJsaWNSZWFkJyk7Cn0KCnJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHsgZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBtYXJrZXJTZXQuc2l6ZSA+IDAgPyBBcnJheS5mcm9tKG1hcmtlclNldCkgOiB1bmRlZmluZWQgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmREYXRhIHJlc3VsdDpgLCByZWNvcmREYXRhKTsKfQoKaWYgKHJlY29yZERhdGEuc3VjY2VzcykgewogICAgYWIubGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBkYXRhIHB1Ymxpc2hlZCB0byByZWNvcmQgJHt1c2VyUmVjb3JkfSBhdCBhZGRyZXNzICR7cmVjb3JkTmFtZX1gLCBsb2dUeXBlOiAnbG9nJywgdG9hc3Q6IHRvYXN0IH0pOwp9IGVsc2UgewogICAgYWIubGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgZGF0YSBmYWlsZWQgdG8gcHVibGlzaCB0byByZWNvcmQgJHt1c2VyUmVjb3JkfSBhdCBhZGRyZXNzICR7cmVjb3JkTmFtZX1cbiR7SlNPTi5zdHJpbmdpZnkocmVjb3JkRGF0YSwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwoKICAgIGlmICh0b2FzdCkgewogICAgICAgIGFiLmxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgZGF0YSBmYWlsZWQgdG8gcHVibGlzaCB0byByZWNvcmQgJHt1c2VyUmVjb3JkfSBhdCBhZGRyZXNzICR7cmVjb3JkTmFtZX0uICR7cmVjb3JkRGF0YS5lcnJvck1lc3NhZ2V9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIH0KfQoKcmV0dXJuIHJlY29yZERhdGE7JwDx9uquDb2CAg1hYlB1Ymxpc2hGaWxlAgQA8fbqrg37jgKxDUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKaWYgKCF0aGlzQm90LmNhblB1Ymxpc2hGaWxlKCkpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogZmFsc2UsCiAgICAgICAgZXJyb3JDb2RlOiAnbm90X2F1dGhvcml6ZWQnLAogICAgICAgIGVycm9yTWVzc2FnZTogJ1VzZXIgaXMgbm90IGF1dGhvcml6ZWQgdG8gcHVibGlzaCBmaWxlcy4nCiAgICB9Cn0KCmxldCBmaWxlID0gdGhhdC5maWxlOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGVOYW1lOwpsZXQgbWltZVR5cGUgPSB0aGF0Lm1pbWVUeXBlOwpsZXQgbWFya2VyU2V0ID0gdGhhdC5tYXJrZXJTZXQgPz8gbmV3IFNldCgpOwpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gdHJ1ZTsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKaWYgKCFmaWxlKSB7CiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIGVycm9yQ29kZTogJ2ludmFsaWRfZmlsZV9kYXRhJywKICAgICAgICBlcnJvck1lc3NhZ2U6ICdBIGZpbGUgbXVzdCBiZSBwcm92aWRlZCB0byBwdWJsaXNoLicKICAgIH0KfQoKYXNzZXJ0KG1hcmtlclNldCBpbnN0YW5jZW9mIFNldCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBtYXJrZXJTZXQgbXVzdCBiZSBhbiBpbnN0YW5jZSBvZiBTZXRgKTsKCi8vIFtSeWFuIENvb2tdIEhBQ0s6IFRoZXJlIGFyZSBpc3N1ZXMgd2l0aCBjdXN0b20gbWFya2Vycy4gQ2xlYXIgYWxsIG9mIHRoZSBleGNlcHQgZm9yIHB1YmxpY1JlYWQuCm1hcmtlclNldC5jbGVhcigpOwoKaWYgKHB1YmxpY0ZhY2luZykgewogICAgbWFya2VyU2V0LmFkZCgncHVibGljUmVhZCcpOwp9CgpsZXQgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwgeyBkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZSwgbWFya2VyczogbWFya2VyU2V0LnNpemUgPiAwID8gQXJyYXkuZnJvbShtYXJrZXJTZXQpIDogdW5kZWZpbmVkIH0pOwoKaWYgKCFmaWxlVXBsb2FkLnN1Y2Nlc3MpIHsKICAgIGlmIChmaWxlVXBsb2FkLmVycm9yQ29kZSA9PSAiZmlsZV9hbHJlYWR5X2V4aXN0cyIpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmaWxlIGFscmVhZHkgZXhpc3RzIGluICR7dXNlclJlY29yZH1gLCBsb2dUeXBlOiAnbG9nJyB9KTsKICAgICAgICByZXR1cm4gZmlsZVVwbG9hZDsKICAgIH0KCiAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24odXNlclJlY29yZCk7CgogICAgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwgeyBkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZSwgbWFya2VyczogbWFya2VyU2V0LnNpemUgPiAwID8gQXJyYXkuZnJvbShtYXJrZXJTZXQpIDogdW5kZWZpbmVkIH0pOwp9CgppZiAoZmlsZVVwbG9hZC5zdWNjZXNzKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBmaWxlIHJlY29yZGVkIHRvICR7dXNlclJlY29yZH1gLCBsb2dUeXBlOiAnbG9nJyB9KTsKfQplbHNlIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYGZpbGUgZmFpbGVkIHRvIHJlY29yZGAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7Cn0KCnJldHVybiBmaWxlVXBsb2FkOycA8fbqrg29ggIQYWJDb3JlTWVudUFjdGlvbgIEAPH26q4NrZwCTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwDx9uquDb2CAgtvblN0b3JlTWVudQIEAPH26q4N+5wCk5QBQGxldCBwb3NzaWJsZVB1Ymxpc2hCb3QgPSBuZXcgU2V0KCk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpKSB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzLmZvckVhY2goYiA9PiBwb3NzaWJsZVB1Ymxpc2hCb3QuYWRkKGIpKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcG9zc2libGVQdWJsaXNoQm90LmFkZChsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpOwogICAgfQp9CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgewogICAgcG9zc2libGVQdWJsaXNoQm90LmFkZChsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKTsKfQoKcG9zc2libGVQdWJsaXNoQm90ID0gQXJyYXkuZnJvbShwb3NzaWJsZVB1Ymxpc2hCb3QpOwoKY29uc3QgYmFzZUFCID0gIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMgPyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjogbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cy5pZDsKY29uc3QgYmFzZUJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IGJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBkZWZhdWx0cyA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbWFuYWdlcjogIvCflJciICsgdGhpc0JvdC5pZCwKICAgIG1hbmlmZXN0YXRpb246IHRhZ3MubWFuaWZlc3RhdGlvbiwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gCn0KCi8vIENyZWF0ZSBkb3dubG9hZCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICBsYWJlbDogImRvd25sb2FkIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtQWRkcmVzczogImdldF9hcHAiLAogICAgcG9zc2libGVCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJEb3dubG9hZCh7IHBvc3NpYmxlQm90czogbGlua3MucG9zc2libGVCb3QsIHNvdXJjZUV2ZW50OiAnYWJfc3RvcmVfbWVudV9kb3dubG9hZCcgfSk7YAp9KTsKCmlmICghYXV0aEJvdCkgCnsKICAgIC8vIENyZWF0ZSBsb2dpbiBtZXNzYWdlCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgICAgIGxhYmVsOiAicGxlYXNlIHNpZ24gaW4gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siLAogICAgICAgIG9uQ2xpY2s6IGBAIG9zLnJlcXVlc3RBdXRoQm90KClgCiAgICB9KTsKCiAgICByZXR1cm47Cn0KZWxzZSBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIgPT0gIkZyZWVQbGF5IikgCnsKICAgIC8vIENyZWF0ZSB1cGdyYWRlIHN1YnNjcmlwdGlvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInBsZWFzZSB1cGdyYWRlIHlvdXIgc3Vic2NyaXB0aW9uIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIgogICAgfSk7CgogICAgcmV0dXJuOwp9CgoKbGV0IHVzZXJTdHVkaW9zID0gY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zOwoKaWYgKCF1c2VyU3R1ZGlvcykgCnsKICAgIHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7Cn0KCmlmICh1c2VyU3R1ZGlvcy5zdWNjZXNzKSAKewogICAgY29uc3QgYWN0aXZlU3R1ZGlvID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCk7CgogICAgbGV0IGJhc2VTdHVkaW8gPSBhdXRoQm90LmlkOwoKICAgIGlmIChiYXNlU3R1ZGlvID09IGF1dGhCb3QuaWQpIAogICAgewogICAgICAgIGJhc2VTdHVkaW8gPSAicGxheWVyIjsKICAgIH0KCiAgICBpZiAoYWN0aXZlU3R1ZGlvID09IC0xICYmIGJhc2VTdHVkaW8gIT0gInBsYXllciIpIAogICAgewogICAgICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYmFzZVN0dWRpbzsKICAgIH0KCiAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICYmICFhY3RpdmVTdHVkaW8pIAogICAgewogICAgICAgIGNvbnN0IHN0dWRpb01hdGNoID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCgogICAgICAgIGlmIChzdHVkaW9NYXRjaCAhPSAtMSkgewogICAgICAgICAgICBiYXNlU3R1ZGlvID0gYmFzZVN0dWRpbzsKICAgICAgICB9CiAgICB9CgogICAgY29uc3Qgc3R1ZGlvTGFiZWwgPSBhY3RpdmVTdHVkaW8gPT0gLTEgPyBiYXNlU3R1ZGlvIDogdXNlclN0dWRpb3Muc3R1ZGlvc1thY3RpdmVTdHVkaW9dLmRpc3BsYXlOYW1lOwoKICAgIC8vIENyZWF0ZSBzdHVkaW8gc2VsZWN0IGJ1dHRvbgogICAgY29uc3Qgc3R1ZGlvRGlzcGxheUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInN0dWRpbz0iICsgc3R1ZGlvTGFiZWwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUsCiAgICAgICAgc3R1ZGlvSW5mb3JtYXRpb246IHVzZXJTdHVkaW9zLAogICAgICAgIGZvcm1BZGRyZXNzOiAiaW52ZW50b3J5XzIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuc3R1ZGlvU2VsZWN0KHRhZ3Muc3R1ZGlvSW5mb3JtYXRpb24pO2AKICAgIH0pOwoKICAgIG1hc2tzLnN0dWRpb1NlbGVjdEJ1dHRvbiA9IGdldExpbmsoc3R1ZGlvRGlzcGxheUJ1dHRvbik7Cn0KCmNvbnN0IHRvdGFsQm90Q291bnQgPSBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoID4gMCA/IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggbGFiZWwgYnV0dG9uCmNvbnN0IGxhYmVsQm90ID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBsYWJlbDogYHB1Ymxpc2ggcGF0dGVybiAke2Jhc2VCb3RzLmxlbmd0aCA+IDAgPyAiIiA6ICJhcyAifSR7YmFzZUFCfSAoJHt0b3RhbEJvdENvdW50fSBib3Qke2Jhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgdG90YWxCb3RzOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoLAogICAgYWJNZW51U29ydE9yZGVyOiAxLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgZm9ybUFkZHJlc3M6IG51bGwsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IDhweCAwcHggMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItdG9wLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgc2hpZnRTdGF0ZTogZmFsc2UsCiAgICBvbkNsaWNrOiBgQCBjb25zdCBtZW51Qm90cyA9IGdldEJvdHMoJ2FiTWVudVNvcnRPcmRlcicpOwoKICAgICAgICBpZiAodGFncy5zaGlmdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5VXAiLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleURvd24iLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRhZ3Muc2hpZnRTdGF0ZSA9ICF0YWdzLnNoaWZ0U3RhdGU7YCwKICAgIHNjYWxlWTogImF1dG8iLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgbGV0IHRvdGFsQm90cyA9IGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA/IHRoYXQuYWJCb3RzIDogdGhhdC5hYkJvdHMgKyB0aGF0Lm5vbkFCQm90czsKCiAgICBjb25zdCB0b3RhbEJvdFZhciA9IHRvdGFsQm90cyA9PSAxID8gIiBib3QiIDogIiBib3RzIjsKICAgIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzPy5sZW5ndGggID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICBpZiAoZ2V0Qm90KCJhYklET3JpZ2luIiwgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKS5sZW5ndGg7CgogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIGFiQm90cyArICIgYm90cykiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IGFiQm90czsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoIHBhdHRlcm4gYXMgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgICAgICB9ICAgCiAgICB9CiAgICBlbHNlCiAgICB7ICAgCiAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoICIgKyB0aGF0LmFiICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgfWAKfSk7CgovLyBDcmVhdGUgZW5jcnlwdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgbGFiZWw6ICJlbmNyeXB0IiwKICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgZW5jcnlwdFN0YXRlOiBmYWxzZSwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MuZW5jcnlwdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IHRydWU7CiAgICAgICAgfWAsCn0pOwoKbGV0IGFiQnV0dG9uOwoKaWYgKHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy8gQ3JlYXRlIGluY2x1ZGVCb3RzIGJ1dHRvbgogICAgYWJCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUyLAogICAgICAgIGFiU2VsZWN0aW9uQnV0dG9uOiB0cnVlLAogICAgICAgIGxhYmVsOiBiYXNlQm90cy5sZW5ndGggPiAwICYmIGJhc2VBQiAhPSB1bmRlZmluZWQgPyBgc2VsZWN0ZWQgcGF0dGVybjogJHtiYXNlQUJ9ICgke2Jhc2VCb3RzLmxlbmd0aH0gYm90JHtiYXNlQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgIDogYG5ldyBwYXR0ZXJuICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICdlZ2cnLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYlB1Ymxpc2hTZWxlY3QoKTtgLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhck5vbiA9IHRoYXQubm9uQUJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIGNvbnN0IGJvdFZhckFCID0gdGhhdC5hYkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gdGhhdC5hYiArICIgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhck5vbjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJzZWxlY3RlZCBwYXR0ZXJuOiAiICsgdGhhdC5hYiArICIgKCIgKyB0aGF0LmFiQm90cyArIGJvdFZhckFCOwogICAgICAgIH1gCiAgICB9KTsKfQoKaWYgKG5vbkFCQm90cy5sZW5ndGggPiAwICYmIHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy9pY2x1ZGUgbmV3IGJvdHMKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUzLAogICAgICAgIGFiQnV0dG9uOiBnZXRMaW5rKGFiQnV0dG9uKSwKICAgICAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICAgICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgICAgICBsYWJlbDogYGluY2x1ZGUgbmV3ICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3giLAogICAgICAgIHVuY2xhaW1lZFN0YXRlOiBmYWxzZSwKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSBsaW5rcy5hYkJ1dHRvbi50YWdzLmxhYmVsOwoKICAgICAgICAgICAgICAgIGlmIChsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRhZ3MudW5jbGFpbWVkU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogbm9uQUJCb3RzLmxlbmd0aH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKCiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IDB9KTsKICAgICAgICAgICAgfWAsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHMgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJpbmNsdWRlIG5ldyAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyOwoKICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IHRoYXQuYWI7CgogICAgICAgICAgICBpZighbGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSBwdWJsaWMgYnV0dG9uCmlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgCnsKICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IGZhbHNlOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICAgICAgbGFiZWw6ICJpc1B1YmxpYyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICAgICAgcHVibGljU3RhdGU6IGZhbHNlLAogICAgICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MucHVibGljU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgdmVyc2lvbiBzZWxlY3QgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGxhYmVsOiAndmVyc2lvbkZsYWc9Y3VycmVudCcsCiAgICBmb3JtQWRkcmVzczogJ2FsdF9yb3V0ZScsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgc2hvdXQoJ3Nob3dWZXJzaW9uU2VsZWN0b3InKTtgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmxhYmVsID0gJ3ZlcnNpb25GbGFnPScgKyB0aGF0OwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgYCwKfSk7CgovLyBDdXJyZW50IFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2N1cnJlbnQnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX2NoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIEZlZWRiYWNrIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2ZlZWRiYWNrJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTExLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ2ZlZWRiYWNrJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBTdGFibGUgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnc3RhYmxlJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEyLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ3N0YWJsZSc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA0LAogICAgZm9ybUFkZHJlc3M6ICJlZ2ciLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCAwcHggOHB4IDhweCIsCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItYm90dG9tLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm06ICJpbnB1dCIsCiAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICBvbklucHV0VHlwaW5nOiBgQCBsaW5rcy5sYWJlbEJvdC50YWdzLmxhYmVsID0gJ3B1Ymxpc2ggcGF0dGVybiBhcyAnICsgdGhhdC50ZXh0ICsgJyAoJyArIGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzICsgJyBib3QnICsgKGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzID09IDEgPyAnKScgOiAncyknKTtgLAogICAgbWVudUl0ZW1TaG93U3VibWl0V2hlbkVtcHR5OiB0cnVlLAogICAgdGFyZ2V0Qm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBtZW51SXRlbVRleHQ6IGJhc2VBQiwKICAgIG9uU3VibWl0OiBgQAogICAgICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQudGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0YXJnZXRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwogICAgICAgICAgICBjb25zdCBjb25maXJtUHVzaCA9IGF3YWl0IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgICAgIHRpdGxlOiAiY29uZmlybSBwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICJwdWJsaXNoICIgKyB0aGF0LnRleHQgKyAiIHRvICIgKyB0YXJnZXRTdHVkaW8gKyAiPyIsCiAgICAgICAgICAgICAgICBjb25maXJtVGV4dDogInB1Ymxpc2giLAogICAgICAgICAgICAgICAgY2FuY2VsVGV4dDogImNhbmNlbCIKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIWNvbmZpcm1QdXNoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoQUIoeyBhYjogdGhhdC50ZXh0LCBib3Q6IGxpbmtzLnRhcmdldEJvdCwgYmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgbWFudWFsUHVibGlzaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdzdG9yZV9tZW51JyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJhYiBub3Qgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSB0aGF0LmFiOwogICAgfWAKfSk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgCnsKICAgIC8vIENyZWF0ZSBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDgsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAiY29weSB0byBjbGlwYm9hcmQiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiZmlsZV9jb3B5IiwKICAgICAgICB0YXJnZXRCb3Q6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RGb2N1cywKICAgICAgICBvbkNsaWNrOiBgQCAKICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRCb3QgPSBsaW5rcy50YXJnZXRCb3Q7CgogICAgICAgICAgICBhYi5saW5rcy5wYXN0ZS5hYkNvcHlCb3RzVG9DbGlwYm9hcmQoeyBib3RzOiBbbGlua3MudGFyZ2V0Qm90XSwgc291cmNlRXZlbnQ6ICdhYl9zdG9yZV9tZW51X2NvcHlfY2xpcGJvYXJkJyB9KQoKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CiAgICAgICAgYCwKICAgIH0pOwp9CmVsc2UgCnsKICAgIC8vIENyZWF0ZSBzY2FuIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMTAsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyAgICAgICAgICAgIAogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAic2NhbiB0byBwdWJsaXNoIiwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgb25DbGljazogYEAgY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSB0cnVlOyBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpO2AsCiAgICB9KTsKfQoKbGV0IGhvc3RCdXR0b24gPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDUwLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgZm9ybUFkZHJlc3M6ICJncm91cF9hZGQiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLmxlYXJuLmFiQ3JlYXRlSG9zdCh0aGlzQm90KTsKICAgIGlmICghbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpCiAgICB7CiAgICAgICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKICAgIH1gLAp9OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMCwgMykgKyAiLSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMyk7Cn0KZWxzZSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJnZW5lcmF0ZSBqb2luIGNvZGUiOwp9CgppZiAoY29uZmlnQm90LnRhZ3Muc3RhdGljSW5zdCA9PSB1bmRlZmluZWQpCnsKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGhvc3RCdXR0b24pOy8vZ2VuZXJhdGUgYSBob3N0IGJ1dHRvbgp9JwDx9uquDb2CAg5hYkNvcmVNZW51SWNvbgIEAPH26q4NgbEDCWlvc19zaGFyZScA8fbqrg29ggIPYWJDb3JlTWVudUxhYmVsAgQA8fbqrg2LsQMFc2hhcmUnAPH26q4NvYICE2FiQ29yZU1lbnVTb3J0T3JkZXICBADx9uquDZGxAwEzJwDx9uquDb2CAghyZW1lbWJlcgIEAPH26q4Nk7EDKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAPH26q4NvYICC2FiUHVibGlzaEFCAgQA8fbqrg26sQO5P0BpZiAoIWF1dGhCb3QpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiAibXVzdCBiZSBsb2dnZWQgaW4gdG8gcHVibGlzaCBwYXR0ZXJucy4iLCBsb2dUeXBlOiAiZXJyb3IiIH0pOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QuY2FuUHVibGlzaEZpbGUoKSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJtdXN0IGhhdmUgc3Vic2NyaXB0aW9uIHRoYXQgc3VwcG9ydHMgZmlsZSBwdWJsaXNoaW5nLiIsIGxvZ1R5cGU6ICJlcnJvciIgfSk7CiAgICByZXR1cm4gCn0KCmlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJwYXR0ZXJuIG5hbWVzIG1heSBub3QgY29udGFpbiBzcGFjZXMgb3IgcXVvdGFpb24gbWFya3MsIHBsZWFzZSB0cnkgYWdhaW4uIiwgbG9nVHlwZTogImVycm9yIiB9KTsKICAgIHJldHVybjsKfQoKCmxpbmtzLnV0aWxzLmFiTG9nKGBwdWJsaXNoaW5nICR7dGhhdC5hYn1gKTsKCmlmICghdGhhdC5rZWVwTWVudSkgewogICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKfQoKLy9hYiB2YXJpYWJsZXMKY29uc3QgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKY29uc3QgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpjb25zdCBiYXNlQUIgPSB0aGF0LmJhc2VBQiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPz8gKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQpOwpjb25zdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoID0gdGhhdC5vblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOyAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4gKG9wdGlvbmFsKQpjb25zdCBtYW51YWxQdWJsaXNoID0gdGhhdC5tYW51YWxQdWJsaXNoOwpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQuc291cmNlRXZlbnQ7IC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQpjb25zdCBlZ2dNYXJrZXJTZXQgPSB0aGF0LmVnZ01hcmtlclNldCA/PyBuZXcgU2V0KCk7CmNvbnN0IGF1eE1hcmtlclNldCA9IHRoYXQuYXV4TWFya2VyU2V0ID8/IG5ldyBTZXQoKTsKY29uc3Qgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmFzc2VydChlZ2dNYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CmFzc2VydChhdXhNYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXV4TWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7Cgpjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwoKZWdnTWFya2VyU2V0LmFkZCgnYWJFZ2cnKTsKZWdnTWFya2VyU2V0LmFkZChhYklEKTsKCmF1eE1hcmtlclNldC5hZGQoJ2FiQXV4Jyk7CmF1eE1hcmtlclNldC5hZGQoYWJJRCk7CgpsZXQgYnVzeUluZGljYXRvcjsKaWYgKG1hbnVhbFB1Ymxpc2ggJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkgewogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQogICAgCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHVwbG9hZGluZyAke3RoYXQuYWJ9YCwgb25EZXN0cm95OiBgQGNvbnNvbGUubG9nKCdidXN5IGluZGljYXRvciBnbyBib29tJylgfSk7Cn0KCi8vIExldCBhbGwgYm90cyBrbm93IHRoYXQgYWIgaXMgYWJvdXQgdG8gc3RhcnQgcHVibGlzaGluZy4KY29uc3QgYmVmb3JlUHVibGlzaEFyZyA9IHsgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nLCBzb3VyY2VFdmVudCB9Owphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJCZWZvcmVQdWJsaXNoJywgYmVmb3JlUHVibGlzaEFyZykpOwoKaWYgKCF0YXJnZXQgfHwgdGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgIGlmIChjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgJiYgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQikgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBhYklEKTsKCiAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiAmJiBnZXRCb3QoImFiSURPcmlnaW4iLCBiYXNlQUIpKSB7CiAgICAgICAgY29uc3QgZWdnQm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKTsKICAgICAgICBjb25zdCBuZXdCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCk7CgogICAgICAgIHRhcmdldCA9IFsuLi5lZ2dCb3RzLCAuLi5uZXdCb3RzXTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgfQoKICAgIHNldFRhZyh0YXJnZXQsICJhYklET3JpZ2luIiwgYWJJRCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IG51bGw7CgogICAgaWYgKHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgibm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIGlmICghdGhhdC5rZWVwTWVudSkgewogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikgewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkgewogICAgICAgIGtleUNoZWNrID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ2NvbmZpcm0gc2VjcmV0IGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBpZiAoa2V5ICE9IGtleUNoZWNrKSB7CiAgICAgICAgaWYgKCFrZXlDaGVjaykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBrZXkgZW50ZXJlZCIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoIXRoYXQua2VlcE1lbnUpIHsKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsgCiAgICAgICAgfQoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGN1cnJlbnRCb3RJRCA9IHRhcmdldFtpXS5pZDsKICAgICAgICBsZXQgY3VycmVudEJvdERhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldFtpXSkpOwoKICAgICAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdERhdGE7CiAgICB9Cn0KZWxzZSB7CiAgICBzdGF0ZVt0YXJnZXQuaWRdID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0YXJnZXQpKTsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7IGFiSUQ6IGFiSUQgfSk7CgovL2FkZCB4cCBib3QgaGVyZQpzdGF0ZS5hYlhQQm90ID0gewogICAgc3BhY2U6ICJzaGFyZWQiLAogICAgaWQ6ICJhYlhQQm90IiwKICAgIHRhZ3M6IHsKICAgICAgICBmb3JtOiAibm90aGluZyIsCiAgICAgICAgc3lzdGVtOiAiYWIucGF0dGVybi5hYlhQQm90IiwKICAgICAgICBhdXRob3JJRDogYXV0aEJvdC5pZCwKICAgICAgICB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24sCiAgICAgICAgeHA6IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUCwKICAgICAgICBzaWduYXR1cmU6IGVnZ0NoZWNrLnNpZ25hdHVyZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgIH0KfTsKCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBhYiBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhOiBzdGF0ZSwgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nLCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gnLCBwcmVwcm9jZXNzQXJnKSk7CgovL2FkZGl0aW9uYWwgZmlsZSBkYXRhCmZvcm1hdHRlZEZpbGUudmVyc2lvbiA9IDE7CmZvcm1hdHRlZEZpbGUuc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwpmb3JtYXR0ZWRGaWxlLnN0YXRlID0gc3RhdGU7CgovL2FjdHVhbCBlbmNyeXB0aW9uIGlmIGNob3NlbgppZiAoa2V5KSB7CiAgICBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkoZm9ybWF0dGVkRmlsZSk7CiAgICBmb3JtYXR0ZWRGaWxlID0gY3J5cHRvLmVuY3J5cHQoa2V5LCBmb3JtYXR0ZWRGaWxlKTsKfQoKLy9wdWJsaXNoIHRoZSBmaWxlIGFuZCB0aGUgZWdnIHJlY29yZC4KbGV0IHB1Ymxpc2hGaWxlOwpsZXQgcHVibGlzaFJlY29yZDsKCnB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogdHJ1ZSwgbWFya2VyU2V0OiBhdXhNYXJrZXJTZXQgfSk7CgppZiAocHVibGlzaEZpbGUuc3VjY2VzcykgewogICAgLy9nYXRoZXIgYWRkaW9uYWwgZWdnIGRhdGEKICAgIGNvbnN0IGFpUGVybWl0Q2hlY2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3QuaWQsICJhaV9wZXJtaXQiKTsKICAgIGNvbnN0IGFpUGVybWl0SUQgPSBhaVBlcm1pdENoZWNrLnN1Y2Nlc3MgPyBhaVBlcm1pdENoZWNrLmRhdGEucGVybWl0SUQgOiBmYWxzZTsKCiAgICBlZ2dDaGVjay5lZ2dEYXRhLmFpUGVybWl0ID0gYWlQZXJtaXRJRDsKICAgIGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkucHVzaChwdWJsaXNoRmlsZS51cmwpOwogICAgZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICBlZ2dDaGVjay5lZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKICAgIAogICAgLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKICAgIHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7IGRhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZywgbWFya2VyU2V0OiBlZ2dNYXJrZXJTZXQsIHRvYXN0OiBmYWxzZSB9KTsKfQoKaWYgKHB1Ymxpc2hGaWxlLnN1Y2Nlc3MgJiYgcHVibGlzaFJlY29yZC5zdWNjZXNzKSB7CiAgICAvL3B1Ymxpc2hpbmcgc2hvdXQKICAgIHN1cGVyU2hvdXQoIm9uQUJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOwogICAgc3VwZXJTaG91dCgib25BYlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7IC8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgoKICAgIGNvbnN0IGJpb3MgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwogICAgY29uc3QgaW5zdFR5cGUgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwoKICAgIHNldFRhZ01hc2sobGlua3MubGVhcm4sICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKCiAgICBpZiAobWFudWFsUHVibGlzaCkgewogICAgICAgIGxldCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKICAgICAgICBjb25zdCB1cmwgPSBzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICImc3R1ZGlvPSIgKyBzdHVkaW8gKyAiJmJpb3M9IiArIGJpb3M7CiAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKHVybCk7CgogICAgICAgIGlmIChrZXkpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgd2l0aCBlbmNyeXB0ZWQgZGF0YSBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9CiAgICB9CgogICAgdHJ5IHsKICAgICAgICBhd2FpdCBhbmFseXRpY3MucmVjb3JkRXZlbnQoJ2FiX2VnZ19wdWJsaXNoJywgeyBhYjogYWJJRCwgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggfSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICB9Cn0KZWxzZSB7CiAgICBsZXQgZXJyb3JNZXNzYWdlOwoKICAgIGlmICghcHVibGlzaEZpbGUuc3VjY2VzcykgewogICAgICAgIGVycm9yTWVzc2FnZSA9IHB1Ymxpc2hGaWxlLmVycm9yTWVzc2FnZSA/PyBwdWJsaXNoRmlsZS5lcnJvckNvZGU7CiAgICB9IGVsc2UgaWYgKCFwdWJsaXNoUmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBlcnJvck1lc3NhZ2UgPSBwdWJsaWNoUmVjb3JkLmVycm9yTWVzc2FnZSA/PyBwdWJsaXNoUmVjb3JkLmVycm9yQ29kZTsKICAgIH0gZWxzZSB7CiAgICAgICAgZXJyb3JNZXNzYWdlID0gJ1Vua25vd24gcmVhc29uJzsKICAgIH0KCiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiBgUHVibGlzaGluZyBmYWlsZWQ6ICR7ZXJyb3JNZXNzYWdlfWAsCiAgICAgICAgbG9nVHlwZTogJ2Vycm9yJywKICAgICAgICB0b2FzdDogIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZQogICAgfSkKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBwdWJsaXNoUmVjb3JkOycA8fbqrg29ggIIYWJJZ25vcmUCBADx9uquDfTwAwR0cnVlJwDx9uquDb2CAgphYkRvd25sb2FkAgQA8fbqrg358AO5FUBjb25zdCBwb3NzaWJsZUJvdHMgPSB0aGF0Py5wb3NzaWJsZUJvdHM7CmxldCBmaWxlbmFtZSA9IHRoYXQ/LmZpbGVuYW1lOwpsZXQgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKbGV0IG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ7CmxldCBsb2cgPSB0aGF0Py5sb2cgPz8gdHJ1ZTsKbGV0IHJlb3BlbkFiTWVudSA9IHRoYXQ/LnJlb3BlbkFiTWVudSA/PyB0cnVlOwoKLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byBkb3dubG9hZCBib3RzLgpjb25zdCBiZWZvcmVEb3dubG9hZEFyZyA9IHsgZmlsZW5hbWUsIHNvdXJjZUV2ZW50IH07CmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZURvd25sb2FkJywgYmVmb3JlRG93bmxvYWRBcmcpKTsKCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zdCBzaG91bGREb3dubG9hZEluc3QgPSAhcG9zc2libGVCb3RzIHx8IChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykgJiYgcG9zc2libGVCb3RzLmxlbmd0aCA9PT0gMCk7CgppZiAoc2hvdWxkRG93bmxvYWRJbnN0KSB7CiAgICAvLyBEb3dubG9hZCBpbnN0LgogICAgZG93bmxvYWRCb3RzID0gZ2V0Qm90cyhiID0+ICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOwoKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgIH0KCiAgICBpZiAobG9nKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGluc3QnKTsKICAgIH0KfSBlbHNlIHsKICAgIGlmIChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykpIHsKICAgICAgICAvLyBEb3dubG9hZCBib3RzLgogICAgICAgIGRvd25sb2FkQm90cyA9IHBvc3NpYmxlQm90czsKICAgICAgICBjb25zdCBib3RJZHMgPSBwb3NzaWJsZUJvdHMubWFwKGIgPT4gYi5pZCkuc29ydCgpOwogICAgICAgIGxldCBib3RJZHNTSEExID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90SWRzKTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtib3RJZHNTSEExLnN1YnN0cmluZygwLCA3KX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9nKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGBkb3dubG9hZCAke2Rvd25sb2FkQm90cy5sZW5ndGh9IGJvdHNgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGJvdC4KICAgICAgICBkb3dubG9hZEJvdHMgPSBbcG9zc2libGVCb3RzXTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtwb3NzaWJsZUJvdHMuaWQuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGJvdCcpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpIHsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9Cgpjb25zdCBzdGF0ZSA9IHt9OwoKLy8gRm9ybWF0IGJvdHMgZm9yIGZpbGUgc3RvcmFnZQpmb3IgKGxldCBpID0gMDsgaSA8IGRvd25sb2FkQm90cy5sZW5ndGg7IGkrKykgewogICAgbGV0IGN1cnJlbnRCb3RJRCA9IGRvd25sb2FkQm90c1tpXS5pZDsKICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZG93bmxvYWRCb3RzW2ldKSk7CgogICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwp9CgppZiAoIWZpbGVuYW1lLmVuZHNXaXRoKCcuYXV4JykpIHsKICAgIGZpbGVuYW1lICs9ICcuYXV4JzsKfQoKLy8gRG8gYSBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmNvbnN0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBmaWxlbmFtZSwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQocHJlcHJvY2Vzc0FyZyk7Cn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vIERvd25sb2FkIGFzIHYxIGF1eCBmaWxlLgpjb25zdCBhdXhGaWxlID0geyB2ZXJzaW9uOiAxLCBzdGF0ZSB9Owpvcy5kb3dubG9hZChhdXhGaWxlLCBmaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgppZiAocmVvcGVuQWJNZW51KSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfScA8fbqrg29ggINbWFuaWZlc3RhdGlvbgIEAPH26q4Ns4YEKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAPH26q4NvYICBG1lbnUCBADx9uquDdqGBCjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDx9uquDb2CAhJhYlByZXZpb3VzRWdnQ2hlY2sCBADx9uquDYGHBIARQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0Py5hYklEOwpjb25zdCByZWNvcmRLZXlPck5hbWUgPSB0aGF0Py5yZWNvcmRLZXlPck5hbWUgPz8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQ7Cgphc3NlcnQodHlwZW9mIGFiSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyYCk7CmFzc2VydCh0eXBlb2YgcmVjb3JkS2V5T3JOYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXlPck5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBlZ2dIaXN0b3J5OwpsZXQgZWdnSUQ7CmxldCB0YXJnZXRWZXJzaW9uTnVtOwpsZXQgbGFzdEhhc2g7CmxldCBtYXhWZXJzaW9uTnVtOwpsZXQgc3RhYmxlVmVyc2lvbjsKbGV0IGZlZWRiYWNrVmVyc2lvbjsKbGV0IHByZXZpb3VzWFA7CmxldCByZWNvcmRMb29rdXAgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleU9yTmFtZSwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycA8fbqrg29ggIPYWJCb3RNZW51QWN0aW9uAgQA8fbqrg2CmARNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAPH26q4NvYICDmFiQm90TWVudUxhYmVsAgQA8fbqrg3QmAQFc2hhcmUnAPH26q4NvYICDWFiQm90TWVudUljb24CBADx9uquDdaYBAlpb3Nfc2hhcmUnAPH26q4NvYICEmFiQm90TWVudVNvcnRPcmRlcgIEAPH26q4N4JgEAzMuNScA8fbqrg29ggIFbGVhcm4CBADx9uquDeSYBCjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDx9uquDb2CAgthYlFSUHVibGlzaAIEAPH26q4Ni5kE4QFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0LCBzb3VyY2VFdmVudDogJ3FyX3B1Ymxpc2gnfSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAPH26q4NvYICBnNlYXJjaAIEAPH26q4N7ZoEKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAPH26q4NvYICB2FiU2hlbGwCBADx9uquDZSbBAR0cnVlJwDx9uquDb2CAgxzdHVkaW9TZWxlY3QCBADx9uquDZmbBIsLQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwDx9uquDb2CAg5hYlB1Ymxpc2hBc2tJRAIEAPH26q4No6YE3xVAaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgbWVudURpbWVuc2lvbiA9IHRoYXQubWVudURpbWVuc2lvbiA/PyBjb25maWdCb3QudGFncy5tZW51UG9ydGFsOwpsZXQgcHJvZ3Jlc3NCdXR0b247CgppZiAobWVudURpbWVuc2lvbikgewogICAgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBbbWVudURpbWVuc2lvbl06IHRydWUsIGxhYmVsOiBgcHVibGlzaGluZyAke3RoYXQuYXNrSUR9YCB9KTsKfQoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmNvbnN0IHBhdHRlcm5JRCA9IHRoYXQucGF0dGVybklEOwpjb25zdCBzdHVkaW9JRCA9IHRoYXQuc3R1ZGlvSUQgPyB0aGF0LnN0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKY29uc3QgbWFya2VyU2V0ID0gdGhhdC5tYXJrZXJTZXQgPz8gbmV3IFNldCgpOwpjb25zdCB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdHJ1ZTsKCmFzc2VydChtYXJrZXJTZXQgaW5zdGFuY2VvZiBTZXQsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbWFya2VyU2V0IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgU2V0YCk7CgptYXJrZXJTZXQuYWRkKCdwdWJsaWNSZWFkJyk7Cm1hcmtlclNldC5hZGQoJ2FiQXNrJyk7CgovLyBbUnlhbiBDb29rXSBIQUNLOiBUaGVyZSBhcmUgaXNzdWVzIHdpdGggY3VzdG9tIG1hcmtlcnMuIENsZWFyIGFsbCBvZiB0aGUgZXhjZXB0IGZvciBwdWJsaWNSZWFkLgptYXJrZXJTZXQuY2xlYXIoKTsKbWFya2VyU2V0LmFkZCgncHVibGljUmVhZCcpOwoKLy8gQ2hlY2sgdG8gc2VlIGlmIHRoaXMgYXNrSUQgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBDYXN1YWwgY2F0YWxvZyBhc2tzIGFsd2F5cyBvdmVycmlkZSBhYiBhc2tzIGFuZCBzbyB1c2VyJ3Mgc2hvdWxkIGJlIGF3YXJlLgpjb25zdCBleGlzdHNJbkNhc3VhbENhdGFsb2cgPSBhd2FpdCBhYi5saW5rcy5zZWFyY2guYWJDYXN1YWxDYXRhbG9nQXNrSURFeGlzdHMoeyBhc2tJRDogdGhhdC5hc2tJRCB9KTsKCmlmICghZXhpc3RzSW5DYXN1YWxDYXRhbG9nKSB7CiAgICBjb25zdCBwdWJsaXNoQXNrID0gYXdhaXQgb3MucmVjb3JkRGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwgeyBwYXR0ZXJuSUQ6IHBhdHRlcm5JRCwgc3R1ZGlvSUQ6IHN0dWRpb0lEIH0sIHsgZW5kcG9pbnQ6IGVuZHBvaW50LCB1cGRhdGVQb2xpY3k6IFthdXRoQm90LmlkXSwgbWFya2VyczogbWFya2VyU2V0LnNpemUgPiAwID8gQXJyYXkuZnJvbShtYXJrZXJTZXQpIDogdW5kZWZpbmVkIH0pOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBwdWJsaXNoQXNrIHJlc3VsdDpgLCBwdWJsaXNoQXNrKTsKICAgIH0KCiAgICBpZiAocHVibGlzaEFzay5zdWNjZXNzKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gcHVibGlzaGVkIHRvIGFiIHJlY29yZC5gLCBsb2dUeXBlOiAnbG9nJyB9KTsKCiAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiVG9hc3QoeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gcHVibGlzaGVkLmAsIGxvZ1R5cGU6ICdsb2cnIH0pOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgYXNrICR7dGhhdC5hc2tJRH0gZmFpbGVkIHRvIHB1Ymxpc2ggdG8gYWIgcmVjb3JkLlxuJHtKU09OLnN0cmluZ2lmeShwdWJsaXNoQXNrLCB1bmRlZmluZWQsIDIpfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CgogICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYGZhaWxlZCB0byBwdWJsaXNoIGFzayAke3RoYXQuYXNrSUR9LiAke3B1Ymxpc2hBc2suZXJyb3JNZXNzYWdlfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQoKICAgIHJldHVybiBwdWJsaXNoQXNrOwp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBhc2tJRCAnJHt0aGF0LmFza0lEfScgYWxyZWFkeSBleGlzdHMgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLiBQbGVhc2UgY2hvb3NlIGEgZGlmZmVyZW50IG5hbWUuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKCiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KICAgIAogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBpbiB0aGUgc2hhcGUgb2YgUmVjb3JkRGF0YUZhaWx1cmUuCiAgICByZXR1cm4gewogICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgIGVycm9yQ29kZTogJ2Fza2lkX2V4aXN0c19jYXN1YWxfY2F0YWxvZycsCiAgICAgICAgZXJyb3JNZXNzYWdlOiBgQ2FzdWFsIGNhdGFsb2cgYWxyZWFkeSBjb250YWlucyB0aGUgYXNrSUQgJyR7YXNrSUR9J2AKICAgIH0KfScA8fbqrg29ggIFaW5wdXQCBADx9uquDYO8BCjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDx9uquDb2CAgthYkVtYmVkTGluawIEAPH26q4NqrwEpANAY29uc3QgYWIgPSB0aGF0ID8gdHJ1ZSA6IGZhbHNlOwpjb25zdCBlbWJlZExpbmsgPSBhYiA/ICJhYj0iICsgdGhhdCA6ICJpbnN0PSIgKyBjb25maWdCb3QudGFncy5pbnN0Owpjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKY29uc3QgZW1iZWRUZXh0ID0gYDwhRE9DVFlQRSBodG1sPgrCoMKgwqDCoDxodG1sPgrCoMKgwqDCoMKgwqDCoMKgPGhlYWQ+PC9oZWFkPgrCoMKgwqDCoMKgwqDCoMKgPGJvZHk+CsKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoDxpZnJhbWUgc3JjPSIke3NpdGVPcmlnaW4gKyAiLz8iICsgZW1iZWRMaW5rfSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iNDAwIiAvPgrCoMKgwqDCoMKgwqDCoMKgPC9ib2R5PgrCoMKgwqDCoDwvaHRtbD5gOwoKcmV0dXJuIGVtYmVkVGV4dDsnAPH26q4NvYICD2FiUGF0dGVyblVwZGF0ZQIEAPH26q4No78EpQVALy9zaG91dCgiYWJQYXR0ZXJuVXBkYXRlIiwge2FiSUQ6IGFiSUQsIHN0dWRpbzpzdHVkaW8/LCBib3RzOiBib3RzP30pOwphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKaWYgKCFhdXRoQm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8gdGhhdC5zdHVkaW8gOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBhYk1hbmlmZXN0ID0gZ2V0Qm90KGJ5TW9kKHthYkVnZzogdHJ1ZSwgb3JpZ2luX2FiOiBhYklEfSkpOwoKaWYgKCFhYk1hbmlmZXN0KQp7CiAgICBzaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGF1dG9IYXRjaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdwYXR0ZXJuX3VwZGF0ZSd9KTsKCiAgICByZXR1cm47Cn0KCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gc3R1ZGlvOwoKY29uc3QgYWJCb3RzID0gdGhhdC5ib3RzID8/IGdldEJvdHMoImFiSURPcmlnaW4iLCBhYklEKTsKCmF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBhYklELCB0YXJnZXQ6IGFiQm90cywgcHVibGljRmFjaW5nOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm5fdXBkYXRlJ30pOycA8fbqrg29ggIXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBADx9uquDcnEBE1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycA8fbqrg29ggIaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBADx9uquDZfFBAEyJwDx9uquDb2CAhVhYk11bHRpcGxlQm90TWVudUljb24CBADx9uquDZnFBAlpb3Nfc2hhcmUnAPH26q4NvYICFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBADx9uquDaPFBAVzaGFyZScA8fbqrg29ggIPYWJQdWJsaXNoU2VsZWN0AgQA8fbqrg2pxQSqE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IHRhZ3MubGFiZWwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vblBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwDx9uquDb2CAglhYlZlcnNpb24CBADx9uquDdLYBAUxMC4yOScA8fbqrg29ggILcGVyc29uYWxpdHkCBADx9uquDdjYBCjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDx9uquDb2CAgV1dGlscwIEAPH26q4N/9gEKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAPH26q4NvYICDmNhblB1Ymxpc2hGaWxlAgQA8fbqrg2m2QT+A0BpZiAoZ2xvYmFsVGhpcy5hYikgewogICAgaWYgKGF1dGhCb3QpIHsKICAgICAgICBpZiAoYWIubGlua3MucmVtZW1iZXIudGFncy5zdWJzY3JpcHRpb25zRW5hYmxlZCkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciAhPT0gJ0ZyZWVQbGF5JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9IGVsc2UgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHdhaXQgZm9yIGFiIHRvIGZpbmlzaCBib290aW5nIGJlZm9yZSBxdWVyeWluZyAke3RhZ05hbWV9LmApCiAgICByZXR1cm4gbnVsbDsKfScA8fbqrg29ggIFZGVidWcCBADx9uquDaXdBAR0cnVlJwEEYm90cyQ3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcBJwDx9uquDardBBVhYkZpbmRBcnRpZmFjdEJ1bmRsZXMCBADx9uquDavdBJMGQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmNvbnN0IGFydGlmYWN0QnVuZGxlczogUmVjb3JkPHN0cmluZywgQUJBcnRpZmFjdEJ1bmRsZT4gPSB7fTsgLy8gS2V5IGlzIGFydGlmYWN0IGlkCgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGIudGFncy5hYkFydGlmYWN0QnVuZGxlKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGIudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEICYmIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICE9PSBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYXJ0aWZhY3RJZCA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlLmlkOwoKICAgICAgICBpZiAoYXJ0aWZhY3RJZCAmJiAhYXJ0aWZhY3RCdW5kbGVzW2FydGlmYWN0SWRdKSB7CiAgICAgICAgICAgIGFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIH0KICAgIH0KfSk7CgpyZXR1cm4gYXJ0aWZhY3RCdW5kbGVzOycA8fbqrg2q3QQFc3RvcmUCBADx9uquDb/jBCjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwDx9uquDardBAZzeXN0ZW0CBADx9uquDebjBBFhYi5zaGVsbC5hcnRpZmFjdCcA8fbqrg2q3QQIYWJJZ25vcmUCBADx9uquDfjjBAR0cnVlJwDx9uquDardBAlhYlZlcnNpb24CBADx9uquDf3jBAUxMC4yOScA8fbqrg2q3QQFZGVidWcCBADx9uquDYPkBAVmYWxzZScA8fbqrg2q3QQIcmVtZW1iZXICBADx9uquDYnkBCjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDx9uquDardBBNhYkNyZWF0ZUFydGlmYWN0Qm90AgQA8fbqrg2w5ATeE0Bjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBhdXRoQm90Py5pZCA/PyBhYi5saW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwKICAgIGRpbWVuc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJJbnN0ID8/ICdob21lJywKICAgIHBvc2l0aW9uID0gbmV3IFZlY3RvcjMoMCwgMCwgMCksCiAgICBvdGhlclRhZ3MgPSB7fSwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJvdCA9IGNyZWF0ZSh7CiAgICBzcGFjZTogJ3NoYXJlZCcsCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICBhYkFydGlmYWN0Qm90OiB0cnVlLAogICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICBbYCR7ZGltZW5zaW9ufVhgXTogcG9zaXRpb24ueCwKICAgIFtgJHtkaW1lbnNpb259WWBdOiBwb3NpdGlvbi55LAogICAgW2Ake2RpbWVuc2lvbn1aYF06IHBvc2l0aW9uLnosCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIGN1cnNvcjogJ3BvaW50ZXInLAogICAgbGFiZWxDb2xvcjogYWJBcnRpZmFjdExhYmVsQ29sb3IsCiAgICBzdHJva2VDb2xvcjogYWJBcnRpZmFjdExhYmVsQ29sb3IsCiAgICBvbkJvdEFkZGVkOiBgQAogICAgICAgIHRoaXNCb3QudXBkYXRlQ29tcHV0ZWRUYWdzKCk7CiAgICBgLAogICAgb25Cb3RDaGFuZ2VkOiBgQAogICAgICAgIGNvbnN0IGNoYW5nZWRUYWdzID0gdGhhdC50YWdzOwoKICAgICAgICBpZiAoY2hhbmdlZFRhZ3Muc29tZSh0ID0+IHQgPT09ICdhYkFydGlmYWN0SW5zdGFuY2VJRCcgfHwgdCA9PT0gJ2FiQXJ0aWZhY3ROYW1lJykpIHsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVDb21wdXRlZFRhZ3MoKTsKICAgICAgICB9CiAgICBgLAogICAgdXBkYXRlQ29tcHV0ZWRUYWdzOiBgQAogICAgICAgIGxldCBzeXN0ZW0gPSAnYWJBcnRpZmFjdEJvdCc7CgogICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHN5c3RlbSArPSAnLicgKyB0YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgc3lzdGVtICs9ICcuJyArIHRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQuc3Vic3RyaW5nKDAsIDcpOwogICAgICAgIH0KCiAgICAgICAgdGFncy5zeXN0ZW0gPSAhIXN5c3RlbSA/IHN5c3RlbSA6IG51bGw7CiAgICAgICAgdGFncy5sYWJlbCA9IHRhZ3Muc3lzdGVtOwogICAgYCwKICAgIG9uQUJBcnRpZmFjdFJlY29uc3RpdHV0ZTogYEAKICAgICAgICAvLyBIaWRlIGFydGlmYWN0IGJvdCBvbmNlIGl0IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQuCiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnZm9ybScsICdub3RoaW5nJywgJ3NoYXJlZCcpOwogICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2xhYmVsJywgJyAnLCAnc2hhcmVkJyk7CiAgICBgLAogICAgLi4ub3RoZXJUYWdzLAp9KTsKCnRyeSB7CiAgICAvLyBVcGRhdGUgYWxsIHRoZSBzaGFyZHMgZm9yIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgLS0gd2hpY2ggbm93IGluY2x1ZGVzIHRoaXMgYm90IQogICAgY29uc3QgdXBkYXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBhYkFydGlmYWN0SW5zdGFuY2VPd25lciB9KTsKCiAgICBpZiAoIXVwZGF0ZVJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gdXBkYXRlICcke2FiQXJ0aWZhY3ROYW1lfScgYXJ0aWZhY3Qgc2hhcmRzLmApOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2h0IGVycm9yIHdoaWxlIHVwZGF0ZSBhcnRpZmFjdCBzaGFyZHM6YCwgZSk7CiAgICBkZXN0cm95KGFiQXJ0aWZhY3RCb3QpOwogICAgcmV0dXJuIG51bGw7Cn0KCnJldHVybiBhYkFydGlmYWN0Qm90OycA8fbqrg2q3QQWYWJBcnRpZmFjdFJlY29uc3RpdHV0ZQIEAPH26q4Nj/gE4C1AaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmFzc2VydCh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJnIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLmApOwoKY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLAogICAgZWdnUGFyYW1ldGVycywgLy8gRWdnIHBhcmFtdGVycyB0aGF0IHlvdSB3b3VsZCBsaWtlIHRvIGhhdmUgcGFzc2VkIHRvIHRoZSByZWNvbnNpdHV0ZWQgYm90cyAob3B0aW9uYWwpLgogICAgdG9hc3QgPSB0cnVlLAp9ID0gdGhhdCBhcyBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnOwoKYXNzZXJ0KGFiQXJ0aWZhY3RCdW5kbGUgJiYgYWJBcnRpZmFjdEJ1bmRsZS5kYXRhICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCdW5kbGUgaXMgcmVxdWlyZWQgdG8gYmUgb2YgdHlwZSBBQkFydGlmYWN0QnVuZGxlLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgc3RyaW5nLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZVN0cmluZyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwpjb25zdCBzaGFyZEJvdHMgPSBbXTsKCmZ1bmN0aW9uIGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUoeyBib3REYXRhIH0pIHsKICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7IC8vIElmIHRoZSBzaGFyZCBib3QgaGFzIGl0c2VsZiBtYXJrZWQgYXMgcmVjb25zdGl0dXRlZCBhbHJlYWR5IChwb3NzaWJseSBkdWUgdG8gYW4gb3ZlcnNpZ2h0KSwgdGhlbiByZW1vdmUgaXQhCgogICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJ1bmRsZVN0cmluZzsgLy8gQXNzaWduIHRoZSBhcnRpZmFjdCBidW5kbGUgYmFjayB0byB0aGUgaGF0Y2hlZCBzaGFyZCBib3QuCiAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gYWJBcnRpZmFjdEluc3RhbmNlSUQ7IC8vIFVVSUQgb2YgdGhlIGFydGlmYWN0IGluc3RhbmNlIHRoYXQgdGhpcyBib3QgYmVsb25ncyB0by4KICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjsgLy8gVGhlIHVzZXIgaWQgdGhlIG93bmVyIG9mIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UuCiAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7IC8vIFVVSUQgYXNzaWduZWQgdG8gdGhlIGJvdCBieSB0aGUgYXJ0aWZhY3Qgd2hlbiBsb2FkZWQuCiAgICB9Cn0KCmZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcykgewogICAgY29uc3QgZGVwZW5kZW5jeUJvdHMgPSBbXTsKCiAgICBpZiAodGhpc0JvdC5pc0VnZ0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICBjb25zdCBlZ2dEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeTsKICAgICAgICAKICAgICAgICAvLyBGaXJzdCB0cnkgdG8gbG9hZCBmcm9tIGVnZy4KICAgICAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgICAgICBhYklEOiBlZ2dEZXBlbmRlbmN5LmFiSUQsCiAgICAgICAgICAgIHJlY29yZEtleTogZWdnRGVwZW5kZW5jeS5yZWNvcmRLZXksCiAgICAgICAgICAgIGFiVmVyc2lvbjogZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24sCiAgICAgICAgICAgIGF1dG9IYXRjaDogdHJ1ZSwKICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUKICAgICAgICB9KQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAke2VnZ0RlcGVuZGVuY3kuYWJJRH0gbG9va3VwRWdnUmVzdWx0OmAsIGxvb2t1cEVnZ1Jlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9va3VwRWdnUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgbG9hZGVkIGRlcGVuZGVuY3kgYWJJRDogJHtlZ2dEZXBlbmRlbmN5LmFiSUR9LCBhYlZlcnNpb246ICR7ZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24gPz8gJ2xhdGVzdCd9YCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoY29uc3QgaGF0Y2hlZEJvdCBvZiBsb29rdXBFZ2dSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA9PT0gMCAmJiB0aGlzQm90LmlzQXNrRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgIGNvbnN0IGFza0RlcGVuZGVuY3kgPSBkZXBlbmRlbmN5IGFzIEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5OwoKICAgICAgICAvLyBUcnkgdG8gbG9hZCBmcm9tIGFzay4KICAgICAgICBjb25zdCBsb29rdXBBc2tSZXN1bHQ6IEFCTG9va3VwQXNrSURSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBc2tJRCh7CiAgICAgICAgICAgIGFza0lEOiBhc2tEZXBlbmRlbmN5LmFza0lELAogICAgICAgICAgICBzaG93SW5kaWNhdG9yOiBmYWxzZSwKICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICBpZ25vcmVSZXNlcnZlZDogdHJ1ZSwKICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUKICAgICAgICB9KQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFza1Jlc3VsdDpgLCBsb29rdXBBc2tSZXN1bHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxvb2t1cEFza1Jlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgaGF0Y2hlZEJvdCBvZiBsb29rdXBBc2tSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICBmb3IgKGNvbnN0IHNoYXJkQm90IG9mIGRlcGVuZGVuY3lCb3RzKSB7CiAgICAgICAgICAgIHNoYXJkQm90cy5wdXNoKHNoYXJkQm90KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSBmYWlsZWQgdG8gbG9hZCBkZXBlbmRlbmN5OiAke0pTT04uc3RyaW5naWZ5KGRlcGVuZGVuY3kpfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIH0KfQoKCmlmIChzaGFyZEJvdHMubGVuZ3RoID4gMCkgewogICAgLy8gVGVsbCBhbGwgaGF0Y2hlZCBzaGFyZCBib3RzIHRvIHJlY29uc3RpdHV0ZS4gVGhleSBhbGwgaGF2ZSBjb3BpZXMgb2YgdGhlIGFiQXJ0aWZhY3RCdW5kbGUgYW5kIGNhbiByZWNvbnN0aXR1dGUgdGhlbXNlbHZlcyBmcm9tIHRoYXQuCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUnLCB7IGRhdGE6IGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSB9KSk7CgogICAgZm9yIChsZXQgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7IC8vIFRoaXMgYm90IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQgaW4gdGhpcyBpbnN0LgogICAgfQoKICAgIGF3YWl0IHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwogICAgCiAgICBjb25zdCByZWNvbnN0aXR1dGlvblJlc3VsdCA9IHsKICAgICAgICBhYkFydGlmYWN0TmFtZTogYWJBcnRpZmFjdEJ1bmRsZS5uYW1lLAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICBzaGFyZEJvdHMsCiAgICB9OwoKICAgIHdoaXNwZXIoc2hhcmRCb3RzLCAnb25SZWNvbnN0aXR1dGVkJywgcmVjb25zdGl0dXRpb25SZXN1bHQpOwogICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCByZWNvbnN0aXR1dGlvblJlc3VsdCk7CgogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9JyAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBmaW5pc2hlZCByZWNvbnN0aXR1dGlvbi5gLCB0b2FzdDogdG9hc3QgfSk7CgogICAgcmV0dXJuIHJlY29uc3RpdHV0aW9uUmVzdWx0Owp9IGVsc2UgewogICAgY29uc3QgZmFpbHVyZVJlc3VsdCA9IHsKICAgICAgICBlcnJvckNvZGU6ICdub19zaGFyZF9ib3RzJywKICAgICAgICBlcnJvck1lc3NhZ2U6ICdSZWNvbnN0aXR1dGlvbiByZXN1bHRzIGluIG5vIHNoYXJkIGJvdHMuJywKICAgICAgICBhYkFydGlmYWN0TmFtZTogYWJBcnRpZmFjdEJ1bmRsZS5uYW1lLAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgIH07CgogICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkJywgZmFpbHVyZVJlc3VsdCk7CgogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9JyAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBmYWlsZWQgcmVjb25zdGl0dXRpb24uYCwgdG9hc3Q6IHRvYXN0IH0pOwogICAgCiAgICByZXR1cm4gZmFpbHVyZVJlc3VsdDsKfQonAPH26q4Nqt0EF2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uAgQA8fbqrg3upQUBMScA8fbqrg2q3QQGc2VhcmNoAgQA8fbqrg3wpQUo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScA8fbqrg2q3QQHYWJTaGVsbAIEAPH26q4Nl6YFBHRydWUnAPH26q4Nqt0EBXV0aWxzAgQA8fbqrg2cpgUo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycA8fbqrg2q3QQPb25BbnlCb3RDbGlja2VkAgQA8fbqrg3DpgWBAUBjb25zdCB7IGJvdCB9ID0gdGhhdDsKCmlmIChib3QgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEJvdCA9PT0gdHJ1ZSkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBib3QgfSkKfScA8fbqrg2q3QQWYWJVcGRhdGVBcnRpZmFjdFNoYXJkcwIEAPH26q4NxacFshxAY29uc3QgYWJBcnRpZmFjdE5hbWUgPSB0aGF0LmFiQXJ0aWZhY3ROYW1lOwpsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSB0aGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwpsZXQgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSB0aGF0LmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID8/IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lOwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKaWYgKHNoYXJkQm90cy5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVGhlcmUgYXJlIG5vIHNoYXJkcyBmb3IgYXJ0aWZhY3QgbmFtZSAnJHthYkFydGlmYWN0TmFtZX0nLmAsIGxvZ1R5cGU6ICd3YXJuJyB9KTsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KCmNvbnN0IHByZXZBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHNoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CmNvbnN0IHByZXZBcnRpZmFjdElEID0gcHJldkFydGlmYWN0QnVuZGxlID8gcHJldkFydGlmYWN0QnVuZGxlLmlkIDogbnVsbDsKY29uc3QgcHJldkFydGlmYWN0SW5zdGFuY2VPd25lciA9IHNoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwoKbGV0IGNvbGxlY3RTaGFyZFJlc3VsdDogQUJBcnRpZmFjdENvbGxlY3RTaGFyZHNSZXN1bHQ7Cgp0cnkgewogICAgY29sbGVjdFNoYXJkUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hYkNvbGxlY3RBcnRpZmFjdFNoYXJkcyh7IHNoYXJkQm90cyB9KTsKCiAgICBpZiAoIWNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGNvbGxlY3RTaGFyZFJlc3VsdC5yZWFzb24sIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQogICAgfQp9IGNhdGNoKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFNvbWV0aGluZyB3ZW50IHdyb25nIGNvbGxlY3Rpbmcgc2hhcmRzLiBTZWUgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Cn0KCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSB0aGlzQm90LmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdFNoYXJkOiBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQgfSk7CgppZiAocHJldkFydGlmYWN0SUQgJiYgcHJldkFydGlmYWN0SUQgIT09IGFiQXJ0aWZhY3RCdW5kbGUuaWQpIHsKICAgIC8vIFRoZSBhcnRpZmFjdCBoYXMgYSBuZXcgaWQuIEFsbCBvZiB0aGUgc2hhcmQgYm90cyBuZWVkIGEgbmV3IGluc3RhbmNlIGlkIGFzIHdlbGwuCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKCiAgICBmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBhYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5hbCBtZXJnZWQgYXJ0aWZhY3QgJHthYkFydGlmYWN0TmFtZX06YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIEV2ZXJ5IHNoYXJkIGJvdCBnZXRzIGEgY29weSBvZiB0aGUgYXJ0aWZhY3QgYnVuZGxlLgovLyBUaGlzIG1ha2VzIHRoZSBhcnRpZmFjdCBob2xvZ3JhcGhpYyBieSBuYXR1cmUuIFRoaXMgbWVhbnMgdGhhdCBhbnkgc2hhcmQgY2FuIGJlIHVzZWQgdG8gcmVjb25zdGl0dXRlIHRoZSB3aG9sZS4KZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIC8vIE1hcmsgZWFjaCBzaGFyZCBib3QgYXMgYmVpbmcgJ3JlY29uc3RpdHV0ZWQnIHdoZW4gd2UgdXBkYXRlIHRoZSBhcnRpZmFjdC4KICAgIC8vIEJlY2F1c2UgdGhpcyBpcyBhIHNoYXJlZCB0YWcgbWFzaywgaXQgd2lsbCBvbmx5IGJlIHRydWUgaW4gdGhlIGN1cnJlbnQgaW5zdC4KICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOwogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlID0gICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwoKICAgIC8vIElmIHRoZSBzaGFyZEJvdCBoYXNudCBiZWVuIG1hcmtlZCBhcyBoYXZpbmcgYW4gaW5zdGFuY2Ugb3duZXIgT1IgaXRzIG93bmVyIGRvZXNudCBtYXRjaCB0aGUgb25lIGJlaW5nIHByb3ZpZGVkIHRvCiAgICAvLyB0aGlzIHVwZGF0ZSBmdW5jdGlvbiB0aGVuIHdlIGNoYW5nZSBpdC4KICAgIGlmICghc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciB8fCBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyICE9PSBhYkFydGlmYWN0SW5zdGFuY2VPd25lcikgewogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPSBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKICAgIH0KfQoKLy8gUnlhbiBDb29rOiBOZWVkIHRvIGdpdmUgQ2FzdWFsT1MgYSBjaGFuY2UgdG8gY2F0Y2h1cC4KLy8gRm91bmQgdGhhdCBpZiB3ZSBkaWRudCBkbyB0aGlzLCBtb2QgdGFncyB3b3VsZCBub3QgYmUgcmV0dXJuZWQgYXMgSlNPTiBvYmplY3RzIGJ1dCBpbnN0ZWFkIHRoZSByYXcgc3RyaW5nLgphd2FpdCBvcy5zbGVlcCgwKTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0ZWQgYXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9Jy4gQ29waWVkIGFydGlmYWN0IGJ1bmRsZSB0byAke3NoYXJkQm90cy5sZW5ndGh9IGJvdHMuIGFiQXJ0aWZhY3RCdW5kbGU6YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCnNob3V0KCdvbkFueUFCQXJ0aWZhY3RTaGFyZHNVcGRhdGVkJywgeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLCBhYkFydGlmYWN0QnVuZGxlLCBzaGFyZEJvdHMgfSkKCi8vIFNoYXJkIHVwZGF0ZSBzdWNjZXNzZnVsLgpyZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07JwDx9uquDardBARtZW51AgQA8fbqrg32wwUo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA8fbqrg2q3QQFbGVhcm4CBADx9uquDZ3EBSjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDx9uquDardBAtvbkdyaWRDbGljawIEAPH26q4NxMQFRkBpZiAobGlua3MuYXJ0aWZhY3RNZW51Qm90cykgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7Cn0nAPH26q4Nqt0EGmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0AgQA8fbqrg2LxQUHI0FFQTFGRicA8fbqrg2q3QQbYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0AgQA8fbqrg2TxQUHIzFlMWIyZCcA8fbqrg2q3QQQb25BbnlCb3RzUmVtb3ZlZAIEAPH26q4Nm8UFlQFAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7CgppZiAobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkICYmIGJvdElEcy5pbmNsdWRlcyhtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQpKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfScA8fbqrg2q3QQHdmVyc2lvbgIEAPH26q4NscYFKPCflJc1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYnAPH26q4Nqt0EGGFiR2V0QXJ0aWZhY3ROYW1lc0luSW5zdAIEAPH26q4N2MYFrAFAY29uc3QgYWJBcnRpZmFjdE5hbWVzID0gbmV3IFNldCgpOwoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIGFiQXJ0aWZhY3ROYW1lcy5hZGQoYi50YWdzLmFiQXJ0aWZhY3ROYW1lKTsKICAgIH0KfSkKCnJldHVybiBhYkFydGlmYWN0TmFtZXM7JwDx9uquDardBBVhYkFydGlmYWN0Qm90TWVudU9wZW4CBADx9uquDYXIBdUXQGNvbnN0IHsgYWJBcnRpZmFjdEJvdCB9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0Qm90ICYmIGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCnNob3V0KCJhYkFydGlmYWN0Qm90TWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkFydGlmYWN0TWVudSI7CgppZiAoIXRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwp9Cgpjb25zdCBhYkFydGlmYWN0QmFzZUNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0QmFzZUNvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQ7CmNvbnN0IGFiQXJ0aWZhY3RMYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0TGFiZWxDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdDsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKCmxldCBpbmZvTGFiZWwgPSBgW2FydGlmYWN0IG5hbWVdOiAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGlkXTogJHthYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLCA3KX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGluc3RhbmNlIGlkXTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPz8gJ3Vuc2V0J30gXG5gOwppbmZvTGFiZWwgKz0gYFthcnRpZmFjdCBpbnN0YW5jZSBvd25lcl06ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID8/ICd1bnNldCd9IFxuYDsKaW5mb0xhYmVsICs9IGBbcmVjb25zdGl0dXRlZCBpbiBpbnN0XTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZH1cbmA7CmluZm9MYWJlbCArPSBgW2Zvcm1hdF06IHYke2FiQXJ0aWZhY3RCdW5kbGUuZm9ybWF0VmVyc2lvbn1cbmA7CmluZm9MYWJlbCArPSBgW2NyZWF0ZWQgdGltZV06ICR7RGF0ZVRpbWUuZnJvbUlTTyhhYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXApLnRvTG9jYWxlU3RyaW5nKERhdGVUaW1lLkRBVEVUSU1FX1NIT1JUX1dJVEhfU0VDT05EUyl9XG5gOwoKLy8gSGVhZGVyCmNvbnN0IGluZm9Cb3QgPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudVRleHQoewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBsYWJlbDogaW5mb0xhYmVsLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGluZm9Cb3QpOwoKLy8gRG93bmxvYWQgc2hhcmQgYnV0dG9uLgpjb25zdCBkb3dubG9hZEJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdkb3dubG9hZCcsCiAgICBsYWJlbDogYGRvd25sb2FkIHNoYXJkYCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSAnYWJBcnRpZmFjdC0nICsgYWJBcnRpZmFjdEJ1bmRsZS5uYW1lICsgJy0nICsgYWJBcnRpZmFjdEJ1bmRsZS5pZC5zdWJzdHJpbmcoMCw3KSArICcuYXV4JzsgCiAgICAgICAgb3MuZG93bmxvYWRCb3RzKFsgbGlua3MuYWJBcnRpZmFjdEJvdCBdLCBmaWxlbmFtZSk7CiAgICAgICAgCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwogICAgYCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaChkb3dubG9hZEJ1dHRvbik7CgovLyBVcGRhdGUgYXJ0aWZhY3QgYnV0dG9uLgpjb25zdCB1cGRhdGVCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGFiQXJ0aWZhY3RCb3Q6IGdldExpbmsoYWJBcnRpZmFjdEJvdCksCiAgICBhYkFydGlmYWN0VG9vbDogZ2V0TGluayh0aGlzQm90KSwKICAgIGZvcm1BZGRyZXNzOiAnc3luYycsCiAgICBsYWJlbDogYHVwZGF0ZSBhcnRpZmFjdGAsCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IGxpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gYWJBcnRpZmFjdEJ1bmRsZS5uYW1lOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOwogICAgICAgIAogICAgICAgIGF3YWl0IGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIH0pOwoKICAgICAgICBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYkFydGlmYWN0Qm90TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBsaW5rcy5hYkFydGlmYWN0Qm90IH0pOwogICAgYCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaCh1cGRhdGVCdXR0b24pOwoKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gYWJBcnRpZmFjdEJvdC5pZDsnAPH26q4Nqt0EGWFiRG93bmxvYWRBcnRpZmFjdFBhdHRlcm4CBADx9uquDdvfBfwEQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgc2hhcmRCb3RzLAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdE5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSAmJiBzaGFyZEJvdHMubGVuZ3RoID4gMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgYSByZXF1aXJlZCBCb3QgYXJyYXkgcGFyYW1ldGVyLiBJdCBtdXN0IGhhdmUgYXQgbGVhc3QgMSBib3QuYCk7CgpyZXR1cm4gbGlua3Muc3RvcmUuYWJEb3dubG9hZCh7IAogICAgcG9zc2libGVCb3RzOiBzaGFyZEJvdHMsCiAgICBmaWxlbmFtZTogYCR7YWJBcnRpZmFjdE5hbWV9YCwKICAgIHNvdXJjZUV2ZW50OiAnZG93bmxvYWRfYXJ0aWZhY3RfcGF0dGVybicsCiAgICByZW9wZW5BYk1lbnU6IGZhbHNlLAogICAgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ6IChhcmcpID0+IHsKICAgICAgICB0aGlzQm90LmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhKGFyZy5ib3REYXRhKTsKICAgIH0KfSk7JwDx9uquDardBBZhYkFydGlmYWN0Qm90TWVudVJlc2V0AgQA8fbqrg3Y5AXvAUBpZiAodGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMgJiYgdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMubGVuZ3RoID4gMCkgewogICAgZGVzdHJveSh0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyk7CiAgICB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwp9Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7Cm1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCA9IG51bGw7JwDx9uquDardBAV0eXBlcwIEAPH26q4NyOYF+wnwn5OEaW50ZXJmYWNlIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgewogICAgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZTsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEPzogc3RyaW5nOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cz86IHN0cmluZzsKICAgIGVnZ1BhcmFtZXRlcnM/OiBhbnk7CiAgICB0b2FzdD86IGJvb2xlYW47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeSB7CiAgICBhYklEOiBzdHJpbmc7CiAgICByZWNvcmRLZXk6IHN0cmluZzsKICAgIGFiVmVyc2lvbj86IG51bWJlcjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5IHsKICAgIGFza0lEOiBzdHJpbmc7Cn0KCnR5cGUgQUJBcnRpZmFjdERlcGVuZGVuY3kgPSBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeSB8IEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5OwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RCdW5kbGUgewogICAgaWQ6IHN0cmluZzsKICAgIG5hbWU6IHN0cmluZzsKICAgIGZvcm1hdFZlcnNpb246IG51bWJlcjsKICAgIGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT47CiAgICBkZXBlbmRlbmNpZXM6IEFycmF5PEFCQXJ0aWZhY3REZXBlbmRlbmN5PjsKICAgIGNhc3VhbE9TVmVyc2lvbjogQXV4VmVyc2lvbjsKICAgIGNyZWF0ZWRUaW1lc3RhbXA6IHN0cmluZzsKICAgIGFiU2hlbGxWZXJzaW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0U2hhcmQgewogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2UgewogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFeHBlcmllbmNlQXV0aCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogc3RyaW5nOwogICAgYXV0aG9yaXplZDogYm9vbGVhbjsKICAgIGZhaWx1cmVSZWFzb246IEFCQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmVSZWFzb247Cn0KCnR5cGUgQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZVJlYXNvbiA9ICd1c2VyX2RlY2xpbmVkX3NpZ25faW4nIHwgJ3VzZXJfZGVjbGluZWRfaW5zdF9wZXJtaXNzaW9uJyB8ICd1bmtub3duJzsKCmludGVyZmFjZSBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuOwogICAgcmVhc29uPzogYW55OwogICAgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKfQonAPH26q4Nqt0EGm9uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlAgQA8fbqrg3C8AXhP0BpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKY29uc3QgeyBib3REYXRhLCBvcmlnaW4sIHN0dWRpbywgcmVjb3JkLCB2ZXJzaW9uLCBlZ2dQYXJhbWV0ZXJzLCBpbml0aWFsQm9vdCwgc291cmNlRXZlbnQgfSA9IHRoYXQ7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhhdCkpKTsKfQoKaWYgKHNvdXJjZUV2ZW50ID09PSAnYXNrJyB8fCAKICAgIHNvdXJjZUV2ZW50ID09PSAncGFzdGUnIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdib290JyB8fCAKICAgIHNvdXJjZUV2ZW50ID09PSAnZmlsZV91cGxvYWQnIHx8CiAgICBzb3VyY2VFdmVudCA9PT0gJ3Rvb2wnIHx8CiAgICBzb3VyY2VFdmVudCA9PT0gJ2NyZWF0ZV9hcnRpZmFjdF9wcm9taXNlJwopIHsKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYm90cyBiZWluZyBhZGRlZCBhcmUgYXJ0aWZhY3Qgc2hhcmRzIHRoYXQgbmVlZHMgdG8gYmUgcmVjb25zdGl0dXRlZC4KICAgIGNvbnN0IGFydGlmYWN0c1RvUmVjb25zdGl0dXRlOiBSZWNvcmQ8c3RyaW5nLCBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnPiA9IHt9OyAvLyBLZXkgaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMoKTsKICAgIGNvbnN0IGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVGhpcyBzZXQgdHJhY2tzIGFydGlmYWN0IGlkcyB0aGF0IGFyZSBhbHJlYWR5IHF1ZXVlZCB0byBiZSByZWNvbnN0aXR1dGVkIHdpdGggYSBuZXcgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7IC8vIFRyYWNrIG9yaWdpbmFsIGluc3RhbmNlIElEcyB0aGF0IHdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBnaXZlIG5ldyBpbnN0YW5jZXMKCiAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgaWYgKGRhdGEgJiYKICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICAgICAgICAgICFkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZT8uc3RhcnRzV2l0aCgn8J+nrCcpCiAgICAgICAgKSB7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmcgPSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOiBzdHJpbmcgPSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBKU09OLnBhcnNlKGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlLnN1YnN0cmluZygyKSk7CgogICAgICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgICAgIC8vIFNoYXJkIGhhcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXNbYWJBcnRpZmFjdEluc3RhbmNlSURdICYmICFvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxOiBJbnN0YW5jZSBhbHJlYWR5IGV4aXN0cyAtIGNyZWF0ZSBuZXcgaW5zdGFuY2UgKGZpcnN0IHRpbWUgd2Ugc2VlIHRoaXMgY29sbGlzaW9uKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzOiBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGVnZ1BhcmFtZXRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5hZGQoYWJBcnRpZmFjdEJ1bmRsZS5pZCk7IC8vIFRyYWNrIHRoYXQgd2UncmUgY3JlYXRpbmcgYSBuZXcgaW5zdGFuY2UgZm9yIHRoaXMgYXJ0aWZhY3QgSUQKICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5hZGQoYWJBcnRpZmFjdEluc3RhbmNlSUQpOyAvLyBUcmFjayB0aGF0IHdlJ3ZlIGRlY2lkZWQgdG8gcmVwbGFjZSB0aGlzIG9yaWdpbmFsIGluc3RhbmNlIElECgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAxOiBTaGFyZCBmcm9tIGV4aXN0aW5nIGluc3RhbmNlLiBDcmVhdGluZyBuZXcgaW5zdGFuY2UuIChvbGQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9LCBuZXc6ICR7bmV3QXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmhhcyhhYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDFiOiBXZSd2ZSBhbHJlYWR5IGRlY2lkZWQgdG8gY3JlYXRlIGEgbmV3IGluc3RhbmNlIGZvciB0aGlzIG9yaWdpbmFsIElEIC0gZGlzcG9zZS4KICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMWI6IEFkZGl0aW9uYWwgc2hhcmQgZm9yIHJlcGxhY2VkIGluc3RhbmNlLiBEaXNwb3NpbmcuIChvcmlnaW5hbDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMjogSW5zdGFuY2UgYWxyZWFkeSBxdWV1ZWQgZm9yIHJlY29uc3RpdHV0aW9uIC0gZGlzcG9zZSBkdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMjogRHVwbGljYXRlIHNoYXJkIGZvciBxdWV1ZWQgaW5zdGFuY2UuIERpc3Bvc2luZy4gKGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMzogSW5zdGFuY2UgdG8gcmVjb25zdGl0dXRlIHdpdGggZXhpc3RpbmcgSUQKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICAgICAgZWdnUGFyYW1ldGVycywKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAzOiBJbnN0YW5jZSB0byByZWNvbnN0aXR1dGUuIChhYkFydGlmYWN0SW5zdGFuY2VJRDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gU2hhcmQgaGFzIG5vIGFydGlmYWN0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICBpZiAoYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuaGFzKGFiQXJ0aWZhY3RCdW5kbGUuaWQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSA0OiBBcnRpZmFjdCBhbHJlYWR5IGhhcyBuZXcgaW5zdGFuY2UgcXVldWVkIC0gZGlzcG9zZSBkdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgNDogRHVwbGljYXRlIHNoYXJkIGZvciBhcnRpZmFjdCB3aXRoIG5ldyBpbnN0YW5jZSBxdWV1ZWQuIERpc3Bvc2luZy4gKGFydGlmYWN0SWQ6ICR7YWJBcnRpZmFjdEJ1bmRsZS5pZH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDU6IENyZWF0ZSBuZXcgaW5zdGFuY2UgZm9yIGFydGlmYWN0IHdpdGhvdXQgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdBcnRpZmFjdEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbbmV3QXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IG5ld0FydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgICAgICAgICAgICAgICAgIGVnZ1BhcmFtZXRlcnMsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5hZGQoYWJBcnRpZmFjdEJ1bmRsZS5pZCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSA1OiBDcmVhdGluZyBuZXcgaW5zdGFuY2UgZm9yIGFydGlmYWN0IHdpdGhvdXQgaW5zdGFuY2UgSUQuIChuZXc6ICR7bmV3QXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBUaGlzIGlzIG5vdCBhIHNoYXJkIGJvdC4gSWdub3JlIGl0LgogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGU6YCwgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlczpgLCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlOmAsIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkOmAsIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkKTsKICAgIH0KCiAgICBmb3IgKGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlKSB7CiAgICAgICAgY29uc3QgcmVjb25zdGl0dXRlQXJnOiBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnID0gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdOwogICAgICAgIAogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gUmVjb25zdGl0dXRpbmcgYXJ0aWZhY3QgaW5zdGFuY2U6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZShyZWNvbnN0aXR1dGVBcmcpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKHNvdXJjZUV2ZW50ID09PSAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgICAgICAgIC8vIERvIGEgc3BlY2lhbCBzaG91dCBzbyB0aGF0IHRoZSBjcmVhdGUgYXJ0aWZhY3QgcHJvbWlzZSBmdW5jdGlvbiBjYW4gY2F0Y2ggdGhpcyBlcnJvci4KICAgICAgICAgICAgICAgIGNvbnN0IGZhaWx1cmVSZXN1bHQgPSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JDb2RlOiAnYXJ0aWZhY3RfcHJvbWlzZV9yZWNvbnN0aXR1dGlvbl9mYWlsZWQnLAogICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZTogYFJlY29uc3RpdHV0aW9uIGZyb20gYXJ0aWZhY3QgcHJvbWlzZSBoYXMgZmFpbGVkLiBDYXVnaHQgZXJyb3I6ICR7bGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpfWAsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0QnVuZGxlLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cywKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lcjogcmVjb25zdGl0dXRlQXJnLmFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLAogICAgICAgICAgICAgICAgICAgIGVnZ1BhcmFtZXRlcnM6IHJlY29uc3RpdHV0ZUFyZy5lZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGU6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBzaG91dCgnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBmYWlsdXJlUmVzdWx0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgdGhyb3cgZTsKICAgICAgICB9CiAgICB9Cn0nAPH26q4Nqt0EG29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaAIEAPH26q4NorAGpQJAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKdGhpc0JvdC5hYlByZXByb2Nlc3NCb3REYXRhVG9BcnRpZmFjdFByb21pc2VzKHsgYm90RGF0YTogdGhhdC5ib3REYXRhIH0pOycA8fbqrg2q3QQWYWJHZXRBcnRpZmFjdEluc3RhbmNlcwIEAPH26q4NyLIGygdAY29uc3QgeyAKICAgIGJvdHMsCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge30KCmlmIChib3RzKSB7CiAgICBhc3NlcnQoQXJyYXkuaXNBcnJheShib3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIG11c3QgYmUgYW4gYXJyYXkuYCk7Cn0KCmNvbnN0IGluc3RhbmNlczogUmVjb3JkPHN0cmluZywgQm90W10+ID0ge30gLy8gS2V5IGlzIGFydGlmYWN0IGluc3RhbmNlIGlkLgoKZnVuY3Rpb24gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYm90KSB7CiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbGV0IGJvdEFycmF5ID0gaW5zdGFuY2VzW2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICAgICAgaWYgKCFib3RBcnJheSkgewogICAgICAgICAgICBib3RBcnJheSA9IFtdOwogICAgICAgICAgICBpbnN0YW5jZXNbYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSURdID0gYm90QXJyYXk7CiAgICAgICAgfQoKICAgICAgICBib3RBcnJheS5wdXNoKGJvdCk7CiAgICB9Cn0KCmlmIChib3RzKSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgaW5zdGFuY2VzIGluIHByb3ZpZGVkIGxpc3Qgb2YgYm90cy4KICAgIGJvdHMuZm9yRWFjaChiID0+IHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGIpKTsKfSBlbHNlIHsKICAgIC8vIEdldCBhcnRpZmFjdCBpbnN0YW5jZXMgaW4gaW5zdC4KICAgIGdldEJvdHMoYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShiKSk7Cn0KCnJldHVybiBpbnN0YW5jZXM7JwDx9uquDardBBVhYkdldEFydGlmYWN0UGF0dGVybnMCBADx9uquDZO6BvMHQGNvbnN0IHsgCiAgICBib3RzLAogICAgYWJBcnRpZmFjdE5hbWUsCn0gPSB0aGF0ID8/IHt9CgppZiAoYm90cykgewogICAgYXNzZXJ0KEFycmF5LmlzQXJyYXkoYm90cyksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyBtdXN0IGJlIGFuIGFycmF5LmApOwp9Cgpjb25zdCBwYXR0ZXJuczogUmVjb3JkPHN0cmluZywgQm90W10+ID0ge30gLy8gS2V5IGlzIGFydGlmYWN0IG5hbWUuCgpmdW5jdGlvbiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGJvdCkgewogICAgLy8gUGF0dGVybiBib3RzIGhhdmUgYWJBcnRpZmFjdE5hbWUgYnV0IG5vIGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgIWJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxldCBib3RBcnJheSA9IHBhdHRlcm5zW2JvdC50YWdzLmFiQXJ0aWZhY3ROYW1lXTsKCiAgICAgICAgaWYgKCFib3RBcnJheSkgewogICAgICAgICAgICBib3RBcnJheSA9IFtdOwogICAgICAgICAgICBwYXR0ZXJuc1tib3QudGFncy5hYkFydGlmYWN0TmFtZV0gPSBib3RBcnJheTsKICAgICAgICB9CgogICAgICAgIGJvdEFycmF5LnB1c2goYm90KTsKICAgIH0KfQoKaWYgKGJvdHMpIHsKICAgIC8vIEdldCBhcnRpZmFjdCBwYXR0ZXJucyBpbiBwcm92aWRlZCBsaXN0IG9mIGJvdHMuCiAgICBib3RzLmZvckVhY2goYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGIpKTsKfSBlbHNlIHsKICAgIC8vIEdldCBhcnRpZmFjdCBwYXR0ZXJucyBpbiBpbnN0LgogICAgZ2V0Qm90cyhiID0+IHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYikpOwp9CgpyZXR1cm4gcGF0dGVybnM7JwDx9uquDardBBhhYlB1Ymxpc2hBcnRpZmFjdFBhdHRlcm4CBADx9uquDYfCBvoFQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgc3R1ZGlvLAogICAgc2hhcmRCb3RzLAogICAgbWFudWFsUHVibGlzaCwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3ROYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2Ygc3R1ZGlvID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdHVkaW8gaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpICYmIHNoYXJkQm90cy5sZW5ndGggPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyBhIHJlcXVpcmVkIEJvdCBhcnJheSBwYXJhbWV0ZXIuIEl0IG11c3QgaGF2ZSBhdCBsZWFzdCAxIGJvdC5gKTsKCnJldHVybiBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hBQih7CiAgICBhYjogYWJBcnRpZmFjdE5hbWUsIAogICAgdGFyZ2V0OiBzaGFyZEJvdHMsIAogICAgc3R1ZGlvLAogICAgbWFudWFsUHVibGlzaCwKICAgIHNvdXJjZUV2ZW50OiAncHVibGlzaF9hcnRpZmFjdF9wYXR0ZXJuJywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2g6IChhcmcpID0+IHsKICAgICAgICB0aGlzQm90LmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhKGFyZy5ib3REYXRhKTsKICAgIH0KfSk7JwDx9uquDardBCZhYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YQIEAPH26q4NgsgGmAdAY29uc3QgYm90RGF0YSA9IHRoYXQ7Cgphc3NlcnQobGlua3MudXRpbHMuaXNPYmplY3QoYm90RGF0YSksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJndW1lbnQgbXVzdCBiZSBhbiBvYmplY3QuYCk7Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwogICAgCiAgICBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3RCb3QgPT09IHRydWUpIHsKICAgICAgICAvLyBSZW1vdmUgYXJ0aWZhY3QgYm90cy4KICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgIAogICAgfSBlbHNlIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAvLyBTdHJpcCBhcnRpZmFjdCBpbnN0YW5jZSBkYXRhIGZyb20gYm90LgogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lcjsKCiAgICAgICAgLy8gUmVtb3ZlIHNvbWUgb3RoZXJzLgogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuY3JlYXRvcjsKCiAgICAgICAgLy8gR2l2ZSBlYWNoIGJvdCBhIGNoYW5jZSB0byBzdHJpcCBpbnN0YW5jZSBkYXRhIGZyb20gdGhlIGNvcHkgb2YgaXRzIG93biBib3QgZGF0YS4KICAgICAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihkYXRhLmlkLCAnb25BQlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YScsIHsgZGF0YSB9KSk7CiAgICB9Cn0KICAgICcA8fbqrg2q3QQPaXNFZ2dEZXBlbmRlbmN5AgQA8fbqrg2bzwZSQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hYklEKSAmJiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5yZWNvcmRLZXkpOycA8fbqrg2q3QQPaXNBc2tEZXBlbmRlbmN5AgQA8fbqrg3uzwYqQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hc2tJRCk7JwDx9uquDardBBBvbkFueUJvdHNDaGFuZ2VkAgQA8fbqrg2Z0AbJCEAvLyBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cgpmb3IgKGNvbnN0IGNoYW5nZWQgb2YgdGhhdCkgewogICAgaWYgKGNoYW5nZWQgPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIC8vIDEpIG9ubHkgY2FyZSBhYm91dCBib3RzIHdpdGggYXJ0aWZhY3QgdGFncwogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lIHx8ICFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSBjb250aW51ZTsKCiAgICAvLyAyKSBhcnRpZmFjdCBtdXN0IGJlIHJlY29uc3RpdHV0ZWQuCiAgICBpZiAoIWNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCkgY29udGludWU7CgogICAgaWYgKHRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGFuZ2VzIG9uIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gZGV0ZWN0ZWQsIGNhbGxpbmcgdG8gdXBkYXRlIGV4cGVyaWVuY2UuYCwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgY2hhbmdlZEJvdElkOiBjaGFuZ2VkLmJvdC5pZCwKICAgICAgICAgICAgICAgIGNoYW5nZWRUYWdzOiBjaGFuZ2VkLnRhZ3MsCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0IGluc3RhbmNlICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gY2hhbmdlZCBidXQgZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KJwDx9uquDardBBlleHBlcmllbmNlVGlja1JhdGVMaW1pdE1TAgQA8fbqrg3j2AYENTAwMCcA8fbqrg2q3QQWY29sbGVjdFNoYXJkc0xpc3RlblRhZwIEAPH26q4N6NgGGW9uQUJBcnRpZmFjdENvbGxlY3RTaGFyZHMnAPH26q4Nqt0ECGRlYnVnRXhwAgQA8fbqrg2C2QYFZmFsc2UnAPH26q4Nqt0EF2lzUmVjb25zdGl0dXRpb25FbmFibGVkAgQA8fbqrg2I2QZ8QGlmIChjb25maWdCb3QudGFncy5hYkFydGlmYWN0UmVjb25zdGl0dXRpb24gPT09IGZhbHNlKSB7CiAgICByZXR1cm4gZmFsc2U7Cn0KCi8vIFJlY29uc3RpdHV0aW9uIG9uIGJ5IGRlZmF1bHQuCnJldHVybiB0cnVlOycA8fbqrg2q3QQXYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMCBADx9uquDYXaBtAYQGNvbnN0IHsgc2hhcmRCb3RzIH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgcmVxdWlyZWQgdG8gYmUgYW4gYm90IGFycmF5LmApOwoKLyoqIEtlZXAgdHJhY2sgb2YgZGVwZW5kZW5jeSBoYXNoZXMuIFRoaXMgcHJldmVudHMgZHVwbGljYXRlcyBpbiB0aGUgYXJ0aWZhY3QgZGVwZW5kZW5jaWVzLiAqLwpjb25zdCBkZXBlbmRlbmN5SGFzaGVzID0gbmV3IFNldCgpOwoKbGV0IG1lcmdlZFNoYXJkOiBBQkFydGlmYWN0U2hhcmQgPSB7CiAgICBkYXRhOiB7fSwKICAgIGRlcGVuZGVuY2llczogW10sCn07Cgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgY29uc3QgYm90U2hvcnRJZCA9IHNoYXJkQm90LmlkLnN1YnN0cmluZygwLCA1KTsKCiAgICBsZXQgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKICAgIGlmIChzaGFyZEJvdC50YWdzW3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10pIHsKICAgICAgICBpZiAoc2hhcmRCb3RbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSkgewogICAgICAgICAgICBzaGFyZCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShzaGFyZEJvdFt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHRhZyBpcyBkZWZpbmVkIGJ1dCBpcyBub3QgYSB2YWxpZCBmdW5jdGlvbi5gIH07CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgc2hhcmQ6YCwgc2hhcmQpOwogICAgfQoKICAgIGlmIChzaGFyZCkgewogICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQpKSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCBtdXN0IGJlIGFuIG9iamVjdC5gIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGF0YSkgewogICAgICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzT2JqZWN0KHNoYXJkLmRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgJ2RhdGEnIHByb3BlcnR5IG11c3QgYmUgYW4gb2JqZWN0LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2hhbGxvdyBtZXJnZSBzaGFyZCdzIGRhdGEgcHJvcGVydGllcyBpbnRvIGNvbWJpbmVkIGFydGlmYWN0IGRhdGEuCiAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRhdGEgPSB7IC4uLm1lcmdlZFNoYXJkLmRhdGEsIC4uLnNoYXJkLmRhdGEgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc0FycmF5KHNoYXJkLmRlcGVuZGVuY2llcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCAnZGVwZW5kZW5jaWVzJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIGFycmF5LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgdGhhdCBkZXBlbmRlbmN5IGlzIG9uZSBvZiB0aGUgc3VwcG9ydGVkIHR5cGVzLgogICAgICAgICAgICAgICAgaWYgKCF0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSAmJiAhdGhpc0JvdC5pc0Fza0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIGhhcyBhIGRlcGVuZGVuY3kgZW50cnkgdGhhdCBpcyBuZWl0aGVyIGFuIGVnZyBvciBhc2sgZGVwZW5kZW5jeSB0eXBlLmAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBkZXBlbmRlbmN5IGlzbnQgYWxyZWFkeSBjb2xsZWN0ZWQuCiAgICAgICAgICAgICAgICBjb25zdCBoYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgZGVwZW5kZW5jeSk7CgogICAgICAgICAgICAgICAgaWYgKCFkZXBlbmRlbmN5SGFzaGVzLmhhcyhoYXNoKSkgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lIYXNoZXMuYWRkKGhhc2gpOwogICAgICAgICAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBNYWtlIHN1cmUgd2UgaGF2ZSBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeS4KaWYgKG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIG11c3QgbGlzdCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeSBpbiBvcmRlciB0byByZWNvbnN0aXR1dGUgcHJvcGVybHkuYCB9Owp9Cgpjb25zdCByZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0ID0gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIHNoYXJkOiBtZXJnZWRTaGFyZCwKfQoKcmV0dXJuIHJlc3VsdDsnAPH26q4Nqt0EF2NhblVzZXJVcGRhdGVFeHBlcmllbmNlAgQA8fbqrg3W8gbOCUBjb25zdCB7CiAgICByZW1vdGVJZCA9IGNvbmZpZ0JvdC5pZCwKICAgIHNoYXJkQm90Cn0gPSB0aGF0ID8/IHt9CgppZiAoc2hhcmRCb3QgJiYgCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlECikgewogICAgLy8gTmVlZCB0byBmaWd1cmUgb3V0IGlmIHRoaXMgdXNlciBpcyBhbGxvd2VkIHRvIHVwZGF0ZSB0aGUgZXhwZXJpZW5jZSBvZiB0aGlzIGFydGlmYWN0IGluc3RhbmNlLgogICAgbGV0IGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKCiAgICBzd2l0Y2ggKHNoYXJkQm90LnNwYWNlKSB7CiAgICAgICAgY2FzZSAnc2hhcmVkJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgY2FzZSAndGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBiYXNpY2FsbHkgb3duZWQgYnkgdGhpcyB1c2VyLgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncmVtb3RlVGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHJlbW90ZVRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBvd25lZCBieSBzb21lb25lIGVsc2UuCiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnbG9jYWwnOgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAndGVtcExvY2FsJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgYm90IHNwYWNlOmAsIHNoYXJkQm90LnNwYWNlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIGNhblVzZXJVcGRhdGU7Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHByb3ZpZGVkIHNoYXJkQm90IGRvZXMgbm90IGFwcGVhciB0byBiZSBmcm9tIGFuIGFydGlmYWN0IGluc3RhbmNlLmAsIHNoYXJkQm90KTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKfScA8fbqrg2q3QQaYWJDcmVhdGVBcnRpZmFjdFByb21pc2VCb3QCBADx9uquDaX8BuIVQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0U2hhcmQsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IGF1dGhCb3Q/LmlkID8/IGFiLmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lLAogICAgc3BhY2UgPSAnc2hhcmVkJywKfSA9IHRoYXQgPz8ge307CgoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYm90RGF0YSA9IFtdOwpjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0QnVuZGxlKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RTaGFyZCB9KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGdlbmVyYXRlZCBhYkFydGlmYWN0QnVuZGxlOmAsIGFiQXJ0aWZhY3RCdW5kbGUpOwp9Cgpib3REYXRhW3Byb21pc2VJZF0gPSB7CiAgICBpZDogcHJvbWlzZUlkLAogICAgc3BhY2UsCiAgICB0YWdzOiB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIsCiAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogJ/Cfp6wnICsgSlNPTi5zdHJpbmdpZnkoYWJBcnRpZmFjdEJ1bmRsZSksCiAgICAgICAgYWJBcnRpZmFjdFByb21pc2U6IHRydWUsCiAgICB9Cn0KCi8vIENyZWF0ZSBhcnRpZmFjdCBwcm9taXNlIHRocm91Z2ggYWJDcmVhdGVCb3RzLiAKLy8gVGhpcyB3aWxsIHRyaWdnZXIgYXJ0aWZhY3QncyBvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSBhbmQgaXQgd2lsbCBmaW5kCi8vIHRoaXMgYXJ0aWZhY3QgcHJvbWlzZSBhbmQgdXNlIHRoZSBkYXRhIHRvIHJlY29uc3RpdHV0ZSBpdC4KbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdERhdGEsIHNvdXJjZUV2ZW50OiAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnIH0pOwoKY29uc3Qgd2FpdEZvclJlY29uc3RpdHV0aW9uID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgZnVuY3Rpb24gY2xlYW51cCgpIHsKICAgICAgICBvcy5yZW1vdmVCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKTsKICAgICAgICBvcy5yZW1vdmVCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQpOwogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKGxpc3RlbmVyVGhhdCkgewogICAgICAgIGlmIChsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIHx8CiAgICAgICAgICAgIGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgICkgewogICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgIHJlc29sdmUobGlzdGVuZXJUaGF0KTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkKGxpc3RlbmVyVGhhdCkgewogICAgICAgIGlmIChsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIHx8CiAgICAgICAgICAgIGxpc3RlbmVyVGhhdC5hYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgICkgewogICAgICAgICAgICBjbGVhbnVwKCk7CiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IobGlzdGVuZXJUaGF0LmVycm9yTWVzc2FnZSkpOwogICAgICAgIH0KICAgIH0KCiAgICBvcy5hZGRCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVkKTsKICAgIG9zLmFkZEJvdExpc3RlbmVyKHRoaXNCb3QsICdvbkFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCcsIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZCk7Cn0pCgpjb25zdCByZWNvbnN0aXR1dGVSZXN1bHQgPSBhd2FpdCB3YWl0Rm9yUmVjb25zdGl0dXRpb247CgpyZXR1cm4gcmVjb25zdGl0dXRlUmVzdWx0LnNoYXJkQm90czsnAPH26q4Nqt0EFmFiQ3JlYXRlQXJ0aWZhY3RCdW5kbGUCBADx9uquDYaSB5kIQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdFNoYXJkLAp9ID0gdGhhdDsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHsKICAgIG5hbWU6IGFiQXJ0aWZhY3ROYW1lLAogICAgZm9ybWF0VmVyc2lvbjogMSwKICAgIGRhdGE6IGFiQXJ0aWZhY3RTaGFyZC5kYXRhLAogICAgZGVwZW5kZW5jaWVzOiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLAp9CgovLyBHZW5lcmF0ZSB0aGUgYXJ0aWZhY3QgaWQsIHdoaWNoIGlzIHNoYTI1NiBoYXNoIG9mIHRoZSBjb3JlIGNvbnRlbnRzIG9mIHRoZSBhcnRpZmFjdC4KYWJBcnRpZmFjdEJ1bmRsZS5pZCA9IGNyeXB0by5zaGEyNTYoYWJBcnRpZmFjdEJ1bmRsZSk7CgovLyBTdG9yZSBzb21lIGV4dHJhIG1ldGFkYXRhIHByb3BlcnRpZXMgd2l0aCB0aGUgYXJ0aWZhY3QuCi8vIFRoZXNlIGFyZSBub3QgY29yZSB0byB0aGUgYXJ0aWZhY3QncyBmdW5jdGlvbmFsaXR5IGJ1dCBtYXkgYmUgdXNlZnVsIGFzIGFydGlmYWN0cyBldm9sdmUuCmFiQXJ0aWZhY3RCdW5kbGUuY2FzdWFsT1NWZXJzaW9uID0gb3MudmVyc2lvbigpOwphYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXAgPSBEYXRlVGltZS5ub3coKS50b0lTTygpOwphYkFydGlmYWN0QnVuZGxlLmFiU2hlbGxWZXJzaW9uID0gYCR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1ham9yVmVyc2lvbn0uJHtsaW5rcy52ZXJzaW9uLnJhdy5hYlNoZWxsTWlub3JWZXJzaW9ufWA7CgpyZXR1cm4gYWJBcnRpZmFjdEJ1bmRsZTsnAPH26q4Nqt0EBmNyZWF0ZQIEAPH26q4NoJoHKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAPH26q4Nqt0EE2lzRXhwZXJpZW5jZUVuYWJsZWQCBADx9uquDceaB3RAaWYgKGNvbmZpZ0JvdC50YWdzLmFiQXJ0aWZhY3RFeHBlcmllbmNlID09PSB0cnVlKSB7CiAgICByZXR1cm4gdHJ1ZTsKfQoKLy8gRXhwZXJpZW5jZSBvZmYgYnkgZGVmYXVsdC4KcmV0dXJuIGZhbHNlOycA8fbqrg2q3QQeYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50AgQA8fbqrg28mwfJHEBjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyLCAvLyBbUnlhbiBDb29rXTogSSB3aWxsIG5lZWQgdGhpcyB3aGVuIEkgZ2V0IGJhY2sgdG8gYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZS4KfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MgPSB7fTsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYWxyZWFkeSBoYXMgYSBkb2N1bWVudCBsb2FkZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmxldCBleHBlcmllbmNlQXV0aDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCmlmICghZXhwZXJpZW5jZUF1dGguYXV0aG9yaXplZCkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEFydGlmYWN0IGV4cGVyaWVuY2Ugd2FzIG5vdCBhdXRob3JpemVkLiBSZWFzb246ICR7ZXhwZXJpZW5jZUF1dGguZmFpbHVyZVJlYXNvbn1gKTsKICAgIHJldHVybjsKfQoKLy8gR2V0IHRoZSBhcnRpZmFjdCBpbnN0YW5jZSdzIHNoYXJlZCBkb2N1bWVudCBhcyB3ZWxsIGFzIHRoZSBleHBlcmllbmNlIG1hcC4KY29uc3QgZG9jdW1lbnQgPSBhd2FpdCBvcy5nZXRTaGFyZWREb2N1bWVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwgYGFydGlmYWN0SW5zdGFuY2VfJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gLCAnbWFpbicpOwpjb25zdCBleHBlcmllbmNlTWFwID0gZG9jdW1lbnQuZ2V0TWFwKCdleHBlcmllbmNlJyk7Cgpjb25zdCBza2lwS2V5cyA9IG5ldyBTZXQoWwogICAgJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnLAogICAgLy8gQWRkIG1vcmUga2V5cyBoZXJlIGlmIG5lZWRlZAogICAgLy8gJ3NvbWVPdGhlcktleScsCiAgICAvLyAneWV0QW5vdGhlcktleScKXSk7Cgpjb25zdCBleHBlcmllbmNlU3ViID0gZXhwZXJpZW5jZU1hcC5kZWVwQ2hhbmdlcy5zdWJzY3JpYmUoKGV2ZW50cykgPT4gewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9uIGRlZXAgY2hhbmdlczpgLCBldmVudHMpOwogICAgfQoKICAgIC8vIENvbGxlY3QgYWxsIGNoYW5nZWQga2V5cwogICAgY29uc3QgYWxsS2V5cyA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZXZ0IG9mIGV2ZW50cyA/PyBbXSkgewogICAgICAgIGNvbnN0IG0gPSBldnQ/LmNoYW5nZXM7CiAgICAgICAgaWYgKG0gJiYgdHlwZW9mIG0ua2V5cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBmb3IgKGNvbnN0IGsgb2YgbS5rZXlzKCkpIHsKICAgICAgICAgICAgICAgIGFsbEtleXMuYWRkKGspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFNraXAgaWYgKmFsbCogY2hhbmdlcyBhcmUgaW5zaWRlIHRoZSBza2lwIGxpc3QKICAgIGNvbnN0IHNob3VsZFNraXAgPSBhbGxLZXlzLnNpemUgPiAwICYmIFsuLi5hbGxLZXlzXS5ldmVyeSgoaykgPT4gc2tpcEtleXMuaGFzKGspKTsKICAgIGlmIChzaG91bGRTa2lwKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYWxsIHRvIGFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlLCB0aGUgb25seSBjaGFuZ2UgdG8gdGhlIGV4cGVyaWVuY2Ugd2VyZSBzcGVjaWFsIHJlc2VydmVkIHByb3BlcnRpZXMuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0pOwoKdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gPSB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3VifTsKCmlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGluc3RhbmNlIGRvY3VtZW50IGxvYWRlZDpgLCB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSk7CgogICAgY29uc3QgZXhwZXJpZW5jZUpTT04gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VNYXAudG9KU09OKCkpKTsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gbG9hZGVkIGV4cGVyaWVuY2UgbWFwIHN0YXRlOmAsIGV4cGVyaWVuY2VKU09OKTsKfQoKY29uc3QgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9IGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJyk7CgppZiAoYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9PT0gdHJ1ZSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0aW5nIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGZyb20gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEltbWVkaWF0ZWx5IGdpdmUgdGhlIHNoYXJkIGJvdHMgdGhlIGN1cnJlbnQgZXhwZXJpZW5jZSBzdGF0ZS4KICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbml0aWFsaXppbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEluaXRpYWxpemUgdGhlIGV4cGVyaWVuY2Ugc3RhdGUgd2l0aCB0aGUgY3VycmVudCBzaGFyZCBkYXRhLgogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7ICAgIAp9CicA8fbqrg2q3QQgYWJVbmxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQCBADx9uquDYa4B4kGQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IHsgZG9jdW1lbnQsIGV4cGVyaWVuY2VNYXAsIGV4cGVyaWVuY2VTdWIgfSA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOyAKCiAgICBpZiAoZXhwZXJpZW5jZVN1YikgewogICAgICAgIGV4cGVyaWVuY2VTdWIudW5zdWJzY3JpYmUoKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bnN1YnNjcmliZWQgZnJvbSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBleHBlcmllbmNlIG1hcC5gKTsKICAgICAgICB9CiAgICB9CgogICAgZGVsZXRlIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZW1vdmVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGRvY3VtZW50LmApOwogICAgfQp9JwDx9uquDardBB5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMCBADx9uquDZC+B7QCQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgIHJldHVybiBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0pOwoKcmV0dXJuIHNoYXJkQm90czsnAPH26q4Nqt0EJmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlAgQA8fbqrg3FwAfpB0Bjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICByZXR1cm47Cn0KCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCBpbnN0YW5jZURvYyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmIChpbnN0YW5jZURvYykgewogICAgICAgIGNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUR9KTsKCiAgICAgICAgY29uc3QgeyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1YiB9ID0gaW5zdGFuY2VEb2M7CgogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VEYXRhID0gZXhwZXJpZW5jZU1hcC50b0pTT04oKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSB3aXRoIGV4cGVyaWVuY2Ugc3RhdGU6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlRGF0YSkpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHdoaXNwZXIoc2hhcmRCb3RzLCAnb25BQkFydGlmYWN0RXhwZXJpZW5jZScsIHsgZGF0YTogZXhwZXJpZW5jZURhdGEgfSkpOwogICAgfQp9JwDx9uquDardBCJhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlAgQA8fbqrg2vyAfQKEBpbXBvcnQgeyBTaGFyZWRNYXAgfSBmcm9tICdjYXN1YWxvcyc7Cgpjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKCF0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMpIHsKICAgIHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcyA9IG5ldyBTZXQoKTsKfQoKaWYgKHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSB1cGRhdGUgaXMgYWxyZWFkeSBpbiBwcm9ncmVzcyBmb3IgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgIH0KICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgY29uc3QgaW5zdGFuY2VEb2MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICBpZiAoaW5zdGFuY2VEb2MpIHsKICAgICAgICBjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKICAgICAgICAvLyBOZWVkIHRvIGFzayBpZiB0aGlzIHVzZXIgaXMgYWxsb3dlZCB0byB1cGRhdGUgdGhlIGV4cGVyaWVuY2Ugb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgICAgICBjb25zdCBjYW5Vc2VyVXBkYXRlID0gYXdhaXQgdGhpc0JvdC5jYW5Vc2VyVXBkYXRlRXhwZXJpZW5jZSh7IHJlbW90ZUlkOiBjb25maWdCb3QuaWQsIHNoYXJkQm90OiBzaGFyZEJvdHNbMF0gfSk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2FuIHVzZXIgdXBkYXRlIGV4cGVyaWVuY2UgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7c2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQuc3Vic3RyaW5nKDAsIDcpfT9gLCBjYW5Vc2VyVXBkYXRlKTsKICAgICAgICB9CgogICAgICAgIGlmIChjYW5Vc2VyVXBkYXRlKSB7CiAgICAgICAgICAgIGxldCBjb2xsZWN0U2hhcmRSZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0OwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbGxlY3RTaGFyZFJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMoeyBzaGFyZEJvdHMgfSk7CgogICAgICAgICAgICAgICAgaWYgKCFjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY29sbGVjdFNoYXJkUmVzdWx0LnJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOmAsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBgY29sbGVjdFNoYXJkUmVzdWx0OmAsIEpTT04uc3RyaW5naWZ5KGNvbGxlY3RTaGFyZFJlc3VsdCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29sbGVjdFNoYXJkUmVzdWx0ICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBlbnRyeSBpbiBleHBlcmllbmNlTWFwIGlmIHRoZSBkYXRhIGlzIGFjdHVhbGx5IGRpZmZlcmVudC4KICAgICAgICAgICAgICAgIGNvbnN0IGV4cGVyaWVuY2VNYXA6IFNoYXJlZE1hcCA9IGluc3RhbmNlRG9jLmV4cGVyaWVuY2VNYXA7CgogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBzaGFyZCBkYXRhIG1pZ2h0IGJlIHVuZGVmaW5lZC9udWxsCiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGEgPSAoY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhKSA/IGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhIDoge307CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGFLZXlzID0gT2JqZWN0LmtleXMoc2hhcmREYXRhKTsKICAgICAgICAgICAgICAgIGNvbnN0IGtleXNUb0RlbGV0ZSA9IFtdOwoKICAgICAgICAgICAgICAgIC8vIFNpbXBsZSBkZWVwLWVxdWFsaXR5IGNoZWNrIGZvciBKU09OLXNlcmlhbGl6YWJsZSB2YWx1ZXMKICAgICAgICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSAoYSwgYikgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChhID09PSBiKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYSkgPT09IEpTT04uc3RyaW5naWZ5KGIpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyAxKSBVcHNlcnQgb25seSB3aGVuIGRpZmZlcmVudAogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2Ygc2hhcmREYXRhS2V5cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1ZhbCA9IHNoYXJkRGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbCA9IGV4cGVyaWVuY2VNYXAuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0VxdWFsKG9sZFZhbCwgbmV3VmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBleHBlcmllbmNlTWFwIGtleSAiJHtrZXl9ImAsIEpTT04uc3RyaW5naWZ5KHsgb2xkVmFsLCBuZXdWYWwgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KGtleSwgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMikgQ29sbGVjdCBrZXlzIHRoYXQgZXhpc3QgaW4gdGhlIG1hcCBidXQgbm90IGluIHRoZSBzaGFyZCBkYXRhCiAgICAgICAgICAgICAgICAvLyAgICAod2UgYXZvaWQgbXV0YXRpbmcgdGhlIG1hcCB3aGlsZSBpdGVyYXRpbmcgaXQpCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBleHBlcmllbmNlTWFwLmtleXMoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09ICdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBkZWxldGUgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZC4gSXRzIGEgc3BlY2lhbCBwcm9wZXJ0eS4KICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICghc2hhcmREYXRhS2V5cy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleXNUb0RlbGV0ZS5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMpIFJlbW92ZSBzdGFsZSBrZXlzCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzVG9EZWxldGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlbGV0aW5nIHN0YWxlIGV4cGVyaWVuY2VNYXAga2V5ICIke2tleX0iYCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgIT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSBpbnN0YW5jZSBkb2N1bWVudCBub3QgbG9hZGVkLmApOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IHVwZGF0ZSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBiZWNhdXNlIGluc3RhbmNlIGRvY3VtZW50cyBoYXZlIG5vdCBiZWVuIGluaXRpYWxpemVkLmApOwogICAgfQp9Cgp0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuZGVsZXRlKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsnAPH26q4Nqt0EDG9uSW5zdEpvaW5lZAIEAPH26q4NgPEHgQNAbWFza3MuaW5zdEpvaW5lZCA9IHRydWU7Cgpjb25zdCBhcnRpZmFjdEluc3RhbmNlcyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwoKZm9yIChsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RJbnN0YW5jZXMpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb2FkaW5nIGFydGlmYWN0IGluc3RhbmNlIGRvY3VtZW50IGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWApOwogICAgfQogICAgCiAgICB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9JwDx9uquDardBA5vbkFueUJvdHNBZGRlZAIEAPH26q4NgvQHwgRAaWYgKCFtYXNrcy5pbnN0Sm9pbmVkKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFkZGVkQm90cyA9IHRoYXQuYm90czsKCmZvciAoY29uc3QgYm90IG9mIGFkZGVkQm90cykgewogICAgaWYgKGJvdCA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjUwKTsKCiAgICAgICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGV0ZWN0ZWQgYWRkZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7Ym90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9LmApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgICAgIH0KICAgIH0KfScA8fbqrg2q3QQab25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQCBADx9uquDcX4B94FQGxldCBhYkNvbW1hbmRzOiBBQkNvbW1hbmRzTWFuYWdlciA9IHRoYXQ7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3ByaW50YXJ0aWZhY3RleHBlcmllbmNlJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGluc3RhbmNlRG9jcyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3M7CgogICAgbGV0IGFsbEV4cGVyaWVuY2UgPSB7fTsKCiAgICBmb3IgKGxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBpbnN0YW5jZURvY3MpIHsKICAgICAgICBjb25zdCBleHBlcmllbmNlTWFwID0gaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXS5leHBlcmllbmNlTWFwOwogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VKU09OID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlTWFwLnRvSlNPTigpKSk7CiAgICAgICAgYWxsRXhwZXJpZW5jZVthYkFydGlmYWN0SW5zdGFuY2VJRF0gPSBleHBlcmllbmNlSlNPTjsKICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW3ByaW50YXJ0aWZhY3RleHBlcmllbmNlXSBBbGwgY3VycmVudCBhcnRpZmFjdCBpbnN0YW5jZSBleHBlcmllbmNlIHN0YXRlczpgLCBhbGxFeHBlcmllbmNlKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1ByaW50IGFsbCBjdXJyZW50bHkgbG9hZGVkIGFydGlmYWN0IGluc3RhbmNlIGV4cGVyaWVuY2Ugc3RhdGVzIHRvIHRoZSBjb25zb2xlLicsCiAgICB1c2FnZTogWycucHJpbnRhcnRpZmFjdGV4cGVyaWVuY2UnXQp9KTsnAPH26q4Nqt0EGGFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aAIEAPH26q4NpP4H3BJAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBleHBBdXRoUmVzdWx0OiBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGggPSB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGF1dGhvcml6ZWQ6IHVuZGVmaW5lZCwKICAgIGZhaWx1cmVSZWFzb246IHVuZGVmaW5lZCwKfQoKaWYgKGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSkgewogICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSBhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkOwoKICAgIHJldHVybiBleHBBdXRoUmVzdWx0Owp9CgpsZXQgbXlBdXRoQm90ID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCmlmICghbXlBdXRoQm90KSB7CiAgICAvLyBOb3Qgc2lnbmVkIGluLCBuZWVkIHRvIHNpZ24gaW4gdG8gdXNlIGFydGlmYWN0IGV4cGVyaWVuY2UuCiAgICBsZXQgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IGdsb2JhbFRoaXMuYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKCiAgICBpZiAoIWFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UpIHsKICAgICAgICBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlID0gb3Muc2hvd0NvbmZpcm0oewogICAgICAgICAgICB0aXRsZTogJ1NpZ24gSW4gUmVxdWlyZWQnLAogICAgICAgICAgICBjb250ZW50OiAnVGhpcyBzZXJ2ZXIgaGFzIGFydGlmYWN0cyB0aGF0IHdvcmsgYmVzdCB3aGVuIHlvdeKAmXJlIHNpZ25lZCBpbi4gSWYgeW91IGNvbnRpbnVlIHdpdGhvdXQgc2lnbmluZyBpbiwgdGhlIGFydGlmYWN0cyBtYXkgbm90IHN0YXkgaW4gc3luYy4nLAogICAgICAgICAgICBjb25maXJtVGV4dDogJ1NpZ24gSW4nLAogICAgICAgICAgICBjYW5jZWxUZXh0OiAnQ29udGludWUgV2l0aG91dCcKICAgICAgICB9KTsKCiAgICAgICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0VXNlckF1dGhQcm9taXNlID0gYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKICAgIH0KCiAgICBjb25zdCBjb25maXJtZWQgPSBhd2FpdCBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlOwogICAgZGVsZXRlIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZTsKCiAgICBpZiAoY29uZmlybWVkKSB7CiAgICAgICAgbXlBdXRoQm90ID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICAgICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbic7CiAgICAgICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlID0gZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uOwogICAgICAgIAogICAgICAgIHJldHVybiBleHBBdXRoUmVzdWx0OwogICAgfQp9CgppZiAoIW15QXV0aEJvdCkgewogICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSAndW5rbm93bic7CiAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUgPSBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb247CgogICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Cn0KCi8vIGNvbnN0IGFkbWluUGVybWlzc2lvblJlc3VsdCA9IGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSk7Ci8vIGNvbnNvbGUubG9nKGBhZG1pblBlcm1pc3Npb25SZXN1bHQ6YCwgYWRtaW5QZXJtaXNzaW9uUmVzdWx0KTsKCi8vIGlmIChhZG1pblBlcm1pc3Npb25SZXN1bHQuc3VjY2VzcykgewovLyAgICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gdHJ1ZTsKCi8vICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKLy8gfSBlbHNlIHsKLy8gICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwovLyAgICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfaW5zdF9wZXJtaXNzaW9uJzsKLy8gICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSA9IGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbjsKCi8vICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKLy8gfQoKZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gdHJ1ZTsKCnJldHVybiBleHBBdXRoUmVzdWx0OycA8fbqrg2q3QQRb25BQkJlZm9yZVB1Ymxpc2gCBADx9uquDf+QCIcEQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwDx9uquDardBBJvbkFCQmVmb3JlRG93bmxvYWQCBADx9uquDYeVCIcEQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwDx9uquDardBBlhYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzAgQA8fbqrg2PmQihBUBjb25zdCBhcnRpZmFjdEluc3RhbmNlczogUmVjb3JkPHN0cmluZywgQm90W10+ID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VzKCk7Cgpmb3IgKGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGFydGlmYWN0SW5zdGFuY2VzKSB7CiAgICBjb25zdCBzaGFyZEJvdCA9IGFydGlmYWN0SW5zdGFuY2VzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXS5maW5kKGIgPT4gYiAhPSBudWxsKTsKCiAgICBpZiAoIXNoYXJkQm90KSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdW5hYmxlIHRvIHVwZGF0ZSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBiZWNhdXNlIHRoZXJlIHdlcmUgbm8gc2hhcmQgYm90cyBmb3VuZC5gKTsKICAgICAgICBjb250aW51ZTsKICAgIH0KCiAgICBjb25zdCBhYkFydGlmYWN0TmFtZSA9IHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICBjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VPd25lciA9IHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlT3duZXI7CiAgICAKICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdEluc3RhbmNlT3duZXIgfSk7Cn0nAPH26q4Nqt0EHG9uQUJQcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQCBADx9uquDbGeCOMCQGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmlmICh0aGF0LnNvdXJjZUV2ZW50ICE9PSAnZG93bmxvYWRfYXJ0aWZhY3RfcGF0dGVybicpIHsKICAgIHRoaXNCb3QuYWJQcmVwcm9jZXNzQm90RGF0YVRvQXJ0aWZhY3RQcm9taXNlcyh7IGJvdERhdGE6IHRoYXQuYm90RGF0YSB9KTsKfScA8fbqrg2q3QQlYWJQcmVwcm9jZXNzQm90RGF0YVRvQXJ0aWZhY3RQcm9taXNlcwIEAPH26q4NlaEI+g9ALyoqCiAqIFRoaXMgZnVuY3Rpb24gdGFrZXMgYm90RGF0YSAoZnJvbSBvbkFCUHJlcHJvY2Vzc0JlZm9yZSogY2FsbHMpIGFuZCByZXBsYWNlcyBhbnkgc2hhcmQgYm90cyB3aXRoIGFydGlmYWN0IHByb21pc2UgYm90cy4KICovCgpjb25zdCBib3REYXRhID0gdGhhdD8uYm90RGF0YTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0YXJ0aW5nIGJvdERhdGE6YCwgey4uLmJvdERhdGF9KTsKfQoKYXNzZXJ0KHR5cGVvZiBib3REYXRhID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3REYXRhIGlzIGEgcmVxdWlyZWQgb2JqZWN0LmApOwoKLy8gRGV0ZWN0IGFydGlmYWN0IGluc3RhbmNlcyB0aGF0IG5lZWQgdG8gYmUgY29udmVydGVkIGludG8gYXJ0aWZhY3QgcHJvbWlzZXMuCgovKioga2V5OiBhcnRpZmFjdCBpbnN0YW5jZSBpZCwgdmFsdWU6IGFydGlmYWN0IHByb21pc2UgZGF0YS4gKi8KY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZSA9IG5ldyBTZXQoKTsgLy8gS2VlcCB0cmFjayBvZiB3aGF0IGFydGlmYWN0IGluc3RhbmNlIElEcyBoYXZlIGhhZCBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUuCgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QuCiAgICAgICAgaWYgKCFhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmhhcyhkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgIC8vIFRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgbmVlZHMgYW4gYXJ0aWZhY3QgcHJvbWlzZSBtYWRlIGZvciBpdC4KICAgICAgICAgICAgY29uc3QgcHJvbWlzZUlkID0gdXVpZCgpOwoKICAgICAgICAgICAgYm90RGF0YVtwcm9taXNlSWRdID0gewogICAgICAgICAgICAgICAgaWQ6IHByb21pc2VJZCwKICAgICAgICAgICAgICAgIHNwYWNlOiAnc2hhcmVkJywKICAgICAgICAgICAgICAgIHRhZ3M6IHsKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlT3duZXI6IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0UHJvbWlzZTogdHJ1ZSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ29udmVydGVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7ZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEfSBpbnRvIGFuIGFydGlmYWN0IHByb21pc2U6YCwgYm90RGF0YVtwcm9taXNlSWRdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZS5hZGQoZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsKICAgICAgICB9CgogICAgICAgIC8vIFJlbW92ZSBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QgZnJvbSBib3REYXRhIHRoYXQgaXMgYWJvdXQgdG8gYmUgcHVibGlzaGVkLgogICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZpbmlzaGVkIGJvdERhdGE6YCwgey4uLmJvdERhdGF9KTsKfScA8fbqrg2q3QQdb25BQkJlZm9yZUNvcHlCb3RzVG9DbGlwYm9hcmQCBADx9uquDZCxCMgHQGNvbnN0IHsgYm90cyB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCmNvbnN0IHVwZGF0ZWRJbnN0YW5jZXMgPSBuZXcgU2V0KCk7Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEICYmIGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgaWYgKCF1cGRhdGVkSW5zdGFuY2VzLmhhcyhib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgdXBkYXRlZEluc3RhbmNlcy5hZGQoYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpOwoKICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsKICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBib3QudGFncy5hYkFydGlmYWN0TmFtZSwKICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZU93bmVyOiBib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VPd25lciwKICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9Cn0nAQRib3RzJDkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YwEnAPH26q4N2bgIDmFiRmlsZVRpbWVjb2RlAgQA8fbqrg3auAhmQGNvbnN0IGRhdGU6IERhdGVUaW1lID0gdGhhdD8uZGF0ZSA/PyBEYXRlVGltZS5ub3coKTsKcmV0dXJuIGRhdGUudG9VVEMoKS50b0Zvcm1hdCgneXl5eU1NZGQtSEhtbXNzJyk7JwDx9uquDdm4CAZzeXN0ZW0CBADx9uquDcG5CA5hYi5zaGVsbC51dGlscycA8fbqrg3ZuAgMYWJDb21waWxlQ1NTAgQA8fbqrg3QuQiCBEBsZXQgYm90cyA9IHRoYXQ7Cgpib3RzID0gQXJyYXkuaXNBcnJheShib3RzKSA/IGJvdHMgOiBbYm90c107CgpsZXQgY3NzID0gW107Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgZm9yIChsZXQga2V5IGluIGJvdC50YWdzKSB7CiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCdjc3MnKSkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBDU1Mga2V5OiAke2tleX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3MucHVzaChib3QudGFnc1trZXldKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IGNvbXBpbGVkID0gY3NzLmpvaW4oJ1xuXG4nKTsKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY29tcGlsZWQgQ1NTOlxuXG5gLCBjb21waWxlZCk7Cn0KCnJldHVybiBjb21waWxlZDsnAPH26q4N2bgICGFiSWdub3JlAgQA8fbqrg3TvQgEdHJ1ZScA8fbqrg3ZuAgHYWJTaGVsbAIEAPH26q4N2L0IBHRydWUnAPH26q4N2bgICWFiVmVyc2lvbgIEAPH26q4N3b0IBTEwLjI5JwDx9uquDdm4CA1hYkxvZ0FuZFRvYXN0AgQA8fbqrg3jvQi4CkBsZXQgbWVzc2FnZTsKbGV0IGR1cmF0aW9uOwpsZXQgbG9nVHlwZSA9ICdsb2cnOwpsZXQgbmFtZSA9IGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eTsKbGV0IHRvYXN0ID0gdHJ1ZTsKbGV0IGFiTG9nID0gdHJ1ZTsKbGV0IGNvbnNvbGVMb2cgPSB0cnVlOwoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgbWVzc2FnZSA9IHRoYXQ7CiAgICBkdXJhdGlvbiA9IHRoaXNCb3QuZXN0aW1hdGVSZWFkaW5nVGltZSh7IHRleHQ6IHRoYXQsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDA7Cn0gZWxzZSB7CiAgICBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uID8/ICh0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0Lm1lc3NhZ2UsIGRlbGF5VGltZTogMTAwMCB9KSAvIDEwMDApOwogICAgbmFtZSA9IHRoYXQubmFtZSA/PyBuYW1lOwogICAgbG9nVHlwZSA9IHRoYXQubG9nVHlwZSA/PyBsb2dUeXBlOwogICAgdG9hc3QgPSB0aGF0LnRvYXN0ID8/IHRvYXN0OwogICAgYWJMb2cgPSB0aGF0LmFiTG9nID8/IGFiTG9nOwp9CgppZiAobG9nVHlwZSA9PT0gJ2xvZycpIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICd3YXJuaW5nJyB8fCBsb2dUeXBlID09PSAnd2FybicpIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiBXYXJuaW5nOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS53YXJuKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBXYXJuaW5nOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICdlcnJvcicpIHsKICAgIGlmIChhYkxvZykgYWIubG9nKG5hbWUgKyAnOiBFcnJvcjogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUuZXJyb3IobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QoYEVycm9yOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgewogICAgaWYgKGFiTG9nKSBhYi5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmIChjb25zb2xlTG9nKSBjb25zb2xlLmxvZyhuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7Cn0nAPH26q4N2bgICHJlbWVtYmVyAgQA8fbqrg2cyAgo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA8fbqrg3ZuAgFYWJMb2cCBADx9uquDcPICKUCQGlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgYWJMb2c6IHRydWUsCiAgICAgICAgY29uc29sZUxvZzogdHJ1ZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICBhYkxvZzogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nOiB0cnVlLAogICAgfSk7Cn0nAPH26q4N2bgIE2VzdGltYXRlUmVhZGluZ1RpbWUCBADx9uquDenKCNwDQGNvbnN0IHsKICAgIHRleHQgPSAnJywKICAgIHdvcmRzUGVyTWludXRlID0gMjUwLAogICAgZGVsYXlUaW1lID0gNTAwLAp9ID0gdGhhdDsKCi8vIENvdW50IHdvcmRzIChyb3VnaCBhcHByb3hpbWF0aW9uIGJ5IHNwbGl0dGluZyBvbiB3aGl0ZXNwYWNlKQpjb25zdCB3b3JkQ291bnQgPSB0ZXh0LnRyaW0oKS5zcGxpdCgvXHMrLykubGVuZ3RoOwpsZXQgdG90YWxUaW1lTXMgPSAwOwoKaWYgKHdvcmRDb3VudCA+IDApIHsKICAgIC8vIENhbGN1bGF0ZSByZWFkaW5nIHRpbWUgaW4gbWlsbGlzZWNvbmRzCiAgICBjb25zdCB3b3Jkc1BlclNlY29uZCA9IHdvcmRzUGVyTWludXRlIC8gNjA7CiAgICBjb25zdCByZWFkaW5nVGltZU1zID0gTWF0aC5jZWlsKCh3b3JkQ291bnQgLyB3b3Jkc1BlclNlY29uZCkgKiAxMDAwKTsKCiAgICB0b3RhbFRpbWVNcyA9IHJlYWRpbmdUaW1lTXMgKyBkZWxheVRpbWU7Cn0KCnJldHVybiB0b3RhbFRpbWVNczsnAPH26q4N2bgICGlzT2JqZWN0AgQA8fbqrg3Gzgg5QHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcgJiYgIUFycmF5LmlzQXJyYXkodGhhdCk7JwDx9uquDdm4CAdpc0FycmF5AgQA8fbqrg2AzwgcQHJldHVybiBBcnJheS5pc0FycmF5KHRoYXQpOycA8fbqrg3ZuAgIaXNTdHJpbmcCBADx9uquDZ3PCCFAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJzsnAPH26q4N2bgID2dldEVycm9yTWVzc2FnZQIEAPH26q4Nv88IwAJAZnVuY3Rpb24gZ2V0RXJyb3JNZXNzYWdlKGVycm9yKSB7CiAgICBpZiAoZXJyb3IpIHsKICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykgewogICAgICAgICAgICByZXR1cm4gZXJyb3I7CiAgICAgICAgfSBlbHNlIGlmIChlcnJvci5tZXNzYWdlKSB7CiAgICAgICAgICAgIHJldHVybiBlcnJvci5tZXNzYWdlOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IuZXJyb3IpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yTWVzc2FnZShlcnJvci5lcnJvcik7CiAgICAgICAgfQogICAgfQp9CgpyZXR1cm4gZ2V0RXJyb3JNZXNzYWdlKHRoYXQpOycA8fbqrg3ZuAgHYWJUb2FzdAIEAPH26q4NgNIIpwJAaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIGFiTG9nOiBmYWxzZSwKICAgICAgICBjb25zb2xlTG9nOiBmYWxzZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiB0cnVlLAogICAgICAgIGFiTG9nOiBmYWxzZSwKICAgICAgICBjb25zb2xlTG9nOiBmYWxzZSwKICAgIH0pOwp9JwDx9uquDdm4CBhoYXNHZW9sb2NhdGlvblBlcm1pc3Npb24CBADx9uquDajUCPwCQGxldCBoYXNQZXJtaXNzaW9uID0gZmFsc2U7Cgp0cnkgewogICAgaWYgKGdsb2JhbFRoaXMubmF2aWdhdG9yICYmIG5hdmlnYXRvci5wZXJtaXNzaW9ucykgewogICAgICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IG5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeSh7IG5hbWU6ICdnZW9sb2NhdGlvbicgfSk7CiAgICAgICAgaGFzUGVybWlzc2lvbiA9IHN0YXR1cz8uc3RhdGUgPT09ICdncmFudGVkJzsKICAgIH0KfSBjYXRjaCAoZSkgeyAKICAgIGNvbnNvbGUuZXJyb3IoYENhdWdodCBhbiBlcnJvciB3aWxsIHF1ZXJ5aW5nIHBlcm1pc3Npb25zLiBFcnJvcjpgLCBhYi5saW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSkpOwp9CgpyZXR1cm4gaGFzUGVybWlzc2lvbjsnAPH26q4N2bgIBWlzQm90AgQA8fbqrg2l1whUQHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcgJiYgdGhhdC50YWdzICYmIHRoYXQuaWQgJiYgdGhhdC5zcGFjZSAmJiB0aGF0LnZhcnM7JwEEYm90cyRkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUBJwDx9uquDfrXCAZzeXN0ZW0CBADx9uquDfvXCA9hYi5zaGVsbC5zZWFyY2gnAPH26q4N+tcIBGZvcm0CBADx9uquDYvYCAdub3RoaW5nJwDx9uquDfrXCA5hYlJldHJpZXZlRmlsZQIEAPH26q4Nk9gIggFALy9wdWxsIGRvd24gZmlsZSBkYXRhCmlmICghdGhhdC51cmwpCnsKICAgIHJldHVybiAibm8gZmlsZSB1cmwgc3VwcGxpZWQiOwp9CgpsZXQgZGF0YSA9IGF3YWl0IG9zLmdldEZpbGUodGhhdC51cmwpOwoKcmV0dXJuIGRhdGE7JwDx9uquDfrXCBBhYlJldHJpZXZlUmVjb3JkAgQA8fbqrg2W2QjsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwDx9uquDfrXCAhyZW1lbWJlcgIEAPH26q4Ng94IKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAPH26q4N+tcIDW1hbmlmZXN0YXRpb24CBADx9uquDareCCjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDx9uquDfrXCA5vbkxvb2t1cEFCRWdncwIEAPH26q4N0d4IzzJAY29uc3QgeyAKICAgIGFiSUQsCiAgICBhYlZlcnNpb24sCiAgICBpbml0aWFsQm9vdCwKICAgIGF1dG9IYXRjaCwKICAgIHJldHVyblR5cGUsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5LAogICAgdG9hc3QgPSB0cnVlLAogICAgc2hvd0luZGljYXRvciA9IHRydWUsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsLiAob3B0aW9uYWwpCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBsb2FkaW5nICIgKyBhYklEKTsKCi8vY2xlYXIgYWItMQppZiAobGlua3MubWFuaWZlc3RhdGlvbiAmJiBjb25maWdCb3QudGFncy5tZW51UG9ydGFsID09ICJhYk1lbnUiKSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfQoKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvYWRpbmcgJHthYklEfWB9KTsKfQoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2V0UmVjb3JkOmAsIHsuLi5nZXRSZWNvcmR9KTsKfQoKbGV0IGVnZ0RhdGE7CgovL3RoaXMgbG9naWMgaGFuZGxlcyB0aGUgcmV0cmlldmVkIGRhdGEsIHNlYXJjaGVzIGFnYWluIGlmIG5vbmUgY2FtZSB0aHJvdWdoCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmIChwb3NzaWJsZUF1dGguaWQgPT0gcmVjb3JkS2V5ICYmCiAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSAmJgogICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJyZWNvcmRfbm90X2ZvdW5kIgogICAgKSB7CiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIikgewogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CiAgICB9IGVsc2UgaWYgKGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfbG9nZ2VkX2luIikgewogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgogICAgICAgIGlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MgJiYgCiAgICAgICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfYXV0aG9yaXplZCIKICAgICAgICApIHsKICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICAgICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgICAgICB9CiAgICB9Cn0KCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmICh0b2FzdCkgeyAKICAgICAgICBvcy50b2FzdChgbm8gZGF0YSBmb3VuZCBpbiAke2FiSUR9YCk7CiAgICB9CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICB9CgogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQplbHNlIHsKICAgIGNvbnN0IHB1YmxpY1JlYWRUZXN0ID0gZ2V0UmVjb3JkLm1hcmtlcnMuaW5kZXhPZigicHVibGljUmVhZCIpOwogICAgY29uc3QgYXV0aG9yID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCiAgICBpZiAocHVibGljUmVhZFRlc3QgIT0gLTEgJiYgYXV0aG9yKSB7CiAgICAgICAgaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGVnZ0hhdGNoRXZlbnQgPSBhYklEOwoKICAgICAgICAgICAgb3MucmVjb3JkRXZlbnQobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgZWdnSGF0Y2hFdmVudCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vcGFja2FnZSB0aGUgcmVjb3JkIGRhdGEKICAgIGVnZ0RhdGEgPSBnZXRSZWNvcmQuZGF0YTsKCiAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgLy8gQ2hhbmdlIGluaXRpYWwgdGFyZ2V0IHZlcnNpb24gb2YgdGhlIGVnZyBpZiBhYlZlcnNpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gYWJWZXJzaW9uOwogICAgfQp9CgppZiAocmV0dXJuVHlwZSAhPSBudWxsKSB7CiAgICBpZiAoZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGxldCB2ZXJzaW9uID0gZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiAtIDE7CgogICAgICAgICAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKGFiVmVyc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gYWJWZXJzaW9uIC0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgICAgICAgICBjb25zdCByZXR1cm5EYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShlZ2dEYXRhVVJMKTsKCiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0dXJuRGF0YTsKICAgICAgICB9IGVsc2UgaWYgKHJldHVyblR5cGUgPT09ICJlZ2ciKSB7CiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKGVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkpOwogICAgICAgICAgICBjb25zdCBmaWxlVVVJRCA9IHZlcnNpb25BcnJheVtlZ2dEYXRhLm1heFZlcnNpb24gLSAxXTsKICAgICAgICAgICAgY29uc3QgZmlsZW5hbWVoYXNoTFRNID0gY3J5cHRvLnNoYTI1NihmaWxlVVVJRCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGV1cmxoYXNoTFRNID0gImF1eF8iICsgZmlsZW5hbWVoYXNoTFRNICsgJy5hdXgnOwogICAgICAgICAgICBjb25zdCB0YXJnZXRMVE1VUkwgPSAiaHR0cHM6Ly9idWlsZGVyLWx0bS1maWxlcy5zMy5hbWF6b25hd3MuY29tLyIgKyBmaWxldXJsaGFzaExUTTsKICAgICAgICAgICAgY29uc3QgbyA9IHsKICAgICAgICAgICAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgICAgICAgICAgICB1cmw6IHRhcmdldExUTVVSTAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbGV0IGZpbGVHZXQgPSBhd2FpdCB3ZWJob29rKG8pOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5tYW5pZmVzdE92byh7CiAgICBhYklELAogICAgc3R1ZGlvOiByZWNvcmRLZXksCiAgICBkaW1Nb2QsCiAgICBzcGFjZU1vZCwKICAgIGVnZ0RhdGEsCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwKfSk7CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKbGlua3MudXRpbHMuYWJMb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogIiArIGFiSUQgKyAiIGxvYWRlZCwgdmVyc2lvbiAiICsgZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIGdldFJlY29yZC5kYXRhLm1heFZlcnNpb24pOwoKcmV0dXJuIHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBoYXRjaGVkQm90czogbWFuaWZlc3RSZXN1bHQ/LmhhdGNoZWRCb3RzLAp9OycA8fbqrg361wgLbWFuaWZlc3RPdm8CBADx9uquDaGRCdQPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCAmJiAhY29uZmlnQm90LnRhZ3MuYWJTdGF5QXdha2UpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgppZiAobGlua3Mub3ZvQm90KSB7CiAgICBkZXN0cm95KGxpbmtzLm92b0JvdCk7Cn0KCmxldCBlZ2dNb2QgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBpbml0aWFsVGltZXI6IHRydWUsCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgc291cmNlRXZlbnQsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaW50ZXJhY3RPdm8oKTsKICAgIGAsCiAgICBmb3JtOiAiZWdnIiwKICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VMYWJlbENvbG9yLAogICAgcHJvZ3Jlc3NCYXJDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvciwKICAgIHByb2dyZXNzQmFyQmFja2dyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgbGFiZWxTaXplOiAwLjUsCiAgICBvblBvaW50ZXJFbnRlcjogYEAKICAgICAgICBtYXNrcy50aXBJZCA9IGF3YWl0IG9zLnRpcCh0YWdzLmFiSUQgKyAnIHYnICsgdGFncy50YXJnZXRWZXJzaW9uKTsKICAgIGAsCiAgICBvblBvaW50ZXJFeGl0OiBgQAogICAgICAgIGlmIChtYXNrcy50aXBJZCkgewogICAgICAgICAgICBvcy5oaWRlVGlwcyhtYXNrcy50aXBJZCk7CiAgICAgICAgfQogICAgYCwKICAgIGxhYmVsUG9zaXRpb246ICJmcm9udCIsCiAgICBvcmllbnRhdGlvbk1vZGU6ICJiaWxsYm9hcmRGcm9udCIsCiAgICBvbkRlc3Ryb3k6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5tYXNrcy5vdm9Cb3QgPSBudWxsOwogICAgYCwKICAgIGVnZ1RpbWVyOiBgQAogICAgICAgIGlmICh0YWdzLnByb2dyZXNzQmFyIDwgMSkgewogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyICs9IDAuMTsKCiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge3doaXNwZXIodGhpc0JvdCwgImVnZ1RpbWVyIik7fSwgNzUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXNCb3Qub25DbGljaygpOwogICAgICAgICAgICAKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciA9IG51bGw7CiAgICAgICAgfQogICAgYAp9OwoKCmNvbnN0IG92byA9IGF3YWl0IGNyZWF0ZShlZ2dEYXRhLCBlZ2dNb2QsIGRpbU1vZCwgc3BhY2VNb2QpOwptYXNrcy5vdm9Cb3QgPSBnZXRMaW5rKG92byk7CgppZiAob25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKSB7CiAgICBvdm8udmFycy5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGUgPSBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU7Cn0KCmlmIChvdm8udGFncy5hdXRvSGF0Y2gpIHsKICAgIGNvbnN0IGhhdGNoZWRCb3RzID0gYXdhaXQgdGhpc0JvdC5oYXRjaE92byhvdm8pOwogICAgcmV0dXJuIHsgaGF0Y2hlZEJvdHMgfTsKfQplbHNlIHsKICAgIG92by50YWdzLnByb2dyZXNzQmFyID0gMDsKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBvdm8udGFncy5tYXhWZXJzaW9uOwogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9JwDx9uquDfrXCAlvbktleURvd24CBADx9uquDfagCYIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAPH26q4N+tcICGhhdGNoT3ZvAgQA8fbqrg33pgmdFUAvL2xvZ2ljIGZvciBoYXRjaGluZyBvZiBhbiBhYgpzaG91dCgnb3ZvTWVudVJlc2V0Jyk7CgovL2RhdGEgaW4gcmVnYXJkcyB0byB3aGF0IGFiIGlzIGdvaW5nIHRvIGJlIGhhdGNoZWQKY29uc3Qgb3ZvID0gdGhhdDsKCi8vaGF0Y2ggc3BlY2lmaWMgdmFyaWFibGVzCmxldCBpbml0aWFsQm9vdCA9IG92by50YWdzLmluaXRpYWxCb290OwpsZXQgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLnN0YWJsZVZlcnNpb24gPz8gb3ZvLnRhZ3MudGFyZ2V0VmVyc2lvbjsKCmlmICgoY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uIHx8IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uKSAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIpKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uOwp9CgovL3RhcmdldGVkIHZlcnNpb25zCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYiB8fCAhaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpKQp7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiZmVlZGJhY2siKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5mZWVkYmFja1ZlcnNpb247CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJjdXJyZW50IikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgfQogICAgZWxzZSBpZiAoIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy52ZXJzaW9uCiAgICB9CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG51bGw7Cn0KCmlmIChpc05hTih0YXJnZXRWZXJzaW9uKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKfQoKbGV0IHZlcnNpb25BcnJheSA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5OwpsZXQgZmlsZVVSTCA9IHZlcnNpb25BcnJheVt0YXJnZXRWZXJzaW9uIC0gMV07CmxldCBrZXkgPSBvdm8udGFncy5rZXkgPyBvdm8udGFncy5rZXkgOiBjb25maWdCb3QudGFncy5rZXk7CmxldCBmaWxlR2V0OwoKLy9hY3R1YWwgZmlsZSByZXRyaWV2YWwKdHJ5CnsKICAgIGZpbGVHZXQgPSBhd2FpdCBvcy5nZXRGaWxlKGZpbGVVUkwpOwp9CmNhdGNoIChlKQp7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnbm8gZmlsZSBmb3VuZCcpOwoKICAgIHJldHVybjsKfQoKLy9oYW5kbGluZyBmb3IgZW5jcnlwdGVkIGFiIGZpbGUKaWYgKGNyeXB0by5pc0VuY3J5cHRlZChmaWxlR2V0KSkKewogICAgaWYgKCFrZXkpCiAgICB7CiAgICAgICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCcnLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ0VudGVyIGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBmaWxlR2V0ID0gY3J5cHRvLmRlY3J5cHQoa2V5LCBmaWxlR2V0KTsKCiAgICBpZiAoZmlsZUdldCA9PSBudWxsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnaW5jb3JyZWN0IGtleScpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgCiAgICBmaWxlR2V0ID0gSlNPTi5wYXJzZShmaWxlR2V0KTsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CmVsc2UKewogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KCi8vY2xlYW4gdXAKZGVzdHJveShvdm8pOwoKLy90b2FzdCBpZiBub3Qgb24gc3RhYmxlCmlmKG92by50YWdzLnN0YWJsZVZlcnNpb24gIT0gdGFyZ2V0VmVyc2lvbiAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnQpCnsKICAgIGlmIChvdm8udGFncy5mZWVkYmFja1ZlcnNpb24gPT0gdGFyZ2V0VmVyc2lvbikKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCBmZWVkYmFjayB2ZXJzaW9uIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCB2ZXJzaW9uICIgKyB0YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoICsgIiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9Cn0KCi8vZ2VuZXJhdGUgYm90cyBiYXNlZCBvbiB0aGUgZmlsZSByZXRyaWV2ZWQgKkhFUkUqCmNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsKICAgIGJvdHM6IGZpbGVHZXQsCiAgICBvcmlnaW46IG92by50YWdzLmFiSUQsCiAgICBzdHVkaW86IG92by50YWdzLnN0dWRpbywKICAgIHZlcnNpb246IHRhcmdldFZlcnNpb24sCiAgICBpbml0aWFsQm9vdDogaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzOiBvdm8udGFncy5lZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBvdm8udmFycy5vblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudDogb3ZvLnRhZ3Muc291cmNlRXZlbnQsCn0pOwoKcmV0dXJuIG5ld0JvdHM7JwDx9uquDfrXCAtpbnRlcmFjdE92bwIEAPH26q4NlbwJ6QZALy9tYW51YWwgaGF0Y2ggbWVudQpjb25zdCBvdm9Cb3QgPSB0aGF0ID8gdGhhdCA6IGxpbmtzLm92b0JvdDsKCmlmICghb3ZvQm90KSB7CiAgICByZXR1cm47Cn0KCnNob3V0KCJvdm9NZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiT3ZvTWVudSI7CgptYXNrcy5vbkdyaWRDbGljayA9IGBACiAgICBzaG91dCgib3ZvTWVudVJlc2V0Iik7CmA7Cm1hc2tzLm92b01lbnVSZXNldCA9IGBACiAgICBtYXNrcy5vbkdyaWRDbGljayA9IG51bGw7CiAgICBtYXNrcy5vdm9NZW51UmVzZXQgPSBudWxsOwoKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKYDsKCm9zLnR3ZWVuVG8ob3ZvQm90LCAxNSw0NSw0NSwgNSk7Cgpjb25zdCBlZ2dNZW51QnV0dG9uID0gewogICAgYWJPdm9NZW51OiB0cnVlLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG92b0JvdDogZ2V0TGluayhvdm9Cb3QpLAogICAgY29sb3I6IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHRhcmdldFZlcnNpb246IG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sCiAgICBsYWJlbDogYGhhdGNoICR7b3ZvQm90LnRhZ3MuYWJJRH0gdiR7b3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbn0gb2YgJHtvdm9Cb3QudGFncy5tYXhWZXJzaW9ufWAsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBvdm9NZW51UmVzZXQ6IGBACiAgICAgICAgZGVzdHJveSh0aGlzQm90KTsKICAgIGAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaGF0Y2hPdm8obGlua3Mub3ZvQm90KTsKICAgIGAsCn07CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihlZ2dNZW51QnV0dG9uKTsnAPH26q4N+tcIBmNyZWF0ZQIEAPH26q4N/8IJKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAPH26q4N+tcIEGNoYW5nZU92b1ZlcnNpb24CBADx9uquDabDCfACQC8vbG9naWMgZm9yIHZlcnNpb24gY2hhbmdpbmcgd2hlbiBtYW51YWxseSBoYXRjaGluZyBhbiBhYgpjb25zdCBvdm9Cb3QgPSBsaW5rcy5vdm9Cb3Q7CgpsZXQgbmV3VmVyc2lvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uLCB7CiAgICBwbGFjZWhvbGRlcjogImVudGVyIGEgdmVyc2lvbiBmcm9tIDEgdG8gIiArIG92b0JvdC50YWdzLm1heFZlcnNpb24KfSk7Cgpvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uID0gbmV3VmVyc2lvbjsKb3ZvQm90LnRhZ3MubGFiZWwgPSAndicrIG5ld1ZlcnNpb247Cgpjb25maWdCb3QudGFncy52ZXJzaW9uID0gbmV3VmVyc2lvbjsKCnNob3V0KCJvdm9NZW51UmVzZXQiKTsnAPH26q4N+tcIBG1lbnUCBADx9uquDZfGCSjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDx9uquDfrXCAhhYklnbm9yZQIEAPH26q4NvsYJBHRydWUnAPH26q4N+tcIB2FiU2hlbGwCBADx9uquDcPGCQR0cnVlJwDx9uquDfrXCAxhYjFMVE1TZWFyY2gCBADx9uquDcjGCTNALy9zdXBwb3J0IG9sZCBzeW50YXgKdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsnAPH26q4N+tcIDW9uTG9va3VwQXNrSUQCBADx9uquDfzGCbIgQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IHNob3dJbmRpY2F0b3IgPSB0aGF0Py5zaG93SW5kaWNhdG9yID8/IHRydWU7CmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOwpjb25zdCBlZ2dQYXJhbWV0ZXJzID0gdGhhdD8uZWdnUGFyYW1ldGVyczsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwpjb25zdCBpZ25vcmVSZXNlcnZlZCA9IHRoYXQ/Lmlnbm9yZVJlc2VydmVkOwpjb25zdCBkYXRhT25seSA9IHRoYXQ/LmRhdGFPbmx5ID8/IGZhbHNlOwoKYXNzZXJ0KHR5cGVvZiBhc2tJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCmlmIChzaG93SW5kaWNhdG9yKSB7CiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQoKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgbG9va2luZyB1cCAke2Fza0lEfWAgfSk7Cn0KCi8vQ2hlY2sgZm9yIHJlc2VydmVkIGtleXdvcmRzCmlmIChsaW5rcz8ubGVhcm4/LnRhZ3M/LnJlc2VydmVkQXNrcz8uaW5jbHVkZXMoYXNrSUQpICYmICFpZ25vcmVSZXNlcnZlZCAmJiBhdXRoQm90KSB7CiAgICBpZiAoIWdldEJvdCgiYWJJRE9yaWdpbiIsIGFza0lEKSkgewogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IHRoaXNCb3QubG9va3VwRnJvbVN0dWRpbyh7Li4udGhhdCwgcmVzZXJ2ZWQ6IHRydWUsIGRhdGFPbmx5IH0pOwogICAgICAgIGlmIChsb29rdXBBc2sgJiYgbG9va3VwQXNrLnN1Y2Nlc3MgPT0gdHJ1ZSkgewogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZXR1cm5pbmcgcmVzZXJ2ZWQgYXNrICcke2Fza0lEfScgZm91bmQgaW4gc3R1ZGlvOmAsIGxvb2t1cEFzayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsKICAgICAgICB9CiAgICB9Cn0KCi8vIEZpcnN0IGNoZWNrIHRoZSBjYXN1YWwgY2F0YWxvZyBmb3IgdGhlIGFzay4KY29uc3QgY2FzdWFsQ2F0YWxvZ1VSTCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYXNrcy8ke2Fza0lEfS5hdXhgKTsKCnRyeSB7CiAgICBjb25zdCBjYXN1YWxDYXRhbG9nUmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7IG1ldGhvZDogJ0dFVCcsIHVybDogY2FzdWFsQ2F0YWxvZ1VSTCB9KTsKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2FzdWFsIGNhdGFsb2cgcmVzcG9uc2U6YCwgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlKTsKICAgIH0KCiAgICBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICAgICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDEgJiYgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUpIHsKICAgICAgICAgICAgaWYgKGRhdGFPbmx5KSB7CiAgICAgICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycsCiAgICAgICAgICAgICAgICAgICAgZGF0YTogY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBDYXN1YWwgY2F0YWxvZyByZXNwb25zZSBpcyBhIHYxIGF1eCBmaWxlLgogICAgICAgICAgICAgICAgY29uc3QgbmV3Qm90cyA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyAKICAgICAgICAgICAgICAgICAgICBib3RzOiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS5zdGF0ZSwKICAgICAgICAgICAgICAgICAgICBpZ25vcmVHcmlkRm9jdXM6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgb3JpZ2luOiBhc2tJRCwKICAgICAgICAgICAgICAgICAgICBlZ2dQYXJhbWV0ZXJzLAogICAgICAgICAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgICAgICAgICAgICAgICAgICBzb3VyY2VFdmVudCwKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJywKICAgICAgICAgICAgICAgICAgICBoYXRjaGVkQm90czogbmV3Qm90cywKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiAmJiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS51cGRhdGVzKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjIgYXV4IGZpbGUuCiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXNrcyBvbmx5IHN1cHBvcnQgdjEgYXV4IGZpbGUgZm9ybWF0LmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UuCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgYXNrIHJlc3BvbnNlLmAsIGNhc3VhbENhdGFsb2dSZXNwb25zZSk7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS4gQ2hlY2sgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmV0dXJuaW5nIGFzayAnJHthc2tJRH0nIGZvdW5kIGluIGNhc3VhbCBjYXRhbG9nOmAsIGxvb2t1cEFzaykKICAgICAgICB9CgogICAgICAgIHJldHVybiBsb29rdXBBc2s7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIERpZCBub3QgZmluZCBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuCn0KCmxvb2t1cEFzayA9IGF3YWl0IHRoaXNCb3QubG9va3VwRnJvbVN0dWRpbyh0aGF0KTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEZyb21TdHVkaW8gcmVzdWx0OmAsIHsuLi5sb29rdXBBc2t9KTsKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBsb29rdXBBc2s7JwDx9uquDfrXCAV0eXBlcwIEAPH26q4Nr+cJ9gHwn5OEdHlwZSBBQkFza0lET3JpZ2luID0gJ2Nhc3VhbF9jYXRhbG9nJyB8ICdhYl9yZWNvcmQnOwoKaW50ZXJmYWNlIEFCTG9va3VwQXNrSURSZXN1bHQgewogICAgc3VjY2VzczogYm9vbGVhbjsKICAgIG9yaWdpbjogQUJBc2tJRE9yaWdpbjsKICAgIGhhdGNoZWRCb3RzPzogQm90W107Cn0KCmludGVyZmFjZSBBQkxvb2t1cEVnZ1Jlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuLAogICAgaGF0Y2hlZEJvdHM/OiBCb3RbXSwKfQonAPH26q4N+tcIBWlucHV0AgQA8fbqrg2k6Qko8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcA8fbqrg361wgFaGF0Y2gCBADx9uquDcvpCcABQC8vc2hvdXQoImhhdGNoIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBrZXk6IGtleSwgYXV0b0hhdGNoOiBib29sZWFuLCByZXR1cm5UeXBlOiBkYXRhL251bGwsIGVnZ1BhcmFtZXRlcnM6IGFyZ30pOwoKY29uc3QgbG9va1VwID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsKCnJldHVybiBsb29rVXA7JwDx9uquDfrXCAlhYlZlcnNpb24CBADx9uquDYzrCQUxMC4yOScA8fbqrg361wgFbGVhcm4CBADx9uquDZLrCSjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDx9uquDfrXCAV1dGlscwIEAPH26q4NuesJKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAPH26q4N+tcIC3BlcnNvbmFsaXR5AgQA8fbqrg3g6wko8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicA8fbqrg361wgQbG9va3VwRnJvbVN0dWRpbwIEAPH26q4Nh+wJ+CpAY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsNCmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOw0KY29uc3QgZWdnUGFyYW1ldGVycyA9IHRoYXQ/LmVnZ1BhcmFtZXRlcnM7DQpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQ/LnNvdXJjZUV2ZW50Ow0KY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOw0KY29uc3QgcmVzZXJ2ZWQgPSB0aGF0Py5yZXNlcnZlZDsNCmNvbnN0IGlzQ2hhbm5lbCA9IHRoYXQ/LmlzQ2hhbm5lbDsNCmNvbnN0IGlzVVVBQiA9IHRoYXQ/LmlzVVVBQjsNCmNvbnN0IGRhdGFPbmx5ID0gdGhhdD8uZGF0YU9ubHkgPz8gZmFsc2U7DQoNCmxldCBsb29rdXBBc2s6IEFCTG9va3VwQXNrSURSZXN1bHQ7DQpsZXQgdXNlZFN0dWRpbzsNCg0KaWYgKHRhZ3MuZGVidWcpIHsNCiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsNCn0NCg0KLy8gQ2hlY2sgdGhlIGFiIHJlY29yZCBmb3IgdGhlIGFzay4NCmNvbnN0IGFiRm9ybWF0dGVkQXNrSUQgPSBhc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOw0KDQppZiAodGFncy5kZWJ1Zykgew0KICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJGb3JtYXR0ZWRBc2tJRDpgLCBhYkZvcm1hdHRlZEFza0lEKTsNCn0NCg0KaWYgKHJlc2VydmVkKSB7DQogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbykgew0KICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICE9IGF1dGhCb3QuaWQpIHsNCiAgICAgICAgICAgIGNvbnN0IHBlcm1zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7DQogICAgICAgICAgICBpZiAocGVybXMuc3VjY2Vzcykgew0KICAgICAgICAgICAgICAgIGNvbnN0IGZvdW5kID0gcGVybXMuc3R1ZGlvcy5maW5kKChzdHVkKSA9PiB7DQogICAgICAgICAgICAgICAgICAgIHJldHVybiAoc3R1ZC5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pOw0KICAgICAgICAgICAgICAgIH0pOw0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBVc2VyIHBlcm1pc3Npb25zIGZvciBzdHVkaW8iLCBmb3VuZCwgcGVybXMpOw0KICAgICAgICAgICAgICAgIGlmICghZm91bmQpIHsNCiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IFVzZXIgZG9lcyBub3QgaGF2ZSBwZXJtaXNzaW9ucyBmb3IgdGhpcyBzdHVkaW8uIikNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvb2t1cEFzazsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdXNlZFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8sIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzICYmIGxvb2t1cEFzay5lcnJvckNvZGUgJiYgbG9va3VwQXNrLmVycm9yQ29kZSA9PSAnbm90X2F1dGhvcml6ZWQnKSB7DQogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24oY29uZmlnQm90LnRhZ3Muc3R1ZGlvKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogZmFpbHVyZSBsb29raW5nIHVwIGFzayBpbiBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBMb29rZWQgdXAgYXNrIGluIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIH0gZWxzZSB7DQogICAgICAgIHVzZWRTdHVkaW8gPSBhdXRoQm90Py5pZDsNCiAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90Py5pZCwgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihhdXRoQm90Py5pZCk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3Q/LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MpIHsNCiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogZmFpbHVyZSBsb29raW5nIHVwIGFzayBpbiB1c2VyIHN0dWRpbyIsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IExvb2tlZCB1cCBhc2sgaW4gdXNlciBzdHVkaW8iLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9DQp9IGVsc2Ugew0KICAgIHVzZWRTdHVkaW8gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5Ow0KICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYGFza18ke2FiRm9ybWF0dGVkQXNrSUR9YCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsNCiAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFzayBhdHRlbXB0IDE6YCwgey4uLmxvb2t1cEFza30pOw0KICAgIH0NCiAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzKSB7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYWJGb3JtYXR0ZWRBc2tJRCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsNCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMjpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgIH0NCiAgICB9DQoNCiAgICBpZiAoIWxvb2t1cEFzay5zdWNjZXNzICYmIGlzVVVBQikgew0KICAgICAgICB1c2VkU3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQ7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2sgYXR0ZW1wdCAzIChpc1VVQUIpOmAsIHsuLi5sb29rdXBBc2t9KTsNCiAgICAgICAgfQ0KICAgICAgICBpZihsb29rdXBBc2suZXJyb3JDb2RlICYmIGxvb2t1cEFzay5lcnJvckNvZGUgPT0gJ25vdF9hdXRob3JpemVkJykgew0KICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8/IGF1dGhCb3QuaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICB9DQogICAgfQ0KDQogICAgaWYgKCFsb29rdXBBc2suc3VjY2VzcyAmJiBpc0NoYW5uZWwpIHsNCiAgICAgICAgdXNlZFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkOw0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsNCiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrIGF0dGVtcHQgMyAoaXNDaGFubmVsKTpgLCB7Li4ubG9va3VwQXNrfSk7DQogICAgICAgIH0NCiAgICAgICAgaWYobG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdC5pZCk7DQogICAgICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/PyBhdXRoQm90LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgfQ0KICAgIH0NCn0NCg0KbG9va3VwQXNrLm9yaWdpbiA9ICdhYl9yZWNvcmQnOw0KDQppZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgKGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCB8fCByZXNlcnZlZCB8fCBpc0NoYW5uZWwgfHwgaXNVVUFCKSkgew0KICAgIGlmIChkYXRhT25seSkgew0KICAgICAgICByZXR1cm4gbG9va3VwQXNrOw0KICAgIH0gZWxzZSB7DQogICAgICAgIC8vIExvb2t1cCB0aGUgZWdnIHVzaW5nIHRoZSBzdHVkaW9JRCBhbmQgcGF0dGVybklEIGZyb20gdGhlIGFiX3JlY29yZCBhc2suDQogICAgICAgIGNvbnN0IGxvb2t1cEVnZzogQUJMb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogKHJlc2VydmVkIHx8IGlzQ2hhbm5lbCB8fCBpc1VVQUIpID8gYWJGb3JtYXR0ZWRBc2tJRCA6IGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA/PyB1c2VkU3R1ZGlvLCBhdXRvSGF0Y2gsIGVnZ1BhcmFtZXRlcnMsIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgc291cmNlRXZlbnQgfSk7DQogICAgICAgIA0KICAgICAgICBpZiAodGFncy5kZWJ1Zykgew0KICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBFZ2c6YCwgey4uLmxvb2t1cEVnZ30pOw0KICAgICAgICB9DQoNCiAgICAgICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBsb29rdXBFZ2cuc3VjY2VzczsNCiAgICAgICAgbG9va3VwQXNrLmhhdGNoZWRCb3RzID0gbG9va3VwRWdnLmhhdGNoZWRCb3RzOw0KICAgIH0NCn0gZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgIWxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCAmJiAhbG9va3VwQXNrLmRhdGEudXJsKSB7DQogICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBmYWxzZTsNCn0NCg0KcmV0dXJuIGxvb2t1cEFzazsnAPH26q4N+tcIBWRlYnVnAgQA8fbqrg2AlwoEdHJ1ZScA8fbqrg361wgaYWJDYXN1YWxDYXRhbG9nQXNrSURFeGlzdHMCBADx9uquDYWXCoIHQGNvbnN0IGFza0lEID0gdGhhdD8uYXNrSUQ7CmNvbnN0IHVybCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYXNrcy8ke2Fza0lEfS5hdXhgKTsKCmxldCBleGlzdHM7CmxldCByZXNwb25zZTsKCnRyeSB7CiAgICByZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsKICAgICAgICBtZXRob2Q6ICdIRUFEJywKICAgICAgICB1cmwsCiAgICB9KQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZXNwb25zZTpgLCByZXNwb25zZSk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIENhbGwgdG8gY2FzdWFsIGNhdGFsb2cgaGFzIGZhaWxlZCwgdGhlIGFzayBpZCBkb2VzIG5vdCBleGlzdCB0aGVyZS4KICAgIC8vIE5PVEU6IEl0IHdvdWxkIGJlIG5pY2UgaWYgdGhlIENhc3VhbCBDYXRhbG9nIGVuZHBvaW50IHJldHVybmVkIGEgNDA0IE5vdCBGb3VuZCBzdGF0dXMgY29kZSBqdXN0IHNvIHdlIGNhbiBydWxlIG91dCBhY3R1YWwgc2VydmVyIGVycm9ycy4KICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhdWdodCBhbiBlcnJvcjpgLCBlKTsKICAgIH0KCiAgICBleGlzdHMgPSBmYWxzZTsKfQoKaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLnN0YXR1cyA9PT0gMjAwKSB7CiAgICBleGlzdHMgPSB0cnVlOwp9IGVsc2UgewogICAgZXhpc3RzID0gZmFsc2U7Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEICcke2Fza0lEfScgZXhpc3RzIGluIGNhc3VhbCBjYXRhbG9nP2AsIGV4aXN0cyk7Cn0KCnJldHVybiBleGlzdHM7CicA8fbqrg361wgZYWJDaGVja0Fza1VwZGF0ZUF2YWlsYWJsZQIEAPH26q4NiJ4Kyw5AY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsKY29uc3QgY3VycmVudEhhc2ggPSB0aGF0Py5jdXJyZW50SGFzaDsKY29uc3QgaGFzaEFsZ29yaXRobSA9IHRoYXQ/Lmhhc2hBbGdvcml0aG0gPz8gJ3NoYTEnOwpjb25zdCBoYXNoRm9ybWF0ID0gdGhhdD8uaGFzaEZvcm1hdCA/PyAnaGV4JzsKCmFzc2VydCh0eXBlb2YgYXNrSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBjdXJyZW50SGFzaCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3VycmVudEhhc2ggaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApCgpjb25zdCBhc2tEYXRhID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLm9uTG9va3VwQXNrSUQoeyBhc2tJRCwgc2hvd0luZGljYXRvcjogZmFsc2UsIGRhdGFPbmx5OiB0cnVlLCBzb3VyY2VFdmVudDogJ2Fza191cGRhdGVfY2hlY2snIH0pOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrRGF0YTpgLCBhc2tEYXRhKTsKfQoKaWYgKGFza0RhdGEuc3VjY2VzcykgewogICAgaWYgKGFza0RhdGEuZGF0YS5wYXR0ZXJuSUQgJiYgYXNrRGF0YS5kYXRhLnN0dWRpb0lEKSB7CiAgICAgICAgLy8gQXNrIGlzIGEgcG9pbnRlciB0byBhbiBlZ2cgaW4gYSBzdHVkaW8uCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgYWJEYXRhID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogYXNrRGF0YS5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBhc2tEYXRhLmRhdGEuc3R1ZGlvSUQsIHJldHVyblR5cGU6ICdkYXRhJ30pOwogICAgICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgYWJEYXRhLnN0YXRlKTsKCiAgICAgICAgICAgIHJldHVybiB7IAogICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2gsCiAgICAgICAgICAgICAgICBjdXJyZW50SGFzaCwKICAgICAgICAgICAgICAgIGxhdGVzdEhhc2gsCiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaHQgYW4gZXJyb3IuYCwgZSk7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH0KICAgICAgICB9CiAgICB9ICBlbHNlIGlmIChhc2tEYXRhLmRhdGEudmVyc2lvbiA9PT0gMSAmJiBhc2tEYXRhLmRhdGEuc3RhdGUpIHsKICAgICAgICAvLyBBc2sgaXMgYSB2MSBhdXggZmlsZS4KICAgICAgICBjb25zdCBsYXRlc3RIYXNoID0gY3J5cHRvLmhhc2goaGFzaEFsZ29yaXRobSwgaGFzaEZvcm1hdCwgYXNrRGF0YS5kYXRhLnN0YXRlKTsKCiAgICAgICAgcmV0dXJuIHsgCiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgIHVwZGF0ZUF2YWlsYWJsZTogY3VycmVudEhhc2ggIT09IGxhdGVzdEhhc2gsCiAgICAgICAgICAgIGN1cnJlbnRIYXNoLAogICAgICAgICAgICBsYXRlc3RIYXNoLAogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVucmVjb2duaXplZCBhc2tEYXRhIHN0cnVjdHVyZS5gLCBhc2tEYXRhKTsKICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICB9Cn0gZWxzZSB7CiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Cn0KJwDx9uquDfrXCBlhYkNoZWNrRWdnVXBkYXRlQXZhaWxhYmxlAgQA8fbqrg3UrAqZB0Bjb25zdCBhYklEID0gdGhhdD8uYWJJRDsKY29uc3QgY3VycmVudEFCVmVyc2lvbiA9IHRoYXQ/LmN1cnJlbnRBQlZlcnNpb247IC8vIDEtYmFzZWQgdmVyc2lvbiBudW1iZXIuCmNvbnN0IHJlY29yZEtleU9yTmFtZSA9IHRoYXQ/LnJlY29yZEtleU9yTmFtZTsKCmFzc2VydCh0eXBlb2YgYWJJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXJgKTsKYXNzZXJ0KE51bWJlci5pc0ludGVnZXIoY3VycmVudEFCVmVyc2lvbikgJiYgY3VycmVudEFCVmVyc2lvbiA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY3VycmVudEFCVmVyc2lvbiBtdXN0IGJlIGFuIGludGVnZXIgZ3JlYXRlciB0aGFuIDAuYCk7CmFzc2VydCh0eXBlb2YgcmVjb3JkS2V5T3JOYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXlPck5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgZWdnID0gYXdhaXQgYWIubGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsgYWJJRCwgcmVjb3JkS2V5OiByZWNvcmRLZXlPck5hbWUsIHJldHVyblR5cGU6ICdlZ2cnfSk7CgppZiAoIWVnZyB8fCBlZ2cuc3VjY2VzcyA9PT0gZmFsc2UpIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogZmFsc2UKICAgIH0KfSBlbHNlIHsKICAgIHJldHVybiB7CiAgICAgICAgc3VjY2VzczogdHJ1ZSwKICAgICAgICB1cGRhdGVBdmFpbGFibGU6IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPiBjdXJyZW50QUJWZXJzaW9uLAogICAgICAgIGN1cnJlbnRBQlZlcnNpb24sCiAgICAgICAgbGF0ZXN0QUJWZXJzaW9uOiBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoLAogICAgfQp9CicBBGJvdHMkZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwAScA8fbqrg3uswoGc3lzdGVtAgQA8fbqrg3vswoOYWIuc2hlbGwuaW5wdXQnAPH26q4N7rMKBGZvcm0CBADx9uquDf6zCgdub3RoaW5nJwDx9uquDe6zCglvbktleURvd24CBADx9uquDYa0CvoKQGNvbnN0IHsga2V5cyB9ID0gdGhhdDsKCmlmIChtYXNrcy5jaGF0T3BlbikgewogICAgY29uc3QgZXNjID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdFc2NhcGUnKTsKCiAgICBpZiAoZXNjKSB7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBhcnJvd1VwID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd1VwJyk7CiAgICAgICAgY29uc3QgYXJyb3dEb3duID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdBcnJvd0Rvd24nKTsKICAgICAgICAKICAgICAgICBpZiAoYXJyb3dVcCB8fCBhcnJvd0Rvd24pIHsKICAgICAgICAgICAgLy8gSWYgQXJyb3dVcCBvciBBcnJvd0Rvd24gYXJlIHByZXNzZWQgd2hpbGUgdGhlIGFiIGNoYXQgYmFyIGlzIG9wZW4gdGhlbgogICAgICAgICAgICAvLyBzdGFydCBjb21iaW5nIHRocm91Z2ggY2hhdCBoaXN0b3J5LgogICAgICAgICAgICBjb25zdCBkaXIgPSBhcnJvd1VwID8gLTEgOiAxOwogICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggKyBkaXI7CiAgICAgICAgICAgIGxldCBoaXN0b3JpY2FsVGV4dCA9IG51bGw7CgogICAgICAgICAgICBpZiAoaW5kZXggPj0gMCAmJiBpbmRleCA8IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGhpc3RvcmljYWxUZXh0ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5W2luZGV4XTsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSAtMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCA+PSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVXBkYXRlIHRoZSBjaGF0IGJhci4KICAgICAgICAgICAgYXdhaXQgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oeyBwcmVmaWxsOiBoaXN0b3JpY2FsVGV4dCB9KTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBjb25zdCBiYWNrdGljayA9IHRoYXQua2V5cy5pbmNsdWRlcygnYCcpIHx8IHRoYXQua2V5cy5pbmNsdWRlcygiRGVhZCIpOwoKICAgIGlmIChiYWNrdGljaykgewogICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgfQp9CicA8fbqrg3uswoGb25DaGF0AgQA8fbqrg2BvwqKGEAvLyBOb3Qgc3VwcG9ydGVkIG91dHNpZGUgb2YgYnVpbGRlciB2ZXJzaW9uCmlmICghYnVpbGRlclZlcnNpb24pIHsKICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIHJldHVybjsKfQoKaWYgKCF0aGF0Lm1lc3NhZ2UpIHsKICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIHJldHVybjsKfQoKLy8gQXBwZW5kIG1lc3NhZ2UgdG8gY2hhdCBoaXN0b3J5IGFuZCB1cGRhdGUgdGhlIGN1cnJlbnQgaGlzdG9yeSBpbmRleC4KdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5LnB1c2godGhhdC5tZXNzYWdlKTsKdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CgovLyBGdW5jdGlvbiB0byBwYXJzZSBhcmd1bWVudHMgd2l0aCBxdW90ZSBzdXBwb3J0IGFuZCBlcnJvciBoYW5kbGluZwovLyBFeGFtcGxlczogCi8vICAgJ2FyZzEgYXJnMicgLT4gWydhcmcxJywgJ2FyZzInXQovLyAgICciYXJnIHdpdGggc3BhY2VzIiBhcmcyJyAtPiBbJ2FyZyB3aXRoIHNwYWNlcycsICdhcmcyJ10KLy8gICAnInVuY2xvc2VkIHF1b3RlJyAtPiB0aHJvd3MgRXJyb3IKZnVuY3Rpb24gcGFyc2VBcmd1bWVudHMoaW5wdXQpIHsKICAgIGNvbnN0IGFyZ3MgPSBbXTsKICAgIGxldCBjdXJyZW50QXJnID0gJyc7CiAgICBsZXQgaW5zaWRlUXVvdGVzID0gbnVsbDsKICAgIGxldCBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBjaGFyID0gaW5wdXRbaV07CiAgICAgICAgCiAgICAgICAgaWYgKGluc2lkZVF1b3RlcykgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgICAgICBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgICAgICAgICAgICAgcXVvdGVTdGFydFBvcyA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICdcXCcgJiYgaSArIDEgPCBpbnB1dC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGkrKzsgLy8gU2tpcCB0aGUgYmFja3NsYXNoCiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGlucHV0W2ldOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBjaGFyOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGNoYXIgPT09ICciJyB8fCBjaGFyID09PSAiJyIpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IGNoYXI7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gaTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAnICcpIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudEFyZyA9ICcnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBjaGFyOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmNsb3NlZCBxdW90ZTogZm91bmQgb3BlbmluZyAke2luc2lkZVF1b3Rlc30gYXQgcG9zaXRpb24gJHtxdW90ZVN0YXJ0UG9zfSBidXQgbm8gY2xvc2luZyBxdW90ZWApOwogICAgfQogICAgCiAgICBpZiAoY3VycmVudEFyZy5sZW5ndGggPiAwKSB7CiAgICAgICAgYXJncy5wdXNoKGN1cnJlbnRBcmcpOwogICAgfQogICAgCiAgICByZXR1cm4gYXJnczsKfQoKaWYgKHRoYXQubWVzc2FnZVswXSA9PSAiLiIpIHsKICAgIGNvbnN0IGNvbW1hbmRQYXJ0ID0gdGhhdC5tZXNzYWdlLnN1YnN0cmluZygxKTsgLy8gUmVtb3ZlIHRoZSBkb3QKICAgIGNvbnN0IHNwYWNlSW5kZXggPSBjb21tYW5kUGFydC5pbmRleE9mKCcgJyk7CiAgICAKICAgIGxldCBjbWQsIGFyZ3M7CiAgICBpZiAoc3BhY2VJbmRleCA9PT0gLTEpIHsKICAgICAgICAvLyBObyBhcmd1bWVudHMKICAgICAgICBjbWQgPSBjb21tYW5kUGFydDsKICAgICAgICBhcmdzID0gdW5kZWZpbmVkOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBIYXMgYXJndW1lbnRzCiAgICAgICAgY21kID0gY29tbWFuZFBhcnQuc3Vic3RyaW5nKDAsIHNwYWNlSW5kZXgpOwogICAgICAgIGNvbnN0IGFyZ3NTdHJpbmcgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoc3BhY2VJbmRleCArIDEpOwogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IHBhcnNlZEFyZ3MgPSBwYXJzZUFyZ3VtZW50cyhhcmdzU3RyaW5nKTsKICAgICAgICAgICAgYXJncyA9IHBhcnNlZEFyZ3MubGVuZ3RoID8gcGFyc2VkQXJncyA6IHVuZGVmaW5lZDsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEVycm9yIHBhcnNpbmcgY29tbWFuZCBhcmd1bWVudHM6ICR7ZXJyb3IubWVzc2FnZX1gLCBsb2dUeXBlOiAnRXJyb3InIH0pOwogICAgICAgICAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9CgogICAgLy8gQ3JlYXRlIGEgZnJlc2ggQ29tbWFuZHNNYW5hZ2VyIHdpdGggZWFjaCBjYWxsIHNvIHRoYXQgd2UgYWx3YXlzIGhhdmUgdGhlIGxhdGVzdCBjb21tYW5kcyBhbmQgZnVuY3Rpb25hbGl0eS4KICAgIGNvbnN0IGFiQ29tbWFuZHMgPSBuZXcgQUJDb21tYW5kc01hbmFnZXIoKTsKCiAgICBpZiAoYWJDb21tYW5kcyAmJiBhYkNvbW1hbmRzLmhhc0NvbW1hbmQoY21kKSkgewogICAgICAgIC8vIENhbGwgY29tbWFuZCB3aXRoIGFyZ3MuCiAgICAgICAgYWJDb21tYW5kcy5jYWxsQ29tbWFuZChjbWQsIGFyZ3MpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBFdmFsdWF0ZSBjb21tYW5kIGFzIGphdmFzY3JpcHQuCiAgICAgICAgY29uc3QganMgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOwogICAgICAgIG9zLnJ1bihqcyk7CiAgICB9Cn0KCnRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsnAPH26q4N7rMKC2Rlc2NyaXB0aW9uAgQA8fbqrg2M1wpCVGhpcyBpcyBtZWFudCB0byBoYW5kbGUgYW55IG5vbmUgbWVudSByZWxhdGVkIGlucHV0cy9pbnRlcmFjdGlvbnMuJwDx9uquDe6zCgxvbkZpbGVVcGxvYWQCBADx9uquDc/XCqI1QGltcG9ydCB7IFJlY29yZEZpbGVSZXN1bHQgfSBmcm9tICdjYXN1YWxvcyc7CgovL2ZpbHRlciBvdXQgdGltZXMgd2hlbiBmaWxlIGxvYWRpbmcgaXMgbm90IGFsbG93ZWQKaWYgKCFidWlsZGVyVmVyc2lvbiB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiTGlzdGVuaW5nRm9yRmlsZVVwbG9hZHMgIT09IHRydWUpIHsKICAgIHJldHVybjsKfQoKLy92YXJpb3VzIGZpbGUgc3BlY2lmaWMgdmFyaWFibGVzCmxldCBmaWxlRXh0ZW5zaW9uID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CmxldCBzaXplID0gdGhhdC5maWxlLnNpemU7CmxldCBjb3B5VXJsID0gdGhhdC5jb3B5VXJsID8/IHRydWU7CmxldCBmb2N1c0NhbWVyYSA9IHRoYXQuZm9jdXNDYW1lcmEgPz8gdHJ1ZTsKbGV0IG1pbWVUeXBlOwpjb25zdCBib3RJbmZvID0ge307CgovL2hhcmQgbGltaXQgYmFzZWQgb24gZmlsZSBzaXplCmlmIChzaXplID4gMjAwMDAwMDAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogIm1heGltdW0gZmlsZSBzaXplIGV4Y2VlZGVkICgyMDAgbWIpIiwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIHJldHVybjsKfQoKLyoqCiAqIEhlbHBlciBmdW5jdGlvbiBmb3IgcmV0cmlldmluZyBpbWFnZSBkaW1lbnNpb25zICYgYXNwZWN0IGZyb20gQXJyYXlCdWZmZXIgZGF0YS4KICogUmVxdWlyZXMgQ2FzdWFsT1MgYmUgY29uZmlndXJlZCB0byBoYXZlIGFjY2VzcyB0byB0aGUgRE9NLgogKi8KZnVuY3Rpb24gZ2V0SW1hZ2VEaW1lbnNpb25zKGFycmF5QnVmZmVyLCBtaW1lVHlwZSkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2FycmF5QnVmZmVyXSwgeyB0eXBlOiBtaW1lVHlwZSB9KTsKICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOwogICAgICAgIGNvbnN0IGltZyA9IG5ldyBzZWxmLkltYWdlKCk7CiAgICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHsKICAgICAgICAgICAgcmVzb2x2ZSh7IHdpZHRoOiBpbWcubmF0dXJhbFdpZHRoLCBoZWlnaHQ6IGltZy5uYXR1cmFsSGVpZ2h0LCBhc3BlY3Q6IGltZy5uYXR1cmFsV2lkdGggLyBpbWcubmF0dXJhbEhlaWdodCB9KTsKICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh1cmwpOwogICAgICAgIH07CiAgICAgICAgaW1nLm9uZXJyb3IgPSByZWplY3Q7CiAgICAgICAgaW1nLnNyYyA9IHVybDsKICAgIH0pOwp9CgovL3RoaXMgc3dpdGNoIGhhbmRsZXMgcG9zc2libGUgZmlsZXMgZXh0ZW5zaW9ucywgd2hpbGUgcmVqZWN0aW5nIGFueSBpdCBkb2VzIG5vdCByZWNvZ25pemUKc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICBjYXNlICdqcGcnOgogICAgY2FzZSAnanBlZyc6CiAgICBjYXNlICd3ZWJwJzoKICAgIGNhc2UgJ2dpZic6CiAgICBjYXNlICdwbmcnOgogICAgICAgIG1pbWVUeXBlID0gImltYWdlLyIgKyBmaWxlRXh0ZW5zaW9uOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgICAgIGJvdEluZm8uYW5jaG9yUG9pbnQgPSAn8J+nrFswLDAsLTAuMDFdJzsKCiAgICAgICAgaWYgKG9zLmRldmljZSgpLnN1cHBvcnRzRE9NKSB7CiAgICAgICAgICAgIGNvbnN0IGltYWdlRGltZW5zaW9ucyA9IGF3YWl0IGdldEltYWdlRGltZW5zaW9ucyh0aGF0LmZpbGUuZGF0YSwgbWltZVR5cGUpOwoKICAgICAgICAgICAgLy8gQWRqdXN0IHNjYWxlIHRvIHJlc3BlY3QgYXNwZWN0IHJhdGlvLiBUaGlzIGlzICJjb3ZlciIgc2NhbGluZyBzdHlsZS4KICAgICAgICAgICAgaWYgKGltYWdlRGltZW5zaW9ucy5hc3BlY3QgPj0gMSkgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVggPSBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVkgPSAxIC8gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdzdmcnOgogICAgICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgICAgIGJvdEluZm8uYW5jaG9yUG9pbnQgPSAn8J+nrFswLDAsLTAuMDFdJzsKCiAgICAgICAgaWYgKG9zLmRldmljZSgpLnN1cHBvcnRzRE9NKSB7CiAgICAgICAgICAgIGNvbnN0IGltYWdlRGltZW5zaW9ucyA9IGF3YWl0IGdldEltYWdlRGltZW5zaW9ucyh0aGF0LmZpbGUuZGF0YSwgbWltZVR5cGUpOwoKICAgICAgICAgICAgLy8gQWRqdXN0IHNjYWxlIHRvIHJlc3BlY3QgYXNwZWN0IHJhdGlvLiBUaGlzIGlzICJjb3ZlciIgc2NhbGluZyBzdHlsZS4KICAgICAgICAgICAgaWYgKGltYWdlRGltZW5zaW9ucy5hc3BlY3QgPj0gMSkgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVggPSBpbWFnZURpbWVuc2lvbnMuYXNwZWN0OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm90SW5mby5zY2FsZVkgPSAxIC8gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBicmVhazsKICAgIGNhc2UgJ2dsYic6CiAgICBjYXNlICdleHInOgogICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgbWltZVR5cGUgPSAidGV4dC94bWwiOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJtZXNoIjsKICAgICAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gImdsdGYiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnYXV4JzoKICAgIGNhc2UgJ3BkZic6CiAgICAgICAgbGV0IGJvdERhdGEgPSBmaWxlRXh0ZW5zaW9uID09ICIuYXV4IiA/IEpTT04ucGFyc2UodGhhdC5maWxlLmRhdGEpLnN0YXRlIDogb3MucGFyc2VCb3RzRnJvbURhdGEodGhhdC5maWxlLmRhdGEpOwogICAgICAgIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3RzOiBib3REYXRhLCBvcmlnaW46IGZpbGVOYW1lLCBzb3VyY2VFdmVudDogJ2ZpbGVfdXBsb2FkJyB9KTsKICAgICAgICByZXR1cm47CiAgICBjYXNlICdtcDMnOgogICAgICAgIG1pbWVUeXBlID0gJ2F1ZGlvL21wZWcnOwogICAgICAgIGJvdEluZm8ub25DbGljayA9ICJAIG9zLnBsYXlTb3VuZCh0YWdzLmZvcm1BZGRyZXNzKTsiOwogICAgICAgIGJvdEluZm8ubGFiZWwgPSAiQ2xpY2sgdG8gUGxheSI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdtcDQnOgogICAgICAgIG1pbWVUeXBlID0gJ3ZpZGVvL21wNCc7CiAgICAgICAgYm90SW5mby5mb3JtID0gImlmcmFtZSI7CiAgICAgICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJzcmMiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnb3RmJzoKICAgICAgICBtaW1lVHlwZSA9ICdmb250L290Zic7CiAgICAgICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ3dvZmYnOgogICAgICAgIG1pbWVUeXBlID0gJ2ZvbnQvd29mZic7CiAgICAgICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBmaWxlIHR5cGUgbm90IHN1cHBvcnRlZGAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgcmV0dXJuIG5ldyBFcnJvcigidW5oYW5kbGVkIGZpbGUgdHlwZTogIiArIGZpbGVFeHRlbnNpb24pOwp9CgovL3RoZSBmb2xsb3dpbmcgdmFyaWFibGVzIGFuZCBvYmplY3RzIHNldCB1cCBhIGxvYWRpbmcgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgdXBsb2FkaW5nYCB9KTsKCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvOwoKaWYgKCFjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCkgewogICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cn0KCi8vdGhpcyBpcyB0aGUgYWN0dWFsIHVwbG9hZCBmdW5jdGlvbmFsaXR5CmxldCB1cGxvYWRSZXN1bHQ6IFJlY29yZEZpbGVSZXN1bHQgPSBhd2FpdCBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogdGhhdC5maWxlLmRhdGEsIGZpbGVOYW1lOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlIH0pOwoKaWYgKHVwbG9hZFJlc3VsdCkgewogICAgaWYgKHVwbG9hZFJlc3VsdC5zdWNjZXNzIHx8IHVwbG9hZFJlc3VsdC5lcnJvckNvZGUgPT09ICdmaWxlX2FscmVhZHlfZXhpc3RzJykgewogICAgICAgIGNvbnN0IGZpbGVVUkwgPSB1cGxvYWRSZXN1bHQudXJsID8/IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgICAgIC8vaWYgdGhlIGZpbGUgc2hvdWxkIGJlIGluY2x1ZGVkIGFzIGEgYm90IHdpdGggYSBsaW5rLCB0aGlzIGxvZ2ljIGhhbmRsZXMgdGhhdAogICAgICAgIGlmIChPYmplY3Qua2V5cyhib3RJbmZvKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGxldCBkaW1lbnNpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uOwoKICAgICAgICAgICAgaWYgKCFkaW1lbnNpb24pIHsKICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmYWxsYmFjayB0byB3aGF0ZXZlciBpcyB0aGUgdmlzaWJsZSBwb3J0YWwuCiAgICAgICAgICAgICAgICBpZiAoY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb25maWdCb3QudGFncy5ncmlkUG9ydGFsKSB7CiAgICAgICAgICAgICAgICAgICAgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGRpbWVuc2lvbikgewogICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb25dID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgICAgICAgICAgICAgIGxldCBwb3NpdGlvbiA9IGdldEJvdFBvc2l0aW9uKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QsIGRpbWVuc2lvbik7CiAgICAgICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb24gKyAnWCddID0gcG9zaXRpb24ueDsKICAgICAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbiArICdZJ10gPSBwb3NpdGlvbi55OwogICAgICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uICsgJ1onXSA9IHBvc2l0aW9uLno7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtaW1lVHlwZS5pbmNsdWRlcygiZm9udCIpKSB7CiAgICAgICAgICAgICAgICBib3RJbmZvLmxhYmVsRm9udEFkZHJlc3MgPSBmaWxlVVJMOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYm90SW5mby5mb3JtQWRkcmVzcyA9IGZpbGVVUkw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGJvdEluZm8uYWJGaWxlVXBsb2FkID0gdHJ1ZTsKCiAgICAgICAgICAgIGNvbnN0IGJvdCA9IGNyZWF0ZShib3RJbmZvKTsKCiAgICAgICAgICAgIGlmIChmb2N1c0NhbWVyYSkgewogICAgICAgICAgICAgICAgb3MuZm9jdXNPbihib3QsIHsgZHVyYXRpb246IDEgfSkuY2F0Y2goZSA9PiB7fSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNvcHlVcmwpIHsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGZpbGVVUkwpOwogICAgICAgICAgICAKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJUb2FzdCh7IG1lc3NhZ2U6IGBGaWxlIHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkLmAsIGxvZ1R5cGU6ICdsb2cnIH0pOwogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBGaWxlIHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke2ZpbGVVUkx9YCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYEZhaWxlZCB0byB1cGxvYWQgZmlsZS4gUmVhc29uOiAke3VwbG9hZFJlc3VsdC5lcnJvck1lc3NhZ2V9YCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gdXBsb2FkIGZpbGUuIFJlc3VsdDogJHtKU09OLnN0cmluZ2lmeSh1cGxvYWRSZXN1bHQpfWAsIGxvZ1R5cGU6IGBlcnJvcmB9KTsKICAgIH0KfSBlbHNlIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2l0aCBmaWxlIHVwbG9hZC5gLCBsb2dUeXBlOiBgZXJyb3JgfSk7Cn0KCi8vY2xlYXIgdGhlIHByb2dyZXNzIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwoKaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHVwbG9hZFJlc3VsdDsnAPH26q4N7rMKBWxlYXJuAgQA8fbqrg3ujAso8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA8fbqrg3uswoIcmVtZW1iZXICBADx9uquDZWNCyjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDx9uquDe6zCg1tYW5pZmVzdGF0aW9uAgQA8fbqrg28jQso8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA8fbqrg3uswoIYWJJZ25vcmUCBADx9uquDeONCwR0cnVlJwDx9uquDe6zCgZjcmVhdGUCBADx9uquDeiNCyjwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwDx9uquDe6zCgVzdG9yZQIEAPH26q4Nj44LKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAPH26q4N7rMKBG1lbnUCBADx9uquDbaOCyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDx9uquDe6zCgdhYlNoZWxsAgQA8fbqrg3djgsEdHJ1ZScA8fbqrg3uswoJb25UYXBDb2RlAgQA8fbqrg3ijgupAkBjb25zdCB0YXBDb2RlID0gdGhhdDsKCnN3aXRjaCAodGFwQ29kZSkKewogICAgY2FzZSAiMzM0MiI6CiAgICAgICAgb3MudG9hc3QoIndha2luZyAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSk7CgogICAgICAgIHRoaXNCb3Qub25DaGF0KHttZXNzYWdlOiAiLi4ifSk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICI0MjQyIjoKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgLy9jb25zb2xlLmxvZyh0YXBDb2RlKTsKfScA8fbqrg3uswoDYXNrAgQA8fbqrg2MkQso8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycA8fbqrg3uswoJYWJWZXJzaW9uAgQA8fbqrg2zkQsFMTAuMjknAPH26q4N7rMKCm9uQm90QWRkZWQCBADx9uquDbmRC0BAdGhpc0JvdC5sb2FkQUJDb21tYW5kc01hbmFnZXIoKTsKdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5ID0gW107JwDx9uquDe6zChpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAPH26q4N+pEL12tAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCi8vIFRoZXNlIGFyZSBhbGwgdGhlIGJ1aWx0LWluIGNvbW1hbmRzLgoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdoZWxwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGNvbW1hbmRzID0gYWJDb21tYW5kcy5jb21tYW5kczsKICAgIGNvbnN0IGNvbW1hbmRLZXlzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpOwoKICAgIGxldCBzZWxlY3RlZENvbW1hbmQ7CiAgICBpZiAoY29tbWFuZEtleXMgJiYgY29tbWFuZEtleXMubGVuZ3RoICYmIGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb21tYW5kS2V5TWF0Y2ggPSBjb21tYW5kS2V5cy5maW5kKGtleSA9PiBrZXkgPT09IGFyZ3NbMF0pOwogICAgICAgIHNlbGVjdGVkQ29tbWFuZCA9IGNvbW1hbmRLZXlNYXRjaDsKICAgIH0KICAgIAogICAgbGlua3MuaGVscC5tb3VudCh7IGFiQ29tbWFuZHNNYW5hZ2VyOiBhYkNvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IHRoaXMgaGVscCB3aW5kb3cuIENhbiBzcGVjaWZ5IGEgY29tbWFuZCB0byBvcGVuIHRoZSBoZWxwIHBhZ2UgZm9yIHRoYXQgY29tbWFuZCBkaXJlY3RseS4nLAogICAgdXNhZ2U6IFsnLmhlbHAnLCAnLmhlbHAgW2NvbW1hbmRdJ10KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJy4nLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcuLicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3dha2UnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcud2FrZScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NsZWVwJywgYXJncyA9PiB0aGlzQm90LmNtZEFCU2xlZXAoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdXQgYWIgdG8gc2xlZXAuJywKICAgIHVzYWdlOiAnLnNsZWVwJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYWNjb3VudCcsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBlbmRwb2ludCA9IGF3YWl0IG9zLmdldFJlY29yZHNFbmRwb2ludCgpOwogICAgb3Mub3BlblVSTChlbmRwb2ludCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBhY2NvdW50L3JlY29yZHMgcGFnZSBpbiBhIG5ldyB0YWIuJywKICAgIHVzYWdlOiAnLmFjY291bnQnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhc2snLCAoYXJncykgPT4gewogICAgaWYgKGxpbmtzLmFzaykgewogICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBhc2tJbnB1dCA9IGFyZ3Muam9pbignICcpOwogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLmFzayBjb21tYW5kIHJlcXVpcmVzIGlucHV0YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhc2sgYm90IGlzIG5vdCBsb2FkZWQsIGNhbm5vdCBsb2FkIGFza2ApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQXNrIGFiJywKICAgIHVzYWdlOiAnLmFzayA8YXNrX25hbWU+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbmFtZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSwgeyB0aXRsZTogJ3doYXQgd291bGQgeW91IGxpa2UgdG8gY2FsbCBtZT8nIH0pOwogICAgc2V0VGFnTWFzayhsaW5rcy5wZXJzb25hbGl0eSwgJ2FiQnVpbGRlcklkZW50aXR5JywgbmFtZSwgJ2xvY2FsJyk7CiAgICBzaG91dCgnY2hhbmdlUGVyc29uYWxpdHlDb25maWcnLCB7IG5hbWU6IG5hbWUgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHaXZlIGFiIGEgbmV3IG5hbWUuJywKICAgIHVzYWdlOiAnLm5hbWVhYicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwZGF0ZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGxpbmtzLmxlYXJuLnVwZGF0ZUFCKCk7Owp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBkYXRlIEFCIGNvcmUgYW5kIHNraWxscyB0byBjdXJyZW50IGNvZGUuJywKICAgIHVzYWdlOiAnLnVwZGF0ZWFiJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc3lzdGVtJywgYXJncyA9PiB0aGlzQm90LmNtZFN5c3RlbShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpbnN0LicsCiAgICBsb25nRGVzY3JpcHRpb246IGBPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaSAgICAKCiAgICBZb3UgbWF5IHByb3ZpZGUgYSBjdXN0b20gc3lzdGVtVGFnTmFtZSB3aXRoIHRoZSBjb21tYW5kLCBpbiBvcmRlciB0byBvcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIG9ubHkgZm9yIGJvdHMgd2l0aCB0aGUgZ2l2ZW4gc3lzdGVtVGFnTmFtZS4gQnkgZGVmYXVsdCwgInN5c3RlbSIgd2lsbCBiZSB1c2VkIGFzIHRoZSBzeXN0ZW1UYWdOYW1lLgoKICAgIEZvciBleGFtcGxlOgoKICAgID4gLnN5c3RlbQogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAic3lzdGVtIiB0YWcuCgogICAgPiAuc3lzdGVtIG15R3JvdXAKICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgIm15R3JvdXAiIHRhZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuc3lzdGVtJywKICAgICAgICAnLnN5c3RlbSBzeXN0ZW1UYWdOYW1lJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBpbiB0aGUgY3VycmVudCB3aW5kb3cuIEJ5IGRlZmF1bHQgdGhlIHN5c3RlbSBwb3J0YWwgd2lsbCBvcGVuIGluIGEgbmV3IHRhYi4nCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nJywgKGFyZ3MpID0+IHsKICAgIGxpbmtzLmNvbnNvbGUudG9nZ2xlQ29uc29sZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVG9nZ2xlIHZpc2libGl0eSBvZiB0aGUgYWIgbG9nLicsCiAgICB1c2FnZTogJy5sb2cnCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZ2NsZWFyJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG1lc3NhZ2VMb2dCb3RzID0gZ2V0Qm90cygiY29uc29sZUxvZ01lc3NhZ2VCb3QiLCB0cnVlKTsKICAgIGRlc3Ryb3kobWVzc2FnZUxvZ0JvdHMpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQ2xlYXIgYWxsIGFiIGxvZyBtZXNzYWdlcy4nLAogICAgdXNhZ2U6ICcubG9nY2xlYXInCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NoZWV0JywgYXJncyA9PiB0aGlzQm90LmNtZFNoZWV0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciBzcGVjaWZpZWQgYm90IG9yIGFuIGVudGlyZSBkaW1lbnNpb24uJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zaGVldCBbb3B0aW9uc10gW3BvcnRhbCB8IGhlbHBlckJvdE5hbWUgfCBib3RJZCB8IGdsb2JhbFRoaXNQYXRoXScsCiAgICAgICAgJ2V4LiAuc2hlZXQgaG9tZScsCiAgICAgICAgJ2V4LiAuc2hlZXQgY29uZmlnQm90JywKICAgICAgICAnZXguIC5zaGVldCAtdCBhMmNmNDczOS0zOWEyLTRmZDYtYjNlZi1jYzQ3ODJmOTcwODknLAogICAgICAgICdleC4gLnNoZWV0IGdsb2JhbFRoaXMubXlPYmplY3QubXlCb3QnLAogICAgICAgICdleC4gLnNoZWV0IG15T2JqZWN0Lm15Qm90JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGluIGEgbmV3IGJyb3dzZXIgdGFiLiBcblxuTk9URTogLnNoZWV0IHdpbGwgYXV0b21hdGljYWxseSBpbnNwZWN0IHRoZSBzcGFjZSBvZiBhIGJvdCBhbmQgZm9yY2Ugb3BlbmluZyBpbiB0aGUgc2FtZSB0YWIgaWYgYSBib3QgaXMgaW4gdGVtcExvY2FsIG9yIHRlbXBTaGFyZWQgc3BhY2UuJywKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdtZW51c2hlZXQnLCAoYXJncykgPT4gewogICAgY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgPSBjb25maWdCb3QudGFncy5tZW51UG9ydGFsOwogICAgaWYgKCFjb25maWdCb3QudGFncy5tZW51UG9ydGFsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBDYW5ub3Qgb3BlbiBzaGVldFBvcnRhbCBmb3IgbWVudVBvcnRhbCBib3RzLiBUaGUgbWVudVBvcnRhbCBpcyBjdXJyZW50bHkgZGlzYWJsZWQuYH0pCiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHRoZSBjdXJyZW50IG1lbnUgcG9ydGFsLicsCiAgICB1c2FnZTogJy5tZW51U2hlZXQnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRpbnN0JywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkSW5zdChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIHRoZSBpbnN0IHRvIGRpc2suJywKICAgIHVzYWdlOiAnLmRvd25sb2FkaW5zdCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2Fkc3lzdGVtJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkU3lzdGVtKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgdGhlIHNwZWNpZmllZCBib3Qgc3lzdGVtKHMpIHRvIGRpc2suJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIHRoZSBzcGVjaWZpZWQgYm90IHN5c3RlbShzKSB0byBkaXNrLgogICAgCiAgICBUaGUgcHJvdmlkZWQgc3lzdGVtTmFtZShzKSBpbGwgYmUgdXNlZCB0byBtYXRjaCBhZ2FpbnN0IGJvdHMgd2hvc2Ugc3lzdGVtIHRhZyBzdGFydHMgd2l0aCBzeXN0ZW1OYW1lKHMpLiBJdCB3aWxsIHJlc3BlY3QgdGhlIGRvdCBub3RhdGlvbiBvZiB0aGUgc3lzdGVtIHRhZywgc28gcGFydGlhbCBtYXRjaGVzIHdpbGwgbm90IHdvcmsuIFNlZSB0aGUgZXhhbXBsZXMgYmVsb3cgZm9yIGEgYmV0dGVyIHVuZGVyc3RhbmRpbmcuCgogICAgRm9yIGV4YW1wbGUgaWYgc3lzdGVtTmFtZSBpcyAiaGVsbG8iOgoKICAgIFN5c3RlbSBUYWcgLT4gRG93bmxvYWQ/CiAgICAtIGhlbGxvIC0+IHllcwogICAgLSBoZWxsby53b3JsZC5tYWluIC0+IHllcwogICAgLSBoZWxsby53b3JsZC5maXJld29ya3MgLT4geWVzCiAgICAtIHJjLnJlZEJvdCAtPiBubwogICAgLSBoZWxsb1dvcmxkLmJvdCAtPiBubwogICAgLSBoZWxpdW0uYXRvbSAtPiBubwogICAgLSBoZXguZ3JpZC5oZWxsbyAtPiBubwogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5kb3dubG9hZHN5c3RlbSBbLi4uc3lzdGVtTmFtZV0nCiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGFiJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkQUIoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBzcGVjaWZpZWQgYWIgZ3JvdXAocykgdG8gZGlzay4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suCgogICAgWW91IGNhbiBwcm92aWRlIGEgbGlzdCBvZiBncm91cHMgdG8gZG93bmxvYWQgYWxvbmcgd2l0aCB0aGUgY29tbWFuZDoKICAgID4gLmRvd25sb2FkYWIgYWJDb3JlIGFiU2hlbGwgYWJJbnRlcmZhY2UKCiAgICBJZiBncm91cChzKSBhcmUgbm90IHByb3ZpZGVkIHdpdGggdGhlIGNvbWFtYW5kIHRoZW4geW91IHdpbGwgYmUgcHJvbXB0ZWQgdG8gcHJvdmlkZSBvbmUgd2l0aCBhIGRpYWxvZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRhYiBbb3B0aW9uc10gW2dyb3VwLi4uXScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiBhYlNoZWxsIGFiSW50ZXJmYWNlJywKICAgICAgICAnZXguIC5kb3dubG9hZGFiIC12IDEgbXlHcm91cE5hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy12JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdTcGVjaWZ5IHRoZSBhdXggZm9ybWF0IHZlcnNpb24gbnVtYmVyLiBleC4gLXYgMSB3aWxsIGJlIGF1eCBmb3JtYXQgdmVyc2lvbiAxIChwdXJlIGJvdCBqc29uKS4gQnkgZGVmYXVsdCwgYWIgZmlsZXMgYXJlIHVzdWFsbHkgZG93bmxvYWRlZCBhcyB2ZXJzaW9uIDIgYXV4IGZpbGVzIChjb25mbGljdC1mcmVlIHVwZGF0ZSkuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkZWdnJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkRWdnKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLiBZb3Ugd2lsbCBuZWVkIHRvIHByb3ZpZGUgdGhlIHJlY29yZEtleSBhcyB3ZWxsIGFuZCB0aGUgbmFtZSBvZiB0aGUgZWdnLiBBIGRyb3Bkb3duIHNlbGVjdGlvbiB3aWxsIGJlIHByb3ZpZGVkIGZvciB0aGUgZWdnIGlmIGZvdW5kIHRvIHNlbGVjdCB3aGljaCB2ZXJzaW9uIHRvIGRvd25sb2FkLmAsCiAgICB1c2FnZTogJy5kb3dubG9hZGVnZycsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2Fkc2tpbGwnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKGFyZ3MpIHsKICAgICAgICBmb3IgKGxldCBza2lsbCBvZiBhcmdzKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoc2tpbGwpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnLmxvYWRza2lsbCByZXF1aXJlcyBzb21lIHNraWxsIG5hbWVzJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdMb2FkIHRoZSBzcGVjaWZpZWQgYWIgc2tpbGxzLicsCiAgICB1c2FnZTogJy5sb2FkU2tpbGwgW3NraWxsIC4uLl0nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cmxxcicsICgpID0+IG9zLnNob3dRUkNvZGUoY29uZmlnQm90LnRhZ3MudXJsKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgYSBRUiBjb2RlIGZvciB0aGUgYnJvd2VyIHRhYlwncyBjdXJyZW50IFVSTC4nLAogICAgdXNhZ2U6ICcudXJscXInCn0pOwoKY29uc3QgRElNX1NVUFBPUlRFRF9QT1JUQUxTID0gWydncmlkJywgJ21hcCcsICdtaW5pR3JpZCcsICdtaW5pTWFwJywgJ3NoZWV0JywgJ3N5c3RlbScsICdtZW51JywgJ3RhZyddOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkaW0nLCAoYXJncykgPT4gewogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBsZXQgcG9ydGFsID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXAnKTsKICAgICAgICBsZXQgZGltZW5zaW9uID0gYXJncy5qb2luKCcgJyk7CgogICAgICAgIGlmICghcG9ydGFsKSB7CiAgICAgICAgICAgIHBvcnRhbCA9ICdncmlkJzsKICAgICAgICB9CgogICAgICAgIGlmIChkaW1lbnNpb24gPT09ICJudWxsIiB8fCBkaW1lbnNpb24gPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGRpbWVuc2lvbiA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoRElNX1NVUFBPUlRFRF9QT1JUQUxTLmluZGV4T2YocG9ydGFsKSA+PSAwKSB7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzW2Ake3BvcnRhbH1Qb3J0YWxgXSA9IGRpbWVuc2lvbjsKCiAgICAgICAgICAgIGlmIChkaW1lbnNpb24gPT0gbnVsbCkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBDbG9zZWQgJHtwb3J0YWx9UG9ydGFsLmAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFNldCAke3BvcnRhbH1Qb3J0YWwgdG8gJyR7ZGltZW5zaW9ufScgZGltZW5zaW9uLmAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYCR7cG9ydGFsfSBpcyBub3QgYSBzdXBwb3J0ZWQgcG9ydGFsIGZvciB0aGUgZGltIGNvbW1hbmQuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KQogICAgICAgIH0KICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dvIHRvIHNwZWNpZmllZCBwb3J0YWwgZGltZW5zaW9uLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBHbyB0byBzcGVjaWZpZWQgcHJvdGFsIGRpbWVuc2lvbi4KICAgIAogICAgSWYgYSBwb3J0YWwgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkIHRoZW4gaXQgd2lsbCBkZWZhdWx0IHRvIHRoZSBncmlkUG9ydGFsLgogICAgCiAgICBJZiBhIGRpbWVuc2lvbiBpcyBub3QgcHJvdmlkZWQgb3IgaXMgIm51bGwiIHRoZW4gdGhlIHBvcnRhbCB3aWxsIGJlIHNldCB0byBudWxsIGFuZCBiZSBjbG9zZWQuYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5kaW0gPGRpbWVuc2lvbj4nLAogICAgICAgICcuZGltIC1wIDxwb3J0YWw+IDxkaW1lbnNpb24+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBgU3BlY2lmeSB0aGUgcG9ydGFsIG5hbWUuIENhbiBiZSBhbnlvbmUgb2YgdGhlIGZvbGxvd2luZzogJHtESU1fU1VQUE9SVEVEX1BPUlRBTFMuam9pbignLCAnKX1gCiAgICAgICAgfQogICAgXQoKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3V1aWQnLCAoKSA9PiB7CiAgICBvcy5zZXRDbGlwYm9hcmQodXVpZCgpKTsKCiAgICBsZXQgbWVzc2FnZSA9IGBDb3BpZWQgbmV3IHV1aWQgdG8gY2xpcGJvYXJkYDsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgb3MudG9hc3QobWVzc2FnZSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHZW5lcmF0ZSBhIHVuaXZlcnNhbGx5IHVuaXF1ZSBpZGVudGlmaWVyICh1dWlkKSBhbmQgY29weSBpdCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy51dWlkJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZHVwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGJvdElkID0gYXJncyA/IGFyZ3NbMF0gOiB1bmRlZmluZWQ7CiAgICBpZiAoYm90SWQpIHsKICAgICAgICBjb25zdCBib3QgPSBnZXRCb3QoJ2lkJywgYm90SWQpOwogICAgICAgIGlmIChib3QpIHsKICAgICAgICAgICAgY29uc3QgZHVwQm90ID0gY3JlYXRlKGJvdCk7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChkdXBCb3QuaWQpOwogICAgICAgICAgICBvcy50b2FzdCgnRHVwbGljYXRlIGJvdCBpZCBjb3BpZWQgdG8gY2xpcGJvYXJkLicpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9zLnRvYXN0KGBObyBib3QgZm91bmQgd2l0aCBpZCAke2JvdElkfWApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgb3MudG9hc3QoJ1Byb3ZpZGUgdGhlIGlkIG9mIHRoZSBib3QgeW91IHdhbnQgdG8gZHVwbGljYXRlJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEdXBsaWNhdGUgYSBzcGVjaWZpZWQgYm90IGFuZCBjb3B5IHRoZSBuZXcgYm90XCdzIGlkIHRvIHRoZSBjbGlwYm9hcmQuJywKICAgIHVzYWdlOiAnLmR1cCA8Ym90SWQ+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkYXV4JywgKGFyZ3MpID0+IHsKICAgIG9zLnNob3dVcGxvYWRBdXhGaWxlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgQVVYIGZpbGUocykgdG8gdGhlIGN1cnJlbnQgaW5zdC4nLAogICAgdXNhZ2U6ICcudXBsb2FkYXV4Jwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGxvYWRmaWxlcycsIGFyZ3MgPT4gdGhpc0JvdC5jbWRVcGxvYWRGaWxlcyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwbG9hZCBmaWxlKHMpIGRpcmVjdGx5IHRvIHJlY29yZC4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnVwbG9hZGZpbGVzJywKICAgICAgICAnLnVwbG9hZGZpbGVzIC1yZWNvcmQgPHJlY29yZF9pZD4nCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1yZWNvcmQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wdGlvbmFsbHkgcHVibGlzaCBmaWxlKHMpIHRvIGEgc3BlY2lmaWMgcmVjb3JkLiBJZiBvbWl0dGVkLCBmaWxlKHMpIHdpbGwgYmUgcHVibGlzaGVkIHRvIHRoZSB1c2VyXCdzIHBlcnNvbmFsIHJlY29yZC4nCiAgICAgICAgfQogICAgXQp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdwdWJsaXNoYXNrJywgYXJncyA9PiB0aGlzQm90LmNtZFB1Ymxpc2hBc2soYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdWJsaXNoIGFuIGFzayB0byB0aGUgcHVibGljIGFiIHJlY29yZC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgUHVibGlzaCBhbiBhc2sgdG8gdGhlIHB1YmxpYyBhYiByZWNvcmQuCgogICAgQW4gYWIgYXNrIGlzIGEgbGl0dGxlIHBvaW50ZXIgdG8gYSBwYXR0ZXJuIGluc2lkZSBvZiBhIHNwZWNpZmljIHN0dWRpby4gVGhlIGFzayBjYW4gYmUgdXNlZCB0byBsb2FkIHRoZSBnaXZlbiBwYXR0ZXJuIHVzaW5nIGEgc2ltcGxlIG5hbWUsIGxpa2UgYSBzaG9ydGN1dCBvciBhbiBhbGlhcy4KCiAgICBUaGUgYXNrIGl0c2VsZiBpcyBzdG9yZWQgaW4gdGhlIHB1YmxpYyBhYiByZWNvcmQgc28gdGhhdCBhbnlvbmUgY2FuIHJlYWQgdGhlIHBvaW50ZXIgZmlsZSwgYnV0IHRoZSBwZXJtaXNzaW9ucyBmb3IgdGhlIHBhdHRlcm4gaW5zaWRlIHRoZSBzdHVkaW8gYXJlIHN0aWxsIG1hbmFnZWQgYnkgdGhlIG9yaWdpbmFsIGF1dGhvci4KCiAgICBBbnkgdXBkYXRlcyB0byBhbiBleGlzdGluZyBhc2sgd2lsbCBiZSBvdmVyd3JpdHRlbi4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcucHVibGlzaGFzayAtYXNrIDxhc2tJRD4gLXBhdHRlcm4gPHBhdHRlcm5JRD4gLXN0dWRpbyA8c3R1ZGlvSUQ+JywKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLWFzaycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIGFzayB0byBiZSBzZXQuJywKICAgICAgICB9LAogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1wYXR0ZXJuJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgcGF0dGVybiBzZXQgdGhlIGFzayB0byBwb2ludCBhdC4nLAogICAgICAgIH0sCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXN0dWRpbycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIHN0dWRpbyB0byBzZXQgdGhlIGFzayB0byBwb2ludCBhdC4gVGhpcyBpcyB0ZWNobmljYWxseSBvcHRpb25hbCwgaWYgbm90IHByb3ZpZGVkIHRoZW4gdGhlIHN0dWRpbyBJRCBvZiB0aGUgY3VycmVudGx5IGxvZ2dlZCBpbiB1c2VyIHdpbGwgYmUgdXNlZC4nLAogICAgICAgIH0KICAgIF0KfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndmlld3JlY29yZGRhdGEnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKCFsaW5rcy52aWV3UmVjb3JkRGF0YUFwcCkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiVmlld1JlY29yZCcpOwogICAgfQoKICAgIGNvbnN0IGlzQWxpYXMgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ0ZsYWcoYXJncywgJy1hJykKCiAgICBsZXQgcmVjb3JkTmFtZTsKCiAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICByZWNvcmROYW1lID0gYXJncy5qb2luKCcgJyk7CiAgICB9CgogICAgaWYgKGlzQWxpYXMpIHsKICAgICAgICBzd2l0Y2gocmVjb3JkTmFtZSkgewogICAgICAgICAgICBjYXNlICdwbGF5ZXInOgogICAgICAgICAgICAgICAgaWYgKGF1dGhCb3QpIHsKICAgICAgICAgICAgICAgICAgICByZWNvcmROYW1lID0gYXV0aEJvdC5pZDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLnZpZXdyZWNvcmRkYXRhIG11c3QgYmUgbG9nZ2VkIGluIHRvIHZpZXcgcGxheWVyIHJlY29yZC5gKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSAnYWInOgogICAgICAgICAgICAgICAgcmVjb3JkTmFtZSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmROYW1lOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAudmlld3JlY29yZGRhdGEgY29tbWFuZCBkb2VzIG5vdCByZWNvZ25pemUgYWxpYXMgJHtyZWNvcmROYW1lfWApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFyZWNvcmROYW1lICYmIGF1dGhCb3QpIHsKICAgICAgICAgICAgcmVjb3JkTmFtZSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQogICAgfQogICAgCiAgICBpZiAocmVjb3JkTmFtZSkgewogICAgICAgIGxpbmtzLnZpZXdSZWNvcmREYXRhQXBwLm1vdW50KHsgcmVjb3JkTmFtZSB9KTsKICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLnZpZXdyZWNvcmRkYXRhIGNvbW1hbmQgcmVxdWlyZXMgYSByZWNvcmROYW1lYCk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdWaWV3IGRhdGEgc3RvcmVkIGluIHByb3ZpZGVkIHJlY29yZCBuYW1lLiBJZiByZWNvcmQgbmFtZSBpcyBub3QgcHJvdmlkZWQgdGhlbiBpdCB3aWxsIGRlZmF1bHQgdG8geW91ciBwZXJzb25hbCByZWNvcmQuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYFZpZXcgZGF0YSBzdG9yZWQgaW4gcHJvdmlkZWQgcmVjb3JkIG5hbWUuIElmIHJlY29yZCBuYW1lIGlzIG5vdCBwcm92aWRlZCB0aGVuIGl0IHdpbGwgZGVmYXVsdCB0byB5b3VyIHBlcnNvbmFsIHJlY29yZC4KCiAgICBUaGVyZSBhcmUgc29tZSBhbGlhc2VzIHRoYXQgY2FuIGJlIHVzZWQgd2l0aCB0aGUgYWxpYXMgYXJndW1lbnQgdG8gbG9hZCBhIHJlY29yZCB2aWEgYWxpYXM6CiAgICAtIHBsYXllcjogeW91ciBwZXJzb25hbCByZWNvcmQKICAgIC0gYWI6IGFiJ3MgcHVibGljIHJlY29yZAogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy52aWV3cmVjb3JkZGF0YScsCiAgICAgICAgJy52aWV3cmVjb3JkZGF0YSBbcmVjb3JkTmFtZV0nLAogICAgICAgICctdmlld3JlY29yZGRhdGEgLWEgYWInICAKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLWEnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1RoZSBwcm92aWRlZCByZWNvcmROYW1lIGlzIGFjdHVhbGx5IGFuIGFsaWFzLicKICAgICAgICB9CiAgICBdCn0pJwDx9uquDe6zCghhcnRpZmFjdAIEAPH26q4N0v0LKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAPH26q4N7rMKFWxvYWRBQkNvbW1hbmRzTWFuYWdlcgIEAPH26q4N+f0L+i1ALyoqCiAqIEFCQ29tbWFuZHNNYW5hZ2VyIGlzIHBhcnQgb2YgYWJTaGVsbC4KICogWW91IGNhbiByZWdpc3RlciBjb21tYW5kcyB0byBpdCB0aGF0IGNhbiBiZSBpbnZva2VkIHVzaW5nICckPGNvbW1hbmQ+JyB3aXRoIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICogSXRzIGdlbmVyYWxseSBub3QgcmVjb21tZW5kZWQgdG8gY3JlYXRlIHRoaXMgeW91cnNlbGYgYnV0IGluc3RlYWQgdG8gbGlzdGVuIGZvciB0aGUgQG9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkIHNob3V0CiAqIGFuZCB0byByZWdpc3RlciB5b3VyIGNvbW1hbmRzIHRoZXJlLgogKiBAcHJvcCB7c3RyaW5nW119IGNvbW1hbmRzCiAqLwpjbGFzcyBBQkNvbW1hbmRzTWFuYWdlciB7CiAgICBjb21tYW5kczogUmVjb3JkPHN0cmluZywgQUJDb21tYW5kPjsKCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLmNvbW1hbmRzID0ge307CgogICAgICAgIC8vIFNob3V0IHRoYXQgYW4gaW5zdGFuY2Ugb2YgQUJDb21tYW5kc01hbmFnZXIgaGFzIGJlZW4gY3JlYXRlZCBhbmQgYWxsb3cgYW55IGxpc3RlbmVycwogICAgICAgIC8vIHRvIGFkZCB0aGVpciBvd24gY29tbWFuZHMgdG8gdGhlIGluc3RhbmNlLgogICAgICAgIHNob3V0KCdvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCcsIHRoaXMpOwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgY29tbWFuZCB0byBBQkNvbW1hbmRzTWFuYWdlci4KICAgICAqIFRoaXMgY29tbWFuZCB3aWxsIGJlIGF2YWlsYWJsZSB0byBpbnZva2UgdXNpbmcgJyQ8bmFtZT4nIG9uIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBzdWNjZXNzZnVsbHkgYWRkZWQuCiAgICAgKi8KICAgIGFkZENvbW1hbmQobmFtZTogc3RyaW5nLCBjYWxsYmFjazogQUJDb21tYW5kQ2FsbGJhY2ssIGhlbHA6IEFCQ29tbWFuZEhlbHApOiBib29sZWFuIHsKICAgICAgICBpZiAoIW5hbWUgfHwgdHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gc3RyaW5nIG5hbWUgaXMgcmVxdWlyZWQgZm9yIGNvbW1hbmRzLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgYWxyZWFkeSBleGlzdHMgYXMgYSBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWNhbGxiYWNrIHx8IHR5cGVvZiBjYWxsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBhIGNhbGxiYWNrIGZ1bmN0aW9uLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHApIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIGlzIG1pc3Npbmcgc2hvcnREZXNjcmlwdGlvbiBmcm9tIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbW1hbmRzW25hbWVdID0geyBuYW1lLCBjYWxsYmFjaywgaGVscCB9OwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGhhc0NvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29tbWFuZHNbbmFtZV0gIT0gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSBhIGNvbW1hbmQgZnJvbSBBQkNvbW1hbmRzTWFuYWdlcgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdhcyByZW1vdmVkLiBJZiB0aGUgY29tbWFuZCBkb2Vzbid0IGV4aXN0IGZhbHNlIHdpbGwgYWxzbyBiZSByZXR1cm5lZC4KICAgICAqLwogICAgcmVtb3ZlQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENhbGwgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdpdGggdGhlIHByb3ZpZGVkIGFyZ3MgKGlmIGFueSkuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgZXhlY3V0ZWQuCiAgICAgKi8KICAgIGNhbGxDb21tYW5kKG5hbWU6IHN0cmluZywgYXJncz86IGFueVtdKTogYm9vbGVhbiB7CiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgaWYgKGNvbW1hbmQpIHsKICAgICAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaGVscEFyZyBvZiBjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShoZWxwQXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaCguLi5oZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBc3NlcnQgdGhhdCB0aGUgaW5wdXQgYXJncyBhcmUgdmFsaWQgYWdhaW5zdCB0aGUgY29tbWFuZCBoZWxwIGRvY3VtZW50YXRpb24uCiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGVhc3kgd2F5IHRvIHZhbGlkYXRlIGFyZ3MgYmVmb3JlIGV4ZWN1dGluZyBhIGNvbW1hbmQuCiAgICAgICAgICAgICAgICBBQkNvbW1hbmRzTWFuYWdlci5hc3NlcnRWYWxpZEFyZ3MoYXJncywgdmFsaWRBcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21tYW5kLmNhbGxiYWNrKGFyZ3MpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgbm90IGEgdmFsaWQgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBwcm92aWRlZCBhcmcuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgYW5kIHZhbHVlIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ1ZhbHVlKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGFueSB7CiAgICAgICAgbGV0IHZhbHVlID0gbnVsbDsKCiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgbGV0IGRlbGV0ZUNvdW50ID0gMTsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlSW5kZXggPSBhcmdJbmRleCArIDE7CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlSW5kZXggPCBhcmdzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhcmdzW3ZhbHVlSW5kZXhdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSByZWxhdGVkIGFyZ3MgJiB2YWx1ZXMKICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCBkZWxldGVDb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB3ZXRoZXIgdGhlIGFyZyBmbGFnIGlzIHByb3ZpZGVkIGluIHRoZSBhcmdzLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ0ZsYWcoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFyZyBmbGFnLgogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIDEpOwoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICBzdGF0aWMgYXNzZXJ0VmFsaWRBcmdzKGFyZ3M6IGFueVtdLCB2YWxpZEFyZ3M6IGFueVtdKTogdm9pZCB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgaW52YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGFyZyBvZiBhcmdzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJnICYmIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcmcgd2Ugd2FudCB0byBldmFsdWF0ZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZEFyZ3MgfHwgIXZhbGlkQXJncy5pbmNsdWRlcyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGFyZyBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHZhbGlkQXJncywgdGh1cyB0aGUgYXJnIGlzIGludmFsaWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQXJncy5wdXNoKGFyZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgdGhpcyBhcmcgaXQgaXMgbW9zdGx5IGxpa2VseSBhIHZhbHVlIGFyZy4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpbnZhbGlkQXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgSW52YWxpZCBhcmd1bWVudHM6ICR7aW52YWxpZEFyZ3Muam9pbignLCAnKX1gOwoKICAgICAgICAgICAgICAgIG9zLnRvYXN0KGVycm9yTWVzc2FnZSwgNCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKZ2xvYmFsVGhpcy5BQkNvbW1hbmRzTWFuYWdlciA9IEFCQ29tbWFuZHNNYW5hZ2VyOycA8fbqrg3uswoEaGVscAIEAPH26q4N9KsMKPCflJcyNGRjMDQzMS1mZmJiLTQ0OGQtYWE3NS05NzFiYWEwNzE4ZGMnAPH26q4N7rMKCGNtZFNoZWV0AgQA8fbqrg2brAzNFEBjb25zdCBhcmdzID0gdGhhdDsKCmxldCBwb3J0YWw7CmxldCBuZXdUYWIgPSBmYWxzZTsKCmlmIChhcmdzKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBhcmcgPSBhcmdzW2ldOwogICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgIGlmIChhcmcgPT09ICctdCcpIHsKICAgICAgICAgICAgICAgIG5ld1RhYiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFwb3J0YWwpIHsKICAgICAgICAgICAgcG9ydGFsID0gYXJnOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFwb3J0YWwpIHsKICAgIHBvcnRhbCA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKY29uc3QgaGVscGVyQm90cyA9IHsKICAgICdjb25maWdCb3QnOiBjb25maWdCb3QsCiAgICAnZ3JpZFBvcnRhbEJvdCc6IGdyaWRQb3J0YWxCb3QsCiAgICAnc2hlZXRQb3J0YWxCb3QnOiBzaGVldFBvcnRhbEJvdCwKICAgICdzeXN0ZW1Qb3J0YWxCb3QnOiBzeXN0ZW1Qb3J0YWxCb3QsCiAgICAnbWluaUdyaWRQb3J0YWxCb3QnOiBtaW5pR3JpZFBvcnRhbEJvdCwKICAgICdtYXBQb3J0YWxCb3QnOiBtYXBQb3J0YWxCb3QsCiAgICAnbWluaU1hcFBvcnRhbEJvdCc6IG1pbmlNYXBQb3J0YWxCb3QsCiAgICAnbWVudVBvcnRhbEJvdCc6IG1lbnVQb3J0YWxCb3QsCiAgICAnbGVmdFdyaXN0UG9ydGFsQm90JzogbGVmdFdyaXN0UG9ydGFsQm90LAogICAgJ3JpZ2h0V3Jpc3RQb3J0YWxCb3QnOiByaWdodFdyaXN0UG9ydGFsQm90LAogICAgJ21lZXRQb3J0YWxCb3QnOiBtZWV0UG9ydGFsQm90LAogICAgJ3RhZ1BvcnRhbEJvdCc6IHRhZ1BvcnRhbEJvdCwKICAgICdpbXVQb3J0YWxCb3QnOiBpbXVQb3J0YWxCb3QsCn07CgovLyBGdW5jdGlvbiB0byByZXNvbHZlIGEgcG9ydGFsIHJlZmVyZW5jZSB0byBhIHNwZWNpZmljIGJvdApmdW5jdGlvbiByZXNvbHZlUG9ydGFsVG9Cb3QocGF0aCkgewogICAgaWYgKCFwYXRoIHx8IHBhdGggPT09ICcnKSByZXR1cm4gbnVsbDsKICAgIAogICAgLy8gRmlyc3QgY2hlY2sgaWYgaXQncyBkaXJlY3RseSBpbiBoZWxwZXJCb3RzCiAgICBpZiAoaGVscGVyQm90c1twYXRoXSkgewogICAgICAgIHJldHVybiBoZWxwZXJCb3RzW3BhdGhdOwogICAgfQoKICAgIC8vIFBlcmhhcHMgdGhlIHBhdGggaXMgYSBib3QgaWQuCiAgICBsZXQgYm90RnJvbUlkU2VhcmNoID0gZ2V0Qm90KCdpZCcsIHBhdGgpOwogICAgaWYgKGJvdEZyb21JZFNlYXJjaCkgewogICAgICAgIHJldHVybiBib3RGcm9tSWRTZWFyY2g7CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGZvciBib3RoIGRpcmVjdCBhbmQgbmVzdGVkIHBhdGhzIGluIGdsb2JhbFRoaXMKICAgIGxldCBwYXRoUGFydHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICBsZXQgY3VycmVudE9iaiA9IGdsb2JhbFRoaXM7CiAgICBsZXQgc3RhcnRJbmRleCA9IDA7CiAgICAKICAgIC8vIEhhbmRsZSBpZiB0aGUgcGF0aCBleHBsaWNpdGx5IHN0YXJ0cyB3aXRoICdnbG9iYWxUaGlzJwogICAgaWYgKHBhdGhQYXJ0c1swXSA9PT0gJ2dsb2JhbFRoaXMnKSB7CiAgICAgICAgc3RhcnRJbmRleCA9IDE7IC8vIFNraXAgdGhlICdnbG9iYWxUaGlzJyBwYXJ0IHNpbmNlIHdlJ3JlIGFscmVhZHkgc3RhcnRpbmcgdGhlcmUKICAgIH0KICAgIAogICAgLy8gVHJhdmVyc2UgdGhlIHBhdGgKICAgIGZvciAobGV0IGkgPSBzdGFydEluZGV4OyBpIDwgcGF0aFBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcGFydCA9IHBhdGhQYXJ0c1tpXTsKICAgICAgICBpZiAoIWN1cnJlbnRPYmpbcGFydF0pIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIFBhdGggc2VnbWVudCBkb2Vzbid0IGV4aXN0CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRPYmogPSBjdXJyZW50T2JqW3BhcnRdOwogICAgfQogICAgCiAgICAvLyBDaGVjayBpZiB0aGUgZmluYWwgb2JqZWN0IGlzIGEgYm90IChoYXMgaWQgYW5kIHRhZ3MpCiAgICBpZiAoY3VycmVudE9iaiAmJiBjdXJyZW50T2JqLmlkICYmIGN1cnJlbnRPYmoudGFncykgewogICAgICAgIHJldHVybiBjdXJyZW50T2JqOwogICAgfQogICAgCiAgICByZXR1cm4gbnVsbDsgLy8gTm90IGEgdmFsaWQgYm90Cn0KCi8vIFNlYXJjaCB0byBzZWUgaWYgcG9ydGFsIGFyZ3VtZW50IGlzIHNwZWNpZmljIHRvIGEgYm90CmxldCB1bmlxdWVCb3QgPSByZXNvbHZlUG9ydGFsVG9Cb3QocG9ydGFsKTsKCmlmICh1bmlxdWVCb3QpIHsKICAgIGlmICh1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBMb2NhbCcgfHwKICAgICAgICB1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBTaGFyZWQnCiAgICApIHsKICAgICAgICAvLyBGb3JjZSBzaGVldCB0byBvcGVuIGluIHNhbWUgdGFiIGlmIHRoZSBib3Qgb25seSBsaXZlcyBpbiB0aGlzIHRhYi4KICAgICAgICBuZXdUYWIgPSBmYWxzZTsKICAgIH0KICAgIHBvcnRhbCA9IHVuaXF1ZUJvdC5pZDsKfQoKaWYgKG5ld1RhYikgewogICAgb3Mub3BlblVSTChgLz9pbnN0PSR7b3MuZ2V0Q3VycmVudEluc3QoKX0mc2hlZXRQb3J0YWw9JHtwb3J0YWx9YCk7Cn0gZWxzZSB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IHBvcnRhbDsKfScA8fbqrg3uswoNY21kRG93bmxvYWRBQgIEAPH26q4N6cAMowtAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgYXV4VmVyc2lvbjogc3RyaW5nID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXYnKTsKCmlmICghYXV4VmVyc2lvbikgewogICAgLy8gRGVmYXVsdCB0byBhdXggdmVyc2lvbiAyIGlmIGFyZ3VtZW50IGlzIG5vdCBwcm92aWRlZC4KICAgIGF1eFZlcnNpb24gPSAnMic7Cn0KCmlmIChhdXhWZXJzaW9uICE9PSAnMScgJiYgYXV4VmVyc2lvbiAhPT0gJzInKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBPbmx5IGF1eCBmb3JtYXQgdmVyc2lvbiAxIGFuZCAyIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGRvd25sb2FkIGFiIGNvbW1hbmQuYCk7CiAgICByZXR1cm47Cn0KCi8vIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiBmYWxzZSB9KTsKCmxldCBncm91cHMgPSBbXTsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgLy8gUmVtYWluaW5nIGFyZ3MgYXJlIGdyb3VwIG5hbWVzIHByb3ZpZGVkIHdpdGggdGhlIGNvbW1hbmQuCiAgICBncm91cHMgPSBhcmdzOwp9IGVsc2UgewogICAgbGV0IGdyb3VwID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCwgeyB0aXRsZTogJ0FCIEdyb3VwIFRhZycsIGF1dG9TZWxlY3Q6IHRydWUgfSk7CiAgICBpZiAoZ3JvdXApIHsKICAgICAgICBtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAgPSBncm91cDsKICAgICAgICBncm91cHMucHVzaChncm91cCk7CiAgICB9Cn0KCmNvbnN0IG1ham9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWFqb3JWZXJzaW9uOwpjb25zdCBtaW5vclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1pbm9yVmVyc2lvbjsKY29uc3QgYWJWZXJzaW9uID0gYCR7bWFqb3JWZXJzaW9ufS4ke21pbm9yVmVyc2lvbn1gOwoKZm9yIChsZXQgZ3JvdXAgb2YgZ3JvdXBzKSB7CiAgICBjb25zdCBncm91cEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgW2dyb3VwXTogdHJ1ZSwgc3BhY2U6ICdzaGFyZWQnIH0pKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwQm90cy5sZW5ndGg7IGkrKykgewogICAgICAgIGdyb3VwQm90c1tpXS50YWdzLmFiVmVyc2lvbiA9IGFiVmVyc2lvbjsKICAgIH0KCiAgICBpZiAoZ3JvdXAgPT0gImFiQ29uZmlnIikgewogICAgICAgIGdyb3VwID0gImFiMSI7CiAgICB9CgogICAgaWYgKGF1eFZlcnNpb24gPT09ICcxJykgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMQogICAgICAgIG9zLmRvd25sb2FkQm90cyhncm91cEJvdHMsIGdyb3VwKQogICAgfSBlbHNlIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDIKICAgICAgICBvcy5kb3dubG9hZEJvdHNBc0luaXRpYWx6YXRpb25VcGRhdGUoZ3JvdXBCb3RzLCBncm91cCk7CiAgICB9Cgp9CgonAPH26q4N7rMKCWNtZEFCV2FrZQIEAPH26q4NjcwMMUBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogdHJ1ZSB9KTsnAPH26q4N7rMKCmNtZEFCU2xlZXACBADx9uquDb/MDNABQGxpbmtzLm1hbmlmZXN0YXRpb24uYWJTZXRBd2FrZSh7IGF3YWtlOiBmYWxzZSB9KTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cgp0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOycA8fbqrg3uswoHY29uc29sZQIEAPH26q4NkM4MKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAPH26q4N7rMKDmNtZFVwbG9hZEZpbGVzAgQA8fbqrg23zgyTEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScA8fbqrg3uswoOY21kRG93bmxvYWRFZ2cCBADx9uquDcveDPkLQGNvbnN0IHJlY29yZEtleSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXksIHsKICAgIHRpdGxlOiAncmVjb3JkIHRvIGxvb2t1cCBlZ2cgaW4nLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleTpgLCByZWNvcmRLZXkpOwoKaWYgKCFyZWNvcmRLZXkpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5ID0gcmVjb3JkS2V5OwoKY29uc3QgZWdnTmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lLCB7CiAgICB0aXRsZTogJ25hbWUgb2YgZWdnJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2dOYW1lOmAsIGVnZ05hbWUpOwoKaWYgKCFlZ2dOYW1lKSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUgPSBlZ2dOYW1lOwoKY29uc3QgZWdnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgIGFiSUQ6IGVnZ05hbWUsCiAgICByZWNvcmRLZXksCiAgICByZXR1cm5UeXBlOiAnZWdnJwp9KQoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2c6YCwgZWdnKTsKCmlmICghQXJyYXkuaXNBcnJheShlZ2cuZWdnVmVyc2lvbkhpc3RvcnkpIHx8IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYERhdGEgZm91bmQgYXQgYWRkcmVzcyAnJHtlZ2dOYW1lfScgaW4gcmVjb3JkICcke3JlY29yZEtleX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlZ2cuYCkKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBlZ2dWZXJzaW9uT3B0aW9ucyA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7CiAgICByZXR1cm4geyBsYWJlbDogYHZlcnNpb24gJHtpbmRleCArIDF9YCwgdmFsdWU6IGluZGV4IH0KfSkKCmNvbnN0IHNlbGVjdGVkVmVyc2lvbk9wdGlvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChlZ2dWZXJzaW9uT3B0aW9ucy5sZW5ndGggLSAxLCB7CiAgICB0aXRsZTogJ2Rvd25sb2FkIGVnZyB2ZXJzaW9uJywKICAgIHR5cGU6ICdsaXN0JywKICAgIHN1YnR5cGU6ICdzZWxlY3QnLAogICAgaXRlbXM6IGVnZ1ZlcnNpb25PcHRpb25zLAp9KQoKaWYgKCFzZWxlY3RlZFZlcnNpb25PcHRpb24pIHsKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBhdXhEYXRhVXJsID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5W3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZV07CmNvbnN0IGF1eERhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGF1eERhdGFVcmwpOwpjb25zdCBhdXhGaWxlbmFtZSA9IGAke2VnZ05hbWV9X3Yke3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZSArIDF9LmF1eGA7Cgpvcy5kb3dubG9hZChhdXhEYXRhLCBhdXhGaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsnAPH26q4N7rMKD2NtZERvd25sb2FkSW5zdAIEAPH26q4NxeoMWUBhYi5saW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgcmVvcGVuQWJNZW51OiBmYWxzZSwgc291cmNlRXZlbnQ6ICdhYl9jbWRfZG93bmxvYWRfaW5zdCcgfSk7JwDx9uquDe6zCgZzZWFyY2gCBADx9uquDZ/rDCjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwDx9uquDe6zCgV1dGlscwIEAPH26q4NxusMKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAPH26q4N7rMKCWNtZFN5c3RlbQIEAPH26q4N7esMkQdAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBzYW1lV2luZG93ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctdycpOwoKbGV0IHN5c3RlbVRhZ05hbWUgPSBudWxsOwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICBzeXN0ZW1UYWdOYW1lID0gYXJncy5qb2luKCcgJyk7Cn0KCmlmIChzYW1lV2luZG93KSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LgogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsID0gdHJ1ZTsKICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVRhZ05hbWUgPSBzeXN0ZW1UYWdOYW1lOwp9IGVsc2UgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIGEgbmV3IHRhYi4KICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKTsKCiAgICAvLyBSZW1vdmUgYW55IHBvcnRhbHMgdGhhdCBhcmUgc2V0IGluIHRoZSBVUkwuCiAgICBsZXQgcGFyYW1zID0gdXJsLnNlYXJjaFBhcmFtcy5rZXlzKCk7CiAgICBmb3IgKGxldCBwYXJhbSBvZiBwYXJhbXMpIHsKICAgICAgICBpZiAocGFyYW0uZW5kc1dpdGgoJ1BvcnRhbCcpKSB7CiAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKHBhcmFtKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gVHVybiBvbiB0aGUgc3lzdGVtIHBvcnRhbC4KICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1Qb3J0YWwnLCAndHJ1ZScpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3N5c3RlbVRhZ05hbWUnKTsKCiAgICBpZiAoc3lzdGVtVGFnTmFtZSkgewogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1UYWdOYW1lJywgc3lzdGVtVGFnTmFtZSk7CiAgICB9CgogICAgb3Mub3BlblVSTCh1cmwuaHJlZik7Cn0KJwDx9uquDe6zCg1hYkNoYXRCYXJPcGVuAgQA8fbqrg3/8gyjAkBjb25zdCB7CiAgICBwcmVmaWxsLAp9ID0gdGhhdCA/PyB7fQoKbWFza3MuY2hhdE9wZW4gPSB0cnVlOwoKb3Muc2hvd0NoYXQoewogICAgcGxhY2Vob2xkZXI6ICc+IC5oZWxwIHRvIHNlZSBhdmFpbGFibGUgY29tbWFuZHMnLAogICAgYmFja2dyb3VuZENvbG9yOiAnIzJmMmYyZicsCiAgICBmb3JlZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwbGFjZWhvbGRlckNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcHJlZmlsbAp9KScA8fbqrg3uswoOYWJDaGF0QmFyQ2xvc2UCBADx9uquDaP1DHZAbWFza3MuY2hhdE9wZW4gPSBmYWxzZTsKb3MuaGlkZUNoYXQoKTsKCi8vIEdpdmUgQ2FzdWFsT1MgYSBjaGFuZ2UgdG8gYWN0dWFsbHkgcmVtb3ZlIHRoZSBjaGF0IGJhci4KYXdhaXQgb3Muc2xlZXAoMCk7JwDx9uquDe6zCgtwZXJzb25hbGl0eQIEAPH26q4NmvYMKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAPH26q4N7rMKBXR5cGVzAgQA8fbqrg3B9gzyAvCfk4R0eXBlIEFCQ29tbWFuZENhbGxiYWNrID0gKGFyZ3M/OiBhbnlbXSkgPT4gdm9pZDsKCmludGVyZmFjZSBBQkNvbW1hbmRBcmcgewogIGlkZW50aWZpZXI6IHN0cmluZ1tdIHwgc3RyaW5nOwogIGRlc2NyaXB0aW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkNvbW1hbmRIZWxwIHsKICBzaG9ydERlc2NyaXB0aW9uOiBzdHJpbmc7CiAgbG9uZ0Rlc2NyaXB0aW9uPzogc3RyaW5nOwogIGFyZ3M/OiBBQkNvbW1hbmRBcmdbXTsKICB1c2FnZT86IHN0cmluZyB8IHN0cmluZ1tdOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kIHsKICBuYW1lOiBzdHJpbmc7CiAgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrOwogIGhlbHA6IEFCQ29tbWFuZEhlbHA7Cn0nAPH26q4N7rMKEXZpZXdSZWNvcmREYXRhQXBwAgQA8fbqrg2y+Qwo8J+UlzkyZmY2ZDI4LTMzNTEtNGNmYi04NDY0LTlkN2M2MTQyN2EyNicA8fbqrg3uswoRY21kRG93bmxvYWRTeXN0ZW0CBADx9uquDdn5DN4GQGNvbnN0IGFyZ3MgPSB0aGF0OwoKaWYgKCFhcmdzIHx8IGFyZ3MubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogJ011c3QgcHJvdmlkZSBzeXN0ZW0gbmFtZShzKSB0byBkb3dubG9hZC4nLCBsb2dUeXBlOiAnZXJyb3InIH0pCiAgICByZXR1cm47Cn0KCmNvbnN0IHN5c3RlbU5hbWVzID0gYXJnczsKCmZvciAoY29uc3Qgc3lzdGVtTmFtZSBvZiBzeXN0ZW1OYW1lcykgewogICAgY29uc3Qgc3lzdGVtTmFtZVBhcnRzID0gc3lzdGVtTmFtZS5zcGxpdCgnLicpOwoKICAgIGNvbnN0IHN5c3RlbUJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICAgICAgaWYgKGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLnN5c3RlbSkgewogICAgICAgICAgICBjb25zdCBzeXN0ZW1UYWdQYXJ0cyA9IGIudGFncy5zeXN0ZW0uc3BsaXQoJy4nKTsKICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBzeXN0ZW1OYW1lUGFydHMuZXZlcnkoKHN5c3RlbU5hbWVQYXJ0LCBpbmRleCkgPT4gc3lzdGVtVGFnUGFydHNbaW5kZXhdID09PSBzeXN0ZW1OYW1lUGFydCk7CiAgICAgICAgICAgIHJldHVybiBtYXRjaDsKICAgICAgICB9CiAgICB9KTsKCiAgICBpZiAoc3lzdGVtQm90cyAmJiBzeXN0ZW1Cb3RzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gYCR7c3lzdGVtTmFtZX0uYXV4YDsKICAgICAgICBhYi5saW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgcG9zc2libGVCb3RzOiBzeXN0ZW1Cb3RzLCBmaWxlbmFtZSwgcmVvcGVuQWJNZW51OiBmYWxzZSwgc291cmNlRXZlbnQ6ICdhYl9jbWRfZG93bmxvYWRfc3lzdGVtJyB9KTsKICAgIH0KfScA8fbqrg3uswoNY21kUHVibGlzaEFzawIEAPH26q4NuIANoQ9AY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBhc2tJRCA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy1hc2snKTsKY29uc3QgcGF0dGVybklEID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXBhdHRlcm4nKTsKbGV0IHN0dWRpb0lEID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXN0dWRpbycpOwoKaWYgKCFhc2tJRCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGAtYXNrIGlzIGEgcmVxdWlyZWQgYXJndW1lbnRgLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCmlmICghcGF0dGVybklEKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYC1wYXR0ZXJuIGlzIGEgcmVxdWlyZWQgYXJndW1lbnRgLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCmlmICghc3R1ZGlvSUQpIHsKICAgIGlmIChhdXRoQm90KSB7CiAgICAgICAgc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEVpdGhlciBwcm92aWRlIGEgc3R1ZGlvIG9yIGxvZ2luIHRvIHVzZSB5b3VyIHBlcnNvbmFsIHN0dWRpbyBmb3IgdGhlIGFzay5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICAgICAgcmV0dXJuOwogICAgfQp9CgpsZXQgcHVibGlzaFJlc3VsdDsKCnRyeSB7CiAgICBwdWJsaXNoUmVzdWx0ID0gYXdhaXQgbGlua3Muc3RvcmUuYWJQdWJsaXNoQXNrSUQoeyBhc2tJRCwgcGF0dGVybklELCBzdHVkaW9JRCB9KTsKfSBjYXRjaCAoZSkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gcHVibGlzaCBhc2sgJyR7YXNrSUR9Jy4gJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgcmV0dXJuOwp9CgppZiAocHVibGlzaFJlc3VsdC5zdWNjZXNzKSB7CiAgICAvLyBOZWVkIHRvIHVzZSBjb25maWdCb3Qgc3R1ZGlvIHRhZyBmb3IgbG9va3VwLgogICAgY29uZmlnQm90Lm1hc2tzLnN0dWRpbyA9IHN0dWRpb0lEOwogICAgYXdhaXQgb3Muc2xlZXAoMCk7CiAgICAKICAgIHRyeSB7CiAgICAgICAgY29uc3QgbG9va3VwQXNrUmVzdWx0ID0gYXdhaXQgbGlua3Muc2VhcmNoLmxvb2t1cEZyb21TdHVkaW8oeyBhc2tJRCwgZGF0YU9ubHk6IHRydWUgfSk7CgogICAgICAgIGlmIChsb29rdXBBc2tSZXN1bHQuc3VjY2VzcyAmJiBsb29rdXBBc2tSZXN1bHQuZGF0YSkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFB1Ymxpc2hlZCBhc2sgJyR7YXNrSUR9Jy4gJHtKU09OLnN0cmluZ2lmeShsb29rdXBBc2tSZXN1bHQuZGF0YSwgdW5kZWZpbmVkLCAyKX1gLCBsb2dUeXBlOiAnbG9nJ30pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIGxvb2t1cCBhc2sgJyR7YXNrSUR9JyBpbiBzdHVkaW8gJyR7c3R1ZGlvSUR9Jy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRmFpbGVkIHRvIGxvb2t1cCBhc2sgJyR7YXNrSUR9JyBpbiBzdHVkaW8gJyR7c3R1ZGlvSUR9Jy4gJHtsaW5rcy51dGlscy5nZXRFcnJvck1lc3NhZ2UoZSl9YCwgbG9nVHlwZTogJ2Vycm9yJ30pOwogICAgfQoKICAgIGNvbmZpZ0JvdC5tYXNrcy5zdHVkaW8gPSBudWxsOwp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBGYWlsZWQgdG8gcHVibGlzaCBhc2sgJyR7YXNrSUR9Jy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICByZXR1cm47Cn0KCgoA"}]}