{"version":2,"updates":[{"id":0,"timestamp":1757346161115,"update":"Af0DxLX97AkAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwDEtf3sCQAGc3lzdGVtAgQAxLX97AkBDWFiLnNoZWxsLmdyaWQnAMS1/ewJAARmb3JtAgQAxLX97AkPB25vdGhpbmcnAMS1/ewJAAxvbkFueUJvdERyYWcCBADEtf3sCRe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAMS1/ewJAAhyZW1lbWJlcgIEAMS1/ewJ0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAxLX97AkACGFiSWdub3JlAgQAxLX97An6AQR0cnVlJwDEtf3sCQAHYWJTaGVsbAIEAMS1/ewJ/wEEdHJ1ZScAxLX97AkACWFiVmVyc2lvbgIEAMS1/ewJhAIEMTAuOScAxLX97AkABWZvY3VzAgQAxLX97AmJAqsEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKQp9CmVsc2UKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LnBvc2l0aW9uLCBmb2N1c09wdGlvbnMpOwp9JwEEYm90cyQxMWM5NWM3ZC1hMTkzLTQwMGUtYjcxMC0zYmEwNDg2YTZhMWEBJwDEtf3sCbUGBnN5c3RlbQIEAMS1/ewJtgYTYWIuc2hlbGwuY29tcG9uZW50cycAxLX97Am1BgxBcHBDb250YWluZXICBADEtf3sCcoGrARAY29uc3QgeyB1c2VDYWxsYmFjaywgdXNlU3RhdGUgfSA9IG9zLmFwcEhvb2tzOwoKY29uc3QgQXBwQ29udGFpbmVyID0gKHsKICAgIGlkID0gdXVpZCgpLAogICAgb25CYWNrZ3JvdW5kQ2xpY2ssCiAgICBjaGlsZHJlbgp9KSA9PiB7CiAgICBjb25zdCBbYXBwSWQsIF0gPSB1c2VTdGF0ZShpZCk7CgogICAgY29uc3Qgb25DbGljayA9IHVzZUNhbGxiYWNrKChlKSA9PiB7CiAgICAgICAgaWYgKGUudGFyZ2V0LmlkID09PSBhcHBJZCkgewogICAgICAgICAgICBpZiAob25CYWNrZ3JvdW5kQ2xpY2spIHsKICAgICAgICAgICAgICAgIC8vIENsaWNrZWQgb24gYXBwIGJhY2tncm91bmQuCiAgICAgICAgICAgICAgICBvbkJhY2tncm91bmRDbGljaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgW2FwcElkXSk7CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2IGlkPXthcHBJZH0gY2xhc3NOYW1lPSdhYi1hcHAtYmcnIG9uQ2xpY2s9e29uQ2xpY2t9PgogICAgICAgICAgICB7Y2hpbGRyZW59CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBBcHBDb250YWluZXI7JwDEtf3sCbUGCFRleHRMaW5rAgQAxLX97An3CqMDQGNvbnN0IFRleHRMaW5rID0gKHsKICAgIG9uQ2xpY2ssCiAgICBjaGlsZHJlbiwKfSkgPT4gewogICAgcmV0dXJuICgKICAgICAgICA8c3BhbiAKICAgICAgICAgICAgY2xhc3NOYW1lPSdhYi1hcHAtdGV4dC1saW5rIGJvbGQnIAogICAgICAgICAgICBvbkNsaWNrPXtvbkNsaWNrfQogICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICAgICAgICAgICAgICAnLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yJzogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJsdWVwcmludENvbG9yCiAgICAgICAgICAgIH19CiAgICAgICAgPntjaGlsZHJlbn08L3NwYW4+CiAgICApCn0KCnJldHVybiBUZXh0TGluazsnAMS1/ewJtQYGV2luZG93AgQAxLX97AmbDrYCQGNvbnN0IFdpbmRvdyA9ICh7CiAgICBpZCwKICAgIGRpc2FibGVTaGFkb3csCiAgICBjaGlsZHJlbiwKfSkgPT4gewoKICAgIGxldCB3aW5kb3dDbGFzc05hbWUgPSAnYWItYXBwLXdpbmRvdyc7CgogICAgaWYgKGRpc2FibGVTaGFkb3cpIHsKICAgICAgICB3aW5kb3dDbGFzc05hbWUgKz0gJyBuby1zaGFkb3cnOwogICAgfQoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17aWR9IGNsYXNzTmFtZT17d2luZG93Q2xhc3NOYW1lfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gV2luZG93OycAxLX97Am1BgxUZXh0TGluay5jc3MCBADEtf3sCdIQ7QEuYWItYXBwLXRleHQtbGluayB7CiAgY29sb3I6IHZhcigtLWFiLWFwcC10ZXh0LWxpbmstY29sb3IsIHJnYig3MSAyNTUgMTM3KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rOmhvdmVyIHsKICBjdXJzb3I6IHBvaW50ZXI7CiAgY29sb3I6IHZhcigtLWFiLWFwcC10ZXh0LWxpbmstaG92ZXItY29sb3IsIHJnYigwIDE5MiAyNTUpKTsKfQoKLmFiLWFwcC10ZXh0LWxpbmsuYm9sZCB7CiAgZm9udC13ZWlnaHQ6IGJvbGQ7Cn0nAMS1/ewJtQYVQmFja2dyb3VuZE92ZXJsYXkuY3NzAgQAxLX97AnAEnEuYWItYXBwLWJnIHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGJhY2tncm91bmQtY29sb3I6IHJnYmEoMCwgMCwgMCwgMC4zMyk7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKfScAxLX97Am1BgpXaW5kb3cuY3NzAgQAxLX97AmyE6gDLmFiLWFwcC13aW5kb3cgewogICAgcG9zaXRpb246IGZpeGVkOwogICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTsKICAgIGNvbG9yOiB3aGl0ZTsKICAgIGJhY2tncm91bmQtY29sb3I6ICMyZjJmMmY7CiAgICB3aWR0aDogODB2dzsKICAgIGhlaWdodDogNzB2aDsKICAgIG1heC13aWR0aDogMTUwMHB4OwogICAgbWF4LWhlaWdodDogMTAwMHB4OwogICAgbGVmdDogNTAlOwogICAgdG9wOiA1MCU7CiAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZSgtNTAlLCAtNTAlKTsKICAgIGJveC1zaGFkb3c6IDBweCAwcHggMTJweCAwcHggYmxhY2s7CiAgICBvdmVyZmxvdzogYXV0bzsKICAgIHBhZGRpbmctbGVmdDogOHB4OwogICAgcGFkZGluZy1yaWdodDogOHB4Owp9CgouYWItYXBwLXdpbmRvdy5uby1zaGFkb3cgewogICAgYm94LXNoYWRvdzogbm9uZTsKfScAxLX97Am1BghyZW1lbWJlcgIEAMS1/ewJ2xYo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAxLX97Am1BghhYklnbm9yZQIEAMS1/ewJghcEdHJ1ZScAxLX97Am1BgdhYlNoZWxsAgQAxLX97AmHFwR0cnVlJwDEtf3sCbUGCWFiVmVyc2lvbgIEAMS1/ewJjBcEMTAuOScAxLX97Am1BgtwZXJzb25hbGl0eQIEAMS1/ewJkRco8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicBBGJvdHMkMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViAScAxLX97Am4FwdBcHAuY3NzAgQAxLX97Am5F8oWOnJvb3QgewogIC0tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICAtLW9uLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgLS1hYi1jb25zb2xlLWhlaWdodDogMzN2aDsKfQovKiBEYXJrIG1vZGUgc3VwcG9ydCAqLwpAbWVkaWEgKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKSB7CiAgOnJvb3QgewogICAgLS1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogICAgLS1vbi1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIH0KfQoKLmFiLWNvbnNvbGUtYnRuIHsKICBjdXJzb3I6IHBvaW50ZXI7CiAgY29sb3I6IGluaGVyaXQ7CiAgbGV0dGVyLXNwYWNpbmc6IGluaGVyaXQ7CiAgbGluZS1oZWlnaHQ6IGluaGVyaXQ7CiAgdGV4dC10cmFuc2Zvcm06IGluaGVyaXQ7CiAgdGV4dC1pbmRlbnQ6IGluaGVyaXQ7CiAgdGV4dC1zaGFkb3c6IGluaGVyaXQ7CiAgYmFja2dyb3VuZC1jb2xvcjogaW5oZXJpdDsKICBtYXJnaW46IGluaGVyaXQ7CiAgcGFkZGluZy1ibG9jazogaW5oZXJpdDsKICBwYWRkaW5nLWlubGluZTogaW5oZXJpdDsKICBib3JkZXI6IG5vbmU7CiAgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOwp9CgouYWItY29uc29sZSB7CiAgd2lkdGg6IDEwMHZ3OwogIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgcGFkZGluZzogMDsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgYmFja2Ryb3AtZmlsdGVyOiBibHVyKDEwcHgpIGJyaWdodG5lc3MoMjAwJSk7CiAgYW5pbWF0aW9uLW5hbWU6IHNsaWRlLWFwcC1pbjsKICBhbmltYXRpb24tZHVyYXRpb246IDAuNXM7CiAgb3ZlcmZsb3cteTogaGlkZGVuOwogIHotaW5kZXg6IDE7Cn0KCi5hYi1jb25zb2xlOjphZnRlciB7CiAgY29udGVudDogIiI7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgcG9zaXRpb246IGFic29sdXRlOwogIHRvcDogMDsKICBsZWZ0OiAwOwogIHJpZ2h0OiAwOwogIGJvdHRvbTogMDsKICBvcGFjaXR5OiAwLjk7CiAgei1pbmRleDogMDsKfQoKQGtleWZyYW1lcyBzbGlkZS1hcHAtaW4gewogIGZyb20gewogICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogY3ViaWMtYmV6aWVyKC42LDAsLjc5LDEuMDMpOwogICAgLyogdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDExMCUpOyAqLwogICAgLyogaGVpZ2h0OiAwcHg7ICovCiAgICAvKiBtaW4taGVpZ2h0OiAwcHg7ICovCiAgICBtYXgtaGVpZ2h0OiAwcHg7CiAgfQoKICB0byB7CiAgICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgICAvKiBtaW4taGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7ICovCiAgfQp9CgouYWItY29uc29sZSA+IGRpdiB7CiAgei1pbmRleDogMTsKICBwb3NpdGlvbjogcmVsYXRpdmUKfQoKLmFiLWNvbnNvbGUtdG9wLWJhciB7CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgd2lkdGg6IDEwMCU7CiAgdGV4dC1hbGlnbjogY2VudGVyOwogIHVzZXItc2VsZWN0OiBub25lOwogIGRpc3BsYXk6IGZsZXg7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBqdXN0aWZ5LWNvbnRlbnQ6IGVuZDsKICBwYWRkaW5nOiAwLjVyZW07Cn0KCi5hYi1jb25zb2xlLWxvZyB7CiAgb3ZlcmZsb3cteTogYXV0bzsKICBmbGV4LWdyb3c6IDE7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uLXJldmVyc2U7CiAgbWluLWhlaWdodDogMjRweDsKICBwYWRkaW5nOiAwIDFyZW07CiAgY3Vyc29yOiBwb2ludGVyOwogIG92ZXJzY3JvbGwtYmVoYXZpb3I6IGNvbnRhaW47Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIGN1cnNvcjogaW5pdGlhbDsKfQoKLmFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIgewogIG1hcmdpbjogMC41cmVtIDA7Cn0KLmFiLWNvbnNvbGUtbWVzc2FnZSB7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogcm93OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgZ2FwOiA4cHg7Cn0KCi5hYi1jb25zb2xlLXNwYWNlciB7CiAgZmxleC1zaHJpbms6IDA7CiAgZmxleC1ncm93OiAxOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBtYXgtd2lkdGg6IDgwdnc7CiAgYm9yZGVyLXJhZGl1czogMC4yNXJlbTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBjb2xvcjogdmFyKC0tb24tYWItY29uc29sZS1iZyk7CiAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScAxLX97Am4FwZnZXRBcHACBADEtf3sCYQu3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwDEtf3sCbgXC2hpZGVDb25zb2xlAgQAxLX97AniUZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwDEtf3sCbgXA2xvZwIEAMS1/ewJglOFCUBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGF3YWl0IGNyZWF0ZShib3RUYWdzKTsKCnNob3V0KCJvbkFCTG9nIiwgbG9nQm90KTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwDEtf3sCbgXC3Nob3dDb25zb2xlAgQAxLX97AmIXO0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAxLX97Am4FwZzeXN0ZW0CBADEtf3sCfZfEGFiLnNoZWxsLmNvbnNvbGUnAMS1/ewJuBcNdG9nZ2xlQ29uc29sZQIEAMS1/ewJh2CWAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScAxLX97Am4FwRmb3JtAgQAxLX97AmeYQdub3RoaW5nJwDEtf3sCbgXB2FiU2hlbGwCBADEtf3sCaZhBHRydWUnAMS1/ewJuBcKYWJJRE9yaWdpbgIEAMS1/ewJq2EVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwDEtf3sCbgXBlRvcEJhcgIEAMS1/ewJwWHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAxLX97Am4Fw1zaG93Q2hhdElucHV0AgQAxLX97Am1ZgVmYWxzZScAxLX97Am4FwpzaG93VG9wQmFyAgQAxLX97Am7ZgVmYWxzZScAxLX97Am4FwlhYlZlcnNpb24CBADEtf3sCcFmBDEwLjknAMS1/ewJuBcSc2V0QWJFeHBhbmRDb25zb2xlAgQAxLX97AnGZpcCQGNvbnNvbGUubG9nKHRoaXNCb3QudmFycy5zZXRTaG93QWxsKQppZiAodHlwZW9mIHRoaXNCb3QudmFycy5zZXRTaG93QWxsICE9PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHMgPT4gIXMpOwp9IGVsc2UgaWYgKHRoYXQgPT0gdHJ1ZSkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwodHJ1ZSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChmYWxzZSk7Cn0KJwDEtf3sCbgXCGFiSWdub3JlAgQAxLX97AneaAR0cnVlJwDEtf3sCbgXB01lc3NhZ2UCBADEtf3sCeNowRBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPnttZXNzYWdlfTwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIE1lc3NhZ2U7JwDEtf3sCbgXEG9uQW55Qm90c1JlbW92ZWQCBADEtf3sCaV5rQJAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90SWQgb2YgYm90SURzKSB7DQogICAgaWYgKHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5kZWxldGUoYm90SWQpOw0KDQogICAgICAgIGlmIChkZWxldGVkKSB7DQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3RJZDogYm90SWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9JwDEtf3sCbgXDm9uQW55Qm90c0FkZGVkAgQAxLX97AnTe/gDQGNvbnN0IHsgYm90cyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBuZXdCb3Qgb2YgYm90cykgew0KICAgIGlmIChuZXdCb3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMobmV3Qm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKG5ld0JvdC5pZCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IG5ld0JvdCB9KTsNCiAgICB9DQp9JwDEtf3sCbgXEG9uQW55Qm90c0NoYW5nZWQCBADEtf3sCcx/4wVAY29uc3QgYm90cyA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90IG9mIGJvdHMpIHsNCiAgICBpZiAoYm90LmJvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhib3QuYm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKGJvdC5ib3QuaWQpOw0KDQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBib3QuYm90IH0pOw0KICAgICAgICB9IA0KDQogICAgICAgIGlmIChib3QudGFncy5pbmNsdWRlcygibWVzc2FnZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJuYW1lIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoInRpbWVzdGFtcCIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIpKSB7DQogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOyAgICAgICAgDQogICAgICAgIH0NCiAgICB9DQp9JwDEtf3sCbgXH29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQCBADEtf3sCbCFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAMS1/ewJuBcdb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQCBADEtf3sCeeFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAQRib3RzJDI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYwEnAMS1/ewJnoYBBnN5c3RlbQIEAMS1/ewJn4YBDWFiLnNoZWxsLmhlbHAnAMS1/ewJnoYBCW9uS2V5RG93bgIEAMS1/ewJrYYBiAJAaWYgKHRhZ3MuYWN0aXZlICYmIHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJykpIHsKICAgIGlmICh0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgIGZvciAobGV0IGNhbGxiYWNrIG9mIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0nAMS1/ewJnoYBB3VubW91bnQCBADEtf3sCbaIAY4BQGF3YWl0IG9zLmNvbXBpbGVBcHAodGFncy5hcHBJZCwgPD48Lz4pOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKHRhZ3MuYXBwSWQpOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSB1bmRlZmluZWQ7Cm1hc2tzLmFjdGl2ZSA9IGZhbHNlOycAxLX97AmehgEJc3R5bGUuY3NzAgQAxLX97AnFiQHxBy5oZWxwLXRhYmxlIHsKICB3aWR0aDogMTAwJTsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLmhlbHAtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5oZWxwLXRhYmxlIHRkIGgzIHsKICBtYXJnaW46IDA7Cn0KCi5oZWxwLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9Cgouc2VjdGlvbiB7CiAgbWFyZ2luLXRvcDogMTZweDsKfQoKLnNlY3Rpb24gcDpmaXJzdC1vZi10eXBlIHsKICBtYXJnaW4tdG9wOiA0cHg7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5kZXNjcmlwdGlvbiB7IAogIHdoaXRlLXNwYWNlOiBwcmUtbGluZTsKfQoKLnVzYWdlLXRhYmxlIHsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLnVzYWdlLXRhYmxlIHRkLGgzIHsgCiAgdmVydGljYWwtYWxpZ246IHRvcDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgbWFyZ2luOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogNjBweDsKfQoKLmFyZ3MtdGFibGUgewogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouYXJncy10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmFyZ3MtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCksIChtYXgtaGVpZ2h0OiA2MDBweCkgewogIC5oZWxwLXdpbmRvdyB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGxlZnQ6IHVuc2V0OwogICAgdG9wOiB1bnNldDsKICAgIHRyYW5zZm9ybTogdW5zZXQ7CiAgICBtYXgtd2lkdGg6IHVuc2V0OwogICAgbWF4LWhlaWdodDogdW5zZXQ7CiAgICBib3gtc2hhZG93OiB1bnNldDsKICB9Cn0nAMS1/ewJnoYBCW9uRGVzdHJveQIEAMS1/ewJt5EBE0B0aGlzQm90LnVubW91bnQoKTsnAMS1/ewJnoYBBW1vdW50AgQAxLX97AnLkQHxAkBjb25zdCB7CiAgICBhYkNvbW1hbmRzTWFuYWdlciwKICAgIHNlbGVjdGVkQ29tbWFuZAp9ID0gdGhhdCA/PyB7fTsKCmlmIChtYXNrcy5hY3RpdmUpIHsKICAgIGF3YWl0IHRoaXNCb3QudW5tb3VudCgpOwp9Cgpjb25zdCBBcHAgPSB0aGlzQm90LkFwcCgpOwoKYXdhaXQgb3MucmVnaXN0ZXJBcHAodGFncy5hcHBJZCwgdGhpc0JvdCk7CmF3YWl0IG9zLmNvbXBpbGVBcHAodGFncy5hcHBJZCwgPEFwcCBjb21tYW5kcz17YWJDb21tYW5kc01hbmFnZXIuY29tbWFuZHN9IGluaXRpYWxTZWxlY3RlZENvbW1hbmQ9e3NlbGVjdGVkQ29tbWFuZH0vPik7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IFtdOwptYXNrcy5hY3RpdmUgPSB0cnVlOycAxLX97AmehgEKY29tcG9uZW50cwIEAMS1/ewJvZQBKPCflJcxMWM5NWM3ZC1hMTkzLTQwMGUtYjcxMC0zYmEwNDg2YTZhMWEnAMS1/ewJnoYBBXV0aWxzAgQAxLX97AnklAEo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAxLX97AmehgEIYWJJZ25vcmUCBADEtf3sCYuVAQR0cnVlJwDEtf3sCZ6GAQdhYlNoZWxsAgQAxLX97AmQlQEEdHJ1ZScAxLX97AmehgEJYWJWZXJzaW9uAgQAxLX97AmVlQEEMTAuOScAxLX97AmehgEDQXBwAgQAxLX97AmalQGyL0Bjb25zdCBBcHBDb250YWluZXIgPSBsaW5rcy5jb21wb25lbnRzLkFwcENvbnRhaW5lcigpOwpjb25zdCBXaW5kb3cgPSBsaW5rcy5jb21wb25lbnRzLldpbmRvdygpOwpjb25zdCBUZXh0TGluayA9IGxpbmtzLmNvbXBvbmVudHMuVGV4dExpbmsoKTsKY29uc3QgY3NzID0gbGlua3MudXRpbHMuYWJDb21waWxlQ1NTKFsgdGhpc0JvdCwgbGlua3MuY29tcG9uZW50cyBdKTsKCmNvbnN0IHsgdXNlU3RhdGUsIHVzZUVmZmVjdCwgdXNlQ2FsbGJhY2ssIHVzZVJlZiwgdXNlTWVtbyB9ID0gb3MuYXBwSG9va3M7CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKi8KY29uc3QgQXZhaWxhYmxlQ29tbWFuZHMgPSAoeyBjb21tYW5kcywgb25Db21tYW5kQ2xpY2sgfSkgPT4gewogICAgY29uc3QgY29tbWFuZE5hbWVzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpLnNvcnQoKTsKCiAgICBjb25zdCBvbkNsb3NlID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkNsb3NlfT57J3ggQ2xvc2UnfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+QXZhaWxhYmxlIENvbW1hbmRzPC9oMj4KICAgICAgICAgICAgPHA+VXNhZ2U6IC5jb21tYW5kIFtvcHRpb25zXTwvcD4KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgICAgICB7Y29tbWFuZE5hbWVzLm1hcCgobmFtZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSBjb21tYW5kc1tuYW1lXTsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxUZXh0TGluayBvbkNsaWNrPXsoKSA9PiBvbkNvbW1hbmRDbGljayhjb21tYW5kLm5hbWUpfT57Y29tbWFuZC5uYW1lfTwvVGV4dExpbms+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57ZGVzY3JpcHRpb259PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICA8Lz4KICAgICkKfQoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge0NvbW1hbmR9IHByb3BzLmNvbW1hbmQKICovCmNvbnN0IFNwZWNpZmljQ29tbWFuZCA9ICh7IGNvbW1hbmQsIG9uQmFjayB9KSA9PiB7CiAgICBsZXQgdXNhZ2UgPSAnJzsKICAgIGxldCBkZXNjcmlwdGlvbiA9IG51bGw7CiAgICBsZXQgYXJncyA9IG51bGw7CgogICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgIGlmIChjb21tYW5kLmhlbHAudXNhZ2UpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29tbWFuZC5oZWxwLnVzYWdlKSkgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2Uuam9pbignXG4nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVzYWdlID0gY29tbWFuZC5oZWxwLnVzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5sb25nRGVzY3JpcHRpb247CiAgICAgICAgfSBlbHNlIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzICYmIGNvbW1hbmQuaGVscC5hcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgYXJncyA9IGNvbW1hbmQuaGVscC5hcmdzOwogICAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuICgKICAgICAgICA8PiAgCiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkJhY2t9PnsnPCBCYWNrJ308L1RleHRMaW5rPjwvcD4KICAgICAgICAgICAgPGgyPntjb21tYW5kLm5hbWV9PC9oMj4KICAgICAgICAgICAgeyB1c2FnZSAmJgogICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0ndXNhZ2UtdGFibGUnPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxoMz5Vc2FnZTo8L2gzPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57dXNhZ2V9PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGRlc2NyaXB0aW9uICYmIAogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5EZXNjcmlwdGlvbjo8L2gzPgogICAgICAgICAgICAgICAgICAgIDxwIGNsYXNzTmFtZT0nZGVzY3JpcHRpb24nPntkZXNjcmlwdGlvbn08L3A+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGFyZ3MgJiYKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uJz4KICAgICAgICAgICAgICAgICAgICA8aDM+QXJndW1lbnRzOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0nYXJncy10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgICAgIHsgYXJncy5tYXAoKGFyZykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcmcuaWRlbnRpZmllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ0Rlc2NyaXB0aW9uRGlzcGxheSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllci5qb2luKCcsXG4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLmRlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gYXJnLmRlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2FyZ0lkZW50aWZpZXJEaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnRGVzY3JpcHRpb25EaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgfSl9CiAgICAgICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIDxici8+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2hlbHAtdGFibGUnPgogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKiBAcGFyYW0ge2FueVtdfSBbcHJvcHMuYXJnc10KICovCmNvbnN0IEFwcCA9ICh7IGNvbW1hbmRzLCBpbml0aWFsU2VsZWN0ZWRDb21tYW5kIH0pID0+IHsKICAgIGNvbnN0IFsgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmQgXSA9IHVzZVN0YXRlKGluaXRpYWxTZWxlY3RlZENvbW1hbmQpOwoKICAgIC8vIEVzY2FwZSBrZXkgcHJlc3MgZXZlbnQgaGFuZGxlcgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBjb25zdCBvbkVzY2FwZUtleVByZXNzID0gKCkgPT4gewogICAgICAgICAgICBpZiAoc2VsZWN0ZWRDb21tYW5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5wdXNoKG9uRXNjYXBlS2V5UHJlc3MpOwoKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBjb25zdCBjYWxsYmFja0luZGV4ID0gdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MuZmluZEluZGV4KChjYWxsYmFjaykgPT4gY2FsbGJhY2sgPT09IG9uRXNjYXBlS2V5UHJlc3MpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5zcGxpY2UoY2FsbGJhY2tJbmRleCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBbc2VsZWN0ZWRDb21tYW5kXSk7CiAgICAKICAgIGNvbnN0IG9uQmFja2dyb3VuZENsaWNrID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwoKICAgIGNvbnN0IG9uQ29tbWFuZENsaWNrID0gdXNlQ2FsbGJhY2soKG5hbWUpID0+IHsKICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobmFtZSk7CiAgICB9LCBbc2V0U2VsZWN0ZWRDb21tYW5kXSkKCiAgICBjb25zdCBjb250ZW50ID0gdXNlTWVtbygoKSA9PiB7CiAgICAgICAgaWYgKCFzZWxlY3RlZENvbW1hbmQpIHsKICAgICAgICAgICAgcmV0dXJuIDxBdmFpbGFibGVDb21tYW5kcyBjb21tYW5kcz17Y29tbWFuZHN9IG9uQ29tbWFuZENsaWNrPXtvbkNvbW1hbmRDbGlja30vPgogICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICByZXR1cm4gPFNwZWNpZmljQ29tbWFuZCBjb21tYW5kPXtjb21tYW5kc1tzZWxlY3RlZENvbW1hbmRdfSBvbkJhY2s9eygpID0+IHNldFNlbGVjdGVkQ29tbWFuZChudWxsKX0vPgogICAgICAgIH0KICAgIH0sIFtjb21tYW5kcywgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmRdKTsKCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxzdHlsZT57Y3NzfTwvc3R5bGU+CgogICAgICAgICAgICA8QXBwQ29udGFpbmVyIG9uQmFja2dyb3VuZENsaWNrPXtvbkJhY2tncm91bmRDbGlja30+CiAgICAgICAgICAgICAgICA8V2luZG93PgogICAgICAgICAgICAgICAgICAgIHtjb250ZW50fQogICAgICAgICAgICAgICAgPC9XaW5kb3c+CiAgICAgICAgICAgIDwvQXBwQ29udGFpbmVyPgogICAgICAgIDwvPgogICAgKQp9CgpyZXR1cm4gQXBwOycAxLX97AmehgEFYXBwSWQCBADEtf3sCc3EAQ9hYi1jb21tYW5kLWhlbHAnAQRib3RzJDM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MwEnAMS1/ewJ3cQBBnN5c3RlbQIEAMS1/ewJ3sQBD2FiLnNoZWxsLmNyZWF0ZScAxLX97AndxAEEZm9ybQIEAMS1/ewJ7sQBB25vdGhpbmcnAMS1/ewJ3cQBC2Rlc2NyaXB0aW9uAgQAxLX97An2xAE9Qm90IHVzZWQgdG8gY3JlYXRlL21hbmlmZXN0IGJvdHMgaW50byBhbiBhY3R1YWwgc2NlbmUvcG9ydGFsLicAxLX97AndxAEMYWJDcmVhdGVCb3RzAgQAxLX97Am0xQHEKEBsZXQgeyAKICAgIGluaXRpYWxCb290LCAvLyBjaGVja3MgZm9yIGluaXRpYWwgYm9vdCBib29sZWFuIChvcHRpb25hbCkKICAgIGJvdERhdGEsIC8vIGJvdHMgdG8gYmUgZ2VuZXJhdGVkCiAgICBvcmlnaW4sIC8vIHdoZXJlIGRpZCB0aGUgZGF0YSBjb21lIGZyb20gKG9wdGlvbmFsKQogICAgc3R1ZGlvLCAvLyB3aGF0IHN0dWRpbyBpcyB0aGlzIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICByZWNvcmQsIC8vIFJ5YW4gQ29vazogZG8gd2UgbmVlZCB0aGlzIGlmIHdlIGFscmVhZHkgaGF2ZSBzdHVkaW8/IChvcHRpb25hbCkKICAgIHZlcnNpb24sIC8vIHZlcnNpb24gb2YgdGhlIGRhdGEgKG9wdGlvbmFsKQogICAgZWdnUGFyYW1ldGVycywgLy8gZGF0YSB0byBwYXNzIHRvIGFsbCBjcmVhdGVkIGJvdHMgdmlhIEBvbkVnZ0hhdGNoLiAob3B0aW9uYWwpCiAgICBpZ25vcmVHcmlkRm9jdXMsIC8vIFJ5YW4gQ29vazogYWRkaW5nIHRoaXMgYXMgYW4gb3B0aW9uYWwgZmxhZy4gKG9wdGlvbmFsKQogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSB0aGUgYm90cyBhcmUgY3JlYXRlZC4gKG9wdGlvbmFsKQogICAgc291cmNlRXZlbnQsIC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbCB0byBhYkNyZWF0ZUJvdHMuIChvcHRpb25hbCkuCn0gPSB0aGF0OwoKLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZm9yIHdoZW4gYWJDcmVhdGVCb3RzIGV4cGVjdGVkICJib3RzIiBwYXJhbWV0ZXIuCmlmICghYm90RGF0YSAmJiB0aGF0LmJvdHMpIHsKICAgIGJvdERhdGEgPSB0aGF0LmJvdHM7Cn0KCmxldCBib3RDb3VudCA9IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aDsKY29uc3QgYWJHcmlkRm9jdXMgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKLy8gUnVuIHNvbWUgYWItc3BlY2lmaWMgcHJlcHJvY2Vzc2luZyBvZiBib3QgZGF0YS4KZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgZGF0YS50YWdzLmFiSURPcmlnaW4gPSBvcmlnaW47CiAgICAgICAgZGF0YS50YWdzLmFiSURTdHVkaW8gPSBzdHVkaW87CgogICAgICAgIGlmIChkYXRhLnRhZ3MuY3JlYXRvcikgewogICAgICAgICAgICBkYXRhLnRhZ3Mub2xkQ3JlYXRvciA9IGRhdGEudGFncy5jcmVhdG9yOwogICAgICAgIH0KCiAgICAgICAgLy8gUnlhbiBDb29rOiBUaGlzIHRhcmdldFBvc2l0aW9uIHN0dWZmIGlzIGFwcGFyZW50bHkgdXNlZCBmb3IgYm90IHBhc3Rpbmc/IAogICAgICAgIC8vIFRoaXMgaXMgc29tZSByZWFsbHkgY29uZnVzaW5nIGxvZ2ljIGFuZCBzaG91bGQgYmUgcmVmYWN0b3JlZCBldmVudHVhbGx5LgogICAgICAgIGlmICgoYm90Q291bnQgPCAyIHx8IGJvdENvdW50IDwgMyAmJiBib3REYXRhLmFiWFBCb3QgIT0gbnVsbCkgJiYgYWJHcmlkRm9jdXMgJiYgIWlnbm9yZUdyaWRGb2N1cykgewogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWCddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueDsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbiArICdZJ10gPSBhYkdyaWRGb2N1cy5wb3NpdGlvbi55OwogICAgICAgIH0KICAgIH0KfQoKLy8gRG8gYW5vdGhlciBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSB0aGUgYm90cyBhcmVhIGNyZWF0ZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhLCBvcmlnaW4sIHN0dWRpbywgcmVjb3JkLCB2ZXJzaW9uLCBlZ2dQYXJhbWV0ZXJzLCBpbml0aWFsQm9vdCwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZShwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlJywgcHJlcHJvY2Vzc0FyZykpOwoKaWYgKHR5cGVvZiBib3REYXRhICE9PSAnb2JqZWN0JyB8fCBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGggPT09IDApIHsKICAgIC8vIFRoZXJlIGlzbid0IGFueSBib3REYXRhIHRvIGNyZWF0ZSBmcm9tIQogICAgcmV0dXJuOwp9CgovLyBDcmVhdGUgYm90cyBmcm9tIHRoZSBib3QgZGF0YS4KbGV0IGlkTWFwID0gbmV3IE1hcCgpOwpsZXQgbmV3Qm90cyA9IFtdOwpsZXQgbmV3Qm90SWRzID0gW107Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MpIHsKICAgICAgICB0cnkgeyAKICAgICAgICAgICAgY29uc3QgbmV3Qm90ID0gY3JlYXRlKGRhdGEudGFncyk7CgogICAgICAgICAgICBpZE1hcC5zZXQoZGF0YS5pZCwgbmV3Qm90LmlkKTsKICAgICAgICAgICAgbmV3Qm90cy5wdXNoKG5ld0JvdCk7CiAgICAgICAgICAgIG5ld0JvdElkcy5wdXNoKG5ld0JvdC5pZCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGludmFsaWQgYm90YCwgZSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraXBwZWQgYm90OiBgLCBkYXRhKTsKICAgIH0KfQoKLy8gQXJyYXkgb2YgdGFnIHJlbGF0aW9uc2hpcHMgdG8gYmUgcHJlc2VydmVkCmNvbnN0IGxpbmtUYWdzID0gWyJsaW5rIiwgImNyZWF0b3IiLCAiY29uZmlnQm90IiwgImxpbmVUbyIsICJ0cmFuc2Zvcm1lciIsICJmb3JtTGlnaHRUYXJnZXQiXTsKCi8vIFRoaXMgbG9vcCBjb250YWlucyB0aGUgbG9naWMgZm9yIHByZXNlcnZpbmcgdGhlIGxpbmtUYWdzCmZvciAobGV0IG5ld0JvdCBvZiBuZXdCb3RzKSB7CiAgICBmb3IgKGxldCB0YWcgb2YgbGlua1RhZ3MpIHsKICAgICAgICBsZXQgdmFsdWUgPSBuZXdCb3QudGFnc1t0YWddOwoKICAgICAgICBpZiAodGFnID09ICJjcmVhdG9yIikgewogICAgICAgICAgICB2YWx1ZSA9IG5ld0JvdC50YWdzLm9sZENyZWF0b3I7CiAgICAgICAgICAgIG5ld0JvdC50YWdzLm9sZENyZWF0b3IgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlQm90TGlua3MobmV3Qm90LCBpZE1hcCk7CgogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGxldCBuZXdWYWx1ZSA9IHZhbHVlLm1hcChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkTWFwLmdldChpZCkgfHwgaWQ7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgbmV3SUQgPSBpZE1hcC5nZXQodmFsdWUpOwoKICAgICAgICAgICAgICAgIGlmIChuZXdJRCkgewogICAgICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld0lEOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBUb2FzdHMgZm9yIGhhdGNoZXMsIGJ1dCBvbmx5IG9uIGJ1aWxkZXIKaWYgKG9yaWdpbiAmJiB2ZXJzaW9uICYmIGNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSA9PSBudWxsICYmICFjb25maWdCb3QudGFncy5waCAmJiBidWlsZGVyVmVyc2lvbiA9PSAiYnVpbGRlciIpIHsKICAgIG9zLnRvYXN0KCJoYXRjaGVkICIgKyBvcmlnaW4gKyAiIHYiICsgdmVyc2lvbik7Cn0KCmlmIChvcmlnaW4pIHsKICAgIC8vIENyZWF0ZSBhYkVnZyBib3QgdGhhdCB0cmFja3MgY2FuIGJlIHVzZWQgdG8gdHJhY2sgd2hhdCBlZ2dzIGhhdmUgYmVlbiBoYXRjaGVkLgogICAgY3JlYXRlKHsKICAgICAgICBzcGFjZTogInNoYXJlZCIsCiAgICAgICAgYWI6IHRydWUsCiAgICAgICAgYWJFZ2c6IHRydWUsCiAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgb3JpZ2luX2FiOiBvcmlnaW4sCiAgICAgICAgb3JpZ2luX3ZlcnNpb246IHZlcnNpb24sCiAgICAgICAgb3JpZ2luX3JlY29yZDogcmVjb3JkLAogICAgICAgIG9yaWdpbl9zdHVkaW86IHN0dWRpbywKICAgICAgICBmb3JtOiAiZWdnIiwKICAgICAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICAgICAgbGFiZWw6IG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uLAogICAgfSk7Cn0KCmNvbmZpZ0JvdC50YWdzLmxhc3RFZ2dIYXRjaGVkID0gb3JpZ2luOwoKd2hpc3BlcihuZXdCb3RzLCAnb25QcmVIYXRjaCcsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKCmlmIChpbml0aWFsQm9vdCkgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBvcmlnaW47Cn0KCi8vIG9uRWdnSGF0Y2ggZm9yIGFsbCBqdXN0IGhhdGNoZWQgYm90cwp3aGlzcGVyKG5ld0JvdHMsICJvbkVnZ0hhdGNoIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIGVnZ1BhcmFtZXRlcnMsIHNvdXJjZUV2ZW50IH0pOwoKLy8gb25BYkFkZGVkIGZvciBhbGwgYm90cyBpbiB0aGUgZXhwZXJpZW5jZQpzdXBlclNob3V0KCJvbkFCQWRkZWQiLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQgfSk7CnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgpyZXR1cm4gbmV3Qm90czsnAMS1/ewJ3cQBCHJlbWVtYmVyAgQAxLX97An57QEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAxLX97AndxAEIYWJJZ25vcmUCBADEtf3sCaDuAQR0cnVlJwDEtf3sCd3EAQdhYlNoZWxsAgQAxLX97Aml7gEEdHJ1ZScAxLX97AndxAEJYWJWZXJzaW9uAgQAxLX97Amq7gEEMTAuOScAxLX97AndxAELcGVyc29uYWxpdHkCBADEtf3sCa/uASjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwEEYm90cyQ1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYBJwDEtf3sCdbuAQZzeXN0ZW0CBADEtf3sCdfuARBhYi5zaGVsbC52ZXJzaW9uJwDEtf3sCdbuAQRmb3JtAgQAxLX97Ano7gEHbm90aGluZycAxLX97AnW7gEIYWJJZ25vcmUCBADEtf3sCfDuAQR0cnVlJwDEtf3sCdbuAQdhYlNoZWxsAgQAxLX97An17gEEdHJ1ZScAxLX97AnW7gETYWJTaGVsbE1ham9yVmVyc2lvbgIEAMS1/ewJ+u4BATInAMS1/ewJ1u4BDW9uU2tpbGxVcGRhdGUCBADEtf3sCfzuAZcBQGNvbnN0IHZlcnNpb25TdHJpbmcgPSB0YWdzLmFiU2hlbGxNYWpvclZlcnNpb24gKyAiLiIgKyB0YWdzLmFiU2hlbGxNaW5vclZlcnNpb247DQoNCmNvbnNvbGUubG9nKCJbQUJTaGVsbF0gTG9hZGVkIEFCIHNoZWxsIHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycAxLX97AnW7gEJYWJWZXJzaW9uAgQAxLX97AmU8AEEMTAuOScAxLX97AnW7gETYWJTaGVsbE1pbm9yVmVyc2lvbgIEAMS1/ewJmfABAjE3JwEEYm90cyQ3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YBJwDEtf3sCZzwAQZzeXN0ZW0CBADEtf3sCZ3wAQ5hYi5zaGVsbC5zdG9yZScAxLX97Amc8AEEZm9ybQIEAMS1/ewJrPABB25vdGhpbmcnAMS1/ewJnPABC2Rlc2NyaXB0aW9uAgQAxLX97Am08AE/VGhpcyBza2lsbCBpcyBtZWFudCB0byBiZSBhIGNvbmZpZ3VyYWJsZSBtZWFucyB0byBwdWJsaXNoIGRhdGEuJwDEtf3sCZzwAQ9hYlB1Ymxpc2hSZWNvcmQCBADEtf3sCfTwAcAGQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmc7CmxldCByZWNvcmREYXRhID0gdGhhdC5kYXRhOwpsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKbGV0IGVuZHBvaW50ID0gdGhhdC5lbmRwb2ludCA/IHRoYXQuZW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghcmVjb3JkRGF0YSkKewogICAgcmV0dXJuICJubyBkYXRhIHN1cHBsaWVkIjsKfQoKaWYgKHB1YmxpY0ZhY2luZykKewogICAgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEodXNlclJlY29yZCwgcmVjb3JkTmFtZSwgcmVjb3JkRGF0YSwge2VuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogWyJwdWJsaWNSZWFkIl19KTsKfQplbHNlCnsgICAgCiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbcmVjb3JkTmFtZV19KTsKfQoKaWYgKHJlY29yZERhdGEuc3VjY2VzcykKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIHJlY29yZGVkIHRvICIgKyB1c2VyUmVjb3JkKTsKfQplbHNlCnsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZGF0YSBmYWlsZWQgdG8gcmVjb3JkIik7Cn0KCnJldHVybiByZWNvcmREYXRhOycAxLX97Amc8AENYWJQdWJsaXNoRmlsZQIEAMS1/ewJtfcBrAdAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBmaWxlID0gdGhhdC5maWxlOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGVOYW1lOwpsZXQgbWltZVR5cGUgPSB0aGF0Lm1pbWVUeXBlOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIWZpbGUpCnsKICAgIHJldHVybiAibm8gZmlsZSBzdXBwbGllZCI7Cn0KCmxldCBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKICAgIAppZiAoIWZpbGVVcGxvYWQuc3VjY2VzcykgCnsKICAgIGlmIChmaWxlVXBsb2FkLmVycm9yQ29kZSA9PSAiZmlsZV9hbHJlYWR5X2V4aXN0cyIpCiAgICB7CiAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGFscmVhZHkgZXhpc3RzIGluICIgKyB1c2VyUmVjb3JkKTsKCiAgICAgICAgcmV0dXJuIGZpbGVVcGxvYWQ7CiAgICB9CgogICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHVzZXJSZWNvcmQpOwoKICAgIGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHtkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwp9CgppZiAoZmlsZVVwbG9hZC5zdWNjZXNzKQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIGZpbGVVcGxvYWQ7JwDEtf3sCZzwARBhYkNvcmVNZW51QWN0aW9uAgQAxLX97Ani/gFNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAMS1/ewJnPABC29uU3RvcmVNZW51AgQAxLX97Amw/wHwlQFAbGV0IHBvc3NpYmxlUHVibGlzaEJvdCA9IG5ldyBTZXQoKTsKCmlmIChsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cykpIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMuZm9yRWFjaChiID0+IHBvc3NpYmxlUHVibGlzaEJvdC5hZGQoYikpOwogICAgfSBlbHNlIHsKICAgICAgICBwb3NzaWJsZVB1Ymxpc2hCb3QuYWRkKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cyk7CiAgICB9Cn0KCmlmIChsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKSB7CiAgICBwb3NzaWJsZVB1Ymxpc2hCb3QuYWRkKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpOwp9Cgpwb3NzaWJsZVB1Ymxpc2hCb3QgPSBBcnJheS5mcm9tKHBvc3NpYmxlUHVibGlzaEJvdCk7Cgpjb25zdCBiYXNlQUIgPSAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyA/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOiBsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzLmlkOwpjb25zdCBiYXNlQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwpjb25zdCBub25BQkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IGRlZmF1bHRzID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBtYW5hZ2VyOiAi8J+UlyIgKyB0aGlzQm90LmlkLAogICAgbWFuaWZlc3RhdGlvbjogdGFncy5tYW5pZmVzdGF0aW9uLAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAKfQoKLy8gQ3JlYXRlIGRvd25sb2FkIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgIGxhYmVsOiAiZG93bmxvYWQiLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm1BZGRyZXNzOiAiZ2V0X2FwcCIsCiAgICBwb3NzaWJsZUJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYkRvd25sb2FkKHsgcG9zc2libGVCb3RzOiBsaW5rcy5wb3NzaWJsZUJvdH0pO2AKfSk7CgppZiAoIWF1dGhCb3QpIAp7CiAgICAvLyBDcmVhdGUgbG9naW4gbWVzc2FnZQogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgICAgICBsYWJlbDogInBsZWFzZSBzaWduIGluIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIiwKICAgICAgICBvbkNsaWNrOiBgQCBvcy5yZXF1ZXN0QXV0aEJvdCgpYAogICAgfSk7CgogICAgcmV0dXJuOwp9CmVsc2UgaWYgKGF1dGhCb3QudGFncy5zdWJzY3JpcHRpb25UaWVyID09ICJGcmVlUGxheSIpIAp7CiAgICAvLyBDcmVhdGUgdXBncmFkZSBzdWJzY3JpcHRpb24gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJwbGVhc2UgdXBncmFkZSB5b3VyIHN1YnNjcmlwdGlvbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIKICAgIH0pOwoKICAgIHJldHVybjsKfQoKCmxldCB1c2VyU3R1ZGlvcyA9IGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvczsKCmlmICghdXNlclN0dWRpb3MpIAp7CiAgICB1c2VyU3R1ZGlvcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOwp9CgppZiAodXNlclN0dWRpb3Muc3VjY2VzcykgCnsKICAgIGNvbnN0IGFjdGl2ZVN0dWRpbyA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpOwoKICAgIGxldCBiYXNlU3R1ZGlvID0gYXV0aEJvdC5pZDsKCiAgICBpZiAoYmFzZVN0dWRpbyA9PSBhdXRoQm90LmlkKSAKICAgIHsKICAgICAgICBiYXNlU3R1ZGlvID0gInBsYXllciI7CiAgICB9CgogICAgaWYgKGFjdGl2ZVN0dWRpbyA9PSAtMSAmJiBiYXNlU3R1ZGlvICE9ICJwbGF5ZXIiKSAKICAgIHsKICAgICAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGJhc2VTdHVkaW87CiAgICB9CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyAmJiAhYWN0aXZlU3R1ZGlvKSAKICAgIHsKICAgICAgICBjb25zdCBzdHVkaW9NYXRjaCA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQoKICAgICAgICBpZiAoc3R1ZGlvTWF0Y2ggIT0gLTEpIHsKICAgICAgICAgICAgYmFzZVN0dWRpbyA9IGJhc2VTdHVkaW87CiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHN0dWRpb0xhYmVsID0gYWN0aXZlU3R1ZGlvID09IC0xID8gYmFzZVN0dWRpbyA6IHVzZXJTdHVkaW9zLnN0dWRpb3NbYWN0aXZlU3R1ZGlvXS5kaXNwbGF5TmFtZTsKCiAgICAvLyBDcmVhdGUgc3R1ZGlvIHNlbGVjdCBidXR0b24KICAgIGNvbnN0IHN0dWRpb0Rpc3BsYXlCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJzdHVkaW89IiArIHN0dWRpb0xhYmVsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41LAogICAgICAgIHN0dWRpb0luZm9ybWF0aW9uOiB1c2VyU3R1ZGlvcywKICAgICAgICBmb3JtQWRkcmVzczogImludmVudG9yeV8yIiwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLnN0dWRpb1NlbGVjdCh0YWdzLnN0dWRpb0luZm9ybWF0aW9uKTtgCiAgICB9KTsKCiAgICBtYXNrcy5zdHVkaW9TZWxlY3RCdXR0b24gPSBnZXRMaW5rKHN0dWRpb0Rpc3BsYXlCdXR0b24pOwp9Cgpjb25zdCB0b3RhbEJvdENvdW50ID0gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA+IDAgPyBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoIDogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aDsKCi8vIENyZWF0ZSBwdWJsaXNoIGxhYmVsIGJ1dHRvbgpjb25zdCBsYWJlbEJvdCA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgbGFiZWw6IGBwdWJsaXNoIHBhdHRlcm4gJHtiYXNlQm90cy5sZW5ndGggPiAwID8gIiIgOiAiYXMgIn0ke2Jhc2VBQn0gKCR7dG90YWxCb3RDb3VudH0gYm90JHtiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgIHRvdGFsQm90czogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCwKICAgIGFiTWVudVNvcnRPcmRlcjogMSwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIGZvcm1BZGRyZXNzOiBudWxsLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCA4cHggMHB4IDBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLXRvcC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIHNoaWZ0U3RhdGU6IGZhbHNlLAogICAgb25DbGljazogYEAgY29uc3QgbWVudUJvdHMgPSBnZXRCb3RzKCdhYk1lbnVTb3J0T3JkZXInKTsKCiAgICAgICAgaWYgKHRhZ3Muc2hpZnRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleVVwIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlEb3duIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0YWdzLnNoaWZ0U3RhdGUgPSAhdGFncy5zaGlmdFN0YXRlO2AsCiAgICBzY2FsZVk6ICJhdXRvIiwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGxldCB0b3RhbEJvdHMgPSBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPyB0aGF0LmFiQm90cyA6IHRoYXQuYWJCb3RzICsgdGhhdC5ub25BQkJvdHM7CgogICAgY29uc3QgdG90YWxCb3RWYXIgPSB0b3RhbEJvdHMgPT0gMSA/ICIgYm90IiA6ICIgYm90cyI7CiAgICBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cz8ubGVuZ3RoICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgaWYgKGdldEJvdCgiYWJJRE9yaWdpbiIsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCKSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSkubGVuZ3RoOwoKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiArICIgKCIgKyBhYkJvdHMgKyAiIGJvdHMpIjsKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSBhYkJvdHM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCBwYXR0ZXJuIGFzICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjsKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICAgICAgfSAgIAogICAgfQogICAgZWxzZQogICAgeyAgIAogICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgdGhhdC5hYiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjsKICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgIH1gCn0pOwoKLy8gQ3JlYXRlIGVuY3J5cHQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgIGxhYmVsOiAiZW5jcnlwdCIsCiAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgIGVuY3J5cHRTdGF0ZTogZmFsc2UsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBpZih0YWdzLmVuY3J5cHRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSB0cnVlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSB0cnVlOwogICAgICAgIH1gLAp9KTsKCmxldCBhYkJ1dHRvbjsKCmlmIChwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vIENyZWF0ZSBpbmNsdWRlQm90cyBidXR0b24KICAgIGFiQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MiwKICAgICAgICBhYlNlbGVjdGlvbkJ1dHRvbjogdHJ1ZSwKICAgICAgICBsYWJlbDogYmFzZUJvdHMubGVuZ3RoID4gMCAmJiBiYXNlQUIgIT0gdW5kZWZpbmVkID8gYHNlbGVjdGVkIHBhdHRlcm46ICR7YmFzZUFCfSAoJHtiYXNlQm90cy5sZW5ndGh9IGJvdCR7YmFzZUJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCA6IGBuZXcgcGF0dGVybiAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAnZWdnJywKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoU2VsZWN0KCk7YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXJOb24gPSB0aGF0Lm5vbkFCQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICBjb25zdCBib3RWYXJBQiA9IHRoYXQuYWJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgICAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9IHRoYXQuYWIgKyAiICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXJOb247CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAic2VsZWN0ZWQgcGF0dGVybjogIiArIHRoYXQuYWIgKyAiICgiICsgdGhhdC5hYkJvdHMgKyBib3RWYXJBQjsKICAgICAgICB9YAogICAgfSk7Cn0KCmlmIChub25BQkJvdHMubGVuZ3RoID4gMCAmJiBwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vaWNsdWRlIG5ldyBib3RzCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MywKICAgICAgICBhYkJ1dHRvbjogZ2V0TGluayhhYkJ1dHRvbiksCiAgICAgICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICAgICAgbGFiZWw6IGBpbmNsdWRlIG5ldyAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94IiwKICAgICAgICB1bmNsYWltZWRTdGF0ZTogZmFsc2UsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gbGlua3MuYWJCdXR0b24udGFncy5sYWJlbDsKCiAgICAgICAgICAgICAgICBpZiAobGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih0YWdzLnVuY2xhaW1lZFN0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zdCBub25BQkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vbkFCQm90cy5sZW5ndGh9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CgogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiAwfSk7CiAgICAgICAgICAgIH1gLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAiaW5jbHVkZSBuZXcgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhcjsKCiAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSB0aGF0LmFiOwoKICAgICAgICAgICAgaWYoIWxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgcHVibGljIGJ1dHRvbgppZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIAp7CiAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBmYWxzZTsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgICAgIGxhYmVsOiAiaXNQdWJsaWMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgICAgIHB1YmxpY1N0YXRlOiBmYWxzZSwKICAgICAgICBvbkNsaWNrOiBgQCBpZih0YWdzLnB1YmxpY1N0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IHRydWU7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHZlcnNpb24gc2VsZWN0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBsYWJlbDogJ3ZlcnNpb25GbGFnPWN1cnJlbnQnLAogICAgZm9ybUFkZHJlc3M6ICdhbHRfcm91dGUnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIHNob3V0KCdzaG93VmVyc2lvblNlbGVjdG9yJyk7YCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICd2ZXJzaW9uRmxhZz0nICsgdGhhdDsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgIGAsCn0pOwoKLy8gQ3VycmVudCBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdjdXJyZW50JywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl9jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBGZWVkYmFjayBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdmZWVkYmFjaycsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdmZWVkYmFjayc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gU3RhYmxlIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ3N0YWJsZScsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMiwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdzdGFibGUnOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIENyZWF0ZSBwdWJsaXNoIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogNCwKICAgIGZvcm1BZGRyZXNzOiAiZWdnIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHggMHB4IDhweCA4cHgiLAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWJvdHRvbS1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtOiAiaW5wdXQiLAogICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgb25JbnB1dFR5cGluZzogYEAgbGlua3MubGFiZWxCb3QudGFncy5sYWJlbCA9ICdwdWJsaXNoIHBhdHRlcm4gYXMgJyArIHRoYXQudGV4dCArICcgKCcgKyBsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyArICcgYm90JyArIChsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyA9PSAxID8gJyknIDogJ3MpJyk7YCwKICAgIG1lbnVJdGVtU2hvd1N1Ym1pdFdoZW5FbXB0eTogdHJ1ZSwKICAgIHRhcmdldEJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgbWVudUl0ZW1UZXh0OiBiYXNlQUIsCiAgICBvblN1Ym1pdDogYEAKICAgICAgICAgICAgaWYgKHRoYXQudGV4dCA9PSBudWxsICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGF0LnRleHQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKICAgICAgICAgICAgY29uc3QgY29uZmlybVB1c2ggPSBhd2FpdCBvcy5zaG93Q29uZmlybSh7CiAgICAgICAgICAgICAgICB0aXRsZTogImNvbmZpcm0gcHVibGlzaCIsCiAgICAgICAgICAgICAgICBjb250ZW50OiAicHVibGlzaCAiICsgdGhhdC50ZXh0ICsgIiB0byAiICsgdGFyZ2V0U3R1ZGlvICsgIj8iLAogICAgICAgICAgICAgICAgY29uZmlybVRleHQ6ICJwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNhbmNlbFRleHQ6ICJjYW5jZWwiCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKCFjb25maXJtUHVzaCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhhdC50ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaEFCKHsgYWI6IHRoYXQudGV4dCwgYm90OiBsaW5rcy50YXJnZXRCb3QsIGJhc2VBQjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIG1hbnVhbFB1Ymxpc2g6IHRydWUsIHNvdXJjZUV2ZW50OiAnc3RvcmVfbWVudScgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvcy50b2FzdCgiYWIgbm90IHNwZWNpZmllZCIpOwogICAgICAgICAgICB9CiAgICAgICAgYCwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIAogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gdGhhdC5hYjsKICAgIH1gCn0pOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIAp7CiAgICAvLyBDcmVhdGUgY29weSB0byBjbGlwYm9hcmQgYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA4LAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogImNvcHkgdG8gY2xpcGJvYXJkIiwKICAgICAgICBmb3JtQWRkcmVzczogImZpbGVfY29weSIsCiAgICAgICAgdGFyZ2V0Qm90OiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90Rm9jdXMsCiAgICAgICAgb25DbGljazogYEAgbGV0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwogICAgICAgICAgICBsZXQgcHJlcHBlZEJvdCA9IEpTT04uc3RyaW5naWZ5KHNlbGVjdGVkQm90KTsKICAgICAgICAgICAgbGV0IHN0YXRlID0ge30KCiAgICAgICAgICAgIHN0YXRlW2FiSW5zdE1lbW9yeS50YWdzLmFiRm9jdXNEYXRhXSA9IHNlbGVjdGVkQm90OwoKICAgICAgICAgICAgbGV0IG5ld0ZpbGUgPSB7fQogICAgICAgICAgICBuZXdGaWxlLnZlcnNpb24gPSAxOwogICAgICAgICAgICBuZXdGaWxlLnN0YXRlID0gc3RhdGU7CgogICAgICAgICAgICB2YXIgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KG5ld0ZpbGUpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZm9ybWF0dGVkRmlsZSk7CgogICAgICAgICAgICBvcy50b2FzdCgiYm90IGNvcGllZCB0byBjbGlwYm9hcmQiKTsKCiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIGAsCiAgICB9KTsKfQplbHNlIAp7CiAgICAvLyBDcmVhdGUgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEwLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsgICAgICAgICAgICAKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogInNjYW4gdG8gcHVibGlzaCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJxcl9jb2RlX3NjYW5uZXIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gdHJ1ZTsgb3Mub3BlblFSQ29kZVNjYW5uZXIoKTtgLAogICAgfSk7Cn0KCmxldCBob3N0QnV0dG9uID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51U29ydE9yZGVyOiA1MCwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGZvcm1BZGRyZXNzOiAiZ3JvdXBfYWRkIiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5sZWFybi5hYkNyZWF0ZUhvc3QodGhpc0JvdCk7CiAgICBpZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKQogICAgewogICAgICAgIHRhZ3MubGFiZWwgPSAnZ2VuZXJhdGluZyBjb2RlIG5vdyc7CiAgICB9YCwKfTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiam9pbiBjb2RlOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDAsIDMpICsgIi0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDMpOwp9CmVsc2UgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiZ2VuZXJhdGUgam9pbiBjb2RlIjsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnN0YXRpY0luc3QgPT0gdW5kZWZpbmVkKQp7CiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihob3N0QnV0dG9uKTsvL2dlbmVyYXRlIGEgaG9zdCBidXR0b24KfScAxLX97Amc8AEOYWJDb3JlTWVudUljb24CBADEtf3sCZOVAwlpb3Nfc2hhcmUnAMS1/ewJnPABD2FiQ29yZU1lbnVMYWJlbAIEAMS1/ewJnZUDBXNoYXJlJwDEtf3sCZzwARNhYkNvcmVNZW51U29ydE9yZGVyAgQAxLX97AmjlQMBMycAxLX97Amc8AEIcmVtZW1iZXICBADEtf3sCaWVAyjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDEtf3sCZzwAQthYlB1Ymxpc2hBQgIEAMS1/ewJzJUDozZAaWYgKHRoYXQuYWIuaW5kZXhPZigiICIpICE9IC0xIHx8IHRoYXQuYWIuaW5kZXhPZignIicpICE9IC0xKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnOiAicGF0dGVybiBuYW1lcyBtYXkgbm90IGNvbnRhaW4gc3BhY2VzIG9yIHF1b3RhaW9uIG1hcmtzLCBwbGVhc2UgdHJ5IGFnYWluLiIsIGxvZ1R5cGU6ICJlcnJvciIgfSk7CiAgICByZXR1cm47Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGBwdWJsaXNoaW5nICR7dGhhdC5hYn1gKTsKCmlmICghdGhhdC5rZWVwTWVudSkgewogICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKfQoKLy9hYiB2YXJpYWJsZXMKY29uc3QgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKY29uc3QgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpjb25zdCBiYXNlQUIgPSB0aGF0LmJhc2VBQiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPz8gKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQpOwpjb25zdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoID0gdGhhdC5vblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOyAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4gKG9wdGlvbmFsKQpjb25zdCBtYW51YWxQdWJsaXNoID0gdGhhdC5tYW51YWxQdWJsaXNoOwpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQuc291cmNlRXZlbnQ7IC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQpjb25zdCBzdGF0ZSA9IHt9OwpsZXQgZm9ybWF0dGVkRmlsZSA9IHt9OwoKY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKCmxldCBidXN5SW5kaWNhdG9yOwppZiAobWFudWFsUHVibGlzaCAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKSB7CiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKICAgIGlmICghbGlua3MubWVudSkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7CiAgICB9CiAgICAKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgdXBsb2FkaW5nICR7dGhhdC5hYn1gLCBvbkRlc3Ryb3k6IGBAY29uc29sZS5sb2coJ2J1c3kgaW5kaWNhdG9yIGdvIGJvb20nKWB9KTsKfQoKLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byBzdGFydCBwdWJsaXNoaW5nLgpjb25zdCBiZWZvcmVQdWJsaXNoQXJnID0geyBhYjogYWJJRCwgc3R1ZGlvLCBwdWJsaWNGYWNpbmcsIHNvdXJjZUV2ZW50IH07CmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZVB1Ymxpc2gnLCBiZWZvcmVQdWJsaXNoQXJnKSk7CgppZiAoIXRhcmdldCB8fCB0YXJnZXQubGVuZ3RoIDwgMSkgewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCAmJiBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT09IGFiSUQpOwoKICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwogICAgfSBlbHNlIGlmIChjb25maWdCb3QudGFncy5zZWxlY3RlZEFCICYmIGdldEJvdCgiYWJJRE9yaWdpbiIsIGJhc2VBQikpIHsKICAgICAgICBjb25zdCBlZ2dCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIpOwogICAgICAgIGNvbnN0IG5ld0JvdHMgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSAmJiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsKTsKCiAgICAgICAgdGFyZ2V0ID0gWy4uLmVnZ0JvdHMsIC4uLm5ld0JvdHNdOwogICAgfSBlbHNlIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CiAgICB9CgogICAgc2V0VGFnKHRhcmdldCwgImFiSURPcmlnaW4iLCBhYklEKTsKCiAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCID0gbnVsbDsKCiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBib3RzIGZvdW5kIHRvIHB1Ymxpc2giKTsKCiAgICAgICAgaWYgKCF0aGF0LmtlZXBNZW51KSB7CiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7IAogICAgICAgIH0KCiAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgZ2VuZXJhdGluZyBhIGtleSBmb3IgZW5jcnlwdGlvbiAob3B0aW9uYWwpCmlmIChjb25maWdCb3QudGFncy5lbmNyeXB0aW9uKSB7CiAgICBsZXQga2V5Q2hlY2s7CgogICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CgogICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgdGl0bGU6ICdlbnRlciBhIHNlY3JldCBrZXknCiAgICB9KTsKCiAgICBpZiAoa2V5KSB7CiAgICAgICAga2V5Q2hlY2sgPSBhd2FpdCBvcy5zaG93SW5wdXQoIiIsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnY29uZmlybSBzZWNyZXQga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGlmIChrZXkgIT0ga2V5Q2hlY2spIHsKICAgICAgICBpZiAoIWtleUNoZWNrKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoIm5vIGtleSBlbnRlcmVkIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgia2V5cyBkbyBub3QgbWF0Y2giKTsKICAgICAgICB9CgogICAgICAgIGlmICghdGhhdC5rZWVwTWVudSkgewogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOyAKICAgICAgICB9CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vZm9ybWF0dGluZyBib3RzIGZvciBmaWxlIHN0b3JhZ2UKaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YXJnZXQubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgY3VycmVudEJvdElEID0gdGFyZ2V0W2ldLmlkOwogICAgICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGFyZ2V0W2ldKSk7CgogICAgICAgIHN0YXRlW2N1cnJlbnRCb3RJRF0gPSBjdXJyZW50Qm90RGF0YTsKICAgIH0KfQplbHNlIHsKICAgIHN0YXRlW3RhcmdldC5pZF0gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldCkpOwp9CgovL2NoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhbmQgcmV0dXJucyBkYXRhIGZvciBwcmV2aW91c2x5IHB1Ymxpc2hlZCBhYidzCmxldCBlZ2dDaGVjayA9IGF3YWl0IHRoaXNCb3QuYWJQcmV2aW91c0VnZ0NoZWNrKHsgYWJJRDogYWJJRCB9KTsKCi8vYWRkIHhwIGJvdCBoZXJlCnN0YXRlLmFiWFBCb3QgPSB7CiAgICBzcGFjZTogInNoYXJlZCIsCiAgICBpZDogImFiWFBCb3QiLAogICAgdGFnczogewogICAgICAgIGZvcm06ICJub3RoaW5nIiwKICAgICAgICBzeXN0ZW06ICJhYi5wYXR0ZXJuLmFiWFBCb3QiLAogICAgICAgIGF1dGhvcklEOiBhdXRoQm90LmlkLAogICAgICAgIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbiwKICAgICAgICB4cDogbGlua3MubGVhcm4udGFncy5hYlhQLAogICAgICAgIHNpZ25hdHVyZTogZWdnQ2hlY2suc2lnbmF0dXJlLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgfQp9OwoKLy8gRG8gYW5vdGhlciBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGFiIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4KbGV0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBhYjogYWJJRCwgc3R1ZGlvLCBwdWJsaWNGYWNpbmcsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaChwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vYWRkaXRpb25hbCBmaWxlIGRhdGEKZm9ybWF0dGVkRmlsZS52ZXJzaW9uID0gMTsKZm9ybWF0dGVkRmlsZS5zaWduYXR1cmUgPSBlZ2dDaGVjay5zaWduYXR1cmU7CmZvcm1hdHRlZEZpbGUuc3RhdGUgPSBzdGF0ZTsKCi8vYWN0dWFsIGVuY3J5cHRpb24gaWYgY2hvc2VuCmlmIChrZXkpIHsKICAgIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRGaWxlKTsKICAgIGZvcm1hdHRlZEZpbGUgPSBjcnlwdG8uZW5jcnlwdChrZXksIGZvcm1hdHRlZEZpbGUpOwp9CgovL3B1Ymxpc2ggdGhlIGZpbGUKbGV0IHB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUQgfSk7CgovL2dhdGhlciBhZGRpb25hbCBlZ2cgZGF0YQpjb25zdCBhaVBlcm1pdENoZWNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWlfcGVybWl0Iik7CmNvbnN0IGFpUGVybWl0SUQgPSBhaVBlcm1pdENoZWNrLnN1Y2Nlc3MgPyBhaVBlcm1pdENoZWNrLmRhdGEucGVybWl0SUQgOiBmYWxzZTsKCmVnZ0NoZWNrLmVnZ0RhdGEuYWlQZXJtaXQgPSBhaVBlcm1pdElEOwplZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5LnB1c2gocHVibGlzaEZpbGUudXJsKTsKZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CmVnZ0NoZWNrLmVnZ0RhdGEudGFyZ2V0VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwoKLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKbGV0IHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7IGRhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogcHVibGljRmFjaW5nIH0pOwpsZXQgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CgovL3B1Ymxpc2hpbmcgc2hvdXQKc3VwZXJTaG91dCgib25BQlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7CnN1cGVyU2hvdXQoIm9uQWJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCi8vc2VuZCBkYXRhIGFuZCBmb3JtYXQgdXJsIGlmIGRhdGEgc3VjY2Vzc2Z1bGx5IHNlbnQKaWYgKHB1Ymxpc2hSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3QgYmlvcyA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CiAgICBjb25zdCBpbnN0VHlwZSA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CgogICAgc2V0VGFnTWFzayhsaW5rcy5sZWFybiwgImFiWFAiLCAiMCIsICJsb2NhbCIpOwoKICAgIGlmIChtYW51YWxQdWJsaXNoKSB7CiAgICAgICAgY29uc3QgdXJsID0gc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJnN0dWRpbz0iICsgc3R1ZGlvICsgIiZiaW9zPSIgKyBiaW9zOwogICAgICAgIG9zLnNldENsaXBib2FyZCh1cmwpOwoKICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIHdpdGggZW5jcnlwdGVkIGRhdGEgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgYW5hbHl0aWNzLnJlY29yZEV2ZW50KCdhYl9lZ2dfcHVibGlzaCcsIHsgYWI6IGFiSUQsIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgfQp9CmVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogJ3B1Ymxpc2hpbmcgZmFpbGVkJywKICAgICAgICBsb2dUeXBlOiAnZXJyb3InLAogICAgICAgIHRvYXN0OiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlCiAgICB9KQoKICAgIGNvbnNvbGUuZXJyb3IoYGZhaWxlZCBwdWJsaXNoIHJlY29yZDpgLCBwdWJsaXNoUmVjb3JkKTsKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBwdWJsaXNoUmVjb3JkOycAxLX97Amc8AEIYWJJZ25vcmUCBADEtf3sCfDLAwR0cnVlJwDEtf3sCZzwAQphYkRvd25sb2FkAgQAxLX97An1ywO5FUBjb25zdCBwb3NzaWJsZUJvdHMgPSB0aGF0Py5wb3NzaWJsZUJvdHM7CmxldCBmaWxlbmFtZSA9IHRoYXQ/LmZpbGVuYW1lOwpsZXQgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKbGV0IG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ7CmxldCBsb2cgPSB0aGF0Py5sb2cgPz8gdHJ1ZTsKbGV0IHJlb3BlbkFiTWVudSA9IHRoYXQ/LnJlb3BlbkFiTWVudSA/PyB0cnVlOwoKLy8gTGV0IGFsbCBib3RzIGtub3cgdGhhdCBhYiBpcyBhYm91dCB0byBkb3dubG9hZCBib3RzLgpjb25zdCBiZWZvcmVEb3dubG9hZEFyZyA9IHsgZmlsZW5hbWUsIHNvdXJjZUV2ZW50IH07CmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQkJlZm9yZURvd25sb2FkJywgYmVmb3JlRG93bmxvYWRBcmcpKTsKCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zdCBzaG91bGREb3dubG9hZEluc3QgPSAhcG9zc2libGVCb3RzIHx8IChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykgJiYgcG9zc2libGVCb3RzLmxlbmd0aCA9PT0gMCk7CgppZiAoc2hvdWxkRG93bmxvYWRJbnN0KSB7CiAgICAvLyBEb3dubG9hZCBpbnN0LgogICAgZG93bmxvYWRCb3RzID0gZ2V0Qm90cyhiID0+ICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOwoKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgIH0KCiAgICBpZiAobG9nKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGluc3QnKTsKICAgIH0KfSBlbHNlIHsKICAgIGlmIChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykpIHsKICAgICAgICAvLyBEb3dubG9hZCBib3RzLgogICAgICAgIGRvd25sb2FkQm90cyA9IHBvc3NpYmxlQm90czsKICAgICAgICBjb25zdCBib3RJZHMgPSBwb3NzaWJsZUJvdHMubWFwKGIgPT4gYi5pZCkuc29ydCgpOwogICAgICAgIGxldCBib3RJZHNTSEExID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90SWRzKTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtib3RJZHNTSEExLnN1YnN0cmluZygwLCA3KX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9nKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGBkb3dubG9hZCAke2Rvd25sb2FkQm90cy5sZW5ndGh9IGJvdHNgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGJvdC4KICAgICAgICBkb3dubG9hZEJvdHMgPSBbcG9zc2libGVCb3RzXTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtwb3NzaWJsZUJvdHMuaWQuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGJvdCcpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpIHsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9Cgpjb25zdCBzdGF0ZSA9IHt9OwoKLy8gRm9ybWF0IGJvdHMgZm9yIGZpbGUgc3RvcmFnZQpmb3IgKGxldCBpID0gMDsgaSA8IGRvd25sb2FkQm90cy5sZW5ndGg7IGkrKykgewogICAgbGV0IGN1cnJlbnRCb3RJRCA9IGRvd25sb2FkQm90c1tpXS5pZDsKICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZG93bmxvYWRCb3RzW2ldKSk7CgogICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwp9CgppZiAoIWZpbGVuYW1lLmVuZHNXaXRoKCcuYXV4JykpIHsKICAgIGZpbGVuYW1lICs9ICcuYXV4JzsKfQoKLy8gRG8gYSBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmNvbnN0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBmaWxlbmFtZSwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQocHJlcHJvY2Vzc0FyZyk7Cn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vIERvd25sb2FkIGFzIHYxIGF1eCBmaWxlLgpjb25zdCBhdXhGaWxlID0geyB2ZXJzaW9uOiAxLCBzdGF0ZSB9Owpvcy5kb3dubG9hZChhdXhGaWxlLCBmaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgppZiAocmVvcGVuQWJNZW51KSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfScAxLX97Amc8AENbWFuaWZlc3RhdGlvbgIEAMS1/ewJr+EDKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAMS1/ewJnPABBG1lbnUCBADEtf3sCdbhAyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDEtf3sCZzwARJhYlByZXZpb3VzRWdnQ2hlY2sCBADEtf3sCf3hA7EPQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGVnZ0hpc3Rvcnk7CmxldCBlZ2dJRDsKbGV0IHRhcmdldFZlcnNpb25OdW07CmxldCBsYXN0SGFzaDsKbGV0IG1heFZlcnNpb25OdW07CmxldCBzdGFibGVWZXJzaW9uOwpsZXQgZmVlZGJhY2tWZXJzaW9uOwpsZXQgcHJldmlvdXNYUDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKbGV0IHJlY29yZExvb2t1cCA9IGF3YWl0IG9zLmdldERhdGEodXNlclJlY29yZCwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycAxLX97Amc8AEPYWJCb3RNZW51QWN0aW9uAgQAxLX97Amv8QNNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAMS1/ewJnPABDmFiQm90TWVudUxhYmVsAgQAxLX97An98QMFc2hhcmUnAMS1/ewJnPABDWFiQm90TWVudUljb24CBADEtf3sCYPyAwlpb3Nfc2hhcmUnAMS1/ewJnPABEmFiQm90TWVudVNvcnRPcmRlcgIEAMS1/ewJjfIDAzMuNScAxLX97Amc8AEFbGVhcm4CBADEtf3sCZHyAyjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDEtf3sCZzwAQthYlFSUHVibGlzaAIEAMS1/ewJuPID4QFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0LCBzb3VyY2VFdmVudDogJ3FyX3B1Ymxpc2gnfSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAMS1/ewJnPABBnNlYXJjaAIEAMS1/ewJmvQDKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAMS1/ewJnPABB2FiU2hlbGwCBADEtf3sCcH0AwR0cnVlJwDEtf3sCZzwAQxzdHVkaW9TZWxlY3QCBADEtf3sCcb0A4sLQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwDEtf3sCZzwAQ5hYlB1Ymxpc2hBc2tJRAIEAMS1/ewJ0P8D2wVAaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgcHVibGlzaGluZyAke3RoYXQuYXNrSUR9YH0pOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmNvbnN0IHBhdHRlcm5JRCA9IHRoYXQucGF0dGVybklEOwpjb25zdCBzdHVkaW9JRCA9IHRoYXQuc3R1ZGlvSUQgPyB0aGF0LnN0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKY29uc3QgcHVibGlzaEFzayA9IGF3YWl0IG9zLnJlY29yZERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIHtwYXR0ZXJuSUQ6IHBhdHRlcm5JRCwgc3R1ZGlvSUQ6IHN0dWRpb0lEfSwge2VuZHBvaW50OiBlbmRwb2ludCwgdXBkYXRlUG9saWN5OiBbYXV0aEJvdC5pZF19KTsKCmlmIChwcm9ncmVzc0J1dHRvbikKewogICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiBwdWJsaXNoQXNrOycAxLX97Amc8AEFaW5wdXQCBADEtf3sCayFBCjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDEtf3sCZzwAQthYkVtYmVkTGluawIEAMS1/ewJ04UEpANAY29uc3QgYWIgPSB0aGF0ID8gdHJ1ZSA6IGZhbHNlOwpjb25zdCBlbWJlZExpbmsgPSBhYiA/ICJhYj0iICsgdGhhdCA6ICJpbnN0PSIgKyBjb25maWdCb3QudGFncy5pbnN0Owpjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKY29uc3QgZW1iZWRUZXh0ID0gYDwhRE9DVFlQRSBodG1sPgrCoMKgwqDCoDxodG1sPgrCoMKgwqDCoMKgwqDCoMKgPGhlYWQ+PC9oZWFkPgrCoMKgwqDCoMKgwqDCoMKgPGJvZHk+CsKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoDxpZnJhbWUgc3JjPSIke3NpdGVPcmlnaW4gKyAiLz8iICsgZW1iZWRMaW5rfSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iNDAwIiAvPgrCoMKgwqDCoMKgwqDCoMKgPC9ib2R5PgrCoMKgwqDCoDwvaHRtbD5gOwoKcmV0dXJuIGVtYmVkVGV4dDsnAMS1/ewJnPABD2FiUGF0dGVyblVwZGF0ZQIEAMS1/ewJzIgEpQVALy9zaG91dCgiYWJQYXR0ZXJuVXBkYXRlIiwge2FiSUQ6IGFiSUQsIHN0dWRpbzpzdHVkaW8/LCBib3RzOiBib3RzP30pOwphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKaWYgKCFhdXRoQm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8gdGhhdC5zdHVkaW8gOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBhYk1hbmlmZXN0ID0gZ2V0Qm90KGJ5TW9kKHthYkVnZzogdHJ1ZSwgb3JpZ2luX2FiOiBhYklEfSkpOwoKaWYgKCFhYk1hbmlmZXN0KQp7CiAgICBzaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGF1dG9IYXRjaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdwYXR0ZXJuX3VwZGF0ZSd9KTsKCiAgICByZXR1cm47Cn0KCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gc3R1ZGlvOwoKY29uc3QgYWJCb3RzID0gdGhhdC5ib3RzID8/IGdldEJvdHMoImFiSURPcmlnaW4iLCBhYklEKTsKCmF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBhYklELCB0YXJnZXQ6IGFiQm90cywgcHVibGljRmFjaW5nOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm5fdXBkYXRlJ30pOycAxLX97Amc8AEXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBADEtf3sCfKNBE1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAxLX97Amc8AEaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBADEtf3sCcCOBAEyJwDEtf3sCZzwARVhYk11bHRpcGxlQm90TWVudUljb24CBADEtf3sCcKOBAlpb3Nfc2hhcmUnAMS1/ewJnPABFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBADEtf3sCcyOBAVzaGFyZScAxLX97Amc8AEPYWJQdWJsaXNoU2VsZWN0AgQAxLX97AnSjgSqE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IHRhZ3MubGFiZWwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vblBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwDEtf3sCZzwAQlhYlZlcnNpb24CBADEtf3sCfuhBAQxMC45JwDEtf3sCZzwAQtwZXJzb25hbGl0eQIEAMS1/ewJgKIEKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAMS1/ewJnPABBXV0aWxzAgQAxLX97AmnogQo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycBBGJvdHMkNzhlNDE1MDMtYzkzMy00ZjhhLTgxN2EtYmE5N2JmOGQ1ZDI3AScAxLX97AnOogQVYWJGaW5kQXJ0aWZhY3RCdW5kbGVzAgQAxLX97AnPogSTBkBjb25zdCB7IAogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge307Cgpjb25zdCBhcnRpZmFjdEJ1bmRsZXM6IFJlY29yZDxzdHJpbmcsIEFCQXJ0aWZhY3RCdW5kbGU+ID0ge307IC8vIEtleSBpcyBhcnRpZmFjdCBpZAoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSAmJiBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCAmJiBhYkFydGlmYWN0SW5zdGFuY2VJRCAhPT0gYi50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFydGlmYWN0SWQgPSBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZS5pZDsKCiAgICAgICAgaWYgKGFydGlmYWN0SWQgJiYgIWFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSkgewogICAgICAgICAgICBhcnRpZmFjdEJ1bmRsZXNbYXJ0aWZhY3RJZF0gPSBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICB9CiAgICB9Cn0pOwoKcmV0dXJuIGFydGlmYWN0QnVuZGxlczsnAMS1/ewJzqIEBXN0b3JlAgQAxLX97AnjqAQo8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicAxLX97AnOogQGc3lzdGVtAgQAxLX97AmKqQQRYWIuc2hlbGwuYXJ0aWZhY3QnAMS1/ewJzqIECGFiSWdub3JlAgQAxLX97AmcqQQEdHJ1ZScAxLX97AnOogQJYWJWZXJzaW9uAgQAxLX97AmhqQQEMTAuOScAxLX97AnOogQFZGVidWcCBADEtf3sCaapBAVmYWxzZScAxLX97AnOogQIcmVtZW1iZXICBADEtf3sCaypBCjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDEtf3sCc6iBBNhYkNyZWF0ZUFydGlmYWN0Qm90AgQAxLX97AnTqQTWEkBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgZGltZW5zaW9uID0gbGlua3MubGVhcm4udGFncy5hYkluc3QgPz8gJ2hvbWUnLAogICAgcG9zaXRpb24gPSBuZXcgVmVjdG9yMygwLCAwLCAwKSwKICAgIG90aGVyVGFncyA9IHt9LAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0TmFtZSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0Qm90ID0gY3JlYXRlKHsKICAgIHNwYWNlOiAnc2hhcmVkJywKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0Qm90OiB0cnVlLAogICAgW2RpbWVuc2lvbl06IHRydWUsCiAgICBbYCR7ZGltZW5zaW9ufVhgXTogcG9zaXRpb24ueCwKICAgIFtgJHtkaW1lbnNpb259WWBdOiBwb3NpdGlvbi55LAogICAgW2Ake2RpbWVuc2lvbn1aYF06IHBvc2l0aW9uLnosCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIGN1cnNvcjogJ3BvaW50ZXInLAogICAgbGFiZWxDb2xvcjogYWJBcnRpZmFjdExhYmVsQ29sb3IsCiAgICBzdHJva2VDb2xvcjogYWJBcnRpZmFjdExhYmVsQ29sb3IsCiAgICBvbkJvdEFkZGVkOiBgQAogICAgICAgIHRoaXNCb3QudXBkYXRlQ29tcHV0ZWRUYWdzKCk7CiAgICBgLAogICAgb25Cb3RDaGFuZ2VkOiBgQAogICAgICAgIGNvbnN0IGNoYW5nZWRUYWdzID0gdGhhdC50YWdzOwoKICAgICAgICBpZiAoY2hhbmdlZFRhZ3Muc29tZSh0ID0+IHQgPT09ICdhYkFydGlmYWN0SW5zdGFuY2VJRCcgfHwgdCA9PT0gJ2FiQXJ0aWZhY3ROYW1lJykpIHsKICAgICAgICAgICAgdGhpc0JvdC51cGRhdGVDb21wdXRlZFRhZ3MoKTsKICAgICAgICB9CiAgICBgLAogICAgdXBkYXRlQ29tcHV0ZWRUYWdzOiBgQAogICAgICAgIGxldCBzeXN0ZW0gPSAnYWJBcnRpZmFjdEJvdCc7CgogICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHN5c3RlbSArPSAnLicgKyB0YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgc3lzdGVtICs9ICcuJyArIHRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQuc3Vic3RyaW5nKDAsIDcpOwogICAgICAgIH0KCiAgICAgICAgdGFncy5zeXN0ZW0gPSAhIXN5c3RlbSA/IHN5c3RlbSA6IG51bGw7CiAgICAgICAgdGFncy5sYWJlbCA9IHRhZ3Muc3lzdGVtOwogICAgYCwKICAgIG9uQUJBcnRpZmFjdFJlY29uc3RpdHV0ZTogYEAKICAgICAgICAvLyBIaWRlIGFydGlmYWN0IGJvdCBvbmNlIGl0IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQuCiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnZm9ybScsICdub3RoaW5nJywgJ3NoYXJlZCcpOwogICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2xhYmVsJywgJyAnLCAnc2hhcmVkJyk7CiAgICBgLAogICAgLi4ub3RoZXJUYWdzLAp9KTsKCnRyeSB7CiAgICAvLyBVcGRhdGUgYWxsIHRoZSBzaGFyZHMgZm9yIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgLS0gd2hpY2ggbm93IGluY2x1ZGVzIHRoaXMgYm90IQogICAgY29uc3QgdXBkYXRlUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKICAgIGlmICghdXBkYXRlUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byB1cGRhdGUgJyR7YWJBcnRpZmFjdE5hbWV9JyBhcnRpZmFjdCBzaGFyZHMuYCk7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXVnaHQgZXJyb3Igd2hpbGUgdXBkYXRlIGFydGlmYWN0IHNoYXJkczpgLCBlKTsKICAgIGRlc3Ryb3koYWJBcnRpZmFjdEJvdCk7CiAgICByZXR1cm4gbnVsbDsKfQoKcmV0dXJuIGFiQXJ0aWZhY3RCb3Q7JwDEtf3sCc6iBBZhYkFydGlmYWN0UmVjb25zdGl0dXRlAgQAxLX97AmqvATXKUBpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKYXNzZXJ0KHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmcgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuYCk7Cgpjb25zdCB7IAogICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cywKICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgYXMgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgQUJBcnRpZmFjdEJ1bmRsZS5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCB0byBiZSBvZiB0eXBlIHN0cmluZy5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmcgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKTsKY29uc3Qgc2hhcmRCb3RzID0gW107CgpmdW5jdGlvbiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKHsgYm90RGF0YSB9KSB7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkOyAvLyBJZiB0aGUgc2hhcmQgYm90IGhhcyBpdHNlbGYgbWFya2VkIGFzIHJlY29uc3RpdHV0ZWQgYWxyZWFkeSAocG9zc2libHkgZHVlIHRvIGFuIG92ZXJzaWdodCksIHRoZW4gcmVtb3ZlIGl0IQoKICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmc7IC8vIEFzc2lnbiB0aGUgYXJ0aWZhY3QgYnVuZGxlIGJhY2sgdG8gdGhlIGhhdGNoZWQgc2hhcmQgYm90LgogICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOyAvLyBVVUlEIG9mIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSB0aGF0IHRoaXMgYm90IGJlbG9uZ3MgdG8uCiAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7IC8vIFVVSUQgYXNzaWduZWQgdG8gdGhlIGJvdCBieSB0aGUgYXJ0aWZhY3Qgd2hlbiBsb2FkZWQuCiAgICB9Cn0KCmZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcykgewogICAgY29uc3QgZGVwZW5kZW5jeUJvdHMgPSBbXTsKCiAgICBpZiAodGhpc0JvdC5pc0VnZ0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICBjb25zdCBlZ2dEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeTsKICAgICAgICAKICAgICAgICAvLyBGaXJzdCB0cnkgdG8gbG9hZCBmcm9tIGVnZy4KICAgICAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgICAgICBhYklEOiBlZ2dEZXBlbmRlbmN5LmFiSUQsCiAgICAgICAgICAgIHJlY29yZEtleTogZWdnRGVwZW5kZW5jeS5yZWNvcmRLZXksCiAgICAgICAgICAgIGFiVmVyc2lvbjogZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24sCiAgICAgICAgICAgIGF1dG9IYXRjaDogdHJ1ZSwKICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUKICAgICAgICB9KQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAke2VnZ0RlcGVuZGVuY3kuYWJJRH0gbG9va3VwRWdnUmVzdWx0OmAsIGxvb2t1cEVnZ1Jlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9va3VwRWdnUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgbG9hZGVkIGRlcGVuZGVuY3kgYWJJRDogJHtlZ2dEZXBlbmRlbmN5LmFiSUR9LCBhYlZlcnNpb246ICR7ZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24gPz8gJ2xhdGVzdCd9YCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoY29uc3QgaGF0Y2hlZEJvdCBvZiBsb29rdXBFZ2dSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA9PT0gMCAmJiB0aGlzQm90LmlzQXNrRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgIGNvbnN0IGFza0RlcGVuZGVuY3kgPSBkZXBlbmRlbmN5IGFzIEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5OwoKICAgICAgICAvLyBUcnkgdG8gbG9hZCBmcm9tIGFzay4KICAgICAgICBjb25zdCBsb29rdXBBc2tSZXN1bHQ6IEFCTG9va3VwQXNrSURSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBc2tJRCh7CiAgICAgICAgICAgIGFza0lEOiBhc2tEZXBlbmRlbmN5LmFza0lELAogICAgICAgICAgICBzaG93SW5kaWNhdG9yOiBmYWxzZSwKICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICBpZ25vcmVSZXNlcnZlZDogdHJ1ZSwKICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUKICAgICAgICB9KQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGxvb2t1cEFza1Jlc3VsdDpgLCBsb29rdXBBc2tSZXN1bHQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxvb2t1cEFza1Jlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgaGF0Y2hlZEJvdCBvZiBsb29rdXBBc2tSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA+IDApIHsKICAgICAgICBmb3IgKGNvbnN0IHNoYXJkQm90IG9mIGRlcGVuZGVuY3lCb3RzKSB7CiAgICAgICAgICAgIHNoYXJkQm90cy5wdXNoKHNoYXJkQm90KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSBmYWlsZWQgdG8gbG9hZCBkZXBlbmRlbmN5OiAke0pTT04uc3RyaW5naWZ5KGRlcGVuZGVuY3kpfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIH0KfQoKCmlmIChzaGFyZEJvdHMubGVuZ3RoID4gMCkgewogICAgLy8gVGVsbCBhbGwgaGF0Y2hlZCBzaGFyZCBib3RzIHRvIHJlY29uc3RpdHV0ZS4gVGhleSBhbGwgaGF2ZSBjb3BpZXMgb2YgdGhlIGFiQXJ0aWZhY3RCdW5kbGUgYW5kIGNhbiByZWNvbnN0aXR1dGUgdGhlbXNlbHZlcyBmcm9tIHRoYXQuCiAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUnLCB7IGRhdGE6IGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSB9KSk7CgogICAgZm9yIChsZXQgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7IC8vIFRoaXMgYm90IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQgaW4gdGhpcyBpbnN0LgogICAgfQoKICAgIGF3YWl0IHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICAKICAgIGNvbnN0IHJlY29uc3RpdHV0aW9uUmVzdWx0ID0gewogICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBhYkFydGlmYWN0QnVuZGxlLm5hbWUsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cywKICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgIHNoYXJkQm90cywKICAgIH07CgogICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCByZWNvbnN0aXR1dGlvblJlc3VsdCk7CgogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9JyAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBmaW5pc2hlZCByZWNvbnN0aXR1dGlvbi5gLCB0b2FzdDogdG9hc3QgfSk7CgogICAgcmV0dXJuIHJlY29uc3RpdHV0aW9uUmVzdWx0Owp9IGVsc2UgewogICAgY29uc3QgZmFpbHVyZVJlc3VsdCA9IHsKICAgICAgICBlcnJvckNvZGU6ICdub19zaGFyZF9ib3RzJywKICAgICAgICBlcnJvck1lc3NhZ2U6ICdSZWNvbnN0aXR1dGlvbiByZXN1bHRzIGluIG5vIHNoYXJkIGJvdHMuJywKICAgICAgICBhYkFydGlmYWN0TmFtZTogYWJBcnRpZmFjdEJ1bmRsZS5uYW1lLAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEUHJldmlvdXMsCiAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgIH07CgogICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkJywgZmFpbHVyZVJlc3VsdCk7CgogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9JyAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBmYWlsZWQgcmVjb25zdGl0dXRpb24uYCwgdG9hc3Q6IHRvYXN0IH0pOwogICAgCiAgICByZXR1cm4gZmFpbHVyZVJlc3VsdDsKfQonAMS1/ewJzqIEF2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uAgQAxLX97AmA5gQBMScAxLX97AnOogQGc2VhcmNoAgQAxLX97AmC5gQo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAxLX97AnOogQHYWJTaGVsbAIEAMS1/ewJqeYEBHRydWUnAMS1/ewJzqIEBXV0aWxzAgQAxLX97Amu5gQo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAxLX97AnOogQPb25BbnlCb3RDbGlja2VkAgQAxLX97AnV5gSBAUBjb25zdCB7IGJvdCB9ID0gdGhhdDsKCmlmIChib3QgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEJvdCA9PT0gdHJ1ZSkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBib3QgfSkKfScAxLX97AnOogQWYWJVcGRhdGVBcnRpZmFjdFNoYXJkcwIEAMS1/ewJ1+cEoxdAY29uc3QgYWJBcnRpZmFjdE5hbWUgPSB0aGF0LmFiQXJ0aWZhY3ROYW1lOwpsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSB0aGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKaWYgKHNoYXJkQm90cy5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVGhlcmUgYXJlIG5vIHNoYXJkcyBmb3IgYXJ0aWZhY3QgbmFtZSAnJHthYkFydGlmYWN0TmFtZX0nLmAsIGxvZ1R5cGU6ICd3YXJuJyB9KTsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KCgpjb25zdCBwcmV2QXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBzaGFyZEJvdHNbMF0udGFncy5hYkFydGlmYWN0QnVuZGxlOwpjb25zdCBwcmV2QXJ0aWZhY3RJRCA9IHByZXZBcnRpZmFjdEJ1bmRsZSA/IHByZXZBcnRpZmFjdEJ1bmRsZS5pZCA6IG51bGw7CgpsZXQgY29sbGVjdFNoYXJkUmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdDsKCnRyeSB7CiAgICBjb2xsZWN0U2hhcmRSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiQ29sbGVjdEFydGlmYWN0U2hhcmRzKHsgc2hhcmRCb3RzIH0pOwoKICAgIGlmICghY29sbGVjdFNoYXJkUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogY29sbGVjdFNoYXJkUmVzdWx0LnJlYXNvbiwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9CiAgICB9Cn0gY2F0Y2goZSkgewogICAgY29uc29sZS5lcnJvcihlKTsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgU29tZXRoaW5nIHdlbnQgd3JvbmcgY29sbGVjdGluZyBzaGFyZHMuIFNlZSBjb25zb2xlIGZvciBtb3JlIGRldGFpbHMuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH0KfQoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHRoaXNCb3QuYWJDcmVhdGVBcnRpZmFjdEJ1bmRsZSh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0U2hhcmQ6IGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZCB9KTsKCmlmIChwcmV2QXJ0aWZhY3RJRCAmJiBwcmV2QXJ0aWZhY3RJRCAhPT0gYWJBcnRpZmFjdEJ1bmRsZS5pZCkgewogICAgLy8gVGhlIGFydGlmYWN0IGhhcyBhIG5ldyBpZC4gQWxsIG9mIHRoZSBzaGFyZCBib3RzIG5lZWQgYSBuZXcgaW5zdGFuY2UgaWQgYXMgd2VsbC4KICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwoKICAgIGZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZmluYWwgbWVyZ2VkIGFydGlmYWN0ICR7YWJBcnRpZmFjdE5hbWV9OmAsIGFiQXJ0aWZhY3RCdW5kbGUpOwp9CgovLyBFdmVyeSBzaGFyZCBib3QgZ2V0cyBhIGNvcHkgb2YgdGhlIGFydGlmYWN0IGJ1bmRsZS4KLy8gVGhpcyBtYWtlcyB0aGUgYXJ0aWZhY3QgaG9sb2dyYXBoaWMgYnkgbmF0dXJlLiBUaGlzIG1lYW5zIHRoYXQgYW55IHNoYXJkIGNhbiBiZSB1c2VkIHRvIHJlY29uc3RpdHV0ZSB0aGUgd2hvbGUuCmZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAvLyBNYXJrIGVhY2ggc2hhcmQgYm90IGFzIGJlaW5nICdyZWNvbnN0aXR1dGVkJyB3aGVuIHdlIHVwZGF0ZSB0aGUgYXJ0aWZhY3QuCiAgICAvLyBCZWNhdXNlIHRoaXMgaXMgYSBzaGFyZWQgdGFnIG1hc2ssIGl0IHdpbGwgb25seSBiZSB0cnVlIGluIHRoZSBjdXJyZW50IGluc3QuCiAgICBzZXRUYWdNYXNrKHNoYXJkQm90LCAnYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCcsIHRydWUsICdzaGFyZWQnKTsKICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSA9ICAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKTsKfQoKLy8gUnlhbiBDb29rOiBOZWVkIHRvIGdpdmUgQ2FzdWFsT1MgYSBjaGFuY2UgdG8gY2F0Y2h1cC4KLy8gRm91bmQgdGhhdCBpZiB3ZSBkaWRudCBkbyB0aGlzLCBtb2QgdGFncyB3b3VsZCBub3QgYmUgcmV0dXJuZWQgYXMgSlNPTiBvYmplY3RzIGJ1dCBpbnN0ZWFkIHRoZSByYXcgc3RyaW5nLgphd2FpdCBvcy5zbGVlcCgwKTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0ZWQgYXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9Jy4gQ29waWVkIGFydGlmYWN0IGJ1bmRsZSB0byAke3NoYXJkQm90cy5sZW5ndGh9IGJvdHMuIGFiQXJ0aWZhY3RCdW5kbGU6YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCnNob3V0KCdvbkFueUFCQXJ0aWZhY3RTaGFyZHNVcGRhdGVkJywgeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQsIGFiQXJ0aWZhY3RCdW5kbGUsIHNoYXJkQm90cyB9KQoKLy8gU2hhcmQgdXBkYXRlIHN1Y2Nlc3NmdWwuCnJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTsnAMS1/ewJzqIEBG1lbnUCBADEtf3sCfn+BCjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDEtf3sCc6iBAVsZWFybgIEAMS1/ewJoP8EKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAMS1/ewJzqIEC29uR3JpZENsaWNrAgQAxLX97AnH/wRGQGlmIChsaW5rcy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfScAxLX97AnOogQaYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQCBADEtf3sCY6ABQcjQUVBMUZGJwDEtf3sCc6iBBthYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQCBADEtf3sCZaABQcjMWUxYjJkJwDEtf3sCc6iBBBvbkFueUJvdHNSZW1vdmVkAgQAxLX97AmegAWVAUBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsKCmlmIChtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgJiYgYm90SURzLmluY2x1ZGVzKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCkpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwp9JwDEtf3sCc6iBAd2ZXJzaW9uAgQAxLX97Am0gQUo8J+UlzUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZicAxLX97AnOogQYYWJHZXRBcnRpZmFjdE5hbWVzSW5JbnN0AgQAxLX97AnbgQWsAUBjb25zdCBhYkFydGlmYWN0TmFtZXMgPSBuZXcgU2V0KCk7CgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgYWJBcnRpZmFjdE5hbWVzLmFkZChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpOwogICAgfQp9KQoKcmV0dXJuIGFiQXJ0aWZhY3ROYW1lczsnAMS1/ewJzqIEFWFiQXJ0aWZhY3RCb3RNZW51T3BlbgIEAMS1/ewJiIMF+xVAY29uc3QgeyBhYkFydGlmYWN0Qm90IH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3RCb3QgJiYgYWJBcnRpZmFjdEJvdC5zcGFjZSAmJiBhYkFydGlmYWN0Qm90LnRhZ3MsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJvdCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQm90LmApOwoKc2hvdXQoImFiQXJ0aWZhY3RCb3RNZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiQXJ0aWZhY3RNZW51IjsKCmlmICghdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwoKbGV0IGluZm9MYWJlbCA9IGBbYXJ0aWZhY3QgbmFtZV06ICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaWRdOiAke2FiQXJ0aWZhY3RCdW5kbGUuaWQuc3Vic3RyaW5nKDAsIDcpfVxuYDsKaW5mb0xhYmVsICs9IGBbYXJ0aWZhY3QgaW5zdGFuY2UgaWRdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA/PyAndW5zZXQnfSBcbmA7CmluZm9MYWJlbCArPSBgW3JlY29uc3RpdHV0ZWQgaW4gaW5zdF06ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWR9XG5gOwppbmZvTGFiZWwgKz0gYFtmb3JtYXRdOiB2JHthYkFydGlmYWN0QnVuZGxlLmZvcm1hdFZlcnNpb259XG5gOwppbmZvTGFiZWwgKz0gYFtjcmVhdGVkIHRpbWVdOiAke0RhdGVUaW1lLmZyb21JU08oYWJBcnRpZmFjdEJ1bmRsZS5jcmVhdGVkVGltZXN0YW1wKS50b0xvY2FsZVN0cmluZyhEYXRlVGltZS5EQVRFVElNRV9TSE9SVF9XSVRIX1NFQ09ORFMpfVxuYDsKCi8vIEhlYWRlcgpjb25zdCBpbmZvQm90ID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVUZXh0KHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgbGFiZWw6IGluZm9MYWJlbCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaChpbmZvQm90KTsKCi8vIERvd25sb2FkIHNoYXJkIGJ1dHRvbi4KY29uc3QgZG93bmxvYWRCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGFiQXJ0aWZhY3RCb3Q6IGdldExpbmsoYWJBcnRpZmFjdEJvdCksCiAgICBhYkFydGlmYWN0VG9vbDogZ2V0TGluayh0aGlzQm90KSwKICAgIGZvcm1BZGRyZXNzOiAnZG93bmxvYWQnLAogICAgbGFiZWw6IGBkb3dubG9hZCBzaGFyZGAsCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IGxpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGNvbnN0IGZpbGVuYW1lID0gJ2FiQXJ0aWZhY3QtJyArIGFiQXJ0aWZhY3RCdW5kbGUubmFtZSArICctJyArIGFiQXJ0aWZhY3RCdW5kbGUuaWQuc3Vic3RyaW5nKDAsNykgKyAnLmF1eCc7IAogICAgICAgIG9zLmRvd25sb2FkQm90cyhbIGxpbmtzLmFiQXJ0aWZhY3RCb3QgXSwgZmlsZW5hbWUpOwogICAgICAgIAogICAgICAgIGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKICAgIGAsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2goZG93bmxvYWRCdXR0b24pOwoKLy8gVXBkYXRlIGFydGlmYWN0IGJ1dHRvbi4KY29uc3QgdXBkYXRlQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgYWJBcnRpZmFjdFRvb2w6IGdldExpbmsodGhpc0JvdCksCiAgICBmb3JtQWRkcmVzczogJ3N5bmMnLAogICAgbGFiZWw6IGB1cGRhdGUgYXJ0aWZhY3RgLAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGUgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBjb25zdCBhYkFydGlmYWN0TmFtZSA9IGFiQXJ0aWZhY3RCdW5kbGUubmFtZTsKICAgICAgICBjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IGxpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICAKICAgICAgICBhd2FpdCBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYlVwZGF0ZUFydGlmYWN0U2hhcmRzKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKICAgICAgICBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYkFydGlmYWN0Qm90TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBsaW5rcy5hYkFydGlmYWN0Qm90IH0pOwogICAgYCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaCh1cGRhdGVCdXR0b24pOwoKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gYWJBcnRpZmFjdEJvdC5pZDsnAMS1/ewJzqIEGWFiRG93bmxvYWRBcnRpZmFjdFBhdHRlcm4CBADEtf3sCYSZBfwEQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgc2hhcmRCb3RzLAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdE5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSAmJiBzaGFyZEJvdHMubGVuZ3RoID4gMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgYSByZXF1aXJlZCBCb3QgYXJyYXkgcGFyYW1ldGVyLiBJdCBtdXN0IGhhdmUgYXQgbGVhc3QgMSBib3QuYCk7CgpyZXR1cm4gbGlua3Muc3RvcmUuYWJEb3dubG9hZCh7IAogICAgcG9zc2libGVCb3RzOiBzaGFyZEJvdHMsCiAgICBmaWxlbmFtZTogYCR7YWJBcnRpZmFjdE5hbWV9YCwKICAgIHNvdXJjZUV2ZW50OiAnZG93bmxvYWRfYXJ0aWZhY3RfcGF0dGVybicsCiAgICByZW9wZW5BYk1lbnU6IGZhbHNlLAogICAgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ6IChhcmcpID0+IHsKICAgICAgICB0aGlzQm90LmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhKGFyZy5ib3REYXRhKTsKICAgIH0KfSk7JwDEtf3sCc6iBBZhYkFydGlmYWN0Qm90TWVudVJlc2V0AgQAxLX97AmBngXvAUBpZiAodGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMgJiYgdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMubGVuZ3RoID4gMCkgewogICAgZGVzdHJveSh0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyk7CiAgICB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwp9Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7Cm1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCA9IG51bGw7JwDEtf3sCc6iBAV0eXBlcwIEAMS1/ewJ8Z8F4gnwn5OEaW50ZXJmYWNlIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmcgewogICAgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZTsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEPzogc3RyaW5nOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cz86IHN0cmluZzsKICAgIHRvYXN0PzogYm9vbGVhbjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHsKICAgIGFiSUQ6IHN0cmluZzsKICAgIHJlY29yZEtleTogc3RyaW5nOwogICAgYWJWZXJzaW9uPzogbnVtYmVyOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3kgewogICAgYXNrSUQ6IHN0cmluZzsKfQoKdHlwZSBBQkFydGlmYWN0RGVwZW5kZW5jeSA9IEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHwgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgppbnRlcmZhY2UgQUJBcnRpZmFjdEJ1bmRsZSB7CiAgICBpZDogc3RyaW5nOwogICAgbmFtZTogc3RyaW5nOwogICAgZm9ybWF0VmVyc2lvbjogbnVtYmVyOwogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+OwogICAgY2FzdWFsT1NWZXJzaW9uOiBBdXhWZXJzaW9uOwogICAgY3JlYXRlZFRpbWVzdGFtcDogc3RyaW5nOwogICAgYWJTaGVsbFZlcnNpb246IHN0cmluZzsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RTaGFyZCB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+OwogICAgZGVwZW5kZW5jaWVzOiBBcnJheTxBQkFydGlmYWN0RGVwZW5kZW5jeT47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RXhwZXJpZW5jZSB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoIHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmc7CiAgICBhdXRob3JpemVkOiBib29sZWFuOwogICAgZmFpbHVyZVJlYXNvbjogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZVJlYXNvbjsKfQoKdHlwZSBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbicgfCAndXNlcl9kZWNsaW5lZF9pbnN0X3Blcm1pc3Npb24nIHwgJ3Vua25vd24nOwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICByZWFzb24/OiBhbnk7CiAgICBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwp9CicAxLX97AnOogQab25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUCBADEtf3sCdKpBe47QGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKaWYgKHNvdXJjZUV2ZW50ID09PSAnYXNrJyB8fCAKICAgIHNvdXJjZUV2ZW50ID09PSAncGFzdGUnIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdib290JyB8fCAKICAgIHNvdXJjZUV2ZW50ID09PSAnZmlsZV91cGxvYWQnIHx8CiAgICBzb3VyY2VFdmVudCA9PT0gJ3Rvb2wnIHx8CiAgICBzb3VyY2VFdmVudCA9PT0gJ2NyZWF0ZV9hcnRpZmFjdF9wcm9taXNlJwopIHsKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGUgYm90cyBiZWluZyBhZGRlZCBhcmUgYXJ0aWZhY3Qgc2hhcmRzIHRoYXQgbmVlZHMgdG8gYmUgcmVjb25zdGl0dXRlZC4KICAgIGNvbnN0IGFydGlmYWN0c1RvUmVjb25zdGl0dXRlOiBSZWNvcmQ8c3RyaW5nLCBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnPiA9IHt9OyAvLyBLZXkgaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMoKTsKICAgIGNvbnN0IGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVGhpcyBzZXQgdHJhY2tzIGFydGlmYWN0IGlkcyB0aGF0IGFyZSBhbHJlYWR5IHF1ZXVlZCB0byBiZSByZWNvbnN0aXR1dGVkIHdpdGggYSBuZXcgaW5zdGFuY2UgaWQuCiAgICBjb25zdCBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZDogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7IC8vIFRyYWNrIG9yaWdpbmFsIGluc3RhbmNlIElEcyB0aGF0IHdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBnaXZlIG5ldyBpbnN0YW5jZXMKCiAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgaWYgKGRhdGEgJiYKICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICAgICAgICAgICFkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZT8uc3RhcnRzV2l0aCgn8J+nrCcpCiAgICAgICAgKSB7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBzdHJpbmcgPSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBKU09OLnBhcnNlKGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlLnN1YnN0cmluZygyKSk7CgogICAgICAgICAgICBpZiAoYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgICAgIC8vIFNoYXJkIGhhcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgaWYgKGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXNbYWJBcnRpZmFjdEluc3RhbmNlSURdICYmICFvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAxOiBJbnN0YW5jZSBhbHJlYWR5IGV4aXN0cyAtIGNyZWF0ZSBuZXcgaW5zdGFuY2UgKGZpcnN0IHRpbWUgd2Ugc2VlIHRoaXMgY29sbGlzaW9uKQogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzOiBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsgLy8gVHJhY2sgdGhhdCB3ZSdyZSBjcmVhdGluZyBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBhcnRpZmFjdCBJRAogICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7IC8vIFRyYWNrIHRoYXQgd2UndmUgZGVjaWRlZCB0byByZXBsYWNlIHRoaXMgb3JpZ2luYWwgaW5zdGFuY2UgSUQKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDE6IFNoYXJkIGZyb20gZXhpc3RpbmcgaW5zdGFuY2UuIENyZWF0aW5nIG5ldyBpbnN0YW5jZS4gKG9sZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0sIG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMWI6IFdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2UgZm9yIHRoaXMgb3JpZ2luYWwgSUQgLSBhZGQgdGhpcyBzaGFyZCB0byB0aGF0IG5ldyBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAxYjogQWRkaXRpb25hbCBzaGFyZCBmb3IgcmVwbGFjZWQgaW5zdGFuY2UuIERpc3Bvc2luZy4gKG9yaWdpbmFsOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAyOiBJbnN0YW5jZSBhbHJlYWR5IHF1ZXVlZCBmb3IgcmVjb25zdGl0dXRpb24gLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAyOiBEdXBsaWNhdGUgc2hhcmQgZm9yIHF1ZXVlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAoYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAzOiBJbnN0YW5jZSB0byByZWNvbnN0aXR1dGUgd2l0aCBleGlzdGluZyBJRAogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMzogSW5zdGFuY2UgdG8gcmVjb25zdGl0dXRlLiAoYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFNoYXJkIGhhcyBubyBhcnRpZmFjdCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgaWYgKGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmhhcyhhYkFydGlmYWN0QnVuZGxlLmlkKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgNDogQXJ0aWZhY3QgYWxyZWFkeSBoYXMgbmV3IGluc3RhbmNlIHF1ZXVlZCAtIGRpc3Bvc2UgZHVwbGljYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDQ6IER1cGxpY2F0ZSBzaGFyZCBmb3IgYXJ0aWZhY3Qgd2l0aCBuZXcgaW5zdGFuY2UgcXVldWVkLiBEaXNwb3NpbmcuIChhcnRpZmFjdElkOiAke2FiQXJ0aWZhY3RCdW5kbGUuaWR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSA1OiBDcmVhdGUgbmV3IGluc3RhbmNlIGZvciBhcnRpZmFjdCB3aXRob3V0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW25ld0FydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBuZXdBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5hZGQoYWJBcnRpZmFjdEJ1bmRsZS5pZCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSA1OiBDcmVhdGluZyBuZXcgaW5zdGFuY2UgZm9yIGFydGlmYWN0IHdpdGhvdXQgaW5zdGFuY2UgSUQuIChuZXc6ICR7bmV3QXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBUaGlzIGlzIG5vdCBhIHNoYXJkIGJvdC4gSWdub3JlIGl0LgogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGU6YCwgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlczpgLCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlOmAsIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkOmAsIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkKTsKICAgIH0KCiAgICBmb3IgKGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlKSB7CiAgICAgICAgY29uc3QgcmVjb25zdGl0dXRlQXJnOiBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnID0gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdOwogICAgICAgIAogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gUmVjb25zdGl0dXRpbmcgYXJ0aWZhY3QgaW5zdGFuY2U6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZShyZWNvbnN0aXR1dGVBcmcpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgaWYgKHNvdXJjZUV2ZW50ID09PSAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgICAgICAgIC8vIERvIGEgc3BlY2lhbCBzaG91dCBzbyB0aGF0IHRoZSBjcmVhdGUgYXJ0aWZhY3QgcHJvbWlzZSBmdW5jdGlvbiBjYW4gY2F0Y2ggdGhpcyBlcnJvci4KICAgICAgICAgICAgICAgIGNvbnN0IGZhaWx1cmVSZXN1bHQgPSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JDb2RlOiAnYXJ0aWZhY3RfcHJvbWlzZV9yZWNvbnN0aXR1dGlvbl9mYWlsZWQnLAogICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZTogYFJlY29uc3RpdHV0aW9uIGZyb20gYXJ0aWZhY3QgcHJvbWlzZSBoYXMgZmFpbGVkLiBDYXVnaHQgZXJyb3I6ICR7bGlua3MudXRpbHMuZ2V0RXJyb3JNZXNzYWdlKGUpfWAsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0QnVuZGxlLm5hbWUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IHJlY29uc3RpdHV0ZUFyZy5hYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRFByZXZpb3VzOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cywKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiByZWNvbnN0aXR1dGVBcmcuYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgc2hvdXQoJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkJywgZmFpbHVyZVJlc3VsdCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgfQp9JwDEtf3sCc6iBBtvbkFCUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gCBADEtf3sCb/lBdwOQGlmICghdGhpc0JvdC5pc1JlY29uc3RpdHV0aW9uRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGJvdERhdGEsIGFiLCBwdWJsaWNGYWNpbmcsIHN0dWRpbywgc291cmNlRXZlbnQgfSA9IHRoYXQ7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHsuLi50aGF0fSk7Cn0KCi8vIERldGVjdCBhcnRpZmFjdCBpbnN0YW5jZXMgdGhhdCBuZWVkIHRvIGJlIGNvbnZlcnRlZCBpbnRvIGFydGlmYWN0IHByb21pc2VzLgoKLyoqIGtleTogYXJ0aWZhY3QgaW5zdGFuY2UgaWQsIHZhbHVlOiBhcnRpZmFjdCBwcm9taXNlIGRhdGEuICovCmNvbnN0IGFydGlmYWN0SW5zdGFuY2VzV2l0aFByb21pc2UgPSBuZXcgU2V0KCk7IC8vIEtlZXAgdHJhY2sgb2Ygd2hhdCBhcnRpZmFjdCBpbnN0YW5jZSBJRHMgaGF2ZSBoYWQgYW4gYXJ0aWZhY3QgcHJvbWlzZSBtYWRlLgoKZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIC8vIFRoaXMgaXMgYW4gYXJ0aWZhY3QgaW5zdGFuY2Ugc2hhcmQgYm90LgogICAgICAgIGlmICghYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZS5oYXMoZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICAvLyBUaGlzIGFydGlmYWN0IGluc3RhbmNlIG5lZWRzIGFuIGFydGlmYWN0IHByb21pc2UgbWFkZSBmb3IgaXQuCiAgICAgICAgICAgIGNvbnN0IHByb21pc2VJZCA9IHV1aWQoKTsKCiAgICAgICAgICAgIGJvdERhdGFbcHJvbWlzZUlkXSA9IHsKICAgICAgICAgICAgICAgIGlkOiBwcm9taXNlSWQsCiAgICAgICAgICAgICAgICBzcGFjZTogJ3NoYXJlZCcsCiAgICAgICAgICAgICAgICB0YWdzOiB7CiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdE5hbWU6IGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGU6IGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RQcm9taXNlOiB0cnVlLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDb252ZXJ0ZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHtkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9IGludG8gYW4gYXJ0aWZhY3QgcHJvbWlzZTpgLCBib3REYXRhW3Byb21pc2VJZF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmFkZChkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpOwogICAgICAgIH0KCiAgICAgICAgLy8gUmVtb3ZlIGFydGlmYWN0IGluc3RhbmNlIHNoYXJkIGJvdCBmcm9tIGJvdERhdGEgdGhhdCBpcyBhYm91dCB0byBiZSBwdWJsaXNoZWQuCiAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZmluaXNoZWQgYm90RGF0YTpgLCB7Li4uYm90RGF0YX0pOwp9JwDEtf3sCc6iBBZhYkdldEFydGlmYWN0SW5zdGFuY2VzAgQAxLX97Amc9AXKB0Bjb25zdCB7IAogICAgYm90cywKICAgIGFiQXJ0aWZhY3ROYW1lLAp9ID0gdGhhdCA/PyB7fQoKaWYgKGJvdHMpIHsKICAgIGFzc2VydChBcnJheS5pc0FycmF5KGJvdHMpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgbXVzdCBiZSBhbiBhcnJheS5gKTsKfQoKY29uc3QgaW5zdGFuY2VzOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB7fSAvLyBLZXkgaXMgYXJ0aWZhY3QgaW5zdGFuY2UgaWQuCgpmdW5jdGlvbiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShib3QpIHsKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiBib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBib3QudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBsZXQgYm90QXJyYXkgPSBpbnN0YW5jZXNbYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgICAgICBpZiAoIWJvdEFycmF5KSB7CiAgICAgICAgICAgIGJvdEFycmF5ID0gW107CiAgICAgICAgICAgIGluc3RhbmNlc1tib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRF0gPSBib3RBcnJheTsKICAgICAgICB9CgogICAgICAgIGJvdEFycmF5LnB1c2goYm90KTsKICAgIH0KfQoKaWYgKGJvdHMpIHsKICAgIC8vIEdldCBhcnRpZmFjdCBpbnN0YW5jZXMgaW4gcHJvdmlkZWQgbGlzdCBvZiBib3RzLgogICAgYm90cy5mb3JFYWNoKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYikpOwp9IGVsc2UgewogICAgLy8gR2V0IGFydGlmYWN0IGluc3RhbmNlcyBpbiBpbnN0LgogICAgZ2V0Qm90cyhiID0+IHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGIpKTsKfQoKcmV0dXJuIGluc3RhbmNlczsnAMS1/ewJzqIEFWFiR2V0QXJ0aWZhY3RQYXR0ZXJucwIEAMS1/ewJ5/sF8wdAY29uc3QgeyAKICAgIGJvdHMsCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge30KCmlmIChib3RzKSB7CiAgICBhc3NlcnQoQXJyYXkuaXNBcnJheShib3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIG11c3QgYmUgYW4gYXJyYXkuYCk7Cn0KCmNvbnN0IHBhdHRlcm5zOiBSZWNvcmQ8c3RyaW5nLCBCb3RbXT4gPSB7fSAvLyBLZXkgaXMgYXJ0aWZhY3QgbmFtZS4KCmZ1bmN0aW9uIHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYm90KSB7CiAgICAvLyBQYXR0ZXJuIGJvdHMgaGF2ZSBhYkFydGlmYWN0TmFtZSBidXQgbm8gYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiAhYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbGV0IGJvdEFycmF5ID0gcGF0dGVybnNbYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWVdOwoKICAgICAgICBpZiAoIWJvdEFycmF5KSB7CiAgICAgICAgICAgIGJvdEFycmF5ID0gW107CiAgICAgICAgICAgIHBhdHRlcm5zW2JvdC50YWdzLmFiQXJ0aWZhY3ROYW1lXSA9IGJvdEFycmF5OwogICAgICAgIH0KCiAgICAgICAgYm90QXJyYXkucHVzaChib3QpOwogICAgfQp9CgppZiAoYm90cykgewogICAgLy8gR2V0IGFydGlmYWN0IHBhdHRlcm5zIGluIHByb3ZpZGVkIGxpc3Qgb2YgYm90cy4KICAgIGJvdHMuZm9yRWFjaChiID0+IHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYikpOwp9IGVsc2UgewogICAgLy8gR2V0IGFydGlmYWN0IHBhdHRlcm5zIGluIGluc3QuCiAgICBnZXRCb3RzKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihiKSk7Cn0KCnJldHVybiBwYXR0ZXJuczsnAMS1/ewJzqIEGGFiUHVibGlzaEFydGlmYWN0UGF0dGVybgIEAMS1/ewJ24MG+gVAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzdHVkaW8sCiAgICBzaGFyZEJvdHMsCiAgICBtYW51YWxQdWJsaXNoLAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdE5hbWUgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KHR5cGVvZiBzdHVkaW8gPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHN0dWRpbyBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiUHVibGlzaEFCKHsKICAgIGFiOiBhYkFydGlmYWN0TmFtZSwgCiAgICB0YXJnZXQ6IHNoYXJkQm90cywgCiAgICBzdHVkaW8sCiAgICBtYW51YWxQdWJsaXNoLAogICAgc291cmNlRXZlbnQ6ICdwdWJsaXNoX2FydGlmYWN0X3BhdHRlcm4nLAogICAgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaDogKGFyZykgPT4gewogICAgICAgIHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAMS1/ewJzqIEJmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhAgQAxLX97AnWiQbmBkBjb25zdCBib3REYXRhID0gdGhhdDsKCmFzc2VydChsaW5rcy51dGlscy5pc09iamVjdChib3REYXRhKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmd1bWVudCBtdXN0IGJlIGFuIG9iamVjdC5gKTsKCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CiAgICAKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdEJvdCA9PT0gdHJ1ZSkgewogICAgICAgIC8vIFJlbW92ZSBhcnRpZmFjdCBib3RzLgogICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgCiAgICB9IGVsc2UgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIC8vIFN0cmlwIGFydGlmYWN0IGluc3RhbmNlIGRhdGEgZnJvbSBib3QuCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRJbnN0YW5jZUlEOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZDsKCiAgICAgICAgLy8gUmVtb3ZlIHNvbWUgb3RoZXJzLgogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuY3JlYXRvcjsKCiAgICAgICAgLy8gR2l2ZSBlYWNoIGJvdCBhIGNoYW5jZSB0byBzdHJpcCBpbnN0YW5jZSBkYXRhIGZyb20gdGhlIGNvcHkgb2YgaXRzIG93biBib3QgZGF0YS4KICAgICAgICBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQod2hpc3BlcihkYXRhLmlkLCAnb25BQlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YScsIHsgZGF0YSB9KSk7CiAgICB9Cn0KICAgICcAxLX97AnOogQPaXNFZ2dEZXBlbmRlbmN5AgQAxLX97Am9kAZSQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hYklEKSAmJiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5yZWNvcmRLZXkpOycAxLX97AnOogQPaXNBc2tEZXBlbmRlbmN5AgQAxLX97AmQkQYqQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hc2tJRCk7JwDEtf3sCc6iBBBvbkFueUJvdHNDaGFuZ2VkAgQAxLX97Am7kQbJCEAvLyBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cgpmb3IgKGNvbnN0IGNoYW5nZWQgb2YgdGhhdCkgewogICAgaWYgKGNoYW5nZWQgPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIC8vIDEpIG9ubHkgY2FyZSBhYm91dCBib3RzIHdpdGggYXJ0aWZhY3QgdGFncwogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lIHx8ICFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSBjb250aW51ZTsKCiAgICAvLyAyKSBhcnRpZmFjdCBtdXN0IGJlIHJlY29uc3RpdHV0ZWQuCiAgICBpZiAoIWNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCkgY29udGludWU7CgogICAgaWYgKHRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGFuZ2VzIG9uIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gZGV0ZWN0ZWQsIGNhbGxpbmcgdG8gdXBkYXRlIGV4cGVyaWVuY2UuYCwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgY2hhbmdlZEJvdElkOiBjaGFuZ2VkLmJvdC5pZCwKICAgICAgICAgICAgICAgIGNoYW5nZWRUYWdzOiBjaGFuZ2VkLnRhZ3MsCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0IGluc3RhbmNlICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gY2hhbmdlZCBidXQgZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KJwDEtf3sCc6iBBlleHBlcmllbmNlVGlja1JhdGVMaW1pdE1TAgQAxLX97AmFmgYENTAwMCcAxLX97AnOogQWY29sbGVjdFNoYXJkc0xpc3RlblRhZwIEAMS1/ewJipoGGW9uQUJBcnRpZmFjdENvbGxlY3RTaGFyZHMnAMS1/ewJzqIECGRlYnVnRXhwAgQAxLX97AmkmgYFZmFsc2UnAMS1/ewJzqIEF2lzUmVjb25zdGl0dXRpb25FbmFibGVkAgQAxLX97AmqmgZ8QGlmIChjb25maWdCb3QudGFncy5hYkFydGlmYWN0UmVjb25zdGl0dXRpb24gPT09IGZhbHNlKSB7CiAgICByZXR1cm4gZmFsc2U7Cn0KCi8vIFJlY29uc3RpdHV0aW9uIG9uIGJ5IGRlZmF1bHQuCnJldHVybiB0cnVlOycAxLX97AnOogQXYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMCBADEtf3sCaebBtAYQGNvbnN0IHsgc2hhcmRCb3RzIH0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgcmVxdWlyZWQgdG8gYmUgYW4gYm90IGFycmF5LmApOwoKLyoqIEtlZXAgdHJhY2sgb2YgZGVwZW5kZW5jeSBoYXNoZXMuIFRoaXMgcHJldmVudHMgZHVwbGljYXRlcyBpbiB0aGUgYXJ0aWZhY3QgZGVwZW5kZW5jaWVzLiAqLwpjb25zdCBkZXBlbmRlbmN5SGFzaGVzID0gbmV3IFNldCgpOwoKbGV0IG1lcmdlZFNoYXJkOiBBQkFydGlmYWN0U2hhcmQgPSB7CiAgICBkYXRhOiB7fSwKICAgIGRlcGVuZGVuY2llczogW10sCn07Cgpmb3IgKGNvbnN0IHNoYXJkQm90IG9mIHNoYXJkQm90cykgewogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgY29uc3QgYm90U2hvcnRJZCA9IHNoYXJkQm90LmlkLnN1YnN0cmluZygwLCA1KTsKCiAgICBsZXQgc2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZDsKICAgIGlmIChzaGFyZEJvdC50YWdzW3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10pIHsKICAgICAgICBpZiAoc2hhcmRCb3RbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSkgewogICAgICAgICAgICBzaGFyZCA9IGF3YWl0IFByb21pc2UucmVzb2x2ZShzaGFyZEJvdFt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKCkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHRhZyBpcyBkZWZpbmVkIGJ1dCBpcyBub3QgYSB2YWxpZCBmdW5jdGlvbi5gIH07CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgc2hhcmQ6YCwgc2hhcmQpOwogICAgfQoKICAgIGlmIChzaGFyZCkgewogICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQpKSB7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCBtdXN0IGJlIGFuIG9iamVjdC5gIH07CiAgICAgICAgfQoKICAgICAgICBpZiAoc2hhcmQuZGF0YSkgewogICAgICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzT2JqZWN0KHNoYXJkLmRhdGEpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gc2hhcmQgJ2RhdGEnIHByb3BlcnR5IG11c3QgYmUgYW4gb2JqZWN0LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2hhbGxvdyBtZXJnZSBzaGFyZCdzIGRhdGEgcHJvcGVydGllcyBpbnRvIGNvbWJpbmVkIGFydGlmYWN0IGRhdGEuCiAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRhdGEgPSB7IC4uLm1lcmdlZFNoYXJkLmRhdGEsIC4uLnNoYXJkLmRhdGEgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc0FycmF5KHNoYXJkLmRlcGVuZGVuY2llcykpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCAnZGVwZW5kZW5jaWVzJyBwcm9wZXJ0eSBtdXN0IGJlIGFuIGFycmF5LmAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgdGhhdCBkZXBlbmRlbmN5IGlzIG9uZSBvZiB0aGUgc3VwcG9ydGVkIHR5cGVzLgogICAgICAgICAgICAgICAgaWYgKCF0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSAmJiAhdGhpc0JvdC5pc0Fza0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgcmVhc29uOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIGhhcyBhIGRlcGVuZGVuY3kgZW50cnkgdGhhdCBpcyBuZWl0aGVyIGFuIGVnZyBvciBhc2sgZGVwZW5kZW5jeSB0eXBlLmAgfTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBkZXBlbmRlbmN5IGlzbnQgYWxyZWFkeSBjb2xsZWN0ZWQuCiAgICAgICAgICAgICAgICBjb25zdCBoYXNoID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgZGVwZW5kZW5jeSk7CgogICAgICAgICAgICAgICAgaWYgKCFkZXBlbmRlbmN5SGFzaGVzLmhhcyhoYXNoKSkgewogICAgICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lIYXNoZXMuYWRkKGhhc2gpOwogICAgICAgICAgICAgICAgICAgIG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBNYWtlIHN1cmUgd2UgaGF2ZSBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeS4KaWYgKG1lcmdlZFNoYXJkLmRlcGVuZGVuY2llcy5sZW5ndGggPT09IDApIHsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIG11c3QgbGlzdCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeSBpbiBvcmRlciB0byByZWNvbnN0aXR1dGUgcHJvcGVybHkuYCB9Owp9Cgpjb25zdCByZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0ID0gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIHNoYXJkOiBtZXJnZWRTaGFyZCwKfQoKcmV0dXJuIHJlc3VsdDsnAMS1/ewJzqIEF2NhblVzZXJVcGRhdGVFeHBlcmllbmNlAgQAxLX97An4swbOCUBjb25zdCB7CiAgICByZW1vdGVJZCA9IGNvbmZpZ0JvdC5pZCwKICAgIHNoYXJkQm90Cn0gPSB0aGF0ID8/IHt9CgppZiAoc2hhcmRCb3QgJiYgCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmCiAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlECikgewogICAgLy8gTmVlZCB0byBmaWd1cmUgb3V0IGlmIHRoaXMgdXNlciBpcyBhbGxvd2VkIHRvIHVwZGF0ZSB0aGUgZXhwZXJpZW5jZSBvZiB0aGlzIGFydGlmYWN0IGluc3RhbmNlLgogICAgbGV0IGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKCiAgICBzd2l0Y2ggKHNoYXJkQm90LnNwYWNlKSB7CiAgICAgICAgY2FzZSAnc2hhcmVkJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgY2FzZSAndGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBiYXNpY2FsbHkgb3duZWQgYnkgdGhpcyB1c2VyLgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncmVtb3RlVGVtcFNoYXJlZCc6CiAgICAgICAgICAgIC8vIHJlbW90ZVRlbXBTaGFyZWQgc3BhY2UgbWVhbnMgdGhhdCB0aGlzIGJvdCBpcyBvd25lZCBieSBzb21lb25lIGVsc2UuCiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSBmYWxzZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnbG9jYWwnOgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAndGVtcExvY2FsJzoKICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgYm90IHNwYWNlOmAsIHNoYXJkQm90LnNwYWNlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgcmV0dXJuIGNhblVzZXJVcGRhdGU7Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHByb3ZpZGVkIHNoYXJkQm90IGRvZXMgbm90IGFwcGVhciB0byBiZSBmcm9tIGFuIGFydGlmYWN0IGluc3RhbmNlLmAsIHNoYXJkQm90KTsKICAgIH0KICAgIHJldHVybiBmYWxzZTsKfScAxLX97AnOogQaYWJDcmVhdGVBcnRpZmFjdFByb21pc2VCb3QCBADEtf3sCce9BvkTQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBhYkFydGlmYWN0U2hhcmQsCiAgICBzcGFjZSA9ICdzaGFyZWQnLAp9ID0gdGhhdCA/PyB7fTsKCgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RTaGFyZCAmJiBhYkFydGlmYWN0U2hhcmQuZGF0YSAmJiBhYkFydGlmYWN0U2hhcmQuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RTaGFyZCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQUJBcnRpZmFjdFNoYXJkLmApOwoKY29uc3QgYm90RGF0YSA9IFtdOwpjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0QnVuZGxlKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBhYkFydGlmYWN0U2hhcmQgfSk7CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBnZW5lcmF0ZWQgYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKYm90RGF0YVtwcm9taXNlSWRdID0gewogICAgaWQ6IHByb21pc2VJZCwKICAgIHNwYWNlLAogICAgdGFnczogewogICAgICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgIGFiQXJ0aWZhY3RCdW5kbGU6ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpLAogICAgICAgIGFiQXJ0aWZhY3RQcm9taXNlOiB0cnVlLAogICAgfQp9CgovLyBDcmVhdGUgYXJ0aWZhY3QgcHJvbWlzZSB0aHJvdWdoIGFiQ3JlYXRlQm90cy4gCi8vIFRoaXMgd2lsbCB0cmlnZ2VyIGFydGlmYWN0J3Mgb25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUgYW5kIGl0IHdpbGwgZmluZAovLyB0aGlzIGFydGlmYWN0IHByb21pc2UgYW5kIHVzZSB0aGUgZGF0YSB0byByZWNvbnN0aXR1dGUgaXQuCmxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3REYXRhLCBzb3VyY2VFdmVudDogJ2NyZWF0ZV9hcnRpZmFjdF9wcm9taXNlJyB9KTsKCmNvbnN0IHdhaXRGb3JSZWNvbnN0aXR1dGlvbiA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgIGZ1bmN0aW9uIGNsZWFudXAoKSB7CiAgICAgICAgb3MucmVtb3ZlQm90TGlzdGVuZXIodGhpc0JvdCwgJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCk7CiAgICAgICAgb3MucmVtb3ZlQm90TGlzdGVuZXIodGhpc0JvdCwgJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkJywgaGFuZGxlQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0aW9uRmFpbGVkKTsKICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZChsaXN0ZW5lclRoYXQpIHsKICAgICAgICBpZiAobGlzdGVuZXJUaGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRCB8fAogICAgICAgICAgICBsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cyA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgICAgICApIHsKICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICByZXNvbHZlKGxpc3RlbmVyVGhhdCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGhhbmRsZUFueUFCQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbkZhaWxlZChsaXN0ZW5lclRoYXQpIHsKICAgICAgICBpZiAobGlzdGVuZXJUaGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSBhYkFydGlmYWN0SW5zdGFuY2VJRCB8fAogICAgICAgICAgICBsaXN0ZW5lclRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSURQcmV2aW91cyA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgICAgICApIHsKICAgICAgICAgICAgY2xlYW51cCgpOwogICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGxpc3RlbmVyVGhhdC5lcnJvck1lc3NhZ2UpKTsKICAgICAgICB9CiAgICB9CgogICAgb3MuYWRkQm90TGlzdGVuZXIodGhpc0JvdCwgJ29uQW55QUJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCk7CiAgICBvcy5hZGRCb3RMaXN0ZW5lcih0aGlzQm90LCAnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQnLCBoYW5kbGVBbnlBQkFydGlmYWN0UmVjb25zdGl0dXRpb25GYWlsZWQpOwp9KQoKY29uc3QgcmVjb25zdGl0dXRlUmVzdWx0ID0gYXdhaXQgd2FpdEZvclJlY29uc3RpdHV0aW9uOwoKcmV0dXJuIHJlY29uc3RpdHV0ZVJlc3VsdC5zaGFyZEJvdHM7JwDEtf3sCc6iBBZhYkNyZWF0ZUFydGlmYWN0QnVuZGxlAgQAxLX97Am/0QaZCEBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RTaGFyZCwKfSA9IHRoYXQ7Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydChhYkFydGlmYWN0U2hhcmQgJiYgYWJBcnRpZmFjdFNoYXJkLmRhdGEgJiYgYWJBcnRpZmFjdFNoYXJkLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0U2hhcmQgaXMgYSByZXF1aXJlZCB0byBiZSBhIEFCQXJ0aWZhY3RTaGFyZC5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSB7CiAgICBuYW1lOiBhYkFydGlmYWN0TmFtZSwKICAgIGZvcm1hdFZlcnNpb246IDEsCiAgICBkYXRhOiBhYkFydGlmYWN0U2hhcmQuZGF0YSwKICAgIGRlcGVuZGVuY2llczogYWJBcnRpZmFjdFNoYXJkLmRlcGVuZGVuY2llcywKfQoKLy8gR2VuZXJhdGUgdGhlIGFydGlmYWN0IGlkLCB3aGljaCBpcyBzaGEyNTYgaGFzaCBvZiB0aGUgY29yZSBjb250ZW50cyBvZiB0aGUgYXJ0aWZhY3QuCmFiQXJ0aWZhY3RCdW5kbGUuaWQgPSBjcnlwdG8uc2hhMjU2KGFiQXJ0aWZhY3RCdW5kbGUpOwoKLy8gU3RvcmUgc29tZSBleHRyYSBtZXRhZGF0YSBwcm9wZXJ0aWVzIHdpdGggdGhlIGFydGlmYWN0LgovLyBUaGVzZSBhcmUgbm90IGNvcmUgdG8gdGhlIGFydGlmYWN0J3MgZnVuY3Rpb25hbGl0eSBidXQgbWF5IGJlIHVzZWZ1bCBhcyBhcnRpZmFjdHMgZXZvbHZlLgphYkFydGlmYWN0QnVuZGxlLmNhc3VhbE9TVmVyc2lvbiA9IG9zLnZlcnNpb24oKTsKYWJBcnRpZmFjdEJ1bmRsZS5jcmVhdGVkVGltZXN0YW1wID0gRGF0ZVRpbWUubm93KCkudG9JU08oKTsKYWJBcnRpZmFjdEJ1bmRsZS5hYlNoZWxsVmVyc2lvbiA9IGAke2xpbmtzLnZlcnNpb24ucmF3LmFiU2hlbGxNYWpvclZlcnNpb259LiR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1pbm9yVmVyc2lvbn1gOwoKcmV0dXJuIGFiQXJ0aWZhY3RCdW5kbGU7JwDEtf3sCc6iBAZjcmVhdGUCBADEtf3sCdnZBijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwDEtf3sCc6iBBNpc0V4cGVyaWVuY2VFbmFibGVkAgQAxLX97AmA2gZ0QGlmIChjb25maWdCb3QudGFncy5hYkFydGlmYWN0RXhwZXJpZW5jZSA9PT0gdHJ1ZSkgewogICAgcmV0dXJuIHRydWU7Cn0KCi8vIEV4cGVyaWVuY2Ugb2ZmIGJ5IGRlZmF1bHQuCnJldHVybiBmYWxzZTsnAMS1/ewJzqIEHmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudAIEAMS1/ewJ9doG3BtAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MgPSB7fTsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYWxyZWFkeSBoYXMgYSBkb2N1bWVudCBsb2FkZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmxldCBleHBlcmllbmNlQXV0aDogQUJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoID0gYXdhaXQgdGhpc0JvdC5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGgoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCmlmICghZXhwZXJpZW5jZUF1dGguYXV0aG9yaXplZCkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIEFydGlmYWN0IGV4cGVyaWVuY2Ugd2FzIG5vdCBhdXRob3JpemVkLiBSZWFzb246ICR7ZXhwZXJpZW5jZUF1dGguZmFpbHVyZVJlYXNvbn1gKTsKICAgIHJldHVybjsKfQoKLy8gR2V0IHRoZSBhcnRpZmFjdCBpbnN0YW5jZSdzIHNoYXJlZCBkb2N1bWVudCBhcyB3ZWxsIGFzIHRoZSBleHBlcmllbmNlIG1hcC4KY29uc3QgZG9jdW1lbnQgPSBhd2FpdCBvcy5nZXRTaGFyZWREb2N1bWVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSwgYGFydGlmYWN0SW5zdGFuY2VfJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gLCAnbWFpbicpOwpjb25zdCBleHBlcmllbmNlTWFwID0gZG9jdW1lbnQuZ2V0TWFwKCdleHBlcmllbmNlJyk7Cgpjb25zdCBza2lwS2V5cyA9IG5ldyBTZXQoWwogICAgJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnLAogICAgLy8gQWRkIG1vcmUga2V5cyBoZXJlIGlmIG5lZWRlZAogICAgLy8gJ3NvbWVPdGhlcktleScsCiAgICAvLyAneWV0QW5vdGhlcktleScKXSk7Cgpjb25zdCBleHBlcmllbmNlU3ViID0gZXhwZXJpZW5jZU1hcC5kZWVwQ2hhbmdlcy5zdWJzY3JpYmUoKGV2ZW50cykgPT4gewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9uIGRlZXAgY2hhbmdlczpgLCBldmVudHMpOwogICAgfQoKICAgIC8vIENvbGxlY3QgYWxsIGNoYW5nZWQga2V5cwogICAgY29uc3QgYWxsS2V5cyA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZXZ0IG9mIGV2ZW50cyA/PyBbXSkgewogICAgICAgIGNvbnN0IG0gPSBldnQ/LmNoYW5nZXM7CiAgICAgICAgaWYgKG0gJiYgdHlwZW9mIG0ua2V5cyA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBmb3IgKGNvbnN0IGsgb2YgbS5rZXlzKCkpIHsKICAgICAgICAgICAgICAgIGFsbEtleXMuYWRkKGspOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIC8vIFNraXAgaWYgKmFsbCogY2hhbmdlcyBhcmUgaW5zaWRlIHRoZSBza2lwIGxpc3QKICAgIGNvbnN0IHNob3VsZFNraXAgPSBhbGxLZXlzLnNpemUgPiAwICYmIFsuLi5hbGxLZXlzXS5ldmVyeSgoaykgPT4gc2tpcEtleXMuaGFzKGspKTsKICAgIGlmIChzaG91bGRTa2lwKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBza2lwcGluZyBjYWxsIHRvIGFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlLCB0aGUgb25seSBjaGFuZ2UgdG8gdGhlIGV4cGVyaWVuY2Ugd2VyZSBzcGVjaWFsIHJlc2VydmVkIHByb3BlcnRpZXMuYCk7CiAgICAgICAgfQogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0pOwoKdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gPSB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3VifTsKCmlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGluc3RhbmNlIGRvY3VtZW50IGxvYWRlZDpgLCB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSk7CgogICAgY29uc3QgZXhwZXJpZW5jZUpTT04gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV4cGVyaWVuY2VNYXAudG9KU09OKCkpKTsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gbG9hZGVkIGV4cGVyaWVuY2UgbWFwIHN0YXRlOmAsIGV4cGVyaWVuY2VKU09OKTsKfQoKY29uc3QgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9IGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJyk7CgppZiAoYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCA9PT0gdHJ1ZSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0aW5nIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGZyb20gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEltbWVkaWF0ZWx5IGdpdmUgdGhlIHNoYXJkIGJvdHMgdGhlIGN1cnJlbnQgZXhwZXJpZW5jZSBzdGF0ZS4KICAgIGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBpbml0aWFsaXppbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZXhwZXJpZW5jZS5gKTsKICAgIH0KICAgIC8vIEluaXRpYWxpemUgdGhlIGV4cGVyaWVuY2Ugc3RhdGUgd2l0aCB0aGUgY3VycmVudCBzaGFyZCBkYXRhLgogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7ICAgIAp9CicAxLX97AnOogQgYWJVbmxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQCBADEtf3sCdL2BokGQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IHsgZG9jdW1lbnQsIGV4cGVyaWVuY2VNYXAsIGV4cGVyaWVuY2VTdWIgfSA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOyAKCiAgICBpZiAoZXhwZXJpZW5jZVN1YikgewogICAgICAgIGV4cGVyaWVuY2VTdWIudW5zdWJzY3JpYmUoKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1bnN1YnNjcmliZWQgZnJvbSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBleHBlcmllbmNlIG1hcC5gKTsKICAgICAgICB9CiAgICB9CgogICAgZGVsZXRlIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZW1vdmVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGRvY3VtZW50LmApOwogICAgfQp9JwDEtf3sCc6iBB5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMCBADEtf3sCdz8BrQCQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgIHJldHVybiBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09IGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0pOwoKcmV0dXJuIHNoYXJkQm90czsnAMS1/ewJzqIEJmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUZyb21FeHBlcmllbmNlAgQAxLX97AmR/wbpB0Bjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICByZXR1cm47Cn0KCmlmICh0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzKSB7CiAgICBjb25zdCBpbnN0YW5jZURvYyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdOwoKICAgIGlmIChpbnN0YW5jZURvYykgewogICAgICAgIGNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUR9KTsKCiAgICAgICAgY29uc3QgeyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1YiB9ID0gaW5zdGFuY2VEb2M7CgogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VEYXRhID0gZXhwZXJpZW5jZU1hcC50b0pTT04oKTsKCiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSB3aXRoIGV4cGVyaWVuY2Ugc3RhdGU6YCwgSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlRGF0YSkpKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHdoaXNwZXIoc2hhcmRCb3RzLCAnb25BQkFydGlmYWN0RXhwZXJpZW5jZScsIHsgZGF0YTogZXhwZXJpZW5jZURhdGEgfSkpOwogICAgfQp9JwDEtf3sCc6iBCJhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlAgQAxLX97An7hgfQKEBpbXBvcnQgeyBTaGFyZWRNYXAgfSBmcm9tICdjYXN1YWxvcyc7Cgpjb25zdCB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge30KCmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmlmICghdGhpc0JvdC5pc0V4cGVyaWVuY2VFbmFibGVkKCkpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgIH0KICAgIHJldHVybjsKfQoKaWYgKCF0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMpIHsKICAgIHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcyA9IG5ldyBTZXQoKTsKfQoKaWYgKHRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5oYXMoYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSB1cGRhdGUgaXMgYWxyZWFkeSBpbiBwcm9ncmVzcyBmb3IgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgIH0KICAgIHJldHVybjsKfQoKdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgY29uc3QgaW5zdGFuY2VEb2MgPSB0aGlzQm90LnZhcnMuaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICBpZiAoaW5zdGFuY2VEb2MpIHsKICAgICAgICBjb25zdCBzaGFyZEJvdHMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cyh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwoKICAgICAgICAvLyBOZWVkIHRvIGFzayBpZiB0aGlzIHVzZXIgaXMgYWxsb3dlZCB0byB1cGRhdGUgdGhlIGV4cGVyaWVuY2Ugb2YgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZS4KICAgICAgICBjb25zdCBjYW5Vc2VyVXBkYXRlID0gYXdhaXQgdGhpc0JvdC5jYW5Vc2VyVXBkYXRlRXhwZXJpZW5jZSh7IHJlbW90ZUlkOiBjb25maWdCb3QuaWQsIHNoYXJkQm90OiBzaGFyZEJvdHNbMF0gfSk7CgogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2FuIHVzZXIgdXBkYXRlIGV4cGVyaWVuY2UgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7c2hhcmRCb3RzWzBdLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQuc3Vic3RyaW5nKDAsIDcpfT9gLCBjYW5Vc2VyVXBkYXRlKTsKICAgICAgICB9CgogICAgICAgIGlmIChjYW5Vc2VyVXBkYXRlKSB7CiAgICAgICAgICAgIGxldCBjb2xsZWN0U2hhcmRSZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0OwoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbGxlY3RTaGFyZFJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMoeyBzaGFyZEJvdHMgfSk7CgogICAgICAgICAgICAgICAgaWYgKCFjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoY29sbGVjdFNoYXJkUmVzdWx0LnJlYXNvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOmAsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCBgY29sbGVjdFNoYXJkUmVzdWx0OmAsIEpTT04uc3RyaW5naWZ5KGNvbGxlY3RTaGFyZFJlc3VsdCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoY29sbGVjdFNoYXJkUmVzdWx0ICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAvLyBPbmx5IHVwZGF0ZSBlbnRyeSBpbiBleHBlcmllbmNlTWFwIGlmIHRoZSBkYXRhIGlzIGFjdHVhbGx5IGRpZmZlcmVudC4KICAgICAgICAgICAgICAgIGNvbnN0IGV4cGVyaWVuY2VNYXA6IFNoYXJlZE1hcCA9IGluc3RhbmNlRG9jLmV4cGVyaWVuY2VNYXA7CgogICAgICAgICAgICAgICAgLy8gU2FmZXR5OiBzaGFyZCBkYXRhIG1pZ2h0IGJlIHVuZGVmaW5lZC9udWxsCiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGEgPSAoY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkICYmIGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhKSA/IGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZC5kYXRhIDoge307CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZERhdGFLZXlzID0gT2JqZWN0LmtleXMoc2hhcmREYXRhKTsKICAgICAgICAgICAgICAgIGNvbnN0IGtleXNUb0RlbGV0ZSA9IFtdOwoKICAgICAgICAgICAgICAgIC8vIFNpbXBsZSBkZWVwLWVxdWFsaXR5IGNoZWNrIGZvciBKU09OLXNlcmlhbGl6YWJsZSB2YWx1ZXMKICAgICAgICAgICAgICAgIGNvbnN0IGlzRXF1YWwgPSAoYSwgYikgPT4gewogICAgICAgICAgICAgICAgICAgIGlmIChhID09PSBiKSByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoYSkgPT09IEpTT04uc3RyaW5naWZ5KGIpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAvLyAxKSBVcHNlcnQgb25seSB3aGVuIGRpZmZlcmVudAogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2Ygc2hhcmREYXRhS2V5cykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld1ZhbCA9IHNoYXJkRGF0YVtrZXldOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbCA9IGV4cGVyaWVuY2VNYXAuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0VxdWFsKG9sZFZhbCwgbmV3VmFsKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB1cGRhdGluZyBleHBlcmllbmNlTWFwIGtleSAiJHtrZXl9ImAsIEpTT04uc3RyaW5naWZ5KHsgb2xkVmFsLCBuZXdWYWwgfSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KGtleSwgbmV3VmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gMikgQ29sbGVjdCBrZXlzIHRoYXQgZXhpc3QgaW4gdGhlIG1hcCBidXQgbm90IGluIHRoZSBzaGFyZCBkYXRhCiAgICAgICAgICAgICAgICAvLyAgICAod2UgYXZvaWQgbXV0YXRpbmcgdGhlIG1hcCB3aGlsZSBpdGVyYXRpbmcgaXQpCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBleHBlcmllbmNlTWFwLmtleXMoKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChrZXkgPT09ICdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBEb24ndCBkZWxldGUgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZC4gSXRzIGEgc3BlY2lhbCBwcm9wZXJ0eS4KICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICghc2hhcmREYXRhS2V5cy5pbmNsdWRlcyhrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleXNUb0RlbGV0ZS5wdXNoKGtleSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDMpIFJlbW92ZSBzdGFsZSBrZXlzCiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzVG9EZWxldGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRlbGV0aW5nIHN0YWxlIGV4cGVyaWVuY2VNYXAga2V5ICIke2tleX0iYCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuZGVsZXRlKGtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGV4cGVyaWVuY2VNYXAuZ2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJykgIT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGV4cGVyaWVuY2VNYXAuc2V0KCdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSBpbnN0YW5jZSBkb2N1bWVudCBub3QgbG9hZGVkLmApOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY2Fubm90IHVwZGF0ZSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBiZWNhdXNlIGluc3RhbmNlIGRvY3VtZW50cyBoYXZlIG5vdCBiZWVuIGluaXRpYWxpemVkLmApOwogICAgfQp9Cgp0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuZGVsZXRlKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsnAMS1/ewJzqIEDG9uSW5zdEpvaW5lZAIEAMS1/ewJzK8HgQNAbWFza3MuaW5zdEpvaW5lZCA9IHRydWU7Cgpjb25zdCBhcnRpZmFjdEluc3RhbmNlcyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwoKZm9yIChsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgaW4gYXJ0aWZhY3RJbnN0YW5jZXMpIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb2FkaW5nIGFydGlmYWN0IGluc3RhbmNlIGRvY3VtZW50IGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWApOwogICAgfQogICAgCiAgICB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9JwDEtf3sCc6iBA5vbkFueUJvdHNBZGRlZAIEAMS1/ewJzrIHwgRAaWYgKCFtYXNrcy5pbnN0Sm9pbmVkKSB7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFkZGVkQm90cyA9IHRoYXQuYm90czsKCmZvciAoY29uc3QgYm90IG9mIGFkZGVkQm90cykgewogICAgaWYgKGJvdCA9PSBudWxsKSB7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgYXdhaXQgb3Muc2xlZXAoMjUwKTsKCiAgICAgICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZGV0ZWN0ZWQgYWRkZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7Ym90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUR9LmApCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXNCb3QuYWJMb2FkQXJ0aWZhY3RJbnN0YW5jZURvY3VtZW50KHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgICAgIH0KICAgIH0KfScAxLX97AnOogQab25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQCBADEtf3sCZG3B94FQGxldCBhYkNvbW1hbmRzOiBBQkNvbW1hbmRzTWFuYWdlciA9IHRoYXQ7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3ByaW50YXJ0aWZhY3RleHBlcmllbmNlJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGluc3RhbmNlRG9jcyA9IHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3M7CgogICAgbGV0IGFsbEV4cGVyaWVuY2UgPSB7fTsKCiAgICBmb3IgKGxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBpbnN0YW5jZURvY3MpIHsKICAgICAgICBjb25zdCBleHBlcmllbmNlTWFwID0gaW5zdGFuY2VEb2NzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXS5leHBlcmllbmNlTWFwOwogICAgICAgIGNvbnN0IGV4cGVyaWVuY2VKU09OID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShleHBlcmllbmNlTWFwLnRvSlNPTigpKSk7CiAgICAgICAgYWxsRXhwZXJpZW5jZVthYkFydGlmYWN0SW5zdGFuY2VJRF0gPSBleHBlcmllbmNlSlNPTjsKICAgIH0KCiAgICBjb25zb2xlLmxvZyhgW3ByaW50YXJ0aWZhY3RleHBlcmllbmNlXSBBbGwgY3VycmVudCBhcnRpZmFjdCBpbnN0YW5jZSBleHBlcmllbmNlIHN0YXRlczpgLCBhbGxFeHBlcmllbmNlKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1ByaW50IGFsbCBjdXJyZW50bHkgbG9hZGVkIGFydGlmYWN0IGluc3RhbmNlIGV4cGVyaWVuY2Ugc3RhdGVzIHRvIHRoZSBjb25zb2xlLicsCiAgICB1c2FnZTogWycucHJpbnRhcnRpZmFjdGV4cGVyaWVuY2UnXQp9KTsnAMS1/ewJzqIEGGFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aAIEAMS1/ewJ8LwH3BJAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlECn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBleHBBdXRoUmVzdWx0OiBBQkFydGlmYWN0RXhwZXJpZW5jZUF1dGggPSB7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGF1dGhvcml6ZWQ6IHVuZGVmaW5lZCwKICAgIGZhaWx1cmVSZWFzb246IHVuZGVmaW5lZCwKfQoKaWYgKGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSkgewogICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSBhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkOwoKICAgIHJldHVybiBleHBBdXRoUmVzdWx0Owp9CgpsZXQgbXlBdXRoQm90ID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCmlmICghbXlBdXRoQm90KSB7CiAgICAvLyBOb3Qgc2lnbmVkIGluLCBuZWVkIHRvIHNpZ24gaW4gdG8gdXNlIGFydGlmYWN0IGV4cGVyaWVuY2UuCiAgICBsZXQgYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZSA9IGdsb2JhbFRoaXMuYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKCiAgICBpZiAoIWFiQXJ0aWZhY3RVc2VyQXV0aFByb21pc2UpIHsKICAgICAgICBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlID0gb3Muc2hvd0NvbmZpcm0oewogICAgICAgICAgICB0aXRsZTogJ1NpZ24gSW4gUmVxdWlyZWQnLAogICAgICAgICAgICBjb250ZW50OiAnVGhpcyBzZXJ2ZXIgaGFzIGFydGlmYWN0cyB0aGF0IHdvcmsgYmVzdCB3aGVuIHlvdeKAmXJlIHNpZ25lZCBpbi4gSWYgeW91IGNvbnRpbnVlIHdpdGhvdXQgc2lnbmluZyBpbiwgdGhlIGFydGlmYWN0cyBtYXkgbm90IHN0YXkgaW4gc3luYy4nLAogICAgICAgICAgICBjb25maXJtVGV4dDogJ1NpZ24gSW4nLAogICAgICAgICAgICBjYW5jZWxUZXh0OiAnQ29udGludWUgV2l0aG91dCcKICAgICAgICB9KTsKCiAgICAgICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0VXNlckF1dGhQcm9taXNlID0gYWJBcnRpZmFjdFVzZXJBdXRoUHJvbWlzZTsKICAgIH0KCiAgICBjb25zdCBjb25maXJtZWQgPSBhd2FpdCBhYkFydGlmYWN0VXNlckF1dGhQcm9taXNlOwogICAgZGVsZXRlIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZTsKCiAgICBpZiAoY29uZmlybWVkKSB7CiAgICAgICAgbXlBdXRoQm90ID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICAgICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfc2lnbl9pbic7CiAgICAgICAgZ2xvYmFsVGhpcy5hYkFydGlmYWN0RXhwZXJpZW5jZUF1dGhGYWlsdXJlID0gZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uOwogICAgICAgIAogICAgICAgIHJldHVybiBleHBBdXRoUmVzdWx0OwogICAgfQp9CgppZiAoIW15QXV0aEJvdCkgewogICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gZmFsc2U7CiAgICBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb24gPSAndW5rbm93bic7CiAgICBnbG9iYWxUaGlzLmFiQXJ0aWZhY3RFeHBlcmllbmNlQXV0aEZhaWx1cmUgPSBleHBBdXRoUmVzdWx0LmZhaWx1cmVSZWFzb247CgogICAgcmV0dXJuIGV4cEF1dGhSZXN1bHQ7Cn0KCi8vIGNvbnN0IGFkbWluUGVybWlzc2lvblJlc3VsdCA9IGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZSk7Ci8vIGNvbnNvbGUubG9nKGBhZG1pblBlcm1pc3Npb25SZXN1bHQ6YCwgYWRtaW5QZXJtaXNzaW9uUmVzdWx0KTsKCi8vIGlmIChhZG1pblBlcm1pc3Npb25SZXN1bHQuc3VjY2VzcykgewovLyAgICAgZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gdHJ1ZTsKCi8vICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKLy8gfSBlbHNlIHsKLy8gICAgIGV4cEF1dGhSZXN1bHQuYXV0aG9yaXplZCA9IGZhbHNlOwovLyAgICAgZXhwQXV0aFJlc3VsdC5mYWlsdXJlUmVhc29uID0gJ3VzZXJfZGVjbGluZWRfaW5zdF9wZXJtaXNzaW9uJzsKLy8gICAgIGdsb2JhbFRoaXMuYWJBcnRpZmFjdEV4cGVyaWVuY2VBdXRoRmFpbHVyZSA9IGV4cEF1dGhSZXN1bHQuZmFpbHVyZVJlYXNvbjsKCi8vICAgICByZXR1cm4gZXhwQXV0aFJlc3VsdDsKLy8gfQoKZXhwQXV0aFJlc3VsdC5hdXRob3JpemVkID0gdHJ1ZTsKCnJldHVybiBleHBBdXRoUmVzdWx0OycAxLX97AnOogQRb25BQkJlZm9yZVB1Ymxpc2gCBADEtf3sCcvPB4cEQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwDEtf3sCc6iBBJvbkFCQmVmb3JlRG93bmxvYWQCBADEtf3sCdPTB4cEQGlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0aGF0OmAsIHRoYXQpOwp9CgovLyBbSU1QT1JUQU5UIE5PVEVdIChTZXB0ZW1iZXIgNCwgMjAyNSk6IFRoaXMgaXMgYSB3b3JrYXJvdW5kIHVudGlsIHdlIGhhdmUgYWIgYXJ0aWZhY3QgZXhwZXJpZW5jZSBzdGF0ZSB3b3JraW5nLiBBcyBzb29uIGFzIGV4cGVyaWVuY2Ugc3RhdGUgaG9va2VkCi8vIHVwLCB0aGlzIHByb2Nlc3Mgc2hvdWxkIGJlIGVsaW1pbmF0ZWQgYmVjYXVzZSBpdCBjaGFuZ2VzIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSBpZCB3aGljaCBpcyBub3QgaWRlYWwgLSBidXQgaXMgc2VydmljYWJsZSB1bnRpbAovLyB0aGVuIGZvciB0aGUgbmVlZHMgd2UgaGF2ZSBub3cuCgovLyBOYWl2ZWx5IHVwZGF0ZSBhbGwgYXJ0aWZhY3Qgc2hhcmRzIGluIHRoaXMgaW5zdCBiZWZvcmUgYWIgcHVibGlzaGVzIGFuIGVnZy4KYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzKCk7JwDEtf3sCc6iBBlhYlVwZGF0ZUFsbEFydGlmYWN0U2hhcmRzAgQAxLX97Anb1we+BEAKY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwoKZm9yIChjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBhcnRpZmFjdEluc3RhbmNlcykgewogICAgY29uc3Qgc2hhcmRCb3QgPSBhcnRpZmFjdEluc3RhbmNlc1thYkFydGlmYWN0SW5zdGFuY2VJRF0uZmluZChiID0+IGIgIT0gbnVsbCk7CgogICAgaWYgKCFzaGFyZEJvdCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVuYWJsZSB0byB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSB0aGVyZSB3ZXJlIG5vIHNoYXJkIGJvdHMgZm91bmQuYCk7CiAgICAgICAgY29udGludWU7CiAgICB9CgogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lOwogICAgCiAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7Cn0nAQRib3RzJDkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YwEnAMS1/ewJmtwHDmFiRmlsZVRpbWVjb2RlAgQAxLX97Amb3AdmQGNvbnN0IGRhdGU6IERhdGVUaW1lID0gdGhhdD8uZGF0ZSA/PyBEYXRlVGltZS5ub3coKTsKcmV0dXJuIGRhdGUudG9VVEMoKS50b0Zvcm1hdCgneXl5eU1NZGQtSEhtbXNzJyk7JwDEtf3sCZrcBwZzeXN0ZW0CBADEtf3sCYLdBw5hYi5zaGVsbC51dGlscycAxLX97Ama3AcMYWJDb21waWxlQ1NTAgQAxLX97AmR3QeCBEBsZXQgYm90cyA9IHRoYXQ7Cgpib3RzID0gQXJyYXkuaXNBcnJheShib3RzKSA/IGJvdHMgOiBbYm90c107CgpsZXQgY3NzID0gW107Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgZm9yIChsZXQga2V5IGluIGJvdC50YWdzKSB7CiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCdjc3MnKSkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBDU1Mga2V5OiAke2tleX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3MucHVzaChib3QudGFnc1trZXldKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IGNvbXBpbGVkID0gY3NzLmpvaW4oJ1xuXG4nKTsKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY29tcGlsZWQgQ1NTOlxuXG5gLCBjb21waWxlZCk7Cn0KCnJldHVybiBjb21waWxlZDsnAMS1/ewJmtwHCGFiSWdub3JlAgQAxLX97AmU4QcEdHJ1ZScAxLX97Ama3AcHYWJTaGVsbAIEAMS1/ewJmeEHBHRydWUnAMS1/ewJmtwHCWFiVmVyc2lvbgIEAMS1/ewJnuEHBDEwLjknAMS1/ewJmtwHDWFiTG9nQW5kVG9hc3QCBADEtf3sCaPhB7gKQGxldCBtZXNzYWdlOwpsZXQgZHVyYXRpb247CmxldCBsb2dUeXBlID0gJ2xvZyc7CmxldCBuYW1lID0gYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5OwpsZXQgdG9hc3QgPSB0cnVlOwpsZXQgYWJMb2cgPSB0cnVlOwpsZXQgY29uc29sZUxvZyA9IHRydWU7CgppZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICBtZXNzYWdlID0gdGhhdDsKICAgIGR1cmF0aW9uID0gdGhpc0JvdC5lc3RpbWF0ZVJlYWRpbmdUaW1lKHsgdGV4dDogdGhhdCwgZGVsYXlUaW1lOiAxMDAwIH0pIC8gMTAwMDsKfSBlbHNlIHsKICAgIG1lc3NhZ2UgPSB0aGF0Lm1lc3NhZ2U7CiAgICBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb24gPz8gKHRoaXNCb3QuZXN0aW1hdGVSZWFkaW5nVGltZSh7IHRleHQ6IHRoYXQubWVzc2FnZSwgZGVsYXlUaW1lOiAxMDAwIH0pIC8gMTAwMCk7CiAgICBuYW1lID0gdGhhdC5uYW1lID8/IG5hbWU7CiAgICBsb2dUeXBlID0gdGhhdC5sb2dUeXBlID8/IGxvZ1R5cGU7CiAgICB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdG9hc3Q7CiAgICBhYkxvZyA9IHRoYXQuYWJMb2cgPz8gYWJMb2c7Cn0KCmlmIChsb2dUeXBlID09PSAnbG9nJykgewogICAgaWYgKGFiTG9nKSBhYi5sb2cobmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmIChjb25zb2xlTG9nKSBjb25zb2xlLmxvZyhuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ3dhcm5pbmcnIHx8IGxvZ1R5cGUgPT09ICd3YXJuJykgewogICAgaWYgKGFiTG9nKSBhYi5sb2cobmFtZSArICc6IFdhcm5pbmc6ICcgKyBtZXNzYWdlKTsKICAgIGlmIChjb25zb2xlTG9nKSBjb25zb2xlLndhcm4obmFtZSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QoYFdhcm5pbmc6ICR7bWVzc2FnZX1gLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ2Vycm9yJykgewogICAgaWYgKGFiTG9nKSBhYi5sb2cobmFtZSArICc6IEVycm9yOiAnICsgbWVzc2FnZSk7CiAgICBpZiAoY29uc29sZUxvZykgY29uc29sZS5lcnJvcihuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChgRXJyb3I6ICR7bWVzc2FnZX1gLCBkdXJhdGlvbik7Cn0gZWxzZSB7CiAgICBpZiAoYWJMb2cpIGFiLmxvZyhuYW1lICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKGNvbnNvbGVMb2cpIGNvbnNvbGUubG9nKG5hbWUgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfScAxLX97Ama3AcIcmVtZW1iZXICBADEtf3sCdzrByjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDEtf3sCZrcBwVhYkxvZwIEAMS1/ewJg+wHpQJAaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICBhYkxvZzogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nOiB0cnVlLAogICAgfSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LmFiTG9nQW5kVG9hc3QoewogICAgICAgIC4uLnRoYXQsCiAgICAgICAgdG9hc3Q6IGZhbHNlLAogICAgICAgIGFiTG9nOiB0cnVlLAogICAgICAgIGNvbnNvbGVMb2c6IHRydWUsCiAgICB9KTsKfScAxLX97Ama3AcTZXN0aW1hdGVSZWFkaW5nVGltZQIEAMS1/ewJqe4H3ANAY29uc3QgewogICAgdGV4dCA9ICcnLAogICAgd29yZHNQZXJNaW51dGUgPSAyNTAsCiAgICBkZWxheVRpbWUgPSA1MDAsCn0gPSB0aGF0OwoKLy8gQ291bnQgd29yZHMgKHJvdWdoIGFwcHJveGltYXRpb24gYnkgc3BsaXR0aW5nIG9uIHdoaXRlc3BhY2UpCmNvbnN0IHdvcmRDb3VudCA9IHRleHQudHJpbSgpLnNwbGl0KC9ccysvKS5sZW5ndGg7CmxldCB0b3RhbFRpbWVNcyA9IDA7CgppZiAod29yZENvdW50ID4gMCkgewogICAgLy8gQ2FsY3VsYXRlIHJlYWRpbmcgdGltZSBpbiBtaWxsaXNlY29uZHMKICAgIGNvbnN0IHdvcmRzUGVyU2Vjb25kID0gd29yZHNQZXJNaW51dGUgLyA2MDsKICAgIGNvbnN0IHJlYWRpbmdUaW1lTXMgPSBNYXRoLmNlaWwoKHdvcmRDb3VudCAvIHdvcmRzUGVyU2Vjb25kKSAqIDEwMDApOwoKICAgIHRvdGFsVGltZU1zID0gcmVhZGluZ1RpbWVNcyArIGRlbGF5VGltZTsKfQoKcmV0dXJuIHRvdGFsVGltZU1zOycAxLX97Ama3AcIaXNPYmplY3QCBADEtf3sCYbyBzlAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheSh0aGF0KTsnAMS1/ewJmtwHB2lzQXJyYXkCBADEtf3sCcDyBxxAcmV0dXJuIEFycmF5LmlzQXJyYXkodGhhdCk7JwDEtf3sCZrcBwhpc1N0cmluZwIEAMS1/ewJ3fIHIUByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnOycAxLX97Ama3AcPZ2V0RXJyb3JNZXNzYWdlAgQAxLX97An/8gfAAkBmdW5jdGlvbiBnZXRFcnJvck1lc3NhZ2UoZXJyb3IpIHsKICAgIGlmIChlcnJvcikgewogICAgICAgIGlmICh0eXBlb2YgZXJyb3IgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIHJldHVybiBlcnJvcjsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yLm1lc3NhZ2UpIHsKICAgICAgICAgICAgcmV0dXJuIGVycm9yLm1lc3NhZ2U7CiAgICAgICAgfSBlbHNlIGlmIChlcnJvci5lcnJvcikgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JNZXNzYWdlKGVycm9yLmVycm9yKTsKICAgICAgICB9CiAgICB9Cn0KCnJldHVybiBnZXRFcnJvck1lc3NhZ2UodGhhdCk7JwDEtf3sCZrcBwdhYlRvYXN0AgQAxLX97AnA9QenAkBpZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICB0aGlzQm90LmFiTG9nQW5kVG9hc3QoewogICAgICAgIG1lc3NhZ2U6IHRoYXQsCiAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgYWJMb2c6IGZhbHNlLAogICAgICAgIGNvbnNvbGVMb2c6IGZhbHNlLAogICAgfSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LmFiTG9nQW5kVG9hc3QoewogICAgICAgIC4uLnRoYXQsCiAgICAgICAgdG9hc3Q6IHRydWUsCiAgICAgICAgYWJMb2c6IGZhbHNlLAogICAgICAgIGNvbnNvbGVMb2c6IGZhbHNlLAogICAgfSk7Cn0nAMS1/ewJmtwHGGhhc0dlb2xvY2F0aW9uUGVybWlzc2lvbgIEAMS1/ewJ6PcH6gFAbGV0IGhhc1Blcm1pc3Npb24gPSBmYWxzZTsKCmlmIChnbG9iYWxUaGlzLm5hdmlnYXRvciAmJiBuYXZpZ2F0b3IucGVybWlzc2lvbnMpIHsKICAgIGNvbnN0IHN0YXR1cyA9IGF3YWl0IG5hdmlnYXRvci5wZXJtaXNzaW9ucy5xdWVyeSh7IG5hbWU6ICdnZW9sb2NhdGlvbicgfSk7CiAgICBoYXNQZXJtaXNzaW9uID0gc3RhdHVzPy5zdGF0ZSA9PT0gJ2dyYW50ZWQnOwp9CgpyZXR1cm4gaGFzUGVybWlzc2lvbjsnAMS1/ewJmtwHBWlzQm90AgQAxLX97AnT+QdUQHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcgJiYgdGhhdC50YWdzICYmIHRoYXQuaWQgJiYgdGhhdC5zcGFjZSAmJiB0aGF0LnZhcnM7JwEEYm90cyRkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUBJwDEtf3sCaj6BwZzeXN0ZW0CBADEtf3sCan6Bw9hYi5zaGVsbC5zZWFyY2gnAMS1/ewJqPoHBGZvcm0CBADEtf3sCbn6Bwdub3RoaW5nJwDEtf3sCaj6Bw5hYlJldHJpZXZlRmlsZQIEAMS1/ewJwfoHggFALy9wdWxsIGRvd24gZmlsZSBkYXRhCmlmICghdGhhdC51cmwpCnsKICAgIHJldHVybiAibm8gZmlsZSB1cmwgc3VwcGxpZWQiOwp9CgpsZXQgZGF0YSA9IGF3YWl0IG9zLmdldEZpbGUodGhhdC51cmwpOwoKcmV0dXJuIGRhdGE7JwDEtf3sCaj6BxBhYlJldHJpZXZlUmVjb3JkAgQAxLX97AnE+wfsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwDEtf3sCaj6BwhyZW1lbWJlcgIEAMS1/ewJsYAIKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMS1/ewJqPoHDW1hbmlmZXN0YXRpb24CBADEtf3sCdiACCjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDEtf3sCaj6Bw5vbkxvb2t1cEFCRWdncwIEAMS1/ewJ/4AIjjFAY29uc3QgeyAKICAgIGFiSUQsCiAgICBhYlZlcnNpb24sCiAgICBpbml0aWFsQm9vdCwKICAgIGF1dG9IYXRjaCwKICAgIHJldHVyblR5cGUsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5LAogICAgdG9hc3QgPSB0cnVlLAogICAgc2hvd0luZGljYXRvciA9IHRydWUsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsLiAob3B0aW9uYWwpCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgphYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGxvYWRpbmcgIiArIGFiSUQpOwoKLy9jbGVhciBhYi0xCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uICYmIGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgPT0gImFiTWVudSIpIHsKICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwp9CgpsZXQgYnVzeUluZGljYXRvcjsKCmlmIChzaG93SW5kaWNhdG9yKSB7CiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQoKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgbG9hZGluZyAke2FiSUR9YH0pOwp9Cgpjb25zdCBwb3NzaWJsZUF1dGggPSBhdXRoQm90ID8gYXV0aEJvdCA6IHRydWU7CmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgpsZXQgZWdnRGF0YTsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYKICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5ICYmCiAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gInJlY29yZF9ub3RfZm91bmQiCiAgICApIHsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiKSB7CiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9sb2dnZWRfaW4iKSB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCiAgICAgICAgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiAKICAgICAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIgogICAgICAgICkgewogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHRvYXN0KSB7IAogICAgICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKICAgIH0KCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgIH0KCiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CmVsc2UgewogICAgY29uc3QgcHVibGljUmVhZFRlc3QgPSBnZXRSZWNvcmQubWFya2Vycy5pbmRleE9mKCJwdWJsaWNSZWFkIik7CiAgICBjb25zdCBhdXRob3IgPSBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwoKICAgIGlmIChwdWJsaWNSZWFkVGVzdCAhPSAtMSAmJiBhdXRob3IpIHsKICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIHsKICAgICAgICAgICAgY29uc3QgZWdnSGF0Y2hFdmVudCA9IGFiSUQ7CgogICAgICAgICAgICBvcy5yZWNvcmRFdmVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBlZ2dIYXRjaEV2ZW50KTsKICAgICAgICB9CiAgICB9CgogICAgLy9wYWNrYWdlIHRoZSByZWNvcmQgZGF0YQogICAgZWdnRGF0YSA9IGdldFJlY29yZC5kYXRhOwoKICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAvLyBDaGFuZ2UgaW5pdGlhbCB0YXJnZXQgdmVyc2lvbiBvZiB0aGUgZWdnIGlmIGFiVmVyc2lvbiBpcyBwcm92aWRlZC4KICAgICAgICBlZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBhYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCmlmIChyZXR1cm5UeXBlICE9IG51bGwpIHsKICAgIGlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICAgICAgICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYWJWZXJzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSBhYlZlcnNpb24gLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlZ2dEYXRhVVJMID0gZ2V0UmVjb3JkLmRhdGEuZWdnVmVyc2lvbkhpc3RvcnlbdmVyc2lvbl07CiAgICAgICAgICAgIGNvbnN0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXR1cm5EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocmV0dXJuVHlwZSA9PT0gImVnZyIpIHsKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNpbXBseSByZXR1cm4gdGhlIGVnZyBkYXRhIGlmIHJlcXVlc3RlZC4KICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZC5kYXRhOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVGhpcyBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgYXV4IGZpbGVzIHN0b3JlZCBiZWZvcmUgdGhlIHJlY29yZCBzeXN0ZW0gZXhpc3RlZC4KICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGNvbnN0IHZlcnNpb25BcnJheSA9IEpTT04ucGFyc2UoZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeSk7CiAgICAgICAgICAgIGNvbnN0IGZpbGVVVUlEID0gdmVyc2lvbkFycmF5W2VnZ0RhdGEubWF4VmVyc2lvbiAtIDFdOwogICAgICAgICAgICBjb25zdCBmaWxlbmFtZWhhc2hMVE0gPSBjcnlwdG8uc2hhMjU2KGZpbGVVVUlEKTsKICAgICAgICAgICAgY29uc3QgZmlsZXVybGhhc2hMVE0gPSAiYXV4XyIgKyBmaWxlbmFtZWhhc2hMVE0gKyAnLmF1eCc7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldExUTVVSTCA9ICJodHRwczovL2J1aWxkZXItbHRtLWZpbGVzLnMzLmFtYXpvbmF3cy5jb20vIiArIGZpbGV1cmxoYXNoTFRNOwogICAgICAgICAgICBjb25zdCBvID0gewogICAgICAgICAgICAgICAgbWV0aG9kOiAiR0VUIiwKICAgICAgICAgICAgICAgIHVybDogdGFyZ2V0TFRNVVJMCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsZXQgZmlsZUdldCA9IGF3YWl0IHdlYmhvb2sobyk7CgogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZpbGVHZXQuc3RhdHVzICE9IDIwMCkgewogICAgICAgICAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgb3MudG9hc3QoIm5vIGZpbGUgZm91bmQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CgogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZpbGVHZXQgPSBmaWxlR2V0LmRhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmaWxlR2V0OwogICAgICAgIH0KICAgIH0KfQoKLy9hYiBzcGVjaWZpYyB2YXJpYWJsZXMgZm9yIHVuZGVyc3RhbmRpbmcgaWYgYSBwb3NpdGlvbiBpcyBzcGVjaWZpZWQKbGV0IGN1cnJlbnREaW07CmxldCBzcGFjZU1vZDsKbGV0IGRpbWVuc2lvblg7CmxldCBkaW1lbnNpb25ZOwpsZXQgZGltTW9kOwoKLy9oYW5kbGUgZGltZW5zaW9uIGlkZW50aWZpY2F0aW9uCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGNvbnN0IGFiQm90ID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdDsKCiAgICAgICAgY3VycmVudERpbSA9IGFiQm90LnRhZ3MuZGltZW5zaW9uOwogICAgfQp9CmVsc2UgewogICAgY3VycmVudERpbSA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKLy9jaGVja3MgZm9yIGdyaWQgZm9jdXMKaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzKSB7CiAgICBkaW1lbnNpb25YID0gbnVsbDsKICAgIGRpbWVuc2lvblkgPSBudWxsOwp9CmVsc2UgewogICAgbGV0IGhhdGNoUG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKICAgIGN1cnJlbnREaW0gPSBoYXRjaFBvaW50LmRpbWVuc2lvbjsKICAgIGRpbWVuc2lvblggPSBoYXRjaFBvaW50LnBvc2l0aW9uLng7CiAgICBkaW1lbnNpb25ZID0gaGF0Y2hQb2ludC5wb3NpdGlvbi55OwogICAgc3BhY2VNb2QgPSB7IHNwYWNlOiAic2hhcmVkIiB9Owp9CgovL3RoaXMgbG9naWMgaGFuZGxlcyBsb2dpYyBhcm91bmQgYXV0b0hhdGNoIHZzIG1hbnVhbCBoYXRjaGluZwppZiAoIWF1dG9IYXRjaCAmJiBjb25maWdCb3QudGFncy5wYXR0ZXJuID09IG51bGwpIHsKICAgIGRpbU1vZCA9IHsKICAgICAgICBbY3VycmVudERpbV06IHRydWUsCiAgICAgICAgW2N1cnJlbnREaW0gKyAiWCJdOiBkaW1lbnNpb25YLAogICAgICAgIFtjdXJyZW50RGltICsgIlkiXTogZGltZW5zaW9uWSwKICAgICAgICBkaW1lbnNpb246IGN1cnJlbnREaW0KICAgIH07Cn0KZWxzZSB7CiAgICBkaW1Nb2QgPSB7IGF1dG9IYXRjaDogdHJ1ZSwga2V5IH07Cn0KCi8vY2FsbCBmb3Igb3ZvIHdpdGggaW5mb3JtYXRpb24gcHJvdmlkZWQKY29uc3QgbWFuaWZlc3RSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm1hbmlmZXN0T3ZvKHsKICAgIGFiSUQsCiAgICBzdHVkaW86IHJlY29yZEtleSwKICAgIGRpbU1vZCwKICAgIHNwYWNlTW9kLAogICAgZWdnRGF0YSwKICAgIGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50LAp9KTsKCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIGhhdGNoZWRCb3RzOiBtYW5pZmVzdFJlc3VsdD8uaGF0Y2hlZEJvdHMsCn07JwDEtf3sCaj6BwttYW5pZmVzdE92bwIEAMS1/ewJjrII1A9AY29uc3QgeyAKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIHNwYWNlTW9kLAogICAgZGltTW9kLAogICAgZWdnRGF0YSwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwKfSA9IHRoYXQ7CgovL2VnZyB2aXN1YWxpemF0aW9uCnNob3V0KCJhYk1lbnVSZXNldCIpOwoKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24pIHsKICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90ICYmICFjb25maWdCb3QudGFncy5hYlN0YXlBd2FrZSkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCmlmIChsaW5rcy5vdm9Cb3QpIHsKICAgIGRlc3Ryb3kobGlua3Mub3ZvQm90KTsKfQoKbGV0IGVnZ01vZCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGluaXRpYWxUaW1lcjogdHJ1ZSwKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBzb3VyY2VFdmVudCwKICAgIGN1cnNvcjogJ3BvaW50ZXInLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5pbnRlcmFjdE92bygpOwogICAgYCwKICAgIGZvcm06ICJlZ2ciLAogICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICBwcm9ncmVzc0JhckNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yLAogICAgcHJvZ3Jlc3NCYXJCYWNrZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNSwKICAgIG9uUG9pbnRlckVudGVyOiBgQAogICAgICAgIG1hc2tzLnRpcElkID0gYXdhaXQgb3MudGlwKHRhZ3MuYWJJRCArICcgdicgKyB0YWdzLnRhcmdldFZlcnNpb24pOwogICAgYCwKICAgIG9uUG9pbnRlckV4aXQ6IGBACiAgICAgICAgaWYgKG1hc2tzLnRpcElkKSB7CiAgICAgICAgICAgIG9zLmhpZGVUaXBzKG1hc2tzLnRpcElkKTsKICAgICAgICB9CiAgICBgLAogICAgbGFiZWxQb3NpdGlvbjogImZyb250IiwKICAgIG9yaWVudGF0aW9uTW9kZTogImJpbGxib2FyZEZyb250IiwKICAgIG9uRGVzdHJveTogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLm1hc2tzLm92b0JvdCA9IG51bGw7CiAgICBgLAogICAgZWdnVGltZXI6IGBACiAgICAgICAgaWYgKHRhZ3MucHJvZ3Jlc3NCYXIgPCAxKSB7CiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgKz0gMC4xOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7d2hpc3Blcih0aGlzQm90LCAiZWdnVGltZXIiKTt9LCA3NSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5vbkNsaWNrKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyID0gbnVsbDsKICAgICAgICB9CiAgICBgCn07CgoKY29uc3Qgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7Cm1hc2tzLm92b0JvdCA9IGdldExpbmsob3ZvKTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsKfQoKaWYgKG92by50YWdzLmF1dG9IYXRjaCkgewogICAgY29uc3QgaGF0Y2hlZEJvdHMgPSBhd2FpdCB0aGlzQm90LmhhdGNoT3ZvKG92byk7CiAgICByZXR1cm4geyBoYXRjaGVkQm90cyB9Owp9CmVsc2UgewogICAgb3ZvLnRhZ3MucHJvZ3Jlc3NCYXIgPSAwOwogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG92by50YWdzLm1heFZlcnNpb247CiAgICBzZXRUaW1lb3V0KCgpID0+IHsgd2hpc3Blcihvdm8sICJlZ2dUaW1lciIpOyB9LCA3NSk7Cn0nAMS1/ewJqPoHCW9uS2V5RG93bgIEAMS1/ewJ48EIggZALy9oaWRkZW4gdmVyc2lvbiBidXR0b24gZm9yIGhhdGNoIG1lbnUKaWYgKCFsaW5rcy5vdm9Cb3QgfHwgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCAhPSAiYWJPdm9NZW51IikKewogICAgcmV0dXJuOwp9CgppZiAodGhhdC5rZXlzID09ICJTaGlmdCIpCnsKICAgIGxldCB2ZXJzaW9uQnV0dG9uID0ge307CgogICAgdmVyc2lvbkJ1dHRvbi5hYk92b01lbnUgPSB0cnVlOwogICAgdmVyc2lvbkJ1dHRvbi5vdm9Tb3J0T3JkZXIgPSAtMTsKICAgIHZlcnNpb25CdXR0b24ubWF4VmVyc2lvbiA9IGxpbmtzLm92b0JvdC50YWdzLm1heFZlcnNpb247CiAgICB2ZXJzaW9uQnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwogICAgdmVyc2lvbkJ1dHRvbi5sYWJlbCA9ICJjaGFuZ2UgZWdnIHZlcnNpb24iOwogICAgdmVyc2lvbkJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJjZW50ZXIiOwogICAgdmVyc2lvbkJ1dHRvbi5vdm9NZW51UmVzZXQgPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CiAgICB2ZXJzaW9uQnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvcjsKICAgIHZlcnNpb25CdXR0b24ub25LZXlVcCA9ICJAIGlmKHRoYXQua2V5cyA9PSAnU2hpZnQnKXtkZXN0cm95KHRoaXNCb3QpfTsiOwogICAgdmVyc2lvbkJ1dHRvbi5vbkNsaWNrID0gIkAgbGlua3MubWFuYWdlci5jaGFuZ2VPdm9WZXJzaW9uKCk7IjsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih2ZXJzaW9uQnV0dG9uKTsKfScAxLX97Amo+gcIaGF0Y2hPdm8CBADEtf3sCeTHCJ0VQC8vbG9naWMgZm9yIGhhdGNoaW5nIG9mIGFuIGFiCnNob3V0KCdvdm9NZW51UmVzZXQnKTsKCi8vZGF0YSBpbiByZWdhcmRzIHRvIHdoYXQgYWIgaXMgZ29pbmcgdG8gYmUgaGF0Y2hlZApjb25zdCBvdm8gPSB0aGF0OwoKLy9oYXRjaCBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGluaXRpYWxCb290ID0gb3ZvLnRhZ3MuaW5pdGlhbEJvb3Q7CmxldCB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiA/PyBvdm8udGFncy50YXJnZXRWZXJzaW9uOwoKaWYgKChjb25maWdCb3QudGFncy5hYlZlcnNpb24gfHwgY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb24pICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy5hYlZlcnNpb24gPz8gY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb247Cn0KCi8vdGFyZ2V0ZWQgdmVyc2lvbnMKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiIHx8ICFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkpCnsKICAgIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJmZWVkYmFjayIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmZlZWRiYWNrVmVyc2lvbjsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImN1cnJlbnQiKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICB9CiAgICBlbHNlIGlmICghaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnZlcnNpb24KICAgIH0KCiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gbnVsbDsKfQoKaWYgKGlzTmFOKHRhcmdldFZlcnNpb24pKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwp9CgpsZXQgdmVyc2lvbkFycmF5ID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3Rvcnk7CmxldCBmaWxlVVJMID0gdmVyc2lvbkFycmF5W3RhcmdldFZlcnNpb24gLSAxXTsKbGV0IGtleSA9IG92by50YWdzLmtleSA/IG92by50YWdzLmtleSA6IGNvbmZpZ0JvdC50YWdzLmtleTsKbGV0IGZpbGVHZXQ7CgovL2FjdHVhbCBmaWxlIHJldHJpZXZhbAp0cnkKewogICAgZmlsZUdldCA9IGF3YWl0IG9zLmdldEZpbGUoZmlsZVVSTCk7Cn0KY2F0Y2ggKGUpCnsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdubyBmaWxlIGZvdW5kJyk7CgogICAgcmV0dXJuOwp9CgovL2hhbmRsaW5nIGZvciBlbmNyeXB0ZWQgYWIgZmlsZQppZiAoY3J5cHRvLmlzRW5jcnlwdGVkKGZpbGVHZXQpKQp7CiAgICBpZiAoIWtleSkKICAgIHsKICAgICAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoJycsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnRW50ZXIga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGZpbGVHZXQgPSBjcnlwdG8uZGVjcnlwdChrZXksIGZpbGVHZXQpOwoKICAgIGlmIChmaWxlR2V0ID09IG51bGwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdpbmNvcnJlY3Qga2V5Jyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAKICAgIGZpbGVHZXQgPSBKU09OLnBhcnNlKGZpbGVHZXQpOwogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KZWxzZQp7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQoKLy9jbGVhbiB1cApkZXN0cm95KG92byk7CgovL3RvYXN0IGlmIG5vdCBvbiBzdGFibGUKaWYob3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiAhPSB0YXJnZXRWZXJzaW9uICYmICFjb25maWdCb3QudGFncy5hYlNpbGVudCkKewogICAgaWYgKG92by50YWdzLmZlZWRiYWNrVmVyc2lvbiA9PSB0YXJnZXRWZXJzaW9uKQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIGZlZWRiYWNrIHZlcnNpb24gb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIHZlcnNpb24gIiArIHRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggKyAiIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KfQoKLy9nZW5lcmF0ZSBib3RzIGJhc2VkIG9uIHRoZSBmaWxlIHJldHJpZXZlZCAqSEVSRSoKY29uc3QgbmV3Qm90cyA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoewogICAgYm90czogZmlsZUdldCwKICAgIG9yaWdpbjogb3ZvLnRhZ3MuYWJJRCwKICAgIHN0dWRpbzogb3ZvLnRhZ3Muc3R1ZGlvLAogICAgdmVyc2lvbjogdGFyZ2V0VmVyc2lvbiwKICAgIGluaXRpYWxCb290OiBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnM6IG92by50YWdzLmVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50OiBvdm8udGFncy5zb3VyY2VFdmVudCwKfSk7CgpyZXR1cm4gbmV3Qm90czsnAMS1/ewJqPoHC2ludGVyYWN0T3ZvAgQAxLX97AmC3QjpBkAvL21hbnVhbCBoYXRjaCBtZW51CmNvbnN0IG92b0JvdCA9IHRoYXQgPyB0aGF0IDogbGlua3Mub3ZvQm90OwoKaWYgKCFvdm9Cb3QpIHsKICAgIHJldHVybjsKfQoKc2hvdXQoIm92b01lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJPdm9NZW51IjsKCm1hc2tzLm9uR3JpZENsaWNrID0gYEAKICAgIHNob3V0KCJvdm9NZW51UmVzZXQiKTsKYDsKbWFza3Mub3ZvTWVudVJlc2V0ID0gYEAKICAgIG1hc2tzLm9uR3JpZENsaWNrID0gbnVsbDsKICAgIG1hc2tzLm92b01lbnVSZXNldCA9IG51bGw7CgogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKb3MudHdlZW5Ubyhvdm9Cb3QsIDE1LDQ1LDQ1LCA1KTsKCmNvbnN0IGVnZ01lbnVCdXR0b24gPSB7CiAgICBhYk92b01lbnU6IHRydWUsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb3ZvQm90OiBnZXRMaW5rKG92b0JvdCksCiAgICBjb2xvcjogYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgdGFyZ2V0VmVyc2lvbjogb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwKICAgIGxhYmVsOiBgaGF0Y2ggJHtvdm9Cb3QudGFncy5hYklEfSB2JHtvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9ufSBvZiAke292b0JvdC50YWdzLm1heFZlcnNpb259YCwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIG92b01lbnVSZXNldDogYEAKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgYCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOwogICAgYCwKfTsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGVnZ01lbnVCdXR0b24pOycAxLX97Amo+gcGY3JlYXRlAgQAxLX97Ans4wgo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAxLX97Amo+gcQY2hhbmdlT3ZvVmVyc2lvbgIEAMS1/ewJk+QI8AJALy9sb2dpYyBmb3IgdmVyc2lvbiBjaGFuZ2luZyB3aGVuIG1hbnVhbGx5IGhhdGNoaW5nIGFuIGFiCmNvbnN0IG92b0JvdCA9IGxpbmtzLm92b0JvdDsKCmxldCBuZXdWZXJzaW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sIHsKICAgIHBsYWNlaG9sZGVyOiAiZW50ZXIgYSB2ZXJzaW9uIGZyb20gMSB0byAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbgp9KTsKCm92b0JvdC50YWdzLnRhcmdldFZlcnNpb24gPSBuZXdWZXJzaW9uOwpvdm9Cb3QudGFncy5sYWJlbCA9ICd2JysgbmV3VmVyc2lvbjsKCmNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBuZXdWZXJzaW9uOwoKc2hvdXQoIm92b01lbnVSZXNldCIpOycAxLX97Amo+gcEbWVudQIEAMS1/ewJhOcIKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAMS1/ewJqPoHCGFiSWdub3JlAgQAxLX97Amr5wgEdHJ1ZScAxLX97Amo+gcHYWJTaGVsbAIEAMS1/ewJsOcIBHRydWUnAMS1/ewJqPoHDGFiMUxUTVNlYXJjaAIEAMS1/ewJtecIM0AvL3N1cHBvcnQgb2xkIHN5bnRheAp0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOycAxLX97Amo+gcNb25Mb29rdXBBc2tJRAIEAMS1/ewJ6ecImhhAY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsKY29uc3Qgc2hvd0luZGljYXRvciA9IHRoYXQ/LnNob3dJbmRpY2F0b3IgPz8gdHJ1ZTsKY29uc3QgY2hhbm5lbENvbmZpZyA9IHRoYXQ/LmNoYW5uZWxDb25maWc7CmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOwpjb25zdCBlZ2dQYXJhbWV0ZXJzID0gdGhhdD8uZWdnUGFyYW1ldGVyczsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwpjb25zdCBpZ25vcmVSZXNlcnZlZCA9IHRoYXQ/Lmlnbm9yZVJlc2VydmVkOwoKYXNzZXJ0KHR5cGVvZiBhc2tJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvb2tpbmcgdXAgJHthc2tJRH1gIH0pOwp9CgovL0NoZWNrIGZvciByZXNlcnZlZCBrZXl3b3JkcwppZiAobGlua3M/LmxlYXJuPy50YWdzPy5yZXNlcnZlZEFza3M/LmluY2x1ZGVzKGFza0lEKSAmJiAhaWdub3JlUmVzZXJ2ZWQgJiYgYXV0aEJvdCkgewogICAgbG9va3VwQXNrID0gYXdhaXQgdGhpc0JvdC5sb29rdXBGcm9tU3R1ZGlvKHsuLi50aGF0LCByZXNlcnZlZDogdHJ1ZX0pOwogICAgaWYgKGxvb2t1cEFzayAmJiBsb29rdXBBc2suc3VjY2VzcyA9PSB0cnVlKSB7CiAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICB9CiAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IExvYWRpbmcgYXNrIGZyb20gc3R1ZGlvIGJlZm9yZSBjYXRhbG9nIiwgbG9va3VwQXNrKTsKICAgICAgICByZXR1cm4gbG9va3VwQXNrOwogICAgfQp9CgovLyBGaXJzdCBjaGVjayB0aGUgY2FzdWFsIGNhdGFsb2cgZm9yIHRoZSBhc2suCmNvbnN0IGNhc3VhbENhdGFsb2dVUkwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2Fza3MvJHthc2tJRH0uYXV4YCk7Cgp0cnkgewogICAgY29uc3QgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICdHRVQnLCB1cmw6IGNhc3VhbENhdGFsb2dVUkwgfSk7CgogICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgIGlmIChjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAxICYmIGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnN0YXRlKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjEgYXV4IGZpbGUuCiAgICAgICAgICAgIGNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90czogY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUsIGlnbm9yZUdyaWRGb2N1czogdHJ1ZSwgb3JpZ2luOiBhc2tJRCwgZWdnUGFyYW1ldGVycywgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCBzb3VyY2VFdmVudCB9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycsCiAgICAgICAgICAgICAgICBoYXRjaGVkQm90czogbmV3Qm90cywKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiAmJiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS51cGRhdGVzKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjIgYXV4IGZpbGUuCiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXNrcyBvbmx5IHN1cHBvcnQgdjEgYXV4IGZpbGUgZm9ybWF0LmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UuCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgYXNrIHJlc3BvbnNlLmAsIGNhc3VhbENhdGFsb2dSZXNwb25zZSk7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS4gQ2hlY2sgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsb29rdXBBc2s7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIERpZCBub3QgZmluZCBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuCn0KCmxvb2t1cEFzayA9IGF3YWl0IHRoaXNCb3QubG9va3VwRnJvbVN0dWRpbyh0aGF0KTsKCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gbG9va3VwQXNrOycAxLX97Amo+gcFdHlwZXMCBADEtf3sCYSACfYB8J+ThHR5cGUgQUJBc2tJRE9yaWdpbiA9ICdjYXN1YWxfY2F0YWxvZycgfCAnYWJfcmVjb3JkJzsKCmludGVyZmFjZSBBQkxvb2t1cEFza0lEUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICBvcmlnaW46IEFCQXNrSURPcmlnaW47CiAgICBoYXRjaGVkQm90cz86IEJvdFtdOwp9CgppbnRlcmZhY2UgQUJMb29rdXBFZ2dSZXN1bHQgewogICAgc3VjY2VzczogYm9vbGVhbiwKICAgIGhhdGNoZWRCb3RzPzogQm90W10sCn0KJwDEtf3sCaj6BwVpbnB1dAIEAMS1/ewJ+YEJKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAMS1/ewJqPoHBWhhdGNoAgQAxLX97AmgggnAAUAvL3Nob3V0KCJoYXRjaCIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywga2V5OiBrZXksIGF1dG9IYXRjaDogYm9vbGVhbiwgcmV0dXJuVHlwZTogZGF0YS9udWxsLCBlZ2dQYXJhbWV0ZXJzOiBhcmd9KTsKCmNvbnN0IGxvb2tVcCA9IGF3YWl0IHRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7CgpyZXR1cm4gbG9va1VwOycAxLX97Amo+gcJYWJWZXJzaW9uAgQAxLX97AnhgwkEMTAuOScAxLX97Amo+gcFbGVhcm4CBADEtf3sCeaDCSjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDEtf3sCaj6BwV1dGlscwIEAMS1/ewJjYQJKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAMS1/ewJqPoHC3BlcnNvbmFsaXR5AgQAxLX97Am0hAko8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicAxLX97Amo+gcQbG9va3VwRnJvbVN0dWRpbwIEAMS1/ewJ24QJxR1AY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsNCmNvbnN0IHNob3dJbmRpY2F0b3IgPSB0aGF0Py5zaG93SW5kaWNhdG9yID8/IHRydWU7DQpjb25zdCBjaGFubmVsQ29uZmlnID0gdGhhdD8uY2hhbm5lbENvbmZpZzsNCmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOw0KY29uc3QgZWdnUGFyYW1ldGVycyA9IHRoYXQ/LmVnZ1BhcmFtZXRlcnM7DQpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQ/LnNvdXJjZUV2ZW50Ow0KY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOw0KY29uc3QgcmVzZXJ2ZWQgPSB0aGF0Py5yZXNlcnZlZDsNCg0KbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsNCg0KLy8gQ2hlY2sgdGhlIGFiIHJlY29yZCBmb3IgdGhlIGFzay4NCmNvbnN0IGFiRm9ybWF0dGVkQXNrSUQgPSBhc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOw0KDQppZiAocmVzZXJ2ZWQpIHsNCiAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvKSB7DQogICAgICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8gIT0gYXV0aEJvdC5pZCkgew0KICAgICAgICAgICAgY29uc3QgcGVybXMgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsNCiAgICAgICAgICAgIGlmIChwZXJtcy5zdWNjZXNzKSB7DQogICAgICAgICAgICAgICAgY29uc3QgZm91bmQgPSBwZXJtcy5zdHVkaW9zLmZpbmQoKHN0dWQpID0+IHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChzdHVkLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IFVzZXIgcGVybWlzc2lvbnMgZm9yIHN0dWRpbyIsIGZvdW5kLCBwZXJtcyk7DQogICAgICAgICAgICAgICAgaWYgKCFmb3VuZCkgew0KICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiW2FiUmVzZXJ2ZWRBc2tzXTogVXNlciBkb2VzIG5vdCBoYXZlIHBlcm1pc3Npb25zIGZvciB0aGlzIHN0dWRpby4iKQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9va3VwQXNrOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGNvbmZpZ0JvdC50YWdzLnN0dWRpbywgYWJGb3JtYXR0ZWRBc2tJRCk7DQogICAgICAgIGlmICghbG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmVycm9yQ29kZSAmJiBsb29rdXBBc2suZXJyb3JDb2RlID09ICdub3RfYXV0aG9yaXplZCcpIHsNCiAgICAgICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihjb25maWdCb3QudGFncy5zdHVkaW8pOw0KICAgICAgICAgICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShjb25maWdCb3QudGFncy5zdHVkaW8sIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYgKCFsb29rdXBBc2suc3VjY2Vzcykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBmYWlsdXJlIGxvb2tpbmcgdXAgYXNrIGluIHN0dWRpbyIsIGxvb2t1cEFzayk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBMb29rZWQgdXAgYXNrIGluIHN0dWRpbyIsIGxvb2t1cEFzayk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGF1dGhCb3Q/LmlkLCBhYkZvcm1hdHRlZEFza0lEKTsNCiAgICAgICAgaWYgKCFsb29rdXBBc2suc3VjY2VzcyAmJiBsb29rdXBBc2suZXJyb3JDb2RlICYmIGxvb2t1cEFzay5lcnJvckNvZGUgPT0gJ25vdF9hdXRob3JpemVkJykgew0KICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKGF1dGhCb3Q/LmlkKTsNCiAgICAgICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdD8uaWQsIGFiRm9ybWF0dGVkQXNrSUQpOw0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgaWYgKCFsb29rdXBBc2suc3VjY2Vzcykgew0KICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJbYWJSZXNlcnZlZEFza3NdOiBmYWlsdXJlIGxvb2tpbmcgdXAgYXNrIGluIHVzZXIgc3R1ZGlvIiwgbG9va3VwQXNrKTsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIlthYlJlc2VydmVkQXNrc106IExvb2tlZCB1cCBhc2sgaW4gdXNlciBzdHVkaW8iLCBsb29rdXBBc2spOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KfSBlbHNlIHsNCiAgICB0cnkgew0KICAgICAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGBhc2tfJHthYkZvcm1hdHRlZEFza0lEfWAsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludCk7DQogICAgfSBjYXRjaCB7DQogICAgICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYWJGb3JtYXR0ZWRBc2tJRCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsNCiAgICB9IA0KfQ0KDQpsb29rdXBBc2sub3JpZ2luID0gJ2FiX3JlY29yZCc7DQoNCmlmIChjaGFubmVsQ29uZmlnKSB7DQogICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsNCiAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsNCiAgICB9DQoNCiAgICByZXR1cm4gbG9va3VwQXNrOw0KfSBlbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiAobG9va3VwQXNrLmRhdGEucGF0dGVybklEIHx8IHJlc2VydmVkKSkgew0KICAgIGlmIChsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA9PSAiQUIiKSB7DQogICAgICAgIC8vIFJ5YW4gQ29vazogVGhpcyBhcHBlYXJzIHRvIGJlIHNvbWV0aGluZyBuZWVkZWQgYnkgYWJDaGFubmVscy4NCiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQpOw0KDQogICAgICAgIHNob3V0KCJvbkFCSW5pdGlhbGl6ZWQiKTsNCiAgICB9IGVsc2Ugew0KICAgICAgICAvLyBMb29rdXAgdGhlIGVnZyB1c2luZyB0aGUgc3R1ZGlvSUQgYW5kIHBhdHRlcm5JRCBmcm9tIHRoZSBhYl9yZWNvcmQgYXNrLg0KICAgICAgICBjb25zdCBsb29rdXBFZ2c6IEFCTG9va3VwRWdnUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh7IGFiSUQ6IHJlc2VydmVkID8gYWJGb3JtYXR0ZWRBc2tJRCA6IGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiByZXNlcnZlZCA/IChjb25maWdCb3QudGFncy5zdHVkaW8gPz8gYXV0aEJvdD8uaWQpIDogbG9va3VwQXNrLmRhdGEuc3R1ZGlvSUQsIGF1dG9IYXRjaCwgZWdnUGFyYW1ldGVycywgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCBzb3VyY2VFdmVudCB9KTsNCiAgICAgICAgDQogICAgICAgIGxvb2t1cEFzay5zdWNjZXNzID0gbG9va3VwRWdnLnN1Y2Nlc3M7DQogICAgICAgIGxvb2t1cEFzay5oYXRjaGVkQm90cyA9IGxvb2t1cEVnZy5oYXRjaGVkQm90czsNCiAgICB9DQp9IGVsc2UgaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmICFsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQgJiYgIWxvb2t1cEFzay5kYXRhLnVybCkgew0KICAgIGxvb2t1cEFzay5zdWNjZXNzID0gZmFsc2U7DQp9DQoNCnJldHVybiBsb29rdXBBc2s7JwEEYm90cyRmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjABJwDEtf3sCaGiCQZzeXN0ZW0CBADEtf3sCaKiCQ5hYi5zaGVsbC5pbnB1dCcAxLX97AmhogkEZm9ybQIEAMS1/ewJsaIJB25vdGhpbmcnAMS1/ewJoaIJCW9uS2V5RG93bgIEAMS1/ewJuaIJ+gpAY29uc3QgeyBrZXlzIH0gPSB0aGF0OwoKaWYgKG1hc2tzLmNoYXRPcGVuKSB7CiAgICBjb25zdCBlc2MgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpOwoKICAgIGlmIChlc2MpIHsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFycm93VXAgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93VXAnKTsKICAgICAgICBjb25zdCBhcnJvd0Rvd24gPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93RG93bicpOwogICAgICAgIAogICAgICAgIGlmIChhcnJvd1VwIHx8IGFycm93RG93bikgewogICAgICAgICAgICAvLyBJZiBBcnJvd1VwIG9yIEFycm93RG93biBhcmUgcHJlc3NlZCB3aGlsZSB0aGUgYWIgY2hhdCBiYXIgaXMgb3BlbiB0aGVuCiAgICAgICAgICAgIC8vIHN0YXJ0IGNvbWJpbmcgdGhyb3VnaCBjaGF0IGhpc3RvcnkuCiAgICAgICAgICAgIGNvbnN0IGRpciA9IGFycm93VXAgPyAtMSA6IDE7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCArIGRpcjsKICAgICAgICAgICAgbGV0IGhpc3RvcmljYWxUZXh0ID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIGluZGV4IDwgdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaGlzdG9yaWNhbFRleHQgPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnlbaW5kZXhdOwogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IGluZGV4OwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID49IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGNoYXQgYmFyLgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3Blbih7IHByZWZpbGw6IGhpc3RvcmljYWxUZXh0IH0pOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGNvbnN0IGJhY2t0aWNrID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdgJykgfHwgdGhhdC5rZXlzLmluY2x1ZGVzKCJEZWFkIik7CgogICAgaWYgKGJhY2t0aWNrKSB7CiAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICB9Cn0KJwDEtf3sCaGiCQZvbkNoYXQCBADEtf3sCbStCYoYQC8vIE5vdCBzdXBwb3J0ZWQgb3V0c2lkZSBvZiBidWlsZGVyIHZlcnNpb24KaWYgKCFidWlsZGVyVmVyc2lvbikgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgppZiAoIXRoYXQubWVzc2FnZSkgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgovLyBBcHBlbmQgbWVzc2FnZSB0byBjaGF0IGhpc3RvcnkgYW5kIHVwZGF0ZSB0aGUgY3VycmVudCBoaXN0b3J5IGluZGV4Lgp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkucHVzaCh0aGF0Lm1lc3NhZ2UpOwp0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKCi8vIEZ1bmN0aW9uIHRvIHBhcnNlIGFyZ3VtZW50cyB3aXRoIHF1b3RlIHN1cHBvcnQgYW5kIGVycm9yIGhhbmRsaW5nCi8vIEV4YW1wbGVzOiAKLy8gICAnYXJnMSBhcmcyJyAtPiBbJ2FyZzEnLCAnYXJnMiddCi8vICAgJyJhcmcgd2l0aCBzcGFjZXMiIGFyZzInIC0+IFsnYXJnIHdpdGggc3BhY2VzJywgJ2FyZzInXQovLyAgICcidW5jbG9zZWQgcXVvdGUnIC0+IHRocm93cyBFcnJvcgpmdW5jdGlvbiBwYXJzZUFyZ3VtZW50cyhpbnB1dCkgewogICAgY29uc3QgYXJncyA9IFtdOwogICAgbGV0IGN1cnJlbnRBcmcgPSAnJzsKICAgIGxldCBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgbGV0IHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGNoYXIgPSBpbnB1dFtpXTsKICAgICAgICAKICAgICAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSBpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJ1xcJyAmJiBpICsgMSA8IGlucHV0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaSsrOyAvLyBTa2lwIHRoZSBiYWNrc2xhc2gKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gaW5wdXRbaV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gJyInIHx8IGNoYXIgPT09ICInIikgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gY2hhcjsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSBpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICcgJykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50QXJnID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuY2xvc2VkIHF1b3RlOiBmb3VuZCBvcGVuaW5nICR7aW5zaWRlUXVvdGVzfSBhdCBwb3NpdGlvbiAke3F1b3RlU3RhcnRQb3N9IGJ1dCBubyBjbG9zaW5nIHF1b3RlYCk7CiAgICB9CiAgICAKICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICB9CiAgICAKICAgIHJldHVybiBhcmdzOwp9CgppZiAodGhhdC5tZXNzYWdlWzBdID09ICIuIikgewogICAgY29uc3QgY29tbWFuZFBhcnQgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOyAvLyBSZW1vdmUgdGhlIGRvdAogICAgY29uc3Qgc3BhY2VJbmRleCA9IGNvbW1hbmRQYXJ0LmluZGV4T2YoJyAnKTsKICAgIAogICAgbGV0IGNtZCwgYXJnczsKICAgIGlmIChzcGFjZUluZGV4ID09PSAtMSkgewogICAgICAgIC8vIE5vIGFyZ3VtZW50cwogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0OwogICAgICAgIGFyZ3MgPSB1bmRlZmluZWQ7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEhhcyBhcmd1bWVudHMKICAgICAgICBjbWQgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoMCwgc3BhY2VJbmRleCk7CiAgICAgICAgY29uc3QgYXJnc1N0cmluZyA9IGNvbW1hbmRQYXJ0LnN1YnN0cmluZyhzcGFjZUluZGV4ICsgMSk7CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcGFyc2VkQXJncyA9IHBhcnNlQXJndW1lbnRzKGFyZ3NTdHJpbmcpOwogICAgICAgICAgICBhcmdzID0gcGFyc2VkQXJncy5sZW5ndGggPyBwYXJzZWRBcmdzIDogdW5kZWZpbmVkOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRXJyb3IgcGFyc2luZyBjb21tYW5kIGFyZ3VtZW50czogJHtlcnJvci5tZXNzYWdlfWAsIGxvZ1R5cGU6ICdFcnJvcicgfSk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDcmVhdGUgYSBmcmVzaCBDb21tYW5kc01hbmFnZXIgd2l0aCBlYWNoIGNhbGwgc28gdGhhdCB3ZSBhbHdheXMgaGF2ZSB0aGUgbGF0ZXN0IGNvbW1hbmRzIGFuZCBmdW5jdGlvbmFsaXR5LgogICAgY29uc3QgYWJDb21tYW5kcyA9IG5ldyBBQkNvbW1hbmRzTWFuYWdlcigpOwoKICAgIGlmIChhYkNvbW1hbmRzICYmIGFiQ29tbWFuZHMuaGFzQ29tbWFuZChjbWQpKSB7CiAgICAgICAgLy8gQ2FsbCBjb21tYW5kIHdpdGggYXJncy4KICAgICAgICBhYkNvbW1hbmRzLmNhbGxDb21tYW5kKGNtZCwgYXJncyk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEV2YWx1YXRlIGNvbW1hbmQgYXMgamF2YXNjcmlwdC4KICAgICAgICBjb25zdCBqcyA9IHRoYXQubWVzc2FnZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgb3MucnVuKGpzKTsKICAgIH0KfQoKdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOycAxLX97AmhogkLZGVzY3JpcHRpb24CBADEtf3sCb/FCUJUaGlzIGlzIG1lYW50IHRvIGhhbmRsZSBhbnkgbm9uZSBtZW51IHJlbGF0ZWQgaW5wdXRzL2ludGVyYWN0aW9ucy4nAMS1/ewJoaIJDG9uRmlsZVVwbG9hZAIEAMS1/ewJgsYJyjNAaW1wb3J0IHsgUmVjb3JkRmlsZVJlc3VsdCB9IGZyb20gJ2Nhc3VhbG9zJzsKCi8vZmlsdGVyIG91dCB0aW1lcyB3aGVuIGZpbGUgbG9hZGluZyBpcyBub3QgYWxsb3dlZAppZiAoIWJ1aWxkZXJWZXJzaW9uIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJMaXN0ZW5pbmdGb3JGaWxlVXBsb2FkcyAhPT0gdHJ1ZSkgewogICAgcmV0dXJuOwp9CgovL3ZhcmlvdXMgZmlsZSBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpLnRvTG93ZXJDYXNlKCk7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykuc2hpZnQoKTsKbGV0IHNpemUgPSB0aGF0LmZpbGUuc2l6ZTsKbGV0IG1pbWVUeXBlOwpsZXQgYm90SW5mbyA9IHt9OwoKLy9oYXJkIGxpbWl0IGJhc2VkIG9uIGZpbGUgc2l6ZQppZiAoc2l6ZSA+IDIwMDAwMDAwMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6ICJtYXhpbXVtIGZpbGUgc2l6ZSBleGNlZWRlZCAoMjAwIG1iKSIsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICByZXR1cm47Cn0KCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gZm9yIHJldHJpZXZpbmcgaW1hZ2UgZGltZW5zaW9ucyAmIGFzcGVjdCBmcm9tIEFycmF5QnVmZmVyIGRhdGEuCiAqIFJlcXVpcmVzIENhc3VhbE9TIGJlIGNvbmZpZ3VyZWQgdG8gaGF2ZSBhY2Nlc3MgdG8gdGhlIERPTS4KICovCmZ1bmN0aW9uIGdldEltYWdlRGltZW5zaW9ucyhhcnJheUJ1ZmZlciwgbWltZVR5cGUpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFthcnJheUJ1ZmZlcl0sIHsgdHlwZTogbWltZVR5cGUgfSk7CiAgICAgICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTsKICAgICAgICBjb25zdCBpbWcgPSBuZXcgc2VsZi5JbWFnZSgpOwogICAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7CiAgICAgICAgICAgIHJlc29sdmUoeyB3aWR0aDogaW1nLm5hdHVyYWxXaWR0aCwgaGVpZ2h0OiBpbWcubmF0dXJhbEhlaWdodCwgYXNwZWN0OiBpbWcubmF0dXJhbFdpZHRoIC8gaW1nLm5hdHVyYWxIZWlnaHQgfSk7CiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsKICAgICAgICB9OwogICAgICAgIGltZy5vbmVycm9yID0gcmVqZWN0OwogICAgICAgIGltZy5zcmMgPSB1cmw7CiAgICB9KTsKfQoKLy90aGlzIHN3aXRjaCBoYW5kbGVzIHBvc3NpYmxlIGZpbGVzIGV4dGVuc2lvbnMsIHdoaWxlIHJlamVjdGluZyBhbnkgaXQgZG9lcyBub3QgcmVjb2duaXplCnN3aXRjaCAoZmlsZUV4dGVuc2lvbikgewogICAgY2FzZSAnanBnJzoKICAgIGNhc2UgJ2pwZWcnOgogICAgY2FzZSAnd2VicCc6CiAgICBjYXNlICdnaWYnOgogICAgY2FzZSAncG5nJzoKICAgICAgICBtaW1lVHlwZSA9ICJpbWFnZS8iICsgZmlsZUV4dGVuc2lvbjsKICAgICAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgICAgICBib3RJbmZvLmFuY2hvclBvaW50ID0gJ/Cfp6xbMCwwLC0wLjAxXSc7CgogICAgICAgIGlmIChvcy5kZXZpY2UoKS5zdXBwb3J0c0RPTSkgewogICAgICAgICAgICBjb25zdCBpbWFnZURpbWVuc2lvbnMgPSBhd2FpdCBnZXRJbWFnZURpbWVuc2lvbnModGhhdC5maWxlLmRhdGEsIG1pbWVUeXBlKTsKCiAgICAgICAgICAgIC8vIEFkanVzdCBzY2FsZSB0byByZXNwZWN0IGFzcGVjdCByYXRpby4gVGhpcyBpcyAiY292ZXIiIHNjYWxpbmcgc3R5bGUuCiAgICAgICAgICAgIGlmIChpbWFnZURpbWVuc2lvbnMuYXNwZWN0ID49IDEpIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVYID0gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVZID0gMSAvIGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGJyZWFrOwogICAgY2FzZSAnc3ZnJzoKICAgICAgICBtaW1lVHlwZSA9ICJpbWFnZS9zdmcreG1sIjsKICAgICAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgICAgICBib3RJbmZvLmFuY2hvclBvaW50ID0gJ/Cfp6xbMCwwLC0wLjAxXSc7CgogICAgICAgIGlmIChvcy5kZXZpY2UoKS5zdXBwb3J0c0RPTSkgewogICAgICAgICAgICBjb25zdCBpbWFnZURpbWVuc2lvbnMgPSBhd2FpdCBnZXRJbWFnZURpbWVuc2lvbnModGhhdC5maWxlLmRhdGEsIG1pbWVUeXBlKTsKCiAgICAgICAgICAgIC8vIEFkanVzdCBzY2FsZSB0byByZXNwZWN0IGFzcGVjdCByYXRpby4gVGhpcyBpcyAiY292ZXIiIHNjYWxpbmcgc3R5bGUuCiAgICAgICAgICAgIGlmIChpbWFnZURpbWVuc2lvbnMuYXNwZWN0ID49IDEpIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVYID0gaW1hZ2VEaW1lbnNpb25zLmFzcGVjdDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uc2NhbGVZID0gMSAvIGltYWdlRGltZW5zaW9ucy5hc3BlY3Q7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgYnJlYWs7CiAgICBjYXNlICdnbGInOgogICAgY2FzZSAnZXhyJzoKICAgIGNhc2UgJ2dsdGYnOgogICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICBib3RJbmZvLmZvcm0gPSAibWVzaCI7CiAgICAgICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJnbHRmIjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ2F1eCc6CiAgICBjYXNlICdwZGYnOgogICAgICAgIGxldCBib3REYXRhID0gZmlsZUV4dGVuc2lvbiA9PSAiLmF1eCIgPyBKU09OLnBhcnNlKHRoYXQuZmlsZS5kYXRhKS5zdGF0ZSA6IG9zLnBhcnNlQm90c0Zyb21EYXRhKHRoYXQuZmlsZS5kYXRhKTsKICAgICAgICBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90czogYm90RGF0YSwgb3JpZ2luOiBmaWxlTmFtZSwgc291cmNlRXZlbnQ6ICdmaWxlX3VwbG9hZCcgfSk7CiAgICAgICAgcmV0dXJuOwogICAgY2FzZSAnbXAzJzoKICAgICAgICBtaW1lVHlwZSA9ICdhdWRpby9tcGVnJzsKICAgICAgICBib3RJbmZvLm9uQ2xpY2sgPSAiQCBvcy5wbGF5U291bmQodGFncy5mb3JtQWRkcmVzcyk7IjsKICAgICAgICBib3RJbmZvLmxhYmVsID0gIkNsaWNrIHRvIFBsYXkiOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAnbXA0JzoKICAgICAgICBtaW1lVHlwZSA9ICd2aWRlby9tcDQnOwogICAgICAgIGJvdEluZm8uZm9ybSA9ICJpZnJhbWUiOwogICAgICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAic3JjIjsKICAgICAgICBicmVhazsKICAgIGNhc2UgJ290Zic6CiAgICAgICAgbWltZVR5cGUgPSAnZm9udC9vdGYnOwogICAgICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICd3b2ZmJzoKICAgICAgICBtaW1lVHlwZSA9ICdmb250L3dvZmYnOwogICAgICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgZmlsZSB0eXBlIG5vdCBzdXBwb3J0ZWRgLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIHJldHVybiBuZXcgRXJyb3IoInVuaGFuZGxlZCBmaWxlIHR5cGU6ICIgKyBmaWxlRXh0ZW5zaW9uKTsKfQoKLy90aGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhbmQgb2JqZWN0cyBzZXQgdXAgYSBsb2FkaW5nIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmlmICghbGlua3MubWVudSkgewogICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKfQoKbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYHVwbG9hZGluZ2AgfSk7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpb0lEID8/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsKCmlmICghY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpIHsKICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwp9CgovL3RoaXMgaXMgdGhlIGFjdHVhbCB1cGxvYWQgZnVuY3Rpb25hbGl0eQpsZXQgdXBsb2FkUmVzdWx0OiBSZWNvcmRGaWxlUmVzdWx0ID0gYXdhaXQgbGlua3Muc3RvcmUuYWJQdWJsaXNoRmlsZSh7IGZpbGU6IHRoYXQuZmlsZS5kYXRhLCBmaWxlTmFtZTogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZSB9KTsKCmlmICh1cGxvYWRSZXN1bHQpIHsKICAgIGlmICh1cGxvYWRSZXN1bHQuc3VjY2VzcyB8fCB1cGxvYWRSZXN1bHQuZXJyb3JDb2RlID09PSAnZmlsZV9hbHJlYWR5X2V4aXN0cycpIHsKICAgICAgICBjb25zdCBmaWxlVVJMID0gdXBsb2FkUmVzdWx0LnVybCA/PyB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKICAgICAgICAvL2lmIHRoZSBmaWxlIHNob3VsZCBiZSBpbmNsdWRlZCBhcyBhIGJvdCB3aXRoIGEgbGluaywgdGhpcyBsb2dpYyBoYW5kbGVzIHRoYXQKICAgICAgICBpZiAoT2JqZWN0LmtleXMoYm90SW5mbykubGVuZ3RoID4gMCkgewogICAgICAgICAgICBsZXQgZGltZW5zaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFjdGl2ZURpbWVuc2lvbjsKCiAgICAgICAgICAgIGlmICghZGltZW5zaW9uKSB7CiAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZmFsbGJhY2sgdG8gd2hhdGV2ZXIgaXMgdGhlIHZpc2libGUgcG9ydGFsLgogICAgICAgICAgICAgICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgIGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbDsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCkgewogICAgICAgICAgICAgICAgICAgIGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChkaW1lbnNpb24pIHsKICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uXSA9IHRydWU7CgogICAgICAgICAgICAgICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgcG9zaXRpb24gPSBnZXRCb3RQb3NpdGlvbihsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90LCBkaW1lbnNpb24pOwogICAgICAgICAgICAgICAgICAgIGJvdEluZm9bZGltZW5zaW9uICsgJ1gnXSA9IHBvc2l0aW9uLng7CiAgICAgICAgICAgICAgICAgICAgYm90SW5mb1tkaW1lbnNpb24gKyAnWSddID0gcG9zaXRpb24ueTsKICAgICAgICAgICAgICAgICAgICBib3RJbmZvW2RpbWVuc2lvbiArICdaJ10gPSBwb3NpdGlvbi56OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAobWltZVR5cGUuaW5jbHVkZXMoImZvbnQiKSkgewogICAgICAgICAgICAgICAgYm90SW5mby5sYWJlbEZvbnRBZGRyZXNzID0gZmlsZVVSTDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGJvdEluZm8uZm9ybUFkZHJlc3MgPSBmaWxlVVJMOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBib3QgPSBjcmVhdGUoYm90SW5mbyk7CiAgICAgICAgICAgIAogICAgICAgICAgICBvcy5mb2N1c09uKGJvdCwgeyBkdXJhdGlvbjogMSB9KS5jYXRjaChlID0+IHt9KQogICAgICAgIH0KCiAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGZpbGVVUkwpOwoKICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYEZpbGUgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQuYCwgbG9nVHlwZTogJ2xvZycgfSk7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coeyBtZXNzYWdlOiBgRmlsZSB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogJHtmaWxlVVJMfWAsIGxvZ1R5cGU6ICdsb2cnIH0pOwogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYlRvYXN0KHsgbWVzc2FnZTogYEZhaWxlZCB0byB1cGxvYWQgZmlsZS4gUmVhc29uOiAke3VwbG9hZFJlc3VsdC5lcnJvck1lc3NhZ2UudG9Mb3dlckNhc2UoKX1gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYEZhaWxlZCB0byB1cGxvYWQgZmlsZS4gUmVzdWx0OiAke0pTT04uc3RyaW5naWZ5KHVwbG9hZFJlc3VsdCl9YCwgbG9nVHlwZTogYGVycm9yYH0pOwogICAgfQp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBTb21ldGhpbmcgd2VudCB3cm9uZyB3aXRoIGZpbGUgdXBsb2FkLmAsIGxvZ1R5cGU6IGBlcnJvcmB9KTsKfQoKLy9jbGVhciB0aGUgcHJvZ3Jlc3MgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CgppZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gdXBsb2FkUmVzdWx0OycAxLX97AmhogkFbGVhcm4CBADEtf3sCcn5CSjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDEtf3sCaGiCQhyZW1lbWJlcgIEAMS1/ewJ8PkJKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAMS1/ewJoaIJDW1hbmlmZXN0YXRpb24CBADEtf3sCZf6CSjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDEtf3sCaGiCQhhYklnbm9yZQIEAMS1/ewJvvoJBHRydWUnAMS1/ewJoaIJBmNyZWF0ZQIEAMS1/ewJw/oJKPCflJczNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMnAMS1/ewJoaIJBXN0b3JlAgQAxLX97Anq+gko8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicAxLX97AmhogkEbWVudQIEAMS1/ewJkfsJKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAMS1/ewJoaIJB2FiU2hlbGwCBADEtf3sCbj7CQR0cnVlJwDEtf3sCaGiCQlvblRhcENvZGUCBADEtf3sCb37CakCQGNvbnN0IHRhcENvZGUgPSB0aGF0OwoKc3dpdGNoICh0YXBDb2RlKQp7CiAgICBjYXNlICIzMzQyIjoKICAgICAgICBvcy50b2FzdCgid2FraW5nICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5KTsKCiAgICAgICAgdGhpc0JvdC5vbkNoYXQoe21lc3NhZ2U6ICIuLiJ9KTsKICAgICAgICBicmVhazsKICAgIGNhc2UgIjQyNDIiOgogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3BlbigpOwogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICAvL2NvbnNvbGUubG9nKHRhcENvZGUpOwp9JwDEtf3sCaGiCQNhc2sCBADEtf3sCef9CSjwn5SXZWM4NWMxZDYtOWYxYS00MGQ0LTgyZTEtNWJkNjgwMzQ5YzI3JwDEtf3sCaGiCQlhYlZlcnNpb24CBADEtf3sCY7+CQQxMC45JwDEtf3sCaGiCQpvbkJvdEFkZGVkAgQAxLX97AmT/glAQHRoaXNCb3QubG9hZEFCQ29tbWFuZHNNYW5hZ2VyKCk7CnRoaXNCb3QudmFycy5jaGF0SGlzdG9yeSA9IFtdOycAxLX97Amhogkab25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQCBADEtf3sCdT+CeVYQGxldCBhYkNvbW1hbmRzOiBBQkNvbW1hbmRzTWFuYWdlciA9IHRoYXQ7CgovLyBUaGVzZSBhcmUgYWxsIHRoZSBidWlsdC1pbiBjb21tYW5kcy4KCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnaGVscCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBjb21tYW5kcyA9IGFiQ29tbWFuZHMuY29tbWFuZHM7CiAgICBjb25zdCBjb21tYW5kS2V5cyA9IE9iamVjdC5rZXlzKGNvbW1hbmRzKTsKCiAgICBsZXQgc2VsZWN0ZWRDb21tYW5kOwogICAgaWYgKGNvbW1hbmRLZXlzICYmIGNvbW1hbmRLZXlzLmxlbmd0aCAmJiBhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgY29tbWFuZEtleU1hdGNoID0gY29tbWFuZEtleXMuZmluZChrZXkgPT4ga2V5ID09PSBhcmdzWzBdKTsKICAgICAgICBzZWxlY3RlZENvbW1hbmQgPSBjb21tYW5kS2V5TWF0Y2g7CiAgICB9CiAgICAKICAgIGxpbmtzLmhlbHAubW91bnQoeyBhYkNvbW1hbmRzTWFuYWdlcjogYWJDb21tYW5kcywgc2VsZWN0ZWRDb21tYW5kIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnU2hvdyB0aGlzIGhlbHAgd2luZG93LiBDYW4gc3BlY2lmeSBhIGNvbW1hbmQgdG8gb3BlbiB0aGUgaGVscCBwYWdlIGZvciB0aGF0IGNvbW1hbmQgZGlyZWN0bHkuJywKICAgIHVzYWdlOiBbJy5oZWxwJywgJy5oZWxwIFtjb21tYW5kXSddCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCcuJywgYXJncyA9PiB0aGlzQm90LmNtZEFCV2FrZShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1dha2UgdXAgYWIuJywKICAgIHVzYWdlOiAnLi4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd3YWtlJywgYXJncyA9PiB0aGlzQm90LmNtZEFCV2FrZShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1dha2UgdXAgYWIuJywKICAgIHVzYWdlOiAnLndha2UnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzbGVlcCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQlNsZWVwKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnUHV0IGFiIHRvIHNsZWVwLicsCiAgICB1c2FnZTogJy5zbGVlcCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2FzaycsIChhcmdzKSA9PiB7CiAgICBpZiAobGlua3MuYXNrKSB7CiAgICAgICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGFza0lucHV0ID0gYXJncy5qb2luKCcgJyk7CiAgICAgICAgICAgIGxpbmtzLmFzay5hYkNvcmVNZW51QWN0aW9uKGFza0lucHV0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAuYXNrIGNvbW1hbmQgcmVxdWlyZXMgaW5wdXRgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYGFzayBib3QgaXMgbm90IGxvYWRlZCwgY2Fubm90IGxvYWQgYXNrYCk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdBc2sgYWInLAogICAgdXNhZ2U6ICcuYXNrIDxhc2tfbmFtZT4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCduYW1lYWInLCBhc3luYyAoYXJncykgPT4gewogICAgY29uc3QgbmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5LCB7IHRpdGxlOiAnd2hhdCB3b3VsZCB5b3UgbGlrZSB0byBjYWxsIG1lPycgfSk7CiAgICBzZXRUYWdNYXNrKGxpbmtzLnBlcnNvbmFsaXR5LCAnYWJCdWlsZGVySWRlbnRpdHknLCBuYW1lLCAnbG9jYWwnKTsKICAgIHNob3V0KCdjaGFuZ2VQZXJzb25hbGl0eUNvbmZpZycsIHsgbmFtZTogbmFtZSB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dpdmUgYWIgYSBuZXcgbmFtZS4nLAogICAgdXNhZ2U6ICcubmFtZWFiJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc3lzdGVtJywgYXJncyA9PiB0aGlzQm90LmNtZFN5c3RlbShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpbnN0LicsCiAgICBsb25nRGVzY3JpcHRpb246IGBPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaSAgICAKCiAgICBZb3UgbWF5IHByb3ZpZGUgYSBjdXN0b20gc3lzdGVtVGFnTmFtZSB3aXRoIHRoZSBjb21tYW5kLCBpbiBvcmRlciB0byBvcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIG9ubHkgZm9yIGJvdHMgd2l0aCB0aGUgZ2l2ZW4gc3lzdGVtVGFnTmFtZS4gQnkgZGVmYXVsdCwgInN5c3RlbSIgd2lsbCBiZSB1c2VkIGFzIHRoZSBzeXN0ZW1UYWdOYW1lLgoKICAgIEZvciBleGFtcGxlOgoKICAgID4gLnN5c3RlbQogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAic3lzdGVtIiB0YWcuCgogICAgPiAuc3lzdGVtIG15R3JvdXAKICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgIm15R3JvdXAiIHRhZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuc3lzdGVtJywKICAgICAgICAnLnN5c3RlbSBzeXN0ZW1UYWdOYW1lJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBpbiB0aGUgY3VycmVudCB3aW5kb3cuIEJ5IGRlZmF1bHQgdGhlIHN5c3RlbSBwb3J0YWwgd2lsbCBvcGVuIGluIGEgbmV3IHRhYi4nCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nJywgKGFyZ3MpID0+IHsKICAgIGxpbmtzLmNvbnNvbGUudG9nZ2xlQ29uc29sZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVG9nZ2xlIHZpc2libGl0eSBvZiB0aGUgYWIgbG9nLicsCiAgICB1c2FnZTogJy5sb2cnCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZ2NsZWFyJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG1lc3NhZ2VMb2dCb3RzID0gZ2V0Qm90cygiY29uc29sZUxvZ01lc3NhZ2VCb3QiLCB0cnVlKTsKICAgIGRlc3Ryb3kobWVzc2FnZUxvZ0JvdHMpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQ2xlYXIgYWxsIGFiIGxvZyBtZXNzYWdlcy4nLAogICAgdXNhZ2U6ICcubG9nY2xlYXInCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NoZWV0JywgYXJncyA9PiB0aGlzQm90LmNtZFNoZWV0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciBzcGVjaWZpZWQgYm90IG9yIGFuIGVudGlyZSBkaW1lbnNpb24uJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zaGVldCBbb3B0aW9uc10gW3BvcnRhbCB8IGhlbHBlckJvdE5hbWUgfCBib3RJZCB8IGdsb2JhbFRoaXNQYXRoXScsCiAgICAgICAgJ2V4LiAuc2hlZXQgaG9tZScsCiAgICAgICAgJ2V4LiAuc2hlZXQgY29uZmlnQm90JywKICAgICAgICAnZXguIC5zaGVldCAtdCBhMmNmNDczOS0zOWEyLTRmZDYtYjNlZi1jYzQ3ODJmOTcwODknLAogICAgICAgICdleC4gLnNoZWV0IGdsb2JhbFRoaXMubXlPYmplY3QubXlCb3QnLAogICAgICAgICdleC4gLnNoZWV0IG15T2JqZWN0Lm15Qm90JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGluIGEgbmV3IGJyb3dzZXIgdGFiLiBcblxuTk9URTogLnNoZWV0IHdpbGwgYXV0b21hdGljYWxseSBpbnNwZWN0IHRoZSBzcGFjZSBvZiBhIGJvdCBhbmQgZm9yY2Ugb3BlbmluZyBpbiB0aGUgc2FtZSB0YWIgaWYgYSBib3QgaXMgaW4gdGVtcExvY2FsIG9yIHRlbXBTaGFyZWQgc3BhY2UuJywKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdtZW51c2hlZXQnLCAoYXJncykgPT4gewogICAgY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgPSBjb25maWdCb3QudGFncy5tZW51UG9ydGFsOwogICAgaWYgKCFjb25maWdCb3QudGFncy5tZW51UG9ydGFsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBDYW5ub3Qgb3BlbiBzaGVldFBvcnRhbCBmb3IgbWVudVBvcnRhbCBib3RzLiBUaGUgbWVudVBvcnRhbCBpcyBjdXJyZW50bHkgZGlzYWJsZWQuYH0pCiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHRoZSBjdXJyZW50IG1lbnUgcG9ydGFsLicsCiAgICB1c2FnZTogJy5tZW51U2hlZXQnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRpbnN0JywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkSW5zdChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIHRoZSBpbnN0IHRvIGRpc2suJywKICAgIHVzYWdlOiAnLmRvd25sb2FkaW5zdCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkYWInLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRBQihhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIHNwZWNpZmllZCBhYiBncm91cChzKSB0byBkaXNrLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBzcGVjaWZpZWQgYWIgZ3JvdXAocykgdG8gZGlzay4KCiAgICBZb3UgY2FuIHByb3ZpZGUgYSBsaXN0IG9mIGdyb3VwcyB0byBkb3dubG9hZCBhbG9uZyB3aXRoIHRoZSBjb21tYW5kOgogICAgPiAuZG93bmxvYWRhYiBhYkNvcmUgYWJTaGVsbCBhYkludGVyZmFjZQoKICAgIElmIGdyb3VwKHMpIGFyZSBub3QgcHJvdmlkZWQgd2l0aCB0aGUgY29tYW1hbmQgdGhlbiB5b3Ugd2lsbCBiZSBwcm9tcHRlZCB0byBwcm92aWRlIG9uZSB3aXRoIGEgZGlhbG9nLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5kb3dubG9hZGFiIFtvcHRpb25zXSBbZ3JvdXAuLi5dJywKICAgICAgICAnZXguIC5kb3dubG9hZGFiIGFiU2hlbGwgYWJJbnRlcmZhY2UnLAogICAgICAgICdleC4gLmRvd25sb2FkYWIgLXYgMSBteUdyb3VwTmFtZScKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXYnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ1NwZWNpZnkgdGhlIGF1eCBmb3JtYXQgdmVyc2lvbiBudW1iZXIuIGV4LiAtdiAxIHdpbGwgYmUgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgKHB1cmUgYm90IGpzb24pLiBCeSBkZWZhdWx0LCBhYiBmaWxlcyBhcmUgdXN1YWxseSBkb3dubG9hZGVkIGFzIHZlcnNpb24gMiBhdXggZmlsZXMgKGNvbmZsaWN0LWZyZWUgdXBkYXRlKS4nCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRlZ2cnLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRFZ2coYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuIFlvdSB3aWxsIG5lZWQgdG8gcHJvdmlkZSB0aGUgcmVjb3JkS2V5IGFzIHdlbGwgYW5kIHRoZSBuYW1lIG9mIHRoZSBlZ2cuIEEgZHJvcGRvd24gc2VsZWN0aW9uIHdpbGwgYmUgcHJvdmlkZWQgZm9yIHRoZSBlZ2cgaWYgZm91bmQgdG8gc2VsZWN0IHdoaWNoIHZlcnNpb24gdG8gZG93bmxvYWQuYCwKICAgIHVzYWdlOiAnLmRvd25sb2FkZWdnJywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvYWRza2lsbCcsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBpZiAoYXJncykgewogICAgICAgIGZvciAobGV0IHNraWxsIG9mIGFyZ3MpIHsKICAgICAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChza2lsbCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCcubG9hZHNraWxsIHJlcXVpcmVzIHNvbWUgc2tpbGwgbmFtZXMnKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0xvYWQgdGhlIHNwZWNpZmllZCBhYiBza2lsbHMuJywKICAgIHVzYWdlOiAnLmxvYWRTa2lsbCBbc2tpbGwgLi4uXScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VybHFyJywgKCkgPT4gb3Muc2hvd1FSQ29kZShjb25maWdCb3QudGFncy51cmwpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnU2hvdyBhIFFSIGNvZGUgZm9yIHRoZSBicm93ZXIgdGFiXCdzIGN1cnJlbnQgVVJMLicsCiAgICB1c2FnZTogJy51cmxxcicKfSk7Cgpjb25zdCBESU1fU1VQUE9SVEVEX1BPUlRBTFMgPSBbJ2dyaWQnLCAnbWFwJywgJ21pbmlHcmlkJywgJ21pbmlNYXAnLCAnc2hlZXQnLCAnc3lzdGVtJywgJ21lbnUnLCAndGFnJ107CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2RpbScsIChhcmdzKSA9PiB7CiAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCkgewogICAgICAgIGxldCBwb3J0YWwgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcCcpOwogICAgICAgIGxldCBkaW1lbnNpb24gPSBhcmdzLmpvaW4oJyAnKTsKCiAgICAgICAgaWYgKCFwb3J0YWwpIHsKICAgICAgICAgICAgcG9ydGFsID0gJ2dyaWQnOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRpbWVuc2lvbiA9PT0gIm51bGwiIHx8IGRpbWVuc2lvbiA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZGltZW5zaW9uID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmIChESU1fU1VQUE9SVEVEX1BPUlRBTFMuaW5kZXhPZihwb3J0YWwpID49IDApIHsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3NbYCR7cG9ydGFsfVBvcnRhbGBdID0gZGltZW5zaW9uOwoKICAgICAgICAgICAgaWYgKGRpbWVuc2lvbiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYENsb3NlZCAke3BvcnRhbH1Qb3J0YWwuYCB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgU2V0ICR7cG9ydGFsfVBvcnRhbCB0byAnJHtkaW1lbnNpb259JyBkaW1lbnNpb24uYCB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgJHtwb3J0YWx9IGlzIG5vdCBhIHN1cHBvcnRlZCBwb3J0YWwgZm9yIHRoZSBkaW0gY29tbWFuZC5gLCBsb2dUeXBlOiAnZXJyb3InIH0pCiAgICAgICAgfQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR28gdG8gc3BlY2lmaWVkIHBvcnRhbCBkaW1lbnNpb24uJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYEdvIHRvIHNwZWNpZmllZCBwcm90YWwgZGltZW5zaW9uLgogICAgCiAgICBJZiBhIHBvcnRhbCBhcmd1bWVudCBpcyBub3QgcHJvdmlkZWQgdGhlbiBpdCB3aWxsIGRlZmF1bHQgdG8gdGhlIGdyaWRQb3J0YWwuCiAgICAKICAgIElmIGEgZGltZW5zaW9uIGlzIG5vdCBwcm92aWRlZCBvciBpcyAibnVsbCIgdGhlbiB0aGUgcG9ydGFsIHdpbGwgYmUgc2V0IHRvIG51bGwgYW5kIGJlIGNsb3NlZC5gLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRpbSA8ZGltZW5zaW9uPicsCiAgICAgICAgJy5kaW0gLXAgPHBvcnRhbD4gPGRpbWVuc2lvbj4nCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1wJywKICAgICAgICAgICAgZGVzY3JpcHRpb246IGBTcGVjaWZ5IHRoZSBwb3J0YWwgbmFtZS4gQ2FuIGJlIGFueW9uZSBvZiB0aGUgZm9sbG93aW5nOiAke0RJTV9TVVBQT1JURURfUE9SVEFMUy5qb2luKCcsICcpfWAKICAgICAgICB9CiAgICBdCgp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXVpZCcsICgpID0+IHsKICAgIG9zLnNldENsaXBib2FyZCh1dWlkKCkpOwoKICAgIGxldCBtZXNzYWdlID0gYENvcGllZCBuZXcgdXVpZCB0byBjbGlwYm9hcmRgOwogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBvcy50b2FzdChtZXNzYWdlKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dlbmVyYXRlIGEgdW5pdmVyc2FsbHkgdW5pcXVlIGlkZW50aWZpZXIgKHV1aWQpIGFuZCBjb3B5IGl0IHRvIHRoZSBjbGlwYm9hcmQuJywKICAgIHVzYWdlOiAnLnV1aWQnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkdXAnLCAoYXJncykgPT4gewogICAgY29uc3QgYm90SWQgPSBhcmdzID8gYXJnc1swXSA6IHVuZGVmaW5lZDsKICAgIGlmIChib3RJZCkgewogICAgICAgIGNvbnN0IGJvdCA9IGdldEJvdCgnaWQnLCBib3RJZCk7CiAgICAgICAgaWYgKGJvdCkgewogICAgICAgICAgICBjb25zdCBkdXBCb3QgPSBjcmVhdGUoYm90KTsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGR1cEJvdC5pZCk7CiAgICAgICAgICAgIG9zLnRvYXN0KCdEdXBsaWNhdGUgYm90IGlkIGNvcGllZCB0byBjbGlwYm9hcmQuJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3MudG9hc3QoYE5vIGJvdCBmb3VuZCB3aXRoIGlkICR7Ym90SWR9YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBvcy50b2FzdCgnUHJvdmlkZSB0aGUgaWQgb2YgdGhlIGJvdCB5b3Ugd2FudCB0byBkdXBsaWNhdGUnKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0R1cGxpY2F0ZSBhIHNwZWNpZmllZCBib3QgYW5kIGNvcHkgdGhlIG5ldyBib3RcJ3MgaWQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcuZHVwIDxib3RJZD4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGxvYWRhdXgnLCAoYXJncykgPT4gewogICAgb3Muc2hvd1VwbG9hZEF1eEZpbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwbG9hZCBBVVggZmlsZShzKSB0byB0aGUgY3VycmVudCBpbnN0LicsCiAgICB1c2FnZTogJy51cGxvYWRhdXgnCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGZpbGVzJywgYXJncyA9PiB0aGlzQm90LmNtZFVwbG9hZEZpbGVzKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIGZpbGUocykgZGlyZWN0bHkgdG8gcmVjb3JkLicsCiAgICB1c2FnZTogWwogICAgICAgICcudXBsb2FkZmlsZXMnLAogICAgICAgICcudXBsb2FkZmlsZXMgLXJlY29yZCA8cmVjb3JkX2lkPicKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXJlY29yZCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3B0aW9uYWxseSBwdWJsaXNoIGZpbGUocykgdG8gYSBzcGVjaWZpYyByZWNvcmQuIElmIG9taXR0ZWQsIGZpbGUocykgd2lsbCBiZSBwdWJsaXNoZWQgdG8gdGhlIHVzZXJcJ3MgcGVyc29uYWwgcmVjb3JkLicKICAgICAgICB9CiAgICBdCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3ZpZXdyZWNvcmRkYXRhJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmICghbGlua3Mudmlld1JlY29yZERhdGFBcHApIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYlZpZXdSZWNvcmQnKTsKICAgIH0KCiAgICBjb25zdCBpc0FsaWFzID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctYScpCgogICAgbGV0IHJlY29yZE5hbWU7CgogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgcmVjb3JkTmFtZSA9IGFyZ3Muam9pbignICcpOwogICAgfQoKICAgIGlmIChpc0FsaWFzKSB7CiAgICAgICAgc3dpdGNoKHJlY29yZE5hbWUpIHsKICAgICAgICAgICAgY2FzZSAncGxheWVyJzoKICAgICAgICAgICAgICAgIGlmIChhdXRoQm90KSB7CiAgICAgICAgICAgICAgICAgICAgcmVjb3JkTmFtZSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC52aWV3cmVjb3JkZGF0YSBtdXN0IGJlIGxvZ2dlZCBpbiB0byB2aWV3IHBsYXllciByZWNvcmQuYCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgJ2FiJzoKICAgICAgICAgICAgICAgIHJlY29yZE5hbWUgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkTmFtZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLnZpZXdyZWNvcmRkYXRhIGNvbW1hbmQgZG9lcyBub3QgcmVjb2duaXplIGFsaWFzICR7cmVjb3JkTmFtZX1gKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGlmICghcmVjb3JkTmFtZSAmJiBhdXRoQm90KSB7CiAgICAgICAgICAgIHJlY29yZE5hbWUgPSBhdXRoQm90LmlkOwogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKHJlY29yZE5hbWUpIHsKICAgICAgICBsaW5rcy52aWV3UmVjb3JkRGF0YUFwcC5tb3VudCh7IHJlY29yZE5hbWUgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC52aWV3cmVjb3JkZGF0YSBjb21tYW5kIHJlcXVpcmVzIGEgcmVjb3JkTmFtZWApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVmlldyBkYXRhIHN0b3JlZCBpbiBwcm92aWRlZCByZWNvcmQgbmFtZS4gSWYgcmVjb3JkIG5hbWUgaXMgbm90IHByb3ZpZGVkIHRoZW4gaXQgd2lsbCBkZWZhdWx0IHRvIHlvdXIgcGVyc29uYWwgcmVjb3JkLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBWaWV3IGRhdGEgc3RvcmVkIGluIHByb3ZpZGVkIHJlY29yZCBuYW1lLiBJZiByZWNvcmQgbmFtZSBpcyBub3QgcHJvdmlkZWQgdGhlbiBpdCB3aWxsIGRlZmF1bHQgdG8geW91ciBwZXJzb25hbCByZWNvcmQuCgogICAgVGhlcmUgYXJlIHNvbWUgYWxpYXNlcyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggdGhlIGFsaWFzIGFyZ3VtZW50IHRvIGxvYWQgYSByZWNvcmQgdmlhIGFsaWFzOgogICAgLSBwbGF5ZXI6IHlvdXIgcGVyc29uYWwgcmVjb3JkCiAgICAtIGFiOiBhYidzIHB1YmxpYyByZWNvcmQKICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcudmlld3JlY29yZGRhdGEnLAogICAgICAgICcudmlld3JlY29yZGRhdGEgW3JlY29yZE5hbWVdJywKICAgICAgICAnLXZpZXdyZWNvcmRkYXRhIC1hIGFiJyAgCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1hJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdUaGUgcHJvdmlkZWQgcmVjb3JkTmFtZSBpcyBhY3R1YWxseSBhbiBhbGlhcy4nCiAgICAgICAgfQogICAgXQp9KScAxLX97AmhogkIYXJ0aWZhY3QCBADEtf3sCbrXCijwn5SXNzhlNDE1MDMtYzkzMy00ZjhhLTgxN2EtYmE5N2JmOGQ1ZDI3JwDEtf3sCaGiCRVsb2FkQUJDb21tYW5kc01hbmFnZXICBADEtf3sCeHXCvotQC8qKgogKiBBQkNvbW1hbmRzTWFuYWdlciBpcyBwYXJ0IG9mIGFiU2hlbGwuCiAqIFlvdSBjYW4gcmVnaXN0ZXIgY29tbWFuZHMgdG8gaXQgdGhhdCBjYW4gYmUgaW52b2tlZCB1c2luZyAnJDxjb21tYW5kPicgd2l0aCB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAqIEl0cyBnZW5lcmFsbHkgbm90IHJlY29tbWVuZGVkIHRvIGNyZWF0ZSB0aGlzIHlvdXJzZWxmIGJ1dCBpbnN0ZWFkIHRvIGxpc3RlbiBmb3IgdGhlIEBvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCBzaG91dAogKiBhbmQgdG8gcmVnaXN0ZXIgeW91ciBjb21tYW5kcyB0aGVyZS4KICogQHByb3Age3N0cmluZ1tdfSBjb21tYW5kcwogKi8KY2xhc3MgQUJDb21tYW5kc01hbmFnZXIgewogICAgY29tbWFuZHM6IFJlY29yZDxzdHJpbmcsIEFCQ29tbWFuZD47CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgdGhpcy5jb21tYW5kcyA9IHt9OwoKICAgICAgICAvLyBTaG91dCB0aGF0IGFuIGluc3RhbmNlIG9mIEFCQ29tbWFuZHNNYW5hZ2VyIGhhcyBiZWVuIGNyZWF0ZWQgYW5kIGFsbG93IGFueSBsaXN0ZW5lcnMKICAgICAgICAvLyB0byBhZGQgdGhlaXIgb3duIGNvbW1hbmRzIHRvIHRoZSBpbnN0YW5jZS4KICAgICAgICBzaG91dCgnb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQnLCB0aGlzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZCBhIGNvbW1hbmQgdG8gQUJDb21tYW5kc01hbmFnZXIuCiAgICAgKiBUaGlzIGNvbW1hbmQgd2lsbCBiZSBhdmFpbGFibGUgdG8gaW52b2tlIHVzaW5nICckPG5hbWU+JyBvbiB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgc3VjY2Vzc2Z1bGx5IGFkZGVkLgogICAgICovCiAgICBhZGRDb21tYW5kKG5hbWU6IHN0cmluZywgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrLCBoZWxwOiBBQkNvbW1hbmRIZWxwKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKCFuYW1lIHx8IHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdIHN0cmluZyBuYW1lIGlzIHJlcXVpcmVkIGZvciBjb21tYW5kcy5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIGFscmVhZHkgZXhpc3RzIGFzIGEgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFjYWxsYmFjayB8fCB0eXBlb2YgY2FsbGJhY2sgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgYSBjYWxsYmFjayBmdW5jdGlvbi5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCBpcyBtaXNzaW5nIHNob3J0RGVzY3JpcHRpb24gZnJvbSBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb21tYW5kc1tuYW1lXSA9IHsgbmFtZSwgY2FsbGJhY2ssIGhlbHAgfTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBoYXNDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRzW25hbWVdICE9IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmUgYSBjb21tYW5kIGZyb20gQUJDb21tYW5kc01hbmFnZXIKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3YXMgcmVtb3ZlZC4gSWYgdGhlIGNvbW1hbmQgZG9lc24ndCBleGlzdCBmYWxzZSB3aWxsIGFsc28gYmUgcmV0dXJuZWQuCiAgICAgKi8KICAgIHJlbW92ZUNvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsIHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3aXRoIHRoZSBwcm92aWRlZCBhcmdzIChpZiBhbnkpLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIGV4ZWN1dGVkLgogICAgICovCiAgICBjYWxsQ29tbWFuZChuYW1lOiBzdHJpbmcsIGFyZ3M/OiBhbnlbXSk6IGJvb2xlYW4gewogICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgIGlmIChjb21tYW5kKSB7CiAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhlbHBBcmcgb2YgY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaGVscEFyZy5pZGVudGlmaWVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goLi4uaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKGhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXNzZXJ0IHRoYXQgdGhlIGlucHV0IGFyZ3MgYXJlIHZhbGlkIGFnYWluc3QgdGhlIGNvbW1hbmQgaGVscCBkb2N1bWVudGF0aW9uLgogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBlYXN5IHdheSB0byB2YWxpZGF0ZSBhcmdzIGJlZm9yZSBleGVjdXRpbmcgYSBjb21tYW5kLgogICAgICAgICAgICAgICAgQUJDb21tYW5kc01hbmFnZXIuYXNzZXJ0VmFsaWRBcmdzKGFyZ3MsIHZhbGlkQXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWFuZC5jYWxsYmFjayhhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIG5vdCBhIHZhbGlkIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgcHJvdmlkZWQgYXJnLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGFuZCB2YWx1ZSBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdWYWx1ZShhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBhbnkgewogICAgICAgIGxldCB2YWx1ZSA9IG51bGw7CgogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIGxldCBkZWxldGVDb3VudCA9IDE7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUluZGV4ID0gYXJnSW5kZXggKyAxOwoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZUluZGV4IDwgYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYXJnc1t2YWx1ZUluZGV4XTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgcmVsYXRlZCBhcmdzICYgdmFsdWVzCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgZGVsZXRlQ291bnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgd2V0aGVyIHRoZSBhcmcgZmxhZyBpcyBwcm92aWRlZCBpbiB0aGUgYXJncy4gV2lsbCByZW1vdmUgdGhlIGFyZyBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdGbGFnKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBhcmcgZmxhZy4KICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCAxKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgc3RhdGljIGFzc2VydFZhbGlkQXJncyhhcmdzOiBhbnlbXSwgdmFsaWRBcmdzOiBhbnlbXSk6IHZvaWQgewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGludmFsaWRBcmdzID0gW107CgogICAgICAgICAgICBmb3IgKGxldCBhcmcgb2YgYXJncykgewogICAgICAgICAgICAgICAgaWYgKGFyZyAmJiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJnIHdlIHdhbnQgdG8gZXZhbHVhdGUuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRBcmdzIHx8ICF2YWxpZEFyZ3MuaW5jbHVkZXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBhcmcgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB2YWxpZEFyZ3MsIHRodXMgdGhlIGFyZyBpcyBpbnZhbGlkLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZEFyZ3MucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHRoaXMgYXJnIGl0IGlzIG1vc3RseSBsaWtlbHkgYSB2YWx1ZSBhcmcuCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaW52YWxpZEFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYEludmFsaWQgYXJndW1lbnRzOiAke2ludmFsaWRBcmdzLmpvaW4oJywgJyl9YDsKCiAgICAgICAgICAgICAgICBvcy50b2FzdChlcnJvck1lc3NhZ2UsIDQpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdsb2JhbFRoaXMuQUJDb21tYW5kc01hbmFnZXIgPSBBQkNvbW1hbmRzTWFuYWdlcjsnAMS1/ewJoaIJBGhlbHACBADEtf3sCdyFCyjwn5SXMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjJwDEtf3sCaGiCQhjbWRTaGVldAIEAMS1/ewJg4YLzRRAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgcG9ydGFsOwpsZXQgbmV3VGFiID0gZmFsc2U7CgppZiAoYXJncykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYXJnID0gYXJnc1tpXTsKICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICBpZiAoYXJnID09PSAnLXQnKSB7CiAgICAgICAgICAgICAgICBuZXdUYWIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghcG9ydGFsKSB7CiAgICAgICAgICAgIHBvcnRhbCA9IGFyZzsKICAgICAgICB9CiAgICB9Cn0KCmlmICghcG9ydGFsKSB7CiAgICBwb3J0YWwgPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCmNvbnN0IGhlbHBlckJvdHMgPSB7CiAgICAnY29uZmlnQm90JzogY29uZmlnQm90LAogICAgJ2dyaWRQb3J0YWxCb3QnOiBncmlkUG9ydGFsQm90LAogICAgJ3NoZWV0UG9ydGFsQm90Jzogc2hlZXRQb3J0YWxCb3QsCiAgICAnc3lzdGVtUG9ydGFsQm90Jzogc3lzdGVtUG9ydGFsQm90LAogICAgJ21pbmlHcmlkUG9ydGFsQm90JzogbWluaUdyaWRQb3J0YWxCb3QsCiAgICAnbWFwUG9ydGFsQm90JzogbWFwUG9ydGFsQm90LAogICAgJ21pbmlNYXBQb3J0YWxCb3QnOiBtaW5pTWFwUG9ydGFsQm90LAogICAgJ21lbnVQb3J0YWxCb3QnOiBtZW51UG9ydGFsQm90LAogICAgJ2xlZnRXcmlzdFBvcnRhbEJvdCc6IGxlZnRXcmlzdFBvcnRhbEJvdCwKICAgICdyaWdodFdyaXN0UG9ydGFsQm90JzogcmlnaHRXcmlzdFBvcnRhbEJvdCwKICAgICdtZWV0UG9ydGFsQm90JzogbWVldFBvcnRhbEJvdCwKICAgICd0YWdQb3J0YWxCb3QnOiB0YWdQb3J0YWxCb3QsCiAgICAnaW11UG9ydGFsQm90JzogaW11UG9ydGFsQm90LAp9OwoKLy8gRnVuY3Rpb24gdG8gcmVzb2x2ZSBhIHBvcnRhbCByZWZlcmVuY2UgdG8gYSBzcGVjaWZpYyBib3QKZnVuY3Rpb24gcmVzb2x2ZVBvcnRhbFRvQm90KHBhdGgpIHsKICAgIGlmICghcGF0aCB8fCBwYXRoID09PSAnJykgcmV0dXJuIG51bGw7CiAgICAKICAgIC8vIEZpcnN0IGNoZWNrIGlmIGl0J3MgZGlyZWN0bHkgaW4gaGVscGVyQm90cwogICAgaWYgKGhlbHBlckJvdHNbcGF0aF0pIHsKICAgICAgICByZXR1cm4gaGVscGVyQm90c1twYXRoXTsKICAgIH0KCiAgICAvLyBQZXJoYXBzIHRoZSBwYXRoIGlzIGEgYm90IGlkLgogICAgbGV0IGJvdEZyb21JZFNlYXJjaCA9IGdldEJvdCgnaWQnLCBwYXRoKTsKICAgIGlmIChib3RGcm9tSWRTZWFyY2gpIHsKICAgICAgICByZXR1cm4gYm90RnJvbUlkU2VhcmNoOwogICAgfQogICAgCiAgICAvLyBDaGVjayBmb3IgYm90aCBkaXJlY3QgYW5kIG5lc3RlZCBwYXRocyBpbiBnbG9iYWxUaGlzCiAgICBsZXQgcGF0aFBhcnRzID0gcGF0aC5zcGxpdCgnLicpOwogICAgbGV0IGN1cnJlbnRPYmogPSBnbG9iYWxUaGlzOwogICAgbGV0IHN0YXJ0SW5kZXggPSAwOwogICAgCiAgICAvLyBIYW5kbGUgaWYgdGhlIHBhdGggZXhwbGljaXRseSBzdGFydHMgd2l0aCAnZ2xvYmFsVGhpcycKICAgIGlmIChwYXRoUGFydHNbMF0gPT09ICdnbG9iYWxUaGlzJykgewogICAgICAgIHN0YXJ0SW5kZXggPSAxOyAvLyBTa2lwIHRoZSAnZ2xvYmFsVGhpcycgcGFydCBzaW5jZSB3ZSdyZSBhbHJlYWR5IHN0YXJ0aW5nIHRoZXJlCiAgICB9CiAgICAKICAgIC8vIFRyYXZlcnNlIHRoZSBwYXRoCiAgICBmb3IgKGxldCBpID0gc3RhcnRJbmRleDsgaSA8IHBhdGhQYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHBhcnQgPSBwYXRoUGFydHNbaV07CiAgICAgICAgaWYgKCFjdXJyZW50T2JqW3BhcnRdKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBQYXRoIHNlZ21lbnQgZG9lc24ndCBleGlzdAogICAgICAgIH0KICAgICAgICBjdXJyZW50T2JqID0gY3VycmVudE9ialtwYXJ0XTsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgaWYgdGhlIGZpbmFsIG9iamVjdCBpcyBhIGJvdCAoaGFzIGlkIGFuZCB0YWdzKQogICAgaWYgKGN1cnJlbnRPYmogJiYgY3VycmVudE9iai5pZCAmJiBjdXJyZW50T2JqLnRhZ3MpIHsKICAgICAgICByZXR1cm4gY3VycmVudE9iajsKICAgIH0KICAgIAogICAgcmV0dXJuIG51bGw7IC8vIE5vdCBhIHZhbGlkIGJvdAp9CgovLyBTZWFyY2ggdG8gc2VlIGlmIHBvcnRhbCBhcmd1bWVudCBpcyBzcGVjaWZpYyB0byBhIGJvdApsZXQgdW5pcXVlQm90ID0gcmVzb2x2ZVBvcnRhbFRvQm90KHBvcnRhbCk7CgppZiAodW5pcXVlQm90KSB7CiAgICBpZiAodW5pcXVlQm90LnRhZ3Muc3BhY2UgPT09ICd0ZW1wTG9jYWwnIHx8CiAgICAgICAgdW5pcXVlQm90LnRhZ3Muc3BhY2UgPT09ICd0ZW1wU2hhcmVkJwogICAgKSB7CiAgICAgICAgLy8gRm9yY2Ugc2hlZXQgdG8gb3BlbiBpbiBzYW1lIHRhYiBpZiB0aGUgYm90IG9ubHkgbGl2ZXMgaW4gdGhpcyB0YWIuCiAgICAgICAgbmV3VGFiID0gZmFsc2U7CiAgICB9CiAgICBwb3J0YWwgPSB1bmlxdWVCb3QuaWQ7Cn0KCmlmIChuZXdUYWIpIHsKICAgIG9zLm9wZW5VUkwoYC8/aW5zdD0ke29zLmdldEN1cnJlbnRJbnN0KCl9JnNoZWV0UG9ydGFsPSR7cG9ydGFsfWApOwp9IGVsc2UgewogICAgY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgPSBwb3J0YWw7Cn0nAMS1/ewJoaIJDWNtZERvd25sb2FkQUICBADEtf3sCdGaC6ALQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IGF1eFZlcnNpb246IHN0cmluZyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnVmFsdWUoYXJncywgJy12Jyk7CgppZiAoIWF1eFZlcnNpb24pIHsKICAgIC8vIERlZmF1bHQgdG8gYXV4IHZlcnNpb24gMiBpZiBhcmd1bWVudCBpcyBub3QgcHJvdmlkZWQuCiAgICBhdXhWZXJzaW9uID0gJzInOwp9CgppZiAoYXV4VmVyc2lvbiAhPT0gJzEnICYmIGF1eFZlcnNpb24gIT09ICcyJykgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgT25seSBhdXggZm9ybWF0IHZlcnNpb24gMSBhbmQgMiBhcmUgc3VwcG9ydGVkIGluIHRoZSBkb3dubG9hZCBhYiBjb21tYW5kLmApOwogICAgcmV0dXJuOwp9CgpsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogZmFsc2UgfSk7CgpsZXQgZ3JvdXBzID0gW107CgppZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgIC8vIFJlbWFpbmluZyBhcmdzIGFyZSBncm91cCBuYW1lcyBwcm92aWRlZCB3aXRoIHRoZSBjb21tYW5kLgogICAgZ3JvdXBzID0gYXJnczsKfSBlbHNlIHsKICAgIGxldCBncm91cCA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAsIHsgdGl0bGU6ICdBQiBHcm91cCBUYWcnLCBhdXRvU2VsZWN0OiB0cnVlIH0pOwogICAgaWYgKGdyb3VwKSB7CiAgICAgICAgbWFza3MucHJldklucHV0RG93bmxvYWRBQkdyb3VwID0gZ3JvdXA7CiAgICAgICAgZ3JvdXBzLnB1c2goZ3JvdXApOwogICAgfQp9Cgpjb25zdCBtYWpvclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1ham9yVmVyc2lvbjsKY29uc3QgbWlub3JWZXJzaW9uID0gbGlua3MubGVhcm4udGFncy5hYkNvcmVNaW5vclZlcnNpb247CmNvbnN0IGFiVmVyc2lvbiA9IGAke21ham9yVmVyc2lvbn0uJHttaW5vclZlcnNpb259YDsKCmZvciAobGV0IGdyb3VwIG9mIGdyb3VwcykgewogICAgY29uc3QgZ3JvdXBCb3RzID0gZ2V0Qm90cyhieU1vZCh7IFtncm91cF06IHRydWUsIHNwYWNlOiAnc2hhcmVkJyB9KSk7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncm91cEJvdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBncm91cEJvdHNbaV0udGFncy5hYlZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9CgogICAgaWYgKGdyb3VwID09ICJhYkNvbmZpZyIpIHsKICAgICAgICBncm91cCA9ICJhYjEiOwogICAgfQoKICAgIGlmIChhdXhWZXJzaW9uID09PSAnMScpIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDEKICAgICAgICBvcy5kb3dubG9hZEJvdHMoZ3JvdXBCb3RzLCBncm91cCkKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRG93bmxvYWQgYXMgdmVyc2lvbiAyCiAgICAgICAgb3MuZG93bmxvYWRCb3RzQXNJbml0aWFsemF0aW9uVXBkYXRlKGdyb3VwQm90cywgZ3JvdXApOwogICAgfQoKfQoKJwDEtf3sCaGiCQljbWRBQldha2UCBADEtf3sCfKlCzFAbGlua3MubWFuaWZlc3RhdGlvbi5hYlNldEF3YWtlKHsgYXdha2U6IHRydWUgfSk7JwDEtf3sCaGiCQpjbWRBQlNsZWVwAgQAxLX97AmkpgvQAUBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiU2V0QXdha2UoeyBhd2FrZTogZmFsc2UgfSk7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwoKdGFnUG9ydGFsQm90Lm1hc2tzLnRhZ1BvcnRhbEFuY2hvclBvaW50ID0gbnVsbDsnAMS1/ewJoaIJB2NvbnNvbGUCBADEtf3sCfWnCyjwn5SXMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViJwDEtf3sCaGiCQ5jbWRVcGxvYWRGaWxlcwIEAMS1/ewJnKgLkxBAY29uc3QgYXJncyA9IHRoYXQ7Cgphc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlKHsgZmlsZSwgcmVjb3JkS2V5IH0pIHsKICAgIGxldCBmaWxlRXh0ZW5zaW9uID0gZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCk7CiAgICBsZXQgZmlsZU5hbWUgPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwogICAgbGV0IG1pbWVUeXBlOwoKICAgIHN3aXRjaCAoZmlsZUV4dGVuc2lvbikgewogICAgICAgIGNhc2UgJ3N2Zyc6CiAgICAgICAgICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdnbGInOgogICAgICAgIGNhc2UgJ2dsdGYnOgogICAgICAgICAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIG1pbWVUeXBlID0gZmlsZS5taW1lVHlwZTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgbGV0IHVybDsKICAgICAgICAKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gcmVjb3JkS2V5OwogICAgY29uc3QgW3Jlc3VsdF0gPSBhd2FpdCBQcm9taXNlLmFsbChzaG91dCgnYWJQdWJsaXNoRmlsZScsIHsgZmlsZSwgZmlsZU5hbWUsIG1pbWVUeXBlIH0pKTsKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gbnVsbDsKICAgIAogICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQudXJsOwogICAgfSBlbHNlIGlmIChyZXN1bHQuZXhpc3RpbmdGaWxlVXJsKSB7CiAgICAgICAgdXJsID0gcmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKICAgIH0KCiAgICByZXR1cm4geyB1cmwgfTsKfQoKY29uc3QgcmVjb3JkS2V5ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXJlY29yZCcpOwpjb25zdCBzZWxlY3RlZEZpbGVzID0gYXdhaXQgb3Muc2hvd1VwbG9hZEZpbGVzKCk7CmNvbnN0IHB1Ymxpc2hSZWNvcmQgPSBnZXRCb3QoJ3N5c3RlbScsICdyYy1wYWNrYWdlLWRldi5wdWJsaXNoUmVjb3JkJyk7CgppZiAoc2VsZWN0ZWRGaWxlcyAmJiBzZWxlY3RlZEZpbGVzLmxlbmd0aCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVwbG9hZCAke3NlbGVjdGVkRmlsZXMubGVuZ3RofSBmaWxlcy4uLmApOwogICAgfQoKICAgIGxldCBkb25lSHRtbCA9ICcnOwoKICAgIGlmIChyZWNvcmRLZXkpIHsKICAgICAgICBkb25lSHRtbCArPSBgPGgyPlJlY29yZCBJZDwvaDI+YDsKICAgICAgICBkb25lSHRtbCArPSBgPHA+JHtyZWNvcmRLZXl9PC9wPmA7CiAgICB9CgogICAgZG9uZUh0bWwgKz0gJzxoMj5VcGxvYWRlZCBGaWxlczwvaDI+JzsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEZpbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb3Muc2hvd0h0bWwoYFVwbG9hZGluZyAke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX0uLi5gKTsKICAgICAgICAKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1cGxvYWRGaWxlKHsKICAgICAgICAgICAgZmlsZTogc2VsZWN0ZWRGaWxlc1tpXSwKICAgICAgICAgICAgcmVjb3JkS2V5LAogICAgICAgICAgICBvblByb2dyZXNzOiAoZmlsZVByb2dyZXNzKSA9PiB7CiAgICAgICAgICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSAke01hdGguY2VpbChmaWxlUHJvZ3Jlc3MgKiAxMDApfSVgKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGlmIChyZXN1bHQudXJsKSB7CiAgICAgICAgICAgIGRvbmVIdG1sICs9IGA8YSBocmVmPSIke3Jlc3VsdC51cmx9IiB0YXJnZXQ9Il9ibGFuayI+JHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9PC9hPjwvYnI+YDsKICAgICAgICB9CgogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSByZXN1bHQ6YCwgcmVzdWx0KTsKICAgIH0KCiAgICBvcy5zaG93SHRtbChkb25lSHRtbCk7Cn0nAMS1/ewJoaIJDmNtZERvd25sb2FkRWdnAgQAxLX97AmwuAv5C0Bjb25zdCByZWNvcmRLZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5LCB7CiAgICB0aXRsZTogJ3JlY29yZCB0byBsb29rdXAgZWdnIGluJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXk6YCwgcmVjb3JkS2V5KTsKCmlmICghcmVjb3JkS2V5KSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ1JlY29yZEtleSA9IHJlY29yZEtleTsKCmNvbnN0IGVnZ05hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnTmFtZSwgewogICAgdGl0bGU6ICduYW1lIG9mIGVnZycsCiAgICB0eXBlOiAndGV4dCcsCn0pCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTmFtZTpgLCBlZ2dOYW1lKTsKCmlmICghZWdnTmFtZSkgewogICAgcmV0dXJuOwp9CgptYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lID0gZWdnTmFtZTsKCmNvbnN0IGVnZyA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICBhYklEOiBlZ2dOYW1lLAogICAgcmVjb3JkS2V5LAogICAgcmV0dXJuVHlwZTogJ2VnZycKfSkKCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnOmAsIGVnZyk7CgppZiAoIUFycmF5LmlzQXJyYXkoZWdnLmVnZ1ZlcnNpb25IaXN0b3J5KSB8fCBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBEYXRhIGZvdW5kIGF0IGFkZHJlc3MgJyR7ZWdnTmFtZX0nIGluIHJlY29yZCAnJHtyZWNvcmRLZXl9JyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYW4gZWdnLmApCiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgZWdnVmVyc2lvbk9wdGlvbnMgPSBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubWFwKChpdGVtLCBpbmRleCkgPT4gewogICAgcmV0dXJuIHsgbGFiZWw6IGB2ZXJzaW9uICR7aW5kZXggKyAxfWAsIHZhbHVlOiBpbmRleCB9Cn0pCgpjb25zdCBzZWxlY3RlZFZlcnNpb25PcHRpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQoZWdnVmVyc2lvbk9wdGlvbnMubGVuZ3RoIC0gMSwgewogICAgdGl0bGU6ICdkb3dubG9hZCBlZ2cgdmVyc2lvbicsCiAgICB0eXBlOiAnbGlzdCcsCiAgICBzdWJ0eXBlOiAnc2VsZWN0JywKICAgIGl0ZW1zOiBlZ2dWZXJzaW9uT3B0aW9ucywKfSkKCmlmICghc2VsZWN0ZWRWZXJzaW9uT3B0aW9uKSB7CiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgYXV4RGF0YVVybCA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeVtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWVdOwpjb25zdCBhdXhEYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShhdXhEYXRhVXJsKTsKY29uc3QgYXV4RmlsZW5hbWUgPSBgJHtlZ2dOYW1lfV92JHtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWUgKyAxfS5hdXhgOwoKb3MuZG93bmxvYWQoYXV4RGF0YSwgYXV4RmlsZW5hbWUsICdhcHBsaWNhdGlvbi9qc29uJyk7JwDEtf3sCaGiCQ9jbWREb3dubG9hZEluc3QCBADEtf3sCarEC4UBQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3QgYm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKb3MuZG93bmxvYWRCb3RzKGJvdHMsIG9zLmdldEN1cnJlbnRJbnN0KCkpOycAxLX97AmhogkGc2VhcmNoAgQAxLX97AmwxQso8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAxLX97AmhogkFdXRpbHMCBADEtf3sCdfFCyjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDEtf3sCaGiCQljbWRTeXN0ZW0CBADEtf3sCf7FC5EHQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3Qgc2FtZVdpbmRvdyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnRmxhZyhhcmdzLCAnLXcnKTsKCmxldCBzeXN0ZW1UYWdOYW1lID0gbnVsbDsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgc3lzdGVtVGFnTmFtZSA9IGFyZ3Muam9pbignICcpOwp9CgppZiAoc2FtZVdpbmRvdykgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4KICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVBvcnRhbCA9IHRydWU7CiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1UYWdOYW1lID0gc3lzdGVtVGFnTmFtZTsKfSBlbHNlIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiBhIG5ldyB0YWIuCiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCk7CgogICAgLy8gUmVtb3ZlIGFueSBwb3J0YWxzIHRoYXQgYXJlIHNldCBpbiB0aGUgVVJMLgogICAgbGV0IHBhcmFtcyA9IHVybC5zZWFyY2hQYXJhbXMua2V5cygpOwogICAgZm9yIChsZXQgcGFyYW0gb2YgcGFyYW1zKSB7CiAgICAgICAgaWYgKHBhcmFtLmVuZHNXaXRoKCdQb3J0YWwnKSkgewogICAgICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZShwYXJhbSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIFR1cm4gb24gdGhlIHN5c3RlbSBwb3J0YWwuCiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtUG9ydGFsJywgJ3RydWUnKTsKICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCdzeXN0ZW1UYWdOYW1lJyk7CgogICAgaWYgKHN5c3RlbVRhZ05hbWUpIHsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtVGFnTmFtZScsIHN5c3RlbVRhZ05hbWUpOwogICAgfQoKICAgIG9zLm9wZW5VUkwodXJsLmhyZWYpOwp9CicAxLX97AmhogkNYWJDaGF0QmFyT3BlbgIEAMS1/ewJkM0LowJAY29uc3QgewogICAgcHJlZmlsbCwKfSA9IHRoYXQgPz8ge30KCm1hc2tzLmNoYXRPcGVuID0gdHJ1ZTsKCm9zLnNob3dDaGF0KHsKICAgIHBsYWNlaG9sZGVyOiAnPiAuaGVscCB0byBzZWUgYXZhaWxhYmxlIGNvbW1hbmRzJywKICAgIGJhY2tncm91bmRDb2xvcjogJyMyZjJmMmYnLAogICAgZm9yZWdyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcGxhY2Vob2xkZXJDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHByZWZpbGwKfSknAMS1/ewJoaIJDmFiQ2hhdEJhckNsb3NlAgQAxLX97Am0zwt2QG1hc2tzLmNoYXRPcGVuID0gZmFsc2U7Cm9zLmhpZGVDaGF0KCk7CgovLyBHaXZlIENhc3VhbE9TIGEgY2hhbmdlIHRvIGFjdHVhbGx5IHJlbW92ZSB0aGUgY2hhdCBiYXIuCmF3YWl0IG9zLnNsZWVwKDApOycAxLX97AmhogkLcGVyc29uYWxpdHkCBADEtf3sCavQCyjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDEtf3sCaGiCQV0eXBlcwIEAMS1/ewJ0tAL8gLwn5OEdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9JwDEtf3sCaGiCRF2aWV3UmVjb3JkRGF0YUFwcAIEAMS1/ewJw9MLKPCflJc5MmZmNmQyOC0zMzUxLTRjZmItODQ2NC05ZDdjNjE0MjdhMjYA"}]}