{"version":2,"updates":[{"id":0,"timestamp":1755612647031,"update":"AekD66SUhgEAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwDrpJSGAQAGc3lzdGVtAgQA66SUhgEBDWFiLnNoZWxsLmdyaWQnAOuklIYBAARmb3JtAgQA66SUhgEPB25vdGhpbmcnAOuklIYBAAxvbkFueUJvdERyYWcCBADrpJSGARe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAOuklIYBAAhyZW1lbWJlcgIEAOuklIYB0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA66SUhgEACGFiSWdub3JlAgQA66SUhgH6AQR0cnVlJwDrpJSGAQAHYWJTaGVsbAIEAOuklIYB/wEEdHJ1ZScA66SUhgEACWFiVmVyc2lvbgIEAOuklIYBhAIEMTAuNScA66SUhgEABWZvY3VzAgQA66SUhgGJAqwEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKTsKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScA66SUhgG2BgZzeXN0ZW0CBADrpJSGAbcGE2FiLnNoZWxsLmNvbXBvbmVudHMnAOuklIYBtgYMQXBwQ29udGFpbmVyAgQA66SUhgHLBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycA66SUhgG2BghUZXh0TGluawIEAOuklIYB+AqjA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwDrpJSGAbYGBldpbmRvdwIEAOuklIYBnA62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAOuklIYBtgYMVGV4dExpbmsuY3NzAgQA66SUhgHTEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwDrpJSGAbYGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAOuklIYBwRJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAOuklIYBtgYKV2luZG93LmNzcwIEAOuklIYBsxOoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAOuklIYBtgYIcmVtZW1iZXICBADrpJSGAdwWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAOuklIYBtgYIYWJJZ25vcmUCBADrpJSGAYMXBHRydWUnAOuklIYBtgYHYWJTaGVsbAIEAOuklIYBiBcEdHJ1ZScA66SUhgG2BglhYlZlcnNpb24CBADrpJSGAY0XBDEwLjUnAOuklIYBtgYLcGVyc29uYWxpdHkCBADrpJSGAZIXKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYgEnAOuklIYBuRcHQXBwLmNzcwIEAOuklIYBuhexFjpyb290IHsKICAtLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgLS1vbi1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogIC0tYWItY29uc29sZS1oZWlnaHQ6IDMzdmg7Cn0KLyogRGFyayBtb2RlIHN1cHBvcnQgKi8KQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykgewogIDpyb290IHsKICAgIC0tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAgIC0tb24tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICB9Cn0KCi5hYi1jb25zb2xlLWJ0biB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiBpbmhlcml0OwogIGxldHRlci1zcGFjaW5nOiBpbmhlcml0OwogIGxpbmUtaGVpZ2h0OiBpbmhlcml0OwogIHRleHQtdHJhbnNmb3JtOiBpbmhlcml0OwogIHRleHQtaW5kZW50OiBpbmhlcml0OwogIHRleHQtc2hhZG93OiBpbmhlcml0OwogIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgbWFyZ2luOiBpbmhlcml0OwogIHBhZGRpbmctYmxvY2s6IGluaGVyaXQ7CiAgcGFkZGluZy1pbmxpbmU6IGluaGVyaXQ7CiAgYm9yZGVyOiBub25lOwogIHRyYW5zZm9ybTogc2NhbGUoMS4yKTsKfQoKLmFiLWNvbnNvbGUgewogIHdpZHRoOiAxMDB2dzsKICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogIHBhZGRpbmc6IDA7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KSBicmlnaHRuZXNzKDIwMCUpOwogIGFuaW1hdGlvbi1uYW1lOiBzbGlkZS1hcHAtaW47CiAgYW5pbWF0aW9uLWR1cmF0aW9uOiAwLjVzOwogIG92ZXJmbG93LXk6IGhpZGRlbjsKICB6LWluZGV4OiAxOwp9CgouYWItY29uc29sZTo6YWZ0ZXIgewogIGNvbnRlbnQ6ICIiOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB0b3A6IDA7CiAgbGVmdDogMDsKICByaWdodDogMDsKICBib3R0b206IDA7CiAgb3BhY2l0eTogMC45OwogIHotaW5kZXg6IDA7Cn0KCkBrZXlmcmFtZXMgc2xpZGUtYXBwLWluIHsKICBmcm9tIHsKICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGN1YmljLWJlemllciguNiwwLC43OSwxLjAzKTsKICAgIC8qIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMTAlKTsgKi8KICAgIC8qIGhlaWdodDogMHB4OyAqLwogICAgLyogbWluLWhlaWdodDogMHB4OyAqLwogICAgbWF4LWhlaWdodDogMHB4OwogIH0KCiAgdG8gewogICAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogICAgLyogbWluLWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOyAqLwogIH0KfQoKLmFiLWNvbnNvbGUgPiBkaXYgewogIHotaW5kZXg6IDE7CiAgcG9zaXRpb246IHJlbGF0aXZlCn0KCi5hYi1jb25zb2xlLXRvcC1iYXIgewogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHdpZHRoOiAxMDAlOwogIHRleHQtYWxpZ246IGNlbnRlcjsKICB1c2VyLXNlbGVjdDogbm9uZTsKICBkaXNwbGF5OiBmbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBlbmQ7CiAgcGFkZGluZzogMC41cmVtOwp9CgouYWItY29uc29sZS1sb2cgewogIG92ZXJmbG93LXk6IGF1dG87CiAgZmxleC1ncm93OiAxOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwogIG1pbi1oZWlnaHQ6IDI0cHg7CiAgcGFkZGluZzogMCAxcmVtOwogIGN1cnNvcjogcG9pbnRlcjsKICBvdmVyc2Nyb2xsLWJlaGF2aW9yOiBjb250YWluOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBjdXJzb3I6IGluaXRpYWw7Cn0KCi5hYi1jb25zb2xlLW1lc3NhZ2UtY29udGFpbmVyIHsKICBtYXJnaW46IDAuNXJlbSAwOwp9Ci5hYi1jb25zb2xlLW1lc3NhZ2UgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGdhcDogOHB4Owp9CgouYWItY29uc29sZS1zcGFjZXIgewogIGZsZXgtc2hyaW5rOiAwOwogIGZsZXgtZ3JvdzogMTsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgbWF4LXdpZHRoOiA4MHZ3OwogIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScA66SUhgG5FwZnZXRBcHACBADrpJSGAewt3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwDrpJSGAbkXC2hpZGVDb25zb2xlAgQA66SUhgHKUZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwDrpJSGAbkXA2xvZwIEAOuklIYB6lKFCUBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGF3YWl0IGNyZWF0ZShib3RUYWdzKTsKCnNob3V0KCJvbkFCTG9nIiwgbG9nQm90KTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwDrpJSGAbkXC3Nob3dDb25zb2xlAgQA66SUhgHwW+0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicA66SUhgG5FwZzeXN0ZW0CBADrpJSGAd5fEGFiLnNoZWxsLmNvbnNvbGUnAOuklIYBuRcNdG9nZ2xlQ29uc29sZQIEAOuklIYB71+WAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScA66SUhgG5FwRmb3JtAgQA66SUhgGGYQdub3RoaW5nJwDrpJSGAbkXB2FiU2hlbGwCBADrpJSGAY5hBHRydWUnAOuklIYBuRcKYWJJRE9yaWdpbgIEAOuklIYBk2EVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwDrpJSGAbkXBlRvcEJhcgIEAOuklIYBqWHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicA66SUhgG5Fw1zaG93Q2hhdElucHV0AgQA66SUhgGdZgVmYWxzZScA66SUhgG5FwpzaG93VG9wQmFyAgQA66SUhgGjZgVmYWxzZScA66SUhgG5FwlhYlZlcnNpb24CBADrpJSGAalmBDEwLjUnAOuklIYBuRcSc2V0QWJFeHBhbmRDb25zb2xlAgQA66SUhgGuZpcCQGNvbnNvbGUubG9nKHRoaXNCb3QudmFycy5zZXRTaG93QWxsKQppZiAodHlwZW9mIHRoaXNCb3QudmFycy5zZXRTaG93QWxsICE9PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHMgPT4gIXMpOwp9IGVsc2UgaWYgKHRoYXQgPT0gdHJ1ZSkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwodHJ1ZSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChmYWxzZSk7Cn0KJwDrpJSGAbkXCGFiSWdub3JlAgQA66SUhgHGaAR0cnVlJwDrpJSGAbkXB01lc3NhZ2UCBADrpJSGActo5xBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPgogICAgICAgICAgICAgICAgICAgIHttZXNzYWdlfQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gTWVzc2FnZTsnAOuklIYBuRcQb25BbnlCb3RzUmVtb3ZlZAIEAOuklIYBs3mtAkBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3RJZCBvZiBib3RJRHMpIHsNCiAgICBpZiAodGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgY29uc3QgZGVsZXRlZCA9IHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmRlbGV0ZShib3RJZCk7DQoNCiAgICAgICAgaWYgKGRlbGV0ZWQpIHsNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdElkOiBib3RJZCB9KTsNCiAgICAgICAgfQ0KICAgIH0NCn0nAOuklIYBuRcOb25BbnlCb3RzQWRkZWQCBADrpJSGAeF7+ANAY29uc3QgeyBib3RzIH0gPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IG5ld0JvdCBvZiBib3RzKSB7DQogICAgaWYgKG5ld0JvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhuZXdCb3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQobmV3Qm90LmlkKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdDogbmV3Qm90IH0pOw0KICAgIH0NCn0nAOuklIYBuRcQb25BbnlCb3RzQ2hhbmdlZAIEAOuklIYB2n/jBUBjb25zdCBib3RzID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3Qgb2YgYm90cykgew0KICAgIGlmIChib3QuYm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKGJvdC5ib3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQoYm90LmJvdC5pZCk7DQoNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IGJvdC5ib3QgfSk7DQogICAgICAgIH0gDQoNCiAgICAgICAgaWYgKGJvdC50YWdzLmluY2x1ZGVzKCJtZXNzYWdlIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoIm5hbWUiKSB8fCBib3QudGFncy5pbmNsdWRlcygidGltZXN0YW1wIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoImNvbnNvbGVMb2dNZXNzYWdlQm90IikpIHsNCiAgICAgICAgICAgIGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7ICAgICAgICANCiAgICAgICAgfQ0KICAgIH0NCn0nAOuklIYBuRcfb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZAIEAOuklIYBvoUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycA66SUhgG5Fx1vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZAIEAOuklIYB9YUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycBBGJvdHMkMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjAScA66SUhgGshgEGc3lzdGVtAgQA66SUhgGthgENYWIuc2hlbGwuaGVscCcA66SUhgGshgEJb25LZXlEb3duAgQA66SUhgG7hgGIAkBpZiAodGFncy5hY3RpdmUgJiYgdGhhdC5rZXlzLmluY2x1ZGVzKCdFc2NhcGUnKSkgewogICAgaWYgKHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgZm9yIChsZXQgY2FsbGJhY2sgb2YgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfScA66SUhgGshgEHdW5tb3VudAIEAOuklIYBxIgBjgFAYXdhaXQgb3MuY29tcGlsZUFwcCh0YWdzLmFwcElkLCA8PjwvPik7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAodGFncy5hcHBJZCk7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IHVuZGVmaW5lZDsKbWFza3MuYWN0aXZlID0gZmFsc2U7JwDrpJSGAayGAQlzdHlsZS5jc3MCBADrpJSGAdOJAfEHLmhlbHAtdGFibGUgewogIHdpZHRoOiAxMDAlOwogIGJvcmRlci1zcGFjaW5nOiAwOwp9CgouaGVscC10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmhlbHAtdGFibGUgdGQgaDMgewogIG1hcmdpbjogMDsKfQoKLmhlbHAtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCi5zZWN0aW9uIHsKICBtYXJnaW4tdG9wOiAxNnB4Owp9Cgouc2VjdGlvbiBwOmZpcnN0LW9mLXR5cGUgewogIG1hcmdpbi10b3A6IDRweDsKICBtYXJnaW4tbGVmdDogMTZweDsKfQoKLmRlc2NyaXB0aW9uIHsgCiAgd2hpdGUtc3BhY2U6IHByZS1saW5lOwp9CgoudXNhZ2UtdGFibGUgewogIGJvcmRlci1zcGFjaW5nOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQsaDMgeyAKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKICBtYXJnaW46IDA7Cn0KCi51c2FnZS10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA2MHB4Owp9CgouYXJncy10YWJsZSB7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5hcmdzLXRhYmxlIHRkIHsKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHBhZGRpbmctYm90dG9tOiA4cHg7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouYXJncy10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA5MHB4OwogIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKQG1lZGlhIChtYXgtd2lkdGg6IDY0MHB4KSwgKG1heC1oZWlnaHQ6IDYwMHB4KSB7CiAgLmhlbHAtd2luZG93IHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbGVmdDogdW5zZXQ7CiAgICB0b3A6IHVuc2V0OwogICAgdHJhbnNmb3JtOiB1bnNldDsKICAgIG1heC13aWR0aDogdW5zZXQ7CiAgICBtYXgtaGVpZ2h0OiB1bnNldDsKICAgIGJveC1zaGFkb3c6IHVuc2V0OwogIH0KfScA66SUhgGshgEJb25EZXN0cm95AgQA66SUhgHFkQETQHRoaXNCb3QudW5tb3VudCgpOycA66SUhgGshgEFbW91bnQCBADrpJSGAdmRAfECQGNvbnN0IHsKICAgIGFiQ29tbWFuZHNNYW5hZ2VyLAogICAgc2VsZWN0ZWRDb21tYW5kCn0gPSB0aGF0ID8/IHt9OwoKaWYgKG1hc2tzLmFjdGl2ZSkgewogICAgYXdhaXQgdGhpc0JvdC51bm1vdW50KCk7Cn0KCmNvbnN0IEFwcCA9IHRoaXNCb3QuQXBwKCk7Cgphd2FpdCBvcy5yZWdpc3RlckFwcCh0YWdzLmFwcElkLCB0aGlzQm90KTsKYXdhaXQgb3MuY29tcGlsZUFwcCh0YWdzLmFwcElkLCA8QXBwIGNvbW1hbmRzPXthYkNvbW1hbmRzTWFuYWdlci5jb21tYW5kc30gaW5pdGlhbFNlbGVjdGVkQ29tbWFuZD17c2VsZWN0ZWRDb21tYW5kfS8+KTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gW107Cm1hc2tzLmFjdGl2ZSA9IHRydWU7JwDrpJSGAayGAQpjb21wb25lbnRzAgQA66SUhgHLlAEo8J+UlzExYzk1YzdkLWExOTMtNDAwZS1iNzEwLTNiYTA0ODZhNmExYScA66SUhgGshgEFdXRpbHMCBADrpJSGAfKUASjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDrpJSGAayGAQhhYklnbm9yZQIEAOuklIYBmZUBBHRydWUnAOuklIYBrIYBB2FiU2hlbGwCBADrpJSGAZ6VAQR0cnVlJwDrpJSGAayGAQlhYlZlcnNpb24CBADrpJSGAaOVAQQxMC41JwDrpJSGAayGAQNBcHACBADrpJSGAaiVAbIvQGNvbnN0IEFwcENvbnRhaW5lciA9IGxpbmtzLmNvbXBvbmVudHMuQXBwQ29udGFpbmVyKCk7CmNvbnN0IFdpbmRvdyA9IGxpbmtzLmNvbXBvbmVudHMuV2luZG93KCk7CmNvbnN0IFRleHRMaW5rID0gbGlua3MuY29tcG9uZW50cy5UZXh0TGluaygpOwpjb25zdCBjc3MgPSBsaW5rcy51dGlscy5hYkNvbXBpbGVDU1MoWyB0aGlzQm90LCBsaW5rcy5jb21wb25lbnRzIF0pOwoKY29uc3QgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlUmVmLCB1c2VNZW1vIH0gPSBvcy5hcHBIb29rczsKCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqLwpjb25zdCBBdmFpbGFibGVDb21tYW5kcyA9ICh7IGNvbW1hbmRzLCBvbkNvbW1hbmRDbGljayB9KSA9PiB7CiAgICBjb25zdCBjb21tYW5kTmFtZXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcykuc29ydCgpOwoKICAgIGNvbnN0IG9uQ2xvc2UgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQ2xvc2V9PnsneCBDbG9zZSd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj5BdmFpbGFibGUgQ29tbWFuZHM8L2gyPgogICAgICAgICAgICA8cD5Vc2FnZTogLmNvbW1hbmQgW29wdGlvbnNdPC9wPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgICAgIHtjb21tYW5kTmFtZXMubWFwKChuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRzW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PFRleHRMaW5rIG9uQ2xpY2s9eygpID0+IG9uQ29tbWFuZENsaWNrKGNvbW1hbmQubmFtZSl9Pntjb21tYW5kLm5hbWV9PC9UZXh0TGluaz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntkZXNjcmlwdGlvbn08L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7Q29tbWFuZH0gcHJvcHMuY29tbWFuZAogKi8KY29uc3QgU3BlY2lmaWNDb21tYW5kID0gKHsgY29tbWFuZCwgb25CYWNrIH0pID0+IHsKICAgIGxldCB1c2FnZSA9ICcnOwogICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKICAgIGxldCBhcmdzID0gbnVsbDsKCiAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC51c2FnZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb21tYW5kLmhlbHAudXNhZ2UpKSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZS5qb2luKCdcbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbjsKICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MgJiYgY29tbWFuZC5oZWxwLmFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhcmdzID0gY29tbWFuZC5oZWxwLmFyZ3M7CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+ICAKICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQmFja30+eyc8IEJhY2snfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+e2NvbW1hbmQubmFtZX08L2gyPgogICAgICAgICAgICB7IHVzYWdlICYmCiAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSd1c2FnZS10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGgzPlVzYWdlOjwvaDM+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2FnZX08L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgZGVzY3JpcHRpb24gJiYgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkRlc2NyaXB0aW9uOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdkZXNjcmlwdGlvbic+e2Rlc2NyaXB0aW9ufTwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgYXJncyAmJgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5Bcmd1bWVudHM6PC9oMz4KICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdhcmdzLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICAgICAgeyBhcmdzLm1hcCgoYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZy5pZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdJZGVudGlmaWVyRGlzcGxheSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyLmpvaW4oJyxcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmcuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBhcmcuZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnSWRlbnRpZmllckRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdEZXNjcmlwdGlvbkRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqIEBwYXJhbSB7YW55W119IFtwcm9wcy5hcmdzXQogKi8KY29uc3QgQXBwID0gKHsgY29tbWFuZHMsIGluaXRpYWxTZWxlY3RlZENvbW1hbmQgfSkgPT4gewogICAgY29uc3QgWyBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZCBdID0gdXNlU3RhdGUoaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCk7CgogICAgLy8gRXNjYXBlIGtleSBwcmVzcyBldmVudCBoYW5kbGVyCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IG9uRXNjYXBlS2V5UHJlc3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZENvbW1hbmQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnB1c2gob25Fc2NhcGVLZXlQcmVzcyk7CgogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrSW5kZXggPSB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5maW5kSW5kZXgoKGNhbGxiYWNrKSA9PiBjYWxsYmFjayA9PT0gb25Fc2NhcGVLZXlQcmVzcyk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnNwbGljZShjYWxsYmFja0luZGV4LCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFtzZWxlY3RlZENvbW1hbmRdKTsKICAgIAogICAgY29uc3Qgb25CYWNrZ3JvdW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CgogICAgY29uc3Qgb25Db21tYW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygobmFtZSkgPT4gewogICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChuYW1lKTsKICAgIH0sIFtzZXRTZWxlY3RlZENvbW1hbmRdKQoKICAgIGNvbnN0IGNvbnRlbnQgPSB1c2VNZW1vKCgpID0+IHsKICAgICAgICBpZiAoIXNlbGVjdGVkQ29tbWFuZCkgewogICAgICAgICAgICByZXR1cm4gPEF2YWlsYWJsZUNvbW1hbmRzIGNvbW1hbmRzPXtjb21tYW5kc30gb25Db21tYW5kQ2xpY2s9e29uQ29tbWFuZENsaWNrfS8+CiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgIHJldHVybiA8U3BlY2lmaWNDb21tYW5kIGNvbW1hbmQ9e2NvbW1hbmRzW3NlbGVjdGVkQ29tbWFuZF19IG9uQmFjaz17KCkgPT4gc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpfS8+CiAgICAgICAgfQogICAgfSwgW2NvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHN0eWxlPntjc3N9PC9zdHlsZT4KCiAgICAgICAgICAgIDxBcHBDb250YWluZXIgb25CYWNrZ3JvdW5kQ2xpY2s9e29uQmFja2dyb3VuZENsaWNrfT4KICAgICAgICAgICAgICAgIDxXaW5kb3c+CiAgICAgICAgICAgICAgICAgICAge2NvbnRlbnR9CiAgICAgICAgICAgICAgICA8L1dpbmRvdz4KICAgICAgICAgICAgPC9BcHBDb250YWluZXI+CiAgICAgICAgPC8+CiAgICApCn0KCnJldHVybiBBcHA7JwDrpJSGAayGAQVhcHBJZAIEAOuklIYB28QBD2FiLWNvbW1hbmQtaGVscCcBBGJvdHMkMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczAScA66SUhgHrxAEGc3lzdGVtAgQA66SUhgHsxAEPYWIuc2hlbGwuY3JlYXRlJwDrpJSGAevEAQRmb3JtAgQA66SUhgH8xAEHbm90aGluZycA66SUhgHrxAELZGVzY3JpcHRpb24CBADrpJSGAYTFAT1Cb3QgdXNlZCB0byBjcmVhdGUvbWFuaWZlc3QgYm90cyBpbnRvIGFuIGFjdHVhbCBzY2VuZS9wb3J0YWwuJwDrpJSGAevEAQxhYkNyZWF0ZUJvdHMCBADrpJSGAcLFAcQoQGxldCB7IAogICAgaW5pdGlhbEJvb3QsIC8vIGNoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4gKG9wdGlvbmFsKQogICAgYm90RGF0YSwgLy8gYm90cyB0byBiZSBnZW5lcmF0ZWQKICAgIG9yaWdpbiwgLy8gd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCiAgICBzdHVkaW8sIC8vIHdoYXQgc3R1ZGlvIGlzIHRoaXMgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgIHJlY29yZCwgLy8gUnlhbiBDb29rOiBkbyB3ZSBuZWVkIHRoaXMgaWYgd2UgYWxyZWFkeSBoYXZlIHN0dWRpbz8gKG9wdGlvbmFsKQogICAgdmVyc2lvbiwgLy8gdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCiAgICBlZ2dQYXJhbWV0ZXJzLCAvLyBkYXRhIHRvIHBhc3MgdG8gYWxsIGNyZWF0ZWQgYm90cyB2aWEgQG9uRWdnSGF0Y2guIChvcHRpb25hbCkKICAgIGlnbm9yZUdyaWRGb2N1cywgLy8gUnlhbiBDb29rOiBhZGRpbmcgdGhpcyBhcyBhbiBvcHRpb25hbCBmbGFnLiAob3B0aW9uYWwpCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIC8vIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIHRoZSBib3RzIGFyZSBjcmVhdGVkLiAob3B0aW9uYWwpCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsIHRvIGFiQ3JlYXRlQm90cy4gKG9wdGlvbmFsKS4KfSA9IHRoYXQ7CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSBmb3Igd2hlbiBhYkNyZWF0ZUJvdHMgZXhwZWN0ZWQgImJvdHMiIHBhcmFtZXRlci4KaWYgKCFib3REYXRhICYmIHRoYXQuYm90cykgewogICAgYm90RGF0YSA9IHRoYXQuYm90czsKfQoKbGV0IGJvdENvdW50ID0gT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoOwpjb25zdCBhYkdyaWRGb2N1cyA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkRm9jdXM7CgovLyBSdW4gc29tZSBhYi1zcGVjaWZpYyBwcmVwcm9jZXNzaW5nIG9mIGJvdCBkYXRhLgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MpIHsKICAgICAgICBkYXRhLnRhZ3MuYWJJRE9yaWdpbiA9IG9yaWdpbjsKICAgICAgICBkYXRhLnRhZ3MuYWJJRFN0dWRpbyA9IHN0dWRpbzsKCiAgICAgICAgaWYgKGRhdGEudGFncy5jcmVhdG9yKSB7CiAgICAgICAgICAgIGRhdGEudGFncy5vbGRDcmVhdG9yID0gZGF0YS50YWdzLmNyZWF0b3I7CiAgICAgICAgfQoKICAgICAgICAvLyBSeWFuIENvb2s6IFRoaXMgdGFyZ2V0UG9zaXRpb24gc3R1ZmYgaXMgYXBwYXJlbnRseSB1c2VkIGZvciBib3QgcGFzdGluZz8gCiAgICAgICAgLy8gVGhpcyBpcyBzb21lIHJlYWxseSBjb25mdXNpbmcgbG9naWMgYW5kIHNob3VsZCBiZSByZWZhY3RvcmVkIGV2ZW50dWFsbHkuCiAgICAgICAgaWYgKChib3RDb3VudCA8IDIgfHwgYm90Q291bnQgPCAzICYmIGJvdERhdGEuYWJYUEJvdCAhPSBudWxsKSAmJiBhYkdyaWRGb2N1cyAmJiAhaWdub3JlR3JpZEZvY3VzKSB7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbiArICdYJ10gPSBhYkdyaWRGb2N1cy5wb3NpdGlvbi54OwogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uICsgJ1knXSA9IGFiR3JpZEZvY3VzLnBvc2l0aW9uLnk7CiAgICAgICAgfQogICAgfQp9CgovLyBEbyBhbm90aGVyIHByZXByb2Nlc3NpbmcgcGFzcyB0aGF0IGFsbG93cyBsaXN0ZW5lcnMgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIHRoZSBib3RzIGFyZWEgY3JlYXRlZC4KbGV0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKHByZXByb2Nlc3NBcmcpCn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVDcmVhdGUnLCBwcmVwcm9jZXNzQXJnKSk7CgppZiAodHlwZW9mIGJvdERhdGEgIT09ICdvYmplY3QnIHx8IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aCA9PT0gMCkgewogICAgLy8gVGhlcmUgaXNuJ3QgYW55IGJvdERhdGEgdG8gY3JlYXRlIGZyb20hCiAgICByZXR1cm47Cn0KCi8vIENyZWF0ZSBib3RzIGZyb20gdGhlIGJvdCBkYXRhLgpsZXQgaWRNYXAgPSBuZXcgTWFwKCk7CmxldCBuZXdCb3RzID0gW107CmxldCBuZXdCb3RJZHMgPSBbXTsKCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncykgewogICAgICAgIHRyeSB7IAogICAgICAgICAgICBjb25zdCBuZXdCb3QgPSBjcmVhdGUoZGF0YS50YWdzKTsKCiAgICAgICAgICAgIGlkTWFwLnNldChkYXRhLmlkLCBuZXdCb3QuaWQpOwogICAgICAgICAgICBuZXdCb3RzLnB1c2gobmV3Qm90KTsKICAgICAgICAgICAgbmV3Qm90SWRzLnB1c2gobmV3Qm90LmlkKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gaW52YWxpZCBib3RgLCBlKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpcHBlZCBib3Q6IGAsIGRhdGEpOwogICAgfQp9CgovLyBBcnJheSBvZiB0YWcgcmVsYXRpb25zaGlwcyB0byBiZSBwcmVzZXJ2ZWQKY29uc3QgbGlua1RhZ3MgPSBbImxpbmsiLCAiY3JlYXRvciIsICJjb25maWdCb3QiLCAibGluZVRvIiwgInRyYW5zZm9ybWVyIiwgImZvcm1MaWdodFRhcmdldCJdOwoKLy8gVGhpcyBsb29wIGNvbnRhaW5zIHRoZSBsb2dpYyBmb3IgcHJlc2VydmluZyB0aGUgbGlua1RhZ3MKZm9yIChsZXQgbmV3Qm90IG9mIG5ld0JvdHMpIHsKICAgIGZvciAobGV0IHRhZyBvZiBsaW5rVGFncykgewogICAgICAgIGxldCB2YWx1ZSA9IG5ld0JvdC50YWdzW3RhZ107CgogICAgICAgIGlmICh0YWcgPT0gImNyZWF0b3IiKSB7CiAgICAgICAgICAgIHZhbHVlID0gbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvcjsKICAgICAgICAgICAgbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVCb3RMaW5rcyhuZXdCb3QsIGlkTWFwKTsKCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgbGV0IG5ld1ZhbHVlID0gdmFsdWUubWFwKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWRNYXAuZ2V0KGlkKSB8fCBpZDsKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdJRCA9IGlkTWFwLmdldCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgaWYgKG5ld0lEKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3SUQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vIFRvYXN0cyBmb3IgaGF0Y2hlcywgYnV0IG9ubHkgb24gYnVpbGRlcgppZiAob3JpZ2luICYmIHZlcnNpb24gJiYgY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlID09IG51bGwgJiYgIWNvbmZpZ0JvdC50YWdzLnBoICYmIGJ1aWxkZXJWZXJzaW9uID09ICJidWlsZGVyIikgewogICAgb3MudG9hc3QoImhhdGNoZWQgIiArIG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uKTsKfQoKaWYgKG9yaWdpbikgewogICAgLy8gQ3JlYXRlIGFiRWdnIGJvdCB0aGF0IHRyYWNrcyBjYW4gYmUgdXNlZCB0byB0cmFjayB3aGF0IGVnZ3MgaGF2ZSBiZWVuIGhhdGNoZWQuCiAgICBjcmVhdGUoewogICAgICAgIHNwYWNlOiAic2hhcmVkIiwKICAgICAgICBhYjogdHJ1ZSwKICAgICAgICBhYkVnZzogdHJ1ZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBvcmlnaW5fYWI6IG9yaWdpbiwKICAgICAgICBvcmlnaW5fdmVyc2lvbjogdmVyc2lvbiwKICAgICAgICBvcmlnaW5fcmVjb3JkOiByZWNvcmQsCiAgICAgICAgb3JpZ2luX3N0dWRpbzogc3R1ZGlvLAogICAgICAgIGZvcm06ICJlZ2ciLAogICAgICAgIGNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgICAgICBsYWJlbDogb3JpZ2luICsgIiB2IiArIHZlcnNpb24sCiAgICB9KTsKfQoKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47Cgp3aGlzcGVyKG5ld0JvdHMsICdvblByZUhhdGNoJywgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOwoKaWYgKGluaXRpYWxCb290KSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy8gb25FZ2dIYXRjaCBmb3IgYWxsIGp1c3QgaGF0Y2hlZCBib3RzCndoaXNwZXIobmV3Qm90cywgIm9uRWdnSGF0Y2giLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgZWdnUGFyYW1ldGVycywgc291cmNlRXZlbnQgfSk7CgovLyBvbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQUJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKc3VwZXJTaG91dCgib25BYkFkZGVkIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIHNvdXJjZUV2ZW50IH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCnJldHVybiBuZXdCb3RzOycA66SUhgHrxAEIcmVtZW1iZXICBADrpJSGAYfuASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDrpJSGAevEAQhhYklnbm9yZQIEAOuklIYBru4BBHRydWUnAOuklIYB68QBB2FiU2hlbGwCBADrpJSGAbPuAQR0cnVlJwDrpJSGAevEAQlhYlZlcnNpb24CBADrpJSGAbjuAQQxMC41JwDrpJSGAevEAQtwZXJzb25hbGl0eQIEAOuklIYBve4BKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDUyOGRjMGY5LTQzZWMtNDNmMy1hNDcwLWUyZGQ2YTBkYTk1ZgEnAOuklIYB5O4BBnN5c3RlbQIEAOuklIYB5e4BEGFiLnNoZWxsLnZlcnNpb24nAOuklIYB5O4BBGZvcm0CBADrpJSGAfbuAQdub3RoaW5nJwDrpJSGAeTuAQhhYklnbm9yZQIEAOuklIYB/u4BBHRydWUnAOuklIYB5O4BB2FiU2hlbGwCBADrpJSGAYPvAQR0cnVlJwDrpJSGAeTuARNhYlNoZWxsTWFqb3JWZXJzaW9uAgQA66SUhgGI7wEBMScA66SUhgHk7gENb25Ta2lsbFVwZGF0ZQIEAOuklIYBiu8BlwFAY29uc3QgdmVyc2lvblN0cmluZyA9IHRhZ3MuYWJTaGVsbE1ham9yVmVyc2lvbiArICIuIiArIHRhZ3MuYWJTaGVsbE1pbm9yVmVyc2lvbjsNCg0KY29uc29sZS5sb2coIltBQlNoZWxsXSBMb2FkZWQgQUIgc2hlbGwgdmVyc2lvbiAiICsgdmVyc2lvblN0cmluZyk7JwDrpJSGAeTuAQlhYlZlcnNpb24CBADrpJSGAaLwAQQxMC41JwDrpJSGAeTuARNhYlNoZWxsTWlub3JWZXJzaW9uAgQA66SUhgGn8AECMTcnAQRib3RzJDc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZgEnAOuklIYBqvABBnN5c3RlbQIEAOuklIYBq/ABDmFiLnNoZWxsLnN0b3JlJwDrpJSGAarwAQRmb3JtAgQA66SUhgG68AEHbm90aGluZycA66SUhgGq8AELZGVzY3JpcHRpb24CBADrpJSGAcLwAT9UaGlzIHNraWxsIGlzIG1lYW50IHRvIGJlIGEgY29uZmlndXJhYmxlIG1lYW5zIHRvIHB1Ymxpc2ggZGF0YS4nAOuklIYBqvABD2FiUHVibGlzaFJlY29yZAIEAOuklIYBgvEBwAZAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBwdWJsaWNGYWNpbmcgPSB0aGF0LnB1YmxpY0ZhY2luZzsKbGV0IHJlY29yZERhdGEgPSB0aGF0LmRhdGE7CmxldCByZWNvcmROYW1lID0gdGhhdC5yZWNvcmROYW1lOwpsZXQgZW5kcG9pbnQgPSB0aGF0LmVuZHBvaW50ID8gdGhhdC5lbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKaWYgKCFyZWNvcmREYXRhKQp7CiAgICByZXR1cm4gIm5vIGRhdGEgc3VwcGxpZWQiOwp9CgppZiAocHVibGljRmFjaW5nKQp7CiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbInB1YmxpY1JlYWQiXX0pOwp9CmVsc2UKeyAgICAKICAgIHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHtlbmRwb2ludDogZW5kcG9pbnQsIG1hcmtlcnM6IFtyZWNvcmROYW1lXX0pOwp9CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGRhdGEgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIHJlY29yZERhdGE7JwDrpJSGAarwAQ1hYlB1Ymxpc2hGaWxlAgQA66SUhgHD9wGsB0Bhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGZpbGUgPSB0aGF0LmZpbGU7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZU5hbWU7CmxldCBtaW1lVHlwZSA9IHRoYXQubWltZVR5cGU7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghZmlsZSkKewogICAgcmV0dXJuICJubyBmaWxlIHN1cHBsaWVkIjsKfQoKbGV0IGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHtkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwogICAgCmlmICghZmlsZVVwbG9hZC5zdWNjZXNzKSAKewogICAgaWYgKGZpbGVVcGxvYWQuZXJyb3JDb2RlID09ICJmaWxlX2FscmVhZHlfZXhpc3RzIikKICAgIHsKICAgICAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgYWxyZWFkeSBleGlzdHMgaW4gIiArIHVzZXJSZWNvcmQpOwoKICAgICAgICByZXR1cm4gZmlsZVVwbG9hZDsKICAgIH0KCiAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24odXNlclJlY29yZCk7CgogICAgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwge2Rlc2NyaXB0aW9uOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlfSk7Cn0KCmlmIChmaWxlVXBsb2FkLnN1Y2Nlc3MpCnsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZmlsZSByZWNvcmRlZCB0byAiICsgdXNlclJlY29yZCk7Cn0KZWxzZQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgZmFpbGVkIHRvIHJlY29yZCIpOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAOuklIYBqvABEGFiQ29yZU1lbnVBY3Rpb24CBADrpJSGAfD+AU1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycA66SUhgGq8AELb25TdG9yZU1lbnUCBADrpJSGAb7/AfCVAUBsZXQgcG9zc2libGVQdWJsaXNoQm90ID0gbmV3IFNldCgpOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cykgewogICAgaWYgKEFycmF5LmlzQXJyYXkobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKSkgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cy5mb3JFYWNoKGIgPT4gcG9zc2libGVQdWJsaXNoQm90LmFkZChiKSk7CiAgICB9IGVsc2UgewogICAgICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKTsKICAgIH0KfQoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIHsKICAgIHBvc3NpYmxlUHVibGlzaEJvdC5hZGQobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyk7Cn0KCnBvc3NpYmxlUHVibGlzaEJvdCA9IEFycmF5LmZyb20ocG9zc2libGVQdWJsaXNoQm90KTsKCmNvbnN0IGJhc2VBQiA9ICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzID8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMuaWQ7CmNvbnN0IGJhc2VCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBiYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgZGVmYXVsdHMgPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIG1hbmFnZXI6ICLwn5SXIiArIHRoaXNCb3QuaWQsCiAgICBtYW5pZmVzdGF0aW9uOiB0YWdzLm1hbmlmZXN0YXRpb24sCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YAp9CgovLyBDcmVhdGUgZG93bmxvYWQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgbGFiZWw6ICJkb3dubG9hZCIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybUFkZHJlc3M6ICJnZXRfYXBwIiwKICAgIHBvc3NpYmxlQm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiRG93bmxvYWQoeyBwb3NzaWJsZUJvdHM6IGxpbmtzLnBvc3NpYmxlQm90fSk7YAp9KTsKCmlmICghYXV0aEJvdCkgCnsKICAgIC8vIENyZWF0ZSBsb2dpbiBtZXNzYWdlCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgICAgIGxhYmVsOiAicGxlYXNlIHNpZ24gaW4gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siLAogICAgICAgIG9uQ2xpY2s6IGBAIG9zLnJlcXVlc3RBdXRoQm90KClgCiAgICB9KTsKCiAgICByZXR1cm47Cn0KZWxzZSBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIgPT0gIkZyZWVQbGF5IikgCnsKICAgIC8vIENyZWF0ZSB1cGdyYWRlIHN1YnNjcmlwdGlvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInBsZWFzZSB1cGdyYWRlIHlvdXIgc3Vic2NyaXB0aW9uIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIgogICAgfSk7CgogICAgcmV0dXJuOwp9CgoKbGV0IHVzZXJTdHVkaW9zID0gY29uZmlnQm90LnRhZ3MudXNlcl9zdHVkaW9zOwoKaWYgKCF1c2VyU3R1ZGlvcykgCnsKICAgIHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7Cn0KCmlmICh1c2VyU3R1ZGlvcy5zdWNjZXNzKSAKewogICAgY29uc3QgYWN0aXZlU3R1ZGlvID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCk7CgogICAgbGV0IGJhc2VTdHVkaW8gPSBhdXRoQm90LmlkOwoKICAgIGlmIChiYXNlU3R1ZGlvID09IGF1dGhCb3QuaWQpIAogICAgewogICAgICAgIGJhc2VTdHVkaW8gPSAicGxheWVyIjsKICAgIH0KCiAgICBpZiAoYWN0aXZlU3R1ZGlvID09IC0xICYmIGJhc2VTdHVkaW8gIT0gInBsYXllciIpIAogICAgewogICAgICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYmFzZVN0dWRpbzsKICAgIH0KCiAgICBpZiAoY29uZmlnQm90LnRhZ3Muc3R1ZGlvICYmICFhY3RpdmVTdHVkaW8pIAogICAgewogICAgICAgIGNvbnN0IHN0dWRpb01hdGNoID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCgogICAgICAgIGlmIChzdHVkaW9NYXRjaCAhPSAtMSkgewogICAgICAgICAgICBiYXNlU3R1ZGlvID0gYmFzZVN0dWRpbzsKICAgICAgICB9CiAgICB9CgogICAgY29uc3Qgc3R1ZGlvTGFiZWwgPSBhY3RpdmVTdHVkaW8gPT0gLTEgPyBiYXNlU3R1ZGlvIDogdXNlclN0dWRpb3Muc3R1ZGlvc1thY3RpdmVTdHVkaW9dLmRpc3BsYXlOYW1lOwoKICAgIC8vIENyZWF0ZSBzdHVkaW8gc2VsZWN0IGJ1dHRvbgogICAgY29uc3Qgc3R1ZGlvRGlzcGxheUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBsYWJlbDogInN0dWRpbz0iICsgc3R1ZGlvTGFiZWwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUsCiAgICAgICAgc3R1ZGlvSW5mb3JtYXRpb246IHVzZXJTdHVkaW9zLAogICAgICAgIGZvcm1BZGRyZXNzOiAiaW52ZW50b3J5XzIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuc3R1ZGlvU2VsZWN0KHRhZ3Muc3R1ZGlvSW5mb3JtYXRpb24pO2AKICAgIH0pOwoKICAgIG1hc2tzLnN0dWRpb1NlbGVjdEJ1dHRvbiA9IGdldExpbmsoc3R1ZGlvRGlzcGxheUJ1dHRvbik7Cn0KCmNvbnN0IHRvdGFsQm90Q291bnQgPSBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoID4gMCA/IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggbGFiZWwgYnV0dG9uCmNvbnN0IGxhYmVsQm90ID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBsYWJlbDogYHB1Ymxpc2ggcGF0dGVybiAke2Jhc2VCb3RzLmxlbmd0aCA+IDAgPyAiIiA6ICJhcyAifSR7YmFzZUFCfSAoJHt0b3RhbEJvdENvdW50fSBib3Qke2Jhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgdG90YWxCb3RzOiBiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoLAogICAgYWJNZW51U29ydE9yZGVyOiAxLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgZm9ybUFkZHJlc3M6IG51bGwsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IDhweCAwcHggMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItdG9wLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgc2hpZnRTdGF0ZTogZmFsc2UsCiAgICBvbkNsaWNrOiBgQCBjb25zdCBtZW51Qm90cyA9IGdldEJvdHMoJ2FiTWVudVNvcnRPcmRlcicpOwoKICAgICAgICBpZiAodGFncy5zaGlmdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5VXAiLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleURvd24iLCB7a2V5czogWyJTaGlmdCJdfSk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRhZ3Muc2hpZnRTdGF0ZSA9ICF0YWdzLnNoaWZ0U3RhdGU7YCwKICAgIHNjYWxlWTogImF1dG8iLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgbGV0IHRvdGFsQm90cyA9IGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA/IHRoYXQuYWJCb3RzIDogdGhhdC5hYkJvdHMgKyB0aGF0Lm5vbkFCQm90czsKCiAgICBjb25zdCB0b3RhbEJvdFZhciA9IHRvdGFsQm90cyA9PSAxID8gIiBib3QiIDogIiBib3RzIjsKICAgIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzPy5sZW5ndGggID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICBpZiAoZ2V0Qm90KCJhYklET3JpZ2luIiwgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKS5sZW5ndGg7CgogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIGFiQm90cyArICIgYm90cykiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IGFiQm90czsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoIHBhdHRlcm4gYXMgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgICAgICB9ICAgCiAgICB9CiAgICBlbHNlCiAgICB7ICAgCiAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoICIgKyB0aGF0LmFiICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwogICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgfWAKfSk7CgovLyBDcmVhdGUgZW5jcnlwdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgbGFiZWw6ICJlbmNyeXB0IiwKICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgZW5jcnlwdFN0YXRlOiBmYWxzZSwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MuZW5jcnlwdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IHRydWU7CiAgICAgICAgfWAsCn0pOwoKbGV0IGFiQnV0dG9uOwoKaWYgKHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy8gQ3JlYXRlIGluY2x1ZGVCb3RzIGJ1dHRvbgogICAgYWJCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUyLAogICAgICAgIGFiU2VsZWN0aW9uQnV0dG9uOiB0cnVlLAogICAgICAgIGxhYmVsOiBiYXNlQm90cy5sZW5ndGggPiAwICYmIGJhc2VBQiAhPSB1bmRlZmluZWQgPyBgc2VsZWN0ZWQgcGF0dGVybjogJHtiYXNlQUJ9ICgke2Jhc2VCb3RzLmxlbmd0aH0gYm90JHtiYXNlQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgIDogYG5ldyBwYXR0ZXJuICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICdlZ2cnLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYlB1Ymxpc2hTZWxlY3QoKTtgLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhck5vbiA9IHRoYXQubm9uQUJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIGNvbnN0IGJvdFZhckFCID0gdGhhdC5hYkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gdGhhdC5hYiArICIgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhck5vbjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJzZWxlY3RlZCBwYXR0ZXJuOiAiICsgdGhhdC5hYiArICIgKCIgKyB0aGF0LmFiQm90cyArIGJvdFZhckFCOwogICAgICAgIH1gCiAgICB9KTsKfQoKaWYgKG5vbkFCQm90cy5sZW5ndGggPiAwICYmIHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy9pY2x1ZGUgbmV3IGJvdHMKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUzLAogICAgICAgIGFiQnV0dG9uOiBnZXRMaW5rKGFiQnV0dG9uKSwKICAgICAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICAgICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgICAgICBsYWJlbDogYGluY2x1ZGUgbmV3ICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3giLAogICAgICAgIHVuY2xhaW1lZFN0YXRlOiBmYWxzZSwKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSBsaW5rcy5hYkJ1dHRvbi50YWdzLmxhYmVsOwoKICAgICAgICAgICAgICAgIGlmIChsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09PSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRhZ3MudW5jbGFpbWVkU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwoKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogbm9uQUJCb3RzLmxlbmd0aH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKCiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IDB9KTsKICAgICAgICAgICAgfWAsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHMgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJpbmNsdWRlIG5ldyAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyOwoKICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IHRoYXQuYWI7CgogICAgICAgICAgICBpZighbGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSBwdWJsaWMgYnV0dG9uCmlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgCnsKICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IGZhbHNlOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICAgICAgbGFiZWw6ICJpc1B1YmxpYyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICAgICAgcHVibGljU3RhdGU6IGZhbHNlLAogICAgICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MucHVibGljU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgdmVyc2lvbiBzZWxlY3QgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGxhYmVsOiAndmVyc2lvbkZsYWc9Y3VycmVudCcsCiAgICBmb3JtQWRkcmVzczogJ2FsdF9yb3V0ZScsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgc2hvdXQoJ3Nob3dWZXJzaW9uU2VsZWN0b3InKTtgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmxhYmVsID0gJ3ZlcnNpb25GbGFnPScgKyB0aGF0OwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgYCwKfSk7CgovLyBDdXJyZW50IFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2N1cnJlbnQnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX2NoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIEZlZWRiYWNrIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2ZlZWRiYWNrJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTExLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ2ZlZWRiYWNrJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBTdGFibGUgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnc3RhYmxlJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEyLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ3N0YWJsZSc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA0LAogICAgZm9ybUFkZHJlc3M6ICJlZ2ciLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCAwcHggOHB4IDhweCIsCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItYm90dG9tLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm06ICJpbnB1dCIsCiAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICBvbklucHV0VHlwaW5nOiBgQCBsaW5rcy5sYWJlbEJvdC50YWdzLmxhYmVsID0gJ3B1Ymxpc2ggcGF0dGVybiBhcyAnICsgdGhhdC50ZXh0ICsgJyAoJyArIGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzICsgJyBib3QnICsgKGxpbmtzLmxhYmVsQm90LnRhZ3MudG90YWxCb3RzID09IDEgPyAnKScgOiAncyknKTtgLAogICAgbWVudUl0ZW1TaG93U3VibWl0V2hlbkVtcHR5OiB0cnVlLAogICAgdGFyZ2V0Qm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBtZW51SXRlbVRleHQ6IGJhc2VBQiwKICAgIG9uU3VibWl0OiBgQAogICAgICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoYXQudGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCB0YXJnZXRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwogICAgICAgICAgICBjb25zdCBjb25maXJtUHVzaCA9IGF3YWl0IG9zLnNob3dDb25maXJtKHsKICAgICAgICAgICAgICAgIHRpdGxlOiAiY29uZmlybSBwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNvbnRlbnQ6ICJwdWJsaXNoICIgKyB0aGF0LnRleHQgKyAiIHRvICIgKyB0YXJnZXRTdHVkaW8gKyAiPyIsCiAgICAgICAgICAgICAgICBjb25maXJtVGV4dDogInB1Ymxpc2giLAogICAgICAgICAgICAgICAgY2FuY2VsVGV4dDogImNhbmNlbCIKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoIWNvbmZpcm1QdXNoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoQUIoeyBhYjogdGhhdC50ZXh0LCBib3Q6IGxpbmtzLnRhcmdldEJvdCwgYmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgbWFudWFsUHVibGlzaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdzdG9yZV9tZW51JyB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJhYiBub3Qgc3BlY2lmaWVkIik7CiAgICAgICAgICAgIH0KICAgICAgICBgLAogICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgCiAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIGxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IG51bGw7CgogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSB0aGF0LmFiOwogICAgfWAKfSk7CgppZiAobGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykgCnsKICAgIC8vIENyZWF0ZSBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDgsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAiY29weSB0byBjbGlwYm9hcmQiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiZmlsZV9jb3B5IiwKICAgICAgICB0YXJnZXRCb3Q6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RGb2N1cywKICAgICAgICBvbkNsaWNrOiBgQCBsZXQgc2VsZWN0ZWRCb3QgPSBsaW5rcy50YXJnZXRCb3Q7CiAgICAgICAgICAgIGxldCBwcmVwcGVkQm90ID0gSlNPTi5zdHJpbmdpZnkoc2VsZWN0ZWRCb3QpOwogICAgICAgICAgICBsZXQgc3RhdGUgPSB7fQoKICAgICAgICAgICAgc3RhdGVbYWJJbnN0TWVtb3J5LnRhZ3MuYWJGb2N1c0RhdGFdID0gc2VsZWN0ZWRCb3Q7CgogICAgICAgICAgICBsZXQgbmV3RmlsZSA9IHt9CiAgICAgICAgICAgIG5ld0ZpbGUudmVyc2lvbiA9IDE7CiAgICAgICAgICAgIG5ld0ZpbGUuc3RhdGUgPSBzdGF0ZTsKCiAgICAgICAgICAgIHZhciBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkobmV3RmlsZSk7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChmb3JtYXR0ZWRGaWxlKTsKCiAgICAgICAgICAgIG9zLnRvYXN0KCJib3QgY29waWVkIHRvIGNsaXBib2FyZCIpOwoKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKICAgICAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CiAgICAgICAgYCwKICAgIH0pOwp9CmVsc2UgCnsKICAgIC8vIENyZWF0ZSBzY2FuIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMTAsCiAgICAgICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgeyAgICAgICAgICAgIAogICAgICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwKICAgICAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgICAgIH1gLAogICAgICAgIGxhYmVsOiAic2NhbiB0byBwdWJsaXNoIiwKICAgICAgICBmb3JtQWRkcmVzczogInFyX2NvZGVfc2Nhbm5lciIsCiAgICAgICAgb25DbGljazogYEAgY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSB0cnVlOyBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpO2AsCiAgICB9KTsKfQoKbGV0IGhvc3RCdXR0b24gPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDUwLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgZm9ybUFkZHJlc3M6ICJncm91cF9hZGQiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBsZWFybjogdGFncy5sZWFybiwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLmxlYXJuLmFiQ3JlYXRlSG9zdCh0aGlzQm90KTsKICAgIGlmICghbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpCiAgICB7CiAgICAgICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKICAgIH1gLAp9OwoKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMCwgMykgKyAiLSIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMyk7Cn0KZWxzZSAKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJnZW5lcmF0ZSBqb2luIGNvZGUiOwp9CgppZiAoY29uZmlnQm90LnRhZ3Muc3RhdGljSW5zdCA9PSB1bmRlZmluZWQpCnsKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGhvc3RCdXR0b24pOy8vZ2VuZXJhdGUgYSBob3N0IGJ1dHRvbgp9JwDrpJSGAarwAQ5hYkNvcmVNZW51SWNvbgIEAOuklIYBoZUDCWlvc19zaGFyZScA66SUhgGq8AEPYWJDb3JlTWVudUxhYmVsAgQA66SUhgGrlQMFc2hhcmUnAOuklIYBqvABE2FiQ29yZU1lbnVTb3J0T3JkZXICBADrpJSGAbGVAwEzJwDrpJSGAarwAQhyZW1lbWJlcgIEAOuklIYBs5UDKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAOuklIYBqvABC2FiUHVibGlzaEFCAgQA66SUhgHalQPzNEBpZiAodGhhdC5hYi5pbmRleE9mKCIgIikgIT0gLTEgfHwgdGhhdC5hYi5pbmRleE9mKCciJykgIT0gLTEpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWc6ICJwYXR0ZXJuIG5hbWVzIG1heSBub3QgY29udGFpbiBzcGFjZXMgb3IgcXVvdGFpb24gbWFya3MsIHBsZWFzZSB0cnkgYWdhaW4uIiwgbG9nVHlwZTogImVycm9yIiB9KTsKICAgIHJldHVybjsKfQoKbGlua3MudXRpbHMuYWJMb2coYHB1Ymxpc2hpbmcgJHt0aGF0LmFifWApOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCi8vY2xlYXIgYWIgYnVpbGRlcgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgovL2FiIHZhcmlhYmxlcwpjb25zdCBhYklEID0gdGhhdC5hYjsKbGV0IGtleSA9IHRoYXQua2V5OwpsZXQgdGFyZ2V0ID0gdGhhdC50YXJnZXQgPyB0aGF0LnRhcmdldCA6IHRoYXQuYm90Owpjb25zdCBwdWJsaWNGYWNpbmcgPSB0aGF0LnB1YmxpY0ZhY2luZyA/PyBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmc7CmNvbnN0IGJhc2VBQiA9IHRoYXQuYmFzZUFCID8/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwpjb25zdCBzdHVkaW8gPSB0aGF0LnN0dWRpbyA/PyAoY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZCk7CmNvbnN0IG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2ggPSB0aGF0Lm9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2g7IC8vIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQgdG8gcHJlcHJvY2VzcyB0aGUgZGF0YSBiZWZvcmUgaXQgaXMgcHVibGlzaGVkLiAob3B0aW9uYWwpCmNvbnN0IG1hbnVhbFB1Ymxpc2ggPSB0aGF0Lm1hbnVhbFB1Ymxpc2g7CmNvbnN0IHNvdXJjZUV2ZW50ID0gdGhhdC5zb3VyY2VFdmVudDsgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsLiAob3B0aW9uYWwpCmNvbnN0IHN0YXRlID0ge307CmxldCBmb3JtYXR0ZWRGaWxlID0ge307Cgpjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwoKbGV0IGJ1c3lJbmRpY2F0b3I7CmlmIChtYW51YWxQdWJsaXNoICYmICFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUpIHsKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KICAgIAogICAgYnVzeUluZGljYXRvciA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGB1cGxvYWRpbmcgJHt0aGF0LmFifWAsIG9uRGVzdHJveTogYEBjb25zb2xlLmxvZygnYnVzeSBpbmRpY2F0b3IgZ28gYm9vbScpYH0pOwp9CgppZiAoIXRhcmdldCB8fCB0YXJnZXQubGVuZ3RoIDwgMSkgewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCAmJiBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT09IGFiSUQpOwoKICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwogICAgfSBlbHNlIGlmIChjb25maWdCb3QudGFncy5zZWxlY3RlZEFCICYmIGdldEJvdCgiYWJJRE9yaWdpbiIsIGJhc2VBQikpIHsKICAgICAgICBjb25zdCBlZ2dCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIpOwogICAgICAgIGNvbnN0IG5ld0JvdHMgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSAmJiBiLnRhZ3MuYWJJRE9yaWdpbiA9PSBudWxsKTsKCiAgICAgICAgdGFyZ2V0ID0gWy4uLmVnZ0JvdHMsIC4uLm5ld0JvdHNdOwogICAgfSBlbHNlIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGIgPT4gYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CiAgICB9CgogICAgc2V0VGFnKHRhcmdldCwgImFiSURPcmlnaW4iLCBhYklEKTsKCiAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCID0gbnVsbDsKCiAgICBpZiAodGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBib3RzIGZvdW5kIHRvIHB1Ymxpc2giKTsKCiAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgZ2VuZXJhdGluZyBhIGtleSBmb3IgZW5jcnlwdGlvbiAob3B0aW9uYWwpCmlmIChjb25maWdCb3QudGFncy5lbmNyeXB0aW9uKSB7CiAgICBsZXQga2V5Q2hlY2s7CgogICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CgogICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgdGl0bGU6ICdlbnRlciBhIHNlY3JldCBrZXknCiAgICB9KTsKCiAgICBpZiAoa2V5KSB7CiAgICAgICAga2V5Q2hlY2sgPSBhd2FpdCBvcy5zaG93SW5wdXQoIiIsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnY29uZmlybSBzZWNyZXQga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGlmIChrZXkgIT0ga2V5Q2hlY2spIHsKICAgICAgICBpZiAoIWtleUNoZWNrKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoIm5vIGtleSBlbnRlcmVkIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgia2V5cyBkbyBub3QgbWF0Y2giKTsKICAgICAgICB9CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vZm9ybWF0dGluZyBib3RzIGZvciBmaWxlIHN0b3JhZ2UKaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YXJnZXQubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgY3VycmVudEJvdElEID0gdGFyZ2V0W2ldLmlkOwogICAgICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGFyZ2V0W2ldKSk7CgogICAgICAgIHN0YXRlW2N1cnJlbnRCb3RJRF0gPSBjdXJyZW50Qm90RGF0YTsKICAgIH0KfQplbHNlIHsKICAgIHN0YXRlW3RhcmdldC5pZF0gPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldCkpOwp9CgovL2NoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhbmQgcmV0dXJucyBkYXRhIGZvciBwcmV2aW91c2x5IHB1Ymxpc2hlZCBhYidzCmxldCBlZ2dDaGVjayA9IGF3YWl0IHRoaXNCb3QuYWJQcmV2aW91c0VnZ0NoZWNrKHsgYWJJRDogYWJJRCB9KTsKCi8vYWRkIHhwIGJvdCBoZXJlCnN0YXRlLmFiWFBCb3QgPSB7CiAgICBzcGFjZTogInNoYXJlZCIsCiAgICBpZDogImFiWFBCb3QiLAogICAgdGFnczogewogICAgICAgIGZvcm06ICJub3RoaW5nIiwKICAgICAgICBzeXN0ZW06ICJhYi5wYXR0ZXJuLmFiWFBCb3QiLAogICAgICAgIGF1dGhvcklEOiBhdXRoQm90LmlkLAogICAgICAgIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbiwKICAgICAgICB4cDogbGlua3MubGVhcm4udGFncy5hYlhQLAogICAgICAgIHNpZ25hdHVyZTogZWdnQ2hlY2suc2lnbmF0dXJlLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgfQp9OwoKLy8gRG8gYW5vdGhlciBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGFiIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4KbGV0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBhYjogYWJJRCwgc3R1ZGlvLCBwdWJsaWNGYWNpbmcsIHNvdXJjZUV2ZW50IH07CgppZiAob25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlUHVibGlzaChwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlUHVibGlzaCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vYWRkaXRpb25hbCBmaWxlIGRhdGEKZm9ybWF0dGVkRmlsZS52ZXJzaW9uID0gMTsKZm9ybWF0dGVkRmlsZS5zaWduYXR1cmUgPSBlZ2dDaGVjay5zaWduYXR1cmU7CmZvcm1hdHRlZEZpbGUuc3RhdGUgPSBzdGF0ZTsKCi8vYWN0dWFsIGVuY3J5cHRpb24gaWYgY2hvc2VuCmlmIChrZXkpIHsKICAgIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRGaWxlKTsKICAgIGZvcm1hdHRlZEZpbGUgPSBjcnlwdG8uZW5jcnlwdChrZXksIGZvcm1hdHRlZEZpbGUpOwp9CgovL3B1Ymxpc2ggdGhlIGZpbGUKbGV0IHB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUQgfSk7CgovL2dhdGhlciBhZGRpb25hbCBlZ2cgZGF0YQpjb25zdCBhaVBlcm1pdENoZWNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWlfcGVybWl0Iik7CmNvbnN0IGFpUGVybWl0SUQgPSBhaVBlcm1pdENoZWNrLnN1Y2Nlc3MgPyBhaVBlcm1pdENoZWNrLmRhdGEucGVybWl0SUQgOiBmYWxzZTsKCmVnZ0NoZWNrLmVnZ0RhdGEuYWlQZXJtaXQgPSBhaVBlcm1pdElEOwplZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5LnB1c2gocHVibGlzaEZpbGUudXJsKTsKZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CmVnZ0NoZWNrLmVnZ0RhdGEudGFyZ2V0VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwoKLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKbGV0IHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7IGRhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogcHVibGljRmFjaW5nIH0pOwpsZXQgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CgovL3B1Ymxpc2hpbmcgc2hvdXQKc3VwZXJTaG91dCgib25BQlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7CnN1cGVyU2hvdXQoIm9uQWJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCi8vc2VuZCBkYXRhIGFuZCBmb3JtYXQgdXJsIGlmIGRhdGEgc3VjY2Vzc2Z1bGx5IHNlbnQKaWYgKHB1Ymxpc2hSZWNvcmQuc3VjY2VzcykgewogICAgY29uc3QgYmlvcyA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CiAgICBjb25zdCBpbnN0VHlwZSA9IHB1YmxpY0ZhY2luZyA/ICJmcmVlIiA6ICJsb2NhbCI7CgogICAgc2V0VGFnTWFzayhsaW5rcy5sZWFybiwgImFiWFAiLCAiMCIsICJsb2NhbCIpOwoKICAgIGlmIChtYW51YWxQdWJsaXNoKSB7CiAgICAgICAgY29uc3QgdXJsID0gc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJnN0dWRpbz0iICsgc3R1ZGlvICsgIiZiaW9zPSIgKyBiaW9zOwogICAgICAgIG9zLnNldENsaXBib2FyZCh1cmwpOwoKICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIHdpdGggZW5jcnlwdGVkIGRhdGEgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfQogICAgfQoKICAgIHRyeSB7CiAgICAgICAgYXdhaXQgYW5hbHl0aWNzLnJlY29yZEV2ZW50KCdhYl9lZ2dfcHVibGlzaCcsIHsgYWI6IGFiSUQsIHZlcnNpb246IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoIH0pOwogICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgfQp9CmVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogJ3B1Ymxpc2hpbmcgZmFpbGVkJywKICAgICAgICBsb2dUeXBlOiAnZXJyb3InLAogICAgICAgIHRvYXN0OiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlCiAgICB9KQoKICAgIGNvbnNvbGUuZXJyb3IoYGZhaWxlZCBwdWJsaXNoIHJlY29yZDpgLCBwdWJsaXNoUmVjb3JkKTsKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBwdWJsaXNoUmVjb3JkOycA66SUhgGq8AEIYWJJZ25vcmUCBADrpJSGAc7KAwR0cnVlJwDrpJSGAarwAQphYkRvd25sb2FkAgQA66SUhgHTygOBFEBjb25zdCBwb3NzaWJsZUJvdHMgPSB0aGF0Py5wb3NzaWJsZUJvdHM7CmxldCBmaWxlbmFtZSA9IHRoYXQ/LmZpbGVuYW1lOwpsZXQgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKbGV0IG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQ7CmxldCBsb2cgPSB0aGF0Py5sb2cgPz8gdHJ1ZTsKbGV0IHJlb3BlbkFiTWVudSA9IHRoYXQ/LnJlb3BlbkFiTWVudSA/PyB0cnVlOwoKbGV0IGRvd25sb2FkQm90czsKCmNvbnN0IHNob3VsZERvd25sb2FkSW5zdCA9ICFwb3NzaWJsZUJvdHMgfHwgKEFycmF5LmlzQXJyYXkocG9zc2libGVCb3RzKSAmJiBwb3NzaWJsZUJvdHMubGVuZ3RoID09PSAwKTsKCmlmIChzaG91bGREb3dubG9hZEluc3QpIHsKICAgIC8vIERvd25sb2FkIGluc3QuCiAgICBkb3dubG9hZEJvdHMgPSBnZXRCb3RzKGIgPT4gIWIudGFncy5hYklnbm9yZSAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyk7CgogICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgIC8vIEdlbmVyYXRlIGEgZmlsZW5hbWUgaWYgb25lIGlzIG5vdCBnaXZlbi4KICAgICAgICBmaWxlbmFtZSA9IGAke29zLmdldEN1cnJlbnRJbnN0KCl9XyR7bGlua3MudXRpbHMuYWJGaWxlVGltZWNvZGUoKX1gOwogICAgfQoKICAgIGlmIChsb2cpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZygnZG93bmxvYWQgaW5zdCcpOwogICAgfQp9IGVsc2UgewogICAgaWYgKEFycmF5LmlzQXJyYXkocG9zc2libGVCb3RzKSkgewogICAgICAgIC8vIERvd25sb2FkIGJvdHMuCiAgICAgICAgZG93bmxvYWRCb3RzID0gcG9zc2libGVCb3RzOwogICAgICAgIGNvbnN0IGJvdElkcyA9IHBvc3NpYmxlQm90cy5tYXAoYiA9PiBiLmlkKS5zb3J0KCk7CiAgICAgICAgbGV0IGJvdElkc1NIQTEgPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBib3RJZHMpOwoKICAgICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgICAgIC8vIEdlbmVyYXRlIGEgZmlsZW5hbWUgaWYgb25lIGlzIG5vdCBnaXZlbi4KICAgICAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2JvdElkc1NIQTEuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coYGRvd25sb2FkICR7ZG93bmxvYWRCb3RzLmxlbmd0aH0gYm90c2ApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRG93bmxvYWQgYm90LgogICAgICAgIGRvd25sb2FkQm90cyA9IFtwb3NzaWJsZUJvdHNdOwoKICAgICAgICBpZiAoIWZpbGVuYW1lKSB7CiAgICAgICAgICAgIC8vIEdlbmVyYXRlIGEgZmlsZW5hbWUgaWYgb25lIGlzIG5vdCBnaXZlbi4KICAgICAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke3Bvc3NpYmxlQm90cy5pZC5zdWJzdHJpbmcoMCwgNyl9XyR7bGlua3MudXRpbHMuYWJGaWxlVGltZWNvZGUoKX1gOwogICAgICAgIH0KCiAgICAgICAgaWYgKGxvZykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZygnZG93bmxvYWQgYm90Jyk7CiAgICAgICAgfQogICAgfQp9CgppZiAoIUFycmF5LmlzQXJyYXkoZG93bmxvYWRCb3RzKSkgewogICAgZG93bmxvYWRCb3RzID0gW2Rvd25sb2FkQm90c107Cn0KCmNvbnN0IHN0YXRlID0ge307CgovLyBGb3JtYXQgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmZvciAobGV0IGkgPSAwOyBpIDwgZG93bmxvYWRCb3RzLmxlbmd0aDsgaSsrKSB7CiAgICBsZXQgY3VycmVudEJvdElEID0gZG93bmxvYWRCb3RzW2ldLmlkOwogICAgbGV0IGN1cnJlbnRCb3REYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkb3dubG9hZEJvdHNbaV0pKTsKCiAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdERhdGE7Cn0KCmlmICghZmlsZW5hbWUuZW5kc1dpdGgoJy5hdXgnKSkgewogICAgZmlsZW5hbWUgKz0gJy5hdXgnOwp9CgovLyBEbyBhIHByZXByb2Nlc3NpbmcgcGFzcyB0aGF0IGFsbG93cyBsaXN0ZW5lcnMgdG8gcHJlcHJvY2VzcyB0aGUgYm90IGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4KY29uc3QgcHJlcHJvY2Vzc0FyZyA9IHsgYm90RGF0YTogc3RhdGUsIGZpbGVuYW1lLCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkKSB7CiAgICBhd2FpdCBvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZChwcmVwcm9jZXNzQXJnKTsKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkJywgcHJlcHJvY2Vzc0FyZykpOwoKLy8gRG93bmxvYWQgYXMgdjEgYXV4IGZpbGUuCmNvbnN0IGF1eEZpbGUgPSB7IHZlcnNpb246IDEsIHN0YXRlIH07Cm9zLmRvd25sb2FkKGF1eEZpbGUsIGZpbGVuYW1lLCAnYXBwbGljYXRpb24vanNvbicpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmlmIChyZW9wZW5BYk1lbnUpIHsKICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwp9JwDrpJSGAarwAQ1tYW5pZmVzdGF0aW9uAgQA66SUhgHV3gMo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA66SUhgGq8AEEbWVudQIEAOuklIYB/N4DKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAOuklIYBqvABEmFiUHJldmlvdXNFZ2dDaGVjawIEAOuklIYBo98DsQ9ALy90aGlzIGZ1bmN0aW9uIGNoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhdCBhIHNwZWNpZmllZCBhYiwgcmV0dXJuaW5nIGFueSBkYXRhIHRoYXQgaXQgZmluZHMKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgZWdnSGlzdG9yeTsKbGV0IGVnZ0lEOwpsZXQgdGFyZ2V0VmVyc2lvbk51bTsKbGV0IGxhc3RIYXNoOwpsZXQgbWF4VmVyc2lvbk51bTsKbGV0IHN0YWJsZVZlcnNpb247CmxldCBmZWVkYmFja1ZlcnNpb247CmxldCBwcmV2aW91c1hQOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpsZXQgcmVjb3JkTG9va3VwID0gYXdhaXQgb3MuZ2V0RGF0YSh1c2VyUmVjb3JkLCBhYklEKS5jYXRjaChlID0+IHt9KTsKCmlmIChyZWNvcmRMb29rdXAuc3VjY2VzcykgCnsKICAgIGVnZ0hpc3RvcnkgPSByZWNvcmRMb29rdXAuZGF0YS5lZ2dWZXJzaW9uSGlzdG9yeTsKICAgIGVnZ0lEID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnSUQ7CiAgICBwcmV2aW91c1hQID0gcmVjb3JkTG9va3VwLmRhdGEueHAgPz8gMDsKICAgIHRhcmdldFZlcnNpb25OdW0gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7CiAgICBsYXN0SGFzaCA9IGVnZ0hpc3RvcnlbdGFyZ2V0VmVyc2lvbk51bSAtIDFdOwogICAgc3RhYmxlVmVyc2lvbiA9IHJlY29yZExvb2t1cC5kYXRhLnN0YWJsZVZlcnNpb247CiAgICBmZWVkYmFja1ZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5mZWVkYmFja1ZlcnNpb247CiAgICBtYXhWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9IAplbHNlIAp7CiAgICBlZ2dIaXN0b3J5ID0gW107CiAgICBlZ2dJRCA9IHV1aWQoKTsKICAgIHRhcmdldFZlcnNpb25OdW0gPSAxOwogICAgbGFzdEhhc2ggPSAibm9uZSI7CiAgICBtYXhWZXJzaW9uTnVtID0gMTsKICAgIHByZXZpb3VzWFAgPSAwOwp9CgppZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gImZlZWRiYWNrIikgCnsKICAgIGZlZWRiYWNrVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQplbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9PSAic3RhYmxlIikKewogICAgc3RhYmxlVmVyc2lvbiA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfQoKY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwoKbGV0IGVnZyA9IHt9OwoKZWdnLmVnZ1ZlcnNpb25IaXN0b3J5ID0gZWdnSGlzdG9yeTsKZWdnLmVnZ0Zvcm1hdFZlcnNpb24gPSBlZ2dJRDsKZWdnLnRhcmdldFZlcnNpb24gPSB0YXJnZXRWZXJzaW9uTnVtOwplZ2cubWF4VmVyc2lvbiA9IG1heFZlcnNpb25OdW07CmVnZy5sYWJlbCA9ICJ2Iit0YXJnZXRWZXJzaW9uTnVtOwplZ2cuc3RhYmxlVmVyc2lvbiA9IHN0YWJsZVZlcnNpb247CmVnZy5mZWVkYmFja1ZlcnNpb24gPSBmZWVkYmFja1ZlcnNpb247CmVnZy5hYklEID0gYWJJRDsKZWdnLnhwID0gbGlua3MubGVhcm4udGFncy5hYlhQOwoKbGV0IHNpZ25hdHVyZSA9IHt9OwpsZXQgZGF0ZSA9IG5ldyBEYXRlKCk7CmxldCB0aW1lID0gZGF0ZS5nZXRUaW1lKCk7CgpzaWduYXR1cmUucHJldmlvdXNIYXNoID0gbGFzdEhhc2g7CnNpZ25hdHVyZS5hYlZlcnNpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQ29yZVZlcnNpb247CnNpZ25hdHVyZS5lZ2dWZXJzaW9uID0gdGFncy5lZ2dVVUlEOwpzaWduYXR1cmUuZWdnVmVyc2lvbk51bSA9IHRhZ3Mub3ZvVmVyc2lvbjsKc2lnbmF0dXJlLnRpbWVTdGFtcCA9IHRpbWU7CnNpZ25hdHVyZS5jYXN1YWxPU1ZlcnNpb24gPSBbb3MudmVyc2lvbigpXTsKCnJldHVybiB7c2lnbmF0dXJlOiBzaWduYXR1cmUsIGVnZ0RhdGE6IGVnZ307JwDrpJSGAarwAQ9hYkJvdE1lbnVBY3Rpb24CBADrpJSGAdXuA01AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycA66SUhgGq8AEOYWJCb3RNZW51TGFiZWwCBADrpJSGAaPvAwVzaGFyZScA66SUhgGq8AENYWJCb3RNZW51SWNvbgIEAOuklIYBqe8DCWlvc19zaGFyZScA66SUhgGq8AESYWJCb3RNZW51U29ydE9yZGVyAgQA66SUhgGz7wMDMy41JwDrpJSGAarwAQVsZWFybgIEAOuklIYBt+8DKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAOuklIYBqvABC2FiUVJQdWJsaXNoAgQA66SUhgHe7wPhAUBjb25maWdCb3QudGFncy5wdWJsaXNoU2NhbiA9IG51bGw7CgpsZXQgc2Nhbm5lZFVSTDsKCnRyeSAKewogICAgc2Nhbm5lZFVSTCA9IG5ldyBVUkwodGhhdCk7Cn0KY2F0Y2ggKGUpIAp7CiAgICBzaG91dCgiYWJQdWJsaXNoQUIiLCB7YWI6IHRoYXQsIHNvdXJjZUV2ZW50OiAncXJfcHVibGlzaCd9KTsKCiAgICB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogdGhhdH0pOwoKICAgIHJldHVybjsKfScA66SUhgGq8AEGc2VhcmNoAgQA66SUhgHA8QMo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScA66SUhgGq8AEHYWJTaGVsbAIEAOuklIYB5/EDBHRydWUnAOuklIYBqvABDHN0dWRpb1NlbGVjdAIEAOuklIYB7PEDiwtALy9zaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJTdHVkaW9NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3Qgc3R1ZGlvcyA9IHRoYXQuc3R1ZGlvczsKY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJTdHVkaW9NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAwOwptZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uYWJTdHVkaW9NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5sYWJlbCA9ICJwbGF5ZXIgc3R1ZGlvIjsKbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldFN0dWRpbyA9PSBhdXRoQm90LmlkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24uc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQCBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHRhZ3Muc3R1ZGlvSUQ7CgpsaW5rcy5tYW5hZ2VyLmxpbmtzLnN0dWRpb1NlbGVjdEJ1dHRvbi50YWdzLmxhYmVsID0gdGFncy5sYWJlbDsKCnNob3V0KCJhYlN0dWRpb01lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc3R1ZGlvcy5sZW5ndGg7IGkrKykKewogICAgbGV0IGFjdGl2ZVN0dWRpbyA9IHN0dWRpb3NbaV07CgogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldFN0dWRpbyA9PSBhY3RpdmVTdHVkaW8uc3R1ZGlvSWQgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVN0dWRpby5kaXNwbGF5TmFtZTsKICAgIG1lbnVCdXR0b24uc3R1ZGlvSUQgPSBhY3RpdmVTdHVkaW8uc3R1ZGlvSWQ7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0nAOuklIYBqvABDmFiUHVibGlzaEFza0lEAgQA66SUhgH2/APbBUBpZiAoIWxpbmtzLm1lbnUpIHsKICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGBwdWJsaXNoaW5nICR7dGhhdC5hc2tJRH1gfSk7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKY29uc3QgcGF0dGVybklEID0gdGhhdC5wYXR0ZXJuSUQ7CmNvbnN0IHN0dWRpb0lEID0gdGhhdC5zdHVkaW9JRCA/IHRoYXQuc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogYXV0aEJvdC5pZDsKY29uc3QgYXNrSUQgPSAiYXNrXyIgKyB0aGF0LmFza0lELnJlcGxhY2VBbGwoIi0iLCAiIik7CmNvbnN0IGVuZHBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50Owpjb25zdCBwdWJsaXNoQXNrID0gYXdhaXQgb3MucmVjb3JkRGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwge3BhdHRlcm5JRDogcGF0dGVybklELCBzdHVkaW9JRDogc3R1ZGlvSUR9LCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCB1cGRhdGVQb2xpY3k6IFthdXRoQm90LmlkXX0pOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHB1Ymxpc2hBc2s7JwDrpJSGAarwAQVpbnB1dAIEAOuklIYB0oIEKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAOuklIYBqvABC2FiRW1iZWRMaW5rAgQA66SUhgH5ggSkA0Bjb25zdCBhYiA9IHRoYXQgPyB0cnVlIDogZmFsc2U7CmNvbnN0IGVtYmVkTGluayA9IGFiID8gImFiPSIgKyB0aGF0IDogImluc3Q9IiArIGNvbmZpZ0JvdC50YWdzLmluc3Q7CmNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwpjb25zdCBlbWJlZFRleHQgPSBgPCFET0NUWVBFIGh0bWw+CsKgwqDCoMKgPGh0bWw+CsKgwqDCoMKgwqDCoMKgwqA8aGVhZD48L2hlYWQ+CsKgwqDCoMKgwqDCoMKgwqA8Ym9keT4KwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgPGlmcmFtZSBzcmM9IiR7c2l0ZU9yaWdpbiArICIvPyIgKyBlbWJlZExpbmt9IiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSI0MDAiIC8+CsKgwqDCoMKgwqDCoMKgwqA8L2JvZHk+CsKgwqDCoMKgPC9odG1sPmA7CgpyZXR1cm4gZW1iZWRUZXh0OycA66SUhgGq8AEPYWJQYXR0ZXJuVXBkYXRlAgQA66SUhgHyhQSlBUAvL3Nob3V0KCJhYlBhdHRlcm5VcGRhdGUiLCB7YWJJRDogYWJJRCwgc3R1ZGlvOnN0dWRpbz8sIGJvdHM6IGJvdHM/fSk7CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgppZiAoIWF1dGhCb3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPyB0aGF0LnN0dWRpbyA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFiTWFuaWZlc3QgPSBnZXRCb3QoYnlNb2Qoe2FiRWdnOiB0cnVlLCBvcmlnaW5fYWI6IGFiSUR9KSk7CgppZiAoIWFiTWFuaWZlc3QpCnsKICAgIHNob3V0KCJvbkxvb2t1cEFCRWdncyIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywgYXV0b0hhdGNoOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm5fdXBkYXRlJ30pOwoKICAgIHJldHVybjsKfQoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBzdHVkaW87Cgpjb25zdCBhYkJvdHMgPSB0aGF0LmJvdHMgPz8gZ2V0Qm90cygiYWJJRE9yaWdpbiIsIGFiSUQpOwoKYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IGFiSUQsIHRhcmdldDogYWJCb3RzLCBwdWJsaWNGYWNpbmc6IHRydWUsIHNvdXJjZUV2ZW50OiAncGF0dGVybl91cGRhdGUnfSk7JwDrpJSGAarwARdhYk11bHRpcGxlQm90TWVudUFjdGlvbgIEAOuklIYBmIsETUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwDrpJSGAarwARphYk11bHRpcGxlQm90TWVudVNvcnRPcmRlcgIEAOuklIYB5osEATInAOuklIYBqvABFWFiTXVsdGlwbGVCb3RNZW51SWNvbgIEAOuklIYB6IsECWlvc19zaGFyZScA66SUhgGq8AEWYWJNdWx0aXBsZUJvdE1lbnVMYWJlbAIEAOuklIYB8osEBXNoYXJlJwDrpJSGAarwAQ9hYlB1Ymxpc2hTZWxlY3QCBADrpJSGAfiLBKoTQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiUGF0dGVybk1lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBhbGxCb3RzID0gZ2V0Qm90cygiYWJJRE9yaWdpbiIpOwpjb25zdCBhbGxQYXR0ZXJucyA9IFsibmV3IHBhdHRlcm4iXTsKCmJvdExvb3A6CmZvciAobGV0IGkgPSAwOyBpIDwgYWxsQm90cy5sZW5ndGg7IGkrKykKewogICAgY29uc3QgYWN0aXZlQm90ID0gYWxsQm90c1tpXTsKCiAgICBpZiAoYWN0aXZlQm90LnRhZ3MuYWJJZ25vcmUpCiAgICB7CiAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgIH0KCiAgICBjb25zdCBwb3NzaWJsZVBhdHRlcm4gPSBhY3RpdmVCb3QudGFncy5hYklET3JpZ2luOwoKICAgIGZvciAobGV0IGogPSAwOyBqIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBqKyspCiAgICB7CiAgICAgICAgY29uc3QgYWN0aXZlUGF0dGVybiA9IGFsbFBhdHRlcm5zW2pdOwoKICAgICAgICBpZiAoYWN0aXZlUGF0dGVybiA9PSBwb3NzaWJsZVBhdHRlcm4gKQogICAgICAgIHsKICAgICAgICAgICAgY29udGludWUgYm90TG9vcDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoaiA9PSBhbGxQYXR0ZXJucy5sZW5ndGggLSAxKQogICAgICAgIHsKICAgICAgICAgICAgYWxsUGF0dGVybnMucHVzaChwb3NzaWJsZVBhdHRlcm4pOwogICAgICAgIH0KICAgIH0KfQoKY29uc3QgdGFyZ2V0QUIgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3QgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiUGF0dGVybk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKbWVudUJ1dHRvbi5yZW1lbWJlciA9IHRhZ3MucmVtZW1iZXI7Cm1lbnVCdXR0b24ub25DbGljayA9IGBAY29uc3QgdG90YWxQYXR0ZXJuQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gdGFncy5sYWJlbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKY29uc3Qgbm9uUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCnNob3V0KCJhYlNlbGVjdFRpdGxlVXBkYXRlIiwge2FiOiB0YWdzLmxhYmVsLCBhYkJvdHM6IHRvdGFsUGF0dGVybkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vblBhdHRlcm5Cb3RzLmxlbmd0aH0pOwoKbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZEFCID0gdGFncy5sYWJlbCA9PSAibmV3IHBhdHRlcm4iID8gbnVsbCA6IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJQYXR0ZXJuTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7YDsKCmFsbFBhdHRlcm5zLnNvcnQoKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgYWxsUGF0dGVybnMubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVQYXR0ZXJuTmFtZSA9IGFsbFBhdHRlcm5zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRBQiA9PSBhY3RpdmVQYXR0ZXJuTmFtZSA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gYWN0aXZlUGF0dGVybk5hbWU7CgogICAgaWYgKGFjdGl2ZVBhdHRlcm5OYW1lID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gLTE7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51U29ydE9yZGVyID0gaTsKICAgIH0KCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKfQoKaWYgKCFnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGZvcm1BZGRyZXNzOiAicmFkaW9fYnV0dG9uX2NoZWNrZWQifSkpKQp7CiAgICBjb25zdCBuZXdCb3QgPSBnZXRCb3QoYnlNb2Qoe2FiUGF0dGVybk1lbnU6IHRydWUsIGxhYmVsOiAibmV3IHBhdHRlcm4ifSkpOwogICAgCiAgICBuZXdCb3QudGFncy5mb3JtQWRkcmVzcyA9ICJyYWRpb19idXR0b25fY2hlY2tlZCI7Cn0nAOuklIYBqvABCWFiVmVyc2lvbgIEAOuklIYBoZ8EBDEwLjUnAOuklIYBqvABC3BlcnNvbmFsaXR5AgQA66SUhgGmnwQo8J+Ul2I3NmRmYmM0LTg1NGItNGY2ZC1hOTFmLWE5NDg2OTQ3NzRkYicA66SUhgGq8AEFdXRpbHMCBADrpJSGAc2fBCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwEEYm90cyQ3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcBJwDrpJSGAfSfBBVhYkZpbmRBcnRpZmFjdEJ1bmRsZXMCBADrpJSGAfWfBJMGQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fTsKCmNvbnN0IGFydGlmYWN0QnVuZGxlczogUmVjb3JkPHN0cmluZywgQUJBcnRpZmFjdEJ1bmRsZT4gPSB7fTsgLy8gS2V5IGlzIGFydGlmYWN0IGlkCgpnZXRCb3RzKChiKSA9PiB7CiAgICBpZiAoYi50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGIudGFncy5hYkFydGlmYWN0QnVuZGxlKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGIudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEICYmIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICE9PSBiLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYXJ0aWZhY3RJZCA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlLmlkOwoKICAgICAgICBpZiAoYXJ0aWZhY3RJZCAmJiAhYXJ0aWZhY3RCdW5kbGVzW2FydGlmYWN0SWRdKSB7CiAgICAgICAgICAgIGFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSA9IGIudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIH0KICAgIH0KfSk7CgpyZXR1cm4gYXJ0aWZhY3RCdW5kbGVzOycA66SUhgH0nwQFc3RvcmUCBADrpJSGAYmmBCjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwDrpJSGAfSfBAZzeXN0ZW0CBADrpJSGAbCmBBFhYi5zaGVsbC5hcnRpZmFjdCcA66SUhgH0nwQIYWJJZ25vcmUCBADrpJSGAcKmBAR0cnVlJwDrpJSGAfSfBAlhYlZlcnNpb24CBADrpJSGAcemBAQxMC41JwDrpJSGAfSfBAVkZWJ1ZwIEAOuklIYBzKYEBHRydWUnAOuklIYB9J8ECHJlbWVtYmVyAgQA66SUhgHRpgQo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA66SUhgH0nwQTYWJDcmVhdGVBcnRpZmFjdEJvdAIEAOuklIYB+KYE1hJAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGRpbWVuc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJJbnN0ID8/ICdob21lJywKICAgIHBvc2l0aW9uID0gbmV3IFZlY3RvcjMoMCwgMCwgMCksCiAgICBvdGhlclRhZ3MgPSB7fSwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKY29uc3QgYWJBcnRpZmFjdEJvdCA9IGNyZWF0ZSh7CiAgICBzcGFjZTogJ3NoYXJlZCcsCiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgYWJBcnRpZmFjdEJvdDogdHJ1ZSwKICAgIFtkaW1lbnNpb25dOiB0cnVlLAogICAgW2Ake2RpbWVuc2lvbn1YYF06IHBvc2l0aW9uLngsCiAgICBbYCR7ZGltZW5zaW9ufVlgXTogcG9zaXRpb24ueSwKICAgIFtgJHtkaW1lbnNpb259WmBdOiBwb3NpdGlvbi56LAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIGxhYmVsQ29sb3I6IGFiQXJ0aWZhY3RMYWJlbENvbG9yLAogICAgc3Ryb2tlQ29sb3I6IGFiQXJ0aWZhY3RMYWJlbENvbG9yLAogICAgb25Cb3RBZGRlZDogYEAKICAgICAgICB0aGlzQm90LnVwZGF0ZUNvbXB1dGVkVGFncygpOwogICAgYCwKICAgIG9uQm90Q2hhbmdlZDogYEAKICAgICAgICBjb25zdCBjaGFuZ2VkVGFncyA9IHRoYXQudGFnczsKCiAgICAgICAgaWYgKGNoYW5nZWRUYWdzLnNvbWUodCA9PiB0ID09PSAnYWJBcnRpZmFjdEluc3RhbmNlSUQnIHx8IHQgPT09ICdhYkFydGlmYWN0TmFtZScpKSB7CiAgICAgICAgICAgIHRoaXNCb3QudXBkYXRlQ29tcHV0ZWRUYWdzKCk7CiAgICAgICAgfQogICAgYCwKICAgIHVwZGF0ZUNvbXB1dGVkVGFnczogYEAKICAgICAgICBsZXQgc3lzdGVtID0gJ2FiQXJ0aWZhY3RCb3QnOwoKICAgICAgICBpZiAodGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0TmFtZTsKICAgICAgICB9CgogICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgICAgIHN5c3RlbSArPSAnLicgKyB0YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELnN1YnN0cmluZygwLCA3KTsKICAgICAgICB9CgogICAgICAgIHRhZ3Muc3lzdGVtID0gISFzeXN0ZW0gPyBzeXN0ZW0gOiBudWxsOwogICAgICAgIHRhZ3MubGFiZWwgPSB0YWdzLnN5c3RlbTsKICAgIGAsCiAgICBvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGU6IGBACiAgICAgICAgLy8gSGlkZSBhcnRpZmFjdCBib3Qgb25jZSBpdCBoYXMgYmVlbiByZWNvbnN0aXR1dGVkLgogICAgICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2Zvcm0nLCAnbm90aGluZycsICdzaGFyZWQnKTsKICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdsYWJlbCcsICcgJywgJ3NoYXJlZCcpOwogICAgYCwKICAgIC4uLm90aGVyVGFncywKfSk7Cgp0cnkgewogICAgLy8gVXBkYXRlIGFsbCB0aGUgc2hhcmRzIGZvciB0aGlzIGFydGlmYWN0IGluc3RhbmNlIC0tIHdoaWNoIG5vdyBpbmNsdWRlcyB0aGlzIGJvdCEKICAgIGNvbnN0IHVwZGF0ZVJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCiAgICBpZiAoIXVwZGF0ZVJlc3VsdC5zdWNjZXNzKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gdXBkYXRlICcke2FiQXJ0aWZhY3ROYW1lfScgYXJ0aWZhY3Qgc2hhcmRzLmApOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2F1Z2h0IGVycm9yIHdoaWxlIHVwZGF0ZSBhcnRpZmFjdCBzaGFyZHM6YCwgZSk7CiAgICBkZXN0cm95KGFiQXJ0aWZhY3RCb3QpOwogICAgcmV0dXJuIG51bGw7Cn0KCnJldHVybiBhYkFydGlmYWN0Qm90OycA66SUhgH0nwQWYWJBcnRpZmFjdFJlY29uc3RpdHV0ZQIEAOuklIYBz7kEhSRAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmFzc2VydCh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJnIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLmApOwoKY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgYXMgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgQUJBcnRpZmFjdEJ1bmRsZS5gKTsKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCB0byBiZSBvZiB0eXBlIHN0cmluZy5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmcgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKTsKY29uc3Qgc2hhcmRCb3RzID0gW107CgpmdW5jdGlvbiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlKHsgYm90RGF0YSB9KSB7CiAgICBmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICAgICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkOyAvLyBJZiB0aGUgc2hhcmQgYm90IGhhcyBpdHNlbGYgbWFya2VkIGFzIHJlY29uc3RpdHV0ZWQgYWxyZWFkeSAocG9zc2libHkgZHVlIHRvIGFuIG92ZXJzaWdodCksIHRoZW4gcmVtb3ZlIGl0IQoKICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSA9IGFiQXJ0aWZhY3RCdW5kbGVTdHJpbmc7IC8vIEFzc2lnbiB0aGUgYXJ0aWZhY3QgYnVuZGxlIGJhY2sgdG8gdGhlIGhhdGNoZWQgc2hhcmQgYm90LgogICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOyAvLyBVVUlEIG9mIHRoZSBhcnRpZmFjdCBpbnN0YW5jZSB0aGF0IHRoaXMgYm90IGJlbG9uZ3MgdG8uCiAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQgPSB1dWlkKCk7IC8vIFVVSUQgYXNzaWduZWQgdG8gdGhlIGJvdCBieSB0aGUgYXJ0aWZhY3Qgd2hlbiBsb2FkZWQuCiAgICB9Cn0KCmZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcykgewogICAgY29uc3QgZGVwZW5kZW5jeUJvdHMgPSBbXTsKCiAgICBpZiAodGhpc0JvdC5pc0VnZ0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICBjb25zdCBlZ2dEZXBlbmRlbmN5ID0gZGVwZW5kZW5jeSBhcyBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeTsKICAgICAgICAKICAgICAgICAvLyBGaXJzdCB0cnkgdG8gbG9hZCBmcm9tIGVnZy4KICAgICAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgICAgICBhYklEOiBlZ2dEZXBlbmRlbmN5LmFiSUQsCiAgICAgICAgICAgIHJlY29yZEtleTogZWdnRGVwZW5kZW5jeS5yZWNvcmRLZXksCiAgICAgICAgICAgIGFiVmVyc2lvbjogZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24sCiAgICAgICAgICAgIGF1dG9IYXRjaDogdHJ1ZSwKICAgICAgICAgICAgc291cmNlRXZlbnQ6ICdyZWNvbnN0aXR1dGUnLAogICAgICAgICAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUKICAgICAgICB9KQoKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAke2VnZ0RlcGVuZGVuY3kuYWJJRH0gbG9va3VwRWdnUmVzdWx0OmAsIGxvb2t1cEVnZ1Jlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9va3VwRWdnUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgbG9hZGVkIGRlcGVuZGVuY3kgYWJJRDogJHtlZ2dEZXBlbmRlbmN5LmFiSUR9LCBhYlZlcnNpb246ICR7ZWdnRGVwZW5kZW5jeS5hYlZlcnNpb24gPz8gJ2xhdGVzdCd9YCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoY29uc3QgaGF0Y2hlZEJvdCBvZiBsb29rdXBFZ2dSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRlcGVuZGVuY3lCb3RzLmxlbmd0aCA9PT0gMCAmJiB0aGlzQm90LmlzQXNrRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgIGNvbnN0IGFza0RlcGVuZGVuY3kgPSBkZXBlbmRlbmN5IGFzIEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5OwoKICAgICAgICAvLyBUcnkgdG8gbG9hZCBmcm9tIGFzay4KICAgICAgICBjb25zdCBsb29rdXBBc2tSZXN1bHQ6IEFCTG9va3VwQXNrSURSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBc2tJRCh7CiAgICAgICAgICAgIGFza0lEOiBhc2tEZXBlbmRlbmN5LmFza0lELAogICAgICAgICAgICBzaG93SW5kaWNhdG9yOiBmYWxzZSwKICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQogICAgICAgIH0pCgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9va3VwQXNrUmVzdWx0OmAsIGxvb2t1cEFza1Jlc3VsdCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGNvbnN0IGhhdGNoZWRCb3Qgb2YgbG9va3VwQXNrUmVzdWx0LmhhdGNoZWRCb3RzKSB7CiAgICAgICAgICAgIGRlcGVuZGVuY3lCb3RzLnB1c2goaGF0Y2hlZEJvdCk7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChkZXBlbmRlbmN5Qm90cy5sZW5ndGggPiAwKSB7CiAgICAgICAgZm9yIChjb25zdCBzaGFyZEJvdCBvZiBkZXBlbmRlbmN5Qm90cykgewogICAgICAgICAgICBzZXRUYWdNYXNrKHNoYXJkQm90LCAnYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCcsIHRydWUsICdzaGFyZWQnKTsgLy8gVGhpcyBib3QgaGFzIGJlZW4gcmVjb25zdGl0dXRlZCBpbiB0aGlzIGluc3QuCiAgICAgICAgICAgIHNoYXJkQm90cy5wdXNoKHNoYXJkQm90KTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKHsgbWVzc2FnZTogYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSBmYWlsZWQgdG8gbG9hZCBkZXBlbmRlbmN5OiAke0pTT04uc3RyaW5naWZ5KGRlcGVuZGVuY3kpfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIH0KfQoKaWYgKHNoYXJkQm90cy5sZW5ndGggPiAwKSB7CiAgICAvLyBUZWxsIGFsbCBoYXRjaGVkIHNoYXJkIGJvdHMgdG8gcmVjb25zdGl0dXRlLiBUaGV5IGFsbCBoYXZlIGNvcGllcyBvZiB0aGUgYWJBcnRpZmFjdEJ1bmRsZSBhbmQgY2FuIHJlY29uc3RpdHV0ZSB0aGVtc2VsdmVzIGZyb20gdGhhdC4KICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKHNoYXJkQm90cywgJ29uQUJBcnRpZmFjdFJlY29uc3RpdHV0ZScsIHsgZGF0YTogYWJBcnRpZmFjdEJ1bmRsZS5kYXRhIH0pKTsKCiAgICBhd2FpdCB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwogICAgCiAgICBzaG91dCgnb25BbnlBQkFydGlmYWN0UmVjb25zdGl0dXRlZCcsIHsKICAgICAgICBhYkFydGlmYWN0TmFtZTogYWJBcnRpZmFjdEJ1bmRsZS5uYW1lLAogICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgc2hhcmRCb3RzLAogICAgfSkKfQoKaWYgKHRvYXN0KSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBBcnRpZmFjdCAnJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9JyAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBmaW5pc2hlZCByZWNvbnN0aXR1dGlvbi5gKQp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2coYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZpbmlzaGVkIHJlY29uc3RpdHV0aW9uLmApOwp9CicA66SUhgH0nwQXYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24CBADrpJSGAdPdBAExJwDrpJSGAfSfBAZzZWFyY2gCBADrpJSGAdXdBCjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwDrpJSGAfSfBAdhYlNoZWxsAgQA66SUhgH83QQEdHJ1ZScA66SUhgH0nwQFdXRpbHMCBADrpJSGAYHeBCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDrpJSGAfSfBA9vbkFueUJvdENsaWNrZWQCBADrpJSGAajeBIEBQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGJvdCB9KQp9JwDrpJSGAfSfBBZhYlVwZGF0ZUFydGlmYWN0U2hhcmRzAgQA66SUhgGq3wSjF0Bjb25zdCBhYkFydGlmYWN0TmFtZSA9IHRoYXQuYWJBcnRpZmFjdE5hbWU7CmxldCBhYkFydGlmYWN0SW5zdGFuY2VJRCA9IHRoYXQuYWJBcnRpZmFjdEluc3RhbmNlSUQ7Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2YgYWJBcnRpZmFjdEluc3RhbmNlSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmNvbnN0IHNoYXJkQm90cyA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlU2hhcmRCb3RzKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgppZiAoc2hhcmRCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBUaGVyZSBhcmUgbm8gc2hhcmRzIGZvciBhcnRpZmFjdCBuYW1lICcke2FiQXJ0aWZhY3ROYW1lfScuYCwgbG9nVHlwZTogJ3dhcm4nIH0pOwogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQoKCmNvbnN0IHByZXZBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHNoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CmNvbnN0IHByZXZBcnRpZmFjdElEID0gcHJldkFydGlmYWN0QnVuZGxlID8gcHJldkFydGlmYWN0QnVuZGxlLmlkIDogbnVsbDsKCmxldCBjb2xsZWN0U2hhcmRSZXN1bHQ6IEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0OwoKdHJ5IHsKICAgIGNvbGxlY3RTaGFyZFJlc3VsdCA9IGF3YWl0IHRoaXNCb3QuYWJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMoeyBzaGFyZEJvdHMgfSk7CgogICAgaWYgKCFjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBjb2xsZWN0U2hhcmRSZXN1bHQucmVhc29uLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH0KICAgIH0KfSBjYXRjaChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBTb21ldGhpbmcgd2VudCB3cm9uZyBjb2xsZWN0aW5nIHNoYXJkcy4gU2VlIGNvbnNvbGUgZm9yIG1vcmUgZGV0YWlscy5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfQp9Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0QnVuZGxlKHsgYWJBcnRpZmFjdE5hbWUsIGFiQXJ0aWZhY3RTaGFyZDogY29sbGVjdFNoYXJkUmVzdWx0LnNoYXJkIH0pOwoKaWYgKHByZXZBcnRpZmFjdElEICYmIHByZXZBcnRpZmFjdElEICE9PSBhYkFydGlmYWN0QnVuZGxlLmlkKSB7CiAgICAvLyBUaGUgYXJ0aWZhY3QgaGFzIGEgbmV3IGlkLiBBbGwgb2YgdGhlIHNoYXJkIGJvdHMgbmVlZCBhIG5ldyBpbnN0YW5jZSBpZCBhcyB3ZWxsLgogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSB1dWlkKCk7CgogICAgZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgICAgICBzaGFyZEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0U2hhcmRJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5hbCBtZXJnZWQgYXJ0aWZhY3QgJHthYkFydGlmYWN0TmFtZX06YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIEV2ZXJ5IHNoYXJkIGJvdCBnZXRzIGEgY29weSBvZiB0aGUgYXJ0aWZhY3QgYnVuZGxlLgovLyBUaGlzIG1ha2VzIHRoZSBhcnRpZmFjdCBob2xvZ3JhcGhpYyBieSBuYXR1cmUuIFRoaXMgbWVhbnMgdGhhdCBhbnkgc2hhcmQgY2FuIGJlIHVzZWQgdG8gcmVjb25zdGl0dXRlIHRoZSB3aG9sZS4KZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIC8vIE1hcmsgZWFjaCBzaGFyZCBib3QgYXMgYmVpbmcgJ3JlY29uc3RpdHV0ZWQnIHdoZW4gd2UgdXBkYXRlIHRoZSBhcnRpZmFjdC4KICAgIC8vIEJlY2F1c2UgdGhpcyBpcyBhIHNoYXJlZCB0YWcgbWFzaywgaXQgd2lsbCBvbmx5IGJlIHRydWUgaW4gdGhlIGN1cnJlbnQgaW5zdC4KICAgIHNldFRhZ01hc2soc2hhcmRCb3QsICdhYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkJywgdHJ1ZSwgJ3NoYXJlZCcpOwogICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlID0gICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwp9CgovLyBSeWFuIENvb2s6IE5lZWQgdG8gZ2l2ZSBDYXN1YWxPUyBhIGNoYW5jZSB0byBjYXRjaHVwLgovLyBGb3VuZCB0aGF0IGlmIHdlIGRpZG50IGRvIHRoaXMsIG1vZCB0YWdzIHdvdWxkIG5vdCBiZSByZXR1cm5lZCBhcyBKU09OIG9iamVjdHMgYnV0IGluc3RlYWQgdGhlIHJhdyBzdHJpbmcuCmF3YWl0IG9zLnNsZWVwKDApOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRlZCBhcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nLiBDb3BpZWQgYXJ0aWZhY3QgYnVuZGxlIHRvICR7c2hhcmRCb3RzLmxlbmd0aH0gYm90cy4gYWJBcnRpZmFjdEJ1bmRsZTpgLCBhYkFydGlmYWN0QnVuZGxlKTsKfQoKc2hvdXQoJ29uQW55QUJBcnRpZmFjdFNoYXJkc1VwZGF0ZWQnLCB7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdEJ1bmRsZSwgc2hhcmRCb3RzIH0pCgovLyBTaGFyZCB1cGRhdGUgc3VjY2Vzc2Z1bC4KcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9OycA66SUhgH0nwQEbWVudQIEAOuklIYBzPYEKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAOuklIYB9J8EBWxlYXJuAgQA66SUhgHz9gQo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA66SUhgH0nwQLb25HcmlkQ2xpY2sCBADrpJSGAZr3BEZAaWYgKGxpbmtzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIHRoaXNCb3QuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwp9JwDrpJSGAfSfBBphYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdAIEAOuklIYB4fcEByNBRUExRkYnAOuklIYB9J8EG2FiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdAIEAOuklIYB6fcEByMxZTFiMmQnAOuklIYB9J8EEG9uQW55Qm90c1JlbW92ZWQCBADrpJSGAfH3BJUBQGNvbnN0IHsgYm90SURzIH0gPSB0aGF0OwoKaWYgKG1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCAmJiBib3RJRHMuaW5jbHVkZXMobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkKSkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7Cn0nAOuklIYB9J8EB3ZlcnNpb24CBADrpJSGAYf5BCjwn5SXNTI4ZGMwZjktNDNlYy00M2YzLWE0NzAtZTJkZDZhMGRhOTVmJwDrpJSGAfSfBBhhYkdldEFydGlmYWN0TmFtZXNJbkluc3QCBADrpJSGAa75BKwBQGNvbnN0IGFiQXJ0aWZhY3ROYW1lcyA9IG5ldyBTZXQoKTsKCmdldEJvdHMoKGIpID0+IHsKICAgIGlmIChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICBhYkFydGlmYWN0TmFtZXMuYWRkKGIudGFncy5hYkFydGlmYWN0TmFtZSk7CiAgICB9Cn0pCgpyZXR1cm4gYWJBcnRpZmFjdE5hbWVzOycA66SUhgH0nwQVYWJBcnRpZmFjdEJvdE1lbnVPcGVuAgQA66SUhgHb+gT7FUBjb25zdCB7IGFiQXJ0aWZhY3RCb3QgfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdEJvdCAmJiBhYkFydGlmYWN0Qm90LnNwYWNlICYmIGFiQXJ0aWZhY3RCb3QudGFncywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0Qm90IGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBCb3QuYCk7CgpzaG91dCgiYWJBcnRpZmFjdEJvdE1lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJBcnRpZmFjdE1lbnUiOwoKaWYgKCF0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cykgewogICAgdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMgPSBbXTsKfQoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7Cgpjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CgpsZXQgaW5mb0xhYmVsID0gYFthcnRpZmFjdCBuYW1lXTogJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9XG5gOwppbmZvTGFiZWwgKz0gYFthcnRpZmFjdCBpZF06ICR7YWJBcnRpZmFjdEJ1bmRsZS5pZC5zdWJzdHJpbmcoMCwgNyl9XG5gOwppbmZvTGFiZWwgKz0gYFthcnRpZmFjdCBpbnN0YW5jZSBpZF06ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID8/ICd1bnNldCd9IFxuYDsKaW5mb0xhYmVsICs9IGBbcmVjb25zdGl0dXRlZCBpbiBpbnN0XTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZH1cbmA7CmluZm9MYWJlbCArPSBgW2Zvcm1hdF06IHYke2FiQXJ0aWZhY3RCdW5kbGUuZm9ybWF0VmVyc2lvbn1cbmA7CmluZm9MYWJlbCArPSBgW2NyZWF0ZWQgdGltZV06ICR7RGF0ZVRpbWUuZnJvbUlTTyhhYkFydGlmYWN0QnVuZGxlLmNyZWF0ZWRUaW1lc3RhbXApLnRvTG9jYWxlU3RyaW5nKERhdGVUaW1lLkRBVEVUSU1FX1NIT1JUX1dJVEhfU0VDT05EUyl9XG5gOwoKLy8gSGVhZGVyCmNvbnN0IGluZm9Cb3QgPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudVRleHQoewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBsYWJlbDogaW5mb0xhYmVsLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGluZm9Cb3QpOwoKLy8gRG93bmxvYWQgc2hhcmQgYnV0dG9uLgpjb25zdCBkb3dubG9hZEJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdkb3dubG9hZCcsCiAgICBsYWJlbDogYGRvd25sb2FkIHNoYXJkYCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSAnYWJBcnRpZmFjdC0nICsgYWJBcnRpZmFjdEJ1bmRsZS5uYW1lICsgJy0nICsgYWJBcnRpZmFjdEJ1bmRsZS5pZC5zdWJzdHJpbmcoMCw3KSArICcuYXV4JzsgCiAgICAgICAgb3MuZG93bmxvYWRCb3RzKFsgbGlua3MuYWJBcnRpZmFjdEJvdCBdLCBmaWxlbmFtZSk7CiAgICAgICAgCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdEJvdE1lbnVSZXNldCgpOwogICAgYCwKfSkKdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMucHVzaChkb3dubG9hZEJ1dHRvbik7CgovLyBVcGRhdGUgYXJ0aWZhY3QgYnV0dG9uLgpjb25zdCB1cGRhdGVCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGFiQXJ0aWZhY3RCb3Q6IGdldExpbmsoYWJBcnRpZmFjdEJvdCksCiAgICBhYkFydGlmYWN0VG9vbDogZ2V0TGluayh0aGlzQm90KSwKICAgIGZvcm1BZGRyZXNzOiAnc3luYycsCiAgICBsYWJlbDogYHVwZGF0ZSBhcnRpZmFjdGAsCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IGxpbmtzLmFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0QnVuZGxlOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gYWJBcnRpZmFjdEJ1bmRsZS5uYW1lOwogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIAogICAgICAgIGF3YWl0IGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgogICAgICAgIGxpbmtzLmFiQXJ0aWZhY3RUb29sLmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGxpbmtzLmFiQXJ0aWZhY3RCb3QgfSk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKHVwZGF0ZUJ1dHRvbik7CgptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBhYkFydGlmYWN0Qm90LmlkOycA66SUhgH0nwQZYWJEb3dubG9hZEFydGlmYWN0UGF0dGVybgIEAOuklIYB15AF/ARAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBzaGFyZEJvdHMsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0TmFtZSA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpICYmIHNoYXJkQm90cy5sZW5ndGggPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyBhIHJlcXVpcmVkIEJvdCBhcnJheSBwYXJhbWV0ZXIuIEl0IG11c3QgaGF2ZSBhdCBsZWFzdCAxIGJvdC5gKTsKCnJldHVybiBsaW5rcy5zdG9yZS5hYkRvd25sb2FkKHsgCiAgICBwb3NzaWJsZUJvdHM6IHNoYXJkQm90cywKICAgIGZpbGVuYW1lOiBgJHthYkFydGlmYWN0TmFtZX1gLAogICAgc291cmNlRXZlbnQ6ICdkb3dubG9hZF9hcnRpZmFjdF9wYXR0ZXJuJywKICAgIHJlb3BlbkFiTWVudTogZmFsc2UsCiAgICBvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZDogKGFyZykgPT4gewogICAgICAgIHRoaXNCb3QuYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGEoYXJnLmJvdERhdGEpOwogICAgfQp9KTsnAOuklIYB9J8EFmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQCBADrpJSGAdSVBe8BQGlmICh0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyAmJiB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5sZW5ndGggPiAwKSB7CiAgICBkZXN0cm95KHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKTsKICAgIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzID0gW107Cn0KCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKbWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkID0gbnVsbDsnAOuklIYB9J8EBXR5cGVzAgQA66SUhgHElwWkB/Cfk4RpbnRlcmZhY2UgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZyB7CiAgICBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlOwogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ/OiBzdHJpbmc7CiAgICB0b2FzdD86IGJvb2xlYW47Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeSB7CiAgICBhYklEOiBzdHJpbmc7CiAgICByZWNvcmRLZXk6IHN0cmluZzsKICAgIGFiVmVyc2lvbj86IG51bWJlcjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5IHsKICAgIGFza0lEOiBzdHJpbmc7Cn0KCnR5cGUgQUJBcnRpZmFjdERlcGVuZGVuY3kgPSBBQkFydGlmYWN0RWdnRGVwZW5kZW5jeSB8IEFCQXJ0aWZhY3RBc2tEZXBlbmRlbmN5OwoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RCdW5kbGUgewogICAgaWQ6IHN0cmluZzsKICAgIG5hbWU6IHN0cmluZzsKICAgIGZvcm1hdFZlcnNpb246IG51bWJlcjsKICAgIGRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT47CiAgICBkZXBlbmRlbmNpZXM6IEFycmF5PEFCQXJ0aWZhY3REZXBlbmRlbmN5PjsKICAgIGNhc3VhbE9TVmVyc2lvbjogQXV4VmVyc2lvbjsKICAgIGNyZWF0ZWRUaW1lc3RhbXA6IHN0cmluZzsKICAgIGFiU2hlbGxWZXJzaW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkFydGlmYWN0U2hhcmQgewogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+Owp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEV4cGVyaWVuY2UgewogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RDb2xsZWN0U2hhcmRzUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW47CiAgICByZWFzb24/OiBhbnk7CiAgICBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwp9JwDrpJSGAfSfBBpvbkFCUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQIEAOuklIYB554F3zNAaWYgKCF0aGlzQm90LmlzUmVjb25zdGl0dXRpb25FbmFibGVkKCkpIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmNvbnN0IHsgYm90RGF0YSwgb3JpZ2luLCBzdHVkaW8sIHJlY29yZCwgdmVyc2lvbiwgZWdnUGFyYW1ldGVycywgaW5pdGlhbEJvb3QsIHNvdXJjZUV2ZW50IH0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9CgppZiAoc291cmNlRXZlbnQgPT09ICdhc2snIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdwYXN0ZScgfHwgCiAgICBzb3VyY2VFdmVudCA9PT0gJ2Jvb3QnIHx8IAogICAgc291cmNlRXZlbnQgPT09ICdmaWxlX3VwbG9hZCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAndG9vbCcgfHwKICAgIHNvdXJjZUV2ZW50ID09PSAnY3JlYXRlX2FydGlmYWN0X3Byb21pc2UnCikgewogICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBib3RzIGJlaW5nIGFkZGVkIGFyZSBhcnRpZmFjdCBzaGFyZHMgdGhhdCBuZWVkcyB0byBiZSByZWNvbnN0aXR1dGVkLgogICAgY29uc3QgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGU6IFJlY29yZDxzdHJpbmcsIEFCQXJ0aWZhY3RSZWNvbnN0aXR1dGVBcmc+ID0ge307IC8vIEtleSBpcyBhcnRpZmFjdCBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHRoaXNCb3QuYWJHZXRBcnRpZmFjdEluc3RhbmNlcygpOwogICAgY29uc3QgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2U6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpOyAvLyBUaGlzIHNldCB0cmFja3MgYXJ0aWZhY3QgaWRzIHRoYXQgYXJlIGFscmVhZHkgcXVldWVkIHRvIGJlIHJlY29uc3RpdHV0ZWQgd2l0aCBhIG5ldyBpbnN0YW5jZSBpZC4KICAgIGNvbnN0IG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTsgLy8gVHJhY2sgb3JpZ2luYWwgaW5zdGFuY2UgSURzIHRoYXQgd2UndmUgYWxyZWFkeSBkZWNpZGVkIHRvIGdpdmUgbmV3IGluc3RhbmNlcwoKICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICBpZiAoZGF0YSAmJgogICAgICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYKICAgICAgICAgICAgIWRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkICYmCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlPy5zdGFydHNXaXRoKCfwn6esJykKICAgICAgICApIHsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IHN0cmluZyA9IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IEpTT04ucGFyc2UoZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGUuc3Vic3RyaW5nKDIpKTsKCiAgICAgICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICAgICAgLy8gU2hhcmQgaGFzIGFuIGFydGlmYWN0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICBpZiAoZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlc1thYkFydGlmYWN0SW5zdGFuY2VJRF0gJiYgIW9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmhhcyhhYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDE6IEluc3RhbmNlIGFscmVhZHkgZXhpc3RzIC0gY3JlYXRlIG5ldyBpbnN0YW5jZSAoZmlyc3QgdGltZSB3ZSBzZWUgdGhpcyBjb2xsaXNpb24pCiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW25ld0FydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBuZXdBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgICAgIHRvYXN0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5hZGQoYWJBcnRpZmFjdEJ1bmRsZS5pZCk7IC8vIFRyYWNrIHRoYXQgd2UncmUgY3JlYXRpbmcgYSBuZXcgaW5zdGFuY2UgZm9yIHRoaXMgYXJ0aWZhY3QgSUQKICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZC5hZGQoYWJBcnRpZmFjdEluc3RhbmNlSUQpOyAvLyBUcmFjayB0aGF0IHdlJ3ZlIGRlY2lkZWQgdG8gcmVwbGFjZSB0aGlzIG9yaWdpbmFsIGluc3RhbmNlIElECgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAxOiBTaGFyZCBmcm9tIGV4aXN0aW5nIGluc3RhbmNlLiBDcmVhdGluZyBuZXcgaW5zdGFuY2UuIChvbGQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9LCBuZXc6ICR7bmV3QXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmhhcyhhYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDFiOiBXZSd2ZSBhbHJlYWR5IGRlY2lkZWQgdG8gY3JlYXRlIGEgbmV3IGluc3RhbmNlIGZvciB0aGlzIG9yaWdpbmFsIElEIC0gYWRkIHRoaXMgc2hhcmQgdG8gdGhhdCBuZXcgaW5zdGFuY2UKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMWI6IEFkZGl0aW9uYWwgc2hhcmQgZm9yIHJlcGxhY2VkIGluc3RhbmNlLiBEaXNwb3NpbmcuIChvcmlnaW5hbDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMjogSW5zdGFuY2UgYWxyZWFkeSBxdWV1ZWQgZm9yIHJlY29uc3RpdHV0aW9uIC0gZGlzcG9zZSBkdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMjogRHVwbGljYXRlIHNoYXJkIGZvciBxdWV1ZWQgaW5zdGFuY2UuIERpc3Bvc2luZy4gKGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMzogSW5zdGFuY2UgdG8gcmVjb25zdGl0dXRlIHdpdGggZXhpc3RpbmcgSUQKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVthYkFydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDM6IEluc3RhbmNlIHRvIHJlY29uc3RpdHV0ZS4gKGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTaGFyZCBoYXMgbm8gYXJ0aWZhY3QgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgIGlmIChhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5oYXMoYWJBcnRpZmFjdEJ1bmRsZS5pZCkpIHsKICAgICAgICAgICAgICAgICAgICAvLyBDYXNlIDQ6IEFydGlmYWN0IGFscmVhZHkgaGFzIG5ldyBpbnN0YW5jZSBxdWV1ZWQgLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSA0OiBEdXBsaWNhdGUgc2hhcmQgZm9yIGFydGlmYWN0IHdpdGggbmV3IGluc3RhbmNlIHF1ZXVlZC4gRGlzcG9zaW5nLiAoYXJ0aWZhY3RJZDogJHthYkFydGlmYWN0QnVuZGxlLmlkfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgNTogQ3JlYXRlIG5ldyBpbnN0YW5jZSBmb3IgYXJ0aWZhY3Qgd2l0aG91dCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0FydGlmYWN0SW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZVtuZXdBcnRpZmFjdEluc3RhbmNlSURdID0gewogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLAogICAgICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRDogbmV3QXJ0aWZhY3RJbnN0YW5jZUlELAogICAgICAgICAgICAgICAgICAgICAgICB0b2FzdDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RJRHNXaXRoTmV3SW5zdGFuY2UuYWRkKGFiQXJ0aWZhY3RCdW5kbGUuaWQpOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgNTogQ3JlYXRpbmcgbmV3IGluc3RhbmNlIGZvciBhcnRpZmFjdCB3aXRob3V0IGluc3RhbmNlIElELiAobmV3OiAke25ld0FydGlmYWN0SW5zdGFuY2VJRH0pYCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVGhpcyBpcyBub3QgYSBzaGFyZCBib3QuIElnbm9yZSBpdC4KICAgICAgICB9CiAgICB9CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlOmAsIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4aXN0aW5nQXJ0aWZhY3RJbnN0YW5jZXM6YCwgZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlcyk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZTpgLCBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZSk7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZDpgLCBvcmlnaW5hbEluc3RhbmNlSURzQmVpbmdSZXBsYWNlZCk7CiAgICB9CgogICAgZm9yIChjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRCBpbiBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZSkgewogICAgICAgIGNvbnN0IHJlY29uc3RpdHV0ZUFyZzogQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZyA9IGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKICAgICAgICAKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFJlY29uc3RpdHV0aW5nIGFydGlmYWN0IGluc3RhbmNlOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfWApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBhd2FpdCB0aGlzQm90LmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGUocmVjb25zdGl0dXRlQXJnKTsKICAgIH0KfScA66SUhgH0nwQbb25BQlByZXByb2Nlc3NCZWZvcmVQdWJsaXNoAgQA66SUhgHF0gXcDkBpZiAoIXRoaXNCb3QuaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKY29uc3QgeyBib3REYXRhLCBhYiwgcHVibGljRmFjaW5nLCBzdHVkaW8sIHNvdXJjZUV2ZW50IH0gPSB0aGF0OwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB7Li4udGhhdH0pOwp9CgovLyBEZXRlY3QgYXJ0aWZhY3QgaW5zdGFuY2VzIHRoYXQgbmVlZCB0byBiZSBjb252ZXJ0ZWQgaW50byBhcnRpZmFjdCBwcm9taXNlcy4KCi8qKiBrZXk6IGFydGlmYWN0IGluc3RhbmNlIGlkLCB2YWx1ZTogYXJ0aWZhY3QgcHJvbWlzZSBkYXRhLiAqLwpjb25zdCBhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlID0gbmV3IFNldCgpOyAvLyBLZWVwIHRyYWNrIG9mIHdoYXQgYXJ0aWZhY3QgaW5zdGFuY2UgSURzIGhhdmUgaGFkIGFuIGFydGlmYWN0IHByb21pc2UgbWFkZS4KCmZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSAmJiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBUaGlzIGlzIGFuIGFydGlmYWN0IGluc3RhbmNlIHNoYXJkIGJvdC4KICAgICAgICBpZiAoIWFydGlmYWN0SW5zdGFuY2VzV2l0aFByb21pc2UuaGFzKGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkpIHsKICAgICAgICAgICAgLy8gVGhpcyBhcnRpZmFjdCBpbnN0YW5jZSBuZWVkcyBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUgZm9yIGl0LgogICAgICAgICAgICBjb25zdCBwcm9taXNlSWQgPSB1dWlkKCk7CgogICAgICAgICAgICBib3REYXRhW3Byb21pc2VJZF0gPSB7CiAgICAgICAgICAgICAgICBpZDogcHJvbWlzZUlkLAogICAgICAgICAgICAgICAgc3BhY2U6ICdzaGFyZWQnLAogICAgICAgICAgICAgICAgdGFnczogewogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0UHJvbWlzZTogdHJ1ZSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ29udmVydGVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7ZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEfSBpbnRvIGFuIGFydGlmYWN0IHByb21pc2U6YCwgYm90RGF0YVtwcm9taXNlSWRdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZS5hZGQoZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKTsKICAgICAgICB9CgogICAgICAgIC8vIFJlbW92ZSBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QgZnJvbSBib3REYXRhIHRoYXQgaXMgYWJvdXQgdG8gYmUgcHVibGlzaGVkLgogICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICB9Cn0KCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZpbmlzaGVkIGJvdERhdGE6YCwgey4uLmJvdERhdGF9KTsKfScA66SUhgH0nwQWYWJHZXRBcnRpZmFjdEluc3RhbmNlcwIEAOuklIYBouEFygdAY29uc3QgeyAKICAgIGJvdHMsCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge30KCmlmIChib3RzKSB7CiAgICBhc3NlcnQoQXJyYXkuaXNBcnJheShib3RzKSwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBib3RzIG11c3QgYmUgYW4gYXJyYXkuYCk7Cn0KCmNvbnN0IGluc3RhbmNlczogUmVjb3JkPHN0cmluZywgQm90W10+ID0ge30gLy8gS2V5IGlzIGFydGlmYWN0IGluc3RhbmNlIGlkLgoKZnVuY3Rpb24gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYm90KSB7CiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpIHsKICAgICAgICAvLyBPcHRpb25hbDogZmlsdGVyIGJ5IGFiQXJ0aWZhY3ROYW1lLgogICAgICAgIGlmIChhYkFydGlmYWN0TmFtZSAmJiBhYkFydGlmYWN0TmFtZSAhPT0gYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgbGV0IGJvdEFycmF5ID0gaW5zdGFuY2VzW2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEXTsKCiAgICAgICAgaWYgKCFib3RBcnJheSkgewogICAgICAgICAgICBib3RBcnJheSA9IFtdOwogICAgICAgICAgICBpbnN0YW5jZXNbYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSURdID0gYm90QXJyYXk7CiAgICAgICAgfQoKICAgICAgICBib3RBcnJheS5wdXNoKGJvdCk7CiAgICB9Cn0KCmlmIChib3RzKSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgaW5zdGFuY2VzIGluIHByb3ZpZGVkIGxpc3Qgb2YgYm90cy4KICAgIGJvdHMuZm9yRWFjaChiID0+IHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGIpKTsKfSBlbHNlIHsKICAgIC8vIEdldCBhcnRpZmFjdCBpbnN0YW5jZXMgaW4gaW5zdC4KICAgIGdldEJvdHMoYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShiKSk7Cn0KCnJldHVybiBpbnN0YW5jZXM7JwDrpJSGAfSfBBVhYkdldEFydGlmYWN0UGF0dGVybnMCBADrpJSGAe3oBfMHQGNvbnN0IHsgCiAgICBib3RzLAogICAgYWJBcnRpZmFjdE5hbWUsCn0gPSB0aGF0ID8/IHt9CgppZiAoYm90cykgewogICAgYXNzZXJ0KEFycmF5LmlzQXJyYXkoYm90cyksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyBtdXN0IGJlIGFuIGFycmF5LmApOwp9Cgpjb25zdCBwYXR0ZXJuczogUmVjb3JkPHN0cmluZywgQm90W10+ID0ge30gLy8gS2V5IGlzIGFydGlmYWN0IG5hbWUuCgpmdW5jdGlvbiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGJvdCkgewogICAgLy8gUGF0dGVybiBib3RzIGhhdmUgYWJBcnRpZmFjdE5hbWUgYnV0IG5vIGFiQXJ0aWZhY3RJbnN0YW5jZUlECiAgICBpZiAoYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgIWJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxldCBib3RBcnJheSA9IHBhdHRlcm5zW2JvdC50YWdzLmFiQXJ0aWZhY3ROYW1lXTsKCiAgICAgICAgaWYgKCFib3RBcnJheSkgewogICAgICAgICAgICBib3RBcnJheSA9IFtdOwogICAgICAgICAgICBwYXR0ZXJuc1tib3QudGFncy5hYkFydGlmYWN0TmFtZV0gPSBib3RBcnJheTsKICAgICAgICB9CgogICAgICAgIGJvdEFycmF5LnB1c2goYm90KTsKICAgIH0KfQoKaWYgKGJvdHMpIHsKICAgIC8vIEdldCBhcnRpZmFjdCBwYXR0ZXJucyBpbiBwcm92aWRlZCBsaXN0IG9mIGJvdHMuCiAgICBib3RzLmZvckVhY2goYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGIpKTsKfSBlbHNlIHsKICAgIC8vIEdldCBhcnRpZmFjdCBwYXR0ZXJucyBpbiBpbnN0LgogICAgZ2V0Qm90cyhiID0+IHByb2Nlc3NCb3RBcnRpZmFjdFBhdHRlcm4oYikpOwp9CgpyZXR1cm4gcGF0dGVybnM7JwDrpJSGAfSfBBhhYlB1Ymxpc2hBcnRpZmFjdFBhdHRlcm4CBADrpJSGAeHwBfoFQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgc3R1ZGlvLAogICAgc2hhcmRCb3RzLAogICAgbWFudWFsUHVibGlzaCwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3ROYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydCh0eXBlb2Ygc3R1ZGlvID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzdHVkaW8gaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpICYmIHNoYXJkQm90cy5sZW5ndGggPiAwLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyBhIHJlcXVpcmVkIEJvdCBhcnJheSBwYXJhbWV0ZXIuIEl0IG11c3QgaGF2ZSBhdCBsZWFzdCAxIGJvdC5gKTsKCnJldHVybiBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hBQih7CiAgICBhYjogYWJBcnRpZmFjdE5hbWUsIAogICAgdGFyZ2V0OiBzaGFyZEJvdHMsIAogICAgc3R1ZGlvLAogICAgbWFudWFsUHVibGlzaCwKICAgIHNvdXJjZUV2ZW50OiAncHVibGlzaF9hcnRpZmFjdF9wYXR0ZXJuJywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2g6IChhcmcpID0+IHsKICAgICAgICB0aGlzQm90LmFiU3RyaXBBcnRpZmFjdEluc3RhbmNlRGF0YUZyb21Cb3REYXRhKGFyZy5ib3REYXRhKTsKICAgIH0KfSk7JwDrpJSGAfSfBCZhYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YQIEAOuklIYB3PYFnwVAY29uc3QgYm90RGF0YSA9IHRoYXQ7Cgphc3NlcnQobGlua3MudXRpbHMuaXNPYmplY3QoYm90RGF0YSksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJndW1lbnQgbXVzdCBiZSBhbiBvYmplY3QuYCk7Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwogICAgCiAgICBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3RCb3QgPT09IHRydWUpIHsKICAgICAgICAvLyBSZW1vdmUgYXJ0aWZhY3QgYm90cy4KICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgICAgIAogICAgfSBlbHNlIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAvLyBTdHJpcCBhcnRpZmFjdCBpbnN0YW5jZSBkYXRhIGZyb20gYm90LgogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIGRlbGV0ZSBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7CgogICAgICAgIC8vIFJlbW92ZSBzb21lIG90aGVycy4KICAgICAgICBkZWxldGUgZGF0YS50YWdzLmNyZWF0b3I7CiAgICB9Cn0KICAgICcA66SUhgH0nwQPaXNFZ2dEZXBlbmRlbmN5AgQA66SUhgH8+wVSQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hYklEKSAmJiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5yZWNvcmRLZXkpOycA66SUhgH0nwQPaXNBc2tEZXBlbmRlbmN5AgQA66SUhgHP/AUqQHJldHVybiBsaW5rcy51dGlscy5pc1N0cmluZyh0aGF0Py5hc2tJRCk7JwDrpJSGAfSfBBBvbkFueUJvdHNDaGFuZ2VkAgQA66SUhgH6/AXJCEAvLyBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgdGhhdCk7Cgpmb3IgKGNvbnN0IGNoYW5nZWQgb2YgdGhhdCkgewogICAgaWYgKGNoYW5nZWQgPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIC8vIDEpIG9ubHkgY2FyZSBhYm91dCBib3RzIHdpdGggYXJ0aWZhY3QgdGFncwogICAgaWYgKCFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lIHx8ICFjaGFuZ2VkLmJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSBjb250aW51ZTsKCiAgICAvLyAyKSBhcnRpZmFjdCBtdXN0IGJlIHJlY29uc3RpdHV0ZWQuCiAgICBpZiAoIWNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCkgY29udGludWU7CgogICAgaWYgKHRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjaGFuZ2VzIG9uIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gZGV0ZWN0ZWQsIGNhbGxpbmcgdG8gdXBkYXRlIGV4cGVyaWVuY2UuYCwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgY2hhbmdlZEJvdElkOiBjaGFuZ2VkLmJvdC5pZCwKICAgICAgICAgICAgICAgIGNoYW5nZWRUYWdzOiBjaGFuZ2VkLnRhZ3MsCiAgICAgICAgICAgIH0pKTsKICAgICAgICB9CiAgICAgICAgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VFeHBlcmllbmNlKHsgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IGNoYW5nZWQuYm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0IGluc3RhbmNlICR7Y2hhbmdlZC5ib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gY2hhbmdlZCBidXQgZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgICAgICB9CiAgICB9Cn0KJwDrpJSGAfSfBBlleHBlcmllbmNlVGlja1JhdGVMaW1pdE1TAgQA66SUhgHEhQYENTAwMCcA66SUhgH0nwQWY29sbGVjdFNoYXJkc0xpc3RlblRhZwIEAOuklIYByYUGGW9uQUJBcnRpZmFjdENvbGxlY3RTaGFyZHMnAOuklIYB9J8ECGRlYnVnRXhwAgQA66SUhgHjhQYEdHJ1ZScA66SUhgH0nwQXaXNSZWNvbnN0aXR1dGlvbkVuYWJsZWQCBADrpJSGAeiFBnxAaWYgKGNvbmZpZ0JvdC50YWdzLmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGlvbiA9PT0gZmFsc2UpIHsKICAgIHJldHVybiBmYWxzZTsKfQoKLy8gUmVjb25zdGl0dXRpb24gb24gYnkgZGVmYXVsdC4KcmV0dXJuIHRydWU7JwDrpJSGAfSfBBdhYkNvbGxlY3RBcnRpZmFjdFNoYXJkcwIEAOuklIYB5YYG0BhAY29uc3QgeyBzaGFyZEJvdHMgfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoQXJyYXkuaXNBcnJheShzaGFyZEJvdHMpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNoYXJkQm90cyBpcyByZXF1aXJlZCB0byBiZSBhbiBib3QgYXJyYXkuYCk7CgovKiogS2VlcCB0cmFjayBvZiBkZXBlbmRlbmN5IGhhc2hlcy4gVGhpcyBwcmV2ZW50cyBkdXBsaWNhdGVzIGluIHRoZSBhcnRpZmFjdCBkZXBlbmRlbmNpZXMuICovCmNvbnN0IGRlcGVuZGVuY3lIYXNoZXMgPSBuZXcgU2V0KCk7CgpsZXQgbWVyZ2VkU2hhcmQ6IEFCQXJ0aWZhY3RTaGFyZCA9IHsKICAgIGRhdGE6IHt9LAogICAgZGVwZW5kZW5jaWVzOiBbXSwKfTsKCmZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICBjb25zdCBhYkFydGlmYWN0TmFtZSA9IHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICBjb25zdCBib3RTaG9ydElkID0gc2hhcmRCb3QuaWQuc3Vic3RyaW5nKDAsIDUpOwoKICAgIGxldCBzaGFyZDogQUJBcnRpZmFjdFNoYXJkOwogICAgaWYgKHNoYXJkQm90LnRhZ3NbdGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnXSkgewogICAgICAgIGlmIChzaGFyZEJvdFt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWddKSB7CiAgICAgICAgICAgIHNoYXJkID0gYXdhaXQgUHJvbWlzZS5yZXNvbHZlKHNoYXJkQm90W3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ10oKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyAke3RhZ3MuY29sbGVjdFNoYXJkc0xpc3RlblRhZ30gdGFnIGlzIGRlZmluZWQgYnV0IGlzIG5vdCBhIHZhbGlkIGZ1bmN0aW9uLmAgfTsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBzaGFyZDpgLCBzaGFyZCk7CiAgICB9CgogICAgaWYgKHNoYXJkKSB7CiAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc09iamVjdChzaGFyZCkpIHsKICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBAJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHNoYXJkIG11c3QgYmUgYW4gb2JqZWN0LmAgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kYXRhKSB7CiAgICAgICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQuZGF0YSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgQCR7dGFncy5jb2xsZWN0U2hhcmRzTGlzdGVuVGFnfSBzaGFyZCAnZGF0YScgcHJvcGVydHkgbXVzdCBiZSBhbiBvYmplY3QuYCB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaGFsbG93IG1lcmdlIHNoYXJkJ3MgZGF0YSBwcm9wZXJ0aWVzIGludG8gY29tYmluZWQgYXJ0aWZhY3QgZGF0YS4KICAgICAgICAgICAgbWVyZ2VkU2hhcmQuZGF0YSA9IHsgLi4ubWVyZ2VkU2hhcmQuZGF0YSwgLi4uc2hhcmQuZGF0YSB9OwogICAgICAgIH0KCiAgICAgICAgaWYgKHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICBpZiAoIWxpbmtzLnV0aWxzLmlzQXJyYXkoc2hhcmQuZGVwZW5kZW5jaWVzKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBAJHt0YWdzLmNvbGxlY3RTaGFyZHNMaXN0ZW5UYWd9IHNoYXJkICdkZXBlbmRlbmNpZXMnIHByb3BlcnR5IG11c3QgYmUgYW4gYXJyYXkuYCB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKGNvbnN0IGRlcGVuZGVuY3kgb2Ygc2hhcmQuZGVwZW5kZW5jaWVzKSB7CiAgICAgICAgICAgICAgICAvLyBWYWxpZGF0ZSB0aGF0IGRlcGVuZGVuY3kgaXMgb25lIG9mIHRoZSBzdXBwb3J0ZWQgdHlwZXMuCiAgICAgICAgICAgICAgICBpZiAoIXRoaXNCb3QuaXNFZ2dEZXBlbmRlbmN5KGRlcGVuZGVuY3kpICYmICF0aGlzQm90LmlzQXNrRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCByZWFzb246IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgaGFzIGEgZGVwZW5kZW5jeSBlbnRyeSB0aGF0IGlzIG5laXRoZXIgYW4gZWdnIG9yIGFzayBkZXBlbmRlbmN5IHR5cGUuYCB9OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGRlcGVuZGVuY3kgaXNudCBhbHJlYWR5IGNvbGxlY3RlZC4KICAgICAgICAgICAgICAgIGNvbnN0IGhhc2ggPSBjcnlwdG8uaGFzaCgnc2hhMScsICdoZXgnLCBkZXBlbmRlbmN5KTsKCiAgICAgICAgICAgICAgICBpZiAoIWRlcGVuZGVuY3lIYXNoZXMuaGFzKGhhc2gpKSB7CiAgICAgICAgICAgICAgICAgICAgZGVwZW5kZW5jeUhhc2hlcy5hZGQoaGFzaCk7CiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkU2hhcmQuZGVwZW5kZW5jaWVzLnB1c2goZGVwZW5kZW5jeSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGF0IGxlYXN0IG9uZSBkZXBlbmRlbmN5LgppZiAobWVyZ2VkU2hhcmQuZGVwZW5kZW5jaWVzLmxlbmd0aCA9PT0gMCkgewogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHJlYXNvbjogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgbXVzdCBsaXN0IGF0IGxlYXN0IG9uZSBkZXBlbmRlbmN5IGluIG9yZGVyIHRvIHJlY29uc3RpdHV0ZSBwcm9wZXJseS5gIH07Cn0KCmNvbnN0IHJlc3VsdDogQUJBcnRpZmFjdENvbGxlY3RTaGFyZHNSZXN1bHQgPSB7CiAgICBzdWNjZXNzOiB0cnVlLAogICAgc2hhcmQ6IG1lcmdlZFNoYXJkLAp9CgpyZXR1cm4gcmVzdWx0OycA66SUhgH0nwQXY2FuVXNlclVwZGF0ZUV4cGVyaWVuY2UCBADrpJSGAbafBs4JQGNvbnN0IHsKICAgIHJlbW90ZUlkID0gY29uZmlnQm90LmlkLAogICAgc2hhcmRCb3QKfSA9IHRoYXQgPz8ge30KCmlmIChzaGFyZEJvdCAmJiAKICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYKICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQKKSB7CiAgICAvLyBOZWVkIHRvIGZpZ3VyZSBvdXQgaWYgdGhpcyB1c2VyIGlzIGFsbG93ZWQgdG8gdXBkYXRlIHRoZSBleHBlcmllbmNlIG9mIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UuCiAgICBsZXQgY2FuVXNlclVwZGF0ZSA9IGZhbHNlOwoKICAgIHN3aXRjaCAoc2hhcmRCb3Quc3BhY2UpIHsKICAgICAgICBjYXNlICdzaGFyZWQnOgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICBjYXNlICd0ZW1wU2hhcmVkJzoKICAgICAgICAgICAgLy8gdGVtcFNoYXJlZCBzcGFjZSBtZWFucyB0aGF0IHRoaXMgYm90IGlzIGJhc2ljYWxseSBvd25lZCBieSB0aGlzIHVzZXIuCiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdyZW1vdGVUZW1wU2hhcmVkJzoKICAgICAgICAgICAgLy8gcmVtb3RlVGVtcFNoYXJlZCBzcGFjZSBtZWFucyB0aGF0IHRoaXMgYm90IGlzIG93bmVkIGJ5IHNvbWVvbmUgZWxzZS4KICAgICAgICAgICAgY2FuVXNlclVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdsb2NhbCc6CiAgICAgICAgICAgIGNhblVzZXJVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICd0ZW1wTG9jYWwnOgogICAgICAgICAgICBjYW5Vc2VyVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVucmVjb2duaXplZCBib3Qgc3BhY2U6YCwgc2hhcmRCb3Quc3BhY2UpOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gY2FuVXNlclVwZGF0ZTsKfSBlbHNlIHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcHJvdmlkZWQgc2hhcmRCb3QgZG9lcyBub3QgYXBwZWFyIHRvIGJlIGZyb20gYW4gYXJ0aWZhY3QgaW5zdGFuY2UuYCwgc2hhcmRCb3QpOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwp9JwDrpJSGAfSfBBphYkNyZWF0ZUFydGlmYWN0UHJvbWlzZUJvdAIEAOuklIYBhakGrApAY29uc3QgewogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RTaGFyZCwKICAgIHNwYWNlID0gJ3NoYXJlZCcsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChhYkFydGlmYWN0U2hhcmQgJiYgYWJBcnRpZmFjdFNoYXJkLmRhdGEgJiYgYWJBcnRpZmFjdFNoYXJkLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0U2hhcmQgaXMgYSByZXF1aXJlZCB0byBiZSBhIEFCQXJ0aWZhY3RTaGFyZC5gKTsKCmNvbnN0IGJvdERhdGEgPSBbXTsKY29uc3QgcHJvbWlzZUlkID0gdXVpZCgpOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZSA9IHRoaXNCb3QuYWJDcmVhdGVBcnRpZmFjdEJ1bmRsZSh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYWJBcnRpZmFjdFNoYXJkIH0pOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ2VuZXJhdGVkIGFiQXJ0aWZhY3RCdW5kbGU6YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCmJvdERhdGFbcHJvbWlzZUlkXSA9IHsKICAgIGlkOiBwcm9taXNlSWQsCiAgICBzcGFjZSwKICAgIHRhZ3M6IHsKICAgICAgICBhYkFydGlmYWN0TmFtZSwKICAgICAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgICAgICBhYkFydGlmYWN0QnVuZGxlOiAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKSwKICAgICAgICBhYkFydGlmYWN0UHJvbWlzZTogdHJ1ZSwKICAgIH0KfQoKLy8gQ3JlYXRlIGFydGlmYWN0IHByb21pc2UgdGhyb3VnaCBhYkNyZWF0ZUJvdHMuIAovLyBUaGlzIHdpbGwgdHJpZ2dlciBhcnRpZmFjdCdzIG9uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlIGFuZCBpdCB3aWxsIGZpbmQKLy8gdGhpcyBhcnRpZmFjdCBwcm9taXNlIGFuZCB1c2UgdGhlIGRhdGEgdG8gcmVjb25zdGl0dXRlIGl0Lgpjb25zdCByZXN1bHQgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90RGF0YSwgc291cmNlRXZlbnQ6ICdjcmVhdGVfYXJ0aWZhY3RfcHJvbWlzZScgfSkKCnJldHVybiByZXN1bHQ7JwDrpJSGAfSfBBZhYkNyZWF0ZUFydGlmYWN0QnVuZGxlAgQA66SUhgGwswaZCEBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3RTaGFyZCwKfSA9IHRoYXQ7Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7CmFzc2VydChhYkFydGlmYWN0U2hhcmQgJiYgYWJBcnRpZmFjdFNoYXJkLmRhdGEgJiYgYWJBcnRpZmFjdFNoYXJkLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0U2hhcmQgaXMgYSByZXF1aXJlZCB0byBiZSBhIEFCQXJ0aWZhY3RTaGFyZC5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSB7CiAgICBuYW1lOiBhYkFydGlmYWN0TmFtZSwKICAgIGZvcm1hdFZlcnNpb246IDEsCiAgICBkYXRhOiBhYkFydGlmYWN0U2hhcmQuZGF0YSwKICAgIGRlcGVuZGVuY2llczogYWJBcnRpZmFjdFNoYXJkLmRlcGVuZGVuY2llcywKfQoKLy8gR2VuZXJhdGUgdGhlIGFydGlmYWN0IGlkLCB3aGljaCBpcyBzaGEyNTYgaGFzaCBvZiB0aGUgY29yZSBjb250ZW50cyBvZiB0aGUgYXJ0aWZhY3QuCmFiQXJ0aWZhY3RCdW5kbGUuaWQgPSBjcnlwdG8uc2hhMjU2KGFiQXJ0aWZhY3RCdW5kbGUpOwoKLy8gU3RvcmUgc29tZSBleHRyYSBtZXRhZGF0YSBwcm9wZXJ0aWVzIHdpdGggdGhlIGFydGlmYWN0LgovLyBUaGVzZSBhcmUgbm90IGNvcmUgdG8gdGhlIGFydGlmYWN0J3MgZnVuY3Rpb25hbGl0eSBidXQgbWF5IGJlIHVzZWZ1bCBhcyBhcnRpZmFjdHMgZXZvbHZlLgphYkFydGlmYWN0QnVuZGxlLmNhc3VhbE9TVmVyc2lvbiA9IG9zLnZlcnNpb24oKTsKYWJBcnRpZmFjdEJ1bmRsZS5jcmVhdGVkVGltZXN0YW1wID0gRGF0ZVRpbWUubm93KCkudG9JU08oKTsKYWJBcnRpZmFjdEJ1bmRsZS5hYlNoZWxsVmVyc2lvbiA9IGAke2xpbmtzLnZlcnNpb24ucmF3LmFiU2hlbGxNYWpvclZlcnNpb259LiR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1pbm9yVmVyc2lvbn1gOwoKcmV0dXJuIGFiQXJ0aWZhY3RCdW5kbGU7JwDrpJSGAfSfBAZjcmVhdGUCBADrpJSGAcq7Bijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwDrpJSGAfSfBBNpc0V4cGVyaWVuY2VFbmFibGVkAgQA66SUhgHxuwY1QHJldHVybiBjb25maWdCb3QudGFncy5hYkFydGlmYWN0RXhwZXJpZW5jZSA9PT0gdHJ1ZTsnAOuklIYB9J8EHmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudAIEAOuklIYBp7wGphlAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBleHBlcmllbmNlIGlzIGRpc2FibGVkLmApOwogICAgcmV0dXJuOwp9CgppZiAoIXRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MgPSB7fTsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYWxyZWFkeSBoYXMgYSBkb2N1bWVudCBsb2FkZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCi8vIEdldCB0aGUgYXJ0aWZhY3QgaW5zdGFuY2UncyBzaGFyZWQgZG9jdW1lbnQgYXMgd2VsbCBhcyB0aGUgZXhwZXJpZW5jZSBtYXAuCmNvbnN0IGRvY3VtZW50ID0gYXdhaXQgb3MuZ2V0U2hhcmVkRG9jdW1lbnQobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWUsIGBhcnRpZmFjdEluc3RhbmNlXyR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCwgJ21haW4nKTsKY29uc3QgZXhwZXJpZW5jZU1hcCA9IGRvY3VtZW50LmdldE1hcCgnZXhwZXJpZW5jZScpOwoKY29uc3Qgc2tpcEtleXMgPSBuZXcgU2V0KFsKICAgICdhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkJywKICAgIC8vIEFkZCBtb3JlIGtleXMgaGVyZSBpZiBuZWVkZWQKICAgIC8vICdzb21lT3RoZXJLZXknLAogICAgLy8gJ3lldEFub3RoZXJLZXknCl0pOwoKY29uc3QgZXhwZXJpZW5jZVN1YiA9IGV4cGVyaWVuY2VNYXAuZGVlcENoYW5nZXMuc3Vic2NyaWJlKChldmVudHMpID0+IHsKICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBvbiBkZWVwIGNoYW5nZXM6YCwgZXZlbnRzKTsKICAgIH0KCiAgICAvLyBDb2xsZWN0IGFsbCBjaGFuZ2VkIGtleXMKICAgIGNvbnN0IGFsbEtleXMgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGV2dCBvZiBldmVudHMgPz8gW10pIHsKICAgICAgICBjb25zdCBtID0gZXZ0Py5jaGFuZ2VzOwogICAgICAgIGlmIChtICYmIHR5cGVvZiBtLmtleXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgZm9yIChjb25zdCBrIG9mIG0ua2V5cygpKSB7CiAgICAgICAgICAgICAgICBhbGxLZXlzLmFkZChrKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvLyBTa2lwIGlmICphbGwqIGNoYW5nZXMgYXJlIGluc2lkZSB0aGUgc2tpcCBsaXN0CiAgICBjb25zdCBzaG91bGRTa2lwID0gYWxsS2V5cy5zaXplID4gMCAmJiBbLi4uYWxsS2V5c10uZXZlcnkoKGspID0+IHNraXBLZXlzLmhhcyhrKSk7CiAgICBpZiAoc2hvdWxkU2tpcCkgewogICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2tpcHBpbmcgY2FsbCB0byBhYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZSwgdGhlIG9ubHkgY2hhbmdlIHRvIHRoZSBleHBlcmllbmNlIHdlcmUgc3BlY2lhbCByZXNlcnZlZCBwcm9wZXJ0aWVzLmApOwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICB9CgogICAgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9KTsKCnRoaXNCb3QudmFycy5pbnN0YW5jZURvY3NbYWJBcnRpZmFjdEluc3RhbmNlSURdID0geyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1Yn07CgppZiAodGFncy5kZWJ1Z0V4cCkgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBpbnN0YW5jZSBkb2N1bWVudCBsb2FkZWQ6YCwgdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF0pOwp9Cgpjb25zdCBhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkID0gZXhwZXJpZW5jZU1hcC5nZXQoJ2FiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQnKTsKCmlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGluc3RhbmNlIGRvY3VtZW50IGFiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQ6YCwgYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCk7Cn0KCmlmIChhYkFydGlmYWN0RXhwZXJpZW5jZUluaXRpYWxpemVkID09PSB0cnVlKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRpbmcgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZnJvbSBleHBlcmllbmNlLmApOwogICAgfQogICAgLy8gSW1tZWRpYXRlbHkgZ2l2ZSB0aGUgc2hhcmQgYm90cyB0aGUgY3VycmVudCBleHBlcmllbmNlIHN0YXRlLgogICAgYXdhaXQgdGhpc0JvdC5hYlVwZGF0ZUFydGlmYWN0SW5zdGFuY2VGcm9tRXhwZXJpZW5jZSh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIH0pOwp9IGVsc2UgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGluaXRpYWxpemluZyBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSBleHBlcmllbmNlLmApOwogICAgfQogICAgLy8gSW5pdGlhbGl6ZSB0aGUgZXhwZXJpZW5jZSBzdGF0ZSB3aXRoIHRoZSBjdXJyZW50IHNoYXJkIGRhdGEuCiAgICBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RJbnN0YW5jZUV4cGVyaWVuY2UoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsgICAgCn0KJwDrpJSGAfSfBCBhYlVubG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudAIEAOuklIYBztUGiQZAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAodGhpc0JvdC52YXJzLmluc3RhbmNlRG9jcykgewogICAgY29uc3QgeyBkb2N1bWVudCwgZXhwZXJpZW5jZU1hcCwgZXhwZXJpZW5jZVN1YiB9ID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07IAoKICAgIGlmIChleHBlcmllbmNlU3ViKSB7CiAgICAgICAgZXhwZXJpZW5jZVN1Yi51bnN1YnNjcmliZSgpOwoKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVuc3Vic2NyaWJlZCBmcm9tIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGV4cGVyaWVuY2UgbWFwLmApOwogICAgICAgIH0KICAgIH0KCiAgICBkZWxldGUgdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlbW92ZWQgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gZG9jdW1lbnQuYCk7CiAgICB9Cn0nAOuklIYB9J8EHmFiR2V0QXJ0aWZhY3RJbnN0YW5jZVNoYXJkQm90cwIEAOuklIYB2NsGtAJAY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKY29uc3Qgc2hhcmRCb3RzID0gZ2V0Qm90cygoYikgPT4gewogICAgcmV0dXJuIGIudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQKfSk7CgpyZXR1cm4gc2hhcmRCb3RzOycA66SUhgH0nwQmYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRnJvbUV4cGVyaWVuY2UCBADrpJSGAY3eBocGQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEluc3RhbmNlSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKaWYgKCF0aGlzQm90LmlzRXhwZXJpZW5jZUVuYWJsZWQoKSkgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhwZXJpZW5jZSBpcyBkaXNhYmxlZC5gKTsKICAgIHJldHVybjsKfQoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IGluc3RhbmNlRG9jID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgaWYgKGluc3RhbmNlRG9jKSB7CiAgICAgICAgY29uc3Qgc2hhcmRCb3RzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMoeyBhYkFydGlmYWN0SW5zdGFuY2VJRH0pOwoKICAgICAgICBjb25zdCB7IGRvY3VtZW50LCBleHBlcmllbmNlTWFwLCBleHBlcmllbmNlU3ViIH0gPSBpbnN0YW5jZURvYzsKCiAgICAgICAgY29uc3QgZXhwZXJpZW5jZURhdGEgPSBleHBlcmllbmNlTWFwLnRvSlNPTigpOwogICAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZCh3aGlzcGVyKHNoYXJkQm90cywgJ29uQUJBcnRpZmFjdEV4cGVyaWVuY2UnLCB7IGRhdGE6IGV4cGVyaWVuY2VEYXRhIH0pKTsKICAgIH0KfScA66SUhgH0nwQiYWJVcGRhdGVBcnRpZmFjdEluc3RhbmNlRXhwZXJpZW5jZQIEAOuklIYBleQG0ChAaW1wb3J0IHsgU2hhcmVkTWFwIH0gZnJvbSAnY2FzdWFsb3MnOwoKY29uc3QgewogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CgppZiAoIXRoaXNCb3QuaXNFeHBlcmllbmNlRW5hYmxlZCgpKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgaXMgZGlzYWJsZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCmlmICghdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzKSB7CiAgICB0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMgPSBuZXcgU2V0KCk7Cn0KCmlmICh0aGlzQm90LnZhcnMuYWN0aXZlRXhwZXJpZW5jZVVwZGF0ZXMuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGV4cGVyaWVuY2UgdXBkYXRlIGlzIGFscmVhZHkgaW4gcHJvZ3Jlc3MgZm9yIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICB9CiAgICByZXR1cm47Cn0KCnRoaXNCb3QudmFycy5hY3RpdmVFeHBlcmllbmNlVXBkYXRlcy5hZGQoYWJBcnRpZmFjdEluc3RhbmNlSUQpOwoKaWYgKHRoaXNCb3QudmFycy5pbnN0YW5jZURvY3MpIHsKICAgIGNvbnN0IGluc3RhbmNlRG9jID0gdGhpc0JvdC52YXJzLmluc3RhbmNlRG9jc1thYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgaWYgKGluc3RhbmNlRG9jKSB7CiAgICAgICAgY29uc3Qgc2hhcmRCb3RzID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VTaGFyZEJvdHMoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCiAgICAgICAgLy8gTmVlZCB0byBhc2sgaWYgdGhpcyB1c2VyIGlzIGFsbG93ZWQgdG8gdXBkYXRlIHRoZSBleHBlcmllbmNlIG9mIHRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UuCiAgICAgICAgY29uc3QgY2FuVXNlclVwZGF0ZSA9IGF3YWl0IHRoaXNCb3QuY2FuVXNlclVwZGF0ZUV4cGVyaWVuY2UoeyByZW1vdGVJZDogY29uZmlnQm90LmlkLCBzaGFyZEJvdDogc2hhcmRCb3RzWzBdIH0pOwoKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbiB1c2VyIHVwZGF0ZSBleHBlcmllbmNlIGZvciBhYkFydGlmYWN0SW5zdGFuY2VJRCAke3NoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlELnN1YnN0cmluZygwLCA3KX0/YCwgY2FuVXNlclVwZGF0ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY2FuVXNlclVwZGF0ZSkgewogICAgICAgICAgICBsZXQgY29sbGVjdFNoYXJkUmVzdWx0OiBBQkFydGlmYWN0Q29sbGVjdFNoYXJkc1Jlc3VsdDsKCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBjb2xsZWN0U2hhcmRSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiQ29sbGVjdEFydGlmYWN0U2hhcmRzKHsgc2hhcmRCb3RzIH0pOwoKICAgICAgICAgICAgICAgIGlmICghY29sbGVjdFNoYXJkUmVzdWx0LnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGNvbGxlY3RTaGFyZFJlc3VsdC5yZWFzb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRDpgLCBhYkFydGlmYWN0SW5zdGFuY2VJRCwgYGNvbGxlY3RTaGFyZFJlc3VsdDpgLCBKU09OLnN0cmluZ2lmeShjb2xsZWN0U2hhcmRSZXN1bHQpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGNvbGxlY3RTaGFyZFJlc3VsdCAmJiBjb2xsZWN0U2hhcmRSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICAgICAgLy8gT25seSB1cGRhdGUgZW50cnkgaW4gZXhwZXJpZW5jZU1hcCBpZiB0aGUgZGF0YSBpcyBhY3R1YWxseSBkaWZmZXJlbnQuCiAgICAgICAgICAgICAgICBjb25zdCBleHBlcmllbmNlTWFwOiBTaGFyZWRNYXAgPSBpbnN0YW5jZURvYy5leHBlcmllbmNlTWFwOwoKICAgICAgICAgICAgICAgIC8vIFNhZmV0eTogc2hhcmQgZGF0YSBtaWdodCBiZSB1bmRlZmluZWQvbnVsbAogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmREYXRhID0gKGNvbGxlY3RTaGFyZFJlc3VsdC5zaGFyZCAmJiBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQuZGF0YSkgPyBjb2xsZWN0U2hhcmRSZXN1bHQuc2hhcmQuZGF0YSA6IHt9OwogICAgICAgICAgICAgICAgY29uc3Qgc2hhcmREYXRhS2V5cyA9IE9iamVjdC5rZXlzKHNoYXJkRGF0YSk7CiAgICAgICAgICAgICAgICBjb25zdCBrZXlzVG9EZWxldGUgPSBbXTsKCiAgICAgICAgICAgICAgICAvLyBTaW1wbGUgZGVlcC1lcXVhbGl0eSBjaGVjayBmb3IgSlNPTi1zZXJpYWxpemFibGUgdmFsdWVzCiAgICAgICAgICAgICAgICBjb25zdCBpc0VxdWFsID0gKGEsIGIpID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoYSA9PT0gYikgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGEpID09PSBKU09OLnN0cmluZ2lmeShiKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gMSkgVXBzZXJ0IG9ubHkgd2hlbiBkaWZmZXJlbnQKICAgICAgICAgICAgICAgIGZvciAoY29uc3Qga2V5IG9mIHNoYXJkRGF0YUtleXMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdWYWwgPSBzaGFyZERhdGFba2V5XTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWwgPSBleHBlcmllbmNlTWFwLmdldChrZXkpOwogICAgICAgICAgICAgICAgICAgIGlmICghaXNFcXVhbChvbGRWYWwsIG5ld1ZhbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdXBkYXRpbmcgZXhwZXJpZW5jZU1hcCBrZXkgIiR7a2V5fSJgLCBKU09OLnN0cmluZ2lmeSh7IG9sZFZhbCwgbmV3VmFsIH0pKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLnNldChrZXksIG5ld1ZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIDIpIENvbGxlY3Qga2V5cyB0aGF0IGV4aXN0IGluIHRoZSBtYXAgYnV0IG5vdCBpbiB0aGUgc2hhcmQgZGF0YQogICAgICAgICAgICAgICAgLy8gICAgKHdlIGF2b2lkIG11dGF0aW5nIHRoZSBtYXAgd2hpbGUgaXRlcmF0aW5nIGl0KQogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2YgZXhwZXJpZW5jZU1hcC5rZXlzKCkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSAnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRG9uJ3QgZGVsZXRlIGFiQXJ0aWZhY3RFeHBlcmllbmNlSW5pdGlhbGl6ZWQuIEl0cyBhIHNwZWNpYWwgcHJvcGVydHkuCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiAoIXNoYXJkRGF0YUtleXMuaW5jbHVkZXMoa2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXlzVG9EZWxldGUucHVzaChrZXkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyAzKSBSZW1vdmUgc3RhbGUga2V5cwogICAgICAgICAgICAgICAgZm9yIChjb25zdCBrZXkgb2Yga2V5c1RvRGVsZXRlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBkZWxldGluZyBzdGFsZSBleHBlcmllbmNlTWFwIGtleSAiJHtrZXl9ImApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLmRlbGV0ZShrZXkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChleHBlcmllbmNlTWFwLmdldCgnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcpICE9IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBleHBlcmllbmNlTWFwLnNldCgnYWJBcnRpZmFjdEV4cGVyaWVuY2VJbml0aWFsaXplZCcsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgICAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjYW5ub3QgdXBkYXRlIGFiQXJ0aWZhY3RJbnN0YW5jZUlEICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9IGJlY2F1c2UgaW5zdGFuY2UgZG9jdW1lbnQgbm90IGxvYWRlZC5gKTsKICAgICAgICB9CiAgICB9Cn0gZWxzZSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNhbm5vdCB1cGRhdGUgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH0gYmVjYXVzZSBpbnN0YW5jZSBkb2N1bWVudHMgaGF2ZSBub3QgYmVlbiBpbml0aWFsaXplZC5gKTsKICAgIH0KfQoKdGhpc0JvdC52YXJzLmFjdGl2ZUV4cGVyaWVuY2VVcGRhdGVzLmRlbGV0ZShhYkFydGlmYWN0SW5zdGFuY2VJRCk7JwDrpJSGAfSfBAxvbkluc3RKb2luZWQCBADrpJSGAeaMB4EDQG1hc2tzLmluc3RKb2luZWQgPSB0cnVlOwoKY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXMgPSB0aGlzQm90LmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMoKTsKCmZvciAobGV0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGFydGlmYWN0SW5zdGFuY2VzKSB7CiAgICBpZiAodGFncy5kZWJ1Z0V4cCkgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gbG9hZGluZyBhcnRpZmFjdCBpbnN0YW5jZSBkb2N1bWVudCBmb3IgYWJBcnRpZmFjdEluc3RhbmNlSUQgJHthYkFydGlmYWN0SW5zdGFuY2VJRH1gKTsKICAgIH0KICAgIAogICAgdGhpc0JvdC5hYkxvYWRBcnRpZmFjdEluc3RhbmNlRG9jdW1lbnQoeyBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKfScA66SUhgH0nwQOb25BbnlCb3RzQWRkZWQCBADrpJSGAeiPB8IEQGlmICghbWFza3MuaW5zdEpvaW5lZCkgewogICAgcmV0dXJuOwp9Cgpjb25zdCBhZGRlZEJvdHMgPSB0aGF0LmJvdHM7Cgpmb3IgKGNvbnN0IGJvdCBvZiBhZGRlZEJvdHMpIHsKICAgIGlmIChib3QgPT0gbnVsbCkgewogICAgICAgIGNvbnRpbnVlOwogICAgfQoKICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIGF3YWl0IG9zLnNsZWVwKDUwMCk7CgogICAgICAgIGlmIChib3QudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnRXhwKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGRldGVjdGVkIGFkZGVkIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiAke2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEfS5gKQogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzQm90LmFiTG9hZEFydGlmYWN0SW5zdGFuY2VEb2N1bWVudCh7IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKICAgICAgICB9CiAgICB9Cn0nAQRib3RzJDkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YwEnAOuklIYBq5QHDmFiRmlsZVRpbWVjb2RlAgQA66SUhgGslAdmQGNvbnN0IGRhdGU6IERhdGVUaW1lID0gdGhhdD8uZGF0ZSA/PyBEYXRlVGltZS5ub3coKTsKcmV0dXJuIGRhdGUudG9VVEMoKS50b0Zvcm1hdCgneXl5eU1NZGQtSEhtbXNzJyk7JwDrpJSGAauUBwZzeXN0ZW0CBADrpJSGAZOVBw5hYi5zaGVsbC51dGlscycA66SUhgGrlAcMYWJDb21waWxlQ1NTAgQA66SUhgGilQeCBEBsZXQgYm90cyA9IHRoYXQ7Cgpib3RzID0gQXJyYXkuaXNBcnJheShib3RzKSA/IGJvdHMgOiBbYm90c107CgpsZXQgY3NzID0gW107Cgpmb3IgKGxldCBib3Qgb2YgYm90cykgewogICAgZm9yIChsZXQga2V5IGluIGJvdC50YWdzKSB7CiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpLmVuZHNXaXRoKCdjc3MnKSkgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmb3VuZCBDU1Mga2V5OiAke2tleX1gKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjc3MucHVzaChib3QudGFnc1trZXldKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IGNvbXBpbGVkID0gY3NzLmpvaW4oJ1xuXG4nKTsKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gY29tcGlsZWQgQ1NTOlxuXG5gLCBjb21waWxlZCk7Cn0KCnJldHVybiBjb21waWxlZDsnAOuklIYBq5QHCGFiSWdub3JlAgQA66SUhgGlmQcEdHJ1ZScA66SUhgGrlAcHYWJTaGVsbAIEAOuklIYBqpkHBHRydWUnAOuklIYBq5QHCWFiVmVyc2lvbgIEAOuklIYBr5kHBDEwLjUnAOuklIYBq5QHDWFiTG9nQW5kVG9hc3QCBADrpJSGAbSZB7MKQGxldCBtZXNzYWdlOwpsZXQgZHVyYXRpb247CmxldCBsb2dUeXBlID0gJ2xvZyc7CmxldCB0b2FzdCA9IHRydWU7CgppZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICBtZXNzYWdlID0gdGhhdDsKICAgIGR1cmF0aW9uID0gdGhpc0JvdC5lc3RpbWF0ZVJlYWRpbmdUaW1lKHsgdGV4dDogdGhhdCwgZGVsYXlUaW1lOiAxMDAwIH0pIC8gMTAwMDsKfSBlbHNlIHsKICAgIG1lc3NhZ2UgPSB0aGF0Lm1lc3NhZ2U7CiAgICBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb24gPz8gKHRoaXNCb3QuZXN0aW1hdGVSZWFkaW5nVGltZSh7IHRleHQ6IHRoYXQubWVzc2FnZSwgZGVsYXlUaW1lOiAxMDAwIH0pIC8gMTAwMCk7CiAgICBsb2dUeXBlID0gdGhhdC5sb2dUeXBlID8/IGxvZ1R5cGU7CiAgICB0b2FzdCA9IHRoYXQudG9hc3QgPz8gdG9hc3Q7Cn0KCmlmIChsb2dUeXBlID09PSAnbG9nJykgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIGlmICh0b2FzdCkgb3MudG9hc3QobWVzc2FnZSwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICd3YXJuaW5nJyB8fCBsb2dUeXBlID09PSAnd2FybicpIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiBXYXJuaW5nOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLndhcm4oYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChgV2FybmluZzogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIGlmIChsb2dUeXBlID09PSAnZXJyb3InKSB7CiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogRXJyb3I6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUuZXJyb3IoYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChgRXJyb3I6ICR7bWVzc2FnZX1gLCBkdXJhdGlvbik7Cn0gZWxzZSB7CiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7Cn0nAOuklIYBq5QHCHJlbWVtYmVyAgQA66SUhgHoowco8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA66SUhgGrlAcFYWJMb2cCBADrpJSGAY+kB8cBQGlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICB9KTsKfSBlbHNlIHsKICAgIHRoaXNCb3QuYWJMb2dBbmRUb2FzdCh7CiAgICAgICAgLi4udGhhdCwKICAgICAgICB0b2FzdDogZmFsc2UsCiAgICB9KTsKfScA66SUhgGrlAcTZXN0aW1hdGVSZWFkaW5nVGltZQIEAOuklIYB16UH3ANAY29uc3QgewogICAgdGV4dCA9ICcnLAogICAgd29yZHNQZXJNaW51dGUgPSAyNTAsCiAgICBkZWxheVRpbWUgPSA1MDAsCn0gPSB0aGF0OwoKLy8gQ291bnQgd29yZHMgKHJvdWdoIGFwcHJveGltYXRpb24gYnkgc3BsaXR0aW5nIG9uIHdoaXRlc3BhY2UpCmNvbnN0IHdvcmRDb3VudCA9IHRleHQudHJpbSgpLnNwbGl0KC9ccysvKS5sZW5ndGg7CmxldCB0b3RhbFRpbWVNcyA9IDA7CgppZiAod29yZENvdW50ID4gMCkgewogICAgLy8gQ2FsY3VsYXRlIHJlYWRpbmcgdGltZSBpbiBtaWxsaXNlY29uZHMKICAgIGNvbnN0IHdvcmRzUGVyU2Vjb25kID0gd29yZHNQZXJNaW51dGUgLyA2MDsKICAgIGNvbnN0IHJlYWRpbmdUaW1lTXMgPSBNYXRoLmNlaWwoKHdvcmRDb3VudCAvIHdvcmRzUGVyU2Vjb25kKSAqIDEwMDApOwoKICAgIHRvdGFsVGltZU1zID0gcmVhZGluZ1RpbWVNcyArIGRlbGF5VGltZTsKfQoKcmV0dXJuIHRvdGFsVGltZU1zOycA66SUhgGrlAcIaXNPYmplY3QCBADrpJSGAbSpBzlAcmV0dXJuIHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheSh0aGF0KTsnAOuklIYBq5QHB2lzQXJyYXkCBADrpJSGAe6pBxxAcmV0dXJuIEFycmF5LmlzQXJyYXkodGhhdCk7JwDrpJSGAauUBwhpc1N0cmluZwIEAOuklIYBi6oHIUByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnOycBBGJvdHMkZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1AScA66SUhgGtqgcGc3lzdGVtAgQA66SUhgGuqgcPYWIuc2hlbGwuc2VhcmNoJwDrpJSGAa2qBwRmb3JtAgQA66SUhgG+qgcHbm90aGluZycA66SUhgGtqgcOYWJSZXRyaWV2ZUZpbGUCBADrpJSGAcaqB4IBQC8vcHVsbCBkb3duIGZpbGUgZGF0YQppZiAoIXRoYXQudXJsKQp7CiAgICByZXR1cm4gIm5vIGZpbGUgdXJsIHN1cHBsaWVkIjsKfQoKbGV0IGRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKHRoYXQudXJsKTsKCnJldHVybiBkYXRhOycA66SUhgGtqgcQYWJSZXRyaWV2ZVJlY29yZAIEAOuklIYByasH7ARALy9yZXRyaWV2ZSBzcGVjaWZpZWQgcmVjb3JkCmxldCByZWNvcmROYW1lID0gdGhhdC5yZWNvcmROYW1lOwoKbGV0IHJlY29yZEtleSA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXk7CgppZiAodGhhdC5yZWNvcmRLZXkpCnsKICAgIHJlY29yZEtleSA9IHRoYXQucmVjb3JkS2V5Owp9CmVsc2UgaWYgKGF1dGhCb3QpCnsKICAgIGlmIChhdXRoQm90LmlkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbykKICAgIHsKICAgICAgICByZWNvcmRLZXkgPSBhdXRoQm90LmlkOwoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgIH0KfQoKbGV0IHJlY29yZEVuZHBvaW50ID0gdGhhdC5yZWNvcmRFbmRwb2ludCA/IHRoYXQucmVjb3JkRW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CgppZiAoIXJlY29yZE5hbWUpCnsKICAgIHJldHVybiAibm8gcmVjb3JkIG5hbWUgc3VwcGxpZWQiOwp9CgpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIHJlY29yZE5hbWUsIHJlY29yZEVuZHBvaW50KTsKCi8vQUREIGFkZGl0aW9uYWwgZXJyb3IgaGFuZGxpbmc/CgpyZXR1cm4gZ2V0UmVjb3JkOycA66SUhgGtqgcIcmVtZW1iZXICBADrpJSGAbawByjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDrpJSGAa2qBw1tYW5pZmVzdGF0aW9uAgQA66SUhgHdsAco8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA66SUhgGtqgcOb25Mb29rdXBBQkVnZ3MCBADrpJSGAYSxB44xQGNvbnN0IHsgCiAgICBhYklELAogICAgYWJWZXJzaW9uLAogICAgaW5pdGlhbEJvb3QsCiAgICBhdXRvSGF0Y2gsCiAgICByZXR1cm5UeXBlLAogICAgZWdnUGFyYW1ldGVycywKICAgIGtleSA9IGNvbmZpZ0JvdC50YWdzLmtleSwKICAgIHRvYXN0ID0gdHJ1ZSwKICAgIHNob3dJbmRpY2F0b3IgPSB0cnVlLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsIC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQp9ID0gdGhhdDsKCmxldCB7CiAgICByZWNvcmRLZXkgPSBjb25maWdCb3QudGFncy5zdHVkaW8sCn0gPSB0aGF0OwoKYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBsb2FkaW5nICIgKyBhYklEKTsKCi8vY2xlYXIgYWItMQppZiAobGlua3MubWFuaWZlc3RhdGlvbiAmJiBjb25maWdCb3QudGFncy5tZW51UG9ydGFsID09ICJhYk1lbnUiKSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfQoKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvYWRpbmcgJHthYklEfWB9KTsKfQoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKbGV0IGVnZ0RhdGE7CgovL3RoaXMgbG9naWMgaGFuZGxlcyB0aGUgcmV0cmlldmVkIGRhdGEsIHNlYXJjaGVzIGFnYWluIGlmIG5vbmUgY2FtZSB0aHJvdWdoCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmIChwb3NzaWJsZUF1dGguaWQgPT0gcmVjb3JkS2V5ICYmCiAgICAgICAgbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSAmJgogICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJyZWNvcmRfbm90X2ZvdW5kIgogICAgKSB7CiAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIikgewogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CiAgICB9IGVsc2UgaWYgKGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfbG9nZ2VkX2luIikgewogICAgICAgIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogICAgICAgIGlmICghcmVjb3JkS2V5KSB7CiAgICAgICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CiAgICAgICAgfQoKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgogICAgICAgIGlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MgJiYgCiAgICAgICAgICAgIGdldFJlY29yZC5lcnJvckNvZGUgPT09ICJub3RfYXV0aG9yaXplZCIKICAgICAgICApIHsKICAgICAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICAgICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgICAgICB9CiAgICB9Cn0KCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGlmICh0b2FzdCkgeyAKICAgICAgICBvcy50b2FzdChgbm8gZGF0YSBmb3VuZCBpbiAke2FiSUR9YCk7CiAgICB9CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICB9CgogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQplbHNlIHsKICAgIGNvbnN0IHB1YmxpY1JlYWRUZXN0ID0gZ2V0UmVjb3JkLm1hcmtlcnMuaW5kZXhPZigicHVibGljUmVhZCIpOwogICAgY29uc3QgYXV0aG9yID0gYXdhaXQgb3MucmVxdWVzdEF1dGhCb3RJbkJhY2tncm91bmQoKTsKCiAgICBpZiAocHVibGljUmVhZFRlc3QgIT0gLTEgJiYgYXV0aG9yKSB7CiAgICAgICAgaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSB7CiAgICAgICAgICAgIGNvbnN0IGVnZ0hhdGNoRXZlbnQgPSBhYklEOwoKICAgICAgICAgICAgb3MucmVjb3JkRXZlbnQobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgZWdnSGF0Y2hFdmVudCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vcGFja2FnZSB0aGUgcmVjb3JkIGRhdGEKICAgIGVnZ0RhdGEgPSBnZXRSZWNvcmQuZGF0YTsKCiAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgLy8gQ2hhbmdlIGluaXRpYWwgdGFyZ2V0IHZlcnNpb24gb2YgdGhlIGVnZyBpZiBhYlZlcnNpb24gaXMgcHJvdmlkZWQuCiAgICAgICAgZWdnRGF0YS50YXJnZXRWZXJzaW9uID0gYWJWZXJzaW9uOwogICAgfQp9CgpsaW5rcy51dGlscy5hYkxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiAiICsgYWJJRCArICIgbG9hZGVkLCB2ZXJzaW9uICIgKyBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgZ2V0UmVjb3JkLmRhdGEubWF4VmVyc2lvbik7CgppZiAocmV0dXJuVHlwZSAhPSBudWxsKSB7CiAgICBpZiAoZ2V0UmVjb3JkLnN1Y2Nlc3MpIHsKICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGxldCB2ZXJzaW9uID0gZ2V0UmVjb3JkLmRhdGEudGFyZ2V0VmVyc2lvbiAtIDE7CgogICAgICAgICAgICBpZiAoYWJWZXJzaW9uKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzTmFOKGFiVmVyc2lvbikpIHsKICAgICAgICAgICAgICAgICAgICB2ZXJzaW9uID0gYWJWZXJzaW9uIC0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgICAgICAgICBjb25zdCByZXR1cm5EYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShlZ2dEYXRhVVJMKTsKCiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmV0dXJuRGF0YTsKICAgICAgICB9IGVsc2UgaWYgKHJldHVyblR5cGUgPT09ICJlZ2ciKSB7CiAgICAgICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKGVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkpOwogICAgICAgICAgICBjb25zdCBmaWxlVVVJRCA9IHZlcnNpb25BcnJheVtlZ2dEYXRhLm1heFZlcnNpb24gLSAxXTsKICAgICAgICAgICAgY29uc3QgZmlsZW5hbWVoYXNoTFRNID0gY3J5cHRvLnNoYTI1NihmaWxlVVVJRCk7CiAgICAgICAgICAgIGNvbnN0IGZpbGV1cmxoYXNoTFRNID0gImF1eF8iICsgZmlsZW5hbWVoYXNoTFRNICsgJy5hdXgnOwogICAgICAgICAgICBjb25zdCB0YXJnZXRMVE1VUkwgPSAiaHR0cHM6Ly9idWlsZGVyLWx0bS1maWxlcy5zMy5hbWF6b25hd3MuY29tLyIgKyBmaWxldXJsaGFzaExUTTsKICAgICAgICAgICAgY29uc3QgbyA9IHsKICAgICAgICAgICAgICAgIG1ldGhvZDogIkdFVCIsCiAgICAgICAgICAgICAgICB1cmw6IHRhcmdldExUTVVSTAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbGV0IGZpbGVHZXQgPSBhd2FpdCB3ZWJob29rKG8pOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5tYW5pZmVzdE92byh7CiAgICBhYklELAogICAgc3R1ZGlvOiByZWNvcmRLZXksCiAgICBkaW1Nb2QsCiAgICBzcGFjZU1vZCwKICAgIGVnZ0RhdGEsCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwKfSk7CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIHsKICAgIHN1Y2Nlc3M6IHRydWUsCiAgICBoYXRjaGVkQm90czogbWFuaWZlc3RSZXN1bHQ/LmhhdGNoZWRCb3RzLAp9OycA66SUhgGtqgcLbWFuaWZlc3RPdm8CBADrpJSGAZPiB7UPQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCmlmIChsaW5rcy5vdm9Cb3QpIHsKICAgIGRlc3Ryb3kobGlua3Mub3ZvQm90KTsKfQoKbGV0IGVnZ01vZCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGluaXRpYWxUaW1lcjogdHJ1ZSwKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBzb3VyY2VFdmVudCwKICAgIGN1cnNvcjogJ3BvaW50ZXInLAogICAgbWFuYWdlcjogZ2V0TGluayh0aGlzQm90KSwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5pbnRlcmFjdE92bygpOwogICAgYCwKICAgIGZvcm06ICJlZ2ciLAogICAgY29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICBwcm9ncmVzc0JhckNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yLAogICAgcHJvZ3Jlc3NCYXJCYWNrZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbFNpemU6IDAuNSwKICAgIG9uUG9pbnRlckVudGVyOiBgQAogICAgICAgIG1hc2tzLnRpcElkID0gYXdhaXQgb3MudGlwKHRhZ3MuYWJJRCArICcgdicgKyB0YWdzLnRhcmdldFZlcnNpb24pOwogICAgYCwKICAgIG9uUG9pbnRlckV4aXQ6IGBACiAgICAgICAgaWYgKG1hc2tzLnRpcElkKSB7CiAgICAgICAgICAgIG9zLmhpZGVUaXBzKG1hc2tzLnRpcElkKTsKICAgICAgICB9CiAgICBgLAogICAgbGFiZWxQb3NpdGlvbjogImZyb250IiwKICAgIG9yaWVudGF0aW9uTW9kZTogImJpbGxib2FyZEZyb250IiwKICAgIG9uRGVzdHJveTogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLm1hc2tzLm92b0JvdCA9IG51bGw7CiAgICBgLAogICAgZWdnVGltZXI6IGBACiAgICAgICAgaWYgKHRhZ3MucHJvZ3Jlc3NCYXIgPCAxKSB7CiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgKz0gMC4xOwoKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7d2hpc3Blcih0aGlzQm90LCAiZWdnVGltZXIiKTt9LCA3NSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpc0JvdC5vbkNsaWNrKCk7CiAgICAgICAgICAgIAogICAgICAgICAgICB0YWdzLnByb2dyZXNzQmFyID0gbnVsbDsKICAgICAgICB9CiAgICBgCn07CgoKY29uc3Qgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7Cm1hc2tzLm92b0JvdCA9IGdldExpbmsob3ZvKTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsKfQoKaWYgKG92by50YWdzLmF1dG9IYXRjaCkgewogICAgY29uc3QgaGF0Y2hlZEJvdHMgPSBhd2FpdCB0aGlzQm90LmhhdGNoT3ZvKG92byk7CiAgICByZXR1cm4geyBoYXRjaGVkQm90cyB9Owp9CmVsc2UgewogICAgb3ZvLnRhZ3MucHJvZ3Jlc3NCYXIgPSAwOwogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG92by50YWdzLm1heFZlcnNpb247CiAgICBzZXRUaW1lb3V0KCgpID0+IHsgd2hpc3Blcihvdm8sICJlZ2dUaW1lciIpOyB9LCA3NSk7Cn0nAOuklIYBraoHCW9uS2V5RG93bgIEAOuklIYByfEHggZALy9oaWRkZW4gdmVyc2lvbiBidXR0b24gZm9yIGhhdGNoIG1lbnUKaWYgKCFsaW5rcy5vdm9Cb3QgfHwgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCAhPSAiYWJPdm9NZW51IikKewogICAgcmV0dXJuOwp9CgppZiAodGhhdC5rZXlzID09ICJTaGlmdCIpCnsKICAgIGxldCB2ZXJzaW9uQnV0dG9uID0ge307CgogICAgdmVyc2lvbkJ1dHRvbi5hYk92b01lbnUgPSB0cnVlOwogICAgdmVyc2lvbkJ1dHRvbi5vdm9Tb3J0T3JkZXIgPSAtMTsKICAgIHZlcnNpb25CdXR0b24ubWF4VmVyc2lvbiA9IGxpbmtzLm92b0JvdC50YWdzLm1heFZlcnNpb247CiAgICB2ZXJzaW9uQnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwogICAgdmVyc2lvbkJ1dHRvbi5sYWJlbCA9ICJjaGFuZ2UgZWdnIHZlcnNpb24iOwogICAgdmVyc2lvbkJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJjZW50ZXIiOwogICAgdmVyc2lvbkJ1dHRvbi5vdm9NZW51UmVzZXQgPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CiAgICB2ZXJzaW9uQnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VBY2NlbnRDb2xvcjsKICAgIHZlcnNpb25CdXR0b24ub25LZXlVcCA9ICJAIGlmKHRoYXQua2V5cyA9PSAnU2hpZnQnKXtkZXN0cm95KHRoaXNCb3QpfTsiOwogICAgdmVyc2lvbkJ1dHRvbi5vbkNsaWNrID0gIkAgbGlua3MubWFuYWdlci5jaGFuZ2VPdm9WZXJzaW9uKCk7IjsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih2ZXJzaW9uQnV0dG9uKTsKfScA66SUhgGtqgcIaGF0Y2hPdm8CBADrpJSGAcr3B50VQC8vbG9naWMgZm9yIGhhdGNoaW5nIG9mIGFuIGFiCnNob3V0KCdvdm9NZW51UmVzZXQnKTsKCi8vZGF0YSBpbiByZWdhcmRzIHRvIHdoYXQgYWIgaXMgZ29pbmcgdG8gYmUgaGF0Y2hlZApjb25zdCBvdm8gPSB0aGF0OwoKLy9oYXRjaCBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGluaXRpYWxCb290ID0gb3ZvLnRhZ3MuaW5pdGlhbEJvb3Q7CmxldCB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiA/PyBvdm8udGFncy50YXJnZXRWZXJzaW9uOwoKaWYgKChjb25maWdCb3QudGFncy5hYlZlcnNpb24gfHwgY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb24pICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy5hYlZlcnNpb24gPz8gY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb247Cn0KCi8vdGFyZ2V0ZWQgdmVyc2lvbnMKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiIHx8ICFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkpCnsKICAgIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJmZWVkYmFjayIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmZlZWRiYWNrVmVyc2lvbjsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImN1cnJlbnQiKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICB9CiAgICBlbHNlIGlmICghaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnZlcnNpb24KICAgIH0KCiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gbnVsbDsKfQoKaWYgKGlzTmFOKHRhcmdldFZlcnNpb24pKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwp9CgpsZXQgdmVyc2lvbkFycmF5ID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3Rvcnk7CmxldCBmaWxlVVJMID0gdmVyc2lvbkFycmF5W3RhcmdldFZlcnNpb24gLSAxXTsKbGV0IGtleSA9IG92by50YWdzLmtleSA/IG92by50YWdzLmtleSA6IGNvbmZpZ0JvdC50YWdzLmtleTsKbGV0IGZpbGVHZXQ7CgovL2FjdHVhbCBmaWxlIHJldHJpZXZhbAp0cnkKewogICAgZmlsZUdldCA9IGF3YWl0IG9zLmdldEZpbGUoZmlsZVVSTCk7Cn0KY2F0Y2ggKGUpCnsKICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdubyBmaWxlIGZvdW5kJyk7CgogICAgcmV0dXJuOwp9CgovL2hhbmRsaW5nIGZvciBlbmNyeXB0ZWQgYWIgZmlsZQppZiAoY3J5cHRvLmlzRW5jcnlwdGVkKGZpbGVHZXQpKQp7CiAgICBpZiAoIWtleSkKICAgIHsKICAgICAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoJycsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnRW50ZXIga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIGZpbGVHZXQgPSBjcnlwdG8uZGVjcnlwdChrZXksIGZpbGVHZXQpOwoKICAgIGlmIChmaWxlR2V0ID09IG51bGwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCdpbmNvcnJlY3Qga2V5Jyk7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAKICAgIGZpbGVHZXQgPSBKU09OLnBhcnNlKGZpbGVHZXQpOwogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KZWxzZQp7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQoKLy9jbGVhbiB1cApkZXN0cm95KG92byk7CgovL3RvYXN0IGlmIG5vdCBvbiBzdGFibGUKaWYob3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiAhPSB0YXJnZXRWZXJzaW9uICYmICFjb25maWdCb3QudGFncy5hYlNpbGVudCkKewogICAgaWYgKG92by50YWdzLmZlZWRiYWNrVmVyc2lvbiA9PSB0YXJnZXRWZXJzaW9uKQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIGZlZWRiYWNrIHZlcnNpb24gb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG9zLnRvYXN0KCJsb2FkIHZlcnNpb24gIiArIHRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggKyAiIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KfQoKLy9nZW5lcmF0ZSBib3RzIGJhc2VkIG9uIHRoZSBmaWxlIHJldHJpZXZlZCAqSEVSRSoKY29uc3QgbmV3Qm90cyA9IGF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoewogICAgYm90czogZmlsZUdldCwKICAgIG9yaWdpbjogb3ZvLnRhZ3MuYWJJRCwKICAgIHN0dWRpbzogb3ZvLnRhZ3Muc3R1ZGlvLAogICAgdmVyc2lvbjogdGFyZ2V0VmVyc2lvbiwKICAgIGluaXRpYWxCb290OiBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnM6IG92by50YWdzLmVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGU6IG92by52YXJzLm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50OiBvdm8udGFncy5zb3VyY2VFdmVudCwKfSk7CgpyZXR1cm4gbmV3Qm90czsnAOuklIYBraoHC2ludGVyYWN0T3ZvAgQA66SUhgHojAjpBkAvL21hbnVhbCBoYXRjaCBtZW51CmNvbnN0IG92b0JvdCA9IHRoYXQgPyB0aGF0IDogbGlua3Mub3ZvQm90OwoKaWYgKCFvdm9Cb3QpIHsKICAgIHJldHVybjsKfQoKc2hvdXQoIm92b01lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJPdm9NZW51IjsKCm1hc2tzLm9uR3JpZENsaWNrID0gYEAKICAgIHNob3V0KCJvdm9NZW51UmVzZXQiKTsKYDsKbWFza3Mub3ZvTWVudVJlc2V0ID0gYEAKICAgIG1hc2tzLm9uR3JpZENsaWNrID0gbnVsbDsKICAgIG1hc2tzLm92b01lbnVSZXNldCA9IG51bGw7CgogICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwpgOwoKb3MudHdlZW5Ubyhvdm9Cb3QsIDE1LDQ1LDQ1LCA1KTsKCmNvbnN0IGVnZ01lbnVCdXR0b24gPSB7CiAgICBhYk92b01lbnU6IHRydWUsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb3ZvQm90OiBnZXRMaW5rKG92b0JvdCksCiAgICBjb2xvcjogYWJQZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgdGFyZ2V0VmVyc2lvbjogb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwKICAgIGxhYmVsOiBgaGF0Y2ggJHtvdm9Cb3QudGFncy5hYklEfSB2JHtvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9ufSBvZiAke292b0JvdC50YWdzLm1heFZlcnNpb259YCwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIG92b01lbnVSZXNldDogYEAKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgYCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOwogICAgYCwKfTsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGVnZ01lbnVCdXR0b24pOycA66SUhgGtqgcGY3JlYXRlAgQA66SUhgHSkwgo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycA66SUhgGtqgcQY2hhbmdlT3ZvVmVyc2lvbgIEAOuklIYB+ZMI8AJALy9sb2dpYyBmb3IgdmVyc2lvbiBjaGFuZ2luZyB3aGVuIG1hbnVhbGx5IGhhdGNoaW5nIGFuIGFiCmNvbnN0IG92b0JvdCA9IGxpbmtzLm92b0JvdDsKCmxldCBuZXdWZXJzaW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sIHsKICAgIHBsYWNlaG9sZGVyOiAiZW50ZXIgYSB2ZXJzaW9uIGZyb20gMSB0byAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbgp9KTsKCm92b0JvdC50YWdzLnRhcmdldFZlcnNpb24gPSBuZXdWZXJzaW9uOwpvdm9Cb3QudGFncy5sYWJlbCA9ICd2JysgbmV3VmVyc2lvbjsKCmNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBuZXdWZXJzaW9uOwoKc2hvdXQoIm92b01lbnVSZXNldCIpOycA66SUhgGtqgcEbWVudQIEAOuklIYB6pYIKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAOuklIYBraoHCGFiSWdub3JlAgQA66SUhgGRlwgEdHJ1ZScA66SUhgGtqgcHYWJTaGVsbAIEAOuklIYBlpcIBHRydWUnAOuklIYBraoHDGFiMUxUTVNlYXJjaAIEAOuklIYBm5cIM0AvL3N1cHBvcnQgb2xkIHN5bnRheAp0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOycA66SUhgGtqgcNb25Mb29rdXBBc2tJRAIEAOuklIYBz5cImB5AY29uc3QgYXNrSUQgPSB0aGF0Py5hc2tJRDsKY29uc3Qgc2hvd0luZGljYXRvciA9IHRoYXQ/LnNob3dJbmRpY2F0b3IgPz8gdHJ1ZTsKY29uc3QgY2hhbm5lbENvbmZpZyA9IHRoYXQ/LmNoYW5uZWxDb25maWc7CmNvbnN0IGF1dG9IYXRjaCA9IHRoYXQ/LmF1dG9IYXRjaCA/PyB0cnVlOwpjb25zdCBlZ2dQYXJhbWV0ZXJzID0gdGhhdD8uZWdnUGFyYW1ldGVyczsKY29uc3Qgc291cmNlRXZlbnQgPSB0aGF0Py5zb3VyY2VFdmVudDsKY29uc3Qgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gdGhhdD8ub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwoKYXNzZXJ0KHR5cGVvZiBhc2tJRCA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXNrSUQgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwoKbGV0IGxvb2t1cEFzazogQUJMb29rdXBBc2tJRFJlc3VsdDsKbGV0IGJ1c3lJbmRpY2F0b3I7CgppZiAoc2hvd0luZGljYXRvcikgewogICAgaWYgKCFsaW5rcy5tZW51KSB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdCgnYWJJbnRlcmZhY2UnKTsKICAgIH0KCiAgICBidXN5SW5kaWNhdG9yID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXN5SW5kaWNhdG9yKHsgYWJNZW51OiB0cnVlLCBsYWJlbDogYGxvb2tpbmcgdXAgJHthc2tJRH1gIH0pOwp9CgovLyBGaXJzdCBjaGVjayB0aGUgY2FzdWFsIGNhdGFsb2cgZm9yIHRoZSBhc2suCmNvbnN0IGNhc3VhbENhdGFsb2dVUkwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2Fza3MvJHthc2tJRH0uYXV4YCk7Cgp0cnkgewogICAgY29uc3QgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soeyBtZXRob2Q6ICdHRVQnLCB1cmw6IGNhc3VhbENhdGFsb2dVUkwgfSk7CgogICAgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgIGlmIChjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS52ZXJzaW9uID09PSAxICYmIGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnN0YXRlKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjEgYXV4IGZpbGUuCiAgICAgICAgICAgIGNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHsgYm90czogY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEuc3RhdGUsIGlnbm9yZUdyaWRGb2N1czogdHJ1ZSwgb3JpZ2luOiBhc2tJRCwgZWdnUGFyYW1ldGVycywgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCBzb3VyY2VFdmVudCB9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsCiAgICAgICAgICAgICAgICBvcmlnaW46ICdjYXN1YWxfY2F0YWxvZycsCiAgICAgICAgICAgICAgICBoYXRjaGVkQm90czogbmV3Qm90cywKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMiAmJiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS51cGRhdGVzKSB7CiAgICAgICAgICAgIC8vIENhc3VhbCBjYXRhbG9nIHJlc3BvbnNlIGlzIGEgdjIgYXV4IGZpbGUuCiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXNrcyBvbmx5IHN1cHBvcnQgdjEgYXV4IGZpbGUgZm9ybWF0LmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgcmVzcG9uc2UuCiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVbnJlY29nbml6ZWQgY2FzdWFsIGNhdGFsb2cgYXNrIHJlc3BvbnNlLmAsIGNhc3VhbENhdGFsb2dSZXNwb25zZSk7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS4gQ2hlY2sgY29uc29sZSBmb3IgbW9yZSBkZXRhaWxzLmAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKCiAgICAgICAgICAgIGxvb2t1cEFzayA9IHsKICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBsb29rdXBBc2s7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIC8vIERpZCBub3QgZmluZCBpbiB0aGUgY2FzdWFsIGNhdGFsb2cuCn0KCi8vIENoZWNrIHRoZSBhYiByZWNvcmQgZm9yIHRoZSBhc2suCmNvbnN0IGFiRm9ybWF0dGVkQXNrSUQgPSBhc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwoKdHJ5IHsKICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYGFza18ke2FiRm9ybWF0dGVkQXNrSUR9YCwgbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50KTsKfSBjYXRjaCB7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiRm9ybWF0dGVkQXNrSUQsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludCk7Cn0KCmxvb2t1cEFzay5vcmlnaW4gPSAnYWJfcmVjb3JkJzsKCmlmIChjaGFubmVsQ29uZmlnKSB7CiAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICB9CgogICAgcmV0dXJuIGxvb2t1cEFzazsKfSBlbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiBsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQpIHsKICAgIGlmIChsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA9PSAiQUIiKSB7CiAgICAgICAgLy8gUnlhbiBDb29rOiBUaGlzIGFwcGVhcnMgdG8gYmUgc29tZXRoaW5nIG5lZWRlZCBieSBhYkNoYW5uZWxzLgogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQobG9va3VwQXNrLmRhdGEucGF0dGVybklEKTsKCiAgICAgICAgc2hvdXQoIm9uQUJJbml0aWFsaXplZCIpOwogICAgfSBlbHNlIHsKICAgICAgICAvLyBMb29rdXAgdGhlIGVnZyB1c2luZyB0aGUgc3R1ZGlvSUQgYW5kIHBhdHRlcm5JRCBmcm9tIHRoZSBhYl9yZWNvcmQgYXNrLgogICAgICAgIGNvbnN0IGxvb2t1cEVnZzogQUJMb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHsgYWJJRDogbG9va3VwQXNrLmRhdGEucGF0dGVybklELCByZWNvcmRLZXk6IGxvb2t1cEFzay5kYXRhLnN0dWRpb0lELCBhdXRvSGF0Y2gsIGVnZ1BhcmFtZXRlcnMsIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgc291cmNlRXZlbnQgfSk7CiAgICAgICAgCiAgICAgICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBsb29rdXBFZ2cuc3VjY2VzczsKICAgICAgICBsb29rdXBBc2suaGF0Y2hlZEJvdHMgPSBsb29rdXBFZ2cuaGF0Y2hlZEJvdHM7CiAgICB9Cn0gZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgIWxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCAmJiAhbG9va3VwQXNrLmRhdGEudXJsKSB7CiAgICBsb29rdXBBc2suc3VjY2VzcyA9IGZhbHNlOwp9CgppZiAoYnVzeUluZGljYXRvcikgewogICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKfQoKcmV0dXJuIGxvb2t1cEFzazsnAOuklIYBraoHBXR5cGVzAgQA66SUhgHotQj2AfCfk4R0eXBlIEFCQXNrSURPcmlnaW4gPSAnY2FzdWFsX2NhdGFsb2cnIHwgJ2FiX3JlY29yZCc7CgppbnRlcmZhY2UgQUJMb29rdXBBc2tJRFJlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuOwogICAgb3JpZ2luOiBBQkFza0lET3JpZ2luOwogICAgaGF0Y2hlZEJvdHM/OiBCb3RbXTsKfQoKaW50ZXJmYWNlIEFCTG9va3VwRWdnUmVzdWx0IHsKICAgIHN1Y2Nlc3M6IGJvb2xlYW4sCiAgICBoYXRjaGVkQm90cz86IEJvdFtdLAp9CicA66SUhgGtqgcFaW5wdXQCBADrpJSGAd23CCjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDrpJSGAa2qBwVoYXRjaAIEAOuklIYBhLgIwAFALy9zaG91dCgiaGF0Y2giLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGtleToga2V5LCBhdXRvSGF0Y2g6IGJvb2xlYW4sIHJldHVyblR5cGU6IGRhdGEvbnVsbCwgZWdnUGFyYW1ldGVyczogYXJnfSk7Cgpjb25zdCBsb29rVXAgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOwoKcmV0dXJuIGxvb2tVcDsnAOuklIYBraoHCWFiVmVyc2lvbgIEAOuklIYBxbkIBDEwLjUnAOuklIYBraoHBWxlYXJuAgQA66SUhgHKuQgo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA66SUhgGtqgcFdXRpbHMCBADrpJSGAfG5CCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDrpJSGAa2qBwtwZXJzb25hbGl0eQIEAOuklIYBmLoIKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJGY4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMAEnAOuklIYBv7oIBnN5c3RlbQIEAOuklIYBwLoIDmFiLnNoZWxsLmlucHV0JwDrpJSGAb+6CARmb3JtAgQA66SUhgHPuggHbm90aGluZycA66SUhgG/uggJb25LZXlEb3duAgQA66SUhgHXugj6CkBjb25zdCB7IGtleXMgfSA9IHRoYXQ7CgppZiAobWFza3MuY2hhdE9wZW4pIHsKICAgIGNvbnN0IGVzYyA9IHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJyk7CgogICAgaWYgKGVzYykgewogICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgYXJyb3dVcCA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dVcCcpOwogICAgICAgIGNvbnN0IGFycm93RG93biA9IHRoYXQua2V5cy5pbmNsdWRlcygnQXJyb3dEb3duJyk7CiAgICAgICAgCiAgICAgICAgaWYgKGFycm93VXAgfHwgYXJyb3dEb3duKSB7CiAgICAgICAgICAgIC8vIElmIEFycm93VXAgb3IgQXJyb3dEb3duIGFyZSBwcmVzc2VkIHdoaWxlIHRoZSBhYiBjaGF0IGJhciBpcyBvcGVuIHRoZW4KICAgICAgICAgICAgLy8gc3RhcnQgY29tYmluZyB0aHJvdWdoIGNoYXQgaGlzdG9yeS4KICAgICAgICAgICAgY29uc3QgZGlyID0gYXJyb3dVcCA/IC0xIDogMTsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ICsgZGlyOwogICAgICAgICAgICBsZXQgaGlzdG9yaWNhbFRleHQgPSBudWxsOwoKICAgICAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBoaXN0b3JpY2FsVGV4dCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeVtpbmRleF07CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gaW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggPj0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFVwZGF0ZSB0aGUgY2hhdCBiYXIuCiAgICAgICAgICAgIGF3YWl0IHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKHsgcHJlZmlsbDogaGlzdG9yaWNhbFRleHQgfSk7CiAgICAgICAgfQogICAgfQp9IGVsc2UgewogICAgY29uc3QgYmFja3RpY2sgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ2AnKSB8fCB0aGF0LmtleXMuaW5jbHVkZXMoIkRlYWQiKTsKCiAgICBpZiAoYmFja3RpY2spIHsKICAgICAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgIH0KfQonAOuklIYBv7oIBm9uQ2hhdAIEAOuklIYB0sUIihhALy8gTm90IHN1cHBvcnRlZCBvdXRzaWRlIG9mIGJ1aWxkZXIgdmVyc2lvbgppZiAoIWJ1aWxkZXJWZXJzaW9uKSB7CiAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICByZXR1cm47Cn0KCmlmICghdGhhdC5tZXNzYWdlKSB7CiAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICByZXR1cm47Cn0KCi8vIEFwcGVuZCBtZXNzYWdlIHRvIGNoYXQgaGlzdG9yeSBhbmQgdXBkYXRlIHRoZSBjdXJyZW50IGhpc3RvcnkgaW5kZXguCnRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5wdXNoKHRoYXQubWVzc2FnZSk7CnRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwoKLy8gRnVuY3Rpb24gdG8gcGFyc2UgYXJndW1lbnRzIHdpdGggcXVvdGUgc3VwcG9ydCBhbmQgZXJyb3IgaGFuZGxpbmcKLy8gRXhhbXBsZXM6IAovLyAgICdhcmcxIGFyZzInIC0+IFsnYXJnMScsICdhcmcyJ10KLy8gICAnImFyZyB3aXRoIHNwYWNlcyIgYXJnMicgLT4gWydhcmcgd2l0aCBzcGFjZXMnLCAnYXJnMiddCi8vICAgJyJ1bmNsb3NlZCBxdW90ZScgLT4gdGhyb3dzIEVycm9yCmZ1bmN0aW9uIHBhcnNlQXJndW1lbnRzKGlucHV0KSB7CiAgICBjb25zdCBhcmdzID0gW107CiAgICBsZXQgY3VycmVudEFyZyA9ICcnOwogICAgbGV0IGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICBsZXQgcXVvdGVTdGFydFBvcyA9IC0xOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgY2hhciA9IGlucHV0W2ldOwogICAgICAgIAogICAgICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgaWYgKGNoYXIgPT09IGluc2lkZVF1b3RlcykgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gbnVsbDsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjaGFyID09PSAnXFwnICYmIGkgKyAxIDwgaW5wdXQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpKys7IC8vIFNraXAgdGhlIGJhY2tzbGFzaAogICAgICAgICAgICAgICAgY3VycmVudEFyZyArPSBpbnB1dFtpXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gY2hhcjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSAnIicgfHwgY2hhciA9PT0gIiciKSB7CiAgICAgICAgICAgICAgICBpbnNpZGVRdW90ZXMgPSBjaGFyOwogICAgICAgICAgICAgICAgcXVvdGVTdGFydFBvcyA9IGk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJyAnKSB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEFyZy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKGN1cnJlbnRBcmcpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgPSAnJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gY2hhcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgaWYgKGluc2lkZVF1b3RlcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5jbG9zZWQgcXVvdGU6IGZvdW5kIG9wZW5pbmcgJHtpbnNpZGVRdW90ZXN9IGF0IHBvc2l0aW9uICR7cXVvdGVTdGFydFBvc30gYnV0IG5vIGNsb3NpbmcgcXVvdGVgKTsKICAgIH0KICAgIAogICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgIH0KICAgIAogICAgcmV0dXJuIGFyZ3M7Cn0KCmlmICh0aGF0Lm1lc3NhZ2VbMF0gPT0gIi4iKSB7CiAgICBjb25zdCBjb21tYW5kUGFydCA9IHRoYXQubWVzc2FnZS5zdWJzdHJpbmcoMSk7IC8vIFJlbW92ZSB0aGUgZG90CiAgICBjb25zdCBzcGFjZUluZGV4ID0gY29tbWFuZFBhcnQuaW5kZXhPZignICcpOwogICAgCiAgICBsZXQgY21kLCBhcmdzOwogICAgaWYgKHNwYWNlSW5kZXggPT09IC0xKSB7CiAgICAgICAgLy8gTm8gYXJndW1lbnRzCiAgICAgICAgY21kID0gY29tbWFuZFBhcnQ7CiAgICAgICAgYXJncyA9IHVuZGVmaW5lZDsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSGFzIGFyZ3VtZW50cwogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0LnN1YnN0cmluZygwLCBzcGFjZUluZGV4KTsKICAgICAgICBjb25zdCBhcmdzU3RyaW5nID0gY29tbWFuZFBhcnQuc3Vic3RyaW5nKHNwYWNlSW5kZXggKyAxKTsKICAgICAgICAKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VBcmd1bWVudHMoYXJnc1N0cmluZyk7CiAgICAgICAgICAgIGFyZ3MgPSBwYXJzZWRBcmdzLmxlbmd0aCA/IHBhcnNlZEFyZ3MgOiB1bmRlZmluZWQ7CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBFcnJvciBwYXJzaW5nIGNvbW1hbmQgYXJndW1lbnRzOiAke2Vycm9yLm1lc3NhZ2V9YCwgbG9nVHlwZTogJ0Vycm9yJyB9KTsKICAgICAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgfQoKICAgIC8vIENyZWF0ZSBhIGZyZXNoIENvbW1hbmRzTWFuYWdlciB3aXRoIGVhY2ggY2FsbCBzbyB0aGF0IHdlIGFsd2F5cyBoYXZlIHRoZSBsYXRlc3QgY29tbWFuZHMgYW5kIGZ1bmN0aW9uYWxpdHkuCiAgICBjb25zdCBhYkNvbW1hbmRzID0gbmV3IEFCQ29tbWFuZHNNYW5hZ2VyKCk7CgogICAgaWYgKGFiQ29tbWFuZHMgJiYgYWJDb21tYW5kcy5oYXNDb21tYW5kKGNtZCkpIHsKICAgICAgICAvLyBDYWxsIGNvbW1hbmQgd2l0aCBhcmdzLgogICAgICAgIGFiQ29tbWFuZHMuY2FsbENvbW1hbmQoY21kLCBhcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRXZhbHVhdGUgY29tbWFuZCBhcyBqYXZhc2NyaXB0LgogICAgICAgIGNvbnN0IGpzID0gdGhhdC5tZXNzYWdlLnN1YnN0cmluZygxKTsKICAgICAgICBvcy5ydW4oanMpOwogICAgfQp9Cgp0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7JwDrpJSGAb+6CAtkZXNjcmlwdGlvbgIEAOuklIYB3d0IQlRoaXMgaXMgbWVhbnQgdG8gaGFuZGxlIGFueSBub25lIG1lbnUgcmVsYXRlZCBpbnB1dHMvaW50ZXJhY3Rpb25zLicA66SUhgG/uggMb25GaWxlVXBsb2FkAgQA66SUhgGg3gjfGUAvL2ZpbHRlciBvdXQgdGltZXMgd2hlbiBmaWxlIGxvYWRpbmcgaXMgbm90IGFsbG93ZWQKaWYgKCFidWlsZGVyVmVyc2lvbiB8fCBsaW5rcy5yZW1lbWJlci50YWdzLmFiTGlzdGVuaW5nRm9yRmlsZVVwbG9hZHMgIT09IHRydWUpCnsKICAgIHJldHVybjsKfQoKLy92YXJpb3VzIGZpbGUgc3BlY2lmaWMgdmFyaWFibGVzCmxldCBmaWxlRXh0ZW5zaW9uID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKS50b0xvd2VyQ2FzZSgpOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CmxldCBzaXplID0gdGhhdC5maWxlLnNpemU7CmxldCBtaW1lVHlwZTsKbGV0IGJvdEluZm8gPSB7fTsKCi8vaGFyZCBsaW1pdCBiYXNlZCBvbiBmaWxlIHNpemUKaWYgKHNpemUgPiAyMDAwMDAwMDApCnsKICBvcy50b2FzdCgibWF4aW11bSBmaWxlIHNpemUgZXhjZWVkZWQgKDIwMCBtYikiKTsKCiAgcmV0dXJuOwp9CgovL3RoaXMgc3dpdGNoIGhhbmRsZXMgcG9zc2libGUgZmlsZXMgZXh0ZW5zaW9ucywgd2hpbGUgcmVqZWN0aW5nIGFueSBpdCBkb2VzIG5vdCByZWNvZ25pemUKc3dpdGNoKGZpbGVFeHRlbnNpb24pCnsKICBjYXNlICdqcGcnOgogIGNhc2UgJ2pwZWcnOgogIGNhc2UgJ3dlYnAnOgogIGNhc2UgJ2dpZic6CiAgY2FzZSAncG5nJzoKICAgIG1pbWVUeXBlID0gImltYWdlLyIgKyBmaWxlRXh0ZW5zaW9uOwogICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICBicmVhazsKICBjYXNlICdzdmcnOgogICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgIGJyZWFrOwogIGNhc2UgJ2dsYic6CiAgY2FzZSAnZXhyJzoKICBjYXNlICdnbHRmJzoKICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgIGJvdEluZm8uZm9ybSA9ICJtZXNoIjsKICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAiZ2x0ZiI7CiAgICBicmVhazsKICBjYXNlICdhdXgnOgogIGNhc2UgJ3BkZic6CiAgICBsZXQgYm90RGF0YSA9IGZpbGVFeHRlbnNpb24gPT0gIi5hdXgiID8gSlNPTi5wYXJzZSh0aGF0LmZpbGUuZGF0YSkuc3RhdGUgOiBvcy5wYXJzZUJvdHNGcm9tRGF0YSh0aGF0LmZpbGUuZGF0YSk7CgogICAgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7Ym90czogYm90RGF0YSwgb3JpZ2luOiBmaWxlTmFtZSwgc291cmNlRXZlbnQ6ICdmaWxlX3VwbG9hZCd9KTsKCiAgICByZXR1cm47Ci8vICAgY2FzZSAncGRmJzoKLy8gICAgIGJyZWFrOwogIGNhc2UgJ21wMyc6CiAgICBtaW1lVHlwZSA9ICdhdWRpby9tcGVnJzsKICAgIGJvdEluZm8ub25DbGljayA9ICJAIG9zLnBsYXlTb3VuZCh0YWdzLmZvcm1BZGRyZXNzKTsiOwogICAgYm90SW5mby5sYWJlbCA9ICJDbGljayB0byBQbGF5IjsKICAgIGJyZWFrOwogIGNhc2UgJ21wNCc6CiAgICBtaW1lVHlwZSA9ICd2aWRlby9tcDQnOwogICAgYm90SW5mby5mb3JtID0gImlmcmFtZSI7CiAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gInNyYyI7CiAgICBicmVhazsKICBjYXNlICdvdGYnOgogICAgbWltZVR5cGUgPSAnZm9udC9vdGYnOwogICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgIGJyZWFrOwogIGNhc2UgJ3dvZmYnOgogICAgbWltZVR5cGUgPSAnZm9udC93b2ZmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBkZWZhdWx0OgogICAgbGV0IHJlc3VsdCA9IG5ldyBFcnJvcigidW5oYW5kbGVkIGZpbGUgdHlwZTogIiArIGZpbGVFeHRlbnNpb24pOwogICAgb3MudG9hc3QoImZpbGUgdHlwZSBub3Qgc3VwcG9ydGVkIik7CiAgICBjb25zb2xlLndhcm4ocmVzdWx0KQogICAgcmV0dXJuIHJlc3VsdDsKfQoKLy90aGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhbmQgb2JqZWN0cyBzZXQgdXAgYSBsb2FkaW5nIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmxldCB1cGxvYWRSZXN1bHQ7CgppZiAoIWxpbmtzLm1lbnUpIHsKICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGB1cGxvYWRpbmdgfSk7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpb0lEID8/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsKCmlmICghY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpCnsKICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cn0KCi8vdGhpcyBpcyB0aGUgYWN0dWFsIHVwbG9hZCBmdW5jdGlvbmFsaXR5CnVwbG9hZFJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEZpbGUoe2ZpbGU6IHRoYXQuZmlsZS5kYXRhLCBmaWxlTmFtZTogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwoKLy9pZiB0aGUgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgYXMgYSBib3Qgd2l0aCBhIGxpbmssIHRoaXMgbG9naWMgaGFuZGxlcyB0aGF0CgppZiAobWltZVR5cGUuaW5jbHVkZXMoImZvbnQiKSkKewogICAgYm90SW5mb1tjb25maWdCb3QudGFncy5ncmlkUG9ydGFsXSA9IHRydWU7CiAgICBib3RJbmZvLmxhYmVsRm9udEFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9CmVsc2UgaWYgKE9iamVjdC5rZXlzKGJvdEluZm8pLmxlbmd0aCA+IDApCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5mb3JtQWRkcmVzcyA9IHVwbG9hZFJlc3VsdC51cmwgPyB1cGxvYWRSZXN1bHQudXJsIDogdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICBjcmVhdGUoYm90SW5mbyk7Cn0KCmNvbnN0IGNsaXBVUkwgPSB1cGxvYWRSZXN1bHQudXJsID8/IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7Cgpvcy5zZXRDbGlwYm9hcmQoY2xpcFVSTCk7Cgpvcy50b2FzdCgiZmlsZSB1cmwgYWRkZWQgc2V0IHRvIGNsaXBib2FyZCIpOwoKLy9jbGVhciB0aGUgcHJvZ3Jlc3MgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHVwbG9hZFJlc3VsdDsnAOuklIYBv7oIBWxlYXJuAgQA66SUhgGA+Ago8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycA66SUhgG/uggIcmVtZW1iZXICBADrpJSGAaf4CCjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDrpJSGAb+6CA1tYW5pZmVzdGF0aW9uAgQA66SUhgHO+Ago8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcA66SUhgG/uggIYWJJZ25vcmUCBADrpJSGAfX4CAR0cnVlJwDrpJSGAb+6CAZjcmVhdGUCBADrpJSGAfr4CCjwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwDrpJSGAb+6CAVzdG9yZQIEAOuklIYBofkIKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAOuklIYBv7oIBG1lbnUCBADrpJSGAcj5CCjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDrpJSGAb+6CAdhYlNoZWxsAgQA66SUhgHv+QgEdHJ1ZScA66SUhgG/uggJb25UYXBDb2RlAgQA66SUhgH0+QipAkBjb25zdCB0YXBDb2RlID0gdGhhdDsKCnN3aXRjaCAodGFwQ29kZSkKewogICAgY2FzZSAiMzM0MiI6CiAgICAgICAgb3MudG9hc3QoIndha2luZyAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSk7CgogICAgICAgIHRoaXNCb3Qub25DaGF0KHttZXNzYWdlOiAiLi4ifSk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICI0MjQyIjoKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgLy9jb25zb2xlLmxvZyh0YXBDb2RlKTsKfScA66SUhgG/uggDYXNrAgQA66SUhgGe/Ago8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycA66SUhgG/uggJYWJWZXJzaW9uAgQA66SUhgHF/AgEMTAuNScA66SUhgG/uggKb25Cb3RBZGRlZAIEAOuklIYByvwIQEB0aGlzQm90LmxvYWRBQkNvbW1hbmRzTWFuYWdlcigpOwp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkgPSBbXTsnAOuklIYBv7oIGm9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkAgQA66SUhgGL/QjFREBsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKLy8gVGhlc2UgYXJlIGFsbCB0aGUgYnVpbHQtaW4gY29tbWFuZHMuCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2hlbHAnLCAoYXJncykgPT4gewogICAgY29uc3QgY29tbWFuZHMgPSBhYkNvbW1hbmRzLmNvbW1hbmRzOwogICAgY29uc3QgY29tbWFuZEtleXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcyk7CgogICAgbGV0IHNlbGVjdGVkQ29tbWFuZDsKICAgIGlmIChjb21tYW5kS2V5cyAmJiBjb21tYW5kS2V5cy5sZW5ndGggJiYgYXJncyAmJiBhcmdzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGNvbW1hbmRLZXlNYXRjaCA9IGNvbW1hbmRLZXlzLmZpbmQoa2V5ID0+IGtleSA9PT0gYXJnc1swXSk7CiAgICAgICAgc2VsZWN0ZWRDb21tYW5kID0gY29tbWFuZEtleU1hdGNoOwogICAgfQogICAgCiAgICBsaW5rcy5oZWxwLm1vdW50KHsgYWJDb21tYW5kc01hbmFnZXI6IGFiQ29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgdGhpcyBoZWxwIHdpbmRvdy4gQ2FuIHNwZWNpZnkgYSBjb21tYW5kIHRvIG9wZW4gdGhlIGhlbHAgcGFnZSBmb3IgdGhhdCBjb21tYW5kIGRpcmVjdGx5LicsCiAgICB1c2FnZTogWycuaGVscCcsICcuaGVscCBbY29tbWFuZF0nXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnLicsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy4uJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnd2FrZScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy53YWtlJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2xlZXAnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJTbGVlcChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1B1dCBhYiB0byBzbGVlcC4nLAogICAgdXNhZ2U6ICcuc2xlZXAnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhc2snLCAoYXJncykgPT4gewogICAgaWYgKGxpbmtzLmFzaykgewogICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBhc2tJbnB1dCA9IGFyZ3Muam9pbignICcpOwogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLmFzayBjb21tYW5kIHJlcXVpcmVzIGlucHV0YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhc2sgYm90IGlzIG5vdCBsb2FkZWQsIGNhbm5vdCBsb2FkIGFza2ApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQXNrIGFiJywKICAgIHVzYWdlOiAnLmFzayA8YXNrX25hbWU+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbmFtZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSwgeyB0aXRsZTogJ3doYXQgd291bGQgeW91IGxpa2UgdG8gY2FsbCBtZT8nIH0pOwogICAgc2V0VGFnTWFzayhsaW5rcy5wZXJzb25hbGl0eSwgJ2FiQnVpbGRlcklkZW50aXR5JywgbmFtZSwgJ2xvY2FsJyk7CiAgICBzaG91dCgnY2hhbmdlUGVyc29uYWxpdHlDb25maWcnLCB7IG5hbWU6IG5hbWUgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHaXZlIGFiIGEgbmV3IG5hbWUuJywKICAgIHVzYWdlOiAnLm5hbWVhYicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3N5c3RlbScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTeXN0ZW0oYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIChJREUpIGZvciB0aGUgaW5zdC4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGkgICAgCgogICAgWW91IG1heSBwcm92aWRlIGEgY3VzdG9tIHN5c3RlbVRhZ05hbWUgd2l0aCB0aGUgY29tbWFuZCwgaW4gb3JkZXIgdG8gb3BlbiB0aGUgc3lzdGVtIHBvcnRhbCBvbmx5IGZvciBib3RzIHdpdGggdGhlIGdpdmVuIHN5c3RlbVRhZ05hbWUuIEJ5IGRlZmF1bHQsICJzeXN0ZW0iIHdpbGwgYmUgdXNlZCBhcyB0aGUgc3lzdGVtVGFnTmFtZS4KCiAgICBGb3IgZXhhbXBsZToKCiAgICA+IC5zeXN0ZW0KICAgIFRoaXMgd2lsbCBzaG93IGFsbCBib3RzIGluIHRoZSBzeXN0ZW1Qb3J0YWwgdGhhdCBoYXZlIGEgInN5c3RlbSIgdGFnLgoKICAgID4gLnN5c3RlbSBteUdyb3VwCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJteUdyb3VwIiB0YWcuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnN5c3RlbScsCiAgICAgICAgJy5zeXN0ZW0gc3lzdGVtVGFnTmFtZScKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXcnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LiBCeSBkZWZhdWx0IHRoZSBzeXN0ZW0gcG9ydGFsIHdpbGwgb3BlbiBpbiBhIG5ldyB0YWIuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZycsIChhcmdzKSA9PiB7CiAgICBsaW5rcy5jb25zb2xlLnRvZ2dsZUNvbnNvbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1RvZ2dsZSB2aXNpYmxpdHkgb2YgdGhlIGFiIGxvZy4nLAogICAgdXNhZ2U6ICcubG9nJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2djbGVhcicsIChhcmdzKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlTG9nQm90cyA9IGdldEJvdHMoImNvbnNvbGVMb2dNZXNzYWdlQm90IiwgdHJ1ZSk7CiAgICBkZXN0cm95KG1lc3NhZ2VMb2dCb3RzKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0NsZWFyIGFsbCBhYiBsb2cgbWVzc2FnZXMuJywKICAgIHVzYWdlOiAnLmxvZ2NsZWFyJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzaGVldCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTaGVldChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3Igc3BlY2lmaWVkIGJvdCBvciBhbiBlbnRpcmUgZGltZW5zaW9uLicsCiAgICB1c2FnZTogWwogICAgICAgICcuc2hlZXQgW29wdGlvbnNdIFtwb3J0YWwgfCBoZWxwZXJCb3ROYW1lIHwgYm90SWQgfCBnbG9iYWxUaGlzUGF0aF0nLAogICAgICAgICdleC4gLnNoZWV0IGhvbWUnLAogICAgICAgICdleC4gLnNoZWV0IGNvbmZpZ0JvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgLXQgYTJjZjQ3MzktMzlhMi00ZmQ2LWIzZWYtY2M0NzgyZjk3MDg5JywKICAgICAgICAnZXguIC5zaGVldCBnbG9iYWxUaGlzLm15T2JqZWN0Lm15Qm90JywKICAgICAgICAnZXguIC5zaGVldCBteU9iamVjdC5teUJvdCcKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBpbiBhIG5ldyBicm93c2VyIHRhYi4gXG5cbk5PVEU6IC5zaGVldCB3aWxsIGF1dG9tYXRpY2FsbHkgaW5zcGVjdCB0aGUgc3BhY2Ugb2YgYSBib3QgYW5kIGZvcmNlIG9wZW5pbmcgaW4gdGhlIHNhbWUgdGFiIGlmIGEgYm90IGlzIGluIHRlbXBMb2NhbCBvciB0ZW1wU2hhcmVkIHNwYWNlLicsCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbWVudXNoZWV0JywgKGFyZ3MpID0+IHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKICAgIGlmICghY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2Fubm90IG9wZW4gc2hlZXRQb3J0YWwgZm9yIG1lbnVQb3J0YWwgYm90cy4gVGhlIG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IGRpc2FibGVkLmB9KQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciB0aGUgY3VycmVudCBtZW51IHBvcnRhbC4nLAogICAgdXNhZ2U6ICcubWVudVNoZWV0JywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkaW5zdCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEluc3QoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCB0aGUgaW5zdCB0byBkaXNrLicsCiAgICB1c2FnZTogJy5kb3dubG9hZGluc3QnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGFiJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkQUIoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBzcGVjaWZpZWQgYWIgZ3JvdXAocykgdG8gZGlzay4nLAogICAgbG9uZ0Rlc2NyaXB0aW9uOiBgRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suCgogICAgWW91IGNhbiBwcm92aWRlIGEgbGlzdCBvZiBncm91cHMgdG8gZG93bmxvYWQgYWxvbmcgd2l0aCB0aGUgY29tbWFuZDoKICAgID4gLmRvd25sb2FkYWIgYWJDb3JlIGFiU2hlbGwgYWJJbnRlcmZhY2UKCiAgICBJZiBncm91cChzKSBhcmUgbm90IHByb3ZpZGVkIHdpdGggdGhlIGNvbWFtYW5kIHRoZW4geW91IHdpbGwgYmUgcHJvbXB0ZWQgdG8gcHJvdmlkZSBvbmUgd2l0aCBhIGRpYWxvZy4KICAgIGAsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRhYiBbb3B0aW9uc10gW2dyb3VwLi4uXScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiBhYlNoZWxsIGFiSW50ZXJmYWNlJywKICAgICAgICAnZXguIC5kb3dubG9hZGFiIC12IDEgbXlHcm91cE5hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy12JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdTcGVjaWZ5IHRoZSBhdXggZm9ybWF0IHZlcnNpb24gbnVtYmVyLiBleC4gLXYgMSB3aWxsIGJlIGF1eCBmb3JtYXQgdmVyc2lvbiAxIChwdXJlIGJvdCBqc29uKS4gQnkgZGVmYXVsdCwgYWIgZmlsZXMgYXJlIHVzdWFsbHkgZG93bmxvYWRlZCBhcyB2ZXJzaW9uIDIgYXV4IGZpbGVzIChjb25mbGljdC1mcmVlIHVwZGF0ZSkuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkZWdnJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkRWdnKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLiBZb3Ugd2lsbCBuZWVkIHRvIHByb3ZpZGUgdGhlIHJlY29yZEtleSBhcyB3ZWxsIGFuZCB0aGUgbmFtZSBvZiB0aGUgZWdnLiBBIGRyb3Bkb3duIHNlbGVjdGlvbiB3aWxsIGJlIHByb3ZpZGVkIGZvciB0aGUgZWdnIGlmIGZvdW5kIHRvIHNlbGVjdCB3aGljaCB2ZXJzaW9uIHRvIGRvd25sb2FkLmAsCiAgICB1c2FnZTogJy5kb3dubG9hZGVnZycsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2Fkc2tpbGwnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKGFyZ3MpIHsKICAgICAgICBmb3IgKGxldCBza2lsbCBvZiBhcmdzKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoc2tpbGwpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnLmxvYWRza2lsbCByZXF1aXJlcyBzb21lIHNraWxsIG5hbWVzJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdMb2FkIHRoZSBzcGVjaWZpZWQgYWIgc2tpbGxzLicsCiAgICB1c2FnZTogJy5sb2FkU2tpbGwgW3NraWxsIC4uLl0nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cmxxcicsICgpID0+IG9zLnNob3dRUkNvZGUoY29uZmlnQm90LnRhZ3MudXJsKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgYSBRUiBjb2RlIGZvciB0aGUgYnJvd2VyIHRhYlwncyBjdXJyZW50IFVSTC4nLAogICAgdXNhZ2U6ICcudXJscXInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkaW0nLCAoYXJncykgPT4gewogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBuYW1lID0gYXJncy5qb2luKCcgJyk7CiAgICAgICAgb3MuZ29Ub0RpbWVuc2lvbihuYW1lKTsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYE1vdmVkIHRvICcke25hbWV9JyBkaW1lbnNpb24uYCwgZHVyYXRpb246IDMgfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dvIHRvIHNwZWNpZmllZCBkaW1lbnNpb24gLyBwb3J0YWwuJywKICAgIHVzYWdlOiAnLmRpbSA8ZGltZW5zaW9uIHwgcG9ydGFsPicsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1dWlkJywgKCkgPT4gewogICAgb3Muc2V0Q2xpcGJvYXJkKHV1aWQoKSk7CgogICAgbGV0IG1lc3NhZ2UgPSBgQ29waWVkIG5ldyB1dWlkIHRvIGNsaXBib2FyZGA7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYSB1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllciAodXVpZCkgYW5kIGNvcHkgaXQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcudXVpZCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2R1cCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBib3RJZCA9IGFyZ3MgPyBhcmdzWzBdIDogdW5kZWZpbmVkOwogICAgaWYgKGJvdElkKSB7CiAgICAgICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgICAgICBpZiAoYm90KSB7CiAgICAgICAgICAgIGNvbnN0IGR1cEJvdCA9IGNyZWF0ZShib3QpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZHVwQm90LmlkKTsKICAgICAgICAgICAgb3MudG9hc3QoJ0R1cGxpY2F0ZSBib3QgaWQgY29waWVkIHRvIGNsaXBib2FyZC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcy50b2FzdChgTm8gYm90IGZvdW5kIHdpdGggaWQgJHtib3RJZH1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCdQcm92aWRlIHRoZSBpZCBvZiB0aGUgYm90IHlvdSB3YW50IHRvIGR1cGxpY2F0ZScpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGEgc3BlY2lmaWVkIGJvdCBhbmQgY29weSB0aGUgbmV3IGJvdFwncyBpZCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy5kdXAgPGJvdElkPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGF1eCcsIChhcmdzKSA9PiB7CiAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIEFVWCBmaWxlKHMpIHRvIHRoZSBjdXJyZW50IGluc3QuJywKICAgIHVzYWdlOiAnLnVwbG9hZGF1eCcKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkZmlsZXMnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBsb2FkRmlsZXMoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgZmlsZShzKSBkaXJlY3RseSB0byByZWNvcmQuJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGxvYWRmaWxlcycsCiAgICAgICAgJy51cGxvYWRmaWxlcyAtcmVjb3JkIDxyZWNvcmRfaWQ+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcmVjb3JkJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcHRpb25hbGx5IHB1Ymxpc2ggZmlsZShzKSB0byBhIHNwZWNpZmljIHJlY29yZC4gSWYgb21pdHRlZCwgZmlsZShzKSB3aWxsIGJlIHB1Ymxpc2hlZCB0byB0aGUgdXNlclwncyBwZXJzb25hbCByZWNvcmQuJwogICAgICAgIH0KICAgIF0KfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndmlld3JlY29yZGRhdGEnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKCFsaW5rcy52aWV3UmVjb3JkRGF0YUFwcCkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiVmlld1JlY29yZCcpOwogICAgfQoKICAgIGxldCByZWNvcmROYW1lOwoKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgIHJlY29yZE5hbWUgPSBhcmdzLmpvaW4oJyAnKTsKICAgIH0KCiAgICBpZiAoIXJlY29yZE5hbWUpIHsKICAgICAgICByZWNvcmROYW1lID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZE5hbWU7CiAgICB9CiAgICAKICAgIGxpbmtzLnZpZXdSZWNvcmREYXRhQXBwLm1vdW50KHsgcmVjb3JkTmFtZSB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1ZpZXcgZGF0YSBzdG9yZWQgaW4gcHJvdmlkZWQgcmVjb3JkIG5hbWUuIElmIHJlY29yZCBuYW1lIGlzIG5vdCBwcm92aWRlZCB0aGVuIGl0IHdpbGwgZGVmYXVsdCB0byBhYiByZWNvcmQuJywKICAgIHVzYWdlOiBbJy52aWV3cmVjb3JkZGF0YScsICcudmlld3JlY29yZGRhdGEgW3JlY29yZE5hbWVdJ10KfSknAOuklIYBv7oICGFydGlmYWN0AgQA66SUhgHRwQko8J+Ulzc4ZTQxNTAzLWM5MzMtNGY4YS04MTdhLWJhOTdiZjhkNWQyNycA66SUhgG/uggVbG9hZEFCQ29tbWFuZHNNYW5hZ2VyAgQA66SUhgH4wQn6LUAvKioKICogQUJDb21tYW5kc01hbmFnZXIgaXMgcGFydCBvZiBhYlNoZWxsLgogKiBZb3UgY2FuIHJlZ2lzdGVyIGNvbW1hbmRzIHRvIGl0IHRoYXQgY2FuIGJlIGludm9rZWQgdXNpbmcgJyQ8Y29tbWFuZD4nIHdpdGggdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogKiBJdHMgZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZCB0byBjcmVhdGUgdGhpcyB5b3Vyc2VsZiBidXQgaW5zdGVhZCB0byBsaXN0ZW4gZm9yIHRoZSBAb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQgc2hvdXQKICogYW5kIHRvIHJlZ2lzdGVyIHlvdXIgY29tbWFuZHMgdGhlcmUuCiAqIEBwcm9wIHtzdHJpbmdbXX0gY29tbWFuZHMKICovCmNsYXNzIEFCQ29tbWFuZHNNYW5hZ2VyIHsKICAgIGNvbW1hbmRzOiBSZWNvcmQ8c3RyaW5nLCBBQkNvbW1hbmQ+OwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKCiAgICAgICAgLy8gU2hvdXQgdGhhdCBhbiBpbnN0YW5jZSBvZiBBQkNvbW1hbmRzTWFuYWdlciBoYXMgYmVlbiBjcmVhdGVkIGFuZCBhbGxvdyBhbnkgbGlzdGVuZXJzCiAgICAgICAgLy8gdG8gYWRkIHRoZWlyIG93biBjb21tYW5kcyB0byB0aGUgaW5zdGFuY2UuCiAgICAgICAgc2hvdXQoJ29uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkJywgdGhpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgYSBjb21tYW5kIHRvIEFCQ29tbWFuZHNNYW5hZ2VyLgogICAgICogVGhpcyBjb21tYW5kIHdpbGwgYmUgYXZhaWxhYmxlIHRvIGludm9rZSB1c2luZyAnJDxuYW1lPicgb24gdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIHN1Y2Nlc3NmdWxseSBhZGRlZC4KICAgICAqLwogICAgYWRkQ29tbWFuZChuYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjaywgaGVscDogQUJDb21tYW5kSGVscCk6IGJvb2xlYW4gewogICAgICAgIGlmICghbmFtZSB8fCB0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSBzdHJpbmcgbmFtZSBpcyByZXF1aXJlZCBmb3IgY29tbWFuZHMuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBhbHJlYWR5IGV4aXN0cyBhcyBhIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghY2FsbGJhY2sgfHwgdHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGEgY2FsbGJhY2sgZnVuY3Rpb24uYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgaXMgbWlzc2luZyBzaG9ydERlc2NyaXB0aW9uIGZyb20gaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29tbWFuZHNbbmFtZV0gPSB7IG5hbWUsIGNhbGxiYWNrLCBoZWxwIH07CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaGFzQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kc1tuYW1lXSAhPSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgY29tbWFuZCBmcm9tIEFCQ29tbWFuZHNNYW5hZ2VyCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2FzIHJlbW92ZWQuIElmIHRoZSBjb21tYW5kIGRvZXNuJ3QgZXhpc3QgZmFsc2Ugd2lsbCBhbHNvIGJlIHJldHVybmVkLgogICAgICovCiAgICByZW1vdmVDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ2FsbCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2l0aCB0aGUgcHJvdmlkZWQgYXJncyAoaWYgYW55KS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBleGVjdXRlZC4KICAgICAqLwogICAgY2FsbENvbW1hbmQobmFtZTogc3RyaW5nLCBhcmdzPzogYW55W10pOiBib29sZWFuIHsKICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICBpZiAoY29tbWFuZCkgewogICAgICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRBcmdzID0gW107CgogICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBoZWxwQXJnIG9mIGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhlbHBBcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKC4uLmhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaChoZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZSBpbnB1dCBhcmdzIGFyZSB2YWxpZCBhZ2FpbnN0IHRoZSBjb21tYW5kIGhlbHAgZG9jdW1lbnRhdGlvbi4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gZWFzeSB3YXkgdG8gdmFsaWRhdGUgYXJncyBiZWZvcmUgZXhlY3V0aW5nIGEgY29tbWFuZC4KICAgICAgICAgICAgICAgIEFCQ29tbWFuZHNNYW5hZ2VyLmFzc2VydFZhbGlkQXJncyhhcmdzLCB2YWxpZEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1hbmQuY2FsbGJhY2soYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBub3QgYSB2YWxpZCBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHByb3ZpZGVkIGFyZy4gV2lsbCByZW1vdmUgdGhlIGFyZyBhbmQgdmFsdWUgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnVmFsdWUoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYW55IHsKICAgICAgICBsZXQgdmFsdWUgPSBudWxsOwoKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICBsZXQgZGVsZXRlQ291bnQgPSAxOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWVJbmRleCA9IGFyZ0luZGV4ICsgMTsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWVJbmRleCA8IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbdmFsdWVJbmRleF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlbGF0ZWQgYXJncyAmIHZhbHVlcwogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIGRlbGV0ZUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHdldGhlciB0aGUgYXJnIGZsYWcgaXMgcHJvdmlkZWQgaW4gdGhlIGFyZ3MuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnRmxhZyhhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYXJnIGZsYWcuCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgMSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHN0YXRpYyBhc3NlcnRWYWxpZEFyZ3MoYXJnczogYW55W10sIHZhbGlkQXJnczogYW55W10pOiB2b2lkIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBpbnZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFyZyB3ZSB3YW50IHRvIGV2YWx1YXRlLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkQXJncyB8fCAhdmFsaWRBcmdzLmluY2x1ZGVzKGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXJnIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgdmFsaWRBcmdzLCB0aHVzIHRoZSBhcmcgaXMgaW52YWxpZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRBcmdzLnB1c2goYXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB0aGlzIGFyZyBpdCBpcyBtb3N0bHkgbGlrZWx5IGEgdmFsdWUgYXJnLgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGludmFsaWRBcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIGFyZ3VtZW50czogJHtpbnZhbGlkQXJncy5qb2luKCcsICcpfWA7CgogICAgICAgICAgICAgICAgb3MudG9hc3QoZXJyb3JNZXNzYWdlLCA0KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpnbG9iYWxUaGlzLkFCQ29tbWFuZHNNYW5hZ2VyID0gQUJDb21tYW5kc01hbmFnZXI7JwDrpJSGAb+6CARoZWxwAgQA66SUhgHz7wko8J+UlzI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYycA66SUhgG/uggIY21kU2hlZXQCBADrpJSGAZrwCc0UQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IHBvcnRhbDsKbGV0IG5ld1RhYiA9IGZhbHNlOwoKaWYgKGFyZ3MpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV07CiAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJy10JykgewogICAgICAgICAgICAgICAgbmV3VGFiID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSBhcmc7CiAgICAgICAgfQogICAgfQp9CgppZiAoIXBvcnRhbCkgewogICAgcG9ydGFsID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9Cgpjb25zdCBoZWxwZXJCb3RzID0gewogICAgJ2NvbmZpZ0JvdCc6IGNvbmZpZ0JvdCwKICAgICdncmlkUG9ydGFsQm90JzogZ3JpZFBvcnRhbEJvdCwKICAgICdzaGVldFBvcnRhbEJvdCc6IHNoZWV0UG9ydGFsQm90LAogICAgJ3N5c3RlbVBvcnRhbEJvdCc6IHN5c3RlbVBvcnRhbEJvdCwKICAgICdtaW5pR3JpZFBvcnRhbEJvdCc6IG1pbmlHcmlkUG9ydGFsQm90LAogICAgJ21hcFBvcnRhbEJvdCc6IG1hcFBvcnRhbEJvdCwKICAgICdtaW5pTWFwUG9ydGFsQm90JzogbWluaU1hcFBvcnRhbEJvdCwKICAgICdtZW51UG9ydGFsQm90JzogbWVudVBvcnRhbEJvdCwKICAgICdsZWZ0V3Jpc3RQb3J0YWxCb3QnOiBsZWZ0V3Jpc3RQb3J0YWxCb3QsCiAgICAncmlnaHRXcmlzdFBvcnRhbEJvdCc6IHJpZ2h0V3Jpc3RQb3J0YWxCb3QsCiAgICAnbWVldFBvcnRhbEJvdCc6IG1lZXRQb3J0YWxCb3QsCiAgICAndGFnUG9ydGFsQm90JzogdGFnUG9ydGFsQm90LAogICAgJ2ltdVBvcnRhbEJvdCc6IGltdVBvcnRhbEJvdCwKfTsKCi8vIEZ1bmN0aW9uIHRvIHJlc29sdmUgYSBwb3J0YWwgcmVmZXJlbmNlIHRvIGEgc3BlY2lmaWMgYm90CmZ1bmN0aW9uIHJlc29sdmVQb3J0YWxUb0JvdChwYXRoKSB7CiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJycpIHJldHVybiBudWxsOwogICAgCiAgICAvLyBGaXJzdCBjaGVjayBpZiBpdCdzIGRpcmVjdGx5IGluIGhlbHBlckJvdHMKICAgIGlmIChoZWxwZXJCb3RzW3BhdGhdKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlckJvdHNbcGF0aF07CiAgICB9CgogICAgLy8gUGVyaGFwcyB0aGUgcGF0aCBpcyBhIGJvdCBpZC4KICAgIGxldCBib3RGcm9tSWRTZWFyY2ggPSBnZXRCb3QoJ2lkJywgcGF0aCk7CiAgICBpZiAoYm90RnJvbUlkU2VhcmNoKSB7CiAgICAgICAgcmV0dXJuIGJvdEZyb21JZFNlYXJjaDsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgZm9yIGJvdGggZGlyZWN0IGFuZCBuZXN0ZWQgcGF0aHMgaW4gZ2xvYmFsVGhpcwogICAgbGV0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIGxldCBjdXJyZW50T2JqID0gZ2xvYmFsVGhpczsKICAgIGxldCBzdGFydEluZGV4ID0gMDsKICAgIAogICAgLy8gSGFuZGxlIGlmIHRoZSBwYXRoIGV4cGxpY2l0bHkgc3RhcnRzIHdpdGggJ2dsb2JhbFRoaXMnCiAgICBpZiAocGF0aFBhcnRzWzBdID09PSAnZ2xvYmFsVGhpcycpIHsKICAgICAgICBzdGFydEluZGV4ID0gMTsgLy8gU2tpcCB0aGUgJ2dsb2JhbFRoaXMnIHBhcnQgc2luY2Ugd2UncmUgYWxyZWFkeSBzdGFydGluZyB0aGVyZQogICAgfQogICAgCiAgICAvLyBUcmF2ZXJzZSB0aGUgcGF0aAogICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBwYXRoUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwYXJ0ID0gcGF0aFBhcnRzW2ldOwogICAgICAgIGlmICghY3VycmVudE9ialtwYXJ0XSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gUGF0aCBzZWdtZW50IGRvZXNuJ3QgZXhpc3QKICAgICAgICB9CiAgICAgICAgY3VycmVudE9iaiA9IGN1cnJlbnRPYmpbcGFydF07CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGlmIHRoZSBmaW5hbCBvYmplY3QgaXMgYSBib3QgKGhhcyBpZCBhbmQgdGFncykKICAgIGlmIChjdXJyZW50T2JqICYmIGN1cnJlbnRPYmouaWQgJiYgY3VycmVudE9iai50YWdzKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRPYmo7CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOyAvLyBOb3QgYSB2YWxpZCBib3QKfQoKLy8gU2VhcmNoIHRvIHNlZSBpZiBwb3J0YWwgYXJndW1lbnQgaXMgc3BlY2lmaWMgdG8gYSBib3QKbGV0IHVuaXF1ZUJvdCA9IHJlc29sdmVQb3J0YWxUb0JvdChwb3J0YWwpOwoKaWYgKHVuaXF1ZUJvdCkgewogICAgaWYgKHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcExvY2FsJyB8fAogICAgICAgIHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcFNoYXJlZCcKICAgICkgewogICAgICAgIC8vIEZvcmNlIHNoZWV0IHRvIG9wZW4gaW4gc2FtZSB0YWIgaWYgdGhlIGJvdCBvbmx5IGxpdmVzIGluIHRoaXMgdGFiLgogICAgICAgIG5ld1RhYiA9IGZhbHNlOwogICAgfQogICAgcG9ydGFsID0gdW5pcXVlQm90LmlkOwp9CgppZiAobmV3VGFiKSB7CiAgICBvcy5vcGVuVVJMKGAvP2luc3Q9JHtvcy5nZXRDdXJyZW50SW5zdCgpfSZzaGVldFBvcnRhbD0ke3BvcnRhbH1gKTsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gcG9ydGFsOwp9JwDrpJSGAb+6CA1jbWREb3dubG9hZEFCAgQA66SUhgHohAqtC0Bjb25zdCBhcmdzID0gdGhhdDsKCmxldCBhdXhWZXJzaW9uOiBzdHJpbmcgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctdicpOwoKaWYgKCFhdXhWZXJzaW9uKSB7CiAgICAvLyBEZWZhdWx0IHRvIGF1eCB2ZXJzaW9uIDIgaWYgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkLgogICAgYXV4VmVyc2lvbiA9ICcyJzsKfQoKaWYgKGF1eFZlcnNpb24gIT09ICcxJyAmJiBhdXhWZXJzaW9uICE9PSAnMicpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYE9ubHkgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgYW5kIDIgYXJlIHN1cHBvcnRlZCBpbiB0aGUgZG93bmxvYWQgYWIgY29tbWFuZC5gKTsKICAgIHJldHVybjsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmxldCBncm91cHMgPSBbXTsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgLy8gUmVtYWluaW5nIGFyZ3MgYXJlIGdyb3VwIG5hbWVzIHByb3ZpZGVkIHdpdGggdGhlIGNvbW1hbmQuCiAgICBncm91cHMgPSBhcmdzOwp9IGVsc2UgewogICAgbGV0IGdyb3VwID0gYXdhaXQgb3Muc2hvd0lucHV0KG1hc2tzLnByZXZJbnB1dERvd25sb2FkQUJHcm91cCwgeyB0aXRsZTogJ0FCIEdyb3VwIFRhZycsIGF1dG9TZWxlY3Q6IHRydWUgfSk7CiAgICBpZiAoZ3JvdXApIHsKICAgICAgICBtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAgPSBncm91cDsKICAgICAgICBncm91cHMucHVzaChncm91cCk7CiAgICB9Cn0KCmNvbnN0IG1ham9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWFqb3JWZXJzaW9uOwpjb25zdCBtaW5vclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1pbm9yVmVyc2lvbjsKY29uc3QgYWJWZXJzaW9uID0gYCR7bWFqb3JWZXJzaW9ufS4ke21pbm9yVmVyc2lvbn1gOwoKZm9yIChsZXQgZ3JvdXAgb2YgZ3JvdXBzKSB7CiAgICBjb25zdCBncm91cEJvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgW2dyb3VwXTogdHJ1ZSwgc3BhY2U6ICdzaGFyZWQnIH0pKTsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGdyb3VwQm90cy5sZW5ndGg7IGkrKykgewogICAgICAgIGdyb3VwQm90c1tpXS50YWdzLmFiVmVyc2lvbiA9IGFiVmVyc2lvbjsKICAgIH0KCiAgICBpZiAoZ3JvdXAgPT0gImFiQ29uZmlnIikgewogICAgICAgIGdyb3VwID0gImFiMSI7CiAgICB9CgogICAgaWYgKGF1eFZlcnNpb24gPT09ICcxJykgewogICAgICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMQogICAgICAgIG9zLmRvd25sb2FkQm90cyhncm91cEJvdHMsIGdyb3VwKQogICAgfSBlbHNlIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDIKICAgICAgICBvcy5kb3dubG9hZEJvdHNBc0luaXRpYWx6YXRpb25VcGRhdGUoZ3JvdXBCb3RzLCBncm91cCk7CiAgICB9Cgp9CgonAOuklIYBv7oICWNtZEFCV2FrZQIEAOuklIYBlpAK1gNAbGV0IHNraWxsQXJyYXkgPSBbImFiUGVyc29uYWxpdHkiLCAiYWJJbnRlcmZhY2UiLCAiYWJBY3Rpb24iLCAiYWJUZXN0cyJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwp9Cgphd2FpdCBvcy5zbGVlcCgzMDApOwoKLy9rZWVwIGFiIGF3YWtlCnNldFRhZ01hc2sobGlua3MucmVtZW1iZXIsICdhYkF3YWtlU3RhdGUnLCB0cnVlLCAnc2hhcmVkJykKCmlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47Cn0KZWxzZSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkF3YWtlIiwgImFiTWFuaWZlc3RTdGF0ZSIpOycA66SUhgG/uggKY21kQUJTbGVlcAIEAOuklIYB7ZMK3QFAY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cgp0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOycA66SUhgG/uggHY29uc29sZQIEAOuklIYBy5UKKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAOuklIYBv7oIDmNtZFVwbG9hZEZpbGVzAgQA66SUhgHylQqTEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScA66SUhgG/uggOY21kRG93bmxvYWRFZ2cCBADrpJSGAYamCvkLQGNvbnN0IHJlY29yZEtleSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXksIHsKICAgIHRpdGxlOiAncmVjb3JkIHRvIGxvb2t1cCBlZ2cgaW4nLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleTpgLCByZWNvcmRLZXkpOwoKaWYgKCFyZWNvcmRLZXkpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5ID0gcmVjb3JkS2V5OwoKY29uc3QgZWdnTmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lLCB7CiAgICB0aXRsZTogJ25hbWUgb2YgZWdnJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2dOYW1lOmAsIGVnZ05hbWUpOwoKaWYgKCFlZ2dOYW1lKSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUgPSBlZ2dOYW1lOwoKY29uc3QgZWdnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgIGFiSUQ6IGVnZ05hbWUsCiAgICByZWNvcmRLZXksCiAgICByZXR1cm5UeXBlOiAnZWdnJwp9KQoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2c6YCwgZWdnKTsKCmlmICghQXJyYXkuaXNBcnJheShlZ2cuZWdnVmVyc2lvbkhpc3RvcnkpIHx8IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYERhdGEgZm91bmQgYXQgYWRkcmVzcyAnJHtlZ2dOYW1lfScgaW4gcmVjb3JkICcke3JlY29yZEtleX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlZ2cuYCkKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBlZ2dWZXJzaW9uT3B0aW9ucyA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7CiAgICByZXR1cm4geyBsYWJlbDogYHZlcnNpb24gJHtpbmRleCArIDF9YCwgdmFsdWU6IGluZGV4IH0KfSkKCmNvbnN0IHNlbGVjdGVkVmVyc2lvbk9wdGlvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChlZ2dWZXJzaW9uT3B0aW9ucy5sZW5ndGggLSAxLCB7CiAgICB0aXRsZTogJ2Rvd25sb2FkIGVnZyB2ZXJzaW9uJywKICAgIHR5cGU6ICdsaXN0JywKICAgIHN1YnR5cGU6ICdzZWxlY3QnLAogICAgaXRlbXM6IGVnZ1ZlcnNpb25PcHRpb25zLAp9KQoKaWYgKCFzZWxlY3RlZFZlcnNpb25PcHRpb24pIHsKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBhdXhEYXRhVXJsID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5W3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZV07CmNvbnN0IGF1eERhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGF1eERhdGFVcmwpOwpjb25zdCBhdXhGaWxlbmFtZSA9IGAke2VnZ05hbWV9X3Yke3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZSArIDF9LmF1eGA7Cgpvcy5kb3dubG9hZChhdXhEYXRhLCBhdXhGaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsnAOuklIYBv7oID2NtZERvd25sb2FkSW5zdAIEAOuklIYBgLIKhQFAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBib3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwpvcy5kb3dubG9hZEJvdHMoYm90cywgb3MuZ2V0Q3VycmVudEluc3QoKSk7JwDrpJSGAb+6CAZzZWFyY2gCBADrpJSGAYazCijwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwDrpJSGAb+6CAV1dGlscwIEAOuklIYBrbMKKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAOuklIYBv7oICWNtZFN5c3RlbQIEAOuklIYB1LMKkQdAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCBzYW1lV2luZG93ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdGbGFnKGFyZ3MsICctdycpOwoKbGV0IHN5c3RlbVRhZ05hbWUgPSBudWxsOwoKaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPiAwKSB7CiAgICBzeXN0ZW1UYWdOYW1lID0gYXJncy5qb2luKCcgJyk7Cn0KCmlmIChzYW1lV2luZG93KSB7CiAgICAvLyBPcGVuIHN5c3RlbSBwb3J0YWwgaW4gdGhlIGN1cnJlbnQgd2luZG93LgogICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsID0gdHJ1ZTsKICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVRhZ05hbWUgPSBzeXN0ZW1UYWdOYW1lOwp9IGVsc2UgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIGEgbmV3IHRhYi4KICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKTsKCiAgICAvLyBSZW1vdmUgYW55IHBvcnRhbHMgdGhhdCBhcmUgc2V0IGluIHRoZSBVUkwuCiAgICBsZXQgcGFyYW1zID0gdXJsLnNlYXJjaFBhcmFtcy5rZXlzKCk7CiAgICBmb3IgKGxldCBwYXJhbSBvZiBwYXJhbXMpIHsKICAgICAgICBpZiAocGFyYW0uZW5kc1dpdGgoJ1BvcnRhbCcpKSB7CiAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKHBhcmFtKTsKICAgICAgICB9CiAgICB9CgogICAgLy8gVHVybiBvbiB0aGUgc3lzdGVtIHBvcnRhbC4KICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1Qb3J0YWwnLCAndHJ1ZScpOwogICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUoJ3N5c3RlbVRhZ05hbWUnKTsKCiAgICBpZiAoc3lzdGVtVGFnTmFtZSkgewogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdzeXN0ZW1UYWdOYW1lJywgc3lzdGVtVGFnTmFtZSk7CiAgICB9CgogICAgb3Mub3BlblVSTCh1cmwuaHJlZik7Cn0KJwDrpJSGAb+6CA1hYkNoYXRCYXJPcGVuAgQA66SUhgHmugqjAkBjb25zdCB7CiAgICBwcmVmaWxsLAp9ID0gdGhhdCA/PyB7fQoKbWFza3MuY2hhdE9wZW4gPSB0cnVlOwoKb3Muc2hvd0NoYXQoewogICAgcGxhY2Vob2xkZXI6ICc+IC5oZWxwIHRvIHNlZSBhdmFpbGFibGUgY29tbWFuZHMnLAogICAgYmFja2dyb3VuZENvbG9yOiAnIzJmMmYyZicsCiAgICBmb3JlZ3JvdW5kQ29sb3I6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwbGFjZWhvbGRlckNvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcHJlZmlsbAp9KScA66SUhgG/uggOYWJDaGF0QmFyQ2xvc2UCBADrpJSGAYq9CnZAbWFza3MuY2hhdE9wZW4gPSBmYWxzZTsKb3MuaGlkZUNoYXQoKTsKCi8vIEdpdmUgQ2FzdWFsT1MgYSBjaGFuZ2UgdG8gYWN0dWFsbHkgcmVtb3ZlIHRoZSBjaGF0IGJhci4KYXdhaXQgb3Muc2xlZXAoMCk7JwDrpJSGAb+6CAtwZXJzb25hbGl0eQIEAOuklIYBgb4KKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAOuklIYBv7oIBXR5cGVzAgQA66SUhgGovgryAvCfk4R0eXBlIEFCQ29tbWFuZENhbGxiYWNrID0gKGFyZ3M/OiBhbnlbXSkgPT4gdm9pZDsKCmludGVyZmFjZSBBQkNvbW1hbmRBcmcgewogIGlkZW50aWZpZXI6IHN0cmluZ1tdIHwgc3RyaW5nOwogIGRlc2NyaXB0aW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkNvbW1hbmRIZWxwIHsKICBzaG9ydERlc2NyaXB0aW9uOiBzdHJpbmc7CiAgbG9uZ0Rlc2NyaXB0aW9uPzogc3RyaW5nOwogIGFyZ3M/OiBBQkNvbW1hbmRBcmdbXTsKICB1c2FnZT86IHN0cmluZyB8IHN0cmluZ1tdOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kIHsKICBuYW1lOiBzdHJpbmc7CiAgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrOwogIGhlbHA6IEFCQ29tbWFuZEhlbHA7Cn0nAOuklIYBv7oIEXZpZXdSZWNvcmREYXRhQXBwAgQA66SUhgGZwQoo8J+UlzkyZmY2ZDI4LTMzNTEtNGNmYi04NDY0LTlkN2M2MTQyN2EyNgA="}]}