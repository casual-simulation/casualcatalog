{"version":2,"updates":[{"id":0,"timestamp":1751564136529,"update":"AfwCi/zg8AcAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwCL/ODwBwAGc3lzdGVtAgQAi/zg8AcBDWFiLnNoZWxsLmdyaWQnAIv84PAHAARmb3JtAgQAi/zg8AcPB25vdGhpbmcnAIv84PAHAAxvbkFueUJvdERyYWcCBACL/ODwBxe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAIv84PAHAAhyZW1lbWJlcgIEAIv84PAH0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAi/zg8AcACGFiSWdub3JlAgQAi/zg8Af6AQR0cnVlJwCL/ODwBwAHYWJTaGVsbAIEAIv84PAH/wEEdHJ1ZScAi/zg8AcACWFiVmVyc2lvbgIEAIv84PAHhAIEMTAuMycAi/zg8AcABWZvY3VzAgQAi/zg8AeJAqwEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKTsKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScAi/zg8Ae2BgZzeXN0ZW0CBACL/ODwB7cGE2FiLnNoZWxsLmNvbXBvbmVudHMnAIv84PAHtgYMQXBwQ29udGFpbmVyAgQAi/zg8AfLBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycAi/zg8Ae2BghUZXh0TGluawIEAIv84PAH+AqdA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwCL/ODwB7YGBldpbmRvdwIEAIv84PAHlg62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAIv84PAHtgYMVGV4dExpbmsuY3NzAgQAi/zg8AfNEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwCL/ODwB7YGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAIv84PAHuxJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAIv84PAHtgYKV2luZG93LmNzcwIEAIv84PAHrROoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAIv84PAHtgYIcmVtZW1iZXICBACL/ODwB9YWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAIv84PAHtgYIYWJJZ25vcmUCBACL/ODwB/0WBHRydWUnAIv84PAHtgYHYWJTaGVsbAIEAIv84PAHghcEdHJ1ZScAi/zg8Ae2BglhYlZlcnNpb24CBACL/ODwB4cXBDEwLjMnAQRib3RzJDI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYgEnAIv84PAHjBcHQXBwLmNzcwIEAIv84PAHjRexFjpyb290IHsKICAtLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgLS1vbi1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogIC0tYWItY29uc29sZS1oZWlnaHQ6IDMzdmg7Cn0KLyogRGFyayBtb2RlIHN1cHBvcnQgKi8KQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykgewogIDpyb290IHsKICAgIC0tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAgIC0tb24tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICB9Cn0KCi5hYi1jb25zb2xlLWJ0biB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiBpbmhlcml0OwogIGxldHRlci1zcGFjaW5nOiBpbmhlcml0OwogIGxpbmUtaGVpZ2h0OiBpbmhlcml0OwogIHRleHQtdHJhbnNmb3JtOiBpbmhlcml0OwogIHRleHQtaW5kZW50OiBpbmhlcml0OwogIHRleHQtc2hhZG93OiBpbmhlcml0OwogIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgbWFyZ2luOiBpbmhlcml0OwogIHBhZGRpbmctYmxvY2s6IGluaGVyaXQ7CiAgcGFkZGluZy1pbmxpbmU6IGluaGVyaXQ7CiAgYm9yZGVyOiBub25lOwogIHRyYW5zZm9ybTogc2NhbGUoMS4yKTsKfQoKLmFiLWNvbnNvbGUgewogIHdpZHRoOiAxMDB2dzsKICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogIHBhZGRpbmc6IDA7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KSBicmlnaHRuZXNzKDIwMCUpOwogIGFuaW1hdGlvbi1uYW1lOiBzbGlkZS1hcHAtaW47CiAgYW5pbWF0aW9uLWR1cmF0aW9uOiAwLjVzOwogIG92ZXJmbG93LXk6IGhpZGRlbjsKICB6LWluZGV4OiAxOwp9CgouYWItY29uc29sZTo6YWZ0ZXIgewogIGNvbnRlbnQ6ICIiOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB0b3A6IDA7CiAgbGVmdDogMDsKICByaWdodDogMDsKICBib3R0b206IDA7CiAgb3BhY2l0eTogMC45OwogIHotaW5kZXg6IDA7Cn0KCkBrZXlmcmFtZXMgc2xpZGUtYXBwLWluIHsKICBmcm9tIHsKICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGN1YmljLWJlemllciguNiwwLC43OSwxLjAzKTsKICAgIC8qIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMTAlKTsgKi8KICAgIC8qIGhlaWdodDogMHB4OyAqLwogICAgLyogbWluLWhlaWdodDogMHB4OyAqLwogICAgbWF4LWhlaWdodDogMHB4OwogIH0KCiAgdG8gewogICAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogICAgLyogbWluLWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOyAqLwogIH0KfQoKLmFiLWNvbnNvbGUgPiBkaXYgewogIHotaW5kZXg6IDE7CiAgcG9zaXRpb246IHJlbGF0aXZlCn0KCi5hYi1jb25zb2xlLXRvcC1iYXIgewogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHdpZHRoOiAxMDAlOwogIHRleHQtYWxpZ246IGNlbnRlcjsKICB1c2VyLXNlbGVjdDogbm9uZTsKICBkaXNwbGF5OiBmbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBlbmQ7CiAgcGFkZGluZzogMC41cmVtOwp9CgouYWItY29uc29sZS1sb2cgewogIG92ZXJmbG93LXk6IGF1dG87CiAgZmxleC1ncm93OiAxOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwogIG1pbi1oZWlnaHQ6IDI0cHg7CiAgcGFkZGluZzogMCAxcmVtOwogIGN1cnNvcjogcG9pbnRlcjsKICBvdmVyc2Nyb2xsLWJlaGF2aW9yOiBjb250YWluOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBjdXJzb3I6IGluaXRpYWw7Cn0KCi5hYi1jb25zb2xlLW1lc3NhZ2UtY29udGFpbmVyIHsKICBtYXJnaW46IDAuNXJlbSAwOwp9Ci5hYi1jb25zb2xlLW1lc3NhZ2UgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGdhcDogOHB4Owp9CgouYWItY29uc29sZS1zcGFjZXIgewogIGZsZXgtc2hyaW5rOiAwOwogIGZsZXgtZ3JvdzogMTsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgbWF4LXdpZHRoOiA4MHZ3OwogIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScAi/zg8AeMFwZnZXRBcHACBACL/ODwB78t3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwCL/ODwB4wXC2hpZGVDb25zb2xlAgQAi/zg8AedUZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwCL/ODwB4wXA2xvZwIEAIv84PAHvVLnCEBsZXQgYm90VGFncyA9IHt9OwoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgY29uc3QgX21lc3NhZ2VUZXh0ID0gU3RyaW5nKHRoYXQpLnNwbGl0KCc6ICcpOwogICAgY29uc3QgX25hbWUgPSBfbWVzc2FnZVRleHQuc2hpZnQoKTsKICAgIGNvbnN0IF90aW1lc3RhbXAgPSBvcy5pc0NvbGxhYm9yYXRpdmUoKSA/IG9zLmFncmVlZFVwb25UaW1lIDogb3MubG9jYWxUaW1lCgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGNyZWF0ZShib3RUYWdzKTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwCL/ODwB4wXC3Nob3dDb25zb2xlAgQAi/zg8AelW+0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicAi/zg8AeMFwZzeXN0ZW0CBACL/ODwB5NfEGFiLnNoZWxsLmNvbnNvbGUnAIv84PAHjBcNdG9nZ2xlQ29uc29sZQIEAIv84PAHpF+WAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScAi/zg8AeMFwRmb3JtAgQAi/zg8Ae7YAdub3RoaW5nJwCL/ODwB4wXB2FiU2hlbGwCBACL/ODwB8NgBHRydWUnAIv84PAHjBcKYWJJRE9yaWdpbgIEAIv84PAHyGAVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwCL/ODwB4wXBlRvcEJhcgIEAIv84PAH3mDzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicAi/zg8AeMFw1zaG93Q2hhdElucHV0AgQAi/zg8AfSZQVmYWxzZSgAi/zg8AeMFwpzaG93VG9wQmFyAXknAIv84PAHjBcJYWJWZXJzaW9uAgQAi/zg8AfZZQQxMC4zJwCL/ODwB4wXEnNldEFiRXhwYW5kQ29uc29sZQIEAIv84PAH3mWXAkBjb25zb2xlLmxvZyh0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCkKaWYgKHR5cGVvZiB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCAhPT0gJ2Z1bmN0aW9uJykgewogICAgcmV0dXJuOwp9CgppZiAodGhhdCA9PT0gdW5kZWZpbmVkKSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChzID0+ICFzKTsKfSBlbHNlIGlmICh0aGF0ID09IHRydWUpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHRydWUpOwp9IGVsc2UgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwoZmFsc2UpOwp9CicAi/zg8AeMFwhhYklnbm9yZQIEAIv84PAH9mcEdHJ1ZScAi/zg8AeMFwdNZXNzYWdlAgQAi/zg8Af7Z+cQQGNvbnN0IHsgdXNlU3RhdGUsIHVzZU1lbW8sIHVzZUVmZmVjdCB9ID0gb3MuYXBwSG9va3MKY29uc3QgVG9wQmFyID0gdGhpc0JvdC5Ub3BCYXIoKQoKY29uc3QgTWVzc2FnZSA9ICh7IHRpbWVzdGFtcCwgbWVzc2FnZSwgbmFtZSB9KSA9PiB7CiAgICBjb25zdCBbc2hvd1RpbWUsIHNldFNob3dUaW1lXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IFt1c2VyTWVzc2FnZSwgc2V0VXNlck1lc3NhZ2VdID0gdXNlU3RhdGUoZmFsc2UpOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGF1dGhCb3QgJiYgYXV0aEJvdC50YWdzLm5hbWUpIHsKICAgICAgICAgICAgaWYgKGF1dGhCb3QudGFncy5uYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUpIHsKICAgICAgICAgICAgICAgIGlmIChtYXNrcy5wcmVmZXJyZWROYW1lID09IG5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobmFtZSA9PSAidXNlciIgfHwgbmFtZSA9PSAiVXNlciIpIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UoZmFsc2UpOwogICAgICAgIH0KCiAgICB9LCBbbmFtZV0pCgogICAgY29uc3QgdGltZVRleHQgPSB1c2VNZW1vKAogICAgICAgICgpID0+IHsKICAgICAgICAgICAgaWYgKCF0aW1lc3RhbXApIHsgcmV0dXJuIH0KICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKHRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoCiAgICAgICAgICAgICAgICAgICAnZW4tdXMnLCB7dGltZVN0eWxlOiAnbWVkaXVtJ30pfSwKICAgICAgICBbdGltZXN0YW1wXQogICAgKTsKCiAgICBpZiAoIXRpbWVzdGFtcCB8fCAhbWVzc2FnZSkgeyByZXR1cm4gPD48Lz4gfQoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbWVzc2FnZS1jb250YWluZXIiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoKSA9PiBzZXRTaG93VGltZSh0cnVlKX0KICAgICAgICAgICAgb25Qb2ludGVyTGVhdmU9eygpID0+IHNldFNob3dUaW1lKGZhbHNlKX0KICAgICAgICA+CiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIHN0eWxlPXt1c2VyTWVzc2FnZSAmJiB7dGV4dEFsaWduOiAncmlnaHQnfX0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAge25hbWV9CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlIiBzdHlsZT17ewogICAgICAgICAgICAgICAgZmxleERpcmVjdGlvbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3JvdycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ3Jvdy1yZXZlcnNlJwogICAgICAgICAgICB9fT4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXNwYWNlciIKICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0QWxpZ246IHVzZXJNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncmlnaHQnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnbGVmdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHNob3dUaW1lID8gMC42IDogMAogICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAge3RpbWVUZXh0fQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1jb250ZW50Ij4KICAgICAgICAgICAgICAgICAgICB7bWVzc2FnZX0KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIE1lc3NhZ2U7JwCL/ODwB4wXEG9uQW55Qm90c1JlbW92ZWQCBACL/ODwB+N4rQJAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90SWQgb2YgYm90SURzKSB7DQogICAgaWYgKHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgIGNvbnN0IGRlbGV0ZWQgPSB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5kZWxldGUoYm90SWQpOw0KDQogICAgICAgIGlmIChkZWxldGVkKSB7DQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3RJZDogYm90SWQgfSk7DQogICAgICAgIH0NCiAgICB9DQp9JwCL/ODwB4wXDm9uQW55Qm90c0FkZGVkAgQAi/zg8AeRe/gDQGNvbnN0IHsgYm90cyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBuZXdCb3Qgb2YgYm90cykgew0KICAgIGlmIChuZXdCb3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMobmV3Qm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKG5ld0JvdC5pZCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IG5ld0JvdCB9KTsNCiAgICB9DQp9JwCL/ODwB4wXEG9uQW55Qm90c0NoYW5nZWQCBACL/ODwB4p/4wVAY29uc3QgYm90cyA9IHRoYXQ7DQoNCmZvciAoY29uc3QgYm90IG9mIGJvdHMpIHsNCiAgICBpZiAoYm90LmJvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhib3QuYm90LmlkKSkgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuYWRkKGJvdC5ib3QuaWQpOw0KDQogICAgICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBib3QuYm90IH0pOw0KICAgICAgICB9IA0KDQogICAgICAgIGlmIChib3QudGFncy5pbmNsdWRlcygibWVzc2FnZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJuYW1lIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoInRpbWVzdGFtcCIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIpKSB7DQogICAgICAgICAgICBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOyAgICAgICAgDQogICAgICAgIH0NCiAgICB9DQp9JwCL/ODwB4wXH29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQCBACL/ODwB+6EATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAIv84PAHjBcdb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQCBACL/ODwB6WFATZAaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsnAQRib3RzJDI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYwEnAIv84PAH3IUBBnN5c3RlbQIEAIv84PAH3YUBDWFiLnNoZWxsLmhlbHAnAIv84PAH3IUBCW9uS2V5RG93bgIEAIv84PAH64UBjAJAaWYgKHRhZ3MuaGVscEFjdGl2ZSAmJiB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpKSB7CiAgICBpZiAodGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICBmb3IgKGxldCBjYWxsYmFjayBvZiB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9JwCL/ODwB9yFAQd1bm1vdW50AgQAi/zg8Af4hwGgAUBhd2FpdCBvcy5jb21waWxlQXBwKCdhYi1jb21tYW5kLWhlbHAnLCA8PjwvPik7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoJ2FiLWNvbW1hbmQtaGVscCcpOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSB1bmRlZmluZWQ7Cm1hc2tzLmhlbHBBY3RpdmUgPSBmYWxzZTsnAIv84PAH3IUBCXN0eWxlLmNzcwIEAIv84PAHmYkB8QcuaGVscC10YWJsZSB7CiAgd2lkdGg6IDEwMCU7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi5oZWxwLXRhYmxlIHRkIHsKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHBhZGRpbmctYm90dG9tOiA4cHg7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouaGVscC10YWJsZSB0ZCBoMyB7CiAgbWFyZ2luOiAwOwp9CgouaGVscC10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA5MHB4OwogIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLnNlY3Rpb24gewogIG1hcmdpbi10b3A6IDE2cHg7Cn0KCi5zZWN0aW9uIHA6Zmlyc3Qtb2YtdHlwZSB7CiAgbWFyZ2luLXRvcDogNHB4OwogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouZGVzY3JpcHRpb24geyAKICB3aGl0ZS1zcGFjZTogcHJlLWxpbmU7Cn0KCi51c2FnZS10YWJsZSB7CiAgYm9yZGVyLXNwYWNpbmc6IDA7Cn0KCi51c2FnZS10YWJsZSB0ZCxoMyB7IAogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogIG1hcmdpbjogMDsKfQoKLnVzYWdlLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDYwcHg7Cn0KCi5hcmdzLXRhYmxlIHsKICBtYXJnaW4tbGVmdDogMTZweDsKfQoKLmFyZ3MtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5hcmdzLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9CgpAbWVkaWEgKG1heC13aWR0aDogNjQwcHgpLCAobWF4LWhlaWdodDogNjAwcHgpIHsKICAuaGVscC13aW5kb3cgewogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBsZWZ0OiB1bnNldDsKICAgIHRvcDogdW5zZXQ7CiAgICB0cmFuc2Zvcm06IHVuc2V0OwogICAgbWF4LXdpZHRoOiB1bnNldDsKICAgIG1heC1oZWlnaHQ6IHVuc2V0OwogICAgYm94LXNoYWRvdzogdW5zZXQ7CiAgfQp9JwCL/ODwB9yFAQlvbkRlc3Ryb3kCBACL/ODwB4uRARNAdGhpc0JvdC51bm1vdW50KCk7JwCL/ODwB9yFAQVtb3VudAIEAIv84PAHn5EBkwNAY29uc3QgewogICAgYWJDb21tYW5kc01hbmFnZXIsCiAgICBzZWxlY3RlZENvbW1hbmQKfSA9IHRoYXQgPz8ge307CgppZiAobWFza3MuaGVscEFjdGl2ZSkgewogICAgYXdhaXQgdGhpc0JvdC51bm1vdW50KCk7Cn0KCmNvbnN0IEhlbHBBcHAgPSB0aGlzQm90LkhlbHBBcHAoKTsKCmF3YWl0IG9zLnJlZ2lzdGVyQXBwKCdhYi1jb21tYW5kLWhlbHAnLCB0aGlzQm90KTsKYXdhaXQgb3MuY29tcGlsZUFwcCgnYWItY29tbWFuZC1oZWxwJywgPEhlbHBBcHAgY29tbWFuZHM9e2FiQ29tbWFuZHNNYW5hZ2VyLmNvbW1hbmRzfSBpbml0aWFsU2VsZWN0ZWRDb21tYW5kPXtzZWxlY3RlZENvbW1hbmR9Lz4pOwoKdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MgPSBbXTsKbWFza3MuaGVscEFjdGl2ZSA9IHRydWU7JwCL/ODwB9yFAQdIZWxwQXBwAgQAi/zg8AezlAG6L0Bjb25zdCBBcHBDb250YWluZXIgPSBsaW5rcy5jb21wb25lbnRzLkFwcENvbnRhaW5lcigpOwpjb25zdCBXaW5kb3cgPSBsaW5rcy5jb21wb25lbnRzLldpbmRvdygpOwpjb25zdCBUZXh0TGluayA9IGxpbmtzLmNvbXBvbmVudHMuVGV4dExpbmsoKTsKY29uc3QgY3NzID0gbGlua3MudXRpbHMuYWJDb21waWxlQ1NTKFsgdGhpc0JvdCwgbGlua3MuY29tcG9uZW50cyBdKTsKCmNvbnN0IHsgdXNlU3RhdGUsIHVzZUVmZmVjdCwgdXNlQ2FsbGJhY2ssIHVzZVJlZiwgdXNlTWVtbyB9ID0gb3MuYXBwSG9va3M7CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKi8KY29uc3QgQXZhaWxhYmxlQ29tbWFuZHMgPSAoeyBjb21tYW5kcywgb25Db21tYW5kQ2xpY2sgfSkgPT4gewogICAgY29uc3QgY29tbWFuZE5hbWVzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpLnNvcnQoKTsKCiAgICBjb25zdCBvbkNsb3NlID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkNsb3NlfT57J3ggQ2xvc2UnfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+QXZhaWxhYmxlIENvbW1hbmRzPC9oMj4KICAgICAgICAgICAgPHA+VXNhZ2U6IC5jb21tYW5kIFtvcHRpb25zXTwvcD4KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgICAgICB7Y29tbWFuZE5hbWVzLm1hcCgobmFtZSkgPT4gewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQgPSBjb21tYW5kc1tuYW1lXTsKCiAgICAgICAgICAgICAgICAgICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxUZXh0TGluayBvbkNsaWNrPXsoKSA9PiBvbkNvbW1hbmRDbGljayhjb21tYW5kLm5hbWUpfT57Y29tbWFuZC5uYW1lfTwvVGV4dExpbms+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57ZGVzY3JpcHRpb259PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICA8Lz4KICAgICkKfQoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge0NvbW1hbmR9IHByb3BzLmNvbW1hbmQKICovCmNvbnN0IFNwZWNpZmljQ29tbWFuZCA9ICh7IGNvbW1hbmQsIG9uQmFjayB9KSA9PiB7CiAgICBsZXQgdXNhZ2UgPSAnJzsKICAgIGxldCBkZXNjcmlwdGlvbiA9IG51bGw7CiAgICBsZXQgYXJncyA9IG51bGw7CgogICAgaWYgKGNvbW1hbmQuaGVscCkgewogICAgICAgIGlmIChjb21tYW5kLmhlbHAudXNhZ2UpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY29tbWFuZC5oZWxwLnVzYWdlKSkgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2Uuam9pbignXG4nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVzYWdlID0gY29tbWFuZC5oZWxwLnVzYWdlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5sb25nRGVzY3JpcHRpb247CiAgICAgICAgfSBlbHNlIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzICYmIGNvbW1hbmQuaGVscC5hcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgYXJncyA9IGNvbW1hbmQuaGVscC5hcmdzOwogICAgICAgIH0KICAgIH0KICAgIAogICAgcmV0dXJuICgKICAgICAgICA8PiAgCiAgICAgICAgICAgIDxwPjxUZXh0TGluayBvbkNsaWNrPXtvbkJhY2t9PnsnPCBCYWNrJ308L1RleHRMaW5rPjwvcD4KICAgICAgICAgICAgPGgyPntjb21tYW5kLm5hbWV9PC9oMj4KICAgICAgICAgICAgeyB1c2FnZSAmJgogICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0ndXNhZ2UtdGFibGUnPgogICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxoMz5Vc2FnZTo8L2gzPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57dXNhZ2V9PC90ZD4KICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGRlc2NyaXB0aW9uICYmIAogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5EZXNjcmlwdGlvbjo8L2gzPgogICAgICAgICAgICAgICAgICAgIDxwIGNsYXNzTmFtZT0nZGVzY3JpcHRpb24nPntkZXNjcmlwdGlvbn08L3A+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgfQogICAgICAgICAgICB7IGFyZ3MgJiYKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uJz4KICAgICAgICAgICAgICAgICAgICA8aDM+QXJndW1lbnRzOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0nYXJncy10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgICAgIHsgYXJncy5tYXAoKGFyZykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcmcuaWRlbnRpZmllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ0Rlc2NyaXB0aW9uRGlzcGxheSA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllci5qb2luKCcsXG4nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnSWRlbnRpZmllckRpc3BsYXkgPSBhcmcuaWRlbnRpZmllcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLmRlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gYXJnLmRlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2FyZ0lkZW50aWZpZXJEaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnRGVzY3JpcHRpb25EaXNwbGF5ID8/ICcnfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgfSl9CiAgICAgICAgICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIDxici8+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2hlbHAtdGFibGUnPgogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7T2JqZWN0LjxzdHJpbmcsIENvbW1hbmQ+fSBwcm9wcy5jb21tYW5kcwogKiBAcGFyYW0ge2FueVtdfSBbcHJvcHMuYXJnc10KICovCmNvbnN0IEhlbHBBcHAgPSAoeyBjb21tYW5kcywgaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCB9KSA9PiB7CiAgICBjb25zdCBbIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kIF0gPSB1c2VTdGF0ZShpbml0aWFsU2VsZWN0ZWRDb21tYW5kKTsKCiAgICAvLyBFc2NhcGUga2V5IHByZXNzIGV2ZW50IGhhbmRsZXIKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgY29uc3Qgb25Fc2NhcGVLZXlQcmVzcyA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKHNlbGVjdGVkQ29tbWFuZCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MucHVzaChvbkVzY2FwZUtleVByZXNzKTsKCiAgICAgICAgcmV0dXJuICgpID0+IHsKICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tJbmRleCA9IHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLmZpbmRJbmRleCgoY2FsbGJhY2spID0+IGNhbGxiYWNrID09PSBvbkVzY2FwZUtleVByZXNzKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3Muc3BsaWNlKGNhbGxiYWNrSW5kZXgsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgW3NlbGVjdGVkQ29tbWFuZF0pOwogICAgCiAgICBjb25zdCBvbkJhY2tncm91bmRDbGljayA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgIH0sIFtdKTsKCiAgICBjb25zdCBvbkNvbW1hbmRDbGljayA9IHVzZUNhbGxiYWNrKChuYW1lKSA9PiB7CiAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG5hbWUpOwogICAgfSwgW3NldFNlbGVjdGVkQ29tbWFuZF0pCgogICAgY29uc3QgY29udGVudCA9IHVzZU1lbW8oKCkgPT4gewogICAgICAgIGlmICghc2VsZWN0ZWRDb21tYW5kKSB7CiAgICAgICAgICAgIHJldHVybiA8QXZhaWxhYmxlQ29tbWFuZHMgY29tbWFuZHM9e2NvbW1hbmRzfSBvbkNvbW1hbmRDbGljaz17b25Db21tYW5kQ2xpY2t9Lz4KICAgICAgICB9IGVsc2UgeyAKICAgICAgICAgICAgcmV0dXJuIDxTcGVjaWZpY0NvbW1hbmQgY29tbWFuZD17Y29tbWFuZHNbc2VsZWN0ZWRDb21tYW5kXX0gb25CYWNrPXsoKSA9PiBzZXRTZWxlY3RlZENvbW1hbmQobnVsbCl9Lz4KICAgICAgICB9CiAgICB9LCBbY29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCwgc2V0U2VsZWN0ZWRDb21tYW5kXSk7CgogICAgcmV0dXJuICgKICAgICAgICA8PgogICAgICAgICAgICA8c3R5bGU+e2Nzc308L3N0eWxlPgoKICAgICAgICAgICAgPEFwcENvbnRhaW5lciBvbkJhY2tncm91bmRDbGljaz17b25CYWNrZ3JvdW5kQ2xpY2t9PgogICAgICAgICAgICAgICAgPFdpbmRvdz4KICAgICAgICAgICAgICAgICAgICB7Y29udGVudH0KICAgICAgICAgICAgICAgIDwvV2luZG93PgogICAgICAgICAgICA8L0FwcENvbnRhaW5lcj4KICAgICAgICA8Lz4KICAgICkKfQoKcmV0dXJuIEhlbHBBcHA7JwCL/ODwB9yFAQpjb21wb25lbnRzAgQAi/zg8AfuwwEo8J+UlzExYzk1YzdkLWExOTMtNDAwZS1iNzEwLTNiYTA0ODZhNmExYScAi/zg8AfchQEFdXRpbHMCBACL/ODwB5XEASjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCL/ODwB9yFAQhhYklnbm9yZQIEAIv84PAHvMQBBHRydWUnAIv84PAH3IUBB2FiU2hlbGwCBACL/ODwB8HEAQR0cnVlJwCL/ODwB9yFAQlhYlZlcnNpb24CBACL/ODwB8bEAQQxMC4zJwEEYm90cyQzNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMBJwCL/ODwB8vEAQZzeXN0ZW0CBACL/ODwB8zEAQ9hYi5zaGVsbC5jcmVhdGUnAIv84PAHy8QBBGZvcm0CBACL/ODwB9zEAQdub3RoaW5nJwCL/ODwB8vEAQtkZXNjcmlwdGlvbgIEAIv84PAH5MQBPUJvdCB1c2VkIHRvIGNyZWF0ZS9tYW5pZmVzdCBib3RzIGludG8gYW4gYWN0dWFsIHNjZW5lL3BvcnRhbC4nAIv84PAHy8QBDGFiQ3JlYXRlQm90cwIEAIv84PAHosUBtyJALy9jaGVja3MgZm9yIGluaXRpYWwgYm9vdCBib29sZWFuCmxldCBpbml0aWFsQm9vdCA9IHRoYXQuaW5pdGlhbEJvb3Q7Ci8vYm90cyB0byBiZSBnZW5lcmF0ZWQKbGV0IGJvdERhdGEgPSB0aGF0LmJvdHM7Ci8vd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCmxldCBvcmlnaW4gPSB0aGF0Lm9yaWdpbjsKLy93aGF0IHN0dWRpbyBpcyB0aGlzIGRhdGEgZnJvbSAob3B0aW9uYWwpCmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvCi8vdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCmxldCB2ZXJzaW9uID0gdGhhdC52ZXJzaW9uOwovLyBSeWFuIENvb2s6IGFkZGluZyB0aGlzIGFzIGFuIG9wdGlvbmFsIGZsYWcuCmxldCBpZ25vcmVHcmlkRm9jdXMgPSB0aGF0Lmlnbm9yZUdyaWRGb2N1czsKLy9pZE1hcCBhbmQgbmV3Qm90cyBhcmUgdXNlZCB0byBtYW5hZ2UgdGhlIGluY29taW5nIGJvdCBkYXRhCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKCi8vdGhpcyBsb29wIGNyZWF0ZXMgdGhlIG5ldyBib3RzIGFuZCB0aGVuIHBhY2thZ2VzIHRoZW0gZm9yIGFkZGl0aW9uYWwgcHJvY2Vzc2luZywgd2hpbGUgYWRkaW5nIGFueSBuZWVkZWQgYWRkaXRpb25hbCB0YWdzCmZvciAoY29uc3QgcHJvcGVydHkgaW4gYm90RGF0YSkgewogICAgY29uc3QgbmV3Qm90ID0gYm90RGF0YVtwcm9wZXJ0eV07CiAgICBjb25zdCBib3RUb3RhbCA9IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aDsKICAgIGNvbnN0IGFiSURPcmlnaW4gPSB7IGFiSURPcmlnaW46IG9yaWdpbiwgYWJJRFN0dWRpbzogdGhhdC5zdHVkaW8gfTsKICAgIGNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBpZiAobmV3Qm90LnRhZ3MpIHsKICAgICAgICBpZiAobmV3Qm90LnRhZ3MuY3JlYXRvcikgewogICAgICAgICAgICBhYklET3JpZ2luLm9sZENyZWF0b3IgPSBuZXdCb3QudGFncy5jcmVhdG9yOwogICAgICAgIH0KCiAgICAgICAgbGV0IHRhcmdldFBvc2l0aW9uOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBSeWFuIENvb2s6IFRoaXMgdGFyZ2V0UG9zaXRpb24gc3R1ZmYgaXMgYXBwYXJlbnRseSB1c2VkIGZvciBib3QgcGFzdGluZz8gCiAgICAgICAgICAgIC8vIFRoaXMgaXMgc29tZSByZWFsbHkgY29uZnVzaW5nIGxvZ2ljIGFuZCBzaG91bGQgYmUgcmVmYWN0b3JlZCBldmVudHVhbGx5LgogICAgICAgICAgICBpZiAoKGJvdFRvdGFsIDwgMiB8fCBib3RUb3RhbCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXREaW1lbnNpb24gPSBhYkdyaWRGb2N1cy5kaW1lbnNpb247CgogICAgICAgICAgICAgICAgdGFyZ2V0UG9zaXRpb24gPSB7IFt0YXJnZXREaW1lbnNpb25dOiB0cnVlLCBbdGFyZ2V0RGltZW5zaW9uICsgIlgiXTogYWJHcmlkRm9jdXMucG9zaXRpb24ueCwgW3RhcmdldERpbWVuc2lvbiArICJZIl06IGFiR3JpZEZvY3VzLnBvc2l0aW9uLnkgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGIgPSBjcmVhdGUobmV3Qm90LnRhZ3MsIHRhcmdldFBvc2l0aW9uLCBhYklET3JpZ2luKTsKCiAgICAgICAgICAgIGlkTWFwLnNldChib3REYXRhW3Byb3BlcnR5XS5pZCwgYi5pZCk7CiAgICAgICAgICAgIG5ld0JvdHMucHVzaChiKTsKCiAgICAgICAgICAgIGlmIChiLnRhZ3MuY3JlYXRvciA9PSB0aGlzQm90LmlkKSB7CiAgICAgICAgICAgICAgICBiLnRhZ3MuY3JlYXRvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJpbnZhbGlkIGJvdCIsIGVycm9yKTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZygic2tpcHBlZCBib3Q6ICIgKyBuZXdCb3QpOwogICAgfQp9CgovL2FycmF5IG9mIHRhZyByZWxhdGlvbnNoaXBzIHRvIGJlIHByZXNlcnZlZApsZXQgbGlua1RhZ3MgPSBbImxpbmsiLCAiY3JlYXRvciIsICJjb25maWdCb3QiLCAibGluZVRvIiwgInRyYW5zZm9ybWVyIiwgImZvcm1MaWdodFRhcmdldCJdOwoKLy90aGlzIGxvb3AgY29udGFpbnMgdGhlIGxvZ2ljIGZvciBwcmVzZXJ2aW5nIHRoZSBsaW5rVGFncwpmb3IgKGxldCBuZXdCb3Qgb2YgbmV3Qm90cykgewogICAgZm9yIChsZXQgdGFnIG9mIGxpbmtUYWdzKSB7CiAgICAgICAgbGV0IHZhbHVlID0gbmV3Qm90LnRhZ3NbdGFnXTsKCiAgICAgICAgaWYgKHRhZyA9PSAiY3JlYXRvciIpIHsKICAgICAgICAgICAgdmFsdWUgPSBuZXdCb3QudGFncy5vbGRDcmVhdG9yOwogICAgICAgICAgICBuZXdCb3QudGFncy5vbGRDcmVhdG9yID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHVwZGF0ZUJvdExpbmtzKG5ld0JvdCwgaWRNYXApOwoKICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgICAgICAgICBsZXQgbmV3VmFsdWUgPSB2YWx1ZS5tYXAoaWQgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpZE1hcC5nZXQoaWQpIHx8IGlkOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lEID0gaWRNYXAuZ2V0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3SUQpIHsKICAgICAgICAgICAgICAgICAgICBuZXdCb3QucmF3W3RhZ10gPSBuZXdJRDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKLy90b2FzdHMgZm9yIGhhdGNoZXMsIGJ1dCBvbmx5IG9uIGJ1aWxkZXIKaWYgKGNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSA9PSBudWxsICYmICFjb25maWdCb3QudGFncy5waCAmJiBidWlsZGVyVmVyc2lvbiA9PSAiYnVpbGRlciIpIHsKICAgIG9zLnRvYXN0KCJoYXRjaGVkICIgKyBvcmlnaW4gKyAiIHYiICsgdmVyc2lvbik7Cn0KCmlmIChvcmlnaW4pIHsKICAgIGxldCBhYkVnZyA9IHt9OwoKICAgIGFiRWdnLmFiID0gdHJ1ZTsKICAgIGFiRWdnLmFiRWdnID0gdHJ1ZTsKICAgIC8vYWJFZ2cuc3BhY2UgPSAibG9jYWwiOwogICAgYWJFZ2cuYWJJZ25vcmUgPSB0cnVlOwogICAgYWJFZ2cub3JpZ2luX2FiID0gb3JpZ2luOwogICAgYWJFZ2cub3JpZ2luX3ZlcnNpb24gPSB2ZXJzaW9uOwogICAgYWJFZ2cub3JpZ2luX3JlY29yZCA9IHRoYXQucmVjb3JkOwogICAgYWJFZ2cub3JpZ2luX3N0dWRpbyA9IHN0dWRpbzsKICAgIGFiRWdnLmZvcm0gPSAiZWdnIjsKICAgIGFiRWdnLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VDb2xvcjsKICAgIGFiRWdnLmxhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3I7CiAgICBhYkVnZy5sYWJlbCA9IG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uOwogICAgYWJFZ2cuYWJYID0gZ2V0Qm90cygiYWIiKS5sZW5ndGggKiAxLjU7CgogICAgY3JlYXRlKGFiRWdnKTsKfQoKLy9hZGRpdGlvbmFsIGhhdGNoIGRhdGEKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47CgovL2NoZWNrIGFuZCBleGVjdXRlIG9uUHJlSGF0Y2ggY29kZQpmb3IgKGNvbnN0IGhhdGNoaW5nQm90IG9mIG5ld0JvdHMpIHsKICAgIGlmIChoYXRjaGluZ0JvdC50YWdzLm9uUHJlSGF0Y2gpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCBoYXRjaGluZ0JvdC5vblByZUhhdGNoKHsgYWI6IG9yaWdpbiwgdmVyc2lvbjogdmVyc2lvbiB9KTsKICAgICAgICB9CiAgICAgICAgY2F0Y2gKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBvblByZUhhdGNoIG5vdCB2YWxpZCBvbiBib3QgJHtoYXRjaGluZ0JvdC5pZH1gKTsKICAgICAgICB9CiAgICB9Cn0KCi8vaW5pdGlhbCBib290IGxvZ2ljIFdIQVQgSVMgVEhJUz8/PwppZiAoaW5pdGlhbEJvb3QpIHsKICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCID0gb3JpZ2luOwp9CgovL29uRWdnSGF0Y2ggZm9yIGFsbCBqdXN0IGhhdGNoZWQgYm90cwp3aGlzcGVyKG5ld0JvdHMsICJvbkVnZ0hhdGNoIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uOiB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgZWdnUGFyYW1ldGVyczogdGhhdC5lZ2dQYXJhbWV0ZXJzIH0pOwoKLy9vbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbjogdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QgfSk7CgpyZXR1cm4gbmV3Qm90czsnAIv84PAHy8QBCHJlbWVtYmVyAgQAi/zg8Afa5wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAi/zg8AfLxAEJb25BYkFkZGVkAgQAi/zg8AeB6AFdQGNvbnNvbGUubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyB0aGF0LmFiLCAidmVyc2lvbjogIiArIHRoYXQudmVyc2lvbik7JwCL/ODwB8vEAQhhYklnbm9yZQIEAIv84PAH3+gBBHRydWUnAIv84PAHy8QBB2FiU2hlbGwCBACL/ODwB+ToAQR0cnVlJwCL/ODwB8vEAQlhYlZlcnNpb24CBACL/ODwB+noAQQxMC4zJwEEYm90cyQ1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYBJwCL/ODwB+7oAQZzeXN0ZW0CBACL/ODwB+/oARBhYi5zaGVsbC52ZXJzaW9uJwCL/ODwB+7oAQRmb3JtAgQAi/zg8AeA6QEHbm90aGluZycAi/zg8Afu6AEIYWJJZ25vcmUCBACL/ODwB4jpAQR0cnVlJwCL/ODwB+7oAQdhYlNoZWxsAgQAi/zg8AeN6QEEdHJ1ZScAi/zg8Afu6AETYWJTaGVsbE1ham9yVmVyc2lvbgIEAIv84PAHkukBATEnAIv84PAH7ugBE2FiU2hlbGxNaW5vclZlcnNpb24CBACL/ODwB5TpAQE2JwCL/ODwB+7oAQ1vblNraWxsVXBkYXRlAgQAi/zg8AeW6QGXAUBjb25zdCB2ZXJzaW9uU3RyaW5nID0gdGFncy5hYlNoZWxsTWFqb3JWZXJzaW9uICsgIi4iICsgdGFncy5hYlNoZWxsTWlub3JWZXJzaW9uOw0KDQpjb25zb2xlLmxvZygiW0FCU2hlbGxdIExvYWRlZCBBQiBzaGVsbCB2ZXJzaW9uICIgKyB2ZXJzaW9uU3RyaW5nKTsnAIv84PAH7ugBCWFiVmVyc2lvbgIEAIv84PAHruoBBDEwLjMnAQRib3RzJDc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZgEnAIv84PAHs+oBBnN5c3RlbQIEAIv84PAHtOoBDmFiLnNoZWxsLnN0b3JlJwCL/ODwB7PqAQRmb3JtAgQAi/zg8AfD6gEHbm90aGluZycAi/zg8Aez6gELZGVzY3JpcHRpb24CBACL/ODwB8vqAT9UaGlzIHNraWxsIGlzIG1lYW50IHRvIGJlIGEgY29uZmlndXJhYmxlIG1lYW5zIHRvIHB1Ymxpc2ggZGF0YS4nAIv84PAHs+oBD2FiUHVibGlzaFJlY29yZAIEAIv84PAHi+sBsgZAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBwdWJsaWNGYWNpbmcgPSB0aGF0LnB1YmxpY0ZhY2luZzsKbGV0IHJlY29yZERhdGEgPSB0aGF0LmRhdGE7CmxldCByZWNvcmROYW1lID0gdGhhdC5yZWNvcmROYW1lOwpsZXQgZW5kcG9pbnQgPSB0aGF0LmVuZHBvaW50ID8gdGhhdC5lbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKaWYgKCFyZWNvcmREYXRhKQp7CiAgICByZXR1cm4gIm5vIGRhdGEgc3VwcGxpZWQiOwp9CgppZiAocHVibGljRmFjaW5nKQp7CiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbInB1YmxpY1JlYWQiXX0pOwp9CmVsc2UKeyAgICAKICAgIHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHtlbmRwb2ludDogZW5kcG9pbnQsIG1hcmtlcnM6IFtyZWNvcmROYW1lXX0pOwp9CgppZiAocmVjb3JkRGF0YS5zdWNjZXNzKQp7CiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZGF0YSByZWNvcmRlZCB0byAiICsgdXNlclJlY29yZCk7Cn0KZWxzZQp7CiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZGF0YSBmYWlsZWQgdG8gcmVjb3JkIik7Cn0KCnJldHVybiByZWNvcmREYXRhOycAi/zg8Aez6gENYWJQdWJsaXNoRmlsZQIEAIv84PAHvvEBlwdAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBmaWxlID0gdGhhdC5maWxlOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGVOYW1lOwpsZXQgbWltZVR5cGUgPSB0aGF0Lm1pbWVUeXBlOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIWZpbGUpCnsKICAgIHJldHVybiAibm8gZmlsZSBzdXBwbGllZCI7Cn0KCmxldCBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKICAgIAppZiAoIWZpbGVVcGxvYWQuc3VjY2VzcykgCnsKICAgIGlmIChmaWxlVXBsb2FkLmVycm9yQ29kZSA9PSAiZmlsZV9hbHJlYWR5X2V4aXN0cyIpCiAgICB7CiAgICAgICAgYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgYWxyZWFkeSBleGlzdHMgaW4gIiArIHVzZXJSZWNvcmQpOwoKICAgICAgICByZXR1cm4gZmlsZVVwbG9hZDsKICAgIH0KCiAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24odXNlclJlY29yZCk7CgogICAgZmlsZVVwbG9hZCA9IGF3YWl0IG9zLnJlY29yZEZpbGUodXNlclJlY29yZCwgZmlsZSwge2Rlc2NyaXB0aW9uOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlfSk7Cn0KCmlmIChmaWxlVXBsb2FkLnN1Y2Nlc3MpCnsKICAgIGFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIHJlY29yZGVkIHRvICIgKyB1c2VyUmVjb3JkKTsKfQplbHNlCnsKICAgIGFiLmxvZyhhYlJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIGZpbGVVcGxvYWQ7JwCL/ODwB7PqARBhYkNvcmVNZW51QWN0aW9uAgQAi/zg8AfW+AFNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAIv84PAHs+oBC29uU3RvcmVNZW51AgQAi/zg8Aek+QHRkwFAY29uc3QgdGFyZ2V0Qm90cyA9IFsuLi5uZXcgU2V0KGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cyldOwpjb25zdCBwb3NzaWJsZVB1Ymxpc2hCb3QgPSB0YXJnZXRCb3RzPy5sZW5ndGggPiAwID8gdGFyZ2V0Qm90cyA6IGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMgPyBbbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1c10gOiBbXTsKY29uc3QgYmFzZUFCID0gIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMgPyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjogbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cy5pZDsKY29uc3QgYmFzZUJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiBiYXNlQUIsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CmNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IG51bGwsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgZGVmYXVsdHMgPSB7CiAgICBhYk1lbnU6IHRydWUsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIG1hbmFnZXI6ICLwn5SXIiArIHRoaXNCb3QuaWQsCiAgICBtYW5pZmVzdGF0aW9uOiB0YWdzLm1hbmlmZXN0YXRpb24sCiAgICByZW1lbWJlcjogdGFncy5yZW1lbWJlciwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICIwcHgiLAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YAp9CgovLyBDcmVhdGUgZG93bmxvYWQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA5LAogICAgbGFiZWw6ICJkb3dubG9hZCIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiOHB4IiwgICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybUFkZHJlc3M6ICJnZXRfYXBwIiwKICAgIHBvc3NpYmxlQm90OiBnZXRMaW5rKHBvc3NpYmxlUHVibGlzaEJvdCksCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiRG93bmxvYWQoe2Jhc2VBQjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIHBvc3NpYmxlQm90czogbGlua3MucG9zc2libGVCb3R9KTtgCn0pOwoKaWYgKCFhdXRoQm90KSAKewogICAgLy8gQ3JlYXRlIGxvZ2luIG1lc3NhZ2UKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICAgICAgbGFiZWw6ICJwbGVhc2Ugc2lnbiBpbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIsCiAgICAgICAgb25DbGljazogYEAgb3MucmVxdWVzdEF1dGhCb3QoKWAKICAgIH0pOwoKICAgIHJldHVybjsKfQplbHNlIGlmIChhdXRoQm90LnRhZ3Muc3Vic2NyaXB0aW9uVGllciA9PSAiRnJlZVBsYXkiKSAKewogICAgLy8gQ3JlYXRlIHVwZ3JhZGUgc3Vic2NyaXB0aW9uIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAicGxlYXNlIHVwZ3JhZGUgeW91ciBzdWJzY3JpcHRpb24gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIiwKICAgICAgICBmb3JtQWRkcmVzczogImxvY2siCiAgICB9KTsKCiAgICByZXR1cm47Cn0KCgpsZXQgdXNlclN0dWRpb3MgPSBjb25maWdCb3QudGFncy51c2VyX3N0dWRpb3M7CgppZiAoIXVzZXJTdHVkaW9zKSAKewogICAgdXNlclN0dWRpb3MgPSBhd2FpdCBvcy5saXN0VXNlclN0dWRpb3MoKTsKfQoKaWYgKHVzZXJTdHVkaW9zLnN1Y2Nlc3MpIAp7CiAgICBjb25zdCBhY3RpdmVTdHVkaW8gPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKTsKCiAgICBsZXQgYmFzZVN0dWRpbyA9IGF1dGhCb3QuaWQ7CgogICAgaWYgKGJhc2VTdHVkaW8gPT0gYXV0aEJvdC5pZCkgCiAgICB7CiAgICAgICAgYmFzZVN0dWRpbyA9ICJwbGF5ZXIiOwogICAgfQoKICAgIGlmIChhY3RpdmVTdHVkaW8gPT0gLTEgJiYgYmFzZVN0dWRpbyAhPSAicGxheWVyIikgCiAgICB7CiAgICAgICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBiYXNlU3R1ZGlvOwogICAgfQoKICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8gJiYgIWFjdGl2ZVN0dWRpbykgCiAgICB7CiAgICAgICAgY29uc3Qgc3R1ZGlvTWF0Y2ggPSB1c2VyU3R1ZGlvcy5zdHVkaW9zLmZpbmRJbmRleChzdHVkaW8gPT4gc3R1ZGlvLnN0dWRpb0lkID09IGNvbmZpZ0JvdC50YWdzLnN0dWRpbykKCiAgICAgICAgaWYgKHN0dWRpb01hdGNoICE9IC0xKSB7CiAgICAgICAgICAgIGJhc2VTdHVkaW8gPSBiYXNlU3R1ZGlvOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBzdHVkaW9MYWJlbCA9IGFjdGl2ZVN0dWRpbyA9PSAtMSA/IGJhc2VTdHVkaW8gOiB1c2VyU3R1ZGlvcy5zdHVkaW9zW2FjdGl2ZVN0dWRpb10uZGlzcGxheU5hbWU7CgogICAgLy8gQ3JlYXRlIHN0dWRpbyBzZWxlY3QgYnV0dG9uCiAgICBjb25zdCBzdHVkaW9EaXNwbGF5QnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGxhYmVsOiAic3R1ZGlvPSIgKyBzdHVkaW9MYWJlbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNSwKICAgICAgICBzdHVkaW9JbmZvcm1hdGlvbjogdXNlclN0dWRpb3MsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJpbnZlbnRvcnlfMiIsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5zdHVkaW9TZWxlY3QodGFncy5zdHVkaW9JbmZvcm1hdGlvbik7YAogICAgfSk7CgogICAgbWFza3Muc3R1ZGlvU2VsZWN0QnV0dG9uID0gZ2V0TGluayhzdHVkaW9EaXNwbGF5QnV0dG9uKTsKfQoKY29uc3QgdG90YWxCb3RDb3VudCA9IHBvc3NpYmxlUHVibGlzaEJvdC5sZW5ndGggPiAwID8gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGg7CgovLyBDcmVhdGUgcHVibGlzaCBsYWJlbCBidXR0b24KY29uc3QgbGFiZWxCb3QgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGxhYmVsOiBgcHVibGlzaCBwYXR0ZXJuICR7YmFzZUJvdHMubGVuZ3RoID4gMCA/ICIiIDogImFzICJ9JHtiYXNlQUJ9ICgke3RvdGFsQm90Q291bnR9IGJvdCR7YmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICB0b3RhbEJvdHM6IGJhc2VCb3RzLmxlbmd0aCArIG5vbkFCQm90cy5sZW5ndGgsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEsCiAgICBsYWJlbEFsaWdubWVudDogImNlbnRlciIsCiAgICBmb3JtQWRkcmVzczogbnVsbCwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHggOHB4IDBweCAwcHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci10b3Atc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBzaGlmdFN0YXRlOiBmYWxzZSwKICAgIG9uQ2xpY2s6IGBAIGNvbnN0IG1lbnVCb3RzID0gZ2V0Qm90cygnYWJNZW51U29ydE9yZGVyJyk7CgogICAgICAgIGlmICh0YWdzLnNoaWZ0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlVcCIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgd2hpc3BlcihtZW51Qm90cywgIm9uS2V5RG93biIsIHtrZXlzOiBbIlNoaWZ0Il19KTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGFncy5zaGlmdFN0YXRlID0gIXRhZ3Muc2hpZnRTdGF0ZTtgLAogICAgc2NhbGVZOiAiYXV0byIsCiAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBsZXQgdG90YWxCb3RzID0gY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID8gdGhhdC5hYkJvdHMgOiB0aGF0LmFiQm90cyArIHRoYXQubm9uQUJCb3RzOwoKICAgIGNvbnN0IHRvdGFsQm90VmFyID0gdG90YWxCb3RzID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cz8ubGVuZ3RoICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgaWYgKGdldEJvdCgiYWJJRE9yaWdpbiIsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCKSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpLmxlbmd0aDsKCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgYWJCb3RzICsgIiBib3RzKSI7CgogICAgICAgICAgICB0YWdzLnRvdGFsQm90cyA9IGFiQm90czsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoIHBhdHRlcm4gYXMgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICsgIiAoIiArIHRvdGFsQm90cyArIHRvdGFsQm90VmFyICsgIikiOwoKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICAgICAgfSAgIAogICAgfQogICAgZWxzZQogICAgeyAgIAogICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgdGhhdC5hYiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjs7CgogICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgfWAKfSk7CgovLyBDcmVhdGUgZW5jcnlwdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgbGFiZWw6ICJlbmNyeXB0IiwKICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgZW5jcnlwdFN0YXRlOiBmYWxzZSwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MuZW5jcnlwdFN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IHRydWU7CiAgICAgICAgfWAsCn0pOwoKbGV0IGFiQnV0dG9uOwoKaWYgKHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy8gQ3JlYXRlIGluY2x1ZGVCb3RzIGJ1dHRvbgogICAgYWJCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUyLAogICAgICAgIGFiU2VsZWN0aW9uQnV0dG9uOiB0cnVlLAogICAgICAgIGxhYmVsOiBiYXNlQm90cy5sZW5ndGggPiAwICYmIGJhc2VBQiAhPSB1bmRlZmluZWQgPyBgc2VsZWN0ZWQgcGF0dGVybjogJHtiYXNlQUJ9ICgke2Jhc2VCb3RzLmxlbmd0aH0gYm90JHtiYXNlQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgIDogYG5ldyBwYXR0ZXJuICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICdlZ2cnLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYlB1Ymxpc2hTZWxlY3QoKTtgLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhck5vbiA9IHRoYXQubm9uQUJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIGNvbnN0IGJvdFZhckFCID0gdGhhdC5hYkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CgogICAgICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gdGhhdC5hYiArICIgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhck5vbjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJzZWxlY3RlZCBwYXR0ZXJuOiAiICsgdGhhdC5hYiArICIgKCIgKyB0aGF0LmFiQm90cyArIGJvdFZhckFCOwogICAgICAgIH1gCiAgICB9KTsKfQoKaWYgKG5vbkFCQm90cy5sZW5ndGggPiAwICYmIHBvc3NpYmxlUHVibGlzaEJvdD8ubGVuZ3RoIDwgMSkKewogICAgLy9pY2x1ZGUgbmV3IGJvdHMKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxLjUzLAogICAgICAgIGFiQnV0dG9uOiBnZXRMaW5rKGFiQnV0dG9uKSwKICAgICAgICBsYWJlbEJvdDogZ2V0TGluayhsYWJlbEJvdCksCiAgICAgICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgICAgICBsYWJlbDogYGluY2x1ZGUgbmV3ICgke25vbkFCQm90cy5sZW5ndGh9IGJvdCR7bm9uQUJCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3giLAogICAgICAgIHVuY2xhaW1lZFN0YXRlOiBmYWxzZSwKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwoKICAgICAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSBsaW5rcy5hYkJ1dHRvbi50YWdzLmxhYmVsOwoKICAgICAgICAgICAgICAgIGlmIChsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25DbGljazogYEAgY29uc3QgYWJCb3RzID0gZ2V0Qm90cyhieU1vZCh7YWJJRE9yaWdpbjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih0YWdzLnVuY2xhaW1lZFN0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zdCBub25BQkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiBudWxsLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwoKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogbm9uQUJCb3RzLmxlbmd0aH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKCiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IDB9KTsKICAgICAgICAgICAgfWAsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyID0gdGhhdC5ub25BQkJvdHMgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJpbmNsdWRlIG5ldyAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyOwoKICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IHRoYXQuYWI7CgogICAgICAgICAgICBpZighbGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSBwdWJsaWMgYnV0dG9uCmlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgCnsKICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IGZhbHNlOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDIsCiAgICAgICAgbGFiZWw6ICJpc1B1YmxpYyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICAgICAgcHVibGljU3RhdGU6IGZhbHNlLAogICAgICAgIG9uQ2xpY2s6IGBAIGlmKHRhZ3MucHVibGljU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MucHVibGljU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gdHJ1ZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgdmVyc2lvbiBzZWxlY3QgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGxhYmVsOiAndmVyc2lvbkZsYWc9Y3VycmVudCcsCiAgICBmb3JtQWRkcmVzczogJ2FsdF9yb3V0ZScsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgc2hvdXQoJ3Nob3dWZXJzaW9uU2VsZWN0b3InKTtgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmxhYmVsID0gJ3ZlcnNpb25GbGFnPScgKyB0aGF0OwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgYCwKfSk7CgovLyBDdXJyZW50IFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2N1cnJlbnQnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX2NoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSBudWxsOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIEZlZWRiYWNrIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ2ZlZWRiYWNrJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTExLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ2ZlZWRiYWNrJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBTdGFibGUgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnc3RhYmxlJywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEyLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fdW5jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gJ3N0YWJsZSc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gQ3JlYXRlIHB1Ymxpc2ggYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51U29ydE9yZGVyOiA0LAogICAgZm9ybUFkZHJlc3M6ICJlZ2ciLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCAwcHggOHB4IDhweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsICAgICAgICAKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1ib3R0b20tc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gLAogICAgZm9ybTogImlucHV0IiwKICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgIG9uSW5wdXRUeXBpbmc6IGBAIGxpbmtzLmxhYmVsQm90LnRhZ3MubGFiZWwgPSAncHVibGlzaCBwYXR0ZXJuIGFzICcgKyB0aGF0LnRleHQgKyAnICgnICsgbGlua3MubGFiZWxCb3QudGFncy50b3RhbEJvdHMgKyAnIGJvdCcgKyAobGlua3MubGFiZWxCb3QudGFncy50b3RhbEJvdHMgPT0gMSA/ICcpJyA6ICdzKScpO2AsCiAgICBtZW51SXRlbVNob3dTdWJtaXRXaGVuRW1wdHk6IHRydWUsCiAgICB0YXJnZXRCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgIG1lbnVJdGVtVGV4dDogYmFzZUFCLAogICAgb25TdWJtaXQ6IGBACiAgICAgICAgICAgIGlmICh0aGF0LnRleHQgPT0gbnVsbCAmJiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiAmJiAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhhdC50ZXh0ID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CiAgICAgICAgICAgIGNvbnN0IGNvbmZpcm1QdXNoID0gYXdhaXQgb3Muc2hvd0NvbmZpcm0oewogICAgICAgICAgICAgICAgdGl0bGU6ICJjb25maXJtIHB1Ymxpc2giLAogICAgICAgICAgICAgICAgY29udGVudDogInB1Ymxpc2ggIiArIHRoYXQudGV4dCArICIgdG8gIiArIHRhcmdldFN0dWRpbyArICI/IiwKICAgICAgICAgICAgICAgIGNvbmZpcm1UZXh0OiAicHVibGlzaCIsCiAgICAgICAgICAgICAgICBjYW5jZWxUZXh0OiAiY2FuY2VsIgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmICghY29uZmlybVB1c2gpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCA9IHRydWU7CgogICAgICAgICAgICBpZiAodGhhdC50ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaEFCKHthYjogdGhhdC50ZXh0LCBtYW51YWxQdWJsaXNoOiB0cnVlLCBib3Q6IGxpbmtzLnRhcmdldEJvdCwgYmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQn0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3MudG9hc3QoImFiIG5vdCBzcGVjaWZpZWQiKTsKICAgICAgICAgICAgfQogICAgICAgIGAsCiAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCAKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgdGFncy5tZW51SXRlbVRleHQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IHRoYXQuYWI7CiAgICB9YAp9KTsKCmlmIChsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKSAKewogICAgLy8gQ3JlYXRlIGNvcHkgdG8gY2xpcGJvYXJkIGJ1dHRvbgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogOCwKICAgICAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLAogICAgICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICAgICAgfWAsCiAgICAgICAgbGFiZWw6ICJjb3B5IHRvIGNsaXBib2FyZCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJmaWxlX2NvcHkiLAogICAgICAgIHRhcmdldEJvdDogbGlua3MucmVtZW1iZXIudGFncy5hYkJvdEZvY3VzLAogICAgICAgIG9uQ2xpY2s6IGBAIGxldCBzZWxlY3RlZEJvdCA9IGxpbmtzLnRhcmdldEJvdDsKICAgICAgICAgICAgbGV0IHByZXBwZWRCb3QgPSBKU09OLnN0cmluZ2lmeShzZWxlY3RlZEJvdCk7CiAgICAgICAgICAgIGxldCBzdGF0ZSA9IHt9CgogICAgICAgICAgICBzdGF0ZVthYkluc3RNZW1vcnkudGFncy5hYkZvY3VzRGF0YV0gPSBzZWxlY3RlZEJvdDsKCiAgICAgICAgICAgIGxldCBuZXdGaWxlID0ge30KICAgICAgICAgICAgbmV3RmlsZS52ZXJzaW9uID0gMTsKICAgICAgICAgICAgbmV3RmlsZS5zdGF0ZSA9IHN0YXRlOwoKICAgICAgICAgICAgdmFyIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShuZXdGaWxlKTsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGZvcm1hdHRlZEZpbGUpOwoKICAgICAgICAgICAgb3MudG9hc3QoImJvdCBjb3BpZWQgdG8gY2xpcGJvYXJkIik7CgogICAgICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwogICAgICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKICAgICAgICBgLAogICAgfSk7Cn0KZWxzZSAKewogICAgLy8gQ3JlYXRlIHNjYW4gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAxMCwKICAgICAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7ICAgICAgICAgICAgCiAgICAgICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLAogICAgICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICAgICAgfWAsCiAgICAgICAgbGFiZWw6ICJzY2FuIHRvIHB1Ymxpc2giLAogICAgICAgIGZvcm1BZGRyZXNzOiAicXJfY29kZV9zY2FubmVyIiwKICAgICAgICBvbkNsaWNrOiBgQCBjb25maWdCb3QudGFncy5wdWJsaXNoU2NhbiA9IHRydWU7IG9zLm9wZW5RUkNvZGVTY2FubmVyKCk7YCwKICAgIH0pOwp9CgpsZXQgaG9zdEJ1dHRvbiA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVNvcnRPcmRlcjogNTAsCiAgICBhYk1lbnVSZWZyZXNoOiAiQCBkZXN0cm95KHRoaXNCb3QpOyIsCiAgICBmb3JtQWRkcmVzczogImdyb3VwX2FkZCIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvciwKICAgIGxlYXJuOiB0YWdzLmxlYXJuLAogICAgb25DbGljazogYEAgbGlua3MubGVhcm4uYWJDcmVhdGVIb3N0KHRoaXNCb3QpOwogICAgaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkKICAgIHsKICAgICAgICB0YWdzLmxhYmVsID0gJ2dlbmVyYXRpbmcgY29kZSBub3cnOwogICAgfWAsCn07CgppZiAobGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQpIAp7CiAgICBob3N0QnV0dG9uLmxhYmVsID0gImpvaW4gY29kZTogIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElELnN1YnN0cmluZygwLCAzKSArICItIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElELnN1YnN0cmluZygzKTsKfQplbHNlIAp7CiAgICBob3N0QnV0dG9uLmxhYmVsID0gImdlbmVyYXRlIGpvaW4gY29kZSI7Cn0KCmlmIChjb25maWdCb3QudGFncy5zdGF0aWNJbnN0ID09IHVuZGVmaW5lZCkKewogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oaG9zdEJ1dHRvbik7Ly9nZW5lcmF0ZSBhIGhvc3QgYnV0dG9uCn0nAIv84PAHs+oBDmFiQ29yZU1lbnVJY29uAgQAi/zg8AfojAMJaW9zX3NoYXJlJwCL/ODwB7PqAQ9hYkNvcmVNZW51TGFiZWwCBACL/ODwB/KMAwVzaGFyZScAi/zg8Aez6gETYWJDb3JlTWVudVNvcnRPcmRlcgIEAIv84PAH+IwDATMnAIv84PAHs+oBCHJlbWVtYmVyAgQAi/zg8Af6jAMo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAi/zg8Aez6gELYWJQdWJsaXNoQUICBACL/ODwB6GNA7ExQC8vc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiAiIiwga2V5OiAiIiwgdGFyZ2V0OiAiIn0pOwppZiAodGhhdC5hYi5pbmRleE9mKCIgIikgIT0gLTEgfHwgdGhhdC5hYi5pbmRleE9mKCciJykgIT0gLTEpCnsKICAgIG9zLnRvYXN0KCJwYXR0ZXJuIG5hbWVzIG1heSBub3QgY29udGFpbiBzcGFjZXMgb3IgcXVvdGFpb24gbWFya3MsIHBsZWFzZSB0cnkgYWdhaW4uIik7CgogICAgcmV0dXJuOwp9CgphYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogcHVibGlzaGluZyAiICsgdGhhdC5hYik7CgpsZXQgcHJvZ3Jlc3NCdXR0b247CgpzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKLy9jbGVhciBhYiBidWlsZGVyCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKQp7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkKICAgIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgovL3Byb2dyZXNzIGJhciBmb3IgbWFudWFsIHB1Ymxpc2hpbmcgY29uZmlybWF0aW9uCmlmIChjb25maWdCb3QudGFncy5tYW51YWxQdWJsaXNoKQp7CiAgICBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYHVwbG9hZGluZyAke3RoYXQuYWJ9YCk7Cn0KCi8vYWIgdmFyaWFibGVzCmxldCBhYklEID0gdGhhdC5hYjsKbGV0IGtleSA9IHRoYXQua2V5OwpsZXQgdGFyZ2V0ID0gdGhhdC50YXJnZXQgPyB0aGF0LnRhcmdldCA6IHRoYXQuYm90OwpsZXQgcmV0dXJuVHlwZSA9IHRoYXQucmV0dXJuVHlwZTsKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nID8/IGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZzsKbGV0IHN0YXRlID0ge307CmxldCBmb3JtYXR0ZWRGaWxlID0ge307Cgpjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwoKLy90aGlzIGxvZ2ljIGZvcm1hdHMgdGhlIHNwZWNpZmllZCBib3RzIGFuZCBwYWNrYWdlcyB0aGVtIGZvciBwdWJsaXNoaW5nCmlmICghQXJyYXkuaXNBcnJheSh0YXJnZXQpICYmIHRhcmdldCAhPSBudWxsICYmIHRhcmdldCAhPSB1bmRlZmluZWQpCnsKCn0KZWxzZSBpZiAoIXRhcmdldCB8fCB0YXJnZXQubGVuZ3RoIDwgMSkKewogICAgY29uc3QgYmFzZUFCID0gdGhhdC5iYXNlQUIgPz8gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCAmJiBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKQogICAgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYnlNb2Qoe3NwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGwsIGFiSURPcmlnaW46IGFiSUR9KSk7CgogICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IG51bGw7CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy5zZWxlY3RlZEFCICYmIGdldEJvdCgiYWJJRE9yaWdpbiIsIGJhc2VBQikpCiAgICB7CiAgICAgICAgY29uc3QgZWdnQm90cyA9IGdldEJvdHMoYnlNb2Qoe3NwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGwsIGFiSURPcmlnaW46IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUJ9KSk7CiAgICAgICAgY29uc3QgbmV3Qm90cyA9IGdldEJvdHMoYnlNb2Qoe3NwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGwsIGFiSURPcmlnaW46IG51bGx9KSk7CgogICAgICAgIHRhcmdldCA9IFsuLi5lZ2dCb3RzLCAuLi5uZXdCb3RzXTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0YXJnZXQgPSBnZXRCb3RzKGJ5TW9kKHtzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwogICAgfQoKICAgIHNldFRhZyh0YXJnZXQsICJhYklET3JpZ2luIiwgYWJJRCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IG51bGw7CgogICAgaWYgKHRhcmdldC5sZW5ndGggPCAxKQogICAgewogICAgICAgIG9zLnRvYXN0KCJObyBib3RzIGZvdW5kIHRvIHB1Ymxpc2giKTsKCiAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7CgogICAgICAgIHJldHVybjsKICAgIH0KfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgZ2VuZXJhdGluZyBhIGtleSBmb3IgZW5jcnlwdGlvbiAob3B0aW9uYWwpCmlmIChjb25maWdCb3QudGFncy5lbmNyeXB0aW9uKQp7CiAgICBsZXQga2V5Q2hlY2s7CgogICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CgogICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgdGl0bGU6ICdlbnRlciBhIHNlY3JldCBrZXknCiAgICB9KTsKCiAgICBpZiAoa2V5KQogICAgewogICAgICAgIGtleUNoZWNrID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ2NvbmZpcm0gc2VjcmV0IGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBpZiAoa2V5ICE9IGtleUNoZWNrKSB7CiAgICAgICAgaWYgKCFrZXlDaGVjaykKICAgICAgICB7CiAgICAgICAgICAgIG9zLnRvYXN0KCJubyBrZXkgZW50ZXJlZCIpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBvcy50b2FzdCgia2V5cyBkbyBub3QgbWF0Y2giKTsKICAgICAgICB9CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vZm9ybWF0dGluZyBib3RzIGZvciBmaWxlIHN0b3JhZ2UKaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSkgCnsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGN1cnJlbnRCb3RJRCA9IHRhcmdldFtpXS5pZDsKICAgICAgICBsZXQgY3VycmVudEJvdCA9IHRhcmdldFtpXTsKICAgICAgICAKICAgICAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdDsKICAgIH0KfQplbHNlIAp7CiAgICBzdGF0ZVt0YXJnZXQuaWRdID0gdGFyZ2V0Owp9CgovL2NoZWNrcyBmb3IgcHJldmlvdXMgZWdncyBhbmQgcmV0dXJucyBkYXRhIGZvciBwcmV2aW91c2x5IHB1Ymxpc2hlZCBhYidzCmxldCBlZ2dDaGVjayA9IGF3YWl0IHRoaXNCb3QuYWJQcmV2aW91c0VnZ0NoZWNrKHthYklEOiBhYklEfSk7CgovL2FkZCB4cCBib3QgaGVyZQpjb25zdCB4cFZlcnNpb25Cb3QgPSB7fTsKCnhwVmVyc2lvbkJvdC5zcGFjZSA9ICJzaGFyZWQiOwp4cFZlcnNpb25Cb3QuaWQgPSAiYWJYUEJvdCI7CnhwVmVyc2lvbkJvdC50YWdzID0ge307CnhwVmVyc2lvbkJvdC50YWdzLmZvcm0gPSAibm90aGluZyI7CnhwVmVyc2lvbkJvdC50YWdzLnN5c3RlbSA9ICJhYi5wYXR0ZXJuLmFiWFBCb3QiOwp4cFZlcnNpb25Cb3QudGFncy5hdXRob3JJRCA9IGF1dGhCb3QuaWQ7CnhwVmVyc2lvbkJvdC50YWdzLnZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb247CnhwVmVyc2lvbkJvdC50YWdzLnhwID0gbGlua3MubGVhcm4udGFncy5hYlhQOwp4cFZlcnNpb25Cb3QudGFncy5zaWduYXR1cmUgPSBlZ2dDaGVjay5zaWduYXR1cmU7CnhwVmVyc2lvbkJvdC50YWdzLmFiSWdub3JlID0gdHJ1ZTsKCnN0YXRlLmFiWFBCb3QgPSB4cFZlcnNpb25Cb3Q7CgovL2FkZGl0aW9uYWwgZmlsZSBkYXRhCmZvcm1hdHRlZEZpbGUudmVyc2lvbiA9IDE7CmZvcm1hdHRlZEZpbGUuc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwpmb3JtYXR0ZWRGaWxlLnN0YXRlID0gc3RhdGU7CgovL2FjdHVhbCBlbmNyeXB0aW9uIGlmIGNob3NlbgppZiAoa2V5KSAKewogICAgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KGZvcm1hdHRlZEZpbGUpOwoKICAgIGZvcm1hdHRlZEZpbGUgPSBjcnlwdG8uZW5jcnlwdChrZXksIGZvcm1hdHRlZEZpbGUpOwp9CgovL3B1Ymxpc2ggdGhlIGZpbGUKbGV0IHB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHtmaWxlOiBmb3JtYXR0ZWRGaWxlLCBmaWxlTmFtZTogYWJJRH0pOwoKLy9nYXRoZXIgYWRkaW9uYWwgZWdnIGRhdGEKY29uc3QgYWlQZXJtaXRDaGVjayA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdC5pZCwgImFpX3Blcm1pdCIpOwpjb25zdCBhaVBlcm1pdElEID0gYWlQZXJtaXRDaGVjay5zdWNjZXNzID8gYWlQZXJtaXRDaGVjay5kYXRhLnBlcm1pdElEIDogZmFsc2U7CgplZ2dDaGVjay5lZ2dEYXRhLmFpUGVybWl0ID0gYWlQZXJtaXRJRDsKZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5wdXNoKHB1Ymxpc2hGaWxlLnVybCk7CmVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwplZ2dDaGVjay5lZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKCi8vcHVibGlzaCBlZ2cvYWIgcmVjb3JkCmxldCBwdWJsaXNoUmVjb3JkID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hSZWNvcmQoe2RhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogcHVibGljRmFjaW5nfSk7CmxldCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKCi8vcHVibGlzaGluZyBzaG91dApzdXBlclNob3V0KCJvbkFCUHVibGlzaGVkIiwge3N1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsfSk7Ly9SRU1PVkUgVEhJUyBFVkVOVFVBTExZCnN1cGVyU2hvdXQoIm9uQWJQdWJsaXNoZWQiLCB7c3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmx9KTsKCmNvbnN0IHN0dWRpb0xpbmsgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKLy9zZW5kIGRhdGEgYW5kIGZvcm1hdCB1cmwgaWYgZGF0YSBzdWNjZXNzZnVsbHkgc2VudAppZiAocHVibGlzaFJlY29yZC5zdWNjZXNzKQp7CiAgICBjb25zdCBiaW9zID0gcHVibGljRmFjaW5nID8gImZyZWUlMjBpbnN0IiA6ICJsb2NhbCUyMGluc3QiOwogICAgY29uc3QgaW5zdFR5cGUgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiCgogICAgc2V0VGFnTWFzayhsaW5rcy5sZWFybiwgImFiWFAiLCAiMCIsICJsb2NhbCIpOwoKICAgIGlmIChrZXkgJiYgY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCkgCiAgICB7CiAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKHNpdGVPcmlnaW4gKyAiLz9wYXR0ZXJuPSIgKyBhYklEICsgIiZrZXk9IiArIGtleSArICImc3R1ZGlvPSIgKyBzdHVkaW9MaW5rICsgIiZiaW9zPSIgKyBiaW9zKTsKICAgICAgICAKICAgICAgICBvcy50b2FzdChgZW5jcnlwdGVkIGRhdGEgd2l0aCBhICR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmRgKTsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2gpCiAgICB7CiAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKHNpdGVPcmlnaW4gKyAiLz9wYXR0ZXJuPSIgKyBhYklEICsgIiZzdHVkaW89IiArIHN0dWRpb0xpbmsgKyAiJmJpb3M9IiArIGJpb3MpOwoKICAgICAgICBvcy50b2FzdChgJHtpbnN0VHlwZX0gaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZGApOwogICAgfQoKICAgIHRyeSAKICAgIHsKICAgICAgICBhd2FpdCBhbmFseXRpY3MucmVjb3JkRXZlbnQoJ2FiX2VnZ19wdWJsaXNoJywgeyBhYjogYWJJRCwgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggfSk7CiAgICB9CiAgICBjYXRjaCAoZSkgCiAgICB7CiAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICB9Cn0KZWxzZQp7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkKICAgIHsKICAgICAgICBvcy50b2FzdCgicHVibGlzaGluZyBmYWlsZWQsIHBsZWFzZSB0cnkgYWdhaW4iKTsKICAgIH0KCiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogcHVibGlzaGluZyBmYWlsZWQiKTsKICAgIAogICAgY29uc29sZS5sb2cocHVibGlzaFJlY29yZCk7Cn0KCi8vY2xlYXIgcHJvZ3Jlc3MgYmFyCmlmIChwcm9ncmVzc0J1dHRvbikKewogICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCmNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2ggPSBudWxsOwoKcmV0dXJuIHB1Ymxpc2hSZWNvcmQ7JwCL/ODwB7PqAQhhYklnbm9yZQIEAIv84PAH074DBHRydWUnAIv84PAHs+oBCmFiRG93bmxvYWQCBACL/ODwB9i+A7sGQC8vZG93bmxvYWQgYm90cyAoZWl0aGVyIHNlbGVjdGVkIG9yIGFsbCBleHBlcmllbmNlKQpsZXQgZG93bmxvYWRCb3RzOwoKY29uc29sZS5sb2coImRvd25sb2FkIiwgdGhhdCk7CgppZiAoQXJyYXkuaXNBcnJheSh0aGF0LnBvc3NpYmxlQm90cykpCnsKICAgIGlmICh0aGF0LnBvc3NpYmxlQm90cy5sZW5ndGggPiAwKQogICAgewogICAgICAgIGRvd25sb2FkQm90cyA9IHRoYXQucG9zc2libGVCb3RzOwoKICAgICAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZG93bmxvYWRpbmcgYm90cyIpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGRvd25sb2FkQm90cyA9IGdldEJvdHMoYnlNb2QoeyJhYklnbm9yZSI6IG51bGwsICJzcGFjZSI6ICJzaGFyZWQifSkpOwoKICAgICAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZG93bmxvYWRpbmcgaW5zdCIpOwogICAgfSAgICAKfQplbHNlCnsKCgogICAgZG93bmxvYWRCb3RzID0gW3RoYXQucG9zc2libGVCb3RzXTsKCiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZG93bmxvYWRpbmcgYm90Iik7Cn0KCmlmICghQXJyYXkuaXNBcnJheShkb3dubG9hZEJvdHMpKQp7CiAgICBkb3dubG9hZEJvdHMgPSBbZG93bmxvYWRCb3RzXTsKfQoKbGV0IGN1cnJlbnRJbnN0ID0gb3MuZ2V0Q3VycmVudEluc3QoKTsKCm9zLmRvd25sb2FkQm90cyhkb3dubG9hZEJvdHMsIGN1cnJlbnRJbnN0KTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgpsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsnAIv84PAHs+oBDW1hbmlmZXN0YXRpb24CBACL/ODwB5TFAyjwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwCL/ODwB7PqAQRtZW51AgQAi/zg8Ae7xQMo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAi/zg8Aez6gESYWJQcmV2aW91c0VnZ0NoZWNrAgQAi/zg8AfixQOxD0AvL3RoaXMgZnVuY3Rpb24gY2hlY2tzIGZvciBwcmV2aW91cyBlZ2dzIGF0IGEgc3BlY2lmaWVkIGFiLCByZXR1cm5pbmcgYW55IGRhdGEgdGhhdCBpdCBmaW5kcwpjb25zdCBhYklEID0gdGhhdC5hYklEOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBlZ2dIaXN0b3J5OwpsZXQgZWdnSUQ7CmxldCB0YXJnZXRWZXJzaW9uTnVtOwpsZXQgbGFzdEhhc2g7CmxldCBtYXhWZXJzaW9uTnVtOwpsZXQgc3RhYmxlVmVyc2lvbjsKbGV0IGZlZWRiYWNrVmVyc2lvbjsKbGV0IHByZXZpb3VzWFA7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmxldCByZWNvcmRMb29rdXAgPSBhd2FpdCBvcy5nZXREYXRhKHVzZXJSZWNvcmQsIGFiSUQpLmNhdGNoKGUgPT4ge30pOwoKaWYgKHJlY29yZExvb2t1cC5zdWNjZXNzKSAKewogICAgZWdnSGlzdG9yeSA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5OwogICAgZWdnSUQgPSByZWNvcmRMb29rdXAuZGF0YS5lZ2dJRDsKICAgIHByZXZpb3VzWFAgPSByZWNvcmRMb29rdXAuZGF0YS54cCA/PyAwOwogICAgdGFyZ2V0VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKICAgIGxhc3RIYXNoID0gZWdnSGlzdG9yeVt0YXJnZXRWZXJzaW9uTnVtIC0gMV07CiAgICBzdGFibGVWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuc3RhYmxlVmVyc2lvbjsKICAgIGZlZWRiYWNrVmVyc2lvbiA9IHJlY29yZExvb2t1cC5kYXRhLmZlZWRiYWNrVmVyc2lvbjsKICAgIG1heFZlcnNpb25OdW0gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0gCmVsc2UgCnsKICAgIGVnZ0hpc3RvcnkgPSBbXTsKICAgIGVnZ0lEID0gdXVpZCgpOwogICAgdGFyZ2V0VmVyc2lvbk51bSA9IDE7CiAgICBsYXN0SGFzaCA9ICJub25lIjsKICAgIG1heFZlcnNpb25OdW0gPSAxOwogICAgcHJldmlvdXNYUCA9IDA7Cn0KCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9PSAiZmVlZGJhY2siKSAKewogICAgZmVlZGJhY2tWZXJzaW9uID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9CmVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJzdGFibGUiKQp7CiAgICBzdGFibGVWZXJzaW9uID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9Cgpjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CgpsZXQgZWdnID0ge307CgplZ2cuZWdnVmVyc2lvbkhpc3RvcnkgPSBlZ2dIaXN0b3J5OwplZ2cuZWdnRm9ybWF0VmVyc2lvbiA9IGVnZ0lEOwplZ2cudGFyZ2V0VmVyc2lvbiA9IHRhcmdldFZlcnNpb25OdW07CmVnZy5tYXhWZXJzaW9uID0gbWF4VmVyc2lvbk51bTsKZWdnLmxhYmVsID0gInYiK3RhcmdldFZlcnNpb25OdW07CmVnZy5zdGFibGVWZXJzaW9uID0gc3RhYmxlVmVyc2lvbjsKZWdnLmZlZWRiYWNrVmVyc2lvbiA9IGZlZWRiYWNrVmVyc2lvbjsKZWdnLmFiSUQgPSBhYklEOwplZ2cueHAgPSBsaW5rcy5sZWFybi50YWdzLmFiWFA7CgpsZXQgc2lnbmF0dXJlID0ge307CmxldCBkYXRlID0gbmV3IERhdGUoKTsKbGV0IHRpbWUgPSBkYXRlLmdldFRpbWUoKTsKCnNpZ25hdHVyZS5wcmV2aW91c0hhc2ggPSBsYXN0SGFzaDsKc2lnbmF0dXJlLmFiVmVyc2lvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJDb3JlVmVyc2lvbjsKc2lnbmF0dXJlLmVnZ1ZlcnNpb24gPSB0YWdzLmVnZ1VVSUQ7CnNpZ25hdHVyZS5lZ2dWZXJzaW9uTnVtID0gdGFncy5vdm9WZXJzaW9uOwpzaWduYXR1cmUudGltZVN0YW1wID0gdGltZTsKc2lnbmF0dXJlLmNhc3VhbE9TVmVyc2lvbiA9IFtvcy52ZXJzaW9uKCldOwoKcmV0dXJuIHtzaWduYXR1cmU6IHNpZ25hdHVyZSwgZWdnRGF0YTogZWdnfTsnAIv84PAHs+oBD2FiQm90TWVudUFjdGlvbgIEAIv84PAHlNUDTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwCL/ODwB7PqAQ5hYkJvdE1lbnVMYWJlbAIEAIv84PAH4tUDBXNoYXJlJwCL/ODwB7PqAQ1hYkJvdE1lbnVJY29uAgQAi/zg8Afo1QMJaW9zX3NoYXJlJwCL/ODwB7PqARJhYkJvdE1lbnVTb3J0T3JkZXICBACL/ODwB/LVAwMzLjUnAIv84PAHs+oBBWxlYXJuAgQAi/zg8Af21QMo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAi/zg8Aez6gELYWJRUlB1Ymxpc2gCBACL/ODwB53WA8YBQGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gbnVsbDsKCmxldCBzY2FubmVkVVJMOwoKdHJ5IAp7CiAgICBzY2FubmVkVVJMID0gbmV3IFVSTCh0aGF0KTsKfQpjYXRjaCAoZSkgCnsKICAgIHNob3V0KCJhYlB1Ymxpc2hBQiIsIHthYjogdGhhdH0pOwoKICAgIHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiB0aGF0fSk7CgogICAgcmV0dXJuOwp9JwCL/ODwB7PqAQZzZWFyY2gCBACL/ODwB+TXAyjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCL/ODwB7PqAQdhYlNoZWxsAgQAi/zg8AeL2AMEdHJ1ZScAi/zg8Aez6gEMc3R1ZGlvU2VsZWN0AgQAi/zg8AeQ2AOLC0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlN0dWRpb01lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBzdHVkaW9zID0gdGhhdC5zdHVkaW9zOwpjb25zdCB0YXJnZXRTdHVkaW8gPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKY29uc3QgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5hYlN0dWRpb01lbnUgPSB0cnVlOwptZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlN0dWRpb01lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmxhYmVsID0gInBsYXllciBzdHVkaW8iOwptZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0U3R1ZGlvID09IGF1dGhCb3QuaWQgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKbWVudUJ1dHRvbi5zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cm1lbnVCdXR0b24ub25DbGljayA9IGBAIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gdGFncy5zdHVkaW9JRDsKCmxpbmtzLm1hbmFnZXIubGlua3Muc3R1ZGlvU2VsZWN0QnV0dG9uLnRhZ3MubGFiZWwgPSB0YWdzLmxhYmVsOwoKc2hvdXQoImFiU3R1ZGlvTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7YDsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBzdHVkaW9zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlU3R1ZGlvID0gc3R1ZGlvc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0U3R1ZGlvID09IGFjdGl2ZVN0dWRpby5zdHVkaW9JZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gYWN0aXZlU3R1ZGlvLmRpc3BsYXlOYW1lOwogICAgbWVudUJ1dHRvbi5zdHVkaW9JRCA9IGFjdGl2ZVN0dWRpby5zdHVkaW9JZDsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKfScAi/zg8Aez6gEOYWJQdWJsaXNoQXNrSUQCBACL/ODwB5rjA/QEQGxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYHB1Ymxpc2hpbmcgJHt0aGF0LmFza0lEfWApOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmNvbnN0IHBhdHRlcm5JRCA9IHRoYXQucGF0dGVybklEOwpjb25zdCBzdHVkaW9JRCA9IHRoYXQuc3R1ZGlvSUQgPyB0aGF0LnN0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKY29uc3QgcHVibGlzaEFzayA9IGF3YWl0IG9zLnJlY29yZERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIHtwYXR0ZXJuSUQ6IHBhdHRlcm5JRCwgc3R1ZGlvSUQ6IHN0dWRpb0lEfSwge2VuZHBvaW50OiBlbmRwb2ludCwgdXBkYXRlUG9saWN5OiBbYXV0aEJvdC5pZF19KTsKCmlmIChwcm9ncmVzc0J1dHRvbikKewogICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiBwdWJsaXNoQXNrOycAi/zg8Aez6gEFaW5wdXQCBACL/ODwB4/oAyjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwCL/ODwB7PqAQthYkVtYmVkTGluawIEAIv84PAHtugDpANAY29uc3QgYWIgPSB0aGF0ID8gdHJ1ZSA6IGZhbHNlOwpjb25zdCBlbWJlZExpbmsgPSBhYiA/ICJhYj0iICsgdGhhdCA6ICJpbnN0PSIgKyBjb25maWdCb3QudGFncy5pbnN0Owpjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKY29uc3QgZW1iZWRUZXh0ID0gYDwhRE9DVFlQRSBodG1sPgrCoMKgwqDCoDxodG1sPgrCoMKgwqDCoMKgwqDCoMKgPGhlYWQ+PC9oZWFkPgrCoMKgwqDCoMKgwqDCoMKgPGJvZHk+CsKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoDxpZnJhbWUgc3JjPSIke3NpdGVPcmlnaW4gKyAiLz8iICsgZW1iZWRMaW5rfSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iNDAwIiAvPgrCoMKgwqDCoMKgwqDCoMKgPC9ib2R5PgrCoMKgwqDCoDwvaHRtbD5gOwoKcmV0dXJuIGVtYmVkVGV4dDsnAIv84PAHs+oBD2FiUGF0dGVyblVwZGF0ZQIEAIv84PAHr+sD5wRALy9zaG91dCgiYWJQYXR0ZXJuVXBkYXRlIiwge2FiSUQ6IGFiSUQsIHN0dWRpbzpzdHVkaW8/LCBib3RzOiBib3RzP30pOwphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKaWYgKCFhdXRoQm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8gdGhhdC5zdHVkaW8gOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBhYk1hbmlmZXN0ID0gZ2V0Qm90KGJ5TW9kKHthYkVnZzogdHJ1ZSwgb3JpZ2luX2FiOiBhYklEfSkpOwoKaWYgKCFhYk1hbmlmZXN0KQp7CiAgICBzaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGF1dG9IYXRjaDogdHJ1ZX0pOwoKICAgIHJldHVybjsKfQoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBzdHVkaW87Cgpjb25zdCBhYkJvdHMgPSB0aGF0LmJvdHMgPz8gZ2V0Qm90cygiYWJJRE9yaWdpbiIsIGFiSUQpOwoKYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IGFiSUQsIHRhcmdldDogYWJCb3RzLCBwdWJsaWNGYWNpbmc6IHRydWV9KTsnAIv84PAHs+oBF2FiTXVsdGlwbGVCb3RNZW51QWN0aW9uAgQAi/zg8AeX8ANNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAIv84PAHs+oBGmFiTXVsdGlwbGVCb3RNZW51U29ydE9yZGVyAgQAi/zg8Afl8AMBMicAi/zg8Aez6gEVYWJNdWx0aXBsZUJvdE1lbnVJY29uAgQAi/zg8Afn8AMJaW9zX3NoYXJlJwCL/ODwB7PqARZhYk11bHRpcGxlQm90TWVudUxhYmVsAgQAi/zg8Afx8AMFc2hhcmUnAIv84PAHs+oBD2FiUHVibGlzaFNlbGVjdAIEAIv84PAH9/ADiRNALy9zaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJQYXR0ZXJuTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IGFsbEJvdHMgPSBnZXRCb3RzKCJhYklET3JpZ2luIik7CmNvbnN0IGFsbFBhdHRlcm5zID0gWyJuZXcgcGF0dGVybiJdOwoKYm90TG9vcDoKZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxCb3RzLmxlbmd0aDsgaSsrKQp7CiAgICBjb25zdCBhY3RpdmVCb3QgPSBhbGxCb3RzW2ldOwoKICAgIGlmIChhY3RpdmVCb3QudGFncy5hYklnbm9yZSkKICAgIHsKICAgICAgICBjb250aW51ZSBib3RMb29wOwogICAgfQoKICAgIGNvbnN0IHBvc3NpYmxlUGF0dGVybiA9IGFjdGl2ZUJvdC50YWdzLmFiSURPcmlnaW47CgogICAgZm9yIChsZXQgaiA9IDA7IGogPCBhbGxQYXR0ZXJucy5sZW5ndGg7IGorKykKICAgIHsKICAgICAgICBjb25zdCBhY3RpdmVQYXR0ZXJuID0gYWxsUGF0dGVybnNbal07CgogICAgICAgIGlmIChhY3RpdmVQYXR0ZXJuID09IHBvc3NpYmxlUGF0dGVybiApCiAgICAgICAgewogICAgICAgICAgICBjb250aW51ZSBib3RMb29wOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChqID09IGFsbFBhdHRlcm5zLmxlbmd0aCAtIDEpCiAgICAgICAgewogICAgICAgICAgICBhbGxQYXR0ZXJucy5wdXNoKHBvc3NpYmxlUGF0dGVybik7CiAgICAgICAgfQogICAgfQp9Cgpjb25zdCB0YXJnZXRBQiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiUGF0dGVybk1lbnUgPSB0cnVlOwptZW51QnV0dG9uLmFiUGF0dGVybk1lbnVTb3J0T3JkZXIgPSAwOwptZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnJlbWVtYmVyID0gdGFncy5yZW1lbWJlcjsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEBjb25zdCB0b3RhbFBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhieU1vZCh7YWJJRE9yaWdpbjogdGFncy5sYWJlbCwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKY29uc3Qgbm9uUGF0dGVybkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiBudWxsLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwoKc2hvdXQoImFiU2VsZWN0VGl0bGVVcGRhdGUiLCB7YWI6IHRhZ3MubGFiZWwsIGFiQm90czogdG90YWxQYXR0ZXJuQm90cy5sZW5ndGgsIG5vbkFCQm90czogbm9uUGF0dGVybkJvdHMubGVuZ3RofSk7CgpsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSB0YWdzLmxhYmVsID09ICJuZXcgcGF0dGVybiIgPyBudWxsIDogdGFncy5sYWJlbDsKCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgPSB0YWdzLmxhYmVsID09ICJuZXcgcGF0dGVybiIgPyBudWxsIDogdGFncy5sYWJlbDsKCnNob3V0KCJhYlBhdHRlcm5NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKYWxsUGF0dGVybnMuc29ydCgpOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhbGxQYXR0ZXJucy5sZW5ndGg7IGkrKykKewogICAgbGV0IGFjdGl2ZVBhdHRlcm5OYW1lID0gYWxsUGF0dGVybnNbaV07CgogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IHRhcmdldEFCID09IGFjdGl2ZVBhdHRlcm5OYW1lID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVQYXR0ZXJuTmFtZTsKCiAgICBpZiAoYWN0aXZlUGF0dGVybk5hbWUgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBtZW51QnV0dG9uLmFiUGF0dGVybk1lbnVTb3J0T3JkZXIgPSAtMTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBtZW51QnV0dG9uLmFiUGF0dGVybk1lbnVTb3J0T3JkZXIgPSBpOwogICAgfQoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9CgppZiAoIWdldEJvdChieU1vZCh7YWJQYXR0ZXJuTWVudTogdHJ1ZSwgZm9ybUFkZHJlc3M6ICJyYWRpb19idXR0b25fY2hlY2tlZCJ9KSkpCnsKICAgIGNvbnN0IG5ld0JvdCA9IGdldEJvdChieU1vZCh7YWJQYXR0ZXJuTWVudTogdHJ1ZSwgbGFiZWw6ICJuZXcgcGF0dGVybiJ9KSk7CiAgICAKICAgIG5ld0JvdC50YWdzLmZvcm1BZGRyZXNzID0gInJhZGlvX2J1dHRvbl9jaGVja2VkIjsKfScAi/zg8Aez6gEJYWJWZXJzaW9uAgQAi/zg8Af/gwQEMTAuMycBBGJvdHMkNzhlNDE1MDMtYzkzMy00ZjhhLTgxN2EtYmE5N2JmOGQ1ZDI3AScAi/zg8AeEhAQGc3lzdGVtAgQAi/zg8AeFhAQRYWIuc2hlbGwuYXJ0aWZhY3QnAIv84PAHhIQECGFiSWdub3JlAgQAi/zg8AeXhAQEdHJ1ZScAi/zg8AeEhAQJYWJWZXJzaW9uAgQAi/zg8AechAQEMTAuMycAi/zg8AeEhAQFZGVidWcCBACL/ODwB6GEBAR0cnVlJwCL/ODwB4SEBAhyZW1lbWJlcgIEAIv84PAHpoQEKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAIv84PAHhIQEE2FiQ3JlYXRlQXJ0aWZhY3RCb3QCBACL/ODwB82EBMAuQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0TmFtZSwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUcgPSAnb25BQkNvbGxlY3RBcnRpZmFjdFNoYXJkcyc7CmNvbnN0IEFSVElGQUNUX0RFUEVOREVOQ0lFU19UQUcgPSAnYWJBcnRpZmFjdERlcGVuZGVuY2llcyc7CgpmdW5jdGlvbiBsb2dBbmRUb2FzdChtZXNzYWdlLCBsb2dUeXBlID0gJ2xvZycpIHsKICAgIGlmIChsb2dUeXBlID09PSAnbG9nJykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV1gLCBtZXNzYWdlKTsKICAgICAgICBvcy50b2FzdChtZXNzYWdlLCA1KTsKICAgIH0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ3dhcm5pbmcnKSB7CiAgICAgICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV1gLCBtZXNzYWdlKTsKICAgICAgICBvcy50b2FzdChgV2FybmluZzogJHttZXNzYWdlfWAsIDUpOwogICAgfSBlbHNlIGlmIChsb2dUeXBlID09PSAnZXJyb3InKSB7CiAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dYCwgbWVzc2FnZSk7CiAgICAgICAgb3MudG9hc3QoYEVycm9yOiAke21lc3NhZ2V9YCwgNSk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUuZXJyb3IoYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9LmxvZ0FuZFRvYXN0XSBsb2dUeXBlICcke2xvZ1R5cGV9JyBpcyBub3Qgc3VwcG9ydGVkLiBGYWxsaW5nIGJhY2sgdG8gJ2xvZycgdHlwZS5gKQogICAgICAgIGxvZ0FuZFRvYXN0KG1lc3NhZ2UsICdsb2cnKTsKICAgIH0KfQogICAgCmNvbnN0IGFydGlmYWN0Qm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgIHJldHVybiBiLnRhZ3MuYWJBcnRpZmFjdE5hbWUgPT09IGFiQXJ0aWZhY3ROYW1lICYmCiAgICAgICAgICAgIWIudGFncy5hcnRpZmFjdCAvLyBJZ25vcmUgYW55IGFydGlmYWN0IGJvdHMgdGhlbXNlbHZlcy4KfSk7CgpsZXQgc2hhcmRzID0ge307CmxldCBkZXBlbmRlbmNpZXMgPSBbXTsKCmZvciAoY29uc3QgYXJ0aWZhY3RCb3Qgb2YgYXJ0aWZhY3RCb3RzKSB7CiAgICBjb25zdCBib3RTaG9ydElkID0gYXJ0aWZhY3RCb3QuaWQuc3Vic3RyaW5nKDAsIDUpOwogICAgY29uc3Qgc2hhcmQgPSBhd2FpdCB3aGlzcGVyKGFydGlmYWN0Qm90LCBBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUcsIHsgYWJBcnRpZmFjdE5hbWUgfSlbMF07CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBzaGFyZDpgLCBzaGFyZCk7CiAgICB9CgogICAgaWYgKHNoYXJkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzaGFyZCAhPT0gJ29iamVjdCcgfHwgQXJyYXkuaXNBcnJheShzaGFyZCkpIHsKICAgICAgICAgICAgbG9nQW5kVG9hc3QoYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBtdXN0IHJldHVybiBhbiBvYmplY3QgZnJvbSBAJHtBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUd9YCwgJ2Vycm9yJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNoYXJkcyA9IHsgLi4uc2hhcmRzLCAuLi5zaGFyZCB9OwogICAgfQoKICAgIGNvbnN0IGRlcHMgPSBhcnRpZmFjdEJvdC50YWdzW0FSVElGQUNUX0RFUEVOREVOQ0lFU19UQUddOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgZGVwczpgLCBkZXBzKTsKICAgIH0KCiAgICBpZiAoZGVwcykgewogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShkZXBzKSkgewogICAgICAgICAgICBsb2dBbmRUb2FzdChgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIHRhZyAke0FSVElGQUNUX0RFUEVOREVOQ0lFU19UQUd9IG11c3QgYmUgYW4gYXJyYXkuYCwgJ2Vycm9yJyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAoY29uc3QgZGVwIG9mIGRlcHMpIHsKICAgICAgICAgICAgLy8gVmFsaWRhdGUgZGVwZW5kZW5jeSBmb3JtYXQuCiAgICAgICAgICAgIGlmICghZGVwLnJlY29yZEtleSkgewogICAgICAgICAgICAgICAgbG9nQW5kVG9hc3QoYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyB0YWcgJHtBUlRJRkFDVF9ERVBFTkRFTkNJRVNfVEFHfSBlbnRyaWVzIG11c3QgY29udGFpbiAncmVjb3JkS2V5Jy5gLCAnZXJyb3InKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFkZXAuYWJJRCkgewogICAgICAgICAgICAgICAgbG9nQW5kVG9hc3QoYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyB0YWcgJHtBUlRJRkFDVF9ERVBFTkRFTkNJRVNfVEFHfSBlbnRyaWVzIG11c3QgY29udGFpbiAnYWJJRCcuYCwgJ2Vycm9yJyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGRlcGVuZGVuY3kgaXNudCBhbHJlYWR5IGNvbGxlY3RlZC4KICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyeXB0by5zaGEyNTYoZGVwKTsKICAgICAgICAgICAgY29uc3QgY29udGFpbnMgPSBkZXBlbmRlbmNpZXMuc29tZShkID0+IGNyeXB0by5zaGEyNTYoZCkgPT09IGhhc2gpOyAvLyBUT0RPOiBDYW4gb3B0aW1pemUgd2l0aCBtYXAvZGljdCBpbnN0ZWFkIG9mIGFycmF5LgoKICAgICAgICAgICAgaWYgKCFjb250YWlucykgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBhZGRpbmcgZGVwOmAsIGRlcCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLnB1c2goZGVwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdE5hbWV9LCBzaGFyZHM6YCwgc2hhcmRzLCAnZGVwZW5kZW5jaWVzOicsIGRlcGVuZGVuY2llcyk7Cn0KCmNvbnN0IGhhdmVBcnRpZmFjdERhdGEgPSBPYmplY3Qua2V5cyhzaGFyZHMpLmxlbmd0aCA+IDA7CgppZiAoaGF2ZUFydGlmYWN0RGF0YSkgewogICAgY29uc3QgYXJ0aWZhY3RNb2QgPSB7fTsKCiAgICBhcnRpZmFjdE1vZC5zcGFjZSA9ICdzaGFyZWQnOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdCA9IHRydWU7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0TmFtZSA9IGFiQXJ0aWZhY3ROYW1lOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdERhdGEgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShzaGFyZHMpOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdERlcGVuZGVuY2llcyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGRlcGVuZGVuY2llcyk7CgogICAgLy8gQ3JlYXRlIGFuZCBzdG9yZSBhIGhhc2ggb2YgYXJ0aWZhY3QncyBjb250ZW50LgogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdEhhc2ggPSBjcnlwdG8uc2hhMjU2KGFydGlmYWN0TW9kKTsKICAgIAogICAgLy8gRXh0cmEgdGFncyBmb3Igc3lzdGVtIHBvcnRhbCBhbmQgb3RoZXIgbWV0YWRhdGEuCiAgICBhcnRpZmFjdE1vZC5zeXN0ZW0gPSBgYWJBcnRpZmFjdC4ke2FiQXJ0aWZhY3ROYW1lfS0ke2FydGlmYWN0TW9kLmFiQXJ0aWZhY3RIYXNoLnN1YnN0cmluZygwLCA3KX1gOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdENhc3VhbE9TVmVyc2lvbiA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KG9zLnZlcnNpb24oKSk7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiA9IDE7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0Q3JlYXRlZFRpbWVzdGFtcCA9IERhdGVUaW1lLm5vdygpOwogICAgYXJ0aWZhY3RNb2QuYWJWZXJzaW9uID0gdGFncy5hYlZlcnNpb247CgogICAgLy8gU2V0dXAgYXJ0aWZhY3QncyBsb2FkaW5nIGxvZ2ljLgogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQgPSBmYWxzZTsKICAgIGFydGlmYWN0TW9kLmFiQXJ0aWZhY3REZWJ1ZyA9IHRhZ3MuZGVidWc7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0VG9vbCA9IGdldExpbmsodGhpc0JvdCk7CiAgICBhcnRpZmFjdE1vZC5vbkNyZWF0ZSA9IGBACiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7CiAgICAgICAgdGFncy5vbkNyZWF0ZSA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3REZWJ1ZykgewogICAgICAgICAgICBjb25zdCBsb2dNYXJrZXIgPSAnWycgKyB0YWdzLnN5c3RlbSArICddJzsKICAgICAgICAgICAgY29uc29sZS5sb2cobG9nTWFya2VyLCAnbWFya2VkIGFydGlmYWN0IGFzIGxvYWRlZCBvbiBjcmVhdGUgc28gdGhhdCBpdCBkb2VzbnQgbG9hZCByaWdodCBhd2F5Jyk7CiAgICAgICAgfQogICAgYDsKICAgIGFydGlmYWN0TW9kLm9uQm90QWRkZWQgPSBgQAogICAgICAgIGlmIChnbG9iYWxUaGlzLmFiKSB7CiAgICAgICAgICAgIHRoaXNCb3QuX3JlY29uc3RpdHV0ZSgpOwogICAgICAgIH0KICAgIGA7CiAgICBhcnRpZmFjdE1vZC5vbkFCSW5pdGlhbGl6ZWQgPSBgQAogICAgICAgIHRoaXNCb3QuX3JlY29uc3RpdHV0ZSgpOwogICAgYDsKICAgIGFydGlmYWN0TW9kLl9yZWNvbnN0aXR1dGUgPSBgQAogICAgICAgIGNvbnN0IGxvZ01hcmtlciA9ICdbJyArIHRhZ3Muc3lzdGVtICsgJ10nOwoKICAgICAgICBpZiAoIWxpbmtzLmFiQXJ0aWZhY3RUb29sKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3REZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2cobG9nTWFya2VyLCAnYXJ0aWZhY3QgdG9vbCBub3QgZm91bmQsIGFkYXB0aW5nIGFiIHdpdGggYWN0aW9uJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBhYi5hYkFkYXB0KCJhYlNoZWxsIik7CgogICAgICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobG9nTWFya2VyLCAnZmFpbGVkIHRvIGFkYXB0IGFiIHdpdGggYWJTaGVsbCcpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWxpbmtzLmFiQXJ0aWZhY3RUb29sKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGxvZ01hcmtlciwgJ2ZhaWxlZCB0byBmaW5kIGFiQXJ0aWZhY3RUb29sJyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZSh7IGFiQXJ0aWZhY3RCb3Q6IHRoaXNCb3QgfSkKICAgIGA7CgogICAgY29uc3QgYXJ0aWZhY3RCb3QgPSBjcmVhdGUoYXJ0aWZhY3RNb2QpOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDpgLCBhcnRpZmFjdEJvdCk7CiAgICB9CgogICAgcmV0dXJuIGFydGlmYWN0Qm90Owp9JwCL/ODwB4SEBA1tYW5pZmVzdGF0aW9uAgQAi/zg8AeIswQo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAi/zg8AeEhAQgYWJBcHBseUFydGlmYWN0TWFuaWZlc3RhdGlvblRhZ3MCBACL/ODwB6+zBLgIQGNvbnN0IHsgCiAgICBhYkFydGlmYWN0Qm90LAogICAgZGltZW5zaW9uID0gY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbCA/PyAnaG9tZScsCiAgICBwb3NpdGlvbiA9IG5ldyBWZWN0b3IzKDAsIDAsIDApLAogICAgY3VzdG9tVGFncyA9IHt9Cn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3RCb3QsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJvdCBpcyBhIHJlcXVpcmVkIHBhcmFtZXRlci5gKTsKYXNzZXJ0KGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCmFiQXJ0aWZhY3RCb3QudGFnc1tkaW1lbnNpb25dID0gdHJ1ZTsKYWJBcnRpZmFjdEJvdC50YWdzW2Ake2RpbWVuc2lvbn1YYF0gPSBwb3NpdGlvbi54OwphYkFydGlmYWN0Qm90LnRhZ3NbYCR7ZGltZW5zaW9ufVlgXSA9IHBvc2l0aW9uLnk7CmFiQXJ0aWZhY3RCb3QudGFnc1tgJHtkaW1lbnNpb259WmBdID0gcG9zaXRpb24uejsKYWJBcnRpZmFjdEJvdC50YWdzLmxhYmVsID0gYCR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lfSBhcnRpZmFjdGA7CmFiQXJ0aWZhY3RCb3QudGFncy5vbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUgPSBgQAogICAgY29uc3QgeyBhYkFydGlmYWN0TmFtZSB9ID0gdGhhdDsKICAgIAogICAgaWYgKGFiQXJ0aWZhY3ROYW1lICE9PSB0YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2Zvcm0nLCAnbm90aGluZycsICdzaGFyZWQnKTsKICAgIHNldFRhZ01hc2sodGhpc0JvdCwgJ2xhYmVsJywgJyAnLCAnc2hhcmVkJyk7CmAKCmZvciAoY29uc3QgdGFnTmFtZSBpbiBjdXN0b21UYWdzKSB7CiAgICBhYkFydGlmYWN0Qm90cy50YWdzW3RhZ05hbWVdID0gY3VzdG9tVGFnc1t0YWdOYW1lXTsKfQoKcmV0dXJuIGFiQXJ0aWZhY3RCb3Q7JwCL/ODwB4SEBBZhYkFydGlmYWN0UmVjb25zdGl0dXRlAgQAi/zg8AfouwS9EEBjb25zdCB7IAogICAgYWJBcnRpZmFjdEJvdCwKICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdEJvdCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0Qm90IGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQoYWJBcnRpZmFjdEJvdC5zcGFjZSAmJiBhYkFydGlmYWN0Qm90LnRhZ3MsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdEJvdCBpcyBhIHJlcXVpcmVkIHRvIGJlIGEgQm90LmApOwoKY29uc3QgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gPSBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEZvcm1hdFZlcnNpb247CgppZiAoYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gPT09IDEpIHsKICAgIGlmIChhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQpIHsKICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7YWJBcnRpZmFjdEJvdC50YWdzLnN5c3RlbX0gaXMgYWxyZWFkeSByZWNvbnNpdGl0dXRlZC5gKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0RGVwZW5kZW5jaWVzOwoKICAgIGZvciAoY29uc3QgZGVwIG9mIGRlcGVuZGVuY2llcykgewogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICAgICAgICAgIGFiSUQ6IGRlcC5hYklELAogICAgICAgICAgICByZWNvcmRLZXk6IGRlcC5yZWNvcmRLZXksCiAgICAgICAgICAgIGFiVmVyc2lvbjogZGVwLmFiVmVyc2lvbiwKICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgIH0pCgogICAgICAgIGlmIChyZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc3QgbG9nTWVzc2FnZSA9IGAke2FiQXJ0aWZhY3RCb3QudGFncy5zeXN0ZW19IGxvYWRlZCBkZXBlbmRlbmN5IGFiSUQ6ICR7ZGVwLmFiSUR9LCBhYlZlcnNpb246ICR7ZGVwLmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gOwogICAgICAgICAgICAgICAgYWIubG9nKGxvZ01lc3NhZ2UpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke2xvZ01lc3NhZ2V9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgJHthYkFydGlmYWN0Qm90LnRhZ3Muc3lzdGVtfSBmYWlsZWQgdG8gbG9hZCBkZXBlbmRlbmN5IGFiSUQ6ICR7ZGVwLmFiSUR9LCBhYlZlcnNpb246ICR7ZGVwLmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gOwogICAgICAgICAgICBhYi5sb2coZXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7ZXJyb3JNZXNzYWdlfWApOwogICAgICAgIH0KICAgIH0KCiAgICBzaG91dChgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlYCwgewogICAgICAgIGFiQXJ0aWZhY3ROYW1lOiBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdE5hbWUsCiAgICAgICAgYWJBcnRpZmFjdERhdGE6IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0RGF0YSwKICAgICAgICBhYkFydGlmYWN0Qm90OiBhYkFydGlmYWN0Qm90CiAgICB9KQoKICAgIGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0UmVjb25zdGl0dXRlZCA9IHRydWU7CiAgICAKICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lfScgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC5gOwogICAgYWIubG9nKGxvZ01lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSB7CiAgICAgICAgb3MudG9hc3QobG9nTWVzc2FnZSk7CiAgICB9Cn0gZWxzZSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uICR7YWJBcnRpZmFjdEZvcm1hdFZlcnNpb259IGlzIG5vdCBpbXBsZW1lbnRlZCBpbiAke3RhZ05hbWV9LmApOwp9CicAi/zg8AeEhAQXYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24CBACL/ODwB6bMBAExJwCL/ODwB4SEBAZzZWFyY2gCBACL/ODwB6jMBCjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCL/ODwB4SEBAdhYlNoZWxsAgQAi/zg8AfPzAQEdHJ1ZScAi/zg8AeEhAQRX2FiR3JpZE1lbnVBY3Rpb24CBACL/ODwB9TMBMwPQC8vIEZpbmQgYWxsIHRoZSB1bmlxdWUgYWJBcnRpZmFjdE5hbWVzIGluIHRoZSBpbnN0LgpsZXQgYWJBcnRpZmFjdE5hbWVzID0gbmV3IFNldCgpOwoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSAmJiAhYi50YWdzLmFiQXJ0aWZhY3QpIHsgCiAgICAgICAgYWJBcnRpZmFjdE5hbWVzLmFkZChiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpOwogICAgfQp9KQoKaWYgKGFiQXJ0aWZhY3ROYW1lcy5zaXplID4gMCkgewogICAgLy8gTGV0IHRoZSB1c2VyIGNob29zZSB3aGljaCBhcnRpZmFjdCB0aGV5IHdvdWxkIGxpa2UgdG8gZ2VuZXJhdGUuCiAgICBhYkFydGlmYWN0TmFtZXMgPSBBcnJheS5mcm9tKGFiQXJ0aWZhY3ROYW1lcyk7CiAgICBhYkFydGlmYWN0TmFtZXMuc29ydCgpOyAvLyBTb3J0IGFydGlmYWN0IG5hbWVzIGFscGhhYmV0aWNhbGx5LgoKICAgIC8vIENvbnZlcnQgYXJ0aWZhY3QgbmFtZXMgaW50byBpbnB1dCBvcHRpb25zLgogICAgbGV0IGFydGlmYWN0T3B0aW9ucyA9IGFiQXJ0aWZhY3ROYW1lcy5tYXAoKG5hbWUsIGluZGV4KSA9PiB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgbGFiZWw6IG5hbWUsCiAgICAgICAgICAgIHZhbHVlOiBuYW1lCiAgICAgICAgfQogICAgfSkKCiAgICAvLyBGaW5kIChpZiBhbnkpIHRoZSBpbmRleGVzIG9mIHByZXZpb3VzbHkgc2VsZWN0ZWQgYXJ0aWZhY3RzLgogICAgbGV0IHByZXZTZWxlY3RlZEluZGV4ZXMgPSBbXTsKICAgIGlmIChtYXNrcy5wcmV2U2VsZWN0ZWRJdGVtcykgewogICAgICAgIGZvciAoY29uc3QgcHJldlNlbGVjdGVkSXRlbSBvZiBtYXNrcy5wcmV2U2VsZWN0ZWRJdGVtcykgewogICAgICAgICAgICBjb25zdCBpbmRleCA9IGFydGlmYWN0T3B0aW9ucy5maW5kSW5kZXgobyA9PiBvLnZhbHVlID09PSBwcmV2U2VsZWN0ZWRJdGVtLnZhbHVlKTsKICAgICAgICAgICAgaWYgKGluZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIHByZXZTZWxlY3RlZEluZGV4ZXMucHVzaChpbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgY29uc3Qgc2VsZWN0ZWRJdGVtcyA9IGF3YWl0IG9zLnNob3dJbnB1dChwcmV2U2VsZWN0ZWRJbmRleGVzLCB7CiAgICAgICAgdGl0bGU6ICdDaG9vc2UgYXJ0aWZhY3RzIHRvIG1ha2UnLAogICAgICAgIHR5cGU6ICdsaXN0JywKICAgICAgICBzdWJ0eXBlOiAnbXVsdGlTZWxlY3QnLAogICAgICAgIGl0ZW1zOiBhcnRpZmFjdE9wdGlvbnMsCiAgICAgICAgcGxhY2Vob2xkZXI6ICdDaG9vc2UgYXJ0aWZhY3RzJywKICAgIH0pOwoKICAgIG1hc2tzLnByZXZTZWxlY3RlZEl0ZW1zID0gc2VsZWN0ZWRJdGVtczsKCiAgICBpZiAoc2VsZWN0ZWRJdGVtcyAmJiBzZWxlY3RlZEl0ZW1zLmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBhYkdyaWRGb2N1cyA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkRm9jdXM7CiAgICAgICAgCiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEl0ZW1zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNvbnN0IGFiQXJ0aWZhY3ROYW1lID0gc2VsZWN0ZWRJdGVtc1tpXS52YWx1ZTsKICAgICAgICAgICAgY29uc3QgYWJBcnRpZmFjdEJvdCA9IGF3YWl0IHRoaXNCb3QuYWJDcmVhdGVBcnRpZmFjdEJvdCh7IGFiQXJ0aWZhY3ROYW1lIH0pOwoKICAgICAgICAgICAgaWYgKGFiQXJ0aWZhY3RCb3QpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QuYWJBcHBseUFydGlmYWN0TWFuaWZlc3RhdGlvblRhZ3MoewogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCb3QsCiAgICAgICAgICAgICAgICAgICAgZGltZW5zaW9uOiBhYkdyaWRGb2N1cy5kaW1lbnNpb24sCiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IG5ldyBWZWN0b3IzKGFiR3JpZEZvY3VzLnBvc2l0aW9uLngsIGFiR3JpZEZvY3VzLnBvc2l0aW9uLnksIGkpLAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfScAi/zg8AeEhAQUX2FiQm90TWVudU9uR2VuZXJhdGUCBACL/ODwB6HcBKoCQGNvbnN0IGZvY3VzZWRCb3QgPSBhYi5saW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzOwoKaWYgKGZvY3VzZWRCb3QudGFncy5hYkFydGlmYWN0TmFtZSAmJiAhZm9jdXNlZEJvdC50YWdzLmFiQXJ0aWZhY3QpIHsKICAgIHRhZ3MubGFiZWwgPSBgbWFrZSAnJHtmb2N1c2VkQm90LnRhZ3MuYWJBcnRpZmFjdE5hbWV9JyBhcnRpZmFjdGAKfSBlbHNlIHsKICAgIC8vIEZvY3VzZWQgYm90IGlzbnQgcGFydCBvZiBhbiBhcnRpZmFjdCwgZGVzdHJveSB0aGlzIGFiIG1lbnUgYm90LgogICAgZGVzdHJveSh0aGlzQm90KTsKfScAi/zg8AeEhAQQX2FiQm90TWVudUFjdGlvbgIEAIv84PAHzN4EqARAY29uc3QgZm9jdXNlZEJvdCA9IGFiLmxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXM7CgppZiAoZm9jdXNlZEJvdCkgewogICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBmb2N1c2VkQm90LnRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICBjb25zdCBhYkFydGlmYWN0Qm90ID0gYXdhaXQgdGhpc0JvdC5hYkNyZWF0ZUFydGlmYWN0Qm90KHsgYWJBcnRpZmFjdE5hbWUgfSk7CgogICAgaWYgKGFiQXJ0aWZhY3RCb3QpIHsKICAgICAgICBjb25zdCBkaW1lbnNpb24gPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQWN0aXZlRGltZW5zaW9uID8/ICdob21lJzsKICAgICAgICBjb25zdCBmb2N1c2VkQm90UG9zaXRpb24gPSBnZXRCb3RQb3NpdGlvbihmb2N1c2VkQm90LCBkaW1lbnNpb24pOwoKICAgICAgICB0aGlzQm90LmFiQXBwbHlBcnRpZmFjdE1hbmlmZXN0YXRpb25UYWdzKHsKICAgICAgICAgICAgYWJBcnRpZmFjdEJvdCwKICAgICAgICAgICAgZGltZW5zaW9uLAogICAgICAgICAgICBwb3NpdGlvbjogZm9jdXNlZEJvdFBvc2l0aW9uLAogICAgICAgIH0pCiAgICB9Cn0nAQRib3RzJDkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YwEnAIv84PAH9eIEBnN5c3RlbQIEAIv84PAH9uIEDmFiLnNoZWxsLnV0aWxzJwCL/ODwB/XiBAxhYkNvbXBpbGVDU1MCBACL/ODwB4XjBIIEQGxldCBib3RzID0gdGhhdDsKCmJvdHMgPSBBcnJheS5pc0FycmF5KGJvdHMpID8gYm90cyA6IFtib3RzXTsKCmxldCBjc3MgPSBbXTsKCmZvciAobGV0IGJvdCBvZiBib3RzKSB7CiAgICBmb3IgKGxldCBrZXkgaW4gYm90LnRhZ3MpIHsKICAgICAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJ2NzcycpKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIENTUyBrZXk6ICR7a2V5fWApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNzcy5wdXNoKGJvdC50YWdzW2tleV0pOwogICAgICAgIH0KICAgIH0KfQoKY29uc3QgY29tcGlsZWQgPSBjc3Muam9pbignXG5cbicpOwppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb21waWxlZCBDU1M6XG5cbmAsIGNvbXBpbGVkKTsKfQoKcmV0dXJuIGNvbXBpbGVkOycAi/zg8Af14gQIYWJJZ25vcmUCBACL/ODwB4jnBAR0cnVlJwCL/ODwB/XiBAdhYlNoZWxsAgQAi/zg8AeN5wQEdHJ1ZScAi/zg8Af14gQJYWJWZXJzaW9uAgQAi/zg8AeS5wQEMTAuMycAi/zg8Af14gQNYWJMb2dBbmRUb2FzdAIEAIv84PAHl+cEyAJAbGV0IG1lc3NhZ2U7CmxldCBkdXJhdGlvbiA9IDU7CgppZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICBtZXNzYWdlID0gdGhhdDsKfSBlbHNlIHsKICAgIG1lc3NhZ2UgPSB0aGF0Lm1lc3NhZ2U7CiAgICBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb24gPz8gZHVyYXRpb247Cn0KCmFiLmxvZyhsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwpjb25zb2xlLmxvZyhsaW5rcy5yZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwpvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7JwCL/ODwB/XiBAhyZW1lbWJlcgIEAIv84PAH4OkEKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAQRib3RzJGQ4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNQEnAIv84PAHh+oEBnN5c3RlbQIEAIv84PAHiOoED2FiLnNoZWxsLnNlYXJjaCcAi/zg8AeH6gQEZm9ybQIEAIv84PAHmOoEB25vdGhpbmcnAIv84PAHh+oEDmFiUmV0cmlldmVGaWxlAgQAi/zg8Aeg6gSCAUAvL3B1bGwgZG93biBmaWxlIGRhdGEKaWYgKCF0aGF0LnVybCkKewogICAgcmV0dXJuICJubyBmaWxlIHVybCBzdXBwbGllZCI7Cn0KCmxldCBkYXRhID0gYXdhaXQgb3MuZ2V0RmlsZSh0aGF0LnVybCk7CgpyZXR1cm4gZGF0YTsnAIv84PAHh+oEEGFiUmV0cmlldmVSZWNvcmQCBACL/ODwB6PrBOwEQC8vcmV0cmlldmUgc3BlY2lmaWVkIHJlY29yZApsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKCmxldCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKaWYgKHRoYXQucmVjb3JkS2V5KQp7CiAgICByZWNvcmRLZXkgPSB0aGF0LnJlY29yZEtleTsKfQplbHNlIGlmIChhdXRoQm90KQp7CiAgICBpZiAoYXV0aEJvdC5pZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCiAgICB7CiAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKCiAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICB9Cn0KCmxldCByZWNvcmRFbmRwb2ludCA9IHRoYXQucmVjb3JkRW5kcG9pbnQgPyB0aGF0LnJlY29yZEVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwoKaWYgKCFyZWNvcmROYW1lKQp7CiAgICByZXR1cm4gIm5vIHJlY29yZCBuYW1lIHN1cHBsaWVkIjsKfQoKbGV0IGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCByZWNvcmROYW1lLCByZWNvcmRFbmRwb2ludCk7CgovL0FERCBhZGRpdGlvbmFsIGVycm9yIGhhbmRsaW5nPwoKcmV0dXJuIGdldFJlY29yZDsnAIv84PAHh+oECHJlbWVtYmVyAgQAi/zg8AeQ8AQo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAi/zg8AeH6gQNbWFuaWZlc3RhdGlvbgIEAIv84PAHt/AEKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAIv84PAHh+oEDm9uTG9va3VwQUJFZ2dzAgQAi/zg8Afe8AS+LEBjb25zdCB7IAogICAgYWJJRCwKICAgIGFiVmVyc2lvbiwKICAgIGluaXRpYWxCb290LAogICAgYXV0b0hhdGNoLAogICAgcmV0dXJuVHlwZSwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBrZXkgPSBjb25maWdCb3QudGFncy5rZXksCiAgICB0b2FzdCA9IHRydWUsCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgphYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogbG9hZGluZyAiICsgYWJJRCk7CgovL2NsZWFyIGFiLTEKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24gJiYgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9PSAiYWJNZW51IikgewogICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYGxvYWRpbmcgJHthYklEfWApOwoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKbGV0IG5ld0VnZzsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYKICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5ICYmCiAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gInJlY29yZF9ub3RfZm91bmQiCiAgICApIHsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiKSB7CiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9sb2dnZWRfaW4iKSB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCiAgICAgICAgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiAKICAgICAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIgogICAgICAgICkgewogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHRvYXN0KSB7IAogICAgICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKICAgIH0KCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQoKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KZWxzZSB7CiAgICBjb25zdCBwdWJsaWNSZWFkVGVzdCA9IGdldFJlY29yZC5tYXJrZXJzLmluZGV4T2YoInB1YmxpY1JlYWQiKTsKICAgIGNvbnN0IGF1dGhvciA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgogICAgaWYgKHB1YmxpY1JlYWRUZXN0ICE9IC0xICYmIGF1dGhvcikgewogICAgICAgIGlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgewogICAgICAgICAgICBjb25zdCBlZ2dIYXRjaEV2ZW50ID0gYWJJRDsKCiAgICAgICAgICAgIG9zLnJlY29yZEV2ZW50KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGVnZ0hhdGNoRXZlbnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvL3BhY2thZ2UgdGhlIHJlY29yZCBkYXRhCiAgICBuZXdFZ2cgPSBnZXRSZWNvcmQuZGF0YTsKfQoKYWIubG9nKGFiUmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBhYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCmlmIChyZXR1cm5UeXBlICE9IG51bGwpIHsKICAgIGlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICAgICAgICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYWJWZXJzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSBhYlZlcnNpb24gLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlZ2dEYXRhVVJMID0gZ2V0UmVjb3JkLmRhdGEuZWdnVmVyc2lvbkhpc3RvcnlbdmVyc2lvbl07CiAgICAgICAgICAgIGNvbnN0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgICAgICAgICAgaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldHVybkRhdGE7CiAgICAgICAgfSBlbHNlIGlmIChyZXR1cm5UeXBlID09PSAiZWdnIikgewogICAgICAgICAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKG5ld0VnZy5lZ2dWZXJzaW9uSGlzdG9yeSk7CiAgICAgICAgICAgIGNvbnN0IGZpbGVVVUlEID0gdmVyc2lvbkFycmF5W25ld0VnZy5tYXhWZXJzaW9uIC0gMV07CiAgICAgICAgICAgIGNvbnN0IGZpbGVuYW1laGFzaExUTSA9IGNyeXB0by5zaGEyNTYoZmlsZVVVSUQpOwogICAgICAgICAgICBjb25zdCBmaWxldXJsaGFzaExUTSA9ICJhdXhfIiArIGZpbGVuYW1laGFzaExUTSArICcuYXV4JzsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TFRNVVJMID0gImh0dHBzOi8vYnVpbGRlci1sdG0tZmlsZXMuczMuYW1hem9uYXdzLmNvbS8iICsgZmlsZXVybGhhc2hMVE07CiAgICAgICAgICAgIGNvbnN0IG8gPSB7CiAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgICAgICAgdXJsOiB0YXJnZXRMVE1VUkwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGxldCBmaWxlR2V0ID0gYXdhaXQgd2ViaG9vayhvKTsKCiAgICAgICAgICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgICAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmF3YWl0IHRoaXNCb3QubWFuaWZlc3RPdm8oewogICAgYWJJRCwKICAgIHN0dWRpbzogcmVjb3JkS2V5LAogICAgZGltTW9kLAogICAgc3BhY2VNb2QsCiAgICBlZ2dEYXRhOiBuZXdFZ2csCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMgCn0pOwoKaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9OycAi/zg8AeH6gQLbWFuaWZlc3RPdm8CBACL/ODwB52dBeQNQGNvbnN0IHsgCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBzcGFjZU1vZCwKICAgIGRpbU1vZCwKICAgIGVnZ0RhdGEsCiAgICBlZ2dQYXJhbWV0ZXJzLAp9ID0gdGhhdDsKCi8vZWdnIHZpc3VhbGl6YXRpb24Kc2hvdXQoImFiTWVudVJlc2V0Iik7CgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBkZXN0cm95KGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpOwogICAgfQp9CgppZiAobGlua3Mub3ZvQm90KSB7CiAgICBkZXN0cm95KGxpbmtzLm92b0JvdCk7Cn0KCmxldCBlZ2dNb2QgPSB7CiAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICBpbml0aWFsVGltZXI6IHRydWUsCiAgICBhYklELAogICAgc3R1ZGlvLAogICAgaW5pdGlhbEJvb3QsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb25DbGljazogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLmludGVyYWN0T3ZvKCk7CiAgICBgLAogICAgZm9ybTogImVnZyIsCiAgICBjb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgIHByb2dyZXNzQmFyQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3IsCiAgICBwcm9ncmVzc0JhckJhY2tncm91bmRDb2xvcjogbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC41LAogICAgb25Qb2ludGVyRW50ZXI6IGBACiAgICAgICAgbWFza3MudGlwSWQgPSBhd2FpdCBvcy50aXAodGFncy5hYklEICsgJyB2JyArIHRhZ3MudGFyZ2V0VmVyc2lvbik7CiAgICBgLAogICAgb25Qb2ludGVyRXhpdDogYEAKICAgICAgICBpZiAobWFza3MudGlwSWQpIHsKICAgICAgICAgICAgb3MuaGlkZVRpcHMobWFza3MudGlwSWQpOwogICAgICAgIH0KICAgIGAsCiAgICBsYWJlbFBvc2l0aW9uOiAiZnJvbnQiLAogICAgb3JpZW50YXRpb25Nb2RlOiAiYmlsbGJvYXJkRnJvbnQiLAogICAgb25EZXN0cm95OiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3Mub3ZvQm90ID0gbnVsbDsKICAgIGAsCiAgICBlZ2dUaW1lcjogYEAKICAgICAgICBpZiAodGFncy5wcm9ncmVzc0JhciA8IDEpIHsKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciArPSAwLjE7CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90Lm9uQ2xpY2soKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgPSBudWxsOwogICAgICAgIH0KICAgIGAKfTsKCgpsZXQgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7CgppZiAob3ZvLnRhZ3MuYXV0b0hhdGNoKSB7CiAgICBhd2FpdCB0aGlzQm90LmhhdGNoT3ZvKG92byk7Cn0KZWxzZSB7CiAgICBvdm8udGFncy5wcm9ncmVzc0JhciA9IDA7CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG92by50YWdzLm1heFZlcnNpb247CgogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9CgptYXNrcy5vdm9Cb3QgPSBnZXRMaW5rKG92byk7CgpyZXR1cm47JwCL/ODwB4fqBAlvbktleURvd24CBACL/ODwB4KrBYIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAIv84PAHh+oECGhhdGNoT3ZvAgQAi/zg8AeDsQWpFEAvL2xvZ2ljIGZvciBoYXRjaGluZyBvZiBhbiBhYgpzaG91dCgnb3ZvTWVudVJlc2V0Jyk7CgovL2RhdGEgaW4gcmVnYXJkcyB0byB3aGF0IGFiIGlzIGdvaW5nIHRvIGJlIGhhdGNoZWQKY29uc3Qgb3ZvID0gdGhhdDsKCi8vaGF0Y2ggc3BlY2lmaWMgdmFyaWFibGVzCmxldCBpbml0aWFsQm9vdCA9IG92by50YWdzLmluaXRpYWxCb290OwpsZXQgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLnN0YWJsZVZlcnNpb24gPz8gb3ZvLnRhZ3MudGFyZ2V0VmVyc2lvbjsKCmlmICgoY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uIHx8IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uKSAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIpKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uOwp9CgovL3RhcmdldGVkIHZlcnNpb25zCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYiB8fCAhaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpKQp7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiZmVlZGJhY2siKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5mZWVkYmFja1ZlcnNpb247CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJjdXJyZW50IikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgfQogICAgZWxzZSBpZiAoIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy52ZXJzaW9uCiAgICB9CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG51bGw7Cn0KCmlmIChpc05hTih0YXJnZXRWZXJzaW9uKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKfQoKbGV0IHZlcnNpb25BcnJheSA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5OwpsZXQgZmlsZVVSTCA9IHZlcnNpb25BcnJheVt0YXJnZXRWZXJzaW9uIC0gMV07CmxldCBrZXkgPSBvdm8udGFncy5rZXkgPyBvdm8udGFncy5rZXkgOiBjb25maWdCb3QudGFncy5rZXk7CmxldCBmaWxlR2V0OwoKLy9hY3R1YWwgZmlsZSByZXRyaWV2YWwKdHJ5CnsKICAgIGZpbGVHZXQgPSBhd2FpdCBvcy5nZXRGaWxlKGZpbGVVUkwpOwp9CmNhdGNoIChlcnJvcikKewogICAgY29uc29sZS5sb2coZXJyb3IpOwoKICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CgogICAgcmV0dXJuOwp9CgovL2hhbmRsaW5nIGZvciBlbmNyeXB0ZWQgYWIgZmlsZQppZiAoY3J5cHRvLmlzRW5jcnlwdGVkKGZpbGVHZXQpKQp7CiAgICBpZiAoIWtleSkKICAgIHsKICAgICAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoJycsIHsKICAgICAgICAgICAgdHlwZTogJ3NlY3JldCcsCiAgICAgICAgICAgIHRpdGxlOiAnRW50ZXIga2V5JwogICAgICAgIH0pOwogICAgfQoKICAgIHRyeQogICAgewogICAgICAgIGZpbGVHZXQgPSBjcnlwdG8uZGVjcnlwdChrZXksIGZpbGVHZXQpOwogICAgfQogICAgY2F0Y2ggKGVycm9yKQogICAgewogICAgICAgIGNvbnNvbGUubG9nKGVycm9yKQoKICAgICAgICBvcy50b2FzdCgia2V5IGRvZXMgbm90IG1hdGNoIGZpbGUiKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQogICAKICAgIGZpbGVHZXQgPSBKU09OLnBhcnNlKGZpbGVHZXQpOwoKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CmVsc2UKewogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KCi8vY2xlYW4gdXAKZGVzdHJveShvdm8pOwoKLy90b2FzdCBpZiBub3Qgb24gc3RhYmxlCmlmKG92by50YWdzLnN0YWJsZVZlcnNpb24gIT0gdGFyZ2V0VmVyc2lvbiAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnQpCnsKICAgIGlmIChvdm8udGFncy5mZWVkYmFja1ZlcnNpb24gPT0gdGFyZ2V0VmVyc2lvbikKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZGluZyBmZWVkYmFjayB2ZXJzaW9uIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZGluZyB2ZXJzaW9uICIgKyB0YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoICsgIiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9Cn0KCi8vZ2VuZXJhdGUgYm90cyBiYXNlZCBvbiB0aGUgZmlsZSByZXRyaWV2ZWQgKkhFUkUqCmF3YWl0IGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoe2JvdHM6IGZpbGVHZXQsIG9yaWdpbjogb3ZvLnRhZ3MuYWJJRCwgc3R1ZGlvOiBvdm8udGFncy5zdHVkaW8sIHZlcnNpb246IHRhcmdldFZlcnNpb24sIGluaXRpYWxCb290OiBpbml0aWFsQm9vdCwgZWdnUGFyYW1ldGVyczogb3ZvLnRhZ3MuZWdnUGFyYW1ldGVyc30pOwoKcmV0dXJuOycAi/zg8AeH6gQLaW50ZXJhY3RPdm8CBACL/ODwB63FBeoGQC8vbWFudWFsIGhhdGNoIG1lbnUKY29uc3Qgb3ZvQm90ID0gdGhhdCA/IHRoYXQgOiBsaW5rcy5vdm9Cb3Q7CgppZiAoIW92b0JvdCkgewogICAgcmV0dXJuOwp9CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk92b01lbnUiOwoKbWFza3Mub25HcmlkQ2xpY2sgPSBgQAogICAgc2hvdXQoIm92b01lbnVSZXNldCIpOwpgOwptYXNrcy5vdm9NZW51UmVzZXQgPSBgQAogICAgbWFza3Mub25HcmlkQ2xpY2sgPSBudWxsOwogICAgbWFza3Mub3ZvTWVudVJlc2V0ID0gbnVsbDsKCiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7Cgpvcy50d2VlblRvKG92b0JvdCwgMTUsNDUsNDUsIDUpOwoKY29uc3QgZWdnTWVudUJ1dHRvbiA9IHsKICAgIGFiT3ZvTWVudTogdHJ1ZSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvdm9Cb3Q6IGdldExpbmsob3ZvQm90KSwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUNvbG9yLAogICAgdGFyZ2V0VmVyc2lvbjogb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwKICAgIGxhYmVsOiBgaGF0Y2ggJHtvdm9Cb3QudGFncy5hYklEfSB2JHtvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9ufSBvZiAke292b0JvdC50YWdzLm1heFZlcnNpb259YCwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIG92b01lbnVSZXNldDogYEAKICAgICAgICBkZXN0cm95KHRoaXNCb3QpOwogICAgYCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgbGlua3MubWFuYWdlci5oYXRjaE92byhsaW5rcy5vdm9Cb3QpOwogICAgYCwKfTsKCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKGVnZ01lbnVCdXR0b24pOycAi/zg8AeH6gQGY3JlYXRlAgQAi/zg8AeYzAUo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycAi/zg8AeH6gQQY2hhbmdlT3ZvVmVyc2lvbgIEAIv84PAHv8wF8AJALy9sb2dpYyBmb3IgdmVyc2lvbiBjaGFuZ2luZyB3aGVuIG1hbnVhbGx5IGhhdGNoaW5nIGFuIGFiCmNvbnN0IG92b0JvdCA9IGxpbmtzLm92b0JvdDsKCmxldCBuZXdWZXJzaW9uID0gYXdhaXQgb3Muc2hvd0lucHV0KG92b0JvdC50YWdzLnRhcmdldFZlcnNpb24sIHsKICAgIHBsYWNlaG9sZGVyOiAiZW50ZXIgYSB2ZXJzaW9uIGZyb20gMSB0byAiICsgb3ZvQm90LnRhZ3MubWF4VmVyc2lvbgp9KTsKCm92b0JvdC50YWdzLnRhcmdldFZlcnNpb24gPSBuZXdWZXJzaW9uOwpvdm9Cb3QudGFncy5sYWJlbCA9ICd2JysgbmV3VmVyc2lvbjsKCmNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBuZXdWZXJzaW9uOwoKc2hvdXQoIm92b01lbnVSZXNldCIpOycAi/zg8AeH6gQEbWVudQIEAIv84PAHsM8FKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAIv84PAHh+oECGFiSWdub3JlAgQAi/zg8AfXzwUEdHJ1ZScAi/zg8AeH6gQHYWJTaGVsbAIEAIv84PAH3M8FBHRydWUnAIv84PAHh+oEDGFiMUxUTVNlYXJjaAIEAIv84PAH4c8FM0AvL3N1cHBvcnQgb2xkIHN5bnRheAp0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOycAi/zg8AeH6gQNb25Mb29rdXBBc2tJRAIEAIv84PAHldAF/wdAbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgbG9va2luZyB1cCAke3RoYXQuYXNrSUR9YCk7Cgpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQ7CmNvbnN0IGVuZHBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgbG9va3VwQXNrOyAKCnRyeQp7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFza0lELCBlbmRwb2ludCk7Cn0KY2F0Y2gKewogICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCB0aGF0LmFza0lELCBlbmRwb2ludCk7Cn0KCmlmICh0aGF0LmNoYW5uZWxDb25maWcpCnsKICAgIGlmIChwcm9ncmVzc0J1dHRvbikKICAgIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KICAgIAogICAgcmV0dXJuIGxvb2t1cEFzazsKfQplbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiBsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQpCnsKICAgIGlmIChsb29rdXBBc2suZGF0YS5zdHVkaW9JRCA9PSAiQUIiKQogICAgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQobG9va3VwQXNrLmRhdGEucGF0dGVybklEKTsKCiAgICAgICAgc2hvdXQoIm9uQUJJbml0aWFsaXplZCIpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXNCb3Qub25Mb29rdXBBQkVnZ3Moe2FiSUQ6IGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBsb29rdXBBc2suZGF0YS5zdHVkaW9JRCwgYXV0b0hhdGNoOiB0cnVlfSk7ICAKICAgIH0KfQplbHNlIGlmIChsb29rdXBBc2suc3VjY2VzcyAmJiAhbG9va3VwQXNrLmRhdGEudXJsKQp7CiAgICBsb29rdXBBc2suc3VjY2VzcyA9ICFsb29rdXBBc2suc3VjY2VzczsKfQoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIGxvb2t1cEFzazsnAIv84PAHh+oEBWlucHV0AgQAi/zg8AeV2AUo8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcAi/zg8AeH6gQFaGF0Y2gCBACL/ODwB7zYBcABQC8vc2hvdXQoImhhdGNoIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBrZXk6IGtleSwgYXV0b0hhdGNoOiBib29sZWFuLCByZXR1cm5UeXBlOiBkYXRhL251bGwsIGVnZ1BhcmFtZXRlcnM6IGFyZ30pOwoKY29uc3QgbG9va1VwID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsKCnJldHVybiBsb29rVXA7JwCL/ODwB4fqBAlhYlZlcnNpb24CBACL/ODwB/3ZBQQxMC4zJwCL/ODwB4fqBAVsZWFybgIEAIv84PAHgtoFKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAIv84PAHh+oECmFiTG9hZFRvb2wCBACL/ODwB6naBbAHQGxldCB7CiAgICB0b29sTmFtZSwKICAgIHRvb2xQYXJhbWV0ZXJzLAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHRvb2xOYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRvb2xOYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0b29sUGFyYW1ldGVyczpgLCB0b29sUGFyYW1ldGVycyk7Cgpjb25zdCB1cmwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FidG9vbHMvJHt0b29sTmFtZX0uYXV4YCk7CgpsZXQgYXV4OwoKdHJ5IHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soewogICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgdXJsLAogICAgfSkKCiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICBhdXggPSByZXNwb25zZS5kYXRhOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBsZXQgbWVzc2FnZSA9IGBGYWlsZWQgdG8gZG93bmxvYWQgdG9vbCAnJHt0b29sTmFtZX0nLmA7CiAgICBpZiAoZS5tZXNzYWdlKSB7CiAgICAgICAgbWVzc2FnZSArPSBgIEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgfQoKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QobWVzc2FnZSk7Cn0KaWYgKGF1eCkgewogICAgaWYgKGF1eC52ZXJzaW9uID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3RzOiBhdXguc3RhdGUsIGVnZ1BhcmFtZXRlcnM6IHRvb2xQYXJhbWV0ZXJzLCBpZ25vcmVHcmlkRm9jdXM6IHRydWUgfSkKICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYWIgdG9vbHMgbXVzdCBiZSBpbiBhdXggZm9ybWF0IHYxLiAnJHt0b29sTmFtZX0nIGlzIGF1eCBmb3JtYXQgdiR7YXV4LnZlcnNpb259YCk7CiAgICB9Cn0nAIv84PAHh+oEBXV0aWxzAgQAi/zg8Afa4QUo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycBBGJvdHMkZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwAScAi/zg8AeB4gUGc3lzdGVtAgQAi/zg8AeC4gUOYWIuc2hlbGwuaW5wdXQnAIv84PAHgeIFBGZvcm0CBACL/ODwB5HiBQdub3RoaW5nJwCL/ODwB4HiBQlvbktleURvd24CBACL/ODwB5niBZYBQC8vYWxsb3cgcHVsbGluZyB1cCBjaGF0IGluIGJ1aWxkZXIgdmVyc2lvbgppZiAoKHRoYXQua2V5cy5pbmNsdWRlcygiYCIpIHx8ICh0aGF0LmtleXMuaW5jbHVkZXMoIkRlYWQiKSkgKSYmIGJ1aWxkZXJWZXJzaW9uKQp7CiAgICBvcy5zaG93Q2hhdCgiPiIpOwp9JwCL/ODwB4HiBQZvbkNoYXQCBACL/ODwB7DjBasGQC8vbm90IHN1cHBvcnRlZCBvdXRzaWRlIG9mIGJ1aWxkZXIgdmVyc2lvbgppZiAoIWJ1aWxkZXJWZXJzaW9uKQp7CiAgICByZXR1cm47Cn0KCi8vdGhpcyBsb29wIGlkZW50aWZpZXMgcG9zc2libGUgYWIgc3BlY2lmaWMgbWVzc2FnZXMsIGFuZCBjYWxscyBhIHNldCBsaXN0IG9mIGNvbW1hbmRzCmlmICh0aGF0Lm1lc3NhZ2VbMF0gPT0gIi4iKSAKewogICAgb3MuaGlkZUNoYXQoKTsKCiAgICAvLyBHZXQgY29tbWFuZCBhbmQgYXJncy4KICAgIGxldCBhcmdzID0gdGhhdC5tZXNzYWdlLnNwbGl0KCcgJyk7CiAgICBjb25zdCBjbWQgPSBhcmdzWzBdLnNsaWNlKDEpOwogICAgYXJncy5zcGxpY2UoMCwgMSk7CiAgICBhcmdzID0gYXJncy5maWx0ZXIoYXJnID0+IGFyZyAhPT0gJycpOwogICAgYXJncyA9IGFyZ3MubGVuZ3RoID8gYXJncyA6IHVuZGVmaW5lZDsKCiAgICAvLyBDcmVhdGUgYSBmcmVzaCBDb21tYW5kc01hbmFnZXIgd2l0aCBlYWNoIGNhbGwgc28gdGhhdCB3ZSBhbHdheXMgaGF2ZSB0aGUgbGF0ZXN0IGNvbW1hbmRzIGFuZCBmdW5jdGlvbmFsaXR5LgogICAgY29uc3QgYWJDb21tYW5kcyA9IG5ldyBBQkNvbW1hbmRzTWFuYWdlcigpOwoKICAgIGlmIChhYkNvbW1hbmRzICYmIGFiQ29tbWFuZHMuaGFzQ29tbWFuZChjbWQpKSB7CiAgICAgICAgLy8gQ2FsbCBjb21tYW5kIHdpdGggYXJncy4KICAgICAgICBhYkNvbW1hbmRzLmNhbGxDb21tYW5kKGNtZCwgYXJncyk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEV2YWx1YXRlIGNvbW1hbmQgYXMgamF2YXNjcmlwdC4KICAgICAgICBvcy5ydW4oY21kKTsKICAgIH0KfScAi/zg8AeB4gULZGVzY3JpcHRpb24CBACL/ODwB9zpBUJUaGlzIGlzIG1lYW50IHRvIGhhbmRsZSBhbnkgbm9uZSBtZW51IHJlbGF0ZWQgaW5wdXRzL2ludGVyYWN0aW9ucy4nAIv84PAHgeIFDG9uRmlsZVVwbG9hZAIEAIv84PAHn+oF1xhALy9maWx0ZXIgb3V0IHRpbWVzIHdoZW4gZmlsZSBsb2FkaW5nIGlzIG5vdCBhbGxvd2VkCmlmICghYnVpbGRlclZlcnNpb24gfHwgbGlua3MucmVtZW1iZXIudGFncy5hYkxpc3RlbmluZ0ZvckZpbGVVcGxvYWRzICE9PSB0cnVlKQp7CiAgICByZXR1cm47Cn0KCi8vdmFyaW91cyBmaWxlIHNwZWNpZmljIHZhcmlhYmxlcwpsZXQgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCkudG9Mb3dlckNhc2UoKTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwpsZXQgc2l6ZSA9IHRoYXQuZmlsZS5zaXplOwpsZXQgbWltZVR5cGU7CmxldCBib3RJbmZvID0ge307CgovL2hhcmQgbGltaXQgYmFzZWQgb24gZmlsZSBzaXplCmlmIChzaXplID4gMjAwMDAwMDAwKQp7CiAgb3MudG9hc3QoIm1heGltdW0gZmlsZSBzaXplIGV4Y2VlZGVkICgyMDAgbWIpIik7CgogIHJldHVybjsKfQoKLy90aGlzIHN3aXRjaCBoYW5kbGVzIHBvc3NpYmxlIGZpbGVzIGV4dGVuc2lvbnMsIHdoaWxlIHJlamVjdGluZyBhbnkgaXQgZG9lcyBub3QgcmVjb2duaXplCnN3aXRjaChmaWxlRXh0ZW5zaW9uKQp7CiAgY2FzZSAnanBnJzoKICBjYXNlICdqcGVnJzoKICBjYXNlICd3ZWJwJzoKICBjYXNlICdnaWYnOgogIGNhc2UgJ3BuZyc6CiAgICBtaW1lVHlwZSA9ICJpbWFnZS8iICsgZmlsZUV4dGVuc2lvbjsKICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgYnJlYWs7CiAgY2FzZSAnc3ZnJzoKICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICBicmVhazsKICBjYXNlICdnbGInOgogIGNhc2UgJ2V4cic6CiAgY2FzZSAnZ2x0Zic6CiAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICBib3RJbmZvLmZvcm0gPSAibWVzaCI7CiAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gImdsdGYiOwogICAgYnJlYWs7CiAgY2FzZSAnYXV4JzoKICBjYXNlICdwZGYnOgogICAgbGV0IGJvdERhdGEgPSBmaWxlRXh0ZW5zaW9uID09ICIuYXV4IiA/IEpTT04ucGFyc2UodGhhdC5maWxlLmRhdGEpLnN0YXRlIDogb3MucGFyc2VCb3RzRnJvbURhdGEodGhhdC5maWxlLmRhdGEpOwoKICAgIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoe2JvdHM6IGJvdERhdGEsIG9yaWdpbjogZmlsZU5hbWV9KTsKCiAgICByZXR1cm47Ci8vICAgY2FzZSAncGRmJzoKLy8gICAgIGJyZWFrOwogIGNhc2UgJ21wMyc6CiAgICBtaW1lVHlwZSA9ICdhdWRpby9tcGVnJzsKICAgIGJvdEluZm8ub25DbGljayA9ICJAIG9zLnBsYXlTb3VuZCh0YWdzLmZvcm1BZGRyZXNzKTsiOwogICAgYm90SW5mby5sYWJlbCA9ICJDbGljayB0byBQbGF5IjsKICAgIGJyZWFrOwogIGNhc2UgJ21wNCc6CiAgICBtaW1lVHlwZSA9ICd2aWRlby9tcDQnOwogICAgYm90SW5mby5mb3JtID0gImlmcmFtZSI7CiAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gInNyYyI7CiAgICBicmVhazsKICBjYXNlICdvdGYnOgogICAgbWltZVR5cGUgPSAnZm9udC9vdGYnOwogICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgIGJyZWFrOwogIGNhc2UgJ3dvZmYnOgogICAgbWltZVR5cGUgPSAnZm9udC93b2ZmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBkZWZhdWx0OgogICAgbGV0IHJlc3VsdCA9IG5ldyBFcnJvcigidW5oYW5kbGVkIGZpbGUgdHlwZTogIiArIGZpbGVFeHRlbnNpb24pOwogICAgb3MudG9hc3QoImZpbGUgdHlwZSBub3Qgc3VwcG9ydGVkIik7CiAgICBjb25zb2xlLndhcm4ocmVzdWx0KQogICAgcmV0dXJuIHJlc3VsdDsKfQoKLy90aGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhbmQgb2JqZWN0cyBzZXQgdXAgYSBsb2FkaW5nIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmxldCB1cGxvYWRSZXN1bHQ7CmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IHRoaXNCb3QuYWJQcm9ncmVzc0JhcihgdXBsb2FkaW5nYCk7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpb0lEID8/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsKCmlmICghY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpCnsKICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cn0KCi8vdGhpcyBpcyB0aGUgYWN0dWFsIHVwbG9hZCBmdW5jdGlvbmFsaXR5CnVwbG9hZFJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEZpbGUoe2ZpbGU6IHRoYXQuZmlsZS5kYXRhLCBmaWxlTmFtZTogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwoKLy9pZiB0aGUgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgYXMgYSBib3Qgd2l0aCBhIGxpbmssIHRoaXMgbG9naWMgaGFuZGxlcyB0aGF0CgppZiAobWltZVR5cGUuaW5jbHVkZXMoImZvbnQiKSkKewogICAgYm90SW5mb1tjb25maWdCb3QudGFncy5ncmlkUG9ydGFsXSA9IHRydWU7CiAgICBib3RJbmZvLmxhYmVsRm9udEFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9CmVsc2UgaWYgKE9iamVjdC5rZXlzKGJvdEluZm8pLmxlbmd0aCA+IDApCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5mb3JtQWRkcmVzcyA9IHVwbG9hZFJlc3VsdC51cmwgPyB1cGxvYWRSZXN1bHQudXJsIDogdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICBjcmVhdGUoYm90SW5mbyk7Cn0KCmNvbnN0IGNsaXBVUkwgPSB1cGxvYWRSZXN1bHQudXJsID8/IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7Cgpvcy5zZXRDbGlwYm9hcmQoY2xpcFVSTCk7Cgpvcy50b2FzdCgiZmlsZSB1cmwgYWRkZWQgc2V0IHRvIGNsaXBib2FyZCIpOwoKLy9jbGVhciB0aGUgcHJvZ3Jlc3MgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHVwbG9hZFJlc3VsdDsnAIv84PAHgeIFBWxlYXJuAgQAi/zg8Af3ggYo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAi/zg8AeB4gUIcmVtZW1iZXICBACL/ODwB56DBijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCL/ODwB4HiBQ1tYW5pZmVzdGF0aW9uAgQAi/zg8AfFgwYo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAi/zg8AeB4gUIYWJJZ25vcmUCBACL/ODwB+yDBgR0cnVlJwCL/ODwB4HiBQZjcmVhdGUCBACL/ODwB/GDBijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwCL/ODwB4HiBQVzdG9yZQIEAIv84PAHmIQGKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAIv84PAHgeIFBG1lbnUCBACL/ODwB7+EBijwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCL/ODwB4HiBQdhYlNoZWxsAgQAi/zg8AfmhAYEdHJ1ZScAi/zg8AeB4gUNYWJQcm9ncmVzc0JhcgIEAIv84PAH64QG/QlAaWYgKCFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUpCnsKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7Cn0KCmxldCBsb2FkTGFiZWwgPSB0aGF0ID8/ICJ1cGRhdGluZyI7CmxldCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLnNwYWNlID0gInRlbXBMb2NhbCI7Cm1lbnVCdXR0b24uYWJNZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5tZW51SXRlbVN0eWxlID0gewogICAgImJvcmRlci1yYWRpdXMiOiI4cHgiLCAKICAgICJtYXJnaW4tdG9wIjoiOHB4IiwgCiAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAibWluLWhlaWdodCI6ICI0NHB4Igp9OzsKbWVudUJ1dHRvbi50cmFja051bSA9IC0xOwptZW51QnV0dG9uLm9uQ3JlYXRlID0gYEAKICAgIGlmICh0YWdzLnRyYWNrTnVtID09IDIpCiAgICB7CiAgICAgICAgdGFncy50cmFja051bSA9IDA7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy50cmFja051bSsrOwogICAgfQoKICAgIHRhZ3MubGFiZWwgPSB0YWdzWyJsYWJlbCIrdGFncy50cmFja051bV07CiAgICB0YWdzLmZvcm1BZGRyZXNzID0gdGFnc1siZm9ybSIrdGFncy50cmFja051bV07CgogICAgc2V0VGltZW91dCgoKSA9PiB3aGlzcGVyKHRoaXNCb3QsICJvbkNyZWF0ZSIpLCA1MDApO2A7Cm1lbnVCdXR0b24ubGFiZWwwID0gbG9hZExhYmVsICsgIi4iOwptZW51QnV0dG9uLmxhYmVsMSA9IGxvYWRMYWJlbCArICIuLiI7Cm1lbnVCdXR0b24ubGFiZWwyID0gbG9hZExhYmVsICsgIi4uLiI7Cm1lbnVCdXR0b24uZm9ybTAgPSAiaG91cmdsYXNzX2JvdHRvbSI7Cm1lbnVCdXR0b24uZm9ybTEgPSAiaG91cmdsYXNzX3RvcCI7Cm1lbnVCdXR0b24uZm9ybTIgPSAiaG91cmdsYXNzX2JvdHRvbSI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLmxhYmVsQ29sb3IgPSAiYmxhY2siOwptZW51QnV0dG9uLmxhYmVsQWxpZ25tZW50ID0gImNlbnRlciI7Cm1lbnVCdXR0b24uYWJQcm9ncmVzc1Jlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLm9uRGVzdHJveSA9ICJAIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsiOwoKbWVudUJ1dHRvbiA9IGNyZWF0ZShtZW51QnV0dG9uKTsKCnJldHVybiBtZW51QnV0dG9uOycAi/zg8AeB4gUJb25UYXBDb2RlAgQAi/zg8AfpjgaiAkBjb25zdCB0YXBDb2RlID0gdGhhdDsKCnN3aXRjaCAodGFwQ29kZSkKewogICAgY2FzZSAiMzM0MiI6CiAgICAgICAgb3MudG9hc3QoIndha2luZyAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSk7CgogICAgICAgIHRoaXNCb3Qub25DaGF0KHttZXNzYWdlOiAiLi4ifSk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICI0MjQyIjoKICAgICAgICBvcy5zaG93Q2hhdCgiPiIpOwogICAgICAgIGJyZWFrOwogICAgZGVmYXVsdDoKICAgICAgICAvL2NvbnNvbGUubG9nKHRhcENvZGUpOwp9JwCL/ODwB4HiBQNhc2sCBACL/ODwB4yRBijwn5SXZWM4NWMxZDYtOWYxYS00MGQ0LTgyZTEtNWJkNjgwMzQ5YzI3JwCL/ODwB4HiBQlhYlZlcnNpb24CBACL/ODwB7ORBgQxMC4zJwCL/ODwB4HiBQpvbkJvdEFkZGVkAgQAi/zg8Ae4kQYhQHRoaXNCb3QubG9hZEFCQ29tbWFuZHNNYW5hZ2VyKCk7JwCL/ODwB4HiBRpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAIv84PAH2pEGqDhAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCi8vIFRoZXNlIGFyZSBhbGwgdGhlIGJ1aWx0LWluIGNvbW1hbmRzLgoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdoZWxwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGNvbW1hbmRzID0gYWJDb21tYW5kcy5jb21tYW5kczsKICAgIGNvbnN0IGNvbW1hbmRLZXlzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpOwoKICAgIGxldCBzZWxlY3RlZENvbW1hbmQ7CiAgICBpZiAoY29tbWFuZEtleXMgJiYgY29tbWFuZEtleXMubGVuZ3RoICYmIGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb21tYW5kS2V5TWF0Y2ggPSBjb21tYW5kS2V5cy5maW5kKGtleSA9PiBrZXkgPT09IGFyZ3NbMF0pOwogICAgICAgIHNlbGVjdGVkQ29tbWFuZCA9IGNvbW1hbmRLZXlNYXRjaDsKICAgIH0KICAgIAogICAgbGlua3MuaGVscC5tb3VudCh7IGFiQ29tbWFuZHNNYW5hZ2VyOiBhYkNvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IHRoaXMgaGVscCB3aW5kb3cuIENhbiBzcGVjaWZ5IGEgY29tbWFuZCB0byBvcGVuIHRoZSBoZWxwIHBhZ2UgZm9yIHRoYXQgY29tbWFuZCBkaXJlY3RseS4nLAogICAgdXNhZ2U6IFsnLmhlbHAnLCAnLmhlbHAgW2NvbW1hbmRdJ10KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJy4nLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcuLicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3dha2UnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcud2FrZScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NsZWVwJywgYXJncyA9PiB0aGlzQm90LmNtZEFCU2xlZXAoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdXQgYWIgdG8gc2xlZXAuJywKICAgIHVzYWdlOiAnLnNsZWVwJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYXNrJywgKGFyZ3MpID0+IHsKICAgIGlmIChsaW5rcy5hc2spIHsKICAgICAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgYXNrSW5wdXQgPSBhcmdzLmpvaW4oJyAnKTsKICAgICAgICAgICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrSW5wdXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC5hc2sgY29tbWFuZCByZXF1aXJlcyBpbnB1dGApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYXNrIGJvdCBpcyBub3QgbG9hZGVkLCBjYW5ub3QgbG9hZCBhc2tgKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0FzayBhYicsCiAgICB1c2FnZTogJy5hc2sgPGFza19uYW1lPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ25hbWVhYicsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBuYW1lID0gYXdhaXQgb3Muc2hvd0lucHV0KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHksIHsgdGl0bGU6ICd3aGF0IHdvdWxkIHlvdSBsaWtlIHRvIGNhbGwgbWU/JyB9KTsKICAgIHNldFRhZ01hc2sobGlua3MucmVtZW1iZXIsICdhYkJ1aWxkZXJJZGVudGl0eScsIG5hbWUsICdsb2NhbCcpOwogICAgc2hvdXQoJ2J1aWxkZXJJZGVudGl0eV9zYXZlJywgeyBuYW1lOiBuYW1lIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2l2ZSBhYiBhIG5ldyBuYW1lLicsCiAgICB1c2FnZTogJy5uYW1lYWInCn0pOwoKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnaWRlJywgYXJncyA9PiB0aGlzQm90LmNtZElERShhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpbnN0LicsCiAgICB1c2FnZTogJy5pZGUnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzeXN0ZW0nLCBhcmdzID0+IHRoaXNCb3QuY21kSURFKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGluc3QuJywKICAgIHVzYWdlOiAnLnN5c3RlbScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2xvZycsIChhcmdzKSA9PiB7CiAgICBsaW5rcy5jb25zb2xlLnRvZ2dsZUNvbnNvbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1RvZ2dsZSB2aXNpYmxpdHkgb2YgdGhlIGFiIGxvZy4nLAogICAgdXNhZ2U6ICcubG9nJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2djbGVhcicsIChhcmdzKSA9PiB7CiAgICBjb25zdCBtZXNzYWdlTG9nQm90cyA9IGdldEJvdHMoImNvbnNvbGVMb2dNZXNzYWdlQm90IiwgdHJ1ZSk7CiAgICBkZXN0cm95KG1lc3NhZ2VMb2dCb3RzKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0NsZWFyIGFsbCBhYiBsb2cgbWVzc2FnZXMuJywKICAgIHVzYWdlOiAnLmxvZ2NsZWFyJwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzaGVldCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWRTaGVldChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3Igc3BlY2lmaWVkIGJvdCBvciBhbiBlbnRpcmUgZGltZW5zaW9uLicsCiAgICB1c2FnZTogWwogICAgICAgICcuc2hlZXQgW29wdGlvbnNdIFtwb3J0YWwgfCBoZWxwZXJCb3ROYW1lIHwgYm90SWQgfCBnbG9iYWxUaGlzUGF0aF0nLAogICAgICAgICdleC4gLnNoZWV0IGhvbWUnLAogICAgICAgICdleC4gLnNoZWV0IGNvbmZpZ0JvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgLXQgYTJjZjQ3MzktMzlhMi00ZmQ2LWIzZWYtY2M0NzgyZjk3MDg5JywKICAgICAgICAnZXguIC5zaGVldCBnbG9iYWxUaGlzLm15T2JqZWN0Lm15Qm90JywKICAgICAgICAnZXguIC5zaGVldCBteU9iamVjdC5teUJvdCcKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBpbiBhIG5ldyBicm93c2VyIHRhYi4gXG5cbk5PVEU6IC5zaGVldCB3aWxsIGF1dG9tYXRpY2FsbHkgaW5zcGVjdCB0aGUgc3BhY2Ugb2YgYSBib3QgYW5kIGZvcmNlIG9wZW5pbmcgaW4gdGhlIHNhbWUgdGFiIGlmIGEgYm90IGlzIGluIHRlbXBMb2NhbCBvciB0ZW1wU2hhcmVkIHNwYWNlLicsCiAgICAgICAgfQogICAgXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbWVudXNoZWV0JywgKGFyZ3MpID0+IHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbDsKICAgIGlmICghY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQ2Fubm90IG9wZW4gc2hlZXRQb3J0YWwgZm9yIG1lbnVQb3J0YWwgYm90cy4gVGhlIG1lbnVQb3J0YWwgaXMgY3VycmVudGx5IGRpc2FibGVkLmB9KQogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc2hlZXQgcG9ydGFsIGZvciB0aGUgY3VycmVudCBtZW51IHBvcnRhbC4nLAogICAgdXNhZ2U6ICcubWVudVNoZWV0JywKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkaW5zdCcsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEluc3QoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCB0aGUgaW5zdCB0byBkaXNrLicsCiAgICB1c2FnZTogJy5kb3dubG9hZGluc3QnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGFiJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkQUIoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEb3dubG9hZCBzcGVjaWZpZWQgYWIgZmlsZSB0byBkaXNrLicsCiAgICB1c2FnZTogWwogICAgICAgICcuZG93bmxvYWRhYicsCiAgICAgICAgJy5kb3dubG9hZGFiIC12IDEnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy12JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdTcGVjaWZ5IHRoZSBhdXggZm9ybWF0IHZlcnNpb24gbnVtYmVyLiBleC4gLXYgMSB3aWxsIGJlIGF1eCBmb3JtYXQgdmVyc2lvbiAxIChwdXJlIGJvdCBqc29uKS4gQnkgZGVmYXVsdCwgYWIgZmlsZXMgYXJlIHVzdWFsbHkgZG93bmxvYWRlZCBhcyB2ZXJzaW9uIDIgYXV4IGZpbGVzIChjb25mbGljdC1mcmVlIHVwZGF0ZSkuJwogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2Rvd25sb2FkZWdnJywgYXJncyA9PiB0aGlzQm90LmNtZERvd25sb2FkRWdnKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgYXV4IGZpbGUgZnJvbSBhYiBlZ2cuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLiBZb3Ugd2lsbCBuZWVkIHRvIHByb3ZpZGUgdGhlIHJlY29yZEtleSBhcyB3ZWxsIGFuZCB0aGUgbmFtZSBvZiB0aGUgZWdnLiBBIGRyb3Bkb3duIHNlbGVjdGlvbiB3aWxsIGJlIHByb3ZpZGVkIGZvciB0aGUgZWdnIGlmIGZvdW5kIHRvIHNlbGVjdCB3aGljaCB2ZXJzaW9uIHRvIGRvd25sb2FkLmAsCiAgICB1c2FnZTogJy5kb3dubG9hZGVnZycsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2Fkc2tpbGwnLCBhc3luYyAoYXJncykgPT4gewogICAgaWYgKGFyZ3MpIHsKICAgICAgICBmb3IgKGxldCBza2lsbCBvZiBhcmdzKSB7CiAgICAgICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoc2tpbGwpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnLmxvYWRza2lsbCByZXF1aXJlcyBzb21lIHNraWxsIG5hbWVzJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdMb2FkIHRoZSBzcGVjaWZpZWQgYWIgc2tpbGxzLicsCiAgICB1c2FnZTogJy5sb2FkU2tpbGwgW3NraWxsIC4uLl0nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cmxxcicsICgpID0+IG9zLnNob3dRUkNvZGUoY29uZmlnQm90LnRhZ3MudXJsKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgYSBRUiBjb2RlIGZvciB0aGUgYnJvd2VyIHRhYlwncyBjdXJyZW50IFVSTC4nLAogICAgdXNhZ2U6ICcudXJscXInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkaW0nLCAoYXJncykgPT4gewogICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBuYW1lID0gYXJncy5qb2luKCcgJyk7CiAgICAgICAgb3MuZ29Ub0RpbWVuc2lvbihuYW1lKTsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYE1vdmVkIHRvICcke25hbWV9JyBkaW1lbnNpb24uYCwgZHVyYXRpb246IDMgfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dvIHRvIHNwZWNpZmllZCBkaW1lbnNpb24gLyBwb3J0YWwuJywKICAgIHVzYWdlOiAnLmRpbSA8ZGltZW5zaW9uIHwgcG9ydGFsPicsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1dWlkJywgKCkgPT4gewogICAgb3Muc2V0Q2xpcGJvYXJkKHV1aWQoKSk7CgogICAgbGV0IG1lc3NhZ2UgPSBgQ29waWVkIG5ldyB1dWlkIHRvIGNsaXBib2FyZGA7CiAgICBhYi5sb2coYWJSZW1lbWJlci50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgb3MudG9hc3QobWVzc2FnZSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHZW5lcmF0ZSBhIHVuaXZlcnNhbGx5IHVuaXF1ZSBpZGVudGlmaWVyICh1dWlkKSBhbmQgY29weSBpdCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy51dWlkJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZHVwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGJvdElkID0gYXJncyA/IGFyZ3NbMF0gOiB1bmRlZmluZWQ7CiAgICBpZiAoYm90SWQpIHsKICAgICAgICBjb25zdCBib3QgPSBnZXRCb3QoJ2lkJywgYm90SWQpOwogICAgICAgIGlmIChib3QpIHsKICAgICAgICAgICAgY29uc3QgZHVwQm90ID0gY3JlYXRlKGJvdCk7CiAgICAgICAgICAgIG9zLnNldENsaXBib2FyZChkdXBCb3QuaWQpOwogICAgICAgICAgICBvcy50b2FzdCgnRHVwbGljYXRlIGJvdCBpZCBjb3BpZWQgdG8gY2xpcGJvYXJkLicpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIG9zLnRvYXN0KGBObyBib3QgZm91bmQgd2l0aCBpZCAke2JvdElkfWApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgb3MudG9hc3QoJ1Byb3ZpZGUgdGhlIGlkIG9mIHRoZSBib3QgeW91IHdhbnQgdG8gZHVwbGljYXRlJyk7CiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdEdXBsaWNhdGUgYSBzcGVjaWZpZWQgYm90IGFuZCBjb3B5IHRoZSBuZXcgYm90XCdzIGlkIHRvIHRoZSBjbGlwYm9hcmQuJywKICAgIHVzYWdlOiAnLmR1cCA8Ym90SWQ+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkYXV4JywgKGFyZ3MpID0+IHsKICAgIG9zLnNob3dVcGxvYWRBdXhGaWxlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgQVVYIGZpbGUocykgdG8gdGhlIGN1cnJlbnQgaW5zdC4nLAogICAgdXNhZ2U6ICcudXBsb2FkYXV4Jwp9KQoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGxvYWRmaWxlcycsIGFyZ3MgPT4gdGhpc0JvdC5jbWRVcGxvYWRGaWxlcyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwbG9hZCBmaWxlKHMpIGRpcmVjdGx5IHRvIHJlY29yZC4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnVwbG9hZGZpbGVzJywKICAgICAgICAnLnVwbG9hZGZpbGVzIC1yZWNvcmQgPHJlY29yZF9pZD4nCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy1yZWNvcmQnLAogICAgICAgICAgICBkZXNjcmlwdGlvbjogJ09wdGlvbmFsbHkgcHVibGlzaCBmaWxlKHMpIHRvIGEgc3BlY2lmaWMgcmVjb3JkLiBJZiBvbWl0dGVkLCBmaWxlKHMpIHdpbGwgYmUgcHVibGlzaGVkIHRvIHRoZSB1c2VyXCdzIHBlcnNvbmFsIHJlY29yZC4nCiAgICAgICAgfQogICAgXQp9KScAi/zg8AeB4gUVbG9hZEFCQ29tbWFuZHNNYW5hZ2VyAgQAi/zg8AeDygbqMEB0eXBlIEFCQ29tbWFuZENhbGxiYWNrID0gKGFyZ3M/OiBhbnlbXSkgPT4gdm9pZDsKCmludGVyZmFjZSBBQkNvbW1hbmRBcmcgewogIGlkZW50aWZpZXI6IHN0cmluZ1tdIHwgc3RyaW5nOwogIGRlc2NyaXB0aW9uOiBzdHJpbmc7Cn0KCmludGVyZmFjZSBBQkNvbW1hbmRIZWxwIHsKICBzaG9ydERlc2NyaXB0aW9uOiBzdHJpbmc7CiAgbG9uZ0Rlc2NyaXB0aW9uPzogc3RyaW5nOwogIGFyZ3M/OiBBQkNvbW1hbmRBcmdbXTsKICB1c2FnZT86IHN0cmluZyB8IHN0cmluZ1tdOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kIHsKICBuYW1lOiBzdHJpbmc7CiAgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrOwogIGhlbHA6IEFCQ29tbWFuZEhlbHA7Cn0KCi8qKgogKiBBQkNvbW1hbmRzTWFuYWdlciBpcyBwYXJ0IG9mIGFiU2hlbGwuCiAqIFlvdSBjYW4gcmVnaXN0ZXIgY29tbWFuZHMgdG8gaXQgdGhhdCBjYW4gYmUgaW52b2tlZCB1c2luZyAnJDxjb21tYW5kPicgd2l0aCB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAqIEl0cyBnZW5lcmFsbHkgbm90IHJlY29tbWVuZGVkIHRvIGNyZWF0ZSB0aGlzIHlvdXJzZWxmIGJ1dCBpbnN0ZWFkIHRvIGxpc3RlbiBmb3IgdGhlIEBvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCBzaG91dAogKiBhbmQgdG8gcmVnaXN0ZXIgeW91ciBjb21tYW5kcyB0aGVyZS4KICogQHByb3Age3N0cmluZ1tdfSBjb21tYW5kcwogKi8KY2xhc3MgQUJDb21tYW5kc01hbmFnZXIgewogICAgY29tbWFuZHM6IFJlY29yZDxzdHJpbmcsIEFCQ29tbWFuZD47CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgdGhpcy5jb21tYW5kcyA9IHt9OwoKICAgICAgICAvLyBTaG91dCB0aGF0IGFuIGluc3RhbmNlIG9mIEFCQ29tbWFuZHNNYW5hZ2VyIGhhcyBiZWVuIGNyZWF0ZWQgYW5kIGFsbG93IGFueSBsaXN0ZW5lcnMKICAgICAgICAvLyB0byBhZGQgdGhlaXIgb3duIGNvbW1hbmRzIHRvIHRoZSBpbnN0YW5jZS4KICAgICAgICBzaG91dCgnb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQnLCB0aGlzKTsKICAgIH0KCiAgICAvKioKICAgICAqIEFkZCBhIGNvbW1hbmQgdG8gQUJDb21tYW5kc01hbmFnZXIuCiAgICAgKiBUaGlzIGNvbW1hbmQgd2lsbCBiZSBhdmFpbGFibGUgdG8gaW52b2tlIHVzaW5nICckPG5hbWU+JyBvbiB0aGUgQ2FzdWFsT1MgY2hhdCBiYXIuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgc3VjY2Vzc2Z1bGx5IGFkZGVkLgogICAgICovCiAgICBhZGRDb21tYW5kKG5hbWU6IHN0cmluZywgY2FsbGJhY2s6IEFCQ29tbWFuZENhbGxiYWNrLCBoZWxwOiBBQkNvbW1hbmRIZWxwKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKCFuYW1lIHx8IHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdIHN0cmluZyBuYW1lIGlzIHJlcXVpcmVkIGZvciBjb21tYW5kcy5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIGFscmVhZHkgZXhpc3RzIGFzIGEgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFjYWxsYmFjayB8fCB0eXBlb2YgY2FsbGJhY2sgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgYSBjYWxsYmFjayBmdW5jdGlvbi5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCBpcyBtaXNzaW5nIHNob3J0RGVzY3JpcHRpb24gZnJvbSBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb21tYW5kc1tuYW1lXSA9IHsgbmFtZSwgY2FsbGJhY2ssIGhlbHAgfTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBoYXNDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRzW25hbWVdICE9IG51bGw7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZW1vdmUgYSBjb21tYW5kIGZyb20gQUJDb21tYW5kc01hbmFnZXIKICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3YXMgcmVtb3ZlZC4gSWYgdGhlIGNvbW1hbmQgZG9lc24ndCBleGlzdCBmYWxzZSB3aWxsIGFsc28gYmUgcmV0dXJuZWQuCiAgICAgKi8KICAgIHJlbW92ZUNvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKHRoaXMuY29tbWFuZHNbbmFtZV0pIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBDYWxsIHRoZSBzcGVjaWZpZWQgY29tbWFuZCB3aXRoIHRoZSBwcm92aWRlZCBhcmdzIChpZiBhbnkpLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIGV4ZWN1dGVkLgogICAgICovCiAgICBjYWxsQ29tbWFuZChuYW1lOiBzdHJpbmcsIGFyZ3M/OiBhbnlbXSk6IGJvb2xlYW4gewogICAgICAgIGNvbnN0IGNvbW1hbmQgPSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgIGlmIChjb21tYW5kKSB7CiAgICAgICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGhlbHBBcmcgb2YgY29tbWFuZC5oZWxwLmFyZ3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaGVscEFyZy5pZGVudGlmaWVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goLi4uaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKGhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQXNzZXJ0IHRoYXQgdGhlIGlucHV0IGFyZ3MgYXJlIHZhbGlkIGFnYWluc3QgdGhlIGNvbW1hbmQgaGVscCBkb2N1bWVudGF0aW9uLgogICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBlYXN5IHdheSB0byB2YWxpZGF0ZSBhcmdzIGJlZm9yZSBleGVjdXRpbmcgYSBjb21tYW5kLgogICAgICAgICAgICAgICAgQUJDb21tYW5kc01hbmFnZXIuYXNzZXJ0VmFsaWRBcmdzKGFyZ3MsIHZhbGlkQXJncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29tbWFuZC5jYWxsYmFjayhhcmdzKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGlzIG5vdCBhIHZhbGlkIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgcHJvdmlkZWQgYXJnLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGFuZCB2YWx1ZSBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdWYWx1ZShhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBhbnkgewogICAgICAgIGxldCB2YWx1ZSA9IG51bGw7CgogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIGxldCBkZWxldGVDb3VudCA9IDE7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZUluZGV4ID0gYXJnSW5kZXggKyAxOwoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZUluZGV4IDwgYXJncy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGVDb3VudCsrOwogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYXJnc1t2YWx1ZUluZGV4XTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgcmVsYXRlZCBhcmdzICYgdmFsdWVzCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgZGVsZXRlQ291bnQpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgd2V0aGVyIHRoZSBhcmcgZmxhZyBpcyBwcm92aWRlZCBpbiB0aGUgYXJncy4gV2lsbCByZW1vdmUgdGhlIGFyZyBmcm9tIHRoZSBhcmdzIGFycmF5LgogICAgICovCiAgICBzdGF0aWMgcGFyc2VBcmdGbGFnKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGFyZ0luZGV4ID0gYXJncy5maW5kSW5kZXgoYSA9PiBhID09PSBhcmcpOwoKICAgICAgICAgICAgaWYgKGFyZ0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBhcmcgZmxhZy4KICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCAxKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgc3RhdGljIGFzc2VydFZhbGlkQXJncyhhcmdzOiBhbnlbXSwgdmFsaWRBcmdzOiBhbnlbXSk6IHZvaWQgewogICAgICAgIGlmIChhcmdzKSB7CiAgICAgICAgICAgIGNvbnN0IGludmFsaWRBcmdzID0gW107CgogICAgICAgICAgICBmb3IgKGxldCBhcmcgb2YgYXJncykgewogICAgICAgICAgICAgICAgaWYgKGFyZyAmJiB0eXBlb2YgYXJnID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gYXJnIHdlIHdhbnQgdG8gZXZhbHVhdGUuCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsaWRBcmdzIHx8ICF2YWxpZEFyZ3MuaW5jbHVkZXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBhcmcgaXMgbm90IGluY2x1ZGVkIGluIHRoZSB2YWxpZEFyZ3MsIHRodXMgdGhlIGFyZyBpcyBpbnZhbGlkLgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZEFyZ3MucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlIHRoaXMgYXJnIGl0IGlzIG1vc3RseSBsaWtlbHkgYSB2YWx1ZSBhcmcuCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaW52YWxpZEFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYEludmFsaWQgYXJndW1lbnRzOiAke2ludmFsaWRBcmdzLmpvaW4oJywgJyl9YDsKCiAgICAgICAgICAgICAgICBvcy50b2FzdChlcnJvck1lc3NhZ2UsIDQpOwogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmdsb2JhbFRoaXMuQUJDb21tYW5kc01hbmFnZXIgPSBBQkNvbW1hbmRzTWFuYWdlcjsnAIv84PAHgeIFBGhlbHACBACL/ODwB+76Bijwn5SXMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjJwCL/ODwB4HiBQhjbWRTaGVldAIEAIv84PAHlfsGzRRAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgcG9ydGFsOwpsZXQgbmV3VGFiID0gZmFsc2U7CgppZiAoYXJncykgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgYXJnID0gYXJnc1tpXTsKICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICBpZiAoYXJnID09PSAnLXQnKSB7CiAgICAgICAgICAgICAgICBuZXdUYWIgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICghcG9ydGFsKSB7CiAgICAgICAgICAgIHBvcnRhbCA9IGFyZzsKICAgICAgICB9CiAgICB9Cn0KCmlmICghcG9ydGFsKSB7CiAgICBwb3J0YWwgPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCmNvbnN0IGhlbHBlckJvdHMgPSB7CiAgICAnY29uZmlnQm90JzogY29uZmlnQm90LAogICAgJ2dyaWRQb3J0YWxCb3QnOiBncmlkUG9ydGFsQm90LAogICAgJ3NoZWV0UG9ydGFsQm90Jzogc2hlZXRQb3J0YWxCb3QsCiAgICAnc3lzdGVtUG9ydGFsQm90Jzogc3lzdGVtUG9ydGFsQm90LAogICAgJ21pbmlHcmlkUG9ydGFsQm90JzogbWluaUdyaWRQb3J0YWxCb3QsCiAgICAnbWFwUG9ydGFsQm90JzogbWFwUG9ydGFsQm90LAogICAgJ21pbmlNYXBQb3J0YWxCb3QnOiBtaW5pTWFwUG9ydGFsQm90LAogICAgJ21lbnVQb3J0YWxCb3QnOiBtZW51UG9ydGFsQm90LAogICAgJ2xlZnRXcmlzdFBvcnRhbEJvdCc6IGxlZnRXcmlzdFBvcnRhbEJvdCwKICAgICdyaWdodFdyaXN0UG9ydGFsQm90JzogcmlnaHRXcmlzdFBvcnRhbEJvdCwKICAgICdtZWV0UG9ydGFsQm90JzogbWVldFBvcnRhbEJvdCwKICAgICd0YWdQb3J0YWxCb3QnOiB0YWdQb3J0YWxCb3QsCiAgICAnaW11UG9ydGFsQm90JzogaW11UG9ydGFsQm90LAp9OwoKLy8gRnVuY3Rpb24gdG8gcmVzb2x2ZSBhIHBvcnRhbCByZWZlcmVuY2UgdG8gYSBzcGVjaWZpYyBib3QKZnVuY3Rpb24gcmVzb2x2ZVBvcnRhbFRvQm90KHBhdGgpIHsKICAgIGlmICghcGF0aCB8fCBwYXRoID09PSAnJykgcmV0dXJuIG51bGw7CiAgICAKICAgIC8vIEZpcnN0IGNoZWNrIGlmIGl0J3MgZGlyZWN0bHkgaW4gaGVscGVyQm90cwogICAgaWYgKGhlbHBlckJvdHNbcGF0aF0pIHsKICAgICAgICByZXR1cm4gaGVscGVyQm90c1twYXRoXTsKICAgIH0KCiAgICAvLyBQZXJoYXBzIHRoZSBwYXRoIGlzIGEgYm90IGlkLgogICAgbGV0IGJvdEZyb21JZFNlYXJjaCA9IGdldEJvdCgnaWQnLCBwYXRoKTsKICAgIGlmIChib3RGcm9tSWRTZWFyY2gpIHsKICAgICAgICByZXR1cm4gYm90RnJvbUlkU2VhcmNoOwogICAgfQogICAgCiAgICAvLyBDaGVjayBmb3IgYm90aCBkaXJlY3QgYW5kIG5lc3RlZCBwYXRocyBpbiBnbG9iYWxUaGlzCiAgICBsZXQgcGF0aFBhcnRzID0gcGF0aC5zcGxpdCgnLicpOwogICAgbGV0IGN1cnJlbnRPYmogPSBnbG9iYWxUaGlzOwogICAgbGV0IHN0YXJ0SW5kZXggPSAwOwogICAgCiAgICAvLyBIYW5kbGUgaWYgdGhlIHBhdGggZXhwbGljaXRseSBzdGFydHMgd2l0aCAnZ2xvYmFsVGhpcycKICAgIGlmIChwYXRoUGFydHNbMF0gPT09ICdnbG9iYWxUaGlzJykgewogICAgICAgIHN0YXJ0SW5kZXggPSAxOyAvLyBTa2lwIHRoZSAnZ2xvYmFsVGhpcycgcGFydCBzaW5jZSB3ZSdyZSBhbHJlYWR5IHN0YXJ0aW5nIHRoZXJlCiAgICB9CiAgICAKICAgIC8vIFRyYXZlcnNlIHRoZSBwYXRoCiAgICBmb3IgKGxldCBpID0gc3RhcnRJbmRleDsgaSA8IHBhdGhQYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IHBhcnQgPSBwYXRoUGFydHNbaV07CiAgICAgICAgaWYgKCFjdXJyZW50T2JqW3BhcnRdKSB7CiAgICAgICAgICAgIHJldHVybiBudWxsOyAvLyBQYXRoIHNlZ21lbnQgZG9lc24ndCBleGlzdAogICAgICAgIH0KICAgICAgICBjdXJyZW50T2JqID0gY3VycmVudE9ialtwYXJ0XTsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgaWYgdGhlIGZpbmFsIG9iamVjdCBpcyBhIGJvdCAoaGFzIGlkIGFuZCB0YWdzKQogICAgaWYgKGN1cnJlbnRPYmogJiYgY3VycmVudE9iai5pZCAmJiBjdXJyZW50T2JqLnRhZ3MpIHsKICAgICAgICByZXR1cm4gY3VycmVudE9iajsKICAgIH0KICAgIAogICAgcmV0dXJuIG51bGw7IC8vIE5vdCBhIHZhbGlkIGJvdAp9CgovLyBTZWFyY2ggdG8gc2VlIGlmIHBvcnRhbCBhcmd1bWVudCBpcyBzcGVjaWZpYyB0byBhIGJvdApsZXQgdW5pcXVlQm90ID0gcmVzb2x2ZVBvcnRhbFRvQm90KHBvcnRhbCk7CgppZiAodW5pcXVlQm90KSB7CiAgICBpZiAodW5pcXVlQm90LnRhZ3Muc3BhY2UgPT09ICd0ZW1wTG9jYWwnIHx8CiAgICAgICAgdW5pcXVlQm90LnRhZ3Muc3BhY2UgPT09ICd0ZW1wU2hhcmVkJwogICAgKSB7CiAgICAgICAgLy8gRm9yY2Ugc2hlZXQgdG8gb3BlbiBpbiBzYW1lIHRhYiBpZiB0aGUgYm90IG9ubHkgbGl2ZXMgaW4gdGhpcyB0YWIuCiAgICAgICAgbmV3VGFiID0gZmFsc2U7CiAgICB9CiAgICBwb3J0YWwgPSB1bmlxdWVCb3QuaWQ7Cn0KCmlmIChuZXdUYWIpIHsKICAgIG9zLm9wZW5VUkwoYC8/aW5zdD0ke29zLmdldEN1cnJlbnRJbnN0KCl9JnNoZWV0UG9ydGFsPSR7cG9ydGFsfWApOwp9IGVsc2UgewogICAgY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgPSBwb3J0YWw7Cn0nAIv84PAHgeIFBmNtZElERQIEAIv84PAH448HuANAY29uc3QgYXJncyA9IHRoYXQ7Cgpjb25zdCB1cmwgPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCk7CgovLyBSZW1vdmUgYW55IHBvcnRhbHMgdGhhdCBhcmUgc2V0IGluIHRoZSBVUkwuCmxldCBwYXJhbXMgPSB1cmwuc2VhcmNoUGFyYW1zLmtleXMoKTsKZm9yIChsZXQgcGFyYW0gb2YgcGFyYW1zKSB7CiAgICBpZiAocGFyYW0uZW5kc1dpdGgoJ1BvcnRhbCcpKSB7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5kZWxldGUocGFyYW0pOwogICAgfQp9CgovLyBUdXJuIG9uIHRoZSBzeXN0ZW0gcG9ydGFsLgp1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZSgnc3lzdGVtVGFnTmFtZScpOwp1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtUG9ydGFsJywgJ3RydWUnKTsKdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3RoZW1lJywgJ2RhcmsnKTsKCm9zLm9wZW5VUkwodXJsLmhyZWYpOycAi/zg8AeB4gUNY21kRG93bmxvYWRBQgIEAIv84PAHnJMHzAhAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgYXV4VmVyc2lvbjogc3RyaW5nID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXYnKTsKCmlmICghYXV4VmVyc2lvbikgewogICAgLy8gRGVmYXVsdCB0byBhdXggdmVyc2lvbiAyIGlmIGFyZ3VtZW50IGlzIG5vdCBwcm92aWRlZC4KICAgIGF1eFZlcnNpb24gPSAnMic7Cn0KCmlmIChhdXhWZXJzaW9uICE9PSAnMScgJiYgYXV4VmVyc2lvbiAhPT0gJzInKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBPbmx5IGF1eCBmb3JtYXQgdmVyc2lvbiAxIGFuZCAyIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGRvd25sb2FkIGFiIGNvbW1hbmQuYCk7CiAgICByZXR1cm47Cn0KCmNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBc2xlZXAiLCAiYWJNYW5pZmVzdFN0YXRlIik7CgpsZXQgZ3JvdXAgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkQUJHcm91cCwgeyB0aXRsZTogJ0FCIEdyb3VwIFRhZycsIGF1dG9TZWxlY3Q6IHRydWUgfSk7Cm1hc2tzLnByZXZEb3dubG9hZEFCR3JvdXAgPSBncm91cDsKCmNvbnN0IG1ham9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWFqb3JWZXJzaW9uOwpjb25zdCBtaW5vclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1pbm9yVmVyc2lvbjsKY29uc3QgYWJWZXJzaW9uID0gYCR7bWFqb3JWZXJzaW9ufS4ke21pbm9yVmVyc2lvbn1gOwoKY29uc3QgYWJHcm91cCA9IGdldEJvdHMoZ3JvdXApOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBhYkdyb3VwLmxlbmd0aDsgaSsrKSB7CiAgICBhYkdyb3VwW2ldLnRhZ3MuYWJWZXJzaW9uID0gYWJWZXJzaW9uOwp9CgppZiAoZ3JvdXAgPT0gImFiQ29yZSIpIHsKICAgIGdyb3VwID0gImFiMSI7Cn0KCmlmIChhdXhWZXJzaW9uID09PSAnMScpIHsKICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMQogICAgb3MuZG93bmxvYWRCb3RzKGFiR3JvdXAsIGdyb3VwKQp9IGVsc2UgewogICAgLy8gRG93bmxvYWQgYXMgdmVyc2lvbiAyCiAgICBvcy5kb3dubG9hZEJvdHNBc0luaXRpYWx6YXRpb25VcGRhdGUoYWJHcm91cCwgZ3JvdXApOwp9CicAi/zg8AeB4gUJY21kQUJXYWtlAgQAi/zg8AfpmwezA0BsZXQgc2tpbGxBcnJheSA9IFsiYWJJbnRlcmZhY2UiLCAiYWJBY3Rpb24iLCAiYWJUZXN0cyJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwp9Cgphd2FpdCBvcy5zbGVlcCgzMDApOwoKLy9rZWVwIGFiIGF3YWtlCmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBd2FrZVN0YXRlID0gdHJ1ZTsKCmlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47Cn0KZWxzZSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkF3YWtlIiwgImFiTWFuaWZlc3RTdGF0ZSIpOycAi/zg8AeB4gUKY21kQUJTbGVlcAIEAIv84PAHnZ8H3QFAY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cgp0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOycAi/zg8AeB4gUHY29uc29sZQIEAIv84PAH+6AHKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAIv84PAHgeIFDmNtZFVwbG9hZEZpbGVzAgQAi/zg8AeioQeTEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScAi/zg8AeB4gUOY21kRG93bmxvYWRFZ2cCBACL/ODwB7axB/kLQGNvbnN0IHJlY29yZEtleSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXksIHsKICAgIHRpdGxlOiAncmVjb3JkIHRvIGxvb2t1cCBlZ2cgaW4nLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleTpgLCByZWNvcmRLZXkpOwoKaWYgKCFyZWNvcmRLZXkpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5ID0gcmVjb3JkS2V5OwoKY29uc3QgZWdnTmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lLCB7CiAgICB0aXRsZTogJ25hbWUgb2YgZWdnJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2dOYW1lOmAsIGVnZ05hbWUpOwoKaWYgKCFlZ2dOYW1lKSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUgPSBlZ2dOYW1lOwoKY29uc3QgZWdnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgIGFiSUQ6IGVnZ05hbWUsCiAgICByZWNvcmRLZXksCiAgICByZXR1cm5UeXBlOiAnZWdnJwp9KQoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2c6YCwgZWdnKTsKCmlmICghQXJyYXkuaXNBcnJheShlZ2cuZWdnVmVyc2lvbkhpc3RvcnkpIHx8IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYERhdGEgZm91bmQgYXQgYWRkcmVzcyAnJHtlZ2dOYW1lfScgaW4gcmVjb3JkICcke3JlY29yZEtleX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlZ2cuYCkKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBlZ2dWZXJzaW9uT3B0aW9ucyA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7CiAgICByZXR1cm4geyBsYWJlbDogYHZlcnNpb24gJHtpbmRleCArIDF9YCwgdmFsdWU6IGluZGV4IH0KfSkKCmNvbnN0IHNlbGVjdGVkVmVyc2lvbk9wdGlvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChlZ2dWZXJzaW9uT3B0aW9ucy5sZW5ndGggLSAxLCB7CiAgICB0aXRsZTogJ2Rvd25sb2FkIGVnZyB2ZXJzaW9uJywKICAgIHR5cGU6ICdsaXN0JywKICAgIHN1YnR5cGU6ICdzZWxlY3QnLAogICAgaXRlbXM6IGVnZ1ZlcnNpb25PcHRpb25zLAp9KQoKaWYgKCFzZWxlY3RlZFZlcnNpb25PcHRpb24pIHsKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBhdXhEYXRhVXJsID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5W3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZV07CmNvbnN0IGF1eERhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGF1eERhdGFVcmwpOwpjb25zdCBhdXhGaWxlbmFtZSA9IGAke2VnZ05hbWV9X3Yke3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZSArIDF9LmF1eGA7Cgpvcy5kb3dubG9hZChhdXhEYXRhLCBhdXhGaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsnAIv84PAHgeIFD2NtZERvd25sb2FkSW5zdAIEAIv84PAHsL0Hb0Bjb25zdCBhcmdzID0gdGhhdDsKCm9zLmRvd25sb2FkQm90cyhnZXRCb3RzKGJ5TW9kKHsgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbCB9KSksIG9zLmdldEN1cnJlbnRJbnN0KCkpOycAi/zg8AeB4gUGc2VhcmNoAgQAi/zg8Aegvgco8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAi/zg8AeB4gUFdXRpbHMCBACL/ODwB8e+Byjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjAA=="}]}