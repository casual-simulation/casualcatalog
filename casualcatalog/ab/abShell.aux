{"version":2,"updates":[{"id":0,"timestamp":1754323482371,"update":"AckD4a3mmQ0AJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwDhreaZDQAGc3lzdGVtAgQA4a3mmQ0BDWFiLnNoZWxsLmdyaWQnAOGt5pkNAARmb3JtAgQA4a3mmQ0PB25vdGhpbmcnAOGt5pkNAAxvbkFueUJvdERyYWcCBADhreaZDRe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAOGt5pkNAAhyZW1lbWJlcgIEAOGt5pkN0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA4a3mmQ0ACGFiSWdub3JlAgQA4a3mmQ36AQR0cnVlJwDhreaZDQAHYWJTaGVsbAIEAOGt5pkN/wEEdHJ1ZScA4a3mmQ0ACWFiVmVyc2lvbgIEAOGt5pkNhAIEMTAuNScA4a3mmQ0ABWZvY3VzAgQA4a3mmQ2JAqwEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKTsKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScA4a3mmQ22BgZzeXN0ZW0CBADhreaZDbcGE2FiLnNoZWxsLmNvbXBvbmVudHMnAOGt5pkNtgYMQXBwQ29udGFpbmVyAgQA4a3mmQ3LBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycA4a3mmQ22BghUZXh0TGluawIEAOGt5pkN+AqjA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgICAgICAgICAgICAgJy0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvcic6IGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCbHVlcHJpbnRDb2xvcgogICAgICAgICAgICB9fQogICAgICAgID57Y2hpbGRyZW59PC9zcGFuPgogICAgKQp9CgpyZXR1cm4gVGV4dExpbms7JwDhreaZDbYGBldpbmRvdwIEAOGt5pkNnA62AkBjb25zdCBXaW5kb3cgPSAoewogICAgaWQsCiAgICBkaXNhYmxlU2hhZG93LAogICAgY2hpbGRyZW4sCn0pID0+IHsKCiAgICBsZXQgd2luZG93Q2xhc3NOYW1lID0gJ2FiLWFwcC13aW5kb3cnOwoKICAgIGlmIChkaXNhYmxlU2hhZG93KSB7CiAgICAgICAgd2luZG93Q2xhc3NOYW1lICs9ICcgbm8tc2hhZG93JzsKICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYgaWQ9e2lkfSBjbGFzc05hbWU9e3dpbmRvd0NsYXNzTmFtZX0+CiAgICAgICAgICAgIHtjaGlsZHJlbn0KICAgICAgICA8L2Rpdj4KICAgICkKfQoKcmV0dXJuIFdpbmRvdzsnAOGt5pkNtgYMVGV4dExpbmsuY3NzAgQA4a3mmQ3TEO0BLmFiLWFwcC10ZXh0LWxpbmsgewogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWNvbG9yLCByZ2IoNzEgMjU1IDEzNykpOwp9CgouYWItYXBwLXRleHQtbGluazpob3ZlciB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiB2YXIoLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yLCByZ2IoMCAxOTIgMjU1KSk7Cn0KCi5hYi1hcHAtdGV4dC1saW5rLmJvbGQgewogIGZvbnQtd2VpZ2h0OiBib2xkOwp9JwDhreaZDbYGFUJhY2tncm91bmRPdmVybGF5LmNzcwIEAOGt5pkNwRJxLmFiLWFwcC1iZyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiByZ2JhKDAsIDAsIDAsIDAuMzMpOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7Cn0nAOGt5pkNtgYKV2luZG93LmNzcwIEAOGt5pkNsxOoAy5hYi1hcHAtd2luZG93IHsKICAgIHBvc2l0aW9uOiBmaXhlZDsKICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7CiAgICBjb2xvcjogd2hpdGU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjMmYyZjJmOwogICAgd2lkdGg6IDgwdnc7CiAgICBoZWlnaHQ6IDcwdmg7CiAgICBtYXgtd2lkdGg6IDE1MDBweDsKICAgIG1heC1oZWlnaHQ6IDEwMDBweDsKICAgIGxlZnQ6IDUwJTsKICAgIHRvcDogNTAlOwogICAgdHJhbnNmb3JtOiB0cmFuc2xhdGUoLTUwJSwgLTUwJSk7CiAgICBib3gtc2hhZG93OiAwcHggMHB4IDEycHggMHB4IGJsYWNrOwogICAgb3ZlcmZsb3c6IGF1dG87CiAgICBwYWRkaW5nLWxlZnQ6IDhweDsKICAgIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKLmFiLWFwcC13aW5kb3cubm8tc2hhZG93IHsKICAgIGJveC1zaGFkb3c6IG5vbmU7Cn0nAOGt5pkNtgYIcmVtZW1iZXICBADhreaZDdwWKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAOGt5pkNtgYIYWJJZ25vcmUCBADhreaZDYMXBHRydWUnAOGt5pkNtgYHYWJTaGVsbAIEAOGt5pkNiBcEdHJ1ZScA4a3mmQ22BglhYlZlcnNpb24CBADhreaZDY0XBDEwLjUnAOGt5pkNtgYLcGVyc29uYWxpdHkCBADhreaZDZIXKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAQRib3RzJDI0YjdlNjZmLTBkNWItNDA2NC1iZjQ4LWI1NjJiOWU2ZTNlYgEnAOGt5pkNuRcHQXBwLmNzcwIEAOGt5pkNuhexFjpyb290IHsKICAtLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgLS1vbi1hYi1jb25zb2xlLWJnOiAjMjEyNTI5OwogIC0tYWItY29uc29sZS1oZWlnaHQ6IDMzdmg7Cn0KLyogRGFyayBtb2RlIHN1cHBvcnQgKi8KQG1lZGlhIChwcmVmZXJzLWNvbG9yLXNjaGVtZTogZGFyaykgewogIDpyb290IHsKICAgIC0tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAgIC0tb24tYWItY29uc29sZS1iZzogI2Y4ZjlmYTsKICB9Cn0KCi5hYi1jb25zb2xlLWJ0biB7CiAgY3Vyc29yOiBwb2ludGVyOwogIGNvbG9yOiBpbmhlcml0OwogIGxldHRlci1zcGFjaW5nOiBpbmhlcml0OwogIGxpbmUtaGVpZ2h0OiBpbmhlcml0OwogIHRleHQtdHJhbnNmb3JtOiBpbmhlcml0OwogIHRleHQtaW5kZW50OiBpbmhlcml0OwogIHRleHQtc2hhZG93OiBpbmhlcml0OwogIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgbWFyZ2luOiBpbmhlcml0OwogIHBhZGRpbmctYmxvY2s6IGluaGVyaXQ7CiAgcGFkZGluZy1pbmxpbmU6IGluaGVyaXQ7CiAgYm9yZGVyOiBub25lOwogIHRyYW5zZm9ybTogc2NhbGUoMS4yKTsKfQoKLmFiLWNvbnNvbGUgewogIHdpZHRoOiAxMDB2dzsKICBtYXgtaGVpZ2h0OiB2YXIoLS1hYi1jb25zb2xlLWhlaWdodCk7CiAgZGlzcGxheTogZmxleDsKICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogIHBhZGRpbmc6IDA7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogIGJhY2tkcm9wLWZpbHRlcjogYmx1cigxMHB4KSBicmlnaHRuZXNzKDIwMCUpOwogIGFuaW1hdGlvbi1uYW1lOiBzbGlkZS1hcHAtaW47CiAgYW5pbWF0aW9uLWR1cmF0aW9uOiAwLjVzOwogIG92ZXJmbG93LXk6IGhpZGRlbjsKICB6LWluZGV4OiAxOwp9CgouYWItY29uc29sZTo6YWZ0ZXIgewogIGNvbnRlbnQ6ICIiOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICB0b3A6IDA7CiAgbGVmdDogMDsKICByaWdodDogMDsKICBib3R0b206IDA7CiAgb3BhY2l0eTogMC45OwogIHotaW5kZXg6IDA7Cn0KCkBrZXlmcmFtZXMgc2xpZGUtYXBwLWluIHsKICBmcm9tIHsKICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGN1YmljLWJlemllciguNiwwLC43OSwxLjAzKTsKICAgIC8qIHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMTAlKTsgKi8KICAgIC8qIGhlaWdodDogMHB4OyAqLwogICAgLyogbWluLWhlaWdodDogMHB4OyAqLwogICAgbWF4LWhlaWdodDogMHB4OwogIH0KCiAgdG8gewogICAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogICAgLyogbWluLWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOyAqLwogIH0KfQoKLmFiLWNvbnNvbGUgPiBkaXYgewogIHotaW5kZXg6IDE7CiAgcG9zaXRpb246IHJlbGF0aXZlCn0KCi5hYi1jb25zb2xlLXRvcC1iYXIgewogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIHdpZHRoOiAxMDAlOwogIHRleHQtYWxpZ246IGNlbnRlcjsKICB1c2VyLXNlbGVjdDogbm9uZTsKICBkaXNwbGF5OiBmbGV4OwogIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAganVzdGlmeS1jb250ZW50OiBlbmQ7CiAgcGFkZGluZzogMC41cmVtOwp9CgouYWItY29uc29sZS1sb2cgewogIG92ZXJmbG93LXk6IGF1dG87CiAgZmxleC1ncm93OiAxOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbi1yZXZlcnNlOwogIG1pbi1oZWlnaHQ6IDI0cHg7CiAgcGFkZGluZzogMCAxcmVtOwogIGN1cnNvcjogcG9pbnRlcjsKICBvdmVyc2Nyb2xsLWJlaGF2aW9yOiBjb250YWluOwp9CgouYWItY29uc29sZS1jb250ZW50IHsKICBjdXJzb3I6IGluaXRpYWw7Cn0KCi5hYi1jb25zb2xlLW1lc3NhZ2UtY29udGFpbmVyIHsKICBtYXJnaW46IDAuNXJlbSAwOwp9Ci5hYi1jb25zb2xlLW1lc3NhZ2UgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGdhcDogOHB4Owp9CgouYWItY29uc29sZS1zcGFjZXIgewogIGZsZXgtc2hyaW5rOiAwOwogIGZsZXgtZ3JvdzogMTsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgbWF4LXdpZHRoOiA4MHZ3OwogIGJvcmRlci1yYWRpdXM6IDAuMjVyZW07CiAgYmFja2dyb3VuZC1jb2xvcjogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwp9CgouYWItY29uc29sZS10aW1lc3RhbXAgewogIG9wYWNpdHk6IDAuNjsKfQoKLmNvbnNvbGUtc2VuZC1idG4gewogIG1hcmdpbjogMCAhaW1wb3J0YW50OwogIHBhZGRpbmc6IDAgMXJlbSAhaW1wb3J0YW50OwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLmNvbnNvbGUtc2VuZC1idG4gPiBzcGFuIHsKICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoM3B4KQp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgewogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IHJvdzsKICBnYXA6IDAuNzVyZW07CiAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgouYWItY29uc29sZS1pbnB1dC1jb250YWluZXIgPiBpbnB1dCB7CiAgYmFja2dyb3VuZDogdmFyKC0tYWItY29uc29sZS1iZyk7CiAgY29sb3I6IHZhcigtLW9uLWFiLWNvbnNvbGUtYmcpOwogIGZsZXgtZ3JvdzogMTsKICBvdXRsaW5lOiBub25lOwogIGJvcmRlcjogbm9uZTsKICBwYWRkaW5nOiAxcmVtOwogIGJvcmRlci1yYWRpdXM6IDRweDsKfScA4a3mmQ25FwZnZXRBcHACBADhreaZDewt3SNAY29uc3QgeyB1c2VFZmZlY3QsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VSZWYgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCk7CmNvbnN0IE1lc3NhZ2UgPSB0aGlzQm90Lk1lc3NhZ2UoKTsKCmNvbnN0IEFwcCA9ICgpID0+IHsKICAgIGNvbnN0IFtwb2ludGVyRG93blBvcywgc2V0UG9pbnRlckRvd25Qb3NdID0gdXNlU3RhdGUoe3g6IC0xLCB5OiAtMX0pOwogICAgY29uc3QgW2NvbnNvbGVMb2csIHNldENvbnNvbGVMb2ddID0gdXNlU3RhdGUoW10pOwogICAgY29uc3QgW3Nob3dDaGF0LCBzZXRTaG93Q2hhdF0gPSB1c2VTdGF0ZSh0YWdzLnNob3dDaGF0SW5wdXQpOwogICAgY29uc3QgW3VzZXJJbnB1dCwgc2V0VXNlcklucHV0XSA9IHVzZVN0YXRlKCcnKTsKICAgIGNvbnN0IFtzaG93QWxsLCBzZXRTaG93QWxsXSA9IHVzZVN0YXRlKGZhbHNlKTsKICAgIGNvbnN0IGlucHV0UmVmID0gdXNlUmVmKCk7CgogICAgY29uc3QgdXBkYXRlTG9nID0gKCkgPT4gewogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBib3RzID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHM7CiAgICAgICAgY29uc3QgbWVzc2FnZUxvZ0FyciA9IFtdOwoKICAgICAgICBmb3IgKGNvbnN0IGJvdElEIG9mIGJvdHMpIHsKICAgICAgICAgICAgY29uc3QgbWVzc2FnZUJvdCA9IGdldEJvdCgiaWQiLCBib3RJRCk7CiAgICAgICAgICAgIGlmIChtZXNzYWdlQm90KSB7CiAgICAgICAgICAgICAgICBtZXNzYWdlTG9nQXJyLnB1c2goewogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2VCb3QudGFncy5tZXNzYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbWVzc2FnZUJvdC50YWdzLnRpbWVzdGFtcCwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlQm90LnRhZ3MubmFtZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbWVzc2FnZUxvZ0Fyci5zb3J0KCAoYSwgYikgPT4gbmV3IERhdGUoYS50aW1lc3RhbXApIDwgbmV3IERhdGUoYi50aW1lc3RhbXApID8gMSA6IC0xICk7CgogICAgICAgIHNldENvbnNvbGVMb2cobWVzc2FnZUxvZ0Fycik7CiAgICB9CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gdXBkYXRlTG9nOwogICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gc2V0U2hvd0FsbDsKCiAgICAgICAgdXBkYXRlTG9nKCk7CgogICAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgICAgICB0aGlzQm90LnZhcnMudXBkYXRlTG9nID0gbnVsbDsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgPSBudWxsOwogICAgICAgIH0pOwogICAgfSwgW10pOwoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgaWYgKGlucHV0UmVmLmN1cnJlbnQpIGlucHV0UmVmLmN1cnJlbnQuZm9jdXMoKTsKICAgIH0sIFtzaG93Q2hhdF0pOwoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJEb3duID0gKGUpID0+IHsKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7CiAgICAgICAgICAgIHg6IGUuY2xpZW50WCwKICAgICAgICAgICAgeTogZS5jbGllbnRZLAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlUG9pbnRlclVwID0gKGUpID0+IHsKICAgICAgICBjb25zdCBkaWZmWCA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHBvaW50ZXJEb3duUG9zLngpOwogICAgICAgIGNvbnN0IGRpZmZZID0gTWF0aC5hYnMoZS5jbGllbnRZIC0gcG9pbnRlckRvd25Qb3MueSk7CgogICAgICAgIGlmIChkaWZmWCA8IDUgJiYgZGlmZlkgPCA1KSB7CiAgICAgICAgICAgIHNldFNob3dBbGwocyA9PiAhcyk7CiAgICAgICAgfQoKICAgICAgICBzZXRQb2ludGVyRG93blBvcyh7eDogLTEsIHk6IC0xfSk7CiAgICB9CgogICAgY29uc3QgaGFuZGxlU3VibWl0ID0gKCkgPT4gewogICAgICAgIGlmICh1c2VySW5wdXQpIHsKICAgICAgICAgICAgd2hpc3BlcihnZXRCb3QoJ3N5c3RlbScsICdhYi5hY3Rpb24uYXNrJyksICdhYkNvcmVNZW51QWN0aW9uJywgdXNlcklucHV0KQogICAgICAgICAgICBzZXRVc2VySW5wdXQoJycpOwogICAgICAgICAgICBjb25zb2xlLmxvZygiaW5wdXRSZWY6IiwgaW5wdXRSZWYuY3VycmVudCk7CiAgICAgICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LnZhbHVlID0gJyc7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8c3R5bGU+e3RhZ3NbJ0FwcC5jc3MnXX08L3N0eWxlPgoKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGlkPSJhYi1jb25zb2xlIgogICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUiCiAgICAgICAgICAgIG9uUG9pbnRlckVudGVyPXsoZSkgPT4gewogICAgICAgICAgICAgICAgZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9fQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC5pZCA9PSAiYWItY29uc29sZSIpewogICAgICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSB0cnVlOyAKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfX0KICAgICAgICA+CiAgICAgICAgICAgIHt0YWdzLnNob3dUb3BCYXIgJiYgPFRvcEJhciAvPn0KCiAgICAgICAgICAgIDxkaXYKICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1sb2ciCiAgICAgICAgICAgICAgICBvblBvaW50ZXJEb3duPXtoYW5kbGVQb2ludGVyRG93bn0KICAgICAgICAgICAgICAgIG9uUG9pbnRlclVwPXtoYW5kbGVQb2ludGVyVXB9CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHsvKiBNZXNzYWdlIGhpc3RvcnkgKi8gQXJyYXkuaXNBcnJheShjb25zb2xlTG9nKQogICAgICAgICAgICAgICAgPyBzaG93QWxsCiAgICAgICAgICAgICAgICAgICAgPyBjb25zb2xlTG9nLm1hcCgobSwgaSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW0gfHwgIW0udGltZXN0YW1wIHx8ICFtLm1lc3NhZ2UpIHsgcmV0dXJuIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wPXttLnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXttLm1lc3NhZ2V9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17bS5uYW1lfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT17YG1lc3NhZ2UtJHtpfWB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgICAgICAgICApfSkKICAgICAgICAgICAgICAgICAgICA6IDxNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17Y29uc29sZUxvZ1swXT8udGltZXN0YW1wfQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlPXtjb25zb2xlTG9nWzBdPy5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICBuYW1lPXtjb25zb2xlTG9nWzBdPy5uYW1lfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICA6IDw+PC8+fQoKICAgICAgICAgICAgPC9kaXY+CgogICAgICAgICAgICAgICAge3Nob3dDaGF0ICYmCiAgICAgICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWlucHV0LWNvbnRhaW5lciIKICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICA8aW5wdXQKICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9ImFzayBhYi0xIgogICAgICAgICAgICAgICAgICAgICAgICBvbkNoYW5nZT17ZSA9PiBzZXRVc2VySW5wdXQoZS50YXJnZXQudmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBvbktleURvd249e2UgPT4geyBpZiAoZS5rZXkgPT09ICdFbnRlcicpIGhhbmRsZVN1Ym1pdCgpIH19CiAgICAgICAgICAgICAgICAgICAgICAgIHJlZj17aW5wdXRSZWZ9CiAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gY29uc29sZS1zZW5kLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17aGFuZGxlU3VibWl0fQogICAgICAgICAgICAgICAgICAgICAgICBzdHlsZT17ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiAnNDBweCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aWR0aDogJzQ4cHgnLAogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgID5zZW5kPC9idXR0b24+CiAgICAgICAgICAgICAgICA8L2Rpdj59CiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBBcHAKJwDhreaZDbkXC2hpZGVDb25zb2xlAgQA4a3mmQ3KUZ8BQHZhciBjdXJyZW50VmVyID0gbWFza3MuY29uc29sZVZlcnNpb24gPz8gMDsKYXdhaXQgb3MudW5yZWdpc3RlckFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCk7Cm1hc2tzLm9wZW4gPSBmYWxzZTsKZ3JpZFBvcnRhbEJvdC5tYXNrcy5wb3J0YWxab29tYWJsZSA9IG51bGw7JwDhreaZDbkXA2xvZwIEAOGt5pkN6lLkCEBsZXQgYm90VGFncyA9IHt9OwoKY29uc3QgX3RpbWVzdGFtcCA9IG9zLmlzQ29sbGFib3JhdGl2ZSgpID8gb3MuYWdyZWVkVXBvblRpbWUgOiBvcy5sb2NhbFRpbWUKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIGNvbnN0IF9tZXNzYWdlVGV4dCA9IFN0cmluZyh0aGF0KS5zcGxpdCgnOiAnKTsKICAgIGNvbnN0IF9uYW1lID0gX21lc3NhZ2VUZXh0LnNoaWZ0KCk7CgogICAgaWYgKCF0aGF0LmluY2x1ZGVzKCc6ICcpKSB7CiAgICAgICAgYm90VGFncyA9IHsKICAgICAgICAgICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgICAgICAgICBuYW1lOiAiIiwKICAgICAgICAgICAgbWVzc2FnZTogdGhhdCwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogX25hbWUsCiAgICAgICAgICAgIG1lc3NhZ2U6IF9tZXNzYWdlVGV4dC5qb2luKCc6ICcpLAogICAgICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgICAgIHRpbWVzdGFtcDogX3RpbWVzdGFtcCwKICAgICAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIgogICAgICAgIH0KICAgIH0KCn0gZWxzZSB7CiAgICBib3RUYWdzID0gewogICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgY2xlYXJDb25zb2xlTG9nQm90czogIkBkZXN0cm95KHRoaXMpIiwKICAgICAgICAuLi50aGF0CiAgICB9Cn0KCmNvbnN0IGxvZ0JvdCA9IGNyZWF0ZShib3RUYWdzKTsKCmlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwDhreaZDbkXC3Nob3dDb25zb2xlAgQA4a3mmQ3PW+0DQGlmIChtYXNrcy5vcGVuKSB7IHJldHVybiB9OwoKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7CgovLyBVbnJlZ2lzdGVyIGluIGNhc2UgaXQgd2FzIGFscmVhZHkgb3Blbgp2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwoKY3VycmVudFZlciArPSAxOwptYXNrcy5jb25zb2xlVmVyc2lvbiA9IGN1cnJlbnRWZXI7Ci8vIEdldCwgcmVnaXN0ZXIsIGFuZCBjb21waWxlIHRoZSBhcHAKY29uc3QgQXBwID0gdGhpc0JvdC5nZXRBcHAoKTsKYXdhaXQgb3MucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWAsIHRoaXNCb3QpOwpvcy5jb21waWxlQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCA8QXBwIC8+KTsKbWFza3Mub3BlbiA9IHRydWU7CicA4a3mmQ25FwZzeXN0ZW0CBADhreaZDb1fEGFiLnNoZWxsLmNvbnNvbGUnAOGt5pkNuRcNdG9nZ2xlQ29uc29sZQIEAOGt5pkNzl+WAUBpZiAobWFza3Mub3BlbikgewogICAgd2hpc3Blcih0aGlzQm90LCAiaGlkZUNvbnNvbGUiKTsKICAgIG1hc2tzLm9wZW4gPSBmYWxzZTsKfSBlbHNlIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgInNob3dDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gdHJ1ZTsKfScA4a3mmQ25FwRmb3JtAgQA4a3mmQ3lYAdub3RoaW5nJwDhreaZDbkXB2FiU2hlbGwCBADhreaZDe1gBHRydWUnAOGt5pkNuRcKYWJJRE9yaWdpbgIEAOGt5pkN8mAVYWJDb25zb2xlIHVwZGF0ZSA3LTE2JwDhreaZDbkXBlRvcEJhcgIEAOGt5pkNiGHzBEBjb25zdCBvZmZzZXQgPSA4CmNvbnN0IGluaXRpYWxIZWlnaHQgPSAyNTYKY29uc3QgZHJhZ0ludGVydmFsID0gMjUKCmNvbnN0IEJ1dHRvbnNCYXIgPSAoKSA9PiB7CgogICAgY29uc3QgaGFuZGxlQ2xvc2UgPSAoKSA9PiB7CiAgICAgICAgc2hvdXQoJ2hpZGVDb25zb2xlJyk7CiAgICB9CgogICAgcmV0dXJuICg8PgogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLXRvcC1iYXIiCiAgICAgICAgPgoKICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWJ0biBtZC1pY29uIG1kLWljb24tZm9udCIKICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZUNsb3NlfQogICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICB0b3A6ICI4cHgiLAogICAgICAgICAgICAgICAgICAgIHJpZ2h0OiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICB6SW5kZXg6IDIsCiAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICBjbG9zZQogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgCiAgICAgICAgPC9kaXY+CiAgICA8Lz4pCn0KCnJldHVybiBCdXR0b25zQmFyCicA4a3mmQ25Fw1zaG93Q2hhdElucHV0AgQA4a3mmQ38ZQVmYWxzZScA4a3mmQ25FwpzaG93VG9wQmFyAgQA4a3mmQ2CZgVmYWxzZScA4a3mmQ25FwlhYlZlcnNpb24CBADhreaZDYhmBDEwLjUnAOGt5pkNuRcSc2V0QWJFeHBhbmRDb25zb2xlAgQA4a3mmQ2NZpcCQGNvbnNvbGUubG9nKHRoaXNCb3QudmFycy5zZXRTaG93QWxsKQppZiAodHlwZW9mIHRoaXNCb3QudmFycy5zZXRTaG93QWxsICE9PSAnZnVuY3Rpb24nKSB7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0ID09PSB1bmRlZmluZWQpIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKHMgPT4gIXMpOwp9IGVsc2UgaWYgKHRoYXQgPT0gdHJ1ZSkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwodHJ1ZSk7Cn0gZWxzZSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbChmYWxzZSk7Cn0KJwDhreaZDbkXCGFiSWdub3JlAgQA4a3mmQ2laAR0cnVlJwDhreaZDbkXB01lc3NhZ2UCBADhreaZDapo5xBAY29uc3QgeyB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlRWZmZWN0IH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpCgpjb25zdCBNZXNzYWdlID0gKHsgdGltZXN0YW1wLCBtZXNzYWdlLCBuYW1lIH0pID0+IHsKICAgIGNvbnN0IFtzaG93VGltZSwgc2V0U2hvd1RpbWVdID0gdXNlU3RhdGUoZmFsc2UpOwogICAgY29uc3QgW3VzZXJNZXNzYWdlLCBzZXRVc2VyTWVzc2FnZV0gPSB1c2VTdGF0ZShmYWxzZSk7CgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBpZiAoYXV0aEJvdCAmJiBhdXRoQm90LnRhZ3MubmFtZSkgewogICAgICAgICAgICBpZiAoYXV0aEJvdC50YWdzLm5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSkgewogICAgICAgICAgICAgICAgaWYgKG1hc2tzLnByZWZlcnJlZE5hbWUgPT0gbmFtZSkgewogICAgICAgICAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0gCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuYW1lID09ICJ1c2VyIiB8fCBuYW1lID09ICJVc2VyIikgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzZXRVc2VyTWVzc2FnZShmYWxzZSk7CiAgICAgICAgfQoKICAgIH0sIFtuYW1lXSkKCiAgICBjb25zdCB0aW1lVGV4dCA9IHVzZU1lbW8oCiAgICAgICAgKCkgPT4gewogICAgICAgICAgICBpZiAoIXRpbWVzdGFtcCkgeyByZXR1cm4gfQogICAgICAgICAgICByZXR1cm4gbmV3IERhdGUodGltZXN0YW1wKS50b0xvY2FsZVN0cmluZygKICAgICAgICAgICAgICAgICAgICdlbi11cycsIHt0aW1lU3R5bGU6ICdtZWRpdW0nfSl9LAogICAgICAgIFt0aW1lc3RhbXBdCiAgICApOwoKICAgIGlmICghdGltZXN0YW1wIHx8ICFtZXNzYWdlKSB7IHJldHVybiA8PjwvPiB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciIKICAgICAgICAgICAgb25Qb2ludGVyRW50ZXI9eygpID0+IHNldFNob3dUaW1lKHRydWUpfQogICAgICAgICAgICBvblBvaW50ZXJMZWF2ZT17KCkgPT4gc2V0U2hvd1RpbWUoZmFsc2UpfQogICAgICAgID4KICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgc3R5bGU9e3VzZXJNZXNzYWdlICYmIHt0ZXh0QWxpZ246ICdyaWdodCd9fQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7bmFtZX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UiIHN0eWxlPXt7CiAgICAgICAgICAgICAgICBmbGV4RGlyZWN0aW9uOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyAncm93JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAncm93LXJldmVyc2UnCiAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtc3BhY2VyIgogICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRBbGlnbjogdXNlck1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyaWdodCcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdsZWZ0JywKICAgICAgICAgICAgICAgICAgICAgICAgb3BhY2l0eTogc2hvd1RpbWUgPyAwLjYgOiAwCiAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgICB7dGltZVRleHR9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJhYi1jb25zb2xlLWNvbnRlbnQiPgogICAgICAgICAgICAgICAgICAgIHttZXNzYWdlfQogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gTWVzc2FnZTsnAOGt5pkNuRcQb25BbnlCb3RzUmVtb3ZlZAIEAOGt5pkNknmtAkBjb25zdCB7IGJvdElEcyB9ID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3RJZCBvZiBib3RJRHMpIHsNCiAgICBpZiAodGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgY29uc3QgZGVsZXRlZCA9IHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmRlbGV0ZShib3RJZCk7DQoNCiAgICAgICAgaWYgKGRlbGV0ZWQpIHsNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdElkOiBib3RJZCB9KTsNCiAgICAgICAgfQ0KICAgIH0NCn0nAOGt5pkNuRcOb25BbnlCb3RzQWRkZWQCBADhreaZDcB7+ANAY29uc3QgeyBib3RzIH0gPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IG5ld0JvdCBvZiBib3RzKSB7DQogICAgaWYgKG5ld0JvdC50YWdzLmNvbnNvbGVMb2dNZXNzYWdlQm90ID09PSB0cnVlKSB7DQogICAgICAgIC8vIEluaXQgbWVzc2FnZSBib3QgaWQgdHJhY2tpbmcgc2V0IGlmIG5lZWRlZC4NCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICAgICAgdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMgPSBuZXcgU2V0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmhhcyhuZXdCb3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQobmV3Qm90LmlkKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdDogbmV3Qm90IH0pOw0KICAgIH0NCn0nAOGt5pkNuRcQb25BbnlCb3RzQ2hhbmdlZAIEAOGt5pkNuX/jBUBjb25zdCBib3RzID0gdGhhdDsNCg0KZm9yIChjb25zdCBib3Qgb2YgYm90cykgew0KICAgIGlmIChib3QuYm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKGJvdC5ib3QuaWQpKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5hZGQoYm90LmJvdC5pZCk7DQoNCiAgICAgICAgICAgIHNob3V0KCdvbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZCcsIHsgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IGJvdC5ib3QgfSk7DQogICAgICAgIH0gDQoNCiAgICAgICAgaWYgKGJvdC50YWdzLmluY2x1ZGVzKCJtZXNzYWdlIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoIm5hbWUiKSB8fCBib3QudGFncy5pbmNsdWRlcygidGltZXN0YW1wIikgfHwgYm90LnRhZ3MuaW5jbHVkZXMoImNvbnNvbGVMb2dNZXNzYWdlQm90IikpIHsNCiAgICAgICAgICAgIGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7ICAgICAgICANCiAgICAgICAgfQ0KICAgIH0NCn0nAOGt5pkNuRcfb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90UmVtb3ZlZAIEAOGt5pkNnYUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycA4a3mmQ25Fx1vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RBZGRlZAIEAOGt5pkN1IUBNkBpZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycBBGJvdHMkMjRkYzA0MzEtZmZiYi00NDhkLWFhNzUtOTcxYmFhMDcxOGRjAScA4a3mmQ2LhgEGc3lzdGVtAgQA4a3mmQ2MhgENYWIuc2hlbGwuaGVscCcA4a3mmQ2LhgEJb25LZXlEb3duAgQA4a3mmQ2ahgGMAkBpZiAodGFncy5oZWxwQWN0aXZlICYmIHRoYXQua2V5cy5pbmNsdWRlcygnRXNjYXBlJykpIHsKICAgIGlmICh0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcykgewogICAgICAgIGZvciAobGV0IGNhbGxiYWNrIG9mIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0nAOGt5pkNi4YBB3VubW91bnQCBADhreaZDaeIAaABQGF3YWl0IG9zLmNvbXBpbGVBcHAoJ2FiLWNvbW1hbmQtaGVscCcsIDw+PC8+KTsKYXdhaXQgb3MudW5yZWdpc3RlckFwcCgnYWItY29tbWFuZC1oZWxwJyk7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IHVuZGVmaW5lZDsKbWFza3MuaGVscEFjdGl2ZSA9IGZhbHNlOycA4a3mmQ2LhgEJc3R5bGUuY3NzAgQA4a3mmQ3IiQHxBy5oZWxwLXRhYmxlIHsKICB3aWR0aDogMTAwJTsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLmhlbHAtdGFibGUgdGQgewogIHZlcnRpY2FsLWFsaWduOiB0b3A7CiAgcGFkZGluZy1ib3R0b206IDhweDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7Cn0KCi5oZWxwLXRhYmxlIHRkIGgzIHsKICBtYXJnaW46IDA7Cn0KCi5oZWxwLXRhYmxlIHRkOmZpcnN0LWNoaWxkIHsKICBtaW4td2lkdGg6IDkwcHg7CiAgcGFkZGluZy1yaWdodDogOHB4Owp9Cgouc2VjdGlvbiB7CiAgbWFyZ2luLXRvcDogMTZweDsKfQoKLnNlY3Rpb24gcDpmaXJzdC1vZi10eXBlIHsKICBtYXJnaW4tdG9wOiA0cHg7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5kZXNjcmlwdGlvbiB7IAogIHdoaXRlLXNwYWNlOiBwcmUtbGluZTsKfQoKLnVzYWdlLXRhYmxlIHsKICBib3JkZXItc3BhY2luZzogMDsKfQoKLnVzYWdlLXRhYmxlIHRkLGgzIHsgCiAgdmVydGljYWwtYWxpZ246IHRvcDsKICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgbWFyZ2luOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogNjBweDsKfQoKLmFyZ3MtdGFibGUgewogIG1hcmdpbi1sZWZ0OiAxNnB4Owp9CgouYXJncy10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmFyZ3MtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCkBtZWRpYSAobWF4LXdpZHRoOiA2NDBweCksIChtYXgtaGVpZ2h0OiA2MDBweCkgewogIC5oZWxwLXdpbmRvdyB7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGxlZnQ6IHVuc2V0OwogICAgdG9wOiB1bnNldDsKICAgIHRyYW5zZm9ybTogdW5zZXQ7CiAgICBtYXgtd2lkdGg6IHVuc2V0OwogICAgbWF4LWhlaWdodDogdW5zZXQ7CiAgICBib3gtc2hhZG93OiB1bnNldDsKICB9Cn0nAOGt5pkNi4YBCW9uRGVzdHJveQIEAOGt5pkNupEBE0B0aGlzQm90LnVubW91bnQoKTsnAOGt5pkNi4YBBW1vdW50AgQA4a3mmQ3OkQGTA0Bjb25zdCB7CiAgICBhYkNvbW1hbmRzTWFuYWdlciwKICAgIHNlbGVjdGVkQ29tbWFuZAp9ID0gdGhhdCA/PyB7fTsKCmlmIChtYXNrcy5oZWxwQWN0aXZlKSB7CiAgICBhd2FpdCB0aGlzQm90LnVubW91bnQoKTsKfQoKY29uc3QgSGVscEFwcCA9IHRoaXNCb3QuSGVscEFwcCgpOwoKYXdhaXQgb3MucmVnaXN0ZXJBcHAoJ2FiLWNvbW1hbmQtaGVscCcsIHRoaXNCb3QpOwphd2FpdCBvcy5jb21waWxlQXBwKCdhYi1jb21tYW5kLWhlbHAnLCA8SGVscEFwcCBjb21tYW5kcz17YWJDb21tYW5kc01hbmFnZXIuY29tbWFuZHN9IGluaXRpYWxTZWxlY3RlZENvbW1hbmQ9e3NlbGVjdGVkQ29tbWFuZH0vPik7Cgp0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcyA9IFtdOwptYXNrcy5oZWxwQWN0aXZlID0gdHJ1ZTsnAOGt5pkNi4YBB0hlbHBBcHACBADhreaZDeKUAbovQGNvbnN0IEFwcENvbnRhaW5lciA9IGxpbmtzLmNvbXBvbmVudHMuQXBwQ29udGFpbmVyKCk7CmNvbnN0IFdpbmRvdyA9IGxpbmtzLmNvbXBvbmVudHMuV2luZG93KCk7CmNvbnN0IFRleHRMaW5rID0gbGlua3MuY29tcG9uZW50cy5UZXh0TGluaygpOwpjb25zdCBjc3MgPSBsaW5rcy51dGlscy5hYkNvbXBpbGVDU1MoWyB0aGlzQm90LCBsaW5rcy5jb21wb25lbnRzIF0pOwoKY29uc3QgeyB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjaywgdXNlUmVmLCB1c2VNZW1vIH0gPSBvcy5hcHBIb29rczsKCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqLwpjb25zdCBBdmFpbGFibGVDb21tYW5kcyA9ICh7IGNvbW1hbmRzLCBvbkNvbW1hbmRDbGljayB9KSA9PiB7CiAgICBjb25zdCBjb21tYW5kTmFtZXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcykuc29ydCgpOwoKICAgIGNvbnN0IG9uQ2xvc2UgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQ2xvc2V9PnsneCBDbG9zZSd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj5BdmFpbGFibGUgQ29tbWFuZHM8L2gyPgogICAgICAgICAgICA8cD5Vc2FnZTogLmNvbW1hbmQgW29wdGlvbnNdPC9wPgogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgICAgIHtjb21tYW5kTmFtZXMubWFwKChuYW1lKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRzW25hbWVdOwoKICAgICAgICAgICAgICAgICAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PFRleHRMaW5rIG9uQ2xpY2s9eygpID0+IG9uQ29tbWFuZENsaWNrKGNvbW1hbmQubmFtZSl9Pntjb21tYW5kLm5hbWV9PC9UZXh0TGluaz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPntkZXNjcmlwdGlvbn08L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICA8L3RhYmxlPgogICAgICAgIDwvPgogICAgKQp9CgovKioKICogQHBhcmFtIHtPYmplY3R9IHByb3BzCiAqIEBwYXJhbSB7Q29tbWFuZH0gcHJvcHMuY29tbWFuZAogKi8KY29uc3QgU3BlY2lmaWNDb21tYW5kID0gKHsgY29tbWFuZCwgb25CYWNrIH0pID0+IHsKICAgIGxldCB1c2FnZSA9ICcnOwogICAgbGV0IGRlc2NyaXB0aW9uID0gbnVsbDsKICAgIGxldCBhcmdzID0gbnVsbDsKCiAgICBpZiAoY29tbWFuZC5oZWxwKSB7CiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC51c2FnZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb21tYW5kLmhlbHAudXNhZ2UpKSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZS5qb2luKCdcbicpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdXNhZ2UgPSBjb21tYW5kLmhlbHAudXNhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLmxvbmdEZXNjcmlwdGlvbjsKICAgICAgICB9IGVsc2UgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGRlc2NyaXB0aW9uID0gY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb247CiAgICAgICAgfQoKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLmFyZ3MgJiYgY29tbWFuZC5oZWxwLmFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBhcmdzID0gY29tbWFuZC5oZWxwLmFyZ3M7CiAgICAgICAgfQogICAgfQogICAgCiAgICByZXR1cm4gKAogICAgICAgIDw+ICAKICAgICAgICAgICAgPHA+PFRleHRMaW5rIG9uQ2xpY2s9e29uQmFja30+eyc8IEJhY2snfTwvVGV4dExpbms+PC9wPgogICAgICAgICAgICA8aDI+e2NvbW1hbmQubmFtZX08L2gyPgogICAgICAgICAgICB7IHVzYWdlICYmCiAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSd1c2FnZS10YWJsZSc+CiAgICAgICAgICAgICAgICAgICAgPHRyPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGgzPlVzYWdlOjwvaDM+PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnt1c2FnZX08L3RkPgogICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgZGVzY3JpcHRpb24gJiYgCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkRlc2NyaXB0aW9uOjwvaDM+CiAgICAgICAgICAgICAgICAgICAgPHAgY2xhc3NOYW1lPSdkZXNjcmlwdGlvbic+e2Rlc2NyaXB0aW9ufTwvcD4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB9CiAgICAgICAgICAgIHsgYXJncyAmJgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9J3NlY3Rpb24nPgogICAgICAgICAgICAgICAgICAgIDxoMz5Bcmd1bWVudHM6PC9oMz4KICAgICAgICAgICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdhcmdzLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICAgICAgeyBhcmdzLm1hcCgoYXJnKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFyZy5pZGVudGlmaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdJZGVudGlmaWVyRGlzcGxheSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJnRGVzY3JpcHRpb25EaXNwbGF5ID0gbnVsbDsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyLmpvaW4oJyxcbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdJZGVudGlmaWVyRGlzcGxheSA9IGFyZy5pZGVudGlmaWVyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmcuZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBhcmcuZGVzY3JpcHRpb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD57YXJnSWRlbnRpZmllckRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdEZXNjcmlwdGlvbkRpc3BsYXkgPz8gJyd9PC90ZD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L3RyPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgPGJyLz4KICAgICAgICAgICAgPHRhYmxlIGNsYXNzTmFtZT0naGVscC10YWJsZSc+CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtPYmplY3QuPHN0cmluZywgQ29tbWFuZD59IHByb3BzLmNvbW1hbmRzCiAqIEBwYXJhbSB7YW55W119IFtwcm9wcy5hcmdzXQogKi8KY29uc3QgSGVscEFwcCA9ICh7IGNvbW1hbmRzLCBpbml0aWFsU2VsZWN0ZWRDb21tYW5kIH0pID0+IHsKICAgIGNvbnN0IFsgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmQgXSA9IHVzZVN0YXRlKGluaXRpYWxTZWxlY3RlZENvbW1hbmQpOwoKICAgIC8vIEVzY2FwZSBrZXkgcHJlc3MgZXZlbnQgaGFuZGxlcgogICAgdXNlRWZmZWN0KCgpID0+IHsKICAgICAgICBjb25zdCBvbkVzY2FwZUtleVByZXNzID0gKCkgPT4gewogICAgICAgICAgICBpZiAoc2VsZWN0ZWRDb21tYW5kICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChudWxsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5wdXNoKG9uRXNjYXBlS2V5UHJlc3MpOwoKICAgICAgICByZXR1cm4gKCkgPT4gewogICAgICAgICAgICBjb25zdCBjYWxsYmFja0luZGV4ID0gdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MuZmluZEluZGV4KChjYWxsYmFjaykgPT4gY2FsbGJhY2sgPT09IG9uRXNjYXBlS2V5UHJlc3MpOwogICAgICAgICAgICBpZiAoY2FsbGJhY2tJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5zcGxpY2UoY2FsbGJhY2tJbmRleCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LCBbc2VsZWN0ZWRDb21tYW5kXSk7CiAgICAKICAgIGNvbnN0IG9uQmFja2dyb3VuZENsaWNrID0gdXNlQ2FsbGJhY2soKCkgPT4gewogICAgICAgIHRoaXNCb3QudW5tb3VudCgpOwogICAgfSwgW10pOwoKICAgIGNvbnN0IG9uQ29tbWFuZENsaWNrID0gdXNlQ2FsbGJhY2soKG5hbWUpID0+IHsKICAgICAgICBzZXRTZWxlY3RlZENvbW1hbmQobmFtZSk7CiAgICB9LCBbc2V0U2VsZWN0ZWRDb21tYW5kXSkKCiAgICBjb25zdCBjb250ZW50ID0gdXNlTWVtbygoKSA9PiB7CiAgICAgICAgaWYgKCFzZWxlY3RlZENvbW1hbmQpIHsKICAgICAgICAgICAgcmV0dXJuIDxBdmFpbGFibGVDb21tYW5kcyBjb21tYW5kcz17Y29tbWFuZHN9IG9uQ29tbWFuZENsaWNrPXtvbkNvbW1hbmRDbGlja30vPgogICAgICAgIH0gZWxzZSB7IAogICAgICAgICAgICByZXR1cm4gPFNwZWNpZmljQ29tbWFuZCBjb21tYW5kPXtjb21tYW5kc1tzZWxlY3RlZENvbW1hbmRdfSBvbkJhY2s9eygpID0+IHNldFNlbGVjdGVkQ29tbWFuZChudWxsKX0vPgogICAgICAgIH0KICAgIH0sIFtjb21tYW5kcywgc2VsZWN0ZWRDb21tYW5kLCBzZXRTZWxlY3RlZENvbW1hbmRdKTsKCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIDxzdHlsZT57Y3NzfTwvc3R5bGU+CgogICAgICAgICAgICA8QXBwQ29udGFpbmVyIG9uQmFja2dyb3VuZENsaWNrPXtvbkJhY2tncm91bmRDbGlja30+CiAgICAgICAgICAgICAgICA8V2luZG93PgogICAgICAgICAgICAgICAgICAgIHtjb250ZW50fQogICAgICAgICAgICAgICAgPC9XaW5kb3c+CiAgICAgICAgICAgIDwvQXBwQ29udGFpbmVyPgogICAgICAgIDwvPgogICAgKQp9CgpyZXR1cm4gSGVscEFwcDsnAOGt5pkNi4YBCmNvbXBvbmVudHMCBADhreaZDZ3EASjwn5SXMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhJwDhreaZDYuGAQV1dGlscwIEAOGt5pkNxMQBKPCflJc5M2Q5NjVlMC1kMjBlLTRiNDUtOGNhMC02NDkyNzNiNzEzOGMnAOGt5pkNi4YBCGFiSWdub3JlAgQA4a3mmQ3rxAEEdHJ1ZScA4a3mmQ2LhgEHYWJTaGVsbAIEAOGt5pkN8MQBBHRydWUnAOGt5pkNi4YBCWFiVmVyc2lvbgIEAOGt5pkN9cQBBDEwLjUnAQRib3RzJDM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MwEnAOGt5pkN+sQBBnN5c3RlbQIEAOGt5pkN+8QBD2FiLnNoZWxsLmNyZWF0ZScA4a3mmQ36xAEEZm9ybQIEAOGt5pkNi8UBB25vdGhpbmcnAOGt5pkN+sQBC2Rlc2NyaXB0aW9uAgQA4a3mmQ2TxQE9Qm90IHVzZWQgdG8gY3JlYXRlL21hbmlmZXN0IGJvdHMgaW50byBhbiBhY3R1YWwgc2NlbmUvcG9ydGFsLicA4a3mmQ36xAEMYWJDcmVhdGVCb3RzAgQA4a3mmQ3RxQHEKEBsZXQgeyAKICAgIGluaXRpYWxCb290LCAvLyBjaGVja3MgZm9yIGluaXRpYWwgYm9vdCBib29sZWFuIChvcHRpb25hbCkKICAgIGJvdERhdGEsIC8vIGJvdHMgdG8gYmUgZ2VuZXJhdGVkCiAgICBvcmlnaW4sIC8vIHdoZXJlIGRpZCB0aGUgZGF0YSBjb21lIGZyb20gKG9wdGlvbmFsKQogICAgc3R1ZGlvLCAvLyB3aGF0IHN0dWRpbyBpcyB0aGlzIGRhdGEgZnJvbSAob3B0aW9uYWwpCiAgICByZWNvcmQsIC8vIFJ5YW4gQ29vazogZG8gd2UgbmVlZCB0aGlzIGlmIHdlIGFscmVhZHkgaGF2ZSBzdHVkaW8/IChvcHRpb25hbCkKICAgIHZlcnNpb24sIC8vIHZlcnNpb24gb2YgdGhlIGRhdGEgKG9wdGlvbmFsKQogICAgZWdnUGFyYW1ldGVycywgLy8gZGF0YSB0byBwYXNzIHRvIGFsbCBjcmVhdGVkIGJvdHMgdmlhIEBvbkVnZ0hhdGNoLiAob3B0aW9uYWwpCiAgICBpZ25vcmVHcmlkRm9jdXMsIC8vIFJ5YW4gQ29vazogYWRkaW5nIHRoaXMgYXMgYW4gb3B0aW9uYWwgZmxhZy4gKG9wdGlvbmFsKQogICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLCAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSB0aGUgYm90cyBhcmUgY3JlYXRlZC4gKG9wdGlvbmFsKQogICAgc291cmNlRXZlbnQsIC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbCB0byBhYkNyZWF0ZUJvdHMuIChvcHRpb25hbCkuCn0gPSB0aGF0OwoKLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZm9yIHdoZW4gYWJDcmVhdGVCb3RzIGV4cGVjdGVkICJib3RzIiBwYXJhbWV0ZXIuCmlmICghYm90RGF0YSAmJiB0aGF0LmJvdHMpIHsKICAgIGJvdERhdGEgPSB0aGF0LmJvdHM7Cn0KCmxldCBib3RDb3VudCA9IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aDsKY29uc3QgYWJHcmlkRm9jdXMgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKLy8gUnVuIHNvbWUgYWItc3BlY2lmaWMgcHJlcHJvY2Vzc2luZyBvZiBib3QgZGF0YS4KZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKCiAgICBpZiAoZGF0YS50YWdzKSB7CiAgICAgICAgZGF0YS50YWdzLmFiSURPcmlnaW4gPSBvcmlnaW47CiAgICAgICAgZGF0YS50YWdzLmFiSURTdHVkaW8gPSBzdHVkaW87CgogICAgICAgIGlmIChkYXRhLnRhZ3MuY3JlYXRvcikgewogICAgICAgICAgICBkYXRhLnRhZ3Mub2xkQ3JlYXRvciA9IGRhdGEudGFncy5jcmVhdG9yOwogICAgICAgIH0KCiAgICAgICAgLy8gUnlhbiBDb29rOiBUaGlzIHRhcmdldFBvc2l0aW9uIHN0dWZmIGlzIGFwcGFyZW50bHkgdXNlZCBmb3IgYm90IHBhc3Rpbmc/IAogICAgICAgIC8vIFRoaXMgaXMgc29tZSByZWFsbHkgY29uZnVzaW5nIGxvZ2ljIGFuZCBzaG91bGQgYmUgcmVmYWN0b3JlZCBldmVudHVhbGx5LgogICAgICAgIGlmICgoYm90Q291bnQgPCAyIHx8IGJvdENvdW50IDwgMyAmJiBib3REYXRhLmFiWFBCb3QgIT0gbnVsbCkgJiYgYWJHcmlkRm9jdXMgJiYgIWlnbm9yZUdyaWRGb2N1cykgewogICAgICAgICAgICBkYXRhLnRhZ3NbYWJHcmlkRm9jdXMuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIGRhdGEudGFnc1thYkdyaWRGb2N1cy5kaW1lbnNpb24gKyAnWCddID0gYWJHcmlkRm9jdXMucG9zaXRpb24ueDsKICAgICAgICAgICAgZGF0YS50YWdzW2FiR3JpZEZvY3VzLmRpbWVuc2lvbiArICdZJ10gPSBhYkdyaWRGb2N1cy5wb3NpdGlvbi55OwogICAgICAgIH0KICAgIH0KfQoKLy8gRG8gYW5vdGhlciBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSB0aGUgYm90cyBhcmVhIGNyZWF0ZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhLCBvcmlnaW4sIHN0dWRpbywgcmVjb3JkLCB2ZXJzaW9uLCBlZ2dQYXJhbWV0ZXJzLCBpbml0aWFsQm9vdCwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZShwcmVwcm9jZXNzQXJnKQp9Cgphd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoc2hvdXQoJ29uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlJywgcHJlcHJvY2Vzc0FyZykpOwoKaWYgKHR5cGVvZiBib3REYXRhICE9PSAnb2JqZWN0JyB8fCBPYmplY3Qua2V5cyhib3REYXRhKS5sZW5ndGggPT09IDApIHsKICAgIC8vIFRoZXJlIGlzbid0IGFueSBib3REYXRhIHRvIGNyZWF0ZSBmcm9tIQogICAgcmV0dXJuOwp9CgovLyBDcmVhdGUgYm90cyBmcm9tIHRoZSBib3QgZGF0YS4KbGV0IGlkTWFwID0gbmV3IE1hcCgpOwpsZXQgbmV3Qm90cyA9IFtdOwpsZXQgbmV3Qm90SWRzID0gW107Cgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MpIHsKICAgICAgICB0cnkgeyAKICAgICAgICAgICAgY29uc3QgbmV3Qm90ID0gY3JlYXRlKGRhdGEudGFncyk7CgogICAgICAgICAgICBpZE1hcC5zZXQoZGF0YS5pZCwgbmV3Qm90LmlkKTsKICAgICAgICAgICAgbmV3Qm90cy5wdXNoKG5ld0JvdCk7CiAgICAgICAgICAgIG5ld0JvdElkcy5wdXNoKG5ld0JvdC5pZCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGludmFsaWQgYm90YCwgZSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHNraXBwZWQgYm90OiBgLCBkYXRhKTsKICAgIH0KfQoKLy8gQXJyYXkgb2YgdGFnIHJlbGF0aW9uc2hpcHMgdG8gYmUgcHJlc2VydmVkCmNvbnN0IGxpbmtUYWdzID0gWyJsaW5rIiwgImNyZWF0b3IiLCAiY29uZmlnQm90IiwgImxpbmVUbyIsICJ0cmFuc2Zvcm1lciIsICJmb3JtTGlnaHRUYXJnZXQiXTsKCi8vIFRoaXMgbG9vcCBjb250YWlucyB0aGUgbG9naWMgZm9yIHByZXNlcnZpbmcgdGhlIGxpbmtUYWdzCmZvciAobGV0IG5ld0JvdCBvZiBuZXdCb3RzKSB7CiAgICBmb3IgKGxldCB0YWcgb2YgbGlua1RhZ3MpIHsKICAgICAgICBsZXQgdmFsdWUgPSBuZXdCb3QudGFnc1t0YWddOwoKICAgICAgICBpZiAodGFnID09ICJjcmVhdG9yIikgewogICAgICAgICAgICB2YWx1ZSA9IG5ld0JvdC50YWdzLm9sZENyZWF0b3I7CiAgICAgICAgICAgIG5ld0JvdC50YWdzLm9sZENyZWF0b3IgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlQm90TGlua3MobmV3Qm90LCBpZE1hcCk7CgogICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICAgICAgICAgIGxldCBuZXdWYWx1ZSA9IHZhbHVlLm1hcChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkTWFwLmdldChpZCkgfHwgaWQ7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgbmV3SUQgPSBpZE1hcC5nZXQodmFsdWUpOwoKICAgICAgICAgICAgICAgIGlmIChuZXdJRCkgewogICAgICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld0lEOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBUb2FzdHMgZm9yIGhhdGNoZXMsIGJ1dCBvbmx5IG9uIGJ1aWxkZXIKaWYgKG9yaWdpbiAmJiB2ZXJzaW9uICYmIGNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSA9PSBudWxsICYmICFjb25maWdCb3QudGFncy5waCAmJiBidWlsZGVyVmVyc2lvbiA9PSAiYnVpbGRlciIpIHsKICAgIG9zLnRvYXN0KCJoYXRjaGVkICIgKyBvcmlnaW4gKyAiIHYiICsgdmVyc2lvbik7Cn0KCmlmIChvcmlnaW4pIHsKICAgIC8vIENyZWF0ZSBhYkVnZyBib3QgdGhhdCB0cmFja3MgY2FuIGJlIHVzZWQgdG8gdHJhY2sgd2hhdCBlZ2dzIGhhdmUgYmVlbiBoYXRjaGVkLgogICAgY3JlYXRlKHsKICAgICAgICBzcGFjZTogInNoYXJlZCIsCiAgICAgICAgYWI6IHRydWUsCiAgICAgICAgYWJFZ2c6IHRydWUsCiAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgb3JpZ2luX2FiOiBvcmlnaW4sCiAgICAgICAgb3JpZ2luX3ZlcnNpb246IHZlcnNpb24sCiAgICAgICAgb3JpZ2luX3JlY29yZDogcmVjb3JkLAogICAgICAgIG9yaWdpbl9zdHVkaW86IHN0dWRpbywKICAgICAgICBmb3JtOiAiZWdnIiwKICAgICAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICAgICAgbGFiZWw6IG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uLAogICAgfSk7Cn0KCmNvbmZpZ0JvdC50YWdzLmxhc3RFZ2dIYXRjaGVkID0gb3JpZ2luOwoKd2hpc3BlcihuZXdCb3RzLCAnb25QcmVIYXRjaCcsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsKCmlmIChpbml0aWFsQm9vdCkgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBvcmlnaW47Cn0KCi8vIG9uRWdnSGF0Y2ggZm9yIGFsbCBqdXN0IGhhdGNoZWQgYm90cwp3aGlzcGVyKG5ld0JvdHMsICJvbkVnZ0hhdGNoIiwgeyBhYjogb3JpZ2luLCB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdCwgYm90SWRzOiBuZXdCb3RJZHMsIGVnZ1BhcmFtZXRlcnMsIHNvdXJjZUV2ZW50IH0pOwoKLy8gb25BYkFkZGVkIGZvciBhbGwgYm90cyBpbiB0aGUgZXhwZXJpZW5jZQpzdXBlclNob3V0KCJvbkFCQWRkZWQiLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcywgc291cmNlRXZlbnQgfSk7CnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBzb3VyY2VFdmVudCB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgpyZXR1cm4gbmV3Qm90czsnAOGt5pkN+sQBCHJlbWVtYmVyAgQA4a3mmQ2W7gEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA4a3mmQ36xAEIYWJJZ25vcmUCBADhreaZDb3uAQR0cnVlJwDhreaZDfrEAQdhYlNoZWxsAgQA4a3mmQ3C7gEEdHJ1ZScA4a3mmQ36xAEJYWJWZXJzaW9uAgQA4a3mmQ3H7gEEMTAuNScA4a3mmQ36xAELcGVyc29uYWxpdHkCBADhreaZDczuASjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwEEYm90cyQ1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYBJwDhreaZDfPuAQZzeXN0ZW0CBADhreaZDfTuARBhYi5zaGVsbC52ZXJzaW9uJwDhreaZDfPuAQRmb3JtAgQA4a3mmQ2F7wEHbm90aGluZycA4a3mmQ3z7gEIYWJJZ25vcmUCBADhreaZDY3vAQR0cnVlJwDhreaZDfPuAQdhYlNoZWxsAgQA4a3mmQ2S7wEEdHJ1ZScA4a3mmQ3z7gETYWJTaGVsbE1ham9yVmVyc2lvbgIEAOGt5pkNl+8BATEnAOGt5pkN8+4BDW9uU2tpbGxVcGRhdGUCBADhreaZDZnvAZcBQGNvbnN0IHZlcnNpb25TdHJpbmcgPSB0YWdzLmFiU2hlbGxNYWpvclZlcnNpb24gKyAiLiIgKyB0YWdzLmFiU2hlbGxNaW5vclZlcnNpb247DQoNCmNvbnNvbGUubG9nKCJbQUJTaGVsbF0gTG9hZGVkIEFCIHNoZWxsIHZlcnNpb24gIiArIHZlcnNpb25TdHJpbmcpOycA4a3mmQ3z7gEJYWJWZXJzaW9uAgQA4a3mmQ2x8AEEMTAuNScA4a3mmQ3z7gETYWJTaGVsbE1pbm9yVmVyc2lvbgIEAOGt5pkNtvABAjE1JwEEYm90cyQ3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YBJwDhreaZDbnwAQZzeXN0ZW0CBADhreaZDbrwAQ5hYi5zaGVsbC5zdG9yZScA4a3mmQ258AEEZm9ybQIEAOGt5pkNyfABB25vdGhpbmcnAOGt5pkNufABC2Rlc2NyaXB0aW9uAgQA4a3mmQ3R8AE/VGhpcyBza2lsbCBpcyBtZWFudCB0byBiZSBhIGNvbmZpZ3VyYWJsZSBtZWFucyB0byBwdWJsaXNoIGRhdGEuJwDhreaZDbnwAQ9hYlB1Ymxpc2hSZWNvcmQCBADhreaZDZHxAcAGQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmc7CmxldCByZWNvcmREYXRhID0gdGhhdC5kYXRhOwpsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKbGV0IGVuZHBvaW50ID0gdGhhdC5lbmRwb2ludCA/IHRoYXQuZW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghcmVjb3JkRGF0YSkKewogICAgcmV0dXJuICJubyBkYXRhIHN1cHBsaWVkIjsKfQoKaWYgKHB1YmxpY0ZhY2luZykKewogICAgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEodXNlclJlY29yZCwgcmVjb3JkTmFtZSwgcmVjb3JkRGF0YSwge2VuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogWyJwdWJsaWNSZWFkIl19KTsKfQplbHNlCnsgICAgCiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbcmVjb3JkTmFtZV19KTsKfQoKaWYgKHJlY29yZERhdGEuc3VjY2VzcykKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIHJlY29yZGVkIHRvICIgKyB1c2VyUmVjb3JkKTsKfQplbHNlCnsKICAgIGFiLmxvZyhsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZGF0YSBmYWlsZWQgdG8gcmVjb3JkIik7Cn0KCnJldHVybiByZWNvcmREYXRhOycA4a3mmQ258AENYWJQdWJsaXNoRmlsZQIEAOGt5pkN0vcBrAdAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBmaWxlID0gdGhhdC5maWxlOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGVOYW1lOwpsZXQgbWltZVR5cGUgPSB0aGF0Lm1pbWVUeXBlOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIWZpbGUpCnsKICAgIHJldHVybiAibm8gZmlsZSBzdXBwbGllZCI7Cn0KCmxldCBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKICAgIAppZiAoIWZpbGVVcGxvYWQuc3VjY2VzcykgCnsKICAgIGlmIChmaWxlVXBsb2FkLmVycm9yQ29kZSA9PSAiZmlsZV9hbHJlYWR5X2V4aXN0cyIpCiAgICB7CiAgICAgICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGFscmVhZHkgZXhpc3RzIGluICIgKyB1c2VyUmVjb3JkKTsKCiAgICAgICAgcmV0dXJuIGZpbGVVcGxvYWQ7CiAgICB9CgogICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHVzZXJSZWNvcmQpOwoKICAgIGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHtkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwp9CgppZiAoZmlsZVVwbG9hZC5zdWNjZXNzKQp7CiAgICBhYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBmaWxlIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIGZpbGVVcGxvYWQ7JwDhreaZDbnwARBhYkNvcmVNZW51QWN0aW9uAgQA4a3mmQ3//gFNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAOGt5pkNufABC29uU3RvcmVNZW51AgQA4a3mmQ3N/wHwlQFAbGV0IHBvc3NpYmxlUHVibGlzaEJvdCA9IG5ldyBTZXQoKTsKCmlmIChsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cykpIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5saW5rcy5hYk11bHRpcGxlQm90Rm9jdXMuZm9yRWFjaChiID0+IHBvc3NpYmxlUHVibGlzaEJvdC5hZGQoYikpOwogICAgfSBlbHNlIHsKICAgICAgICBwb3NzaWJsZVB1Ymxpc2hCb3QuYWRkKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiTXVsdGlwbGVCb3RGb2N1cyk7CiAgICB9Cn0KCmlmIChsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKSB7CiAgICBwb3NzaWJsZVB1Ymxpc2hCb3QuYWRkKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpOwp9Cgpwb3NzaWJsZVB1Ymxpc2hCb3QgPSBBcnJheS5mcm9tKHBvc3NpYmxlUHVibGlzaEJvdCk7Cgpjb25zdCBiYXNlQUIgPSAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyA/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOiBsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzLmlkOwpjb25zdCBiYXNlQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gYmFzZUFCICYmIGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwpjb25zdCBub25BQkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IGRlZmF1bHRzID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51UmVmcmVzaDogIkAgZGVzdHJveSh0aGlzQm90KTsiLAogICAgY29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3IsCiAgICBtYW5hZ2VyOiAi8J+UlyIgKyB0aGlzQm90LmlkLAogICAgbWFuaWZlc3RhdGlvbjogdGFncy5tYW5pZmVzdGF0aW9uLAogICAgcmVtZW1iZXI6IHRhZ3MucmVtZW1iZXIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwKICAgICAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICJib3JkZXItbGVmdC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1yaWdodC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAKfQoKLy8gQ3JlYXRlIGRvd25sb2FkIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgIGxhYmVsOiAiZG93bmxvYWQiLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIGZvcm1BZGRyZXNzOiAiZ2V0X2FwcCIsCiAgICBwb3NzaWJsZUJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgb25DbGljazogYEAgbGlua3MubWFuYWdlci5hYkRvd25sb2FkKHsgcG9zc2libGVCb3RzOiBsaW5rcy5wb3NzaWJsZUJvdH0pO2AKfSk7CgppZiAoIWF1dGhCb3QpIAp7CiAgICAvLyBDcmVhdGUgbG9naW4gbWVzc2FnZQogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgICAgICBsYWJlbDogInBsZWFzZSBzaWduIGluIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIiwKICAgICAgICBvbkNsaWNrOiBgQCBvcy5yZXF1ZXN0QXV0aEJvdCgpYAogICAgfSk7CgogICAgcmV0dXJuOwp9CmVsc2UgaWYgKGF1dGhCb3QudGFncy5zdWJzY3JpcHRpb25UaWVyID09ICJGcmVlUGxheSIpIAp7CiAgICAvLyBDcmVhdGUgdXBncmFkZSBzdWJzY3JpcHRpb24gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJwbGVhc2UgdXBncmFkZSB5b3VyIHN1YnNjcmlwdGlvbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIKICAgIH0pOwoKICAgIHJldHVybjsKfQoKCmxldCB1c2VyU3R1ZGlvcyA9IGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvczsKCmlmICghdXNlclN0dWRpb3MpIAp7CiAgICB1c2VyU3R1ZGlvcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOwp9CgppZiAodXNlclN0dWRpb3Muc3VjY2VzcykgCnsKICAgIGNvbnN0IGFjdGl2ZVN0dWRpbyA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpOwoKICAgIGxldCBiYXNlU3R1ZGlvID0gYXV0aEJvdC5pZDsKCiAgICBpZiAoYmFzZVN0dWRpbyA9PSBhdXRoQm90LmlkKSAKICAgIHsKICAgICAgICBiYXNlU3R1ZGlvID0gInBsYXllciI7CiAgICB9CgogICAgaWYgKGFjdGl2ZVN0dWRpbyA9PSAtMSAmJiBiYXNlU3R1ZGlvICE9ICJwbGF5ZXIiKSAKICAgIHsKICAgICAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGJhc2VTdHVkaW87CiAgICB9CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyAmJiAhYWN0aXZlU3R1ZGlvKSAKICAgIHsKICAgICAgICBjb25zdCBzdHVkaW9NYXRjaCA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQoKICAgICAgICBpZiAoc3R1ZGlvTWF0Y2ggIT0gLTEpIHsKICAgICAgICAgICAgYmFzZVN0dWRpbyA9IGJhc2VTdHVkaW87CiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHN0dWRpb0xhYmVsID0gYWN0aXZlU3R1ZGlvID09IC0xID8gYmFzZVN0dWRpbyA6IHVzZXJTdHVkaW9zLnN0dWRpb3NbYWN0aXZlU3R1ZGlvXS5kaXNwbGF5TmFtZTsKCiAgICAvLyBDcmVhdGUgc3R1ZGlvIHNlbGVjdCBidXR0b24KICAgIGNvbnN0IHN0dWRpb0Rpc3BsYXlCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJzdHVkaW89IiArIHN0dWRpb0xhYmVsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41LAogICAgICAgIHN0dWRpb0luZm9ybWF0aW9uOiB1c2VyU3R1ZGlvcywKICAgICAgICBmb3JtQWRkcmVzczogImludmVudG9yeV8yIiwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLnN0dWRpb1NlbGVjdCh0YWdzLnN0dWRpb0luZm9ybWF0aW9uKTtgCiAgICB9KTsKCiAgICBtYXNrcy5zdHVkaW9TZWxlY3RCdXR0b24gPSBnZXRMaW5rKHN0dWRpb0Rpc3BsYXlCdXR0b24pOwp9Cgpjb25zdCB0b3RhbEJvdENvdW50ID0gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA+IDAgPyBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoIDogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aDsKCi8vIENyZWF0ZSBwdWJsaXNoIGxhYmVsIGJ1dHRvbgpjb25zdCBsYWJlbEJvdCA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgbGFiZWw6IGBwdWJsaXNoIHBhdHRlcm4gJHtiYXNlQm90cy5sZW5ndGggPiAwID8gIiIgOiAiYXMgIn0ke2Jhc2VBQn0gKCR7dG90YWxCb3RDb3VudH0gYm90JHtiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgIHRvdGFsQm90czogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCwKICAgIGFiTWVudVNvcnRPcmRlcjogMSwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIGZvcm1BZGRyZXNzOiBudWxsLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCA4cHggMHB4IDBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLXRvcC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIHNoaWZ0U3RhdGU6IGZhbHNlLAogICAgb25DbGljazogYEAgY29uc3QgbWVudUJvdHMgPSBnZXRCb3RzKCdhYk1lbnVTb3J0T3JkZXInKTsKCiAgICAgICAgaWYgKHRhZ3Muc2hpZnRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleVVwIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlEb3duIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0YWdzLnNoaWZ0U3RhdGUgPSAhdGFncy5zaGlmdFN0YXRlO2AsCiAgICBzY2FsZVk6ICJhdXRvIiwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGxldCB0b3RhbEJvdHMgPSBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPyB0aGF0LmFiQm90cyA6IHRoYXQuYWJCb3RzICsgdGhhdC5ub25BQkJvdHM7CgogICAgY29uc3QgdG90YWxCb3RWYXIgPSB0b3RhbEJvdHMgPT0gMSA/ICIgYm90IiA6ICIgYm90cyI7CiAgICBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cz8ubGVuZ3RoICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgaWYgKGdldEJvdCgiYWJJRE9yaWdpbiIsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCKSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSkubGVuZ3RoOwoKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICJwdWJsaXNoICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiArICIgKCIgKyBhYkJvdHMgKyAiIGJvdHMpIjsKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSBhYkJvdHM7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCBwYXR0ZXJuIGFzICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjsKICAgICAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICAgICAgfSAgIAogICAgfQogICAgZWxzZQogICAgeyAgIAogICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgdGhhdC5hYiArICIgKCIgKyB0b3RhbEJvdHMgKyB0b3RhbEJvdFZhciArICIpIjsKICAgICAgICB0YWdzLnRvdGFsQm90cyA9IHRvdGFsQm90czsKICAgIH1gCn0pOwoKLy8gQ3JlYXRlIGVuY3J5cHQgYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgZGltZW5zaW9uOiAiYWJNZW51IiwKICAgIGxhYmVsOiAiZW5jcnlwdCIsCiAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgIGVuY3J5cHRTdGF0ZTogZmFsc2UsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBpZih0YWdzLmVuY3J5cHRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSB0cnVlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSB0cnVlOwogICAgICAgIH1gLAp9KTsKCmxldCBhYkJ1dHRvbjsKCmlmIChwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vIENyZWF0ZSBpbmNsdWRlQm90cyBidXR0b24KICAgIGFiQnV0dG9uID0gYXdhaXQgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MiwKICAgICAgICBhYlNlbGVjdGlvbkJ1dHRvbjogdHJ1ZSwKICAgICAgICBsYWJlbDogYmFzZUJvdHMubGVuZ3RoID4gMCAmJiBiYXNlQUIgIT0gdW5kZWZpbmVkID8gYHNlbGVjdGVkIHBhdHRlcm46ICR7YmFzZUFCfSAoJHtiYXNlQm90cy5sZW5ndGh9IGJvdCR7YmFzZUJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCA6IGBuZXcgcGF0dGVybiAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAnZWdnJywKICAgICAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoU2VsZWN0KCk7YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXJOb24gPSB0aGF0Lm5vbkFCQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKICAgICAgICBjb25zdCBib3RWYXJBQiA9IHRoYXQuYWJCb3RzICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgICAgICBpZiAodGhhdC5hYiA9PSAibmV3IHBhdHRlcm4iKQogICAgICAgIHsKICAgICAgICAgICAgdGFncy5sYWJlbCA9IHRoYXQuYWIgKyAiICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXJOb247CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAic2VsZWN0ZWQgcGF0dGVybjogIiArIHRoYXQuYWIgKyAiICgiICsgdGhhdC5hYkJvdHMgKyBib3RWYXJBQjsKICAgICAgICB9YAogICAgfSk7Cn0KCmlmIChub25BQkJvdHMubGVuZ3RoID4gMCAmJiBwb3NzaWJsZVB1Ymxpc2hCb3Q/Lmxlbmd0aCA8IDEpCnsKICAgIC8vaWNsdWRlIG5ldyBib3RzCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51OiBudWxsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41MywKICAgICAgICBhYkJ1dHRvbjogZ2V0TGluayhhYkJ1dHRvbiksCiAgICAgICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICAgICAgbGFiZWw6IGBpbmNsdWRlIG5ldyAoJHtub25BQkJvdHMubGVuZ3RofSBib3Qke25vbkFCQm90cy5sZW5ndGggPT0gMSA/ICIiIDogInMifSlgLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94IiwKICAgICAgICB1bmNsYWltZWRTdGF0ZTogZmFsc2UsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gbGlua3MuYWJCdXR0b24udGFncy5sYWJlbDsKCiAgICAgICAgICAgICAgICBpZiAobGFiZWxDaGVjay5pbmNsdWRlcygnbmV3IHBhdHRlcm4nKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9YCwKICAgICAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYiA9PiBiLnRhZ3MuYWJJRE9yaWdpbiA9PT0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZih0YWdzLnVuY2xhaW1lZFN0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zdCBub25BQkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCAmJiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKCiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPSBudWxsOwoKICAgICAgICAgICAgICAgIGxpbmtzLmxhYmVsQm90LmFiU2VsZWN0VGl0bGVVcGRhdGUoe2FiOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgYWJCb3RzOiBhYkJvdHMubGVuZ3RoLCBub25BQkJvdHM6IG5vbkFCQm90cy5sZW5ndGh9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3MudW5jbGFpbWVkU3RhdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CgogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiAwfSk7CiAgICAgICAgICAgIH1gLAogICAgICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGNvbnN0IGJvdFZhciA9IHRoYXQubm9uQUJCb3RzID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAiaW5jbHVkZSBuZXcgKCIgKyB0aGF0Lm5vbkFCQm90cyArIGJvdFZhcjsKCiAgICAgICAgICAgIGNvbnN0IGxhYmVsQ2hlY2sgPSB0aGF0LmFiOwoKICAgICAgICAgICAgaWYoIWxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG1hc2tzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAKICAgIH0pOwp9CgovLyBDcmVhdGUgcHVibGljIGJ1dHRvbgppZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIAp7CiAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBmYWxzZTsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiAyLAogICAgICAgIGxhYmVsOiAiaXNQdWJsaWMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiLAogICAgICAgIHB1YmxpY1N0YXRlOiBmYWxzZSwKICAgICAgICBvbkNsaWNrOiBgQCBpZih0YWdzLnB1YmxpY1N0YXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94JzsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnB1YmxpY0ZhY2luZyA9IHRydWU7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHZlcnNpb24gc2VsZWN0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBsYWJlbDogJ3ZlcnNpb25GbGFnPWN1cnJlbnQnLAogICAgZm9ybUFkZHJlc3M6ICdhbHRfcm91dGUnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CiAgICAgICAgICAgIH1gLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBAIHNob3V0KCdzaG93VmVyc2lvblNlbGVjdG9yJyk7YCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5sYWJlbCA9ICd2ZXJzaW9uRmxhZz0nICsgdGhhdDsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgIGAsCn0pOwoKLy8gQ3VycmVudCBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdjdXJyZW50JywKICAgIGRpbWVuc2lvbjogJ2FiTWVudScsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl9jaGVja2VkJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsO2AsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fY2hlY2tlZCc7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBGZWVkYmFjayBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdmZWVkYmFjaycsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMSwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdmZWVkYmFjayc7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gU3RhYmxlIFZlcnNpb24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBsYWJlbDogJ3N0YWJsZScsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxMiwKICAgIGZvcm1BZGRyZXNzOiAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICdzdGFibGUnOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIENyZWF0ZSBwdWJsaXNoIGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudVNvcnRPcmRlcjogNCwKICAgIGZvcm1BZGRyZXNzOiAiZWdnIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICIwcHggMHB4IDhweCA4cHgiLAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLAogICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWJvdHRvbS1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtOiAiaW5wdXQiLAogICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgb25JbnB1dFR5cGluZzogYEAgbGlua3MubGFiZWxCb3QudGFncy5sYWJlbCA9ICdwdWJsaXNoIHBhdHRlcm4gYXMgJyArIHRoYXQudGV4dCArICcgKCcgKyBsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyArICcgYm90JyArIChsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyA9PSAxID8gJyknIDogJ3MpJyk7YCwKICAgIG1lbnVJdGVtU2hvd1N1Ym1pdFdoZW5FbXB0eTogdHJ1ZSwKICAgIHRhcmdldEJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgbWVudUl0ZW1UZXh0OiBiYXNlQUIsCiAgICBvblN1Ym1pdDogYEAKICAgICAgICAgICAgaWYgKHRoYXQudGV4dCA9PSBudWxsICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGF0LnRleHQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKICAgICAgICAgICAgY29uc3QgY29uZmlybVB1c2ggPSBhd2FpdCBvcy5zaG93Q29uZmlybSh7CiAgICAgICAgICAgICAgICB0aXRsZTogImNvbmZpcm0gcHVibGlzaCIsCiAgICAgICAgICAgICAgICBjb250ZW50OiAicHVibGlzaCAiICsgdGhhdC50ZXh0ICsgIiB0byAiICsgdGFyZ2V0U3R1ZGlvICsgIj8iLAogICAgICAgICAgICAgICAgY29uZmlybVRleHQ6ICJwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNhbmNlbFRleHQ6ICJjYW5jZWwiCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKCFjb25maXJtUHVzaCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhhdC50ZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaEFCKHsgYWI6IHRoYXQudGV4dCwgYm90OiBsaW5rcy50YXJnZXRCb3QsIGJhc2VBQjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIG1hbnVhbFB1Ymxpc2g6IHRydWUsIHNvdXJjZUV2ZW50OiAnc3RvcmVfbWVudScgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvcy50b2FzdCgiYWIgbm90IHNwZWNpZmllZCIpOwogICAgICAgICAgICB9CiAgICAgICAgYCwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIAogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gdGhhdC5hYjsKICAgIH1gCn0pOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIAp7CiAgICAvLyBDcmVhdGUgY29weSB0byBjbGlwYm9hcmQgYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA4LAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogImNvcHkgdG8gY2xpcGJvYXJkIiwKICAgICAgICBmb3JtQWRkcmVzczogImZpbGVfY29weSIsCiAgICAgICAgdGFyZ2V0Qm90OiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90Rm9jdXMsCiAgICAgICAgb25DbGljazogYEAgbGV0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwogICAgICAgICAgICBsZXQgcHJlcHBlZEJvdCA9IEpTT04uc3RyaW5naWZ5KHNlbGVjdGVkQm90KTsKICAgICAgICAgICAgbGV0IHN0YXRlID0ge30KCiAgICAgICAgICAgIHN0YXRlW2FiSW5zdE1lbW9yeS50YWdzLmFiRm9jdXNEYXRhXSA9IHNlbGVjdGVkQm90OwoKICAgICAgICAgICAgbGV0IG5ld0ZpbGUgPSB7fQogICAgICAgICAgICBuZXdGaWxlLnZlcnNpb24gPSAxOwogICAgICAgICAgICBuZXdGaWxlLnN0YXRlID0gc3RhdGU7CgogICAgICAgICAgICB2YXIgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KG5ld0ZpbGUpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZm9ybWF0dGVkRmlsZSk7CgogICAgICAgICAgICBvcy50b2FzdCgiYm90IGNvcGllZCB0byBjbGlwYm9hcmQiKTsKCiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIGAsCiAgICB9KTsKfQplbHNlIAp7CiAgICAvLyBDcmVhdGUgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEwLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsgICAgICAgICAgICAKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogInNjYW4gdG8gcHVibGlzaCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJxcl9jb2RlX3NjYW5uZXIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gdHJ1ZTsgb3Mub3BlblFSQ29kZVNjYW5uZXIoKTtgLAogICAgfSk7Cn0KCmxldCBob3N0QnV0dG9uID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51U29ydE9yZGVyOiA1MCwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGZvcm1BZGRyZXNzOiAiZ3JvdXBfYWRkIiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5sZWFybi5hYkNyZWF0ZUhvc3QodGhpc0JvdCk7CiAgICBpZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKQogICAgewogICAgICAgIHRhZ3MubGFiZWwgPSAnZ2VuZXJhdGluZyBjb2RlIG5vdyc7CiAgICB9YCwKfTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiam9pbiBjb2RlOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDAsIDMpICsgIi0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDMpOwp9CmVsc2UgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiZ2VuZXJhdGUgam9pbiBjb2RlIjsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnN0YXRpY0luc3QgPT0gdW5kZWZpbmVkKQp7CiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihob3N0QnV0dG9uKTsvL2dlbmVyYXRlIGEgaG9zdCBidXR0b24KfScA4a3mmQ258AEOYWJDb3JlTWVudUljb24CBADhreaZDbCVAwlpb3Nfc2hhcmUnAOGt5pkNufABD2FiQ29yZU1lbnVMYWJlbAIEAOGt5pkNupUDBXNoYXJlJwDhreaZDbnwARNhYkNvcmVNZW51U29ydE9yZGVyAgQA4a3mmQ3AlQMBMycA4a3mmQ258AEIcmVtZW1iZXICBADhreaZDcKVAyjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDhreaZDbnwAQthYlB1Ymxpc2hBQgIEAOGt5pkN6ZUD8zRAaWYgKHRoYXQuYWIuaW5kZXhPZigiICIpICE9IC0xIHx8IHRoYXQuYWIuaW5kZXhPZignIicpICE9IC0xKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnOiAicGF0dGVybiBuYW1lcyBtYXkgbm90IGNvbnRhaW4gc3BhY2VzIG9yIHF1b3RhaW9uIG1hcmtzLCBwbGVhc2UgdHJ5IGFnYWluLiIsIGxvZ1R5cGU6ICJlcnJvciIgfSk7CiAgICByZXR1cm47Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGBwdWJsaXNoaW5nICR7dGhhdC5hYn1gKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgovL2NsZWFyIGFiIGJ1aWxkZXIKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24pIHsKICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KTsKICAgIH0KfQoKLy9hYiB2YXJpYWJsZXMKY29uc3QgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKY29uc3QgcHVibGljRmFjaW5nID0gdGhhdC5wdWJsaWNGYWNpbmcgPz8gY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nOwpjb25zdCBiYXNlQUIgPSB0aGF0LmJhc2VBQiA/PyBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPz8gKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQpOwpjb25zdCBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoID0gdGhhdC5vblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOyAvLyBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGNhbiBiZSB1c2VkIHRvIHByZXByb2Nlc3MgdGhlIGRhdGEgYmVmb3JlIGl0IGlzIHB1Ymxpc2hlZC4gKG9wdGlvbmFsKQpjb25zdCBtYW51YWxQdWJsaXNoID0gdGhhdC5tYW51YWxQdWJsaXNoOwpjb25zdCBzb3VyY2VFdmVudCA9IHRoYXQuc291cmNlRXZlbnQ7IC8vIHNvdXJjZUV2ZW50IGlzIGFuIGV2ZW50IG5hbWUgdGhhdCBzeW1ib2xpemVzIHdoYXQgdHJpZ2dlcmVkIHRoaXMgY2FsbC4gKG9wdGlvbmFsKQpjb25zdCBzdGF0ZSA9IHt9OwpsZXQgZm9ybWF0dGVkRmlsZSA9IHt9OwoKY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKCmxldCBidXN5SW5kaWNhdG9yOwppZiAobWFudWFsUHVibGlzaCAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKSB7CiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKICAgIGlmICghbGlua3MubWVudSkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7CiAgICB9CiAgICAKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgdXBsb2FkaW5nICR7dGhhdC5hYn1gLCBvbkRlc3Ryb3k6IGBAY29uc29sZS5sb2coJ2J1c3kgaW5kaWNhdG9yIGdvIGJvb20nKWB9KTsKfQoKaWYgKCF0YXJnZXQgfHwgdGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgIGlmIChjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgJiYgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQikgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBhYklEKTsKCiAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKICAgIH0gZWxzZSBpZiAoY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiAmJiBnZXRCb3QoImFiSURPcmlnaW4iLCBiYXNlQUIpKSB7CiAgICAgICAgY29uc3QgZWdnQm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlICYmIGIudGFncy5hYklET3JpZ2luID09PSBjb25maWdCb3QudGFncy5zZWxlY3RlZEFCKTsKICAgICAgICBjb25zdCBuZXdCb3RzID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi50YWdzLmFiSURPcmlnaW4gPT0gbnVsbCk7CgogICAgICAgIHRhcmdldCA9IFsuLi5lZ2dCb3RzLCAuLi5uZXdCb3RzXTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhiID0+IGIuc3BhY2UgPT09ICdzaGFyZWQnICYmICFiLnRhZ3MuYWJJZ25vcmUpOwogICAgfQoKICAgIHNldFRhZyh0YXJnZXQsICJhYklET3JpZ2luIiwgYWJJRCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IG51bGw7CgogICAgaWYgKHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgibm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikgewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkgewogICAgICAgIGtleUNoZWNrID0gYXdhaXQgb3Muc2hvd0lucHV0KCIiLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ2NvbmZpcm0gc2VjcmV0IGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBpZiAoa2V5ICE9IGtleUNoZWNrKSB7CiAgICAgICAgaWYgKCFrZXlDaGVjaykgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KCJubyBrZXkgZW50ZXJlZCIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGFyZ2V0Lmxlbmd0aDsgaSsrKSB7CiAgICAgICAgbGV0IGN1cnJlbnRCb3RJRCA9IHRhcmdldFtpXS5pZDsKICAgICAgICBsZXQgY3VycmVudEJvdERhdGEgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRhcmdldFtpXSkpOwoKICAgICAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdERhdGE7CiAgICB9Cn0KZWxzZSB7CiAgICBzdGF0ZVt0YXJnZXQuaWRdID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0YXJnZXQpKTsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7IGFiSUQ6IGFiSUQgfSk7CgovL2FkZCB4cCBib3QgaGVyZQpzdGF0ZS5hYlhQQm90ID0gewogICAgc3BhY2U6ICJzaGFyZWQiLAogICAgaWQ6ICJhYlhQQm90IiwKICAgIHRhZ3M6IHsKICAgICAgICBmb3JtOiAibm90aGluZyIsCiAgICAgICAgc3lzdGVtOiAiYWIucGF0dGVybi5hYlhQQm90IiwKICAgICAgICBhdXRob3JJRDogYXV0aEJvdC5pZCwKICAgICAgICB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLm1heFZlcnNpb24sCiAgICAgICAgeHA6IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUCwKICAgICAgICBzaWduYXR1cmU6IGVnZ0NoZWNrLnNpZ25hdHVyZSwKICAgICAgICBhYklnbm9yZTogdHJ1ZSwKICAgIH0KfTsKCi8vIERvIGFub3RoZXIgcHJlcHJvY2Vzc2luZyBwYXNzIHRoYXQgYWxsb3dzIGxpc3RlbmVycyB0byBwcmVwcm9jZXNzIHRoZSBhYiBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmxldCBwcmVwcm9jZXNzQXJnID0geyBib3REYXRhOiBzdGF0ZSwgYWI6IGFiSUQsIHN0dWRpbywgcHVibGljRmFjaW5nLCBzb3VyY2VFdmVudCB9OwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gpIHsKICAgIGF3YWl0IG9uUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gocHJlcHJvY2Vzc0FyZykKfQoKYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHNob3V0KCdvbkFCUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gnLCBwcmVwcm9jZXNzQXJnKSk7CgovL2FkZGl0aW9uYWwgZmlsZSBkYXRhCmZvcm1hdHRlZEZpbGUudmVyc2lvbiA9IDE7CmZvcm1hdHRlZEZpbGUuc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwpmb3JtYXR0ZWRGaWxlLnN0YXRlID0gc3RhdGU7CgovL2FjdHVhbCBlbmNyeXB0aW9uIGlmIGNob3NlbgppZiAoa2V5KSB7CiAgICBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkoZm9ybWF0dGVkRmlsZSk7CiAgICBmb3JtYXR0ZWRGaWxlID0gY3J5cHRvLmVuY3J5cHQoa2V5LCBmb3JtYXR0ZWRGaWxlKTsKfQoKLy9wdWJsaXNoIHRoZSBmaWxlCmxldCBwdWJsaXNoRmlsZSA9IGF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoRmlsZSh7IGZpbGU6IGZvcm1hdHRlZEZpbGUsIGZpbGVOYW1lOiBhYklEIH0pOwoKLy9nYXRoZXIgYWRkaW9uYWwgZWdnIGRhdGEKY29uc3QgYWlQZXJtaXRDaGVjayA9IGF3YWl0IG9zLmdldERhdGEoYXV0aEJvdC5pZCwgImFpX3Blcm1pdCIpOwpjb25zdCBhaVBlcm1pdElEID0gYWlQZXJtaXRDaGVjay5zdWNjZXNzID8gYWlQZXJtaXRDaGVjay5kYXRhLnBlcm1pdElEIDogZmFsc2U7CgplZ2dDaGVjay5lZ2dEYXRhLmFpUGVybWl0ID0gYWlQZXJtaXRJRDsKZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5wdXNoKHB1Ymxpc2hGaWxlLnVybCk7CmVnZ0NoZWNrLmVnZ0RhdGEubWF4VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwplZ2dDaGVjay5lZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKCi8vcHVibGlzaCBlZ2cvYWIgcmVjb3JkCmxldCBwdWJsaXNoUmVjb3JkID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hSZWNvcmQoeyBkYXRhOiBlZ2dDaGVjay5lZ2dEYXRhLCByZWNvcmROYW1lOiBhYklELCBwdWJsaWNGYWNpbmc6IHB1YmxpY0ZhY2luZyB9KTsKbGV0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwoKLy9wdWJsaXNoaW5nIHNob3V0CnN1cGVyU2hvdXQoIm9uQUJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOwpzdXBlclNob3V0KCJvbkFiUHVibGlzaGVkIiwgeyBzdWNjZXNzOiBwdWJsaXNoRmlsZS5zdWNjZXNzLCBhYjogYWJJRCwgZmlsZUFkZHJlc3M6IHB1Ymxpc2hGaWxlLnVybCB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgovL3NlbmQgZGF0YSBhbmQgZm9ybWF0IHVybCBpZiBkYXRhIHN1Y2Nlc3NmdWxseSBzZW50CmlmIChwdWJsaXNoUmVjb3JkLnN1Y2Nlc3MpIHsKICAgIGNvbnN0IGJpb3MgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwogICAgY29uc3QgaW5zdFR5cGUgPSBwdWJsaWNGYWNpbmcgPyAiZnJlZSIgOiAibG9jYWwiOwoKICAgIHNldFRhZ01hc2sobGlua3MubGVhcm4sICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKCiAgICBpZiAobWFudWFsUHVibGlzaCkgewogICAgICAgIGNvbnN0IHVybCA9IHNpdGVPcmlnaW4gKyAiLz9wYXR0ZXJuPSIgKyBhYklEICsgIiZzdHVkaW89IiArIHN0dWRpbyArICImYmlvcz0iICsgYmlvczsKICAgICAgICBvcy5zZXRDbGlwYm9hcmQodXJsKTsKCiAgICAgICAgaWYgKGtleSkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCB3aXRoIGVuY3J5cHRlZCBkYXRhIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7dXJsfWApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7dXJsfWApOwogICAgICAgIH0KICAgIH0KCiAgICB0cnkgewogICAgICAgIGF3YWl0IGFuYWx5dGljcy5yZWNvcmRFdmVudCgnYWJfZWdnX3B1Ymxpc2gnLCB7IGFiOiBhYklELCB2ZXJzaW9uOiBlZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCB9KTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgIH0KfQplbHNlIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoewogICAgICAgIG1lc3NhZ2U6ICdwdWJsaXNoaW5nIGZhaWxlZCcsCiAgICAgICAgbG9nVHlwZTogJ2Vycm9yJywKICAgICAgICB0b2FzdDogIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZQogICAgfSkKCiAgICBjb25zb2xlLmVycm9yKGBmYWlsZWQgcHVibGlzaCByZWNvcmQ6YCwgcHVibGlzaFJlY29yZCk7Cn0KCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gcHVibGlzaFJlY29yZDsnAOGt5pkNufABCGFiSWdub3JlAgQA4a3mmQ3dygMEdHJ1ZScA4a3mmQ258AEKYWJEb3dubG9hZAIEAOGt5pkN4soDgRRAY29uc3QgcG9zc2libGVCb3RzID0gdGhhdD8ucG9zc2libGVCb3RzOwpsZXQgZmlsZW5hbWUgPSB0aGF0Py5maWxlbmFtZTsKbGV0IHNvdXJjZUV2ZW50ID0gdGhhdD8uc291cmNlRXZlbnQ7CmxldCBvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCA9IHRoYXQ/Lm9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkOwpsZXQgbG9nID0gdGhhdD8ubG9nID8/IHRydWU7CmxldCByZW9wZW5BYk1lbnUgPSB0aGF0Py5yZW9wZW5BYk1lbnUgPz8gdHJ1ZTsKCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zdCBzaG91bGREb3dubG9hZEluc3QgPSAhcG9zc2libGVCb3RzIHx8IChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykgJiYgcG9zc2libGVCb3RzLmxlbmd0aCA9PT0gMCk7CgppZiAoc2hvdWxkRG93bmxvYWRJbnN0KSB7CiAgICAvLyBEb3dubG9hZCBpbnN0LgogICAgZG93bmxvYWRCb3RzID0gZ2V0Qm90cyhiID0+ICFiLnRhZ3MuYWJJZ25vcmUgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcpOwoKICAgIGlmICghZmlsZW5hbWUpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgZmlsZW5hbWUgPSBgJHtvcy5nZXRDdXJyZW50SW5zdCgpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgIH0KCiAgICBpZiAobG9nKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGluc3QnKTsKICAgIH0KfSBlbHNlIHsKICAgIGlmIChBcnJheS5pc0FycmF5KHBvc3NpYmxlQm90cykpIHsKICAgICAgICAvLyBEb3dubG9hZCBib3RzLgogICAgICAgIGRvd25sb2FkQm90cyA9IHBvc3NpYmxlQm90czsKICAgICAgICBjb25zdCBib3RJZHMgPSBwb3NzaWJsZUJvdHMubWFwKGIgPT4gYi5pZCkuc29ydCgpOwogICAgICAgIGxldCBib3RJZHNTSEExID0gY3J5cHRvLmhhc2goJ3NoYTEnLCAnaGV4JywgYm90SWRzKTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtib3RJZHNTSEExLnN1YnN0cmluZygwLCA3KX1fJHtsaW5rcy51dGlscy5hYkZpbGVUaW1lY29kZSgpfWA7CiAgICAgICAgfQoKICAgICAgICBpZiAobG9nKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGBkb3dubG9hZCAke2Rvd25sb2FkQm90cy5sZW5ndGh9IGJvdHNgKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIERvd25sb2FkIGJvdC4KICAgICAgICBkb3dubG9hZEJvdHMgPSBbcG9zc2libGVCb3RzXTsKCiAgICAgICAgaWYgKCFmaWxlbmFtZSkgewogICAgICAgICAgICAvLyBHZW5lcmF0ZSBhIGZpbGVuYW1lIGlmIG9uZSBpcyBub3QgZ2l2ZW4uCiAgICAgICAgICAgIGZpbGVuYW1lID0gYCR7b3MuZ2V0Q3VycmVudEluc3QoKX1fJHtwb3NzaWJsZUJvdHMuaWQuc3Vic3RyaW5nKDAsIDcpfV8ke2xpbmtzLnV0aWxzLmFiRmlsZVRpbWVjb2RlKCl9YDsKICAgICAgICB9CgogICAgICAgIGlmIChsb2cpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coJ2Rvd25sb2FkIGJvdCcpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpIHsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9Cgpjb25zdCBzdGF0ZSA9IHt9OwoKLy8gRm9ybWF0IGJvdHMgZm9yIGZpbGUgc3RvcmFnZQpmb3IgKGxldCBpID0gMDsgaSA8IGRvd25sb2FkQm90cy5sZW5ndGg7IGkrKykgewogICAgbGV0IGN1cnJlbnRCb3RJRCA9IGRvd25sb2FkQm90c1tpXS5pZDsKICAgIGxldCBjdXJyZW50Qm90RGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZG93bmxvYWRCb3RzW2ldKSk7CgogICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3REYXRhOwp9CgppZiAoIWZpbGVuYW1lLmVuZHNXaXRoKCcuYXV4JykpIHsKICAgIGZpbGVuYW1lICs9ICcuYXV4JzsKfQoKLy8gRG8gYSBwcmVwcm9jZXNzaW5nIHBhc3MgdGhhdCBhbGxvd3MgbGlzdGVuZXJzIHRvIHByZXByb2Nlc3MgdGhlIGJvdCBkYXRhIGJlZm9yZSBpdCBpcyBwdWJsaXNoZWQuCmNvbnN0IHByZXByb2Nlc3NBcmcgPSB7IGJvdERhdGE6IHN0YXRlLCBmaWxlbmFtZSwgc291cmNlRXZlbnQgfTsKCmlmIChvblByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCkgewogICAgYXdhaXQgb25QcmVwcm9jZXNzQmVmb3JlRG93bmxvYWQocHJlcHJvY2Vzc0FyZyk7Cn0KCmF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzaG91dCgnb25BQlByZXByb2Nlc3NCZWZvcmVEb3dubG9hZCcsIHByZXByb2Nlc3NBcmcpKTsKCi8vIERvd25sb2FkIGFzIHYxIGF1eCBmaWxlLgpjb25zdCBhdXhGaWxlID0geyB2ZXJzaW9uOiAxLCBzdGF0ZSB9Owpvcy5kb3dubG9hZChhdXhGaWxlLCBmaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgppZiAocmVvcGVuQWJNZW51KSB7CiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKfScA4a3mmQ258AENbWFuaWZlc3RhdGlvbgIEAOGt5pkN5N4DKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAOGt5pkNufABBG1lbnUCBADhreaZDYvfAyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwDhreaZDbnwARJhYlByZXZpb3VzRWdnQ2hlY2sCBADhreaZDbLfA7EPQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGVnZ0hpc3Rvcnk7CmxldCBlZ2dJRDsKbGV0IHRhcmdldFZlcnNpb25OdW07CmxldCBsYXN0SGFzaDsKbGV0IG1heFZlcnNpb25OdW07CmxldCBzdGFibGVWZXJzaW9uOwpsZXQgZmVlZGJhY2tWZXJzaW9uOwpsZXQgcHJldmlvdXNYUDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKbGV0IHJlY29yZExvb2t1cCA9IGF3YWl0IG9zLmdldERhdGEodXNlclJlY29yZCwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycA4a3mmQ258AEPYWJCb3RNZW51QWN0aW9uAgQA4a3mmQ3k7gNNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAOGt5pkNufABDmFiQm90TWVudUxhYmVsAgQA4a3mmQ2y7wMFc2hhcmUnAOGt5pkNufABDWFiQm90TWVudUljb24CBADhreaZDbjvAwlpb3Nfc2hhcmUnAOGt5pkNufABEmFiQm90TWVudVNvcnRPcmRlcgIEAOGt5pkNwu8DAzMuNScA4a3mmQ258AEFbGVhcm4CBADhreaZDcbvAyjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDhreaZDbnwAQthYlFSUHVibGlzaAIEAOGt5pkN7e8D4QFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0LCBzb3VyY2VFdmVudDogJ3FyX3B1Ymxpc2gnfSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAOGt5pkNufABBnNlYXJjaAIEAOGt5pkNz/EDKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAOGt5pkNufABB2FiU2hlbGwCBADhreaZDfbxAwR0cnVlJwDhreaZDbnwAQxzdHVkaW9TZWxlY3QCBADhreaZDfvxA4sLQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwDhreaZDbnwAQ5hYlB1Ymxpc2hBc2tJRAIEAOGt5pkNhf0D2wVAaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgcHVibGlzaGluZyAke3RoYXQuYXNrSUR9YH0pOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmNvbnN0IHBhdHRlcm5JRCA9IHRoYXQucGF0dGVybklEOwpjb25zdCBzdHVkaW9JRCA9IHRoYXQuc3R1ZGlvSUQgPyB0aGF0LnN0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRC5yZXBsYWNlQWxsKCItIiwgIiIpOwpjb25zdCBlbmRwb2ludCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKY29uc3QgcHVibGlzaEFzayA9IGF3YWl0IG9zLnJlY29yZERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIHtwYXR0ZXJuSUQ6IHBhdHRlcm5JRCwgc3R1ZGlvSUQ6IHN0dWRpb0lEfSwge2VuZHBvaW50OiBlbmRwb2ludCwgdXBkYXRlUG9saWN5OiBbYXV0aEJvdC5pZF19KTsKCmlmIChwcm9ncmVzc0J1dHRvbikKewogICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiBwdWJsaXNoQXNrOycA4a3mmQ258AEFaW5wdXQCBADhreaZDeGCBCjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwDhreaZDbnwAQthYkVtYmVkTGluawIEAOGt5pkNiIMEpANAY29uc3QgYWIgPSB0aGF0ID8gdHJ1ZSA6IGZhbHNlOwpjb25zdCBlbWJlZExpbmsgPSBhYiA/ICJhYj0iICsgdGhhdCA6ICJpbnN0PSIgKyBjb25maWdCb3QudGFncy5pbnN0Owpjb25zdCBzaXRlT3JpZ2luID0gbmV3IFVSTChjb25maWdCb3QudGFncy51cmwpLm9yaWdpbjsKY29uc3QgZW1iZWRUZXh0ID0gYDwhRE9DVFlQRSBodG1sPgrCoMKgwqDCoDxodG1sPgrCoMKgwqDCoMKgwqDCoMKgPGhlYWQ+PC9oZWFkPgrCoMKgwqDCoMKgwqDCoMKgPGJvZHk+CsKgwqDCoMKgwqDCoMKgwqDCoMKgwqDCoDxpZnJhbWUgc3JjPSIke3NpdGVPcmlnaW4gKyAiLz8iICsgZW1iZWRMaW5rfSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iNDAwIiAvPgrCoMKgwqDCoMKgwqDCoMKgPC9ib2R5PgrCoMKgwqDCoDwvaHRtbD5gOwoKcmV0dXJuIGVtYmVkVGV4dDsnAOGt5pkNufABD2FiUGF0dGVyblVwZGF0ZQIEAOGt5pkNgYYEpQVALy9zaG91dCgiYWJQYXR0ZXJuVXBkYXRlIiwge2FiSUQ6IGFiSUQsIHN0dWRpbzpzdHVkaW8/LCBib3RzOiBib3RzP30pOwphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKaWYgKCFhdXRoQm90KQp7CiAgICByZXR1cm47Cn0KCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7CmNvbnN0IHN0dWRpbyA9IHRoYXQuc3R1ZGlvID8gdGhhdC5zdHVkaW8gOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBhYk1hbmlmZXN0ID0gZ2V0Qm90KGJ5TW9kKHthYkVnZzogdHJ1ZSwgb3JpZ2luX2FiOiBhYklEfSkpOwoKaWYgKCFhYk1hbmlmZXN0KQp7CiAgICBzaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGF1dG9IYXRjaDogdHJ1ZSwgc291cmNlRXZlbnQ6ICdwYXR0ZXJuX3VwZGF0ZSd9KTsKCiAgICByZXR1cm47Cn0KCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gc3R1ZGlvOwoKY29uc3QgYWJCb3RzID0gdGhhdC5ib3RzID8/IGdldEJvdHMoImFiSURPcmlnaW4iLCBhYklEKTsKCmF3YWl0IHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBhYklELCB0YXJnZXQ6IGFiQm90cywgcHVibGljRmFjaW5nOiB0cnVlLCBzb3VyY2VFdmVudDogJ3BhdHRlcm5fdXBkYXRlJ30pOycA4a3mmQ258AEXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBADhreaZDaeLBE1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycA4a3mmQ258AEaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBADhreaZDfWLBAEyJwDhreaZDbnwARVhYk11bHRpcGxlQm90TWVudUljb24CBADhreaZDfeLBAlpb3Nfc2hhcmUnAOGt5pkNufABFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBADhreaZDYGMBAVzaGFyZScA4a3mmQ258AEPYWJQdWJsaXNoU2VsZWN0AgQA4a3mmQ2HjASqE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGIgPT4gYi50YWdzLmFiSURPcmlnaW4gPT09IHRhZ3MubGFiZWwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CmNvbnN0IG5vblBhdHRlcm5Cb3RzID0gZ2V0Qm90cyhiID0+IGIudGFncy5hYklET3JpZ2luID09IG51bGwgJiYgYi5zcGFjZSA9PT0gJ3NoYXJlZCcgJiYgIWIudGFncy5hYklnbm9yZSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwDhreaZDbnwAQlhYlZlcnNpb24CBADhreaZDbCfBAQxMC41JwDhreaZDbnwAQtwZXJzb25hbGl0eQIEAOGt5pkNtZ8EKPCflJdiNzZkZmJjNC04NTRiLTRmNmQtYTkxZi1hOTQ4Njk0Nzc0ZGInAOGt5pkNufABBXV0aWxzAgQA4a3mmQ3cnwQo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycBBGJvdHMkNzhlNDE1MDMtYzkzMy00ZjhhLTgxN2EtYmE5N2JmOGQ1ZDI3AScA4a3mmQ2DoAQVYWJGaW5kQXJ0aWZhY3RCdW5kbGVzAgQA4a3mmQ2EoASTBkBjb25zdCB7IAogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgPz8ge307Cgpjb25zdCBhcnRpZmFjdEJ1bmRsZXM6IFJlY29yZDxzdHJpbmcsIEFCQXJ0aWZhY3RCdW5kbGU+ID0ge307IC8vIEtleSBpcyBhcnRpZmFjdCBpZAoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSAmJiBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBiLnRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgICAgIGlmIChhYkFydGlmYWN0SW5zdGFuY2VJRCAmJiBhYkFydGlmYWN0SW5zdGFuY2VJRCAhPT0gYi50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFydGlmYWN0SWQgPSBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZS5pZDsKCiAgICAgICAgaWYgKGFydGlmYWN0SWQgJiYgIWFydGlmYWN0QnVuZGxlc1thcnRpZmFjdElkXSkgewogICAgICAgICAgICBhcnRpZmFjdEJ1bmRsZXNbYXJ0aWZhY3RJZF0gPSBiLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICB9CiAgICB9Cn0pOwoKcmV0dXJuIGFydGlmYWN0QnVuZGxlczsnAOGt5pkNg6AEBXN0b3JlAgQA4a3mmQ2YpgQo8J+Ulzc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZicA4a3mmQ2DoAQGc3lzdGVtAgQA4a3mmQ2/pgQRYWIuc2hlbGwuYXJ0aWZhY3QnAOGt5pkNg6AECGFiSWdub3JlAgQA4a3mmQ3RpgQEdHJ1ZScA4a3mmQ2DoAQJYWJWZXJzaW9uAgQA4a3mmQ3WpgQEMTAuNScA4a3mmQ2DoAQFZGVidWcCBADhreaZDdumBAR0cnVlJwDhreaZDYOgBAhyZW1lbWJlcgIEAOGt5pkN4KYEKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAOGt5pkNg6AEE2FiQ3JlYXRlQXJ0aWZhY3RCb3QCBADhreaZDYenBNYSQGNvbnN0IHsKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICBkaW1lbnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiSW5zdCA/PyAnaG9tZScsCiAgICBwb3NpdGlvbiA9IG5ldyBWZWN0b3IzKDAsIDAsIDApLAogICAgb3RoZXJUYWdzID0ge30sCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBhYkFydGlmYWN0QmFzZUNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0QmFzZUNvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQ7CmNvbnN0IGFiQXJ0aWZhY3RMYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0TGFiZWxDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdDsKCmNvbnN0IGFiQXJ0aWZhY3RCb3QgPSBjcmVhdGUoewogICAgc3BhY2U6ICdzaGFyZWQnLAogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RCb3Q6IHRydWUsCiAgICBbZGltZW5zaW9uXTogdHJ1ZSwKICAgIFtgJHtkaW1lbnNpb259WGBdOiBwb3NpdGlvbi54LAogICAgW2Ake2RpbWVuc2lvbn1ZYF06IHBvc2l0aW9uLnksCiAgICBbYCR7ZGltZW5zaW9ufVpgXTogcG9zaXRpb24ueiwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBsYWJlbENvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIHN0cm9rZUNvbG9yOiBhYkFydGlmYWN0TGFiZWxDb2xvciwKICAgIG9uQm90QWRkZWQ6IGBACiAgICAgICAgdGhpc0JvdC51cGRhdGVDb21wdXRlZFRhZ3MoKTsKICAgIGAsCiAgICBvbkJvdENoYW5nZWQ6IGBACiAgICAgICAgY29uc3QgY2hhbmdlZFRhZ3MgPSB0aGF0LnRhZ3M7CgogICAgICAgIGlmIChjaGFuZ2VkVGFncy5zb21lKHQgPT4gdCA9PT0gJ2FiQXJ0aWZhY3RJbnN0YW5jZUlEJyB8fCB0ID09PSAnYWJBcnRpZmFjdE5hbWUnKSkgewogICAgICAgICAgICB0aGlzQm90LnVwZGF0ZUNvbXB1dGVkVGFncygpOwogICAgICAgIH0KICAgIGAsCiAgICB1cGRhdGVDb21wdXRlZFRhZ3M6IGBACiAgICAgICAgbGV0IHN5c3RlbSA9ICdhYkFydGlmYWN0Qm90JzsKCiAgICAgICAgaWYgKHRhZ3MuYWJBcnRpZmFjdE5hbWUpIHsKICAgICAgICAgICAgc3lzdGVtICs9ICcuJyArIHRhZ3MuYWJBcnRpZmFjdE5hbWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgICAgICBzeXN0ZW0gKz0gJy4nICsgdGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRC5zdWJzdHJpbmcoMCwgNyk7CiAgICAgICAgfQoKICAgICAgICB0YWdzLnN5c3RlbSA9ICEhc3lzdGVtID8gc3lzdGVtIDogbnVsbDsKICAgICAgICB0YWdzLmxhYmVsID0gdGFncy5zeXN0ZW07CiAgICBgLAogICAgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlOiBgQAogICAgICAgIC8vIEhpZGUgYXJ0aWZhY3QgYm90IG9uY2UgaXQgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC4KICAgICAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnbGFiZWwnLCAnICcsICdzaGFyZWQnKTsKICAgIGAsCiAgICAuLi5vdGhlclRhZ3MsCn0pOwoKdHJ5IHsKICAgIC8vIFVwZGF0ZSBhbGwgdGhlIHNoYXJkcyBmb3IgdGhpcyBhcnRpZmFjdCBpbnN0YW5jZSAtLSB3aGljaCBub3cgaW5jbHVkZXMgdGhpcyBib3QhCiAgICBjb25zdCB1cGRhdGVSZXN1bHQgPSBhd2FpdCB0aGlzQm90LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEluc3RhbmNlSUQgfSk7CgogICAgaWYgKCF1cGRhdGVSZXN1bHQuc3VjY2VzcykgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHVwZGF0ZSAnJHthYkFydGlmYWN0TmFtZX0nIGFydGlmYWN0IHNoYXJkcy5gKTsKICAgIH0KfSBjYXRjaCAoZSkgewogICAgY29uc29sZS5lcnJvcihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhdWdodCBlcnJvciB3aGlsZSB1cGRhdGUgYXJ0aWZhY3Qgc2hhcmRzOmAsIGUpOwogICAgZGVzdHJveShhYkFydGlmYWN0Qm90KTsKICAgIHJldHVybiBudWxsOwp9CgpyZXR1cm4gYWJBcnRpZmFjdEJvdDsnAOGt5pkNg6AEFmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGUCBADhreaZDd65BOoIQGlmICghY29uZmlnQm90LnRhZ3MucmVjb25zdGl0dXRpb24pIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmFzc2VydCh0eXBlb2YgdGhhdCA9PT0gJ29iamVjdCcsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJnIG9iamVjdCBtdXN0IGJlIHByb3ZpZGVkLmApOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdGhhdDpgLCB0aGF0KTsKfQoKY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKfSA9IHRoYXQgYXMgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZzsKCmFzc2VydChhYkFydGlmYWN0QnVuZGxlICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGF0YSAmJiBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0QnVuZGxlIGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBBQkFydGlmYWN0QnVuZGxlLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgc3RyaW5nLmApOwoKY29uc3QgZm9ybWF0VmVyc2lvbiA9IGFiQXJ0aWZhY3RCdW5kbGUuZm9ybWF0VmVyc2lvbjsKCmlmIChmb3JtYXRWZXJzaW9uID09IG51bGwpIHsKICAgIHRocm93IG5ldyBFcnJvcihgZm9ybWF0VmVyc2lvbiAke2Zvcm1hdFZlcnNpb259IGlzIG5vdCB2YWxpZC5gKTsKfQoKY29uc3QgZnVuY1RhZ05hbWUgPSBgYWJBcnRpZmFjdFJlY29uc3RpdHV0ZV92JHtmb3JtYXRWZXJzaW9ufWA7CgppZiAodHlwZW9mIHRoaXNCb3RbZnVuY1RhZ05hbWVdICE9PSAnZnVuY3Rpb24nKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZnVuY1RhZ05hbWV9IGlzIG5vdCBhIGZ1bmN0aW9uLmApCn0KCi8vIENhbGwgdGhlIHZlcnNpb25lZCByZWNvbnN0aXR1dGUgZnVuY3Rpb24uCnJldHVybiBhd2FpdCB0aGlzQm90W2Z1bmNUYWdOYW1lXSh0aGF0KTsnAOGt5pkNg6AEF2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uAgQA4a3mmQ3JwgQBMScA4a3mmQ2DoAQGc2VhcmNoAgQA4a3mmQ3LwgQo8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScA4a3mmQ2DoAQHYWJTaGVsbAIEAOGt5pkN8sIEBHRydWUnAOGt5pkNg6AEBXV0aWxzAgQA4a3mmQ33wgQo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycA4a3mmQ2DoAQZYWJBcnRpZmFjdFJlY29uc3RpdHV0ZV92MQIEAOGt5pkNnsMEmyBAaWYgKCFjb25maWdCb3QudGFncy5yZWNvbnN0aXR1dGlvbikgewogICAgY29uc29sZS53YXJuKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gcmVjb25zdGl0dXRpb24gaXMgZGlzYWJsZWRgKTsKICAgIHJldHVybjsKfQoKYXNzZXJ0KHR5cGVvZiB0aGF0ID09PSAnb2JqZWN0JywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcmcgb2JqZWN0IG11c3QgYmUgcHJvdmlkZWQuYCk7Cgpjb25zdCB7IAogICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlELAogICAgdG9hc3QgPSB0cnVlLAp9ID0gdGhhdCBhcyBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnOwoKYXNzZXJ0KGFiQXJ0aWZhY3RCdW5kbGUgJiYgYWJBcnRpZmFjdEJ1bmRsZS5kYXRhICYmIGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCdW5kbGUgaXMgcmVxdWlyZWQgdG8gYmUgb2YgdHlwZSBBQkFydGlmYWN0QnVuZGxlLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHRvIGJlIG9mIHR5cGUgc3RyaW5nLmApOwoKY29uc3QgYWJBcnRpZmFjdEJ1bmRsZVN0cmluZyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGFiQXJ0aWZhY3RCdW5kbGUpOwpjb25zdCBzaGFyZEJvdHMgPSBbXTsKCmZ1bmN0aW9uIGhhbmRsZVByZXByb2Nlc3NCZWZvcmVDcmVhdGUoeyBib3REYXRhIH0pIHsKICAgIGZvciAoY29uc3Qga2V5IGluIGJvdERhdGEpIHsKICAgICAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQ7IC8vIElmIHRoZSBzaGFyZCBib3QgaGFzIGl0c2VsZiBtYXJrZWQgYXMgcmVjb25zdGl0dXRlZCBhbHJlYWR5IChwb3NzaWJseSBkdWUgdG8gYW4gb3ZlcnNpZ2h0KSwgdGhlbiByZW1vdmUgaXQhCgogICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0QnVuZGxlID0gYWJBcnRpZmFjdEJ1bmRsZVN0cmluZzsgLy8gQXNzaWduIHRoZSBhcnRpZmFjdCBidW5kbGUgYmFjayB0byB0aGUgaGF0Y2hlZCBzaGFyZCBib3QuCiAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gYWJBcnRpZmFjdEluc3RhbmNlSUQ7IC8vIFVVSUQgb2YgdGhlIGFydGlmYWN0IGluc3RhbmNlIHRoYXQgdGhpcyBib3QgYmVsb25ncyB0by4KICAgICAgICBkYXRhLnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsgLy8gVVVJRCBhc3NpZ25lZCB0byB0aGUgYm90IGJ5IHRoZSBhcnRpZmFjdCB3aGVuIGxvYWRlZC4KICAgIH0KfQoKZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzKSB7CiAgICBjb25zdCBkZXBlbmRlbmN5Qm90cyA9IFtdOwoKICAgIGlmICh0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSkgewogICAgICAgIGNvbnN0IGVnZ0RlcGVuZGVuY3kgPSBkZXBlbmRlbmN5IGFzIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5OwogICAgICAgIAogICAgICAgIC8vIEZpcnN0IHRyeSB0byBsb2FkIGZyb20gZWdnLgogICAgICAgIGNvbnN0IGxvb2t1cEVnZ1Jlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICAgICAgICAgIGFiSUQ6IGVnZ0RlcGVuZGVuY3kuYWJJRCwKICAgICAgICAgICAgcmVjb3JkS2V5OiBlZ2dEZXBlbmRlbmN5LnJlY29yZEtleSwKICAgICAgICAgICAgYWJWZXJzaW9uOiBlZ2dEZXBlbmRlbmN5LmFiVmVyc2lvbiwKICAgICAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgICAgICAgICBzb3VyY2VFdmVudDogJ3JlY29uc3RpdHV0ZScsCiAgICAgICAgICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogaGFuZGxlUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZQogICAgICAgIH0pCgogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHthYkFydGlmYWN0QnVuZGxlLm5hbWV9ICR7ZWdnRGVwZW5kZW5jeS5hYklEfSBsb29rdXBFZ2dSZXN1bHQ6YCwgbG9va3VwRWdnUmVzdWx0KTsKICAgICAgICB9CgogICAgICAgIGlmIChsb29rdXBFZ2dSZXN1bHQuc3VjY2VzcykgewogICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2coYCR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfSAoaW5zdGFuY2UgaWQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KSBsb2FkZWQgZGVwZW5kZW5jeSBhYklEOiAke2VnZ0RlcGVuZGVuY3kuYWJJRH0sIGFiVmVyc2lvbjogJHtlZ2dEZXBlbmRlbmN5LmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBoYXRjaGVkQm90IG9mIGxvb2t1cEVnZ1Jlc3VsdC5oYXRjaGVkQm90cykgewogICAgICAgICAgICAgICAgZGVwZW5kZW5jeUJvdHMucHVzaChoYXRjaGVkQm90KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAoZGVwZW5kZW5jeUJvdHMubGVuZ3RoID09PSAwICYmIHRoaXNCb3QuaXNBc2tEZXBlbmRlbmN5KGRlcGVuZGVuY3kpKSB7CiAgICAgICAgY29uc3QgYXNrRGVwZW5kZW5jeSA9IGRlcGVuZGVuY3kgYXMgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgogICAgICAgIC8vIFRyeSB0byBsb2FkIGZyb20gYXNrLgogICAgICAgIGNvbnN0IGxvb2t1cEFza1Jlc3VsdDogQUJMb29rdXBBc2tJRFJlc3VsdCA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFza0lEKHsKICAgICAgICAgICAgYXNrSUQ6IGFza0RlcGVuZGVuY3kuYXNrSUQsCiAgICAgICAgICAgIHNob3dJbmRpY2F0b3I6IGZhbHNlLAogICAgICAgICAgICBhdXRvSGF0Y2g6IHRydWUsCiAgICAgICAgICAgIHNvdXJjZUV2ZW50OiAncmVjb25zdGl0dXRlJywKICAgICAgICAgICAgb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOiBoYW5kbGVQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlCiAgICAgICAgfSkKCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBsb29rdXBBc2tSZXN1bHQ6YCwgbG9va3VwQXNrUmVzdWx0KTsKICAgIH0KCiAgICBpZiAoZGVwZW5kZW5jeUJvdHMubGVuZ3RoID4gMCkgewogICAgICAgIGZvciAoY29uc3Qgc2hhcmRCb3Qgb2YgZGVwZW5kZW5jeUJvdHMpIHsKICAgICAgICAgICAgc2V0VGFnTWFzayhzaGFyZEJvdCwgJ2FiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7IC8vIFRoaXMgYm90IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQgaW4gdGhpcyBpbnN0LgogICAgICAgICAgICBzaGFyZEJvdHMucHVzaChzaGFyZEJvdCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0gZmFpbGVkIHRvIGxvYWQgZGVwZW5kZW5jeTogJHtKU09OLnN0cmluZ2lmeShkZXBlbmRlbmN5KX1gLCBsb2dUeXBlOiAnZXJyb3InfSk7CiAgICB9Cn0KCi8vIFRlbGwgYWxsIGhhdGNoZWQgc2hhcmQgYm90cyB0byByZWNvbnN0aXR1dGUuIAovLyBUaGV5IGFsbCBoYXZlIGNvcGllcyBvZiB0aGUgYWJBcnRpZmFjdEJ1bmRsZSBhbmQgY2FuIHJlY29uc3RpdHV0ZSB0aGVtc2VsdmVzIGZyb20gdGhhdC4Kd2hpc3BlcihzaGFyZEJvdHMsICdvbkFCQXJ0aWZhY3RSZWNvbnN0aXR1dGUnLCB7IGFiQXJ0aWZhY3RCdW5kbGUgfSk7CgppZiAodG9hc3QpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX0nIChpbnN0YW5jZSBpZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0pIGZpbmlzaGVkIHJlY29uc3RpdHV0aW9uLmApCn0gZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyhgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJ1bmRsZS5uYW1lfScgKGluc3RhbmNlIGlkOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSkgZmluaXNoZWQgcmVjb25zdGl0dXRpb24uYCk7Cn0KJwDhreaZDYOgBA9vbkFueUJvdENsaWNrZWQCBADhreaZDbjjBIEBQGNvbnN0IHsgYm90IH0gPSB0aGF0OwoKaWYgKGJvdCAmJiBib3QudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51T3Blbih7IGFiQXJ0aWZhY3RCb3Q6IGJvdCB9KQp9JwDhreaZDYOgBBZhYlVwZGF0ZUFydGlmYWN0U2hhcmRzAgQA4a3mmQ265ATyBkBjb25zdCB7IAogICAgYWJBcnRpZmFjdE5hbWUsCiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRCwKICAgIGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uID0gdGFncy5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiAvLyBEZWZhdWx0IHRvIHRoZSBjdXJyZW50IGZvcm1hdCB2ZXJzaW9uLgp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dYCwgeyBhYkFydGlmYWN0TmFtZSwgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gfSk7CgppZiAoYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gPT0gbnVsbCkgewogICAgdGhyb3cgbmV3IEVycm9yKGBhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiAke2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9ufSBpcyBub3QgdmFsaWQuYCk7Cn0KCmNvbnN0IGZ1bmNUYWdOYW1lID0gYGFiVXBkYXRlQXJ0aWZhY3RTaGFyZHNfdiR7YWJBcnRpZmFjdEZvcm1hdFZlcnNpb259YDsKCmlmICh0eXBlb2YgdGhpc0JvdFtmdW5jVGFnTmFtZV0gIT09ICdmdW5jdGlvbicpIHsKICAgIHRocm93IG5ldyBFcnJvcihgJHtmdW5jVGFnTmFtZX0gaXMgbm90IGEgZnVuY3Rpb24uYCkKfQoKLy8gQ2FsbCB0aGUgdmVyc2lvbmVkIGNyZWF0ZSBmdW5jdGlvbi4KcmV0dXJuIHRoaXNCb3RbZnVuY1RhZ05hbWVdKHRoYXQpOycA4a3mmQ2DoAQZYWJVcGRhdGVBcnRpZmFjdFNoYXJkc192MQIEAOGt5pkNresE8zBAY29uc3QgYWJBcnRpZmFjdE5hbWUgPSB0aGF0LmFiQXJ0aWZhY3ROYW1lOwpsZXQgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSB0aGF0LmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0SW5zdGFuY2VJRCBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7Cgpjb25zdCBBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUcgPSAnb25BQkFydGlmYWN0Q29sbGVjdFNoYXJkcyc7Cgpjb25zdCBzaGFyZEJvdHMgPSBnZXRCb3RzKChiKSA9PiB7CiAgICByZXR1cm4gYi50YWdzLmFiQXJ0aWZhY3ROYW1lID09PSBhYkFydGlmYWN0TmFtZSAmJgogICAgICAgICAgIGIudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9PT0gYWJBcnRpZmFjdEluc3RhbmNlSUQKfSk7CgppZiAoc2hhcmRCb3RzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBUaGVyZSBhcmUgbm8gc2hhcmRzIGZvciBhcnRpZmFjdCBuYW1lICcke2FiQXJ0aWZhY3ROYW1lfScuYCwgbG9nVHlwZTogJ3dhcm4nIH0pOwogICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKfQoKCmNvbnN0IHByZXZBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHNoYXJkQm90c1swXS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CmNvbnN0IHByZXZBcnRpZmFjdElEID0gcHJldkFydGlmYWN0QnVuZGxlID8gcHJldkFydGlmYWN0QnVuZGxlLmlkIDogbnVsbDsKCi8qKiBBbiBhcnRpZmFjdCBidW5kbGUgaXMgdGhlIGNvbWJpbmF0aW9uIG9mIHNoYXJkIGRhdGEgYW5kIHNoYXJkIGRlcGVuZGVuY2llcy4gKi8KY29uc3QgYWJBcnRpZmFjdEJ1bmRsZTogQUJBcnRpZmFjdEJ1bmRsZSA9IHsKICAgIG5hbWU6IGFiQXJ0aWZhY3ROYW1lLAogICAgZm9ybWF0VmVyc2lvbjogMSwKICAgIGRhdGE6IHt9LAogICAgZGVwZW5kZW5jaWVzOiBbXSwKfQoKLyoqIEtlZXAgdHJhY2sgb2YgZGVwZW5kZW5jeSBoYXNoZXMuIFRoaXMgcHJldmVudHMgZHVwbGljYXRlcyBpbiB0aGUgYXJ0aWZhY3QgZGVwZW5kZW5jaWVzLiAqLwpjb25zdCBkZXBlbmRlbmN5SGFzaGVzID0gbmV3IFNldCgpOwoKZm9yIChjb25zdCBzaGFyZEJvdCBvZiBzaGFyZEJvdHMpIHsKICAgIGNvbnN0IGJvdFNob3J0SWQgPSBzaGFyZEJvdC5pZC5zdWJzdHJpbmcoMCwgNSk7CgogICAgbGV0IHNoYXJkOiBBQkFydGlmYWN0U2hhcmQ7CiAgICBpZiAoc2hhcmRCb3QudGFnc1tBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUddKSB7CiAgICAgICAgaWYgKHNoYXJkQm90W0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR10pIHsKICAgICAgICAgICAgc2hhcmQgPSBhd2FpdCBQcm9taXNlLnJlc29sdmUoc2hhcmRCb3RbQVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHXSgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyAke0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR30gdGFnIGlzIGRlZmluZWQgYnV0IGlzIG5vdCBhIHZhbGlkIGZ1bmN0aW9uLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgc2hhcmQ6YCwgc2hhcmQpOwogICAgfQoKICAgIGlmIChzaGFyZCkgewogICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQpKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR30gc2hhcmQgbXVzdCBiZSBhbiBvYmplY3QuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kYXRhKSB7CiAgICAgICAgICAgIGlmICghbGlua3MudXRpbHMuaXNPYmplY3Qoc2hhcmQuZGF0YSkpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR30gc2hhcmQgJ2RhdGEnIHByb3BlcnR5IG11c3QgYmUgYW4gb2JqZWN0LmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaGFsbG93IG1lcmdlIHNoYXJkJ3MgZGF0YSBwcm9wZXJ0aWVzIGludG8gY29tYmluZWQgYXJ0aWZhY3QgZGF0YS4KICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZS5kYXRhID0geyAuLi5hYkFydGlmYWN0QnVuZGxlLmRhdGEsIC4uLnNoYXJkLmRhdGEgfTsKICAgICAgICB9CgogICAgICAgIGlmIChzaGFyZC5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgaWYgKCFsaW5rcy51dGlscy5pc0FycmF5KHNoYXJkLmRlcGVuZGVuY2llcykpIHsKICAgICAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9JyBib3QgJyR7Ym90U2hvcnRJZH0nIEAke0FSVElGQUNUX1NIQVJEX0xJU1RFTkVSX1RBR30gc2hhcmQgJ2RlcGVuZGVuY2llcycgcHJvcGVydHkgbXVzdCBiZSBhbiBhcnJheS5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChjb25zdCBkZXBlbmRlbmN5IG9mIHNoYXJkLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgLy8gVmFsaWRhdGUgdGhhdCBkZXBlbmRlbmN5IGlzIG9uZSBvZiB0aGUgc3VwcG9ydGVkIHR5cGVzLgogICAgICAgICAgICAgICAgaWYgKCF0aGlzQm90LmlzRWdnRGVwZW5kZW5jeShkZXBlbmRlbmN5KSAmJiAhdGhpc0JvdC5pc0Fza0RlcGVuZGVuY3koZGVwZW5kZW5jeSkpIHsKICAgICAgICAgICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyBoYXMgYSBkZXBlbmRlbmN5IGVudHJ5IHRoYXQgaXMgbmVpdGhlciBhbiBlZ2cgb3IgYXNrIGRlcGVuZGVuY3kgdHlwZS5gLCBsb2dUeXBlOiAnZXJyb3InIH0pOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWFrZSBzdXJlIHRoaXMgZGVwZW5kZW5jeSBpc250IGFscmVhZHkgY29sbGVjdGVkLgogICAgICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyeXB0by5oYXNoKCdzaGExJywgJ2hleCcsIGRlcGVuZGVuY3kpOwoKICAgICAgICAgICAgICAgIGlmICghZGVwZW5kZW5jeUhhc2hlcy5oYXMoaGFzaCkpIHsKICAgICAgICAgICAgICAgICAgICBkZXBlbmRlbmN5SGFzaGVzLmFkZChoYXNoKTsKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0QnVuZGxlLmRlcGVuZGVuY2llcy5wdXNoKGRlcGVuZGVuY3kpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovLyBNYWtlIHN1cmUgd2UgaGF2ZSBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeS4KaWYgKGFiQXJ0aWZhY3RCdW5kbGUuZGVwZW5kZW5jaWVzLmxlbmd0aCA9PT0gMCkgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIG11c3QgbGlzdCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeSBpbiBvcmRlciB0byByZWNvbnN0aXR1dGUgcHJvcGVybHkuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KCi8vIEdlbmVyYXRlIHRoZSBhcnRpZmFjdCBpZCwgd2hpY2ggaXMgc2hhMjU2IGhhc2ggb2YgdGhlIGNvcmUgY29udGVudHMgb2YgdGhlIGFydGlmYWN0LgphYkFydGlmYWN0QnVuZGxlLmlkID0gY3J5cHRvLnNoYTI1NihhYkFydGlmYWN0QnVuZGxlKTsKCmlmIChwcmV2QXJ0aWZhY3RJRCAmJiBwcmV2QXJ0aWZhY3RJRCAhPT0gYWJBcnRpZmFjdEJ1bmRsZS5pZCkgewogICAgLy8gVGhlIGFydGlmYWN0IGhhcyBhIG5ldyBpZC4gQWxsIG9mIHRoZSBzaGFyZCBib3RzIG5lZWQgYSBuZXcgaW5zdGFuY2UgaWQgYXMgd2VsbC4KICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwoKICAgIGZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAgICAgc2hhcmRCb3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCA9IGFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsKICAgIH0KfQoKLy8gU3RvcmUgc29tZSBleHRyYSBtZXRhZGF0YSBwcm9wZXJ0aWVzIHdpdGggdGhlIGFydGlmYWN0LgovLyBUaGVzZSBhcmUgbm90IGNvcmUgdG8gdGhlIGFydGlmYWN0J3MgZnVuY3Rpb25hbGl0eSBidXQgbWF5IGJlIHVzZWZ1bCBhcyBhcnRpZmFjdHMgZXZvbHZlLgphYkFydGlmYWN0QnVuZGxlLmNhc3VhbE9TVmVyc2lvbiA9IG9zLnZlcnNpb24oKTsKYWJBcnRpZmFjdEJ1bmRsZS5jcmVhdGVkVGltZXN0YW1wID0gRGF0ZVRpbWUubm93KCkudG9JU08oKTsKYWJBcnRpZmFjdEJ1bmRsZS5hYlNoZWxsVmVyc2lvbiA9IGAke2xpbmtzLnZlcnNpb24ucmF3LmFiU2hlbGxNYWpvclZlcnNpb259LiR7bGlua3MudmVyc2lvbi5yYXcuYWJTaGVsbE1pbm9yVmVyc2lvbn1gOwoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZmluYWwgbWVyZ2VkIGFydGlmYWN0ICR7YWJBcnRpZmFjdE5hbWV9OmAsIGFiQXJ0aWZhY3RCdW5kbGUpOwp9CgovLyBFdmVyeSBzaGFyZCBib3QgZ2V0cyBhIGNvcHkgb2YgdGhlIGFydGlmYWN0IGJ1bmRsZS4KLy8gVGhpcyBtYWtlcyB0aGUgYXJ0aWZhY3QgaG9sb2dyYXBoaWMgYnkgbmF0dXJlLiBUaGlzIG1lYW5zIHRoYXQgYW55IHNoYXJkIGNhbiBiZSB1c2VkIHRvIHJlY29uc3RpdHV0ZSB0aGUgd2hvbGUuCmZvciAoY29uc3Qgc2hhcmRCb3Qgb2Ygc2hhcmRCb3RzKSB7CiAgICAvLyBNYXJrIGVhY2ggc2hhcmQgYm90IGFzIGJlaW5nICdyZWNvbnN0aXR1dGVkJyB3aGVuIHdlIHVwZGF0ZSB0aGUgYXJ0aWZhY3QuCiAgICAvLyBCZWNhdXNlIHRoaXMgaXMgYSBzaGFyZWQgdGFnIG1hc2ssIGl0IHdpbGwgb25seSBiZSB0cnVlIGluIHRoZSBjdXJyZW50IGluc3QuCiAgICBzZXRUYWdNYXNrKHNoYXJkQm90LCAnYWJBcnRpZmFjdFNoYXJkUmVjb25zdGl0dXRlZCcsIHRydWUsICdzaGFyZWQnKTsKICAgIHNoYXJkQm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZSA9ICAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShhYkFydGlmYWN0QnVuZGxlKTsKfQoKLy8gUnlhbiBDb29rOiBOZWVkIHRvIGdpdmUgQ2FzdWFsT1MgYSBjaGFuY2UgdG8gY2F0Y2h1cC4KLy8gRm91bmQgdGhhdCBpZiB3ZSBkaWRudCBkbyB0aGlzLCBtb2QgdGFncyB3b3VsZCBub3QgYmUgcmV0dXJuZWQgYXMgSlNPTiBvYmplY3RzIGJ1dCBpbnN0ZWFkIHRoZSByYXcgc3RyaW5nLgphd2FpdCBvcy5zbGVlcCgwKTsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHVwZGF0ZWQgYXJ0aWZhY3QgJyR7YWJBcnRpZmFjdE5hbWV9Jy4gQ29waWVkIGFydGlmYWN0IGJ1bmRsZSB0byAke3NoYXJkQm90cy5sZW5ndGh9IGJvdHMuIGFiQXJ0aWZhY3RCdW5kbGU6YCwgYWJBcnRpZmFjdEJ1bmRsZSk7Cn0KCi8vIFNoYXJkIHVwZGF0ZSBzdWNjZXNzZnVsLgpyZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07JwDhreaZDYOgBARtZW51AgQA4a3mmQ2fnAUo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA4a3mmQ2DoAQFbGVhcm4CBADhreaZDcacBSjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwDhreaZDYOgBAtvbkdyaWRDbGljawIEAOGt5pkN7ZwFRkBpZiAobGlua3MuYXJ0aWZhY3RNZW51Qm90cykgewogICAgdGhpc0JvdC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7Cn0nAOGt5pkNg6AEGmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0AgQA4a3mmQ20nQUHI0FFQTFGRicA4a3mmQ2DoAQbYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0AgQA4a3mmQ28nQUHIzFlMWIyZCcA4a3mmQ2DoAQQb25BbnlCb3RzUmVtb3ZlZAIEAOGt5pkNxJ0FlQFAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7CgppZiAobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkICYmIGJvdElEcy5pbmNsdWRlcyhtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQpKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RCb3RNZW51UmVzZXQoKTsKfScA4a3mmQ2DoAQHdmVyc2lvbgIEAOGt5pkN2p4FKPCflJc1MjhkYzBmOS00M2VjLTQzZjMtYTQ3MC1lMmRkNmEwZGE5NWYnAOGt5pkNg6AEGGFiR2V0QXJ0aWZhY3ROYW1lc0luSW5zdAIEAOGt5pkNgZ8FrAFAY29uc3QgYWJBcnRpZmFjdE5hbWVzID0gbmV3IFNldCgpOwoKZ2V0Qm90cygoYikgPT4gewogICAgaWYgKGIudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIGFiQXJ0aWZhY3ROYW1lcy5hZGQoYi50YWdzLmFiQXJ0aWZhY3ROYW1lKTsKICAgIH0KfSkKCnJldHVybiBhYkFydGlmYWN0TmFtZXM7JwDhreaZDYOgBBVhYkFydGlmYWN0Qm90TWVudU9wZW4CBADhreaZDa6gBfsVQGNvbnN0IHsgYWJBcnRpZmFjdEJvdCB9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0Qm90ICYmIGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCnNob3V0KCJhYkFydGlmYWN0Qm90TWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYkFydGlmYWN0TWVudSI7CgppZiAoIXRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzKSB7CiAgICB0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwp9Cgpjb25zdCBhYkFydGlmYWN0QmFzZUNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0QmFzZUNvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvckRlZmF1bHQ7CmNvbnN0IGFiQXJ0aWZhY3RMYWJlbENvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkFydGlmYWN0TGFiZWxDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yRGVmYXVsdDsKCmNvbnN0IGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGUgPSBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKCmxldCBpbmZvTGFiZWwgPSBgW2FydGlmYWN0IG5hbWVdOiAke2FiQXJ0aWZhY3RCdW5kbGUubmFtZX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGlkXTogJHthYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLCA3KX1cbmA7CmluZm9MYWJlbCArPSBgW2FydGlmYWN0IGluc3RhbmNlIGlkXTogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPz8gJ3Vuc2V0J30gXG5gOwppbmZvTGFiZWwgKz0gYFtyZWNvbnN0aXR1dGVkIGluIGluc3RdOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkfVxuYDsKaW5mb0xhYmVsICs9IGBbZm9ybWF0XTogdiR7YWJBcnRpZmFjdEJ1bmRsZS5mb3JtYXRWZXJzaW9ufVxuYDsKaW5mb0xhYmVsICs9IGBbY3JlYXRlZCB0aW1lXTogJHtEYXRlVGltZS5mcm9tSVNPKGFiQXJ0aWZhY3RCdW5kbGUuY3JlYXRlZFRpbWVzdGFtcCkudG9Mb2NhbGVTdHJpbmcoRGF0ZVRpbWUuREFURVRJTUVfU0hPUlRfV0lUSF9TRUNPTkRTKX1cbmA7CgovLyBIZWFkZXIKY29uc3QgaW5mb0JvdCA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51VGV4dCh7CiAgICBhYkFydGlmYWN0TWVudTogdHJ1ZSwKICAgIGxhYmVsOiBpbmZvTGFiZWwsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2goaW5mb0JvdCk7CgovLyBEb3dubG9hZCBzaGFyZCBidXR0b24uCmNvbnN0IGRvd25sb2FkQnV0dG9uID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgYWJBcnRpZmFjdE1lbnU6IHRydWUsCiAgICBhYkFydGlmYWN0Qm90OiBnZXRMaW5rKGFiQXJ0aWZhY3RCb3QpLAogICAgYWJBcnRpZmFjdFRvb2w6IGdldExpbmsodGhpc0JvdCksCiAgICBmb3JtQWRkcmVzczogJ2Rvd25sb2FkJywKICAgIGxhYmVsOiBgZG93bmxvYWQgc2hhcmRgLAogICAgY29sb3I6IGFiQXJ0aWZhY3RCYXNlQ29sb3IsCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGNvbnN0IGFiQXJ0aWZhY3RCdW5kbGUgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZTsKICAgICAgICBjb25zdCBmaWxlbmFtZSA9ICdhYkFydGlmYWN0LScgKyBhYkFydGlmYWN0QnVuZGxlLm5hbWUgKyAnLScgKyBhYkFydGlmYWN0QnVuZGxlLmlkLnN1YnN0cmluZygwLDcpICsgJy5hdXgnOyAKICAgICAgICBvcy5kb3dubG9hZEJvdHMoWyBsaW5rcy5hYkFydGlmYWN0Qm90IF0sIGZpbGVuYW1lKTsKICAgICAgICAKICAgICAgICBsaW5rcy5hYkFydGlmYWN0VG9vbC5hYkFydGlmYWN0Qm90TWVudVJlc2V0KCk7CiAgICBgLAp9KQp0aGlzQm90LnZhcnMuYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGRvd25sb2FkQnV0dG9uKTsKCi8vIFVwZGF0ZSBhcnRpZmFjdCBidXR0b24uCmNvbnN0IHVwZGF0ZUJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGFiQXJ0aWZhY3RUb29sOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgZm9ybUFkZHJlc3M6ICdzeW5jJywKICAgIGxhYmVsOiBgdXBkYXRlIGFydGlmYWN0YCwKICAgIGNvbG9yOiBhYkFydGlmYWN0QmFzZUNvbG9yLAogICAgb25DbGljazogYEAKICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlID0gbGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdE5hbWUgPSBhYkFydGlmYWN0QnVuZGxlLm5hbWU7CiAgICAgICAgY29uc3QgYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQ7CiAgICAgICAgCiAgICAgICAgYXdhaXQgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lLCBhYkFydGlmYWN0SW5zdGFuY2VJRCB9KTsKCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdEJvdE1lbnVPcGVuKHsgYWJBcnRpZmFjdEJvdDogbGlua3MuYWJBcnRpZmFjdEJvdCB9KTsKICAgIGAsCn0pCnRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLnB1c2godXBkYXRlQnV0dG9uKTsKCm1hc2tzLnNlbGVjdGVkQXJ0aWZhY3RCb3RJZCA9IGFiQXJ0aWZhY3RCb3QuaWQ7JwDhreaZDYOgBBlhYkRvd25sb2FkQXJ0aWZhY3RQYXR0ZXJuAgQA4a3mmQ2qtgX8BEBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIHNoYXJkQm90cywKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQodHlwZW9mIGFiQXJ0aWZhY3ROYW1lID09PSAnc3RyaW5nJywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0TmFtZSBpcyBhIHJlcXVpcmVkIHN0cmluZyBwYXJhbWV0ZXIuYCk7CmFzc2VydChBcnJheS5pc0FycmF5KHNoYXJkQm90cykgJiYgc2hhcmRCb3RzLmxlbmd0aCA+IDAsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc2hhcmRCb3RzIGlzIGEgcmVxdWlyZWQgQm90IGFycmF5IHBhcmFtZXRlci4gSXQgbXVzdCBoYXZlIGF0IGxlYXN0IDEgYm90LmApOwoKcmV0dXJuIGxpbmtzLnN0b3JlLmFiRG93bmxvYWQoeyAKICAgIHBvc3NpYmxlQm90czogc2hhcmRCb3RzLAogICAgZmlsZW5hbWU6IGAke2FiQXJ0aWZhY3ROYW1lfWAsCiAgICBzb3VyY2VFdmVudDogJ2Rvd25sb2FkX2FydGlmYWN0X3BhdHRlcm4nLAogICAgcmVvcGVuQWJNZW51OiBmYWxzZSwKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZURvd25sb2FkOiAoYXJnKSA9PiB7CiAgICAgICAgdGhpc0JvdC5hYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YShhcmcuYm90RGF0YSk7CiAgICB9Cn0pOycA4a3mmQ2DoAQWYWJBcnRpZmFjdEJvdE1lbnVSZXNldAIEAOGt5pkNp7sF7wFAaWYgKHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzICYmIHRoaXNCb3QudmFycy5hcnRpZmFjdE1lbnVCb3RzLmxlbmd0aCA+IDApIHsKICAgIGRlc3Ryb3kodGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMpOwogICAgdGhpc0JvdC52YXJzLmFydGlmYWN0TWVudUJvdHMgPSBbXTsKfQoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBudWxsOycA4a3mmQ2DoAQFdHlwZXMCBADhreaZDZe9BfAF8J+ThGludGVyZmFjZSBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnIHsKICAgIGFiQXJ0aWZhY3RCdW5kbGU6IEFCQXJ0aWZhY3RCdW5kbGU7CiAgICBhYkFydGlmYWN0SW5zdGFuY2VJRD86IHN0cmluZzsKICAgIHRvYXN0PzogYm9vbGVhbjsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHsKICAgIGFiSUQ6IHN0cmluZzsKICAgIHJlY29yZEtleTogc3RyaW5nOwogICAgYWJWZXJzaW9uPzogbnVtYmVyOwp9CgppbnRlcmZhY2UgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3kgewogICAgYXNrSUQ6IHN0cmluZzsKfQoKdHlwZSBBQkFydGlmYWN0RGVwZW5kZW5jeSA9IEFCQXJ0aWZhY3RFZ2dEZXBlbmRlbmN5IHwgQUJBcnRpZmFjdEFza0RlcGVuZGVuY3k7CgppbnRlcmZhY2UgQUJBcnRpZmFjdEJ1bmRsZSB7CiAgICBpZDogc3RyaW5nOwogICAgbmFtZTogc3RyaW5nOwogICAgZm9ybWF0VmVyc2lvbjogbnVtYmVyOwogICAgZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjsKICAgIGRlcGVuZGVuY2llczogQXJyYXk8QUJBcnRpZmFjdERlcGVuZGVuY3k+OwogICAgY2FzdWFsT1NWZXJzaW9uOiBBdXhWZXJzaW9uOwogICAgY3JlYXRlZFRpbWVzdGFtcDogc3RyaW5nOwogICAgYWJTaGVsbFZlcnNpb246IHN0cmluZzsKfQoKaW50ZXJmYWNlIEFCQXJ0aWZhY3RTaGFyZCB7CiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+OwogICAgZGVwZW5kZW5jaWVzOiBBcnJheTxBQkFydGlmYWN0RGVwZW5kZW5jeT47Cn0nAOGt5pkNg6AEGm9uQUJQcmVwcm9jZXNzQmVmb3JlQ3JlYXRlAgQA4a3mmQ2GwwWHMkBpZiAoIWNvbmZpZ0JvdC50YWdzLnJlY29uc3RpdHV0aW9uKSB7CiAgICBjb25zb2xlLndhcm4oYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvbnN0aXR1dGlvbiBpcyBkaXNhYmxlZGApOwogICAgcmV0dXJuOwp9Cgpjb25zdCB7IGJvdERhdGEsIG9yaWdpbiwgc3R1ZGlvLCByZWNvcmQsIHZlcnNpb24sIGVnZ1BhcmFtZXRlcnMsIGluaXRpYWxCb290LCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKaWYgKHNvdXJjZUV2ZW50ID09PSAnYXNrJyB8fCBzb3VyY2VFdmVudCA9PT0gJ3Bhc3RlJyB8fCBzb3VyY2VFdmVudCA9PT0gJ2Jvb3QnIHx8IHNvdXJjZUV2ZW50ID09PSAnZmlsZV91cGxvYWQnKSB7CiAgICAvLyBDaGVjayB0byBzZWUgaWYgdGhlIGJvdHMgYmVpbmcgYWRkZWQgYXJlIGFydGlmYWN0IHNoYXJkcyB0aGF0IG5lZWRzIHRvIGJlIHJlY29uc3RpdHV0ZWQuCiAgICBjb25zdCBhcnRpZmFjdHNUb1JlY29uc3RpdHV0ZTogUmVjb3JkPHN0cmluZywgQUJBcnRpZmFjdFJlY29uc3RpdHV0ZUFyZz4gPSB7fTsgLy8gS2V5IGlzIGFydGlmYWN0IGluc3RhbmNlIGlkLgogICAgY29uc3QgZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlczogUmVjb3JkPHN0cmluZywgQm90W10+ID0gdGhpc0JvdC5hYkdldEFydGlmYWN0SW5zdGFuY2VzKCk7CiAgICBjb25zdCBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZTogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7IC8vIFRoaXMgc2V0IHRyYWNrcyBhcnRpZmFjdCBpZHMgdGhhdCBhcmUgYWxyZWFkeSBxdWV1ZWQgdG8gYmUgcmVjb25zdGl0dXRlZCB3aXRoIGEgbmV3IGluc3RhbmNlIGlkLgogICAgY29uc3Qgb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQ6IFNldDxzdHJpbmc+ID0gbmV3IFNldCgpOyAvLyBUcmFjayBvcmlnaW5hbCBpbnN0YW5jZSBJRHMgdGhhdCB3ZSd2ZSBhbHJlYWR5IGRlY2lkZWQgdG8gZ2l2ZSBuZXcgaW5zdGFuY2VzCgogICAgZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgICAgIGNvbnN0IGRhdGEgPSBib3REYXRhW2tleV07CgogICAgICAgIGlmIChkYXRhICYmCiAgICAgICAgICAgIGRhdGEudGFncy5hYkFydGlmYWN0TmFtZSAmJgogICAgICAgICAgICAhZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQgJiYKICAgICAgICAgICAgZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU/LnN0YXJ0c1dpdGgoJ/Cfp6wnKQogICAgICAgICkgewogICAgICAgICAgICBjb25zdCBhYkFydGlmYWN0SW5zdGFuY2VJRDogc3RyaW5nID0gZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEOwogICAgICAgICAgICBjb25zdCBhYkFydGlmYWN0QnVuZGxlOiBBQkFydGlmYWN0QnVuZGxlID0gSlNPTi5wYXJzZShkYXRhLnRhZ3MuYWJBcnRpZmFjdEJ1bmRsZS5zdWJzdHJpbmcoMikpOwoKICAgICAgICAgICAgaWYgKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgICAgICAgICAvLyBTaGFyZCBoYXMgYW4gYXJ0aWZhY3QgaW5zdGFuY2UgSUQKICAgICAgICAgICAgICAgIGlmIChleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSAmJiAhb3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMTogSW5zdGFuY2UgYWxyZWFkeSBleGlzdHMgLSBjcmVhdGUgbmV3IGluc3RhbmNlIChmaXJzdCB0aW1lIHdlIHNlZSB0aGlzIGNvbGxpc2lvbikKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdBcnRpZmFjdEluc3RhbmNlSUQgPSB1dWlkKCk7CiAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbbmV3QXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQ6IG5ld0FydGlmYWN0SW5zdGFuY2VJRAogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmFkZChhYkFydGlmYWN0QnVuZGxlLmlkKTsgLy8gVHJhY2sgdGhhdCB3ZSdyZSBjcmVhdGluZyBhIG5ldyBpbnN0YW5jZSBmb3IgdGhpcyBhcnRpZmFjdCBJRAogICAgICAgICAgICAgICAgICAgIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkLmFkZChhYkFydGlmYWN0SW5zdGFuY2VJRCk7IC8vIFRyYWNrIHRoYXQgd2UndmUgZGVjaWRlZCB0byByZXBsYWNlIHRoaXMgb3JpZ2luYWwgaW5zdGFuY2UgSUQKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDE6IFNoYXJkIGZyb20gZXhpc3RpbmcgaW5zdGFuY2UuIENyZWF0aW5nIG5ldyBpbnN0YW5jZS4gKG9sZDogJHthYkFydGlmYWN0SW5zdGFuY2VJRH0sIG5ldzogJHtuZXdBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3JpZ2luYWxJbnN0YW5jZUlEc0JlaW5nUmVwbGFjZWQuaGFzKGFiQXJ0aWZhY3RJbnN0YW5jZUlEKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgMWI6IFdlJ3ZlIGFscmVhZHkgZGVjaWRlZCB0byBjcmVhdGUgYSBuZXcgaW5zdGFuY2UgZm9yIHRoaXMgb3JpZ2luYWwgSUQgLSBhZGQgdGhpcyBzaGFyZCB0byB0aGF0IG5ldyBpbnN0YW5jZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAxYjogQWRkaXRpb25hbCBzaGFyZCBmb3IgcmVwbGFjZWQgaW5zdGFuY2UuIERpc3Bvc2luZy4gKG9yaWdpbmFsOiAke2FiQXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAyOiBJbnN0YW5jZSBhbHJlYWR5IHF1ZXVlZCBmb3IgcmVjb25zdGl0dXRpb24gLSBkaXNwb3NlIGR1cGxpY2F0ZQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSAyOiBEdXBsaWNhdGUgc2hhcmQgZm9yIHF1ZXVlZCBpbnN0YW5jZS4gRGlzcG9zaW5nLiAoYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSAzOiBJbnN0YW5jZSB0byByZWNvbnN0aXR1dGUgd2l0aCBleGlzdGluZyBJRAogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW2FiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZSwKICAgICAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEluc3RhbmNlSUQKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENhc2UgMzogSW5zdGFuY2UgdG8gcmVjb25zdGl0dXRlLiAoYWJBcnRpZmFjdEluc3RhbmNlSUQ6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFNoYXJkIGhhcyBubyBhcnRpZmFjdCBpbnN0YW5jZSBJRAogICAgICAgICAgICAgICAgaWYgKGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlLmhhcyhhYkFydGlmYWN0QnVuZGxlLmlkKSkgewogICAgICAgICAgICAgICAgICAgIC8vIENhc2UgNDogQXJ0aWZhY3QgYWxyZWFkeSBoYXMgbmV3IGluc3RhbmNlIHF1ZXVlZCAtIGRpc3Bvc2UgZHVwbGljYXRlCiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBDYXNlIDQ6IER1cGxpY2F0ZSBzaGFyZCBmb3IgYXJ0aWZhY3Qgd2l0aCBuZXcgaW5zdGFuY2UgcXVldWVkLiBEaXNwb3NpbmcuIChhcnRpZmFjdElkOiAke2FiQXJ0aWZhY3RCdW5kbGUuaWR9KWApOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ2FzZSA1OiBDcmVhdGUgbmV3IGluc3RhbmNlIGZvciBhcnRpZmFjdCB3aXRob3V0IGluc3RhbmNlIElECiAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3QXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwogICAgICAgICAgICAgICAgICAgIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlW25ld0FydGlmYWN0SW5zdGFuY2VJRF0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBuZXdBcnRpZmFjdEluc3RhbmNlSUQKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgICAgICBhcnRpZmFjdElEc1dpdGhOZXdJbnN0YW5jZS5hZGQoYWJBcnRpZmFjdEJ1bmRsZS5pZCk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gQ2FzZSA1OiBDcmVhdGluZyBuZXcgaW5zdGFuY2UgZm9yIGFydGlmYWN0IHdpdGhvdXQgaW5zdGFuY2UgSUQuIChuZXc6ICR7bmV3QXJ0aWZhY3RJbnN0YW5jZUlEfSlgKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBib3REYXRhW2tleV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBUaGlzIGlzIG5vdCBhIHNoYXJkIGJvdC4gSWdub3JlIGl0LgogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGU6YCwgYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGUpOwogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZXhpc3RpbmdBcnRpZmFjdEluc3RhbmNlczpgLCBleGlzdGluZ0FydGlmYWN0SW5zdGFuY2VzKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlOmAsIGFydGlmYWN0SURzV2l0aE5ld0luc3RhbmNlKTsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkOmAsIG9yaWdpbmFsSW5zdGFuY2VJRHNCZWluZ1JlcGxhY2VkKTsKICAgIH0KCiAgICBmb3IgKGNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEIGluIGFydGlmYWN0c1RvUmVjb25zdGl0dXRlKSB7CiAgICAgICAgY29uc3QgcmVjb25zdGl0dXRlQXJnOiBBQkFydGlmYWN0UmVjb25zdGl0dXRlQXJnID0gYXJ0aWZhY3RzVG9SZWNvbnN0aXR1dGVbYWJBcnRpZmFjdEluc3RhbmNlSURdOwogICAgICAgIAogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gUmVjb25zdGl0dXRpbmcgYXJ0aWZhY3QgaW5zdGFuY2U6ICR7YWJBcnRpZmFjdEluc3RhbmNlSUR9YCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGF3YWl0IHRoaXNCb3QuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZShyZWNvbnN0aXR1dGVBcmcpOwogICAgfQp9JwDhreaZDYOgBBtvbkFCUHJlcHJvY2Vzc0JlZm9yZVB1Ymxpc2gCBADhreaZDYz1BdgOQGlmICghY29uZmlnQm90LnRhZ3MucmVjb25zdGl0dXRpb24pIHsKICAgIGNvbnNvbGUud2FybihgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29uc3RpdHV0aW9uIGlzIGRpc2FibGVkYCk7CiAgICByZXR1cm47Cn0KCmNvbnN0IHsgYm90RGF0YSwgYWIsIHB1YmxpY0ZhY2luZywgc3R1ZGlvLCBzb3VyY2VFdmVudCB9ID0gdGhhdDsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRoYXQ6YCwgey4uLnRoYXR9KTsKfQoKLy8gRGV0ZWN0IGFydGlmYWN0IGluc3RhbmNlcyB0aGF0IG5lZWQgdG8gYmUgY29udmVydGVkIGludG8gYXJ0aWZhY3QgcHJvbWlzZXMuCgovKioga2V5OiBhcnRpZmFjdCBpbnN0YW5jZSBpZCwgdmFsdWU6IGFydGlmYWN0IHByb21pc2UgZGF0YS4gKi8KY29uc3QgYXJ0aWZhY3RJbnN0YW5jZXNXaXRoUHJvbWlzZSA9IG5ldyBTZXQoKTsgLy8gS2VlcCB0cmFjayBvZiB3aGF0IGFydGlmYWN0IGluc3RhbmNlIElEcyBoYXZlIGhhZCBhbiBhcnRpZmFjdCBwcm9taXNlIG1hZGUuCgpmb3IgKGNvbnN0IGtleSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBkYXRhID0gYm90RGF0YVtrZXldOwoKICAgIGlmIChkYXRhLnRhZ3MuYWJBcnRpZmFjdE5hbWUgJiYgZGF0YS50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gVGhpcyBpcyBhbiBhcnRpZmFjdCBpbnN0YW5jZSBzaGFyZCBib3QuCiAgICAgICAgaWYgKCFhcnRpZmFjdEluc3RhbmNlc1dpdGhQcm9taXNlLmhhcyhkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQpKSB7CiAgICAgICAgICAgIC8vIFRoaXMgYXJ0aWZhY3QgaW5zdGFuY2UgbmVlZHMgYW4gYXJ0aWZhY3QgcHJvbWlzZSBtYWRlIGZvciBpdC4KICAgICAgICAgICAgY29uc3QgcHJvbWlzZUlkID0gdXVpZCgpOwoKICAgICAgICAgICAgYm90RGF0YVtwcm9taXNlSWRdID0gewogICAgICAgICAgICAgICAgaWQ6IHByb21pc2VJZCwKICAgICAgICAgICAgICAgIHNwYWNlOiAnc2hhcmVkJywKICAgICAgICAgICAgICAgIHRhZ3M6IHsKICAgICAgICAgICAgICAgICAgICBhYkFydGlmYWN0TmFtZTogZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lLAogICAgICAgICAgICAgICAgICAgIGFiQXJ0aWZhY3RJbnN0YW5jZUlEOiBkYXRhLnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdEJ1bmRsZTogZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGUsCiAgICAgICAgICAgICAgICAgICAgYWJBcnRpZmFjdFByb21pc2U6IHRydWUsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIENvbnZlcnRlZCBhYkFydGlmYWN0SW5zdGFuY2VJRCAke2RhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRH0gaW50byBhbiBhcnRpZmFjdCBwcm9taXNlOmAsIGJvdERhdGFbcHJvbWlzZUlkXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGFydGlmYWN0SW5zdGFuY2VzV2l0aFByb21pc2UuYWRkKGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCk7CiAgICAgICAgfQoKICAgICAgICAvLyBSZW1vdmUgYXJ0aWZhY3QgaW5zdGFuY2Ugc2hhcmQgYm90IGZyb20gYm90RGF0YSB0aGF0IGlzIGFib3V0IHRvIGJlIHB1Ymxpc2hlZC4KICAgICAgICBkZWxldGUgYm90RGF0YVtrZXldOwogICAgfQp9CgppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBmaW5pc2hlZCBib3REYXRhOmAsIHsuLi5ib3REYXRhfSk7Cn0nAOGt5pkNg6AEFmFiR2V0QXJ0aWZhY3RJbnN0YW5jZXMCBADhreaZDeWDBsoHQGNvbnN0IHsgCiAgICBib3RzLAogICAgYWJBcnRpZmFjdE5hbWUsCn0gPSB0aGF0ID8/IHt9CgppZiAoYm90cykgewogICAgYXNzZXJ0KEFycmF5LmlzQXJyYXkoYm90cyksIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYm90cyBtdXN0IGJlIGFuIGFycmF5LmApOwp9Cgpjb25zdCBpbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHt9IC8vIEtleSBpcyBhcnRpZmFjdCBpbnN0YW5jZSBpZC4KCmZ1bmN0aW9uIHByb2Nlc3NCb3RBcnRpZmFjdEluc3RhbmNlKGJvdCkgewogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmIGJvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEKSB7CiAgICAgICAgLy8gT3B0aW9uYWw6IGZpbHRlciBieSBhYkFydGlmYWN0TmFtZS4KICAgICAgICBpZiAoYWJBcnRpZmFjdE5hbWUgJiYgYWJBcnRpZmFjdE5hbWUgIT09IGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGxldCBib3RBcnJheSA9IGluc3RhbmNlc1tib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRF07CgogICAgICAgIGlmICghYm90QXJyYXkpIHsKICAgICAgICAgICAgYm90QXJyYXkgPSBbXTsKICAgICAgICAgICAgaW5zdGFuY2VzW2JvdC50YWdzLmFiQXJ0aWZhY3RJbnN0YW5jZUlEXSA9IGJvdEFycmF5OwogICAgICAgIH0KCiAgICAgICAgYm90QXJyYXkucHVzaChib3QpOwogICAgfQp9CgppZiAoYm90cykgewogICAgLy8gR2V0IGFydGlmYWN0IGluc3RhbmNlcyBpbiBwcm92aWRlZCBsaXN0IG9mIGJvdHMuCiAgICBib3RzLmZvckVhY2goYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RJbnN0YW5jZShiKSk7Cn0gZWxzZSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgaW5zdGFuY2VzIGluIGluc3QuCiAgICBnZXRCb3RzKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0SW5zdGFuY2UoYikpOwp9CgpyZXR1cm4gaW5zdGFuY2VzOycA4a3mmQ2DoAQVYWJHZXRBcnRpZmFjdFBhdHRlcm5zAgQA4a3mmQ2wiwbzB0Bjb25zdCB7IAogICAgYm90cywKICAgIGFiQXJ0aWZhY3ROYW1lLAp9ID0gdGhhdCA/PyB7fQoKaWYgKGJvdHMpIHsKICAgIGFzc2VydChBcnJheS5pc0FycmF5KGJvdHMpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGJvdHMgbXVzdCBiZSBhbiBhcnJheS5gKTsKfQoKY29uc3QgcGF0dGVybnM6IFJlY29yZDxzdHJpbmcsIEJvdFtdPiA9IHt9IC8vIEtleSBpcyBhcnRpZmFjdCBuYW1lLgoKZnVuY3Rpb24gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihib3QpIHsKICAgIC8vIFBhdHRlcm4gYm90cyBoYXZlIGFiQXJ0aWZhY3ROYW1lIGJ1dCBubyBhYkFydGlmYWN0SW5zdGFuY2VJRAogICAgaWYgKGJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lICYmICFib3QudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRCkgewogICAgICAgIC8vIE9wdGlvbmFsOiBmaWx0ZXIgYnkgYWJBcnRpZmFjdE5hbWUuCiAgICAgICAgaWYgKGFiQXJ0aWZhY3ROYW1lICYmIGFiQXJ0aWZhY3ROYW1lICE9PSBib3QudGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBsZXQgYm90QXJyYXkgPSBwYXR0ZXJuc1tib3QudGFncy5hYkFydGlmYWN0TmFtZV07CgogICAgICAgIGlmICghYm90QXJyYXkpIHsKICAgICAgICAgICAgYm90QXJyYXkgPSBbXTsKICAgICAgICAgICAgcGF0dGVybnNbYm90LnRhZ3MuYWJBcnRpZmFjdE5hbWVdID0gYm90QXJyYXk7CiAgICAgICAgfQoKICAgICAgICBib3RBcnJheS5wdXNoKGJvdCk7CiAgICB9Cn0KCmlmIChib3RzKSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgcGF0dGVybnMgaW4gcHJvdmlkZWQgbGlzdCBvZiBib3RzLgogICAgYm90cy5mb3JFYWNoKGIgPT4gcHJvY2Vzc0JvdEFydGlmYWN0UGF0dGVybihiKSk7Cn0gZWxzZSB7CiAgICAvLyBHZXQgYXJ0aWZhY3QgcGF0dGVybnMgaW4gaW5zdC4KICAgIGdldEJvdHMoYiA9PiBwcm9jZXNzQm90QXJ0aWZhY3RQYXR0ZXJuKGIpKTsKfQoKcmV0dXJuIHBhdHRlcm5zOycA4a3mmQ2DoAQYYWJQdWJsaXNoQXJ0aWZhY3RQYXR0ZXJuAgQA4a3mmQ2kkwb6BUBjb25zdCB7CiAgICBhYkFydGlmYWN0TmFtZSwKICAgIHN0dWRpbywKICAgIHNoYXJkQm90cywKICAgIG1hbnVhbFB1Ymxpc2gsCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KHR5cGVvZiBhYkFydGlmYWN0TmFtZSA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYWJBcnRpZmFjdE5hbWUgaXMgYSByZXF1aXJlZCBzdHJpbmcgcGFyYW1ldGVyLmApOwphc3NlcnQodHlwZW9mIHN0dWRpbyA9PT0gJ3N0cmluZycsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gc3R1ZGlvIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKYXNzZXJ0KEFycmF5LmlzQXJyYXkoc2hhcmRCb3RzKSAmJiBzaGFyZEJvdHMubGVuZ3RoID4gMCwgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBzaGFyZEJvdHMgaXMgYSByZXF1aXJlZCBCb3QgYXJyYXkgcGFyYW1ldGVyLiBJdCBtdXN0IGhhdmUgYXQgbGVhc3QgMSBib3QuYCk7CgpyZXR1cm4gbGlua3Muc3RvcmUuYWJQdWJsaXNoQUIoewogICAgYWI6IGFiQXJ0aWZhY3ROYW1lLCAKICAgIHRhcmdldDogc2hhcmRCb3RzLCAKICAgIHN0dWRpbywKICAgIG1hbnVhbFB1Ymxpc2gsCiAgICBzb3VyY2VFdmVudDogJ3B1Ymxpc2hfYXJ0aWZhY3RfcGF0dGVybicsCiAgICBvblByZXByb2Nlc3NCZWZvcmVQdWJsaXNoOiAoYXJnKSA9PiB7CiAgICAgICAgdGhpc0JvdC5hYlN0cmlwQXJ0aWZhY3RJbnN0YW5jZURhdGFGcm9tQm90RGF0YShhcmcuYm90RGF0YSk7CiAgICB9Cn0pOycA4a3mmQ2DoAQmYWJTdHJpcEFydGlmYWN0SW5zdGFuY2VEYXRhRnJvbUJvdERhdGECBADhreaZDZ+ZBt0EQGNvbnN0IGJvdERhdGEgPSB0aGF0OwoKYXNzZXJ0KGxpbmtzLnV0aWxzLmlzT2JqZWN0KGJvdERhdGEpLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFyZ3VtZW50IG11c3QgYmUgYW4gb2JqZWN0LmApOwoKZm9yIChjb25zdCBrZXkgaW4gYm90RGF0YSkgewogICAgY29uc3QgZGF0YSA9IGJvdERhdGFba2V5XTsKICAgIAogICAgaWYgKGRhdGEudGFncy5hYkFydGlmYWN0Qm90ID09PSB0cnVlKSB7CiAgICAgICAgLy8gUmVtb3ZlIGFydGlmYWN0IGJvdHMuCiAgICAgICAgZGVsZXRlIGJvdERhdGFba2V5XTsKICAgICAgICAKICAgIH0gZWxzZSBpZiAoZGF0YS50YWdzLmFiQXJ0aWZhY3ROYW1lKSB7CiAgICAgICAgLy8gU3RyaXAgYXJ0aWZhY3QgaW5zdGFuY2UgZGF0YSBmcm9tIGJvdC4KICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RCdW5kbGU7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0SW5zdGFuY2VJRDsKICAgICAgICBkZWxldGUgZGF0YS50YWdzLmFiQXJ0aWZhY3RTaGFyZEluc3RhbmNlSUQ7CiAgICAgICAgZGVsZXRlIGRhdGEudGFncy5hYkFydGlmYWN0U2hhcmRSZWNvbnN0aXR1dGVkOwogICAgfQp9CiAgICAnAOGt5pkNg6AED2lzRWdnRGVwZW5kZW5jeQIEAOGt5pkN/Z0GUkByZXR1cm4gbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8uYWJJRCkgJiYgbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8ucmVjb3JkS2V5KTsnAOGt5pkNg6AED2lzQXNrRGVwZW5kZW5jeQIEAOGt5pkN0J4GKkByZXR1cm4gbGlua3MudXRpbHMuaXNTdHJpbmcodGhhdD8uYXNrSUQpOycBBGJvdHMkOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjAScA4a3mmQ37ngYOYWJGaWxlVGltZWNvZGUCBADhreaZDfyeBmZAY29uc3QgZGF0ZTogRGF0ZVRpbWUgPSB0aGF0Py5kYXRlID8/IERhdGVUaW1lLm5vdygpOwpyZXR1cm4gZGF0ZS50b1VUQygpLnRvRm9ybWF0KCd5eXl5TU1kZC1ISG1tc3MnKTsnAOGt5pkN+54GBnN5c3RlbQIEAOGt5pkN458GDmFiLnNoZWxsLnV0aWxzJwDhreaZDfueBgxhYkNvbXBpbGVDU1MCBADhreaZDfKfBoIEQGxldCBib3RzID0gdGhhdDsKCmJvdHMgPSBBcnJheS5pc0FycmF5KGJvdHMpID8gYm90cyA6IFtib3RzXTsKCmxldCBjc3MgPSBbXTsKCmZvciAobGV0IGJvdCBvZiBib3RzKSB7CiAgICBmb3IgKGxldCBrZXkgaW4gYm90LnRhZ3MpIHsKICAgICAgICBpZiAoa2V5LnRvTG93ZXJDYXNlKCkuZW5kc1dpdGgoJ2NzcycpKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGZvdW5kIENTUyBrZXk6ICR7a2V5fWApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNzcy5wdXNoKGJvdC50YWdzW2tleV0pOwogICAgICAgIH0KICAgIH0KfQoKY29uc3QgY29tcGlsZWQgPSBjc3Muam9pbignXG5cbicpOwppZiAodGFncy5kZWJ1ZykgewogICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBjb21waWxlZCBDU1M6XG5cbmAsIGNvbXBpbGVkKTsKfQoKcmV0dXJuIGNvbXBpbGVkOycA4a3mmQ37ngYIYWJJZ25vcmUCBADhreaZDfWjBgR0cnVlJwDhreaZDfueBgdhYlNoZWxsAgQA4a3mmQ36owYEdHJ1ZScA4a3mmQ37ngYJYWJWZXJzaW9uAgQA4a3mmQ3/owYEMTAuNScA4a3mmQ37ngYNYWJMb2dBbmRUb2FzdAIEAOGt5pkNhKQGswpAbGV0IG1lc3NhZ2U7CmxldCBkdXJhdGlvbjsKbGV0IGxvZ1R5cGUgPSAnbG9nJzsKbGV0IHRvYXN0ID0gdHJ1ZTsKCmlmICh0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZycpIHsKICAgIG1lc3NhZ2UgPSB0aGF0OwogICAgZHVyYXRpb24gPSB0aGlzQm90LmVzdGltYXRlUmVhZGluZ1RpbWUoeyB0ZXh0OiB0aGF0LCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwOwp9IGVsc2UgewogICAgbWVzc2FnZSA9IHRoYXQubWVzc2FnZTsKICAgIGR1cmF0aW9uID0gdGhhdC5kdXJhdGlvbiA/PyAodGhpc0JvdC5lc3RpbWF0ZVJlYWRpbmdUaW1lKHsgdGV4dDogdGhhdC5tZXNzYWdlLCBkZWxheVRpbWU6IDEwMDAgfSkgLyAxMDAwKTsKICAgIGxvZ1R5cGUgPSB0aGF0LmxvZ1R5cGUgPz8gbG9nVHlwZTsKICAgIHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0b2FzdDsKfQoKaWYgKGxvZ1R5cGUgPT09ICdsb2cnKSB7CiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ3dhcm5pbmcnIHx8IGxvZ1R5cGUgPT09ICd3YXJuJykgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6IFdhcm5pbmc6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUud2FybihhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBXYXJuaW5nOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICdlcnJvcicpIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiBFcnJvcjogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5lcnJvcihhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBFcnJvcjogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfScA4a3mmQ37ngYIcmVtZW1iZXICBADhreaZDbiuBijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwDhreaZDfueBgVhYkxvZwIEAOGt5pkN364GxwFAaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgIH0pOwp9JwDhreaZDfueBhNlc3RpbWF0ZVJlYWRpbmdUaW1lAgQA4a3mmQ2nsAbcA0Bjb25zdCB7CiAgICB0ZXh0ID0gJycsCiAgICB3b3Jkc1Blck1pbnV0ZSA9IDI1MCwKICAgIGRlbGF5VGltZSA9IDUwMCwKfSA9IHRoYXQ7CgovLyBDb3VudCB3b3JkcyAocm91Z2ggYXBwcm94aW1hdGlvbiBieSBzcGxpdHRpbmcgb24gd2hpdGVzcGFjZSkKY29uc3Qgd29yZENvdW50ID0gdGV4dC50cmltKCkuc3BsaXQoL1xzKy8pLmxlbmd0aDsKbGV0IHRvdGFsVGltZU1zID0gMDsKCmlmICh3b3JkQ291bnQgPiAwKSB7CiAgICAvLyBDYWxjdWxhdGUgcmVhZGluZyB0aW1lIGluIG1pbGxpc2Vjb25kcwogICAgY29uc3Qgd29yZHNQZXJTZWNvbmQgPSB3b3Jkc1Blck1pbnV0ZSAvIDYwOwogICAgY29uc3QgcmVhZGluZ1RpbWVNcyA9IE1hdGguY2VpbCgod29yZENvdW50IC8gd29yZHNQZXJTZWNvbmQpICogMTAwMCk7CgogICAgdG90YWxUaW1lTXMgPSByZWFkaW5nVGltZU1zICsgZGVsYXlUaW1lOwp9CgpyZXR1cm4gdG90YWxUaW1lTXM7JwDhreaZDfueBghpc09iamVjdAIEAOGt5pkNhLQGOUByZXR1cm4gdHlwZW9mIHRoYXQgPT09ICdvYmplY3QnICYmICFBcnJheS5pc0FycmF5KHRoYXQpOycA4a3mmQ37ngYHaXNBcnJheQIEAOGt5pkNvrQGHEByZXR1cm4gQXJyYXkuaXNBcnJheSh0aGF0KTsnAOGt5pkN+54GCGlzU3RyaW5nAgQA4a3mmQ3btAYhQHJldHVybiB0eXBlb2YgdGhhdCA9PT0gJ3N0cmluZyc7JwEEYm90cyRkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUBJwDhreaZDf20BgZzeXN0ZW0CBADhreaZDf60Bg9hYi5zaGVsbC5zZWFyY2gnAOGt5pkN/bQGBGZvcm0CBADhreaZDY61Bgdub3RoaW5nJwDhreaZDf20Bg5hYlJldHJpZXZlRmlsZQIEAOGt5pkNlrUGggFALy9wdWxsIGRvd24gZmlsZSBkYXRhCmlmICghdGhhdC51cmwpCnsKICAgIHJldHVybiAibm8gZmlsZSB1cmwgc3VwcGxpZWQiOwp9CgpsZXQgZGF0YSA9IGF3YWl0IG9zLmdldEZpbGUodGhhdC51cmwpOwoKcmV0dXJuIGRhdGE7JwDhreaZDf20BhBhYlJldHJpZXZlUmVjb3JkAgQA4a3mmQ2ZtgbsBEAvL3JldHJpZXZlIHNwZWNpZmllZCByZWNvcmQKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CgpsZXQgcmVjb3JkS2V5ID0gbGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleTsKCmlmICh0aGF0LnJlY29yZEtleSkKewogICAgcmVjb3JkS2V5ID0gdGhhdC5yZWNvcmRLZXk7Cn0KZWxzZSBpZiAoYXV0aEJvdCkKewogICAgaWYgKGF1dGhCb3QuaWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQogICAgewogICAgICAgIHJlY29yZEtleSA9IGF1dGhCb3QuaWQ7CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgfQp9CgpsZXQgcmVjb3JkRW5kcG9pbnQgPSB0aGF0LnJlY29yZEVuZHBvaW50ID8gdGhhdC5yZWNvcmRFbmRwb2ludCA6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludDsKCmlmICghcmVjb3JkTmFtZSkKewogICAgcmV0dXJuICJubyByZWNvcmQgbmFtZSBzdXBwbGllZCI7Cn0KCmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgcmVjb3JkTmFtZSwgcmVjb3JkRW5kcG9pbnQpOwoKLy9BREQgYWRkaXRpb25hbCBlcnJvciBoYW5kbGluZz8KCnJldHVybiBnZXRSZWNvcmQ7JwDhreaZDf20BghyZW1lbWJlcgIEAOGt5pkNhrsGKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAOGt5pkN/bQGDW1hbmlmZXN0YXRpb24CBADhreaZDa27Bijwn5SXZGNhNWQ5ODctYzRkOC00NmU0LWI2MGMtZGFhN2IyZjRkZGFkJwDhreaZDf20Bg5vbkxvb2t1cEFCRWdncwIEAOGt5pkN1LsGjjFAY29uc3QgeyAKICAgIGFiSUQsCiAgICBhYlZlcnNpb24sCiAgICBpbml0aWFsQm9vdCwKICAgIGF1dG9IYXRjaCwKICAgIHJldHVyblR5cGUsCiAgICBlZ2dQYXJhbWV0ZXJzLAogICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5LAogICAgdG9hc3QgPSB0cnVlLAogICAgc2hvd0luZGljYXRvciA9IHRydWUsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwgLy8gc291cmNlRXZlbnQgaXMgYW4gZXZlbnQgbmFtZSB0aGF0IHN5bWJvbGl6ZXMgd2hhdCB0cmlnZ2VyZWQgdGhpcyBjYWxsLiAob3B0aW9uYWwpCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgphYi5sb2cobGlua3MucGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGxvYWRpbmcgIiArIGFiSUQpOwoKLy9jbGVhciBhYi0xCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uICYmIGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgPT0gImFiTWVudSIpIHsKICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwp9CgpsZXQgYnVzeUluZGljYXRvcjsKCmlmIChzaG93SW5kaWNhdG9yKSB7CiAgICBpZiAoIWxpbmtzLm1lbnUpIHsKICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwogICAgfQoKICAgIGJ1c3lJbmRpY2F0b3IgPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgbG9hZGluZyAke2FiSUR9YH0pOwp9Cgpjb25zdCBwb3NzaWJsZUF1dGggPSBhdXRoQm90ID8gYXV0aEJvdCA6IHRydWU7CmxldCBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7CgpsZXQgZWdnRGF0YTsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYKICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5ICYmCiAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gInJlY29yZF9ub3RfZm91bmQiCiAgICApIHsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiKSB7CiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9sb2dnZWRfaW4iKSB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCiAgICAgICAgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiAKICAgICAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIgogICAgICAgICkgewogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHRvYXN0KSB7IAogICAgICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKICAgIH0KCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgIH0KCiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSB9Owp9CmVsc2UgewogICAgY29uc3QgcHVibGljUmVhZFRlc3QgPSBnZXRSZWNvcmQubWFya2Vycy5pbmRleE9mKCJwdWJsaWNSZWFkIik7CiAgICBjb25zdCBhdXRob3IgPSBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdEluQmFja2dyb3VuZCgpOwoKICAgIGlmIChwdWJsaWNSZWFkVGVzdCAhPSAtMSAmJiBhdXRob3IpIHsKICAgICAgICBpZiAoYXV0aEJvdC50YWdzLnByaXZhY3lGZWF0dXJlcy5hbGxvd1B1YmxpY0RhdGEpIHsKICAgICAgICAgICAgY29uc3QgZWdnSGF0Y2hFdmVudCA9IGFiSUQ7CgogICAgICAgICAgICBvcy5yZWNvcmRFdmVudChsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBlZ2dIYXRjaEV2ZW50KTsKICAgICAgICB9CiAgICB9CgogICAgLy9wYWNrYWdlIHRoZSByZWNvcmQgZGF0YQogICAgZWdnRGF0YSA9IGdldFJlY29yZC5kYXRhOwoKICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAvLyBDaGFuZ2UgaW5pdGlhbCB0YXJnZXQgdmVyc2lvbiBvZiB0aGUgZWdnIGlmIGFiVmVyc2lvbiBpcyBwcm92aWRlZC4KICAgICAgICBlZ2dEYXRhLnRhcmdldFZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9Cn0KCmxpbmtzLnV0aWxzLmFiTG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBhYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCmlmIChyZXR1cm5UeXBlICE9IG51bGwpIHsKICAgIGlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICAgICAgICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYWJWZXJzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSBhYlZlcnNpb24gLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlZ2dEYXRhVVJMID0gZ2V0UmVjb3JkLmRhdGEuZWdnVmVyc2lvbkhpc3RvcnlbdmVyc2lvbl07CiAgICAgICAgICAgIGNvbnN0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiByZXR1cm5EYXRhOwogICAgICAgIH0gZWxzZSBpZiAocmV0dXJuVHlwZSA9PT0gImVnZyIpIHsKICAgICAgICAgICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNpbXBseSByZXR1cm4gdGhlIGVnZyBkYXRhIGlmIHJlcXVlc3RlZC4KICAgICAgICAgICAgcmV0dXJuIGdldFJlY29yZC5kYXRhOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgLy8gVGhpcyBpcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBvbGQgYXV4IGZpbGVzIHN0b3JlZCBiZWZvcmUgdGhlIHJlY29yZCBzeXN0ZW0gZXhpc3RlZC4KICAgICAgICBpZiAocmV0dXJuVHlwZSA9PT0gImRhdGEiKSB7CiAgICAgICAgICAgIGNvbnN0IHZlcnNpb25BcnJheSA9IEpTT04ucGFyc2UoZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeSk7CiAgICAgICAgICAgIGNvbnN0IGZpbGVVVUlEID0gdmVyc2lvbkFycmF5W2VnZ0RhdGEubWF4VmVyc2lvbiAtIDFdOwogICAgICAgICAgICBjb25zdCBmaWxlbmFtZWhhc2hMVE0gPSBjcnlwdG8uc2hhMjU2KGZpbGVVVUlEKTsKICAgICAgICAgICAgY29uc3QgZmlsZXVybGhhc2hMVE0gPSAiYXV4XyIgKyBmaWxlbmFtZWhhc2hMVE0gKyAnLmF1eCc7CiAgICAgICAgICAgIGNvbnN0IHRhcmdldExUTVVSTCA9ICJodHRwczovL2J1aWxkZXItbHRtLWZpbGVzLnMzLmFtYXpvbmF3cy5jb20vIiArIGZpbGV1cmxoYXNoTFRNOwogICAgICAgICAgICBjb25zdCBvID0gewogICAgICAgICAgICAgICAgbWV0aG9kOiAiR0VUIiwKICAgICAgICAgICAgICAgIHVybDogdGFyZ2V0TFRNVVJMCiAgICAgICAgICAgIH07CgogICAgICAgICAgICBsZXQgZmlsZUdldCA9IGF3YWl0IHdlYmhvb2sobyk7CgogICAgICAgICAgICBpZiAoYnVzeUluZGljYXRvcikgewogICAgICAgICAgICAgICAgZGVzdHJveShidXN5SW5kaWNhdG9yKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGZpbGVHZXQuc3RhdHVzICE9IDIwMCkgewogICAgICAgICAgICAgICAgaWYgKHRvYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgb3MudG9hc3QoIm5vIGZpbGUgZm91bmQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CgogICAgICAgICAgICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGZpbGVHZXQgPSBmaWxlR2V0LmRhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBmaWxlR2V0OwogICAgICAgIH0KICAgIH0KfQoKLy9hYiBzcGVjaWZpYyB2YXJpYWJsZXMgZm9yIHVuZGVyc3RhbmRpbmcgaWYgYSBwb3NpdGlvbiBpcyBzcGVjaWZpZWQKbGV0IGN1cnJlbnREaW07CmxldCBzcGFjZU1vZDsKbGV0IGRpbWVuc2lvblg7CmxldCBkaW1lbnNpb25ZOwpsZXQgZGltTW9kOwoKLy9oYW5kbGUgZGltZW5zaW9uIGlkZW50aWZpY2F0aW9uCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGNvbnN0IGFiQm90ID0gbGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdDsKCiAgICAgICAgY3VycmVudERpbSA9IGFiQm90LnRhZ3MuZGltZW5zaW9uOwogICAgfQp9CmVsc2UgewogICAgY3VycmVudERpbSA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKLy9jaGVja3MgZm9yIGdyaWQgZm9jdXMKaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzKSB7CiAgICBkaW1lbnNpb25YID0gbnVsbDsKICAgIGRpbWVuc2lvblkgPSBudWxsOwp9CmVsc2UgewogICAgbGV0IGhhdGNoUG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKICAgIGN1cnJlbnREaW0gPSBoYXRjaFBvaW50LmRpbWVuc2lvbjsKICAgIGRpbWVuc2lvblggPSBoYXRjaFBvaW50LnBvc2l0aW9uLng7CiAgICBkaW1lbnNpb25ZID0gaGF0Y2hQb2ludC5wb3NpdGlvbi55OwogICAgc3BhY2VNb2QgPSB7IHNwYWNlOiAic2hhcmVkIiB9Owp9CgovL3RoaXMgbG9naWMgaGFuZGxlcyBsb2dpYyBhcm91bmQgYXV0b0hhdGNoIHZzIG1hbnVhbCBoYXRjaGluZwppZiAoIWF1dG9IYXRjaCAmJiBjb25maWdCb3QudGFncy5wYXR0ZXJuID09IG51bGwpIHsKICAgIGRpbU1vZCA9IHsKICAgICAgICBbY3VycmVudERpbV06IHRydWUsCiAgICAgICAgW2N1cnJlbnREaW0gKyAiWCJdOiBkaW1lbnNpb25YLAogICAgICAgIFtjdXJyZW50RGltICsgIlkiXTogZGltZW5zaW9uWSwKICAgICAgICBkaW1lbnNpb246IGN1cnJlbnREaW0KICAgIH07Cn0KZWxzZSB7CiAgICBkaW1Nb2QgPSB7IGF1dG9IYXRjaDogdHJ1ZSwga2V5IH07Cn0KCi8vY2FsbCBmb3Igb3ZvIHdpdGggaW5mb3JtYXRpb24gcHJvdmlkZWQKY29uc3QgbWFuaWZlc3RSZXN1bHQgPSBhd2FpdCB0aGlzQm90Lm1hbmlmZXN0T3ZvKHsKICAgIGFiSUQsCiAgICBzdHVkaW86IHJlY29yZEtleSwKICAgIGRpbU1vZCwKICAgIHNwYWNlTW9kLAogICAgZWdnRGF0YSwKICAgIGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwKICAgIHNvdXJjZUV2ZW50LAp9KTsKCmlmIChidXN5SW5kaWNhdG9yKSB7CiAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwp9CgpyZXR1cm4gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIGhhdGNoZWRCb3RzOiBtYW5pZmVzdFJlc3VsdD8uaGF0Y2hlZEJvdHMsCn07JwDhreaZDf20BgttYW5pZmVzdE92bwIEAOGt5pkN4+wGtQ9AY29uc3QgeyAKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIHNwYWNlTW9kLAogICAgZGltTW9kLAogICAgZWdnRGF0YSwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsCiAgICBzb3VyY2VFdmVudCwKfSA9IHRoYXQ7CgovL2VnZyB2aXN1YWxpemF0aW9uCnNob3V0KCJhYk1lbnVSZXNldCIpOwoKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24pIHsKICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KTsKICAgIH0KfQoKaWYgKGxpbmtzLm92b0JvdCkgewogICAgZGVzdHJveShsaW5rcy5vdm9Cb3QpOwp9CgpsZXQgZWdnTW9kID0gewogICAgc3BhY2U6ICJ0ZW1wTG9jYWwiLAogICAgaW5pdGlhbFRpbWVyOiB0cnVlLAogICAgYWJJRCwKICAgIHN0dWRpbywKICAgIGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVycywKICAgIHNvdXJjZUV2ZW50LAogICAgY3Vyc29yOiAncG9pbnRlcicsCiAgICBtYW5hZ2VyOiBnZXRMaW5rKHRoaXNCb3QpLAogICAgb25DbGljazogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLmludGVyYWN0T3ZvKCk7CiAgICBgLAogICAgZm9ybTogImVnZyIsCiAgICBjb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlTGFiZWxDb2xvciwKICAgIHByb2dyZXNzQmFyQ29sb3I6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3IsCiAgICBwcm9ncmVzc0JhckJhY2tncm91bmRDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC41LAogICAgb25Qb2ludGVyRW50ZXI6IGBACiAgICAgICAgbWFza3MudGlwSWQgPSBhd2FpdCBvcy50aXAodGFncy5hYklEICsgJyB2JyArIHRhZ3MudGFyZ2V0VmVyc2lvbik7CiAgICBgLAogICAgb25Qb2ludGVyRXhpdDogYEAKICAgICAgICBpZiAobWFza3MudGlwSWQpIHsKICAgICAgICAgICAgb3MuaGlkZVRpcHMobWFza3MudGlwSWQpOwogICAgICAgIH0KICAgIGAsCiAgICBsYWJlbFBvc2l0aW9uOiAiZnJvbnQiLAogICAgb3JpZW50YXRpb25Nb2RlOiAiYmlsbGJvYXJkRnJvbnQiLAogICAgb25EZXN0cm95OiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3Mub3ZvQm90ID0gbnVsbDsKICAgIGAsCiAgICBlZ2dUaW1lcjogYEAKICAgICAgICBpZiAodGFncy5wcm9ncmVzc0JhciA8IDEpIHsKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciArPSAwLjE7CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90Lm9uQ2xpY2soKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgPSBudWxsOwogICAgICAgIH0KICAgIGAKfTsKCgpjb25zdCBvdm8gPSBhd2FpdCBjcmVhdGUoZWdnRGF0YSwgZWdnTW9kLCBkaW1Nb2QsIHNwYWNlTW9kKTsKbWFza3Mub3ZvQm90ID0gZ2V0TGluayhvdm8pOwoKaWYgKG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSkgewogICAgb3ZvLnZhcnMub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlID0gb25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlOwp9CgppZiAob3ZvLnRhZ3MuYXV0b0hhdGNoKSB7CiAgICBjb25zdCBoYXRjaGVkQm90cyA9IGF3YWl0IHRoaXNCb3QuaGF0Y2hPdm8ob3ZvKTsKICAgIHJldHVybiB7IGhhdGNoZWRCb3RzIH07Cn0KZWxzZSB7CiAgICBvdm8udGFncy5wcm9ncmVzc0JhciA9IDA7CiAgICBjb25maWdCb3QudGFncy52ZXJzaW9uID0gb3ZvLnRhZ3MubWF4VmVyc2lvbjsKICAgIHNldFRpbWVvdXQoKCkgPT4geyB3aGlzcGVyKG92bywgImVnZ1RpbWVyIik7IH0sIDc1KTsKfScA4a3mmQ39tAYJb25LZXlEb3duAgQA4a3mmQ2Z/AaCBkAvL2hpZGRlbiB2ZXJzaW9uIGJ1dHRvbiBmb3IgaGF0Y2ggbWVudQppZiAoIWxpbmtzLm92b0JvdCB8fCBjb25maWdCb3QudGFncy5tZW51UG9ydGFsICE9ICJhYk92b01lbnUiKQp7CiAgICByZXR1cm47Cn0KCmlmICh0aGF0LmtleXMgPT0gIlNoaWZ0IikKewogICAgbGV0IHZlcnNpb25CdXR0b24gPSB7fTsKCiAgICB2ZXJzaW9uQnV0dG9uLmFiT3ZvTWVudSA9IHRydWU7CiAgICB2ZXJzaW9uQnV0dG9uLm92b1NvcnRPcmRlciA9IC0xOwogICAgdmVyc2lvbkJ1dHRvbi5tYXhWZXJzaW9uID0gbGlua3Mub3ZvQm90LnRhZ3MubWF4VmVyc2lvbjsKICAgIHZlcnNpb25CdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7CiAgICB2ZXJzaW9uQnV0dG9uLmxhYmVsID0gImNoYW5nZSBlZ2cgdmVyc2lvbiI7CiAgICB2ZXJzaW9uQnV0dG9uLmxhYmVsQWxpZ25tZW50ID0gImNlbnRlciI7CiAgICB2ZXJzaW9uQnV0dG9uLm92b01lbnVSZXNldCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKICAgIHZlcnNpb25CdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yOwogICAgdmVyc2lvbkJ1dHRvbi5vbktleVVwID0gIkAgaWYodGhhdC5rZXlzID09ICdTaGlmdCcpe2Rlc3Ryb3kodGhpc0JvdCl9OyI7CiAgICB2ZXJzaW9uQnV0dG9uLm9uQ2xpY2sgPSAiQCBsaW5rcy5tYW5hZ2VyLmNoYW5nZU92b1ZlcnNpb24oKTsiOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHZlcnNpb25CdXR0b24pOwp9JwDhreaZDf20BghoYXRjaE92bwIEAOGt5pkNmoIHnRVALy9sb2dpYyBmb3IgaGF0Y2hpbmcgb2YgYW4gYWIKc2hvdXQoJ292b01lbnVSZXNldCcpOwoKLy9kYXRhIGluIHJlZ2FyZHMgdG8gd2hhdCBhYiBpcyBnb2luZyB0byBiZSBoYXRjaGVkCmNvbnN0IG92byA9IHRoYXQ7CgovL2hhdGNoIHNwZWNpZmljIHZhcmlhYmxlcwpsZXQgaW5pdGlhbEJvb3QgPSBvdm8udGFncy5pbml0aWFsQm9vdDsKbGV0IHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5zdGFibGVWZXJzaW9uID8/IG92by50YWdzLnRhcmdldFZlcnNpb247CgppZiAoKGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbiB8fCBjb25maWdCb3QudGFncy5wYXR0ZXJuVmVyc2lvbikgJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmFiVmVyc2lvbiA/PyBjb25maWdCb3QudGFncy5wYXR0ZXJuVmVyc2lvbjsKfQoKLy90YXJnZXRlZCB2ZXJzaW9ucwppZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIgfHwgIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKSkKewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImZlZWRiYWNrIikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uOwogICAgfQogICAgZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiY3VycmVudCIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKICAgIH0KICAgIGVsc2UgaWYgKCFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MudmVyc2lvbgogICAgfQoKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBudWxsOwp9CgppZiAoaXNOYU4odGFyZ2V0VmVyc2lvbikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7Cn0KCmxldCB2ZXJzaW9uQXJyYXkgPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeTsKbGV0IGZpbGVVUkwgPSB2ZXJzaW9uQXJyYXlbdGFyZ2V0VmVyc2lvbiAtIDFdOwpsZXQga2V5ID0gb3ZvLnRhZ3Mua2V5ID8gb3ZvLnRhZ3Mua2V5IDogY29uZmlnQm90LnRhZ3Mua2V5OwpsZXQgZmlsZUdldDsKCi8vYWN0dWFsIGZpbGUgcmV0cmlldmFsCnRyeQp7CiAgICBmaWxlR2V0ID0gYXdhaXQgb3MuZ2V0RmlsZShmaWxlVVJMKTsKfQpjYXRjaCAoZSkKewogICAgY29uc29sZS5lcnJvcihlKTsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJ25vIGZpbGUgZm91bmQnKTsKCiAgICByZXR1cm47Cn0KCi8vaGFuZGxpbmcgZm9yIGVuY3J5cHRlZCBhYiBmaWxlCmlmIChjcnlwdG8uaXNFbmNyeXB0ZWQoZmlsZUdldCkpCnsKICAgIGlmICgha2V5KQogICAgewogICAgICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgnJywgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdFbnRlciBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgZmlsZUdldCA9IGNyeXB0by5kZWNyeXB0KGtleSwgZmlsZUdldCk7CgogICAgaWYgKGZpbGVHZXQgPT0gbnVsbCkgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJ2luY29ycmVjdCBrZXknKTsKICAgICAgICByZXR1cm47CiAgICB9CiAgIAogICAgZmlsZUdldCA9IEpTT04ucGFyc2UoZmlsZUdldCk7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQplbHNlCnsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CgovL2NsZWFuIHVwCmRlc3Ryb3kob3ZvKTsKCi8vdG9hc3QgaWYgbm90IG9uIHN0YWJsZQppZihvdm8udGFncy5zdGFibGVWZXJzaW9uICE9IHRhcmdldFZlcnNpb24gJiYgIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50KQp7CiAgICBpZiAob3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uID09IHRhcmdldFZlcnNpb24pCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWQgZmVlZGJhY2sgdmVyc2lvbiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWQgdmVyc2lvbiAiICsgdGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCArICIgb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQp9CgovL2dlbmVyYXRlIGJvdHMgYmFzZWQgb24gdGhlIGZpbGUgcmV0cmlldmVkICpIRVJFKgpjb25zdCBuZXdCb3RzID0gYXdhaXQgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7CiAgICBib3RzOiBmaWxlR2V0LAogICAgb3JpZ2luOiBvdm8udGFncy5hYklELAogICAgc3R1ZGlvOiBvdm8udGFncy5zdHVkaW8sCiAgICB2ZXJzaW9uOiB0YXJnZXRWZXJzaW9uLAogICAgaW5pdGlhbEJvb3Q6IGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVyczogb3ZvLnRhZ3MuZWdnUGFyYW1ldGVycywKICAgIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTogb3ZvLnZhcnMub25QcmVwcm9jZXNzQmVmb3JlQ3JlYXRlLAogICAgc291cmNlRXZlbnQ6IG92by50YWdzLnNvdXJjZUV2ZW50LAp9KTsKCnJldHVybiBuZXdCb3RzOycA4a3mmQ39tAYLaW50ZXJhY3RPdm8CBADhreaZDbiXB+kGQC8vbWFudWFsIGhhdGNoIG1lbnUKY29uc3Qgb3ZvQm90ID0gdGhhdCA/IHRoYXQgOiBsaW5rcy5vdm9Cb3Q7CgppZiAoIW92b0JvdCkgewogICAgcmV0dXJuOwp9CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk92b01lbnUiOwoKbWFza3Mub25HcmlkQ2xpY2sgPSBgQAogICAgc2hvdXQoIm92b01lbnVSZXNldCIpOwpgOwptYXNrcy5vdm9NZW51UmVzZXQgPSBgQAogICAgbWFza3Mub25HcmlkQ2xpY2sgPSBudWxsOwogICAgbWFza3Mub3ZvTWVudVJlc2V0ID0gbnVsbDsKCiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7Cgpvcy50d2VlblRvKG92b0JvdCwgMTUsNDUsNDUsIDUpOwoKY29uc3QgZWdnTWVudUJ1dHRvbiA9IHsKICAgIGFiT3ZvTWVudTogdHJ1ZSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvdm9Cb3Q6IGdldExpbmsob3ZvQm90KSwKICAgIGNvbG9yOiBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICB0YXJnZXRWZXJzaW9uOiBvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uLAogICAgbGFiZWw6IGBoYXRjaCAke292b0JvdC50YWdzLmFiSUR9IHYke292b0JvdC50YWdzLnRhcmdldFZlcnNpb259IG9mICR7b3ZvQm90LnRhZ3MubWF4VmVyc2lvbn1gLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgb3ZvTWVudVJlc2V0OiBgQAogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICBgLAogICAgb25DbGljazogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLmhhdGNoT3ZvKGxpbmtzLm92b0JvdCk7CiAgICBgLAp9OwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oZWdnTWVudUJ1dHRvbik7JwDhreaZDf20BgZjcmVhdGUCBADhreaZDaKeByjwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwDhreaZDf20BhBjaGFuZ2VPdm9WZXJzaW9uAgQA4a3mmQ3JngfwAkAvL2xvZ2ljIGZvciB2ZXJzaW9uIGNoYW5naW5nIHdoZW4gbWFudWFsbHkgaGF0Y2hpbmcgYW4gYWIKY29uc3Qgb3ZvQm90ID0gbGlua3Mub3ZvQm90OwoKbGV0IG5ld1ZlcnNpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQob3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwgewogICAgcGxhY2Vob2xkZXI6ICJlbnRlciBhIHZlcnNpb24gZnJvbSAxIHRvICIgKyBvdm9Cb3QudGFncy5tYXhWZXJzaW9uCn0pOwoKb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiA9IG5ld1ZlcnNpb247Cm92b0JvdC50YWdzLmxhYmVsID0gJ3YnKyBuZXdWZXJzaW9uOwoKY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG5ld1ZlcnNpb247CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7JwDhreaZDf20BgRtZW51AgQA4a3mmQ26oQco8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA4a3mmQ39tAYIYWJJZ25vcmUCBADhreaZDeGhBwR0cnVlJwDhreaZDf20BgdhYlNoZWxsAgQA4a3mmQ3moQcEdHJ1ZScA4a3mmQ39tAYMYWIxTFRNU2VhcmNoAgQA4a3mmQ3roQczQC8vc3VwcG9ydCBvbGQgc3ludGF4CnRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7JwDhreaZDf20Bg1vbkxvb2t1cEFza0lEAgQA4a3mmQ2fogfAHUBjb25zdCBhc2tJRCA9IHRoYXQ/LmFza0lEOwpjb25zdCBzaG93SW5kaWNhdG9yID0gdGhhdD8uc2hvd0luZGljYXRvciA/PyB0cnVlOwpjb25zdCBjaGFubmVsQ29uZmlnID0gdGhhdD8uY2hhbm5lbENvbmZpZzsKY29uc3QgYXV0b0hhdGNoID0gdGhhdD8uYXV0b0hhdGNoID8/IHRydWU7CmNvbnN0IHNvdXJjZUV2ZW50ID0gdGhhdD8uc291cmNlRXZlbnQ7CmNvbnN0IG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSA9IHRoYXQ/Lm9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZTsKCmFzc2VydCh0eXBlb2YgYXNrSUQgPT09ICdzdHJpbmcnLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFza0lEIGlzIGEgcmVxdWlyZWQgc3RyaW5nIHBhcmFtZXRlci5gKTsKCmxldCBsb29rdXBBc2s6IEFCTG9va3VwQXNrSURSZXN1bHQ7CmxldCBidXN5SW5kaWNhdG9yOwoKaWYgKHNob3dJbmRpY2F0b3IpIHsKICAgIGlmICghbGlua3MubWVudSkgewogICAgICAgIGF3YWl0IGxpbmtzLmxlYXJuLmFiQWRhcHQoJ2FiSW50ZXJmYWNlJyk7CiAgICB9CgogICAgYnVzeUluZGljYXRvciA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnVzeUluZGljYXRvcih7IGFiTWVudTogdHJ1ZSwgbGFiZWw6IGBsb29raW5nIHVwICR7YXNrSUR9YCB9KTsKfQoKLy8gRmlyc3QgY2hlY2sgdGhlIGNhc3VhbCBjYXRhbG9nIGZvciB0aGUgYXNrLgpjb25zdCBjYXN1YWxDYXRhbG9nVVJMID0gbGlua3MubGVhcm4uYWJCdWlsZENhc3VhbENhdGFsb2dVUkwoYC9hc2tzLyR7YXNrSUR9LmF1eGApOwoKdHJ5IHsKICAgIGNvbnN0IGNhc3VhbENhdGFsb2dSZXNwb25zZSA9IGF3YWl0IHdlYi5ob29rKHsgbWV0aG9kOiAnR0VUJywgdXJsOiBjYXN1YWxDYXRhbG9nVVJMIH0pOwoKICAgIGlmIChjYXN1YWxDYXRhbG9nUmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICBpZiAoY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudmVyc2lvbiA9PT0gMSAmJiBjYXN1YWxDYXRhbG9nUmVzcG9uc2UuZGF0YS5zdGF0ZSkgewogICAgICAgICAgICAvLyBDYXN1YWwgY2F0YWxvZyByZXNwb25zZSBpcyBhIHYxIGF1eCBmaWxlLgogICAgICAgICAgICBjb25zdCBuZXdCb3RzID0gYXdhaXQgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdHM6IGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnN0YXRlLCBpZ25vcmVHcmlkRm9jdXM6IHRydWUsIG9uUHJlcHJvY2Vzc0JlZm9yZUNyZWF0ZSwgc291cmNlRXZlbnQgfSk7CgogICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLAogICAgICAgICAgICAgICAgb3JpZ2luOiAnY2FzdWFsX2NhdGFsb2cnLAogICAgICAgICAgICAgICAgaGF0Y2hlZEJvdHM6IG5ld0JvdHMsCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGNhc3VhbENhdGFsb2dSZXNwb25zZS5kYXRhLnZlcnNpb24gPT09IDIgJiYgY2FzdWFsQ2F0YWxvZ1Jlc3BvbnNlLmRhdGEudXBkYXRlcykgewogICAgICAgICAgICAvLyBDYXN1YWwgY2F0YWxvZyByZXNwb25zZSBpcyBhIHYyIGF1eCBmaWxlLgogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFza3Mgb25seSBzdXBwb3J0IHYxIGF1eCBmaWxlIGZvcm1hdC5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CgogICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIHJlc3BvbnNlLgogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVW5yZWNvZ25pemVkIGNhc3VhbCBjYXRhbG9nIGFzayByZXNwb25zZS5gLCBjYXN1YWxDYXRhbG9nUmVzcG9uc2UpOwogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYFVucmVjb2duaXplZCBjYXN1YWwgY2F0YWxvZyBhc2sgcmVzcG9uc2UuIENoZWNrIGNvbnNvbGUgZm9yIG1vcmUgZGV0YWlscy5gLCBsb2dUeXBlOiAnZXJyb3InfSk7CgogICAgICAgICAgICBsb29rdXBBc2sgPSB7CiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSwKICAgICAgICAgICAgICAgIG9yaWdpbjogJ2Nhc3VhbF9jYXRhbG9nJwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIChidXN5SW5kaWNhdG9yKSB7CiAgICAgICAgICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbG9va3VwQXNrOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICAvLyBEaWQgbm90IGZpbmQgaW4gdGhlIGNhc3VhbCBjYXRhbG9nLgp9CgovLyBDaGVjayB0aGUgYWIgcmVjb3JkIGZvciB0aGUgYXNrLgpjb25zdCBhYkZvcm1hdHRlZEFza0lEID0gYXNrSUQucmVwbGFjZUFsbCgiLSIsICIiKTsKCnRyeSB7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGBhc2tfJHthYkZvcm1hdHRlZEFza0lEfWAsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJFbmRwb2ludCk7Cn0gY2F0Y2ggewogICAgbG9va3VwQXNrID0gYXdhaXQgb3MuZ2V0RGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhYkZvcm1hdHRlZEFza0lELCBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQpOwp9Cgpsb29rdXBBc2sub3JpZ2luID0gJ2FiX3JlY29yZCc7CgppZiAoY2hhbm5lbENvbmZpZykgewogICAgaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgICAgICBkZXN0cm95KGJ1c3lJbmRpY2F0b3IpOwogICAgfQoKICAgIHJldHVybiBsb29rdXBBc2s7Cn0gZWxzZSBpZiAobG9va3VwQXNrLnN1Y2Nlc3MgJiYgbG9va3VwQXNrLmRhdGEucGF0dGVybklEKSB7CiAgICBpZiAobG9va3VwQXNrLmRhdGEuc3R1ZGlvSUQgPT0gIkFCIikgewogICAgICAgIC8vIFJ5YW4gQ29vazogVGhpcyBhcHBlYXJzIHRvIGJlIHNvbWV0aGluZyBuZWVkZWQgYnkgYWJDaGFubmVscy4KICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCk7CgogICAgICAgIHNob3V0KCJvbkFCSW5pdGlhbGl6ZWQiKTsKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gTG9va3VwIHRoZSBlZ2cgdXNpbmcgdGhlIHN0dWRpb0lEIGFuZCBwYXR0ZXJuSUQgZnJvbSB0aGUgYWJfcmVjb3JkIGFzay4KICAgICAgICBjb25zdCBsb29rdXBFZ2c6IEFCTG9va3VwRWdnUmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh7IGFiSUQ6IGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCwgcmVjb3JkS2V5OiBsb29rdXBBc2suZGF0YS5zdHVkaW9JRCwgYXV0b0hhdGNoLCBvblByZXByb2Nlc3NCZWZvcmVDcmVhdGUsIHNvdXJjZUV2ZW50IH0pOwogICAgICAgIAogICAgICAgIGxvb2t1cEFzay5zdWNjZXNzID0gbG9va3VwRWdnLnN1Y2Nlc3M7CiAgICAgICAgbG9va3VwQXNrLmhhdGNoZWRCb3RzID0gbG9va3VwRWdnLmhhdGNoZWRCb3RzOwogICAgfQp9IGVsc2UgaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmICFsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQgJiYgIWxvb2t1cEFzay5kYXRhLnVybCkgewogICAgbG9va3VwQXNrLnN1Y2Nlc3MgPSBmYWxzZTsKfQoKaWYgKGJ1c3lJbmRpY2F0b3IpIHsKICAgIGRlc3Ryb3koYnVzeUluZGljYXRvcik7Cn0KCnJldHVybiBsb29rdXBBc2s7JwDhreaZDf20BgV0eXBlcwIEAOGt5pkN4L8H9gHwn5OEdHlwZSBBQkFza0lET3JpZ2luID0gJ2Nhc3VhbF9jYXRhbG9nJyB8ICdhYl9yZWNvcmQnOwoKaW50ZXJmYWNlIEFCTG9va3VwQXNrSURSZXN1bHQgewogICAgc3VjY2VzczogYm9vbGVhbjsKICAgIG9yaWdpbjogQUJBc2tJRE9yaWdpbjsKICAgIGhhdGNoZWRCb3RzPzogQm90W107Cn0KCmludGVyZmFjZSBBQkxvb2t1cEVnZ1Jlc3VsdCB7CiAgICBzdWNjZXNzOiBib29sZWFuLAogICAgaGF0Y2hlZEJvdHM/OiBCb3RbXSwKfQonAOGt5pkN/bQGBWlucHV0AgQA4a3mmQ3VwQco8J+Ul2Y4NjAyODc4LWMyZWYtNDhiZC04NWEwLThkNjM1MWViNDEyMCcA4a3mmQ39tAYFaGF0Y2gCBADhreaZDfzBB8ABQC8vc2hvdXQoImhhdGNoIiwge2FiSUQ6IGFiSUQsIHJlY29yZEtleTogc3R1ZGlvLCBrZXk6IGtleSwgYXV0b0hhdGNoOiBib29sZWFuLCByZXR1cm5UeXBlOiBkYXRhL251bGwsIGVnZ1BhcmFtZXRlcnM6IGFyZ30pOwoKY29uc3QgbG9va1VwID0gYXdhaXQgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh0aGF0KTsKCnJldHVybiBsb29rVXA7JwDhreaZDf20BglhYlZlcnNpb24CBADhreaZDb3DBwQxMC41JwDhreaZDf20BgVsZWFybgIEAOGt5pkNwsMHKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAOGt5pkN/bQGCmFiTG9hZFRvb2wCBADhreaZDenDB7AHQGxldCB7CiAgICB0b29sTmFtZSwKICAgIHRvb2xQYXJhbWV0ZXJzLAp9ID0gdGhhdCA/PyB7fQoKYXNzZXJ0KHRvb2xOYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRvb2xOYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSB0b29sUGFyYW1ldGVyczpgLCB0b29sUGFyYW1ldGVycyk7Cgpjb25zdCB1cmwgPSBsaW5rcy5sZWFybi5hYkJ1aWxkQ2FzdWFsQ2F0YWxvZ1VSTChgL2FidG9vbHMvJHt0b29sTmFtZX0uYXV4YCk7CgpsZXQgYXV4OwoKdHJ5IHsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgd2ViLmhvb2soewogICAgICAgIG1ldGhvZDogJ0dFVCcsCiAgICAgICAgdXJsLAogICAgfSkKCiAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSAyMDApIHsKICAgICAgICBhdXggPSByZXNwb25zZS5kYXRhOwogICAgfQp9IGNhdGNoIChlKSB7CiAgICBsZXQgbWVzc2FnZSA9IGBGYWlsZWQgdG8gZG93bmxvYWQgdG9vbCAnJHt0b29sTmFtZX0nLmA7CiAgICBpZiAoZS5tZXNzYWdlKSB7CiAgICAgICAgbWVzc2FnZSArPSBgIEVycm9yOiAke2UubWVzc2FnZX1gOwogICAgfQoKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QobWVzc2FnZSk7Cn0KaWYgKGF1eCkgewogICAgaWYgKGF1eC52ZXJzaW9uID09PSAxKSB7CiAgICAgICAgcmV0dXJuIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoeyBib3RzOiBhdXguc3RhdGUsIGVnZ1BhcmFtZXRlcnM6IHRvb2xQYXJhbWV0ZXJzLCBpZ25vcmVHcmlkRm9jdXM6IHRydWUgfSkKICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYWIgdG9vbHMgbXVzdCBiZSBpbiBhdXggZm9ybWF0IHYxLiAnJHt0b29sTmFtZX0nIGlzIGF1eCBmb3JtYXQgdiR7YXV4LnZlcnNpb259YCk7CiAgICB9Cn0nAOGt5pkN/bQGBXV0aWxzAgQA4a3mmQ2aywco8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycA4a3mmQ39tAYLcGVyc29uYWxpdHkCBADhreaZDcHLByjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwEEYm90cyRmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjABJwDhreaZDejLBxFjbWRVcGRhdGVBcnRpZmFjdAIEAOGt5pkN6csHmAhAY29uc3QgYXJncyA9IHRoYXQ7CgppZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgIC8vIFVwZGF0ZSB1c2VyIHByb3ZpZGVkIGFydGlmYWN0IG5hbWVzLgogICAgZm9yIChjb25zdCBhYkFydGlmYWN0TmFtZSBvZiBhcmdzKSB7CiAgICAgICAgbGlua3MuYXJ0aWZhY3QuYWJVcGRhdGVBcnRpZmFjdFNoYXJkcyh7IGFiQXJ0aWZhY3ROYW1lIH0pOwogICAgfQp9IGVsc2UgewogICAgLy8gSGF2ZSB1c2VyIHNlbGVjdCBhcnRpZmFjdCBuYW1lcyB0byB1cGRhdGUuCiAgICBsZXQgYWJBcnRpZmFjdE5hbWVzID0gQXJyYXkuZnJvbShsaW5rcy5hcnRpZmFjdC5hYkdldEFydGlmYWN0TmFtZXNJbkluc3QoKSk7CgogICAgaWYgKGFiQXJ0aWZhY3ROYW1lcyAmJiBhYkFydGlmYWN0TmFtZXMubGVuZ3RoID4gMCkgewogICAgICAgIGFiQXJ0aWZhY3ROYW1lcy5zb3J0KCk7CgogICAgICAgIGNvbnN0IHNlbGVjdGlvbk9wdGlvbnMgPSBhYkFydGlmYWN0TmFtZXMubWFwKChlbnRyeSkgPT4gewogICAgICAgICAgICByZXR1cm4geyBsYWJlbDogZW50cnksIHZhbHVlOiBlbnRyeSB9CiAgICAgICAgfSkKCiAgICAgICAgY29uc3Qgc2VsZWN0ZWRPcHRpb25zID0gYXdhaXQgb3Muc2hvd0lucHV0KG51bGwsIHsKICAgICAgICAgICAgdGl0bGU6ICdVcGRhdGUgYXJ0aWZhY3RzJywKICAgICAgICAgICAgdHlwZTogJ2xpc3QnLAogICAgICAgICAgICBzdWJ0eXBlOiAnY2hlY2tib3gnLAogICAgICAgICAgICBpdGVtczogc2VsZWN0aW9uT3B0aW9ucwogICAgICAgIH0pCgogICAgICAgIGZvciAoY29uc3Qgc2VsZWN0ZWQgb2Ygc2VsZWN0ZWRPcHRpb25zKSB7CiAgICAgICAgICAgIGxpbmtzLmFydGlmYWN0LmFiVXBkYXRlQXJ0aWZhY3RTaGFyZHMoeyBhYkFydGlmYWN0TmFtZTogc2VsZWN0ZWQudmFsdWUgfSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBDYW5ub3QgdXBkYXRlIGFydGlmYWN0cyBiZWNhdXNlIHRoZXJlIGFyZSBubyBhcnRpZmFjdHMgaW4gdGhlIGluc3QuYCk7CiAgICB9Cn0KJwDhreaZDejLBwZzeXN0ZW0CBADhreaZDYLUBw5hYi5zaGVsbC5pbnB1dCcA4a3mmQ3oywcEZm9ybQIEAOGt5pkNkdQHB25vdGhpbmcnAOGt5pkN6MsHCW9uS2V5RG93bgIEAOGt5pkNmdQH+gpAY29uc3QgeyBrZXlzIH0gPSB0aGF0OwoKaWYgKG1hc2tzLmNoYXRPcGVuKSB7CiAgICBjb25zdCBlc2MgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpOwoKICAgIGlmIChlc2MpIHsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFycm93VXAgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93VXAnKTsKICAgICAgICBjb25zdCBhcnJvd0Rvd24gPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93RG93bicpOwogICAgICAgIAogICAgICAgIGlmIChhcnJvd1VwIHx8IGFycm93RG93bikgewogICAgICAgICAgICAvLyBJZiBBcnJvd1VwIG9yIEFycm93RG93biBhcmUgcHJlc3NlZCB3aGlsZSB0aGUgYWIgY2hhdCBiYXIgaXMgb3BlbiB0aGVuCiAgICAgICAgICAgIC8vIHN0YXJ0IGNvbWJpbmcgdGhyb3VnaCBjaGF0IGhpc3RvcnkuCiAgICAgICAgICAgIGNvbnN0IGRpciA9IGFycm93VXAgPyAtMSA6IDE7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCArIGRpcjsKICAgICAgICAgICAgbGV0IGhpc3RvcmljYWxUZXh0ID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIGluZGV4IDwgdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaGlzdG9yaWNhbFRleHQgPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnlbaW5kZXhdOwogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IGluZGV4OwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID49IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGNoYXQgYmFyLgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3Blbih7IHByZWZpbGw6IGhpc3RvcmljYWxUZXh0IH0pOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGNvbnN0IGJhY2t0aWNrID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdgJykgfHwgdGhhdC5rZXlzLmluY2x1ZGVzKCJEZWFkIik7CgogICAgaWYgKGJhY2t0aWNrKSB7CiAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICB9Cn0KJwDhreaZDejLBwZvbkNoYXQCBADhreaZDZTfB4oYQC8vIE5vdCBzdXBwb3J0ZWQgb3V0c2lkZSBvZiBidWlsZGVyIHZlcnNpb24KaWYgKCFidWlsZGVyVmVyc2lvbikgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgppZiAoIXRoYXQubWVzc2FnZSkgewogICAgdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOwogICAgcmV0dXJuOwp9CgovLyBBcHBlbmQgbWVzc2FnZSB0byBjaGF0IGhpc3RvcnkgYW5kIHVwZGF0ZSB0aGUgY3VycmVudCBoaXN0b3J5IGluZGV4Lgp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkucHVzaCh0aGF0Lm1lc3NhZ2UpOwp0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKCi8vIEZ1bmN0aW9uIHRvIHBhcnNlIGFyZ3VtZW50cyB3aXRoIHF1b3RlIHN1cHBvcnQgYW5kIGVycm9yIGhhbmRsaW5nCi8vIEV4YW1wbGVzOiAKLy8gICAnYXJnMSBhcmcyJyAtPiBbJ2FyZzEnLCAnYXJnMiddCi8vICAgJyJhcmcgd2l0aCBzcGFjZXMiIGFyZzInIC0+IFsnYXJnIHdpdGggc3BhY2VzJywgJ2FyZzInXQovLyAgICcidW5jbG9zZWQgcXVvdGUnIC0+IHRocm93cyBFcnJvcgpmdW5jdGlvbiBwYXJzZUFyZ3VtZW50cyhpbnB1dCkgewogICAgY29uc3QgYXJncyA9IFtdOwogICAgbGV0IGN1cnJlbnRBcmcgPSAnJzsKICAgIGxldCBpbnNpZGVRdW90ZXMgPSBudWxsOwogICAgbGV0IHF1b3RlU3RhcnRQb3MgPSAtMTsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGNoYXIgPSBpbnB1dFtpXTsKICAgICAgICAKICAgICAgICBpZiAoaW5zaWRlUXVvdGVzKSB7CiAgICAgICAgICAgIGlmIChjaGFyID09PSBpbnNpZGVRdW90ZXMpIHsKICAgICAgICAgICAgICAgIGluc2lkZVF1b3RlcyA9IG51bGw7CiAgICAgICAgICAgICAgICBxdW90ZVN0YXJ0UG9zID0gLTE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2hhciA9PT0gJ1xcJyAmJiBpICsgMSA8IGlucHV0Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaSsrOyAvLyBTa2lwIHRoZSBiYWNrc2xhc2gKICAgICAgICAgICAgICAgIGN1cnJlbnRBcmcgKz0gaW5wdXRbaV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoY2hhciA9PT0gJyInIHx8IGNoYXIgPT09ICInIikgewogICAgICAgICAgICAgICAgaW5zaWRlUXVvdGVzID0gY2hhcjsKICAgICAgICAgICAgICAgIHF1b3RlU3RhcnRQb3MgPSBpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICcgJykgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRBcmcubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChjdXJyZW50QXJnKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50QXJnID0gJyc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyZW50QXJnICs9IGNoYXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICAKICAgIGlmIChpbnNpZGVRdW90ZXMpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuY2xvc2VkIHF1b3RlOiBmb3VuZCBvcGVuaW5nICR7aW5zaWRlUXVvdGVzfSBhdCBwb3NpdGlvbiAke3F1b3RlU3RhcnRQb3N9IGJ1dCBubyBjbG9zaW5nIHF1b3RlYCk7CiAgICB9CiAgICAKICAgIGlmIChjdXJyZW50QXJnLmxlbmd0aCA+IDApIHsKICAgICAgICBhcmdzLnB1c2goY3VycmVudEFyZyk7CiAgICB9CiAgICAKICAgIHJldHVybiBhcmdzOwp9CgppZiAodGhhdC5tZXNzYWdlWzBdID09ICIuIikgewogICAgY29uc3QgY29tbWFuZFBhcnQgPSB0aGF0Lm1lc3NhZ2Uuc3Vic3RyaW5nKDEpOyAvLyBSZW1vdmUgdGhlIGRvdAogICAgY29uc3Qgc3BhY2VJbmRleCA9IGNvbW1hbmRQYXJ0LmluZGV4T2YoJyAnKTsKICAgIAogICAgbGV0IGNtZCwgYXJnczsKICAgIGlmIChzcGFjZUluZGV4ID09PSAtMSkgewogICAgICAgIC8vIE5vIGFyZ3VtZW50cwogICAgICAgIGNtZCA9IGNvbW1hbmRQYXJ0OwogICAgICAgIGFyZ3MgPSB1bmRlZmluZWQ7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEhhcyBhcmd1bWVudHMKICAgICAgICBjbWQgPSBjb21tYW5kUGFydC5zdWJzdHJpbmcoMCwgc3BhY2VJbmRleCk7CiAgICAgICAgY29uc3QgYXJnc1N0cmluZyA9IGNvbW1hbmRQYXJ0LnN1YnN0cmluZyhzcGFjZUluZGV4ICsgMSk7CiAgICAgICAgCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc3QgcGFyc2VkQXJncyA9IHBhcnNlQXJndW1lbnRzKGFyZ3NTdHJpbmcpOwogICAgICAgICAgICBhcmdzID0gcGFyc2VkQXJncy5sZW5ndGggPyBwYXJzZWRBcmdzIDogdW5kZWZpbmVkOwogICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoeyBtZXNzYWdlOiBgRXJyb3IgcGFyc2luZyBjb21tYW5kIGFyZ3VtZW50czogJHtlcnJvci5tZXNzYWdlfWAsIGxvZ1R5cGU6ICdFcnJvcicgfSk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyQ2xvc2UoKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDcmVhdGUgYSBmcmVzaCBDb21tYW5kc01hbmFnZXIgd2l0aCBlYWNoIGNhbGwgc28gdGhhdCB3ZSBhbHdheXMgaGF2ZSB0aGUgbGF0ZXN0IGNvbW1hbmRzIGFuZCBmdW5jdGlvbmFsaXR5LgogICAgY29uc3QgYWJDb21tYW5kcyA9IG5ldyBBQkNvbW1hbmRzTWFuYWdlcigpOwoKICAgIGlmIChhYkNvbW1hbmRzICYmIGFiQ29tbWFuZHMuaGFzQ29tbWFuZChjbWQpKSB7CiAgICAgICAgLy8gQ2FsbCBjb21tYW5kIHdpdGggYXJncy4KICAgICAgICBhYkNvbW1hbmRzLmNhbGxDb21tYW5kKGNtZCwgYXJncyk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEV2YWx1YXRlIGNvbW1hbmQgYXMgamF2YXNjcmlwdC4KICAgICAgICBjb25zdCBqcyA9IHRoYXQubWVzc2FnZS5zdWJzdHJpbmcoMSk7CiAgICAgICAgb3MucnVuKGpzKTsKICAgIH0KfQoKdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOycA4a3mmQ3oywcLZGVzY3JpcHRpb24CBADhreaZDZ/3B0JUaGlzIGlzIG1lYW50IHRvIGhhbmRsZSBhbnkgbm9uZSBtZW51IHJlbGF0ZWQgaW5wdXRzL2ludGVyYWN0aW9ucy4nAOGt5pkN6MsHDG9uRmlsZVVwbG9hZAIEAOGt5pkN4vcH3xlALy9maWx0ZXIgb3V0IHRpbWVzIHdoZW4gZmlsZSBsb2FkaW5nIGlzIG5vdCBhbGxvd2VkCmlmICghYnVpbGRlclZlcnNpb24gfHwgbGlua3MucmVtZW1iZXIudGFncy5hYkxpc3RlbmluZ0ZvckZpbGVVcGxvYWRzICE9PSB0cnVlKQp7CiAgICByZXR1cm47Cn0KCi8vdmFyaW91cyBmaWxlIHNwZWNpZmljIHZhcmlhYmxlcwpsZXQgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCkudG9Mb3dlckNhc2UoKTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwpsZXQgc2l6ZSA9IHRoYXQuZmlsZS5zaXplOwpsZXQgbWltZVR5cGU7CmxldCBib3RJbmZvID0ge307CgovL2hhcmQgbGltaXQgYmFzZWQgb24gZmlsZSBzaXplCmlmIChzaXplID4gMjAwMDAwMDAwKQp7CiAgb3MudG9hc3QoIm1heGltdW0gZmlsZSBzaXplIGV4Y2VlZGVkICgyMDAgbWIpIik7CgogIHJldHVybjsKfQoKLy90aGlzIHN3aXRjaCBoYW5kbGVzIHBvc3NpYmxlIGZpbGVzIGV4dGVuc2lvbnMsIHdoaWxlIHJlamVjdGluZyBhbnkgaXQgZG9lcyBub3QgcmVjb2duaXplCnN3aXRjaChmaWxlRXh0ZW5zaW9uKQp7CiAgY2FzZSAnanBnJzoKICBjYXNlICdqcGVnJzoKICBjYXNlICd3ZWJwJzoKICBjYXNlICdnaWYnOgogIGNhc2UgJ3BuZyc6CiAgICBtaW1lVHlwZSA9ICJpbWFnZS8iICsgZmlsZUV4dGVuc2lvbjsKICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgYnJlYWs7CiAgY2FzZSAnc3ZnJzoKICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICBicmVhazsKICBjYXNlICdnbGInOgogIGNhc2UgJ2V4cic6CiAgY2FzZSAnZ2x0Zic6CiAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICBib3RJbmZvLmZvcm0gPSAibWVzaCI7CiAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gImdsdGYiOwogICAgYnJlYWs7CiAgY2FzZSAnYXV4JzoKICBjYXNlICdwZGYnOgogICAgbGV0IGJvdERhdGEgPSBmaWxlRXh0ZW5zaW9uID09ICIuYXV4IiA/IEpTT04ucGFyc2UodGhhdC5maWxlLmRhdGEpLnN0YXRlIDogb3MucGFyc2VCb3RzRnJvbURhdGEodGhhdC5maWxlLmRhdGEpOwoKICAgIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoe2JvdHM6IGJvdERhdGEsIG9yaWdpbjogZmlsZU5hbWUsIHNvdXJjZUV2ZW50OiAnZmlsZV91cGxvYWQnfSk7CgogICAgcmV0dXJuOwovLyAgIGNhc2UgJ3BkZic6Ci8vICAgICBicmVhazsKICBjYXNlICdtcDMnOgogICAgbWltZVR5cGUgPSAnYXVkaW8vbXBlZyc7CiAgICBib3RJbmZvLm9uQ2xpY2sgPSAiQCBvcy5wbGF5U291bmQodGFncy5mb3JtQWRkcmVzcyk7IjsKICAgIGJvdEluZm8ubGFiZWwgPSAiQ2xpY2sgdG8gUGxheSI7CiAgICBicmVhazsKICBjYXNlICdtcDQnOgogICAgbWltZVR5cGUgPSAndmlkZW8vbXA0JzsKICAgIGJvdEluZm8uZm9ybSA9ICJpZnJhbWUiOwogICAgYm90SW5mby5mb3JtU3VidHlwZSA9ICJzcmMiOwogICAgYnJlYWs7CiAgY2FzZSAnb3RmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvb3RmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBjYXNlICd3b2ZmJzoKICAgIG1pbWVUeXBlID0gJ2ZvbnQvd29mZic7CiAgICBib3RJbmZvLmxhYmVsID0gImV4YW1wbGUiOwogICAgYnJlYWs7CiAgZGVmYXVsdDoKICAgIGxldCByZXN1bHQgPSBuZXcgRXJyb3IoInVuaGFuZGxlZCBmaWxlIHR5cGU6ICIgKyBmaWxlRXh0ZW5zaW9uKTsKICAgIG9zLnRvYXN0KCJmaWxlIHR5cGUgbm90IHN1cHBvcnRlZCIpOwogICAgY29uc29sZS53YXJuKHJlc3VsdCkKICAgIHJldHVybiByZXN1bHQ7Cn0KCi8vdGhlIGZvbGxvd2luZyB2YXJpYWJsZXMgYW5kIG9iamVjdHMgc2V0IHVwIGEgbG9hZGluZyBiYXIgYnV0dG9uCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgpsZXQgdXBsb2FkUmVzdWx0OwoKaWYgKCFsaW5rcy5tZW51KSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KCdhYkludGVyZmFjZScpOwp9CgpsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1c3lJbmRpY2F0b3IoeyBhYk1lbnU6IHRydWUsIGxhYmVsOiBgdXBsb2FkaW5nYH0pOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBjb25maWdCb3QudGFncy5zdHVkaW9JRCA/PyBjb25maWdCb3QudGFncy5zdHVkaW87CgppZiAoIWNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEKQp7CiAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBhdXRoQm90LmlkOwp9CgovL3RoaXMgaXMgdGhlIGFjdHVhbCB1cGxvYWQgZnVuY3Rpb25hbGl0eQp1cGxvYWRSZXN1bHQgPSBhd2FpdCBsaW5rcy5zdG9yZS5hYlB1Ymxpc2hGaWxlKHtmaWxlOiB0aGF0LmZpbGUuZGF0YSwgZmlsZU5hbWU6IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKCi8vaWYgdGhlIGZpbGUgc2hvdWxkIGJlIGluY2x1ZGVkIGFzIGEgYm90IHdpdGggYSBsaW5rLCB0aGlzIGxvZ2ljIGhhbmRsZXMgdGhhdAoKaWYgKG1pbWVUeXBlLmluY2x1ZGVzKCJmb250IikpCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5sYWJlbEZvbnRBZGRyZXNzID0gdXBsb2FkUmVzdWx0LnVybCA/IHVwbG9hZFJlc3VsdC51cmwgOiB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKICAgIGNyZWF0ZShib3RJbmZvKTsKfQplbHNlIGlmIChPYmplY3Qua2V5cyhib3RJbmZvKS5sZW5ndGggPiAwKQp7CiAgICBib3RJbmZvW2NvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWxdID0gdHJ1ZTsKICAgIGJvdEluZm8uZm9ybUFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9Cgpjb25zdCBjbGlwVVJMID0gdXBsb2FkUmVzdWx0LnVybCA/PyB1cGxvYWRSZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwoKb3Muc2V0Q2xpcGJvYXJkKGNsaXBVUkwpOwoKb3MudG9hc3QoImZpbGUgdXJsIGFkZGVkIHNldCB0byBjbGlwYm9hcmQiKTsKCi8vY2xlYXIgdGhlIHByb2dyZXNzIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiB1cGxvYWRSZXN1bHQ7JwDhreaZDejLBwVsZWFybgIEAOGt5pkNwpEIKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAOGt5pkN6MsHCHJlbWVtYmVyAgQA4a3mmQ3pkQgo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA4a3mmQ3oywcNbWFuaWZlc3RhdGlvbgIEAOGt5pkNkJIIKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAOGt5pkN6MsHCGFiSWdub3JlAgQA4a3mmQ23kggEdHJ1ZScA4a3mmQ3oywcGY3JlYXRlAgQA4a3mmQ28kggo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycA4a3mmQ3oywcFc3RvcmUCBADhreaZDeOSCCjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwDhreaZDejLBwRtZW51AgQA4a3mmQ2Kkwgo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA4a3mmQ3oywcHYWJTaGVsbAIEAOGt5pkNsZMIBHRydWUnAOGt5pkN6MsHCW9uVGFwQ29kZQIEAOGt5pkNtpMIqQJAY29uc3QgdGFwQ29kZSA9IHRoYXQ7Cgpzd2l0Y2ggKHRhcENvZGUpCnsKICAgIGNhc2UgIjMzNDIiOgogICAgICAgIG9zLnRvYXN0KCJ3YWtpbmcgIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkpOwoKICAgICAgICB0aGlzQm90Lm9uQ2hhdCh7bWVzc2FnZTogIi4uIn0pOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAiNDI0MiI6CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICAgIC8vY29uc29sZS5sb2codGFwQ29kZSk7Cn0nAOGt5pkN6MsHA2FzawIEAOGt5pkN4JUIKPCflJdlYzg1YzFkNi05ZjFhLTQwZDQtODJlMS01YmQ2ODAzNDljMjcnAOGt5pkN6MsHCWFiVmVyc2lvbgIEAOGt5pkNh5YIBDEwLjUnAOGt5pkN6MsHCm9uQm90QWRkZWQCBADhreaZDYyWCEBAdGhpc0JvdC5sb2FkQUJDb21tYW5kc01hbmFnZXIoKTsKdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5ID0gW107JwDhreaZDejLBxpvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZAIEAOGt5pkNzZYI80JAbGV0IGFiQ29tbWFuZHM6IEFCQ29tbWFuZHNNYW5hZ2VyID0gdGhhdDsKCi8vIFRoZXNlIGFyZSBhbGwgdGhlIGJ1aWx0LWluIGNvbW1hbmRzLgoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdoZWxwJywgKGFyZ3MpID0+IHsKICAgIGNvbnN0IGNvbW1hbmRzID0gYWJDb21tYW5kcy5jb21tYW5kczsKICAgIGNvbnN0IGNvbW1hbmRLZXlzID0gT2JqZWN0LmtleXMoY29tbWFuZHMpOwoKICAgIGxldCBzZWxlY3RlZENvbW1hbmQ7CiAgICBpZiAoY29tbWFuZEtleXMgJiYgY29tbWFuZEtleXMubGVuZ3RoICYmIGFyZ3MgJiYgYXJncy5sZW5ndGgpIHsKICAgICAgICBjb25zdCBjb21tYW5kS2V5TWF0Y2ggPSBjb21tYW5kS2V5cy5maW5kKGtleSA9PiBrZXkgPT09IGFyZ3NbMF0pOwogICAgICAgIHNlbGVjdGVkQ29tbWFuZCA9IGNvbW1hbmRLZXlNYXRjaDsKICAgIH0KICAgIAogICAgbGlua3MuaGVscC5tb3VudCh7IGFiQ29tbWFuZHNNYW5hZ2VyOiBhYkNvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQgfSk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IHRoaXMgaGVscCB3aW5kb3cuIENhbiBzcGVjaWZ5IGEgY29tbWFuZCB0byBvcGVuIHRoZSBoZWxwIHBhZ2UgZm9yIHRoYXQgY29tbWFuZCBkaXJlY3RseS4nLAogICAgdXNhZ2U6IFsnLmhlbHAnLCAnLmhlbHAgW2NvbW1hbmRdJ10KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJy4nLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcuLicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3dha2UnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJXYWtlKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnV2FrZSB1cCBhYi4nLAogICAgdXNhZ2U6ICcud2FrZScKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3NsZWVwJywgYXJncyA9PiB0aGlzQm90LmNtZEFCU2xlZXAoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdQdXQgYWIgdG8gc2xlZXAuJywKICAgIHVzYWdlOiAnLnNsZWVwJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnYXNrJywgKGFyZ3MpID0+IHsKICAgIGlmIChsaW5rcy5hc2spIHsKICAgICAgICBpZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgY29uc3QgYXNrSW5wdXQgPSBhcmdzLmpvaW4oJyAnKTsKICAgICAgICAgICAgbGlua3MuYXNrLmFiQ29yZU1lbnVBY3Rpb24oYXNrSW5wdXQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYC5hc2sgY29tbWFuZCByZXF1aXJlcyBpbnB1dGApOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgYXNrIGJvdCBpcyBub3QgbG9hZGVkLCBjYW5ub3QgbG9hZCBhc2tgKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0FzayBhYicsCiAgICB1c2FnZTogJy5hc2sgPGFza19uYW1lPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ25hbWVhYicsIGFzeW5jIChhcmdzKSA9PiB7CiAgICBjb25zdCBuYW1lID0gYXdhaXQgb3Muc2hvd0lucHV0KGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHksIHsgdGl0bGU6ICd3aGF0IHdvdWxkIHlvdSBsaWtlIHRvIGNhbGwgbWU/JyB9KTsKICAgIHNldFRhZ01hc2sobGlua3MucGVyc29uYWxpdHksICdhYkJ1aWxkZXJJZGVudGl0eScsIG5hbWUsICdsb2NhbCcpOwogICAgc2hvdXQoJ2NoYW5nZVBlcnNvbmFsaXR5Q29uZmlnJywgeyBuYW1lOiBuYW1lIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2l2ZSBhYiBhIG5ldyBuYW1lLicsCiAgICB1c2FnZTogJy5uYW1lYWInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzeXN0ZW0nLCBhcmdzID0+IHRoaXNCb3QuY21kU3lzdGVtKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGluc3QuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYE9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpICAgIAoKICAgIFlvdSBtYXkgcHJvdmlkZSBhIGN1c3RvbSBzeXN0ZW1UYWdOYW1lIHdpdGggdGhlIGNvbW1hbmQsIGluIG9yZGVyIHRvIG9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgb25seSBmb3IgYm90cyB3aXRoIHRoZSBnaXZlbiBzeXN0ZW1UYWdOYW1lLiBCeSBkZWZhdWx0LCAic3lzdGVtIiB3aWxsIGJlIHVzZWQgYXMgdGhlIHN5c3RlbVRhZ05hbWUuCgogICAgRm9yIGV4YW1wbGU6CgogICAgPiAuc3lzdGVtCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJzeXN0ZW0iIHRhZy4KCiAgICA+IC5zeXN0ZW0gbXlHcm91cAogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAibXlHcm91cCIgdGFnLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zeXN0ZW0nLAogICAgICAgICcuc3lzdGVtIHN5c3RlbVRhZ05hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy13JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4gQnkgZGVmYXVsdCB0aGUgc3lzdGVtIHBvcnRhbCB3aWxsIG9wZW4gaW4gYSBuZXcgdGFiLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2cnLCAoYXJncykgPT4gewogICAgbGlua3MuY29uc29sZS50b2dnbGVDb25zb2xlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdUb2dnbGUgdmlzaWJsaXR5IG9mIHRoZSBhYiBsb2cuJywKICAgIHVzYWdlOiAnLmxvZycKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nY2xlYXInLCAoYXJncykgPT4gewogICAgY29uc3QgbWVzc2FnZUxvZ0JvdHMgPSBnZXRCb3RzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIsIHRydWUpOwogICAgZGVzdHJveShtZXNzYWdlTG9nQm90cyk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdDbGVhciBhbGwgYWIgbG9nIG1lc3NhZ2VzLicsCiAgICB1c2FnZTogJy5sb2djbGVhcicKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2hlZXQnLCBhcmdzID0+IHRoaXNCb3QuY21kU2hlZXQoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHNwZWNpZmllZCBib3Qgb3IgYW4gZW50aXJlIGRpbWVuc2lvbi4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnNoZWV0IFtvcHRpb25zXSBbcG9ydGFsIHwgaGVscGVyQm90TmFtZSB8IGJvdElkIHwgZ2xvYmFsVGhpc1BhdGhdJywKICAgICAgICAnZXguIC5zaGVldCBob21lJywKICAgICAgICAnZXguIC5zaGVldCBjb25maWdCb3QnLAogICAgICAgICdleC4gLnNoZWV0IC10IGEyY2Y0NzM5LTM5YTItNGZkNi1iM2VmLWNjNDc4MmY5NzA4OScsCiAgICAgICAgJ2V4LiAuc2hlZXQgZ2xvYmFsVGhpcy5teU9iamVjdC5teUJvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgbXlPYmplY3QubXlCb3QnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy10JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgaW4gYSBuZXcgYnJvd3NlciB0YWIuIFxuXG5OT1RFOiAuc2hlZXQgd2lsbCBhdXRvbWF0aWNhbGx5IGluc3BlY3QgdGhlIHNwYWNlIG9mIGEgYm90IGFuZCBmb3JjZSBvcGVuaW5nIGluIHRoZSBzYW1lIHRhYiBpZiBhIGJvdCBpcyBpbiB0ZW1wTG9jYWwgb3IgdGVtcFNoYXJlZCBzcGFjZS4nLAogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ21lbnVzaGVldCcsIChhcmdzKSA9PiB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWw7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYENhbm5vdCBvcGVuIHNoZWV0UG9ydGFsIGZvciBtZW51UG9ydGFsIGJvdHMuIFRoZSBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBkaXNhYmxlZC5gfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3IgdGhlIGN1cnJlbnQgbWVudSBwb3J0YWwuJywKICAgIHVzYWdlOiAnLm1lbnVTaGVldCcsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGluc3QnLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRJbnN0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgdGhlIGluc3QgdG8gZGlzay4nLAogICAgdXNhZ2U6ICcuZG93bmxvYWRpbnN0Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRhYicsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEFCKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgc3BlY2lmaWVkIGFiIGdyb3VwKHMpIHRvIGRpc2suJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYERvd25sb2FkIHNwZWNpZmllZCBhYiBncm91cChzKSB0byBkaXNrLgoKICAgIFlvdSBjYW4gcHJvdmlkZSBhIGxpc3Qgb2YgZ3JvdXBzIHRvIGRvd25sb2FkIGFsb25nIHdpdGggdGhlIGNvbW1hbmQ6CiAgICA+IC5kb3dubG9hZGFiIGFiQ29yZSBhYlNoZWxsIGFiSW50ZXJmYWNlCgogICAgSWYgZ3JvdXAocykgYXJlIG5vdCBwcm92aWRlZCB3aXRoIHRoZSBjb21hbWFuZCB0aGVuIHlvdSB3aWxsIGJlIHByb21wdGVkIHRvIHByb3ZpZGUgb25lIHdpdGggYSBkaWFsb2cuCiAgICBgLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRvd25sb2FkYWIgW29wdGlvbnNdIFtncm91cC4uLl0nLAogICAgICAgICdleC4gLmRvd25sb2FkYWIgYWJTaGVsbCBhYkludGVyZmFjZScsCiAgICAgICAgJ2V4LiAuZG93bmxvYWRhYiAtdiAxIG15R3JvdXBOYW1lJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnU3BlY2lmeSB0aGUgYXV4IGZvcm1hdCB2ZXJzaW9uIG51bWJlci4gZXguIC12IDEgd2lsbCBiZSBhdXggZm9ybWF0IHZlcnNpb24gMSAocHVyZSBib3QganNvbikuIEJ5IGRlZmF1bHQsIGFiIGZpbGVzIGFyZSB1c3VhbGx5IGRvd25sb2FkZWQgYXMgdmVyc2lvbiAyIGF1eCBmaWxlcyAoY29uZmxpY3QtZnJlZSB1cGRhdGUpLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGVnZycsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEVnZyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4gWW91IHdpbGwgbmVlZCB0byBwcm92aWRlIHRoZSByZWNvcmRLZXkgYXMgd2VsbCBhbmQgdGhlIG5hbWUgb2YgdGhlIGVnZy4gQSBkcm9wZG93biBzZWxlY3Rpb24gd2lsbCBiZSBwcm92aWRlZCBmb3IgdGhlIGVnZyBpZiBmb3VuZCB0byBzZWxlY3Qgd2hpY2ggdmVyc2lvbiB0byBkb3dubG9hZC5gLAogICAgdXNhZ2U6ICcuZG93bmxvYWRlZ2cnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9hZHNraWxsJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm9yIChsZXQgc2tpbGwgb2YgYXJncykgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJy5sb2Fkc2tpbGwgcmVxdWlyZXMgc29tZSBza2lsbCBuYW1lcycpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTG9hZCB0aGUgc3BlY2lmaWVkIGFiIHNraWxscy4nLAogICAgdXNhZ2U6ICcubG9hZFNraWxsIFtza2lsbCAuLi5dJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXJscXInLCAoKSA9PiBvcy5zaG93UVJDb2RlKGNvbmZpZ0JvdC50YWdzLnVybCksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IGEgUVIgY29kZSBmb3IgdGhlIGJyb3dlciB0YWJcJ3MgY3VycmVudCBVUkwuJywKICAgIHVzYWdlOiAnLnVybHFyJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZGltJywgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgbmFtZSA9IGFyZ3Muam9pbignICcpOwogICAgICAgIG9zLmdvVG9EaW1lbnNpb24obmFtZSk7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBNb3ZlZCB0byAnJHtuYW1lfScgZGltZW5zaW9uLmAsIGR1cmF0aW9uOiAzIH0pCiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHbyB0byBzcGVjaWZpZWQgZGltZW5zaW9uIC8gcG9ydGFsLicsCiAgICB1c2FnZTogJy5kaW0gPGRpbWVuc2lvbiB8IHBvcnRhbD4nLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXVpZCcsICgpID0+IHsKICAgIG9zLnNldENsaXBib2FyZCh1dWlkKCkpOwoKICAgIGxldCBtZXNzYWdlID0gYENvcGllZCBuZXcgdXVpZCB0byBjbGlwYm9hcmRgOwogICAgYWIubG9nKGxpbmtzLnBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBvcy50b2FzdChtZXNzYWdlKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0dlbmVyYXRlIGEgdW5pdmVyc2FsbHkgdW5pcXVlIGlkZW50aWZpZXIgKHV1aWQpIGFuZCBjb3B5IGl0IHRvIHRoZSBjbGlwYm9hcmQuJywKICAgIHVzYWdlOiAnLnV1aWQnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkdXAnLCAoYXJncykgPT4gewogICAgY29uc3QgYm90SWQgPSBhcmdzID8gYXJnc1swXSA6IHVuZGVmaW5lZDsKICAgIGlmIChib3RJZCkgewogICAgICAgIGNvbnN0IGJvdCA9IGdldEJvdCgnaWQnLCBib3RJZCk7CiAgICAgICAgaWYgKGJvdCkgewogICAgICAgICAgICBjb25zdCBkdXBCb3QgPSBjcmVhdGUoYm90KTsKICAgICAgICAgICAgb3Muc2V0Q2xpcGJvYXJkKGR1cEJvdC5pZCk7CiAgICAgICAgICAgIG9zLnRvYXN0KCdEdXBsaWNhdGUgYm90IGlkIGNvcGllZCB0byBjbGlwYm9hcmQuJyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3MudG9hc3QoYE5vIGJvdCBmb3VuZCB3aXRoIGlkICR7Ym90SWR9YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBvcy50b2FzdCgnUHJvdmlkZSB0aGUgaWQgb2YgdGhlIGJvdCB5b3Ugd2FudCB0byBkdXBsaWNhdGUnKTsKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0R1cGxpY2F0ZSBhIHNwZWNpZmllZCBib3QgYW5kIGNvcHkgdGhlIG5ldyBib3RcJ3MgaWQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcuZHVwIDxib3RJZD4nCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCd1cGxvYWRhdXgnLCAoYXJncykgPT4gewogICAgb3Muc2hvd1VwbG9hZEF1eEZpbGUoKTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1VwbG9hZCBBVVggZmlsZShzKSB0byB0aGUgY3VycmVudCBpbnN0LicsCiAgICB1c2FnZTogJy51cGxvYWRhdXgnCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGZpbGVzJywgYXJncyA9PiB0aGlzQm90LmNtZFVwbG9hZEZpbGVzKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIGZpbGUocykgZGlyZWN0bHkgdG8gcmVjb3JkLicsCiAgICB1c2FnZTogWwogICAgICAgICcudXBsb2FkZmlsZXMnLAogICAgICAgICcudXBsb2FkZmlsZXMgLXJlY29yZCA8cmVjb3JkX2lkPicKICAgIF0sCiAgICBhcmdzOiBbCiAgICAgICAgewogICAgICAgICAgICBpZGVudGlmaWVyOiAnLXJlY29yZCcsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnT3B0aW9uYWxseSBwdWJsaXNoIGZpbGUocykgdG8gYSBzcGVjaWZpYyByZWNvcmQuIElmIG9taXR0ZWQsIGZpbGUocykgd2lsbCBiZSBwdWJsaXNoZWQgdG8gdGhlIHVzZXJcJ3MgcGVyc29uYWwgcmVjb3JkLicKICAgICAgICB9CiAgICBdCn0pCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwZGF0ZWFydGlmYWN0JywgYXJncyA9PiB0aGlzQm90LmNtZFVwZGF0ZUFydGlmYWN0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTWFudWFsbHkgdXBkYXRlIGFuIGFydGlmYWN0IGluIHRoZSBjdXJyZW50IGluc3QuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYE1hbnVhbGx5IHVwZGF0ZSBhbiBhcnRpZmFjdCBpbiB0aGUgY3VycmVudCBpbnN0LgogICAgCiAgICBBIGRpYWxvZyB3aWxsIGJlIHNob3duIGFsbG93aW5nIHlvdSB0byBzZWxlY3Qgd2hpY2ggYXJ0aWZhY3RzIHRvIHVwZGF0ZSBpbiB0aGUgY3VycmVudCBpbnN0LgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGRhdGVhcnRpZmFjdCcsCiAgICBdCn0pJwDhreaZDejLBwhhcnRpZmFjdAIEAOGt5pkNwdkIKPCflJc3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcnAOGt5pkN6MsHFWxvYWRBQkNvbW1hbmRzTWFuYWdlcgIEAOGt5pkN6NkI+i1ALyoqCiAqIEFCQ29tbWFuZHNNYW5hZ2VyIGlzIHBhcnQgb2YgYWJTaGVsbC4KICogWW91IGNhbiByZWdpc3RlciBjb21tYW5kcyB0byBpdCB0aGF0IGNhbiBiZSBpbnZva2VkIHVzaW5nICckPGNvbW1hbmQ+JyB3aXRoIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICogSXRzIGdlbmVyYWxseSBub3QgcmVjb21tZW5kZWQgdG8gY3JlYXRlIHRoaXMgeW91cnNlbGYgYnV0IGluc3RlYWQgdG8gbGlzdGVuIGZvciB0aGUgQG9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkIHNob3V0CiAqIGFuZCB0byByZWdpc3RlciB5b3VyIGNvbW1hbmRzIHRoZXJlLgogKiBAcHJvcCB7c3RyaW5nW119IGNvbW1hbmRzCiAqLwpjbGFzcyBBQkNvbW1hbmRzTWFuYWdlciB7CiAgICBjb21tYW5kczogUmVjb3JkPHN0cmluZywgQUJDb21tYW5kPjsKCiAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICB0aGlzLmNvbW1hbmRzID0ge307CgogICAgICAgIC8vIFNob3V0IHRoYXQgYW4gaW5zdGFuY2Ugb2YgQUJDb21tYW5kc01hbmFnZXIgaGFzIGJlZW4gY3JlYXRlZCBhbmQgYWxsb3cgYW55IGxpc3RlbmVycwogICAgICAgIC8vIHRvIGFkZCB0aGVpciBvd24gY29tbWFuZHMgdG8gdGhlIGluc3RhbmNlLgogICAgICAgIHNob3V0KCdvbkFCQ29tbWFuZHNNYW5hZ2VyQ3JlYXRlZCcsIHRoaXMpOwogICAgfQoKICAgIC8qKgogICAgICogQWRkIGEgY29tbWFuZCB0byBBQkNvbW1hbmRzTWFuYWdlci4KICAgICAqIFRoaXMgY29tbWFuZCB3aWxsIGJlIGF2YWlsYWJsZSB0byBpbnZva2UgdXNpbmcgJyQ8bmFtZT4nIG9uIHRoZSBDYXN1YWxPUyBjaGF0IGJhci4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBzdWNjZXNzZnVsbHkgYWRkZWQuCiAgICAgKi8KICAgIGFkZENvbW1hbmQobmFtZTogc3RyaW5nLCBjYWxsYmFjazogQUJDb21tYW5kQ2FsbGJhY2ssIGhlbHA6IEFCQ29tbWFuZEhlbHApOiBib29sZWFuIHsKICAgICAgICBpZiAoIW5hbWUgfHwgdHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gc3RyaW5nIG5hbWUgaXMgcmVxdWlyZWQgZm9yIGNvbW1hbmRzLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgYWxyZWFkeSBleGlzdHMgYXMgYSBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWNhbGxiYWNrIHx8IHR5cGVvZiBjYWxsYmFjayAhPT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBhIGNhbGxiYWNrIGZ1bmN0aW9uLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhlbHApIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgcmVxdWlyZXMgaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIGlzIG1pc3Npbmcgc2hvcnREZXNjcmlwdGlvbiBmcm9tIGhlbHAgb2JqZWN0LmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNvbW1hbmRzW25hbWVdID0geyBuYW1lLCBjYWxsYmFjaywgaGVscCB9OwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGhhc0NvbW1hbmQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgcmV0dXJuIHRoaXMuY29tbWFuZHNbbmFtZV0gIT0gbnVsbDsKICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSBhIGNvbW1hbmQgZnJvbSBBQkNvbW1hbmRzTWFuYWdlcgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdhcyByZW1vdmVkLiBJZiB0aGUgY29tbWFuZCBkb2Vzbid0IGV4aXN0IGZhbHNlIHdpbGwgYWxzbyBiZSByZXR1cm5lZC4KICAgICAqLwogICAgcmVtb3ZlQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tuYW1lXSkgewogICAgICAgICAgICBkZWxldGUgdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENhbGwgdGhlIHNwZWNpZmllZCBjb21tYW5kIHdpdGggdGhlIHByb3ZpZGVkIGFyZ3MgKGlmIGFueSkuCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgY29tbWFuZCB3YXMgZXhlY3V0ZWQuCiAgICAgKi8KICAgIGNhbGxDb21tYW5kKG5hbWU6IHN0cmluZywgYXJncz86IGFueVtdKTogYm9vbGVhbiB7CiAgICAgICAgY29uc3QgY29tbWFuZCA9IHRoaXMuY29tbWFuZHNbbmFtZV07CiAgICAgICAgaWYgKGNvbW1hbmQpIHsKICAgICAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaGVscEFyZyBvZiBjb21tYW5kLmhlbHAuYXJncykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShoZWxwQXJnLmlkZW50aWZpZXIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaCguLi5oZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRBcmdzLnB1c2goaGVscEFyZy5pZGVudGlmaWVyKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBBc3NlcnQgdGhhdCB0aGUgaW5wdXQgYXJncyBhcmUgdmFsaWQgYWdhaW5zdCB0aGUgY29tbWFuZCBoZWxwIGRvY3VtZW50YXRpb24uCiAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGVhc3kgd2F5IHRvIHZhbGlkYXRlIGFyZ3MgYmVmb3JlIGV4ZWN1dGluZyBhIGNvbW1hbmQuCiAgICAgICAgICAgICAgICBBQkNvbW1hbmRzTWFuYWdlci5hc3NlcnRWYWxpZEFyZ3MoYXJncywgdmFsaWRBcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21tYW5kLmNhbGxiYWNrKGFyZ3MpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gaXMgbm90IGEgdmFsaWQgY29tbWFuZC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgdGhlIHZhbHVlIG9mIHRoZSBwcm92aWRlZCBhcmcuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgYW5kIHZhbHVlIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ1ZhbHVlKGFyZ3M6IGFueVtdLCBhcmc6IHN0cmluZyk6IGFueSB7CiAgICAgICAgbGV0IHZhbHVlID0gbnVsbDsKCiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgbGV0IGRlbGV0ZUNvdW50ID0gMTsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlSW5kZXggPSBhcmdJbmRleCArIDE7CgogICAgICAgICAgICAgICAgaWYgKHZhbHVlSW5kZXggPCBhcmdzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZUNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBhcmdzW3ZhbHVlSW5kZXhdOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFJlbW92ZSByZWxhdGVkIGFyZ3MgJiB2YWx1ZXMKICAgICAgICAgICAgICAgIGFyZ3Muc3BsaWNlKGFyZ0luZGV4LCBkZWxldGVDb3VudCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB3ZXRoZXIgdGhlIGFyZyBmbGFnIGlzIHByb3ZpZGVkIGluIHRoZSBhcmdzLiBXaWxsIHJlbW92ZSB0aGUgYXJnIGZyb20gdGhlIGFyZ3MgYXJyYXkuCiAgICAgKi8KICAgIHN0YXRpYyBwYXJzZUFyZ0ZsYWcoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYm9vbGVhbiB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgYXJnSW5kZXggPSBhcmdzLmZpbmRJbmRleChhID0+IGEgPT09IGFyZyk7CgogICAgICAgICAgICBpZiAoYXJnSW5kZXggPj0gMCkgewogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFyZyBmbGFnLgogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIDEpOwoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICBzdGF0aWMgYXNzZXJ0VmFsaWRBcmdzKGFyZ3M6IGFueVtdLCB2YWxpZEFyZ3M6IGFueVtdKTogdm9pZCB7CiAgICAgICAgaWYgKGFyZ3MpIHsKICAgICAgICAgICAgY29uc3QgaW52YWxpZEFyZ3MgPSBbXTsKCiAgICAgICAgICAgIGZvciAobGV0IGFyZyBvZiBhcmdzKSB7CiAgICAgICAgICAgICAgICBpZiAoYXJnICYmIHR5cGVvZiBhcmcgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhbiBhcmcgd2Ugd2FudCB0byBldmFsdWF0ZS4KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWxpZEFyZ3MgfHwgIXZhbGlkQXJncy5pbmNsdWRlcyhhcmcpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGFyZyBpcyBub3QgaW5jbHVkZWQgaW4gdGhlIHZhbGlkQXJncywgdGh1cyB0aGUgYXJnIGlzIGludmFsaWQuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkQXJncy5wdXNoKGFyZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgdGhpcyBhcmcgaXQgaXMgbW9zdGx5IGxpa2VseSBhIHZhbHVlIGFyZy4KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChpbnZhbGlkQXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgSW52YWxpZCBhcmd1bWVudHM6ICR7aW52YWxpZEFyZ3Muam9pbignLCAnKX1gOwoKICAgICAgICAgICAgICAgIG9zLnRvYXN0KGVycm9yTWVzc2FnZSwgNCk7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKZ2xvYmFsVGhpcy5BQkNvbW1hbmRzTWFuYWdlciA9IEFCQ29tbWFuZHNNYW5hZ2VyOycA4a3mmQ3oywcEaGVscAIEAOGt5pkN44cJKPCflJcyNGRjMDQzMS1mZmJiLTQ0OGQtYWE3NS05NzFiYWEwNzE4ZGMnAOGt5pkN6MsHCGNtZFNoZWV0AgQA4a3mmQ2KiAnNFEBjb25zdCBhcmdzID0gdGhhdDsKCmxldCBwb3J0YWw7CmxldCBuZXdUYWIgPSBmYWxzZTsKCmlmIChhcmdzKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBhcmcgPSBhcmdzW2ldOwogICAgICAgIGlmIChhcmcuc3RhcnRzV2l0aCgnLScpKSB7CiAgICAgICAgICAgIGlmIChhcmcgPT09ICctdCcpIHsKICAgICAgICAgICAgICAgIG5ld1RhYiA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCFwb3J0YWwpIHsKICAgICAgICAgICAgcG9ydGFsID0gYXJnOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFwb3J0YWwpIHsKICAgIHBvcnRhbCA9IG9zLmdldEN1cnJlbnREaW1lbnNpb24oKTsKfQoKY29uc3QgaGVscGVyQm90cyA9IHsKICAgICdjb25maWdCb3QnOiBjb25maWdCb3QsCiAgICAnZ3JpZFBvcnRhbEJvdCc6IGdyaWRQb3J0YWxCb3QsCiAgICAnc2hlZXRQb3J0YWxCb3QnOiBzaGVldFBvcnRhbEJvdCwKICAgICdzeXN0ZW1Qb3J0YWxCb3QnOiBzeXN0ZW1Qb3J0YWxCb3QsCiAgICAnbWluaUdyaWRQb3J0YWxCb3QnOiBtaW5pR3JpZFBvcnRhbEJvdCwKICAgICdtYXBQb3J0YWxCb3QnOiBtYXBQb3J0YWxCb3QsCiAgICAnbWluaU1hcFBvcnRhbEJvdCc6IG1pbmlNYXBQb3J0YWxCb3QsCiAgICAnbWVudVBvcnRhbEJvdCc6IG1lbnVQb3J0YWxCb3QsCiAgICAnbGVmdFdyaXN0UG9ydGFsQm90JzogbGVmdFdyaXN0UG9ydGFsQm90LAogICAgJ3JpZ2h0V3Jpc3RQb3J0YWxCb3QnOiByaWdodFdyaXN0UG9ydGFsQm90LAogICAgJ21lZXRQb3J0YWxCb3QnOiBtZWV0UG9ydGFsQm90LAogICAgJ3RhZ1BvcnRhbEJvdCc6IHRhZ1BvcnRhbEJvdCwKICAgICdpbXVQb3J0YWxCb3QnOiBpbXVQb3J0YWxCb3QsCn07CgovLyBGdW5jdGlvbiB0byByZXNvbHZlIGEgcG9ydGFsIHJlZmVyZW5jZSB0byBhIHNwZWNpZmljIGJvdApmdW5jdGlvbiByZXNvbHZlUG9ydGFsVG9Cb3QocGF0aCkgewogICAgaWYgKCFwYXRoIHx8IHBhdGggPT09ICcnKSByZXR1cm4gbnVsbDsKICAgIAogICAgLy8gRmlyc3QgY2hlY2sgaWYgaXQncyBkaXJlY3RseSBpbiBoZWxwZXJCb3RzCiAgICBpZiAoaGVscGVyQm90c1twYXRoXSkgewogICAgICAgIHJldHVybiBoZWxwZXJCb3RzW3BhdGhdOwogICAgfQoKICAgIC8vIFBlcmhhcHMgdGhlIHBhdGggaXMgYSBib3QgaWQuCiAgICBsZXQgYm90RnJvbUlkU2VhcmNoID0gZ2V0Qm90KCdpZCcsIHBhdGgpOwogICAgaWYgKGJvdEZyb21JZFNlYXJjaCkgewogICAgICAgIHJldHVybiBib3RGcm9tSWRTZWFyY2g7CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGZvciBib3RoIGRpcmVjdCBhbmQgbmVzdGVkIHBhdGhzIGluIGdsb2JhbFRoaXMKICAgIGxldCBwYXRoUGFydHMgPSBwYXRoLnNwbGl0KCcuJyk7CiAgICBsZXQgY3VycmVudE9iaiA9IGdsb2JhbFRoaXM7CiAgICBsZXQgc3RhcnRJbmRleCA9IDA7CiAgICAKICAgIC8vIEhhbmRsZSBpZiB0aGUgcGF0aCBleHBsaWNpdGx5IHN0YXJ0cyB3aXRoICdnbG9iYWxUaGlzJwogICAgaWYgKHBhdGhQYXJ0c1swXSA9PT0gJ2dsb2JhbFRoaXMnKSB7CiAgICAgICAgc3RhcnRJbmRleCA9IDE7IC8vIFNraXAgdGhlICdnbG9iYWxUaGlzJyBwYXJ0IHNpbmNlIHdlJ3JlIGFscmVhZHkgc3RhcnRpbmcgdGhlcmUKICAgIH0KICAgIAogICAgLy8gVHJhdmVyc2UgdGhlIHBhdGgKICAgIGZvciAobGV0IGkgPSBzdGFydEluZGV4OyBpIDwgcGF0aFBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgY29uc3QgcGFydCA9IHBhdGhQYXJ0c1tpXTsKICAgICAgICBpZiAoIWN1cnJlbnRPYmpbcGFydF0pIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIFBhdGggc2VnbWVudCBkb2Vzbid0IGV4aXN0CiAgICAgICAgfQogICAgICAgIGN1cnJlbnRPYmogPSBjdXJyZW50T2JqW3BhcnRdOwogICAgfQogICAgCiAgICAvLyBDaGVjayBpZiB0aGUgZmluYWwgb2JqZWN0IGlzIGEgYm90IChoYXMgaWQgYW5kIHRhZ3MpCiAgICBpZiAoY3VycmVudE9iaiAmJiBjdXJyZW50T2JqLmlkICYmIGN1cnJlbnRPYmoudGFncykgewogICAgICAgIHJldHVybiBjdXJyZW50T2JqOwogICAgfQogICAgCiAgICByZXR1cm4gbnVsbDsgLy8gTm90IGEgdmFsaWQgYm90Cn0KCi8vIFNlYXJjaCB0byBzZWUgaWYgcG9ydGFsIGFyZ3VtZW50IGlzIHNwZWNpZmljIHRvIGEgYm90CmxldCB1bmlxdWVCb3QgPSByZXNvbHZlUG9ydGFsVG9Cb3QocG9ydGFsKTsKCmlmICh1bmlxdWVCb3QpIHsKICAgIGlmICh1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBMb2NhbCcgfHwKICAgICAgICB1bmlxdWVCb3QudGFncy5zcGFjZSA9PT0gJ3RlbXBTaGFyZWQnCiAgICApIHsKICAgICAgICAvLyBGb3JjZSBzaGVldCB0byBvcGVuIGluIHNhbWUgdGFiIGlmIHRoZSBib3Qgb25seSBsaXZlcyBpbiB0aGlzIHRhYi4KICAgICAgICBuZXdUYWIgPSBmYWxzZTsKICAgIH0KICAgIHBvcnRhbCA9IHVuaXF1ZUJvdC5pZDsKfQoKaWYgKG5ld1RhYikgewogICAgb3Mub3BlblVSTChgLz9pbnN0PSR7b3MuZ2V0Q3VycmVudEluc3QoKX0mc2hlZXRQb3J0YWw9JHtwb3J0YWx9YCk7Cn0gZWxzZSB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IHBvcnRhbDsKfScA4a3mmQ3oywcNY21kRG93bmxvYWRBQgIEAOGt5pkN2JwJrQtAY29uc3QgYXJncyA9IHRoYXQ7CgpsZXQgYXV4VmVyc2lvbjogc3RyaW5nID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXYnKTsKCmlmICghYXV4VmVyc2lvbikgewogICAgLy8gRGVmYXVsdCB0byBhdXggdmVyc2lvbiAyIGlmIGFyZ3VtZW50IGlzIG5vdCBwcm92aWRlZC4KICAgIGF1eFZlcnNpb24gPSAnMic7Cn0KCmlmIChhdXhWZXJzaW9uICE9PSAnMScgJiYgYXV4VmVyc2lvbiAhPT0gJzInKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBPbmx5IGF1eCBmb3JtYXQgdmVyc2lvbiAxIGFuZCAyIGFyZSBzdXBwb3J0ZWQgaW4gdGhlIGRvd25sb2FkIGFiIGNvbW1hbmQuYCk7CiAgICByZXR1cm47Cn0KCmNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBc2xlZXAiLCAiYWJNYW5pZmVzdFN0YXRlIik7CgpsZXQgZ3JvdXBzID0gW107CgppZiAoYXJncyAmJiBhcmdzLmxlbmd0aCA+IDApIHsKICAgIC8vIFJlbWFpbmluZyBhcmdzIGFyZSBncm91cCBuYW1lcyBwcm92aWRlZCB3aXRoIHRoZSBjb21tYW5kLgogICAgZ3JvdXBzID0gYXJnczsKfSBlbHNlIHsKICAgIGxldCBncm91cCA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2SW5wdXREb3dubG9hZEFCR3JvdXAsIHsgdGl0bGU6ICdBQiBHcm91cCBUYWcnLCBhdXRvU2VsZWN0OiB0cnVlIH0pOwogICAgaWYgKGdyb3VwKSB7CiAgICAgICAgbWFza3MucHJldklucHV0RG93bmxvYWRBQkdyb3VwID0gZ3JvdXA7CiAgICAgICAgZ3JvdXBzLnB1c2goZ3JvdXApOwogICAgfQp9Cgpjb25zdCBtYWpvclZlcnNpb24gPSBsaW5rcy5sZWFybi50YWdzLmFiQ29yZU1ham9yVmVyc2lvbjsKY29uc3QgbWlub3JWZXJzaW9uID0gbGlua3MubGVhcm4udGFncy5hYkNvcmVNaW5vclZlcnNpb247CmNvbnN0IGFiVmVyc2lvbiA9IGAke21ham9yVmVyc2lvbn0uJHttaW5vclZlcnNpb259YDsKCmZvciAobGV0IGdyb3VwIG9mIGdyb3VwcykgewogICAgY29uc3QgZ3JvdXBCb3RzID0gZ2V0Qm90cyhieU1vZCh7IFtncm91cF06IHRydWUsIHNwYWNlOiAnc2hhcmVkJyB9KSk7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBncm91cEJvdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBncm91cEJvdHNbaV0udGFncy5hYlZlcnNpb24gPSBhYlZlcnNpb247CiAgICB9CgogICAgaWYgKGdyb3VwID09ICJhYkNvbmZpZyIpIHsKICAgICAgICBncm91cCA9ICJhYjEiOwogICAgfQoKICAgIGlmIChhdXhWZXJzaW9uID09PSAnMScpIHsKICAgICAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDEKICAgICAgICBvcy5kb3dubG9hZEJvdHMoZ3JvdXBCb3RzLCBncm91cCkKICAgIH0gZWxzZSB7CiAgICAgICAgLy8gRG93bmxvYWQgYXMgdmVyc2lvbiAyCiAgICAgICAgb3MuZG93bmxvYWRCb3RzQXNJbml0aWFsemF0aW9uVXBkYXRlKGdyb3VwQm90cywgZ3JvdXApOwogICAgfQoKfQoKJwDhreaZDejLBwljbWRBQldha2UCBADhreaZDYaoCcQDQGxldCBza2lsbEFycmF5ID0gWyJhYlBlcnNvbmFsaXR5IiwgImFiSW50ZXJmYWNlIiwgImFiQWN0aW9uIiwgImFiVGVzdHMiXTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc2tpbGxBcnJheS5sZW5ndGg7IGkrKykgewogICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChza2lsbEFycmF5W2ldKTsKfQoKYXdhaXQgb3Muc2xlZXAoMzAwKTsKCi8va2VlcCBhYiBhd2FrZQpsaW5rcy5yZW1lbWJlci50YWdzLmFiQXdha2VTdGF0ZSA9IHRydWU7CgppZiAoY29uZmlnQm90LnRhZ3MucGF0dGVybikgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSBjb25maWdCb3QudGFncy5wYXR0ZXJuOwp9CmVsc2UgewogICAgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgPSB1dWlkKCk7Cn0KCmNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBd2FrZSIsICJhYk1hbmlmZXN0U3RhdGUiKTsnAOGt5pkN6MsHCmNtZEFCU2xlZXACBADhreaZDcurCd0BQGNoYW5nZVN0YXRlKGxpbmtzLm1hbmlmZXN0YXRpb24sICJBc2xlZXAiLCAiYWJNYW5pZmVzdFN0YXRlIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwoKdGFnUG9ydGFsQm90Lm1hc2tzLnRhZ1BvcnRhbEFuY2hvclBvaW50ID0gbnVsbDsnAOGt5pkN6MsHB2NvbnNvbGUCBADhreaZDamtCSjwn5SXMjRiN2U2NmYtMGQ1Yi00MDY0LWJmNDgtYjU2MmI5ZTZlM2ViJwDhreaZDejLBw5jbWRVcGxvYWRGaWxlcwIEAOGt5pkN0K0JkxBAY29uc3QgYXJncyA9IHRoYXQ7Cgphc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlKHsgZmlsZSwgcmVjb3JkS2V5IH0pIHsKICAgIGxldCBmaWxlRXh0ZW5zaW9uID0gZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCk7CiAgICBsZXQgZmlsZU5hbWUgPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwogICAgbGV0IG1pbWVUeXBlOwoKICAgIHN3aXRjaCAoZmlsZUV4dGVuc2lvbikgewogICAgICAgIGNhc2UgJ3N2Zyc6CiAgICAgICAgICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdnbGInOgogICAgICAgIGNhc2UgJ2dsdGYnOgogICAgICAgICAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIG1pbWVUeXBlID0gZmlsZS5taW1lVHlwZTsKICAgICAgICAgICAgYnJlYWs7CiAgICB9CgogICAgbGV0IHVybDsKICAgICAgICAKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gcmVjb3JkS2V5OwogICAgY29uc3QgW3Jlc3VsdF0gPSBhd2FpdCBQcm9taXNlLmFsbChzaG91dCgnYWJQdWJsaXNoRmlsZScsIHsgZmlsZSwgZmlsZU5hbWUsIG1pbWVUeXBlIH0pKTsKICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gbnVsbDsKICAgIAogICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQudXJsOwogICAgfSBlbHNlIGlmIChyZXN1bHQuZXhpc3RpbmdGaWxlVXJsKSB7CiAgICAgICAgdXJsID0gcmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKICAgIH0KCiAgICByZXR1cm4geyB1cmwgfTsKfQoKY29uc3QgcmVjb3JkS2V5ID0gQUJDb21tYW5kc01hbmFnZXIucGFyc2VBcmdWYWx1ZShhcmdzLCAnLXJlY29yZCcpOwpjb25zdCBzZWxlY3RlZEZpbGVzID0gYXdhaXQgb3Muc2hvd1VwbG9hZEZpbGVzKCk7CmNvbnN0IHB1Ymxpc2hSZWNvcmQgPSBnZXRCb3QoJ3N5c3RlbScsICdyYy1wYWNrYWdlLWRldi5wdWJsaXNoUmVjb3JkJyk7CgppZiAoc2VsZWN0ZWRGaWxlcyAmJiBzZWxlY3RlZEZpbGVzLmxlbmd0aCkgewogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIFVwbG9hZCAke3NlbGVjdGVkRmlsZXMubGVuZ3RofSBmaWxlcy4uLmApOwogICAgfQoKICAgIGxldCBkb25lSHRtbCA9ICcnOwoKICAgIGlmIChyZWNvcmRLZXkpIHsKICAgICAgICBkb25lSHRtbCArPSBgPGgyPlJlY29yZCBJZDwvaDI+YDsKICAgICAgICBkb25lSHRtbCArPSBgPHA+JHtyZWNvcmRLZXl9PC9wPmA7CiAgICB9CgogICAgZG9uZUh0bWwgKz0gJzxoMj5VcGxvYWRlZCBGaWxlczwvaDI+JzsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEZpbGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgb3Muc2hvd0h0bWwoYFVwbG9hZGluZyAke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX0uLi5gKTsKICAgICAgICAKICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1cGxvYWRGaWxlKHsKICAgICAgICAgICAgZmlsZTogc2VsZWN0ZWRGaWxlc1tpXSwKICAgICAgICAgICAgcmVjb3JkS2V5LAogICAgICAgICAgICBvblByb2dyZXNzOiAoZmlsZVByb2dyZXNzKSA9PiB7CiAgICAgICAgICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSAke01hdGguY2VpbChmaWxlUHJvZ3Jlc3MgKiAxMDApfSVgKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIAogICAgICAgIGlmIChyZXN1bHQudXJsKSB7CiAgICAgICAgICAgIGRvbmVIdG1sICs9IGA8YSBocmVmPSIke3Jlc3VsdC51cmx9IiB0YXJnZXQ9Il9ibGFuayI+JHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9PC9hPjwvYnI+YDsKICAgICAgICB9CgogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfSByZXN1bHQ6YCwgcmVzdWx0KTsKICAgIH0KCiAgICBvcy5zaG93SHRtbChkb25lSHRtbCk7Cn0nAOGt5pkN6MsHDmNtZERvd25sb2FkRWdnAgQA4a3mmQ3kvQn5C0Bjb25zdCByZWNvcmRLZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5LCB7CiAgICB0aXRsZTogJ3JlY29yZCB0byBsb29rdXAgZWdnIGluJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSByZWNvcmRLZXk6YCwgcmVjb3JkS2V5KTsKCmlmICghcmVjb3JkS2V5KSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ1JlY29yZEtleSA9IHJlY29yZEtleTsKCmNvbnN0IGVnZ05hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQobWFza3MucHJldkRvd25sb2FkRWdnTmFtZSwgewogICAgdGl0bGU6ICduYW1lIG9mIGVnZycsCiAgICB0eXBlOiAndGV4dCcsCn0pCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnTmFtZTpgLCBlZ2dOYW1lKTsKCmlmICghZWdnTmFtZSkgewogICAgcmV0dXJuOwp9CgptYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lID0gZWdnTmFtZTsKCmNvbnN0IGVnZyA9IGF3YWl0IGxpbmtzLnNlYXJjaC5vbkxvb2t1cEFCRWdncyh7CiAgICBhYklEOiBlZ2dOYW1lLAogICAgcmVjb3JkS2V5LAogICAgcmV0dXJuVHlwZTogJ2VnZycKfSkKCmNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZWdnOmAsIGVnZyk7CgppZiAoIUFycmF5LmlzQXJyYXkoZWdnLmVnZ1ZlcnNpb25IaXN0b3J5KSB8fCBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoID09PSAwKSB7CiAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBEYXRhIGZvdW5kIGF0IGFkZHJlc3MgJyR7ZWdnTmFtZX0nIGluIHJlY29yZCAnJHtyZWNvcmRLZXl9JyBkb2VzIG5vdCBhcHBlYXIgdG8gYmUgYW4gZWdnLmApCiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgZWdnVmVyc2lvbk9wdGlvbnMgPSBlZ2cuZWdnVmVyc2lvbkhpc3RvcnkubWFwKChpdGVtLCBpbmRleCkgPT4gewogICAgcmV0dXJuIHsgbGFiZWw6IGB2ZXJzaW9uICR7aW5kZXggKyAxfWAsIHZhbHVlOiBpbmRleCB9Cn0pCgpjb25zdCBzZWxlY3RlZFZlcnNpb25PcHRpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQoZWdnVmVyc2lvbk9wdGlvbnMubGVuZ3RoIC0gMSwgewogICAgdGl0bGU6ICdkb3dubG9hZCBlZ2cgdmVyc2lvbicsCiAgICB0eXBlOiAnbGlzdCcsCiAgICBzdWJ0eXBlOiAnc2VsZWN0JywKICAgIGl0ZW1zOiBlZ2dWZXJzaW9uT3B0aW9ucywKfSkKCmlmICghc2VsZWN0ZWRWZXJzaW9uT3B0aW9uKSB7CiAgICByZXR1cm4gbnVsbDsKfQoKY29uc3QgYXV4RGF0YVVybCA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeVtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWVdOwpjb25zdCBhdXhEYXRhID0gYXdhaXQgb3MuZ2V0RmlsZShhdXhEYXRhVXJsKTsKY29uc3QgYXV4RmlsZW5hbWUgPSBgJHtlZ2dOYW1lfV92JHtzZWxlY3RlZFZlcnNpb25PcHRpb24udmFsdWUgKyAxfS5hdXhgOwoKb3MuZG93bmxvYWQoYXV4RGF0YSwgYXV4RmlsZW5hbWUsICdhcHBsaWNhdGlvbi9qc29uJyk7JwDhreaZDejLBw9jbWREb3dubG9hZEluc3QCBADhreaZDd7JCYUBQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3QgYm90cyA9IGdldEJvdHMoYiA9PiBiLnNwYWNlID09PSAnc2hhcmVkJyAmJiAhYi50YWdzLmFiSWdub3JlKTsKb3MuZG93bmxvYWRCb3RzKGJvdHMsIG9zLmdldEN1cnJlbnRJbnN0KCkpOycA4a3mmQ3oywcGc2VhcmNoAgQA4a3mmQ3kygko8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScA4a3mmQ3oywcFdXRpbHMCBADhreaZDYvLCSjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwDhreaZDejLBwljbWRTeXN0ZW0CBADhreaZDbLLCZEHQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3Qgc2FtZVdpbmRvdyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnRmxhZyhhcmdzLCAnLXcnKTsKCmxldCBzeXN0ZW1UYWdOYW1lID0gbnVsbDsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgc3lzdGVtVGFnTmFtZSA9IGFyZ3Muam9pbignICcpOwp9CgppZiAoc2FtZVdpbmRvdykgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4KICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVBvcnRhbCA9IHRydWU7CiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1UYWdOYW1lID0gc3lzdGVtVGFnTmFtZTsKfSBlbHNlIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiBhIG5ldyB0YWIuCiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCk7CgogICAgLy8gUmVtb3ZlIGFueSBwb3J0YWxzIHRoYXQgYXJlIHNldCBpbiB0aGUgVVJMLgogICAgbGV0IHBhcmFtcyA9IHVybC5zZWFyY2hQYXJhbXMua2V5cygpOwogICAgZm9yIChsZXQgcGFyYW0gb2YgcGFyYW1zKSB7CiAgICAgICAgaWYgKHBhcmFtLmVuZHNXaXRoKCdQb3J0YWwnKSkgewogICAgICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZShwYXJhbSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIFR1cm4gb24gdGhlIHN5c3RlbSBwb3J0YWwuCiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtUG9ydGFsJywgJ3RydWUnKTsKICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCdzeXN0ZW1UYWdOYW1lJyk7CgogICAgaWYgKHN5c3RlbVRhZ05hbWUpIHsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtVGFnTmFtZScsIHN5c3RlbVRhZ05hbWUpOwogICAgfQoKICAgIG9zLm9wZW5VUkwodXJsLmhyZWYpOwp9CicA4a3mmQ3oywcNYWJDaGF0QmFyT3BlbgIEAOGt5pkNxNIJowJAY29uc3QgewogICAgcHJlZmlsbCwKfSA9IHRoYXQgPz8ge30KCm1hc2tzLmNoYXRPcGVuID0gdHJ1ZTsKCm9zLnNob3dDaGF0KHsKICAgIHBsYWNlaG9sZGVyOiAnPiAuaGVscCB0byBzZWUgYXZhaWxhYmxlIGNvbW1hbmRzJywKICAgIGJhY2tncm91bmRDb2xvcjogJyMyZjJmMmYnLAogICAgZm9yZWdyb3VuZENvbG9yOiBsaW5rcy5wZXJzb25hbGl0eS50YWdzLmFiQmFzZUNvbG9yLAogICAgcGxhY2Vob2xkZXJDb2xvcjogbGlua3MucGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIHByZWZpbGwKfSknAOGt5pkN6MsHDmFiQ2hhdEJhckNsb3NlAgQA4a3mmQ3o1Al2QG1hc2tzLmNoYXRPcGVuID0gZmFsc2U7Cm9zLmhpZGVDaGF0KCk7CgovLyBHaXZlIENhc3VhbE9TIGEgY2hhbmdlIHRvIGFjdHVhbGx5IHJlbW92ZSB0aGUgY2hhdCBiYXIuCmF3YWl0IG9zLnNsZWVwKDApOycA4a3mmQ3oywcLcGVyc29uYWxpdHkCBADhreaZDd/VCSjwn5SXYjc2ZGZiYzQtODU0Yi00ZjZkLWE5MWYtYTk0ODY5NDc3NGRiJwDhreaZDejLBwV0eXBlcwIEAOGt5pkNhtYJ8gLwn5OEdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9AA=="}]}