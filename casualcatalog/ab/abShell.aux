{"version":2,"updates":[{"id":0,"timestamp":1752173856671,"update":"AZIDgdTs8g8AJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwCB1OzyDwAGc3lzdGVtAgQAgdTs8g8BDWFiLnNoZWxsLmdyaWQnAIHU7PIPAARmb3JtAgQAgdTs8g8PB25vdGhpbmcnAIHU7PIPAAxvbkFueUJvdERyYWcCBACB1OzyDxe7AUAvL2NvbnRyb2xzIGdyaWQgc25hcAppZiAobGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJncmlkIik7Cn0KCi8vY29udHJvbHMgYm90IHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCb3RTbmFwU3RhdGUpCnsKICAgIG9zLmFkZERyb3BTbmFwKCJmYWNlIik7Cn0nAIHU7PIPAAhyZW1lbWJlcgIEAIHU7PIP0wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAgdTs8g8ACGFiSWdub3JlAgQAgdTs8g/6AQR0cnVlJwCB1OzyDwAHYWJTaGVsbAIEAIHU7PIP/wEEdHJ1ZScAgdTs8g8ACWFiVmVyc2lvbgIEAIHU7PIPhAIEMTAuNCcAgdTs8g8ABWZvY3VzAgQAgdTs8g+JAqwEQC8vc2hvdXQoImZvY3VzIiwge2JvdDogYm90LCBwb3NpdGlvbjp7eDogeCwgeTogeX19KTsKCmNvbnN0IGZvY3VzVHlwZSA9IHRoYXQuYm90ID8gImJvdCIgOiAicG9zaXRpb24iOwpjb25zdCBkdXJhdGlvbiA9IHRoYXQuZHVyYXRpb247CmNvbnN0IHpvb20gPSB0aGF0Lnpvb20gPz8gY29uZmlnQm90LnRhZ3MubWFwUG9ydGFsID8gMjAwMCA6IDEwOwpjb25zdCByb3RhdGlvbiA9IHRoYXQucm90YXRpb24gPz8ge3g6IDQ1LCB5OiA0NX07CmNvbnN0IGVhc2luZyA9IHRoYXQuZWFzaW5nID8/IHt0eXBlOiAibGluZWFyIiwgbW9kZTogImlub3V0In07CmNvbnN0IGZvY3VzT3B0aW9ucyA9IHsKICAgIHpvb206IHpvb20sCiAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICBlYXNpbmc6IGVhc2luZywKICAgIGR1cmF0aW9uOiBkdXJhdGlvbgp9OwoKaWYgKGZvY3VzVHlwZSA9PSAiYm90IikKewogICAgYXdhaXQgb3MuZm9jdXNPbih0aGF0LmJvdCwgZm9jdXNPcHRpb25zKTsKfQplbHNlCnsKICAgIGF3YWl0IG9zLmZvY3VzT24odGhhdC5wb3NpdGlvbiwgZm9jdXNPcHRpb25zKTsKfScBBGJvdHMkMTFjOTVjN2QtYTE5My00MDBlLWI3MTAtM2JhMDQ4NmE2YTFhAScAgdTs8g+2BgZzeXN0ZW0CBACB1OzyD7cGE2FiLnNoZWxsLmNvbXBvbmVudHMnAIHU7PIPtgYMQXBwQ29udGFpbmVyAgQAgdTs8g/LBqwEQGNvbnN0IHsgdXNlQ2FsbGJhY2ssIHVzZVN0YXRlIH0gPSBvcy5hcHBIb29rczsKCmNvbnN0IEFwcENvbnRhaW5lciA9ICh7CiAgICBpZCA9IHV1aWQoKSwKICAgIG9uQmFja2dyb3VuZENsaWNrLAogICAgY2hpbGRyZW4KfSkgPT4gewogICAgY29uc3QgW2FwcElkLCBdID0gdXNlU3RhdGUoaWQpOwoKICAgIGNvbnN0IG9uQ2xpY2sgPSB1c2VDYWxsYmFjaygoZSkgPT4gewogICAgICAgIGlmIChlLnRhcmdldC5pZCA9PT0gYXBwSWQpIHsKICAgICAgICAgICAgaWYgKG9uQmFja2dyb3VuZENsaWNrKSB7CiAgICAgICAgICAgICAgICAvLyBDbGlja2VkIG9uIGFwcCBiYWNrZ3JvdW5kLgogICAgICAgICAgICAgICAgb25CYWNrZ3JvdW5kQ2xpY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFthcHBJZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPGRpdiBpZD17YXBwSWR9IGNsYXNzTmFtZT0nYWItYXBwLWJnJyBvbkNsaWNrPXtvbkNsaWNrfT4KICAgICAgICAgICAge2NoaWxkcmVufQogICAgICAgIDwvZGl2PgogICAgKQp9CgpyZXR1cm4gQXBwQ29udGFpbmVyOycAgdTs8g+2BghUZXh0TGluawIEAIHU7PIP+AqbA0Bjb25zdCBUZXh0TGluayA9ICh7CiAgICBvbkNsaWNrLAogICAgY2hpbGRyZW4sCn0pID0+IHsKICAgIHJldHVybiAoCiAgICAgICAgPHNwYW4gCiAgICAgICAgICAgIGNsYXNzTmFtZT0nYWItYXBwLXRleHQtbGluayBib2xkJyAKICAgICAgICAgICAgb25DbGljaz17b25DbGlja30KICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICctLWFiLWFwcC10ZXh0LWxpbmstY29sb3InOiBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICAgICAgICAgICAgICAnLS1hYi1hcHAtdGV4dC1saW5rLWhvdmVyLWNvbG9yJzogYWJQZXJzb25hbGl0eS50YWdzLmFiQmx1ZXByaW50Q29sb3IKICAgICAgICAgICAgfX0KICAgICAgICA+e2NoaWxkcmVufTwvc3Bhbj4KICAgICkKfQoKcmV0dXJuIFRleHRMaW5rOycAgdTs8g+2BgZXaW5kb3cCBACB1OzyD5QOtgJAY29uc3QgV2luZG93ID0gKHsKICAgIGlkLAogICAgZGlzYWJsZVNoYWRvdywKICAgIGNoaWxkcmVuLAp9KSA9PiB7CgogICAgbGV0IHdpbmRvd0NsYXNzTmFtZSA9ICdhYi1hcHAtd2luZG93JzsKCiAgICBpZiAoZGlzYWJsZVNoYWRvdykgewogICAgICAgIHdpbmRvd0NsYXNzTmFtZSArPSAnIG5vLXNoYWRvdyc7CiAgICB9CgogICAgcmV0dXJuICgKICAgICAgICA8ZGl2IGlkPXtpZH0gY2xhc3NOYW1lPXt3aW5kb3dDbGFzc05hbWV9PgogICAgICAgICAgICB7Y2hpbGRyZW59CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBXaW5kb3c7JwCB1OzyD7YGDFRleHRMaW5rLmNzcwIEAIHU7PIPyxDtAS5hYi1hcHAtdGV4dC1saW5rIHsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1jb2xvciwgcmdiKDcxIDI1NSAxMzcpKTsKfQoKLmFiLWFwcC10ZXh0LWxpbms6aG92ZXIgewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogdmFyKC0tYWItYXBwLXRleHQtbGluay1ob3Zlci1jb2xvciwgcmdiKDAgMTkyIDI1NSkpOwp9CgouYWItYXBwLXRleHQtbGluay5ib2xkIHsKICBmb250LXdlaWdodDogYm9sZDsKfScAgdTs8g+2BhVCYWNrZ3JvdW5kT3ZlcmxheS5jc3MCBACB1OzyD7kScS5hYi1hcHAtYmcgewogICAgcG9zaXRpb246IGZpeGVkOwogICAgYmFja2dyb3VuZC1jb2xvcjogcmdiYSgwLCAwLCAwLCAwLjMzKTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwp9JwCB1OzyD7YGCldpbmRvdy5jc3MCBACB1OzyD6sTqAMuYWItYXBwLXdpbmRvdyB7CiAgICBwb3NpdGlvbjogZml4ZWQ7CiAgICBmb250LWZhbWlseTogbW9ub3NwYWNlOwogICAgY29sb3I6IHdoaXRlOwogICAgYmFja2dyb3VuZC1jb2xvcjogIzJmMmYyZjsKICAgIHdpZHRoOiA4MHZ3OwogICAgaGVpZ2h0OiA3MHZoOwogICAgbWF4LXdpZHRoOiAxNTAwcHg7CiAgICBtYXgtaGVpZ2h0OiAxMDAwcHg7CiAgICBsZWZ0OiA1MCU7CiAgICB0b3A6IDUwJTsKICAgIHRyYW5zZm9ybTogdHJhbnNsYXRlKC01MCUsIC01MCUpOwogICAgYm94LXNoYWRvdzogMHB4IDBweCAxMnB4IDBweCBibGFjazsKICAgIG92ZXJmbG93OiBhdXRvOwogICAgcGFkZGluZy1sZWZ0OiA4cHg7CiAgICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCi5hYi1hcHAtd2luZG93Lm5vLXNoYWRvdyB7CiAgICBib3gtc2hhZG93OiBub25lOwp9JwCB1OzyD7YGCHJlbWVtYmVyAgQAgdTs8g/UFijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCB1OzyD7YGCGFiSWdub3JlAgQAgdTs8g/7FgR0cnVlJwCB1OzyD7YGB2FiU2hlbGwCBACB1OzyD4AXBHRydWUnAIHU7PIPtgYJYWJWZXJzaW9uAgQAgdTs8g+FFwQxMC40JwEEYm90cyQyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWIBJwCB1OzyD4oXB0FwcC5jc3MCBACB1OzyD4sXsRY6cm9vdCB7CiAgLS1hYi1jb25zb2xlLWJnOiAjZjhmOWZhOwogIC0tb24tYWItY29uc29sZS1iZzogIzIxMjUyOTsKICAtLWFiLWNvbnNvbGUtaGVpZ2h0OiAzM3ZoOwp9Ci8qIERhcmsgbW9kZSBzdXBwb3J0ICovCkBtZWRpYSAocHJlZmVycy1jb2xvci1zY2hlbWU6IGRhcmspIHsKICA6cm9vdCB7CiAgICAtLWFiLWNvbnNvbGUtYmc6ICMyMTI1Mjk7CiAgICAtLW9uLWFiLWNvbnNvbGUtYmc6ICNmOGY5ZmE7CiAgfQp9CgouYWItY29uc29sZS1idG4gewogIGN1cnNvcjogcG9pbnRlcjsKICBjb2xvcjogaW5oZXJpdDsKICBsZXR0ZXItc3BhY2luZzogaW5oZXJpdDsKICBsaW5lLWhlaWdodDogaW5oZXJpdDsKICB0ZXh0LXRyYW5zZm9ybTogaW5oZXJpdDsKICB0ZXh0LWluZGVudDogaW5oZXJpdDsKICB0ZXh0LXNoYWRvdzogaW5oZXJpdDsKICBiYWNrZ3JvdW5kLWNvbG9yOiBpbmhlcml0OwogIG1hcmdpbjogaW5oZXJpdDsKICBwYWRkaW5nLWJsb2NrOiBpbmhlcml0OwogIHBhZGRpbmctaW5saW5lOiBpbmhlcml0OwogIGJvcmRlcjogbm9uZTsKICB0cmFuc2Zvcm06IHNjYWxlKDEuMik7Cn0KCi5hYi1jb25zb2xlIHsKICB3aWR0aDogMTAwdnc7CiAgbWF4LWhlaWdodDogdmFyKC0tYWItY29uc29sZS1oZWlnaHQpOwogIGRpc3BsYXk6IGZsZXg7CiAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICBwYWRkaW5nOiAwOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICBiYWNrZHJvcC1maWx0ZXI6IGJsdXIoMTBweCkgYnJpZ2h0bmVzcygyMDAlKTsKICBhbmltYXRpb24tbmFtZTogc2xpZGUtYXBwLWluOwogIGFuaW1hdGlvbi1kdXJhdGlvbjogMC41czsKICBvdmVyZmxvdy15OiBoaWRkZW47CiAgei1pbmRleDogMTsKfQoKLmFiLWNvbnNvbGU6OmFmdGVyIHsKICBjb250ZW50OiAiIjsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgdG9wOiAwOwogIGxlZnQ6IDA7CiAgcmlnaHQ6IDA7CiAgYm90dG9tOiAwOwogIG9wYWNpdHk6IDAuOTsKICB6LWluZGV4OiAwOwp9CgpAa2V5ZnJhbWVzIHNsaWRlLWFwcC1pbiB7CiAgZnJvbSB7CiAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBjdWJpYy1iZXppZXIoLjYsMCwuNzksMS4wMyk7CiAgICAvKiB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoMTEwJSk7ICovCiAgICAvKiBoZWlnaHQ6IDBweDsgKi8KICAgIC8qIG1pbi1oZWlnaHQ6IDBweDsgKi8KICAgIG1heC1oZWlnaHQ6IDBweDsKICB9CgogIHRvIHsKICAgIG1heC1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsKICAgIC8qIG1pbi1oZWlnaHQ6IHZhcigtLWFiLWNvbnNvbGUtaGVpZ2h0KTsgKi8KICB9Cn0KCi5hYi1jb25zb2xlID4gZGl2IHsKICB6LWluZGV4OiAxOwogIHBvc2l0aW9uOiByZWxhdGl2ZQp9CgouYWItY29uc29sZS10b3AtYmFyIHsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICB3aWR0aDogMTAwJTsKICB0ZXh0LWFsaWduOiBjZW50ZXI7CiAgdXNlci1zZWxlY3Q6IG5vbmU7CiAgZGlzcGxheTogZmxleDsKICBhbGlnbi1pdGVtczogY2VudGVyOwogIGp1c3RpZnktY29udGVudDogZW5kOwogIHBhZGRpbmc6IDAuNXJlbTsKfQoKLmFiLWNvbnNvbGUtbG9nIHsKICBvdmVyZmxvdy15OiBhdXRvOwogIGZsZXgtZ3JvdzogMTsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW4tcmV2ZXJzZTsKICBtaW4taGVpZ2h0OiAyNHB4OwogIHBhZGRpbmc6IDAgMXJlbTsKICBjdXJzb3I6IHBvaW50ZXI7CiAgb3ZlcnNjcm9sbC1iZWhhdmlvcjogY29udGFpbjsKfQoKLmFiLWNvbnNvbGUtY29udGVudCB7CiAgY3Vyc29yOiBpbml0aWFsOwp9CgouYWItY29uc29sZS1tZXNzYWdlLWNvbnRhaW5lciB7CiAgbWFyZ2luOiAwLjVyZW0gMDsKfQouYWItY29uc29sZS1tZXNzYWdlIHsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiByb3c7CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICBnYXA6IDhweDsKfQoKLmFiLWNvbnNvbGUtc3BhY2VyIHsKICBmbGV4LXNocmluazogMDsKICBmbGV4LWdyb3c6IDE7Cn0KCi5hYi1jb25zb2xlLWNvbnRlbnQgewogIG1heC13aWR0aDogODB2dzsKICBib3JkZXItcmFkaXVzOiAwLjI1cmVtOwogIGJhY2tncm91bmQtY29sb3I6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKfQoKLmFiLWNvbnNvbGUtdGltZXN0YW1wIHsKICBvcGFjaXR5OiAwLjY7Cn0KCi5jb25zb2xlLXNlbmQtYnRuIHsKICBtYXJnaW46IDAgIWltcG9ydGFudDsKICBwYWRkaW5nOiAwIDFyZW0gIWltcG9ydGFudDsKICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1hYi1jb25zb2xlLWJnKTsKICBib3JkZXItcmFkaXVzOiA0cHg7Cn0KCi5jb25zb2xlLXNlbmQtYnRuID4gc3BhbiB7CiAgdHJhbnNmb3JtOiB0cmFuc2xhdGVZKDNweCkKfQoKLmFiLWNvbnNvbGUtaW5wdXQtY29udGFpbmVyIHsKICBkaXNwbGF5OiBmbGV4OwogIGZsZXgtZGlyZWN0aW9uOiByb3c7CiAgZ2FwOiAwLjc1cmVtOwogIG1hcmdpbjogMC41cmVtIDFyZW07CiAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKLmFiLWNvbnNvbGUtaW5wdXQtY29udGFpbmVyID4gaW5wdXQgewogIGJhY2tncm91bmQ6IHZhcigtLWFiLWNvbnNvbGUtYmcpOwogIGNvbG9yOiB2YXIoLS1vbi1hYi1jb25zb2xlLWJnKTsKICBmbGV4LWdyb3c6IDE7CiAgb3V0bGluZTogbm9uZTsKICBib3JkZXI6IG5vbmU7CiAgcGFkZGluZzogMXJlbTsKICBib3JkZXItcmFkaXVzOiA0cHg7Cn0nAIHU7PIPihcGZ2V0QXBwAgQAgdTs8g+9Ld0jQGNvbnN0IHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlUmVmIH0gPSBvcy5hcHBIb29rcwpjb25zdCBUb3BCYXIgPSB0aGlzQm90LlRvcEJhcigpOwpjb25zdCBNZXNzYWdlID0gdGhpc0JvdC5NZXNzYWdlKCk7Cgpjb25zdCBBcHAgPSAoKSA9PiB7CiAgICBjb25zdCBbcG9pbnRlckRvd25Qb3MsIHNldFBvaW50ZXJEb3duUG9zXSA9IHVzZVN0YXRlKHt4OiAtMSwgeTogLTF9KTsKICAgIGNvbnN0IFtjb25zb2xlTG9nLCBzZXRDb25zb2xlTG9nXSA9IHVzZVN0YXRlKFtdKTsKICAgIGNvbnN0IFtzaG93Q2hhdCwgc2V0U2hvd0NoYXRdID0gdXNlU3RhdGUodGFncy5zaG93Q2hhdElucHV0KTsKICAgIGNvbnN0IFt1c2VySW5wdXQsIHNldFVzZXJJbnB1dF0gPSB1c2VTdGF0ZSgnJyk7CiAgICBjb25zdCBbc2hvd0FsbCwgc2V0U2hvd0FsbF0gPSB1c2VTdGF0ZShmYWxzZSk7CiAgICBjb25zdCBpbnB1dFJlZiA9IHVzZVJlZigpOwoKICAgIGNvbnN0IHVwZGF0ZUxvZyA9ICgpID0+IHsKICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgYm90cyA9IHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzOwogICAgICAgIGNvbnN0IG1lc3NhZ2VMb2dBcnIgPSBbXTsKCiAgICAgICAgZm9yIChjb25zdCBib3RJRCBvZiBib3RzKSB7CiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VCb3QgPSBnZXRCb3QoImlkIiwgYm90SUQpOwogICAgICAgICAgICBpZiAobWVzc2FnZUJvdCkgewogICAgICAgICAgICAgICAgbWVzc2FnZUxvZ0Fyci5wdXNoKHsKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlQm90LnRhZ3MubWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG1lc3NhZ2VCb3QudGFncy50aW1lc3RhbXAsCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbWVzc2FnZUJvdC50YWdzLm5hbWUKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG1lc3NhZ2VMb2dBcnIuc29ydCggKGEsIGIpID0+IG5ldyBEYXRlKGEudGltZXN0YW1wKSA8IG5ldyBEYXRlKGIudGltZXN0YW1wKSA/IDEgOiAtMSApOwoKICAgICAgICBzZXRDb25zb2xlTG9nKG1lc3NhZ2VMb2dBcnIpOwogICAgfQoKICAgIHVzZUVmZmVjdCgoKSA9PiB7CiAgICAgICAgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZyA9IHVwZGF0ZUxvZzsKICAgICAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCA9IHNldFNob3dBbGw7CgogICAgICAgIHVwZGF0ZUxvZygpOwoKICAgICAgICByZXR1cm4gKCgpID0+IHsKICAgICAgICAgICAgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZyA9IG51bGw7CiAgICAgICAgICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsID0gbnVsbDsKICAgICAgICB9KTsKICAgIH0sIFtdKTsKCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGlmIChpbnB1dFJlZi5jdXJyZW50KSBpbnB1dFJlZi5jdXJyZW50LmZvY3VzKCk7CiAgICB9LCBbc2hvd0NoYXRdKTsKCiAgICBjb25zdCBoYW5kbGVQb2ludGVyRG93biA9IChlKSA9PiB7CiAgICAgICAgc2V0UG9pbnRlckRvd25Qb3MoewogICAgICAgICAgICB4OiBlLmNsaWVudFgsCiAgICAgICAgICAgIHk6IGUuY2xpZW50WSwKICAgICAgICB9KQogICAgfQoKICAgIGNvbnN0IGhhbmRsZVBvaW50ZXJVcCA9IChlKSA9PiB7CiAgICAgICAgY29uc3QgZGlmZlggPSBNYXRoLmFicyhlLmNsaWVudFggLSBwb2ludGVyRG93blBvcy54KTsKICAgICAgICBjb25zdCBkaWZmWSA9IE1hdGguYWJzKGUuY2xpZW50WSAtIHBvaW50ZXJEb3duUG9zLnkpOwoKICAgICAgICBpZiAoZGlmZlggPCA1ICYmIGRpZmZZIDwgNSkgewogICAgICAgICAgICBzZXRTaG93QWxsKHMgPT4gIXMpOwogICAgICAgIH0KCiAgICAgICAgc2V0UG9pbnRlckRvd25Qb3Moe3g6IC0xLCB5OiAtMX0pOwogICAgfQoKICAgIGNvbnN0IGhhbmRsZVN1Ym1pdCA9ICgpID0+IHsKICAgICAgICBpZiAodXNlcklucHV0KSB7CiAgICAgICAgICAgIHdoaXNwZXIoZ2V0Qm90KCdzeXN0ZW0nLCAnYWIuYWN0aW9uLmFzaycpLCAnYWJDb3JlTWVudUFjdGlvbicsIHVzZXJJbnB1dCkKICAgICAgICAgICAgc2V0VXNlcklucHV0KCcnKTsKICAgICAgICAgICAgY29uc29sZS5sb2coImlucHV0UmVmOiIsIGlucHV0UmVmLmN1cnJlbnQpOwogICAgICAgICAgICBpZiAoaW5wdXRSZWYuY3VycmVudCkgaW5wdXRSZWYuY3VycmVudC52YWx1ZSA9ICcnOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gKDw+CiAgICAgICAgPHN0eWxlPnt0YWdzWydBcHAuY3NzJ119PC9zdHlsZT4KCiAgICAgICAgPGRpdgogICAgICAgICAgICBpZD0iYWItY29uc29sZSIKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlIgogICAgICAgICAgICBvblBvaW50ZXJFbnRlcj17KGUpID0+IHsKICAgICAgICAgICAgICAgIGdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSBmYWxzZTsKICAgICAgICAgICAgfX0KICAgICAgICAgICAgb25Qb2ludGVyTGVhdmU9eyhlKSA9PiB7CiAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQuaWQgPT0gImFiLWNvbnNvbGUiKXsKICAgICAgICAgICAgICAgICAgICBncmlkUG9ydGFsQm90Lm1hc2tzLnBvcnRhbFpvb21hYmxlID0gdHJ1ZTsgCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH19CiAgICAgICAgPgogICAgICAgICAgICB7dGFncy5zaG93VG9wQmFyICYmIDxUb3BCYXIgLz59CgogICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbG9nIgogICAgICAgICAgICAgICAgb25Qb2ludGVyRG93bj17aGFuZGxlUG9pbnRlckRvd259CiAgICAgICAgICAgICAgICBvblBvaW50ZXJVcD17aGFuZGxlUG9pbnRlclVwfQogICAgICAgICAgICA+CiAgICAgICAgICAgICAgICB7LyogTWVzc2FnZSBoaXN0b3J5ICovIEFycmF5LmlzQXJyYXkoY29uc29sZUxvZykKICAgICAgICAgICAgICAgID8gc2hvd0FsbAogICAgICAgICAgICAgICAgICAgID8gY29uc29sZUxvZy5tYXAoKG0sIGkpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFtIHx8ICFtLnRpbWVzdGFtcCB8fCAhbS5tZXNzYWdlKSB7IHJldHVybiB9CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8TWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcD17bS50aW1lc3RhbXB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZT17bS5tZXNzYWdlfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU9e20ubmFtZX0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk9e2BtZXNzYWdlLSR7aX1gfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgICAgICAgICAgICAgKX0pCiAgICAgICAgICAgICAgICAgICAgOiA8TWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA9e2NvbnNvbGVMb2dbMF0/LnRpbWVzdGFtcH0KICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZT17Y29uc29sZUxvZ1swXT8ubWVzc2FnZX0KICAgICAgICAgICAgICAgICAgICAgICAgbmFtZT17Y29uc29sZUxvZ1swXT8ubmFtZX0KICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgOiA8PjwvPn0KCiAgICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgICAgICAgIHtzaG93Q2hhdCAmJgogICAgICAgICAgICAgICAgPGRpdgogICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1pbnB1dC1jb250YWluZXIiCiAgICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICAgICAgPGlucHV0CiAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyPSJhc2sgYWItMSIKICAgICAgICAgICAgICAgICAgICAgICAgb25DaGFuZ2U9e2UgPT4gc2V0VXNlcklucHV0KGUudGFyZ2V0LnZhbHVlKX0KICAgICAgICAgICAgICAgICAgICAgICAgb25LZXlEb3duPXtlID0+IHsgaWYgKGUua2V5ID09PSAnRW50ZXInKSBoYW5kbGVTdWJtaXQoKSB9fQogICAgICAgICAgICAgICAgICAgICAgICByZWY9e2lucHV0UmVmfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbgogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU9ImFiLWNvbnNvbGUtYnRuIGNvbnNvbGUtc2VuZC1idG4gbWQtaWNvbiBtZC1pY29uLWZvbnQiCiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9e2hhbmRsZVN1Ym1pdH0KICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogJzQwcHgnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6ICc0OHB4JywKICAgICAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgICAgICA+c2VuZDwvYnV0dG9uPgogICAgICAgICAgICAgICAgPC9kaXY+fQogICAgICAgIDwvZGl2PgogICAgPC8+KQp9CgpyZXR1cm4gQXBwCicAgdTs8g+KFwtoaWRlQ29uc29sZQIEAIHU7PIPm1GfAUB2YXIgY3VycmVudFZlciA9IG1hc2tzLmNvbnNvbGVWZXJzaW9uID8/IDA7CmF3YWl0IG9zLnVucmVnaXN0ZXJBcHAoYGFiLWNvbnNvbGUtJHtjdXJyZW50VmVyfWApOwptYXNrcy5vcGVuID0gZmFsc2U7CmdyaWRQb3J0YWxCb3QubWFza3MucG9ydGFsWm9vbWFibGUgPSBudWxsOycAgdTs8g+KFwNsb2cCBACB1OzyD7tS5AhAbGV0IGJvdFRhZ3MgPSB7fTsKCmNvbnN0IF90aW1lc3RhbXAgPSBvcy5pc0NvbGxhYm9yYXRpdmUoKSA/IG9zLmFncmVlZFVwb25UaW1lIDogb3MubG9jYWxUaW1lCgppZiAodHlwZW9mIHRoYXQgPT09ICdzdHJpbmcnKSB7CiAgICBjb25zdCBfbWVzc2FnZVRleHQgPSBTdHJpbmcodGhhdCkuc3BsaXQoJzogJyk7CiAgICBjb25zdCBfbmFtZSA9IF9tZXNzYWdlVGV4dC5zaGlmdCgpOwoKICAgIGlmICghdGhhdC5pbmNsdWRlcygnOiAnKSkgewogICAgICAgIGJvdFRhZ3MgPSB7CiAgICAgICAgICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgICAgICAgICAgbmFtZTogIiIsCiAgICAgICAgICAgIG1lc3NhZ2U6IHRoYXQsCiAgICAgICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgICAgICBjb25zb2xlTG9nTWVzc2FnZUJvdDogdHJ1ZSwKICAgICAgICAgICAgdGltZXN0YW1wOiBfdGltZXN0YW1wLAogICAgICAgICAgICBjbGVhckNvbnNvbGVMb2dCb3RzOiAiQGRlc3Ryb3kodGhpcykiCiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBib3RUYWdzID0gewogICAgICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgICAgIG5hbWU6IF9uYW1lLAogICAgICAgICAgICBtZXNzYWdlOiBfbWVzc2FnZVRleHQuam9pbignOiAnKSwKICAgICAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgICAgIGNvbnNvbGVMb2dNZXNzYWdlQm90OiB0cnVlLAogICAgICAgICAgICB0aW1lc3RhbXA6IF90aW1lc3RhbXAsCiAgICAgICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIKICAgICAgICB9CiAgICB9Cgp9IGVsc2UgewogICAgYm90VGFncyA9IHsKICAgICAgICBzcGFjZTogInRlbXBMb2NhbCIsCiAgICAgICAgYWJJZ25vcmU6IHRydWUsCiAgICAgICAgY29uc29sZUxvZ01lc3NhZ2VCb3Q6IHRydWUsCiAgICAgICAgdGltZXN0YW1wOiBfdGltZXN0YW1wLAogICAgICAgIGNsZWFyQ29uc29sZUxvZ0JvdHM6ICJAZGVzdHJveSh0aGlzKSIsCiAgICAgICAgLi4udGhhdAogICAgfQp9Cgpjb25zdCBsb2dCb3QgPSBjcmVhdGUoYm90VGFncyk7CgppZiAodGhpc0JvdC52YXJzLnVwZGF0ZUxvZykgdGhpc0JvdC52YXJzLnVwZGF0ZUxvZygpOycAgdTs8g+KFwtzaG93Q29uc29sZQIEAIHU7PIPoFvtA0BpZiAobWFza3Mub3BlbikgeyByZXR1cm4gfTsKCmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwpjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwoKLy8gVW5yZWdpc3RlciBpbiBjYXNlIGl0IHdhcyBhbHJlYWR5IG9wZW4KdmFyIGN1cnJlbnRWZXIgPSBtYXNrcy5jb25zb2xlVmVyc2lvbiA/PyAwOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gKTsKCmN1cnJlbnRWZXIgKz0gMTsKbWFza3MuY29uc29sZVZlcnNpb24gPSBjdXJyZW50VmVyOwovLyBHZXQsIHJlZ2lzdGVyLCBhbmQgY29tcGlsZSB0aGUgYXBwCmNvbnN0IEFwcCA9IHRoaXNCb3QuZ2V0QXBwKCk7CmF3YWl0IG9zLnJlZ2lzdGVyQXBwKGBhYi1jb25zb2xlLSR7Y3VycmVudFZlcn1gLCB0aGlzQm90KTsKb3MuY29tcGlsZUFwcChgYWItY29uc29sZS0ke2N1cnJlbnRWZXJ9YCwgPEFwcCAvPik7Cm1hc2tzLm9wZW4gPSB0cnVlOwonAIHU7PIPihcGc3lzdGVtAgQAgdTs8g+OXxBhYi5zaGVsbC5jb25zb2xlJwCB1OzyD4oXDXRvZ2dsZUNvbnNvbGUCBACB1OzyD59flgFAaWYgKG1hc2tzLm9wZW4pIHsKICAgIHdoaXNwZXIodGhpc0JvdCwgImhpZGVDb25zb2xlIik7CiAgICBtYXNrcy5vcGVuID0gZmFsc2U7Cn0gZWxzZSB7CiAgICB3aGlzcGVyKHRoaXNCb3QsICJzaG93Q29uc29sZSIpOwogICAgbWFza3Mub3BlbiA9IHRydWU7Cn0nAIHU7PIPihcEZm9ybQIEAIHU7PIPtmAHbm90aGluZycAgdTs8g+KFwdhYlNoZWxsAgQAgdTs8g++YAR0cnVlJwCB1OzyD4oXCmFiSURPcmlnaW4CBACB1OzyD8NgFWFiQ29uc29sZSB1cGRhdGUgNy0xNicAgdTs8g+KFwZUb3BCYXICBACB1OzyD9lg8wRAY29uc3Qgb2Zmc2V0ID0gOApjb25zdCBpbml0aWFsSGVpZ2h0ID0gMjU2CmNvbnN0IGRyYWdJbnRlcnZhbCA9IDI1Cgpjb25zdCBCdXR0b25zQmFyID0gKCkgPT4gewoKICAgIGNvbnN0IGhhbmRsZUNsb3NlID0gKCkgPT4gewogICAgICAgIHNob3V0KCdoaWRlQ29uc29sZScpOwogICAgfQoKICAgIHJldHVybiAoPD4KICAgICAgICA8ZGl2CiAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS10b3AtYmFyIgogICAgICAgID4KCiAgICAgICAgICAgIDxidXR0b24KICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iYWItY29uc29sZS1idG4gbWQtaWNvbiBtZC1pY29uLWZvbnQiCiAgICAgICAgICAgICAgICBvbkNsaWNrPXtoYW5kbGVDbG9zZX0KICAgICAgICAgICAgICAgIHN0eWxlPXt7CiAgICAgICAgICAgICAgICAgICAgdG9wOiAiOHB4IiwKICAgICAgICAgICAgICAgICAgICByaWdodDogIjhweCIsCiAgICAgICAgICAgICAgICAgICAgekluZGV4OiAyLAogICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgY2xvc2UKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIAogICAgICAgIDwvZGl2PgogICAgPC8+KQp9CgpyZXR1cm4gQnV0dG9uc0JhcgonAIHU7PIPihcNc2hvd0NoYXRJbnB1dAIEAIHU7PIPzWUFZmFsc2UoAIHU7PIPihcKc2hvd1RvcEJhcgF5JwCB1OzyD4oXCWFiVmVyc2lvbgIEAIHU7PIP1GUEMTAuNCcAgdTs8g+KFxJzZXRBYkV4cGFuZENvbnNvbGUCBACB1OzyD9lllwJAY29uc29sZS5sb2codGhpc0JvdC52YXJzLnNldFNob3dBbGwpCmlmICh0eXBlb2YgdGhpc0JvdC52YXJzLnNldFNob3dBbGwgIT09ICdmdW5jdGlvbicpIHsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQgPT09IHVuZGVmaW5lZCkgewogICAgdGhpc0JvdC52YXJzLnNldFNob3dBbGwocyA9PiAhcyk7Cn0gZWxzZSBpZiAodGhhdCA9PSB0cnVlKSB7CiAgICB0aGlzQm90LnZhcnMuc2V0U2hvd0FsbCh0cnVlKTsKfSBlbHNlIHsKICAgIHRoaXNCb3QudmFycy5zZXRTaG93QWxsKGZhbHNlKTsKfQonAIHU7PIPihcIYWJJZ25vcmUCBACB1OzyD/FnBHRydWUnAIHU7PIPihcHTWVzc2FnZQIEAIHU7PIP9mfnEEBjb25zdCB7IHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VFZmZlY3QgfSA9IG9zLmFwcEhvb2tzCmNvbnN0IFRvcEJhciA9IHRoaXNCb3QuVG9wQmFyKCkKCmNvbnN0IE1lc3NhZ2UgPSAoeyB0aW1lc3RhbXAsIG1lc3NhZ2UsIG5hbWUgfSkgPT4gewogICAgY29uc3QgW3Nob3dUaW1lLCBzZXRTaG93VGltZV0gPSB1c2VTdGF0ZShmYWxzZSk7CiAgICBjb25zdCBbdXNlck1lc3NhZ2UsIHNldFVzZXJNZXNzYWdlXSA9IHVzZVN0YXRlKGZhbHNlKTsKCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGlmIChhdXRoQm90ICYmIGF1dGhCb3QudGFncy5uYW1lKSB7CiAgICAgICAgICAgIGlmIChhdXRoQm90LnRhZ3MubmFtZSA9PSBuYW1lKSB7CiAgICAgICAgICAgICAgICBzZXRVc2VyTWVzc2FnZSh0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChtYXNrcy5wcmVmZXJyZWROYW1lKSB7CiAgICAgICAgICAgICAgICBpZiAobWFza3MucHJlZmVycmVkTmFtZSA9PSBuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VXNlck1lc3NhZ2UodHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfSAKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKG5hbWUgPT0gInVzZXIiIHx8IG5hbWUgPT0gIlVzZXIiKSB7CiAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKHRydWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldFVzZXJNZXNzYWdlKGZhbHNlKTsKICAgICAgICB9CgogICAgfSwgW25hbWVdKQoKICAgIGNvbnN0IHRpbWVUZXh0ID0gdXNlTWVtbygKICAgICAgICAoKSA9PiB7CiAgICAgICAgICAgIGlmICghdGltZXN0YW1wKSB7IHJldHVybiB9CiAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh0aW1lc3RhbXApLnRvTG9jYWxlU3RyaW5nKAogICAgICAgICAgICAgICAgICAgJ2VuLXVzJywge3RpbWVTdHlsZTogJ21lZGl1bSd9KX0sCiAgICAgICAgW3RpbWVzdGFtcF0KICAgICk7CgogICAgaWYgKCF0aW1lc3RhbXAgfHwgIW1lc3NhZ2UpIHsgcmV0dXJuIDw+PC8+IH0KCiAgICByZXR1cm4gKAogICAgICAgIDxkaXYKICAgICAgICAgICAgY2xhc3NOYW1lPSJhYi1jb25zb2xlLW1lc3NhZ2UtY29udGFpbmVyIgogICAgICAgICAgICBvblBvaW50ZXJFbnRlcj17KCkgPT4gc2V0U2hvd1RpbWUodHJ1ZSl9CiAgICAgICAgICAgIG9uUG9pbnRlckxlYXZlPXsoKSA9PiBzZXRTaG93VGltZShmYWxzZSl9CiAgICAgICAgPgogICAgICAgICAgICA8ZGl2CiAgICAgICAgICAgICAgICBzdHlsZT17dXNlck1lc3NhZ2UgJiYge3RleHRBbGlnbjogJ3JpZ2h0J319CiAgICAgICAgICAgID4KICAgICAgICAgICAgICAgIHtuYW1lfQogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtbWVzc2FnZSIgc3R5bGU9e3sKICAgICAgICAgICAgICAgIGZsZXhEaXJlY3Rpb246IHVzZXJNZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdyb3cnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdyb3ctcmV2ZXJzZScKICAgICAgICAgICAgfX0+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWItY29uc29sZS1zcGFjZXIiCiAgICAgICAgICAgICAgICAgICAgc3R5bGU9e3sKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dEFsaWduOiB1c2VyTWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ3JpZ2h0JwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogJ2xlZnQnLAogICAgICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiBzaG93VGltZSA/IDAuNiA6IDAKICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgPgogICAgICAgICAgICAgICAgICAgIHt0aW1lVGV4dH0KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFiLWNvbnNvbGUtY29udGVudCI+CiAgICAgICAgICAgICAgICAgICAge21lc3NhZ2V9CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICApCn0KCnJldHVybiBNZXNzYWdlOycAgdTs8g+KFxBvbkFueUJvdHNSZW1vdmVkAgQAgdTs8g/eeK0CQGNvbnN0IHsgYm90SURzIH0gPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IGJvdElkIG9mIGJvdElEcykgew0KICAgIGlmICh0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcykgew0KICAgICAgICBjb25zdCBkZWxldGVkID0gdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuZGVsZXRlKGJvdElkKTsNCg0KICAgICAgICBpZiAoZGVsZXRlZCkgew0KICAgICAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdFJlbW92ZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90SWQ6IGJvdElkIH0pOw0KICAgICAgICB9DQogICAgfQ0KfScAgdTs8g+KFw5vbkFueUJvdHNBZGRlZAIEAIHU7PIPjHv4A0Bjb25zdCB7IGJvdHMgfSA9IHRoYXQ7DQoNCmZvciAoY29uc3QgbmV3Qm90IG9mIGJvdHMpIHsNCiAgICBpZiAobmV3Qm90LnRhZ3MuY29uc29sZUxvZ01lc3NhZ2VCb3QgPT09IHRydWUpIHsNCiAgICAgICAgLy8gSW5pdCBtZXNzYWdlIGJvdCBpZCB0cmFja2luZyBzZXQgaWYgbmVlZGVkLg0KICAgICAgICBpZiAoIXRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzKSB7DQogICAgICAgICAgICB0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcyA9IG5ldyBTZXQoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMuaGFzKG5ld0JvdC5pZCkpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmFkZChuZXdCb3QuaWQpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBzaG91dCgnb25BQkNvbnNvbGVMb2dNZXNzYWdlQm90QWRkZWQnLCB7IGNvbnNvbGVMb2dNZXNzYWdlQm90OiBuZXdCb3QgfSk7DQogICAgfQ0KfScAgdTs8g+KFxBvbkFueUJvdHNDaGFuZ2VkAgQAgdTs8g+Ff+MFQGNvbnN0IGJvdHMgPSB0aGF0Ow0KDQpmb3IgKGNvbnN0IGJvdCBvZiBib3RzKSB7DQogICAgaWYgKGJvdC5ib3QudGFncy5jb25zb2xlTG9nTWVzc2FnZUJvdCA9PT0gdHJ1ZSkgew0KICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYm90IGlkIHRyYWNraW5nIHNldCBpZiBuZWVkZWQuDQogICAgICAgIGlmICghdGhpc0JvdC52YXJzLm1lc3NhZ2VCb3RJZHMpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzID0gbmV3IFNldCgpOw0KICAgICAgICB9DQoNCiAgICAgICAgaWYgKCF0aGlzQm90LnZhcnMubWVzc2FnZUJvdElkcy5oYXMoYm90LmJvdC5pZCkpIHsNCiAgICAgICAgICAgIHRoaXNCb3QudmFycy5tZXNzYWdlQm90SWRzLmFkZChib3QuYm90LmlkKTsNCg0KICAgICAgICAgICAgc2hvdXQoJ29uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkJywgeyBjb25zb2xlTG9nTWVzc2FnZUJvdDogYm90LmJvdCB9KTsNCiAgICAgICAgfSANCg0KICAgICAgICBpZiAoYm90LnRhZ3MuaW5jbHVkZXMoIm1lc3NhZ2UiKSB8fCBib3QudGFncy5pbmNsdWRlcygibmFtZSIpIHx8IGJvdC50YWdzLmluY2x1ZGVzKCJ0aW1lc3RhbXAiKSB8fCBib3QudGFncy5pbmNsdWRlcygiY29uc29sZUxvZ01lc3NhZ2VCb3QiKSkgew0KICAgICAgICAgICAgaWYgKHRoaXNCb3QudmFycy51cGRhdGVMb2cpIHRoaXNCb3QudmFycy51cGRhdGVMb2coKTsgICAgICAgIA0KICAgICAgICB9DQogICAgfQ0KfScAgdTs8g+KFx9vbkFCQ29uc29sZUxvZ01lc3NhZ2VCb3RSZW1vdmVkAgQAgdTs8g/phAE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwCB1OzyD4oXHW9uQUJDb25zb2xlTG9nTWVzc2FnZUJvdEFkZGVkAgQAgdTs8g+ghQE2QGlmICh0aGlzQm90LnZhcnMudXBkYXRlTG9nKSB0aGlzQm90LnZhcnMudXBkYXRlTG9nKCk7JwEEYm90cyQyNGRjMDQzMS1mZmJiLTQ0OGQtYWE3NS05NzFiYWEwNzE4ZGMBJwCB1OzyD9eFAQZzeXN0ZW0CBACB1OzyD9iFAQ1hYi5zaGVsbC5oZWxwJwCB1OzyD9eFAQlvbktleURvd24CBACB1OzyD+aFAYwCQGlmICh0YWdzLmhlbHBBY3RpdmUgJiYgdGhhdC5rZXlzLmluY2x1ZGVzKCdFc2NhcGUnKSkgewogICAgaWYgKHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzKSB7CiAgICAgICAgZm9yIChsZXQgY2FsbGJhY2sgb2YgdGhpc0JvdC52YXJzLm9uRXNjYXBlS2V5UHJlc3MpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfScAgdTs8g/XhQEHdW5tb3VudAIEAIHU7PIP84cBoAFAYXdhaXQgb3MuY29tcGlsZUFwcCgnYWItY29tbWFuZC1oZWxwJywgPD48Lz4pOwphd2FpdCBvcy51bnJlZ2lzdGVyQXBwKCdhYi1jb21tYW5kLWhlbHAnKTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gdW5kZWZpbmVkOwptYXNrcy5oZWxwQWN0aXZlID0gZmFsc2U7JwCB1OzyD9eFAQlzdHlsZS5jc3MCBACB1OzyD5SJAfEHLmhlbHAtdGFibGUgewogIHdpZHRoOiAxMDAlOwogIGJvcmRlci1zcGFjaW5nOiAwOwp9CgouaGVscC10YWJsZSB0ZCB7CiAgdmVydGljYWwtYWxpZ246IHRvcDsKICBwYWRkaW5nLWJvdHRvbTogOHB4OwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKfQoKLmhlbHAtdGFibGUgdGQgaDMgewogIG1hcmdpbjogMDsKfQoKLmhlbHAtdGFibGUgdGQ6Zmlyc3QtY2hpbGQgewogIG1pbi13aWR0aDogOTBweDsKICBwYWRkaW5nLXJpZ2h0OiA4cHg7Cn0KCi5zZWN0aW9uIHsKICBtYXJnaW4tdG9wOiAxNnB4Owp9Cgouc2VjdGlvbiBwOmZpcnN0LW9mLXR5cGUgewogIG1hcmdpbi10b3A6IDRweDsKICBtYXJnaW4tbGVmdDogMTZweDsKfQoKLmRlc2NyaXB0aW9uIHsgCiAgd2hpdGUtc3BhY2U6IHByZS1saW5lOwp9CgoudXNhZ2UtdGFibGUgewogIGJvcmRlci1zcGFjaW5nOiAwOwp9CgoudXNhZ2UtdGFibGUgdGQsaDMgeyAKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHdoaXRlLXNwYWNlOiBwcmUtd3JhcDsKICBtYXJnaW46IDA7Cn0KCi51c2FnZS10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA2MHB4Owp9CgouYXJncy10YWJsZSB7CiAgbWFyZ2luLWxlZnQ6IDE2cHg7Cn0KCi5hcmdzLXRhYmxlIHRkIHsKICB2ZXJ0aWNhbC1hbGlnbjogdG9wOwogIHBhZGRpbmctYm90dG9tOiA4cHg7CiAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwp9CgouYXJncy10YWJsZSB0ZDpmaXJzdC1jaGlsZCB7CiAgbWluLXdpZHRoOiA5MHB4OwogIHBhZGRpbmctcmlnaHQ6IDhweDsKfQoKQG1lZGlhIChtYXgtd2lkdGg6IDY0MHB4KSwgKG1heC1oZWlnaHQ6IDYwMHB4KSB7CiAgLmhlbHAtd2luZG93IHsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgbGVmdDogdW5zZXQ7CiAgICB0b3A6IHVuc2V0OwogICAgdHJhbnNmb3JtOiB1bnNldDsKICAgIG1heC13aWR0aDogdW5zZXQ7CiAgICBtYXgtaGVpZ2h0OiB1bnNldDsKICAgIGJveC1zaGFkb3c6IHVuc2V0OwogIH0KfScAgdTs8g/XhQEJb25EZXN0cm95AgQAgdTs8g+GkQETQHRoaXNCb3QudW5tb3VudCgpOycAgdTs8g/XhQEFbW91bnQCBACB1OzyD5qRAZMDQGNvbnN0IHsKICAgIGFiQ29tbWFuZHNNYW5hZ2VyLAogICAgc2VsZWN0ZWRDb21tYW5kCn0gPSB0aGF0ID8/IHt9OwoKaWYgKG1hc2tzLmhlbHBBY3RpdmUpIHsKICAgIGF3YWl0IHRoaXNCb3QudW5tb3VudCgpOwp9Cgpjb25zdCBIZWxwQXBwID0gdGhpc0JvdC5IZWxwQXBwKCk7Cgphd2FpdCBvcy5yZWdpc3RlckFwcCgnYWItY29tbWFuZC1oZWxwJywgdGhpc0JvdCk7CmF3YWl0IG9zLmNvbXBpbGVBcHAoJ2FiLWNvbW1hbmQtaGVscCcsIDxIZWxwQXBwIGNvbW1hbmRzPXthYkNvbW1hbmRzTWFuYWdlci5jb21tYW5kc30gaW5pdGlhbFNlbGVjdGVkQ29tbWFuZD17c2VsZWN0ZWRDb21tYW5kfS8+KTsKCnRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzID0gW107Cm1hc2tzLmhlbHBBY3RpdmUgPSB0cnVlOycAgdTs8g/XhQEHSGVscEFwcAIEAIHU7PIPrpQBui9AY29uc3QgQXBwQ29udGFpbmVyID0gbGlua3MuY29tcG9uZW50cy5BcHBDb250YWluZXIoKTsKY29uc3QgV2luZG93ID0gbGlua3MuY29tcG9uZW50cy5XaW5kb3coKTsKY29uc3QgVGV4dExpbmsgPSBsaW5rcy5jb21wb25lbnRzLlRleHRMaW5rKCk7CmNvbnN0IGNzcyA9IGxpbmtzLnV0aWxzLmFiQ29tcGlsZUNTUyhbIHRoaXNCb3QsIGxpbmtzLmNvbXBvbmVudHMgXSk7Cgpjb25zdCB7IHVzZVN0YXRlLCB1c2VFZmZlY3QsIHVzZUNhbGxiYWNrLCB1c2VSZWYsIHVzZU1lbW8gfSA9IG9zLmFwcEhvb2tzOwoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBDb21tYW5kPn0gcHJvcHMuY29tbWFuZHMKICovCmNvbnN0IEF2YWlsYWJsZUNvbW1hbmRzID0gKHsgY29tbWFuZHMsIG9uQ29tbWFuZENsaWNrIH0pID0+IHsKICAgIGNvbnN0IGNvbW1hbmROYW1lcyA9IE9iamVjdC5rZXlzKGNvbW1hbmRzKS5zb3J0KCk7CgogICAgY29uc3Qgb25DbG9zZSA9IHVzZUNhbGxiYWNrKCgpID0+IHsKICAgICAgICB0aGlzQm90LnVubW91bnQoKTsKICAgIH0sIFtdKTsKICAgIAogICAgcmV0dXJuICgKICAgICAgICA8PgogICAgICAgICAgICA8cD48VGV4dExpbmsgb25DbGljaz17b25DbG9zZX0+eyd4IENsb3NlJ308L1RleHRMaW5rPjwvcD4KICAgICAgICAgICAgPGgyPkF2YWlsYWJsZSBDb21tYW5kczwvaDI+CiAgICAgICAgICAgIDxwPlVzYWdlOiAuY29tbWFuZCBbb3B0aW9uc108L3A+CiAgICAgICAgICAgIDxici8+CiAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2hlbHAtdGFibGUnPgogICAgICAgICAgICAgICAge2NvbW1hbmROYW1lcy5tYXAoKG5hbWUpID0+IHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21tYW5kID0gY29tbWFuZHNbbmFtZV07CgogICAgICAgICAgICAgICAgICAgIGxldCBkZXNjcmlwdGlvbiA9IG51bGw7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb21tYW5kLmhlbHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXNjcmlwdGlvbiA9IGNvbW1hbmQuaGVscC5zaG9ydERlc2NyaXB0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48VGV4dExpbmsgb25DbGljaz17KCkgPT4gb25Db21tYW5kQ2xpY2soY29tbWFuZC5uYW1lKX0+e2NvbW1hbmQubmFtZX08L1RleHRMaW5rPjwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2Rlc2NyaXB0aW9ufTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgfSl9CiAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgPC8+CiAgICApCn0KCi8qKgogKiBAcGFyYW0ge09iamVjdH0gcHJvcHMKICogQHBhcmFtIHtDb21tYW5kfSBwcm9wcy5jb21tYW5kCiAqLwpjb25zdCBTcGVjaWZpY0NvbW1hbmQgPSAoeyBjb21tYW5kLCBvbkJhY2sgfSkgPT4gewogICAgbGV0IHVzYWdlID0gJyc7CiAgICBsZXQgZGVzY3JpcHRpb24gPSBudWxsOwogICAgbGV0IGFyZ3MgPSBudWxsOwoKICAgIGlmIChjb21tYW5kLmhlbHApIHsKICAgICAgICBpZiAoY29tbWFuZC5oZWxwLnVzYWdlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGNvbW1hbmQuaGVscC51c2FnZSkpIHsKICAgICAgICAgICAgICAgIHVzYWdlID0gY29tbWFuZC5oZWxwLnVzYWdlLmpvaW4oJ1xuJyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB1c2FnZSA9IGNvbW1hbmQuaGVscC51c2FnZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5sb25nRGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAubG9uZ0Rlc2NyaXB0aW9uOwogICAgICAgIH0gZWxzZSBpZiAoY29tbWFuZC5oZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgZGVzY3JpcHRpb24gPSBjb21tYW5kLmhlbHAuc2hvcnREZXNjcmlwdGlvbjsKICAgICAgICB9CgogICAgICAgIGlmIChjb21tYW5kLmhlbHAuYXJncyAmJiBjb21tYW5kLmhlbHAuYXJncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGFyZ3MgPSBjb21tYW5kLmhlbHAuYXJnczsKICAgICAgICB9CiAgICB9CiAgICAKICAgIHJldHVybiAoCiAgICAgICAgPD4gIAogICAgICAgICAgICA8cD48VGV4dExpbmsgb25DbGljaz17b25CYWNrfT57JzwgQmFjayd9PC9UZXh0TGluaz48L3A+CiAgICAgICAgICAgIDxoMj57Y29tbWFuZC5uYW1lfTwvaDI+CiAgICAgICAgICAgIHsgdXNhZ2UgJiYKICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J3VzYWdlLXRhYmxlJz4KICAgICAgICAgICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48aDM+VXNhZ2U6PC9oMz48L3RkPgogICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e3VzYWdlfTwvdGQ+CiAgICAgICAgICAgICAgICAgICAgPC90cj4KICAgICAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeyBkZXNjcmlwdGlvbiAmJiAKICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSdzZWN0aW9uJz4KICAgICAgICAgICAgICAgICAgICA8aDM+RGVzY3JpcHRpb246PC9oMz4KICAgICAgICAgICAgICAgICAgICA8cCBjbGFzc05hbWU9J2Rlc2NyaXB0aW9uJz57ZGVzY3JpcHRpb259PC9wPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIH0KICAgICAgICAgICAgeyBhcmdzICYmCiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0nc2VjdGlvbic+CiAgICAgICAgICAgICAgICAgICAgPGgzPkFyZ3VtZW50czo8L2gzPgogICAgICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzc05hbWU9J2FyZ3MtdGFibGUnPgogICAgICAgICAgICAgICAgICAgICAgICB7IGFyZ3MubWFwKChhcmcpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXJnLmlkZW50aWZpZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBhcmdEZXNjcmlwdGlvbkRpc3BsYXkgPSBudWxsOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFyZy5pZGVudGlmaWVyKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gYXJnLmlkZW50aWZpZXIuam9pbignLFxuJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0lkZW50aWZpZXJEaXNwbGF5ID0gYXJnLmlkZW50aWZpZXI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZy5kZXNjcmlwdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ0Rlc2NyaXB0aW9uRGlzcGxheSA9IGFyZy5kZXNjcmlwdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPnthcmdJZGVudGlmaWVyRGlzcGxheSA/PyAnJ308L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+e2FyZ0Rlc2NyaXB0aW9uRGlzcGxheSA/PyAnJ308L3RkPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIH0pfQogICAgICAgICAgICAgICAgICAgIDwvdGFibGU+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgfQogICAgICAgICAgICA8YnIvPgogICAgICAgICAgICA8dGFibGUgY2xhc3NOYW1lPSdoZWxwLXRhYmxlJz4KICAgICAgICAgICAgPC90YWJsZT4KICAgICAgICA8Lz4KICAgICkKfQoKLyoqCiAqIEBwYXJhbSB7T2JqZWN0fSBwcm9wcwogKiBAcGFyYW0ge09iamVjdC48c3RyaW5nLCBDb21tYW5kPn0gcHJvcHMuY29tbWFuZHMKICogQHBhcmFtIHthbnlbXX0gW3Byb3BzLmFyZ3NdCiAqLwpjb25zdCBIZWxwQXBwID0gKHsgY29tbWFuZHMsIGluaXRpYWxTZWxlY3RlZENvbW1hbmQgfSkgPT4gewogICAgY29uc3QgWyBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZCBdID0gdXNlU3RhdGUoaW5pdGlhbFNlbGVjdGVkQ29tbWFuZCk7CgogICAgLy8gRXNjYXBlIGtleSBwcmVzcyBldmVudCBoYW5kbGVyCiAgICB1c2VFZmZlY3QoKCkgPT4gewogICAgICAgIGNvbnN0IG9uRXNjYXBlS2V5UHJlc3MgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmIChzZWxlY3RlZENvbW1hbmQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnB1c2gob25Fc2NhcGVLZXlQcmVzcyk7CgogICAgICAgIHJldHVybiAoKSA9PiB7CiAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrSW5kZXggPSB0aGlzQm90LnZhcnMub25Fc2NhcGVLZXlQcmVzcy5maW5kSW5kZXgoKGNhbGxiYWNrKSA9PiBjYWxsYmFjayA9PT0gb25Fc2NhcGVLZXlQcmVzcyk7CiAgICAgICAgICAgIGlmIChjYWxsYmFja0luZGV4ID49IDApIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5vbkVzY2FwZUtleVByZXNzLnNwbGljZShjYWxsYmFja0luZGV4LCAxKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sIFtzZWxlY3RlZENvbW1hbmRdKTsKICAgIAogICAgY29uc3Qgb25CYWNrZ3JvdW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygoKSA9PiB7CiAgICAgICAgdGhpc0JvdC51bm1vdW50KCk7CiAgICB9LCBbXSk7CgogICAgY29uc3Qgb25Db21tYW5kQ2xpY2sgPSB1c2VDYWxsYmFjaygobmFtZSkgPT4gewogICAgICAgIHNldFNlbGVjdGVkQ29tbWFuZChuYW1lKTsKICAgIH0sIFtzZXRTZWxlY3RlZENvbW1hbmRdKQoKICAgIGNvbnN0IGNvbnRlbnQgPSB1c2VNZW1vKCgpID0+IHsKICAgICAgICBpZiAoIXNlbGVjdGVkQ29tbWFuZCkgewogICAgICAgICAgICByZXR1cm4gPEF2YWlsYWJsZUNvbW1hbmRzIGNvbW1hbmRzPXtjb21tYW5kc30gb25Db21tYW5kQ2xpY2s9e29uQ29tbWFuZENsaWNrfS8+CiAgICAgICAgfSBlbHNlIHsgCiAgICAgICAgICAgIHJldHVybiA8U3BlY2lmaWNDb21tYW5kIGNvbW1hbmQ9e2NvbW1hbmRzW3NlbGVjdGVkQ29tbWFuZF19IG9uQmFjaz17KCkgPT4gc2V0U2VsZWN0ZWRDb21tYW5kKG51bGwpfS8+CiAgICAgICAgfQogICAgfSwgW2NvbW1hbmRzLCBzZWxlY3RlZENvbW1hbmQsIHNldFNlbGVjdGVkQ29tbWFuZF0pOwoKICAgIHJldHVybiAoCiAgICAgICAgPD4KICAgICAgICAgICAgPHN0eWxlPntjc3N9PC9zdHlsZT4KCiAgICAgICAgICAgIDxBcHBDb250YWluZXIgb25CYWNrZ3JvdW5kQ2xpY2s9e29uQmFja2dyb3VuZENsaWNrfT4KICAgICAgICAgICAgICAgIDxXaW5kb3c+CiAgICAgICAgICAgICAgICAgICAge2NvbnRlbnR9CiAgICAgICAgICAgICAgICA8L1dpbmRvdz4KICAgICAgICAgICAgPC9BcHBDb250YWluZXI+CiAgICAgICAgPC8+CiAgICApCn0KCnJldHVybiBIZWxwQXBwOycAgdTs8g/XhQEKY29tcG9uZW50cwIEAIHU7PIP6cMBKPCflJcxMWM5NWM3ZC1hMTkzLTQwMGUtYjcxMC0zYmEwNDg2YTZhMWEnAIHU7PIP14UBBXV0aWxzAgQAgdTs8g+QxAEo8J+UlzkzZDk2NWUwLWQyMGUtNGI0NS04Y2EwLTY0OTI3M2I3MTM4YycAgdTs8g/XhQEIYWJJZ25vcmUCBACB1OzyD7fEAQR0cnVlJwCB1OzyD9eFAQdhYlNoZWxsAgQAgdTs8g+8xAEEdHJ1ZScAgdTs8g/XhQEJYWJWZXJzaW9uAgQAgdTs8g/BxAEEMTAuNCcBBGJvdHMkMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczAScAgdTs8g/GxAEGc3lzdGVtAgQAgdTs8g/HxAEPYWIuc2hlbGwuY3JlYXRlJwCB1OzyD8bEAQRmb3JtAgQAgdTs8g/XxAEHbm90aGluZycAgdTs8g/GxAELZGVzY3JpcHRpb24CBACB1OzyD9/EAT1Cb3QgdXNlZCB0byBjcmVhdGUvbWFuaWZlc3QgYm90cyBpbnRvIGFuIGFjdHVhbCBzY2VuZS9wb3J0YWwuJwCB1OzyD8bEAQxhYkNyZWF0ZUJvdHMCBACB1OzyD53FAd0iQGxldCB7IAogICAgaW5pdGlhbEJvb3QsIC8vIGNoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4gKG9wdGlvbmFsKQogICAgYm90RGF0YSwgLy8gYm90cyB0byBiZSBnZW5lcmF0ZWQKICAgIG9yaWdpbiwgLy8gd2hlcmUgZGlkIHRoZSBkYXRhIGNvbWUgZnJvbSAob3B0aW9uYWwpCiAgICBzdHVkaW8sIC8vIHdoYXQgc3R1ZGlvIGlzIHRoaXMgZGF0YSBmcm9tIChvcHRpb25hbCkKICAgIHJlY29yZCwgLy8gUnlhbiBDb29rOiBkbyB3ZSBuZWVkIHRoaXMgaWYgd2UgYWxyZWFkeSBoYXZlIHN0dWRpbz8gKG9wdGlvbmFsKQogICAgdmVyc2lvbiwgLy8gdmVyc2lvbiBvZiB0aGUgZGF0YSAob3B0aW9uYWwpCiAgICBlZ2dQYXJhbWV0ZXJzLCAvLyBkYXRhIHRvIHBhc3MgdG8gYWxsIGNyZWF0ZWQgYm90cyB2aWEgQG9uRWdnSGF0Y2guIChvcHRpb25hbCkKICAgIGlnbm9yZUdyaWRGb2N1cywgLy8gUnlhbiBDb29rOiBhZGRpbmcgdGhpcyBhcyBhbiBvcHRpb25hbCBmbGFnLiAob3B0aW9uYWwpCn0gPSB0aGF0OwoKLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkgZm9yIHdoZW4gYWJDcmVhdGVCb3RzIGV4cGVjdGVkICJib3RzIiBwYXJhbWV0ZXIuCmlmICghYm90RGF0YSAmJiB0aGF0LmJvdHMpIHsKICAgIGJvdERhdGEgPSB0aGF0LmJvdHM7Cn0KCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKbGV0IG5ld0JvdElkcyA9IFtdOwoKLy90aGlzIGxvb3AgY3JlYXRlcyB0aGUgbmV3IGJvdHMgYW5kIHRoZW4gcGFja2FnZXMgdGhlbSBmb3IgYWRkaXRpb25hbCBwcm9jZXNzaW5nLCB3aGlsZSBhZGRpbmcgYW55IG5lZWRlZCBhZGRpdGlvbmFsIHRhZ3MKZm9yIChjb25zdCBwcm9wZXJ0eSBpbiBib3REYXRhKSB7CiAgICBjb25zdCBuZXdCb3QgPSBib3REYXRhW3Byb3BlcnR5XTsKICAgIGNvbnN0IGJvdFRvdGFsID0gT2JqZWN0LmtleXMoYm90RGF0YSkubGVuZ3RoOwogICAgY29uc3QgYWJJRE9yaWdpbiA9IHsgYWJJRE9yaWdpbjogb3JpZ2luLCBhYklEU3R1ZGlvOiBzdHVkaW8gfTsKICAgIGNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBpZiAobmV3Qm90LnRhZ3MpIHsKICAgICAgICBpZiAobmV3Qm90LnRhZ3MuY3JlYXRvcikgewogICAgICAgICAgICBhYklET3JpZ2luLm9sZENyZWF0b3IgPSBuZXdCb3QudGFncy5jcmVhdG9yOwogICAgICAgIH0KCiAgICAgICAgbGV0IHRhcmdldFBvc2l0aW9uOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAvLyBSeWFuIENvb2s6IFRoaXMgdGFyZ2V0UG9zaXRpb24gc3R1ZmYgaXMgYXBwYXJlbnRseSB1c2VkIGZvciBib3QgcGFzdGluZz8gCiAgICAgICAgICAgIC8vIFRoaXMgaXMgc29tZSByZWFsbHkgY29uZnVzaW5nIGxvZ2ljIGFuZCBzaG91bGQgYmUgcmVmYWN0b3JlZCBldmVudHVhbGx5LgogICAgICAgICAgICBpZiAoKGJvdFRvdGFsIDwgMiB8fCBib3RUb3RhbCA8IDMgJiYgYm90RGF0YS5hYlhQQm90ICE9IG51bGwpICYmIGFiR3JpZEZvY3VzICYmICFpZ25vcmVHcmlkRm9jdXMpIHsKICAgICAgICAgICAgICAgIGxldCB0YXJnZXREaW1lbnNpb24gPSBhYkdyaWRGb2N1cy5kaW1lbnNpb247CgogICAgICAgICAgICAgICAgdGFyZ2V0UG9zaXRpb24gPSB7IFt0YXJnZXREaW1lbnNpb25dOiB0cnVlLCBbdGFyZ2V0RGltZW5zaW9uICsgIlgiXTogYWJHcmlkRm9jdXMucG9zaXRpb24ueCwgW3RhcmdldERpbWVuc2lvbiArICJZIl06IGFiR3JpZEZvY3VzLnBvc2l0aW9uLnkgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbGV0IGIgPSBjcmVhdGUobmV3Qm90LnRhZ3MsIHRhcmdldFBvc2l0aW9uLCBhYklET3JpZ2luKTsKCiAgICAgICAgICAgIGlkTWFwLnNldChib3REYXRhW3Byb3BlcnR5XS5pZCwgYi5pZCk7CiAgICAgICAgICAgIG5ld0JvdHMucHVzaChiKTsKICAgICAgICAgICAgbmV3Qm90SWRzLnB1c2goYi5pZCk7CgogICAgICAgICAgICBpZiAoYi50YWdzLmNyZWF0b3IgPT0gdGhpc0JvdC5pZCkgewogICAgICAgICAgICAgICAgYi50YWdzLmNyZWF0b3IgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoIChlcnJvcikgewogICAgICAgICAgICBjb25zb2xlLmxvZygiaW52YWxpZCBib3QiLCBlcnJvcik7CiAgICAgICAgfQogICAgfQogICAgZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coInNraXBwZWQgYm90OiAiICsgbmV3Qm90KTsKICAgIH0KfQoKLy9hcnJheSBvZiB0YWcgcmVsYXRpb25zaGlwcyB0byBiZSBwcmVzZXJ2ZWQKbGV0IGxpbmtUYWdzID0gWyJsaW5rIiwgImNyZWF0b3IiLCAiY29uZmlnQm90IiwgImxpbmVUbyIsICJ0cmFuc2Zvcm1lciIsICJmb3JtTGlnaHRUYXJnZXQiXTsKCi8vdGhpcyBsb29wIGNvbnRhaW5zIHRoZSBsb2dpYyBmb3IgcHJlc2VydmluZyB0aGUgbGlua1RhZ3MKZm9yIChsZXQgbmV3Qm90IG9mIG5ld0JvdHMpIHsKICAgIGZvciAobGV0IHRhZyBvZiBsaW5rVGFncykgewogICAgICAgIGxldCB2YWx1ZSA9IG5ld0JvdC50YWdzW3RhZ107CgogICAgICAgIGlmICh0YWcgPT0gImNyZWF0b3IiKSB7CiAgICAgICAgICAgIHZhbHVlID0gbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvcjsKICAgICAgICAgICAgbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVCb3RMaW5rcyhuZXdCb3QsIGlkTWFwKTsKCiAgICAgICAgaWYgKHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgICAgICAgbGV0IG5ld1ZhbHVlID0gdmFsdWUubWFwKGlkID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaWRNYXAuZ2V0KGlkKSB8fCBpZDsKICAgICAgICAgICAgICAgIH0pCgogICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3VmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBuZXdJRCA9IGlkTWFwLmdldCh2YWx1ZSk7CgogICAgICAgICAgICAgICAgaWYgKG5ld0lEKSB7CiAgICAgICAgICAgICAgICAgICAgbmV3Qm90LnJhd1t0YWddID0gbmV3SUQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCi8vdG9hc3RzIGZvciBoYXRjaGVzLCBidXQgb25seSBvbiBidWlsZGVyCmlmIChjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUgPT0gbnVsbCAmJiAhY29uZmlnQm90LnRhZ3MucGggJiYgYnVpbGRlclZlcnNpb24gPT0gImJ1aWxkZXIiKSB7CiAgICBvcy50b2FzdCgiaGF0Y2hlZCAiICsgb3JpZ2luICsgIiB2IiArIHZlcnNpb24pOwp9CgppZiAob3JpZ2luKSB7CiAgICAvLyBDcmVhdGUgYWJFZ2cgYm90IHRoYXQgdHJhY2tzIGNhbiBiZSB1c2VkIHRvIHRyYWNrIHdoYXQgZWdncyBoYXZlIGJlZW4gaGF0Y2hlZC4KICAgIGNyZWF0ZSh7CiAgICAgICAgc3BhY2U6ICJzaGFyZWQiLAogICAgICAgIGFiOiB0cnVlLAogICAgICAgIGFiRWdnOiB0cnVlLAogICAgICAgIGFiSWdub3JlOiB0cnVlLAogICAgICAgIG9yaWdpbl9hYjogb3JpZ2luLAogICAgICAgIG9yaWdpbl92ZXJzaW9uOiB2ZXJzaW9uLAogICAgICAgIG9yaWdpbl9yZWNvcmQ6IHJlY29yZCwKICAgICAgICBvcmlnaW5fc3R1ZGlvOiBzdHVkaW8sCiAgICAgICAgZm9ybTogImVnZyIsCiAgICAgICAgY29sb3I6IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgICAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICAgICAgbGFiZWw6IG9yaWdpbiArICIgdiIgKyB2ZXJzaW9uLAogICAgfSk7Cn0KCmNvbmZpZ0JvdC50YWdzLmxhc3RFZ2dIYXRjaGVkID0gb3JpZ2luOwoKd2hpc3BlcihuZXdCb3RzLCAnb25QcmVIYXRjaCcsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzIH0pOwoKaWYgKGluaXRpYWxCb290KSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy9vbkVnZ0hhdGNoIGZvciBhbGwganVzdCBoYXRjaGVkIGJvdHMKd2hpc3BlcihuZXdCb3RzLCAib25FZ2dIYXRjaCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzLCBlZ2dQYXJhbWV0ZXJzIH0pOwoKLy9vbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQUJBZGRlZCIsIHsgYWI6IG9yaWdpbiwgdmVyc2lvbiwgaW5zdDogYWIudGFncy5hYkluc3QsIGJvdElkczogbmV3Qm90SWRzIH0pOwpzdXBlclNob3V0KCJvbkFiQWRkZWQiLCB7IGFiOiBvcmlnaW4sIHZlcnNpb24sIGluc3Q6IGFiLnRhZ3MuYWJJbnN0LCBib3RJZHM6IG5ld0JvdElkcyB9KTsgLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHkuCgpyZXR1cm4gbmV3Qm90czsnAIHU7PIPxsQBCHJlbWVtYmVyAgQAgdTs8g/75wEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAgdTs8g/GxAEIYWJJZ25vcmUCBACB1OzyD6LoAQR0cnVlJwCB1OzyD8bEAQdhYlNoZWxsAgQAgdTs8g+n6AEEdHJ1ZScAgdTs8g/GxAEJYWJWZXJzaW9uAgQAgdTs8g+s6AEEMTAuNCcBBGJvdHMkNTI4ZGMwZjktNDNlYy00M2YzLWE0NzAtZTJkZDZhMGRhOTVmAScAgdTs8g+x6AEGc3lzdGVtAgQAgdTs8g+y6AEQYWIuc2hlbGwudmVyc2lvbicAgdTs8g+x6AEEZm9ybQIEAIHU7PIPw+gBB25vdGhpbmcnAIHU7PIPsegBCGFiSWdub3JlAgQAgdTs8g/L6AEEdHJ1ZScAgdTs8g+x6AEHYWJTaGVsbAIEAIHU7PIP0OgBBHRydWUnAIHU7PIPsegBE2FiU2hlbGxNYWpvclZlcnNpb24CBACB1OzyD9XoAQExJwCB1OzyD7HoAQ1vblNraWxsVXBkYXRlAgQAgdTs8g/X6AGXAUBjb25zdCB2ZXJzaW9uU3RyaW5nID0gdGFncy5hYlNoZWxsTWFqb3JWZXJzaW9uICsgIi4iICsgdGFncy5hYlNoZWxsTWlub3JWZXJzaW9uOw0KDQpjb25zb2xlLmxvZygiW0FCU2hlbGxdIExvYWRlZCBBQiBzaGVsbCB2ZXJzaW9uICIgKyB2ZXJzaW9uU3RyaW5nKTsnAIHU7PIPsegBCWFiVmVyc2lvbgIEAIHU7PIP7+kBBDEwLjQnAIHU7PIPsegBE2FiU2hlbGxNaW5vclZlcnNpb24CBACB1OzyD/TpAQIxMCcBBGJvdHMkNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmAScAgdTs8g/36QEGc3lzdGVtAgQAgdTs8g/46QEOYWIuc2hlbGwuc3RvcmUnAIHU7PIP9+kBBGZvcm0CBACB1OzyD4fqAQdub3RoaW5nJwCB1OzyD/fpAQtkZXNjcmlwdGlvbgIEAIHU7PIPj+oBP1RoaXMgc2tpbGwgaXMgbWVhbnQgdG8gYmUgYSBjb25maWd1cmFibGUgbWVhbnMgdG8gcHVibGlzaCBkYXRhLicAgdTs8g/36QEPYWJQdWJsaXNoUmVjb3JkAgQAgdTs8g/P6gG4BkBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IHB1YmxpY0ZhY2luZyA9IHRoYXQucHVibGljRmFjaW5nOwpsZXQgcmVjb3JkRGF0YSA9IHRoYXQuZGF0YTsKbGV0IHJlY29yZE5hbWUgPSB0aGF0LnJlY29yZE5hbWU7CmxldCBlbmRwb2ludCA9IHRoYXQuZW5kcG9pbnQgPyB0aGF0LmVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIXJlY29yZERhdGEpCnsKICAgIHJldHVybiAibm8gZGF0YSBzdXBwbGllZCI7Cn0KCmlmIChwdWJsaWNGYWNpbmcpCnsKICAgIHJlY29yZERhdGEgPSBhd2FpdCBvcy5yZWNvcmREYXRhKHVzZXJSZWNvcmQsIHJlY29yZE5hbWUsIHJlY29yZERhdGEsIHtlbmRwb2ludDogZW5kcG9pbnQsIG1hcmtlcnM6IFsicHVibGljUmVhZCJdfSk7Cn0KZWxzZQp7ICAgIAogICAgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEodXNlclJlY29yZCwgcmVjb3JkTmFtZSwgcmVjb3JkRGF0YSwge2VuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogW3JlY29yZE5hbWVdfSk7Cn0KCmlmIChyZWNvcmREYXRhLnN1Y2Nlc3MpCnsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIHJlY29yZGVkIHRvICIgKyB1c2VyUmVjb3JkKTsKfQplbHNlCnsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkYXRhIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIHJlY29yZERhdGE7JwCB1OzyD/fpAQ1hYlB1Ymxpc2hGaWxlAgQAgdTs8g+I8QGgB0Bhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGZpbGUgPSB0aGF0LmZpbGU7CmxldCBmaWxlTmFtZSA9IHRoYXQuZmlsZU5hbWU7CmxldCBtaW1lVHlwZSA9IHRoYXQubWltZVR5cGU7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghZmlsZSkKewogICAgcmV0dXJuICJubyBmaWxlIHN1cHBsaWVkIjsKfQoKbGV0IGZpbGVVcGxvYWQgPSBhd2FpdCBvcy5yZWNvcmRGaWxlKHVzZXJSZWNvcmQsIGZpbGUsIHtkZXNjcmlwdGlvbjogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwogICAgCmlmICghZmlsZVVwbG9hZC5zdWNjZXNzKSAKewogICAgaWYgKGZpbGVVcGxvYWQuZXJyb3JDb2RlID09ICJmaWxlX2FscmVhZHlfZXhpc3RzIikKICAgIHsKICAgICAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogZmlsZSBhbHJlYWR5IGV4aXN0cyBpbiAiICsgdXNlclJlY29yZCk7CgogICAgICAgIHJldHVybiBmaWxlVXBsb2FkOwogICAgfQoKICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbih1c2VyUmVjb3JkKTsKCiAgICBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykKewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgcmVjb3JkZWQgdG8gIiArIHVzZXJSZWNvcmQpOwp9CmVsc2UKewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6IGZpbGUgZmFpbGVkIHRvIHJlY29yZCIpOwp9CgpyZXR1cm4gZmlsZVVwbG9hZDsnAIHU7PIP9+kBEGFiQ29yZU1lbnVBY3Rpb24CBACB1OzyD6n4AU1AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAgdTs8g/36QELb25TdG9yZU1lbnUCBACB1OzyD/f4AcuTAUBjb25zdCB0YXJnZXRCb3RzID0gWy4uLm5ldyBTZXQobGlua3MucmVtZW1iZXIubGlua3MuYWJNdWx0aXBsZUJvdEZvY3VzKV07CmNvbnN0IHBvc3NpYmxlUHVibGlzaEJvdCA9IHRhcmdldEJvdHM/Lmxlbmd0aCA+IDAgPyB0YXJnZXRCb3RzIDogbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyA/IFtsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzXSA6IFtdOwpjb25zdCBiYXNlQUIgPSAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyA/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOiBsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzLmlkOwpjb25zdCBiYXNlQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IGJhc2VBQiwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKY29uc3Qgbm9uQUJCb3RzID0gZ2V0Qm90cyhieU1vZCh7YWJJRE9yaWdpbjogbnVsbCwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKbGlua3MubWVudS5tYXNrcy5vbkdyaWRDbGljayA9ICJAIHNob3V0KCdhYk1lbnVSZWZyZXNoJyk7IGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOyI7Cgpjb25zdCBkZWZhdWx0cyA9IHsKICAgIGFiTWVudTogdHJ1ZSwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbWFuYWdlcjogIvCflJciICsgdGhpc0JvdC5pZCwKICAgIG1hbmlmZXN0YXRpb246IHRhZ3MubWFuaWZlc3RhdGlvbiwKICAgIHJlbWVtYmVyOiB0YWdzLnJlbWVtYmVyLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjBweCIsCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLWxlZnQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3JkZXItcmlnaHQtc3R5bGUiOiAic29saWQiLAogICAgICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgIH1gCn0KCi8vIENyZWF0ZSBkb3dubG9hZCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDksCiAgICBsYWJlbDogImRvd25sb2FkIiwKICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAiYm9yZGVyLXJhZGl1cyI6ICI4cHgiLCAKICAgICAgICAibWFyZ2luLXRvcCI6ICI4cHgiLCAgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtQWRkcmVzczogImdldF9hcHAiLAogICAgcG9zc2libGVCb3Q6IGdldExpbmsocG9zc2libGVQdWJsaXNoQm90KSwKICAgIG9uQ2xpY2s6IGBAIGxpbmtzLm1hbmFnZXIuYWJEb3dubG9hZCh7YmFzZUFCOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgcG9zc2libGVCb3RzOiBsaW5rcy5wb3NzaWJsZUJvdH0pO2AKfSk7CgppZiAoIWF1dGhCb3QpIAp7CiAgICAvLyBDcmVhdGUgbG9naW4gbWVzc2FnZQogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogOSwKICAgICAgICBsYWJlbDogInBsZWFzZSBzaWduIGluIHRvIGFjY2VzcyBzaGFyZSBmZWF0dXJlcyIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJsb2NrIiwKICAgICAgICBvbkNsaWNrOiBgQCBvcy5yZXF1ZXN0QXV0aEJvdCgpYAogICAgfSk7CgogICAgcmV0dXJuOwp9CmVsc2UgaWYgKGF1dGhCb3QudGFncy5zdWJzY3JpcHRpb25UaWVyID09ICJGcmVlUGxheSIpIAp7CiAgICAvLyBDcmVhdGUgdXBncmFkZSBzdWJzY3JpcHRpb24gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJwbGVhc2UgdXBncmFkZSB5b3VyIHN1YnNjcmlwdGlvbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiLAogICAgICAgIGZvcm1BZGRyZXNzOiAibG9jayIKICAgIH0pOwoKICAgIHJldHVybjsKfQoKCmxldCB1c2VyU3R1ZGlvcyA9IGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvczsKCmlmICghdXNlclN0dWRpb3MpIAp7CiAgICB1c2VyU3R1ZGlvcyA9IGF3YWl0IG9zLmxpc3RVc2VyU3R1ZGlvcygpOwp9CgppZiAodXNlclN0dWRpb3Muc3VjY2VzcykgCnsKICAgIGNvbnN0IGFjdGl2ZVN0dWRpbyA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpOwoKICAgIGxldCBiYXNlU3R1ZGlvID0gYXV0aEJvdC5pZDsKCiAgICBpZiAoYmFzZVN0dWRpbyA9PSBhdXRoQm90LmlkKSAKICAgIHsKICAgICAgICBiYXNlU3R1ZGlvID0gInBsYXllciI7CiAgICB9CgogICAgaWYgKGFjdGl2ZVN0dWRpbyA9PSAtMSAmJiBiYXNlU3R1ZGlvICE9ICJwbGF5ZXIiKSAKICAgIHsKICAgICAgICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGJhc2VTdHVkaW87CiAgICB9CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLnN0dWRpbyAmJiAhYWN0aXZlU3R1ZGlvKSAKICAgIHsKICAgICAgICBjb25zdCBzdHVkaW9NYXRjaCA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvKQoKICAgICAgICBpZiAoc3R1ZGlvTWF0Y2ggIT0gLTEpIHsKICAgICAgICAgICAgYmFzZVN0dWRpbyA9IGJhc2VTdHVkaW87CiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IHN0dWRpb0xhYmVsID0gYWN0aXZlU3R1ZGlvID09IC0xID8gYmFzZVN0dWRpbyA6IHVzZXJTdHVkaW9zLnN0dWRpb3NbYWN0aXZlU3R1ZGlvXS5kaXNwbGF5TmFtZTsKCiAgICAvLyBDcmVhdGUgc3R1ZGlvIHNlbGVjdCBidXR0b24KICAgIGNvbnN0IHN0dWRpb0Rpc3BsYXlCdXR0b24gPSBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgbGFiZWw6ICJzdHVkaW89IiArIHN0dWRpb0xhYmVsLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMS41LAogICAgICAgIHN0dWRpb0luZm9ybWF0aW9uOiB1c2VyU3R1ZGlvcywKICAgICAgICBmb3JtQWRkcmVzczogImludmVudG9yeV8yIiwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLnN0dWRpb1NlbGVjdCh0YWdzLnN0dWRpb0luZm9ybWF0aW9uKTtgCiAgICB9KTsKCiAgICBtYXNrcy5zdHVkaW9TZWxlY3RCdXR0b24gPSBnZXRMaW5rKHN0dWRpb0Rpc3BsYXlCdXR0b24pOwp9Cgpjb25zdCB0b3RhbEJvdENvdW50ID0gcG9zc2libGVQdWJsaXNoQm90Lmxlbmd0aCA+IDAgPyBwb3NzaWJsZVB1Ymxpc2hCb3QubGVuZ3RoIDogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aDsKCi8vIENyZWF0ZSBwdWJsaXNoIGxhYmVsIGJ1dHRvbgpjb25zdCBsYWJlbEJvdCA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgbGFiZWw6IGBwdWJsaXNoIHBhdHRlcm4gJHtiYXNlQm90cy5sZW5ndGggPiAwID8gIiIgOiAiYXMgIn0ke2Jhc2VBQn0gKCR7dG90YWxCb3RDb3VudH0gYm90JHtiYXNlQm90cy5sZW5ndGggKyBub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgIHRvdGFsQm90czogYmFzZUJvdHMubGVuZ3RoICsgbm9uQUJCb3RzLmxlbmd0aCwKICAgIGFiTWVudVNvcnRPcmRlcjogMSwKICAgIGxhYmVsQWxpZ25tZW50OiAiY2VudGVyIiwKICAgIGZvcm1BZGRyZXNzOiBudWxsLAogICAgbWVudUl0ZW1TdHlsZTogYPCfp6wgewogICAgICAgICJib3JkZXItcmFkaXVzIjogIjhweCA4cHggMHB4IDBweCIsIAogICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsICAgICAgICAgCiAgICAgICAgImJvcmRlci13aWR0aCI6ICIycHgiLCAKICAgICAgICAiYm9yZGVyLWNvbG9yIjogIiMwMDAiLCAKICAgICAgICAiYm9yZGVyLXRvcC1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm94LXNoYWRvdyI6ICIzcHggNHB4ICMwMDAiLAogICAgICAgICJtaW4taGVpZ2h0IjogIjQ0cHgiCiAgICB9YCwKICAgIHNoaWZ0U3RhdGU6IGZhbHNlLAogICAgb25DbGljazogYEAgY29uc3QgbWVudUJvdHMgPSBnZXRCb3RzKCdhYk1lbnVTb3J0T3JkZXInKTsKCiAgICAgICAgaWYgKHRhZ3Muc2hpZnRTdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHdoaXNwZXIobWVudUJvdHMsICJvbktleVVwIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB3aGlzcGVyKG1lbnVCb3RzLCAib25LZXlEb3duIiwge2tleXM6IFsiU2hpZnQiXX0pOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0YWdzLnNoaWZ0U3RhdGUgPSAhdGFncy5zaGlmdFN0YXRlO2AsCiAgICBzY2FsZVk6ICJhdXRvIiwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIGxldCB0b3RhbEJvdHMgPSBjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgPyB0aGF0LmFiQm90cyA6IHRoYXQuYWJCb3RzICsgdGhhdC5ub25BQkJvdHM7CgogICAgY29uc3QgdG90YWxCb3RWYXIgPSB0b3RhbEJvdHMgPT0gMSA/ICIgYm90IiA6ICIgYm90cyI7CiAgICBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cz8ubGVuZ3RoICA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwoKICAgIGlmICh0aGF0LmFiID09ICJuZXcgcGF0dGVybiIpCiAgICB7CiAgICAgICAgbGlua3MucmVtZW1iZXIubWFza3MuYmFzZUFCID0gbnVsbDsKCiAgICAgICAgaWYgKGdldEJvdCgiYWJJRE9yaWdpbiIsIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCKSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IGFiQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpLmxlbmd0aDsKCiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAicHVibGlzaCAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgYWJCb3RzICsgIiBib3RzKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gYWJCb3RzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggcGF0dGVybiBhcyAiICsgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgICAgIHRhZ3MudG90YWxCb3RzID0gdG90YWxCb3RzOwogICAgICAgIH0gICAKICAgIH0KICAgIGVsc2UKICAgIHsgICAKICAgICAgICB0YWdzLmxhYmVsID0gInB1Ymxpc2ggIiArIHRoYXQuYWIgKyAiICgiICsgdG90YWxCb3RzICsgdG90YWxCb3RWYXIgKyAiKSI7CiAgICAgICAgdGFncy50b3RhbEJvdHMgPSB0b3RhbEJvdHM7CiAgICB9YAp9KTsKCi8vIENyZWF0ZSBlbmNyeXB0IGJ1dHRvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgIGRpbWVuc2lvbjogImFiTWVudSIsCiAgICBsYWJlbDogImVuY3J5cHQiLAogICAgZm9ybUFkZHJlc3M6ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayIsCiAgICBlbmNyeXB0U3RhdGU6IGZhbHNlLAogICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICBvbktleVVwOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gLAogICAgb25DbGljazogYEAgaWYodGFncy5lbmNyeXB0U3RhdGUpCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbiA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MuZW5jcnlwdFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gdHJ1ZTsKICAgICAgICB9YCwKfSk7CgpsZXQgYWJCdXR0b247CgppZiAocG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvLyBDcmVhdGUgaW5jbHVkZUJvdHMgYnV0dG9uCiAgICBhYkJ1dHRvbiA9IGF3YWl0IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnU6IG51bGwsCiAgICAgICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTIsCiAgICAgICAgYWJTZWxlY3Rpb25CdXR0b246IHRydWUsCiAgICAgICAgbGFiZWw6IGJhc2VCb3RzLmxlbmd0aCA+IDAgJiYgYmFzZUFCICE9IHVuZGVmaW5lZCA/IGBzZWxlY3RlZCBwYXR0ZXJuOiAke2Jhc2VBQn0gKCR7YmFzZUJvdHMubGVuZ3RofSBib3Qke2Jhc2VCb3RzLmxlbmd0aCA9PSAxID8gIiIgOiAicyJ9KWAgOiBgbmV3IHBhdHRlcm4gKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogJ2VnZycsCiAgICAgICAgb25LZXlEb3duOiBgQCBpZiAodGhhdC5rZXlzWzBdID09ICJTaGlmdCIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaFNlbGVjdCgpO2AsCiAgICAgICAgYWJTZWxlY3RUaXRsZVVwZGF0ZTogYEAgY29uc3QgYm90VmFyTm9uID0gdGhhdC5ub25BQkJvdHMgID09IDEgPyAiIGJvdCkiIDogIiBib3RzKSI7CiAgICAgICAgY29uc3QgYm90VmFyQUIgPSB0aGF0LmFiQm90cyAgPT0gMSA/ICIgYm90KSIgOiAiIGJvdHMpIjsKCiAgICAgICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSB0aGF0LmFiICsgIiAoIiArIHRoYXQubm9uQUJCb3RzICsgYm90VmFyTm9uOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0YWdzLmxhYmVsID0gInNlbGVjdGVkIHBhdHRlcm46ICIgKyB0aGF0LmFiICsgIiAoIiArIHRoYXQuYWJCb3RzICsgYm90VmFyQUI7CiAgICAgICAgfWAKICAgIH0pOwp9CgppZiAobm9uQUJCb3RzLmxlbmd0aCA+IDAgJiYgcG9zc2libGVQdWJsaXNoQm90Py5sZW5ndGggPCAxKQp7CiAgICAvL2ljbHVkZSBuZXcgYm90cwogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudTogbnVsbCwKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEuNTMsCiAgICAgICAgYWJCdXR0b246IGdldExpbmsoYWJCdXR0b24pLAogICAgICAgIGxhYmVsQm90OiBnZXRMaW5rKGxhYmVsQm90KSwKICAgICAgICBkaW1lbnNpb246ICJhYk1lbnUiLAogICAgICAgIGxhYmVsOiBgaW5jbHVkZSBuZXcgKCR7bm9uQUJCb3RzLmxlbmd0aH0gYm90JHtub25BQkJvdHMubGVuZ3RoID09IDEgPyAiIiA6ICJzIn0pYCwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveCIsCiAgICAgICAgdW5jbGFpbWVkU3RhdGU6IGZhbHNlLAogICAgICAgIG9uS2V5RG93bjogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7CgogICAgICAgICAgICAgICAgY29uc3QgbGFiZWxDaGVjayA9IGxpbmtzLmFiQnV0dG9uLnRhZ3MubGFiZWw7CgogICAgICAgICAgICAgICAgaWYgKGxhYmVsQ2hlY2suaW5jbHVkZXMoJ25ldyBwYXR0ZXJuJykpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfWAsCiAgICAgICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgICAgICBvbkNsaWNrOiBgQCBjb25zdCBhYkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiwgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbH0pKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKHRhZ3MudW5jbGFpbWVkU3RhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vbkFCQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IG51bGwsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CgogICAgICAgICAgICAgICAgdGFncy51bmNsYWltZWRTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKCiAgICAgICAgICAgICAgICBsaW5rcy5sYWJlbEJvdC5hYlNlbGVjdFRpdGxlVXBkYXRlKHthYjogbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIsIGFiQm90czogYWJCb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25BQkJvdHMubGVuZ3RofSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzLnVuY2xhaW1lZFN0YXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwoKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLmFiRXhjbHVkZVVuY2xhaW1lZCA9IHRydWU7CgogICAgICAgICAgICAgICAgbGlua3MubGFiZWxCb3QuYWJTZWxlY3RUaXRsZVVwZGF0ZSh7YWI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCLCBhYkJvdHM6IGFiQm90cy5sZW5ndGgsIG5vbkFCQm90czogMH0pOwogICAgICAgICAgICB9YCwKICAgICAgICBhYlNlbGVjdFRpdGxlVXBkYXRlOiBgQCBjb25zdCBib3RWYXIgPSB0aGF0Lm5vbkFCQm90cyA9PSAxID8gIiBib3QpIiA6ICIgYm90cykiOwogICAgICAgIAogICAgICAgICAgICB0YWdzLmxhYmVsID0gImluY2x1ZGUgbmV3ICgiICsgdGhhdC5ub25BQkJvdHMgKyBib3RWYXI7CgogICAgICAgICAgICBjb25zdCBsYWJlbENoZWNrID0gdGhhdC5hYjsKCiAgICAgICAgICAgIGlmKCFsYWJlbENoZWNrLmluY2x1ZGVzKCduZXcgcGF0dGVybicpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXNrc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWFza3NbdGFncy5kaW1lbnNpb25dID0gZmFsc2U7CiAgICAgICAgICAgIH1gCiAgICB9KTsKfQoKLy8gQ3JlYXRlIHB1YmxpYyBidXR0b24KaWYgKGF1dGhCb3QudGFncy5wcml2YWN5RmVhdHVyZXMuYWxsb3dQdWJsaWNEYXRhKSAKewogICAgY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gZmFsc2U7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgICAgIC4uLmRlZmF1bHRzLAogICAgICAgIGFiTWVudVNvcnRPcmRlcjogMiwKICAgICAgICBsYWJlbDogImlzUHVibGljIiwKICAgICAgICBmb3JtQWRkcmVzczogImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIiwKICAgICAgICBwdWJsaWNTdGF0ZTogZmFsc2UsCiAgICAgICAgb25DbGljazogYEAgaWYodGFncy5wdWJsaWNTdGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFncy5wdWJsaWNTdGF0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgICAgICAgICBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmcgPSB0cnVlOwogICAgICAgICAgICB9YAogICAgfSk7Cn0KCi8vIENyZWF0ZSB2ZXJzaW9uIHNlbGVjdCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnU6IG51bGwsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgbGFiZWw6ICd2ZXJzaW9uRmxhZz1jdXJyZW50JywKICAgIGZvcm1BZGRyZXNzOiAnYWx0X3JvdXRlJywKICAgIHNob3dWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgaGlkZVZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBvbktleURvd246IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlOwogICAgICAgICAgICB9YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQCBzaG91dCgnc2hvd1ZlcnNpb25TZWxlY3RvcicpO2AsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MubGFiZWwgPSAndmVyc2lvbkZsYWc9JyArIHRoYXQ7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICBgLAp9KTsKCi8vIEN1cnJlbnQgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnY3VycmVudCcsCiAgICBkaW1lbnNpb246ICdhYk1lbnUnLAogICAgYWJNZW51U29ydE9yZGVyOiAxLjUxLAogICAgZm9ybUFkZHJlc3M6ICdyYWRpb19idXR0b25fY2hlY2tlZCcsCiAgICBzaG93VmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IHRydWU7YCwKICAgIGhpZGVWZXJzaW9uU2VsZWN0b3I6IGBAIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDtgLAogICAgb25LZXlVcDogYEAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IGZhbHNlOwogICAgICAgICAgICB9YCwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX2NoZWNrZWQnOwogICAgICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CiAgICAgICAgICAgIHNob3V0KCd2ZXJzaW9uT3B0aW9uQ2xpY2snLCB0YWdzLmxhYmVsKTsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAsCiAgICB2ZXJzaW9uT3B0aW9uQ2xpY2s6IGBAIGlmICh0aGF0ID09IHRhZ3MubGFiZWwpIHsgcmV0dXJuOyB9CiAgICAgICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAncmFkaW9fYnV0dG9uX3VuY2hlY2tlZCc7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgCn0pOwoKLy8gRmVlZGJhY2sgVmVyc2lvbgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAuLi5kZWZhdWx0cywKICAgIGFiTWVudTogbnVsbCwKICAgIGxhYmVsOiAnZmVlZGJhY2snLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTEsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnZmVlZGJhY2snOwogICAgICAgICAgICBzaG91dCgndmVyc2lvbk9wdGlvbkNsaWNrJywgdGFncy5sYWJlbCk7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gbnVsbDsKICAgICAgICBgLAogICAgdmVyc2lvbk9wdGlvbkNsaWNrOiBgQCBpZiAodGhhdCA9PSB0YWdzLmxhYmVsKSB7IHJldHVybjsgfQogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYAp9KTsKCi8vIFN0YWJsZSBWZXJzaW9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIC4uLmRlZmF1bHRzLAogICAgYWJNZW51OiBudWxsLAogICAgbGFiZWw6ICdzdGFibGUnLAogICAgZGltZW5zaW9uOiAnYWJNZW51JywKICAgIGFiTWVudVNvcnRPcmRlcjogMS41MTIsCiAgICBmb3JtQWRkcmVzczogJ3JhZGlvX2J1dHRvbl91bmNoZWNrZWQnLAogICAgc2hvd1ZlcnNpb25TZWxlY3RvcjogYEAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSB0cnVlO2AsCiAgICBoaWRlVmVyc2lvblNlbGVjdG9yOiBgQCB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7YCwKICAgIG9uS2V5VXA6IGBAIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICAgICAgfWAsCiAgICBvbkNsaWNrOiBgQAogICAgICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ3JhZGlvX2J1dHRvbl9jaGVja2VkJzsKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPSAnc3RhYmxlJzsKICAgICAgICAgICAgc2hvdXQoJ3ZlcnNpb25PcHRpb25DbGljaycsIHRhZ3MubGFiZWwpOwogICAgICAgICAgICB0YWdzW3RhZ3MuZGltZW5zaW9uXSA9IG51bGw7CiAgICAgICAgYCwKICAgIHZlcnNpb25PcHRpb25DbGljazogYEAgaWYgKHRoYXQgPT0gdGFncy5sYWJlbCkgeyByZXR1cm47IH0KICAgICAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdyYWRpb19idXR0b25fdW5jaGVja2VkJzsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBudWxsOwogICAgICAgIGAKfSk7CgovLyBDcmVhdGUgcHVibGlzaCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oewogICAgLi4uZGVmYXVsdHMsCiAgICBhYk1lbnVTb3J0T3JkZXI6IDQsCiAgICBmb3JtQWRkcmVzczogImVnZyIsCiAgICBtZW51SXRlbVN0eWxlOiBg8J+nrCB7CiAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCA4cHggOHB4IiwgCiAgICAgICAgIm1hcmdpbi10b3AiOiAiMHB4IiwgICAgICAgIAogICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAgICAgImJvcmRlci1sZWZ0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLXJpZ2h0LXN0eWxlIjogInNvbGlkIiwKICAgICAgICAiYm9yZGVyLWJvdHRvbS1zdHlsZSI6ICJzb2xpZCIsCiAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAibWluLWhlaWdodCI6ICI0NHB4IgogICAgfWAsCiAgICBmb3JtOiAiaW5wdXQiLAogICAgbGFiZWxCb3Q6IGdldExpbmsobGFiZWxCb3QpLAogICAgb25JbnB1dFR5cGluZzogYEAgbGlua3MubGFiZWxCb3QudGFncy5sYWJlbCA9ICdwdWJsaXNoIHBhdHRlcm4gYXMgJyArIHRoYXQudGV4dCArICcgKCcgKyBsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyArICcgYm90JyArIChsaW5rcy5sYWJlbEJvdC50YWdzLnRvdGFsQm90cyA9PSAxID8gJyknIDogJ3MpJyk7YCwKICAgIG1lbnVJdGVtU2hvd1N1Ym1pdFdoZW5FbXB0eTogdHJ1ZSwKICAgIHRhcmdldEJvdDogZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpLAogICAgbWVudUl0ZW1UZXh0OiBiYXNlQUIsCiAgICBvblN1Ym1pdDogYEAKICAgICAgICAgICAgaWYgKHRoYXQudGV4dCA9PSBudWxsICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCICYmICFsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGF0LnRleHQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKICAgICAgICAgICAgY29uc3QgY29uZmlybVB1c2ggPSBhd2FpdCBvcy5zaG93Q29uZmlybSh7CiAgICAgICAgICAgICAgICB0aXRsZTogImNvbmZpcm0gcHVibGlzaCIsCiAgICAgICAgICAgICAgICBjb250ZW50OiAicHVibGlzaCAiICsgdGhhdC50ZXh0ICsgIiB0byAiICsgdGFyZ2V0U3R1ZGlvICsgIj8iLAogICAgICAgICAgICAgICAgY29uZmlybVRleHQ6ICJwdWJsaXNoIiwKICAgICAgICAgICAgICAgIGNhbmNlbFRleHQ6ICJjYW5jZWwiCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKCFjb25maXJtUHVzaCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25maWdCb3QudGFncy5tYW51YWxQdWJsaXNoID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLm1hbmFnZXIuYWJQdWJsaXNoQUIoe2FiOiB0aGF0LnRleHQsIG1hbnVhbFB1Ymxpc2g6IHRydWUsIGJvdDogbGlua3MudGFyZ2V0Qm90LCBiYXNlQUI6IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBvcy50b2FzdCgiYWIgbm90IHNwZWNpZmllZCIpOwogICAgICAgICAgICB9CiAgICAgICAgYCwKICAgIGFiU2VsZWN0VGl0bGVVcGRhdGU6IGBAIAogICAgaWYgKHRoYXQuYWIgPT0gIm5ldyBwYXR0ZXJuIikKICAgIHsKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5iYXNlQUIgPSBudWxsOwoKICAgICAgICB0YWdzLm1lbnVJdGVtVGV4dCA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRhZ3MubWVudUl0ZW1UZXh0ID0gdGhhdC5hYjsKICAgIH1gCn0pOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpIAp7CiAgICAvLyBDcmVhdGUgY29weSB0byBjbGlwYm9hcmQgYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih7CiAgICAgICAgLi4uZGVmYXVsdHMsCiAgICAgICAgYWJNZW51U29ydE9yZGVyOiA4LAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogImNvcHkgdG8gY2xpcGJvYXJkIiwKICAgICAgICBmb3JtQWRkcmVzczogImZpbGVfY29weSIsCiAgICAgICAgdGFyZ2V0Qm90OiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90Rm9jdXMsCiAgICAgICAgb25DbGljazogYEAgbGV0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwogICAgICAgICAgICBsZXQgcHJlcHBlZEJvdCA9IEpTT04uc3RyaW5naWZ5KHNlbGVjdGVkQm90KTsKICAgICAgICAgICAgbGV0IHN0YXRlID0ge30KCiAgICAgICAgICAgIHN0YXRlW2FiSW5zdE1lbW9yeS50YWdzLmFiRm9jdXNEYXRhXSA9IHNlbGVjdGVkQm90OwoKICAgICAgICAgICAgbGV0IG5ld0ZpbGUgPSB7fQogICAgICAgICAgICBuZXdGaWxlLnZlcnNpb24gPSAxOwogICAgICAgICAgICBuZXdGaWxlLnN0YXRlID0gc3RhdGU7CgogICAgICAgICAgICB2YXIgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KG5ld0ZpbGUpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZm9ybWF0dGVkRmlsZSk7CgogICAgICAgICAgICBvcy50b2FzdCgiYm90IGNvcGllZCB0byBjbGlwYm9hcmQiKTsKCiAgICAgICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIGAsCiAgICB9KTsKfQplbHNlIAp7CiAgICAvLyBDcmVhdGUgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgICAgICAuLi5kZWZhdWx0cywKICAgICAgICBhYk1lbnVTb3J0T3JkZXI6IDEwLAogICAgICAgIG1lbnVJdGVtU3R5bGU6IGDwn6esIHsgICAgICAgICAgICAKICAgICAgICAgICAgImJvcmRlci1yYWRpdXMiOiAiOHB4IiwgCiAgICAgICAgICAgICJtYXJnaW4tdG9wIjogIjhweCIsCiAgICAgICAgICAgICJib3JkZXItd2lkdGgiOiAiMnB4IiwgCiAgICAgICAgICAgICJib3JkZXItY29sb3IiOiAiIzAwMCIsIAogICAgICAgICAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICAgICAgICAgImJveC1zaGFkb3ciOiAiM3B4IDRweCAjMDAwIiwKICAgICAgICAgICAgIm1pbi1oZWlnaHQiOiAiNDRweCIKICAgICAgICB9YCwKICAgICAgICBsYWJlbDogInNjYW4gdG8gcHVibGlzaCIsCiAgICAgICAgZm9ybUFkZHJlc3M6ICJxcl9jb2RlX3NjYW5uZXIiLAogICAgICAgIG9uQ2xpY2s6IGBAIGNvbmZpZ0JvdC50YWdzLnB1Ymxpc2hTY2FuID0gdHJ1ZTsgb3Mub3BlblFSQ29kZVNjYW5uZXIoKTtgLAogICAgfSk7Cn0KCmxldCBob3N0QnV0dG9uID0gewogICAgYWJNZW51OiB0cnVlLAogICAgYWJNZW51U29ydE9yZGVyOiA1MCwKICAgIGFiTWVudVJlZnJlc2g6ICJAIGRlc3Ryb3kodGhpc0JvdCk7IiwKICAgIGZvcm1BZGRyZXNzOiAiZ3JvdXBfYWRkIiwKICAgIGNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yLAogICAgbGVhcm46IHRhZ3MubGVhcm4sCiAgICBvbkNsaWNrOiBgQCBsaW5rcy5sZWFybi5hYkNyZWF0ZUhvc3QodGhpc0JvdCk7CiAgICBpZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEKQogICAgewogICAgICAgIHRhZ3MubGFiZWwgPSAnZ2VuZXJhdGluZyBjb2RlIG5vdyc7CiAgICB9YCwKfTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiam9pbiBjb2RlOiAiICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDAsIDMpICsgIi0iICsgbGlua3MucmVtZW1iZXIudGFncy5ob3N0SUQuc3Vic3RyaW5nKDMpOwp9CmVsc2UgCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiZ2VuZXJhdGUgam9pbiBjb2RlIjsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnN0YXRpY0luc3QgPT0gdW5kZWZpbmVkKQp7CiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihob3N0QnV0dG9uKTsvL2dlbmVyYXRlIGEgaG9zdCBidXR0b24KfScAgdTs8g/36QEOYWJDb3JlTWVudUljb24CBACB1OzyD7WMAwlpb3Nfc2hhcmUnAIHU7PIP9+kBD2FiQ29yZU1lbnVMYWJlbAIEAIHU7PIPv4wDBXNoYXJlJwCB1OzyD/fpARNhYkNvcmVNZW51U29ydE9yZGVyAgQAgdTs8g/FjAMBMycAgdTs8g/36QEIcmVtZW1iZXICBACB1OzyD8eMAyjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCB1OzyD/fpAQthYlB1Ymxpc2hBQgIEAIHU7PIP7owDgTRALy9zaG91dCgiYWJQdWJsaXNoQUIiLCB7YWI6ICIiLCBrZXk6ICIiLCB0YXJnZXQ6ICIifSk7CmlmICh0aGF0LmFiLmluZGV4T2YoIiAiKSAhPSAtMSB8fCB0aGF0LmFiLmluZGV4T2YoJyInKSAhPSAtMSkgewogICAgb3MudG9hc3QoInBhdHRlcm4gbmFtZXMgbWF5IG5vdCBjb250YWluIHNwYWNlcyBvciBxdW90YWlvbiBtYXJrcywgcGxlYXNlIHRyeSBhZ2Fpbi4iKTsKCiAgICByZXR1cm47Cn0KCmFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBwdWJsaXNoaW5nICIgKyB0aGF0LmFiKTsKCmxldCBwcm9ncmVzc0J1dHRvbjsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgovL2NsZWFyIGFiIGJ1aWxkZXIKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24pIHsKICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KSB7CiAgICAgICAgZGVzdHJveShsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KTsKICAgIH0KfQoKLy9wcm9ncmVzcyBiYXIgZm9yIG1hbnVhbCBwdWJsaXNoaW5nIGNvbmZpcm1hdGlvbgppZiAoY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCkgewogICAgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5pbnB1dC5hYlByb2dyZXNzQmFyKGB1cGxvYWRpbmcgJHt0aGF0LmFifWApOwp9CgovL2FiIHZhcmlhYmxlcwpsZXQgYWJJRCA9IHRoYXQuYWI7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IHRhcmdldCA9IHRoYXQudGFyZ2V0ID8gdGhhdC50YXJnZXQgOiB0aGF0LmJvdDsKbGV0IHJldHVyblR5cGUgPSB0aGF0LnJldHVyblR5cGU7CmxldCBwdWJsaWNGYWNpbmcgPSB0aGF0LnB1YmxpY0ZhY2luZyA/PyBjb25maWdCb3QudGFncy5wdWJsaWNGYWNpbmc7CmxldCBzdGF0ZSA9IHt9OwpsZXQgZm9ybWF0dGVkRmlsZSA9IHt9OwoKY29uZmlnQm90LnRhZ3MucHVibGljRmFjaW5nID0gbnVsbDsKCi8vdGhpcyBsb2dpYyBmb3JtYXRzIHRoZSBzcGVjaWZpZWQgYm90cyBhbmQgcGFja2FnZXMgdGhlbSBmb3IgcHVibGlzaGluZwppZiAoIUFycmF5LmlzQXJyYXkodGFyZ2V0KSAmJiB0YXJnZXQgIT0gbnVsbCAmJiB0YXJnZXQgIT0gdW5kZWZpbmVkKSB7Cgp9CmVsc2UgaWYgKCF0YXJnZXQgfHwgdGFyZ2V0Lmxlbmd0aCA8IDEpIHsKICAgIGNvbnN0IGJhc2VBQiA9IHRoYXQuYmFzZUFCID8/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCOwoKICAgIGlmIChjb25maWdCb3QudGFncy5hYkV4Y2x1ZGVVbmNsYWltZWQgJiYgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQikgewogICAgICAgIHRhcmdldCA9IGdldEJvdHMoYnlNb2QoeyBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsLCBhYklET3JpZ2luOiBhYklEIH0pKTsKCiAgICAgICAgY29uZmlnQm90LnRhZ3MuYWJFeGNsdWRlVW5jbGFpbWVkID0gbnVsbDsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkQUIgJiYgZ2V0Qm90KCJhYklET3JpZ2luIiwgYmFzZUFCKSkgewogICAgICAgIGNvbnN0IGVnZ0JvdHMgPSBnZXRCb3RzKGJ5TW9kKHsgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbCwgYWJJRE9yaWdpbjogY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiB9KSk7CiAgICAgICAgY29uc3QgbmV3Qm90cyA9IGdldEJvdHMoYnlNb2QoeyBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsLCBhYklET3JpZ2luOiBudWxsIH0pKTsKCiAgICAgICAgdGFyZ2V0ID0gWy4uLmVnZ0JvdHMsIC4uLm5ld0JvdHNdOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgdGFyZ2V0ID0gZ2V0Qm90cyhieU1vZCh7IHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGwgfSkpOwogICAgfQoKICAgIHNldFRhZyh0YXJnZXQsICJhYklET3JpZ2luIiwgYWJJRCk7CgogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IG51bGw7CgogICAgaWYgKHRhcmdldC5sZW5ndGggPCAxKSB7CiAgICAgICAgb3MudG9hc3QoIk5vIGJvdHMgZm91bmQgdG8gcHVibGlzaCIpOwoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL3RoaXMgbG9naWMgaGFuZGxlcyBnZW5lcmF0aW5nIGEga2V5IGZvciBlbmNyeXB0aW9uIChvcHRpb25hbCkKaWYgKGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24pIHsKICAgIGxldCBrZXlDaGVjazsKCiAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKCiAgICBrZXkgPSBhd2FpdCBvcy5zaG93SW5wdXQoIiIsIHsKICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICB0aXRsZTogJ2VudGVyIGEgc2VjcmV0IGtleScKICAgIH0pOwoKICAgIGlmIChrZXkpIHsKICAgICAgICBrZXlDaGVjayA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdjb25maXJtIHNlY3JldCBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKGtleSAhPSBrZXlDaGVjaykgewogICAgICAgIGlmICgha2V5Q2hlY2spIHsKICAgICAgICAgICAgb3MudG9hc3QoIm5vIGtleSBlbnRlcmVkIik7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBvcy50b2FzdCgia2V5cyBkbyBub3QgbWF0Y2giKTsKICAgICAgICB9CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vZm9ybWF0dGluZyBib3RzIGZvciBmaWxlIHN0b3JhZ2UKaWYgKEFycmF5LmlzQXJyYXkodGFyZ2V0KSkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YXJnZXQubGVuZ3RoOyBpKyspIHsKICAgICAgICBsZXQgY3VycmVudEJvdElEID0gdGFyZ2V0W2ldLmlkOwogICAgICAgIGxldCBjdXJyZW50Qm90ID0gdGFyZ2V0W2ldOwoKICAgICAgICBzdGF0ZVtjdXJyZW50Qm90SURdID0gY3VycmVudEJvdDsKICAgIH0KfQplbHNlIHsKICAgIHN0YXRlW3RhcmdldC5pZF0gPSB0YXJnZXQ7Cn0KCi8vY2hlY2tzIGZvciBwcmV2aW91cyBlZ2dzIGFuZCByZXR1cm5zIGRhdGEgZm9yIHByZXZpb3VzbHkgcHVibGlzaGVkIGFiJ3MKbGV0IGVnZ0NoZWNrID0gYXdhaXQgdGhpc0JvdC5hYlByZXZpb3VzRWdnQ2hlY2soeyBhYklEOiBhYklEIH0pOwoKLy9hZGQgeHAgYm90IGhlcmUKY29uc3QgeHBWZXJzaW9uQm90ID0ge307Cgp4cFZlcnNpb25Cb3Quc3BhY2UgPSAic2hhcmVkIjsKeHBWZXJzaW9uQm90LmlkID0gImFiWFBCb3QiOwp4cFZlcnNpb25Cb3QudGFncyA9IHt9Owp4cFZlcnNpb25Cb3QudGFncy5mb3JtID0gIm5vdGhpbmciOwp4cFZlcnNpb25Cb3QudGFncy5zeXN0ZW0gPSAiYWIucGF0dGVybi5hYlhQQm90IjsKeHBWZXJzaW9uQm90LnRhZ3MuYXV0aG9ySUQgPSBhdXRoQm90LmlkOwp4cFZlcnNpb25Cb3QudGFncy52ZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uOwp4cFZlcnNpb25Cb3QudGFncy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKeHBWZXJzaW9uQm90LnRhZ3Muc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwp4cFZlcnNpb25Cb3QudGFncy5hYklnbm9yZSA9IHRydWU7CgpzdGF0ZS5hYlhQQm90ID0geHBWZXJzaW9uQm90OwoKLy9hZGRpdGlvbmFsIGZpbGUgZGF0YQpmb3JtYXR0ZWRGaWxlLnZlcnNpb24gPSAxOwpmb3JtYXR0ZWRGaWxlLnNpZ25hdHVyZSA9IGVnZ0NoZWNrLnNpZ25hdHVyZTsKZm9ybWF0dGVkRmlsZS5zdGF0ZSA9IHN0YXRlOwoKLy9hY3R1YWwgZW5jcnlwdGlvbiBpZiBjaG9zZW4KaWYgKGtleSkgewogICAgZm9ybWF0dGVkRmlsZSA9IEpTT04uc3RyaW5naWZ5KGZvcm1hdHRlZEZpbGUpOwoKICAgIGZvcm1hdHRlZEZpbGUgPSBjcnlwdG8uZW5jcnlwdChrZXksIGZvcm1hdHRlZEZpbGUpOwp9CgovL3B1Ymxpc2ggdGhlIGZpbGUKbGV0IHB1Ymxpc2hGaWxlID0gYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hGaWxlKHsgZmlsZTogZm9ybWF0dGVkRmlsZSwgZmlsZU5hbWU6IGFiSUQgfSk7CgovL2dhdGhlciBhZGRpb25hbCBlZ2cgZGF0YQpjb25zdCBhaVBlcm1pdENoZWNrID0gYXdhaXQgb3MuZ2V0RGF0YShhdXRoQm90LmlkLCAiYWlfcGVybWl0Iik7CmNvbnN0IGFpUGVybWl0SUQgPSBhaVBlcm1pdENoZWNrLnN1Y2Nlc3MgPyBhaVBlcm1pdENoZWNrLmRhdGEucGVybWl0SUQgOiBmYWxzZTsKCmVnZ0NoZWNrLmVnZ0RhdGEuYWlQZXJtaXQgPSBhaVBlcm1pdElEOwplZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5LnB1c2gocHVibGlzaEZpbGUudXJsKTsKZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CmVnZ0NoZWNrLmVnZ0RhdGEudGFyZ2V0VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwoKLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKbGV0IHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7IGRhdGE6IGVnZ0NoZWNrLmVnZ0RhdGEsIHJlY29yZE5hbWU6IGFiSUQsIHB1YmxpY0ZhY2luZzogcHVibGljRmFjaW5nIH0pOwpsZXQgc2l0ZU9yaWdpbiA9IG5ldyBVUkwoY29uZmlnQm90LnRhZ3MudXJsKS5vcmlnaW47CgovL3B1Ymxpc2hpbmcgc2hvdXQKc3VwZXJTaG91dCgib25BQlB1Ymxpc2hlZCIsIHsgc3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmwgfSk7CnN1cGVyU2hvdXQoIm9uQWJQdWJsaXNoZWQiLCB7IHN1Y2Nlc3M6IHB1Ymxpc2hGaWxlLnN1Y2Nlc3MsIGFiOiBhYklELCBmaWxlQWRkcmVzczogcHVibGlzaEZpbGUudXJsIH0pOyAvLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KCmNvbnN0IHN0dWRpb0xpbmsgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKLy9zZW5kIGRhdGEgYW5kIGZvcm1hdCB1cmwgaWYgZGF0YSBzdWNjZXNzZnVsbHkgc2VudAppZiAocHVibGlzaFJlY29yZC5zdWNjZXNzKSB7CiAgICBjb25zdCBiaW9zID0gcHVibGljRmFjaW5nID8gImZyZWUiIDogImxvY2FsIjsKICAgIGNvbnN0IGluc3RUeXBlID0gcHVibGljRmFjaW5nID8gImZyZWUiIDogImxvY2FsIjsKCiAgICBzZXRUYWdNYXNrKGxpbmtzLmxlYXJuLCAiYWJYUCIsICIwIiwgImxvY2FsIik7CgogICAgaWYgKGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2gpIHsKICAgICAgICBjb25zdCB1cmwgPSBzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICImc3R1ZGlvPSIgKyBzdHVkaW9MaW5rICsgIiZiaW9zPSIgKyBiaW9zOwogICAgICAgIG9zLnNldENsaXBib2FyZCh1cmwpOwoKICAgICAgICBpZiAoa2V5KSB7CiAgICAgICAgICAgIG9zLnRvYXN0KGAke2luc3RUeXBlfSBpbnN0IHVybCB3aXRoIGVuY3J5cHRlZCBkYXRhIGNvcGllZCB0byBjbGlwYm9hcmRgLCA1KTsKICAgICAgICAgICAgYWIubG9nKGAke2FiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX06ICR7aW5zdFR5cGV9IGluc3QgdXJsIHdpdGggZW5jcnlwdGVkIGRhdGEgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGAke2FiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX06ICR7aW5zdFR5cGV9IGluc3QgdXJsIHdpdGggZW5jcnlwdGVkIGRhdGEgY29waWVkIHRvIGNsaXBib2FyZDogJHt1cmx9YCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb3MudG9hc3QoYCR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmRgLCA1KTsKICAgICAgICAgICAgYWIubG9nKGAke2FiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eX06ICR7aW5zdFR5cGV9IGluc3QgdXJsIGNvcGllZCB0byBjbGlwYm9hcmQ6ICR7dXJsfWApOwogICAgICAgICAgICBjb25zb2xlLmxvZyhgJHthYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHl9OiAke2luc3RUeXBlfSBpbnN0IHVybCBjb3BpZWQgdG8gY2xpcGJvYXJkOiAke3VybH1gKTsKICAgICAgICB9CiAgICB9CgogICAgdHJ5IHsKICAgICAgICBhd2FpdCBhbmFseXRpY3MucmVjb3JkRXZlbnQoJ2FiX2VnZ19wdWJsaXNoJywgeyBhYjogYWJJRCwgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggfSk7CiAgICB9CiAgICBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgfQp9CmVsc2UgewogICAgaWYgKCFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUpIHsKICAgICAgICBvcy50b2FzdCgicHVibGlzaGluZyBmYWlsZWQsIHBsZWFzZSB0cnkgYWdhaW4iKTsKICAgIH0KCiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogcHVibGlzaGluZyBmYWlsZWQiKTsKCiAgICBjb25zb2xlLmxvZyhwdWJsaXNoUmVjb3JkKTsKfQoKLy9jbGVhciBwcm9ncmVzcyBiYXIKaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCA9IG51bGw7CgpyZXR1cm4gcHVibGlzaFJlY29yZDsnAIHU7PIP9+kBCGFiSWdub3JlAgQAgdTs8g/wwAMEdHJ1ZScAgdTs8g/36QEKYWJEb3dubG9hZAIEAIHU7PIP9cADxAZALy9kb3dubG9hZCBib3RzIChlaXRoZXIgc2VsZWN0ZWQgb3IgYWxsIGV4cGVyaWVuY2UpCmxldCBkb3dubG9hZEJvdHM7Cgpjb25zb2xlLmxvZygiZG93bmxvYWQiLCB0aGF0KTsKCmlmIChBcnJheS5pc0FycmF5KHRoYXQucG9zc2libGVCb3RzKSkKewogICAgaWYgKHRoYXQucG9zc2libGVCb3RzLmxlbmd0aCA+IDApCiAgICB7CiAgICAgICAgZG93bmxvYWRCb3RzID0gdGhhdC5wb3NzaWJsZUJvdHM7CgogICAgICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkb3dubG9hZGluZyBib3RzIik7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgZG93bmxvYWRCb3RzID0gZ2V0Qm90cyhieU1vZCh7ImFiSWdub3JlIjogbnVsbCwgInNwYWNlIjogInNoYXJlZCJ9KSk7CgogICAgICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkb3dubG9hZGluZyBpbnN0Iik7CiAgICB9ICAgIAp9CmVsc2UKewoKCiAgICBkb3dubG9hZEJvdHMgPSBbdGhhdC5wb3NzaWJsZUJvdHNdOwoKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAiOiBkb3dubG9hZGluZyBib3QiKTsKfQoKaWYgKCFBcnJheS5pc0FycmF5KGRvd25sb2FkQm90cykpCnsKICAgIGRvd25sb2FkQm90cyA9IFtkb3dubG9hZEJvdHNdOwp9CgpsZXQgY3VycmVudEluc3QgPSBvcy5nZXRDdXJyZW50SW5zdCgpOwoKb3MuZG93bmxvYWRCb3RzKGRvd25sb2FkQm90cywgY3VycmVudEluc3QpOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOycAgdTs8g/36QENbWFuaWZlc3RhdGlvbgIEAIHU7PIPuscDKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAIHU7PIP9+kBBG1lbnUCBACB1OzyD+HHAyjwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCB1OzyD/fpARJhYlByZXZpb3VzRWdnQ2hlY2sCBACB1OzyD4jIA7EPQC8vdGhpcyBmdW5jdGlvbiBjaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYXQgYSBzcGVjaWZpZWQgYWIsIHJldHVybmluZyBhbnkgZGF0YSB0aGF0IGl0IGZpbmRzCmNvbnN0IGFiSUQgPSB0aGF0LmFiSUQ7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKbGV0IGVnZ0hpc3Rvcnk7CmxldCBlZ2dJRDsKbGV0IHRhcmdldFZlcnNpb25OdW07CmxldCBsYXN0SGFzaDsKbGV0IG1heFZlcnNpb25OdW07CmxldCBzdGFibGVWZXJzaW9uOwpsZXQgZmVlZGJhY2tWZXJzaW9uOwpsZXQgcHJldmlvdXNYUDsKbGV0IHVzZXJSZWNvcmQgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKbGV0IHJlY29yZExvb2t1cCA9IGF3YWl0IG9zLmdldERhdGEodXNlclJlY29yZCwgYWJJRCkuY2F0Y2goZSA9PiB7fSk7CgppZiAocmVjb3JkTG9va3VwLnN1Y2Nlc3MpIAp7CiAgICBlZ2dIaXN0b3J5ID0gcmVjb3JkTG9va3VwLmRhdGEuZWdnVmVyc2lvbkhpc3Rvcnk7CiAgICBlZ2dJRCA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ0lEOwogICAgcHJldmlvdXNYUCA9IHJlY29yZExvb2t1cC5kYXRhLnhwID8/IDA7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwogICAgbGFzdEhhc2ggPSBlZ2dIaXN0b3J5W3RhcmdldFZlcnNpb25OdW0gLSAxXTsKICAgIHN0YWJsZVZlcnNpb24gPSByZWNvcmRMb29rdXAuZGF0YS5zdGFibGVWZXJzaW9uOwogICAgZmVlZGJhY2tWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuZmVlZGJhY2tWZXJzaW9uOwogICAgbWF4VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKfSAKZWxzZSAKewogICAgZWdnSGlzdG9yeSA9IFtdOwogICAgZWdnSUQgPSB1dWlkKCk7CiAgICB0YXJnZXRWZXJzaW9uTnVtID0gMTsKICAgIGxhc3RIYXNoID0gIm5vbmUiOwogICAgbWF4VmVyc2lvbk51bSA9IDE7CiAgICBwcmV2aW91c1hQID0gMDsKfQoKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJmZWVkYmFjayIpIAp7CiAgICBmZWVkYmFja1ZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbkRlZmluZWQgPT0gInN0YWJsZSIpCnsKICAgIHN0YWJsZVZlcnNpb24gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0KCmNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID0gbnVsbDsKCmxldCBlZ2cgPSB7fTsKCmVnZy5lZ2dWZXJzaW9uSGlzdG9yeSA9IGVnZ0hpc3Rvcnk7CmVnZy5lZ2dGb3JtYXRWZXJzaW9uID0gZWdnSUQ7CmVnZy50YXJnZXRWZXJzaW9uID0gdGFyZ2V0VmVyc2lvbk51bTsKZWdnLm1heFZlcnNpb24gPSBtYXhWZXJzaW9uTnVtOwplZ2cubGFiZWwgPSAidiIrdGFyZ2V0VmVyc2lvbk51bTsKZWdnLnN0YWJsZVZlcnNpb24gPSBzdGFibGVWZXJzaW9uOwplZ2cuZmVlZGJhY2tWZXJzaW9uID0gZmVlZGJhY2tWZXJzaW9uOwplZ2cuYWJJRCA9IGFiSUQ7CmVnZy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKCmxldCBzaWduYXR1cmUgPSB7fTsKbGV0IGRhdGUgPSBuZXcgRGF0ZSgpOwpsZXQgdGltZSA9IGRhdGUuZ2V0VGltZSgpOwoKc2lnbmF0dXJlLnByZXZpb3VzSGFzaCA9IGxhc3RIYXNoOwpzaWduYXR1cmUuYWJWZXJzaW9uID0gbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVWZXJzaW9uOwpzaWduYXR1cmUuZWdnVmVyc2lvbiA9IHRhZ3MuZWdnVVVJRDsKc2lnbmF0dXJlLmVnZ1ZlcnNpb25OdW0gPSB0YWdzLm92b1ZlcnNpb247CnNpZ25hdHVyZS50aW1lU3RhbXAgPSB0aW1lOwpzaWduYXR1cmUuY2FzdWFsT1NWZXJzaW9uID0gW29zLnZlcnNpb24oKV07CgpyZXR1cm4ge3NpZ25hdHVyZTogc2lnbmF0dXJlLCBlZ2dEYXRhOiBlZ2d9OycAgdTs8g/36QEPYWJCb3RNZW51QWN0aW9uAgQAgdTs8g+61wNNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAIHU7PIP9+kBDmFiQm90TWVudUxhYmVsAgQAgdTs8g+I2AMFc2hhcmUnAIHU7PIP9+kBDWFiQm90TWVudUljb24CBACB1OzyD47YAwlpb3Nfc2hhcmUnAIHU7PIP9+kBEmFiQm90TWVudVNvcnRPcmRlcgIEAIHU7PIPmNgDAzMuNScAgdTs8g/36QEFbGVhcm4CBACB1OzyD5zYAyjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwCB1OzyD/fpAQthYlFSUHVibGlzaAIEAIHU7PIPw9gDxgFAY29uZmlnQm90LnRhZ3MucHVibGlzaFNjYW4gPSBudWxsOwoKbGV0IHNjYW5uZWRVUkw7Cgp0cnkgCnsKICAgIHNjYW5uZWRVUkwgPSBuZXcgVVJMKHRoYXQpOwp9CmNhdGNoIChlKSAKewogICAgc2hvdXQoImFiUHVibGlzaEFCIiwge2FiOiB0aGF0fSk7CgogICAgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IHRoYXR9KTsKCiAgICByZXR1cm47Cn0nAIHU7PIP9+kBBnNlYXJjaAIEAIHU7PIPitoDKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAIHU7PIP9+kBB2FiU2hlbGwCBACB1OzyD7HaAwR0cnVlJwCB1OzyD/fpAQxzdHVkaW9TZWxlY3QCBACB1OzyD7baA4sLQC8vc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiU3R1ZGlvTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHN0dWRpb3MgPSB0aGF0LnN0dWRpb3M7CmNvbnN0IHRhcmdldFN0dWRpbyA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zdHVkaW8gPyBjb25maWdCb3QudGFncy5zdHVkaW8gOiBhdXRoQm90LmlkOwpjb25zdCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLmFiU3R1ZGlvTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMDsKbWVudUJ1dHRvbi5hYk1lbnVSZWZyZXNoID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLmFiU3R1ZGlvTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5saW5rcy5zdHVkaW9TZWxlY3RCdXR0b24udGFncy5sYWJlbCA9IHRhZ3MubGFiZWw7CgpzaG91dCgiYWJTdHVkaW9NZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjtgOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cgpmb3IgKGxldCBpID0gMDsgaSA8IHN0dWRpb3MubGVuZ3RoOyBpKyspCnsKICAgIGxldCBhY3RpdmVTdHVkaW8gPSBzdHVkaW9zW2ldOwoKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwCB1OzyD/fpAQ5hYlB1Ymxpc2hBc2tJRAIEAIHU7PIPwOUD9ARAbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgcHVibGlzaGluZyAke3RoYXQuYXNrSUR9YCk7Cgphd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKY29uc3QgcGF0dGVybklEID0gdGhhdC5wYXR0ZXJuSUQ7CmNvbnN0IHN0dWRpb0lEID0gdGhhdC5zdHVkaW9JRCA/IHRoYXQuc3R1ZGlvSUQgOiBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEIDogYXV0aEJvdC5pZDsKY29uc3QgYXNrSUQgPSAiYXNrXyIgKyB0aGF0LmFza0lELnJlcGxhY2VBbGwoIi0iLCAiIik7CmNvbnN0IGVuZHBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50Owpjb25zdCBwdWJsaXNoQXNrID0gYXdhaXQgb3MucmVjb3JkRGF0YShsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5LCBhc2tJRCwge3BhdHRlcm5JRDogcGF0dGVybklELCBzdHVkaW9JRDogc3R1ZGlvSUR9LCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCB1cGRhdGVQb2xpY3k6IFthdXRoQm90LmlkXX0pOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHB1Ymxpc2hBc2s7JwCB1OzyD/fpAQVpbnB1dAIEAIHU7PIPteoDKPCflJdmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjAnAIHU7PIP9+kBC2FiRW1iZWRMaW5rAgQAgdTs8g/c6gOkA0Bjb25zdCBhYiA9IHRoYXQgPyB0cnVlIDogZmFsc2U7CmNvbnN0IGVtYmVkTGluayA9IGFiID8gImFiPSIgKyB0aGF0IDogImluc3Q9IiArIGNvbmZpZ0JvdC50YWdzLmluc3Q7CmNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwpjb25zdCBlbWJlZFRleHQgPSBgPCFET0NUWVBFIGh0bWw+CsKgwqDCoMKgPGh0bWw+CsKgwqDCoMKgwqDCoMKgwqA8aGVhZD48L2hlYWQ+CsKgwqDCoMKgwqDCoMKgwqA8Ym9keT4KwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgPGlmcmFtZSBzcmM9IiR7c2l0ZU9yaWdpbiArICIvPyIgKyBlbWJlZExpbmt9IiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSI0MDAiIC8+CsKgwqDCoMKgwqDCoMKgwqA8L2JvZHk+CsKgwqDCoMKgPC9odG1sPmA7CgpyZXR1cm4gZW1iZWRUZXh0OycAgdTs8g/36QEPYWJQYXR0ZXJuVXBkYXRlAgQAgdTs8g/V7QPnBEAvL3Nob3V0KCJhYlBhdHRlcm5VcGRhdGUiLCB7YWJJRDogYWJJRCwgc3R1ZGlvOnN0dWRpbz8sIGJvdHM6IGJvdHM/fSk7CmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgppZiAoIWF1dGhCb3QpCnsKICAgIHJldHVybjsKfQoKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKY29uc3Qgc3R1ZGlvID0gdGhhdC5zdHVkaW8gPyB0aGF0LnN0dWRpbyA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IGFiTWFuaWZlc3QgPSBnZXRCb3QoYnlNb2Qoe2FiRWdnOiB0cnVlLCBvcmlnaW5fYWI6IGFiSUR9KSk7CgppZiAoIWFiTWFuaWZlc3QpCnsKICAgIHNob3V0KCJvbkxvb2t1cEFCRWdncyIsIHthYklEOiBhYklELCByZWNvcmRLZXk6IHN0dWRpbywgYXV0b0hhdGNoOiB0cnVlfSk7CgogICAgcmV0dXJuOwp9Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IHN0dWRpbzsKCmNvbnN0IGFiQm90cyA9IHRoYXQuYm90cyA/PyBnZXRCb3RzKCJhYklET3JpZ2luIiwgYWJJRCk7Cgphd2FpdCB0aGlzQm90LmFiUHVibGlzaEFCKHthYjogYWJJRCwgdGFyZ2V0OiBhYkJvdHMsIHB1YmxpY0ZhY2luZzogdHJ1ZX0pOycAgdTs8g/36QEXYWJNdWx0aXBsZUJvdE1lbnVBY3Rpb24CBACB1OzyD73yA01AYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCi8vc2V0IHVwIHRoZSBwdWJsaXNoIG1lbnUKdGhpc0JvdC5vblN0b3JlTWVudSgpOycAgdTs8g/36QEaYWJNdWx0aXBsZUJvdE1lbnVTb3J0T3JkZXICBACB1OzyD4vzAwEyJwCB1OzyD/fpARVhYk11bHRpcGxlQm90TWVudUljb24CBACB1OzyD43zAwlpb3Nfc2hhcmUnAIHU7PIP9+kBFmFiTXVsdGlwbGVCb3RNZW51TGFiZWwCBACB1OzyD5fzAwVzaGFyZScAgdTs8g/36QEPYWJQdWJsaXNoU2VsZWN0AgQAgdTs8g+d8wOJE0AvL3Nob3V0KCJhYk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYlBhdHRlcm5NZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3QgYWxsQm90cyA9IGdldEJvdHMoImFiSURPcmlnaW4iKTsKY29uc3QgYWxsUGF0dGVybnMgPSBbIm5ldyBwYXR0ZXJuIl07Cgpib3RMb29wOgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbEJvdHMubGVuZ3RoOyBpKyspCnsKICAgIGNvbnN0IGFjdGl2ZUJvdCA9IGFsbEJvdHNbaV07CgogICAgaWYgKGFjdGl2ZUJvdC50YWdzLmFiSWdub3JlKQogICAgewogICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICB9CgogICAgY29uc3QgcG9zc2libGVQYXR0ZXJuID0gYWN0aXZlQm90LnRhZ3MuYWJJRE9yaWdpbjsKCiAgICBmb3IgKGxldCBqID0gMDsgaiA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaisrKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVBhdHRlcm4gPSBhbGxQYXR0ZXJuc1tqXTsKCiAgICAgICAgaWYgKGFjdGl2ZVBhdHRlcm4gPT0gcG9zc2libGVQYXR0ZXJuICkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnRpbnVlIGJvdExvb3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGogPT0gYWxsUGF0dGVybnMubGVuZ3RoIC0gMSkKICAgICAgICB7CiAgICAgICAgICAgIGFsbFBhdHRlcm5zLnB1c2gocG9zc2libGVQYXR0ZXJuKTsKICAgICAgICB9CiAgICB9Cn0KCmNvbnN0IHRhcmdldEFCID0gbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUI7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudSA9IHRydWU7Cm1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IDA7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5hYlBhdHRlcm5NZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7Cm1lbnVCdXR0b24ucmVtZW1iZXIgPSB0YWdzLnJlbWVtYmVyOwptZW51QnV0dG9uLm9uQ2xpY2sgPSBgQGNvbnN0IHRvdGFsUGF0dGVybkJvdHMgPSBnZXRCb3RzKGJ5TW9kKHthYklET3JpZ2luOiB0YWdzLmxhYmVsLCBzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwpjb25zdCBub25QYXR0ZXJuQm90cyA9IGdldEJvdHMoYnlNb2Qoe2FiSURPcmlnaW46IG51bGwsIHNwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSk7CgpzaG91dCgiYWJTZWxlY3RUaXRsZVVwZGF0ZSIsIHthYjogdGFncy5sYWJlbCwgYWJCb3RzOiB0b3RhbFBhdHRlcm5Cb3RzLmxlbmd0aCwgbm9uQUJCb3RzOiBub25QYXR0ZXJuQm90cy5sZW5ndGh9KTsKCmxpbmtzLnJlbWVtYmVyLm1hc2tzLmJhc2VBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRBQiA9IHRhZ3MubGFiZWwgPT0gIm5ldyBwYXR0ZXJuIiA/IG51bGwgOiB0YWdzLmxhYmVsOwoKc2hvdXQoImFiUGF0dGVybk1lbnVSZWZyZXNoIik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiO2A7CgphbGxQYXR0ZXJucy5zb3J0KCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFsbFBhdHRlcm5zLmxlbmd0aDsgaSsrKQp7CiAgICBsZXQgYWN0aXZlUGF0dGVybk5hbWUgPSBhbGxQYXR0ZXJuc1tpXTsKCiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gdGFyZ2V0QUIgPT0gYWN0aXZlUGF0dGVybk5hbWUgPyAicmFkaW9fYnV0dG9uX2NoZWNrZWQiIDogInJhZGlvX2J1dHRvbl91bmNoZWNrZWQiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9IGFjdGl2ZVBhdHRlcm5OYW1lOwoKICAgIGlmIChhY3RpdmVQYXR0ZXJuTmFtZSA9PSAibmV3IHBhdHRlcm4iKQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IC0xOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIG1lbnVCdXR0b24uYWJQYXR0ZXJuTWVudVNvcnRPcmRlciA9IGk7CiAgICB9CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7Cn0KCmlmICghZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBmb3JtQWRkcmVzczogInJhZGlvX2J1dHRvbl9jaGVja2VkIn0pKSkKewogICAgY29uc3QgbmV3Qm90ID0gZ2V0Qm90KGJ5TW9kKHthYlBhdHRlcm5NZW51OiB0cnVlLCBsYWJlbDogIm5ldyBwYXR0ZXJuIn0pKTsKICAgIAogICAgbmV3Qm90LnRhZ3MuZm9ybUFkZHJlc3MgPSAicmFkaW9fYnV0dG9uX2NoZWNrZWQiOwp9JwCB1OzyD/fpAQlhYlZlcnNpb24CBACB1OzyD6WGBAQxMC40JwEEYm90cyQ3OGU0MTUwMy1jOTMzLTRmOGEtODE3YS1iYTk3YmY4ZDVkMjcBJwCB1OzyD6qGBAZzeXN0ZW0CBACB1OzyD6uGBBFhYi5zaGVsbC5hcnRpZmFjdCcAgdTs8g+qhgQIYWJJZ25vcmUCBACB1OzyD72GBAR0cnVlJwCB1OzyD6qGBAlhYlZlcnNpb24CBACB1OzyD8KGBAQxMC40JwCB1OzyD6qGBAVkZWJ1ZwIEAIHU7PIPx4YEBHRydWUnAIHU7PIPqoYECHJlbWVtYmVyAgQAgdTs8g/MhgQo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAgdTs8g+qhgQTYWJDcmVhdGVBcnRpZmFjdEJvdAIEAIHU7PIP84YE9gRAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3ROYW1lLAogICAgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gPSB0YWdzLmFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uIC8vIERlZmF1bHQgdG8gdGhlIGN1cnJlbnQgZm9ybWF0IHZlcnNpb24uCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKaWYgKGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uID09IG51bGwpIHsKICAgIHRocm93IG5ldyBFcnJvcihgYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24gJHthYkFydGlmYWN0Rm9ybWF0VmVyc2lvbn0gaXMgbm90IHZhbGlkLmApOwp9Cgpjb25zdCBmdW5jVGFnTmFtZSA9IGBhYkNyZWF0ZUFydGlmYWN0Qm90X3Yke2FiQXJ0aWZhY3RGb3JtYXRWZXJzaW9ufWA7CgppZiAodHlwZW9mIHRoaXNCb3RbZnVuY1RhZ05hbWVdICE9PSAnZnVuY3Rpb24nKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZnVuY1RhZ05hbWV9IGlzIG5vdCBhIGZ1bmN0aW9uLmApCn0KCi8vIENhbGwgdGhlIHZlcnNpb25lZCBjcmVhdGUgZnVuY3Rpb24uCnJldHVybiB0aGlzQm90W2Z1bmNUYWdOYW1lXSh0aGF0KTsnAIHU7PIPqoYEIGFiQXBwbHlBcnRpZmFjdE1hbmlmZXN0YXRpb25UYWdzAgQAgdTs8g/qiwSFC0Bjb25zdCB7IAogICAgYWJBcnRpZmFjdEJvdCwKICAgIGRpbWVuc2lvbiA9IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwgPz8gJ2hvbWUnLAogICAgcG9zaXRpb24gPSBuZXcgVmVjdG9yMygwLCAwLCAwKSwKICAgIGN1c3RvbVRhZ3MgPSB7fQp9ID0gdGhhdCA/PyB7fTsKCmFzc2VydChhYkFydGlmYWN0Qm90ICYmIGFiQXJ0aWZhY3RCb3Quc3BhY2UgJiYgYWJBcnRpZmFjdEJvdC50YWdzLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3RCb3QgaXMgYSByZXF1aXJlZCB0byBiZSBhIEJvdC5gKTsKCmNvbnN0IGFiQXJ0aWZhY3RCYXNlQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0QmFzZUNvbG9yRGVmYXVsdDsKY29uc3QgYWJBcnRpZmFjdExhYmVsQ29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQXJ0aWZhY3RMYWJlbENvbG9yID8/IHRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0OwoKYWJBcnRpZmFjdEJvdC50YWdzW2RpbWVuc2lvbl0gPSB0cnVlOwphYkFydGlmYWN0Qm90LnRhZ3NbYCR7ZGltZW5zaW9ufVhgXSA9IHBvc2l0aW9uLng7CmFiQXJ0aWZhY3RCb3QudGFnc1tgJHtkaW1lbnNpb259WWBdID0gcG9zaXRpb24ueTsKYWJBcnRpZmFjdEJvdC50YWdzW2Ake2RpbWVuc2lvbn1aYF0gPSBwb3NpdGlvbi56OwphYkFydGlmYWN0Qm90LnRhZ3MuY29sb3IgPSBhYkFydGlmYWN0QmFzZUNvbG9yOwphYkFydGlmYWN0Qm90LnRhZ3MuY3Vyc29yID0gJ3BvaW50ZXInOwphYkFydGlmYWN0Qm90LnRhZ3MubGFiZWxDb2xvciA9IGFiQXJ0aWZhY3RMYWJlbENvbG9yOwphYkFydGlmYWN0Qm90LnRhZ3Muc3Ryb2tlQ29sb3IgPSBhYkFydGlmYWN0TGFiZWxDb2xvcjsKYWJBcnRpZmFjdEJvdC50YWdzLmxhYmVsID0gYGFydGlmYWN0OiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0TmFtZX1gOwphYkFydGlmYWN0Qm90LnRhZ3Mub25BQkFydGlmYWN0UmVjb25zdGl0dXRlID0gYEAKICAgIGNvbnN0IHsgYWJBcnRpZmFjdE5hbWUgfSA9IHRoYXQ7CiAgICAKICAgIGlmIChhYkFydGlmYWN0TmFtZSAhPT0gdGFncy5hYkFydGlmYWN0TmFtZSkgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBIaWRlIGFydGlmYWN0IGJvdCBvbmNlIGl0IGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQuCiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdmb3JtJywgJ25vdGhpbmcnLCAnc2hhcmVkJyk7CiAgICBzZXRUYWdNYXNrKHRoaXNCb3QsICdsYWJlbCcsICcgJywgJ3NoYXJlZCcpOwpgCgpmb3IgKGNvbnN0IHRhZ05hbWUgaW4gY3VzdG9tVGFncykgewogICAgYWJBcnRpZmFjdEJvdHMudGFnc1t0YWdOYW1lXSA9IGN1c3RvbVRhZ3NbdGFnTmFtZV07Cn0KCnJldHVybiBhYkFydGlmYWN0Qm90OycAgdTs8g+qhgQWYWJBcnRpZmFjdFJlY29uc3RpdHV0ZQIEAIHU7PIP8JYEigVAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3RCb3QKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdEJvdCAmJiBhYkFydGlmYWN0Qm90LnNwYWNlICYmIGFiQXJ0aWZhY3RCb3QudGFncywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0Qm90IGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBCb3QuYCk7Cgpjb25zdCBhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiA9IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbjsKCmlmIChhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiA9PSBudWxsKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoYGFiQXJ0aWZhY3RGb3JtYXRWZXJzaW9uICR7YWJBcnRpZmFjdEZvcm1hdFZlcnNpb259IGlzIG5vdCB2YWxpZC5gKTsKfQoKY29uc3QgZnVuY1RhZ05hbWUgPSBgYWJBcnRpZmFjdFJlY29uc3RpdHV0ZV92JHthYkFydGlmYWN0Rm9ybWF0VmVyc2lvbn1gOwoKaWYgKHR5cGVvZiB0aGlzQm90W2Z1bmNUYWdOYW1lXSAhPT0gJ2Z1bmN0aW9uJykgewogICAgdGhyb3cgbmV3IEVycm9yKGAke2Z1bmNUYWdOYW1lfSBpcyBub3QgYSBmdW5jdGlvbi5gKQp9CgovLyBDYWxsIHRoZSB2ZXJzaW9uZWQgcmVjb25zaXR1dGUgZnVuY3Rpb24uCnRoaXNCb3RbZnVuY1RhZ05hbWVdKHRoYXQpOycAgdTs8g+qhgQXYWJBcnRpZmFjdEZvcm1hdFZlcnNpb24CBACB1OzyD/ubBAExJwCB1OzyD6qGBAZzZWFyY2gCBACB1OzyD/2bBCjwn5SXZDgzNzE0NDQtOTE1OC00NDM2LThmYzctODRjYzkxYjdmNTI1JwCB1OzyD6qGBAdhYlNoZWxsAgQAgdTs8g+knAQEdHJ1ZScAgdTs8g+qhgQFdXRpbHMCBACB1OzyD6mcBCjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCB1OzyD6qGBBlhYkFydGlmYWN0UmVjb25zdGl0dXRlX3YxAgQAgdTs8g/QnASBFUBjb25zdCB7IAogICAgYWJBcnRpZmFjdEJvdCwKICAgIHRvYXN0ID0gdHJ1ZSwKfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdEJvdCAmJiBhYkFydGlmYWN0Qm90LnNwYWNlICYmIGFiQXJ0aWZhY3RCb3QudGFncywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0Qm90IGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBCb3QuYCk7Cgpjb25zdCBhYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiA9IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbjsKCmlmIChhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQpIHsKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSAke2FiQXJ0aWZhY3RCb3QudGFncy5zeXN0ZW19IGlzIGFscmVhZHkgcmVjb25zaXRpdHV0ZWQuYCk7CiAgICB9CiAgICByZXR1cm47Cn0KCi8vIEdlbmVyYXRlIGFydGlmYWN0IGluc3RhbmNlIGlkIGZvciB0aGlzIGFydGlmYWN0IGJvdCB0aGF0IGlzIGJlaW5nIHJlY29uc3RpdHV0ZWQuCmNvbnN0IGFiQXJ0aWZhY3RJbnN0YW5jZUlEID0gdXVpZCgpOwpzZXRUYWdNYXNrKGFiQXJ0aWZhY3RCb3QsICdhYkFydGlmYWN0SW5zdGFuY2VJRCcsIGFiQXJ0aWZhY3RJbnN0YW5jZUlELCAnc2hhcmVkJyk7Cgpjb25zdCBkZXBlbmRlbmNpZXMgPSBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdERlcGVuZGVuY2llczsKCmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lfSBkZXBlbmRlbmNpZXM6YCwgZGVwZW5kZW5jaWVzKTsKfQoKZm9yIChjb25zdCBkZXAgb2YgZGVwZW5kZW5jaWVzKSB7CiAgICBjb25zdCBsb29rdXBFZ2dSZXN1bHQgPSBhd2FpdCBsaW5rcy5zZWFyY2gub25Mb29rdXBBQkVnZ3MoewogICAgICAgIGFiSUQ6IGRlcC5hYklELAogICAgICAgIHJlY29yZEtleTogZGVwLnJlY29yZEtleSwKICAgICAgICBhYlZlcnNpb246IGRlcC5hYlZlcnNpb24sCiAgICAgICAgYXV0b0hhdGNoOiB0cnVlLAogICAgfSkKCiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdE5hbWV9ICR7ZGVwLmFiSUR9IGxvb2t1cEVnZ1Jlc3VsdDpgLCBsb29rdXBFZ2dSZXN1bHQpOwogICAgfQoKICAgIGlmIChsb29rdXBFZ2dSZXN1bHQuc3VjY2VzcykgewogICAgICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nKGAke2FiQXJ0aWZhY3RCb3QudGFncy5zeXN0ZW19IGxvYWRlZCBkZXBlbmRlbmN5IGFiSUQ6ICR7ZGVwLmFiSUR9LCBhYlZlcnNpb246ICR7ZGVwLmFiVmVyc2lvbiA/PyAnbGF0ZXN0J31gKTsKICAgICAgICB9CgogICAgICAgIGZvciAoY29uc3QgaGF0Y2hlZEJvdCBvZiBsb29rdXBFZ2dSZXN1bHQuaGF0Y2hlZEJvdHMpIHsKICAgICAgICAgICAgaGF0Y2hlZEJvdC50YWdzLmFiQXJ0aWZhY3RTaGFyZFJlY29uc3RpdHV0ZWQgPSB0cnVlOyAvLyBUaGlzIGJvdCBoYXMgYmVlbiByZWNvbnN0aXR1dGVkIGJ5IGFuIGFydGlmYWN0LgogICAgICAgICAgICBoYXRjaGVkQm90LnRhZ3MuYWJBcnRpZmFjdEluc3RhbmNlSUQgPSBhYkFydGlmYWN0SW5zdGFuY2VJRDsgLy8gVVVJRCBvZiB0aGUgYXJ0aWZhY3QgdGhhdCB0aGlzIGJvdCB3YXMgbG9hZGVkIGJ5LgogICAgICAgICAgICBoYXRjaGVkQm90LnRhZ3MuYWJBcnRpZmFjdFNoYXJkSW5zdGFuY2VJRCA9IHV1aWQoKTsgLy8gVVVJRCBhc3NpZ25lZCB0byB0aGUgYm90IGJ5IHRoZSBhcnRpZmFjdCB3aGVuIGxvYWRlZC4KICAgICAgICAgICAgaGF0Y2hlZEJvdC50YWdzLmFiSWdub3JlID0gdHJ1ZTsgLy8gRG9uJ3QgcHVibGlzaCBib3RzIGxvYWRlZCBieSBhcnRpZmFjdHMuCiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZyh7IG1lc3NhZ2U6IGAke2FiQXJ0aWZhY3RCb3QudGFncy5zeXN0ZW19IGZhaWxlZCB0byBsb2FkIGRlcGVuZGVuY3kgYWJJRDogJHtkZXAuYWJJRH0sIGFiVmVyc2lvbjogJHtkZXAuYWJWZXJzaW9uID8/ICdsYXRlc3QnfWAsIGxvZ1R5cGU6ICdlcnJvcid9KTsKICAgIH0KfQoKc2V0VGFnTWFzayhhYkFydGlmYWN0Qm90LCAnYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7CgpzaG91dChgb25BQkFydGlmYWN0UmVjb25zdGl0dXRlYCwgewogICAgYWJBcnRpZmFjdE5hbWU6IGFiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0TmFtZSwKICAgIGFiQXJ0aWZhY3REYXRhOiBhYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdERhdGEsCiAgICBhYkFydGlmYWN0Qm90OiBhYkFydGlmYWN0Qm90Cn0pCgppZiAodG9hc3QpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYEFydGlmYWN0ICcke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0TmFtZX0nIGhhcyBiZWVuIHJlY29uc3RpdHV0ZWQuYCk7Cn0gZWxzZSB7CiAgICBsaW5rcy51dGlscy5hYkxvZyhgQXJ0aWZhY3QgJyR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lfScgaGFzIGJlZW4gcmVjb25zdGl0dXRlZC5gKTsKfQonAIHU7PIPqoYED29uQW55Qm90Q2xpY2tlZAIEAIHU7PIP0rEEckBjb25zdCB7IGJvdCB9ID0gdGhhdDsKCmlmIChib3QgJiYgYm90LnRhZ3MuYWJBcnRpZmFjdCkgewogICAgdGhpc0JvdC5hYkFydGlmYWN0TWVudU9wZW4oeyBhYkFydGlmYWN0Qm90OiBib3QgfSkKfScAgdTs8g+qhgQEbWVudQIEAIHU7PIPxbIEKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAIHU7PIPqoYEBWxlYXJuAgQAgdTs8g/ssgQo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAgdTs8g+qhgQTYWJBcnRpZmFjdE1lbnVSZXNldAIEAIHU7PIPk7MEsAFAaWYgKGxpbmtzLmFydGlmYWN0TWVudUJvdHMpIHsKICAgIGRlc3Ryb3kobGlua3MuYXJ0aWZhY3RNZW51Qm90cyk7CiAgICBsaW5rcy5hcnRpZmFjdE1lbnVCb3RzID0gbnVsbDsKfQoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBudWxsOycAgdTs8g+qhgQSYWJBcnRpZmFjdE1lbnVPcGVuAgQAgdTs8g/EtASCDUBjb25zdCB7IGFiQXJ0aWZhY3RCb3QgfSA9IHRoYXQgPz8ge307Cgphc3NlcnQoYWJBcnRpZmFjdEJvdCAmJiBhYkFydGlmYWN0Qm90LnNwYWNlICYmIGFiQXJ0aWZhY3RCb3QudGFncywgYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhYkFydGlmYWN0Qm90IGlzIGEgcmVxdWlyZWQgdG8gYmUgYSBCb3QuYCk7CgpzaG91dCgiYWJBcnRpZmFjdE1lbnVSZXNldCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJBcnRpZmFjdE1lbnUiOwoKY29uc3QgYXJ0aWZhY3RNZW51Qm90cyA9IFtdOwoKY29uc3QgYWJBcnRpZmFjdEJhc2VDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdEJhc2VDb2xvciA/PyB0YWdzLmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0Owpjb25zdCBhYkFydGlmYWN0TGFiZWxDb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBcnRpZmFjdExhYmVsQ29sb3IgPz8gdGFncy5hYkFydGlmYWN0TGFiZWxDb2xvckRlZmF1bHQ7CgpsZXQgaW5mb0xhYmVsID0gYGFydGlmYWN0OiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0TmFtZX1cbmA7CmluZm9MYWJlbCArPSBgaGFzaDogJHthYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEhhc2guc3Vic3RyaW5nKDAsIDcpfVxuYDsKaW5mb0xhYmVsICs9IGByZWNvbnN0aXR1dGVkIGluIGluc3Q6ICR7YWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3RSZWNvbnN0aXR1dGVkfVxuYDsKaW5mb0xhYmVsICs9IGBmb3JtYXQ6IHYke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbn1cbmA7CmluZm9MYWJlbCArPSBgY3JlYXRlZCB0aW1lOiAke2FiQXJ0aWZhY3RCb3QudGFncy5hYkFydGlmYWN0Q3JlYXRlZFRpbWVzdGFtcC50b0xvY2FsZVN0cmluZyhEYXRlVGltZS5EQVRFVElNRV9TSE9SVF9XSVRIX1NFQ09ORFMpfVxuYDsKCi8vIEhlYWRlcgpjb25zdCBpbmZvQm90ID0gbGlua3MubWVudS5hYkNyZWF0ZU1lbnVUZXh0KHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgbGFiZWw6IGluZm9MYWJlbCwKfSkKYXJ0aWZhY3RNZW51Qm90cy5wdXNoKGluZm9Cb3QpOwoKLy8gRG93bmxvYWQgYXJ0aWZhY3QgYnV0dG9uLgpjb25zdCBkb3dubG9hZEJ1dHRvbiA9IGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKHsKICAgIGFiQXJ0aWZhY3RNZW51OiB0cnVlLAogICAgYWJBcnRpZmFjdEJvdDogZ2V0TGluayhhYkFydGlmYWN0Qm90KSwKICAgIGZvcm1BZGRyZXNzOiAnZG93bmxvYWQnLAogICAgbGFiZWw6IGBkb3dubG9hZCBhcnRpZmFjdGAsCiAgICBjb2xvcjogYWJBcnRpZmFjdEJhc2VDb2xvciwKICAgIG9uQ2xpY2s6IGBACiAgICAgICAgb3MuZG93bmxvYWRCb3RzKFsgbGlua3MuYWJBcnRpZmFjdEJvdCBdLCBcYGFiQXJ0aWZhY3QtXCR7bGlua3MuYWJBcnRpZmFjdEJvdC50YWdzLmFiQXJ0aWZhY3ROYW1lfS1cJHtsaW5rcy5hYkFydGlmYWN0Qm90LnRhZ3MuYWJBcnRpZmFjdEhhc2guc3Vic3RyaW5nKDAsIDcpfS5hdXhcYCkKICAgIGAsCn0pCmFydGlmYWN0TWVudUJvdHMucHVzaChkb3dubG9hZEJ1dHRvbik7CgptYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQgPSBhYkFydGlmYWN0Qm90LmlkOwptYXNrcy5hcnRpZmFjdE1lbnVCb3RzID0gZ2V0TGluayhhcnRpZmFjdE1lbnVCb3RzKTsnAIHU7PIPqoYEC29uR3JpZENsaWNrAgQAgdTs8g/HwQR9QGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZ3JpZCBjbGlja2VkYCk7CgppZiAobGlua3MuYXJ0aWZhY3RNZW51Qm90cykgewogICAgdGhpc0JvdC5hYkFydGlmYWN0TWVudVJlc2V0KCk7Cn0nAIHU7PIPqoYEGmFiQXJ0aWZhY3RCYXNlQ29sb3JEZWZhdWx0AgQAgdTs8g/FwgQHI0FFQTFGRicAgdTs8g+qhgQbYWJBcnRpZmFjdExhYmVsQ29sb3JEZWZhdWx0AgQAgdTs8g/NwgQHIzFlMWIyZCcAgdTs8g+qhgQQb25BbnlCb3RzUmVtb3ZlZAIEAIHU7PIP1cIEkgFAY29uc3QgeyBib3RJRHMgfSA9IHRoYXQ7CgppZiAobWFza3Muc2VsZWN0ZWRBcnRpZmFjdEJvdElkICYmIGJvdElEcy5pbmNsdWRlcyhtYXNrcy5zZWxlY3RlZEFydGlmYWN0Qm90SWQpKSB7CiAgICB0aGlzQm90LmFiQXJ0aWZhY3RNZW51UmVzZXQoKTsKfScAgdTs8g+qhgQWYWJDcmVhdGVBcnRpZmFjdEJvdF92MQIEAIHU7PIP6MME7CtAY29uc3QgeyAKICAgIGFiQXJ0aWZhY3ROYW1lCn0gPSB0aGF0ID8/IHt9OwoKYXNzZXJ0KGFiQXJ0aWZhY3ROYW1lLCBgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFiQXJ0aWZhY3ROYW1lIGlzIGEgcmVxdWlyZWQgcGFyYW1ldGVyLmApOwoKY29uc3QgQVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHID0gJ29uQUJDb2xsZWN0QXJ0aWZhY3RTaGFyZHMnOwpjb25zdCBBUlRJRkFDVF9ERVBFTkRFTkNJRVNfVEFHID0gJ2FiQXJ0aWZhY3REZXBlbmRlbmNpZXMnOwogICAgCmNvbnN0IGFydGlmYWN0Qm90cyA9IGdldEJvdHMoKGIpID0+IHsKICAgIHJldHVybiBiLnRhZ3MuYWJBcnRpZmFjdE5hbWUgPT09IGFiQXJ0aWZhY3ROYW1lICYmCiAgICAgICAgICAgIWIudGFncy5hcnRpZmFjdCAvLyBJZ25vcmUgYW55IGFydGlmYWN0IGJvdHMgdGhlbXNlbHZlcy4KfSk7CgpsZXQgc2hhcmRzID0ge307CmxldCBkZXBlbmRlbmNpZXMgPSBbXTsKCmZvciAoY29uc3QgYXJ0aWZhY3RCb3Qgb2YgYXJ0aWZhY3RCb3RzKSB7CiAgICBjb25zdCBib3RTaG9ydElkID0gYXJ0aWZhY3RCb3QuaWQuc3Vic3RyaW5nKDAsIDUpOwogICAgY29uc3Qgc2hhcmQgPSBhd2FpdCB3aGlzcGVyKGFydGlmYWN0Qm90LCBBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUcsIHsgYWJBcnRpZmFjdE5hbWUgfSlbMF07CgogICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBzaGFyZDpgLCBzaGFyZCk7CiAgICB9CgogICAgaWYgKHNoYXJkKSB7CiAgICAgICAgaWYgKHR5cGVvZiBzaGFyZCAhPT0gJ29iamVjdCcgfHwgQXJyYXkuaXNBcnJheShzaGFyZCkpIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgbXVzdCByZXR1cm4gYW4gb2JqZWN0IGZyb20gQCR7QVJUSUZBQ1RfU0hBUkRfTElTVEVORVJfVEFHfWAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNoYXJkcyA9IHsgLi4uc2hhcmRzLCAuLi5zaGFyZCB9OwogICAgfQoKICAgIGNvbnN0IGRlcHMgPSBhcnRpZmFjdEJvdC50YWdzW0FSVElGQUNUX0RFUEVOREVOQ0lFU19UQUddOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDogJHtib3RTaG9ydElkfSwgZGVwczpgLCBkZXBzKTsKICAgIH0KCiAgICBpZiAoZGVwcykgewogICAgICAgIGlmICghQXJyYXkuaXNBcnJheShkZXBzKSkgewogICAgICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYEFydGlmYWN0ICcke2FiQXJ0aWZhY3ROYW1lfScgYm90ICcke2JvdFNob3J0SWR9JyB0YWcgJHtBUlRJRkFDVF9ERVBFTkRFTkNJRVNfVEFHfSBtdXN0IGJlIGFuIGFycmF5LmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAoY29uc3QgZGVwIG9mIGRlcHMpIHsKICAgICAgICAgICAgLy8gVmFsaWRhdGUgZGVwZW5kZW5jeSBmb3JtYXQuCiAgICAgICAgICAgIGlmICghZGVwLnJlY29yZEtleSkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgdGFnICR7QVJUSUZBQ1RfREVQRU5ERU5DSUVTX1RBR30gZW50cmllcyBtdXN0IGNvbnRhaW4gJ3JlY29yZEtleScuYCwgbG9nVHlwZTogJ2Vycm9yJyB9KTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFkZXAuYWJJRCkgewogICAgICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGJvdCAnJHtib3RTaG9ydElkfScgdGFnICR7QVJUSUZBQ1RfREVQRU5ERU5DSUVTX1RBR30gZW50cmllcyBtdXN0IGNvbnRhaW4gJ2FiSUQnLmAsIGxvZ1R5cGU6ICdlcnJvcicgfSk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1ha2Ugc3VyZSB0aGlzIGRlcGVuZGVuY3kgaXNudCBhbHJlYWR5IGNvbGxlY3RlZC4KICAgICAgICAgICAgY29uc3QgaGFzaCA9IGNyeXB0by5zaGEyNTYoZGVwKTsKICAgICAgICAgICAgY29uc3QgY29udGFpbnMgPSBkZXBlbmRlbmNpZXMuc29tZShkID0+IGNyeXB0by5zaGEyNTYoZCkgPT09IGhhc2gpOyAvLyBUT0RPOiBDYW4gb3B0aW1pemUgd2l0aCBtYXAvZGljdCBpbnN0ZWFkIG9mIGFycmF5LgoKICAgICAgICAgICAgaWYgKCFjb250YWlucykgewogICAgICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGFydGlmYWN0OiAke2FiQXJ0aWZhY3ROYW1lfSwgYm90OiAke2JvdFNob3J0SWR9LCBhZGRpbmcgZGVwOmAsIGRlcCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZGVwZW5kZW5jaWVzLnB1c2goZGVwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKaWYgKHRhZ3MuZGVidWcpIHsKICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gYXJ0aWZhY3Q6ICR7YWJBcnRpZmFjdE5hbWV9LCBzaGFyZHM6YCwgc2hhcmRzLCAnZGVwZW5kZW5jaWVzOicsIGRlcGVuZGVuY2llcyk7Cn0KCmNvbnN0IGhhdmVBcnRpZmFjdERhdGEgPSBPYmplY3Qua2V5cyhzaGFyZHMpLmxlbmd0aCA+IDA7CgppZiAoaGF2ZUFydGlmYWN0RGF0YSkgewogICAgY29uc3QgYXJ0aWZhY3RNb2QgPSB7fTsKCiAgICBhcnRpZmFjdE1vZC5zcGFjZSA9ICdzaGFyZWQnOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdCA9IHRydWU7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0TmFtZSA9IGFiQXJ0aWZhY3ROYW1lOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdERhdGEgPSAn8J+nrCcgKyBKU09OLnN0cmluZ2lmeShzaGFyZHMpOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdERlcGVuZGVuY2llcyA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KGRlcGVuZGVuY2llcyk7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0Rm9ybWF0VmVyc2lvbiA9IDE7CgogICAgLy8gQ3JlYXRlIGFuZCBzdG9yZSBhIGhhc2ggb2YgYXJ0aWZhY3QncyBjb250ZW50LgogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdEhhc2ggPSBjcnlwdG8uc2hhMjU2KGFydGlmYWN0TW9kKTsKICAgIAogICAgLy8gRXh0cmEgdGFncyBmb3Igc3lzdGVtIHBvcnRhbCBhbmQgb3RoZXIgbWV0YWRhdGEuCiAgICBhcnRpZmFjdE1vZC5zeXN0ZW0gPSBgYWJBcnRpZmFjdC4ke2FiQXJ0aWZhY3ROYW1lfS0ke2FydGlmYWN0TW9kLmFiQXJ0aWZhY3RIYXNoLnN1YnN0cmluZygwLCA3KX1gOwogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdENhc3VhbE9TVmVyc2lvbiA9ICfwn6esJyArIEpTT04uc3RyaW5naWZ5KG9zLnZlcnNpb24oKSk7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0Q3JlYXRlZFRpbWVzdGFtcCA9IERhdGVUaW1lLm5vdygpOwogICAgYXJ0aWZhY3RNb2QuYWJWZXJzaW9uID0gdGFncy5hYlZlcnNpb247CgogICAgLy8gU2V0dXAgYXJ0aWZhY3QncyBsb2FkaW5nIGxvZ2ljLgogICAgYXJ0aWZhY3RNb2QuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQgPSBmYWxzZTsKICAgIGFydGlmYWN0TW9kLmFiQXJ0aWZhY3REZWJ1ZyA9IHRhZ3MuZGVidWc7CiAgICBhcnRpZmFjdE1vZC5hYkFydGlmYWN0VG9vbCA9IGdldExpbmsodGhpc0JvdCk7CiAgICBhcnRpZmFjdE1vZC5vbkNyZWF0ZSA9IGBACiAgICAgICAgc2V0VGFnTWFzayh0aGlzQm90LCAnYWJBcnRpZmFjdFJlY29uc3RpdHV0ZWQnLCB0cnVlLCAnc2hhcmVkJyk7CiAgICAgICAgdGFncy5vbkNyZWF0ZSA9IG51bGw7CgogICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3REZWJ1ZykgewogICAgICAgICAgICBjb25zdCBsb2dNYXJrZXIgPSAnWycgKyB0YWdzLnN5c3RlbSArICddJzsKICAgICAgICAgICAgY29uc29sZS5sb2cobG9nTWFya2VyLCAnbWFya2VkIGFydGlmYWN0IGFzIGxvYWRlZCBvbiBjcmVhdGUgc28gdGhhdCBpdCBkb2VzbnQgbG9hZCByaWdodCBhd2F5Jyk7CiAgICAgICAgfQogICAgYDsKICAgIGFydGlmYWN0TW9kLm9uQm90QWRkZWQgPSBgQAogICAgICAgIGlmIChnbG9iYWxUaGlzLmFiKSB7CiAgICAgICAgICAgIHRoaXNCb3QuX3JlY29uc3RpdHV0ZSgpOwogICAgICAgIH0KICAgIGA7CiAgICBhcnRpZmFjdE1vZC5vbkFCSW5pdGlhbGl6ZWQgPSBgQAogICAgICAgIHRoaXNCb3QuX3JlY29uc3RpdHV0ZSgpOwogICAgYDsKICAgIGFydGlmYWN0TW9kLl9yZWNvbnN0aXR1dGUgPSBgQAogICAgICAgIGNvbnN0IGxvZ01hcmtlciA9ICdbJyArIHRhZ3Muc3lzdGVtICsgJ10nOwoKICAgICAgICBpZiAoIWxpbmtzLmFiQXJ0aWZhY3RUb29sKSB7CiAgICAgICAgICAgIGlmICh0YWdzLmFiQXJ0aWZhY3REZWJ1ZykgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2cobG9nTWFya2VyLCAnYXJ0aWZhY3QgdG9vbCBub3QgZm91bmQsIGFkYXB0aW5nIGFiIHdpdGggYWN0aW9uJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBhYi5hYkFkYXB0KCJhYlNoZWxsIik7CgogICAgICAgICAgICBpZiAoIXN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobG9nTWFya2VyLCAnZmFpbGVkIHRvIGFkYXB0IGFiIHdpdGggYWJTaGVsbCcpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWxpbmtzLmFiQXJ0aWZhY3RUb29sKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGxvZ01hcmtlciwgJ2ZhaWxlZCB0byBmaW5kIGFiQXJ0aWZhY3RUb29sJyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgbGlua3MuYWJBcnRpZmFjdFRvb2wuYWJBcnRpZmFjdFJlY29uc3RpdHV0ZSh7IGFiQXJ0aWZhY3RCb3Q6IHRoaXNCb3QgfSkKICAgIGA7CgogICAgY29uc3QgYXJ0aWZhY3RCb3QgPSBjcmVhdGUoYXJ0aWZhY3RNb2QpOwoKICAgIGlmICh0YWdzLmRlYnVnKSB7CiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBhcnRpZmFjdDogJHthYkFydGlmYWN0TmFtZX0sIGJvdDpgLCBhcnRpZmFjdEJvdCk7CiAgICB9CgogICAgcmV0dXJuIGFydGlmYWN0Qm90Owp9IGVsc2UgewogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBBcnRpZmFjdCAnJHthYkFydGlmYWN0TmFtZX0nIGRpZCBub3QgcmV0dXJuIGFueSBkYXRhIHZpYSBAJHtBUlRJRkFDVF9TSEFSRF9MSVNURU5FUl9UQUd9LmAsIGxvZ1R5cGU6ICd3YXJuaW5nJyB9KTsKfScBBGJvdHMkOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjAScAgdTs8g/P7wQGc3lzdGVtAgQAgdTs8g/Q7wQOYWIuc2hlbGwudXRpbHMnAIHU7PIPz+8EDGFiQ29tcGlsZUNTUwIEAIHU7PIP3+8EggRAbGV0IGJvdHMgPSB0aGF0OwoKYm90cyA9IEFycmF5LmlzQXJyYXkoYm90cykgPyBib3RzIDogW2JvdHNdOwoKbGV0IGNzcyA9IFtdOwoKZm9yIChsZXQgYm90IG9mIGJvdHMpIHsKICAgIGZvciAobGV0IGtleSBpbiBib3QudGFncykgewogICAgICAgIGlmIChrZXkudG9Mb3dlckNhc2UoKS5lbmRzV2l0aCgnY3NzJykpIHsKICAgICAgICAgICAgaWYgKHRhZ3MuZGVidWcpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gZm91bmQgQ1NTIGtleTogJHtrZXl9YCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3NzLnB1c2goYm90LnRhZ3Nba2V5XSk7CiAgICAgICAgfQogICAgfQp9Cgpjb25zdCBjb21waWxlZCA9IGNzcy5qb2luKCdcblxuJyk7CmlmICh0YWdzLmRlYnVnKSB7CiAgICBjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIGNvbXBpbGVkIENTUzpcblxuYCwgY29tcGlsZWQpOwp9CgpyZXR1cm4gY29tcGlsZWQ7JwCB1OzyD8/vBAhhYklnbm9yZQIEAIHU7PIP4vMEBHRydWUnAIHU7PIPz+8EB2FiU2hlbGwCBACB1OzyD+fzBAR0cnVlJwCB1OzyD8/vBAlhYlZlcnNpb24CBACB1OzyD+zzBAQxMC40JwCB1OzyD8/vBA1hYkxvZ0FuZFRvYXN0AgQAgdTs8g/x8wTFCUBsZXQgbWVzc2FnZTsKbGV0IGR1cmF0aW9uOwpsZXQgbG9nVHlwZSA9ICdsb2cnOwpsZXQgdG9hc3QgPSB0cnVlOwoKaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgbWVzc2FnZSA9IHRoYXQ7Cn0gZWxzZSB7CiAgICBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgZHVyYXRpb24gPSB0aGF0LmR1cmF0aW9uID8/IHRoaXNCb3QuZXN0aW1hdGVSZWFkaW5nVGltZSh7IHRleHQ6IHRoYXQubWVzc2FnZSB9KTsKICAgIGxvZ1R5cGUgPSB0aGF0LmxvZ1R5cGUgPz8gbG9nVHlwZTsKICAgIHRvYXN0ID0gdGhhdC50b2FzdCA/PyB0b2FzdDsKfQoKaWYgKGxvZ1R5cGUgPT09ICdsb2cnKSB7CiAgICBhYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgJzogJyArIG1lc3NhZ2UpOwogICAgaWYgKHRvYXN0KSBvcy50b2FzdChtZXNzYWdlLCBkdXJhdGlvbik7Cn0gZWxzZSBpZiAobG9nVHlwZSA9PT0gJ3dhcm5pbmcnIHx8IGxvZ1R5cGUgPT09ICd3YXJuJykgewogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6IFdhcm5pbmc6ICcgKyBtZXNzYWdlKTsKICAgIGNvbnNvbGUud2FybihhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBXYXJuaW5nOiAke21lc3NhZ2V9YCwgZHVyYXRpb24pOwp9IGVsc2UgaWYgKGxvZ1R5cGUgPT09ICdlcnJvcicpIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiBFcnJvcjogJyArIG1lc3NhZ2UpOwogICAgY29uc29sZS5lcnJvcihhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KGBFcnJvcjogJHttZXNzYWdlfWAsIGR1cmF0aW9uKTsKfSBlbHNlIHsKICAgIGFiLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBjb25zb2xlLmxvZyhhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCdWlsZGVySWRlbnRpdHkgKyAnOiAnICsgbWVzc2FnZSk7CiAgICBpZiAodG9hc3QpIG9zLnRvYXN0KG1lc3NhZ2UsIGR1cmF0aW9uKTsKfScAgdTs8g/P7wQIcmVtZW1iZXICBACB1OzyD7f9BCjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCB1OzyD8/vBAVhYkxvZwIEAIHU7PIP3v0ExwFAaWYgKHR5cGVvZiB0aGF0ID09PSAnc3RyaW5nJykgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICBtZXNzYWdlOiB0aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgIH0pOwp9IGVsc2UgewogICAgdGhpc0JvdC5hYkxvZ0FuZFRvYXN0KHsKICAgICAgICAuLi50aGF0LAogICAgICAgIHRvYXN0OiBmYWxzZSwKICAgIH0pOwp9JwCB1OzyD8/vBBNlc3RpbWF0ZVJlYWRpbmdUaW1lAgQAgdTs8g+m/wSjBEBjb25zdCB7CiAgICB0ZXh0ID0gJycsCiAgICB3b3Jkc1Blck1pbnV0ZSA9IDI1MCwKfSA9IHRoYXQ7CgovLyBDb3VudCB3b3JkcyAocm91Z2ggYXBwcm94aW1hdGlvbiBieSBzcGxpdHRpbmcgb24gd2hpdGVzcGFjZSkKY29uc3Qgd29yZENvdW50ID0gdGV4dC50cmltKCkuc3BsaXQoL1xzKy8pLmxlbmd0aDsKbGV0IHRvdGFsVGltZU1zID0gMDsKCmlmICh3b3JkQ291bnQgPiAwKSB7CiAgICAvLyBDYWxjdWxhdGUgcmVhZGluZyB0aW1lIGluIG1pbGxpc2Vjb25kcwogICAgY29uc3Qgd29yZHNQZXJTZWNvbmQgPSB3b3Jkc1Blck1pbnV0ZSAvIDYwOwogICAgY29uc3QgcmVhZGluZ1RpbWVNcyA9IE1hdGguY2VpbCgod29yZENvdW50IC8gd29yZHNQZXJTZWNvbmQpICogMTAwMCk7CgogICAgLy8gQWRkIGEgc21hbGwgYnVmZmVyIGZvciAicHJvY2Vzc2luZyIgKDEwMC01MDBtcykKICAgIGNvbnN0IHByb2Nlc3NpbmdUaW1lID0gMzAwOwogICAgdG90YWxUaW1lTXMgPSByZWFkaW5nVGltZU1zICsgcHJvY2Vzc2luZ1RpbWU7Cn0KCnJldHVybiB0b3RhbFRpbWVNczsnAQRib3RzJGQ4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNQEnAIHU7PIPyoMFBnN5c3RlbQIEAIHU7PIPy4MFD2FiLnNoZWxsLnNlYXJjaCcAgdTs8g/KgwUEZm9ybQIEAIHU7PIP24MFB25vdGhpbmcnAIHU7PIPyoMFDmFiUmV0cmlldmVGaWxlAgQAgdTs8g/jgwWCAUAvL3B1bGwgZG93biBmaWxlIGRhdGEKaWYgKCF0aGF0LnVybCkKewogICAgcmV0dXJuICJubyBmaWxlIHVybCBzdXBwbGllZCI7Cn0KCmxldCBkYXRhID0gYXdhaXQgb3MuZ2V0RmlsZSh0aGF0LnVybCk7CgpyZXR1cm4gZGF0YTsnAIHU7PIPyoMFEGFiUmV0cmlldmVSZWNvcmQCBACB1OzyD+aEBewEQC8vcmV0cmlldmUgc3BlY2lmaWVkIHJlY29yZApsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKCmxldCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKaWYgKHRoYXQucmVjb3JkS2V5KQp7CiAgICByZWNvcmRLZXkgPSB0aGF0LnJlY29yZEtleTsKfQplbHNlIGlmIChhdXRoQm90KQp7CiAgICBpZiAoYXV0aEJvdC5pZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCiAgICB7CiAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKCiAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICB9Cn0KCmxldCByZWNvcmRFbmRwb2ludCA9IHRoYXQucmVjb3JkRW5kcG9pbnQgPyB0aGF0LnJlY29yZEVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwoKaWYgKCFyZWNvcmROYW1lKQp7CiAgICByZXR1cm4gIm5vIHJlY29yZCBuYW1lIHN1cHBsaWVkIjsKfQoKbGV0IGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCByZWNvcmROYW1lLCByZWNvcmRFbmRwb2ludCk7CgovL0FERCBhZGRpdGlvbmFsIGVycm9yIGhhbmRsaW5nPwoKcmV0dXJuIGdldFJlY29yZDsnAIHU7PIPyoMFCHJlbWVtYmVyAgQAgdTs8g/TiQUo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycAgdTs8g/KgwUNbWFuaWZlc3RhdGlvbgIEAIHU7PIP+okFKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAIHU7PIPyoMFDm9uTG9va3VwQUJFZ2dzAgQAgdTs8g+higWOLUBjb25zdCB7IAogICAgYWJJRCwKICAgIGFiVmVyc2lvbiwKICAgIGluaXRpYWxCb290LAogICAgYXV0b0hhdGNoLAogICAgcmV0dXJuVHlwZSwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBrZXkgPSBjb25maWdCb3QudGFncy5rZXksCiAgICB0b2FzdCA9IHRydWUsCn0gPSB0aGF0OwoKbGV0IHsKICAgIHJlY29yZEtleSA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpbywKfSA9IHRoYXQ7CgphYi5sb2coYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5ICsgIjogbG9hZGluZyAiICsgYWJJRCk7CgovL2NsZWFyIGFiLTEKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24gJiYgY29uZmlnQm90LnRhZ3MubWVudVBvcnRhbCA9PSAiYWJNZW51IikgewogICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYGxvYWRpbmcgJHthYklEfWApOwoKY29uc3QgcG9zc2libGVBdXRoID0gYXV0aEJvdCA/IGF1dGhCb3QgOiB0cnVlOwpsZXQgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwoKbGV0IG5ld0VnZzsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHBvc3NpYmxlQXV0aC5pZCA9PSByZWNvcmRLZXkgJiYKICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5ICYmCiAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gInJlY29yZF9ub3RfZm91bmQiCiAgICApIHsKICAgICAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwogICAgfSBlbHNlIGlmIChnZXRSZWNvcmQuZXJyb3JDb2RlID09PSAibm90X2F1dGhvcml6ZWQiKSB7CiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbihyZWNvcmRLZXkpOwogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKICAgIH0gZWxzZSBpZiAoZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9sb2dnZWRfaW4iKSB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgaWYgKCFyZWNvcmRLZXkpIHsKICAgICAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgICAgICB9CgogICAgICAgIGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCiAgICAgICAgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiAKICAgICAgICAgICAgZ2V0UmVjb3JkLmVycm9yQ29kZSA9PT0gIm5vdF9hdXRob3JpemVkIgogICAgICAgICkgewogICAgICAgICAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKICAgICAgICAgICAgZ2V0UmVjb3JkID0gYXdhaXQgb3MuZ2V0RGF0YShyZWNvcmRLZXksIGFiSUQpOwogICAgICAgIH0KICAgIH0KfQoKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykgewogICAgaWYgKHRvYXN0KSB7IAogICAgICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKICAgIH0KCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQoKICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07Cn0KZWxzZSB7CiAgICBjb25zdCBwdWJsaWNSZWFkVGVzdCA9IGdldFJlY29yZC5tYXJrZXJzLmluZGV4T2YoInB1YmxpY1JlYWQiKTsKICAgIGNvbnN0IGF1dGhvciA9IGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90SW5CYWNrZ3JvdW5kKCk7CgogICAgaWYgKHB1YmxpY1JlYWRUZXN0ICE9IC0xICYmIGF1dGhvcikgewogICAgICAgIGlmIChhdXRoQm90LnRhZ3MucHJpdmFjeUZlYXR1cmVzLmFsbG93UHVibGljRGF0YSkgewogICAgICAgICAgICBjb25zdCBlZ2dIYXRjaEV2ZW50ID0gYWJJRDsKCiAgICAgICAgICAgIG9zLnJlY29yZEV2ZW50KGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGVnZ0hhdGNoRXZlbnQpOwogICAgICAgIH0KICAgIH0KCiAgICAvL3BhY2thZ2UgdGhlIHJlY29yZCBkYXRhCiAgICBuZXdFZ2cgPSBnZXRSZWNvcmQuZGF0YTsKfQoKYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICI6ICIgKyBhYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCmlmIChyZXR1cm5UeXBlICE9IG51bGwpIHsKICAgIGlmIChnZXRSZWNvcmQuc3VjY2VzcykgewogICAgICAgIGlmIChyZXR1cm5UeXBlID09PSAiZGF0YSIpIHsKICAgICAgICAgICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICAgICAgICAgIGlmIChhYlZlcnNpb24pIHsKICAgICAgICAgICAgICAgIGlmICghaXNOYU4oYWJWZXJzaW9uKSkgewogICAgICAgICAgICAgICAgICAgIHZlcnNpb24gPSBhYlZlcnNpb24gLSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBlZ2dEYXRhVVJMID0gZ2V0UmVjb3JkLmRhdGEuZWdnVmVyc2lvbkhpc3RvcnlbdmVyc2lvbl07CiAgICAgICAgICAgIGNvbnN0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgICAgICAgICAgaWYgKHByb2dyZXNzQnV0dG9uKSB7CiAgICAgICAgICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHJldHVybkRhdGE7CiAgICAgICAgfSBlbHNlIGlmIChyZXR1cm5UeXBlID09PSAiZWdnIikgewogICAgICAgICAgICBpZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgICAgICAgICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBTaW1wbHkgcmV0dXJuIHRoZSBlZ2cgZGF0YSBpZiByZXF1ZXN0ZWQuCiAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmQuZGF0YTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIC8vIFRoaXMgaXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggb2xkIGF1eCBmaWxlcyBzdG9yZWQgYmVmb3JlIHRoZSByZWNvcmQgc3lzdGVtIGV4aXN0ZWQuCiAgICAgICAgaWYgKHJldHVyblR5cGUgPT09ICJkYXRhIikgewogICAgICAgICAgICBjb25zdCB2ZXJzaW9uQXJyYXkgPSBKU09OLnBhcnNlKG5ld0VnZy5lZ2dWZXJzaW9uSGlzdG9yeSk7CiAgICAgICAgICAgIGNvbnN0IGZpbGVVVUlEID0gdmVyc2lvbkFycmF5W25ld0VnZy5tYXhWZXJzaW9uIC0gMV07CiAgICAgICAgICAgIGNvbnN0IGZpbGVuYW1laGFzaExUTSA9IGNyeXB0by5zaGEyNTYoZmlsZVVVSUQpOwogICAgICAgICAgICBjb25zdCBmaWxldXJsaGFzaExUTSA9ICJhdXhfIiArIGZpbGVuYW1laGFzaExUTSArICcuYXV4JzsKICAgICAgICAgICAgY29uc3QgdGFyZ2V0TFRNVVJMID0gImh0dHBzOi8vYnVpbGRlci1sdG0tZmlsZXMuczMuYW1hem9uYXdzLmNvbS8iICsgZmlsZXVybGhhc2hMVE07CiAgICAgICAgICAgIGNvbnN0IG8gPSB7CiAgICAgICAgICAgICAgICBtZXRob2Q6ICJHRVQiLAogICAgICAgICAgICAgICAgdXJsOiB0YXJnZXRMVE1VUkwKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGxldCBmaWxlR2V0ID0gYXdhaXQgd2ViaG9vayhvKTsKCiAgICAgICAgICAgIGlmIChwcm9ncmVzc0J1dHRvbikgewogICAgICAgICAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChmaWxlR2V0LnN0YXR1cyAhPSAyMDApIHsKICAgICAgICAgICAgICAgIGlmICh0b2FzdCkgewogICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJubyBmaWxlIGZvdW5kIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBmaWxlR2V0ID0gZmlsZUdldC5kYXRhOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gZmlsZUdldDsKICAgICAgICB9CiAgICB9Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikgewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpIHsKICAgICAgICBjb25zdCBhYkJvdCA9IGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3Q7CgogICAgICAgIGN1cnJlbnREaW0gPSBhYkJvdC50YWdzLmRpbWVuc2lvbjsKICAgIH0KfQplbHNlIHsKICAgIGN1cnJlbnREaW0gPSBvcy5nZXRDdXJyZW50RGltZW5zaW9uKCk7Cn0KCi8vY2hlY2tzIGZvciBncmlkIGZvY3VzCmlmICghbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1cykgewogICAgZGltZW5zaW9uWCA9IG51bGw7CiAgICBkaW1lbnNpb25ZID0gbnVsbDsKfQplbHNlIHsKICAgIGxldCBoYXRjaFBvaW50ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBjdXJyZW50RGltID0gaGF0Y2hQb2ludC5kaW1lbnNpb247CiAgICBkaW1lbnNpb25YID0gaGF0Y2hQb2ludC5wb3NpdGlvbi54OwogICAgZGltZW5zaW9uWSA9IGhhdGNoUG9pbnQucG9zaXRpb24ueTsKICAgIHNwYWNlTW9kID0geyBzcGFjZTogInNoYXJlZCIgfTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKSB7CiAgICBkaW1Nb2QgPSB7CiAgICAgICAgW2N1cnJlbnREaW1dOiB0cnVlLAogICAgICAgIFtjdXJyZW50RGltICsgIlgiXTogZGltZW5zaW9uWCwKICAgICAgICBbY3VycmVudERpbSArICJZIl06IGRpbWVuc2lvblksCiAgICAgICAgZGltZW5zaW9uOiBjdXJyZW50RGltCiAgICB9Owp9CmVsc2UgewogICAgZGltTW9kID0geyBhdXRvSGF0Y2g6IHRydWUsIGtleSB9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCmNvbnN0IG1hbmlmZXN0UmVzdWx0ID0gYXdhaXQgdGhpc0JvdC5tYW5pZmVzdE92byh7CiAgICBhYklELAogICAgc3R1ZGlvOiByZWNvcmRLZXksCiAgICBkaW1Nb2QsCiAgICBzcGFjZU1vZCwKICAgIGVnZ0RhdGE6IG5ld0VnZywKICAgIGluaXRpYWxCb290LAogICAgZWdnUGFyYW1ldGVycyAKfSk7CgppZiAocHJvZ3Jlc3NCdXR0b24pIHsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gewogICAgc3VjY2VzczogdHJ1ZSwKICAgIGhhdGNoZWRCb3RzOiBtYW5pZmVzdFJlc3VsdD8uaGF0Y2hlZEJvdHMsCn07JwCB1OzyD8qDBQttYW5pZmVzdE92bwIEAIHU7PIPsLcFhg5AY29uc3QgeyAKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIHNwYWNlTW9kLAogICAgZGltTW9kLAogICAgZWdnRGF0YSwKICAgIGVnZ1BhcmFtZXRlcnMsCn0gPSB0aGF0OwoKLy9lZ2cgdmlzdWFsaXphdGlvbgpzaG91dCgiYWJNZW51UmVzZXQiKTsKCmlmIChsaW5rcy5tYW5pZmVzdGF0aW9uKSB7CiAgICBpZiAobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCkgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCmlmIChsaW5rcy5vdm9Cb3QpIHsKICAgIGRlc3Ryb3kobGlua3Mub3ZvQm90KTsKfQoKbGV0IGVnZ01vZCA9IHsKICAgIHNwYWNlOiAidGVtcExvY2FsIiwKICAgIGluaXRpYWxUaW1lcjogdHJ1ZSwKICAgIGFiSUQsCiAgICBzdHVkaW8sCiAgICBpbml0aWFsQm9vdCwKICAgIGVnZ1BhcmFtZXRlcnMsCiAgICBjdXJzb3I6ICdwb2ludGVyJywKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvbkNsaWNrOiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIuaW50ZXJhY3RPdm8oKTsKICAgIGAsCiAgICBmb3JtOiAiZWdnIiwKICAgIGNvbG9yOiBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBsYWJlbENvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUxhYmVsQ29sb3IsCiAgICBwcm9ncmVzc0JhckNvbG9yOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZUFjY2VudENvbG9yLAogICAgcHJvZ3Jlc3NCYXJCYWNrZ3JvdW5kQ29sb3I6IGFiUGVyc29uYWxpdHkudGFncy5hYkJhc2VDb2xvciwKICAgIGxhYmVsU2l6ZTogMC41LAogICAgb25Qb2ludGVyRW50ZXI6IGBACiAgICAgICAgbWFza3MudGlwSWQgPSBhd2FpdCBvcy50aXAodGFncy5hYklEICsgJyB2JyArIHRhZ3MudGFyZ2V0VmVyc2lvbik7CiAgICBgLAogICAgb25Qb2ludGVyRXhpdDogYEAKICAgICAgICBpZiAobWFza3MudGlwSWQpIHsKICAgICAgICAgICAgb3MuaGlkZVRpcHMobWFza3MudGlwSWQpOwogICAgICAgIH0KICAgIGAsCiAgICBsYWJlbFBvc2l0aW9uOiAiZnJvbnQiLAogICAgb3JpZW50YXRpb25Nb2RlOiAiYmlsbGJvYXJkRnJvbnQiLAogICAgb25EZXN0cm95OiBgQAogICAgICAgIGxpbmtzLm1hbmFnZXIubWFza3Mub3ZvQm90ID0gbnVsbDsKICAgIGAsCiAgICBlZ2dUaW1lcjogYEAKICAgICAgICBpZiAodGFncy5wcm9ncmVzc0JhciA8IDEpIHsKICAgICAgICAgICAgdGFncy5wcm9ncmVzc0JhciArPSAwLjE7CgogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzQm90Lm9uQ2xpY2soKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHRhZ3MucHJvZ3Jlc3NCYXIgPSBudWxsOwogICAgICAgIH0KICAgIGAKfTsKCgpsZXQgb3ZvID0gYXdhaXQgY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7Cm1hc2tzLm92b0JvdCA9IGdldExpbmsob3ZvKTsKCmlmIChvdm8udGFncy5hdXRvSGF0Y2gpIHsKICAgIGNvbnN0IGhhdGNoZWRCb3RzID0gYXdhaXQgdGhpc0JvdC5oYXRjaE92byhvdm8pOwogICAgcmV0dXJuIHsgaGF0Y2hlZEJvdHMgfTsKfQplbHNlIHsKICAgIG92by50YWdzLnByb2dyZXNzQmFyID0gMDsKICAgIGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPSBvdm8udGFncy5tYXhWZXJzaW9uOwogICAgc2V0VGltZW91dCgoKSA9PiB7IHdoaXNwZXIob3ZvLCAiZWdnVGltZXIiKTsgfSwgNzUpOwp9JwCB1OzyD8qDBQlvbktleURvd24CBACB1OzyD7fFBYIGQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gImFiT3ZvTWVudSIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24uYWJPdm9NZW51ID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlQWNjZW50Q29sb3I7CiAgICB2ZXJzaW9uQnV0dG9uLm9uS2V5VXAgPSAiQCBpZih0aGF0LmtleXMgPT0gJ1NoaWZ0Jyl7ZGVzdHJveSh0aGlzQm90KX07IjsKICAgIHZlcnNpb25CdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuY2hhbmdlT3ZvVmVyc2lvbigpOyI7CgogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24odmVyc2lvbkJ1dHRvbik7Cn0nAIHU7PIPyoMFCGhhdGNoT3ZvAgQAgdTs8g+4ywWaFEAvL2xvZ2ljIGZvciBoYXRjaGluZyBvZiBhbiBhYgpzaG91dCgnb3ZvTWVudVJlc2V0Jyk7CgovL2RhdGEgaW4gcmVnYXJkcyB0byB3aGF0IGFiIGlzIGdvaW5nIHRvIGJlIGhhdGNoZWQKY29uc3Qgb3ZvID0gdGhhdDsKCi8vaGF0Y2ggc3BlY2lmaWMgdmFyaWFibGVzCmxldCBpbml0aWFsQm9vdCA9IG92by50YWdzLmluaXRpYWxCb290OwpsZXQgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLnN0YWJsZVZlcnNpb24gPz8gb3ZvLnRhZ3MudGFyZ2V0VmVyc2lvbjsKCmlmICgoY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uIHx8IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uKSAmJiAob3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5wYXR0ZXJuIHx8IG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MuYWIpKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gY29uZmlnQm90LnRhZ3MuYWJWZXJzaW9uID8/IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm5WZXJzaW9uOwp9CgovL3RhcmdldGVkIHZlcnNpb25zCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYiB8fCAhaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpKQp7CiAgICBpZiAoY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9PSAiZmVlZGJhY2siKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5mZWVkYmFja1ZlcnNpb247CiAgICB9CiAgICBlbHNlIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJjdXJyZW50IikKICAgIHsKICAgICAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwogICAgfQogICAgZWxzZSBpZiAoIWlzTmFOKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24pKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy52ZXJzaW9uCiAgICB9CgogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG51bGw7Cn0KCmlmIChpc05hTih0YXJnZXRWZXJzaW9uKSkKewogICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aDsKfQoKbGV0IHZlcnNpb25BcnJheSA9IG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5OwpsZXQgZmlsZVVSTCA9IHZlcnNpb25BcnJheVt0YXJnZXRWZXJzaW9uIC0gMV07CmxldCBrZXkgPSBvdm8udGFncy5rZXkgPyBvdm8udGFncy5rZXkgOiBjb25maWdCb3QudGFncy5rZXk7CmxldCBmaWxlR2V0OwoKLy9hY3R1YWwgZmlsZSByZXRyaWV2YWwKdHJ5CnsKICAgIGZpbGVHZXQgPSBhd2FpdCBvcy5nZXRGaWxlKGZpbGVVUkwpOwp9CmNhdGNoIChlKQp7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnbm8gZmlsZSBmb3VuZCcpOwoKICAgIHJldHVybjsKfQoKLy9oYW5kbGluZyBmb3IgZW5jcnlwdGVkIGFiIGZpbGUKaWYgKGNyeXB0by5pc0VuY3J5cHRlZChmaWxlR2V0KSkKewogICAgaWYgKCFrZXkpCiAgICB7CiAgICAgICAga2V5ID0gYXdhaXQgb3Muc2hvd0lucHV0KCcnLCB7CiAgICAgICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgICAgICB0aXRsZTogJ0VudGVyIGtleScKICAgICAgICB9KTsKICAgIH0KCiAgICBmaWxlR2V0ID0gY3J5cHRvLmRlY3J5cHQoa2V5LCBmaWxlR2V0KTsKCiAgICBpZiAoZmlsZUdldCA9PSBudWxsKSB7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCgnaW5jb3JyZWN0IGtleScpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgCiAgICBmaWxlR2V0ID0gSlNPTi5wYXJzZShmaWxlR2V0KTsKICAgIGZpbGVHZXQgPSBmaWxlR2V0LnN0YXRlOwp9CmVsc2UKewogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KCi8vY2xlYW4gdXAKZGVzdHJveShvdm8pOwoKLy90b2FzdCBpZiBub3Qgb24gc3RhYmxlCmlmKG92by50YWdzLnN0YWJsZVZlcnNpb24gIT0gdGFyZ2V0VmVyc2lvbiAmJiAhY29uZmlnQm90LnRhZ3MuYWJTaWxlbnQpCnsKICAgIGlmIChvdm8udGFncy5mZWVkYmFja1ZlcnNpb24gPT0gdGFyZ2V0VmVyc2lvbikKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCBmZWVkYmFjayB2ZXJzaW9uIG9mICIgKyBvdm8udGFncy5hYklEKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBvcy50b2FzdCgibG9hZCB2ZXJzaW9uICIgKyB0YXJnZXRWZXJzaW9uICsgIiBvZiAiICsgb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoICsgIiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9Cn0KCi8vZ2VuZXJhdGUgYm90cyBiYXNlZCBvbiB0aGUgZmlsZSByZXRyaWV2ZWQgKkhFUkUqCmNvbnN0IG5ld0JvdHMgPSBhd2FpdCBsaW5rcy5jcmVhdGUuYWJDcmVhdGVCb3RzKHtib3RzOiBmaWxlR2V0LCBvcmlnaW46IG92by50YWdzLmFiSUQsIHN0dWRpbzogb3ZvLnRhZ3Muc3R1ZGlvLCB2ZXJzaW9uOiB0YXJnZXRWZXJzaW9uLCBpbml0aWFsQm9vdDogaW5pdGlhbEJvb3QsIGVnZ1BhcmFtZXRlcnM6IG92by50YWdzLmVnZ1BhcmFtZXRlcnN9KTsKCnJldHVybiBuZXdCb3RzOycAgdTs8g/KgwULaW50ZXJhY3RPdm8CBACB1OzyD9PfBekGQC8vbWFudWFsIGhhdGNoIG1lbnUKY29uc3Qgb3ZvQm90ID0gdGhhdCA/IHRoYXQgOiBsaW5rcy5vdm9Cb3Q7CgppZiAoIW92b0JvdCkgewogICAgcmV0dXJuOwp9CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk92b01lbnUiOwoKbWFza3Mub25HcmlkQ2xpY2sgPSBgQAogICAgc2hvdXQoIm92b01lbnVSZXNldCIpOwpgOwptYXNrcy5vdm9NZW51UmVzZXQgPSBgQAogICAgbWFza3Mub25HcmlkQ2xpY2sgPSBudWxsOwogICAgbWFza3Mub3ZvTWVudVJlc2V0ID0gbnVsbDsKCiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7Cgpvcy50d2VlblRvKG92b0JvdCwgMTUsNDUsNDUsIDUpOwoKY29uc3QgZWdnTWVudUJ1dHRvbiA9IHsKICAgIGFiT3ZvTWVudTogdHJ1ZSwKICAgIG1hbmFnZXI6IGdldExpbmsodGhpc0JvdCksCiAgICBvdm9Cb3Q6IGdldExpbmsob3ZvQm90KSwKICAgIGNvbG9yOiBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICB0YXJnZXRWZXJzaW9uOiBvdm9Cb3QudGFncy50YXJnZXRWZXJzaW9uLAogICAgbGFiZWw6IGBoYXRjaCAke292b0JvdC50YWdzLmFiSUR9IHYke292b0JvdC50YWdzLnRhcmdldFZlcnNpb259IG9mICR7b3ZvQm90LnRhZ3MubWF4VmVyc2lvbn1gLAogICAgbGFiZWxBbGlnbm1lbnQ6ICJjZW50ZXIiLAogICAgb3ZvTWVudVJlc2V0OiBgQAogICAgICAgIGRlc3Ryb3kodGhpc0JvdCk7CiAgICBgLAogICAgb25DbGljazogYEAKICAgICAgICBsaW5rcy5tYW5hZ2VyLmhhdGNoT3ZvKGxpbmtzLm92b0JvdCk7CiAgICBgLAp9OwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oZWdnTWVudUJ1dHRvbik7JwCB1OzyD8qDBQZjcmVhdGUCBACB1OzyD73mBSjwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwCB1OzyD8qDBRBjaGFuZ2VPdm9WZXJzaW9uAgQAgdTs8g/k5gXwAkAvL2xvZ2ljIGZvciB2ZXJzaW9uIGNoYW5naW5nIHdoZW4gbWFudWFsbHkgaGF0Y2hpbmcgYW4gYWIKY29uc3Qgb3ZvQm90ID0gbGlua3Mub3ZvQm90OwoKbGV0IG5ld1ZlcnNpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQob3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwgewogICAgcGxhY2Vob2xkZXI6ICJlbnRlciBhIHZlcnNpb24gZnJvbSAxIHRvICIgKyBvdm9Cb3QudGFncy5tYXhWZXJzaW9uCn0pOwoKb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiA9IG5ld1ZlcnNpb247Cm92b0JvdC50YWdzLmxhYmVsID0gJ3YnKyBuZXdWZXJzaW9uOwoKY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG5ld1ZlcnNpb247CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7JwCB1OzyD8qDBQRtZW51AgQAgdTs8g/V6QUo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicAgdTs8g/KgwUIYWJJZ25vcmUCBACB1OzyD/zpBQR0cnVlJwCB1OzyD8qDBQdhYlNoZWxsAgQAgdTs8g+B6gUEdHJ1ZScAgdTs8g/KgwUMYWIxTFRNU2VhcmNoAgQAgdTs8g+G6gUzQC8vc3VwcG9ydCBvbGQgc3ludGF4CnRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7JwCB1OzyD8qDBQ1vbkxvb2t1cEFza0lEAgQAgdTs8g+66gX/B0BsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5pbnB1dC5hYlByb2dyZXNzQmFyKGBsb29raW5nIHVwICR7dGhhdC5hc2tJRH1gKTsKCmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRDsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCBsb29rdXBBc2s7IAoKdHJ5CnsKICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIGVuZHBvaW50KTsKfQpjYXRjaAp7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIHRoYXQuYXNrSUQsIGVuZHBvaW50KTsKfQoKaWYgKHRoYXQuY2hhbm5lbENvbmZpZykKewogICAgaWYgKHByb2dyZXNzQnV0dG9uKQogICAgewogICAgICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwogICAgfQogICAgCiAgICByZXR1cm4gbG9va3VwQXNrOwp9CmVsc2UgaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmIGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCkKewogICAgaWYgKGxvb2t1cEFzay5kYXRhLnN0dWRpb0lEID09ICJBQiIpCiAgICB7CiAgICAgICAgYXdhaXQgbGlua3MubGVhcm4uYWJBZGFwdChsb29rdXBBc2suZGF0YS5wYXR0ZXJuSUQpOwoKICAgICAgICBzaG91dCgib25BQkluaXRpYWxpemVkIik7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh7YWJJRDogbG9va3VwQXNrLmRhdGEucGF0dGVybklELCByZWNvcmRLZXk6IGxvb2t1cEFzay5kYXRhLnN0dWRpb0lELCBhdXRvSGF0Y2g6IHRydWV9KTsgIAogICAgfQp9CmVsc2UgaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmICFsb29rdXBBc2suZGF0YS51cmwpCnsKICAgIGxvb2t1cEFzay5zdWNjZXNzID0gIWxvb2t1cEFzay5zdWNjZXNzOwp9CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gbG9va3VwQXNrOycAgdTs8g/KgwUFaW5wdXQCBACB1OzyD7ryBSjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwCB1OzyD8qDBQVoYXRjaAIEAIHU7PIP4fIFwAFALy9zaG91dCgiaGF0Y2giLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGtleToga2V5LCBhdXRvSGF0Y2g6IGJvb2xlYW4sIHJldHVyblR5cGU6IGRhdGEvbnVsbCwgZWdnUGFyYW1ldGVyczogYXJnfSk7Cgpjb25zdCBsb29rVXAgPSBhd2FpdCB0aGlzQm90Lm9uTG9va3VwQUJFZ2dzKHRoYXQpOwoKcmV0dXJuIGxvb2tVcDsnAIHU7PIPyoMFCWFiVmVyc2lvbgIEAIHU7PIPovQFBDEwLjQnAIHU7PIPyoMFBWxlYXJuAgQAgdTs8g+n9AUo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAgdTs8g/KgwUKYWJMb2FkVG9vbAIEAIHU7PIPzvQFsAdAbGV0IHsKICAgIHRvb2xOYW1lLAogICAgdG9vbFBhcmFtZXRlcnMsCn0gPSB0aGF0ID8/IHt9Cgphc3NlcnQodG9vbE5hbWUsIGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gdG9vbE5hbWUgaXMgYSByZXF1aXJlZCBwYXJhbWV0ZXIuYCk7Cgpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHRvb2xQYXJhbWV0ZXJzOmAsIHRvb2xQYXJhbWV0ZXJzKTsKCmNvbnN0IHVybCA9IGxpbmtzLmxlYXJuLmFiQnVpbGRDYXN1YWxDYXRhbG9nVVJMKGAvYWJ0b29scy8ke3Rvb2xOYW1lfS5hdXhgKTsKCmxldCBhdXg7Cgp0cnkgewogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB3ZWIuaG9vayh7CiAgICAgICAgbWV0aG9kOiAnR0VUJywKICAgICAgICB1cmwsCiAgICB9KQoKICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDIwMCkgewogICAgICAgIGF1eCA9IHJlc3BvbnNlLmRhdGE7CiAgICB9Cn0gY2F0Y2ggKGUpIHsKICAgIGxldCBtZXNzYWdlID0gYEZhaWxlZCB0byBkb3dubG9hZCB0b29sICcke3Rvb2xOYW1lfScuYDsKICAgIGlmIChlLm1lc3NhZ2UpIHsKICAgICAgICBtZXNzYWdlICs9IGAgRXJyb3I6ICR7ZS5tZXNzYWdlfWA7CiAgICB9CgogICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChtZXNzYWdlKTsKfQppZiAoYXV4KSB7CiAgICBpZiAoYXV4LnZlcnNpb24gPT09IDEpIHsKICAgICAgICByZXR1cm4gbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7IGJvdHM6IGF1eC5zdGF0ZSwgZWdnUGFyYW1ldGVyczogdG9vbFBhcmFtZXRlcnMsIGlnbm9yZUdyaWRGb2N1czogdHJ1ZSB9KQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhYiB0b29scyBtdXN0IGJlIGluIGF1eCBmb3JtYXQgdjEuICcke3Rvb2xOYW1lfScgaXMgYXV4IGZvcm1hdCB2JHthdXgudmVyc2lvbn1gKTsKICAgIH0KfScAgdTs8g/KgwUFdXRpbHMCBACB1OzyD//7BSjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwEEYm90cyRmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjABJwCB1OzyD6b8BQZzeXN0ZW0CBACB1OzyD6f8BQ5hYi5zaGVsbC5pbnB1dCcAgdTs8g+m/AUEZm9ybQIEAIHU7PIPtvwFB25vdGhpbmcnAIHU7PIPpvwFCW9uS2V5RG93bgIEAIHU7PIPvvwF+gpAY29uc3QgeyBrZXlzIH0gPSB0aGF0OwoKaWYgKG1hc2tzLmNoYXRPcGVuKSB7CiAgICBjb25zdCBlc2MgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0VzY2FwZScpOwoKICAgIGlmIChlc2MpIHsKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGFycm93VXAgPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93VXAnKTsKICAgICAgICBjb25zdCBhcnJvd0Rvd24gPSB0aGF0LmtleXMuaW5jbHVkZXMoJ0Fycm93RG93bicpOwogICAgICAgIAogICAgICAgIGlmIChhcnJvd1VwIHx8IGFycm93RG93bikgewogICAgICAgICAgICAvLyBJZiBBcnJvd1VwIG9yIEFycm93RG93biBhcmUgcHJlc3NlZCB3aGlsZSB0aGUgYWIgY2hhdCBiYXIgaXMgb3BlbiB0aGVuCiAgICAgICAgICAgIC8vIHN0YXJ0IGNvbWJpbmcgdGhyb3VnaCBjaGF0IGhpc3RvcnkuCiAgICAgICAgICAgIGNvbnN0IGRpciA9IGFycm93VXAgPyAtMSA6IDE7CiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCArIGRpcjsKICAgICAgICAgICAgbGV0IGhpc3RvcmljYWxUZXh0ID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChpbmRleCA+PSAwICYmIGluZGV4IDwgdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aCkgewogICAgICAgICAgICAgICAgaGlzdG9yaWNhbFRleHQgPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnlbaW5kZXhdOwogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IGluZGV4OwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4IDwgMCkgewogICAgICAgICAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IC0xOwogICAgICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID49IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIHRoaXNCb3QudmFycy5oaXN0b3J5SW5kZXggPSB0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkubGVuZ3RoOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGNoYXQgYmFyLgogICAgICAgICAgICBhd2FpdCB0aGlzQm90LmFiQ2hhdEJhckNsb3NlKCk7CiAgICAgICAgICAgIHRoaXNCb3QuYWJDaGF0QmFyT3Blbih7IHByZWZpbGw6IGhpc3RvcmljYWxUZXh0IH0pOwogICAgICAgIH0KICAgIH0KfSBlbHNlIHsKICAgIGNvbnN0IGJhY2t0aWNrID0gdGhhdC5rZXlzLmluY2x1ZGVzKCdgJykgfHwgdGhhdC5rZXlzLmluY2x1ZGVzKCJEZWFkIik7CgogICAgaWYgKGJhY2t0aWNrKSB7CiAgICAgICAgdGhpc0JvdC52YXJzLmhpc3RvcnlJbmRleCA9IHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5sZW5ndGg7CiAgICAgICAgdGhpc0JvdC5hYkNoYXRCYXJPcGVuKCk7CiAgICB9Cn0KJwCB1OzyD6b8BQZvbkNoYXQCBACB1OzyD7mHBoYIQC8vbm90IHN1cHBvcnRlZCBvdXRzaWRlIG9mIGJ1aWxkZXIgdmVyc2lvbgppZiAoIWJ1aWxkZXJWZXJzaW9uKSB7CiAgICByZXR1cm47Cn0KCi8vdGhpcyBsb29wIGlkZW50aWZpZXMgcG9zc2libGUgYWIgc3BlY2lmaWMgbWVzc2FnZXMsIGFuZCBjYWxscyBhIHNldCBsaXN0IG9mIGNvbW1hbmRzCmlmICh0aGF0Lm1lc3NhZ2VbMF0gPT0gIi4iKSB7CiAgICAvLyBHZXQgY29tbWFuZCBhbmQgYXJncy4KICAgIGxldCBhcmdzID0gdGhhdC5tZXNzYWdlLnNwbGl0KCcgJyk7CiAgICBjb25zdCBjbWQgPSBhcmdzWzBdLnNsaWNlKDEpOwogICAgYXJncy5zcGxpY2UoMCwgMSk7CiAgICBhcmdzID0gYXJncy5maWx0ZXIoYXJnID0+IGFyZyAhPT0gJycpOwogICAgYXJncyA9IGFyZ3MubGVuZ3RoID8gYXJncyA6IHVuZGVmaW5lZDsKCiAgICAvLyBDcmVhdGUgYSBmcmVzaCBDb21tYW5kc01hbmFnZXIgd2l0aCBlYWNoIGNhbGwgc28gdGhhdCB3ZSBhbHdheXMgaGF2ZSB0aGUgbGF0ZXN0IGNvbW1hbmRzIGFuZCBmdW5jdGlvbmFsaXR5LgogICAgY29uc3QgYWJDb21tYW5kcyA9IG5ldyBBQkNvbW1hbmRzTWFuYWdlcigpOwoKICAgIGlmIChhYkNvbW1hbmRzICYmIGFiQ29tbWFuZHMuaGFzQ29tbWFuZChjbWQpKSB7CiAgICAgICAgLy8gQ2FsbCBjb21tYW5kIHdpdGggYXJncy4KICAgICAgICBhYkNvbW1hbmRzLmNhbGxDb21tYW5kKGNtZCwgYXJncyk7CiAgICB9IGVsc2UgewogICAgICAgIC8vIEV2YWx1YXRlIGNvbW1hbmQgYXMgamF2YXNjcmlwdC4KICAgICAgICBvcy5ydW4oY21kKTsKICAgIH0KfQoKaWYgKHRoYXQubWVzc2FnZSkgewogICAgLy8gQXBwZW5kIG1lc3NhZ2UgdG8gY2hhdCBoaXN0b3J5IGFuZCB1cGRhdGUgdGhlIGN1cnJlbnQgaGlzdG9yeSBpbmRleC4KICAgIHRoaXNCb3QudmFycy5jaGF0SGlzdG9yeS5wdXNoKHRoYXQubWVzc2FnZSk7CiAgICB0aGlzQm90LnZhcnMuaGlzdG9yeUluZGV4ID0gdGhpc0JvdC52YXJzLmNoYXRIaXN0b3J5Lmxlbmd0aDsKfQoKdGhpc0JvdC5hYkNoYXRCYXJDbG9zZSgpOycAgdTs8g+m/AULZGVzY3JpcHRpb24CBACB1OzyD8CPBkJUaGlzIGlzIG1lYW50IHRvIGhhbmRsZSBhbnkgbm9uZSBtZW51IHJlbGF0ZWQgaW5wdXRzL2ludGVyYWN0aW9ucy4nAIHU7PIPpvwFDG9uRmlsZVVwbG9hZAIEAIHU7PIPg5AG1xhALy9maWx0ZXIgb3V0IHRpbWVzIHdoZW4gZmlsZSBsb2FkaW5nIGlzIG5vdCBhbGxvd2VkCmlmICghYnVpbGRlclZlcnNpb24gfHwgbGlua3MucmVtZW1iZXIudGFncy5hYkxpc3RlbmluZ0ZvckZpbGVVcGxvYWRzICE9PSB0cnVlKQp7CiAgICByZXR1cm47Cn0KCi8vdmFyaW91cyBmaWxlIHNwZWNpZmljIHZhcmlhYmxlcwpsZXQgZmlsZUV4dGVuc2lvbiA9IHRoYXQuZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCkudG9Mb3dlckNhc2UoKTsKbGV0IGZpbGVOYW1lID0gdGhhdC5maWxlLm5hbWUuc3BsaXQoJy4nKS5zaGlmdCgpOwpsZXQgc2l6ZSA9IHRoYXQuZmlsZS5zaXplOwpsZXQgbWltZVR5cGU7CmxldCBib3RJbmZvID0ge307CgovL2hhcmQgbGltaXQgYmFzZWQgb24gZmlsZSBzaXplCmlmIChzaXplID4gMjAwMDAwMDAwKQp7CiAgb3MudG9hc3QoIm1heGltdW0gZmlsZSBzaXplIGV4Y2VlZGVkICgyMDAgbWIpIik7CgogIHJldHVybjsKfQoKLy90aGlzIHN3aXRjaCBoYW5kbGVzIHBvc3NpYmxlIGZpbGVzIGV4dGVuc2lvbnMsIHdoaWxlIHJlamVjdGluZyBhbnkgaXQgZG9lcyBub3QgcmVjb2duaXplCnN3aXRjaChmaWxlRXh0ZW5zaW9uKQp7CiAgY2FzZSAnanBnJzoKICBjYXNlICdqcGVnJzoKICBjYXNlICd3ZWJwJzoKICBjYXNlICdnaWYnOgogIGNhc2UgJ3BuZyc6CiAgICBtaW1lVHlwZSA9ICJpbWFnZS8iICsgZmlsZUV4dGVuc2lvbjsKICAgIGJvdEluZm8uZm9ybSA9ICJzcHJpdGUiOwogICAgYnJlYWs7CiAgY2FzZSAnc3ZnJzoKICAgIG1pbWVUeXBlID0gImltYWdlL3N2Zyt4bWwiOwogICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICBicmVhazsKICBjYXNlICdnbGInOgogIGNhc2UgJ2V4cic6CiAgY2FzZSAnZ2x0Zic6CiAgICBtaW1lVHlwZSA9ICJ0ZXh0L3htbCI7CiAgICBib3RJbmZvLmZvcm0gPSAibWVzaCI7CiAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gImdsdGYiOwogICAgYnJlYWs7CiAgY2FzZSAnYXV4JzoKICBjYXNlICdwZGYnOgogICAgbGV0IGJvdERhdGEgPSBmaWxlRXh0ZW5zaW9uID09ICIuYXV4IiA/IEpTT04ucGFyc2UodGhhdC5maWxlLmRhdGEpLnN0YXRlIDogb3MucGFyc2VCb3RzRnJvbURhdGEodGhhdC5maWxlLmRhdGEpOwoKICAgIGxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoe2JvdHM6IGJvdERhdGEsIG9yaWdpbjogZmlsZU5hbWV9KTsKCiAgICByZXR1cm47Ci8vICAgY2FzZSAncGRmJzoKLy8gICAgIGJyZWFrOwogIGNhc2UgJ21wMyc6CiAgICBtaW1lVHlwZSA9ICdhdWRpby9tcGVnJzsKICAgIGJvdEluZm8ub25DbGljayA9ICJAIG9zLnBsYXlTb3VuZCh0YWdzLmZvcm1BZGRyZXNzKTsiOwogICAgYm90SW5mby5sYWJlbCA9ICJDbGljayB0byBQbGF5IjsKICAgIGJyZWFrOwogIGNhc2UgJ21wNCc6CiAgICBtaW1lVHlwZSA9ICd2aWRlby9tcDQnOwogICAgYm90SW5mby5mb3JtID0gImlmcmFtZSI7CiAgICBib3RJbmZvLmZvcm1TdWJ0eXBlID0gInNyYyI7CiAgICBicmVhazsKICBjYXNlICdvdGYnOgogICAgbWltZVR5cGUgPSAnZm9udC9vdGYnOwogICAgYm90SW5mby5sYWJlbCA9ICJleGFtcGxlIjsKICAgIGJyZWFrOwogIGNhc2UgJ3dvZmYnOgogICAgbWltZVR5cGUgPSAnZm9udC93b2ZmJzsKICAgIGJvdEluZm8ubGFiZWwgPSAiZXhhbXBsZSI7CiAgICBicmVhazsKICBkZWZhdWx0OgogICAgbGV0IHJlc3VsdCA9IG5ldyBFcnJvcigidW5oYW5kbGVkIGZpbGUgdHlwZTogIiArIGZpbGVFeHRlbnNpb24pOwogICAgb3MudG9hc3QoImZpbGUgdHlwZSBub3Qgc3VwcG9ydGVkIik7CiAgICBjb25zb2xlLndhcm4ocmVzdWx0KQogICAgcmV0dXJuIHJlc3VsdDsKfQoKLy90aGUgZm9sbG93aW5nIHZhcmlhYmxlcyBhbmQgb2JqZWN0cyBzZXQgdXAgYSBsb2FkaW5nIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmxldCB1cGxvYWRSZXN1bHQ7CmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IHRoaXNCb3QuYWJQcm9ncmVzc0JhcihgdXBsb2FkaW5nYCk7Cgpjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGNvbmZpZ0JvdC50YWdzLnN0dWRpb0lEID8/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsKCmlmICghY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpCnsKICBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKICBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA9IGF1dGhCb3QuaWQ7Cn0KCi8vdGhpcyBpcyB0aGUgYWN0dWFsIHVwbG9hZCBmdW5jdGlvbmFsaXR5CnVwbG9hZFJlc3VsdCA9IGF3YWl0IGxpbmtzLnN0b3JlLmFiUHVibGlzaEZpbGUoe2ZpbGU6IHRoYXQuZmlsZS5kYXRhLCBmaWxlTmFtZTogZmlsZU5hbWUsIG1pbWVUeXBlOiBtaW1lVHlwZX0pOwoKLy9pZiB0aGUgZmlsZSBzaG91bGQgYmUgaW5jbHVkZWQgYXMgYSBib3Qgd2l0aCBhIGxpbmssIHRoaXMgbG9naWMgaGFuZGxlcyB0aGF0CgppZiAobWltZVR5cGUuaW5jbHVkZXMoImZvbnQiKSkKewogICAgYm90SW5mb1tjb25maWdCb3QudGFncy5ncmlkUG9ydGFsXSA9IHRydWU7CiAgICBib3RJbmZvLmxhYmVsRm9udEFkZHJlc3MgPSB1cGxvYWRSZXN1bHQudXJsID8gdXBsb2FkUmVzdWx0LnVybCA6IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7CgogICAgY3JlYXRlKGJvdEluZm8pOwp9CmVsc2UgaWYgKE9iamVjdC5rZXlzKGJvdEluZm8pLmxlbmd0aCA+IDApCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5mb3JtQWRkcmVzcyA9IHVwbG9hZFJlc3VsdC51cmwgPyB1cGxvYWRSZXN1bHQudXJsIDogdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICBjcmVhdGUoYm90SW5mbyk7Cn0KCmNvbnN0IGNsaXBVUkwgPSB1cGxvYWRSZXN1bHQudXJsID8/IHVwbG9hZFJlc3VsdC5leGlzdGluZ0ZpbGVVcmw7Cgpvcy5zZXRDbGlwYm9hcmQoY2xpcFVSTCk7Cgpvcy50b2FzdCgiZmlsZSB1cmwgYWRkZWQgc2V0IHRvIGNsaXBib2FyZCIpOwoKLy9jbGVhciB0aGUgcHJvZ3Jlc3MgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKcmV0dXJuIHVwbG9hZFJlc3VsdDsnAIHU7PIPpvwFBWxlYXJuAgQAgdTs8g/bqAYo8J+UlzY2NTdiODY1LWU5ODMtNDQwMS05ZmM5LWY1NDE4ZDE4YTdmNycAgdTs8g+m/AUIcmVtZW1iZXICBACB1OzyD4KpBijwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwCB1OzyD6b8BQ1tYW5pZmVzdGF0aW9uAgQAgdTs8g+pqQYo8J+Ul2RjYTVkOTg3LWM0ZDgtNDZlNC1iNjBjLWRhYTdiMmY0ZGRhZCcAgdTs8g+m/AUIYWJJZ25vcmUCBACB1OzyD9CpBgR0cnVlJwCB1OzyD6b8BQZjcmVhdGUCBACB1OzyD9WpBijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwCB1OzyD6b8BQVzdG9yZQIEAIHU7PIP/KkGKPCflJc3NmFmMDQ5MS0zOTE5LTQ5ODQtYWE4Mi0yMmM3NDJmNDI2M2YnAIHU7PIPpvwFBG1lbnUCBACB1OzyD6OqBijwn5SXYjMwYzZjNWQtYTRmNy00MjY2LWJhMzgtMzkzZGM5NWUxZWNiJwCB1OzyD6b8BQdhYlNoZWxsAgQAgdTs8g/KqgYEdHJ1ZScAgdTs8g+m/AUNYWJQcm9ncmVzc0JhcgIEAIHU7PIPz6oG/QlAaWYgKCFjb25maWdCb3QudGFncy5hYlNpbGVudE1vZGUpCnsKICAgIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7Cn0KCmxldCBsb2FkTGFiZWwgPSB0aGF0ID8/ICJ1cGRhdGluZyI7CmxldCBtZW51QnV0dG9uID0ge307CgptZW51QnV0dG9uLnNwYWNlID0gInRlbXBMb2NhbCI7Cm1lbnVCdXR0b24uYWJNZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5tZW51SXRlbVN0eWxlID0gewogICAgImJvcmRlci1yYWRpdXMiOiI4cHgiLCAKICAgICJtYXJnaW4tdG9wIjoiOHB4IiwgCiAgICAiYm9yZGVyLXdpZHRoIjogIjJweCIsIAogICAgImJvcmRlci1jb2xvciI6ICIjMDAwIiwgCiAgICAiYm9yZGVyLXN0eWxlIjogInNvbGlkIiwKICAgICJib3gtc2hhZG93IjogIjNweCA0cHggIzAwMCIsCiAgICAibWluLWhlaWdodCI6ICI0NHB4Igp9OzsKbWVudUJ1dHRvbi50cmFja051bSA9IC0xOwptZW51QnV0dG9uLm9uQ3JlYXRlID0gYEAKICAgIGlmICh0YWdzLnRyYWNrTnVtID09IDIpCiAgICB7CiAgICAgICAgdGFncy50cmFja051bSA9IDA7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGFncy50cmFja051bSsrOwogICAgfQoKICAgIHRhZ3MubGFiZWwgPSB0YWdzWyJsYWJlbCIrdGFncy50cmFja051bV07CiAgICB0YWdzLmZvcm1BZGRyZXNzID0gdGFnc1siZm9ybSIrdGFncy50cmFja051bV07CgogICAgc2V0VGltZW91dCgoKSA9PiB3aGlzcGVyKHRoaXNCb3QsICJvbkNyZWF0ZSIpLCA1MDApO2A7Cm1lbnVCdXR0b24ubGFiZWwwID0gbG9hZExhYmVsICsgIi4iOwptZW51QnV0dG9uLmxhYmVsMSA9IGxvYWRMYWJlbCArICIuLiI7Cm1lbnVCdXR0b24ubGFiZWwyID0gbG9hZExhYmVsICsgIi4uLiI7Cm1lbnVCdXR0b24uZm9ybTAgPSAiaG91cmdsYXNzX2JvdHRvbSI7Cm1lbnVCdXR0b24uZm9ybTEgPSAiaG91cmdsYXNzX3RvcCI7Cm1lbnVCdXR0b24uZm9ybTIgPSAiaG91cmdsYXNzX2JvdHRvbSI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLmxhYmVsQ29sb3IgPSAiYmxhY2siOwptZW51QnV0dG9uLmxhYmVsQWxpZ25tZW50ID0gImNlbnRlciI7Cm1lbnVCdXR0b24uYWJQcm9ncmVzc1Jlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwptZW51QnV0dG9uLm9uRGVzdHJveSA9ICJAIGNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsiOwoKbWVudUJ1dHRvbiA9IGNyZWF0ZShtZW51QnV0dG9uKTsKCnJldHVybiBtZW51QnV0dG9uOycAgdTs8g+m/AUJb25UYXBDb2RlAgQAgdTs8g/NtAapAkBjb25zdCB0YXBDb2RlID0gdGhhdDsKCnN3aXRjaCAodGFwQ29kZSkKewogICAgY2FzZSAiMzM0MiI6CiAgICAgICAgb3MudG9hc3QoIndha2luZyAiICsgbGlua3MucmVtZW1iZXIudGFncy5hYkJ1aWxkZXJJZGVudGl0eSk7CgogICAgICAgIHRoaXNCb3Qub25DaGF0KHttZXNzYWdlOiAiLi4ifSk7CiAgICAgICAgYnJlYWs7CiAgICBjYXNlICI0MjQyIjoKICAgICAgICB0aGlzQm90LmFiQ2hhdEJhck9wZW4oKTsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgLy9jb25zb2xlLmxvZyh0YXBDb2RlKTsKfScAgdTs8g+m/AUDYXNrAgQAgdTs8g/3tgYo8J+Ul2VjODVjMWQ2LTlmMWEtNDBkNC04MmUxLTViZDY4MDM0OWMyNycAgdTs8g+m/AUJYWJWZXJzaW9uAgQAgdTs8g+etwYEMTAuNCcAgdTs8g+m/AUKb25Cb3RBZGRlZAIEAIHU7PIPo7cGQEB0aGlzQm90LmxvYWRBQkNvbW1hbmRzTWFuYWdlcigpOwp0aGlzQm90LnZhcnMuY2hhdEhpc3RvcnkgPSBbXTsnAIHU7PIPpvwFGm9uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkAgQAgdTs8g/ktwbkPEBsZXQgYWJDb21tYW5kczogQUJDb21tYW5kc01hbmFnZXIgPSB0aGF0OwoKLy8gVGhlc2UgYXJlIGFsbCB0aGUgYnVpbHQtaW4gY29tbWFuZHMuCgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2hlbHAnLCAoYXJncykgPT4gewogICAgY29uc3QgY29tbWFuZHMgPSBhYkNvbW1hbmRzLmNvbW1hbmRzOwogICAgY29uc3QgY29tbWFuZEtleXMgPSBPYmplY3Qua2V5cyhjb21tYW5kcyk7CgogICAgbGV0IHNlbGVjdGVkQ29tbWFuZDsKICAgIGlmIChjb21tYW5kS2V5cyAmJiBjb21tYW5kS2V5cy5sZW5ndGggJiYgYXJncyAmJiBhcmdzLmxlbmd0aCkgewogICAgICAgIGNvbnN0IGNvbW1hbmRLZXlNYXRjaCA9IGNvbW1hbmRLZXlzLmZpbmQoa2V5ID0+IGtleSA9PT0gYXJnc1swXSk7CiAgICAgICAgc2VsZWN0ZWRDb21tYW5kID0gY29tbWFuZEtleU1hdGNoOwogICAgfQogICAgCiAgICBsaW5rcy5oZWxwLm1vdW50KHsgYWJDb21tYW5kc01hbmFnZXI6IGFiQ29tbWFuZHMsIHNlbGVjdGVkQ29tbWFuZCB9KTsKfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1Nob3cgdGhpcyBoZWxwIHdpbmRvdy4gQ2FuIHNwZWNpZnkgYSBjb21tYW5kIHRvIG9wZW4gdGhlIGhlbHAgcGFnZSBmb3IgdGhhdCBjb21tYW5kIGRpcmVjdGx5LicsCiAgICB1c2FnZTogWycuaGVscCcsICcuaGVscCBbY29tbWFuZF0nXQp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnLicsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy4uJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnd2FrZScsIGFyZ3MgPT4gdGhpc0JvdC5jbWRBQldha2UoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdXYWtlIHVwIGFiLicsCiAgICB1c2FnZTogJy53YWtlJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2xlZXAnLCBhcmdzID0+IHRoaXNCb3QuY21kQUJTbGVlcChhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ1B1dCBhYiB0byBzbGVlcC4nLAogICAgdXNhZ2U6ICcuc2xlZXAnCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdhc2snLCAoYXJncykgPT4gewogICAgaWYgKGxpbmtzLmFzaykgewogICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICBjb25zdCBhc2tJbnB1dCA9IGFyZ3Muam9pbignICcpOwogICAgICAgICAgICBsaW5rcy5hc2suYWJDb3JlTWVudUFjdGlvbihhc2tJbnB1dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdChgLmFzayBjb21tYW5kIHJlcXVpcmVzIGlucHV0YCk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KGBhc2sgYm90IGlzIG5vdCBsb2FkZWQsIGNhbm5vdCBsb2FkIGFza2ApOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnQXNrIGFiJywKICAgIHVzYWdlOiAnLmFzayA8YXNrX25hbWU+Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbmFtZWFiJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGNvbnN0IG5hbWUgPSBhd2FpdCBvcy5zaG93SW5wdXQoYWJQZXJzb25hbGl0eS50YWdzLmFiQnVpbGRlcklkZW50aXR5LCB7IHRpdGxlOiAnd2hhdCB3b3VsZCB5b3UgbGlrZSB0byBjYWxsIG1lPycgfSk7CiAgICBzZXRUYWdNYXNrKGFiUGVyc29uYWxpdHksICdhYkJ1aWxkZXJJZGVudGl0eScsIG5hbWUsICdsb2NhbCcpOwogICAgc2hvdXQoJ2NoYW5nZVBlcnNvbmFsaXR5Q29uZmlnJywgeyBuYW1lOiBuYW1lIH0pOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2l2ZSBhYiBhIG5ldyBuYW1lLicsCiAgICB1c2FnZTogJy5uYW1lYWInCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdzeXN0ZW0nLCBhcmdzID0+IHRoaXNCb3QuY21kU3lzdGVtKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnT3BlbiB0aGUgc3lzdGVtIHBvcnRhbCAoSURFKSBmb3IgdGhlIGluc3QuJywKICAgIGxvbmdEZXNjcmlwdGlvbjogYE9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgKElERSkgZm9yIHRoZSBpICAgIAoKICAgIFlvdSBtYXkgcHJvdmlkZSBhIGN1c3RvbSBzeXN0ZW1UYWdOYW1lIHdpdGggdGhlIGNvbW1hbmQsIGluIG9yZGVyIHRvIG9wZW4gdGhlIHN5c3RlbSBwb3J0YWwgb25seSBmb3IgYm90cyB3aXRoIHRoZSBnaXZlbiBzeXN0ZW1UYWdOYW1lLiBCeSBkZWZhdWx0LCAic3lzdGVtIiB3aWxsIGJlIHVzZWQgYXMgdGhlIHN5c3RlbVRhZ05hbWUuCgogICAgRm9yIGV4YW1wbGU6CgogICAgPiAuc3lzdGVtCiAgICBUaGlzIHdpbGwgc2hvdyBhbGwgYm90cyBpbiB0aGUgc3lzdGVtUG9ydGFsIHRoYXQgaGF2ZSBhICJzeXN0ZW0iIHRhZy4KCiAgICA+IC5zeXN0ZW0gbXlHcm91cAogICAgVGhpcyB3aWxsIHNob3cgYWxsIGJvdHMgaW4gdGhlIHN5c3RlbVBvcnRhbCB0aGF0IGhhdmUgYSAibXlHcm91cCIgdGFnLgogICAgYCwKICAgIHVzYWdlOiBbCiAgICAgICAgJy5zeXN0ZW0nLAogICAgICAgICcuc3lzdGVtIHN5c3RlbVRhZ05hbWUnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy13JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4gQnkgZGVmYXVsdCB0aGUgc3lzdGVtIHBvcnRhbCB3aWxsIG9wZW4gaW4gYSBuZXcgdGFiLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdsb2cnLCAoYXJncykgPT4gewogICAgbGlua3MuY29uc29sZS50b2dnbGVDb25zb2xlKCk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdUb2dnbGUgdmlzaWJsaXR5IG9mIHRoZSBhYiBsb2cuJywKICAgIHVzYWdlOiAnLmxvZycKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9nY2xlYXInLCAoYXJncykgPT4gewogICAgY29uc3QgbWVzc2FnZUxvZ0JvdHMgPSBnZXRCb3RzKCJjb25zb2xlTG9nTWVzc2FnZUJvdCIsIHRydWUpOwogICAgZGVzdHJveShtZXNzYWdlTG9nQm90cyk7Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdDbGVhciBhbGwgYWIgbG9nIG1lc3NhZ2VzLicsCiAgICB1c2FnZTogJy5sb2djbGVhcicKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnc2hlZXQnLCBhcmdzID0+IHRoaXNCb3QuY21kU2hlZXQoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgZm9yIHNwZWNpZmllZCBib3Qgb3IgYW4gZW50aXJlIGRpbWVuc2lvbi4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLnNoZWV0IFtvcHRpb25zXSBbcG9ydGFsIHwgaGVscGVyQm90TmFtZSB8IGJvdElkIHwgZ2xvYmFsVGhpc1BhdGhdJywKICAgICAgICAnZXguIC5zaGVldCBob21lJywKICAgICAgICAnZXguIC5zaGVldCBjb25maWdCb3QnLAogICAgICAgICdleC4gLnNoZWV0IC10IGEyY2Y0NzM5LTM5YTItNGZkNi1iM2VmLWNjNDc4MmY5NzA4OScsCiAgICAgICAgJ2V4LiAuc2hlZXQgZ2xvYmFsVGhpcy5teU9iamVjdC5teUJvdCcsCiAgICAgICAgJ2V4LiAuc2hlZXQgbXlPYmplY3QubXlCb3QnCiAgICBdLAogICAgYXJnczogWwogICAgICAgIHsKICAgICAgICAgICAgaWRlbnRpZmllcjogJy10JywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcGVuIHRoZSBzaGVldCBwb3J0YWwgaW4gYSBuZXcgYnJvd3NlciB0YWIuIFxuXG5OT1RFOiAuc2hlZXQgd2lsbCBhdXRvbWF0aWNhbGx5IGluc3BlY3QgdGhlIHNwYWNlIG9mIGEgYm90IGFuZCBmb3JjZSBvcGVuaW5nIGluIHRoZSBzYW1lIHRhYiBpZiBhIGJvdCBpcyBpbiB0ZW1wTG9jYWwgb3IgdGVtcFNoYXJlZCBzcGFjZS4nLAogICAgICAgIH0KICAgIF0KfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ21lbnVzaGVldCcsIChhcmdzKSA9PiB7CiAgICBjb25maWdCb3QudGFncy5zaGVldFBvcnRhbCA9IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWw7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwpIHsKICAgICAgICBsaW5rcy51dGlscy5hYkxvZ0FuZFRvYXN0KHsgbWVzc2FnZTogYENhbm5vdCBvcGVuIHNoZWV0UG9ydGFsIGZvciBtZW51UG9ydGFsIGJvdHMuIFRoZSBtZW51UG9ydGFsIGlzIGN1cnJlbnRseSBkaXNhYmxlZC5gfSkKICAgIH0KfSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ09wZW4gdGhlIHNoZWV0IHBvcnRhbCBmb3IgdGhlIGN1cnJlbnQgbWVudSBwb3J0YWwuJywKICAgIHVzYWdlOiAnLm1lbnVTaGVldCcsCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGluc3QnLCBhcmdzID0+IHRoaXNCb3QuY21kRG93bmxvYWRJbnN0KGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgdGhlIGluc3QgdG8gZGlzay4nLAogICAgdXNhZ2U6ICcuZG93bmxvYWRpbnN0Jwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZG93bmxvYWRhYicsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEFCKGFyZ3MpLCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRG93bmxvYWQgc3BlY2lmaWVkIGFiIGZpbGUgdG8gZGlzay4nLAogICAgdXNhZ2U6IFsKICAgICAgICAnLmRvd25sb2FkYWInLAogICAgICAgICcuZG93bmxvYWRhYiAtdiAxJwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctdicsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnU3BlY2lmeSB0aGUgYXV4IGZvcm1hdCB2ZXJzaW9uIG51bWJlci4gZXguIC12IDEgd2lsbCBiZSBhdXggZm9ybWF0IHZlcnNpb24gMSAocHVyZSBib3QganNvbikuIEJ5IGRlZmF1bHQsIGFiIGZpbGVzIGFyZSB1c3VhbGx5IGRvd25sb2FkZWQgYXMgdmVyc2lvbiAyIGF1eCBmaWxlcyAoY29uZmxpY3QtZnJlZSB1cGRhdGUpLicKICAgICAgICB9CiAgICBdCn0pOwoKYWJDb21tYW5kcy5hZGRDb21tYW5kKCdkb3dubG9hZGVnZycsIGFyZ3MgPT4gdGhpc0JvdC5jbWREb3dubG9hZEVnZyhhcmdzKSwgewogICAgc2hvcnREZXNjcmlwdGlvbjogJ0Rvd25sb2FkIGF1eCBmaWxlIGZyb20gYWIgZWdnLicsCiAgICBsb25nRGVzY3JpcHRpb246IGBEb3dubG9hZCBhdXggZmlsZSBmcm9tIGFiIGVnZy4gWW91IHdpbGwgbmVlZCB0byBwcm92aWRlIHRoZSByZWNvcmRLZXkgYXMgd2VsbCBhbmQgdGhlIG5hbWUgb2YgdGhlIGVnZy4gQSBkcm9wZG93biBzZWxlY3Rpb24gd2lsbCBiZSBwcm92aWRlZCBmb3IgdGhlIGVnZyBpZiBmb3VuZCB0byBzZWxlY3Qgd2hpY2ggdmVyc2lvbiB0byBkb3dubG9hZC5gLAogICAgdXNhZ2U6ICcuZG93bmxvYWRlZ2cnLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnbG9hZHNraWxsJywgYXN5bmMgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzKSB7CiAgICAgICAgZm9yIChsZXQgc2tpbGwgb2YgYXJncykgewogICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoJy5sb2Fkc2tpbGwgcmVxdWlyZXMgc29tZSBza2lsbCBuYW1lcycpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnTG9hZCB0aGUgc3BlY2lmaWVkIGFiIHNraWxscy4nLAogICAgdXNhZ2U6ICcubG9hZFNraWxsIFtza2lsbCAuLi5dJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXJscXInLCAoKSA9PiBvcy5zaG93UVJDb2RlKGNvbmZpZ0JvdC50YWdzLnVybCksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdTaG93IGEgUVIgY29kZSBmb3IgdGhlIGJyb3dlciB0YWJcJ3MgY3VycmVudCBVUkwuJywKICAgIHVzYWdlOiAnLnVybHFyJwp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgnZGltJywgKGFyZ3MpID0+IHsKICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgY29uc3QgbmFtZSA9IGFyZ3Muam9pbignICcpOwogICAgICAgIG9zLmdvVG9EaW1lbnNpb24obmFtZSk7CiAgICAgICAgbGlua3MudXRpbHMuYWJMb2dBbmRUb2FzdCh7IG1lc3NhZ2U6IGBNb3ZlZCB0byAnJHtuYW1lfScgZGltZW5zaW9uLmAsIGR1cmF0aW9uOiAzIH0pCiAgICB9Cn0sIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdHbyB0byBzcGVjaWZpZWQgZGltZW5zaW9uIC8gcG9ydGFsLicsCiAgICB1c2FnZTogJy5kaW0gPGRpbWVuc2lvbiB8IHBvcnRhbD4nLAp9KTsKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXVpZCcsICgpID0+IHsKICAgIG9zLnNldENsaXBib2FyZCh1dWlkKCkpOwoKICAgIGxldCBtZXNzYWdlID0gYENvcGllZCBuZXcgdXVpZCB0byBjbGlwYm9hcmRgOwogICAgYWIubG9nKGFiUGVyc29uYWxpdHkudGFncy5hYkJ1aWxkZXJJZGVudGl0eSArICc6ICcgKyBtZXNzYWdlKTsKICAgIG9zLnRvYXN0KG1lc3NhZ2UpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnR2VuZXJhdGUgYSB1bml2ZXJzYWxseSB1bmlxdWUgaWRlbnRpZmllciAodXVpZCkgYW5kIGNvcHkgaXQgdG8gdGhlIGNsaXBib2FyZC4nLAogICAgdXNhZ2U6ICcudXVpZCcKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ2R1cCcsIChhcmdzKSA9PiB7CiAgICBjb25zdCBib3RJZCA9IGFyZ3MgPyBhcmdzWzBdIDogdW5kZWZpbmVkOwogICAgaWYgKGJvdElkKSB7CiAgICAgICAgY29uc3QgYm90ID0gZ2V0Qm90KCdpZCcsIGJvdElkKTsKICAgICAgICBpZiAoYm90KSB7CiAgICAgICAgICAgIGNvbnN0IGR1cEJvdCA9IGNyZWF0ZShib3QpOwogICAgICAgICAgICBvcy5zZXRDbGlwYm9hcmQoZHVwQm90LmlkKTsKICAgICAgICAgICAgb3MudG9hc3QoJ0R1cGxpY2F0ZSBib3QgaWQgY29waWVkIHRvIGNsaXBib2FyZC4nKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBvcy50b2FzdChgTm8gYm90IGZvdW5kIHdpdGggaWQgJHtib3RJZH1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIG9zLnRvYXN0KCdQcm92aWRlIHRoZSBpZCBvZiB0aGUgYm90IHlvdSB3YW50IHRvIGR1cGxpY2F0ZScpOwogICAgfQp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnRHVwbGljYXRlIGEgc3BlY2lmaWVkIGJvdCBhbmQgY29weSB0aGUgbmV3IGJvdFwncyBpZCB0byB0aGUgY2xpcGJvYXJkLicsCiAgICB1c2FnZTogJy5kdXAgPGJvdElkPicKfSk7CgphYkNvbW1hbmRzLmFkZENvbW1hbmQoJ3VwbG9hZGF1eCcsIChhcmdzKSA9PiB7CiAgICBvcy5zaG93VXBsb2FkQXV4RmlsZSgpOwp9LCB7CiAgICBzaG9ydERlc2NyaXB0aW9uOiAnVXBsb2FkIEFVWCBmaWxlKHMpIHRvIHRoZSBjdXJyZW50IGluc3QuJywKICAgIHVzYWdlOiAnLnVwbG9hZGF1eCcKfSkKCmFiQ29tbWFuZHMuYWRkQ29tbWFuZCgndXBsb2FkZmlsZXMnLCBhcmdzID0+IHRoaXNCb3QuY21kVXBsb2FkRmlsZXMoYXJncyksIHsKICAgIHNob3J0RGVzY3JpcHRpb246ICdVcGxvYWQgZmlsZShzKSBkaXJlY3RseSB0byByZWNvcmQuJywKICAgIHVzYWdlOiBbCiAgICAgICAgJy51cGxvYWRmaWxlcycsCiAgICAgICAgJy51cGxvYWRmaWxlcyAtcmVjb3JkIDxyZWNvcmRfaWQ+JwogICAgXSwKICAgIGFyZ3M6IFsKICAgICAgICB7CiAgICAgICAgICAgIGlkZW50aWZpZXI6ICctcmVjb3JkJywKICAgICAgICAgICAgZGVzY3JpcHRpb246ICdPcHRpb25hbGx5IHB1Ymxpc2ggZmlsZShzKSB0byBhIHNwZWNpZmljIHJlY29yZC4gSWYgb21pdHRlZCwgZmlsZShzKSB3aWxsIGJlIHB1Ymxpc2hlZCB0byB0aGUgdXNlclwncyBwZXJzb25hbCByZWNvcmQuJwogICAgICAgIH0KICAgIF0KfSknAIHU7PIPpvwFFWxvYWRBQkNvbW1hbmRzTWFuYWdlcgIEAIHU7PIPyfQG6jBAdHlwZSBBQkNvbW1hbmRDYWxsYmFjayA9IChhcmdzPzogYW55W10pID0+IHZvaWQ7CgppbnRlcmZhY2UgQUJDb21tYW5kQXJnIHsKICBpZGVudGlmaWVyOiBzdHJpbmdbXSB8IHN0cmluZzsKICBkZXNjcmlwdGlvbjogc3RyaW5nOwp9CgppbnRlcmZhY2UgQUJDb21tYW5kSGVscCB7CiAgc2hvcnREZXNjcmlwdGlvbjogc3RyaW5nOwogIGxvbmdEZXNjcmlwdGlvbj86IHN0cmluZzsKICBhcmdzPzogQUJDb21tYW5kQXJnW107CiAgdXNhZ2U/OiBzdHJpbmcgfCBzdHJpbmdbXTsKfQoKaW50ZXJmYWNlIEFCQ29tbWFuZCB7CiAgbmFtZTogc3RyaW5nOwogIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjazsKICBoZWxwOiBBQkNvbW1hbmRIZWxwOwp9CgovKioKICogQUJDb21tYW5kc01hbmFnZXIgaXMgcGFydCBvZiBhYlNoZWxsLgogKiBZb3UgY2FuIHJlZ2lzdGVyIGNvbW1hbmRzIHRvIGl0IHRoYXQgY2FuIGJlIGludm9rZWQgdXNpbmcgJyQ8Y29tbWFuZD4nIHdpdGggdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogKiBJdHMgZ2VuZXJhbGx5IG5vdCByZWNvbW1lbmRlZCB0byBjcmVhdGUgdGhpcyB5b3Vyc2VsZiBidXQgaW5zdGVhZCB0byBsaXN0ZW4gZm9yIHRoZSBAb25BQkNvbW1hbmRzTWFuYWdlckNyZWF0ZWQgc2hvdXQKICogYW5kIHRvIHJlZ2lzdGVyIHlvdXIgY29tbWFuZHMgdGhlcmUuCiAqIEBwcm9wIHtzdHJpbmdbXX0gY29tbWFuZHMKICovCmNsYXNzIEFCQ29tbWFuZHNNYW5hZ2VyIHsKICAgIGNvbW1hbmRzOiBSZWNvcmQ8c3RyaW5nLCBBQkNvbW1hbmQ+OwoKICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTsKCiAgICAgICAgLy8gU2hvdXQgdGhhdCBhbiBpbnN0YW5jZSBvZiBBQkNvbW1hbmRzTWFuYWdlciBoYXMgYmVlbiBjcmVhdGVkIGFuZCBhbGxvdyBhbnkgbGlzdGVuZXJzCiAgICAgICAgLy8gdG8gYWRkIHRoZWlyIG93biBjb21tYW5kcyB0byB0aGUgaW5zdGFuY2UuCiAgICAgICAgc2hvdXQoJ29uQUJDb21tYW5kc01hbmFnZXJDcmVhdGVkJywgdGhpcyk7CiAgICB9CgogICAgLyoqCiAgICAgKiBBZGQgYSBjb21tYW5kIHRvIEFCQ29tbWFuZHNNYW5hZ2VyLgogICAgICogVGhpcyBjb21tYW5kIHdpbGwgYmUgYXZhaWxhYmxlIHRvIGludm9rZSB1c2luZyAnJDxuYW1lPicgb24gdGhlIENhc3VhbE9TIGNoYXQgYmFyLgogICAgICogQHJldHVybnMge2Jvb2xlYW59IFdldGhlciBvciBub3QgdGhlIGNvbW1hbmQgd2FzIHN1Y2Nlc3NmdWxseSBhZGRlZC4KICAgICAqLwogICAgYWRkQ29tbWFuZChuYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiBBQkNvbW1hbmRDYWxsYmFjaywgaGVscDogQUJDb21tYW5kSGVscCk6IGJvb2xlYW4gewogICAgICAgIGlmICghbmFtZSB8fCB0eXBlb2YgbmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSBzdHJpbmcgbmFtZSBpcyByZXF1aXJlZCBmb3IgY29tbWFuZHMuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBhbHJlYWR5IGV4aXN0cyBhcyBhIGNvbW1hbmQuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghY2FsbGJhY2sgfHwgdHlwZW9mIGNhbGxiYWNrICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBjb21tYW5kIHJlcXVpcmVzIGEgY2FsbGJhY2sgZnVuY3Rpb24uYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICghaGVscCkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQUJDb21tYW5kc01hbmFnZXJdICR7bmFtZX0gY29tbWFuZCByZXF1aXJlcyBoZWxwIG9iamVjdC5gKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFoZWxwLnNob3J0RGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0FCQ29tbWFuZHNNYW5hZ2VyXSAke25hbWV9IGNvbW1hbmQgaXMgbWlzc2luZyBzaG9ydERlc2NyaXB0aW9uIGZyb20gaGVscCBvYmplY3QuYCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29tbWFuZHNbbmFtZV0gPSB7IG5hbWUsIGNhbGxiYWNrLCBoZWxwIH07CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgaGFzQ29tbWFuZChuYW1lOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kc1tuYW1lXSAhPSBudWxsOwogICAgfQoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgY29tbWFuZCBmcm9tIEFCQ29tbWFuZHNNYW5hZ2VyCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gV2V0aGVyIG9yIG5vdCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2FzIHJlbW92ZWQuIElmIHRoZSBjb21tYW5kIGRvZXNuJ3QgZXhpc3QgZmFsc2Ugd2lsbCBhbHNvIGJlIHJldHVybmVkLgogICAgICovCiAgICByZW1vdmVDb21tYW5kKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4gewogICAgICAgIGlmICh0aGlzLmNvbW1hbmRzW25hbWVdKSB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbW1hbmRzW25hbWVdOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQ2FsbCB0aGUgc3BlY2lmaWVkIGNvbW1hbmQgd2l0aCB0aGUgcHJvdmlkZWQgYXJncyAoaWYgYW55KS4KICAgICAqIEByZXR1cm5zIHtib29sZWFufSBXZXRoZXIgb3Igbm90IHRoZSBjb21tYW5kIHdhcyBleGVjdXRlZC4KICAgICAqLwogICAgY2FsbENvbW1hbmQobmFtZTogc3RyaW5nLCBhcmdzPzogYW55W10pOiBib29sZWFuIHsKICAgICAgICBjb25zdCBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tuYW1lXTsKICAgICAgICBpZiAoY29tbWFuZCkgewogICAgICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRBcmdzID0gW107CgogICAgICAgICAgICAgICAgaWYgKGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBoZWxwQXJnIG9mIGNvbW1hbmQuaGVscC5hcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGhlbHBBcmcuaWRlbnRpZmllcikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkQXJncy5wdXNoKC4uLmhlbHBBcmcuaWRlbnRpZmllcik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZEFyZ3MucHVzaChoZWxwQXJnLmlkZW50aWZpZXIpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEFzc2VydCB0aGF0IHRoZSBpbnB1dCBhcmdzIGFyZSB2YWxpZCBhZ2FpbnN0IHRoZSBjb21tYW5kIGhlbHAgZG9jdW1lbnRhdGlvbi4KICAgICAgICAgICAgICAgIC8vIFRoaXMgaXMgYW4gZWFzeSB3YXkgdG8gdmFsaWRhdGUgYXJncyBiZWZvcmUgZXhlY3V0aW5nIGEgY29tbWFuZC4KICAgICAgICAgICAgICAgIEFCQ29tbWFuZHNNYW5hZ2VyLmFzc2VydFZhbGlkQXJncyhhcmdzLCB2YWxpZEFyZ3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbW1hbmQuY2FsbGJhY2soYXJncyk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFtBQkNvbW1hbmRzTWFuYWdlcl0gJHtuYW1lfSBpcyBub3QgYSB2YWxpZCBjb21tYW5kLmApOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgdGhlIHByb3ZpZGVkIGFyZy4gV2lsbCByZW1vdmUgdGhlIGFyZyBhbmQgdmFsdWUgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnVmFsdWUoYXJnczogYW55W10sIGFyZzogc3RyaW5nKTogYW55IHsKICAgICAgICBsZXQgdmFsdWUgPSBudWxsOwoKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICBsZXQgZGVsZXRlQ291bnQgPSAxOwogICAgICAgICAgICAgICAgY29uc3QgdmFsdWVJbmRleCA9IGFyZ0luZGV4ICsgMTsKCiAgICAgICAgICAgICAgICBpZiAodmFsdWVJbmRleCA8IGFyZ3MubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsZXRlQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGFyZ3NbdmFsdWVJbmRleF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUmVtb3ZlIHJlbGF0ZWQgYXJncyAmIHZhbHVlcwogICAgICAgICAgICAgICAgYXJncy5zcGxpY2UoYXJnSW5kZXgsIGRlbGV0ZUNvdW50KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIHdldGhlciB0aGUgYXJnIGZsYWcgaXMgcHJvdmlkZWQgaW4gdGhlIGFyZ3MuIFdpbGwgcmVtb3ZlIHRoZSBhcmcgZnJvbSB0aGUgYXJncyBhcnJheS4KICAgICAqLwogICAgc3RhdGljIHBhcnNlQXJnRmxhZyhhcmdzOiBhbnlbXSwgYXJnOiBzdHJpbmcpOiBib29sZWFuIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBhcmdJbmRleCA9IGFyZ3MuZmluZEluZGV4KGEgPT4gYSA9PT0gYXJnKTsKCiAgICAgICAgICAgIGlmIChhcmdJbmRleCA+PSAwKSB7CiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgYXJnIGZsYWcuCiAgICAgICAgICAgICAgICBhcmdzLnNwbGljZShhcmdJbmRleCwgMSk7CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQoKICAgIHN0YXRpYyBhc3NlcnRWYWxpZEFyZ3MoYXJnczogYW55W10sIHZhbGlkQXJnczogYW55W10pOiB2b2lkIHsKICAgICAgICBpZiAoYXJncykgewogICAgICAgICAgICBjb25zdCBpbnZhbGlkQXJncyA9IFtdOwoKICAgICAgICAgICAgZm9yIChsZXQgYXJnIG9mIGFyZ3MpIHsKICAgICAgICAgICAgICAgIGlmIChhcmcgJiYgdHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoYXJnLnN0YXJ0c1dpdGgoJy0nKSkgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGlzIGlzIGFuIGFyZyB3ZSB3YW50IHRvIGV2YWx1YXRlLgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZhbGlkQXJncyB8fCAhdmFsaWRBcmdzLmluY2x1ZGVzKGFyZykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoaXMgYXJnIGlzIG5vdCBpbmNsdWRlZCBpbiB0aGUgdmFsaWRBcmdzLCB0aHVzIHRoZSBhcmcgaXMgaW52YWxpZC4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRBcmdzLnB1c2goYXJnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSB0aGlzIGFyZyBpdCBpcyBtb3N0bHkgbGlrZWx5IGEgdmFsdWUgYXJnLgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGludmFsaWRBcmdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBJbnZhbGlkIGFyZ3VtZW50czogJHtpbnZhbGlkQXJncy5qb2luKCcsICcpfWA7CgogICAgICAgICAgICAgICAgb3MudG9hc3QoZXJyb3JNZXNzYWdlLCA0KTsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2UpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgpnbG9iYWxUaGlzLkFCQ29tbWFuZHNNYW5hZ2VyID0gQUJDb21tYW5kc01hbmFnZXI7JwCB1OzyD6b8BQRoZWxwAgQAgdTs8g+0pQco8J+UlzI0ZGMwNDMxLWZmYmItNDQ4ZC1hYTc1LTk3MWJhYTA3MThkYycAgdTs8g+m/AUIY21kU2hlZXQCBACB1OzyD9ulB80UQGNvbnN0IGFyZ3MgPSB0aGF0OwoKbGV0IHBvcnRhbDsKbGV0IG5ld1RhYiA9IGZhbHNlOwoKaWYgKGFyZ3MpIHsKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgIGNvbnN0IGFyZyA9IGFyZ3NbaV07CiAgICAgICAgaWYgKGFyZy5zdGFydHNXaXRoKCctJykpIHsKICAgICAgICAgICAgaWYgKGFyZyA9PT0gJy10JykgewogICAgICAgICAgICAgICAgbmV3VGFiID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoIXBvcnRhbCkgewogICAgICAgICAgICBwb3J0YWwgPSBhcmc7CiAgICAgICAgfQogICAgfQp9CgppZiAoIXBvcnRhbCkgewogICAgcG9ydGFsID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9Cgpjb25zdCBoZWxwZXJCb3RzID0gewogICAgJ2NvbmZpZ0JvdCc6IGNvbmZpZ0JvdCwKICAgICdncmlkUG9ydGFsQm90JzogZ3JpZFBvcnRhbEJvdCwKICAgICdzaGVldFBvcnRhbEJvdCc6IHNoZWV0UG9ydGFsQm90LAogICAgJ3N5c3RlbVBvcnRhbEJvdCc6IHN5c3RlbVBvcnRhbEJvdCwKICAgICdtaW5pR3JpZFBvcnRhbEJvdCc6IG1pbmlHcmlkUG9ydGFsQm90LAogICAgJ21hcFBvcnRhbEJvdCc6IG1hcFBvcnRhbEJvdCwKICAgICdtaW5pTWFwUG9ydGFsQm90JzogbWluaU1hcFBvcnRhbEJvdCwKICAgICdtZW51UG9ydGFsQm90JzogbWVudVBvcnRhbEJvdCwKICAgICdsZWZ0V3Jpc3RQb3J0YWxCb3QnOiBsZWZ0V3Jpc3RQb3J0YWxCb3QsCiAgICAncmlnaHRXcmlzdFBvcnRhbEJvdCc6IHJpZ2h0V3Jpc3RQb3J0YWxCb3QsCiAgICAnbWVldFBvcnRhbEJvdCc6IG1lZXRQb3J0YWxCb3QsCiAgICAndGFnUG9ydGFsQm90JzogdGFnUG9ydGFsQm90LAogICAgJ2ltdVBvcnRhbEJvdCc6IGltdVBvcnRhbEJvdCwKfTsKCi8vIEZ1bmN0aW9uIHRvIHJlc29sdmUgYSBwb3J0YWwgcmVmZXJlbmNlIHRvIGEgc3BlY2lmaWMgYm90CmZ1bmN0aW9uIHJlc29sdmVQb3J0YWxUb0JvdChwYXRoKSB7CiAgICBpZiAoIXBhdGggfHwgcGF0aCA9PT0gJycpIHJldHVybiBudWxsOwogICAgCiAgICAvLyBGaXJzdCBjaGVjayBpZiBpdCdzIGRpcmVjdGx5IGluIGhlbHBlckJvdHMKICAgIGlmIChoZWxwZXJCb3RzW3BhdGhdKSB7CiAgICAgICAgcmV0dXJuIGhlbHBlckJvdHNbcGF0aF07CiAgICB9CgogICAgLy8gUGVyaGFwcyB0aGUgcGF0aCBpcyBhIGJvdCBpZC4KICAgIGxldCBib3RGcm9tSWRTZWFyY2ggPSBnZXRCb3QoJ2lkJywgcGF0aCk7CiAgICBpZiAoYm90RnJvbUlkU2VhcmNoKSB7CiAgICAgICAgcmV0dXJuIGJvdEZyb21JZFNlYXJjaDsKICAgIH0KICAgIAogICAgLy8gQ2hlY2sgZm9yIGJvdGggZGlyZWN0IGFuZCBuZXN0ZWQgcGF0aHMgaW4gZ2xvYmFsVGhpcwogICAgbGV0IHBhdGhQYXJ0cyA9IHBhdGguc3BsaXQoJy4nKTsKICAgIGxldCBjdXJyZW50T2JqID0gZ2xvYmFsVGhpczsKICAgIGxldCBzdGFydEluZGV4ID0gMDsKICAgIAogICAgLy8gSGFuZGxlIGlmIHRoZSBwYXRoIGV4cGxpY2l0bHkgc3RhcnRzIHdpdGggJ2dsb2JhbFRoaXMnCiAgICBpZiAocGF0aFBhcnRzWzBdID09PSAnZ2xvYmFsVGhpcycpIHsKICAgICAgICBzdGFydEluZGV4ID0gMTsgLy8gU2tpcCB0aGUgJ2dsb2JhbFRoaXMnIHBhcnQgc2luY2Ugd2UncmUgYWxyZWFkeSBzdGFydGluZyB0aGVyZQogICAgfQogICAgCiAgICAvLyBUcmF2ZXJzZSB0aGUgcGF0aAogICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBwYXRoUGFydHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBjb25zdCBwYXJ0ID0gcGF0aFBhcnRzW2ldOwogICAgICAgIGlmICghY3VycmVudE9ialtwYXJ0XSkgewogICAgICAgICAgICByZXR1cm4gbnVsbDsgLy8gUGF0aCBzZWdtZW50IGRvZXNuJ3QgZXhpc3QKICAgICAgICB9CiAgICAgICAgY3VycmVudE9iaiA9IGN1cnJlbnRPYmpbcGFydF07CiAgICB9CiAgICAKICAgIC8vIENoZWNrIGlmIHRoZSBmaW5hbCBvYmplY3QgaXMgYSBib3QgKGhhcyBpZCBhbmQgdGFncykKICAgIGlmIChjdXJyZW50T2JqICYmIGN1cnJlbnRPYmouaWQgJiYgY3VycmVudE9iai50YWdzKSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnRPYmo7CiAgICB9CiAgICAKICAgIHJldHVybiBudWxsOyAvLyBOb3QgYSB2YWxpZCBib3QKfQoKLy8gU2VhcmNoIHRvIHNlZSBpZiBwb3J0YWwgYXJndW1lbnQgaXMgc3BlY2lmaWMgdG8gYSBib3QKbGV0IHVuaXF1ZUJvdCA9IHJlc29sdmVQb3J0YWxUb0JvdChwb3J0YWwpOwoKaWYgKHVuaXF1ZUJvdCkgewogICAgaWYgKHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcExvY2FsJyB8fAogICAgICAgIHVuaXF1ZUJvdC50YWdzLnNwYWNlID09PSAndGVtcFNoYXJlZCcKICAgICkgewogICAgICAgIC8vIEZvcmNlIHNoZWV0IHRvIG9wZW4gaW4gc2FtZSB0YWIgaWYgdGhlIGJvdCBvbmx5IGxpdmVzIGluIHRoaXMgdGFiLgogICAgICAgIG5ld1RhYiA9IGZhbHNlOwogICAgfQogICAgcG9ydGFsID0gdW5pcXVlQm90LmlkOwp9CgppZiAobmV3VGFiKSB7CiAgICBvcy5vcGVuVVJMKGAvP2luc3Q9JHtvcy5nZXRDdXJyZW50SW5zdCgpfSZzaGVldFBvcnRhbD0ke3BvcnRhbH1gKTsKfSBlbHNlIHsKICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gcG9ydGFsOwp9JwCB1OzyD6b8BQ1jbWREb3dubG9hZEFCAgQAgdTs8g+pugfOCEBjb25zdCBhcmdzID0gdGhhdDsKCmxldCBhdXhWZXJzaW9uOiBzdHJpbmcgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctdicpOwoKaWYgKCFhdXhWZXJzaW9uKSB7CiAgICAvLyBEZWZhdWx0IHRvIGF1eCB2ZXJzaW9uIDIgaWYgYXJndW1lbnQgaXMgbm90IHByb3ZpZGVkLgogICAgYXV4VmVyc2lvbiA9ICcyJzsKfQoKaWYgKGF1eFZlcnNpb24gIT09ICcxJyAmJiBhdXhWZXJzaW9uICE9PSAnMicpIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYE9ubHkgYXV4IGZvcm1hdCB2ZXJzaW9uIDEgYW5kIDIgYXJlIHN1cHBvcnRlZCBpbiB0aGUgZG93bmxvYWQgYWIgY29tbWFuZC5gKTsKICAgIHJldHVybjsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmxldCBncm91cCA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRBQkdyb3VwLCB7IHRpdGxlOiAnQUIgR3JvdXAgVGFnJywgYXV0b1NlbGVjdDogdHJ1ZSB9KTsKbWFza3MucHJldkRvd25sb2FkQUJHcm91cCA9IGdyb3VwOwoKY29uc3QgbWFqb3JWZXJzaW9uID0gbGlua3MubGVhcm4udGFncy5hYkNvcmVNYWpvclZlcnNpb247CmNvbnN0IG1pbm9yVmVyc2lvbiA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJDb3JlTWlub3JWZXJzaW9uOwpjb25zdCBhYlZlcnNpb24gPSBgJHttYWpvclZlcnNpb259LiR7bWlub3JWZXJzaW9ufWA7Cgpjb25zdCBhYkdyb3VwID0gZ2V0Qm90cyhncm91cCk7Cgpmb3IgKGxldCBpID0gMDsgaSA8IGFiR3JvdXAubGVuZ3RoOyBpKyspIHsKICAgIGFiR3JvdXBbaV0udGFncy5hYlZlcnNpb24gPSBhYlZlcnNpb247Cn0KCmlmIChncm91cCA9PSAiYWJDb25maWciKSB7CiAgICBncm91cCA9ICJhYjEiOwp9CgppZiAoYXV4VmVyc2lvbiA9PT0gJzEnKSB7CiAgICAvLyBEb3dubG9hZCBhcyB2ZXJzaW9uIDEKICAgIG9zLmRvd25sb2FkQm90cyhhYkdyb3VwLCBncm91cCkKfSBlbHNlIHsKICAgIC8vIERvd25sb2FkIGFzIHZlcnNpb24gMgogICAgb3MuZG93bmxvYWRCb3RzQXNJbml0aWFsemF0aW9uVXBkYXRlKGFiR3JvdXAsIGdyb3VwKTsKfQonAIHU7PIPpvwFCWNtZEFCV2FrZQIEAIHU7PIP+MIHxANAbGV0IHNraWxsQXJyYXkgPSBbImFiUGVyc29uYWxpdHkiLCAiYWJJbnRlcmZhY2UiLCAiYWJBY3Rpb24iLCAiYWJUZXN0cyJdOwoKZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKSB7CiAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwp9Cgphd2FpdCBvcy5zbGVlcCgzMDApOwoKLy9rZWVwIGFiIGF3YWtlCmxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBd2FrZVN0YXRlID0gdHJ1ZTsKCmlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47Cn0KZWxzZSB7CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKfQoKY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkF3YWtlIiwgImFiTWFuaWZlc3RTdGF0ZSIpOycAgdTs8g+m/AUKY21kQUJTbGVlcAIEAIHU7PIPvcYH3QFAY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gbnVsbDsKY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbCA9IG51bGw7CmNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWxTcGFjZSA9IG51bGw7Cgp0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOycAgdTs8g+m/AUHY29uc29sZQIEAIHU7PIPm8gHKPCflJcyNGI3ZTY2Zi0wZDViLTQwNjQtYmY0OC1iNTYyYjllNmUzZWInAIHU7PIPpvwFDmNtZFVwbG9hZEZpbGVzAgQAgdTs8g/CyAeTEEBjb25zdCBhcmdzID0gdGhhdDsKCmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUoeyBmaWxlLCByZWNvcmRLZXkgfSkgewogICAgbGV0IGZpbGVFeHRlbnNpb24gPSBmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKTsKICAgIGxldCBmaWxlTmFtZSA9IGZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CiAgICBsZXQgbWltZVR5cGU7CgogICAgc3dpdGNoIChmaWxlRXh0ZW5zaW9uKSB7CiAgICAgICAgY2FzZSAnc3ZnJzoKICAgICAgICAgICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2dsYic6CiAgICAgICAgY2FzZSAnZ2x0Zic6CiAgICAgICAgICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgbWltZVR5cGUgPSBmaWxlLm1pbWVUeXBlOwogICAgICAgICAgICBicmVhazsKICAgIH0KCiAgICBsZXQgdXJsOwogICAgICAgIAogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSByZWNvcmRLZXk7CiAgICBjb25zdCBbcmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKHNob3V0KCdhYlB1Ymxpc2hGaWxlJywgeyBmaWxlLCBmaWxlTmFtZSwgbWltZVR5cGUgfSkpOwogICAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBudWxsOwogICAgCiAgICBpZiAocmVzdWx0LnVybCkgewogICAgICAgIHVybCA9IHJlc3VsdC51cmw7CiAgICB9IGVsc2UgaWYgKHJlc3VsdC5leGlzdGluZ0ZpbGVVcmwpIHsKICAgICAgICB1cmwgPSByZXN1bHQuZXhpc3RpbmdGaWxlVXJsOwogICAgfQoKICAgIHJldHVybiB7IHVybCB9Owp9Cgpjb25zdCByZWNvcmRLZXkgPSBBQkNvbW1hbmRzTWFuYWdlci5wYXJzZUFyZ1ZhbHVlKGFyZ3MsICctcmVjb3JkJyk7CmNvbnN0IHNlbGVjdGVkRmlsZXMgPSBhd2FpdCBvcy5zaG93VXBsb2FkRmlsZXMoKTsKY29uc3QgcHVibGlzaFJlY29yZCA9IGdldEJvdCgnc3lzdGVtJywgJ3JjLXBhY2thZ2UtZGV2LnB1Ymxpc2hSZWNvcmQnKTsKCmlmIChzZWxlY3RlZEZpbGVzICYmIHNlbGVjdGVkRmlsZXMubGVuZ3RoKSB7CiAgICBpZiAodGFncy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbJHt0YWdzLnN5c3RlbX0uJHt0YWdOYW1lfV0gVXBsb2FkICR7c2VsZWN0ZWRGaWxlcy5sZW5ndGh9IGZpbGVzLi4uYCk7CiAgICB9CgogICAgbGV0IGRvbmVIdG1sID0gJyc7CgogICAgaWYgKHJlY29yZEtleSkgewogICAgICAgIGRvbmVIdG1sICs9IGA8aDI+UmVjb3JkIElkPC9oMj5gOwogICAgICAgIGRvbmVIdG1sICs9IGA8cD4ke3JlY29yZEtleX08L3A+YDsKICAgIH0KCiAgICBkb25lSHRtbCArPSAnPGgyPlVwbG9hZGVkIEZpbGVzPC9oMj4nOwogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlbGVjdGVkRmlsZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBvcy5zaG93SHRtbChgVXBsb2FkaW5nICR7c2VsZWN0ZWRGaWxlc1tpXS5uYW1lfS4uLmApOwogICAgICAgIAogICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVwbG9hZEZpbGUoewogICAgICAgICAgICBmaWxlOiBzZWxlY3RlZEZpbGVzW2ldLAogICAgICAgICAgICByZWNvcmRLZXksCiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IChmaWxlUHJvZ3Jlc3MpID0+IHsKICAgICAgICAgICAgICAgIG9zLnNob3dIdG1sKGBVcGxvYWRpbmcgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9ICR7TWF0aC5jZWlsKGZpbGVQcm9ncmVzcyAqIDEwMCl9JWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgCiAgICAgICAgaWYgKHJlc3VsdC51cmwpIHsKICAgICAgICAgICAgZG9uZUh0bWwgKz0gYDxhIGhyZWY9IiR7cmVzdWx0LnVybH0iIHRhcmdldD0iX2JsYW5rIj4ke3NlbGVjdGVkRmlsZXNbaV0ubmFtZX08L2E+PC9icj5gOwogICAgICAgIH0KCiAgICAgICAgY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBVcGxvYWQgJHtzZWxlY3RlZEZpbGVzW2ldLm5hbWV9IHJlc3VsdDpgLCByZXN1bHQpOwogICAgfQoKICAgIG9zLnNob3dIdG1sKGRvbmVIdG1sKTsKfScAgdTs8g+m/AUOY21kRG93bmxvYWRFZ2cCBACB1OzyD9bYB/kLQGNvbnN0IHJlY29yZEtleSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dSZWNvcmRLZXksIHsKICAgIHRpdGxlOiAncmVjb3JkIHRvIGxvb2t1cCBlZ2cgaW4nLAogICAgdHlwZTogJ3RleHQnLAp9KQpjb25zb2xlLmxvZyhgWyR7dGFncy5zeXN0ZW19LiR7dGFnTmFtZX1dIHJlY29yZEtleTpgLCByZWNvcmRLZXkpOwoKaWYgKCFyZWNvcmRLZXkpIHsKICAgIHJldHVybjsKfQoKbWFza3MucHJldkRvd25sb2FkRWdnUmVjb3JkS2V5ID0gcmVjb3JkS2V5OwoKY29uc3QgZWdnTmFtZSA9IGF3YWl0IG9zLnNob3dJbnB1dChtYXNrcy5wcmV2RG93bmxvYWRFZ2dOYW1lLCB7CiAgICB0aXRsZTogJ25hbWUgb2YgZWdnJywKICAgIHR5cGU6ICd0ZXh0JywKfSkKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2dOYW1lOmAsIGVnZ05hbWUpOwoKaWYgKCFlZ2dOYW1lKSB7CiAgICByZXR1cm47Cn0KCm1hc2tzLnByZXZEb3dubG9hZEVnZ05hbWUgPSBlZ2dOYW1lOwoKY29uc3QgZWdnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHsKICAgIGFiSUQ6IGVnZ05hbWUsCiAgICByZWNvcmRLZXksCiAgICByZXR1cm5UeXBlOiAnZWdnJwp9KQoKY29uc29sZS5sb2coYFske3RhZ3Muc3lzdGVtfS4ke3RhZ05hbWV9XSBlZ2c6YCwgZWdnKTsKCmlmICghQXJyYXkuaXNBcnJheShlZ2cuZWdnVmVyc2lvbkhpc3RvcnkpIHx8IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggPT09IDApIHsKICAgIGxpbmtzLnV0aWxzLmFiTG9nQW5kVG9hc3QoYERhdGEgZm91bmQgYXQgYWRkcmVzcyAnJHtlZ2dOYW1lfScgaW4gcmVjb3JkICcke3JlY29yZEtleX0nIGRvZXMgbm90IGFwcGVhciB0byBiZSBhbiBlZ2cuYCkKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBlZ2dWZXJzaW9uT3B0aW9ucyA9IGVnZy5lZ2dWZXJzaW9uSGlzdG9yeS5tYXAoKGl0ZW0sIGluZGV4KSA9PiB7CiAgICByZXR1cm4geyBsYWJlbDogYHZlcnNpb24gJHtpbmRleCArIDF9YCwgdmFsdWU6IGluZGV4IH0KfSkKCmNvbnN0IHNlbGVjdGVkVmVyc2lvbk9wdGlvbiA9IGF3YWl0IG9zLnNob3dJbnB1dChlZ2dWZXJzaW9uT3B0aW9ucy5sZW5ndGggLSAxLCB7CiAgICB0aXRsZTogJ2Rvd25sb2FkIGVnZyB2ZXJzaW9uJywKICAgIHR5cGU6ICdsaXN0JywKICAgIHN1YnR5cGU6ICdzZWxlY3QnLAogICAgaXRlbXM6IGVnZ1ZlcnNpb25PcHRpb25zLAp9KQoKaWYgKCFzZWxlY3RlZFZlcnNpb25PcHRpb24pIHsKICAgIHJldHVybiBudWxsOwp9Cgpjb25zdCBhdXhEYXRhVXJsID0gZWdnLmVnZ1ZlcnNpb25IaXN0b3J5W3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZV07CmNvbnN0IGF1eERhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGF1eERhdGFVcmwpOwpjb25zdCBhdXhGaWxlbmFtZSA9IGAke2VnZ05hbWV9X3Yke3NlbGVjdGVkVmVyc2lvbk9wdGlvbi52YWx1ZSArIDF9LmF1eGA7Cgpvcy5kb3dubG9hZChhdXhEYXRhLCBhdXhGaWxlbmFtZSwgJ2FwcGxpY2F0aW9uL2pzb24nKTsnAIHU7PIPpvwFD2NtZERvd25sb2FkSW5zdAIEAIHU7PIP0OQHb0Bjb25zdCBhcmdzID0gdGhhdDsKCm9zLmRvd25sb2FkQm90cyhnZXRCb3RzKGJ5TW9kKHsgc3BhY2U6ICJzaGFyZWQiLCBhYklnbm9yZTogbnVsbCB9KSksIG9zLmdldEN1cnJlbnRJbnN0KCkpOycAgdTs8g+m/AUGc2VhcmNoAgQAgdTs8g/A5Qco8J+Ul2Q4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNScAgdTs8g+m/AUFdXRpbHMCBACB1OzyD+flByjwn5SXOTNkOTY1ZTAtZDIwZS00YjQ1LThjYTAtNjQ5MjczYjcxMzhjJwCB1OzyD6b8BQljbWRTeXN0ZW0CBACB1OzyD47mB5EHQGNvbnN0IGFyZ3MgPSB0aGF0OwoKY29uc3Qgc2FtZVdpbmRvdyA9IEFCQ29tbWFuZHNNYW5hZ2VyLnBhcnNlQXJnRmxhZyhhcmdzLCAnLXcnKTsKCmxldCBzeXN0ZW1UYWdOYW1lID0gbnVsbDsKCmlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID4gMCkgewogICAgc3lzdGVtVGFnTmFtZSA9IGFyZ3Muam9pbignICcpOwp9CgppZiAoc2FtZVdpbmRvdykgewogICAgLy8gT3BlbiBzeXN0ZW0gcG9ydGFsIGluIHRoZSBjdXJyZW50IHdpbmRvdy4KICAgIGNvbmZpZ0JvdC50YWdzLnN5c3RlbVBvcnRhbCA9IHRydWU7CiAgICBjb25maWdCb3QudGFncy5zeXN0ZW1UYWdOYW1lID0gc3lzdGVtVGFnTmFtZTsKfSBlbHNlIHsKICAgIC8vIE9wZW4gc3lzdGVtIHBvcnRhbCBpbiBhIG5ldyB0YWIuCiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCk7CgogICAgLy8gUmVtb3ZlIGFueSBwb3J0YWxzIHRoYXQgYXJlIHNldCBpbiB0aGUgVVJMLgogICAgbGV0IHBhcmFtcyA9IHVybC5zZWFyY2hQYXJhbXMua2V5cygpOwogICAgZm9yIChsZXQgcGFyYW0gb2YgcGFyYW1zKSB7CiAgICAgICAgaWYgKHBhcmFtLmVuZHNXaXRoKCdQb3J0YWwnKSkgewogICAgICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLmRlbGV0ZShwYXJhbSk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIFR1cm4gb24gdGhlIHN5c3RlbSBwb3J0YWwuCiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtUG9ydGFsJywgJ3RydWUnKTsKICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCdzeXN0ZW1UYWdOYW1lJyk7CgogICAgaWYgKHN5c3RlbVRhZ05hbWUpIHsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnc3lzdGVtVGFnTmFtZScsIHN5c3RlbVRhZ05hbWUpOwogICAgfQoKICAgIG9zLm9wZW5VUkwodXJsLmhyZWYpOwp9CicAgdTs8g+m/AUNYWJDaGF0QmFyT3BlbgIEAIHU7PIPoO0HmwJAY29uc3QgewogICAgcHJlZmlsbCwKfSA9IHRoYXQgPz8ge30KCm1hc2tzLmNoYXRPcGVuID0gdHJ1ZTsKCm9zLnNob3dDaGF0KHsKICAgIHBsYWNlaG9sZGVyOiAnPiAuaGVscCB0byBzZWUgYXZhaWxhYmxlIGNvbW1hbmRzJywKICAgIGJhY2tncm91bmRDb2xvcjogJyMyZjJmMmYnLAogICAgZm9yZWdyb3VuZENvbG9yOiBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwbGFjZWhvbGRlckNvbG9yOiBhYlBlcnNvbmFsaXR5LnRhZ3MuYWJCYXNlQ29sb3IsCiAgICBwcmVmaWxsCn0pJwCB1OzyD6b8BQ5hYkNoYXRCYXJDbG9zZQIEAIHU7PIPvO8HdkBtYXNrcy5jaGF0T3BlbiA9IGZhbHNlOwpvcy5oaWRlQ2hhdCgpOwoKLy8gR2l2ZSBDYXN1YWxPUyBhIGNoYW5nZSB0byBhY3R1YWxseSByZW1vdmUgdGhlIGNoYXQgYmFyLgphd2FpdCBvcy5zbGVlcCgwKTsA"}]}