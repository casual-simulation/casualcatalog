{"version":1,"state":{"e8e1d07a-9133-4198-a1be-53f47c71cda4":{"id":"e8e1d07a-9133-4198-a1be-53f47c71cda4","space":"shared","tags":{"creator":"34c3c210-5bf1-49cf-b151-ee2d07f0e673","system":"abArtifactWizard.wizard","label":"artifact wizard","cursor":"pointer","formOpacity":"0.33","strokeColor":"#c0b3fc","labelPosition":"floatingBillboard","onClick":"@thisBot.abArtifactWizardMenuOpen({ wizardBot: thisBot, wizardDimension: that.dimension });\n\n// const { dimension } = that;\n\n// if (!links.artifact) {\n//     await links.learn.abAdapt('abShell');\n// }\n\n// // Find all the unique abArtifactNames in the inst.\n// let abArtifactNames = new Set();\n\n// getBots((b) => {\n//     if (b.tags.abArtifactName && !b.tags.abArtifact) { \n//         abArtifactNames.add(b.tags.abArtifactName);\n//     }\n// })\n\n// if (abArtifactNames.size > 0) {\n//     // Let the user choose which artifact they would like to generate.\n//     abArtifactNames = Array.from(abArtifactNames);\n//     abArtifactNames.sort(); // Sort artifact names alphabetically.\n\n//     // Convert artifact names into input options.\n//     let artifactOptions = abArtifactNames.map((name, index) => {\n//         return {\n//             label: name,\n//             value: name\n//         }\n//     })\n\n//     // Find (if any) the indexes of previously selected artifacts.\n//     let prevSelectedIndex;\n//     if (configBot.tags.abArtifactWizardPrevSelectedItem) {\n//         const index = artifactOptions.findIndex(o => o.value === configBot.tags.abArtifactWizardPrevSelectedItem.value);\n//         if (index >= 0) {\n//             prevSelectedIndex = index;\n//         }\n//     }\n\n//     const selectedItem = await os.showInput(prevSelectedIndex, {\n//         title: 'Choose artifact to make',\n//         type: 'list',\n//         subtype: 'radio',\n//         items: artifactOptions,\n//     });\n\n//     configBot.tags.abArtifactWizardPrevSelectedItem = selectedItem;\n\n//     if (selectedItem) {\n//         const abArtifactName = selectedItem.value;\n//         const abArtifactBot = await links.artifact.abCreateArtifactBot({\n//             abArtifactName,\n//             dimension,\n//             position: getBotPosition(thisBot, dimension),\n//         });\n\n//         if (abArtifactBot) {\n//             if (tags.destroyAfterUse && configBot.tags.gridPortal !== 'abArtifactWizard') {\n//                 destroy(thisBot);\n//             }\n\n//             links.artifact.abArtifactBotMenuOpen({ abArtifactBot });\n//         }\n//     }\n// } else {\n//     os.toast(`No artifacts defined in the inst.`)\n// }\n","abVersion":"10.5","onEggHatch":"@if (that.eggParameters) {\n    const dimension = that.eggParameters.gridInformation?.dimension ?? 'home';\n    const dimensionX = that.eggParameters.gridInformation?.position?.x ?? 0;\n    const dimensionY = that.eggParameters.gridInformation?.position?.y ?? 0;\n\n    tags[dimension] = true;\n    tags[dimension + 'X'] = dimensionX;\n    tags[dimension + 'Y'] = dimensionY;\n\n    thisBot.abArtifactWizardMenuOpen({ wizardDimension: dimension });\n}\n","destroyAfterUse":"true","abIgnore":"true","labelWordWrapMode":"breakWords","abArtifactWizard":true,"color":"#AEA1FF","labelFloatingBackgroundColor":"#AEA1FF","labelColor":"#1e1b2d","remember":"ðŸ”—e5380a6b-8b4d-4a8b-8b04-58e1eb03e5e7","artifact":"ðŸ”—78e41503-c933-4f8a-817a-ba97bf8d5d27","learn":"ðŸ”—6657b865-e983-4401-9fc9-f5418d18a7f7","abArtifactWizardMenuOpen":"@const {\n    wizardDimension = ab.tags.abInst,\n} = that ?? {};\n\nshout('abArtifactWizardMenuReset');\n\nconfigBot.masks.menuPortal = 'abArtifactWizardMainMenu';\n\nconst menuBots = [];\n\nconst abArtifactNames = Array.from(links.artifact.abGetArtifactNamesInInst()).sort();\n\nif (!abArtifactNames || abArtifactNames.length === 0) {\n    links.utils.abLogAndToast({ message: `No artifacts found in the inst.` })\n    return;\n}\n\nconst abArtifactBaseColor = links.remember.tags.abArtifactBaseColor ?? links.artifact.tags.abArtifactBaseColorDefault;\nconst abArtifactLabelColor = links.remember.tags.abArtifactLabelColor ?? links.artifact.tags.abArtifactLabelColorDefault;\n\n/**\n * Menu portal: abArtifactWizardMainMenu\n */\n\nconst createButton = links.menu.abCreateMenuButton({\n    abArtifactWizardMainMenu: true,\n    formAddress: 'add_box',\n    label: `artifact bot`,\n    color: abArtifactBaseColor,\n    labelColor: abArtifactLabelColor,\n    wizardBot: getLink(thisBot),\n    wizardDimension,\n    onArtifactWizardSelection: `@\n        const { abArtifactName } = that;\n\n        console.log('create selection', that);\n\n        const position = getBotPosition(links.wizardBot, tags.wizardDimension);\n\n        const abArtifactBot = await links.wizardBot.links.artifact.abCreateArtifactBot({\n            abArtifactName,\n            dimension: tags.wizardDimension,\n            position,\n        });\n\n        if (abArtifactBot) {\n            if (links.wizardBot && links.wizardBot.tags.destroyAfterUse && configBot.tags.gridPortal !== 'abArtifactWizard') {\n                destroy(links.wizardBot);\n            }\n\n            links.wizardBot.links.artifact.abArtifactBotMenuOpen({ abArtifactBot });\n        }\n        \n        shout(\"abArtifactWizardMenuReset\");\n    `,\n    onClick: `@\n        configBot.tags.abArtifactWizardSelectionMenuTarget = getLink(thisBot);\n        configBot.masks.menuPortal = 'abArtifactWizardSelectionMenu';\n    `,\n})\nmenuBots.push(createButton);\n\nconst publishButton = links.menu.abCreateMenuButton({\n    abArtifactWizardMainMenu: true,\n    formAddress: 'ios_share',\n    label: `publish artifact shards`,\n    color: abArtifactBaseColor,\n    labelColor: abArtifactLabelColor,\n    onArtifactWizardSelection: `@\n        const { abArtifactName } = that;\n\n        configBot.tags.abArtifactWizardSelectedArtifactName = abArtifactName;\n        configBot.masks.menuPortal = 'abArtifactWizardPublishMenu';\n    `,\n    onClick: `@\n        configBot.tags.abArtifactWizardSelectionMenuTarget = getLink(thisBot);\n        configBot.masks.menuPortal = 'abArtifactWizardSelectionMenu';\n    `,\n})\nmenuBots.push(publishButton);\n\n\n/**\n * Menu portal: abArtifactWizardSelectionMenu\n */\n\nfor (const abArtifactName of abArtifactNames) {\n    const artifactNameButton = links.menu.abCreateMenuButton({\n        abArtifactWizardSelectionMenu: true,\n        label: abArtifactName,\n        color: abArtifactBaseColor,\n        labelColor: abArtifactLabelColor,\n        onPortalChanged: `@\n            if (that.portal !== 'menuPortal' && that.dimension !== 'abArtifactWizardSelectionMenu') {\n                return;\n            }\n\n            if (configBot.tags.abArtifactWizardSelectedArtifactName === tags.label) {\n                tags.formAddress = 'radio_button_checked';\n            } else {\n                tags.formAddress = 'radio_button_unchecked';\n            }\n        `,\n        onClick: `@\n            whisper(configBot.links.abArtifactWizardSelectionMenuTarget, 'onArtifactWizardSelection', { abArtifactName: tags.label });\n        `,\n    })\n    menuBots.push(artifactNameButton);\n}\n\n/**\n * Menu portal: abArtifactWizardPublishMenu\n */\n\nconst nameButton = links.menu.abCreateMenuButton({\n    abArtifactWizardPublishMenu: true,\n    formAddress: 'radio_button_checked',\n    publishButton: getLink(publishButton),\n    color: abArtifactBaseColor,\n    labelColor: abArtifactLabelColor,\n    onPortalChanged: `@\n        if (that.portal !== 'menuPortal' && that.dimension !== 'abArtifactWizardPublishMenu') {\n            return;\n        }\n        \n        if (configBot.tags.abArtifactWizardSelectedArtifactName) {\n            tags.label = configBot.tags.abArtifactWizardSelectedArtifactName;\n        } else {\n            tags.label = 'Select an artifact';\n        }\n    `,\n    onClick: `@\n        configBot.tags.abArtifactWizardSelectionMenuTarget = getLink(links.publishButton);\n        configBot.masks.menuPortal = 'abArtifactWizardSelectionMenu';\n    `,\n})\nmenuBots.push(nameButton);\n\nconst studioButton = links.menu.abCreateMenuButton({\n    abArtifactWizardPublishMenu: true,\n    formAddress: 'inventory_2',\n    color: abArtifactBaseColor,\n    labelColor: abArtifactLabelColor,\n    nameButton: getLink(nameButton),\n    wizardBot: getLink(thisBot),\n    onPortalChanged: `@\n        if (that.portal !== 'menuPortal' && that.dimension !== 'abArtifactWizardPublishMenu') {\n            return;\n        }\n\n        let foundRecordKey;\n\n        if (configBot.tags.abArtifactWizardSelectedArtifactName) {\n            const artifactBundles = links.wizardBot.links.artifact.abFindArtifactBundles({ abArtifactName: configBot.tags.abArtifactWizardSelectedArtifactName });\n\n            for (let key in artifactBundles) {\n                const artifactBundle = artifactBundles[key];\n\n                if (artifactBundle.dependencies && artifactBundle.dependencies.length > 0) {\n                    const matchingDep = artifactBundle.dependencies.find(d => d.abID === configBot.tags.abArtifactWizardSelectedArtifactName);\n\n                    if (matchingDep) {\n                        foundRecordKey = matchingDep.recordKey;\n                        break;\n                    }\n                }\n            }\n        }\n\n        if (foundRecordKey) {\n            tags.recordKey = foundRecordKey;\n        } else {\n            tags.recordKey = authBot.id;\n        }\n    `,\n    onClick: `@\n        const input = await os.showInput(tags.recordKey, { autoSelect: true, title: 'studio record key' });\n\n        if (input) {\n            tags.recordKey = input;\n        } else {\n            tags.recordKey = authBot.id;\n        }\n    `,\n    onBotChanged: `@\n        const changedTags = that.tags;\n\n        if (changedTags.includes('recordKey')) {\n            tags.label = 'studio=' + tags.recordKey;\n        }\n    `,\n})\nmenuBots.push(studioButton);\n\nconst submitButton = links.menu.abCreateMenuButton({\n    abArtifactWizardPublishMenu: true,\n    formAddress: 'publish',\n    color: abArtifactBaseColor,\n    labelColor: abArtifactLabelColor,\n    nameButton: getLink(nameButton),\n    studioButton: getLink(studioButton),\n    wizardBot: getLink(thisBot),\n    onPortalChanged: `@\n        if (that.portal !== 'menuPortal' && that.dimension !== 'abArtifactWizardPublishMenu') {\n            return;\n        }\n\n        await os.sleep(0);\n\n        const name = links.nameButton.tags.label;\n        const recordKey = links.studioButton.tags.recordKey;\n\n        const shardBots = getBots(b => b.tags.abArtifactName === name && b.space === 'shared' && !b.tags.abIgnore);\n        thisBot.vars.shardBots = shardBots;\n\n        if (shardBots.length > 1) {\n            tags.label = 'Publish (' + shardBots.length + ' bots)';\n        } else if (shardBots.length === 1) {\n            tags.label = 'Publish (1 bot)';\n        } else {\n            tags.label = 'No bots to publish';\n        }\n    `,\n    onClick: `@\n        const name = links.nameButton.tags.label;\n        const recordKey = links.studioButton.tags.recordKey;\n        const shardBots = thisBot.vars.shardBots;\n\n        console.log(name);\n        console.log(recordKey);\n        console.log(shardBots);\n\n        try { \n            const result = await links.wizardBot.links.artifact.abPublishShards({ abArtifactName: name, studio: recordKey, shardBots })\n\n            if (result.success) {\n                if (links.wizardBot && links.wizardBot.tags.destroyAfterUse && configBot.tags.gridPortal !== 'abArtifactWizard') {\n                    destroy(links.wizardBot);\n                }\n            }\n        } catch (e) {\n            links.wizardBot.links.utils.abLogAndToast({ message: e.message, logType: 'error' });\n        }\n\n    `\n})\nmenuBots.push(submitButton);\n\nmasks.menuBots = getLink(menuBots);","abArtifactWizardMenuReset":"@if (links.menuBots) {\n    destroy(links.menuBots);\n    links.menuBots = null;\n}\n\nconfigBot.masks.menuPortal = null;\nconfigBot.tags.abArtifactWizardSelectionMenuTarget = null;\nconfigBot.tags.abArtifactWizardSelectedArtifactName = null;","onAnyBotsRemoved":"@const { botIDs } = that;\n\nif (botIDs.includes(thisBot.id)) {\n    thisBot.abArtifactBotMenuReset();\n}","onGridClick":"@thisBot.abArtifactWizardMenuReset();","menu":"ðŸ”—b30c6c5d-a4f7-4266-ba38-393dc95e1ecb","utils":"ðŸ”—93d965e0-d20e-4b45-8ca0-649273b7138c","home":null,"homeX":null,"homeY":null,"onCreate":null}}}}