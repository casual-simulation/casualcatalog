{"version":1,"state":{"2b865259-4291-4e78-a985-8a795990f30f":{"id":"2b865259-4291-4e78-a985-8a795990f30f","space":"shared","tags":{"system":"arWebSlinger.menu3dPortalBot","onPortalChanged":"@if (!masks.initialized) {\n    return;\n}\n\nconst { portal, dimension } = that;\n\nif (portal === 'menuPortal') {\n    thisBot.refreshPortal();\n}","home":null,"form":"portal","formAddress":"arWebSlinger_menu3d","onAnyBotsAdded":"@if (!masks.initialized) {\n    return;\n}\n\nconst menuPortal = configBot.tags.menuPortal;\n\n// Add bots that are in the current menu portal to the web slinger's 3d menu.\nlet needRefreshPortal = false;\n\nfor (let i = 0; i < that.bots.length; i++) {\n    const bot = that.bots[i];\n\n    if (bot) {\n        if (bot.tags[menuPortal] == true) {\n            needRefreshPortal = true;\n        }\n    }\n}\n\nif (needRefreshPortal) {\n    thisBot.refreshPortal();\n}","manager":"ðŸ”—5d2d6742-c881-4663-9958-488243d8f941","abArtifactName":"arWebSlinger","onABInitialized":"@thisBot.initialize();","debug":"false","addMenu3dBot":null,"refreshPortal":"@if (!masks.initialized) {\n    return;\n}\n\nif (tags.debug) {\n    console.log(`[${tags.system}.${tagName}] invoke`);\n}\n\nconst runId = uuid();\nthisBot.vars.currentRunId = runId;\n\nawait os.sleep(0);\n\nif (runId !== thisBot.vars.currentRunId) {\n    if (tags.debug) {\n        console.log(`[${tags.system}.${tagName}] ignore call because a newer one has occured.`);\n    }\n\n    return;\n}\n\n// [SLOP] This is bad and we should optimize this, we dont need to always destroy everything if its still needed.\nconst existingMenu3dBots = getBots(b => b.tags.isMenu3dBot);\ndestroy(existingMenu3dBots);\n\nconst menuPortal = configBot.tags.menuPortal;\n\nif (menuPortal) {\n    const menuBots = getBots((b) => {\n        return b.tags[menuPortal] === true\n    })\n\n    if (tags.debug) {\n        const menuBotCreateTimes = menuBots.map((b) => {\n            return { label: b.tags.label, abCreateTime: b.tags.abCreateTime }\n        })\n\n        console.log(`[${tags.system}.${tagName}] menuBotCreateTimes:`, menuBotCreateTimes);\n    }\n\n    // Sort bots to be in the same order that they appear in the menu portal.\n    menuBots.sort((a, b) => {\n        const aSortOrder = a.tags[menuPortal + 'SortOrder'] ?? 0;\n        const bSortOrder = b.tags[menuPortal + 'SortOrder'] ?? 0;\n\n        if (aSortOrder == bSortOrder) {\n            const aCreateTime = a.tags.abCreateTime ?? 0;\n            const bCreateTime = b.tags.abCreateTime ?? 0;\n\n            // If a and b have the same sort order, then sort by creation time.\n            return aCreateTime - bCreateTime;\n        } else {\n            return aSortOrder - bSortOrder;\n        }\n    });\n\n    if (tags.debug) {\n        console.log(`[${tags.system}.${tagName}] ${menuBots.length} bots found in menu portal '${menuPortal}':`, menuBots);\n    }\n\n    if (menuBots.length > 0) {\n        menuBots.reverse();\n\n        for (let i = 0; i < menuBots.length; i++) {\n            const menuBot = menuBots[i];\n            const menu3dBot = thisBot.createMenu3dBot({ menuBot });\n            \n            const menu3dDimension = tags.formAddress;\n            menu3dBot.tags[menu3dDimension + 'Y'] = i * (tags.menu3dBot_height + tags.menu3d_botSpacing)\n\n        }\n    }\n} else {\n    if (tags.debug) {\n        console.log(`[${tags.system}.${tagName}] No menu portal is open.`);\n    }\n}","createMenu3dBot":"@const {\n    menuBot,\n} = that;\n\nif (!menuBot) {\n    return null;\n}\n\nconst menu3dBot = create({\n    space: 'tempLocal',\n    form: 'cube',\n    isMenu3dBot: true,\n    menuBot: getLink(menuBot),\n    menu3dPortalBot: getLink(thisBot),\n    dimension: tags.formAddress,\n    [tags.formAddress]: true,\n    [tags.formAddress + 'X']: 0,\n    [tags.formAddress + 'Y']: 0,\n    scaleX: tags.menu3dBot_width,\n    scaleY: tags.menu3dBot_height,\n    scaleZ: tags.menu3dBot_depth,\n    cursor: 'pointer',\n    onCreate: ListenerString(async () => {\n        if (links.menu3dPortalBot.tags.debug) {\n            console.log(`[menu3dBot.${tagName}] invoke`);\n        }\n        \n        thisBot.vars.onMenuBotChanged = (listenerThat) => {\n            if (links.menu3dPortalBot.tags.debug) {\n                console.log(`[menu3dBot.onMenuBotChanged] changed tags:`, listenerThat.tags);\n            }\n\n            if (masks.initialized) {\n                thisBot.resyncMenuBot();\n            }\n        }\n\n        thisBot.vars.onMenuBotDestroyed = () => {\n            if (links.menu3dPortalBot.tags.debug) {\n                console.log(`[${tags.system}.onMenuBotDestroyed] destroy`);\n            }\n\n            destroy(thisBot);\n        }\n\n        os.addBotListener(links.menuBot, 'onBotChanged', thisBot.vars.onMenuBotChanged);\n        os.addBotListener(links.menuBot, 'onDestroy', thisBot.vars.onMenuBotDestroyed);\n\n        thisBot.resyncMenuBot();\n    }),\n    onClick: ListenerString(() => {\n        whisper(links.menuBot, 'onClick', that);\n    }),\n    resyncMenuBot: ListenerString(() => {\n        const menuBot = links.menuBot;\n\n        if (!menuBot) {\n            if (links.menu3dPortalBot.tags.debug) {\n                console.log(`[menu3dBot.${tagName}] destroy`);\n            }\n\n            destroy(thisBot);\n            return;\n        }\n        \n        if (links.menu3dPortalBot.tags.debug) {\n            console.log(`[menu3dBot.onMenuBotChanged] resync menu bot.`);\n        }\n\n        if (tags.label !== menuBot.tags.label) {\n            tags.label = menuBot.tags.label;\n        }\n\n        if (tags.color !== menuBot.tags.color) {\n            tags.color = menuBot.tags.color;\n        }\n\n    }),\n    onDestroy: ListenerString(() => {\n        if (links.menuBot) {\n            os.removeBotListener(links.menuBot, 'onBotChanged', thisBot.vars.onMenuBotChanged);\n            os.removeBotListener(links.menuBot, 'onDestroy', thisBot.vars.onMenuBotDestroyed);\n        }\n    })  \n})\n\nreturn menu3dBot;","menu3dBot_width":"3","menu3dBot_height":"1","menu3dBot_depth":"0.3","menu3d_botSpacing":"0.2","onABArtifactReconstitute":"@thisBot.initialize();","initialize":"@if (masks.initialized) {\n    return;\n}\n\nif (tags.debug) {\n    console.log(`[${tags.system}.${tagName}] invoke`);\n}\n\nmasks.initialized = true;\nthisBot.refreshPortal();","onEggHatch":"@thisBot.initialize();"}},"5d2d6742-c881-4663-9958-488243d8f941":{"id":"5d2d6742-c881-4663-9958-488243d8f941","space":"shared","tags":{"form":"sphere","formOpacity":"0.5","listening":true,"onClick":"@thisBot.arWebSlingerMenuOpen();","onExitClick":"@if (configBot.tags.arEnabled) {\n    os.disableAR();\n} else if (configBot.tags.vrEnabled) {\n    os.disableVR();\n}","scale":"1.5","system":"arWebSlinger.manager","abVersion":"10.6","abArtifactName":"arWebSlinger","onABArtifactCollectShards":"@const shard: ABArtifactShard = {\n    data: {\n        managerDimension: tags.dimension,\n        managerDimensionX: tags[tags.dimension + 'X'],\n        managerDimensionY: tags[tags.dimension + 'Y'],\n        managerDimensionZ: tags[tags.dimension + 'Z'],\n    },\n    dependencies: [\n        { askID: 'arWebSlinger' }\n    ]\n}\n\nreturn shard;","onABArtifactReconstitute":"@const data = that.data;\n\nif (data.eggParameters) {\n    if (data.eggParameters.gridInformation) {\n        const dimension = data.eggParameters.gridInformation.dimension ?? 'home';\n        const dimensionX = data.eggParameters.gridInformation.position?.x ?? 0;\n        const dimensionY = data.eggParameters.gridInformation.position?.y ?? 0;\n\n        tags.dimension = dimension;\n        tags[dimension] = true;\n        tags[dimension + 'X'] = dimensionX;\n        tags[dimension + 'Y'] = dimensionY;\n    }\n}\n\nif (data.managerDimension) {\n    tags.dimension = data.managerDimension;\n    tags[data.managerDimension] = true;\n    tags[data.managerDimension + 'X'] = data.managerDimensionX;\n    tags[data.managerDimension + 'Y'] = data.managerDimensionY;\n    tags[data.managerDimension + 'Z'] = data.managerDimensionZ;\n}\n\nthisBot.refreshHex();","onABStripArtifactInstanceDataFromBotData":"@console.log(`[${tags.system}.${tagName}]`, JSON.parse(JSON.stringify(that)));\n\nconst { data } = that;\n\nconst dimension = data.tags.dimension;\n\ndelete data.tags.dimension;\ndelete data.tags[dimension];\ndelete data.tags[dimension + 'X'];\ndelete data.tags[dimension + 'Y'];\ndelete data.tags[dimension + 'Z'];","refreshHex":"@if (!links.hex) {\n    const hex = create({\n        space: 'tempLocal',\n        form: 'hex',\n        color: '#00D9CD',\n        manager: getLink(thisBot),\n        scale: 0.5,\n        scaleZ: 0.2,\n        transformer: thisBot.id,\n        pointable: false,\n        onCreate: `@\n            os.addBotListener(links.manager, 'onBotChanged', (listenerThat) => {\n                const changedTags = listenerThat.tags;\n\n                if (changedTags.includes('dimension')) {\n                    links.manager.refreshHex();\n                }\n            })\n        `\n    })\n\n    masks.hex = getLink(hex);\n}\n\nif (links.hex.tags.dimension) {\n    // Remove hex from its previous dimension.\n    const prevDim = links.hex.tags.dimension;\n    \n    console.log(`[${tags.system}.${tagName}] removing from prevDim:`, prevDim);\n\n    links.hex.tags.dimension = null;\n    links.hex.tags[prevDim] = null;\n    links.hex.tags[prevDim + 'X'] = null;\n    links.hex.tags[prevDim + 'Y'] = null;\n    links.hex.tags[prevDim + 'Z'] = null;\n    links.hex.tags[prevDim + 'RotationX'] = null;\n    links.hex.tags[prevDim + 'RotationY'] = null;\n    links.hex.tags[prevDim + 'RotationZ'] = null;\n}\n\nif (tags.dimension) {\n    // Put hex in the current dimension.\n    const curDim = tags.dimension;\n\n    console.log(`[${tags.system}.${tagName}] adding to curDim:`, curDim);\n\n    links.hex.tags.dimension = curDim;\n    links.hex.tags[curDim] = true;\n    links.hex.tags[curDim + 'X'] = 0;\n    links.hex.tags[curDim + 'Y'] = 0;\n    links.hex.tags[curDim + 'Z'] = -0.5;\n    links.hex.tags[curDim + 'RotationX'] = 0.785398;\n    links.hex.tags[curDim + 'RotationY'] = 0;\n    links.hex.tags[curDim + 'RotationZ'] = 0;\n}","debug":"false","onEnterAR":"@configBot.tags.arEnabled = true;\nthisBot.xrSetup();","onExitAR":"@configBot.tags.arEnabled = false;\nthisBot.xrTeardown();","onGridClick":"@// shout('arWebSlingerMenuReset');\nthisBot.arWebSlingerMenuReset();","arWebSlinger":"","arWebSlingerX":"-3","arWebSlingerY":"3","arWebSlingerMenuOpen":"@shout('arWebSlingerMenuReset');\n\nconfigBot.masks.menuPortal = 'arWebSlingerMenu';\n\nconst device = os.device();\n\nif (device.supportsAR || device.supportsVR) {\n    if (device.supportsAR) {\n        const arButton = ab.links.menu.abCreateMenuButton({\n            arWebSlingerMenu: true,\n            label: 'enter ar',\n            arWebSlingerMenuReset: `@destroy(thisBot)`,\n            onClick: `@\n                os.enableAR();\n            `\n        })\n    }\n\n    if (device.supportsVR) {\n        const vrButton = ab.links.menu.abCreateMenuButton({\n            arWebSlingerMenu: true,\n            label: 'enter vr',\n            arWebSlingerMenuReset: `@destroy(thisBot)`,\n            onClick: `@\n                os.enableVR();\n            `\n        })\n    }\n} else {\n    // Device does not support WebXR.\n    ab.links.utils.abLogAndToast({ message: 'WebXR is not available on this device.'});\n    masks.color = 'red';\n}\n","devEnableDesktopTesting":null,"arWebSlingerMenuReset":"@configBot.masks.menuPortal = null;","cursor":"pointer","onEnterVR":"@configBot.tags.vrEnabled = true;\nthisBot.xrSetup();","onExitVR":"@configBot.tags.vrEnabled = false;\nthisBot.xrTeardown();","xrSetup":"@configBot.masks.leftWristPortal = \"arWebSlinger_leftWrist\";\n\n// Put the menu3d portal bot in the left wrist portal.\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal] = true;\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal + 'X'] = 0;\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal + 'Y'] = 0;\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal + 'Z'] = 0;\n\n// Need to move out of the mapPortal if we are in it.\nmasks.mapPortalBeforeAR = configBot.tags.mapPortal;\n\nif (configBot.tags.mapPortal) {\n    configBot.tags.mapPortal = null;\n\n    if (!configBot.tags.gridPortal) {\n        configBot.tags.gridPortal = masks.mapPortalBeforeAR;\n    }\n}\n\nmasks.arWebSlinger = true;\nmasks.onClick = `@ thisBot.onExitClick();`;\nmasks.label = \"X\";\nmasks.form = null;\nmasks.formOpacity = 1;\nmasks.draggable = false;\nmasks.color = \"clear\";\nmasks.scaleZ = 0.1;\nmasks.labelColor = \"#FFFFFF\";\nmasks.onPointerEnter = \"@ masks.scale = 1.1;\";\nmasks.onPointerExit = \"@ masks.scale = null;\";\n\nconst hexBot = getBot(\"transformer\", thisBot.id);\nhexBot.masks.color = \"clear\";","xrTeardown":"@// Remove the menu3d portal bot from the left wrist portal.\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal] = null;\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal + 'X'] = null;\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal + 'Y'] = null;\nlinks.menu3dPortalBot.masks[configBot.masks.leftWristPortal + 'Z'] = null;\n\nif (masks.mapPortalBeforeAR) {\n    configBot.tags.mapPortal = masks.mapPortalBeforeAR;\n}\n\nclearTagMasks(thisBot);\n\nconfigBot.masks.leftWristPortal = null;\n\nconst hexBot = getBot(\"transformer\", thisBot.id);\nclearTagMasks(hexBot);","onBotAdded":"@thisBot.refreshHex();","abIDOrigin":"arWebSlinger","onDestroy":"@thisBot.arWebSlingerMenuReset();\ndestroy(links.hex);","menu3dPortalBot":"ðŸ”—2b865259-4291-4e78-a985-8a795990f30f"}}}}