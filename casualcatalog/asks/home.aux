{"version":1,"state":{"8d699380-a0af-4e0f-b29b-30f739c91f4b":{"id":"8d699380-a0af-4e0f-b29b-30f739c91f4b","space":"shared","tags":{"abCoreMenuIcon":"ios_share","abCoreMenuLabel":"save home data","abCoreMenuSortOrder":"3.5","abIDOrigin":"home","abVersion":"10.6","onAnyBotsAdded":"@if (!tags.autoSave) {\r\n    return;\r\n}\r\n\r\nlet validChange = false;\r\nfor (const addedBot of that.bots) {\r\n    if (addedBot.tags.space !== 'shared') {\r\n        continue;\r\n    }\r\n\r\n    if (addedBot.tags.abIgnore) {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot has abIgnore tag.`);\r\n        }\r\n        continue;\r\n    }\r\n\r\n    if (addedBot.tags.system && addedBot.tags.system.substring(0, 3) == 'ab.') {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot is an ab bot.`);\r\n        }\r\n        continue;\r\n    }\r\n\r\n    if (!addedBot.tags.homeWorldBot) {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot is not a homeWorldBot.`);\r\n        }\r\n        continue;\r\n    }\r\n\r\n    if (addedBot.tags.abIDOrigin && addedBot.tags.abIDOrigin == 'home') {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot is from the home egg.`);\r\n        }\r\n        continue;\r\n    }\r\n\r\n    //Add homeWorldBot if needed.\r\n    if (!thisBot.vars.homeWorldBotIDs) {\r\n        thisBot.vars.homeWorldBotIDs = new Set();\r\n    }\r\n\r\n    if (!thisBot.vars.homeWorldBotIDs.has(addedBot.id)) {\r\n        thisBot.vars.homeWorldBotIDs.add(addedBot.id);\r\n    }\r\n\r\n    validChange = true;\r\n}\r\n\r\nif (validChange) {\r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}] process inst change.`);\r\n    }\r\n    thisBot.processInstChange();\r\n}","onAnyBotsChanged":"@if (!tags.autoSave) {\r\n    return;\r\n}\r\n\r\nlet validChange = false;\r\n\r\nfor (const changed of that) {\r\n    if (changed.bot.tags.space !== 'shared') {\r\n        continue;\r\n    }\r\n\r\n    if (changed.bot.tags.abIgnore) {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot has abIgnore tag.`);\r\n        }\r\n        continue;\r\n    }\r\n\r\n    if (!changed.bot.tags.homeWorldBot) {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot is not a homeWorldBot.`);\r\n        }\r\n        continue;\r\n    }\r\n\r\n    if (changed.bot.tags.system && changed.bot?.tags?.system?.substring(0, 3) == 'ab.') {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot is an ab bot.`);\r\n        }\r\n        continue;\r\n    }\r\n\r\n    if (changed.tags.some(t => t === 'abArtifactBundle' || t === 'abArtifactInstanceID' || t === 'abArtifactShardInstanceID')) {\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] ignore inst change: bot's changed tags are related to artifacts.`);\r\n        }\r\n        continue;\r\n    }\r\n    \r\n    validChange = true;\r\n    break;\r\n}\r\n\r\nif (validChange) {\r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}] process inst change.`);\r\n    }\r\n    thisBot.processInstChange();\r\n}","onEggHatch":"@if (tags.debug) {\r\n    console.log(`[${tags.system}.${tagName}] that:`, that);\r\n}\r\n\r\n// Immediately disable automatic map camera animation from manifestation bot.\r\nsetTagMask(links.remember, \"mapPreventFocus\", true);\r\n\r\nconst currentDim = ab.links.remember.tags.abActiveDimension;\r\nconst currentPortal = configBot.tags.mapPortal ? \"map\" : configBot.tags.gridPortal == \"blueprint\" ? \"blueprint\" :\"grid\";\r\n\r\nab.links.manifestation.abSetAwake({ awake: true })\r\n\r\nif (currentPortal != 'map') {\r\n    configBot.tags.mapPortal = currentDim;\r\n}\r\n\r\nif (!authBot) {\r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}] authBot not found`);\r\n    }\r\n    await os.requestAuthBotInBackground();\r\n}\r\n\r\nif (!authBot) {\r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}] User not logged in.`);\r\n    }\r\n    return;\r\n}\r\n\r\nif (that.eggParameters && that.eggParameters.saveOnLoad) {\r\n    thisBot.saveData();\r\n    return;\r\n}\r\n\r\nconst studio = configBot.tags.studio ?? authBot.id;\r\nconst homeEggData = await os.getData(studio, 'home');\r\n\r\nif (tags.debug) {\r\n    console.log(`[${tags.system}.${tagName}] homeEggData`, homeEggData, studio);\r\n}\r\n\r\nif (!homeEggData.success) {\r\n    if(homeEggData.errorCode && homeEggData.errorCode == 'not_authorized') {\r\n        const permissions = await os.grantInstAdminPermission(studio);\r\n        const homeEggData2 = await os.getData(studio, 'home');\r\n\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] homeEggData2`, homeEggData2, permissions);\r\n        }\r\n        \r\n        if (!homeEggData2.success) {\r\n            thisBot.saveData();\r\n        }\r\n    } else if (homeEggData.errorCode && homeEggData.errorCode == 'data_not_found') {\r\n        thisBot.saveData();\r\n    }\r\n}\r\n\r\nif (tags.abArtifactName && !tags.abArtifactInstanceID) {\r\n    // Turn the home ask into an artifact instance if it isnt one already upon load.\r\n    tags.abArtifactInstanceID = uuid();\r\n\r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}] turning home world into artifact instance ${tags.abArtifactInstanceID}`);\r\n    }\r\n\r\n    ab.links.artifact.abUpdateArtifactShards({\r\n        abArtifactName: tags.abArtifactName,\r\n        abArtifactInstanceID: tags.abArtifactInstanceID\r\n    })\r\n}\r\n\r\nawait thisBot.handleStudioStationSetup();\r\n\r\n// Manually call homeworld's onPortalChanged so it sets up the intro state.\r\nthisBot.onPortalChanged({ portal: 'mapPortal', dimension: currentDim });","onPortalChanged":"@if (that.portal == \"mapPortal\") {\r\n    if (that.dimension) {\r\n        // Override the mapZoomPosition with the homeBase position (if available).\r\n        const homeBase = getBot(\"homeBase\", true);\r\n\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] homeBase:`, homeBase);\r\n        }\r\n\r\n        if (homeBase && homeBase.tags[that.dimension + \"X\"] && homeBase.tags[that.dimension + \"Y\"]) {\r\n            const homeBasePosition = { x: homeBase.tags[that.dimension + \"X\"], y: homeBase.tags[that.dimension + \"Y\"] };\r\n\r\n            if (tags.debug) {\r\n                console.log(`[${tags.system}.${tagName}] masking mapZoomPosition with homeBasePosition:`, homeBasePosition);\r\n            }\r\n\r\n            setTagMask(links.remember, \"mapZoomPosition\", homeBasePosition);\r\n        }\r\n\r\n        if (!masks.introPlayed) {\r\n            if (tags.debug) {\r\n                console.log(`[${tags.system}.${tagName}] setting mapPreventFocus to true`);\r\n            }\r\n\r\n            // Lock automatic zooming on the map portal done by manifestation bot.\r\n            setTagMask(links.remember, \"mapPreventFocus\", true);\r\n\r\n            // Set initial start zoom for homeworld.\r\n            const abPosition = await links.manifestation.getDefaultManifestPosition('map');\r\n            await os.focusOn(abPosition, { duration: 0, portal: 'map', zoom: 999999999 });\r\n\r\n            // Show home intro menu.\r\n            shout('resetHomeIntroMenu');\r\n\r\n            configBot.tags.menuPortal = 'homeIntroMenu';\r\n\r\n            links.menu.abCreateMenuButton({\r\n                space: 'tempLocal',\r\n                homeIntroMenu: true,\r\n                label: 'enter homeworld',\r\n                homeworldBot: getLink(thisBot),\r\n                resetHomeIntroMenu: `@\r\n                    destroy(thisBot);\r\n                `,\r\n                onClick: `@\r\n                    configBot.tag                    \r\n                    setTagMask(links.homeworldBot.links.remember, \"mapPreventFocus\", null);\r\n                    \r\n                    links.homeworldBot.playIntro();\r\n                    \r\n                    shout('resetHomeIntroMenu');\r\n                `\r\n            })\r\n        }\r\n    } else {\r\n        setTagMask(links.remember, \"mapPreventFocus\", null);\r\n    }\r\n}","processInstChange":"@if (thisBot.vars.saveTimout) {\r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}] clear save timeout.`);\r\n    }\r\n    clearTimeout(thisBot.vars.saveTimout);\r\n    thisBot.vars.saveTimout = null;\r\n}\r\n\r\nif (tags.debug) {\r\n    console.log(`[${tags.system}.${tagName}] start save timeout ${tags.saveDelayMS}ms`);\r\n}\r\n\r\nthisBot.vars.saveTimout = await setTimeout(() => {\r\n    thisBot.saveData();\r\n}, tags.saveDelayMS);","saveData":"@if (!authBot) {\r\n    console.log(\"[ab.home.egg]: saveData no authbot\");\r\n    await os.requestAuthBotInBackground();\r\n}\r\n\r\nif (!authBot) {\r\n    console.log(\"[ab.home.egg]: User not logged in.\");\r\n    return;\r\n}\r\n\r\nif (!tags.saveEnabled) {\r\n    return;\r\n}\r\n\r\nconst studio = configBot.tags.studio ?? authBot.id;\r\nconfigBot.tags.selected_studioID = studio;\r\n\r\nconst homeBots = getBots(\"homeWorldBot\", true);\r\n\r\nconst publishAttempt = await ab.links.store.abPublishAB({ab: 'home', target: homeBots, sourceEvent: 'home_egg_publish', keepMenu: true});\r\n\r\nif (tags.debug) {\r\n    console.log(`[${tags.system}.${tagName}] saveData publishAttempt 1:`, publishAttempt);\r\n}\r\n\r\nif (!publishAttempt.success) {\r\n    const permissions = await os.grantInstAdminPermission(studio);\r\n\r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}] saveData permissions:`, permissions);\r\n    }\r\n\r\n    const secondPublishAttempt = await ab.links.store.abPublishAB({ab: 'home', target: homeBots, sourceEvent: 'home_egg_publish', keepMenu: true});\r\n        \r\n    if (tags.debug) {\r\n        console.log(`[${tags.system}.${tagName}]  saveData publishAttempt 2`, secondPublishAttempt);\r\n    }\r\n\r\n    if (!secondPublishAttempt.success){\r\n        if (tags.debug) {\r\n            console.log(`[${tags.system}.${tagName}] Could not publish`, secondPublishAttempt);\r\n        }\r\n    } else {\r\n        ab.links.manifestation.abSetAwake({ awake: true });\r\n        os.tip(\"home world saved\", 0, gridPortalBot.tags.pixelHeight);\r\n    }\r\n} else {\r\n    os.tip(\"home world saved\", 0, gridPortalBot.tags.pixelHeight);\r\n}","system":"ab.home.world","form":"none","homeWorldBot":"true","homeWorld":"true","debug":"false","saveDelayMS":"5000","isHomeWorldCore":"true","onABArtifactCollectShards":"@const shard: ABArtifactShard = {\n    data: {\n        \n    },\n    dependencies: [\n        { askID: 'home' }\n    ]\n}\n\nreturn shard;","onABArtifactReconstitute":"@const data = that.data;\n","abArtifactName":"home","remember":"ðŸ”—e5380a6b-8b4d-4a8b-8b04-58e1eb03e5e7","onAnyBotsRemoved":"@if (!tags.autoSave) {\r\n    return;\r\n}\r\n\r\nconst { botIDs } = that;\r\n\r\nfor (const botId of botIDs) {\r\n    if (thisBot.vars.homeWorldBotIDs) {\r\n        const deleted = thisBot.vars.homeWorldBotIDs.delete(botId);\r\n\r\n        if (deleted) {\r\n            thisBot.processInstChange();\r\n        }\r\n    }\r\n}","saveEnabled":"true","changeHomeVersion":"@console.log(that);\r\n\r\n//get rid of everything\r\nos.toast(\"reverting home world...\");\r\n\r\ntags.saveEnabled = false;\r\n\r\nconst currentDim = ab.links.remember.tags.abActiveDimension;\r\nconst homeWorldBots = getBots(byTag(currentDim, true), byTag(\"system\", sys => sys?.substring(0, 3) != 'ab.'), byTag(\"abIgnore\", null), byTag(\"space\", 'shared'));\r\n\r\ndestroy(homeWorldBots);\r\n\r\n//load old version\r\nab.links.search.onLookupABEggs({recordKey: configBot.tags.studio ?? authBot.id, abID: 'home', abVersion: that, autoHatch: true, sourceEvent: 'ask', eggParameters: {saveOnLoad: true}});\r\ndestroy(thisBot);","autoSave":"false","utils":"ðŸ”—93d965e0-d20e-4b45-8ca0-649273b7138c","handleStudioStationSetup":"@//check authbot\r\nif (!authBot) {\r\n    await os.requestAuthBotInBackground();\r\n}\r\n\r\nif (!authBot) {\r\n    return;\r\n}\r\n\r\n//setup user studio\r\nconst userStudioBot = getBot(byTag(\"studioStation\", true), byTag('studioId', authBot.id));\r\nif (!userStudioBot) {\r\n    const userHomeWorldMetaData = await os.getData(authBot.id, 'homeworldMetaData');\r\n    let positionX;\r\n    let positionY;\r\n    if (!userHomeWorldMetaData.success) {\r\n        let hasGeolocationPermission = await links.utils.hasGeolocationPermission();\r\n\r\n        // Current work-around for allowing geolocation for iOS app\r\n        if (getBot(\"system\", \"ab.iosbridge.messenger\")) {\r\n            hasGeolocationPermission = true;\r\n        }\r\n\r\n        if (hasGeolocationPermission) {\r\n            const geolocation = await os.getGeolocation();\r\n            if (geolocation.success) {\r\n                positionX = geolocation.longitude;\r\n                positionY = geolocation.latitude;\r\n            }\r\n        } else {\r\n            positionX = -85.6761894822434;\r\n            positionY = 42.9656756756756;\r\n        }\r\n\r\n    } else {\r\n        positionX = userHomeWorldMetaData?.data?.position?.x;\r\n        positionY = userHomeWorldMetaData?.data?.position?.y;\r\n    }\r\n\r\n    //setup hub\r\n    const userAbArtifactShard = {\r\n        data: {\r\n            studioId: authBot.id,\r\n            label: 'home',\r\n            eggParameters: {\r\n                toolboxBot: getLink(thisBot),\r\n                gridInformation: {\r\n                    dimension: 'home',\r\n                    position: {\r\n                        x: positionX,\r\n                        y: positionY\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        dependencies: [\r\n            {\r\n                askID: 'studioStation'\r\n            }\r\n        ]\r\n    };\r\n    await ab.links.artifact.abCreateArtifactPromiseBot({\r\n        abArtifactName: 'studioStation',\r\n        abArtifactInstanceID: uuid(),\r\n        abArtifactShard: userAbArtifactShard,\r\n    });\r\n}\r\n\r\n//get all subscribed to studios\r\nconst result = await os.listUserStudios();\r\n\r\nif (result.success) {\r\n     console.log(result.studios);\r\n} else {\r\n     os.toast('Failed to get studios ' + result.errorMessage);\r\n     return;\r\n}\r\n\r\n//for each\r\nconst studios = result.studios;\r\nfor (let i = 0; i < studios.length; ++i) {\r\n\r\n    //make sure its not already placed\r\n    const studioBot = getBot(byTag(\"studioStation\", true), byTag('studioId', studios[i].studioId));\r\n    if (!studioBot) {\r\n        //get meta data\r\n        const homeWorldMetaData = await os.getData(studios[i].studioId, 'homeworldMetaData');\r\n        if (!homeWorldMetaData.success) {\r\n            continue;\r\n        }\r\n\r\n        //setup hub\r\n        const abArtifactShard = {\r\n            data: {\r\n                studioId: studios[i].studioId,\r\n                label: studios[i].displayName,\r\n                eggParameters: {\r\n                    toolboxBot: getLink(thisBot),\r\n                    gridInformation: {\r\n                        dimension: 'home',\r\n                        position: {\r\n                            x: homeWorldMetaData?.data?.position?.x,\r\n                            y: homeWorldMetaData?.data?.position?.y\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            dependencies: [\r\n                {\r\n                    askID: 'studioStation'\r\n                }\r\n            ]\r\n        };\r\n        ab.links.artifact.abCreateArtifactPromiseBot({\r\n            abArtifactName: 'studioStation',\r\n            abArtifactInstanceID: uuid(),\r\n            abArtifactShard,\r\n        });\r\n    }\r\n\r\n    //update all shared eggs\r\n    //update all shared insts\r\n}\r\n    \r\n","learn":"ðŸ”—6657b865-e983-4401-9fc9-f5418d18a7f7","menu":"ðŸ”—b30c6c5d-a4f7-4266-ba38-393dc95e1ecb","playIntro":"@if (tags.debug) {\n    console.log(`[${tags.system}.${tagName}] that:`, that);\n}\n\nmasks.introPlayed = true;\n\nconst abPosition = await links.manifestation.getDefaultManifestPosition('map');\nconst newAB = await links.manifestation.abManifestBot({ dimension: 'home', position: abPosition });\n\n// Play intro music sting.\nconst introMusicURL = links.learn.abBuildCasualCatalogURL('/asks/home-world-assets/music_launch.mp3');\nos.playSound(introMusicURL);\n\nawait os.sleep(1000);\n\nawait os.focusOn(abPosition, { \n    zoom: links.manifestation.tags.defaultMapPortalZoom, \n    duration: 3000, \n    portal: 'map',\n    rotation: { x: 45, y: 45 },\n    easing: {\n        mode: 'inout',\n        type: 'sinusoidal'\n    }\n});","manifestation":"ðŸ”—dca5d987-c4d8-46e4-b60c-daa7b2f4ddad"}}}}