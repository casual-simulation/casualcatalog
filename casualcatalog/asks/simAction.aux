{"version":1,"state":{"3d05c0be-becb-440a-833b-31c3007d45fb":{"id":"3d05c0be-becb-440a-833b-31c3007d45fb","space":"shared","tags":{"system":"sim_toolbox.tools.simAction","onABArtifactCollectShards":"@const shard: ABArtifactShard = {\r\n    data: {\r\n        label: tags.bbLabel,\r\n        dimensionData: {\r\n            dimension: ab.links.remember.tags.abActiveDimension,\r\n            [ab.links.remember.tags.abActiveDimension]: tags[ab.links.remember.tags.abActiveDimension],\r\n            [ab.links.remember.tags.abActiveDimension + 'X']: tags[ab.links.remember.tags.abActiveDimension + 'X'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Y']: tags[ab.links.remember.tags.abActiveDimension + 'Y'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Z']: tags[ab.links.remember.tags.abActiveDimension + 'Z'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationX']: tags[ab.links.remember.tags.abActiveDimension + 'RotationX'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationY']: tags[ab.links.remember.tags.abActiveDimension + 'RotationY'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationZ']: tags[ab.links.remember.tags.abActiveDimension + 'RotationZ'],\r\n        },\r\n        color: tags.color,\r\n        labelFloatingBackgroundColor: tags.bbLabelFloatingBackgroundColor,\r\n        labelColor: tags.bbLabelColor,\r\n        simID: tags.simID,\r\n        actionIcon: tags.actionIcon,\r\n        actionStory: tags.actionStory,\r\n        actionPrerequisites: tags.actionPrerequisites,\r\n        startingAction: tags.startingAction,\r\n        roleTags: tags.roleTags,\r\n        groupTags: tags.groupTags\r\n    },\r\n    dependencies: [\r\n        {\r\n            askID: 'simAction'\r\n        }\r\n    ]\r\n}\r\n\r\nreturn shard;","onABArtifactReconstitute":"@const data = that.data;\r\ntags.bbLabel = data.label ?? 'action';\r\ntags.color = data.color ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD';\r\ntags.bbLabelFloatingBackgroundColor = data.labelFloatingBackgroundColor ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD'; \r\ntags.bbLabelColor = data.labelColor ?? 'white';\r\ntags.simID = data.simID ?? uuid();\r\ntags.actionIcon = data.actionIcon ?? 'sticky_note_2';\r\ntags.actionPrerequisites = data.actionPrerequisites;\r\ntags.startingAction = data.startingAction ?? false;\r\ntags.actionStory = data.actionStory;\r\ntags.roleTags = data.roleTags ?? [];\r\ntags.groupTags = data.groupTags ?? [];\r\n\r\n//Handle lineTo\r\nif (tags.lineTo) {\r\n    tags.lineTo = null;\r\n}\r\nshout(\"onActionReconstituted\", thisBot);\r\n\r\n//clear possible extra data\r\nif (tags.choosingPrereq) {\r\n    tags.choosingPrereq = null;\r\n}\r\n\r\nif (tags.startingAction == true) {\r\n    tags.scaleZ = 1.4;\r\n} else {\r\n    tags.scaleZ = 1;\r\n}\r\n\r\n//Place bot correctly\r\nif (data.dimensionData) {\r\n    for (const tagName in data.dimensionData) {\r\n        tags[tagName] = data.dimensionData[tagName];\r\n    }\r\n}\r\n\r\n//If new action\r\nif (data.eggParameters) {\r\n    const dimension = data.eggParameters.gridInformation?.dimension ?? 'home';\r\n    const dimensionX = data.eggParameters.gridInformation?.position?.x ?? 0;\r\n    const dimensionY = data.eggParameters.gridInformation?.position?.y ?? 0;\r\n\r\n    tags.dimension = dimension;\r\n    tags[dimension] = true;\r\n    tags[dimension + 'X'] = dimensionX;\r\n    tags[dimension + 'Y'] = dimensionY;\r\n\r\n    thisBot.onClick();\r\n}\r\n\r\nif (!ab.links.console.masks.open) {\r\n    whisper(ab.links.console, \"showConsole\");\r\n    ab.links.console.masks.open = true;\r\n}","onABStripArtifactInstanceDataFromBotData":"@const { data } = that;\r\n\r\ndelete data.tags.bbLabel;\r\ndelete data.tags.bbLabelColor;\r\ndelete data.tags.bbLabelFloatingBackgroundColor;\r\ndelete data.tags.color;\r\ndelete data.tags[data.tags.dimension + \"X\"];\r\ndelete data.tags[data.tags.dimension + \"Y\"];\r\ndelete data.tags[data.tags.dimension + \"Z\"];\r\ndelete data.tags[data.tags.dimension + \"RotationX\"];\r\ndelete data.tags[data.tags.dimension + \"RotationY\"];\r\ndelete data.tags[data.tags.dimension + \"RotationZ\"];\r\ndelete data.tags[data.tags.dimension];\r\ndelete data.tags.dimension;\r\ndelete data.tags.simID;\r\ndelete data.tags.actionIcon;\r\ndelete data.tags.actionPrerequisites;\r\ndelete data.tags.choosingPrereq;\r\ndelete data.tags.lineTo;\r\ndelete data.tags.startingAction;\r\ndelete data.tags.actionStory;\r\ndelete data.tags.roleTags;\r\ndelete data.tags.groupTags;\r\ndelete data.tags.menuButton;","onClick":"@if (that) {\r\n    if (that.modality == 'mouse' && that.buttonId == 'right') {\r\n        return;\r\n    }\r\n}\r\n\r\nconst preReqBot = getBot(\"choosingPrereq\", true);\r\n\r\nif (preReqBot) {\r\n    if (preReqBot == thisBot) {\r\n        tags.choosingPrereq = false;\r\n    } else {\r\n        preReqBot.addPreReq(thisBot);\r\n        tags.color = tags.prevColor;\r\n        tags.prevColor = null;\r\n        return;\r\n    }\r\n}\r\n\r\n// os.toast('hello, world!');\r\nshout('abMenuRefresh');\r\nshout(\"clearSimActionMenu\");\r\n\r\nconfigBot.tags.menuPortal = 'simAction_menu';\r\n\r\nconst menuOptions = {\r\n    simAction_menu: true,\r\n    clearSimActionMenu: `@destroy(thisBot);`,\r\n    abMenuRefresh: \"@ destroy(thisBot);\",\r\n    action: getLink(thisBot)\r\n}\r\n\r\nconst labelButton = {\r\n    ...menuOptions,\r\n    label: 'label: ' + tags.bbLabel,\r\n    simAction_menuSortOrder: 1,\r\n    onClick: `@\r\n        const response = await os.showInput(links.action.tags.bbLabel, {\r\n            autoSelect: true,\r\n            title: 'label this action'\r\n        });\r\n        links.action.tags.bbLabel = response;\r\n        links.action.updateBillboardLabel();\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst iconButton = {\r\n    ...menuOptions,\r\n    label: 'action icon',\r\n    simAction_menuSortOrder: 2,\r\n    onClick: `@\r\n        const response = await os.showInput(links.action.tags.actionIcon, {\r\n            autoSelect: true,\r\n            title: 'Choose an icon',\r\n            content: '(google material icon names)'\r\n        });\r\n        links.action.tags.actionIcon = response;\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nif (!tags.roleTags) {\r\n    tags.roleTags = [];\r\n}\r\nlet tagString = \"\";\r\nfor (let i = 0; i < tags.roleTags.length; ++i) {\r\n    tagString += i == 0 ? tags.roleTags[i] : (', ' + tags.roleTags[i]);\r\n}\r\n\r\nconst addRoleTagButton = {\r\n    ...menuOptions,\r\n    label: 'add role tag: ' + tagString,\r\n    simAction_menuSortOrder: 6,\r\n    onClick: `@\r\n        const response = await os.showInput('', {\r\n            autoSelect: true,\r\n            title: 'add a role tag'\r\n        });\r\n\r\n        links.action.tags.roleTags.push(response);\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nif (!tags.groupTags) {\r\n    tags.groupTags = [];\r\n}\r\nlet groupTagString = \"\";\r\nfor (let i = 0; i < tags.groupTags.length; ++i) {\r\n    groupTagString += i == 0 ? tags.groupTags[i] : (', ' + tags.groupTags[i]);\r\n}\r\n\r\nconst addGroupTagButton = {\r\n    ...menuOptions,\r\n    label: 'add group tag: ' + groupTagString,\r\n    simAction_menuSortOrder: 7,\r\n    onClick: `@\r\n        const response = await os.showInput('', {\r\n            autoSelect: true,\r\n            title: 'add a group tag'\r\n        });\r\n\r\n        links.action.tags.groupTags.push(response);\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst storyButton = {\r\n    ...menuOptions,\r\n    label: 'story',\r\n    simAction_menuSortOrder: 4,\r\n    onClick: `@\r\n        const response = await os.showInput(links.action.tags.actionStory, {\r\n            autoSelect: true,\r\n            title: 'Provide a story for this action',\r\n        });\r\n        links.action.tags.actionStory = response;\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst startingActionButton = {\r\n    ...menuOptions,\r\n    label: 'starting action: ' + tags.startingAction,\r\n    simAction_menuSortOrder: 3,\r\n    onClick: `@\r\n        links.action.tags.startingAction = links.action.tags.startingAction == true ? false : true;\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst preReqButton = {\r\n    ...menuOptions,\r\n    label: 'add a prerequisite',\r\n    simAction_menuSortOrder: 5,\r\n    onClick: `@\r\n        links.action.tags.choosingPrereq = true;\r\n        shout(\"clearSimActionMenu\");\r\n    `\r\n}\r\n\r\nab.links.menu.abCreateMenuButton(labelButton);\r\nab.links.menu.abCreateMenuButton(iconButton);\r\nab.links.menu.abCreateMenuButton(startingActionButton);\r\nab.links.menu.abCreateMenuButton(storyButton);\r\nab.links.menu.abCreateMenuButton(preReqButton);\r\nab.links.menu.abCreateMenuButton(addRoleTagButton);\r\nab.links.menu.abCreateMenuButton(addGroupTagButton);","abArtifactName":"simAction","abIDOrigin":"simAction","onBotAdded":"@let waitTime = 0;\r\n\r\nwhile(!globalThis.ab?.links.bot_factory) {\r\n    if (waitTime >= 5000) {\r\n        return;\r\n    }\r\n    \r\n    await os.sleep(250);\r\n    waitTime += 250;\r\n}\r\n\r\nmasks.ready = true;\r\n\r\nthisBot.updateBillboardLabel();","onBotChanged":"@const needUpdateBillboardLabel = that.tags.some(t => t === 'bbLabel' || t === 'bbLabelFloatingBackgroundColor' || t === 'bbLabelColor');\r\n\r\nif (needUpdateBillboardLabel && tags.ready) {\r\n    thisBot.updateBillboardLabel();\r\n}\r\n\r\nif (that.tags.includes(\"startingAction\")) {\r\n    if (tags.startingAction == true) {\r\n        tags.scaleZ = 1.4;\r\n    } else {\r\n        tags.scaleZ = 1;\r\n    }\r\n}","updateBillboardLabel":"@if (thisBot.vars.billboardLabelBot) {\r\n    destroy(thisBot.vars.billboardLabelBot);\r\n    thisBot.vars.billboardLabelBot = null;\r\n}\r\n\r\nthisBot.vars.billboardLabelBot = ab.links.bot_factory.abCreateBillboardLabel({ \r\n    bot: thisBot, \r\n    label: tags.bbLabel,\r\n    color: tags.bbLabelFloatingBackgroundColor,\r\n    dimension: tags.dimension,\r\n    // botLabelMargin: 0,\r\n    labelColor: tags.bbLabelColor,\r\n    space: 'tempLocal',\r\n})","onPointerEnter":"@const preReqBot = getBot(\"choosingPrereq\", true);\r\n\r\nif (preReqBot) {\r\n    tags.prevColor = tags.color;\r\n    tags.color = '#fcba03';\r\n}","onPointerExit":"@const preReqBot = getBot(\"choosingPrereq\", true);\r\n\r\nif (preReqBot) {\r\n    tags.color = tags.prevColor;\r\n    tags.prevColor = null;\r\n}","addPreReq":"@if (!tags.actionPrerequisites) {\r\n    tags.actionPrerequisites = [];\r\n}\r\n\r\nif (!tags.lineTo) {\r\n    tags.lineTo = [];\r\n}\r\n\r\nconst simID = that?.tags?.simID;\r\n\r\nif (simID) {\r\n    tags.actionPrerequisites.push(simID);\r\n    tags.lineTo.push(that?.id);\r\n}\r\n\r\ntags.choosingPrereq = false;","onGridClick":"@shout(\"clearSimActionMenu\");\r\n//shout(\"clearActionMenu\");\r\n\r\nif (tags.choosingPreReq) {\r\n    tags.choosingPreReq = false;\r\n}","strokeColor":"white","simAction":"true","onActionCompleted":"@if (that == thisBot) {\n    return;\n}\n\nif (tags.groupTags && tags.groupTags.length != 0) {\n    if (that?.tags?.groupTags && that?.tags?.groupTags.length != 0) {\n        const matchingGroupTags = tags.groupTags.filter(tag => that?.tags?.groupTags.includes(tag));\n        if (matchingGroupTags.length != 0) {\n            if (links.menuButton) {\n                destroy(links.menuButton);\n                tags.menuButton = null;\n            }\n        }\n    }\n}\n\nif (!tags.roleTags || tags.roleTags.length == 0) {\n    // if (tags.actionPrerequisites && tags.actionPrerequisites.length != 0 && tags.actionPrerequisites.includes(that?.tags?.simID)) {\n    //     thisBot.showAction();\n    // }\n    return;\n}\n\nconst currentRoleTag = getBot(\"roleOwner\", getID(configBot))?.tags.roleName;\nif (currentRoleTag && tags.roleTags.includes(currentRoleTag)) {\n    if (tags.actionPrerequisites && tags.actionPrerequisites.length != 0 && tags.actionPrerequisites.includes(that?.tags?.simID)) {\n        thisBot.showAction();\n    }\n}","onActionReconstituted":"@if (tags.actionPrerequisites && tags.actionPrerequisites.length != 0 && tags.actionPrerequisites.includes(that?.tags?.simID)) {\r\n    if (!tags.lineTo) {\r\n        tags.lineTo = [];\r\n    }\r\n\r\n    if (!tags.lineTo.includes(that.id)) {\r\n        tags.lineTo.push(that.id);\r\n    }\r\n}","showAction":"@if (tags.menuButton) {\r\n    destroy(tags.menuButton);\r\n    tags.menuButton = null;\r\n}\r\n\r\nconst menuBot = getBot(byTag(\"action_menu\", true), byTag(\"menuSimID\", tags.simID));\r\nif (menuBot) {\r\n    destroy(menuBot);\r\n}\r\n\r\nif (configBot.tags.menuPortal != \"action_menu\") {\r\n    configBot.tags.menuPortal = \"action_menu\";\r\n}\r\n\r\nconst menuOptions = {\r\n    action_menu: true,\r\n    menuSimID: tags.simID,\r\n    clearActionMenu: `@destroy(thisBot);`,\r\n}\r\n\r\nconst tempButton = {\r\n    ...menuOptions,\r\n    label: tags.bbLabel,\r\n    formAddress: tags.actionIcon ?? null,\r\n    action: getLink(thisBot),\r\n    onClick: `@\r\n        const remotes = await os.remotes();\r\n        await sendRemoteData(remotes, \"onActionCompleted\", links.action.tags.simID);\r\n        // shout(\"onActionCompleted\", links.action);\r\n        if (links.action.tags.actionStory) {\r\n            ab.log({message: links.action.tags.actionStory, space: \"shared\", name: \"sim\"});\r\n        } else {\r\n            ab.log({message: \"completed: \" + links.action.tags.bbLabel, space: \"shared\", name: \"sim\"});\r\n        }\r\n        links.action.tags.menuButton = null;\r\n        destroy(thisBot);\r\n    `\r\n}\r\n\r\nconst menuButton = await ab.links.menu.abCreateMenuButton(tempButton);\r\ntags.menuButton = getLink(menuButton);\r\n","showActionMenu":"@shout('abMenuRefresh');\r\nshout(\"clearActionMenu\");\r\n\r\nconfigBot.tags.menuPortal = 'action_menu';\r\n\r\nconst menuOptions = {\r\n    action_menu: true,\r\n    clearActionMenu: `@destroy(thisBot);`,\r\n}\r\n\r\nconst actionBots = getBots(byTag(\"simAction\", true), byTag(\"startingAction\", true));\r\n\r\nfor (let i = 0; i < actionBots.length; ++i) {\r\n   actionBots[i].showAction();\r\n}","cursor":"pointer","scaleZ":1,"onRemoteData":"@if (that.name == \"onActionCompleted\") {\r\n    thisBot.onActionCompleted(getBot(\"simID\", that.that));\r\n}\r\n\r\nelse if (that.name == \"onStartMenu\") {\r\n    if (tags.startingAction == true) {\r\n        if (!tags.roleTags || tags.roleTags.length == 0) {\r\n            thisBot.showAction();\r\n        } else {\r\n           const currentRoleTag = getBot(\"roleOwner\", getID(configBot))?.tags.roleName;\r\n            if (currentRoleTag && tags.roleTags.includes(currentRoleTag)) {\r\n                thisBot.showAction();\r\n            } \r\n        }\r\n    }\r\n}","onABOpenMenu":"@if (that.menuType != 'abBotMenu' || ab.links.remember.links.abBotFocus != thisBot) {\r\n    return;\r\n}\r\n\r\nconst menuOptions = {\r\n    abMenuRefresh: `@destroy(thisBot);`,\r\n    abMenu: true,\r\n    action: getLink(thisBot)\r\n}\r\n\r\nconst actionMenuButton = {\r\n    ...menuOptions,\r\n    formAddress: 'menu',\r\n    label: 'show action menu',\r\n    abMenuSortOrder: -1,\r\n    onClick: `@\r\n        links.action.showActionMenu();\r\n        shout('abMenuRefresh');\r\n    `\r\n}\r\n\r\nconst resetRoleTagsButton = {\r\n    ...menuOptions,\r\n    formAddress: 'replay',\r\n    label: 'reset role tags',\r\n    onClick: `@\r\n        links.action.tags.roleTags = [];\r\n        shout('abMenuRefresh');\r\n        shout(\"clearSimActionMenu\");\r\n\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst resetGroupTagsButton = {\r\n    ...menuOptions,\r\n    formAddress: 'replay',\r\n    label: 'reset group tags',\r\n    onClick: `@\r\n        links.action.tags.groupTags = [];\r\n        shout('abMenuRefresh');\r\n        shout(\"clearSimActionMenu\");\r\n\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst resetPrereqsButton = {\r\n    ...menuOptions,\r\n    formAddress: 'replay',\r\n    label: 'reset prerequisites',\r\n    onClick: `@\r\n        links.action.tags.actionPrerequisites = null;\r\n        links.action.tags.lineTo = null;\r\n        shout('abMenuRefresh');\r\n    `\r\n}\r\n\r\nab.links.menu.abCreateMenuButton(actionMenuButton);\r\nab.links.menu.abCreateMenuButton(resetRoleTagsButton);\r\nab.links.menu.abCreateMenuButton(resetGroupTagsButton);\r\nab.links.menu.abCreateMenuButton(resetPrereqsButton);\r\n\r\nreturn;"}}}}