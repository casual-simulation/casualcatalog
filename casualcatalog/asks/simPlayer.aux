{"version":1,"state":{"5dfb1124-e202-4543-b223-da086dc82dc4":{"id":"5dfb1124-e202-4543-b223-da086dc82dc4","space":"shared","tags":{"system":"sim_toolbox.tools.simPlayer","onABArtifactCollectShards":"@const shard: ABArtifactShard = {\r\n    data: {\r\n        label: tags.label,\r\n        dimensionData: {\r\n            dimension: ab.links.remember.tags.abActiveDimension,\r\n            [ab.links.remember.tags.abActiveDimension]: tags[ab.links.remember.tags.abActiveDimension],\r\n            [ab.links.remember.tags.abActiveDimension + 'X']: tags[ab.links.remember.tags.abActiveDimension + 'X'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Y']: tags[ab.links.remember.tags.abActiveDimension + 'Y'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Z']: tags[ab.links.remember.tags.abActiveDimension + 'Z'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationX']: tags[ab.links.remember.tags.abActiveDimension + 'RotationX'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationY']: tags[ab.links.remember.tags.abActiveDimension + 'RotationY'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationZ']: tags[ab.links.remember.tags.abActiveDimension + 'RotationZ'],\r\n        },\r\n        color: tags.color,\r\n        labelFloatingBackgroundColor: tags.labelFloatingBackgroundColor,\r\n        labelColor: tags.labelColor,\r\n        simID: tags.simID,\r\n        form: tags.form,\r\n        formSubtype: tags.formSubtype,\r\n        formAddress: tags.formAddress,\r\n        formAddressAspectRatio: tags.formAddressAspectRatio,\r\n        strokeColor: tags.strokeColor\r\n    },\r\n    dependencies: [\r\n        {\r\n            askID: 'simPlayer'\r\n        }\r\n    ]\r\n}\r\n\r\nreturn shard;","onABArtifactReconstitute":"@let data = that.data;\r\nif (data.config) {\r\n    data = data.config;\r\n}\r\n\r\nlet label = 'player';\r\nconst players = getBots(\"simPlayer\", true);\r\nlabel = label + ' ' + (players.length ?? 1);\r\n\r\ntags.label = data.label ?? label;\r\ntags.color = data.color ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD';\r\ntags.labelFloatingBackgroundColor = data.labelFloatingBackgroundColor ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD'; \r\ntags.labelColor = data.labelColor ?? 'white';\r\ntags.strokeColor = data.strokeColor ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD';\r\ntags.simID = data.simID ?? uuid();\r\ntags.form = data.form;\r\ntags.formSubtype = data.formSubtype;\r\ntags.formAddress = data.formAddress;\r\ntags.formAddressAspectRatio = data.formAddressAspectRatio;\r\n\r\n//Place bot correctly\r\nif (data.dimensionData) {\r\n    for (const tagName in data.dimensionData) {\r\n        tags[tagName] = data.dimensionData[tagName];\r\n    }\r\n}\r\n\r\n//If new action\r\nif (data.eggParameters) {\r\n    const dimension = data.eggParameters.gridInformation?.dimension ?? 'home';\r\n    const dimensionX = data.eggParameters.gridInformation?.position?.x ?? 0;\r\n    const dimensionY = data.eggParameters.gridInformation?.position?.y ?? 0;\r\n\r\n    tags.dimension = dimension;\r\n    tags[dimension] = true;\r\n    tags[dimension + 'X'] = dimensionX;\r\n    tags[dimension + 'Y'] = dimensionY;\r\n\r\n    thisBot.onClick();\r\n}","onABStripArtifactInstanceDataFromBotData":"@const { data } = that;\r\n\r\ndelete data.tags.label;\r\ndelete data.tags.labelColor;\r\ndelete data.tags.labelFloatingBackgroundColor;\r\ndelete data.tags.color;\r\ndelete data.tags[data.tags.dimension + \"X\"];\r\ndelete data.tags[data.tags.dimension + \"Y\"];\r\ndelete data.tags[data.tags.dimension + \"Z\"];\r\ndelete data.tags[data.tags.dimension + \"RotationX\"];\r\ndelete data.tags[data.tags.dimension + \"RotationY\"];\r\ndelete data.tags[data.tags.dimension + \"RotationZ\"];\r\ndelete data.tags[data.tags.dimension];\r\ndelete data.tags.dimension;\r\ndelete data.tags.simID;\r\ndelete data.tags.form;\r\ndelete data.tags.formSubtype;\r\ndelete data.tags.formAddress;\r\ndelete data.tags.formAddressAspectRatio;\r\ndelete data.tags.currentRole;\r\ndelete data.tags.strokeColor;\r\ndelete data.tags.simXP;\r\ndelete data.tags.avatar;","onClick":"@shout('abMenuRefresh');\r\nshout(\"clearSimPlayerMenu\");\r\n\r\n//handle right click\r\nif (that) {\r\n    if (that.modality == 'mouse' && that.buttonId == 'right') { \r\n        return;\r\n    }\r\n}\r\n\r\n//if already occupied, do nothing\r\nif (tags.remoteID) {\r\n    return;\r\n}\r\n\r\nconfigBot.tags.menuPortal = 'simPlayer_menu';\r\n\r\nconst menuOptions = {\r\n    simPlayer_menu: true,\r\n    clearSimPlayerMenu: `@destroy(thisBot);`,\r\n    abMenuRefresh: \"@ destroy(thisBot);\",\r\n    simPlayer: getLink(thisBot)\r\n}\r\n\r\n//create role dropdown\r\nconst roleChoice = {\r\n    ...menuOptions,\r\n    label: \"choose a role\",\r\n    dropdownSortOrder: 1,\r\n    defaultOpen: true,\r\n    dropdownOptions: []\r\n}\r\n\r\nconst roleBots = getBots(byTag(\"simRole\", true));\r\nfor (let i = 0; i < roleBots.length; ++i) {\r\n\r\n    const numAllowed = roleBots[i].tags.numUsers ?? 1;\r\n    if (roleBots[i].tags.roleOwner && roleBots[i].tags.roleOwner.length >= numAllowed) {\r\n        continue;\r\n    }\r\n\r\n    const tempRoleButton = {\r\n        ...menuOptions,\r\n        label: roleBots[i].tags.roleName,\r\n        roleID: roleBots[i].tags.simID,\r\n        onClick: `@\r\n            links.simPlayer.chooseRole(tags.roleID);\r\n            shout(\"clearSimPlayerMenu\");\r\n        `\r\n    }\r\n\r\n    roleChoice.dropdownOptions.push(tempRoleButton);\r\n}\r\n\r\n//If no roles left, notify the user, move on\r\nif (roleChoice.dropdownOptions.length == 0) {\r\n    os.toast(\"There are no remaining roles.\");\r\n    return;\r\n}\r\nab.links.menu.abCreateMenuDropdown(roleChoice);\r\n\r\n\r\n\r\n","abArtifactName":"simPlayer","abIDOrigin":"simPlayer","onBotAdded":"@let waitTime = 0;\r\n\r\nwhile(!globalThis.ab?.links.bot_factory) {\r\n    if (waitTime >= 5000) {\r\n        return;\r\n    }\r\n    \r\n    await os.sleep(250);\r\n    waitTime += 250;\r\n}\r\n\r\nmasks.ready = true;","onGridClick":"@shout(\"clearSimPlayerMenu\");\r\n\r\nif (that) {\r\n    if (that.modality == 'mouse' && that.buttonId == 'right') { \r\n        return;\r\n    }\r\n}","cursor":"pointer","onInstStreaming":"@if (tags.remoteID) {\r\n    const remotes = await os.remotes();\r\n    if (!remotes || !remotes.includes(tags.remoteID)) {\r\n        thisBot.resetPlayer();\r\n    }\r\n}","onABOpenMenu":"@if (that.menuType != 'abBotMenu' || ab.links.remember.links.abBotFocus != thisBot) {\r\n    return;\r\n}\r\n\r\nconst menuOptions = {\r\n    abMenuRefresh: `@destroy(thisBot);`,\r\n    abMenu: true,\r\n    simplayer: getLink(thisBot)\r\n}","formOpacity":".3","simPlayer":"true","scale":"2","labelPosition":"floatingBillboard","labelWordWrapMode":"breakWords","labelSize":"2","labelFontSize":"1","getActionCompletionState":"@const actionSimID = that;\r\n\r\nif (!authBot) {\r\n    await os.requestAuthBotInBackground();\r\n}\r\n\r\nif (!authBot) {\r\n    os.toast(\"user not logged in.\");\r\n    return;\r\n}\r\n\r\nconst simXPBot = getBot(byTag(\"xp\", true), byTag(\"xpType\", \"sim\"), byTag(\"simUser\", authBot.id));\r\n\r\nconst foundAction = simXPBot.tags.completedActions.includes(that);\r\n\r\nif (foundAction) {\r\n    return true;\r\n} else {\r\n    return false;\r\n}","resetPlayer":"@clearTagMasks(thisBot);","chooseRole":"@setTagMask(thisBot, \"scaleZ\", 0.01, \"tempShared\");\r\nsetTagMask(thisBot, \"color\", 'clear', \"tempShared\");\r\nsetTagMask(thisBot, \"labelPosition\", 'top', \"tempShared\");\r\nsetTagMask(thisBot, \"remoteID\", getID(configBot), \"tempShared\");\r\nsetTagMask(thisBot, \"chosenRole\", that, \"tempShared\");\r\n\r\nconst simXPBot = getBot(byTag(\"xp\", true), byTag(\"xpType\", \"sim\"), byTag(\"simUser\", authBot.id));\r\nsetTagMask(simXPBot, \"chosenRole\", that, \"tempShared\");\r\n\r\nconst roleBot = getBot(\"simID\", that);\r\nroleBot.addRoleOwner();\r\n\r\n//create sim avatar\r\nconst avatarBot = getBot(byTag(\"simAvatar\", true), byTag(\"remoteID\", configBot.tags.id));\r\n\r\nif (!avatarBot) {\r\n    const abArtifactShard = {\r\n        data: {\r\n            eggParameters: {\r\n                gridInformation: {\r\n                    dimension: roleBot.tags.defaultPlace ?? tags.dimension,\r\n                    position: {\r\n                        x: tags[tags.dimension + 'X'],\r\n                        y: tags[tags.dimension + 'Y']\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        dependencies: [\r\n            {\r\n                askID: 'simAvatar'\r\n            }\r\n        ]\r\n    };\r\n    const avatar = await ab.links.artifact.abCreateArtifactPromiseBot({\r\n        abArtifactName: 'simAvatar',\r\n        abArtifactInstanceID: uuid(),\r\n        abArtifactShard,\r\n    });\r\n\r\n    tags.avatar = getLink(avatar);\r\n}\r\n\r\nif (roleBot.tags.defaultPlace) {\r\n    configBot.tags.gridPortal = roleBot.tags.defaultPlace;\r\n}\r\n\r\nif (!simXPBot) {\r\n    \r\n    //create XP bot\r\n    if (!authBot) {\r\n        await os.requestAuthBotInBackground();\r\n    }\r\n\r\n    if (!authBot) {\r\n        os.toast(\"user not logged in.\");\r\n        return;\r\n    }\r\n    const abArtifactShard = {\r\n        data: {\r\n            chosenRole: that,\r\n            simUser: authBot.id\r\n        },\r\n        dependencies: [\r\n            {\r\n                askID: 'simXP'\r\n            }\r\n        ]\r\n    };\r\n    const xpBot = await ab.links.artifact.abCreateArtifactPromiseBot({\r\n        abArtifactName: 'simXP',\r\n        abArtifactInstanceID: uuid(),\r\n        abArtifactShard,\r\n    });\r\n\r\n    tags.simXP = getLink(xpBot);\r\n} else {\r\n    tags.simXP = getLink(simXPBot);\r\n}","onInstLeave":"@if (tags.remoteID) {\r\n    const remotes = await os.remotes();\r\n    if (!remotes || !remotes.includes(tags.remoteID)) {\r\n        thisBot.resetPlayer();\r\n    }\r\n}","addActionToQueue":"@if (!that) {\r\n    return;\r\n}\r\n\r\nconst simXPBot = getBot(byTag(\"xp\", true), byTag(\"xpType\", \"sim\"), byTag(\"simUser\", authBot.id));\r\n\r\nif (!simXPBot) {\r\n    return;\r\n}\r\n\r\nif (!simXPBot?.tags?.queuedActions?.includes(that)) {\r\n    simXPBot?.tags?.queuedActions?.push(that);\r\n}\r\n\r\nconsole.log(\"adding\", that);\r\n\r\nthisBot.showActionMenu();","completeAction":"@if (!that) {\r\n    return;\r\n}\r\n\r\nconst simXPBot = getBot(byTag(\"xp\", true), byTag(\"xpType\", \"sim\"), byTag(\"simUser\", authBot.id));\r\n\r\nif (!simXPBot) {\r\n    return;\r\n}\r\n\r\nif (simXPBot?.tags?.queuedActions?.includes(that)) {\r\n    simXPBot?.tags?.queuedActions?.splice(simXPBot?.tags?.queuedActions.indexOf(that), 1);\r\n}\r\n\r\nif (!simXPBot?.tags?.completedActions?.includes(that)) {\r\n    simXPBot?.tags?.completedActions?.push(that);\r\n}\r\n\r\nconsole.log(\"completing\", that);\r\n\r\nthisBot.showActionMenu();","onRemoteData":"@if (that.name == \"onActionCompleted\") {\r\n    if (that.remoteId == getID(configBot)) {\r\n        thisBot.completeAction(that.that);\r\n    }\r\n}\r\n\r\nelse if (that.name == \"onStartMenu\") {\r\n\r\n    const simXPBot = getBot(byTag(\"xp\", true), byTag(\"xpType\", \"sim\"), byTag(\"simUser\", authBot.id));\r\n    const roleBot = getBot(\"simID\", simXPBot?.tags?.chosenRole);\r\n\r\n    if (simXPBot && roleBot.tags.simAttributesStartingValues) {\r\n        simXPBot.tags.playerStats = roleBot.tags.simAttributesStartingValues;\r\n    }\r\n\r\n    shout(\"clearActionMenu\");\r\n    shout(\"clearRoleStats\");\r\n    shout('abMenuRefresh');\r\n\r\n    if (configBot.tags.menuPortal != 'action_menu') {\r\n       configBot.tags.menuPortal = 'action_menu'; \r\n    }\r\n\r\n    simXPBot.tags.queuedActions = [];\r\n    simXPBot.tags.completedActions = [];\r\n\r\n    const actionBots = getBots(byTag(\"simAction\", true), byTag(\"startingAction\", true));\r\n    for (let i = 0; i < actionBots.length; ++i) {\r\n        if (actionBots[i].tags.roleTags && actionBots[i].tags.roleTags.length != 0) {\r\n            if(actionBots[i].tags.roleTags.includes(roleBot.tags.roleName)) {\r\n                thisBot.addActionToQueue(actionBots[i].tags.simID);\r\n            }\r\n        }\r\n    }\r\n}","showActionMenu":"@shout(\"clearActionMenu\");\r\n\r\nawait os.sleep(0);\r\n\r\nif (configBot.tags.menuPortal != \"action_menu\") {\r\n    configBot.tags.menuPortal = \"action_menu\";\r\n}\r\n\r\nconst simXPBot = getBot(byTag(\"xp\", true), byTag(\"xpType\", \"sim\"), byTag(\"simUser\", authBot.id));\r\n\r\nconst stats = await simXPBot.getStats();\r\nif (stats) {\r\n    ab.links.menu.abCreateMenuDropdown(stats);\r\n}\r\n\r\nfor (let i = 0; i < simXPBot.tags.queuedActions.length; ++i) {\r\n    const actionBot = getBot(\"simID\", simXPBot.tags.queuedActions[i]);\r\n    if (!actionBot) {\r\n        continue;\r\n    }\r\n\r\n    if (actionBot.tags.actionTriggerFilter && actionBot.tags.actionTriggerFilter.length > 0) {\r\n        let filterSatisfied = true;\r\n        for (let i = 0; i < actionBot.tags.actionTriggerFilter.length; ++i) {\r\n            const completed = await thisBot.getActionCompletionState(actionBot.tags.actionTriggerFilter[i]);\r\n            if (completed == false) {\r\n                filterSatisfied = false;\r\n            }\r\n        }\r\n        if (filterSatisfied == true) {\r\n            actionBot.showAction();\r\n            continue; \r\n        }\r\n    } else {\r\n      actionBot.showAction();  \r\n    }\r\n}\r\n","removeActionFromQueue":"@if (!that) {\r\n    return;\r\n}\r\n\r\nconst simXPBot = getBot(byTag(\"xp\", true), byTag(\"xpType\", \"sim\"), byTag(\"simUser\", authBot.id));\r\n\r\nif (!simXPBot) {\r\n    return;\r\n}\r\n\r\n\r\nif (simXPBot?.tags?.queuedActions?.includes(that)) {\r\n    simXPBot?.tags?.queuedActions?.splice(simXPBot?.tags?.queuedActions.indexOf(that), 1);\r\n}\r\n\r\nconsole.log(\"removing\", that);\r\n\r\nthisBot.showActionMenu();","onPortalChanged":"@if (that.portal == \"gridPortal\" && that.dimension != 'home' && that.dimension != 'blueprint') {\r\n    const playerBot = getBot(byTag(\"simPlayer\", true), byTag(\"remoteID\", getID(configBot)));\r\n    if (!playerBot) {\r\n        configBot.tags.gridPortal = 'home';\r\n    }\r\n}"}}}}