{"version":1,"state":{"9c57c9b5-bba1-40ed-96cc-efdf3614fa59":{"id":"9c57c9b5-bba1-40ed-96cc-efdf3614fa59","space":"shared","tags":{"system":"sim_toolbox.tools.simWizard","onABArtifactCollectShards":"@const shard: ABArtifactShard = {\r\n    data: {\r\n        label: tags.bbLabel,\r\n        dimensionData: {\r\n            dimension: ab.links.remember.tags.abActiveDimension,\r\n            [ab.links.remember.tags.abActiveDimension]: tags[ab.links.remember.tags.abActiveDimension],\r\n            [ab.links.remember.tags.abActiveDimension + 'X']: tags[ab.links.remember.tags.abActiveDimension + 'X'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Y']: tags[ab.links.remember.tags.abActiveDimension + 'Y'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Z']: tags[ab.links.remember.tags.abActiveDimension + 'Z'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationX']: tags[ab.links.remember.tags.abActiveDimension + 'RotationX'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationY']: tags[ab.links.remember.tags.abActiveDimension + 'RotationY'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationZ']: tags[ab.links.remember.tags.abActiveDimension + 'RotationZ'],\r\n        },\r\n        color: tags.color,\r\n        labelFloatingBackgroundColor: tags.bbLabelFloatingBackgroundColor,\r\n        labelColor: tags.bbLabelColor,\r\n        simID: tags.simID\r\n    },\r\n    dependencies: [\r\n        {\r\n            askID: 'simWizard'\r\n        }\r\n    ]\r\n}\r\n\r\nreturn shard;","onABArtifactReconstitute":"@const data = that.data;\r\ntags.bbLabel = data.label ?? 'wizard';\r\ntags.color = data.color ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD';\r\ntags.bbLabelFloatingBackgroundColor = data.labelFloatingBackgroundColor ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD'; \r\ntags.bbLabelColor = data.labelColor ?? 'white';\r\ntags.simID = data.simID ?? uuid();\r\n\r\n//Place bot correctly\r\nif (data.dimensionData) {\r\n    for (const tagName in data.dimensionData) {\r\n        tags[tagName] = data.dimensionData[tagName];\r\n    }\r\n}\r\n\r\n//If new action\r\nif (data.eggParameters) {\r\n    const dimension = data.eggParameters.gridInformation?.dimension ?? 'home';\r\n    const dimensionX = data.eggParameters.gridInformation?.position?.x ?? 0;\r\n    const dimensionY = data.eggParameters.gridInformation?.position?.y ?? 0;\r\n\r\n    tags.dimension = dimension;\r\n    tags[dimension] = true;\r\n    tags[dimension + 'X'] = dimensionX;\r\n    tags[dimension + 'Y'] = dimensionY;\r\n\r\n    thisBot.onClick();\r\n}\r\n\r\nif (!ab.links.console.masks.open) {\r\n    whisper(ab.links.console, \"showConsole\");\r\n    ab.links.console.masks.open = true;\r\n}","onABStripArtifactInstanceDataFromBotData":"@const { data } = that;\r\n\r\ndelete data.tags.bbLabel;\r\ndelete data.tags.bbLabelColor;\r\ndelete data.tags.bbLabelFloatingBackgroundColor;\r\ndelete data.tags.color;\r\ndelete data.tags[data.tags.dimension + \"X\"];\r\ndelete data.tags[data.tags.dimension + \"Y\"];\r\ndelete data.tags[data.tags.dimension + \"Z\"];\r\ndelete data.tags[data.tags.dimension + \"RotationX\"];\r\ndelete data.tags[data.tags.dimension + \"RotationY\"];\r\ndelete data.tags[data.tags.dimension + \"RotationZ\"];\r\ndelete data.tags[data.tags.dimension];\r\ndelete data.tags.dimension;\r\ndelete data.tags.simID;\r\ndelete data.tags.wizardPrompt;","onClick":"@if (that) {\r\n    if (that.modality == 'mouse' && that.buttonId == 'right') {\r\n        return;\r\n    }\r\n}\r\n\r\nshout('abMenuRefresh');\r\nshout(\"clearSimWizardMenu\");\r\n\r\nconfigBot.tags.menuPortal = 'simWizard_menu';\r\n\r\nconst menuOptions = {\r\n    simWizard_menu: true,\r\n    clearSimWizardMenu: `@destroy(thisBot);`,\r\n    abMenuRefresh: \"@ destroy(thisBot);\",\r\n    wizard: getLink(thisBot)\r\n}\r\n\r\nconst promptButton = {\r\n    ...menuOptions,\r\n    label: 'submit prompt',\r\n    simWizard_menuSortOrder: 1,\r\n    formAddress: 'edit',\r\n    onClick: `@\r\n        const response = await os.showInput(links.wizard.tags.wizardPrompt, {\r\n            autoSelect: true,\r\n            title: 'describe this simulation'\r\n        });\r\n        links.wizard.tags.wizardPrompt = response;\r\n        links.wizard.generateFromPrompt(response);\r\n        shout(\"clearSimWizardMenu\");\r\n    `\r\n}\r\n\r\nconst csvButton = {\r\n    ...menuOptions,\r\n    label: 'upload csv',\r\n    formAddress: 'upload',\r\n    simWizard_menuSortOrder: 2,\r\n    onClick: `@\r\n        links.wizard.generateFromCSV();\r\n        shout(\"clearSimWizardMenu\");\r\n    `\r\n}\r\n\r\nconst downloadButton = {\r\n    ...menuOptions,\r\n    label: 'download simulation',\r\n    formAddress: 'download',\r\n    simWizard_menuSortOrder: 3,\r\n    onClick: `@\r\n        links.wizard.downloadSim();\r\n        shout(\"clearSimWizardMenu\");\r\n    `\r\n}\r\n\r\nab.links.menu.abCreateMenuButton(promptButton);\r\nab.links.menu.abCreateMenuButton(csvButton);\r\nab.links.menu.abCreateMenuButton(downloadButton);","abIDOrigin":"simWizard","onBotAdded":"@let waitTime = 0;\r\n\r\nwhile(!globalThis.ab?.links.bot_factory) {\r\n    if (waitTime >= 5000) {\r\n        return;\r\n    }\r\n    \r\n    await os.sleep(250);\r\n    waitTime += 250;\r\n}\r\n\r\nmasks.ready = true;\r\n\r\nthisBot.updateBillboardLabel();","onBotChanged":"@const needUpdateBillboardLabel = that.tags.some(t => t === 'bbLabel' || t === 'bbLabelFloatingBackgroundColor' || t === 'bbLabelColor');\r\n\r\nif (needUpdateBillboardLabel && tags.ready) {\r\n    thisBot.updateBillboardLabel();\r\n}","updateBillboardLabel":"@if (thisBot.vars.billboardLabelBot) {\r\n    destroy(thisBot.vars.billboardLabelBot);\r\n    thisBot.vars.billboardLabelBot = null;\r\n}\r\n\r\nthisBot.vars.billboardLabelBot = ab.links.bot_factory.abCreateBillboardLabel({ \r\n    bot: thisBot, \r\n    label: tags.bbLabel,\r\n    color: tags.bbLabelFloatingBackgroundColor,\r\n    dimension: tags.dimension,\r\n    // botLabelMargin: 0,\r\n    labelColor: tags.bbLabelColor,\r\n    space: 'tempLocal',\r\n})","onGridClick":"@shout(\"clearSimWizardMenu\");","strokeColor":"white","cursor":"pointer","scaleZ":"2","onABOpenMenu":"@if (that.menuType != 'abBotMenu' || ab.links.remember.links.abBotFocus != thisBot) {\r\n    return;\r\n}\r\n\r\nconst menuOptions = {\r\n    abMenuRefresh: `@destroy(thisBot);`,\r\n    abMenu: true,\r\n    action: getLink(thisBot)\r\n}\r\n\r\nconst actionMenuButton = {\r\n    ...menuOptions,\r\n    formAddress: 'menu',\r\n    label: 'show action menu',\r\n    abMenuSortOrder: -1,\r\n    onClick: `@\r\n        links.action.showActionMenu();\r\n        shout('abMenuRefresh');\r\n    `\r\n}\r\n\r\nconst resetRoleTagsButton = {\r\n    ...menuOptions,\r\n    formAddress: 'replay',\r\n    label: 'reset role tags',\r\n    onClick: `@\r\n        links.action.tags.roleTags = [];\r\n        shout('abMenuRefresh');\r\n        shout(\"clearSimActionMenu\");\r\n\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst resetGroupTagsButton = {\r\n    ...menuOptions,\r\n    formAddress: 'replay',\r\n    label: 'reset group tags',\r\n    onClick: `@\r\n        links.action.tags.groupTags = [];\r\n        shout('abMenuRefresh');\r\n        shout(\"clearSimActionMenu\");\r\n\r\n        links.action.onClick();\r\n    `\r\n}\r\n\r\nconst resetPrereqsButton = {\r\n    ...menuOptions,\r\n    formAddress: 'replay',\r\n    label: 'reset prerequisites',\r\n    onClick: `@\r\n        links.action.tags.actionPrerequisites = null;\r\n        links.action.tags.lineTo = null;\r\n        shout('abMenuRefresh');\r\n    `\r\n}\r\n\r\nab.links.menu.abCreateMenuButton(actionMenuButton);\r\nab.links.menu.abCreateMenuButton(resetRoleTagsButton);\r\nab.links.menu.abCreateMenuButton(resetGroupTagsButton);\r\nab.links.menu.abCreateMenuButton(resetPrereqsButton);\r\n\r\nreturn;","abArtifactName":"simWizard","generateFromPrompt":"@const prompt = that;\r\n\r\nconfigBot.tags.menuPortal = \"simWizardLoading\";\r\nconst loadingBar = ab.links.menu.abCreateMenuBusyIndicator({\r\n    label: \"thinking\",\r\n    simWizardLoading: true\r\n});\r\n\r\nconst basePrompt = `You will be given a prompt for a simulation. You must return a csv with the simulation items that you decide should be created based on the content of the prompt. Add sim places before other items.\r\n    \r\n    Your options for simulation items are:\r\n        - SIM_ACTION: \r\n            description: an action for a user to take or complete.\r\n            configuration: {\r\n                label: the text that should appear on the action (keep it brief, less than 10 words)\r\n                simID: a unique id used to determine prerequisites\r\n                prerequisites: an array of actions or reactions that this action should follow. This can be an empty array.\r\n                roles: an array of roles that this action should appear for (example: a 'doctor' role can 'check test results', but a 'patient' role cannot). \r\n                startingAction: a true or false value representing whether or not this action is one of the first actions a user sees.\r\n            }\r\n\r\n        - SIM_ROLE: \r\n            description: a role that a user can take on (example: doctor, patient).\r\n            configuration: {\r\n                name: the name of the role.\r\n                attributes: a json object of attribute name keys and attribute values.\r\n            }\r\n\r\n        - SIM_REACTION: \r\n            description: an effect that can happen in response to an action, that changes a stat of a chosen role or prop.\r\n            configuration: {\r\n                label: A brief description of the reaction (less than 5 words).\r\n                affectedAttribute: the attribute of a prop or role that should be affected.\r\n                effect: the way that the attribute is affected. This value can be +, -, or =.\r\n                value: The amount that the attribute should be changed by (example 2).\r\n                roles: an array of roles that this reaction should affect (example: a patient role can have it's health attribute reduced).\r\n                simID: a unique id used to determine prerequisites.\r\n                prerequisites: an array of actions or reactions that this action should follow. This can be an empty array.\r\n            }\r\n\r\n        - SIM_PROP:\r\n            description: a prop in the simulation that is not a player but has stats.\r\n            configuration: {\r\n                name: The name of the prop.\r\n                trackedAttribute: The main attribute that should be visually represented for this prop. This value can be left empty.\r\n                lowestValue: The lowest value allowed for the tracked attribute.\r\n                highestValue: The highest value allowed for the tracked attribute.\r\n                attributes: a json object of attribute name keys and attribute values, make sure the tracked attribute is included.\r\n                place: the simID of the place where this prop should be located.\r\n            }\r\n\r\n        - SIM_PLACE:\r\n            description: a location in the simulation that a player can move to and items can be placed in.\r\n            configuration: {\r\n                prompt: A prompt describing the location that should be displayed.\r\n                name: the name of the location (keep it brief, less than 4 words).\r\n                simID: a unique id for sim doors to reference.\r\n            }\r\n\r\n        - SIM_DOOR: \r\n            description: a door that can be placed in a sim place that leads to a different sim place.\r\n            configuration: {\r\n                label: the name of the place that this door should lead to.\r\n                destination: the simID of the place that this door should lead to.\r\n                place: the simID of the place where this door should be located.\r\n            }\r\n`\r\nconst aiChatMessages: AIChatMessage[] = [];\r\n\r\naiChatMessages.push({\r\n    role: 'system',\r\n    content: [\r\n        { text: basePrompt }\r\n    ]\r\n})\r\n\r\naiChatMessages.push({\r\n    role: 'system',\r\n    content: [\r\n        { text: 'prompt: ' + prompt}\r\n    ]\r\n})\r\n\r\nconst aiChatOptions: AIChatOptions = { \r\n    preferredModel: ab.links.personality.tags.abPreferredAIModel\r\n}\r\n\r\nconst response = await ai.chat(aiChatMessages, aiChatOptions);\r\n\r\nconsole.log(response);\r\nif (response) {\r\n    thisBot.generateFromCSV(response.content);\r\n}\r\n\r\ndestroy(loadingBar);","generateFromCSV":"@const csvData = that;\r\n\r\nlet cleanedCSV = csvData?.replaceAll('`', '');\r\nif (cleanedCSV.indexOf('csv') == 0) {\r\n    cleanedCSV = cleanedCSV.replace('csv', '');\r\n}\r\n\r\nconst lines = cleanedCSV.split('\\n');\r\nconst result = [];\r\n\r\nfor (let i = 1; i < lines.length; i++) {\r\n    const obj = {};\r\n    const currentline = lines[i].split(',');\r\n\r\n    let simType = currentline[0];\r\n    let config = currentline?.slice(1)?.join(',')?.trim() ?? \"{}\";\r\n    if (config[0] == '\"') {\r\n        config = config.slice(1);\r\n    }\r\n    if (config[config.length - 1] == '\"') {\r\n        config = config.slice(0, -1);\r\n    }\r\n\r\n    if (simType == 'type' || !config) {\r\n        continue;\r\n    }\r\n\r\n    obj['type'] = simType;\r\n    obj['configuration'] = JSON.parse(config.replaceAll('\"\"', '\"'));\r\n\r\n    result.push(obj);\r\n}\r\n\r\nconst jsonString = JSON.stringify(result, null, 2); // Convert the array of objects to a JSON string\r\nconst jsonData = JSON.parse(jsonString);\r\n\r\nfor (const item of jsonData) {\r\n    if (item[\"type\"]) {\r\n        const xVal = Math.floor(Math.random() * (15 - (-15) + 1)) + (-15);\r\n        const yVal = Math.floor(Math.random() * (15 - (-15) + 1)) + (-15);\r\n        let dimensionName = ab.links.remember.tags.currentDimension ?? 'blueprint';\r\n\r\n        //SIM ROLE\r\n        if (item[\"type\"] == 'SIM_ROLE') {\r\n            const conData = item[\"configuration\"];\r\n            const abArtifactShard = {\r\n                data: {\r\n                    config: {\r\n                        label: conData.name,\r\n                        simAttributes: conData.attributes,\r\n                        roleLocked: true,\r\n                        roleName: conData.name,\r\n                        dimensionData: {\r\n                            dimension: dimensionName,\r\n                            [dimensionName]: true,\r\n                            [dimensionName + 'X']: xVal,\r\n                            [dimensionName + 'Y']: yVal\r\n                        }\r\n                    }\r\n                },\r\n                dependencies: [\r\n                    {\r\n                        askID: 'simRole'\r\n                    }\r\n                ]\r\n            };\r\n            ab.links.artifact.abCreateArtifactPromiseBot({\r\n                abArtifactName: 'simRole',\r\n                abArtifactInstanceID: uuid(),\r\n                abArtifactShard,\r\n            });\r\n\r\n        } \r\n        //SIM ACTION\r\n        else if (item[\"type\"] == 'SIM_ACTION') {\r\n            const conData = item[\"configuration\"];\r\n            const abArtifactShard = {\r\n                data: {\r\n                    config: {\r\n                        label: conData.label,\r\n                        simID: conData.simID,\r\n                        actionPrerequisites: conData.prerequisite,\r\n                        roleTags: conData.roles,\r\n                        startingAction: conData.startingAction,\r\n                        dimensionData: {\r\n                            dimension: dimensionName,\r\n                            [dimensionName]: true,\r\n                            [dimensionName + 'X']: xVal,\r\n                            [dimensionName + 'Y']: yVal\r\n                        }\r\n                    }\r\n                },\r\n                dependencies: [\r\n                    {\r\n                        askID: 'simAction'\r\n                    }\r\n                ]\r\n            };\r\n            ab.links.artifact.abCreateArtifactPromiseBot({\r\n                abArtifactName: 'simAction',\r\n                abArtifactInstanceID: uuid(),\r\n                abArtifactShard,\r\n            });\r\n        } \r\n        //SIM REACTION\r\n        else if (item[\"type\"] == 'SIM_REACTION') {\r\n            const conData = item[\"configuration\"];\r\n            const abArtifactShard = {\r\n                data: {\r\n                    config: {\r\n                        label: conData.label,\r\n                        simID: conData.simID,\r\n                        actionPrerequisites: conData.prerequisite,\r\n                        reactionAttribute: conData.affectedAttribute,\r\n                        reactionEffect: conData.effect,\r\n                        reactionValue: conData.value,\r\n                        roleTags: conData.roles,\r\n                        dimensionData: {\r\n                            dimension: dimensionName,\r\n                            [dimensionName]: true,\r\n                            [dimensionName + 'X']: xVal,\r\n                            [dimensionName + 'Y']: yVal\r\n                        }\r\n                    }\r\n                },\r\n                dependencies: [\r\n                    {\r\n                        askID: 'simReaction'\r\n                    }\r\n                ]\r\n            };\r\n            ab.links.artifact.abCreateArtifactPromiseBot({\r\n                abArtifactName: 'simReaction',\r\n                abArtifactInstanceID: uuid(),\r\n                abArtifactShard,\r\n            });\r\n        } \r\n        //SIM PLACE\r\n        else if (item[\"type\"] == 'SIM_PLACE') {\r\n            const conData = item[\"configuration\"];\r\n            const abArtifactShard = {\r\n                data: {\r\n                    config: {\r\n                        label: conData.name,\r\n                        placePrompt: conData.prompt,\r\n                        simID: conData.simID,\r\n                        chosenDimension: conData.simID,\r\n                        dimensionData: {\r\n                            dimension: dimensionName,\r\n                            [dimensionName]: true,\r\n                            [dimensionName + 'X']: xVal,\r\n                            [dimensionName + 'Y']: yVal\r\n                        }\r\n                    }\r\n                },\r\n                dependencies: [\r\n                    {\r\n                        askID: 'simPlace'\r\n                    }\r\n                ]\r\n            };\r\n            ab.links.artifact.abCreateArtifactPromiseBot({\r\n                abArtifactName: 'simPlace',\r\n                abArtifactInstanceID: uuid(),\r\n                abArtifactShard,\r\n            });\r\n        } \r\n        //SIM DOOR\r\n        else if (item[\"type\"] == 'SIM_DOOR') {\r\n            const conData = item[\"configuration\"];\r\n            dimensionName = conData.place ?? 'home';\r\n            const abArtifactShard = {\r\n                data: {\r\n                    config: {\r\n                        label: conData.label,\r\n                        destination: conData.destination,\r\n                        dimensionData: {\r\n                            dimension: dimensionName,\r\n                            [dimensionName]: true,\r\n                            [dimensionName + 'X']: xVal,\r\n                            [dimensionName + 'Y']: yVal\r\n                        }\r\n                    }\r\n                },\r\n                dependencies: [\r\n                    {\r\n                        askID: 'simDoor'\r\n                    }\r\n                ]\r\n            };\r\n            ab.links.artifact.abCreateArtifactPromiseBot({\r\n                abArtifactName: 'simDoor',\r\n                abArtifactInstanceID: uuid(),\r\n                abArtifactShard,\r\n            });\r\n        } \r\n        //SIM PROP\r\n        else if (item[\"type\"] == 'SIM_PROP') {\r\n            const conData = item[\"configuration\"];\r\n            dimensionName = conData.place ?? 'home';\r\n            const abArtifactShard = {\r\n                data: {\r\n                    config: {\r\n                        label: conData.name,\r\n                        roleName: conData.name,\r\n                        simAttributes: conData.attributes,\r\n                        trackedStat: conData.trackedAttribute,\r\n                        trackedStatStartingValue: conData.lowestValue,\r\n                        trackedStatEndingValue: conData.highestValue,\r\n                        destination: conData.destination,\r\n                        propLocked: true,\r\n                        dimensionData: {\r\n                            dimension: dimensionName,\r\n                            [dimensionName]: true,\r\n                            [dimensionName + 'X']: xVal,\r\n                            [dimensionName + 'Y']: yVal\r\n                        }\r\n                    }\r\n                },\r\n                dependencies: [\r\n                    {\r\n                        askID: 'simProp'\r\n                    }\r\n                ]\r\n            };\r\n            ab.links.artifact.abCreateArtifactPromiseBot({\r\n                abArtifactName: 'simProp',\r\n                abArtifactInstanceID: uuid(),\r\n                abArtifactShard,\r\n            });\r\n        }\r\n    }\r\n}","downloadSim":"@"}}}}