{"version":1,"state":{"42e62d21-4fe0-4742-9fd8-3b8033df7b8a":{"id":"42e62d21-4fe0-4742-9fd8-3b8033df7b8a","space":"shared","tags":{"system":"story_toolbox.storyElement","storyElement":"true","abIDOrigin":"storyElement","onClick":"@if (that?.modality == 'mouse' && that?.buttonId == 'right') {\r\n    thisBot.generateStoryElementEditMenu();\r\n    return;\r\n}\r\n\r\nif (!tags.elementPrompt) {\r\n    thisBot.aiGenerateStoryElement();\r\n    return;\r\n}\r\n\r\nif (!ab.links.console.masks.open) {\r\n    whisper(ab.links.console, \"showConsole\");\r\n    ab.links.console.masks.open = true;\r\n}\r\n\r\nos.tip(\"thinking...\", null, null, 4);\r\n\r\nconst prompt = thisBot.logPrompt();\r\n\r\nconst aiChatOptions: AIChatOptions = {\r\n    preferredModel: ab.links.personality.tags.abPreferredAIModel\r\n}\r\n\r\nlet response = await ai.chat(prompt, aiChatOptions);\r\n\r\nif (!response) {\r\n    return;\r\n}\r\n\r\nab.log({message: response?.content, name: tags.label, space: \"shared\"});\r\n// thisBot.aiGenerateStoryElement();","onGridClick":"@shout(\"clearStoryElementMenu\");","onPointerEnter":"@if (tags.elementQuip) {\r\n    os.tip(tags.elementQuip);\r\n}","generateStoryElementEditMenu":"@shout(\"clearStoryElementMenu\");\r\n\r\nshout(\"abMenuRefresh\");\r\nconfigBot.tags.menuPortal = \"storyElementEditMenu\";\r\n\r\nif (tags.storyElementLocked) {\r\n    const titleButton = {\r\n        label: thisBot.tags.label,\r\n        clearStoryElementMenu: `@destroy(this);`,\r\n        color: abPersonality.tags.abBaseMenuColor,\r\n        storyElementEditMenu: true\r\n    } \r\n\r\n    const lockButton = {\r\n        label: \"locked\",\r\n        element: getLink(thisBot),\r\n        formAddress: \"lock\",\r\n        onClick: `@\r\n            links.element.tags.storyElementLocked = false;\r\n            links.element.generateStoryElementEditMenu();\r\n        `,\r\n        clearStoryElementMenu: `@destroy(this);`,\r\n        storyElementEditMenu: true\r\n    } \r\n\r\n    await ab.links.menu.abCreateMenuText(titleButton);\r\n    await ab.links.menu.abCreateMenuButton(lockButton);\r\n} else {\r\n    const titleEditButton = {\r\n        label: \"edit title\",\r\n        element: getLink(thisBot),\r\n        onClick: `@\r\n            const newTitle = await os.showInput(links.element.tags.label, {\r\n                title: \"Edit title\"\r\n            });\r\n\r\n            links.element.tags.label = newTitle;\r\n            links.element.generateStoryElementEditMenu();\r\n        `,\r\n        clearStoryElementMenu: `@destroy(this);`,\r\n        storyElementEditMenu: true\r\n    } \r\n\r\n    const promptEditButton = {\r\n        label: \"edit prompt\",\r\n        element: getLink(thisBot),\r\n        onClick: `@\r\n            const newPrompt = await os.showInput(links.element.tags.elementPrompt, {\r\n                title: \"Edit prompt\"\r\n            });\r\n\r\n            links.element.tags.elementPrompt = newPrompt;\r\n            links.element.generateStoryElementEditMenu();\r\n        `,\r\n        clearStoryElementMenu: `@destroy(this);`,\r\n        storyElementEditMenu: true\r\n    } \r\n\r\n    const quipEditButton = {\r\n        label: \"edit quip\",\r\n        element: getLink(thisBot),\r\n        onClick: `@\r\n            const newQuip = await os.showInput(links.element.tags.elementQuip, {\r\n                title: \"Edit quip\"\r\n            });\r\n\r\n            links.element.tags.elementQuip = newQuip;\r\n            links.element.generateStoryElementEditMenu();\r\n        `,\r\n        clearStoryElementMenu: `@destroy(this);`,\r\n        storyElementEditMenu: true\r\n    } \r\n\r\n    const lockButton = {\r\n        label: \"unlocked\",\r\n        element: getLink(thisBot),\r\n        formAddress: \"lock\",\r\n        onClick: `@\r\n            links.element.tags.storyElementLocked = true;\r\n            links.element.generateStoryElementEditMenu();\r\n        `,\r\n        clearStoryElementMenu: `@destroy(this);`,\r\n        storyElementEditMenu: true\r\n    } \r\n\r\n    await ab.links.menu.abCreateMenuButton(titleEditButton);\r\n    await ab.links.menu.abCreateMenuButton(promptEditButton);\r\n    await ab.links.menu.abCreateMenuButton(quipEditButton);\r\n    await ab.links.menu.abCreateMenuButton(lockButton);\r\n\r\n}\r\n","abRightClickIgnore":"true","aiGenerateStoryElement":"@let prompt;\r\n\r\nif (that) {\r\n    prompt = that.prompt;\r\n} else {\r\n    prompt = await os.showInput(\"\", {\r\n        title: \"What would you like to add to this story?\"\r\n    });\r\n}\r\n\r\nif (!prompt) {\r\n    return;\r\n}\r\n\r\nconfigBot.tags.menuPortal = \"storyElementLoading\";\r\nconst loadingBar = ab.links.menu.abCreateMenuBusyIndicator({\r\n    label: \"Generating story element\",\r\n    storyElementLoading: true\r\n});\r\n\r\nconst aiChatOptions: AIChatOptions = {\r\n    preferredModel: ab.links.personality.tags.abPreferredAIModel\r\n}\r\n\r\nlet response = await ai.chat([\r\n    {\r\n        role: \"system\",\r\n        content: tags.basePrompt\r\n    },\r\n    {\r\n    role: 'assistant',\r\n    content: [\r\n        { text: 'hello world'}\r\n    ]},\r\n    {\r\n        role: \"user\",\r\n        content: prompt\r\n    }\r\n], aiChatOptions)\r\n\r\ndestroy(loadingBar);\r\n\r\nresponse = response.content.replace(/```json\\n?|```/g, '');\r\n\r\ntry {\r\n    response = JSON.parse(response);\r\n} catch (e) {\r\n    console.log(\"Error generating story block: \", e, response);\r\n    return;\r\n}\r\n\r\nif (!response) {\r\n    return;\r\n}\r\n\r\nconst activeDimension = configBot.tags.gridPortal;\r\ntags.color = response?.color;\r\ntags.label = that?.target ?? response?.name;\r\ntags.elementPrompt = prompt;\r\ntags.elementQuip = response?.expression;\r\ntags[activeDimension] = true;\r\ntags.scaleX = response?.scale?.x;\r\ntags.scaleY = response?.scale?.y;\r\ntags.scaleZ = response?.scale?.z;\r\ntags.storyElementType = response?.categorization;\r\n\r\nshout(\"onStoryElementAdded\", thisBot);","basePrompt":"ðŸ“„`You are a story block in a world with many other story blocks.\r\nYou will recieve a prompt from the user.\r\nReturn pure JSON with a name for your story block, an appropriate color in hex format, a short 'expression' that makes sense for what you are (example: if you were a cow, your expression might be \"moo\"),\r\na categorization array with tags that generalize what you are (each tag must only be one word),\r\nand an x,y,z scaling that represents what you are in a physical space, z is height, units are in yards, decimals are allowed, do not exceed 4.0 for any scale.\r\nYour response must only include valid JSON, starting with a { and ending with a }. You MUST NOT return only a string.\r\n\r\nEXAMPLE:\r\nprompt: \"a happy cow\"\r\nresponse: \r\n{\r\n    name: \"Mooney the happy cow\",\r\n    color: \"#f7f7f7\",\r\n    expression: \"moo!\",\r\n    categorization: [\"animal\", \"cow\"],\r\n    scale: {\r\n        x: 4,\r\n        y: 3,\r\n        z: 3\r\n    }\r\n}`","logPrompt":"@const aiMessageArr = [];\r\n\r\nconst messages = getBots(byTag(\"consoleLogMessageBot\", true), byTag(\"space\", \"shared\"));\r\nfor (let i = 0; i < messages.length; ++i) {\r\n    aiMessageArr.push({\r\n        role: messages[i].tags.name == tags.label ? \"assistant\" : \"user\",\r\n        content: messages[i].tags.name == tags.label ? messages[i].tags.message : messages[i].tags.name + \": \" + messages[i].tags.message\r\n    })\r\n}\r\n\r\naiMessageArr.push({\r\n    role: \"system\",\r\n    content: `You are ${tags.label} in a story. With this description of what you are (${tags.elementPrompt}), continue the story with what you do or say next.\r\n     Keep it simple and short, no more than a sentence or two, inpired by picture books, fables and fairytales. \r\n     You are allowed to improvise, create new plot points, and generally make the story interesting.\r\n     You cannot speak for other story elements. Your response should be a string only.\r\n     \r\n     EXAMPLE SCENARIO:\r\n     a sheep and a cow are in a field, you are the sheep. The cow says \"it is a beautiful day out\".\r\n\r\n     RESPONSE: \r\n     \"Yes! the sun is shining very brightly today! I may go on a walk.\"\r\n     `\r\n});\r\n\r\nconsole.log(\"prompt\", aiMessageArr);\r\nreturn aiMessageArr;","abVersion":"10.10","respond":"@const prompt = thisBot.logPrompt();\r\n\r\nos.tip(\"thinking ...\");\r\n\r\nprompt.push(\r\n    {\r\n        role: \"assistant\",\r\n        content: \"Narrator: \" + that\r\n    }\r\n)\r\n\r\nconst aiChatOptions: AIChatOptions = {\r\n    preferredModel: ab.links.personality.tags.abPreferredAIModel\r\n}\r\nconst response = await ai.chat(prompt, aiChatOptions);\r\n\r\nif (!response) {\r\n    return;\r\n}\r\n\r\nab.log({message: response?.content, name: tags.label, space: \"shared\"});\r\n\r\nreturn response?.content;","storyTarget":"true","onABArtifactReconstitute":"@const data = that.data;\r\ntags.label = data.label ?? 'story element';\r\ntags.color = data.color ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD';\r\ntags.labelFloatingBackgroundColor = data.labelFloatingBackgroundColor ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD'; \r\ntags.labelColor = data.labelColor ?? 'white';\r\ntags.elementQuip = data.elementQuip;\r\ntags.storyElementLocked = data.storyElementLocked;\r\ntags.elementPrompt = data.elementPrompt;\r\ntags.scaleX = data.scaleX;\r\ntags.scaleY = data.scaleY;\r\ntags.scaleZ = data.scaleZ;\r\ntags.storyElementType = data.storyElementType;\r\n\r\n//Place bot correctly\r\nif (data.dimensionData) {\r\n    for (const tagName in data.dimensionData) {\r\n        tags[tagName] = data.dimensionData[tagName];\r\n    }\r\n}\r\n\r\n//If new action\r\nif (data.eggParameters) {\r\n    const dimension = data.eggParameters.gridInformation?.dimension ?? 'home';\r\n    const dimensionX = data.eggParameters.gridInformation?.position?.x ?? 0;\r\n    const dimensionY = data.eggParameters.gridInformation?.position?.y ?? 0;\r\n\r\n    tags.dimension = dimension;\r\n    tags[dimension] = true;\r\n    tags[dimension + 'X'] = dimensionX;\r\n    tags[dimension + 'Y'] = dimensionY;\r\n\r\n     if (data.eggParameters && data.eggParameters.storyParameters) {\r\n        thisBot.aiGenerateStoryElement({\"prompt\": data.eggParameters.storyParameters.prompt, \"target\": data.eggParameters.storyParameters.target});\r\n    } else {\r\n        thisBot.aiGenerateStoryElement();\r\n    }\r\n}\r\n\r\nif (!ab.links.console.masks.open) {\r\n    whisper(ab.links.console, \"showConsole\");\r\n    ab.links.console.masks.open = true;\r\n}\r\n","onABArtifactCollectShards":"@const shard: ABArtifactShard = {\r\n    data: {\r\n        label: tags.label,\r\n        dimensionData: {\r\n            dimension: ab.links.remember.tags.abActiveDimension,\r\n            [ab.links.remember.tags.abActiveDimension]: tags[ab.links.remember.tags.abActiveDimension],\r\n            [ab.links.remember.tags.abActiveDimension + 'X']: tags[ab.links.remember.tags.abActiveDimension + 'X'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Y']: tags[ab.links.remember.tags.abActiveDimension + 'Y'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Z']: tags[ab.links.remember.tags.abActiveDimension + 'Z'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationX']: tags[ab.links.remember.tags.abActiveDimension + 'RotationX'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationY']: tags[ab.links.remember.tags.abActiveDimension + 'RotationY'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationZ']: tags[ab.links.remember.tags.abActiveDimension + 'RotationZ'],\r\n        },\r\n        color: tags.color,\r\n        labelFloatingBackgroundColor: tags.labelFloatingBackgroundColor,\r\n        labelColor: tags.labelColor,\r\n        elementQuip: tags.elementQuip,\r\n        storyElementLocked: tags.storyElementLocked,\r\n        elementPrompt: tags.elementPrompt,\r\n        scaleX: tags.scaleX,\r\n        scaleY: tags.scaleY,\r\n        scaleZ: tags.scaleZ,\r\n        storyElementType: tags.storyElementType\r\n    },\r\n    dependencies: [\r\n        {\r\n            askID: 'storyElement'\r\n        }\r\n    ]\r\n}\r\n\r\nreturn shard;","onABStripArtifactInstanceDataFromBotData":"@const { data } = that;\r\n\r\ndelete data.tags.label;\r\ndelete data.tags.labelColor;\r\ndelete data.tags.labelFloatingBackgroundColor;\r\ndelete data.tags.color;\r\ndelete data.tags[data.tags.dimension + \"X\"];\r\ndelete data.tags[data.tags.dimension + \"Y\"];\r\ndelete data.tags[data.tags.dimension + \"Z\"];\r\ndelete data.tags[data.tags.dimension + \"RotationX\"];\r\ndelete data.tags[data.tags.dimension + \"RotationY\"];\r\ndelete data.tags[data.tags.dimension + \"RotationZ\"];\r\ndelete data.tags[data.tags.dimension];\r\ndelete data.tags.dimension;\r\ndelete data.tags.elementQuip;\r\ndelete data.tags.storyElementLocked;\r\ndelete data.tags.elementPrompt;\r\ndelete data.tags.scaleX;\r\ndelete data.tags.scaleY;\r\ndelete data.tags.scaleZ;\r\ndelete data.tags.storyElementType;","abArtifactName":"storyElement","onBotAdded":"@let waitTime = 0;\r\n\r\nwhile(!globalThis.ab?.links.bot_factory) {\r\n    if (waitTime >= 5000) {\r\n        return;\r\n    }\r\n    \r\n    await os.sleep(250);\r\n    waitTime += 250;\r\n}\r\n\r\nmasks.ready = true;","strokeColor":"white","cursor":"pointer","labelPosition":"floatingBillboard","labelWordWrapMode":"breakWords","labelSize":"1","labelFontSize":"2","onDrop":"@const aiChatOptions: AIChatOptions = {\r\n    preferredModel: ab.links.personality.tags.abPreferredAIModel\r\n}\r\nconst recipes = getBots(\"storyRecipe\", true);\r\nif (that.bot == thisBot && that.to.bot) {\r\n    let foundRecipe = false;\r\n    for (let i = 0; i < recipes.length; ++i) {\r\n        if (tags.storyElementType?.includes(recipes[i].tags.dropped) && that.to.bot?.tags.storyElementType?.includes(recipes[i].tags.droppedOn)) {\r\n            foundRecipe = true;\r\n            newElement(recipes[i].tags.result);\r\n            return;\r\n        }\r\n        if (foundRecipe == false && recipes[i].tags.fuzzy) {\r\n            //ask ai if it should count or not\r\n            configBot.tags.menuPortal = \"storyElementLoading\";\r\n            let loadingBar1 = ab.links.menu.abCreateMenuBusyIndicator({\r\n                label: \"checking fuzzy recipe\",\r\n                storyElementLoading: true\r\n            });\r\n\r\n            let responseA =  await ai.chat([\r\n                {\r\n                    role: \"system\",\r\n                    content: tags.categorizationPrompt\r\n                },\r\n                {\r\n                    role: 'assistant',\r\n                    content: [\r\n                        { text: 'hello world'}\r\n                    ]},\r\n                {\r\n                    role: \"user\",\r\n                    content: \"descriptor: \" + formDescriptor(thisBot) + \" categorization: \" + recipes[i].tags.dropped\r\n                }\r\n            ], aiChatOptions)\r\n\r\n            if (responseA && responseA.content != 'true') {\r\n                continue;\r\n            }\r\n\r\n            let responseB =  await ai.chat([\r\n                {\r\n                    role: \"system\",\r\n                    content: tags.categorizationPrompt\r\n                },\r\n                {\r\n                    role: 'assistant',\r\n                    content: [\r\n                        { text: 'hello world'}\r\n                    ]},\r\n                {\r\n                    role: \"user\",\r\n                    content: \"descriptor: \" + formDescriptor(that.to.bot) + \" categorization: \" + recipes[i].tags.droppedOn\r\n                }\r\n            ], aiChatOptions)\r\n\r\n            if (responseB && responseB.content != 'true') {\r\n                continue;\r\n            }\r\n\r\n            destroy(loadingBar1);\r\n            if (responseA.content == 'true' && responseB.content == 'true') {\r\n                foundRecipe = true;\r\n                newElement(recipes[i].tags.result);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    if (foundRecipe == false) {\r\n        //ask ai what would happen\r\n        configBot.tags.menuPortal = \"storyElementLoading\";\r\n        let loadingBar2 = ab.links.menu.abCreateMenuBusyIndicator({\r\n            label: \"crafting new element\",\r\n            storyElementLoading: true\r\n        });\r\n\r\n        let response = await ai.chat([\r\n            {\r\n                role: \"system\",\r\n                content: tags.newElemPrompt\r\n            },\r\n            {\r\n                role: 'assistant',\r\n                content: [\r\n                    { text: 'hello world'}\r\n                ]},\r\n            {\r\n                role: \"user\",\r\n                content: JSON.stringify(tags.storyElementType) + \" + \" + JSON.stringify(that.to.bot.tags.storyElementType)\r\n            }\r\n        ], aiChatOptions)\r\n\r\n        destroy(loadingBar2);\r\n\r\n        if (response) {\r\n            newElement(response.content);\r\n            return;\r\n        }\r\n    }\r\n}\r\n\r\nfunction newElement (prompt: string) {\r\n    const abArtifactShard = {\r\n        data: {\r\n            eggParameters: {\r\n                toolboxBot: null,\r\n                storyParameters: {\r\n                    prompt: prompt\r\n                },\r\n                gridInformation: {\r\n                    dimension: tags.dimension,\r\n                    position: {\r\n                        x: tags[tags.dimension + 'X'],\r\n                        y: tags[tags.dimension + 'Y']\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        dependencies: [\r\n            {\r\n                askID: \"storyElement\"\r\n            }\r\n        ]\r\n    };\r\n    ab.links.artifact.abCreateArtifactPromiseBot({\r\n        abArtifactName: \"storyElement\",\r\n        abArtifactInstanceID: uuid(),\r\n        abArtifactShard,\r\n    });\r\n\r\n    destroy(that.to.bot);\r\n    destroy(thisBot); \r\n}\r\n\r\nfunction formDescriptor (bot: Object) {\r\n    const json = {\r\n        name: bot.tags.label,\r\n        description: bot.tags.elementPrompt,\r\n        categorization: bot.tags.storyElementType\r\n    }\r\n\r\n    return JSON.stringify(json);\r\n}","newElemPrompt":"ðŸ“„`You will recieve JSON descriptors for two story blocks.\r\nReturn a string with a prompt for a new story block that is a combination of the two you receive.\r\n\r\nEXAMPLE 1:\r\ntags: \"[{\r\n            name: \"Harrison the Horse\",\r\n            description: \"a large brown horse with white spots\",\r\n            categorization: [\"horse\", \"animal\"]\r\n        },\r\n        {\r\n            name: \"Horace the Brave\",\r\n            description: \"a brave knight\",\r\n            categorization: [\"human\", \"knight\"]\r\n        }]\r\nresponse: \"a knight named Horace riding a brown horse named Harrison\"\r\n\r\nEXAMPLE 2:\r\ntags: \"[{\r\n            name: \"Harrison the Horse\",\r\n            description: \"a large brown horse with white spots\",\r\n            categorization: [\"horse\", \"animal\"]\r\n        },\r\n        {\r\n            name: \"Flipper the Narwhal\",\r\n            description: \"a large narwhal with a pointy horn\",\r\n            categorization: [\"animal\", \"seacreature\", \"narwhal\"]\r\n        }]\r\nresponse: \"a large brown unicorn with white spots and a pointy horn\"\r\n`","categorizationPrompt":"ðŸ“„`You will recieve a JSON descriptor for a story block and a categorization tag.\r\nYou must determine if the story block loosely fits the categorization, it does not have to be exact.\r\nReturn a boolean, \"true\" if it fits, \"false\" if it doesnt.\r\nYour response must only include the boolean, nothing else.\r\n\r\nEXAMPLE 1:\r\n    descriptor: \"{\r\n                name: \"Harrison the Horse\",\r\n                description: \"a large brown horse with white spots\",\r\n                categorization: [\"horse\", \"animal\"]\r\n            }\"\r\n    categorization: \"plant\"\r\n    response: false\r\n\r\nEXAMPLE 2:\r\n    descriptor: \"{\r\n                name: \"Ana the Unicorn\",\r\n                description: \"a beautiful white unicorn with shimmering hair\",\r\n                categorization: [\"unicorn\", \"animal\"]\r\n            }\"\r\n    categorization: \"horse\"\r\n    response: true  \r\n}`"}}}}