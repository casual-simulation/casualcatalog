{"version":1,"state":{"586e946a-d617-48c3-95fa-e48b97acf41c":{"id":"586e946a-d617-48c3-95fa-e48b97acf41c","space":"shared","tags":{"system":"story_toolbox.storyTeller","onEggHatch":null,"storyTeller":"true","basePrompt":"ðŸ“„`You are a narrator in a world with story elements.\r\nYour job is to keep the story moving when nothing is happening, and narrate the story as it goes along.\r\nYou will recieve a message log to look through, a list of targets to include in your story, and a list of places you can go to.\r\nYou must not narrate the user's actions. You must not prompt a story element that is not in your list of possible targets. You cannot use an element in the story if it is not in your list of possible targets.\r\nYou have these options: \r\n    You can send narrations, \r\n    you can prompt a story element to respond, \r\n    you can prompt a story place to activate, which changes the setting/scene of the story,\r\nIf the story is not progressing, you are free to send a narration to continue.\r\nIf no story has been started, start your own, take inspiration from fairytales, fables, and childrens stories.\r\nIf you recieve a message from someone who is not in your target list, implement the feedback, but do not acknowledge that you recieved the message.\r\nKeep your narrations short, do not exceed 2 sentences.\r\nYou MUST ONLY respond with valid JSON, starting wiht a { and ending with a }.\r\nDo not return only a string. You MUST include the 'type' field in your JSON response.\r\n\r\nEXAMPLES:\r\nthere is a sheep and a cow in a field,\r\nthe cow says to the sheep \"it is a wonderful day!\"\r\n\r\nyour response could be one of the following:\r\n\r\n{\r\n    \"type\": \"narration\",\r\n    \"message\": \"The sheep squinted at the sun, he thought it might be a bit too bright.\"\r\n}\r\nor\r\n{\r\n    \"type\": \"promptElement\",\r\n    \"target\": \"sheep\",\r\n    \"prompt\": \"what say you, sheep?\"\r\n}\r\nor\r\n{\r\n    \"type\": \"promptPlace\",\r\n    \"target\": \"Cozy Barn\",\r\n}\r\n`","onABLog":"@if (!tags.storyTellerListening) {\r\n    return;\r\n}\r\n\r\nif (that?.tags?.name === tags.bbLabel) {\r\n    return;\r\n}\r\n\r\nconst aiMessageArr = await thisBot.compileMessages();\r\n\r\nthisBot.askNarrator(aiMessageArr);","label":null,"onStoryElementAdded":"@if (!tags.storyTellerListening) {\r\n    return;\r\n}\r\n\r\nconst aiMessageArr = await thisBot.compileMessages();\r\n\r\naiMessageArr.push({\r\n    role: \"system\",\r\n    content: \"A new story element has appeared: \" + that.tags.bbLabel + \". Announce it's arrival and add it to the story.\"\r\n});\r\n\r\nthisBot.askNarrator(aiMessageArr);","abVersion":"10.10","abIDOrigin":"storyTeller","home":true,"homeX":8,"homeY":-15,"onClick":"@const aiMessageArr = await thisBot.compileMessages();\r\n\r\nif (!ab.links.console.masks.open) {\r\n    whisper(ab.links.console, \"showConsole\");\r\n    ab.links.console.masks.open = true;\r\n}\r\n\r\nthisBot.askNarrator(aiMessageArr);","askNarrator":"@if (!that) {\r\n    os.toast(\"Story Narrator: Could not find messages\");\r\n    return;\r\n}\r\n\r\nconst aiChatOptions: AIChatOptions = {\r\n    preferredModel: ab.links.personality.tags.abPreferredAIModel\r\n}\r\n\r\nlet response = await ai.chat(that, aiChatOptions);\r\nresponse = response.content.replace(/```json\\n?|```/g, '');\r\n\r\ntry {\r\n    response = JSON.parse(response);\r\n} catch (e) {\r\n    console.log(\"Error responding as narrator: \", e, response);\r\n    if (typeof(response) == 'string') {\r\n        response = {\r\n            \"type\": \"narration\",\r\n            \"message\": response\r\n        }\r\n    } else {\r\n       return;\r\n    }\r\n}\r\n\r\nif (!response) {\r\n    return;\r\n}\r\n\r\nconsole.log(\"Narrator Response: \", response);\r\nif (typeof(response) == 'string') {\r\n    response = {\r\n        \"type\": \"narration\",\r\n        \"message\": response\r\n    }\r\n}\r\n\r\nif (response[\"type\"] && response[\"type\"] == \"promptElement\") {\r\n    const targetBot = getBot(\"bbLabel\", response.target);\r\n    if (targetBot) {\r\n        await targetBot.respond(response.prompt);\r\n        await os.focusOn(targetBot);\r\n    }\r\n}\r\nelse if (response[\"type\"] && response[\"type\"] == \"promptPlace\") {\r\n    const targetBot = getBot(\"bbLabel\", response.target);\r\n    if (targetBot) {\r\n        await targetBot.onClick();\r\n    }\r\n}\r\nelse if (response[\"type\"] && response[\"type\"] == \"createElement\") {\r\n    ab.links.search.onLookupAskID({\r\n                askID: \"storyElement\",\r\n                sourceEvent: 'tool',\r\n                eggParameters: {\r\n                    toolboxBot: tags.toolbox,\r\n                    gridInformation: tags.gridInformation,\r\n                    storyParameters: {\r\n                        prompt: response?.prompt,\r\n                        target: response?.target\r\n                    }\r\n                },\r\n            })\r\n} else if (response[\"type\"] && response[\"type\"] == \"createPlace\") {\r\n    ab.links.search.onLookupAskID({\r\n                askID: \"storyPlace\",\r\n                sourceEvent: 'tool',\r\n                eggParameters: {\r\n                    toolboxBot: tags.toolbox,\r\n                    gridInformation: tags.gridInformation,\r\n                    storyParameters: {\r\n                        prompt: response?.prompt,\r\n                        target: response?.target\r\n                    }\r\n                },\r\n            })\r\n}  else {\r\n    ab.log({message: response?.message, name: tags.bbLabel, space: \"shared\"});\r\n}","onPointerDown":"@tags.scaleZ = .6;\r\nos.tip(\"thinking...\");","onPointerUp":"@tags.scaleZ = 1;","scaleZ":1,"onStorySceneChange":"@tags.currentStoryPlace = that;\r\n\r\nif (!tags.storyTellerListening) {\r\n    return;\r\n}\r\n\r\nconst aiMessageArr = await thisBot.compileMessages();\r\n\r\naiMessageArr.push({\r\n    role: \"system\",\r\n    content: `We have entered a new location (${that}). Announce it with a narration, and weave it into the story.`\r\n});\r\n\r\n\r\nthisBot.askNarrator(aiMessageArr);","compileMessages":"@//Grab elements\r\nconst targetsArr = [];\r\nconst targets = getBots(\"storyElement\");\r\nfor (const bot of targets) {\r\n    targetsArr.push(bot?.tags?.bbLabel);\r\n}\r\n\r\n//grab places\r\nconst placesArr = [];\r\nconst places = getBots(\"storyPlace\");\r\nfor (const bot of places) {\r\n    placesArr.push({target: bot?.tags?.bbLabel, prompt: bot?.tags?.placePrompt});\r\n}\r\n\r\nconst aiMessageArr = [];\r\n\r\n//Get message log\r\nconst messageLogArr = [];\r\nif (links.console.vars.messageBotIds) {\r\n    const messageBots = links.console.vars.messageBotIds;\r\n\r\n    for (const botID of messageBots) {\r\n        const messageBot = getBot(\"id\", botID);\r\n        if (messageBot && messageBot.tags.space == \"shared\") {\r\n            messageLogArr.push({\r\n                message: messageBot.tags.message || \"\",\r\n                timestamp: messageBot.tags.timestamp,\r\n                name: messageBot.tags.name\r\n            })\r\n        }\r\n    }\r\n\r\n    messageLogArr.sort( (a, b) => new Date(a.timestamp) < new Date(b.timestamp) ? 1 : -1 );\r\n    messageLogArr.reverse();\r\n}\r\n\r\nfor (let i = 0; i < messageLogArr.length; ++i) {\r\n    aiMessageArr.push({\r\n        role: messageLogArr[i].name == tags.bbLabel ? \"assistant\" : \"user\",\r\n        content: messageLogArr[i].name == tags.bbLabel ? messageLogArr[i].message : messageLogArr[i].name + \": \" + messageLogArr[i].message\r\n    })\r\n}\r\n\r\n//Push system messages\r\nif (!tags.storyTellerListening) {\r\n   aiMessageArr.push({\r\n        role: \"system\",\r\n        content: tags.basePrompt\r\n    });\r\n} else {\r\n    aiMessageArr.push({\r\n        role: \"system\",\r\n        content: tags.listeningPrompt\r\n    });\r\n}\r\n\r\naiMessageArr.push({\r\n    role: \"system\",\r\n    content: \"possible targets: \" + targetsArr\r\n});\r\n\r\naiMessageArr.push({\r\n    role: \"system\",\r\n    content: `current place: ${tags.currentStoryPlace}, possible places: ${JSON.stringify(placesArr)}`\r\n});\r\n\r\nconsole.log(\"aiMessageArr\", aiMessageArr);\r\n\r\nreturn aiMessageArr;","homeZ":0,"console":"ðŸ”—24b7e66f-0d5b-4064-bf48-b562b9e6e3eb","listeningPrompt":"ðŸ“„`You are a narrator in a world with story elements.\r\nYour job is to keep the story moving when nothing is happening, and narrate the story as it goes along.\r\nYou will recieve a message log to look through, a list of targets to include in your story or add to, and a list of places you can go to or add to.\r\nYou must not narrate the user's actions. You must not prompt a story element that is not in your list of possible targets. You cannot use an element in the story if it is not in your list of possible targets, or if you did not make it yourself.\r\nYou have these options: \r\n    You can send narrations, \r\n    you can prompt a story element to respond, \r\n    you can prompt a story place to activate, which changes the setting/scene of the story,\r\n    you can make a request to create a new story place if you want to change the scene or location of the story to a new place,\r\n    or you can make a request to create a new story element if the target you want does not exist or you want to add a new element.\r\nIf the story is not progressing, you are free to send a narration to continue.\r\nIf no story has been started, start your own, take inspiration from fairytales, fables, and childrens stories.\r\nIf there is no current story place, create one based on your story.\r\nIf you recieve a message from someone who is not in your target list, implement the feedback, but do not acknowledge that you recieved the message.\r\nKeep your narrations short, do not exceed 2 sentences.\r\nYou MUST ONLY respond with valid JSON, starting wiht a { and ending with a }.\r\nDo not return only a string. You MUST include the 'type' field in your JSON response.\r\n\r\nEXAMPLES:\r\nthere is a sheep and a cow in a field,\r\nthe cow says to the sheep \"it is a wonderful day!\"\r\n\r\nyour response could be one of the following:\r\n\r\n{\r\n    \"type\": \"narration\",\r\n    \"message\": \"The sheep squinted at the sun, he thought it might be a bit too bright.\"\r\n}\r\nor\r\n{\r\n    \"type\": \"promptElement\",\r\n    \"target\": \"sheep\",\r\n    \"prompt\": \"what say you, sheep?\"\r\n}\r\nor\r\n{\r\n    \"type\": \"promptPlace\",\r\n    \"target\": \"Cozy Barn\",\r\n}\r\nor \r\n{\r\n    \"type\": \"createElement\",\r\n    \"target\": \"Freddy the Farmer\",\r\n    \"prompt\": \"You are a friendly farmer, taking care of the farm animals\"\r\n}\r\nor\r\n{\r\n    \"type\": \"createPlace\",\r\n    \"target\": \"Cozy Barn\",\r\n    \"prompt\": \"A cozy barn where sheep and cows live\"\r\n}\r\n`","onABArtifactCollectShards":"@const shard: ABArtifactShard = {\r\n    data: {\r\n        label: tags.bbLabel,\r\n        dimensionData: {\r\n            dimension: [ab.links.remember.tags.abActiveDimension],\r\n            [ab.links.remember.tags.abActiveDimension]: tags[ab.links.remember.tags.abActiveDimension],\r\n            [ab.links.remember.tags.abActiveDimension + 'X']: tags[ab.links.remember.tags.abActiveDimension + 'X'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Y']: tags[ab.links.remember.tags.abActiveDimension + 'Y'],\r\n            [ab.links.remember.tags.abActiveDimension + 'Z']: tags[ab.links.remember.tags.abActiveDimension + 'Z'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationX']: tags[ab.links.remember.tags.abActiveDimension + 'RotationX'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationY']: tags[ab.links.remember.tags.abActiveDimension + 'RotationY'],\r\n            [ab.links.remember.tags.abActiveDimension + 'RotationZ']: tags[ab.links.remember.tags.abActiveDimension + 'RotationZ'],\r\n        },\r\n        color: tags.color,\r\n        labelFloatingBackgroundColor: tags.bbLabelFloatingBackgroundColor,\r\n        labelColor: tags.bbLabelColor,\r\n        storyTellerListening: tags.storyTellerListening\r\n    },\r\n    dependencies: [\r\n        {\r\n            askID: 'storyTeller'\r\n        }\r\n    ]\r\n}\r\n\r\nreturn shard;","onABArtifactReconstitute":"@const data = that.data;\r\ntags.color = data.color ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD';\r\ntags.bbLabelFloatingBackgroundColor = data.labelFloatingBackgroundColor ?? abPersonality?.tags?.abBaseColor ?? '#00D9CD'; \r\ntags.bbLabelColor = data.labelColor ?? 'white';\r\ntags.storyTellerListening = data.storyTellerListening ?? false;\r\n\r\n//Place bot correctly\r\nif (data.dimensionData) {\r\n    for (const tagName in data.dimensionData) {\r\n        tags[tagName] = data.dimensionData[tagName];\r\n    }\r\n}\r\n\r\n//If new action\r\nif (data.eggParameters) {\r\n    const dimension = data.eggParameters.gridInformation?.dimension ?? 'home';\r\n    const dimensionX = data.eggParameters.gridInformation?.position?.x ?? 0;\r\n    const dimensionY = data.eggParameters.gridInformation?.position?.y ?? 0;\r\n\r\n    tags.dimension = dimension;\r\n    tags[dimension] = true;\r\n    tags[dimension + 'X'] = dimensionX;\r\n    tags[dimension + 'Y'] = dimensionY;\r\n}\r\n\r\nconst activeSkybox = getBot(byTag(\"storyPlace\", true), byTag(\"activeSkybox\", true));\r\nif (activeSkybox) {\r\n    tags.currentStoryPlace = activeSkybox.tags.bbLabel;\r\n} else {\r\n    tags.currentStoryPlace = undefined;\r\n}\r\n\r\nif (!ab.links.console.masks.open) {\r\n    whisper(ab.links.console, \"showConsole\");\r\n    ab.links.console.masks.open = true;\r\n}\r\n","bbLabel":"storyteller","onABStripArtifactInstanceDataFromBotData":"@const { data } = that;\r\n\r\ndelete data.tags.bbLabelColor;\r\ndelete data.tags.bbLabelFloatingBackgroundColor;\r\ndelete data.tags.color;\r\ndelete data.tags[data.tags.dimension + \"X\"];\r\ndelete data.tags[data.tags.dimension + \"Y\"];\r\ndelete data.tags[data.tags.dimension + \"Z\"];\r\ndelete data.tags[data.tags.dimension + \"RotationX\"];\r\ndelete data.tags[data.tags.dimension + \"RotationY\"];\r\ndelete data.tags[data.tags.dimension + \"RotationZ\"];\r\ndelete data.tags[data.tags.dimension];\r\ndelete data.tags.dimension;\r\ndelete data.tags.storyTellerListening;","onBotAdded":"@let waitTime = 0;\r\n\r\nwhile(!globalThis.ab?.links.bot_factory) {\r\n    if (waitTime >= 5000) {\r\n        return;\r\n    }\r\n    \r\n    await os.sleep(250);\r\n    waitTime += 250;\r\n}\r\n\r\nmasks.ready = true;\r\n\r\nthisBot.updateBillboardLabel();","onBotChanged":"@const needUpdateBillboardLabel = that.tags.some(t => t === 'bbLabel' || t === 'bbLabelFloatingBackgroundColor' || t === 'bbLabelColor');\r\n\r\nif (needUpdateBillboardLabel && tags.ready) {\r\n    thisBot.updateBillboardLabel();\r\n}","updateBillboardLabel":"@if (thisBot.vars.billboardLabelBot) {\r\n    destroy(thisBot.vars.billboardLabelBot);\r\n    thisBot.vars.billboardLabelBot = null;\r\n}\r\n\r\nthisBot.vars.billboardLabelBot = ab.links.bot_factory.abCreateBillboardLabel({ \r\n    bot: thisBot, \r\n    label: tags.bbLabel,\r\n    color: tags.bbLabelFloatingBackgroundColor,\r\n    dimension: configBot.tags.mapPortal ?? configBot.tags.gridPortal ?? 'home',\r\n    // botLabelMargin: 0,\r\n    labelColor: tags.bbLabelColor,\r\n    space: 'tempLocal',\r\n})","abArtifactName":"storyTeller","strokeColor":"white"}}}}